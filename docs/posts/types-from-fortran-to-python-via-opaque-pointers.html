<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rgoswami.me/posts/types-fortran-python-opaque/">Original</a>
    <h1>Types from Fortran to Python via Opaque Pointers</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>This post is part of the <a href="https://rgoswami.me/series/bridging-fortran-python/">Bridging Fortran &amp; Python</a> series.</p></div><blockquote><p>An exploration of the opaque object and pointer interface approach to
unleash more modern features than those offered by the ISO Fortran
standard.</p></blockquote><h2 id="background">Background</h2><p>Since this has been covered a few times before, just some quick
pointers<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>. The ultimate context is to be able take nice, modern
Fortran code with derived types and generate equally nice, user
friendly, efficient Python wrappers via <code>f2py</code>.</p><h3 id="why">Why?</h3><p>Where the last post (and <a href="https://github.com/numpy/numpy/pull/20770">the test
implementation</a> in <code>f2py</code>)
left off, the type shadowing approach for having exactly interoperable
<code>bind(c)</code> derived types (and
<a href="https://github.com/numpy/numpy/pull/24555">functions</a>) was covered.
However, there are several aspects of derived types which cannot be
covered (“deep” types in the nomenclature of Pletzer et al.
(<a href="#ref-pletzerExposingFortranDerived2008">2008</a>)). A brief list:</p><ul><li>Types with allocatable members</li><li>Types with other types as members</li><li>Types which have bound proceedures</li><li>Pointer elements</li><li>Child types, in an inheritance hierarchy</li></ul><p>Of these, the first three are probably the most common use cases, which
need to be addressed by any serious attempt to bride Fortran and Python.</p><h3 id="scope">Scope</h3><p>This post is just going to cover the development of Python examples
facilitated by the pointer implementation where:</p><ul><li>A simple derived type, <code>point</code>, is manipulated via pointers</li></ul><p>We will first demonstrate a Fortran example, followed by its call from
<code>C</code>, before demonstrating its bridging <code>Python-C</code> code and finally a
user-facing <code>python</code> example. The full code may be found in the examples
folder and pull requests
<a href="https://github.com/HaoZeke/f2py_derived_nep">here</a>. Typically the
snippets here will have elided error handling to drive home the approach
over the boilerplate / best practices <sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>.</p><h2 id="approaches-to-an-automated-method">Approaches to an automated method</h2><p>The main idea here is a separation of concerns at three levels:</p><ul><li>Fortran code handles its own memory / functionality<ul><li>Wrappers are exposed at two levels:<ul><li>One layer to provide pointer “handles” to each part of the
type.</li><li>Another outer layer connecting to <code>bind(c)</code> proceedures.</li></ul></li></ul></li><li><code>C</code> bindings call the <code>bind(c)</code> proceedures and pass handles (opaque
pointers) as <code>void*</code>.</li><li>At the <code>python</code> level, these are stored in <code>PyCapsule</code> instances,
and exposed to the user as a standard Python class.</li></ul><p>The <code>bind(c)</code> proceedures are meant to separate the implementation from
the <code>C</code>-interface in a manner which can be automated (eventually) by
<code>f2py</code>. Similarly, the <code>Python-C</code> code is eventually to be generated as
well.</p><h2 id="point-with-pointers"><code>point</code> with pointers</h2><p>We will start with the prototypical class in applications, a <code>point</code>,
with 2 dimensions.</p><h3 id="fortran-baseline">Fortran baseline</h3><p>The <code>type</code> we want is very minimal:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>type</span><span> </span><span>::</span><span> </span><span>Point</span><span>
</span></span></span><span><span>2</span><span><span>   </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>
</span></span></span><span><span>3</span><span><span>   </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span>4</span><span><span></span><span>end</span><span> </span><span>type</span><span> </span><span>Point</span><span>
</span></span></span></code></pre></div><p>However, since we need to use this via pointers, we need a more involved
set of helpers for this:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>subroutine</span><span> </span><span>create_point</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>p</span><span>)</span><span>
</span></span></span><span><span>2</span><span><span>   </span><span>real</span><span>(</span><span>8</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>,</span><span> </span><span>y</span><span>
</span></span></span><span><span>3</span><span><span>   </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>4</span><span><span>   </span><span>allocate</span><span> </span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>5</span><span><span>   </span><span>p</span><span>%</span><span>x</span><span> </span><span>=</span><span> </span><span>x</span><span>
</span></span></span><span><span>6</span><span><span>   </span><span>p</span><span>%</span><span>y</span><span> </span><span>=</span><span> </span><span>y</span><span>
</span></span></span><span><span>7</span><span><span></span><span>end</span><span> </span><span>subroutine</span><span> </span><span>create_point</span><span>
</span></span></span></code></pre></div><p>There isn’t much to say about these, and they are rather mechanically
derived.</p><h4 id="building-and-testing">Building and testing</h4><p>For the toy point we have:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span> 1</span><span><span>module</span><span> </span><span>point_module</span><span>
</span></span></span><span><span> 2</span><span><span>   </span><span>implicit</span><span> </span><span>none</span><span>
</span></span></span><span><span> 3</span><span><span>   </span><span>type</span><span> </span><span>::</span><span> </span><span>Point</span><span>
</span></span></span><span><span> 4</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>
</span></span></span><span><span> 5</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span> 6</span><span><span>   </span><span>end</span><span> </span><span>type</span><span> </span><span>Point</span><span>
</span></span></span><span><span> 7</span><span><span></span><span>contains</span><span>
</span></span></span><span><span> 8</span><span><span>   </span><span>subroutine</span><span> </span><span>create_point</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>p</span><span>,</span><span> </span><span>alloc_stat</span><span>)</span><span>
</span></span></span><span><span> 9</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>,</span><span> </span><span>y</span><span>
</span></span></span><span><span>10</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>11</span><span><span>      </span><span>integer</span><span>,</span><span> </span><span>intent</span><span>(</span><span>out</span><span>),</span><span> </span><span>optional</span><span> </span><span>::</span><span> </span><span>alloc_stat</span><span>
</span></span></span><span><span>12</span><span><span>      </span><span>allocate</span><span> </span><span>(</span><span>p</span><span>,</span><span> </span><span>stat</span><span>=</span><span>alloc_stat</span><span>)</span><span>
</span></span></span><span><span>13</span><span><span>      </span><span>if</span><span> </span><span>(</span><span>present</span><span>(</span><span>alloc_stat</span><span>)</span><span> </span><span>.</span><span>and</span><span>.</span><span> </span><span>alloc_stat</span><span> </span><span>/=</span><span> </span><span>0</span><span>)</span><span> </span><span>then</span><span>
</span></span></span><span><span>14</span><span><span>         </span><span>return</span><span>
</span></span></span><span><span>15</span><span><span>      </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>16</span><span><span>      </span><span>p</span><span>%</span><span>x</span><span> </span><span>=</span><span> </span><span>x</span><span>
</span></span></span><span><span>17</span><span><span>      </span><span>p</span><span>%</span><span>y</span><span> </span><span>=</span><span> </span><span>y</span><span>
</span></span></span><span><span>18</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>create_point</span><span>
</span></span></span><span><span>19</span><span><span>
</span></span></span><span><span>20</span><span><span>   </span><span>subroutine</span><span> </span><span>destroy_point</span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>21</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>22</span><span><span>      </span><span>if</span><span> </span><span>(</span><span>associated</span><span>(</span><span>p</span><span>))</span><span> </span><span>then</span><span>
</span></span></span><span><span>23</span><span><span>         </span><span>deallocate</span><span> </span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>24</span><span><span>         </span><span>p</span><span> </span><span>=&gt;</span><span> </span><span>null</span><span>()</span><span>
</span></span></span><span><span>25</span><span><span>      </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>26</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>destroy_point</span><span>
</span></span></span><span><span>27</span><span><span>
</span></span></span><span><span>28</span><span><span>   </span><span>function</span><span> </span><span>get_x</span><span>(</span><span>p</span><span>)</span><span> </span><span>result</span><span>(</span><span>x_value</span><span>)</span><span>
</span></span></span><span><span>29</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>30</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>x_value</span><span>
</span></span></span><span><span>31</span><span><span>      </span><span>x_value</span><span> </span><span>=</span><span> </span><span>p</span><span>%</span><span>x</span><span>
</span></span></span><span><span>32</span><span><span>   </span><span>end</span><span> </span><span>function</span><span> </span><span>get_x</span><span>
</span></span></span><span><span>33</span><span><span>
</span></span></span><span><span>34</span><span><span>   </span><span>subroutine</span><span> </span><span>set_x</span><span>(</span><span>p</span><span>,</span><span> </span><span>x</span><span>)</span><span>
</span></span></span><span><span>35</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>intent</span><span>(</span><span>inout</span><span>)</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>36</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>
</span></span></span><span><span>37</span><span><span>      </span><span>p</span><span>%</span><span>x</span><span> </span><span>=</span><span> </span><span>x</span><span>
</span></span></span><span><span>38</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>set_x</span><span>
</span></span></span><span><span>39</span><span><span>
</span></span></span><span><span>40</span><span><span>   </span><span>function</span><span> </span><span>get_y</span><span>(</span><span>p</span><span>)</span><span> </span><span>result</span><span>(</span><span>y_value</span><span>)</span><span>
</span></span></span><span><span>41</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>42</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>y_value</span><span>
</span></span></span><span><span>43</span><span><span>      </span><span>y_value</span><span> </span><span>=</span><span> </span><span>p</span><span>%</span><span>y</span><span>
</span></span></span><span><span>44</span><span><span>   </span><span>end</span><span> </span><span>function</span><span> </span><span>get_y</span><span>
</span></span></span><span><span>45</span><span><span>
</span></span></span><span><span>46</span><span><span>   </span><span>subroutine</span><span> </span><span>set_y</span><span>(</span><span>p</span><span>,</span><span> </span><span>y</span><span>)</span><span>
</span></span></span><span><span>47</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>intent</span><span>(</span><span>inout</span><span>)</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>48</span><span><span>      </span><span>real</span><span>(</span><span>8</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span>49</span><span><span>      </span><span>p</span><span>%</span><span>y</span><span> </span><span>=</span><span> </span><span>y</span><span>
</span></span></span><span><span>50</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>set_y</span><span>
</span></span></span><span><span>51</span><span><span></span><span>end</span><span> </span><span>module</span><span> </span><span>point_module</span><span>
</span></span></span></code></pre></div><p>Now these can be tested from a simple driver:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span> 1</span><span><span>program</span><span> </span><span>test_point_module</span><span>
</span></span></span><span><span> 2</span><span><span>   </span><span>use</span><span> </span><span>point_module</span><span>
</span></span></span><span><span> 3</span><span><span>   </span><span>implicit</span><span> </span><span>none</span><span>
</span></span></span><span><span> 4</span><span><span>
</span></span></span><span><span> 5</span><span><span>   </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>pt</span><span>
</span></span></span><span><span> 6</span><span><span>   </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>x_val</span><span>,</span><span> </span><span>y_val</span><span>
</span></span></span><span><span> 7</span><span><span>   </span><span>integer</span><span> </span><span>::</span><span> </span><span>alloc_status</span><span>
</span></span></span><span><span> 8</span><span><span>
</span></span></span><span><span> 9</span><span><span>   </span><span>! Test creating a new point
</span></span></span><span><span>10</span><span><span></span><span>   </span><span>call</span><span> </span><span>create_point</span><span>(</span><span>1.0d0</span><span>,</span><span> </span><span>2.0d0</span><span>,</span><span> </span><span>pt</span><span>,</span><span> </span><span>alloc_status</span><span>)</span><span>
</span></span></span><span><span>11</span><span><span>
</span></span></span><span><span>12</span><span><span>   </span><span>if</span><span> </span><span>(.</span><span>not</span><span>.</span><span> </span><span>associated</span><span>(</span><span>pt</span><span>))</span><span> </span><span>then</span><span>
</span></span></span><span><span>13</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Point creation failed with status &#34;</span><span>,</span><span> </span><span>alloc_status</span><span>
</span></span></span><span><span>14</span><span><span>      </span><span>stop</span><span>
</span></span></span><span><span>15</span><span><span>   </span><span>else</span><span>
</span></span></span><span><span>16</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Point created: (&#34;</span><span>,</span><span> </span><span>pt</span><span>%</span><span>x</span><span>,</span><span> </span><span>&#34;, &#34;</span><span>,</span><span> </span><span>pt</span><span>%</span><span>y</span><span>,</span><span> </span><span>&#34;)&#34;</span><span>
</span></span></span><span><span>17</span><span><span>   </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>18</span><span><span>
</span></span></span><span><span>19</span><span><span>   </span><span>! Test setters and getters
</span></span></span><span><span>20</span><span><span></span><span>   </span><span>call</span><span> </span><span>set_x</span><span>(</span><span>pt</span><span>,</span><span> </span><span>5.0d0</span><span>)</span><span>
</span></span></span><span><span>21</span><span><span>   </span><span>call</span><span> </span><span>set_y</span><span>(</span><span>pt</span><span>,</span><span> </span><span>1</span><span>0.0d0</span><span>)</span><span>
</span></span></span><span><span>22</span><span><span>   </span><span>x_val</span><span> </span><span>=</span><span> </span><span>get_x</span><span>(</span><span>pt</span><span>)</span><span>
</span></span></span><span><span>23</span><span><span>   </span><span>y_val</span><span> </span><span>=</span><span> </span><span>get_y</span><span>(</span><span>pt</span><span>)</span><span>
</span></span></span><span><span>24</span><span><span>
</span></span></span><span><span>25</span><span><span>   </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;After setting new values:&#34;</span><span>
</span></span></span><span><span>26</span><span><span>   </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;x =&#34;</span><span>,</span><span> </span><span>x_val</span><span>,</span><span> </span><span>&#34;y =&#34;</span><span>,</span><span> </span><span>y_val</span><span>
</span></span></span><span><span>27</span><span><span>
</span></span></span><span><span>28</span><span><span>   </span><span>if</span><span> </span><span>(</span><span>x_val</span><span> </span><span>==</span><span> </span><span>5.0d0</span><span> </span><span>.</span><span>and</span><span>.</span><span> </span><span>y_val</span><span> </span><span>==</span><span> </span><span>1</span><span>0.0d0</span><span>)</span><span> </span><span>then</span><span>
</span></span></span><span><span>29</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Point values updated correctly.&#34;</span><span>
</span></span></span><span><span>30</span><span><span>   </span><span>else</span><span>
</span></span></span><span><span>31</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Error in updating point values.&#34;</span><span>
</span></span></span><span><span>32</span><span><span>   </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>33</span><span><span>
</span></span></span><span><span>34</span><span><span>   </span><span>! Test destruction
</span></span></span><span><span>35</span><span><span></span><span>   </span><span>call</span><span> </span><span>destroy_point</span><span>(</span><span>pt</span><span>)</span><span>
</span></span></span><span><span>36</span><span><span>
</span></span></span><span><span>37</span><span><span>   </span><span>if</span><span> </span><span>(.</span><span>not</span><span>.</span><span> </span><span>associated</span><span>(</span><span>pt</span><span>))</span><span> </span><span>then</span><span>
</span></span></span><span><span>38</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Point destroyed successfully.&#34;</span><span>
</span></span></span><span><span>39</span><span><span>   </span><span>else</span><span>
</span></span></span><span><span>40</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Error in destroying point.&#34;</span><span>
</span></span></span><span><span>41</span><span><span>   </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>42</span><span><span></span><span>end</span><span> </span><span>program</span><span> </span><span>test_point_module</span><span>
</span></span></span></code></pre></div><p>Personally I use <code>meson</code> for everything, but this is trivially compiled
anyway:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>❯ gfortran point.f90 ftest.f90
</span></span><span><span>2</span><span>❯ ./a.out
</span></span><span><span>3</span><span> Point created: <span>(</span>   1.0000000000000000      ,    2.0000000000000000      <span>)</span>
</span></span><span><span>4</span><span> After setting new values:
</span></span><span><span>5</span><span> <span>x</span> <span>=</span>   5.0000000000000000      <span>y</span> <span>=</span>   10.000000000000000
</span></span><span><span>6</span><span> Point values updated correctly.
</span></span><span><span>7</span><span> Point destroyed successfully.
</span></span></code></pre></div><p>Just to build on for when it gets less trivial, the <code>meson</code> equivalent
is:</p><div><pre tabindex="0"><code data-lang="meson"><span><span>1</span><span><span>project</span><span>(</span><span>&#39;pyclass_bindc&#39;</span><span>,</span><span> </span><span>&#39;c&#39;</span><span>,</span><span> </span><span>&#39;fortran&#39;</span><span>,</span><span>
</span></span></span><span><span>2</span><span><span>        </span><span>version</span><span> </span><span>:</span><span> </span><span>&#39;0.1&#39;</span><span>,</span><span>
</span></span></span><span><span>3</span><span><span>        </span><span>default_options</span><span> </span><span>:</span><span> </span><span>[</span><span>&#39;warning_level=2&#39;</span><span>,</span><span>
</span></span></span><span><span>4</span><span><span>                           </span><span>&#39;buildtype=debug&#39;</span><span>,</span><span>
</span></span></span><span><span>5</span><span><span>                           </span><span>&#39;debug=true&#39;</span><span>,</span><span>
</span></span></span><span><span>6</span><span><span>                          </span><span>])</span><span>
</span></span></span><span><span>7</span><span><span></span><span>executable</span><span>(</span><span>&#39;ftest&#39;</span><span>,</span><span>
</span></span></span><span><span>8</span><span><span>           </span><span>&#39;ftest.f90&#39;</span><span>,</span><span>
</span></span></span><span><span>9</span><span><span>           </span><span>&#39;point.f90&#39;</span><span>)</span><span>
</span></span></span></code></pre></div><p>Which can be used with:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>meson setup bbdir
</span></span><span><span>2</span><span>meson compile -C bbdir
</span></span><span><span>3</span><span>❯ ./bbdir/ftest
</span></span><span><span>4</span><span> Point created: <span>(</span>   1.0000000000000000      ,    2.0000000000000000      <span>)</span>
</span></span><span><span>5</span><span> After setting new values:
</span></span><span><span>6</span><span> <span>x</span> <span>=</span>   5.0000000000000000      <span>y</span> <span>=</span>   10.000000000000000
</span></span><span><span>7</span><span> Point values updated correctly.
</span></span><span><span>8</span><span> Point destroyed successfully.
</span></span></code></pre></div><h3 id="c-wrappers"><code>C</code>-Wrappers</h3><p>Lets focus a bit on what we need to do, creation and destruction are
fairly straightforward since we just need to remember to return a
<code>c_ptr</code> and create interface it to our existing functions..</p><div><pre tabindex="0"><code data-lang="fortran"><span><span> 1</span><span><span>function</span><span> </span><span>c_new_point</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>)</span><span> </span><span>result</span><span>(</span><span>cnewpt</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>)</span><span>
</span></span></span><span><span> 2</span><span><span>   </span><span>real</span><span>(</span><span>c_double</span><span>),</span><span> </span><span>value</span><span> </span><span>::</span><span> </span><span>x</span><span>,</span><span> </span><span>y</span><span> </span><span>!! important
</span></span></span><span><span> 3</span><span><span></span><span>   </span><span>type</span><span>(</span><span>c_ptr</span><span>)</span><span> </span><span>::</span><span> </span><span>cnewpt</span><span>
</span></span></span><span><span> 4</span><span><span>   </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span> 5</span><span><span>   </span><span>integer</span><span> </span><span>::</span><span> </span><span>stat</span><span>
</span></span></span><span><span> 6</span><span><span>   </span><span>call</span><span> </span><span>create_point</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>p</span><span>,</span><span> </span><span>stat</span><span>)</span><span>
</span></span></span><span><span> 7</span><span><span>   </span><span>if</span><span> </span><span>(</span><span>stat</span><span> </span><span>/=</span><span> </span><span>0</span><span>)</span><span> </span><span>then</span><span>
</span></span></span><span><span> 8</span><span><span>      </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Allocation failed&#34;</span><span>
</span></span></span><span><span> 9</span><span><span>      </span><span>cnewpt</span><span> </span><span>=</span><span> </span><span>C_NULL_PTR</span><span>
</span></span></span><span><span>10</span><span><span>      </span><span>return</span><span>
</span></span></span><span><span>11</span><span><span>   </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>12</span><span><span>   </span><span>cnewpt</span><span> </span><span>=</span><span> </span><span>c_loc</span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>13</span><span><span></span><span>end</span><span> </span><span>function</span><span> </span><span>c_new_point</span><span>
</span></span></span></code></pre></div><p>Note the use of the <code>c_loc</code> intrinsic which is used to get a pointer
compatible with <code>C</code> as required by the return type too. For bindings, it
is never a good idea to neglect error handling, so we do guard for
allocation failures, using the NULL helper in the <code>iso_c</code> intrinsic. The
<code>value</code> attribute is important enough (and a recurring theme) so it is
relegated to the box.</p><div><p><strong>Warning</strong></p><p>The <code>value</code> attribute is <strong>required</strong> in the to ensure data is copied
and interpreted correctly from <code>C</code> to Fortran.</p></div><p>Similar considerations apply to the rest of the bindings, the full
source of which is reproduced at the end of this section.</p><p>To call these from <code>C</code> we need to remember that we want to grab a
pointer to a pointer, that is, the signatures will be <code>void**</code>. So we
have:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>extern</span> <span>void</span> <span>*</span><span>c_new_point</span><span>(</span><span>double</span> <span>x</span><span>,</span> <span>double</span> <span>y</span><span>);</span>
</span></span><span><span>2</span><span><span>extern</span> <span>void</span> <span>c_delete_point</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>);</span>
</span></span><span><span>3</span><span><span>extern</span> <span>double</span> <span>c_get_x</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>);</span>
</span></span><span><span>4</span><span><span>extern</span> <span>void</span> <span>c_set_x</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>,</span> <span>double</span> <span>x</span><span>);</span>
</span></span><span><span>5</span><span><span>extern</span> <span>double</span> <span>c_get_y</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>);</span>
</span></span><span><span>6</span><span><span>extern</span> <span>void</span> <span>c_set_y</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>,</span> <span>double</span> <span>y</span><span>);</span>
</span></span></code></pre></div><p><code>bind(C)</code> is on the Fortran side is used to ensure no name mangling.</p><h4 id="building-and-testing">Building and testing</h4><p>The additional wrapper file is:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span> 1</span><span><span>! cwrappers.f90
</span></span></span><span><span> 2</span><span><span>! C interoperable wrappers
</span></span></span><span><span> 3</span><span><span></span><span>module</span><span> </span><span>c_wrappers</span><span>
</span></span></span><span><span> 4</span><span><span>   </span><span>use</span><span>,</span><span> </span><span>intrinsic</span><span> </span><span>::</span><span> </span><span>iso_c_binding</span><span>,</span><span> </span><span>only</span><span>:</span><span> </span><span>c_ptr</span><span>,</span><span> </span><span>c_double</span><span>,</span><span> </span><span>c_null_ptr</span><span>,</span><span> </span><span>&amp;</span><span>
</span></span></span><span><span> 5</span><span><span>                                                                             </span><span>c_loc</span><span>,</span><span> </span><span>c_associated</span><span>,</span><span> </span><span>c_f_pointer</span><span>
</span></span></span><span><span> 6</span><span><span>   </span><span>use</span><span> </span><span>point_module</span><span>
</span></span></span><span><span> 7</span><span><span>   </span><span>implicit</span><span> </span><span>none</span><span>
</span></span></span><span><span> 8</span><span><span>
</span></span></span><span><span> 9</span><span><span></span><span>contains</span><span>
</span></span></span><span><span>10</span><span><span>
</span></span></span><span><span>11</span><span><span>   </span><span>! Wrapper for creating a new point
</span></span></span><span><span>12</span><span><span></span><span>   </span><span>function</span><span> </span><span>c_new_point</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>)</span><span> </span><span>result</span><span>(</span><span>cnewpt</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>)</span><span>
</span></span></span><span><span>13</span><span><span>      </span><span>real</span><span>(</span><span>c_double</span><span>),</span><span> </span><span>value</span><span> </span><span>::</span><span> </span><span>x</span><span>,</span><span> </span><span>y</span><span>
</span></span></span><span><span>14</span><span><span>      </span><span>type</span><span>(</span><span>c_ptr</span><span>)</span><span> </span><span>::</span><span> </span><span>cnewpt</span><span>
</span></span></span><span><span>15</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>16</span><span><span>      </span><span>integer</span><span> </span><span>::</span><span> </span><span>stat</span><span>
</span></span></span><span><span>17</span><span><span>      </span><span>call</span><span> </span><span>create_point</span><span>(</span><span>x</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>p</span><span>,</span><span> </span><span>stat</span><span>)</span><span>
</span></span></span><span><span>18</span><span><span>      </span><span>if</span><span> </span><span>(</span><span>stat</span><span> </span><span>/=</span><span> </span><span>0</span><span>)</span><span> </span><span>then</span><span>
</span></span></span><span><span>19</span><span><span>         </span><span>print</span><span> </span><span>*</span><span>,</span><span> </span><span>&#34;Allocation failed&#34;</span><span>
</span></span></span><span><span>20</span><span><span>         </span><span>cnewpt</span><span> </span><span>=</span><span> </span><span>C_NULL_PTR</span><span>
</span></span></span><span><span>21</span><span><span>         </span><span>return</span><span>
</span></span></span><span><span>22</span><span><span>      </span><span>end</span><span> </span><span>if</span><span>
</span></span></span><span><span>23</span><span><span>
</span></span></span><span><span>24</span><span><span>      </span><span>cnewpt</span><span> </span><span>=</span><span> </span><span>c_loc</span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>25</span><span><span>   </span><span>end</span><span> </span><span>function</span><span> </span><span>c_new_point</span><span>
</span></span></span><span><span>26</span><span><span>
</span></span></span><span><span>27</span><span><span>   </span><span>! Wrapper to set the x value of a point
</span></span></span><span><span>28</span><span><span></span><span>   </span><span>subroutine</span><span> </span><span>c_set_x</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>x</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>)</span><span>
</span></span></span><span><span>29</span><span><span>      </span><span>type</span><span>(</span><span>c_ptr</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>p_cptr</span><span>
</span></span></span><span><span>30</span><span><span>      </span><span>real</span><span>(</span><span>c_double</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>),</span><span> </span><span>value</span><span> </span><span>::</span><span> </span><span>x</span><span>
</span></span></span><span><span>31</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>32</span><span><span>
</span></span></span><span><span>33</span><span><span>      </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>p</span><span>)</span><span>
</span></span></span><span><span>34</span><span><span>      </span><span>call</span><span> </span><span>set_x</span><span>(</span><span>p</span><span>,</span><span> </span><span>x</span><span>)</span><span>
</span></span></span><span><span>35</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>c_set_x</span><span>
</span></span></span><span><span>36</span><span><span>
</span></span></span><span><span>37</span><span><span>   </span><span>! Wrapper to get the x value of a point
</span></span></span><span><span>38</span><span><span></span><span>   </span><span>function</span><span> </span><span>c_get_x</span><span>(</span><span>p_cptr</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>)</span><span> </span><span>result</span><span>(</span><span>x</span><span>)</span><span>
</span></span></span><span><span>39</span><span><span>      </span><span>type</span><span>(</span><span>c_ptr</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>p_cptr</span><span>
</span></span></span><span><span>40</span><span><span>      </span><span>real</span><span>(</span><span>c_double</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>
</span></span></span><span><span>41</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>42</span><span><span>
</span></span></span><span><span>43</span><span><span>      </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>p</span><span>)</span><span>
</span></span></span><span><span>44</span><span><span>      </span><span>x</span><span> </span><span>=</span><span> </span><span>get_x</span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>45</span><span><span>   </span><span>end</span><span> </span><span>function</span><span> </span><span>c_get_x</span><span>
</span></span></span><span><span>46</span><span><span>
</span></span></span><span><span>47</span><span><span>   </span><span>! Wrapper to set the y value of a point
</span></span></span><span><span>48</span><span><span></span><span>   </span><span>subroutine</span><span> </span><span>c_set_y</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>y</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>,</span><span> </span><span>name</span><span>=</span><span>&#39;c_set_y&#39;</span><span>)</span><span>
</span></span></span><span><span>49</span><span><span>      </span><span>type</span><span>(</span><span>c_ptr</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>p_cptr</span><span>
</span></span></span><span><span>50</span><span><span>      </span><span>real</span><span>(</span><span>c_double</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>),</span><span> </span><span>value</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span>51</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>52</span><span><span>
</span></span></span><span><span>53</span><span><span>      </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>p</span><span>)</span><span>
</span></span></span><span><span>54</span><span><span>      </span><span>call</span><span> </span><span>set_y</span><span>(</span><span>p</span><span>,</span><span> </span><span>y</span><span>)</span><span>
</span></span></span><span><span>55</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>c_set_y</span><span>
</span></span></span><span><span>56</span><span><span>
</span></span></span><span><span>57</span><span><span>   </span><span>! Wrapper to get the y value of a point
</span></span></span><span><span>58</span><span><span></span><span>   </span><span>function</span><span> </span><span>c_get_y</span><span>(</span><span>p_cptr</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>,</span><span> </span><span>name</span><span>=</span><span>&#39;c_get_y&#39;</span><span>)</span><span> </span><span>result</span><span>(</span><span>y</span><span>)</span><span>
</span></span></span><span><span>59</span><span><span>      </span><span>type</span><span>(</span><span>c_ptr</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>p_cptr</span><span>
</span></span></span><span><span>60</span><span><span>      </span><span>real</span><span>(</span><span>c_double</span><span>)</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span>61</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>62</span><span><span>
</span></span></span><span><span>63</span><span><span>      </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>p</span><span>)</span><span>
</span></span></span><span><span>64</span><span><span>      </span><span>y</span><span> </span><span>=</span><span> </span><span>get_y</span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>65</span><span><span>   </span><span>end</span><span> </span><span>function</span><span> </span><span>c_get_y</span><span>
</span></span></span><span><span>66</span><span><span>
</span></span></span><span><span>67</span><span><span>   </span><span>! Wrapper for deallocating a point
</span></span></span><span><span>68</span><span><span></span><span>   </span><span>subroutine</span><span> </span><span>c_delete_point</span><span>(</span><span>p_cptr</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>,</span><span> </span><span>name</span><span>=</span><span>&#39;c_delete_point&#39;</span><span>)</span><span>
</span></span></span><span><span>69</span><span><span>      </span><span>type</span><span>(</span><span>c_ptr</span><span>),</span><span> </span><span>intent</span><span>(</span><span>inout</span><span>)</span><span> </span><span>::</span><span> </span><span>p_cptr</span><span>
</span></span></span><span><span>70</span><span><span>      </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p</span><span>
</span></span></span><span><span>71</span><span><span>
</span></span></span><span><span>72</span><span><span>      </span><span>if</span><span> </span><span>(.</span><span>not</span><span>.</span><span> </span><span>c_associated</span><span>(</span><span>p_cptr</span><span>))</span><span> </span><span>return</span><span>
</span></span></span><span><span>73</span><span><span>      </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>p_cptr</span><span>,</span><span> </span><span>p</span><span>)</span><span>
</span></span></span><span><span>74</span><span><span>      </span><span>call</span><span> </span><span>destroy_point</span><span>(</span><span>p</span><span>)</span><span>
</span></span></span><span><span>75</span><span><span>      </span><span>p_cptr</span><span> </span><span>=</span><span> </span><span>c_null_ptr</span><span>
</span></span></span><span><span>76</span><span><span>   </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>c_delete_point</span><span>
</span></span></span><span><span>77</span><span><span>
</span></span></span><span><span>78</span><span><span></span><span>end</span><span> </span><span>module</span><span> </span><span>c_wrappers</span><span>
</span></span></span></code></pre></div><p>With the corresponding <code>C</code> file to test:</p><div><pre tabindex="0"><code data-lang="c"><span><span> 1</span><span><span>#include</span> <span>&lt;stdio.h&gt;</span><span>
</span></span></span><span><span> 2</span><span><span></span>
</span></span><span><span> 3</span><span><span>/* Declarations of Fortran functions */</span>
</span></span><span><span> 4</span><span><span>extern</span> <span>void</span> <span>*</span><span>c_new_point</span><span>(</span><span>double</span> <span>x</span><span>,</span> <span>double</span> <span>y</span><span>);</span>
</span></span><span><span> 5</span><span><span>extern</span> <span>void</span> <span>c_delete_point</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>);</span>
</span></span><span><span> 6</span><span><span>extern</span> <span>double</span> <span>c_get_x</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>);</span>
</span></span><span><span> 7</span><span><span>extern</span> <span>void</span> <span>c_set_x</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>,</span> <span>double</span> <span>x</span><span>);</span>
</span></span><span><span> 8</span><span><span>extern</span> <span>double</span> <span>c_get_y</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>);</span>
</span></span><span><span> 9</span><span><span>extern</span> <span>void</span> <span>c_set_y</span><span>(</span><span>void</span> <span>**</span><span>p</span><span>,</span> <span>double</span> <span>y</span><span>);</span>
</span></span><span><span>10</span><span>
</span></span><span><span>11</span><span><span>int</span> <span>main</span><span>()</span> <span>{</span>
</span></span><span><span>12</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>c_new_point</span><span>(</span><span>3.0</span><span>,</span> <span>4.0</span><span>);</span>
</span></span><span><span>13</span><span>  <span>if</span> <span>(</span><span>point</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>14</span><span>    <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>&#34;Failed to create point</span><span>\n</span><span>&#34;</span><span>);</span>
</span></span><span><span>15</span><span>    <span>return</span> <span>1</span><span>;</span>
</span></span><span><span>16</span><span>  <span>}</span>
</span></span><span><span>17</span><span>  <span>/* Retrieve the x and y values using the Fortran function */</span>
</span></span><span><span>18</span><span>  <span>double</span> <span>x</span> <span>=</span> <span>c_get_x</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span>19</span><span>  <span>double</span> <span>y</span> <span>=</span> <span>c_get_y</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span>20</span><span>
</span></span><span><span>21</span><span>  <span>printf</span><span>(</span><span>&#34;Point coordinates: x = %f, y = %f</span><span>\n</span><span>&#34;</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>);</span>
</span></span><span><span>22</span><span>
</span></span><span><span>23</span><span>  <span>/* Set the x and y values using the Fortran function */</span>
</span></span><span><span>24</span><span>  <span>c_set_x</span><span>(</span><span>&amp;</span><span>point</span><span>,</span> <span>5.0</span><span>);</span>
</span></span><span><span>25</span><span>  <span>c_set_y</span><span>(</span><span>&amp;</span><span>point</span><span>,</span> <span>6.0</span><span>);</span>
</span></span><span><span>26</span><span>
</span></span><span><span>27</span><span>  <span>printf</span><span>(</span><span>&#34;Point coordinates after set: x = %f, y = %f</span><span>\n</span><span>&#34;</span><span>,</span> <span>c_get_x</span><span>(</span><span>&amp;</span><span>point</span><span>),</span>
</span></span><span><span>28</span><span>         <span>c_get_y</span><span>(</span><span>&amp;</span><span>point</span><span>));</span>
</span></span><span><span>29</span><span>
</span></span><span><span>30</span><span>  <span>/* Clean up and delete the point using the Fortran function */</span>
</span></span><span><span>31</span><span>  <span>c_delete_point</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span>32</span><span>
</span></span><span><span>33</span><span>  <span>return</span> <span>0</span><span>;</span>
</span></span><span><span>34</span><span><span>}</span>
</span></span></code></pre></div><p>Which can be compiled and run with the following addition to the
existing <code>meson.build</code>:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>executable<span>(</span><span>&#39;ctestf&#39;</span>,
</span></span><span><span>2</span><span>           <span>&#39;testc.c&#39;</span>,
</span></span><span><span>3</span><span>           <span>&#39;point.f90&#39;</span>,
</span></span><span><span>4</span><span>           <span>&#39;cwrappers.f90&#39;</span><span>)</span>
</span></span></code></pre></div><p>With:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>meson compile -C bbdir
</span></span><span><span>2</span><span>./bbdir/ctestf
</span></span><span><span>3</span><span>Point coordinates: <span>x</span> <span>=</span> 3.000000, <span>y</span> <span>=</span> 4.000000
</span></span><span><span>4</span><span>Point coordinates after set: <span>x</span> <span>=</span> 5.000000, <span>y</span> <span>=</span> 6.000000
</span></span></code></pre></div><h3 id="python-c-interface">Python-C Interface</h3><p>The key take-away here is to use a
<a href="https://docs.python.org/3/c-api/capsule.html">PyCapsule</a> object which:</p><blockquote><p>represents an opaque value, useful for C extension modules who need to
pass an opaque value (as a void* pointer) through Python code to
other C code.</p></blockquote><p>In our case the opaque value needs to travel a bit further along and go
through to Fortran and back, but the principle (and implementation) is
the same. The <code>C</code> function calls will be the same, the only difference
being the structure used, unlike in “shadowing” approaches, the <code>struct</code>
will have neither <code>C</code> interop nor <code>Fortran</code> information. So we start
with:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>/* Point object definition */</span>
</span></span><span><span>2</span><span><span>typedef</span> <span>struct</span> <span>{</span>
</span></span><span><span>3</span><span>  <span>PyObject_HEAD</span>
</span></span><span><span>4</span><span>  <span>PyObject</span> <span>*</span><span>capsule</span><span>;</span>
</span></span><span><span>5</span><span><span>}</span> <span>PyPointObject</span><span>;</span>
</span></span></code></pre></div><p>This is simplicity itself. Naturally we need to actually grab the right
object from the capsule before use. Additionally, there are a few
nuances, e.g. before defining creation we need to define cleanup:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>void</span> <span>point_capsule_destructor</span><span>(</span><span>PyObject</span> <span>*</span><span>capsule</span><span>)</span> <span>{</span>
</span></span><span><span>2</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span>3</span><span>  <span>if</span> <span>(</span><span>point</span><span>)</span> <span>{</span>
</span></span><span><span>4</span><span>    <span>c_delete_point</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span>5</span><span>  <span>}</span>
</span></span><span><span>6</span><span><span>}</span>
</span></span></code></pre></div><p>Creation is simply via <code>PyCapsule_New</code> once appropriate steps
(unpacking, error handling) are taken.</p><div><pre tabindex="0"><code data-lang="c"><span><span> 1</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>PyPoint_new</span><span>(</span><span>PyTypeObject</span> <span>*</span><span>type</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span>
</span></span><span><span> 2</span><span>                             <span>PyObject</span> <span>*</span><span>kwds</span><span>)</span> <span>{</span>
</span></span><span><span> 3</span><span>  <span>double</span> <span>x</span><span>,</span> <span>y</span><span>;</span>
</span></span><span><span> 4</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyArg_ParseTuple</span><span>(</span><span>args</span><span>,</span> <span>&#34;dd&#34;</span><span>,</span> <span>&amp;</span><span>x</span><span>,</span> <span>&amp;</span><span>y</span><span>))</span> <span>{</span>
</span></span><span><span> 5</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span> 6</span><span>  <span>}</span>
</span></span><span><span> 7</span><span>
</span></span><span><span> 8</span><span>  <span>PyPointObject</span> <span>*</span><span>self</span> <span>=</span> <span>(</span><span>PyPointObject</span> <span>*</span><span>)</span><span>type</span><span>-&gt;</span><span>tp_alloc</span><span>(</span><span>type</span><span>,</span> <span>0</span><span>);</span>
</span></span><span><span> 9</span><span>  <span>if</span> <span>(</span><span>self</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>10</span><span>    <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>c_new_point</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>);</span>
</span></span><span><span>11</span><span>    <span>if</span> <span>(</span><span>point</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>12</span><span>      <span>Py_DECREF</span><span>(</span><span>self</span><span>);</span>
</span></span><span><span>13</span><span>      <span>return</span> <span>PyErr_NoMemory</span><span>();</span>
</span></span><span><span>14</span><span>    <span>}</span>
</span></span><span><span>15</span><span>    <span>self</span><span>-&gt;</span><span>capsule</span> <span>=</span>
</span></span><span><span>16</span><span>        <span>PyCapsule_New</span><span>(</span><span>point</span><span>,</span> <span>&#34;point._Point&#34;</span><span>,</span> <span>point_capsule_destructor</span><span>);</span>
</span></span><span><span>17</span><span>    <span>if</span> <span>(</span><span>self</span><span>-&gt;</span><span>capsule</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>18</span><span>      <span>c_delete_point</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span>19</span><span>      <span>Py_DECREF</span><span>(</span><span>self</span><span>);</span>
</span></span><span><span>20</span><span>      <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>21</span><span>    <span>}</span>
</span></span><span><span>22</span><span>  <span>}</span>
</span></span><span><span>23</span><span>  <span>return</span> <span>(</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>;</span>
</span></span><span><span>24</span><span><span>}</span>
</span></span></code></pre></div><p>Since the rest of this is standard, including <code>PyFloat_FromDouble</code> and
the rest of the C-Python API, we will move onto the building and testing
phase.</p><h4 id="building-and-testing">Building and testing</h4><p>The full file, including boilerplate defining the module (detailed in
earlier posts) is:</p><div><pre tabindex="0"><code data-lang="c"><span><span>  1</span><span><span>#ifndef PY_SSIZE_T_CLEAN
</span></span></span><span><span>  2</span><span><span>#define PY_SSIZE_T_CLEAN
</span></span></span><span><span>  3</span><span><span>#include</span> <span>&lt;stdio.h&gt;</span><span>
</span></span></span><span><span>  4</span><span><span>#endif </span><span>/* PY_SSIZE_T_CLEAN */</span><span>
</span></span></span><span><span>  5</span><span><span></span>
</span></span><span><span>  6</span><span><span>#include</span> <span>&#34;Python.h&#34;</span><span>
</span></span></span><span><span>  7</span><span><span>#include</span> <span>&#34;point.h&#34;</span><span>
</span></span></span><span><span>  8</span><span><span>#include</span> <span>&#34;structmember.h&#34;</span><span>
</span></span></span><span><span>  9</span><span><span></span>
</span></span><span><span> 10</span><span><span>void</span> <span>point_capsule_destructor</span><span>(</span><span>PyObject</span> <span>*</span><span>capsule</span><span>)</span> <span>{</span>
</span></span><span><span> 11</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span> 12</span><span>  <span>if</span> <span>(</span><span>point</span><span>)</span> <span>{</span>
</span></span><span><span> 13</span><span>    <span>c_delete_point</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span> 14</span><span>  <span>}</span>
</span></span><span><span> 15</span><span><span>}</span>
</span></span><span><span> 16</span><span>
</span></span><span><span> 17</span><span><span>/* Point object definition */</span>
</span></span><span><span> 18</span><span><span>typedef</span> <span>struct</span> <span>{</span>
</span></span><span><span> 19</span><span>  <span>PyObject_HEAD</span>
</span></span><span><span> 20</span><span>  <span>PyObject</span> <span>*</span><span>capsule</span><span>;</span>
</span></span><span><span> 21</span><span><span>}</span> <span>PyPointObject</span><span>;</span>
</span></span><span><span> 22</span><span>
</span></span><span><span> 23</span><span><span>/* Deallocates the PyPointObject */</span>
</span></span><span><span> 24</span><span><span>static</span> <span>void</span> <span>PyPoint_dealloc</span><span>(</span><span>PyPointObject</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span> 25</span><span>  <span>Py_XDECREF</span><span>(</span><span>self</span><span>-&gt;</span><span>capsule</span><span>);</span>
</span></span><span><span> 26</span><span>  <span>Py_TYPE</span><span>(</span><span>self</span><span>)</span><span>-&gt;</span><span>tp_free</span><span>((</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>);</span>
</span></span><span><span> 27</span><span><span>}</span>
</span></span><span><span> 28</span><span>
</span></span><span><span> 29</span><span><span>/* Creates a new PyPointObject */</span>
</span></span><span><span> 30</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>PyPoint_new</span><span>(</span><span>PyTypeObject</span> <span>*</span><span>type</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span>
</span></span><span><span> 31</span><span>                             <span>PyObject</span> <span>*</span><span>kwds</span><span>)</span> <span>{</span>
</span></span><span><span> 32</span><span>  <span>double</span> <span>x</span><span>,</span> <span>y</span><span>;</span>
</span></span><span><span> 33</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyArg_ParseTuple</span><span>(</span><span>args</span><span>,</span> <span>&#34;dd&#34;</span><span>,</span> <span>&amp;</span><span>x</span><span>,</span> <span>&amp;</span><span>y</span><span>))</span> <span>{</span>
</span></span><span><span> 34</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span> 35</span><span>  <span>}</span>
</span></span><span><span> 36</span><span>
</span></span><span><span> 37</span><span>  <span>PyPointObject</span> <span>*</span><span>self</span> <span>=</span> <span>(</span><span>PyPointObject</span> <span>*</span><span>)</span><span>type</span><span>-&gt;</span><span>tp_alloc</span><span>(</span><span>type</span><span>,</span> <span>0</span><span>);</span>
</span></span><span><span> 38</span><span>  <span>if</span> <span>(</span><span>self</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span> 39</span><span>    <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>c_new_point</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>);</span>
</span></span><span><span> 40</span><span>    <span>if</span> <span>(</span><span>point</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span> 41</span><span>      <span>Py_DECREF</span><span>(</span><span>self</span><span>);</span>
</span></span><span><span> 42</span><span>      <span>return</span> <span>PyErr_NoMemory</span><span>();</span>
</span></span><span><span> 43</span><span>    <span>}</span>
</span></span><span><span> 44</span><span>    <span>self</span><span>-&gt;</span><span>capsule</span> <span>=</span>
</span></span><span><span> 45</span><span>        <span>PyCapsule_New</span><span>(</span><span>point</span><span>,</span> <span>&#34;point._Point&#34;</span><span>,</span> <span>point_capsule_destructor</span><span>);</span>
</span></span><span><span> 46</span><span>    <span>if</span> <span>(</span><span>self</span><span>-&gt;</span><span>capsule</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span> 47</span><span>      <span>c_delete_point</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span> 48</span><span>      <span>Py_DECREF</span><span>(</span><span>self</span><span>);</span>
</span></span><span><span> 49</span><span>      <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span> 50</span><span>    <span>}</span>
</span></span><span><span> 51</span><span>  <span>}</span>
</span></span><span><span> 52</span><span>  <span>return</span> <span>(</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>;</span>
</span></span><span><span> 53</span><span><span>}</span>
</span></span><span><span> 54</span><span>
</span></span><span><span> 55</span><span><span>/* Getter for the &#39;x&#39; attribute */</span>
</span></span><span><span> 56</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>PyPoint_getx</span><span>(</span><span>PyPointObject</span> <span>*</span><span>self</span><span>,</span> <span>void</span> <span>*</span><span>closure</span><span>)</span> <span>{</span>
</span></span><span><span> 57</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>self</span><span>-&gt;</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span> 58</span><span>  <span>double</span> <span>x</span> <span>=</span> <span>c_get_x</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span> 59</span><span>  <span>return</span> <span>PyFloat_FromDouble</span><span>(</span><span>x</span><span>);</span>
</span></span><span><span> 60</span><span><span>}</span>
</span></span><span><span> 61</span><span>
</span></span><span><span> 62</span><span><span>/* Setter for the &#39;x&#39; attribute */</span>
</span></span><span><span> 63</span><span><span>static</span> <span>int</span> <span>PyPoint_setx</span><span>(</span><span>PyPointObject</span> <span>*</span><span>self</span><span>,</span> <span>PyObject</span> <span>*</span><span>value</span><span>,</span> <span>void</span> <span>*</span><span>closure</span><span>)</span> <span>{</span>
</span></span><span><span> 64</span><span>  <span>if</span> <span>(</span><span>value</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span> 65</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_TypeError</span><span>,</span> <span>&#34;Cannot delete the x attribute&#34;</span><span>);</span>
</span></span><span><span> 66</span><span>    <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span> 67</span><span>  <span>}</span>
</span></span><span><span> 68</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyFloat_Check</span><span>(</span><span>value</span><span>))</span> <span>{</span>
</span></span><span><span> 69</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_TypeError</span><span>,</span> <span>&#34;The x attribute value must be a float&#34;</span><span>);</span>
</span></span><span><span> 70</span><span>    <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span> 71</span><span>  <span>}</span>
</span></span><span><span> 72</span><span>  <span>double</span> <span>x</span> <span>=</span> <span>PyFloat_AsDouble</span><span>(</span><span>value</span><span>);</span>
</span></span><span><span> 73</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>self</span><span>-&gt;</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span> 74</span><span>  <span>c_set_x</span><span>(</span><span>&amp;</span><span>point</span><span>,</span> <span>x</span><span>);</span>
</span></span><span><span> 75</span><span>  <span>return</span> <span>0</span><span>;</span>
</span></span><span><span> 76</span><span><span>}</span>
</span></span><span><span> 77</span><span>
</span></span><span><span> 78</span><span><span>/* Getter for the &#39;y&#39; attribute */</span>
</span></span><span><span> 79</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>PyPoint_gety</span><span>(</span><span>PyPointObject</span> <span>*</span><span>self</span><span>,</span> <span>void</span> <span>*</span><span>closure</span><span>)</span> <span>{</span>
</span></span><span><span> 80</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>self</span><span>-&gt;</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span> 81</span><span>  <span>double</span> <span>y</span> <span>=</span> <span>c_get_y</span><span>(</span><span>&amp;</span><span>point</span><span>);</span>
</span></span><span><span> 82</span><span>  <span>return</span> <span>PyFloat_FromDouble</span><span>(</span><span>y</span><span>);</span>
</span></span><span><span> 83</span><span><span>}</span>
</span></span><span><span> 84</span><span>
</span></span><span><span> 85</span><span><span>/* Setter for the &#39;y&#39; attribute */</span>
</span></span><span><span> 86</span><span><span>static</span> <span>int</span> <span>PyPoint_sety</span><span>(</span><span>PyPointObject</span> <span>*</span><span>self</span><span>,</span> <span>PyObject</span> <span>*</span><span>value</span><span>,</span> <span>void</span> <span>*</span><span>closure</span><span>)</span> <span>{</span>
</span></span><span><span> 87</span><span>  <span>if</span> <span>(</span><span>value</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span> 88</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_TypeError</span><span>,</span> <span>&#34;Cannot delete the y attribute&#34;</span><span>);</span>
</span></span><span><span> 89</span><span>    <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span> 90</span><span>  <span>}</span>
</span></span><span><span> 91</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyFloat_Check</span><span>(</span><span>value</span><span>))</span> <span>{</span>
</span></span><span><span> 92</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_TypeError</span><span>,</span> <span>&#34;The y attribute value must be a float&#34;</span><span>);</span>
</span></span><span><span> 93</span><span>    <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span> 94</span><span>  <span>}</span>
</span></span><span><span> 95</span><span>  <span>double</span> <span>y</span> <span>=</span> <span>PyFloat_AsDouble</span><span>(</span><span>value</span><span>);</span>
</span></span><span><span> 96</span><span>  <span>void</span> <span>*</span><span>point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>self</span><span>-&gt;</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span> 97</span><span>  <span>c_set_y</span><span>(</span><span>&amp;</span><span>point</span><span>,</span> <span>y</span><span>);</span>
</span></span><span><span> 98</span><span>  <span>return</span> <span>0</span><span>;</span>
</span></span><span><span> 99</span><span><span>}</span>
</span></span><span><span>100</span><span>
</span></span><span><span>101</span><span><span>/* Define the properties of the Point type */</span>
</span></span><span><span>102</span><span><span>static</span> <span>PyGetSetDef</span> <span>PyPoint_getseters</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span>103</span><span>    <span>{</span><span>&#34;x&#34;</span><span>,</span> <span>(</span><span>getter</span><span>)</span><span>PyPoint_getx</span><span>,</span> <span>(</span><span>setter</span><span>)</span><span>PyPoint_setx</span><span>,</span> <span>&#34;x coordinate&#34;</span><span>,</span> <span>NULL</span><span>},</span>
</span></span><span><span>104</span><span>    <span>{</span><span>&#34;y&#34;</span><span>,</span> <span>(</span><span>getter</span><span>)</span><span>PyPoint_gety</span><span>,</span> <span>(</span><span>setter</span><span>)</span><span>PyPoint_sety</span><span>,</span> <span>&#34;y coordinate&#34;</span><span>,</span> <span>NULL</span><span>},</span>
</span></span><span><span>105</span><span>    <span>{</span><span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span>106</span><span><span>};</span>
</span></span><span><span>107</span><span>
</span></span><span><span>108</span><span><span>/* Initializes the PyPointType object */</span>
</span></span><span><span>109</span><span><span>static</span> <span>PyTypeObject</span> <span>PyPointType</span> <span>=</span> <span>{</span>
</span></span><span><span>110</span><span>    <span>PyVarObject_HEAD_INIT</span><span>(</span><span>NULL</span><span>,</span> <span>0</span><span>).</span><span>tp_name</span> <span>=</span> <span>&#34;point.Point&#34;</span><span>,</span>
</span></span><span><span>111</span><span>    <span>.</span><span>tp_doc</span> <span>=</span> <span>&#34;Point objects&#34;</span><span>,</span>
</span></span><span><span>112</span><span>    <span>.</span><span>tp_basicsize</span> <span>=</span> <span>sizeof</span><span>(</span><span>PyPointObject</span><span>),</span>
</span></span><span><span>113</span><span>    <span>.</span><span>tp_itemsize</span> <span>=</span> <span>0</span><span>,</span>
</span></span><span><span>114</span><span>    <span>.</span><span>tp_flags</span> <span>=</span> <span>Py_TPFLAGS_DEFAULT</span> <span>|</span> <span>Py_TPFLAGS_BASETYPE</span><span>,</span>
</span></span><span><span>115</span><span>    <span>.</span><span>tp_new</span> <span>=</span> <span>PyPoint_new</span><span>,</span>
</span></span><span><span>116</span><span>    <span>.</span><span>tp_dealloc</span> <span>=</span> <span>(</span><span>destructor</span><span>)</span><span>PyPoint_dealloc</span><span>,</span>
</span></span><span><span>117</span><span>    <span>.</span><span>tp_getset</span> <span>=</span> <span>PyPoint_getseters</span><span>,</span>
</span></span><span><span>118</span><span><span>};</span>
</span></span><span><span>119</span><span>
</span></span><span><span>120</span><span><span>static</span> <span>PyMethodDef</span> <span>point_methods</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span>121</span><span>    <span>{</span><span>NULL</span><span>,</span> <span>NULL</span><span>,</span> <span>0</span><span>,</span> <span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span>122</span><span><span>};</span>
</span></span><span><span>123</span><span>
</span></span><span><span>124</span><span><span>/* Initializes the point module */</span>
</span></span><span><span>125</span><span><span>static</span> <span>PyModuleDef</span> <span>pointmodule</span> <span>=</span> <span>{</span>
</span></span><span><span>126</span><span>    <span>PyModuleDef_HEAD_INIT</span><span>,</span>
</span></span><span><span>127</span><span>    <span>.</span><span>m_name</span> <span>=</span> <span>&#34;point&#34;</span><span>,</span>
</span></span><span><span>128</span><span>    <span>.</span><span>m_doc</span> <span>=</span> <span>&#34;Module that provides a Point object.&#34;</span><span>,</span>
</span></span><span><span>129</span><span>    <span>.</span><span>m_size</span> <span>=</span> <span>-</span><span>1</span><span>,</span>
</span></span><span><span>130</span><span>    <span>.</span><span>m_methods</span> <span>=</span> <span>point_methods</span><span>,</span>
</span></span><span><span>131</span><span><span>};</span>
</span></span><span><span>132</span><span>
</span></span><span><span>133</span><span><span>PyMODINIT_FUNC</span> <span>PyInit_point</span><span>(</span><span>void</span><span>)</span> <span>{</span>
</span></span><span><span>134</span><span>  <span>if</span> <span>(</span><span>PyType_Ready</span><span>(</span><span>&amp;</span><span>PyPointType</span><span>)</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span>135</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>136</span><span>  <span>}</span>
</span></span><span><span>137</span><span>
</span></span><span><span>138</span><span>  <span>PyObject</span> <span>*</span><span>m</span> <span>=</span> <span>PyModule_Create</span><span>(</span><span>&amp;</span><span>pointmodule</span><span>);</span>
</span></span><span><span>139</span><span>  <span>if</span> <span>(</span><span>m</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>140</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>141</span><span>  <span>}</span>
</span></span><span><span>142</span><span>
</span></span><span><span>143</span><span>  <span>Py_INCREF</span><span>(</span><span>&amp;</span><span>PyPointType</span><span>);</span>
</span></span><span><span>144</span><span>  <span>if</span> <span>(</span><span>PyModule_AddObject</span><span>(</span><span>m</span><span>,</span> <span>&#34;Point&#34;</span><span>,</span> <span>(</span><span>PyObject</span> <span>*</span><span>)</span><span>&amp;</span><span>PyPointType</span><span>)</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span>145</span><span>    <span>Py_DECREF</span><span>(</span><span>&amp;</span><span>PyPointType</span><span>);</span>
</span></span><span><span>146</span><span>    <span>Py_DECREF</span><span>(</span><span>m</span><span>);</span>
</span></span><span><span>147</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>148</span><span>  <span>}</span>
</span></span><span><span>149</span><span>
</span></span><span><span>150</span><span>  <span>return</span> <span>m</span><span>;</span>
</span></span><span><span>151</span><span><span>}</span>
</span></span></code></pre></div><p>Which needs some additions to the <code>meson.build</code> <sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup></p><div><pre tabindex="0"><code data-lang="meson"><span><span> 1</span><span><span>py_mod</span><span> </span><span>=</span><span> </span><span>import</span><span>(</span><span>&#39;python&#39;</span><span>)</span><span>
</span></span></span><span><span> 2</span><span><span></span><span>py3</span><span> </span><span>=</span><span> </span><span>py_mod</span><span>.</span><span>find_installation</span><span>(</span><span>&#39;python3&#39;</span><span>)</span><span>
</span></span></span><span><span> 3</span><span><span></span><span>py3_dep</span><span> </span><span>=</span><span> </span><span>py3</span><span>.</span><span>dependency</span><span>()</span><span>
</span></span></span><span><span> 4</span><span><span></span><span>message</span><span>(</span><span>py3</span><span>.</span><span>path</span><span>())</span><span>
</span></span></span><span><span> 5</span><span><span></span><span>message</span><span>(</span><span>py3</span><span>.</span><span>get_install_dir</span><span>())</span><span>
</span></span></span><span><span> 6</span><span><span>
</span></span></span><span><span> 7</span><span><span></span><span># Python Class Representation</span><span>
</span></span></span><span><span> 8</span><span><span></span><span>py3</span><span>.</span><span>extension_module</span><span>(</span><span>&#39;point&#39;</span><span>,</span><span>
</span></span></span><span><span> 9</span><span><span>           </span><span>&#39;point.f90&#39;</span><span>,</span><span>
</span></span></span><span><span>10</span><span><span>           </span><span>&#39;cwrappers.f90&#39;</span><span>,</span><span>
</span></span></span><span><span>11</span><span><span>           </span><span>&#39;pointcapsule.c&#39;</span><span>,</span><span>
</span></span></span><span><span>12</span><span><span>           </span><span>dependencies</span><span> </span><span>:</span><span> </span><span>py3_dep</span><span>,</span><span>
</span></span></span><span><span>13</span><span><span>           </span><span>install</span><span> </span><span>:</span><span> </span><span>true</span><span>)</span><span>
</span></span></span></code></pre></div><p>With a simple <code>pytest</code> in <code>tests/test_simple.py</code>:</p><div><pre tabindex="0"><code data-lang="python"><span><span>1</span><span><span>from</span> <span>point</span> <span>import</span> <span>Point</span>
</span></span><span><span>2</span><span>
</span></span><span><span>3</span><span><span>def</span> <span>test_point</span><span>():</span>
</span></span><span><span>4</span><span>    <span>p</span> <span>=</span> <span>Point</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
</span></span><span><span>5</span><span>    <span>assert</span> <span>p</span><span>.</span><span>x</span> <span>==</span> <span>1</span>
</span></span><span><span>6</span><span>    <span>assert</span> <span>p</span><span>.</span><span>y</span> <span>==</span> <span>2</span>
</span></span><span><span>7</span><span>    <span>assert</span> <span>p</span> <span>!=</span> <span>Point</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
</span></span></code></pre></div><p>Can be compiled and run with:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>meson compile -C bbdir
</span></span><span><span>2</span><span><span>export</span> <span>PYTHONPATH</span><span>=</span><span>$PYTHONPATH</span>:<span>$(</span><span>pwd</span><span>)</span>/bbdir
</span></span><span><span>3</span><span>pytest
</span></span></code></pre></div><p>Note that we have not (yet) defined any type bound proceedures, so there
are no operations defined between <code>Point</code> objects or anything else.</p><h2 id="binding-type-bound-proceedures">Binding type bound proceedures</h2><p>Given the structure discussed so far, adding a type bound proceedure is
nearly seamless. We need to modify the type definition.</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>type</span><span> </span><span>::</span><span> </span><span>Point</span><span>
</span></span></span><span><span>2</span><span><span>   </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>x</span><span>
</span></span></span><span><span>3</span><span><span>   </span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span>4</span><span><span></span><span>contains</span><span>
</span></span></span><span><span>5</span><span><span>   </span><span>procedure</span><span>,</span><span> </span><span>pass</span><span>(</span><span>self</span><span>)</span><span> </span><span>::</span><span> </span><span>euclidean_distance</span><span>
</span></span></span><span><span>6</span><span><span></span><span>end</span><span> </span><span>type</span><span> </span><span>Point</span><span>
</span></span></span></code></pre></div><p>Followed by adding a “handle” for it:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>real</span><span>(</span><span>8</span><span>)</span><span> </span><span>function</span><span> </span><span>euclidean_distance</span><span>(</span><span>self</span><span>,</span><span> </span><span>other</span><span>)</span><span> </span><span>result</span><span>(</span><span>distance</span><span>)</span><span>
</span></span></span><span><span>2</span><span><span>   </span><span>class</span><span>(</span><span>Point</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>self</span><span>,</span><span> </span><span>other</span><span>
</span></span></span><span><span>3</span><span><span>   </span><span>distance</span><span> </span><span>=</span><span> </span><span>sqrt</span><span>((</span><span>self</span><span>%</span><span>x</span><span> </span><span>-</span><span> </span><span>other</span><span>%</span><span>x</span><span>)</span><span>**</span><span>2</span><span> </span><span>+</span><span> </span><span>(</span><span>self</span><span>%</span><span>y</span><span> </span><span>-</span><span> </span><span>other</span><span>%</span><span>y</span><span>)</span><span>**</span><span>2</span><span>)</span><span>
</span></span></span><span><span>4</span><span><span></span><span>end</span><span> </span><span>function</span><span> </span><span>euclidean_distance</span><span>
</span></span></span></code></pre></div><p>Along with a wrapper:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>function</span><span> </span><span>c_euclidean_distance</span><span>(</span><span>this_cptr</span><span>,</span><span> </span><span>other_cptr</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>)</span><span> </span><span>result</span><span>(</span><span>y</span><span>)</span><span>
</span></span></span><span><span>2</span><span><span>   </span><span>type</span><span>(</span><span>c_ptr</span><span>),</span><span> </span><span>value</span><span> </span><span>::</span><span> </span><span>this_cptr</span><span>,</span><span> </span><span>other_cptr</span><span>
</span></span></span><span><span>3</span><span><span>   </span><span>real</span><span>(</span><span>c_double</span><span>)</span><span> </span><span>::</span><span> </span><span>y</span><span>
</span></span></span><span><span>4</span><span><span>   </span><span>type</span><span>(</span><span>Point</span><span>),</span><span> </span><span>pointer</span><span> </span><span>::</span><span> </span><span>p1</span><span>,</span><span> </span><span>p2</span><span>
</span></span></span><span><span>5</span><span><span>   </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>this_cptr</span><span>,</span><span> </span><span>p1</span><span>)</span><span>
</span></span></span><span><span>6</span><span><span>   </span><span>call</span><span> </span><span>c_f_pointer</span><span>(</span><span>other_cptr</span><span>,</span><span> </span><span>p2</span><span>)</span><span>
</span></span></span><span><span>7</span><span><span>   </span><span>y</span><span> </span><span>=</span><span> </span><span>p1</span><span>%</span><span>euclidean_distance</span><span>(</span><span>p2</span><span>)</span><span>
</span></span></span><span><span>8</span><span><span></span><span>end</span><span> </span><span>function</span><span> </span><span>c_euclidean_distance</span><span>
</span></span></span></code></pre></div><p>Which can be called from <code>C</code> via:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>extern</span> <span>double</span> <span>c_euclidean_distance</span><span>(</span><span>void</span> <span>*</span><span>p1</span><span>,</span> <span>void</span> <span>*</span><span>p2</span><span>);</span>
</span></span></code></pre></div><p>Finally the <code>python-C</code> code requires only the direct addition of the
method:</p><div><pre tabindex="0"><code data-lang="c"><span><span> 1</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>PyPoint_euclidean_distance</span><span>(</span><span>PyPointObject</span> <span>*</span><span>self</span><span>,</span>
</span></span><span><span> 2</span><span>                                            <span>PyObject</span> <span>*</span><span>args</span><span>)</span> <span>{</span>
</span></span><span><span> 3</span><span>  <span>PyObject</span> <span>*</span><span>other</span><span>;</span>
</span></span><span><span> 4</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyArg_ParseTuple</span><span>(</span><span>args</span><span>,</span> <span>&#34;O&#34;</span><span>,</span> <span>&amp;</span><span>other</span><span>))</span> <span>{</span>
</span></span><span><span> 5</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span> 6</span><span>  <span>}</span>
</span></span><span><span> 7</span><span>
</span></span><span><span> 8</span><span>  <span>/* Check if &#39;other&#39; is a PyPointObject instance by comparing type names */</span>
</span></span><span><span> 9</span><span>  <span>if</span> <span>(</span><span>strcmp</span><span>(</span><span>other</span><span>-&gt;</span><span>ob_type</span><span>-&gt;</span><span>tp_name</span><span>,</span> <span>&#34;point.Point&#34;</span><span>)</span> <span>!=</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span>10</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_TypeError</span><span>,</span> <span>&#34;Argument must be a Point instance&#34;</span><span>);</span>
</span></span><span><span>11</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>12</span><span>  <span>}</span>
</span></span><span><span>13</span><span>
</span></span><span><span>14</span><span>  <span>/* Ensure &#39;other&#39; is a capsule before getting the pointer */</span>
</span></span><span><span>15</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyCapsule_CheckExact</span><span>(((</span><span>PyPointObject</span> <span>*</span><span>)</span><span>other</span><span>)</span><span>-&gt;</span><span>capsule</span><span>))</span> <span>{</span>
</span></span><span><span>16</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_TypeError</span><span>,</span> <span>&#34;Argument is not a Point capsule&#34;</span><span>);</span>
</span></span><span><span>17</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>18</span><span>  <span>}</span>
</span></span><span><span>19</span><span>
</span></span><span><span>20</span><span>  <span>void</span> <span>*</span><span>self_point</span> <span>=</span> <span>PyCapsule_GetPointer</span><span>(</span><span>self</span><span>-&gt;</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span>21</span><span>  <span>void</span> <span>*</span><span>other_point</span> <span>=</span>
</span></span><span><span>22</span><span>      <span>PyCapsule_GetPointer</span><span>(((</span><span>PyPointObject</span> <span>*</span><span>)</span><span>other</span><span>)</span><span>-&gt;</span><span>capsule</span><span>,</span> <span>&#34;point._Point&#34;</span><span>);</span>
</span></span><span><span>23</span><span>
</span></span><span><span>24</span><span>  <span>if</span> <span>(</span><span>!</span><span>self_point</span> <span>||</span> <span>!</span><span>other_point</span><span>)</span> <span>{</span>
</span></span><span><span>25</span><span>    <span>PyErr_SetString</span><span>(</span><span>PyExc_RuntimeError</span><span>,</span> <span>&#34;Failed to get Point from capsule&#34;</span><span>);</span>
</span></span><span><span>26</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>27</span><span>  <span>}</span>
</span></span><span><span>28</span><span>
</span></span><span><span>29</span><span>  <span>double</span> <span>distance</span> <span>=</span> <span>c_euclidean_distance</span><span>(</span><span>self_point</span><span>,</span> <span>other_point</span><span>);</span>
</span></span><span><span>30</span><span>  <span>return</span> <span>PyFloat_FromDouble</span><span>(</span><span>distance</span><span>);</span>
</span></span><span><span>31</span><span><span>}</span>
</span></span><span><span>32</span><span>
</span></span><span><span>33</span><span><span>/* Define the methods */</span>
</span></span><span><span>34</span><span><span>static</span> <span>PyMethodDef</span> <span>point_methods</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span>35</span><span>    <span>{</span><span>&#34;euclidean_distance&#34;</span><span>,</span> <span>(</span><span>PyCFunction</span><span>)</span><span>PyPoint_euclidean_distance</span><span>,</span>
</span></span><span><span>36</span><span>     <span>METH_VARARGS</span><span>,</span> <span>&#34;Calculate the Euclidean distance to another Point&#34;</span><span>},</span>
</span></span><span><span>37</span><span>    <span>{</span><span>NULL</span><span>,</span> <span>NULL</span><span>,</span> <span>0</span><span>,</span> <span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span>38</span><span><span>};</span>
</span></span></code></pre></div><p>This can now be used to pass a more stringent set of tests:</p><div><pre tabindex="0"><code data-lang="python"><span><span> 1</span><span><span>from</span> <span>point</span> <span>import</span> <span>Point</span>
</span></span><span><span> 2</span><span>
</span></span><span><span> 3</span><span><span>def</span> <span>test_point</span><span>():</span>
</span></span><span><span> 4</span><span>    <span>p</span> <span>=</span> <span>Point</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
</span></span><span><span> 5</span><span>    <span>assert</span> <span>p</span><span>.</span><span>x</span> <span>==</span> <span>1</span>
</span></span><span><span> 6</span><span>    <span>assert</span> <span>p</span><span>.</span><span>y</span> <span>==</span> <span>2</span>
</span></span><span><span> 7</span><span>    <span>assert</span> <span>p</span> <span>!=</span> <span>Point</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
</span></span><span><span> 8</span><span>
</span></span><span><span> 9</span><span><span>def</span> <span>test_point_euclid</span><span>():</span>
</span></span><span><span>10</span><span>    <span>p</span> <span>=</span> <span>Point</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
</span></span><span><span>11</span><span>    <span>p2</span> <span>=</span> <span>Point</span><span>(</span><span>2</span><span>,</span> <span>5</span><span>)</span>
</span></span><span><span>12</span><span>    <span>assert</span> <span>p</span><span>.</span><span>euclidean_distance</span><span>(</span><span>p2</span><span>)</span> <span>==</span> <span>3.1622776601683795</span>
</span></span><span><span>13</span><span>
</span></span><span><span>14</span><span><span>def</span> <span>test_fails</span><span>():</span>
</span></span><span><span>15</span><span>    <span>p</span> <span>=</span> <span>Point</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
</span></span><span><span>16</span><span>    <span>with</span> <span>pytest</span><span>.</span><span>raises</span><span>(</span><span>TypeError</span><span>)</span> <span>as</span> <span>e_info</span><span>:</span>
</span></span><span><span>17</span><span>        <span>p</span><span>.</span><span>euclidean_distance</span><span>(</span><span>1</span><span>)</span>
</span></span><span><span>18</span><span>    <span>assert</span> <span>str</span><span>(</span><span>e_info</span><span>.</span><span>value</span><span>)</span> <span>==</span> <span>&#34;Argument must be a Point instance&#34;</span>
</span></span></code></pre></div><h2 id="towards-allocatable-components-and-f2py-support">Towards allocatable components and <code>f2py</code> support</h2><p>So far we have not really covered new ground compared to the previous
iteration using <code>C</code> compatible <code>struct</code> information. The remarkable
extensibility of the pointer approach really shines when we consider
adding a new type, with an allocatable component<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup>.</p><p>That being said, there is more to be done over on the <code>f2py</code> side before
it makes sense to delve too deeply into enhancements on the
<code>Fortran-C-Python</code> pipeline. The biggest blocker at the moment is:</p><ul><li>Suport for <code>C_PTR</code> in <code>f2py</code><ul><li>This includes <code>void*</code> handling</li></ul></li></ul><p>The exact details shall be covered later, mostly because the Python-C
code gets a little rough. It is easier with <code>f2py</code> which provides
efficient routines to and from <code>C</code> and Python via <code>numpy</code> arrays but
still too long to be in the same post.</p><h2 id="conclusions">Conclusions</h2><p>More examples notwithstanding, the design discussed here is generic
enough to form a more coherent and pragmatic basis for further
improvements. Some of these are enumerated below for a future attempt:</p><ul><li>Circumventing the need to copy data from Python / <code>C</code> to
Fortran <sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup><ul><li>Either by careful usage of <code>transfer</code> or just via <code>c_loc</code> with
compatible types</li></ul></li><li>Using the <code>CFI</code> descriptors to operate efficiently on discontinous
memory <sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup><ul><li>Actually generally using the <code>CFI</code> descriptors more, since 2018
Reid (<a href="#ref-reidNewFeaturesFortran2018">2018</a>), some of the
pointer highjinks are enshrined as cannon<ul><li><code>c_loc</code> and <code>c_funloc</code> may have non-interoperable arguments
Metcalf, Reid, and Cohen
(<a href="#ref-metcalfModernFortranExplained2018">2018</a>)</li></ul></li></ul></li></ul><p>All that being said, with <code>meson</code> support in <code>f2py</code> from <code>1.26</code>
(<a href="https://github.com/numpy/numpy/pull/24532">npgh-24532</a>), basic types
based modern Fortran <a href="https://github.com/HaoZeke/GaussJacobiQuad#f2py-generated-interface">can already be
used</a>,
so the future remains bright.</p><h2 id="references">References</h2><div id="refs"><p>Metcalf, Michael, John Ker Reid, and Malcolm Cohen. 2018. <em>Modern
Fortran Explained: Incorporating Fortran 2018</em>. Numerical Mathematics
and Scientific Computation. Oxford [England]: Oxford University Press.</p><p>Pletzer, Alexander, Douglas McCune, Stefan Muszala, Srinath Vadlamani,
and Scott Kruger. 2008. “Exposing Fortran Derived Types to C and Other
Languages.” <em>Computing in Science Engineering</em> 10 (4): 86–92.
<a href="https://doi.org/10.1109/MCSE.2008.94">https://doi.org/10.1109/MCSE.2008.94</a>.</p><div id="ref-reidNewFeaturesFortran2018"><p>Reid, John. 2018. “The New Features of Fortran 2018.”
<a href="https://doi.org/10.1145/3206214.3206215">https://doi.org/10.1145/3206214.3206215</a>.</p></div></div><hr/></div></div>
  </body>
</html>
