<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/mozilla/sops">Original</a>
    <h1>Mozilla/Sops: Simple and flexible tool for managing secrets</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><strong>sops</strong> is an editor of encrypted files that supports YAML, JSON, ENV, INI and BINARY
formats and encrypts with AWS KMS, GCP KMS, Azure Key Vault, age, and PGP.
(<a href="https://www.youtube.com/watch?v=YTEVyLXFiq0" rel="nofollow">demo</a>)</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/4ce356d88383ec0075f390e95fc63f431a58fba061048e716c1f45dbc66dbccd/68747470733a2f2f692e696d6775722e636f6d2f5830544d354e492e676966"><img alt="https://i.imgur.com/X0TM5NI.gif" src="https://camo.githubusercontent.com/4ce356d88383ec0075f390e95fc63f431a58fba061048e716c1f45dbc66dbccd/68747470733a2f2f692e696d6775722e636f6d2f5830544d354e492e676966" data-animated-image="" data-canonical-src="https://i.imgur.com/X0TM5NI.gif"/></a></p>
<hr/>
<a href="https://pkg.go.dev/go.mozilla.org/sops/v3" rel="nofollow"><img src="https://camo.githubusercontent.com/7e503173865c4390dc9a11e77efd343fdc5dac279ef251f81742158908159dd1/68747470733a2f2f706b672e676f2e6465762f62616467652f676f2e6d6f7a696c6c612e6f72672f736f70732f76332e737667" data-canonical-src="https://pkg.go.dev/badge/go.mozilla.org/sops/v3.svg"/>
</a>
<a name="user-content-download"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-1download" aria-hidden="true" href="#1download"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id3">1   Download</a></h2>
<a name="user-content-stable-release"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-11stable-release" aria-hidden="true" href="#11stable-release"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id4">1.1   Stable release</a></h3>
<p dir="auto">Binaries and packages of the latest stable release are available at <a href="https://github.com/mozilla/sops/releases">https://github.com/mozilla/sops/releases</a>.</p>
<a name="user-content-development-branch"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-12development-branch" aria-hidden="true" href="#12development-branch"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id5">1.2   Development branch</a></h3>
<p dir="auto">For the adventurous, unstable features are available in the develop branch, which you can install from source:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ mkdir -p $GOPATH/src/go.mozilla.org/sops/
$ git clone https://github.com/mozilla/sops.git $GOPATH/src/go.mozilla.org/sops/
$ cd $GOPATH/src/go.mozilla.org/sops/
$ git checkout develop
$ make install"><pre>$ mkdir -p <span>$GOPATH</span>/src/go.mozilla.org/sops/
$ git clone https://github.com/mozilla/sops.git <span>$GOPATH</span>/src/go.mozilla.org/sops/
$ <span>cd</span> <span>$GOPATH</span>/src/go.mozilla.org/sops/
$ git checkout develop
$ make install</pre></div>
<p dir="auto">(requires Go &gt;= 1.17)</p>
<p dir="auto">If you don&#39;t have Go installed, set it up with:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ {apt,yum,brew} install golang
$ echo &#39;export GOPATH=~/go&#39; &gt;&gt; ~/.bashrc
$ source ~/.bashrc
$ mkdir $GOPATH"><pre>$ {apt,yum,brew} install golang
$ <span>echo</span> <span><span>&#39;</span>export GOPATH=~/go<span>&#39;</span></span> <span>&gt;&gt;</span> <span>~</span>/.bashrc
$ <span>source</span> <span>~</span>/.bashrc
$ mkdir <span>$GOPATH</span></pre></div>
<p dir="auto">Or whatever variation of the above fits your system and shell.</p>
<p dir="auto">To use <strong>sops</strong> as a library, take a look at the <a href="https://pkg.go.dev/go.mozilla.org/sops/v3/decrypt" rel="nofollow">decrypt package</a>.</p>

<a name="user-content-usage"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-2usage" aria-hidden="true" href="#2usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id6">2   Usage</a></h2>
<p dir="auto">For a quick presentation of Sops, check out this Youtube tutorial:</p>
<a href="https://www.youtube.com/watch?v=V2PRhxphH2w" rel="nofollow"><img alt="https://img.youtube.com/vi/V2PRhxphH2w/0.jpg" src="https://camo.githubusercontent.com/43745d8a2abf1fdf74d94d830f7eba2f3253e9ccbf3dcae7eba5f75ec81b11b1/68747470733a2f2f696d672e796f75747562652e636f6d2f76692f56325052687870684832772f302e6a7067" data-canonical-src="https://img.youtube.com/vi/V2PRhxphH2w/0.jpg"/></a>
<p dir="auto">If you&#39;re using AWS KMS, create one or multiple master keys in the IAM console
and export them, comma separated, in the <strong>SOPS_KMS_ARN</strong> env variable. It is
recommended to use at least two master keys in different regions.</p>
<div dir="auto" data-snippet-clipboard-copy-content="export SOPS_KMS_ARN=&#34;arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e,arn:aws:kms:ap-southeast-1:656532927350:key/9006a8aa-0fa6-4c14-930e-a2dfb916de1d&#34;"><pre><span>export</span> SOPS_KMS_ARN=<span><span>&#34;</span>arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e,arn:aws:kms:ap-southeast-1:656532927350:key/9006a8aa-0fa6-4c14-930e-a2dfb916de1d<span>&#34;</span></span></pre></div>
<p dir="auto">Your AWS credentials must be present in <code>~/.aws/credentials</code>. sops uses aws-sdk-go.</p>
<pre>$ cat ~/.aws/credentials
[default]
aws_access_key_id = AKI.....
aws_secret_access_key = mw......
</pre>
<p dir="auto">If you want to use PGP, export the fingerprints of the public keys, comma
separated, in the <strong>SOPS_PGP_FP</strong> env variable.</p>
<div dir="auto" data-snippet-clipboard-copy-content="export SOPS_PGP_FP=&#34;85D77543B3D624B63CEA9E6DBC17301B491B3F21,E60892BB9BD89A69F759A1A0A3D652173B763E8F&#34;"><pre><span>export</span> SOPS_PGP_FP=<span><span>&#34;</span>85D77543B3D624B63CEA9E6DBC17301B491B3F21,E60892BB9BD89A69F759A1A0A3D652173B763E8F<span>&#34;</span></span></pre></div>
<p dir="auto">Note: you can use both PGP and KMS simultaneously.</p>
<p dir="auto">Then simply call <code>sops</code> with a file path as argument. It will handle the
encryption/decryption transparently and open the cleartext file in an editor</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops mynewtestfile.yaml
mynewtestfile.yaml doesn&#39;t exist, creating it.
please wait while an encryption key is being generated and stored in a secure fashion
file written to mynewtestfile.yaml"><pre>$ sops mynewtestfile.yaml
mynewtestfile.yaml doesn<span><span>&#39;</span>t exist, creating it.</span>
<span>please wait while an encryption key is being generated and stored in a secure fashion</span>
<span>file written to mynewtestfile.yaml</span></pre></div>
<p dir="auto">Editing will happen in whatever <code>$EDITOR</code> is set to, or, if it&#39;s not set, in vim.
Keep in mind that sops will wait for the editor to exit, and then try to reencrypt
the file. Some GUI editors (atom, sublime) spawn a child process and then exit
immediately. They usually have an option to wait for the main editor window to be
closed before exiting. See <a href="https://github.com/mozilla/sops/issues/127" data-hovercard-type="issue" data-hovercard-url="/mozilla/sops/issues/127/hovercard">#127</a> for
more information.</p>
<p dir="auto">The resulting encrypted file looks like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="myapp1: ENC[AES256_GCM,data:Tr7o=,iv:1=,aad:No=,tag:k=]
app2:
    db:
        user: ENC[AES256_GCM,data:CwE4O1s=,iv:2k=,aad:o=,tag:w==]
        password: ENC[AES256_GCM,data:p673w==,iv:YY=,aad:UQ=,tag:A=]
    # private key for secret operations in app2
    key: |-
        ENC[AES256_GCM,data:Ea3kL5O5U8=,iv:DM=,aad:FKA=,tag:EA==]
an_array:
- ENC[AES256_GCM,data:v8jQ=,iv:HBE=,aad:21c=,tag:gA==]
- ENC[AES256_GCM,data:X10=,iv:o8=,aad:CQ=,tag:Hw==]
- ENC[AES256_GCM,data:KN=,iv:160=,aad:fI4=,tag:tNw==]
sops:
    kms:
    -   created_at: 1441570389.775376
        enc: CiC....Pm1Hm
        arn: arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e
    -   created_at: 1441570391.925734
        enc: Ci...awNx
        arn: arn:aws:kms:ap-southeast-1:656532927350:key/9006a8aa-0fa6-4c14-930e-a2dfb916de1d
    pgp:
    -   fp: 85D77543B3D624B63CEA9E6DBC17301B491B3F21
        created_at: 1441570391.930042
        enc: |
            -----BEGIN PGP MESSAGE-----
            hQIMA0t4uZHfl9qgAQ//UvGAwGePyHuf2/zayWcloGaDs0MzI+zw6CmXvMRNPUsA
                            ...=oJgS
            -----END PGP MESSAGE-----"><pre><span>myapp1</span>: <span>ENC[AES256_GCM,data:Tr7o=,iv:1=,aad:No=,tag:k=]</span>
<span>app2</span>:
    <span>db</span>:
        <span>user</span>: <span>ENC[AES256_GCM,data:CwE4O1s=,iv:2k=,aad:o=,tag:w==]</span>
        <span>password</span>: <span>ENC[AES256_GCM,data:p673w==,iv:YY=,aad:UQ=,tag:A=]</span>
    <span><span>#</span> private key for secret operations in app2</span>
    <span>key</span>: <span>|-</span>
<span>        ENC[AES256_GCM,data:Ea3kL5O5U8=,iv:DM=,aad:FKA=,tag:EA==]</span>
<span></span><span>an_array</span>:
- <span>ENC[AES256_GCM,data:v8jQ=,iv:HBE=,aad:21c=,tag:gA==]</span>
- <span>ENC[AES256_GCM,data:X10=,iv:o8=,aad:CQ=,tag:Hw==]</span>
- <span>ENC[AES256_GCM,data:KN=,iv:160=,aad:fI4=,tag:tNw==]</span>
<span>sops</span>:
    <span>kms</span>:
    -   <span>created_at</span>: <span>1441570389.775376</span>
        <span>enc</span>: <span>CiC....Pm1Hm</span>
        <span>arn</span>: <span>arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e</span>
    -   <span>created_at</span>: <span>1441570391.925734</span>
        <span>enc</span>: <span>Ci...awNx</span>
        <span>arn</span>: <span>arn:aws:kms:ap-southeast-1:656532927350:key/9006a8aa-0fa6-4c14-930e-a2dfb916de1d</span>
    <span>pgp</span>:
    -   <span>fp</span>: <span>85D77543B3D624B63CEA9E6DBC17301B491B3F21</span>
        <span>created_at</span>: <span>1441570391.930042</span>
        <span>enc</span>: <span>|</span>
<span>            -----BEGIN PGP MESSAGE-----</span>
<span>            hQIMA0t4uZHfl9qgAQ//UvGAwGePyHuf2/zayWcloGaDs0MzI+zw6CmXvMRNPUsA</span>
<span>                            ...=oJgS</span>
<span>            -----END PGP MESSAGE-----</span></pre></div>
<p dir="auto">A copy of the encryption/decryption key is stored securely in each KMS and PGP
block. As long as one of the KMS or PGP method is still usable, you will be able
to access your data.</p>
<p dir="auto">To decrypt a file in a <code>cat</code> fashion, use the <code>-d</code> flag:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops -d mynewtestfile.yaml"><pre>$ sops -d mynewtestfile.yaml</pre></div>
<p dir="auto"><code>sops</code> encrypted files contain the necessary information to decrypt their content.
All a user of <code>sops</code> needs is valid AWS credentials and the necessary
permissions on KMS keys.</p>
<p dir="auto">Given that, the only command a <code>sops</code> user needs is:</p>

<p dir="auto">&lt;file&gt; will be opened, decrypted, passed to a text editor (vim by default),
encrypted if modified, and saved back to its original location. All of these
steps, apart from the actual editing, are transparent to the user.</p>
<a name="user-content-test-with-the-dev-pgp-key"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-21test-with-the-dev-pgp-key" aria-hidden="true" href="#21test-with-the-dev-pgp-key"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id7">2.1   Test with the dev PGP key</a></h3>
<p dir="auto">If you want to test <strong>sops</strong> without having to do a bunch of setup, you can use
the example files and pgp key provided with the repository:</p>
<pre>$ git clone https://github.com/mozilla/sops.git
$ cd sops
$ gpg --import pgp/sops_functional_tests_key.asc
$ sops example.yaml
</pre>
<p dir="auto">This last step will decrypt <code>example.yaml</code> using the test private key.</p>
<a name="user-content-encrypting-using-age"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-22encrypting-using-age" aria-hidden="true" href="#22encrypting-using-age"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id8">2.2   Encrypting using age</a></h3>
<p dir="auto"><a href="https://age-encryption.org/" rel="nofollow">age</a> is a simple, modern, and secure tool for
encrypting files. It&#39;s recommended to use age over PGP, if possible.</p>
<p dir="auto">You can encrypt a file for one or more age recipients (comma separated) using
the <code>--age</code> option or the <strong>SOPS_AGE_RECIPIENTS</strong> environment variable:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --encrypt --age age1yt3tfqlfrwdwx0z0ynwplcr6qxcxfaqycuprpmy89nr83ltx74tqdpszlw test.yaml &gt; test.enc.yaml"><pre>$ sops --encrypt --age age1yt3tfqlfrwdwx0z0ynwplcr6qxcxfaqycuprpmy89nr83ltx74tqdpszlw test.yaml <span>&gt;</span> test.enc.yaml</pre></div>
<p dir="auto">When decrypting a file with the corresponding identity, sops will look for a
text file name <code>keys.txt</code> located in a <code>sops</code> subdirectory of your user
configuration directory. On Linux, this would be <code>$XDG_CONFIG_HOME/sops/age/keys.txt</code>.
On macOS, this would be <code>$HOME/Library/Application Support/sops/age/keys.txt</code>. On
Windows, this would be <code>%AppData%\sops\age\keys.txt</code>. You can specify the location
of this file manually by setting the environment variable <strong>SOPS_AGE_KEY_FILE</strong>.
Alternatively you can provide the the key(s) directly by setting the <strong>SOPS_AGE_KEY</strong>
environment variable.</p>
<p dir="auto">The contents of this key file should be a list of age X25519 identities, one
per line. Lines beginning with <code>#</code> are considered comments and ignored. Each
identity will be tried in sequence until one is able to decrypt the data.</p>
<p dir="auto">Encrypting with SSH keys via age is not yet supported by sops.</p>
<a name="user-content-encrypting-using-gcp-kms"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-23encrypting-using-gcp-kms" aria-hidden="true" href="#23encrypting-using-gcp-kms"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id9">2.3   Encrypting using GCP KMS</a></h3>
<p dir="auto">GCP KMS uses <a href="https://developers.google.com/identity/protocols/application-default-credentials" rel="nofollow">Application Default Credentials</a>.
If you already logged in using</p>

<p dir="auto">you can enable application default credentials using the sdk:</p>
<pre>$ gcloud auth application-default login
</pre>
<p dir="auto">Encrypting/decrypting with GCP KMS requires a KMS ResourceID. You can use the
cloud console the get the ResourceID or you can create one using the gcloud
sdk:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ gcloud kms keyrings create sops --location global
$ gcloud kms keys create sops-key --location global --keyring sops --purpose encryption
$ gcloud kms keys list --location global --keyring sops

# you should see
NAME                                                                   PURPOSE          PRIMARY_STATE
projects/my-project/locations/global/keyRings/sops/cryptoKeys/sops-key ENCRYPT_DECRYPT  ENABLED"><pre>$ gcloud kms keyrings create sops --location global
$ gcloud kms keys create sops-key --location global --keyring sops --purpose encryption
$ gcloud kms keys list --location global --keyring sops

<span><span>#</span> you should see</span>
NAME                                                                   PURPOSE          PRIMARY_STATE
projects/my-project/locations/global/keyRings/sops/cryptoKeys/sops-key ENCRYPT_DECRYPT  ENABLED</pre></div>
<p dir="auto">Now you can encrypt a file using:</p>
<pre>$ sops --encrypt --gcp-kms projects/my-project/locations/global/keyRings/sops/cryptoKeys/sops-key test.yaml &gt; test.enc.yaml
</pre>
<p dir="auto">And decrypt it using:</p>
<pre>$ sops --decrypt test.enc.yaml
</pre>
<a name="user-content-encrypting-using-azure-key-vault"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-24encrypting-using-azure-key-vault" aria-hidden="true" href="#24encrypting-using-azure-key-vault"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id10">2.4   Encrypting using Azure Key Vault</a></h3>
<p dir="auto">The Azure Key Vault integration tries several authentication methods, in
this order:</p>
<blockquote>
<ol dir="auto">
<li>Client credentials</li>
<li>Client Certificate</li>
<li>Username Password</li>
<li>MSI</li>
<li>Azure CLI auth</li>
</ol>
</blockquote>
<p dir="auto">You can force a specific authentication method through the AZURE_AUTH_METHOD
environment variable, which may be one of: clientcredentials, clientcertificate,
usernamepassword, msi, or cli (default).</p>
<p dir="auto">For example, you can use service principals with the following environment variables:</p>
<div dir="auto" data-snippet-clipboard-copy-content="AZURE_TENANT_ID
AZURE_CLIENT_ID
AZURE_CLIENT_SECRET"><pre>AZURE_TENANT_ID
AZURE_CLIENT_ID
AZURE_CLIENT_SECRET</pre></div>
<p dir="auto">You can create a service principal using the cli like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ az ad sp create-for-rbac -n my-keyvault-sp

{
        &#34;appId&#34;: &#34;&lt;some-uuid&gt;&#34;,
        &#34;displayName&#34;: &#34;my-keyvault-sp&#34;,
        &#34;name&#34;: &#34;http://my-keyvault-sp&#34;,
        &#34;password&#34;: &#34;&lt;some-uuid&gt;&#34;,
        &#34;tenant&#34;: &#34;&lt;tenant-id&gt;&#34;
}"><pre>$ az ad sp create-for-rbac -n my-keyvault-sp

{
        <span><span>&#34;</span>appId<span>&#34;</span></span>: <span><span>&#34;</span>&lt;some-uuid&gt;<span>&#34;</span></span>,
        <span><span>&#34;</span>displayName<span>&#34;</span></span>: <span><span>&#34;</span>my-keyvault-sp<span>&#34;</span></span>,
        <span><span>&#34;</span>name<span>&#34;</span></span>: <span><span>&#34;</span>http://my-keyvault-sp<span>&#34;</span></span>,
        <span><span>&#34;</span>password<span>&#34;</span></span>: <span><span>&#34;</span>&lt;some-uuid&gt;<span>&#34;</span></span>,
        <span><span>&#34;</span>tenant<span>&#34;</span></span>: <span><span>&#34;</span>&lt;tenant-id&gt;<span>&#34;</span></span>
}</pre></div>
<p dir="auto">The appId is the client id, and the password is the client secret.</p>
<p dir="auto">Encrypting/decrypting with Azure Key Vault requires the resource identifier for
a key. This has the following form:</p>
<pre>https://${VAULT_URL}/keys/${KEY_NAME}/${KEY_VERSION}
</pre>
<p dir="auto">To create a Key Vault and assign your service principal permissions on it
from the commandline:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Create a resource group if you do not have one:
$ az group create --name sops-rg --location westeurope
# Key Vault names are globally unique, so generate one:
$ keyvault_name=sops-$(uuidgen | tr -d - | head -c 16)
# Create a Vault, a key, and give the service principal access:
$ az keyvault create --name $keyvault_name --resource-group sops-rg --location westeurope
$ az keyvault key create --name sops-key --vault-name $keyvault_name --protection software --ops encrypt decrypt
$ az keyvault set-policy --name $keyvault_name --resource-group sops-rg --spn $AZURE_CLIENT_ID \
        --key-permissions encrypt decrypt
# Read the key id:
$ az keyvault key show --name sops-key --vault-name $keyvault_name --query key.kid

https://sops.vault.azure.net/keys/sops-key/some-string"><pre><span><span>#</span> Create a resource group if you do not have one:</span>
$ az group create --name sops-rg --location westeurope
<span><span>#</span> Key Vault names are globally unique, so generate one:</span>
$ keyvault_name=sops-<span><span>$(</span>uuidgen <span>|</span> tr -d - <span>|</span> head -c 16<span>)</span></span>
<span><span>#</span> Create a Vault, a key, and give the service principal access:</span>
$ az keyvault create --name <span>$keyvault_name</span> --resource-group sops-rg --location westeurope
$ az keyvault key create --name sops-key --vault-name <span>$keyvault_name</span> --protection software --ops encrypt decrypt
$ az keyvault set-policy --name <span>$keyvault_name</span> --resource-group sops-rg --spn <span>$AZURE_CLIENT_ID</span> \
        --key-permissions encrypt decrypt
<span><span>#</span> Read the key id:</span>
$ az keyvault key show --name sops-key --vault-name <span>$keyvault_name</span> --query key.kid

https://sops.vault.azure.net/keys/sops-key/some-string</pre></div>
<p dir="auto">Now you can encrypt a file using:</p>
<pre>$ sops --encrypt --azure-kv https://sops.vault.azure.net/keys/sops-key/some-string test.yaml &gt; test.enc.yaml
</pre>
<p dir="auto">And decrypt it using:</p>
<pre>$ sops --decrypt test.enc.yaml
</pre>
<a name="user-content-encrypting-using-hashicorp-vault"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-25encrypting-using-hashicorp-vault" aria-hidden="true" href="#25encrypting-using-hashicorp-vault"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id11">2.5   Encrypting using Hashicorp Vault</a></h3>
<p dir="auto">We assume you have an instance (or more) of Vault running and you have privileged access to it. For instructions on how to deploy a secure instance of Vault, refer to Hashicorp&#39;s official documentation.</p>
<p dir="auto">To easily deploy Vault locally: (DO NOT DO THIS FOR PRODUCTION!!!)</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ docker run -d -p8200:8200 vault:1.2.0 server -dev -dev-root-token-id=toor"><pre>$ docker run -d -p8200:8200 vault:1.2.0 server -dev -dev-root-token-id=toor</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="$ # Substitute this with the address Vault is running on
$ export VAULT_ADDR=http://127.0.0.1:8200

$ # this may not be necessary in case you previously used `vault login` for production use
$ export VAULT_TOKEN=toor

$ # to check if Vault started and is configured correctly
$ vault status
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.2.0
Cluster Name    vault-cluster-618cc902
Cluster ID      e532e461-e8f0-1352-8a41-fc7c11096908
HA Enabled      false

$ # It is required to enable a transit engine if not already done (It is suggested to create a transit engine specifically for sops, in which it is possible to have multiple keys with various permission levels)
$ vault secrets enable -path=sops transit
Success! Enabled the transit secrets engine at: sops/

$ # Then create one or more keys
$ vault write sops/keys/firstkey type=rsa-4096
Success! Data written to: sops/keys/firstkey

$ vault write sops/keys/secondkey type=rsa-2048
Success! Data written to: sops/keys/secondkey

$ vault write sops/keys/thirdkey type=chacha20-poly1305
Success! Data written to: sops/keys/thirdkey

$ sops --hc-vault-transit $VAULT_ADDR/v1/sops/keys/firstkey vault_example.yml

$ cat &lt;&lt;EOF &gt; .sops.yaml
creation_rules:
        - path_regex: \.dev\.yaml$
          hc_vault_transit_uri: &#34;$VAULT_ADDR/v1/sops/keys/secondkey&#34;
        - path_regex: \.prod\.yaml$
          hc_vault_transit_uri: &#34;$VAULT_ADDR/v1/sops/keys/thirdkey&#34;
EOF

$ sops --verbose -e prod/raw.yaml &gt; prod/encrypted.yaml"><pre>$ <span><span>#</span> Substitute this with the address Vault is running on</span>
$ <span>export</span> VAULT_ADDR=http://127.0.0.1:8200

$ <span><span>#</span> this may not be necessary in case you previously used `vault login` for production use</span>
$ <span>export</span> VAULT_TOKEN=toor

$ <span><span>#</span> to check if Vault started and is configured correctly</span>
$ vault status
Key             Value
---             -----
Seal Type       shamir
Initialized     <span>true</span>
Sealed          <span>false</span>
Total Shares    1
Threshold       1
Version         1.2.0
Cluster Name    vault-cluster-618cc902
Cluster ID      e532e461-e8f0-1352-8a41-fc7c11096908
HA Enabled      <span>false</span>

$ <span><span>#</span> It is required to enable a transit engine if not already done (It is suggested to create a transit engine specifically for sops, in which it is possible to have multiple keys with various permission levels)</span>
$ vault secrets <span>enable</span> -path=sops transit
Success<span>!</span> Enabled the transit secrets engine at: sops/

$ <span><span>#</span> Then create one or more keys</span>
$ vault write sops/keys/firstkey type=rsa-4096
Success<span>!</span> Data written to: sops/keys/firstkey

$ vault write sops/keys/secondkey type=rsa-2048
Success<span>!</span> Data written to: sops/keys/secondkey

$ vault write sops/keys/thirdkey type=chacha20-poly1305
Success<span>!</span> Data written to: sops/keys/thirdkey

$ sops --hc-vault-transit <span>$VAULT_ADDR</span>/v1/sops/keys/firstkey vault_example.yml

$ cat <span><span>&lt;&lt;</span><span>EOF</span> &gt; .sops.yaml</span>
<span>creation_rules:</span>
<span>        - path_regex: \.dev\.yaml$</span>
<span>          hc_vault_transit_uri: &#34;<span>$VAULT_ADDR</span>/v1/sops/keys/secondkey&#34;</span>
<span>        - path_regex: \.prod\.yaml$</span>
<span>          hc_vault_transit_uri: &#34;<span>$VAULT_ADDR</span>/v1/sops/keys/thirdkey&#34;</span>
<span><span>EOF</span></span>

$ sops --verbose -e prod/raw.yaml <span>&gt;</span> prod/encrypted.yaml</pre></div>
<a name="user-content-adding-and-removing-keys"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-26adding-and-removing-keys" aria-hidden="true" href="#26adding-and-removing-keys"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id12">2.6   Adding and removing keys</a></h3>
<p dir="auto">When creating new files, <code>sops</code> uses the PGP, KMS and GCP KMS defined in the
command line arguments <code>--kms</code>, <code>--pgp</code>, <code>--gcp-kms</code> or <code>--azure-kv</code>, or from
the environment variables <code>SOPS_KMS_ARN</code>, <code>SOPS_PGP_FP</code>, <code>SOPS_GCP_KMS_IDS</code>,
<code>SOPS_AZURE_KEYVAULT_URLS</code>. That information is stored in the file under the
<code>sops</code> section, such that decrypting files does not require providing those
parameters again.</p>
<p dir="auto">Master PGP and KMS keys can be added and removed from a <code>sops</code> file in one of
three ways:</p>
<ol dir="auto">
<li>By using a .sops.yaml file and the <code>updatekeys</code> command.</li>
<li>By using command line flags.</li>
<li>By editing the file directly.</li>
</ol>
<p dir="auto">The sops team recommends the <code>updatekeys</code> approach.</p>
<a name="user-content-updatekeys-command"></a>
<h4 tabindex="-1" dir="auto"><a id="user-content-261updatekeys-command" aria-hidden="true" href="#261updatekeys-command"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id13">2.6.1   <code>updatekeys</code> command</a></h4>
<p dir="auto">The <code>updatekeys</code> command uses the <a href="#using-sops-yaml-conf-to-select-kms-pgp-for-new-files">.sops.yaml</a>
configuration file to update (add or remove) the corresponding secrets in the
encrypted file. Note that the example below uses the
<a href="https://yaml-multiline.info/" rel="nofollow">Block Scalar yaml construct</a> to build a space
separated list.</p>
<div dir="auto" data-snippet-clipboard-copy-content="creation_rules:
    - pgp: &gt;-
        85D77543B3D624B63CEA9E6DBC17301B491B3F21,
        FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4"><pre><span>creation_rules</span>:
    - <span>pgp</span>: <span>&gt;-</span>
<span>        85D77543B3D624B63CEA9E6DBC17301B491B3F21,</span>
<span>        FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4</span></pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops updatekeys test.enc.yaml"><pre>$ sops updatekeys test.enc.yaml</pre></div>
<p dir="auto">Sops will prompt you with the changes to be made. This interactivity can be
disabled by supplying the <code>-y</code> flag.</p>
<a name="user-content-command-line"></a>
<h4 tabindex="-1" dir="auto"><a id="user-content-262command-line" aria-hidden="true" href="#262command-line"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id14">2.6.2   Command Line</a></h4>
<p dir="auto">Command line flag <code>--add-kms</code>, <code>--add-pgp</code>, <code>--add-gcp-kms</code>, <code>--add-azure-kv</code>,
<code>--rm-kms</code>, <code>--rm-pgp</code>, <code>--rm-gcp-kms</code> and <code>--rm-azure-kv</code> can be used to add
and remove keys from a file.
These flags use the comma separated syntax as the <code>--kms</code>, <code>--pgp</code>, <code>--gcp-kms</code>
and <code>--azure-kv</code> arguments when creating new files.</p>
<p dir="auto">Note that <code>-r</code> or <code>--rotate</code> is mandatory in this mode. Not specifying
rotate will ignore the <code>--add-*</code> options. Use <code>updatekeys</code> if you want to
add a key without rotating the data key.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# add a new pgp key to the file and rotate the data key
$ sops -r -i --add-pgp 85D77543B3D624B63CEA9E6DBC17301B491B3F21 example.yaml

# remove a pgp key from the file and rotate the data key
$ sops -r -i --rm-pgp 85D77543B3D624B63CEA9E6DBC17301B491B3F21 example.yaml"><pre><span><span>#</span> add a new pgp key to the file and rotate the data key</span>
$ sops -r -i --add-pgp 85D77543B3D624B63CEA9E6DBC17301B491B3F21 example.yaml

<span><span>#</span> remove a pgp key from the file and rotate the data key</span>
$ sops -r -i --rm-pgp 85D77543B3D624B63CEA9E6DBC17301B491B3F21 example.yaml</pre></div>
<a name="user-content-direct-editing"></a>
<h4 tabindex="-1" dir="auto"><a id="user-content-263direct-editing" aria-hidden="true" href="#263direct-editing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id15">2.6.3   Direct Editing</a></h4>
<p dir="auto">Alternatively, invoking <code>sops</code> with the flag <strong>-s</strong> will display the master keys
while editing. This method can be used to add or remove kms or pgp keys under the
sops section. Invoking <code>sops</code> with the <strong>-i</strong> flag will perform an in-place edit
instead of redirecting output to <code>stdout</code>.</p>
<p dir="auto">For example, to add a KMS master key to a file, add the following entry while
editing:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sops:
    kms:
    - arn: arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e"><pre><span>sops</span>:
    <span>kms</span>:
    - <span>arn</span>: <span>arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e</span></pre></div>
<p dir="auto">And, similarly, to add a PGP master key, we add its fingerprint:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sops:
    pgp:
    - fp: 85D77543B3D624B63CEA9E6DBC17301B491B3F21"><pre><span>sops</span>:
    <span>pgp</span>:
    - <span>fp</span>: <span>85D77543B3D624B63CEA9E6DBC17301B491B3F21</span></pre></div>
<p dir="auto">When the file is saved, <code>sops</code> will update its metadata and encrypt the data key
with the freshly added master keys. The removed entries are simply deleted from
the file.</p>
<p dir="auto">When removing keys, it is recommended to rotate the data key using <code>-r</code>,
otherwise owners of the removed key may have add access to the data key in the
past.</p>
<a name="user-content-kms-aws-profiles"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-27kms-aws-profiles" aria-hidden="true" href="#27kms-aws-profiles"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id16">2.7   KMS AWS Profiles</a></h3>
<p dir="auto">If you want to use a specific profile, you can do so with aws_profile:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sops:
    kms:
    -   arn: arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e
        aws_profile: foo"><pre><span>sops</span>:
    <span>kms</span>:
    -   <span>arn</span>: <span>arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e</span>
        <span>aws_profile</span>: <span>foo</span></pre></div>
<p dir="auto">If no AWS profile is set, default credentials will be used.</p>
<p dir="auto">Similarly the --aws-profile flag can be set with the command line with any of the KMS commands.</p>
<a name="user-content-assuming-roles-and-using-kms-in-various-aws-accounts"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-28assuming-roles-and-using-kms-in-various-aws-accounts" aria-hidden="true" href="#28assuming-roles-and-using-kms-in-various-aws-accounts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id17">2.8   Assuming roles and using KMS in various AWS accounts</a></h3>
<p dir="auto">SOPS has the ability to use KMS in multiple AWS accounts by assuming roles in
each account. Being able to assume roles is a nice feature of AWS that allows
administrators to establish trust relationships between accounts, typically from
the most secure account to the least secure one. In our use-case, we use roles
to indicate that a user of the Master AWS account is allowed to make use of KMS
master keys in development and staging AWS accounts. Using roles, a single file
can be encrypted with KMS keys in multiple accounts, thus increasing reliability
and ease of use.</p>
<p dir="auto">You can use keys in various accounts by tying each KMS master key to a role that
the user is allowed to assume in each account. The <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html" rel="nofollow">IAM roles</a>
documentation has full details on how this needs to be configured on AWS&#39;s side.</p>
<p dir="auto">From the point of view of <code>sops</code>, you only need to specify the role a KMS key
must assume alongside its ARN, as follows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sops:
    kms:
    -   arn: arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e
        role: arn:aws:iam::927034868273:role/sops-dev-xyz"><pre><span>sops</span>:
    <span>kms</span>:
    -   <span>arn</span>: <span>arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e</span>
        <span>role</span>: <span>arn:aws:iam::927034868273:role/sops-dev-xyz</span></pre></div>
<p dir="auto">The role must have permission to call Encrypt and Decrypt using KMS. An example
policy is shown below.</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;Sid&#34;: &#34;Allow use of the key&#34;,
  &#34;Effect&#34;: &#34;Allow&#34;,
  &#34;Action&#34;: [
        &#34;kms:Encrypt&#34;,
        &#34;kms:Decrypt&#34;,
        &#34;kms:ReEncrypt*&#34;,
        &#34;kms:GenerateDataKey*&#34;,
        &#34;kms:DescribeKey&#34;
  ],
  &#34;Resource&#34;: &#34;*&#34;,
  &#34;Principal&#34;: {
        &#34;AWS&#34;: [
          &#34;arn:aws:iam::927034868273:role/sops-dev-xyz&#34;
        ]
  }
}"><pre>{
  <span>&#34;Sid&#34;</span>: <span><span>&#34;</span>Allow use of the key<span>&#34;</span></span>,
  <span>&#34;Effect&#34;</span>: <span><span>&#34;</span>Allow<span>&#34;</span></span>,
  <span>&#34;Action&#34;</span>: [
        <span><span>&#34;</span>kms:Encrypt<span>&#34;</span></span>,
        <span><span>&#34;</span>kms:Decrypt<span>&#34;</span></span>,
        <span><span>&#34;</span>kms:ReEncrypt*<span>&#34;</span></span>,
        <span><span>&#34;</span>kms:GenerateDataKey*<span>&#34;</span></span>,
        <span><span>&#34;</span>kms:DescribeKey<span>&#34;</span></span>
  ],
  <span>&#34;Resource&#34;</span>: <span><span>&#34;</span>*<span>&#34;</span></span>,
  <span>&#34;Principal&#34;</span>: {
        <span>&#34;AWS&#34;</span>: [
          <span><span>&#34;</span>arn:aws:iam::927034868273:role/sops-dev-xyz<span>&#34;</span></span>
        ]
  }
}</pre></div>
<p dir="auto">You can specify a role in the <code>--kms</code> flag and <code>SOPS_KMS_ARN</code> variable by
appending it to the ARN of the master key, separated by a <strong>+</strong> sign:</p>
<pre>&lt;KMS ARN&gt;+&lt;ROLE ARN&gt;
arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500+arn:aws:iam::927034868273:role/sops-dev-xyz
</pre>
<a name="user-content-aws-kms-encryption-context"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-29aws-kms-encryption-context" aria-hidden="true" href="#29aws-kms-encryption-context"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id18">2.9   AWS KMS Encryption Context</a></h3>
<p dir="auto">SOPS has the ability to use <a href="http://docs.aws.amazon.com/kms/latest/developerguide/encryption-context.html" rel="nofollow">AWS KMS key policy and encryption context</a>
to refine the access control of a given KMS master key.</p>
<p dir="auto">When creating a new file, you can specify encryption context in the
<code>--encryption-context</code> flag by comma separated list of key-value pairs:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --encryption-context Environment:production,Role:web-server test.dev.yaml"><pre>$ sops --encryption-context Environment:production,Role:web-server test.dev.yaml</pre></div>
<p dir="auto">The format of the Encrypt Context string is <code>&lt;EncryptionContext Key&gt;:&lt;EncryptionContext Value&gt;,&lt;EncryptionContext Key&gt;:&lt;EncryptionContext Value&gt;,...</code></p>
<p dir="auto">The encryption context will be stored in the file metadata and does
not need to be provided at decryption.</p>
<p dir="auto">Encryption contexts can be used in conjunction with KMS Key Policies to define
roles that can only access a given context. An example policy is shown below:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;Effect&#34;: &#34;Allow&#34;,
  &#34;Principal&#34;: {
    &#34;AWS&#34;: &#34;arn:aws:iam::111122223333:role/RoleForExampleApp&#34;
  },
  &#34;Action&#34;: &#34;kms:Decrypt&#34;,
  &#34;Resource&#34;: &#34;*&#34;,
  &#34;Condition&#34;: {
    &#34;StringEquals&#34;: {
      &#34;kms:EncryptionContext:AppName&#34;: &#34;ExampleApp&#34;,
      &#34;kms:EncryptionContext:FilePath&#34;: &#34;/var/opt/secrets/&#34;
    }
  }
}"><pre>{
  <span>&#34;Effect&#34;</span>: <span><span>&#34;</span>Allow<span>&#34;</span></span>,
  <span>&#34;Principal&#34;</span>: {
    <span>&#34;AWS&#34;</span>: <span><span>&#34;</span>arn:aws:iam::111122223333:role/RoleForExampleApp<span>&#34;</span></span>
  },
  <span>&#34;Action&#34;</span>: <span><span>&#34;</span>kms:Decrypt<span>&#34;</span></span>,
  <span>&#34;Resource&#34;</span>: <span><span>&#34;</span>*<span>&#34;</span></span>,
  <span>&#34;Condition&#34;</span>: {
    <span>&#34;StringEquals&#34;</span>: {
      <span>&#34;kms:EncryptionContext:AppName&#34;</span>: <span><span>&#34;</span>ExampleApp<span>&#34;</span></span>,
      <span>&#34;kms:EncryptionContext:FilePath&#34;</span>: <span><span>&#34;</span>/var/opt/secrets/<span>&#34;</span></span>
    }
  }
}</pre></div>
<a name="user-content-key-rotation"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-210key-rotation" aria-hidden="true" href="#210key-rotation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id19">2.10   Key Rotation</a></h3>
<p dir="auto">It is recommended to renew the data key on a regular basis. <code>sops</code> supports key
rotation via the <code>-r</code> flag. Invoking it on an existing file causes sops to
reencrypt the file with a new data key, which is then encrypted with the various
KMS and PGP master keys defined in the file.</p>

<a name="user-content-using-sops-yaml-conf-to-select-kms-pgp-for-new-files"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-211using-sopsyaml-conf-to-select-kmspgp-for-new-files" aria-hidden="true" href="#211using-sopsyaml-conf-to-select-kmspgp-for-new-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id20">2.11   Using .sops.yaml conf to select KMS/PGP for new files</a></h3>
<p dir="auto">It is often tedious to specify the <code>--kms</code> <code>--gcp-kms</code> and <code>--pgp</code> parameters for creation
of all new files. If your secrets are stored under a specific directory, like a
<code>git</code> repository, you can create a <code>.sops.yaml</code> configuration file at the root
directory to define which keys are used for which filename.</p>
<p dir="auto">Let&#39;s take an example:</p>
<ul dir="auto">
<li>file named <strong>something.dev.yaml</strong> should use one set of KMS A</li>
<li>file named <strong>something.prod.yaml</strong> should use another set of KMS B</li>
<li>other files use a third set of KMS C</li>
<li>all live under <strong>mysecretrepo/something.{dev,prod,gcp}.yaml</strong></li>
</ul>
<p dir="auto">Under those circumstances, a file placed at <strong>mysecretrepo/.sops.yaml</strong>
can manage the three sets of configurations for the three types of files:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# creation rules are evaluated sequentially, the first match wins
creation_rules:
        # upon creation of a file that matches the pattern *.dev.yaml,
        # KMS set A is used
        - path_regex: \.dev\.yaml$
          kms: &#39;arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod&#39;
          pgp: &#39;FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4&#39;

        # prod files use KMS set B in the PROD IAM
        - path_regex: \.prod\.yaml$
          kms: &#39;arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod,arn:aws:kms:eu-central-1:361527076523:key/cb1fab90-8d17-42a1-a9d8-334968904f94+arn:aws:iam::361527076523:role/hiera-sops-prod&#39;
          pgp: &#39;FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4&#39;
          hc_vault_uris: &#34;http://localhost:8200/v1/sops/keys/thirdkey&#34;

        # gcp files using GCP KMS
        - path_regex: \.gcp\.yaml$
          gcp_kms: projects/mygcproject/locations/global/keyRings/mykeyring/cryptoKeys/thekey

        # Finally, if the rules above have not matched, this one is a
        # catchall that will encrypt the file using KMS set C
        # The absence of a path_regex means it will match everything
        - kms: &#39;arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:142069644989:key/846cfb17-373d-49b9-8baf-f36b04512e47,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e&#39;
          pgp: &#39;FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4&#39;"><pre><span><span>#</span> creation rules are evaluated sequentially, the first match wins</span>
<span>creation_rules</span>:
        <span><span>#</span> upon creation of a file that matches the pattern *.dev.yaml,</span>
        <span><span>#</span> KMS set A is used</span>
        - <span>path_regex</span>: <span>\.dev\.yaml$</span>
          <span>kms</span>: <span><span>&#39;</span>arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod<span>&#39;</span></span>
          <span>pgp</span>: <span><span>&#39;</span>FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4<span>&#39;</span></span>

        <span><span>#</span> prod files use KMS set B in the PROD IAM</span>
        - <span>path_regex</span>: <span>\.prod\.yaml$</span>
          <span>kms</span>: <span><span>&#39;</span>arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod,arn:aws:kms:eu-central-1:361527076523:key/cb1fab90-8d17-42a1-a9d8-334968904f94+arn:aws:iam::361527076523:role/hiera-sops-prod<span>&#39;</span></span>
          <span>pgp</span>: <span><span>&#39;</span>FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4<span>&#39;</span></span>
          <span>hc_vault_uris</span>: <span><span>&#34;</span>http://localhost:8200/v1/sops/keys/thirdkey<span>&#34;</span></span>

        <span><span>#</span> gcp files using GCP KMS</span>
        - <span>path_regex</span>: <span>\.gcp\.yaml$</span>
          <span>gcp_kms</span>: <span>projects/mygcproject/locations/global/keyRings/mykeyring/cryptoKeys/thekey</span>

        <span><span>#</span> Finally, if the rules above have not matched, this one is a</span>
        <span><span>#</span> catchall that will encrypt the file using KMS set C</span>
        <span><span>#</span> The absence of a path_regex means it will match everything</span>
        - <span>kms</span>: <span><span>&#39;</span>arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:142069644989:key/846cfb17-373d-49b9-8baf-f36b04512e47,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e<span>&#39;</span></span>
          <span>pgp</span>: <span><span>&#39;</span>FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4<span>&#39;</span></span></pre></div>
<p dir="auto">When creating any file under <strong>mysecretrepo</strong>, whether at the root or under
a subdirectory, sops will recursively look for a <code>.sops.yaml</code> file. If one is
found, the filename of the file being created is compared with the filename
regexes of the configuration file. The first regex that matches is selected,
and its KMS and PGP keys are used to encrypt the file. It should be noted that
the looking up of <code>.sops.yaml</code> is from the working directory (CWD) instead of
the directory of the encrypting file (see <a href="https://github.com/mozilla/sops/issues/242" data-hovercard-type="issue" data-hovercard-url="/mozilla/sops/issues/242/hovercard">Issue 242</a>).</p>
<p dir="auto">The path_regex checks the path of the encrypting file relative to the .sops.yaml config file. Here is another example:</p>
<ul dir="auto">
<li>files located under directory <strong>development</strong> should use one set of KMS A</li>
<li>files located under directory <strong>production</strong> should use another set of KMS B</li>
<li>other files use a third set of KMS C</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="creation_rules:
    # upon creation of a file under development,
    # KMS set A is used
    - path_regex: .*/development/.*
      kms: &#39;arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod&#39;
      pgp: &#39;FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4&#39;

    # prod files use KMS set B in the PROD IAM
    - path_regex: .*/production/.*
      kms: &#39;arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod,arn:aws:kms:eu-central-1:361527076523:key/cb1fab90-8d17-42a1-a9d8-334968904f94+arn:aws:iam::361527076523:role/hiera-sops-prod&#39;
      pgp: &#39;FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4&#39;

    # other files use KMS set C
    - kms: &#39;arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:142069644989:key/846cfb17-373d-49b9-8baf-f36b04512e47,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e&#39;
      pgp: &#39;FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4&#39;"><pre><span>creation_rules</span>:
    <span><span>#</span> upon creation of a file under development,</span>
    <span><span>#</span> KMS set A is used</span>
    - <span>path_regex</span>: <span>.*/development/.*</span>
      <span>kms</span>: <span><span>&#39;</span>arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod<span>&#39;</span></span>
      <span>pgp</span>: <span><span>&#39;</span>FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4<span>&#39;</span></span>

    <span><span>#</span> prod files use KMS set B in the PROD IAM</span>
    - <span>path_regex</span>: <span>.*/production/.*</span>
      <span>kms</span>: <span><span>&#39;</span>arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e+arn:aws:iam::361527076523:role/hiera-sops-prod,arn:aws:kms:eu-central-1:361527076523:key/cb1fab90-8d17-42a1-a9d8-334968904f94+arn:aws:iam::361527076523:role/hiera-sops-prod<span>&#39;</span></span>
      <span>pgp</span>: <span><span>&#39;</span>FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4<span>&#39;</span></span>

    <span><span>#</span> other files use KMS set C</span>
    - <span>kms</span>: <span><span>&#39;</span>arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500,arn:aws:kms:us-west-2:142069644989:key/846cfb17-373d-49b9-8baf-f36b04512e47,arn:aws:kms:us-west-2:361527076523:key/5052f06a-5d3f-489e-b86c-57201e06f31e<span>&#39;</span></span>
      <span>pgp</span>: <span><span>&#39;</span>FBC7B9E2A4F9289AC0C1D4843D16CEE4A27381B4<span>&#39;</span></span></pre></div>
<p dir="auto">Creating a new file with the right keys is now as simple as</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops &lt;newfile&gt;.prod.yaml"><pre>$ sops <span>&lt;</span>newfile<span>&gt;</span>.prod.yaml</pre></div>
<p dir="auto">Note that the configuration file is ignored when KMS or PGP parameters are
passed on the sops command line or in environment variables.</p>
<a name="user-content-specify-a-different-gpg-executable"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-212specify-a-different-gpg-executable" aria-hidden="true" href="#212specify-a-different-gpg-executable"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id21">2.12   Specify a different GPG executable</a></h3>
<p dir="auto"><code>sops</code> checks for the <code>SOPS_GPG_EXEC</code> environment variable. If specified,
it will attempt to use the executable set there instead of the default
of <code>gpg</code>.</p>
<p dir="auto">Example: place the following in your <code>~/.bashrc</code></p>
<div dir="auto" data-snippet-clipboard-copy-content="SOPS_GPG_EXEC = &#39;your_gpg_client_wrapper&#39;"><pre>SOPS_GPG_EXEC = <span><span>&#39;</span>your_gpg_client_wrapper<span>&#39;</span></span></pre></div>
<a name="user-content-specify-a-different-gpg-key-server"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-213specify-a-different-gpg-key-server" aria-hidden="true" href="#213specify-a-different-gpg-key-server"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id22">2.13   Specify a different GPG key server</a></h3>
<p dir="auto">By default, <code>sops</code> uses the key server <code>keys.openpgp.org</code> to retrieve the GPG
keys that are not present in the local keyring.
This is no longer configurable. You can learn more about why from this write-up: <a href="https://gist.github.com/rjhansen/67ab921ffb4084c865b3618d6955275f">SKS Keyserver Network Under Attack</a>.</p>
<a name="user-content-key-groups"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-214key-groups" aria-hidden="true" href="#214key-groups"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id23">2.14   Key groups</a></h3>
<p dir="auto">By default, <code>sops</code> encrypts the data key for a file with each of the master keys,
such that if any of the master keys is available, the file can be decrypted.
However, it is sometimes desirable to require access to multiple master keys
in order to decrypt files. This can be achieved with key groups.</p>
<p dir="auto">When using key groups in sops, data keys are split into parts such that keys from
multiple groups are required to decrypt a file. <code>sops</code> uses Shamir&#39;s Secret Sharing
to split the data key such that each key group has a fragment, each key in the
key group can decrypt that fragment, and a configurable number of fragments (threshold)
are needed to decrypt and piece together the complete data key. When decrypting a
file using multiple key groups, <code>sops</code> goes through key groups in order, and in
each group, tries to recover the fragment of the data key using a master key from
that group. Once the fragment is recovered, <code>sops</code> moves on to the next group,
until enough fragments have been recovered to obtain the complete data key.</p>
<p dir="auto">By default, the threshold is set to the number of key groups. For example, if
you have three key groups configured in your SOPS file and you don&#39;t override
the default threshold, then one master key from each of the three groups will
be required to decrypt the file.</p>
<p dir="auto">Management of key groups is done with the <code>sops groups</code> command.</p>
<p dir="auto">For example, you can add a new key group with 3 PGP keys and 3 KMS keys to the
file <code>my_file.yaml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops groups add --file my_file.yaml --pgp fingerprint1 --pgp fingerprint2 --pgp fingerprint3 --kms arn1 --kms arn2 --kms arn3"><pre>$ sops groups add --file my_file.yaml --pgp fingerprint1 --pgp fingerprint2 --pgp fingerprint3 --kms arn1 --kms arn2 --kms arn3</pre></div>
<p dir="auto">Or you can delete the 1st group (group number 0, as groups are zero-indexed)
from <code>my_file.yaml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops groups delete --file my_file.yaml 0"><pre>$ sops groups delete --file my_file.yaml 0</pre></div>
<p dir="auto">Key groups can also be specified in the <code>.sops.yaml</code> config file,
like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="creation_rules:
    - path_regex: .*keygroups.*
      key_groups:
      # First key group
      - pgp:
        - fingerprint1
        - fingerprint2
        kms:
        - arn: arn1
          role: role1
          context:
            foo: bar
        - arn: arn2
      # Second key group
      - pgp:
        - fingerprint3
        - fingerprint4
        kms:
        - arn: arn3
        - arn: arn4
      # Third key group
      - pgp:
        - fingerprint5"><pre><span>creation_rules</span>:
    - <span>path_regex</span>: <span>.*keygroups.*</span>
      <span>key_groups</span>:
      <span><span>#</span> First key group</span>
      - <span>pgp</span>:
        - <span>fingerprint1</span>
        - <span>fingerprint2</span>
        <span>kms</span>:
        - <span>arn</span>: <span>arn1</span>
          <span>role</span>: <span>role1</span>
          <span>context</span>:
            <span>foo</span>: <span>bar</span>
        - <span>arn</span>: <span>arn2</span>
      <span><span>#</span> Second key group</span>
      - <span>pgp</span>:
        - <span>fingerprint3</span>
        - <span>fingerprint4</span>
        <span>kms</span>:
        - <span>arn</span>: <span>arn3</span>
        - <span>arn</span>: <span>arn4</span>
      <span><span>#</span> Third key group</span>
      - <span>pgp</span>:
        - <span>fingerprint5</span></pre></div>
<p dir="auto">Given this configuration, we can create a new encrypted file like we normally
would, and optionally provide the <code>--shamir-secret-sharing-threshold</code> command line
flag if we want to override the default threshold. <code>sops</code> will then split the data
key into three parts (from the number of key groups) and encrypt each fragment with
the master keys found in each group.</p>
<p dir="auto">For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --shamir-secret-sharing-threshold 2 example.json"><pre>$ sops --shamir-secret-sharing-threshold 2 example.json</pre></div>
<p dir="auto">Alternatively, you can configure the Shamir threshold for each creation rule in the <code>.sops.yaml</code> config
with <code>shamir_threshold</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="creation_rules:
    - path_regex: .*keygroups.*
      shamir_threshold: 2
      key_groups:
      # First key group
      - pgp:
        - fingerprint1
        - fingerprint2
        kms:
        - arn: arn1
          role: role1
          context:
            foo: bar
        - arn: arn2
      # Second key group
      - pgp:
        - fingerprint3
        - fingerprint4
        kms:
        - arn: arn3
        - arn: arn4
      # Third key group
      - pgp:
        - fingerprint5"><pre><span>creation_rules</span>:
    - <span>path_regex</span>: <span>.*keygroups.*</span>
      <span>shamir_threshold</span>: <span>2</span>
      <span>key_groups</span>:
      <span><span>#</span> First key group</span>
      - <span>pgp</span>:
        - <span>fingerprint1</span>
        - <span>fingerprint2</span>
        <span>kms</span>:
        - <span>arn</span>: <span>arn1</span>
          <span>role</span>: <span>role1</span>
          <span>context</span>:
            <span>foo</span>: <span>bar</span>
        - <span>arn</span>: <span>arn2</span>
      <span><span>#</span> Second key group</span>
      - <span>pgp</span>:
        - <span>fingerprint3</span>
        - <span>fingerprint4</span>
        <span>kms</span>:
        - <span>arn</span>: <span>arn3</span>
        - <span>arn</span>: <span>arn4</span>
      <span><span>#</span> Third key group</span>
      - <span>pgp</span>:
        - <span>fingerprint5</span></pre></div>
<p dir="auto">And then run <code>sops example.json</code>.</p>
<p dir="auto">The threshold (<code>shamir_threshold</code>) is set to 2, so this configuration will require
master keys from two of the three different key groups in order to decrypt the file.
You can then decrypt the file the same way as with any other SOPS file:</p>

<a name="user-content-key-service"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-215key-service" aria-hidden="true" href="#215key-service"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id24">2.15   Key service</a></h3>
<p dir="auto">There are situations where you might want to run <code>sops</code> on a machine that
doesn&#39;t have direct access to encryption keys such as PGP keys. The <code>sops</code> key
service allows you to forward a socket so that <code>sops</code> can access encryption
keys stored on a remote machine. This is similar to GPG Agent, but more
portable.</p>
<p dir="auto">SOPS uses a client-server approach to encrypting and decrypting the data
key. By default, SOPS runs a local key service in-process. SOPS uses a key
service client to send an encrypt or decrypt request to a key service, which
then performs the operation. The requests are sent using gRPC and Protocol
Buffers. The requests contain an identifier for the key they should perform
the operation with, and the plaintext or encrypted data key. The requests do
not contain any cryptographic keys, public or private.</p>
<p dir="auto"><strong>WARNING: the key service connection currently does not use any sort of
authentication or encryption. Therefore, it is recommended that you make sure
the connection is authenticated and encrypted in some other way, for example
through an SSH tunnel.</strong></p>
<p dir="auto">Whenever we try to encrypt or decrypt a data key, SOPS will try to do so first
with the local key service (unless it&#39;s disabled), and if that fails, it will
try all other remote key services until one succeeds.</p>
<p dir="auto">You can start a key service server by running <code>sops keyservice</code>.</p>
<p dir="auto">You can specify the key services the <code>sops</code> binary uses with <code>--keyservice</code>.
This flag can be specified more than once, so you can use multiple key
services. The local key service can be disabled with
<code>enable-local-keyservice=false</code>.</p>
<p dir="auto">For example, to decrypt a file using both the local key service and the key
service exposed on the unix socket located in <code>/tmp/sops.sock</code>, you can run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --keyservice unix:///tmp/sops.sock -d file.yaml`"><pre>$ sops --keyservice unix:///tmp/sops.sock -d file.yaml<span><span>`</span></span></pre></div>
<p dir="auto">And if you only want to use the key service exposed on the unix socket located
in <code>/tmp/sops.sock</code> and not the local key service, you can run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --enable-local-keyservice=false --keyservice unix:///tmp/sops.sock -d file.yaml"><pre>$ sops --enable-local-keyservice=false --keyservice unix:///tmp/sops.sock -d file.yaml</pre></div>
<a name="user-content-auditing"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-216auditing" aria-hidden="true" href="#216auditing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id25">2.16   Auditing</a></h3>
<p dir="auto">Sometimes, users want to be able to tell what files were accessed by whom in an
environment they control. For this reason, SOPS can generate audit logs to
record activity on encrypted files. When enabled, SOPS will write a log entry
into a pre-configured PostgreSQL database when a file is decrypted. The log
includes a timestamp, the username SOPS is running as, and the file that was
decrypted.</p>
<p dir="auto">In order to enable auditing, you must first create the database and credentials
using the schema found in <code>audit/schema.sql</code>. This schema defines the
tables that store the audit events and a role named <code>sops</code> that only has
permission to add entries to the audit event tables. The default password for
the role <code>sops</code> is <code>sops</code>. You should change this password.</p>
<p dir="auto">Once you have created the database, you have to tell SOPS how to connect to it.
Because we don&#39;t want users of SOPS to be able to control auditing, the audit
configuration file location is not configurable, and must be at
<code>/etc/sops/audit.yaml</code>. This file should have strict permissions such
that only the root user can modify it.</p>
<p dir="auto">For example, to enable auditing to a PostgreSQL database named <code>sops</code> running
on localhost, using the user <code>sops</code> and the password <code>sops</code>,
<code>/etc/sops/audit.yaml</code> should have the following contents:</p>
<div dir="auto" data-snippet-clipboard-copy-content="backends:
    postgres:
        - connection_string: &#34;postgres://sops:sops@localhost/sops?sslmode=verify-full&#34;"><pre><span>backends</span>:
    <span>postgres</span>:
        - <span>connection_string</span>: <span><span>&#34;</span>postgres://sops:sops@localhost/sops?sslmode=verify-full<span>&#34;</span></span></pre></div>
<p dir="auto">You can find more information on the <code>connection_string</code> format in the
<a href="https://www.postgresql.org/docs/current/static/libpq-connect.html#libpq-connstring" rel="nofollow">PostgreSQL docs</a>.</p>
<p dir="auto">Under the <code>postgres</code> map entry in the above YAML is a list, so one can
provide more than one backend, and SOPS will log to all of them:</p>
<div dir="auto" data-snippet-clipboard-copy-content="backends:
    postgres:
        - connection_string: &#34;postgres://sops:sops@localhost/sops?sslmode=verify-full&#34;
        - connection_string: &#34;postgres://sops:sops@remotehost/sops?sslmode=verify-full&#34;"><pre><span>backends</span>:
    <span>postgres</span>:
        - <span>connection_string</span>: <span><span>&#34;</span>postgres://sops:sops@localhost/sops?sslmode=verify-full<span>&#34;</span></span>
        - <span>connection_string</span>: <span><span>&#34;</span>postgres://sops:sops@remotehost/sops?sslmode=verify-full<span>&#34;</span></span></pre></div>
<a name="user-content-saving-output-to-a-file"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-217saving-output-to-a-file" aria-hidden="true" href="#217saving-output-to-a-file"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id26">2.17   Saving Output to a File</a></h3>
<p dir="auto">By default <code>sops</code> just dumps all the output to the standard output. We can use the
<code>--output</code> flag followed by a filename to save the output to the file specified.
Beware using both <code>--in-place</code> and <code>--output</code> flags will result in an error.</p>
<a name="user-content-passing-secrets-to-other-processes"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-218passing-secrets-to-other-processes" aria-hidden="true" href="#218passing-secrets-to-other-processes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id27">2.18   Passing Secrets to Other Processes</a></h3>
<p dir="auto">In addition to writing secrets to standard output and to files on disk, <code>sops</code>
has two commands for passing decrypted secrets to a new process: <code>exec-env</code>
and <code>exec-file</code>. These commands will place all output into the environment of
a child process and into a temporary file, respectively. For example, if a
program looks for credentials in its environment, <code>exec-env</code> can be used to
ensure that the decrypted contents are available only to this process and never
written to disk.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# print secrets to stdout to confirm values
$ sops -d out.json
{
        &#34;database_password&#34;: &#34;jf48t9wfw094gf4nhdf023r&#34;,
        &#34;AWS_ACCESS_KEY_ID&#34;: &#34;AKIAIOSFODNN7EXAMPLE&#34;,
        &#34;AWS_SECRET_KEY&#34;: &#34;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&#34;
}

# decrypt out.json and run a command
# the command prints the environment variable and runs a script that uses it
$ sops exec-env out.json &#39;echo secret: $database_password; ./database-import&#39;
secret: jf48t9wfw094gf4nhdf023r

# launch a shell with the secrets available in its environment
$ sops exec-env out.json &#39;sh&#39;
sh-3.2# echo $database_password
jf48t9wfw094gf4nhdf023r

# the secret is not accessible anywhere else
sh-3.2$ exit
$ echo your password: $database_password
your password:"><pre><span><span>#</span> print secrets to stdout to confirm values</span>
$ sops -d out.json
{
        <span><span>&#34;</span>database_password<span>&#34;</span></span>: <span><span>&#34;</span>jf48t9wfw094gf4nhdf023r<span>&#34;</span></span>,
        <span><span>&#34;</span>AWS_ACCESS_KEY_ID<span>&#34;</span></span>: <span><span>&#34;</span>AKIAIOSFODNN7EXAMPLE<span>&#34;</span></span>,
        <span><span>&#34;</span>AWS_SECRET_KEY<span>&#34;</span></span>: <span><span>&#34;</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY<span>&#34;</span></span>
}

<span><span>#</span> decrypt out.json and run a command</span>
<span><span>#</span> the command prints the environment variable and runs a script that uses it</span>
$ sops exec-env out.json <span><span>&#39;</span>echo secret: $database_password; ./database-import<span>&#39;</span></span>
secret: jf48t9wfw094gf4nhdf023r

<span><span>#</span> launch a shell with the secrets available in its environment</span>
$ sops exec-env out.json <span><span>&#39;</span>sh<span>&#39;</span></span>
sh-3.2# <span>echo</span> <span>$database_password</span>
jf48t9wfw094gf4nhdf023r

<span><span>#</span> the secret is not accessible anywhere else</span>
sh-3.2$ <span>exit</span>
$ <span>echo</span> your password: <span>$database_password</span>
your password:</pre></div>
<p dir="auto">If the command you want to run only operates on files, you can use <code>exec-file</code>
instead. By default <code>sops</code> will use a FIFO to pass the contents of the
decrypted file to the new program. Using a FIFO, secrets are only passed in
memory which has two benefits: the plaintext secrets never touch the disk, and
the child process can only read the secrets once. In contexts where this won&#39;t
work, eg platforms like Windows where FIFOs unavailable or secret files that need
to be available to the child process longer term, the <code>--no-fifo</code> flag can be
used to instruct <code>sops</code> to use a traditional temporary file that will get cleaned
up once the process is finished executing. <code>exec-file</code> behaves similar to
<code>find(1)</code> in that <code>{}</code> is used as a placeholder in the command which will be
substituted with the temporary file path (whether a FIFO or an actual file).</p>
<div dir="auto" data-snippet-clipboard-copy-content="# operating on the same file as before, but as a file this time
$ sops exec-file out.json &#39;echo your temporary file: {}; cat {}&#39;
your temporary file: /tmp/.sops894650499/tmp-file
{
        &#34;database_password&#34;: &#34;jf48t9wfw094gf4nhdf023r&#34;,
        &#34;AWS_ACCESS_KEY_ID&#34;: &#34;AKIAIOSFODNN7EXAMPLE&#34;,
        &#34;AWS_SECRET_KEY&#34;: &#34;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&#34;
}

# launch a shell with a variable TMPFILE pointing to the temporary file
$ sops exec-file --no-fifo out.json &#39;TMPFILE={} sh&#39;
sh-3.2$ echo $TMPFILE
/tmp/.sops506055069/tmp-file291138648
sh-3.2$ cat $TMPFILE
{
        &#34;database_password&#34;: &#34;jf48t9wfw094gf4nhdf023r&#34;,
        &#34;AWS_ACCESS_KEY_ID&#34;: &#34;AKIAIOSFODNN7EXAMPLE&#34;,
        &#34;AWS_SECRET_KEY&#34;: &#34;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&#34;
}
sh-3.2$ ./program --config $TMPFILE
sh-3.2$ exit

# try to open the temporary file from earlier
$ cat /tmp/.sops506055069/tmp-file291138648
cat: /tmp/.sops506055069/tmp-file291138648: No such file or directory"><pre><span><span>#</span> operating on the same file as before, but as a file this time</span>
$ sops exec-file out.json <span><span>&#39;</span>echo your temporary file: {}; cat {}<span>&#39;</span></span>
your temporary file: /tmp/.sops894650499/tmp-file
{
        <span><span>&#34;</span>database_password<span>&#34;</span></span>: <span><span>&#34;</span>jf48t9wfw094gf4nhdf023r<span>&#34;</span></span>,
        <span><span>&#34;</span>AWS_ACCESS_KEY_ID<span>&#34;</span></span>: <span><span>&#34;</span>AKIAIOSFODNN7EXAMPLE<span>&#34;</span></span>,
        <span><span>&#34;</span>AWS_SECRET_KEY<span>&#34;</span></span>: <span><span>&#34;</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY<span>&#34;</span></span>
}

<span><span>#</span> launch a shell with a variable TMPFILE pointing to the temporary file</span>
$ sops exec-file --no-fifo out.json <span><span>&#39;</span>TMPFILE={} sh<span>&#39;</span></span>
sh-3.2$ <span>echo</span> <span>$TMPFILE</span>
/tmp/.sops506055069/tmp-file291138648
sh-3.2$ cat <span>$TMPFILE</span>
{
        <span><span>&#34;</span>database_password<span>&#34;</span></span>: <span><span>&#34;</span>jf48t9wfw094gf4nhdf023r<span>&#34;</span></span>,
        <span><span>&#34;</span>AWS_ACCESS_KEY_ID<span>&#34;</span></span>: <span><span>&#34;</span>AKIAIOSFODNN7EXAMPLE<span>&#34;</span></span>,
        <span><span>&#34;</span>AWS_SECRET_KEY<span>&#34;</span></span>: <span><span>&#34;</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY<span>&#34;</span></span>
}
sh-3.2$ ./program --config <span>$TMPFILE</span>
sh-3.2$ <span>exit</span>

<span><span>#</span> try to open the temporary file from earlier</span>
$ cat /tmp/.sops506055069/tmp-file291138648
cat: /tmp/.sops506055069/tmp-file291138648: No such file or directory</pre></div>
<p dir="auto">Additionally, on unix-like platforms, both <code>exec-env</code> and <code>exec-file</code>
support dropping privileges before executing the new program via the
<code>--user &lt;username&gt;</code> flag. This is particularly useful in cases where the
encrypted file is only readable by root, but the target program does not
need root privileges to function. This flag should be used where possible
for added security.</p>
<p dir="auto">To overwrite the default file name (<code>tmp-file</code>) in <code>exec-file</code> use the
<code>--filename &lt;filename&gt;</code> parameter.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# the encrypted file can&#39;t be read by the current user
$ cat out.json
cat: out.json: Permission denied

# execute sops as root, decrypt secrets, then drop privileges
$ sudo sops exec-env --user nobody out.json &#39;sh&#39;
sh-3.2$ echo $database_password
jf48t9wfw094gf4nhdf023r

# dropped privileges, still can&#39;t load the original file
sh-3.2$ id
uid=4294967294(nobody) gid=4294967294(nobody) groups=4294967294(nobody)
sh-3.2$ cat out.json
cat: out.json: Permission denied"><pre><span><span>#</span> the encrypted file can&#39;t be read by the current user</span>
$ cat out.json
cat: out.json: Permission denied

<span><span>#</span> execute sops as root, decrypt secrets, then drop privileges</span>
$ sudo sops exec-env --user nobody out.json <span><span>&#39;</span>sh<span>&#39;</span></span>
sh-3.2$ <span>echo</span> <span>$database_password</span>
jf48t9wfw094gf4nhdf023r

<span><span>#</span> dropped privileges, still can&#39;t load the original file</span>
sh-3.2$ id
uid=4294967294(nobody) gid=4294967294(nobody) groups=4294967294(nobody)
sh-3.2$ cat out.json
cat: out.json: Permission denied</pre></div>
<a name="user-content-using-the-publish-command"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-219using-the-publish-command" aria-hidden="true" href="#219using-the-publish-command"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id28">2.19   Using the publish command</a></h3>
<p dir="auto"><code>sops publish $file</code> publishes a file to a pre-configured destination (this lives in the sops
config file). Additionally, support re-encryption rules that work just like the creation rules.</p>
<p dir="auto">This command requires a <code>.sops.yaml</code> configuration file. Below is an example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="destination_rules:
   - s3_bucket: &#34;sops-secrets&#34;
     path_regex: s3/*
     recreation_rule:
        pgp: F69E4901EDBAD2D1753F8C67A64535C4163FB307
   - gcs_bucket: &#34;sops-secrets&#34;
     path_regex: gcs/*
     recreation_rule:
        pgp: F69E4901EDBAD2D1753F8C67A64535C4163FB307
   - vault_path: &#34;sops/&#34;
     vault_kv_mount_name: &#34;secret/&#34; # default
     vault_kv_version: 2 # default
     path_regex: vault/*
     omit_extensions: true"><pre><span>destination_rules</span>:
   - <span>s3_bucket</span>: <span><span>&#34;</span>sops-secrets<span>&#34;</span></span>
     <span>path_regex</span>: <span>s3/*</span>
     <span>recreation_rule</span>:
        <span>pgp</span>: <span>F69E4901EDBAD2D1753F8C67A64535C4163FB307</span>
   - <span>gcs_bucket</span>: <span><span>&#34;</span>sops-secrets<span>&#34;</span></span>
     <span>path_regex</span>: <span>gcs/*</span>
     <span>recreation_rule</span>:
        <span>pgp</span>: <span>F69E4901EDBAD2D1753F8C67A64535C4163FB307</span>
   - <span>vault_path</span>: <span><span>&#34;</span>sops/<span>&#34;</span></span>
     <span>vault_kv_mount_name</span>: <span><span>&#34;</span>secret/<span>&#34;</span></span> <span><span>#</span> default</span>
     <span>vault_kv_version</span>: <span>2</span> <span><span>#</span> default</span>
     <span>path_regex</span>: <span>vault/*</span>
     <span>omit_extensions</span>: <span>true</span></pre></div>
<p dir="auto">The above configuration will place all files under <code>s3/*</code> into the S3 bucket <code>sops-secrets</code>,
all files under <code>gcs/*</code> into the GCS bucket <code>sops-secrets</code>, and the contents of all files under
<code>vault/*</code> into Vault&#39;s KV store under the path <code>secrets/sops/</code>. For the files that will be
published to S3 and GCS, it will decrypt them and re-encrypt them using the
<code>F69E4901EDBAD2D1753F8C67A64535C4163FB307</code> pgp key.</p>
<p dir="auto">You would deploy a file to S3 with a command like: <code>sops publish s3/app.yaml</code></p>
<p dir="auto">To publish all files in selected directory recursively, you need to specify <code>--recursive</code> flag.</p>
<p dir="auto">If you don&#39;t want file extension to appear in destination secret path, use <code>--omit-extensions</code>
flag or <code>omit_extensions: true</code> in the destination rule in <code>.sops.yaml</code>.</p>
<a name="user-content-publishing-to-vault"></a>
<h4 tabindex="-1" dir="auto"><a id="user-content-2191publishing-to-vault" aria-hidden="true" href="#2191publishing-to-vault"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id29">2.19.1   Publishing to Vault</a></h4>
<p dir="auto">There are a few settings for Vault that you can place in your destination rules. The first
is <code>vault_path</code>, which is required. The others are optional, and they are
<code>vault_address</code>, <code>vault_kv_mount_name</code>, <code>vault_kv_version</code>.</p>
<p dir="auto"><code>sops</code> uses the official Vault API provided by Hashicorp, which makes use of <a href="https://www.vaultproject.io/docs/commands/#environment-variables" rel="nofollow">environment
variables</a> for
configuring the client.</p>
<p dir="auto"><code>vault_kv_mount_name</code> is used if your Vault KV is mounted somewhere other than <code>secret/</code>.
<code>vault_kv_version</code> supports <code>1</code> and <code>2</code>, with <code>2</code> being the default.</p>
<p dir="auto">If destination secret path already exists in Vault and contains same data as the source file, it
will be skipped.</p>
<p dir="auto">Below is an example of publishing to Vault (using token auth with a local dev instance of Vault).</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export VAULT_TOKEN=...
$ export VAULT_ADDR=&#39;http://127.0.0.1:8200&#39;
$ sops -d vault/test.yaml
example_string: bar
example_number: 42
example_map:
    key: value
$ sops publish vault/test.yaml
uploading /home/user/sops_directory/vault/test.yaml to http://127.0.0.1:8200/v1/secret/data/sops/test.yaml ? (y/n): y
$ vault kv get secret/sops/test.yaml
====== Metadata ======
Key              Value
---              -----
created_time     2019-07-11T03:32:17.074792017Z
deletion_time    n/a
destroyed        false
version          3

========= Data =========
Key               Value
---               -----
example_map       map[key:value]
example_number    42
example_string    bar"><pre>$ <span>export</span> VAULT_TOKEN=...
$ <span>export</span> VAULT_ADDR=<span><span>&#39;</span>http://127.0.0.1:8200<span>&#39;</span></span>
$ sops -d vault/test.yaml
example_string: bar
example_number: 42
example_map:
    key: value
$ sops publish vault/test.yaml
uploading /home/user/sops_directory/vault/test.yaml to http://127.0.0.1:8200/v1/secret/data/sops/test.yaml <span>?</span> (y/n): y
$ vault kv get secret/sops/test.yaml
====== Metadata ======
Key              Value
---              -----
created_time     2019-07-11T03:32:17.074792017Z
deletion_time    n/a
destroyed        <span>false</span>
version          3

========= Data =========
Key               Value
---               -----
example_map       map[key:value]
example_number    42
example_string    bar</pre></div>
<a name="user-content-important-information-on-types"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-3important-information-on-types" aria-hidden="true" href="#3important-information-on-types"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id30">3   Important information on types</a></h2>
<a name="user-content-yaml-and-json-type-extensions"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-31yaml-and-json-type-extensions" aria-hidden="true" href="#31yaml-and-json-type-extensions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id31">3.1   YAML and JSON type extensions</a></h3>
<p dir="auto"><code>sops</code> uses the file extension to decide which encryption method to use on the file
content. <code>YAML</code>, <code>JSON</code>, <code>ENV</code>, and <code>INI</code> files are treated as trees of data, and key/values are
extracted from the files to only encrypt the leaf values. The tree structure is also
used to check the integrity of the file.</p>
<p dir="auto">Therefore, if a file is encrypted using a specific format, it need to be decrypted
in the same format. The easiest way to achieve this is to conserve the original file
extension after encrypting a file. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops -e -i myfile.json
$ sops -d myfile.json"><pre>$ sops -e -i myfile.json
$ sops -d myfile.json</pre></div>
<p dir="auto">If you want to change the extension of the file once encrypted, you need to provide
sops with the <code>--input-type</code> flag upon decryption. For example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops -e myfile.json &gt; myfile.json.enc

$ sops -d --input-type json myfile.json.enc"><pre>$ sops -e myfile.json <span>&gt;</span> myfile.json.enc

$ sops -d --input-type json myfile.json.enc</pre></div>
<p dir="auto">When operating on stdin, use the <code>--input-type</code> and <code>--output-type</code> flags as follows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ cat myfile.json | sops --input-type json --output-type json -d /dev/stdin"><pre>$ cat myfile.json <span>|</span> sops --input-type json --output-type json -d /dev/stdin</pre></div>
<a name="user-content-yaml-anchors"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-32yaml-anchors" aria-hidden="true" href="#32yaml-anchors"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id32">3.2   YAML anchors</a></h3>
<p dir="auto"><code>sops</code> only supports a subset of <code>YAML</code>&#39;s many types. Encrypting YAML files that
contain strings, numbers and booleans will work fine, but files that contain anchors
will not work, because the anchors redefine the structure of the file at load time.</p>
<p dir="auto">This file will not work in <code>sops</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="bill-to:  &amp;id001
    street: |
        123 Tornado Alley
        Suite 16
    city:   East Centerville
    state:  KS

ship-to:  *id001"><pre><span>bill-to</span>:  <span>&amp;id001</span>
    <span>street</span>: <span>|</span>
<span>        123 Tornado Alley</span>
<span>        Suite 16</span>
<span></span>    <span>city</span>:   <span>East Centerville</span>
    <span>state</span>:  <span>KS</span>

<span>ship-to</span>:  <span>*id001</span></pre></div>
<p dir="auto"><code>sops</code> uses the path to a value as additional data in the AEAD encryption, and thus
dynamic paths generated by anchors break the authentication step.</p>
<p dir="auto">JSON and TEXT file types do not support anchors and thus have no such limitation.</p>
<a name="user-content-yaml-streams"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-33yaml-streams" aria-hidden="true" href="#33yaml-streams"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id33">3.3   YAML Streams</a></h3>
<p dir="auto"><code>YAML</code> supports having more than one &#34;document&#34; in a single file, while
formats like <code>JSON</code> do not. <code>sops</code> is able to handle both. This means the
following multi-document will be encrypted as expected:</p>
<div dir="auto" data-snippet-clipboard-copy-content="---
data: foo
---
data: bar"><pre>---
<span>data</span>: <span>foo</span>
---
<span>data</span>: <span>bar</span></pre></div>
<p dir="auto">Note that the <code>sops</code> metadata, i.e. the hash, etc, is computed for the physical
file rather than each internal &#34;document&#34;.</p>
<a name="user-content-top-level-arrays"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-34top-level-arrays" aria-hidden="true" href="#34top-level-arrays"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id34">3.4   Top-level arrays</a></h3>
<p dir="auto"><code>YAML</code> and <code>JSON</code> top-level arrays are not supported, because <code>sops</code>
needs a top-level <code>sops</code> key to store its metadata.</p>
<p dir="auto">This file will not work in sops:</p>
<div dir="auto" data-snippet-clipboard-copy-content="---
  - some
  - array
  - elements"><pre>---
  - <span>some</span>
  - <span>array</span>
  - <span>elements</span></pre></div>
<p dir="auto">But this one will work because the <code>sops</code> key can be added at the same level as the
<code>data</code> key.</p>
<div dir="auto" data-snippet-clipboard-copy-content="data:
  - some
  - array
  - elements"><pre><span>data</span>:
  - <span>some</span>
  - <span>array</span>
  - <span>elements</span></pre></div>
<p dir="auto">Similarly, with <code>JSON</code> arrays, this document will not work:</p>
<div dir="auto" data-snippet-clipboard-copy-content="[
  &#34;some&#34;,
  &#34;array&#34;,
  &#34;elements&#34;
]"><pre>[
  <span><span>&#34;</span>some<span>&#34;</span></span>,
  <span><span>&#34;</span>array<span>&#34;</span></span>,
  <span><span>&#34;</span>elements<span>&#34;</span></span>
]</pre></div>
<p dir="auto">But this one will work just fine:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;data&#34;: [
    &#34;some&#34;,
    &#34;array&#34;,
    &#34;elements&#34;
  ]
}"><pre>{
  <span>&#34;data&#34;</span>: [
    <span><span>&#34;</span>some<span>&#34;</span></span>,
    <span><span>&#34;</span>array<span>&#34;</span></span>,
    <span><span>&#34;</span>elements<span>&#34;</span></span>
  ]
}</pre></div>
<a name="user-content-examples"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-4examples" aria-hidden="true" href="#4examples"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id35">4   Examples</a></h2>
<p dir="auto">Take a look into the <a href="https://github.com/mozilla/sops/tree/master/examples">examples</a> folder for detailed use cases of sops in a CI environment. The section below describes specific tips for common use cases.</p>
<a name="user-content-creating-a-new-file"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-41creating-a-new-file" aria-hidden="true" href="#41creating-a-new-file"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id36">4.1   Creating a new file</a></h3>
<p dir="auto">The command below creates a new file with a data key encrypted by KMS and PGP.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --kms &#34;arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500&#34; --pgp C9CAB0AF1165060DB58D6D6B2653B624D620786D /path/to/new/file.yaml"><pre>$ sops --kms <span><span>&#34;</span>arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500<span>&#34;</span></span> --pgp C9CAB0AF1165060DB58D6D6B2653B624D620786D /path/to/new/file.yaml</pre></div>
<a name="user-content-encrypting-an-existing-file"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-42encrypting-an-existing-file" aria-hidden="true" href="#42encrypting-an-existing-file"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id37">4.2   Encrypting an existing file</a></h3>
<p dir="auto">Similar to the previous command, we tell sops to use one KMS and one PGP key.
The path points to an existing cleartext file, so we give sops flag <code>-e</code> to
encrypt the file, and redirect the output to a destination file.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export SOPS_KMS_ARN=&#34;arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500&#34;
$ export SOPS_PGP_FP=&#34;C9CAB0AF1165060DB58D6D6B2653B624D620786D&#34;
$ sops -e /path/to/existing/file.yaml &gt; /path/to/new/encrypted/file.yaml"><pre>$ <span>export</span> SOPS_KMS_ARN=<span><span>&#34;</span>arn:aws:kms:us-west-2:927034868273:key/fe86dd69-4132-404c-ab86-4269956b4500<span>&#34;</span></span>
$ <span>export</span> SOPS_PGP_FP=<span><span>&#34;</span>C9CAB0AF1165060DB58D6D6B2653B624D620786D<span>&#34;</span></span>
$ sops -e /path/to/existing/file.yaml <span>&gt;</span> /path/to/new/encrypted/file.yaml</pre></div>
<p dir="auto">Decrypt the file with <code>-d</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops -d /path/to/new/encrypted/file.yaml"><pre>$ sops -d /path/to/new/encrypted/file.yaml</pre></div>
<a name="user-content-encrypt-or-decrypt-a-file-in-place"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-43encrypt-or-decrypt-a-file-in-place" aria-hidden="true" href="#43encrypt-or-decrypt-a-file-in-place"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id38">4.3   Encrypt or decrypt a file in place</a></h3>
<p dir="auto">Rather than redirecting the output of <code>-e</code> or <code>-d</code>, sops can replace the
original file after encrypting or decrypting it.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# file.yaml is in cleartext
$ sops -e -i /path/to/existing/file.yaml
# file.yaml is now encrypted
$ sops -d -i /path/to/existing/file.yaml
# file.yaml is back in cleartext"><pre><span><span>#</span> file.yaml is in cleartext</span>
$ sops -e -i /path/to/existing/file.yaml
<span><span>#</span> file.yaml is now encrypted</span>
$ sops -d -i /path/to/existing/file.yaml
<span><span>#</span> file.yaml is back in cleartext</span></pre></div>
<a name="user-content-encrypting-binary-files"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-44encrypting-binary-files" aria-hidden="true" href="#44encrypting-binary-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id39">4.4   Encrypting binary files</a></h3>
<p dir="auto"><code>sops</code> primary use case is encrypting YAML and JSON configuration files, but it
also has the ability to manage binary files. When encrypting a binary, sops will
read the data as bytes, encrypt it, store the encrypted base64 under
<code>tree[&#39;data&#39;]</code> and write the result as JSON.</p>
<p dir="auto">Note that the base64 encoding of encrypted data can actually make the encrypted
file larger than the cleartext one.</p>
<p dir="auto">In-place encryption/decryption also works on binary files.</p>
<pre>$ dd if=/dev/urandom of=/tmp/somerandom bs=1024
count=512
512+0 records in
512+0 records out
524288 bytes (524 kB) copied, 0.0466158 s, 11.2 MB/s

$ sha512sum /tmp/somerandom
9589bb20280e9d381f7a192000498c994e921b3cdb11d2ef5a986578dc2239a340b25ef30691bac72bdb14028270828dad7e8bd31e274af9828c40d216e60cbe /tmp/somerandom

$ sops -e -i /tmp/somerandom
please wait while a data encryption key is being generated and stored securely

$ sops -d -i /tmp/somerandom

$ sha512sum /tmp/somerandom
9589bb20280e9d381f7a192000498c994e921b3cdb11d2ef5a986578dc2239a340b25ef30691bac72bdb14028270828dad7e8bd31e274af9828c40d216e60cbe /tmp/somerandom
</pre>
<a name="user-content-extract-a-sub-part-of-a-document-tree"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-45extract-a-sub-part-of-a-document-tree" aria-hidden="true" href="#45extract-a-sub-part-of-a-document-tree"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id40">4.5   Extract a sub-part of a document tree</a></h3>
<p dir="auto"><code>sops</code> can extract a specific part of a YAML or JSON document, by provided the
path in the <code>--extract</code> command line flag. This is useful to extract specific
values, like keys, without needing an extra parser.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops -d --extract &#39;[&#34;app2&#34;][&#34;key&#34;]&#39; ~/git/svc/sops/example.yaml
-----BEGIN RSA PRIVATE KEY-----
MIIBPAIBAAJBAPTMNIyHuZtpLYc7VsHQtwOkWYobkUblmHWRmbXzlAX6K8tMf3Wf
ImcbNkqAKnELzFAPSBeEMhrBN0PyOC9lYlMCAwEAAQJBALXD4sjuBn1E7Y9aGiMz
bJEBuZJ4wbhYxomVoQKfaCu+kH80uLFZKoSz85/ySauWE8LgZcMLIBoiXNhDKfQL
vHECIQD6tCG9NMFWor69kgbX8vK5Y+QL+kRq+9HK6yZ9a+hsLQIhAPn4Ie6HGTjw
fHSTXWZpGSan7NwTkIu4U5q2SlLjcZh/AiEA78NYRRBwGwAYNUqzutGBqyXKUl4u
Erb0xAEyVV7e8J0CIQC8VBY8f8yg+Y7Kxbw4zDYGyb3KkXL10YorpeuZR4LuQQIg
bKGPkMM4w5blyE1tqGN0T7sJwEx+EUOgacRNqM2ljVA=
-----END RSA PRIVATE KEY-----"><pre>$ sops -d --extract <span><span>&#39;</span>[&#34;app2&#34;][&#34;key&#34;]<span>&#39;</span></span> <span>~</span>/git/svc/sops/example.yaml
-----BEGIN RSA PRIVATE KEY-----
MIIBPAIBAAJBAPTMNIyHuZtpLYc7VsHQtwOkWYobkUblmHWRmbXzlAX6K8tMf3Wf
ImcbNkqAKnELzFAPSBeEMhrBN0PyOC9lYlMCAwEAAQJBALXD4sjuBn1E7Y9aGiMz
bJEBuZJ4wbhYxomVoQKfaCu+kH80uLFZKoSz85/ySauWE8LgZcMLIBoiXNhDKfQL
vHECIQD6tCG9NMFWor69kgbX8vK5Y+QL+kRq+9HK6yZ9a+hsLQIhAPn4Ie6HGTjw
fHSTXWZpGSan7NwTkIu4U5q2SlLjcZh/AiEA78NYRRBwGwAYNUqzutGBqyXKUl4u
Erb0xAEyVV7e8J0CIQC8VBY8f8yg+Y7Kxbw4zDYGyb3KkXL10YorpeuZR4LuQQIg
bKGPkMM4w5blyE1tqGN0T7sJwEx+EUOgacRNqM2ljVA=
-----END RSA PRIVATE KEY-----</pre></div>
<p dir="auto">The tree path syntax uses regular python dictionary syntax, without the
variable name. Extract keys by naming them, and array elements by numbering
them.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops -d --extract &#39;[&#34;an_array&#34;][1]&#39; ~/git/svc/sops/example.yaml
secretuser2"><pre>$ sops -d --extract <span><span>&#39;</span>[&#34;an_array&#34;][1]<span>&#39;</span></span> <span>~</span>/git/svc/sops/example.yaml
secretuser2</pre></div>
<a name="user-content-set-a-sub-part-in-a-document-tree"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-46set-a-sub-part-in-a-document-tree" aria-hidden="true" href="#46set-a-sub-part-in-a-document-tree"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id41">4.6   Set a sub-part in a document tree</a></h3>
<p dir="auto"><code>sops</code> can set a specific part of a YAML or JSON document, by providing
the path and value in the <code>--set</code> command line flag. This is useful to
set specific values, like keys, without needing an editor.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --set &#39;[&#34;app2&#34;][&#34;key&#34;] &#34;app2keystringvalue&#34;&#39;  ~/git/svc/sops/example.yaml"><pre>$ sops --set <span><span>&#39;</span>[&#34;app2&#34;][&#34;key&#34;] &#34;app2keystringvalue&#34;<span>&#39;</span></span>  <span>~</span>/git/svc/sops/example.yaml</pre></div>
<p dir="auto">The tree path syntax uses regular python dictionary syntax, without the
variable name. Set to keys by naming them, and array elements by
numbering them.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --set &#39;[&#34;an_array&#34;][1] &#34;secretuser2&#34;&#39; ~/git/svc/sops/example.yaml"><pre>$ sops --set <span><span>&#39;</span>[&#34;an_array&#34;][1] &#34;secretuser2&#34;<span>&#39;</span></span> <span>~</span>/git/svc/sops/example.yaml</pre></div>
<p dir="auto">The value must be formatted as json.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --set &#39;[&#34;an_array&#34;][1] {&#34;uid1&#34;:null,&#34;uid2&#34;:1000,&#34;uid3&#34;:[&#34;bob&#34;]}&#39; ~/git/svc/sops/example.yaml"><pre>$ sops --set <span><span>&#39;</span>[&#34;an_array&#34;][1] {&#34;uid1&#34;:null,&#34;uid2&#34;:1000,&#34;uid3&#34;:[&#34;bob&#34;]}<span>&#39;</span></span> <span>~</span>/git/svc/sops/example.yaml</pre></div>
<a name="user-content-showing-diffs-in-cleartext-in-git"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-47showing-diffs-in-cleartext-in-git" aria-hidden="true" href="#47showing-diffs-in-cleartext-in-git"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id42">4.7   Showing diffs in cleartext in git</a></h3>
<p dir="auto">You most likely want to store encrypted files in a version controlled repository.
Sops can be used with git to decrypt files when showing diffs between versions.
This is very handy for reviewing changes or visualizing history.</p>
<p dir="auto">To configure sops to decrypt files during diff, create a <code>.gitattributes</code> file
at the root of your repository that contains a filter and a command.</p>
<pre>*.yaml diff=sopsdiffer
</pre>
<p dir="auto">Here we only care about YAML files. <code>sopsdiffer</code> is an arbitrary name that we map
to a sops command in the git configuration file of the repository.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ git config diff.sopsdiffer.textconv &#34;sops -d&#34;

$ grep -A 1 sopsdiffer .git/config
[diff &#34;sopsdiffer&#34;]
        textconv = &#34;sops -d&#34;"><pre>$ git config diff.sopsdiffer.textconv <span><span>&#34;</span>sops -d<span>&#34;</span></span>

$ grep -A 1 sopsdiffer .git/config
[diff <span><span>&#34;</span>sopsdiffer<span>&#34;</span></span>]
        textconv = <span><span>&#34;</span>sops -d<span>&#34;</span></span></pre></div>
<p dir="auto">With this in place, calls to <code>git diff</code> will decrypt both previous and current
versions of the target file prior to displaying the diff. And it even works with
git client interfaces, because they call git diff under the hood!</p>
<a name="user-content-encrypting-only-parts-of-a-file"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-48encrypting-only-parts-of-a-file" aria-hidden="true" href="#48encrypting-only-parts-of-a-file"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id43">4.8   Encrypting only parts of a file</a></h3>
<p dir="auto">Note: this only works on YAML and JSON files, not on BINARY files.</p>
<p dir="auto">By default, <code>sops</code> encrypts all the values of a YAML or JSON file and leaves the
keys in cleartext. In some instances, you may want to exclude some values from
being encrypted. This can be accomplished by adding the suffix <strong>_unencrypted</strong>
to any key of a file. When set, all values underneath the key that set the
<strong>_unencrypted</strong> suffix will be left in cleartext.</p>
<p dir="auto">Note that, while in cleartext, unencrypted content is still added to the
checksum of the file, and thus cannot be modified outside of sops without
breaking the file integrity check.</p>
<p dir="auto">The unencrypted suffix can be set to a different value using the
<code>--unencrypted-suffix</code> option.</p>
<p dir="auto">Conversely, you can opt in to only encrypt some values in a YAML or JSON file,
by adding a chosen suffix to those keys and passing it to the <code>--encrypted-suffix</code> option.</p>
<p dir="auto">A third method is to use the <code>--encrypted-regex</code> which will only encrypt values under
keys that match the supplied regular expression.  For example, this command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --encrypt --encrypted-regex &#39;^(data|stringData)$&#39; k8s-secrets.yaml"><pre>$ sops --encrypt --encrypted-regex <span><span>&#39;</span>^(data|stringData)$<span>&#39;</span></span> k8s-secrets.yaml</pre></div>
<p dir="auto">will encrypt the values under the <code>data</code> and <code>stringData</code> keys in a YAML file
containing kubernetes secrets.  It will not encrypt other values that help you to
navigate the file, like <code>metadata</code> which contains the secrets&#39; names.</p>
<p dir="auto">Conversely, you can opt in to only left certain keys without encrypting by using the
<code>--unencrypted-regex</code> option, which will leave the values unencrypted of those keys
that match the supplied regular expression. For example, this command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --encrypt --unencrypted-regex &#39;^(description|metadata)$&#39; k8s-secrets.yaml"><pre>$ sops --encrypt --unencrypted-regex <span><span>&#39;</span>^(description|metadata)$<span>&#39;</span></span> k8s-secrets.yaml</pre></div>
<p dir="auto">will not encrypt the values under the <code>description</code> and <code>metadata</code> keys in a YAML file
containing kubernetes secrets, while encrypting everything else.</p>
<p dir="auto">You can also specify these options in the <code>.sops.yaml</code> config file.</p>
<p dir="auto">Note: these four options <code>--unencrypted-suffix</code>, <code>--encrypted-suffix</code>, <code>--encrypted-regex</code> and <code>--unencrypted-regex</code> are
mutually exclusive and cannot all be used in the same file.</p>
<a name="user-content-encryption-protocol"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-5encryption-protocol" aria-hidden="true" href="#5encryption-protocol"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id44">5   Encryption Protocol</a></h2>
<p dir="auto">When sops creates a file, it generates a random 256 bit data key and asks each
KMS and PGP master key to encrypt the data key. The encrypted version of the data
key is stored in the <code>sops</code> metadata under <code>sops.kms</code> and <code>sops.pgp</code>.</p>
<p dir="auto">For KMS:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sops:
    kms:
    -   enc: CiC6yCOtzsnFhkfdIslYZ0bAf//gYLYCmIu87B3sy/5yYxKnAQEBAQB4usgjrc7JxYZH3SLJWGdGwH//4GC2ApiLvOwd7Mv+cmMAAAB+MHwGCSqGSIb3DQEHBqBvMG0CAQAwaAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAyGdRODuYMHbA8Ozj8CARCAO7opMolPJUmBXd39Zlp0L2H9fzMKidHm1vvaF6nNFq0ClRY7FlIZmTm4JfnOebPseffiXFn9tG8cq7oi
        enc_ts: 1439568549.245995
        arn: arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e"><pre><span>sops</span>:
    <span>kms</span>:
    -   <span>enc</span>: <span>CiC6yCOtzsnFhkfdIslYZ0bAf//gYLYCmIu87B3sy/5yYxKnAQEBAQB4usgjrc7JxYZH3SLJWGdGwH//4GC2ApiLvOwd7Mv+cmMAAAB+MHwGCSqGSIb3DQEHBqBvMG0CAQAwaAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAyGdRODuYMHbA8Ozj8CARCAO7opMolPJUmBXd39Zlp0L2H9fzMKidHm1vvaF6nNFq0ClRY7FlIZmTm4JfnOebPseffiXFn9tG8cq7oi</span>
        <span>enc_ts</span>: <span>1439568549.245995</span>
        <span>arn</span>: <span>arn:aws:kms:us-east-1:656532927350:key/920aff2e-c5f1-4040-943a-047fa387b27e</span></pre></div>
<p dir="auto">For PGP:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sops:
    pgp:
    -   fp: 85D77543B3D624B63CEA9E6DBC17301B491B3F21
        created_at: 1441570391.930042
        enc: |
            -----BEGIN PGP MESSAGE-----
            Version: GnuPG v1

            hQIMA0t4uZHfl9qgAQ//UvGAwGePyHuf2/zayWcloGaDs0MzI+zw6CmXvMRNPUsA
            pAgRKczJmDu4+XzN+cxX5Iq9xEWIbny9B5rOjwTXT3qcUYZ4Gkzbq4MWkjuPp/Iv
            qO4MJaYzoH5YxC4YORQ2LvzhA2YGsCzYnljmatGEUNg01yJ6r5mwFwDxl4Nc80Cn
            RwnHuGExK8j1jYJZu/juK1qRbuBOAuruIPPWVdFB845PA7waacG1IdUW3ZtBkOy3
            O0BIfG2ekRg0Nik6sTOhDUA+l2bewCcECI8FYCEjwHm9Sg5cxmP2V5m1mby+uKAm
            kewaoOyjbmV1Mh3iI1b/AQMr+/6ZE9MT2KnsoWosYamFyjxV5r1ZZM7cWKnOT+tu
            KOvGhTV1TeOfVpajNTNwtV/Oyh3mMLQ0F0HgCTqomQVqw5+sj7OWAASuD3CU/dyo
            pcmY5Qe0TNL1JsMNEH8LJDqSh+E0hsUxdY1ouVsg3ysf6mdM8ciWb3WRGxih1Vmf
            unfLy8Ly3V7ZIC8EHV8aLJqh32jIZV4i2zXIoO4ZBKrudKcECY1C2+zb/TziVAL8
            qyPe47q8gi1rIyEv5uirLZjgpP+JkDUgoMnzlX334FZ9pWtQMYW4Y67urAI4xUq6
            /q1zBAeHoeeeQK+YKDB7Ak/Y22YsiqQbNp2n4CKSKAE4erZLWVtDvSp+49SWmS/S
            XgGi+13MaXIp0ecPKyNTBjF+NOw/I3muyKr8EbDHrd2XgIT06QXqjYLsCb1TZ0zm
            xgXsOTY3b+ONQ2zjhcovanDp7/k77B+gFitLYKg4BLZsl7gJB12T8MQnpfSmRT4=
            =oJgS
            -----END PGP MESSAGE-----"><pre><span>sops</span>:
    <span>pgp</span>:
    -   <span>fp</span>: <span>85D77543B3D624B63CEA9E6DBC17301B491B3F21</span>
        <span>created_at</span>: <span>1441570391.930042</span>
        <span>enc</span>: <span>|</span>
<span>            -----BEGIN PGP MESSAGE-----</span>
<span>            Version: GnuPG v1</span>
<span></span>
<span>            hQIMA0t4uZHfl9qgAQ//UvGAwGePyHuf2/zayWcloGaDs0MzI+zw6CmXvMRNPUsA</span>
<span>            pAgRKczJmDu4+XzN+cxX5Iq9xEWIbny9B5rOjwTXT3qcUYZ4Gkzbq4MWkjuPp/Iv</span>
<span>            qO4MJaYzoH5YxC4YORQ2LvzhA2YGsCzYnljmatGEUNg01yJ6r5mwFwDxl4Nc80Cn</span>
<span>            RwnHuGExK8j1jYJZu/juK1qRbuBOAuruIPPWVdFB845PA7waacG1IdUW3ZtBkOy3</span>
<span>            O0BIfG2ekRg0Nik6sTOhDUA+l2bewCcECI8FYCEjwHm9Sg5cxmP2V5m1mby+uKAm</span>
<span>            kewaoOyjbmV1Mh3iI1b/AQMr+/6ZE9MT2KnsoWosYamFyjxV5r1ZZM7cWKnOT+tu</span>
<span>            KOvGhTV1TeOfVpajNTNwtV/Oyh3mMLQ0F0HgCTqomQVqw5+sj7OWAASuD3CU/dyo</span>
<span>            pcmY5Qe0TNL1JsMNEH8LJDqSh+E0hsUxdY1ouVsg3ysf6mdM8ciWb3WRGxih1Vmf</span>
<span>            unfLy8Ly3V7ZIC8EHV8aLJqh32jIZV4i2zXIoO4ZBKrudKcECY1C2+zb/TziVAL8</span>
<span>            qyPe47q8gi1rIyEv5uirLZjgpP+JkDUgoMnzlX334FZ9pWtQMYW4Y67urAI4xUq6</span>
<span>            /q1zBAeHoeeeQK+YKDB7Ak/Y22YsiqQbNp2n4CKSKAE4erZLWVtDvSp+49SWmS/S</span>
<span>            XgGi+13MaXIp0ecPKyNTBjF+NOw/I3muyKr8EbDHrd2XgIT06QXqjYLsCb1TZ0zm</span>
<span>            xgXsOTY3b+ONQ2zjhcovanDp7/k77B+gFitLYKg4BLZsl7gJB12T8MQnpfSmRT4=</span>
<span>            =oJgS</span>
<span>            -----END PGP MESSAGE-----</span></pre></div>
<p dir="auto"><code>sops</code> then opens a text editor on the newly created file. The user adds data to the
file and saves it when done.</p>
<p dir="auto">Upon save, sops browses the entire file as a key/value tree. Every time sops
encounters a leaf value (a value that does not have children), it encrypts the
value with AES256_GCM using the data key and a 256 bit random initialization
vector.</p>
<p dir="auto">Each file uses a single data key to encrypt all values of a document, but each
value receives a unique initialization vector and has unique authentication data.</p>
<p dir="auto">Additional data is used to guarantee the integrity of the encrypted data
and of the tree structure: when encrypting the tree, key names are concatenated
into a byte string that is used as AEAD additional data (aad) when encrypting
values. We expect that keys do not carry sensitive information, and
keeping them in cleartext allows for better diff and overall readability.</p>
<p dir="auto">Any valid KMS or PGP master key can later decrypt the data key and access the
data.</p>
<p dir="auto">Multiple master keys allow for sharing encrypted files without sharing master
keys, and provide a disaster recovery solution. The recommended way to use sops
is to have two KMS master keys in different regions and one PGP public key with
the private key stored offline. If, by any chance, both KMS master keys are
lost, you can always recover the encrypted data using the PGP private key.</p>
<a name="user-content-message-authentication-code"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-51message-authentication-code" aria-hidden="true" href="#51message-authentication-code"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id45">5.1   Message Authentication Code</a></h3>
<p dir="auto">In addition to authenticating branches of the tree using keys as additional
data, sops computes a MAC on all the values to ensure that no value has been
added or removed fraudulently. The MAC is stored encrypted with AES_GCM and
the data key under tree-&gt;`sops`-&gt;`mac`.</p>
<a name="user-content-motivation"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-6motivation" aria-hidden="true" href="#6motivation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id46">6   Motivation</a></h2>
<p dir="auto">Automating the distribution of secrets and credentials to components of an
infrastructure is a hard problem. We know how to encrypt secrets and share them
between humans, but extending that trust to systems is difficult. Particularly
when these systems follow devops principles and are created and destroyed
without human intervention. The issue boils down to establishing the initial
trust of a system that just joined the infrastructure, and providing it access
to the secrets it needs to configure itself.</p>
<a name="user-content-the-initial-trust"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-61the-initial-trust" aria-hidden="true" href="#61the-initial-trust"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id47">6.1   The initial trust</a></h3>
<p dir="auto">In many infrastructures, even highly dynamic ones, the initial trust is
established by a human. An example is seen in Puppet by the way certificates are
issued: when a new system attempts to join a Puppetmaster, an administrator
must, by default, manually approve the issuance of the certificate the system
needs. This is cumbersome, and many puppetmasters are configured to auto-sign
new certificates to work around that issue. This is obviously not recommended
and far from ideal.</p>
<p dir="auto">AWS provides a more flexible approach to trusting new systems. It uses a
powerful mechanism of roles and identities. In AWS, it is possible to verify
that a new system has been granted a specific role at creation, and it is
possible to map that role to specific resources. Instead of trusting new systems
directly, the administrator trusts the AWS permission model and its automation
infrastructure. As long as AWS keys are safe, and the AWS API is secure, we can
assume that trust is maintained and systems are who they say they are.</p>
<a name="user-content-kms-trust-and-secrets-distribution"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-62kms-trust-and-secrets-distribution" aria-hidden="true" href="#62kms-trust-and-secrets-distribution"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id48">6.2   KMS, Trust and secrets distribution</a></h3>
<p dir="auto">Using the AWS trust model, we can create fine grained access controls to
Amazon&#39;s Key Management Service (KMS). KMS is a service that encrypts and
decrypts data with AES_GCM, using keys that are never visible to users of the
service. Each KMS master key has a set of role-based access controls, and
individual roles are permitted to encrypt or decrypt using the master key. KMS
helps solve the problem of distributing keys, by shifting it into an access
control problem that can be solved using AWS&#39;s trust model.</p>
<a name="user-content-operational-requirements"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-63operational-requirements" aria-hidden="true" href="#63operational-requirements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id49">6.3   Operational requirements</a></h3>
<p dir="auto">When Mozilla&#39;s Services Operations team started revisiting the issue of
distributing secrets to EC2 instances, we set a goal to store these secrets
encrypted until the very last moment, when they need to be decrypted on target
systems. Not unlike many other organizations that operate sufficiently complex
automation, we found this to be a hard problem with a number of prerequisites:</p>
<ol dir="auto">
<li>Secrets must be stored in YAML files for easy integration into hiera</li>
<li>Secrets must be stored in GIT, and when a new CloudFormation stack is
built, the current HEAD is pinned to the stack. (This allows secrets to
be changed in GIT without impacting the current stack that may
autoscale).</li>
<li>Entries must be encrypted separately. Encrypting entire files as blobs makes
git conflict resolution almost impossible. Encrypting each entry
separately is much easier to manage.</li>
<li>Secrets must always be encrypted on disk (admin laptop, upstream
git repo, jenkins and S3) and only be decrypted on the target
systems</li>
</ol>
<p dir="auto">SOPS can be used to encrypt YAML, JSON and BINARY files. In BINARY mode, the
content of the file is treated as a blob, the same way PGP would encrypt an
entire file. In YAML and JSON modes, however, the content of the file is
manipulated as a tree where keys are stored in cleartext, and values are
encrypted. hiera-eyaml does something similar, and over the years we learned
to appreciate its benefits, namely:</p>
<ul dir="auto">
<li>diffs are meaningful. If a single value of a file is modified, only that
value will show up in the diff. The diff is still limited to only showing
encrypted data, but that information is already more granular that
indicating that an entire file has changed.</li>
<li>conflicts are easier to resolve. If multiple users are working on the
same encrypted files, as long as they don&#39;t modify the same values,
changes are easy to merge. This is an improvement over the PGP
encryption approach where unsolvable conflicts often happen when
multiple users work on the same file.</li>
</ul>
<a name="user-content-openpgp-integration"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-64openpgp-integration" aria-hidden="true" href="#64openpgp-integration"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id50">6.4   OpenPGP integration</a></h3>
<p dir="auto">OpenPGP gets a lot of bad press for being an outdated crypto protocol, and while
true, what really made us look for alternatives is the difficulty of managing and
distributing keys to systems. With KMS, we manage permissions to an API, not keys,
and that&#39;s a lot easier to do.</p>
<p dir="auto">But PGP is not dead yet, and we still rely on it heavily as a backup solution:
all our files are encrypted with KMS and with one PGP public key, with its
private key stored securely for emergency decryption in the event that we lose
all our KMS master keys.</p>
<p dir="auto">SOPS can be used without KMS entirely, the same way you would use an encrypted
PGP file: by referencing the pubkeys of each individual who has access to the file.
It can easily be done by providing sops with a comma-separated list of public keys
when creating a new file:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sops --pgp &#34;E60892BB9BD89A69F759A1A0A3D652173B763E8F,84050F1D61AF7C230A12217687DF65059EF093D3,85D77543B3D624B63CEA9E6DBC17301B491B3F21&#34; mynewfile.yaml"><pre>$ sops --pgp <span><span>&#34;</span>E60892BB9BD89A69F759A1A0A3D652173B763E8F,84050F1D61AF7C230A12217687DF65059EF093D3,85D77543B3D624B63CEA9E6DBC17301B491B3F21<span>&#34;</span></span> mynewfile.yaml</pre></div>
<a name="user-content-threat-model"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-7threat-model" aria-hidden="true" href="#7threat-model"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id51">7   Threat Model</a></h2>
<p dir="auto">The security of the data stored using sops is as strong as the weakest
cryptographic mechanism. Values are encrypted using AES256_GCM which is the
strongest symmetric encryption algorithm known today. Data keys are encrypted
in either KMS, which also uses AES256_GCM, or PGP which uses either RSA or
ECDSA keys.</p>
<p dir="auto">Going from the most likely to the least likely, the threats are as follows:</p>
<a name="user-content-compromised-aws-credentials-grant-access-to-kms-master-key"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-71compromised-aws-credentials-grant-access-to-kms-master-key" aria-hidden="true" href="#71compromised-aws-credentials-grant-access-to-kms-master-key"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id52">7.1   Compromised AWS credentials grant access to KMS master key</a></h3>
<p dir="auto">An attacker with access to an AWS console can grant itself access to one of
the KMS master keys used to encrypt a sops data key. This threat should be
mitigated by protecting AWS accesses with strong controls, such as multi-factor
authentication, and also by performing regular audits of permissions granted
to AWS users.</p>
<a name="user-content-compromised-pgp-key"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-72compromised-pgp-key" aria-hidden="true" href="#72compromised-pgp-key"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id53">7.2   Compromised PGP key</a></h3>
<p dir="auto">PGP keys are routinely mishandled, either because owners copy them from
machine to machine, or because the key is left forgotten on an unused machine
an attacker gains access to. When using PGP encryption, sops users should take
special care of PGP private keys, and store them on smart cards or offline
as often as possible.</p>
<a name="user-content-factorized-rsa-key"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-73factorized-rsa-key" aria-hidden="true" href="#73factorized-rsa-key"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id54">7.3   Factorized RSA key</a></h3>
<p dir="auto">sops doesn&#39;t apply any restriction on the size or type of PGP keys. A weak PGP
keys, for example 512 bits RSA, could be factorized by an attacker to gain
access to the private key and decrypt the data key. Users of sops should rely
on strong keys, such as 2048+ bits RSA keys, or 256+ bits ECDSA keys.</p>
<a name="user-content-weak-aes-cryptography"></a>
<h3 tabindex="-1" dir="auto"><a id="user-content-74weak-aes-cryptography" aria-hidden="true" href="#74weak-aes-cryptography"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id55">7.4   Weak AES cryptography</a></h3>
<p dir="auto">A vulnerability in AES256_GCM could potentially leak the data key or the KMS
master key used by a sops encrypted file. While no such vulnerability exists
today, we recommend that users keep their encrypted files reasonably private.</p>
<a name="user-content-backward-compatibility"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-8backward-compatibility" aria-hidden="true" href="#8backward-compatibility"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id56">8   Backward compatibility</a></h2>
<p dir="auto"><code>sops</code> will remain backward compatible on the major version, meaning that all
improvements brought to the 1.X and 2.X branches (current) will maintain the
file format introduced in <strong>1.0</strong>.</p>
<a name="user-content-security"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-9security" aria-hidden="true" href="#9security"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id57">9   Security</a></h2>
<p dir="auto">Please report security issues to security at mozilla dot org, or by using one
of the contact method available here: <a href="https://www.mozilla.org/en-US/security/#For_Developers" rel="nofollow">https://www.mozilla.org/en-US/security/#For_Developers</a></p>
<a name="user-content-license"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-10license" aria-hidden="true" href="#10license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id58">10   License</a></h2>
<p dir="auto">Mozilla Public License Version 2.0</p>
<a name="user-content-authors"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-11authors" aria-hidden="true" href="#11authors"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id59">11   Authors</a></h2>
<p dir="auto">The core team is composed of:</p>
<ul dir="auto">
<li>AJ Banhken @ajvb</li>
</ul>
<p dir="auto">The original authors were:</p>
<ul dir="auto">
<li>Adrian Utrilla @autrilla</li>
<li>Julien Vehent @jvehent</li>
</ul>
<p dir="auto">And a whole bunch of <a href="https://github.com/mozilla/sops/graphs/contributors">contributors</a></p>
<a name="user-content-credits"></a>
<h2 tabindex="-1" dir="auto"><a id="user-content-12credits" aria-hidden="true" href="#12credits"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a><a href="#id60">12   Credits</a></h2>
<p dir="auto">sops was inspired by <a href="https://github.com/TomPoulton/hiera-eyaml">hiera-eyaml</a>,
<a href="https://github.com/LuminalOSS/credstash">credstash</a> ,
<a href="https://github.com/codahale/sneaker">sneaker</a>,
<a href="http://www.passwordstore.org/" rel="nofollow">password store</a> and too many years managing
PGP encrypted files by hand...</p>

</article>
          </div></div>
  </body>
</html>
