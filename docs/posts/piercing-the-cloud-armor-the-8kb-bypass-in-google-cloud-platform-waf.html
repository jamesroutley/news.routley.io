<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kloudle.com/blog/piercing-the-cloud-armor-the-8kb-bypass-in-google-cloud-platform-waf">Original</a>
    <h1>Piercing the Cloud Armor – The 8KB Bypass in Google Cloud Platform WAF</h1>
    
    <div id="readability-page-1" class="page"><div><a href="https://kloudle.com/category/insights"><p>Insights</p></a><p>Google Cloud Armor provides a rule-based policy framework that can be used by customers of the Google Cloud Platform to mitigate various types of common web application attacks. The Cloud Armor service has a documented limitation of 8 KB as the maximum size of web request that it will inspect. The default behavior of Cloud Armor in this case can allow malicious requests to bypass Cloud Armor and directly reach an underlying application.</p></div><div><h2>Introduction</h2><p>Web application firewall suites provide a critical layer of security for modern web applications and can protect them from a wide variety of attacks, such as: code execution, SQL injection, cross-site scripting, et cetera even when the underlying application is vulnerable. GCP customers can use Cloud Armor to protect applications served with Google Cloud Load Balancing.</p><p>Cloud Armor supports the definition of custom expressions for rules, while also providing a set of pre-configured web application firewall rules that draw from the OWASP ModSecurity Core Rule Set.</p><figure><p><img src="https://assets.website-files.com/610cc7a5a58576a806711235/6217cbabc993e5068e9b35cc_YfE2I5al9j6ym7PgZocnKTDO3uhATL_pQs58IeGHKxsqVb9vDq32TeujBXf_U7SYtHqoxJ033i9f6JZfwCsrXex2igAUrd-HGF83q4cQL7BNLXRKQXHaB-mha_eO7iOVqQXsn_kw.png" alt="Cloud Armor rules in GCP"/></p></figure><h2>The 8 KB limitation</h2><p>The web application firewall component of Cloud Armor inspects incoming HTTP requests and compares them against rule-based policies defined by the user. The Cloud Armor service can be configured to allow or deny a request to the underlying application based on the rules triggered by a given request.</p><figure><p><img src="https://assets.website-files.com/610cc7a5a58576a806711235/6217cbc0b99a252578838fdf_OXQQlpNy6yUBBxTLgrtUd7CTLMOqa5FiegDz0Q35y47KYh7HZULFF2NkzcoGNyeD2DtONdsEyIivIvGm3qebiSOKwdtZkED_DiL5Lj6wILpoBg1TW2i1ml5efWe881dPWwS-xakd.png" alt="Cloud Armor rule blocking an attack"/></p></figure><p>The web application firewall component of Cloud Armor has a non-configurable HTTP request body size limit of 8 KB. This means that Cloud Armor will only inspect the first 8192 bytes or characters of an HTTP POST request body.</p><p>This is similar to the well-documented <a href="https://kloudle.com/blog/the-infamous-8kb-aws-waf-request-body-inspection-limitation" target="_blank">8 KB limitation</a> of the AWS web application firewall, however, in the case of Cloud Armor, the limitation is not as widely known and is not presented to customers as prominently as the limitation in AWS.</p><p>As of the time of writing this article, customers are not shown a prompt or notice when configuring Cloud Armor rules from within the web UI, and can only find a reference to the 8 KB limit in a nondescript notice <a href="https://cloud.google.com/armor/docs/security-policy-overview" target="_blank">included in a documentation article.</a></p><p><a href="https://cloud.google.com/armor/docs/security-policy-overview" target="_blank">‍</a><br/></p><p>This issue can be exploited by crafting an HTTP POST request with a body size exceeding the 8 KB size limitation of Cloud Armor, where the payload appears after the 8192th byte/character in the request body.</p><figure><p><img src="https://assets.website-files.com/610cc7a5a58576a806711235/6217cbc0c72065090696815b_kfKZ_dyEryexJWgFw2dCUVfQgi-hnY-N-p2a6Y-jyMT56hLuBAFO9bYl-YAl-nYMFd04GrhZJ_gbW--YC-hanFvE0PFOiQhD3X9Uro22RvpKxbMkbI0aZAHayKyCOHfKfLZ7OQF0.png" alt="A malicious request in Burp showing the 8KB bypass"/></p></figure><figure><p><img src="https://assets.website-files.com/610cc7a5a58576a806711235/6217cbc0c7356c7adc342796_HAjRzuKMvTWc2j2xL9_BG7Oz9tWWE-rCctI4CIJY_r4iWr0-CxwsqbAHb2c-zJPGBdZBN01XT0jvg_cGq4UxIJPc-wpPdxkSuklaxTIEA0Vby7qYqt47BPwvEunCn54J3UZNXboH.png" alt="Bypass showing exploit was successful"/></p></figure><p>An attacker&#39;s ability to utilise the WAF bypass successfully is conditionally limited, however. The endpoint being targeted should accept and process HTTP POST requests in a manner which could trigger an underlying vulnerability. The bypass will not yield meaningful results for an attacker if a given underlying endpoint does not accept HTTP POST requests.</p><h2>Impact of the WAF bypass</h2><p>An attacker with knowledge of this limitation would be better placed to exploit any vulnerabilities that may be present in an underlying application. For illustration, consider a web application that has not been patched and is still vulnerable to the infamous Log4j RCE vulnerability (CVE-2021-45046).</p><p>A Cloud Armor setup that is configured to use the pre-configured “cve-canary” rule <a href="https://cloud.google.com/blog/products/identity-security/cloud-armor-waf-rule-to-help-address-apache-log4j-vulnerability">will appropriately block</a> most attempts at exploiting the Log4j RCE, however, an attacker with knowledge of Cloud Armor’s 8 KB HTTP POST request body size limitation would still be in a position to bypass the Cloud Armor WAF, exploit the underlying application, and achieve remote code execution.</p><h2>How can this be fixed?</h2><p>Cloud Armor is a valuable security tool, but it is important that customers are aware of the 8 KB size limitation so that they can take steps to further secure their applications.</p><p>Customers can configure a custom Cloud Armor rule to block HTTP requests where the request body is larger than 8192 bytes.</p><blockquote>int(request.headers[&#34;content-length&#34;]) &gt;= 8192</blockquote><p>The above rule will trigger on incoming requests where the value of the Content-Length header is equal to or greater than 8192.</p><p>As noted in our previous article on the 8 KB size limit of the Amazon Web Services WAF, there may be certain resources for which legitimate requests are expected to be 8 KB or larger in size. In these cases, rules can be <a href="https://cloud.google.com/armor/docs/rules-language-reference">fine-tuned</a> using Cloud Armor’s custom rule language so that the WAF expects and appropriately handles legitimate requests.</p><h2>Conclusion</h2><p>While an attacker who is targeting a service behind a web application firewall may only attempt to find bypasses specific to the payload or the type of attack being carried out, the 8 KB limitation affecting Cloud Armor (as well as several other cloud WAF services) can act like a “catch-all” WAF bypass.</p><p>Cloud Armor is a useful service for protecting resources and data on the Google Cloud Platform, however, customers must be aware of the limitations of its request filtering capabilities, and should take steps to mitigate potential risk that may arise from the 8 KB WAF limitation.</p><p>We will be publishing an article later today on Kloudle Academy to provide a detailed explanation of how Cloud Armor can be configured to protect underlying applications from the service’s 8 KB limitation. </p></div><div><p><img src="https://assets.website-files.com/610cc7a5a58576a806711235/622ad470096a63a63a731780_karan-profile.png" loading="lazy" alt="Piercing the Cloud Armor - The 8KB bypass in Google Cloud Platform WAF" sizes="63.99739456176758px" srcset="https://assets.website-files.com/610cc7a5a58576a806711235/622ad470096a63a63a731780_karan-profile-p-500.png 500w, https://assets.website-files.com/610cc7a5a58576a806711235/622ad470096a63a63a731780_karan-profile.png 520w"/></p><div><p>ABOUT THE AUTHOR</p><h2>Karan Saini</h2><p>Karan is a technologist and security researcher with an interest in network and application security, open source intelligence, and consumer privacy. </p></div></div><p>Subscribe to our newsletter and stay ahead with more great insights and resources on cloud security!</p></div>
  </body>
</html>
