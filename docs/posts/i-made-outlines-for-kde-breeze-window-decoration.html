<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.akselmo.dev/2022/10/31/I-made-outlines-for-KDE-Breeze.html">Original</a>
    <h1>I made outlines for KDE Breeze window decoration</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>Window outlines! Yet another KDE contribution by yours truly! This was fun.
Not easy at all, but fun. I’m pretty happy how they turned out.</p>

<p>Breeze Dark</p>

<p><a href="https://www.akselmo.dev/2022/10/31/assets/images/kde/outline_dark.jpg"><img src="https://www.akselmo.dev/assets/images/kde/outline_dark.jpg" alt="Outline Dark"/></a></p>

<p>Breeze Light</p>

<p><a href="https://www.akselmo.dev/2022/10/31/assets/images/kde/outline_light.jpg"><img src="https://www.akselmo.dev/assets/images/kde/outline_light.jpg" alt="Outline Light"/></a></p>

<p><em>I hope Nate you don’t mind me taking the screenshots from your <a href="https://pointieststick.com/2022/10/28/this-week-in-kde-next-generation-improvements/">blog post</a>, I’m just.. Lazy. I have no excuse. Lol.</em></p>

<p>For those who just want to see how it’s made, here’s link to the merge request: <a href="https://invent.kde.org/plasma/breeze/-/merge_requests/241">https://invent.kde.org/plasma/breeze/-/merge_requests/241</a></p>

<p>Also I am probably gonna make couple LOTR references due to talking about binding and light and dark and I’m sorry about that beforehand.</p>

<h2 id="but-why-make-them">But why make them?</h2>

<p>I have big problem making distinctions between windows if they have dark theme and on top of each other. Window shadows are often
dark as well, so the windows just kind of blend into each other and the shadows do not help much. Disable shadows altogether and you got
windows that just disappear into each other. This can even happen with light themes, sometimes the shadows just are not enough.</p>

<p>They also look a bit better with the outlines, in my opinion. They give some kind of “constraint” for the window and they
ease my weird brain.</p>

<p>To sum up, it just makes the windows feel like they’re their own entities which calms my brain, they look nice and
they stop windows from blending into each other.</p>

<h2 id="where-are-they-drawn">Where are they drawn?</h2>

<p>First I had to figure out where the hecc I draw these outlines?</p>

<p>Well, I wanted to make them their own thing, separated completely from other elements. But this would’ve meant
I would need to actually make more in-depth modifications to KDecoration (I think?) and make the outlines their own
draw calls and whatnot.</p>

<p>So instead, I made them play nice with shadows. Basically, the outlines are just part of the shadow drawcall.</p>

<p><em>But what happens if shadows are disabled?</em></p>

<p>Something cheeky happens! I actually draw the shadows with 0% alpha channel!</p>

<div><div><pre><code>    <span>CompositeShadowParams</span> <span>params</span> <span>=</span> <span>lookupShadowParams</span><span>(</span><span>m_internalSettings</span><span>-&gt;</span><span>shadowSize</span><span>());</span>
    <span>if</span> <span>(</span><span>params</span><span>.</span><span>isNone</span><span>())</span> <span>{</span>
        <span>// If shadows are disabled, set shadow opacity to 0.</span>
        <span>// This allows the outline effect to show up without the shadow effect.</span>
        <span>params</span> <span>=</span> <span>CompositeShadowParams</span><span>(</span><span>QPoint</span><span>(</span><span>0</span><span>,</span> <span>4</span><span>),</span> <span>ShadowParams</span><span>(</span><span>QPoint</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>),</span> <span>16</span><span>,</span> <span>0</span><span>),</span> <span>ShadowParams</span><span>(</span><span>QPoint</span><span>(</span><span>0</span><span>,</span> <span>-</span><span>2</span><span>),</span> <span>8</span><span>,</span> <span>0</span><span>));</span>
    <span>}</span>
</code></pre></div></div>
<p>So the shadows are always there, they’re just invisible. But the outlines will show up.</p>

<p><em>Hold on, you could’ve just skipped drawing shadows entirely!</em></p>

<p>Yes, but actually no.</p>

<p>Before shadows are even drawn, they make some very very useful calculations for me. And on top of that, remember that
outlines are part of the shadow drawcall. Outlines are just one more colored part of the shadow, basically.</p>

<p>No shadows, no outlines. In darkness together, I’ve bound them.</p>

<h2 id="bordering-madness">Bordering madness</h2>

<p>I get it all look nice and fancy with borders, they look all nice and rounded on bottom border… And then I disable borders.</p>

<p>And everything looks off.</p>

<p>The bottom border disappears completely and leaves a sharp window edge. The outline then rounds behind the window.
It looks bad!!!</p>

<p><a href="https://www.akselmo.dev/2022/10/31/assets/images/kde/outline_bad.png"><img src="https://www.akselmo.dev/assets/images/kde/outline_bad.png" alt="Outline Bad"/></a></p>

<p>So, if borders are disabled, we do a magic trick and draw the outline path on our own.</p>

<div><div><pre><code>
    <span>// Draw window outline</span>
    <span>const</span> <span>qreal</span> <span>outlineWidth</span> <span>=</span> <span>1.001</span><span>;</span>
    <span>const</span> <span>qreal</span> <span>penOffset</span> <span>=</span> <span>outlineWidth</span> <span>/</span> <span>2</span><span>;</span>

    <span>// Titlebar already has an outline, so move the top of the outline on the same level to avoid 2px width on top outline.</span>
    <span>QRectF</span> <span>outlineRect</span> <span>=</span> <span>innerRect</span> <span>+</span> <span>QMarginsF</span><span>(</span><span>penOffset</span><span>,</span> <span>-</span><span>penOffset</span><span>,</span> <span>penOffset</span><span>,</span> <span>penOffset</span><span>);</span>
    <span>qreal</span> <span>cornerSize</span> <span>=</span> <span>m_scaledCornerRadius</span> <span>*</span> <span>2</span><span>;</span>
    <span>QRectF</span> <span>cornerRect</span><span>(</span><span>outlineRect</span><span>.</span><span>x</span><span>(),</span> <span>outlineRect</span><span>.</span><span>y</span><span>(),</span> <span>cornerSize</span><span>,</span> <span>cornerSize</span><span>);</span>
    <span>QPainterPath</span> <span>outlinePath</span><span>;</span>

    <span>outlinePath</span><span>.</span><span>arcMoveTo</span><span>(</span><span>cornerRect</span><span>,</span> <span>180</span><span>);</span>
    <span>outlinePath</span><span>.</span><span>arcTo</span><span>(</span><span>cornerRect</span><span>,</span> <span>180</span><span>,</span> <span>-</span><span>90</span><span>);</span>
    <span>cornerRect</span><span>.</span><span>moveTopRight</span><span>(</span><span>outlineRect</span><span>.</span><span>topRight</span><span>());</span>
    <span>outlinePath</span><span>.</span><span>arcTo</span><span>(</span><span>cornerRect</span><span>,</span> <span>90</span><span>,</span> <span>-</span><span>90</span><span>);</span>

    <span>// Check if border size is &#34;no borders&#34;</span>
    <span>if</span> <span>(</span><span>borderSize</span><span>(</span><span>true</span><span>)</span> <span>==</span> <span>0</span><span>)</span> <span>{</span>
        <span>outlinePath</span><span>.</span><span>lineTo</span><span>(</span><span>outlineRect</span><span>.</span><span>bottomRight</span><span>());</span>
        <span>outlinePath</span><span>.</span><span>lineTo</span><span>(</span><span>outlineRect</span><span>.</span><span>bottomLeft</span><span>());</span>
    <span>}</span> <span>else</span> <span>{</span>
        <span>cornerRect</span><span>.</span><span>moveBottomRight</span><span>(</span><span>outlineRect</span><span>.</span><span>bottomRight</span><span>());</span>
        <span>outlinePath</span><span>.</span><span>arcTo</span><span>(</span><span>cornerRect</span><span>,</span> <span>0</span><span>,</span> <span>-</span><span>90</span><span>);</span>
        <span>cornerRect</span><span>.</span><span>moveBottomLeft</span><span>(</span><span>outlineRect</span><span>.</span><span>bottomLeft</span><span>());</span>
        <span>outlinePath</span><span>.</span><span>arcTo</span><span>(</span><span>cornerRect</span><span>,</span> <span>270</span><span>,</span> <span>-</span><span>90</span><span>);</span>
    <span>}</span>
    <span>outlinePath</span><span>.</span><span>closeSubpath</span><span>();</span>
</code></pre></div></div>

<p>This part was actually fixed by Noah Davis: <a href="https://invent.kde.org/plasma/breeze/-/merge_requests/241#note_541478">https://invent.kde.org/plasma/breeze/-/merge_requests/241#note_541478</a></p>

<p>So, uh, I’m not 100% sure what’s going on here but it seems that:</p>

<ul>
  <li>Draw a rectangle with top left and top right with an arc, since they’re always rounded</li>
  <li>Check if we have border on or off</li>
  <li>Draw bottom corners with an arc if borders are on, or draw sharp lines if they’re off</li>
</ul>

<p>I think I got it right..? But I can say, my solution was more messy and I’m glad it’s not there. It involved basically blending two rectangles
together. This is <em>much</em> better!</p>

<h2 id="outline-colors">Outline colors!</h2>

<p>The biggest puzzle of this was actually how to get the color for the outlines. We could have just gone with basic
black and white coloring here, but it would be too much contrast in some situations and look jarring to some.</p>

<p>So I started with a simple idea: Take the background color of the window, then light or dim it based on its lightness value (HSL).
If lightness is equal or over 50%, then dim the color. Otherwise lighten it.</p>

<p>At first I used HSV, which caused a bit weird situations.
In HSL, lightness is basically how much the color is lightened or darkened, but in HSV, the value dictates how the color acts under light.
For this situation HSL was better since we’re not playing with lighting values, but just want to know if the color is “dark” or “light” to our eyes.</p>

<p>Anyhow, here’s some copy-pasta from the source files:</p>

<div><div><pre><code>    <span>auto</span> <span>s</span> <span>=</span> <span>settings</span><span>();</span>
    <span>auto</span> <span>c</span> <span>=</span> <span>client</span><span>().</span><span>toStrongRef</span><span>();</span>
    <span>auto</span> <span>outlineColor</span> <span>=</span> <span>c</span><span>-&gt;</span><span>color</span><span>(</span><span>c</span><span>-&gt;</span><span>isActive</span><span>()</span> <span>?</span> <span>ColorGroup</span><span>::</span><span>Active</span> <span>:</span> <span>ColorGroup</span><span>::</span><span>Inactive</span><span>,</span> <span>ColorRole</span><span>::</span><span>TitleBar</span><span>);</span>

    <span>// Bind lightness between 0.1 and 1.0 so it can never be completely black.</span>
    <span>// Outlines only have transparency if alpha channel is supported</span>
    <span>outlineColor</span><span>.</span><span>setHslF</span><span>(</span><span>outlineColor</span><span>.</span><span>hslHueF</span><span>(),</span>
                         <span>outlineColor</span><span>.</span><span>hslSaturationF</span><span>(),</span>
                         <span>qBound</span><span>(</span><span>0.1</span><span>,</span> <span>outlineColor</span><span>.</span><span>lightnessF</span><span>(),</span> <span>1.0</span><span>),</span>
                         <span>s</span><span>-&gt;</span><span>isAlphaChannelSupported</span><span>()</span> <span>?</span> <span>0.9</span> <span>:</span> <span>1.0</span><span>);</span>
</code></pre></div></div>

<p><em>Hold on, you said background color of the window, but you’re using titlebar color?</em></p>

<p>When using the background color <code>ColorRole::Frame</code> the problem is that when having colored titlebar, the outline color feels
<em>very</em> out of place. It just doesn’t look good.</p>

<p>But using <code>ColorRole::TitleBar</code> we get a fun colored outline effect when having a separately colored titlebar!</p>

<p><a href="https://www.akselmo.dev/2022/10/31/assets/images/kde/outline_colored.png"><img src="https://www.akselmo.dev/assets/images/kde/outline_colored.png" alt="Outline Colored"/></a></p>

<p>Also there’s the whole <code>qBound(0.1, outlineColor.lightnessF(), 1.0)</code> thing. Like the comment says, if the lightness value is black or very dark,
the outline will also be black or very dark. Binding the lightness avoids situations where the outline
blends into the dark background color.</p>

<p>And of course, finally we check if transparency is enabled and set it accordingly to avoid awkward situations.</p>

<p>But colors are tricky. Some like this solution, some don’t. I am <em>probably</em> going to make a drop-down setting where people can select
does the outline use background or titlebar color, or are they just off.</p>

<h2 id="continuous-iteration">Continuous Iteration</h2>

<p>My part was done and the outlines got merged! It was long long long ride and I learned a lot. But I’m super happy I managed to
do this part, now it just needs to be iterated on so we can get something that looks <strong>The Best.</strong></p>

<p>Nate Graham already made the colors <strong>pop</strong> a bit more by fixing the lighten/darken values: <a href="https://invent.kde.org/plasma/breeze/-/merge_requests/263">https://invent.kde.org/plasma/breeze/-/merge_requests/263</a></p>

<p>Also there was initially a feature that if the window color was super light, we just didn’t show outlines at all due to the outlines being so dim
it created a weird blur effect as the outlines were gray, the shadow black and the window white. But with this tweak that doesn’t need to be done anymore.</p>

<p>There’s still probably work to be done on this, but the biggest hurdle seems to be over! <em>Knocks on wood</em></p>

<p>As I said, I may make the settings section for this, but we’ll see. I need a short break from KDE contributions, I got my own projects to work on too lol.</p>

<p>There’s also been talk that we could use the separator (the <code>|</code> thing that separates buttons in menus etc etc) color as the outline color, and make that separator color
modifiable. I think that would make A Lot Of Sense… But I would still keep the outline color as the titlebar color if the titlebar is colored. :)</p>

<h2 id="thanks">Thanks!</h2>

<p>Thanks for reading this ramble. I really enjoyed making this contribution and once again I learned <strong>A LOT</strong>. Open source contributions are great
way to learn new stuff and I’m happy I get to make stuff like this for KDE. Also I’ve learned I kinda enjoy writing C++!</p>

<p>And thanks for all the comments and feedback and code reviews and <em>everything</em> anyone did to help me get this outline thing through.
Based on the feedback I’ve read on Da Internets, this is something many people didn’t realise they needed!</p>

  </div></div>
  </body>
</html>
