<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mux.com/blog/if-you-can-read-this-your-browser-captions-are-broken">Original</a>
    <h1>If you can read this, your browser captions are broken</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>I’ve seen <em>a lot</em> of captions over the years, and there’s one thing I can tell you with certainty: The way that custom controls and the HTML video element interact right now is inadequate, and I think there’s some work we can do to fix it.</p><p>The fact that I’m now an editor of the <a href="https://github.com/w3c/webvtt">WebVTT specification</a> and a Chair of the <a href="https://www.w3.org/AudioVideo/TT/">Timed Text Working Group</a> is no accident: I’ve been a heavy captions user since I was a little kid.</p><div><figure><figcaption>Clip from Sailor Moon, Toei Animation</figcaption></figure></div><p>Growing up in Israel, I watched most of my favorite shows on an old CRT in the living room. A lot of programming had open captions, or captions that are always shown on screen, due to accessibility requirements. In addition, a lot of imported non–Hebrew language content was subtitled rather than dubbed, unless it was children’s content, because it’s <span>generally a lot more cost-effective to subtitle films and shows than to dub them.<sup><a id="fnref:1" href="#fn:1">1</a></sup></span></p><h3 id="packing-up-and-heading-to-the-usa">Packing up and heading to the USA<a href="#packing-up-and-heading-to-the-usa"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Packing up and heading to the USA</span></a></h3><figure><figcaption>Clip from Kiki’s Delivery Service, Studio Ghibli</figcaption></figure><p>When I moved to the US in 2000, I continued watching subtitled and captioned content to help me learn English and also to be able to see more non-Hebrew, non-English movies and TV shows — films like “Amelie” and anime like “Cowboy Bebop.”</p><p>If you’re a big anime fan like me, unless you know or took the time to learn Japanese (generally considered to be in the hardest class of languages to learn, although this didn’t prevent me from trying), you wouldn’t have been able to see a lot of the shows if not for subtitles. There have also been great strides in bringing more dubbing into anime in recent years, because having both means greater access. Do you have a favorite movie or show that you wouldn’t have been able to watch if not for subtitles? <a href="https://twitter.com/gkatsev">Let me know!</a></p><p>Nowadays, I have captions turned on basically all the time for online streaming services, <a href="https://www.slashfilm.com/703827/why-movie-dialogue-has-become-so-hard-to-hear-a-video-essay/">because it’s hard to hear dialog</a> (although my new soundbar with a center channel definitely helps with that). It also helps <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5214590/">increase comprehension, focus, and retention</a>, regardless of dialog audio levels.</p><p>(We at Mux think that captions are super important, so we worked to bring you auto-generated captions for your live streams with free minutes! Check out the <a href="https://www.mux.com/blog/live-captions-are-great-auto-generated-live-captions-are-better">blog post</a>.)</p><h3 id="keeping-up-with-the-law">Keeping up with the law<a href="#keeping-up-with-the-law"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Keeping up with the law</span></a></h3><p>As I was graduating from college, the FCC passed a new law that required captions on content that was originally shown on TV and later made available online. I ended up joining a company at just the right time to work on implementing improved captions support. I found this work compelling, so I’ve continued with it, notably adding the <a href="https://github.com/videojs/video.js/issues/1655">improved</a> <a href="https://github.com/videojs/video.js/pull/1749">captions support in Video.js</a>. After my <a href="https://www.youtube.com/watch?v=5AO2ih9-xbI">first Demuxed talk on captions</a>, I expressed interest in helping out with WebVTT. Then, in 2018, as the previous editor of WebVTT was moving on to greater things, I joined the Timed Text Working Group to help move WebVTT forward (it’s been a long journey, and there’s still a lot of work there).</p><div><figure><figcaption>Clip from Cowboy Bebop, Sunrise</figcaption></figure></div><p>When I was improving captioning support in Video.js, in 2014, text track (I’ll call this “native captions” below) was still a pretty new feature, which meant lots of browser bugs and  cross-browser compatibility issues.</p><p>When building Mux Player, one of our goals was to avoid deviating from the browser’s native video implementation as much as possible. With that goal in mind, I&#39;ve had the chance to approach things from a new direction.</p><p>Native captions support has come a long way since 2014, so we wanted to continue using native text tracks if possible.</p><p>Unlike native captions, built-in player controls are very limiting. A lot of web players implement their own controls, not only for functionality but also for the ability to customize the visual design. For example, some native controls have complicated interactions with assistive technologies. Implementing these features manually (using the correct primitives) can produce more accessible controls.</p><p>If you create custom controls and then enable native captions, unless you&#39;re Crunchyroll, your controls probably take up space at the bottom of the display area. This is the same area where the captions appear, which means that when the controls are displayed, they may overlay the captions. (Please don&#39;t hide the captions altogether! Unfortunately, I&#39;ve seen this on some players that shall remain nameless.)</p><div><figure><figcaption>Still from Spy X Family showcasing the Crunchyroll player</figcaption></figure></div><p>This is a bad user experience, particularly for users who rely on captions, because they will miss content when the controls are visible. This isn&#39;t a problem with native controls and native captions because the captions will move out of the way when the controls are shown. I wanted to try and address this behavior with a cross-browser solution.</p><p>There are a couple ways to change where the captions show up. You can 1) change the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebVTT_API#cue_settings">cue settings</a> or 2) apply some CSS.</p><h2 id="cue-settings">Cue settings<a href="#cue-settings"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Cue settings</span></a></h2><p>WebVTT has support for positioning each cue via cue settings right within the WebVTT file. This might be useful, but we don&#39;t want to require Mux users to modify their files to use our player, so this wasn&#39;t going to work for us.</p><p>Is it possible to change these settings on the fly via JavaScript, you might ask? Well, hold that thought for a minute; we&#39;ll get back to it.</p><h2 id="css">CSS<a href="#css"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->CSS</span></a></h2><p>Is it possible to apply CSS to move the cues out of the way? As with a lot of things in computing, the answer is &#34;it depends.&#34; WebVTT has a CSS extension for the <code>::cue</code> pseudo-element, which allows you to apply styles to each cue. However, it limits which things are allowed to be applied, so something like the following is going to get ignored by the browser, unfortunately.</p><div><div><pre><p>css</p></pre><pre><code>/* Don&#39;t try this, the browser will ignore it */
video::cue {
  bottom: 3em;
}</code></pre></div></div><p>Are there other ways to move captions using CSS? Yes, if you&#39;re in Safari or Chrome (and likely other Chromium-based browsers, although I haven&#39;t tested extensively). This is because WebKit-based browsers (remember that Blink was originally forked from WebKit?) render the cues into the video element&#39;s shadow DOM and expose pseudo-elements that we can use to target them. Specifically, <code>::-webkit-media-text-track-display</code>.</p><p>Now, the trick is to make the captions move as expected. Using something like <code>bottom: 3em</code> could work, but it can produce some unexpected results. For example, I’ve seen captions that jumped up twice each time a new cue was shown on screen. Ultimately, the best course of action is using <code>transform</code> to <code>translate</code> the pseudo-element up, like so:</p><div><div><pre><p>css</p></pre><pre><code>video::-webkit-media-text-track-display {
  transform: translateY(-3em);
}</code></pre></div></div><p>Unfortunately, Firefox doesn&#39;t expose any pseudo-elements or other ways to target the display area via CSS.</p><div><figure><figcaption>Image: Ghost In the Shell (1995), Production I.G., Bandai Visual, Manga Entertainment</figcaption></figure></div><p>Remember when you asked about whether you can programmatically modify the cue settings? Well, the answer is that you can!</p><p>All the settings can be modified on the <code>VTTCue</code> object, and the changes should be reflected immediately.</p><h2 id="the-line-cue-setting">The <code>line</code> cue setting<a href="#the-line-cue-setting"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->The line cue setting</span></a></h2><p>The cue setting <code>line</code> controls the position of the cue from the top edge of the video or from either the left or right edge, in the case of vertical cues.</p><p>This setting can be a positive value that represents the line number from the top edge of the video (or a negative value for lines from the bottom edge). Or it can be a percentage of the video height or width, depending on the cue’s orientation.</p><div><div><pre><p>plaintext</p></pre><pre><code>00:00:00.000 --&gt; 00:00:10.100 line:-2
This cue shows up 2 line height from the bottom

00:00:00.000 --&gt; 00:00:10.100 line:-1
This cue shows up right at the bottom
</code></pre></div></div><p>This setting can also be modified via JavaScript:</p><div><div><pre><p>shell</p></pre><pre><code>&gt; const cue = new VTTCue(0, 5, ‘this cue starts with line auto, but modified to line -3’);
&gt; cue.line
&lt; ‘auto’
&gt; cue.line = -3
&gt; cue.line
&lt; -3
</code></pre></div></div><h2 id="the-technical-details">The technical details<a href="#the-technical-details"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->The technical details</span></a></h2><p>So how does this technique work? Well, when the controls are showing, we modify the cue’s <code>line</code> property to subtract the height of the control bar. Then, when the controls hide again, we restore the <code>line</code> property back to what it was before.</p><div><div><pre><p>javascript</p></pre><pre><code>video.addEventListener(&#39;mouseenter&#39;, () =&gt; {
  Array.from(video.textTracks[0].activeCues).forEach((cue) =&gt; {
	cue.line = -3
  });
});

video.addEventListener(&#39;mouseleave, () =&gt; {
  Array.from(video.textTracks[0].activeCues).forEach((cue) =&gt; {
	cue.line = &#39;auto&#39;;
  });
});
</code></pre></div></div><p>For simple cues that don’t have any cue settings, this works quite well. Best of all, because Mux Player only runs in browsers, you’ll always be in an environment that has a JavaScript access to the cues — which means this approach will work anywhere the player needs to run (unlike in VLC, for example, where you wouldn’t be able to do this).</p><p>But what about cues that aren’t at the bottom of the screen? Chances are they’re OK staying where they are. This means we’d want to check if a cue’s <code>line</code> property is either <code>auto</code> or at the bottom of the video — say, if <code>line</code> is between <code>-1</code> and <code>-5</code> (ignoring larger positive values here for simplicity).</p><div><div><pre><p>javascript</p></pre><pre><code>video.addEventListener(&#39;mouseenter&#39;, () =&gt; {
  Array.from(video.textTracks[0].activeCues).forEach((cue) =&gt; {
	// cue.snapToLines means that lines weren&#39;t set to a percentage
	if (cue.snapToLines &amp;&amp;
  	cue.line &lt;= -1 &amp;&amp; cue.line &gt;= -3)) {
  	cue.line = cue.line === &#39;auto&#39; ? -3 : cue.line - 2;
	}
  });
});

video.addEventListener(&#39;mouseleave, () =&gt; {
  Array.from(video.textTracks[0].activeCues).forEach((cue) =&gt; {
	if (cue.snapToLines &amp;&amp;
  	(cue.line === &#39;auto&#39; ||
   	cue.line &lt;= -1 &amp;&amp; cue.line &gt;= -3)) {
  	// if cue.line is -3, set the value back to auto, otherwise, add 2
  	cue.line = cue.line == -3 ?
    	&#39;auto&#39; :
    	cue.line + 2;
	}
  });
});
</code></pre></div></div><p>Mux Player’s design also calls for different buttons and controls to be present depending on the display size and whether the stream is live or not, so <a href="https://github.com/muxinc/elements/pull/229">we want to account for that</a>.</p><h2 id="chrome-bug">Chrome bug<a href="#chrome-bug"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Chrome bug</span></a></h2><p>We did run into a Chrome bug when implementing this solution. Chrome wouldn’t accept the first value that we set <code>line</code> to. However, we noticed that this can be worked around by first setting the <code>line</code> to a different value before setting it to the value we wanted it to be. We’ve filed a <a href="https://crbug.com/1308892">bug</a> with Chromium.</p><div><div><pre><p>javascript</p></pre><pre><code>// we have to set line to 0 first due to a chrome bug https://crbug.com/1308892
cue.line = 0;
cue.line = -3;
</code></pre></div></div><h2 id="final-implementation">Final implementation<a href="#final-implementation"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Final implementation</span></a></h2><p>There’s still more to do to get this to cover a variety of edge cases — like what if the <code>activeCues</code> change while the controls are still showing? Or what if the selected track changes? <a href="https://github.com/muxinc/elements/blob/f8ee204bc9ef07a0a0718472b14ca6dc5741a3c1/packages/mux-player/src/index.ts#L374-L492">The final implementation</a> that we have in Mux Player ends up being a bit complex in order to cover a variety of scenarios, but it does work across browsers, including Firefox, Chrome, and Safari.</p><p>After implementing this technique, I spent some time writing a blog post on this topic. However, as I was completing my first draft of that blog post, we noticed a bug in Safari.</p><div><figure><figcaption>Image: clip from Nichijou, Kyoto Animation, Crunchyroll</figcaption></figure></div><h2 id="safari-bug">Safari bug<a href="#safari-bug"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Safari bug</span></a></h2><p>At first, we weren&#39;t sure what exactly was going on. Someone on the team reported seeing duplicate captions in some cases, but it wasn&#39;t easily reproducible. We noticed it again that day, so I set aside time to figure it out.</p><p>I don&#39;t remember exactly what led me to figuring out how to reproduce it, but the bug happens when we use my new technique to move the captions up and then seek back to replay a portion of video with the captions. It seems like Safari has a check to see if the cue embedded inside an HLS stream exists and, if not, to re-add it. If we modify the cue in any way, like changing the line property, the modified cue becomes invalid, and Safari adds a new cue. Since the modified cue isn’t removed, we end up with duplicated cues.  If you seek back multiple times, you&#39;ll end up getting multiple duplicates, meaning all the previous cues would&#39;ve been shifted.</p><p>I&#39;ve opened <a href="https://bugs.webkit.org/show_bug.cgi?id=240549">an issue against WebKit for this</a>, and I hope it gets fixed soon. In the meantime, since it happens only with native HLS playback, we can use MSE-based playback on desktop and iPad and turn the new captions movement behavior off on iPhones.</p><h2 id="where-do-we-go-from-here-">Where do we go from here?<a href="#where-do-we-go-from-here-"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2712%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span><span>Link to <!-- -->Where do we go from here?</span></a></h2><p>Custom controls are very common for web-based players, from Mux Player to Video.js and beyond. Pretty much every player has, at some point, struggled with captions and controls. In Video.js, the solution we decided on was to not rely on native captions by default except for Safari and then target Safari specifically with CSS.</p><p>Looking at the specification for WebVTT, it specifically accounts for the control bar showing up and asks user agents (browsers) to move the cues out of the way when this happens (<a href="https://w3c.github.io/webvtt/#processing-model">see section 7.1 step 4 of the Processing Model algorithm</a>). Given that this mechanism exists in the spec, we need a way to let the browser know about our custom controls so that it can apply the same mechanism for our controls as for native controls.</p><p>To that end, I opened <a href="https://github.com/w3c/webvtt/issues/503">an issue on the WebVTT specification</a> — where I’ve already shared one potential solution — and started a discussion in the Timed Text Working Group and the Media Working Groups to think about how this should be addressed.</p><p>This is where you come in. Your input and thoughts <a href="https://github.com/w3c/webvtt/issues/503">on the discussion</a> can help drive the future of native video captioning. How can we improve captions on the web when using custom controls with native captions? While you&#39;re at it, do you see any limitations with captions that can be improved?</p><p>Make your voice heard. Give me your take by tweeting @MuxHQ or emailing me at gary@mux.com - and thanks for reading!</p><div><figure><figcaption>Image: Aggretsuko, Fanworks, Netflix</figcaption></figure></div><div><ol><li id="fn:1">The difference between captions and subtitles is that subtitles only have the spoken words, whereas captions also include other auditory cues. Outside the US, there may not be a distinction between the two, or captions may be called Subtitles for The Deaf and Hard of Hearing (SDH).<a href="#fnref:1">↩</a></li></ol></div></div></div></div>
  </body>
</html>
