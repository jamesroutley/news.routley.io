<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://owehrens.com/whisper-nvidia-rtx-4090-vs-m1pro-with-mlx/">Original</a>
    <h1>Whisper: Nvidia RTX 4090 vs. M1 Pro with MLX</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
<article>

    <header>

        

        

            <p>How fast is my Whisper Benchmark with the MLX Framework from Apple? Nvidia 4090 / M1 Pro / M2 Ultra / M3</p>

        <div>
        <section>

            <ul>
                <li>
                    <a href="https://owehrens.com/author/oliver/">
                        <img src="https://www.gravatar.com/avatar/d7192560bc009a2a4a0afe1c2d0dd0e3?s=250&amp;r=x&amp;d=mp" alt="Oliver Wehrens"/>
                    </a>
                </li>
            </ul>

            <div>
                
                <p><time datetime="2023-12-09">Dec 9, 2023</time>
                        <span><span>‚Ä¢</span> 4 min read</span>
                </p>
            </div>

        </section>
        </div>


    </header>

    <section>
        <p>(... see down below for M2 Ultra / M3 Max Update and a Nvidia optimzied whisper)</p><p>Apple <a href="https://github.com/ml-explore/mlx">released a machine learning framework</a> for Apple Silicon. Along with that are <a href="https://github.com/ml-explore/mlx-examples">some examples</a> to see how things are working. They also use a whisper for benchmarking. So I dug out my benchmark and used that to measure performance.</p><p>I simply added a new file to the repo (and the whisper large model was already downloaded). See the <a href="https://github.com/ml-explore/mlx-examples/tree/main/whisper">original source dir</a>.</p><!--kg-card-begin: markdown--><pre><code>import datetime
from pprint import pprint

from whisper import transcribe

if __name__ == &#39;__main__&#39;:
    audio_file = &#34;whisper/assets/audio.wav&#34;
    start_time = datetime.datetime.now()
    x = transcribe(audio=audio_file, model=&#39;large&#39;)
    end_time = datetime.datetime.now()
    pprint(x)
    print(end_time - start_time)
</code></pre>
<!--kg-card-end: markdown--><p>It reports back a list of segements with the following structure:</p><!--kg-card-begin: markdown--><pre><code>{&#39;avg_logprob&#39;: -0.18728541468714807,
               &#39;compression_ratio&#39;: 1.3786764705882353,
               &#39;end&#39;: 589.92,
               &#39;id&#39;: 139,
               &#39;no_speech_prob&#39;: 0.0017877654172480106,
               &#39;seek&#39;: 56892,
               &#39;start&#39;: 586.92,
               &#39;temperature&#39;: 0.0,
               &#39;text&#39;: &#39; Ich hei√üe Moses Fendel, danke f√ºrs Zuh√∂ren und &#39;
                       &#39;tsch√º√ü.&#39;,
               &#39;tokens&#39;: [51264,
                          3141,
                          39124,
                          68,
                          17580,
                          479,
                          521,
                          338,
                          11,
                          46434,
                          46577,
                          1176,
                          3232,
                          26377,
                          674,
                          256,
                          6145,
                          774,
                          2536,
                          13,
                          51414]},
</code></pre>
<!--kg-card-end: markdown--><p>The structure is the same as I get with Python whisper on my RTX 4090. </p><p>The audio file is the same as in my other <a href="https://owehrens.com/openai-whisper-on-apple-m1-cpp-version/">benchmarks</a> with M1 and <a href="https://owehrens.com/whisper-performance-on-nvidia-rtx-4090/">4090</a>. </p><figure><img src="https://owehrens.com/content/images/2023/12/MLX-Power-1.png" alt="" loading="lazy" width="1790" height="798" srcset="https://owehrens.com/content/images/size/w600/2023/12/MLX-Power-1.png 600w, https://owehrens.com/content/images/size/w1000/2023/12/MLX-Power-1.png 1000w, https://owehrens.com/content/images/size/w1600/2023/12/MLX-Power-1.png 1600w, https://owehrens.com/content/images/2023/12/MLX-Power-1.png 1790w" sizes="(min-width: 720px) 720px"/></figure><h2 id="result">Result</h2><p>The result for a 10 Minute audio is 0:03:36.296329 <em>(216 seconds)</em>. Compare that to <em>0:03:06.707770 (186 seconds)</em> on my Nvidia 4090. The 2000 ‚Ç¨ GPU is still 30 seconds or ~ 16% faster. All graphics core where fully utilized during the run and I quit all programs, disabled desktop picture or similar for that run. </p><p>If I use an Nvidia optimized model I get the transcript in 8 seconds.</p><p><strong>Update: </strong>I ran the same tests multiple times, the time is measured now without loading the model into memory in both cases.</p><p>My Macbook Hardware Specs:</p><ul><li>14&#34; MacBook with M1 Pro, 8 (6 performance and 2 efficiency) cores (2021 model)</li><li>32 GB RAM</li><li>16 GPU Cores</li></ul><p>PC Spec:</p><ul><li>Intel Core I7-12700KF 8x 3.60GHz</li><li>2x32 GB RAM 3200 MHz DDR4, Kingston FURY Beast</li><li>SSD M.2 PCIe 2280 - 1000GB Kingston KC3000 PCIe 4.0 NVMe</li><li>GeForce RTX 4090, 24GB GDDR6X / Palit RTX 4090 GameRock OmniBlack<br/></li></ul><h2 id="insanely-fast-whisper"><a href="https://github.com/Vaibhavs10/insanely-fast-whisper">insanely-fast-whisper</a> ?</h2><p>This article is trending on <a href="https://news.ycombinator.com/item?id=38628184">HackerNews</a>. User <em>modeless</em> said:</p><blockquote>downloaded the 10 minute file he used and ran it on <em>my</em> 4090 with insanely-fast-whisper, which took two commands to install. Using whisper-large-v3 the file is transcribed in less than eight seconds. Fifteen seconds if you include the model loading time before transcription starts (obviously this extra time does not depend on the length of the audio file).</blockquote><p>After some hickups and got it working. Alright, the new king:</p><!--kg-card-begin: markdown--><pre><code>(iw-kgoj) ‚ûú  iw insanely-fast-whisper --file-name audio.mp3 --flash True
/home/ai/.virtualenvs/iw-kgoj/lib/python3.10/site-packages/pyannote/audio/core/io.py:43: UserWarning: torchaudio._backend.set_audio_backend has been deprecated. With dispatcher enabled, this function is no-op. You can remove the function call.
  torchaudio.set_audio_backend(&#34;soundfile&#34;)
/home/ai/.virtualenvs/iw-kgoj/lib/python3.10/site-packages/torch_audiomentations/utils/io.py:27: UserWarning: torchaudio._backend.set_audio_backend has been deprecated. With dispatcher enabled, this function is no-op. You can remove the function call.
  torchaudio.set_audio_backend(&#34;soundfile&#34;)
The model was loaded with use_flash_attention_2=True, which is deprecated and may be removed in a future release. Please use `attn_implementation=&#34;flash_attention_2&#34;` instead.
You are attempting to use Flash Attention 2.0 with a model not initialized on GPU. Make sure to move the model to GPU after initializing it on CPU with `model.to(&#39;cuda&#39;)`.
Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
ü§ó Transcribing... ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ 0:00:08
Voila!‚ú® Your file has been transcribed go check it out over here üëâ output.json</code></pre>
<!--kg-card-end: markdown--><p>8 Seconds. Nvidia optimized model. Wow. Today I learned something new :). <br/></p><h2 id="m2-ultra-m3-max-update">M2 Ultra / M3 Max Update</h2><p><a href="https://twitter.com/ivanfioravanti/status/1734644638357573679">Ivan over at Twitter</a> ran the same audio file on M2 Ultra with 76 GPUs and M3 Max with 40 GPUs. Much faster than my M1 but both are similar speed.</p><figure><img src="https://owehrens.com/content/images/2023/12/bench2.jpg" alt="" loading="lazy" width="1188" height="335" srcset="https://owehrens.com/content/images/size/w600/2023/12/bench2.jpg 600w, https://owehrens.com/content/images/size/w1000/2023/12/bench2.jpg 1000w, https://owehrens.com/content/images/2023/12/bench2.jpg 1188w" sizes="(min-width: 720px) 720px"/><figcaption>Ivan tested it on M2+M3</figcaption></figure><h2 id="comparison">Comparison</h2><p>Keep in mind, this is not 100% accurate. The rough idea should be visible. Other processes running, loading times, cold, warm start can influence the numbers. </p><figure><img src="https://owehrens.com/content/images/2023/12/PerfChart.jpg" alt="" loading="lazy" width="1908" height="996" srcset="https://owehrens.com/content/images/size/w600/2023/12/PerfChart.jpg 600w, https://owehrens.com/content/images/size/w1000/2023/12/PerfChart.jpg 1000w, https://owehrens.com/content/images/size/w1600/2023/12/PerfChart.jpg 1600w, https://owehrens.com/content/images/2023/12/PerfChart.jpg 1908w" sizes="(min-width: 720px) 720px"/></figure><h2 id="power-consumption">Power consumption</h2><p>Difference between idle PC / M1Pro and GPU running PC / M1Pro</p><ul><li>PC +242 W (Nvidia 4090 running vs. idle)</li><li>MacBook +38 W (16 M1 GPU cores running vs. idle)</li></ul><p>I measured that with a Shelly plug. This might not be 100% accurate but gives an idea where it is going.</p><p><em>Dear Reddit comments:</em></p><p>Way to go Apple.</p><h3 id="why-im-doing-this">Why I&#39;m doing this?</h3><p>I run a podcast search engine over at <a href="http://podpodgogo.com">https://podpodgogo.com</a>. I transcribe tens of thousands episodes, make them full text searchable and run some data mining on them.<br/></p><p><strong>Update Dec 11th: </strong>Added specs and more tests without loading the model.</p><p><strong>Update Dec 12th: </strong>The 4090 is the fastest <em>consumer</em> graphics card. Also updated numbers for M2/M3.</p><p><strong>Update Dec 13th: </strong>Got mentioned on HackerNews and saw a comment about Nvidia optimized whisper. </p>
    </section>


</article>
</div></div>
  </body>
</html>
