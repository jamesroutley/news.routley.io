<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://foon.uk/fixing-quicklook/">Original</a>
    <h1>Fixing QuickLook (2023)</h1>
    
    <div id="readability-page-1" class="page"><article>
        




<p>After upgrading from Mojave to Ventura, I noticed that Apple had changed QuickLook.
</p>
<p>QuickLook is one of my favourite pieces of software. You just select a file in the Finder, press space, and the file pops up on your screen. Then you press space again and it goes away.</p>
<p>Focus stays in the Finder, so you can use the arrow keys to select different files, and the QuickLook window updates to show them to you.</p>
<p>It&#39;s simple, well-designed, fast, tasteful and just all around excellent.</p>
<p>Until now.</p>
<p>For whatever reason, QuickLook will now remove the corners of your images before showing them to you.</p>




<p>It doesn&#39;t matter if they&#39;re photos, game assets, or UI elements you&#39;re designing. Everything will be rounded off before you see it.
</p>
<p>Naturally, I searched around for the secret switch to make it stop. Apple is usually pretty good about letting us opt out of their latest improvements, so there has to be something, right? An accessibility setting? A cheeky <var>defaults.write</var>? As far as I can tell, there isn&#39;t.</p>
<p>So, I guess we&#39;re out of luck?</p>
<p>No. Don&#39;t think like that. It might be a Mac but it&#39;s still your computer. Let&#39;s fix this.</p>
<h2>QuickLook headers</h2><p>If we want to mess with how QuickLook displays things, we need to get at its window. Then we can hopefully poke around in the views and change how they draw.
</p>
<p>The QuickLook API is public and <a href="https://developer.apple.com/documentation/quicklook?language=objc">documented</a>, and if you look through the docs you&#39;ll see that this window is called <var>QLPreviewPanel</var>, there&#39;s one instance of it per app, and you retrieve it with <var>[QLPreviewPanel sharedPreviewPanel]</var>.</p>
<h2>Debugging Finder</h2><p>I&#39;d only ever used QuickLook from Finder, so that was where I thought to start. Let&#39;s bust out the debugger and see what Finder&#39;s up to:
</p>
<code><span>$ </span><span>lldb -n Finder</span></code>
<p>Actually, first, let&#39;s deal with SIP. SIP is a new Apple technology that helps you out by stopping you from reading and writing memory on your own computer. In order to fix problems in system processes like this, we have to turn it off and reboot.
</p>
<p>Alright, let&#39;s try that again:</p>
<code><span>$ </span><span>lldb -n Finder</span></code>
<p>&lt;hacker-voice&gt;We&#39;re in&lt;/hacker-voice&gt; to our own machine.
</p>
<p>Let&#39;s try setting a breakpoint on <var>sharedPreviewPanel</var>.</p>
<code><span>(lldb) </span><span>break set -n sharedPreviewPanel</span></code>
<p>Navigate to an image file, press space, and:
</p>
<code><span>Process 4040 stopped</span></code>
<p>LLDB has stopped the Finder process in the <var>sharedPreviewPanel</var> function. Let&#39;s get the return value, which should be the preview panel instance:
</p>
<code><span>(lldb) </span><span>finish</span></code>
<p>Alright! We&#39;re getting somewhere. Let&#39;s see what&#39;s in this panel:
</p>
<code><span>(lldb) </span><span>po [$x0 recursiveDescription]</span></code>
<p>This is pretty juicy. We can probably ignore <var>QPreviewTitleBarView</var> and its children, so let&#39;s focus on the other branch of the tree. There&#39;s a <var>QLPreviewBackgroundView</var>, then a bunch of <var>NSView</var>s, and then a <var>QLPanelPreviewView</var>, a <var>QLPreviewContainerView</var>, and right at the very top, an <var>NSRemoteView</var>.
</p>
<h2>NSRemote­View</h2><p>I haven&#39;t come across <var>NSRemoteView</var> before and I&#39;m not really sure what it is. There doesn&#39;t seem to be a public header for it. I wonder how it works?
</p>
<p>Well, we might be getting ahead of ourselves here. We still don&#39;t know if the <var>NSRemoteView</var> has anything to do with our image. Let&#39;s hide it and see if our image disappears.</p>
<code><span>(lldb) </span><span>po [(NSRemoteView *)0x119c3a040 setHidden:YES]</span></code>

<figure>
    <picture>
        <source width="438" height="291" srcset="img/blank-dark.png" media="(prefers-color-scheme: dark)"/>
        <img width="438" height="291" src="https://foon.uk/fixing-quicklook/img/blank-light.png"/>
    </picture>
</figure>

<p>Indeed it does. So it&#39;s this <var>NSRemoteView</var> that&#39;s actually displaying our image. The “remote” makes me think it&#39;s communicating with another process which is doing the actual rendering, so we&#39;ll probably have to look inside the remote process to see what it&#39;s doing. But which process is that? Perhaps the <var>NSRemoteView</var> can tell us? Let&#39;s see what it can do:
</p>
<code><span>(lldb) </span><span>po [[NSRemoteView class] fp_shortMethodDescription]</span></code>
<p>A lot!
</p>
<p>Searching for “process” in that list of methods yields <var>_serviceProcessIdentifier</var> so let&#39;s call it.</p>
<code><span>(lldb) </span><span>po [$v _serviceProcessIdentifier]</span></code>
<p>What&#39;s that process?
</p>
<code><span>$ </span><span>ps -c 5959</span></code>
<p>This has to be it. Debugging Finder isn&#39;t what we want. We need to be debugging QuickLookUIService.
</p>
<h2>Debugging QuickLookUI­Service</h2>
<code><span>(lldb) </span><span>detach</span></code>
<p>So, the other side of that <var>NSRemoteView</var> is... somewhere... in this process.
</p>
<p>If we could iterate through all the views in the process, we could see if any of them looked like the other end of an <var>NSRemoteViewDelegate</var>.</p>
<p>I searched the internet for a function that would get all views, but I couldn&#39;t find anything except for the odd person saying to just use Xcode.<sup><a id="ref1" href="#note1">1</a></sup></p>
<p>Well, why don&#39;t we just use Xcode?</p>
<p>After opening Xcode, creating a project, choosing where to save the project, entering a team name, choosing a template, entering a bundle identifier, creating a scheme, and setting the scheme target so it&#39;ll let me use the debugger, I attached it to QuickLookUIService, pressed “Show View Hierarchy”, and:</p>
<figure>
    <picture>
        <source srcset="thumbs/xcode-dark.png" media="(prefers-color-scheme: dark)"/>
        <img src="https://foon.uk/fixing-quicklook/thumbs/xcode-light.png"/>
    </picture>
<figcaption>Xcode&#39;s view debugger attached to QuickLookUIService.</figcaption>
</figure>

<p>Well, that was easy! We can click through these views and get info about them, including their addresses so we can mess with them in the debugger. And we can see straight away that the frontmost view, which Xcode tells us is a <var>QLBorderView</var>, is a border with rounded corners!
</p>
<p>Wait, there&#39;s a border?</p>
<h2>The Border</h2><p>There is. I hadn&#39;t noticed it at first, but if you zoom in, you can see that as well as rounding the corners, QuickLook also superimposes a slightly-too-small border:
</p>
<figure>
    <picture>
        <source srcset="img/big-dark.png" media="(prefers-color-scheme: dark)"/>
        <img src="https://foon.uk/fixing-quicklook/img/big-light.png"/>
    </picture>
    <figcaption></figcaption>
</figure>

<p>The <var>QLBorderView</var> turns out to be very simple; it&#39;s just a view whose layer has a <var>borderWidth</var> and a <var>borderColor</var>. Let&#39;s get its address from Xcode and tell it to cut it out:
</p>
<code><span>(lldb) </span><span>po [0x600000850180 setBorderWidth:0];</span><br/></code>

<figure>
    <picture>
        <source srcset="img/big-borderless-dark.png" media="(prefers-color-scheme: dark)"/>
        <img src="https://foon.uk/fixing-quicklook/img/big-borderless-light.png"/>
    </picture>
    <figcaption>Border successfully removed!</figcaption>
</figure>


<h2>Unclipping</h2><p>So, the border is gone, but the corners are still rounded. We can see in the view debugger that the image view&#39;s corners are not rounded, so something must be clipping it.
</p>
<p>Let&#39;s have a look through all of the parent views&#39; layers and see if any of them have a nonzero <var>cornerRadius</var>.</p>
<p>You could probably write some code to do this but I just clicked through each one and copied its layer&#39;s address into the debugger to check:</p>
<code><span>(lldb) </span><span>p [(CALayer *)0x60000283f5a0 cornerRadius]</span></code>
<p>Well, that didn&#39;t take long. Let&#39;s try...
</p>
<code><span>(lldb) </span><span>po [0x60000283f660 setMasksToBounds:0]</span></code>

<figure>
    <picture>
        <source srcset="img/fixed-dark.png" media="(prefers-color-scheme: dark)"/>
        <img src="https://foon.uk/fixing-quicklook/img/fixed-light.png"/>
    </picture>
    <figcaption>Corners restored!</figcaption>
</figure>


<h2>Keeping it that way</h2><p>So, we&#39;ve now fixed our view. We can see all of our pixels.
</p>
<p>But we&#39;re not done yet, because when you click on a different file, you get a new view, and the new view is rounded. It looks like QL creates one view per previewed file, and reuses the old view only for the same file.</p>
<p>So, we need to intercept it when it makes new views and stop it from screwing them up.</p>
<p>Let&#39;s start with that border view. When is it created? We&#39;ll break on its init method, which its method list tells us is <var>initWithFrame:</var>.</p>
<code><span>(lldb) </span><span>break set -n &#39;[QLOverlayBorderView initWithFrame:]&#39;</span></code>
<p>This does indeed trigger when you select a new image:
</p>
<code><span>Process 5959 stopped</span></code>
<p>Let&#39;s see who&#39;s calling us:
</p>
<code><span>(lldb) </span><span>bt 5</span></code>
<p>Interesting. The border view is being called from something called <var>enableBorder</var>. What if we disabled <var>enableBorder</var>?
</p>
<p>There are no docs for the <var>QLDisplayBundleViewController</var>, of course, but there&#39;s always a method list:</p>
<code><span>(lldb) </span><span>po [$x0 fp_shortMethodDescription]</span></code>
<p>As well as <var>enableBorder</var>, there&#39;s a <var>disableBorder</var>. If we&#39;re lucky it might disable the border.
</p>
<code><span>(lldb) </span><span>po [$x0 disableBorder]</span><br/></code>
<p>It does! So, to fix our QuickLook process, we&#39;ll have to arrange for <var>disableBorder</var> to be called instead of <var>enableBorder</var>.<sup><a id="ref2" href="#note2">2</a></sup>
</p>
<p>Now, what about the rounded corners? We can set a breakpoint to see where the corners get rounded:</p>
<code><span>(lldb) </span><span>break set -n &#39;setCornerRadius:&#39; -c &#39;$x0 == 0x600002cbd830 &amp;&amp; $d0 != 0.0&#39;</span><br/></code>
<p>When this breakpoint is hit, we can see that it&#39;s being called from a method called <var>updateCornerRadius</var>.
</p>
<p>So, our strategy for making our fix persist will be to:</p>
<ol>
<li>Patch <var>updateCornerRadius</var> to return immediately without doing anything.
</li><li>Patch <var>enableBorder</var> to just call <var>disableBorder</var> and return.
</li></ol>


<h2>Aside: Method Swizzling</h2><p>In Objective-C, classes have methods and methods have implementations. As a holdover from the bicycle-for-the-mind days, the Objective-C runtime is hacker-friendly and provides functions to help us monkey around with things:
</p>
<code><span>Method</span><span> </span><span>class_getInstanceMethod</span><span>(</span><span>Class</span><span>,</span><span> </span><span>SEL</span><span>);</span></code>
<p>In theory, you should be able to use these functions to switch out the implementations of <var>enableBorder</var> and <var>updateCornerRadius</var>.
</p>
<p>But, try as I might, I couldn&#39;t get it to work reliably. Maybe I was holding it wrong, but instead of spending time figuring out why, I just went straight to no-nonsense instruction patching.</p>
<h2>Patching the corner radius</h2><p>Let&#39;s patch <var>updateCornerRadius</var> to return immediately without doing anything. We&#39;ll write a <var>ret</var> instruction over the first instruction in the function.
</p>
<p>As documented in this <a href="https://documentation-service.arm.com/static/644a406baa78c007af74e6fd">76MB PDF</a>, the encoding of <var>ret</var> in ARM64 is <var>0xd65f03c0</var>.</p>
<p>We can write a simple Python script that will find the function in memory and patch it:</p>
<code><span>(lldb) </span><span>script</span></code>
<p>Check it worked:
</p>
<code><span>(lldb) </span><span>dis -n updateCornerRadius -c 4</span></code>
<p>Success!
</p>
<h2>Patching enableBorder</h2><p>Patching <var>enableBorder</var> is a little tricker, since we don&#39;t just want to have it <var>ret</var>, we want to have it jump to <var>disableBorder</var>.
</p>
<p>The ARM64 instruction for performing an unconditional jump is <var>b</var>, and is encoded as follows:</p>

<ul>
<li>The instruction is 4 bytes long, like all ARM64 instructions.
</li><li>The high 6 bits are <var>00101</var>.
</li><li>The low 26 bits are the number of instructions to jump, relative to the current instruction.
</li></ul>

<p>Each instruction is 4 bytes, so we just need to subtract the destination address from the source address, sign-extend to 26 bits, and set the high 6 bits to <var>00101</var>.
</p>
<p>Here&#39;s the Python code to do that:</p>
<code><span>(lldb) </span><span>script</span></code>
<p>Check it worked:
</p>
<code><span>(lldb) </span><span>dis -n &#39;-[QLDisplayBundleViewController enableBorder]&#39; -c 4</span></code>
<p>Nice! <sup><a id="ref3" href="#note3">3</a></sup>
</p>
<h2>Putting it all together</h2><p>We now have all the building blocks we need to make a nice script that attaches to all running QuickLook processes and patches them. This article is long enough already, so instead of reproducing it here I&#39;ll just link to the repo. That way you&#39;ll get any fixes that have been made since I wrote this article, too.
</p>
<p>You can find the latest version of the script <a href="https://github.com/rogual/fix-quicklook">here</a>.</p>
<h2>Conclusion</h2><p>I am reminded of the words of the late, great Douglas Adams:
</p>
<blockquote>
The major difference between a thing that might go wrong and a thing that cannot possibly go wrong is that when a thing that cannot possibly go wrong goes wrong it usually turns out to be impossible to get at and repair.
</blockquote>

<p>Well, perhaps not impossible. But that was rather involved!
</p>
<h2>The bit where I try and sell you something</h2><p>Thanks for reading. If you&#39;d like to read more from me, I&#39;ve got <a href="https://foon.uk/how-flash-2022">this article</a> from last year about how I ported a Flash game to C++. My <a href="https://foon.uk">website</a> has a bunch of free games I&#39;ve made over the years, and I&#39;ve also got two games out on Steam:
</p>
<p>Firstly, <a href="https://store.steampowered.com/app/741110/Blackshift/">Blackshift</a>, an epic puzzle game which you can think of as Chip&#39;s Challenge in space.</p>
<p>And more recently, <a href="https://store.steampowered.com/app/1458090/Hapland_Trilogy/">Hapland Trilogy</a>, a smaller point-and-click game.</p>
<p>If you have comments about the article, or just want to say hi, please feel free to drop me an email at <a href="mailto:r@foon.uk">r@foon.uk</a>.</p>
<p>Oh, and if you want to keep up to date with anything else I write, there&#39;s an <a href="https://foon.uk/feeds/rss.xml">RSS feed</a>. RSS is coming back!</p>
<p>See you next time!</p>
<p>Robin Allen</p>
<p>2023</p>
        <div><p><a id="note1" href="#ref1">1</a>.  I&#39;m not sure why I didn&#39;t think of <var>[NSApp windows]</var>. But I&#39;m glad I ended up in Xcode because its view debugger is great.</p><p><a id="note2" href="#ref2">2</a>.  Why not just have <var>enableBorder</var> do nothing? I tried, but it&#39;s not enough. You really do need to call <var>disableBorder</var>.</p><p><a id="note3" href="#ref3">3</a>.  No, I did not get all this stuff working on the first try.</p></div>
    </article></div>
  </body>
</html>
