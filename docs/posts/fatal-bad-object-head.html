<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://moerner.com/posts/fatal-bad-object-head/">Original</a>
    <h1>fatal: bad object HEAD</h1>
    
    <div id="readability-page-1" class="page"><div>
      

<article>
  <header>
    

    
    <p><time>Feb 8, 2025</time>
      
      
      
      
    </p>
    
  </header>

  <section><p>Thanks to all my friends and colleagues for such a wonderful in-person week at
the <a href="https://www.recurse.com/">Recurse Center</a> hub in Brooklyn. I got so much
out of the pairing, the social environment, and especially the opportunity to
present my work in-person at Presentations+. Part of me wishes I had spent a
week in-person earlier, but part of me also believes it was so great precisely
because it was so late in the batch and my work was in a good place for
collaboration.</p>
<p>I worked late at the Hub on Friday night, and let my laptop battery die while I
was watching a movie at the <a href="https://www.anthologyfilmarchives.org/">Anthology Film Archives</a>. When I opened it today, I was met with:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>user@work ~/s/etracker <span>(</span>main<span>)</span>&gt; git status
</span></span><span><span>error: object file .git/objects/92/4bc35594c3f5ede99dad7768d961eedef24af0 is empty
</span></span><span><span>error: object file .git/objects/92/4bc35594c3f5ede99dad7768d961eedef24af0 is empty
</span></span><span><span>error: object file .git/objects/92/4bc35594c3f5ede99dad7768d961eedef24af0 is empty
</span></span><span><span>fatal: bad object HEAD
</span></span></code></pre></div><p>Uh-oh. That sounds terminal! But this is git, we can fix it right?</p>
<p>The first thing I verified is that my latest edits were both available locally,
and had been pushed to Github. Fortunately, they were
(<a href="https://github.com/dmoerner/etracker/commit/924bc35594c3f5ede99dad7768d961eedef24af0">Github</a>).
So I could just delete the local repository and fetch it again from Github. But
let’s try to fix it in place.</p>
<p>Let’s see what’s going on:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>user@work ~/s/etracker <span>(</span>main<span>)</span>&gt; cat .git/HEAD
</span></span><span><span>ref: refs/heads/main
</span></span><span><span>user@work ~/s/etracker <span>(</span>main<span>)</span>&gt; cat .git/refs/heads/main
</span></span><span><span>924bc35594c3f5ede99dad7768d961eedef24af0
</span></span><span><span>user@work ~/s/etracker <span>(</span>main<span>)</span>&gt; ls -l .git/objects/92/4bc35594c3f5ede99dad7768d961eedef24af0
</span></span><span><span>-r--r--r--. <span>1</span> user user <span>0</span> Feb  <span>7</span> 18:56 .git/objects/92/4bc35594c3f5ede99dad7768d961eedef24af0
</span></span></code></pre></div><p>To put it crudely (but to express the best of my understanding of the matter),
the git HEAD references the current commit on the current branch. The current
branch is “main”, and the current commit is empty. That is obviously bad.</p>
<p>One way to fix this is explained in this detailed <a href="https://stackoverflow.com/a/12371337">Stack Overflow post</a>. Since the working directory is up-to-date, you can just delete the bad object, fix all the references (which will then treat your working directory as modified relative to HEAD), and then re-commit. However, since the commit is already in my remote repository, I think I would then have to do a force-push to rewrite the remote history. I would like to avoid doing this.</p>
<p>So really we have a slightly different challenge: How can I get my local
repository to match the remote repository exactly, without using any of the
normal git commands in the current repository? Well, all we need to do is copy
over a good copy of this object. Well, this is all a bit silly
now, but here’s one way to do it:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>user@work ~&gt; mkdir test
</span></span><span><span>user@work ~&gt; cd test/
</span></span><span><span>user@work ~/test&gt; git clone https://github.com/dmoerner/etracker
</span></span><span><span>Cloning into <span>&#39;etracker&#39;</span>...
</span></span><span><span>remote: Enumerating objects: 673, <span>done</span>.
</span></span><span><span>remote: Counting objects: 100% <span>(</span>168/168<span>)</span>, <span>done</span>.
</span></span><span><span>remote: Compressing objects: 100% <span>(</span>87/87<span>)</span>, <span>done</span>.
</span></span><span><span>remote: Total <span>673</span> <span>(</span>delta 75<span>)</span>, reused <span>134</span> <span>(</span>delta 53<span>)</span>, pack-reused <span>505</span> <span>(</span>from 1<span>)</span>
</span></span><span><span>Receiving objects: 100% <span>(</span>673/673<span>)</span>, 263.91 KiB | 2.09 MiB/s, <span>done</span>.
</span></span><span><span>Resolving deltas: 100% <span>(</span>375/375<span>)</span>, <span>done</span>.
</span></span><span><span>user@work ~/test&gt; cd etracker/
</span></span><span><span>user@work ~/t/etracker <span>(</span>main<span>)</span>&gt; mv .git/objects/pack/pack-85b91a72599f73863365b8873a9a6d35df74d96b.pack .
</span></span><span><span>fatal: bad object HEAD
</span></span><span><span>user@work ~/t/etracker <span>(</span>main<span>)</span>&gt; git unpack-objects &lt; pack-85b91a72599f73863365b8873a9a6d35df74d96b.pack
</span></span><span><span>Unpacking objects: 100% <span>(</span>673/673<span>)</span>, 263.89 KiB | 1.69 MiB/s, <span>done</span>.
</span></span><span><span>user@work ~/t/etracker <span>(</span>main<span>)</span>&gt; sudo cp .git/objects/92/4bc35594c3f5ede99dad7768d961eedef24af0 ~/src/etracker/.git/objects/92/
</span></span><span><span>user@work ~/t/etracker <span>(</span>main<span>)</span>&gt; cd ~/src/etracker/
</span></span><span><span>user@work ~/s/etracker <span>(</span>main<span>)</span>&gt; git status
</span></span><span><span>On branch main
</span></span><span><span>Your branch is up to date with <span>&#39;origin/main&#39;</span>.
</span></span><span><span>
</span></span><span><span>nothing to commit, working tree clean
</span></span></code></pre></div><p>Fixed! So what’s happening here? The issue is that when we clone a remote
repository from Github, the object files are <em>packed</em>. For more information,
see the <a href="https://git-scm.com/book/en/v2/Git-Internals-Packfiles">relevant
chapter</a> of the Git
book. So you can’t just directly clone a repository and copy over the object.</p>
<p>However, there is a secret Git command, <code>git unpack-objects</code>, which will unpack a
packfile. I say it’s “secret” because it is actually omitted from the Git shell
autocompletion! But you can still type it out manually. Now this command has a
weird quirk: You need to run it from the Git repo, but if the packfile is in the
default location, it does nothing. So we <code>mv</code> the packfile out of the
<code>.git/objects/pack</code> directory, thereby <em>deliberately</em> breaking our second repo.
Then we can unpack it again, un-breaking our second repo, and copy the right
object file back to the original repo, un-breaking the first repo! (You need to
<code>sudo cp</code> because all these objects are kept read-only.)</p>
<p>A bit of a silly exercise, but HEAD re-attached, and we are back to normal.</p>
</section>

  
  

  
  
  
  
  <nav>
    
    
    <a href="https://moerner.com/posts/rethinking-js-react/"><span>Learning React and Rethinking JavaScript&#39;s Warts</span><span>→</span></a>
    
  </nav>
  
  

  
  

  
  

  


  
</article>


    </div></div>
  </body>
</html>
