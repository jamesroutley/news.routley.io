<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jcs.org/2022/07/15/kludge">Original</a>
    <h1>Writing and running a BBS on a Macintosh Plus</h1>
    
    <div id="readability-page-1" class="page"><article>
	<header>
			
		
		
	</header>

	
	<p>In 2015, I
<a href="https://jcs.org/2015/04/02/creating_a_bbs_in_2015">wrote a custom BBS server in Ruby</a>
and had been using it to run the Kludge BBS on a small OpenBSD server in my
home office since then.</p>

<p>Last year after writing a lot of
<a href="https://jcs.org/system6c">C on my Macintosh Plus</a>,
I had the itch to write a new BBS server so I could move the BBS to run on
another Mac Plus.
As with all software development projects, it took quite a bit longer than
expected, but last month I finally got far enough with the development to deploy
the new BBS on a Mac Plus.</p>





<h2 id="table-of-contents">Table of Contents</h2>

<ol id="markdown-toc">
  <li><a href="#hardware" id="markdown-toc-hardware">Hardware</a></li>
  <li><a href="#revision-control" id="markdown-toc-revision-control">Revision Control</a></li>
  <li><a href="#threading" id="markdown-toc-threading">Threading</a></li>
  <li><a href="#mactcp" id="markdown-toc-mactcp">MacTCP</a></li>
  <li><a href="#console" id="markdown-toc-console">Console</a></li>
  <li><a href="#design-detours" id="markdown-toc-design-detours">Design Detours</a></li>
  <li><a href="#screen-saver" id="markdown-toc-screen-saver">Screen Saver</a></li>
  <li><a href="#web-login-over-websockets" id="markdown-toc-web-login-over-websockets">Web Login over WebSockets</a></li>
  <li><a href="#file-transfers" id="markdown-toc-file-transfers">File Transfers</a></li>
  <li><a href="#telnet-bots" id="markdown-toc-telnet-bots">Telnet Bots</a></li>
  <li><a href="#future-work" id="markdown-toc-future-work">Future Work</a></li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a></li>
</ol>

<h2 id="hardware">Hardware</h2>

<p>My deployment target is a platinum
<a href="https://en.wikipedia.org/wiki/Macintosh_Plus">Macintosh Plus</a>
with an 8 Mhz Motorola 68000 processor, 4 Mb of RAM (the maximum supported), and
a
<a href="https://store.inertialcomputing.com/product-p/scsi2sd-v5.5.htm">SCSI2SD v5.5</a>
external SCSI hard drive with a 2 GB HFS “disk” on a Samsung PRO Endurance
microSD card.
The Mac is running System 6.0.8.</p>

<figure>
<a href="https://jcs.org/images/2022-07-15-fan-large.jpg"><img src="https://jcs.org/images/2022-07-15-fan-221x294.jpg" srcset="/images/2022-07-15-fan-221x294.jpg 1x, /images/2022-07-15-fan-442x588@2x.jpg 2x" width="221" height="294"/></a>
<figcaption>
Noctua fan
</figcaption>
</figure>
<p>While the Mac Plus is normally fanless, I was concerned about heat buildup
running it 24/7, so I installed a small Noctua fan inside the case that still
operates at near silence.
With the internal CRT also powered on 24/7, I thought it would be useful to add
a toggle switch to reduce power usage and heat, and avoid screen burn-in, but
this does not
<a href="https://tinkerdifferent.com/threads/adding-a-crt-toggle-switch.834/">seem very straightforward</a>.
I did recap the analog board before setting everything up and it’s been running
for a couple months now without issue, but time will tell how long everything
lasts.</p>

<p>For network connectivity, the Mac Plus has a DaynaPORT SCSI/Link-3 SCSI Ethernet
adapter which connects to a managed switch on its own VLAN, connected to my
OpenBSD firewall which routes the Mac Plus’s static IP over my internet
connection.
TCP/IP is provided by MacTCP 2.1.</p>

<p><em>Side note:</em> I
<a href="https://github.com/jcs/pce/commit/1c535505f42e34ba0dac9ac8e0027e8cf18b8dda">implemented</a>
a virtual DaynaPORT SCSI/Link-3 Ethernet adapter in the
<a href="http://www.hampa.ch/pce/">PCE MacPlus emulator</a>,
allowing it to do
<a href="https://twitter.com/jcs/status/1521211685620568065">real network connections</a>
through a <code>tap</code> device on the host.</p>

<p>For modem connectivity, I am using a US Robotics 5686 modem connected to a
Grandstream HT814 VoIP ATA, which routes SIP traffic through the same OpenBSD
firewall running Asterisk, which then routes that traffic through Twilio for
<abbr title="Public Switched Telephone Network">PSTN</abbr>
service.
I took the US Robotics modem board out of its normal case and rigged it up
inside the case of an
<a href="https://jcs.org/2017/06/23/wifi232#apple-modem-3001200">Apple Modem 300/1200</a>,
and soldered a green power LED to the front.</p>

<p>For backups and for transferring files between my Mac Plus workstation, I am
using an Iomega Zip 100 SCSI drive.
For those keeping track, that’s a SCSI ethernet device, SCSI hard drive, and
SCSI Zip drive on an 8 Mhz computer from 1986.
I don’t know why the non-server PC market never caught on to using SCSI for hard
drives and peripherals.</p>

<figure>
<a href="https://jcs.org/images/2022-07-15-ethernet-large.jpg"><img src="https://jcs.org/images/2022-07-15-ethernet-335x251.jpg" srcset="/images/2022-07-15-ethernet-335x251.jpg 1x, /images/2022-07-15-ethernet-670x502@2x.jpg 2x" width="335" height="251"/></a>
<a href="https://jcs.org/images/2022-07-15-modem-large.jpg"><img src="https://jcs.org/images/2022-07-15-modem-335x251.jpg" srcset="/images/2022-07-15-modem-335x251.jpg 1x, /images/2022-07-15-modem-670x502@2x.jpg 2x" width="335" height="251"/></a>
<figcaption>
DaynaPORT SCSI/Link-3 Ethernet, Iomega Zip 100 Drive, and Apple 300/1200 Modem
</figcaption>
</figure>

<h2 id="revision-control">Revision Control</h2>

<p>As with all of my classic Mac OS projects, I would be writing the code for the
BBS
<a href="https://jcs.org/system6c">on a Mac Plus</a>
in the THINK C 5 IDE.
Since THINK C’s editor only has one level of undo, once a file is saved, I can’t
go back without restoring a file from a backup, and my previous method of making
a date-stamped copy of my code directory was not scaling well.</p>

<p>Before I started writing the BBS, which I am calling
<a href="https://amendhub.com/jcs/subtext">Subtext</a>,
I wanted to have a proper revision control system so I could commit things in
small chunks, view diffs of what’s in my work directory, and if needed, revert
changes to a file.</p>

<p>There are some proprietary development tools that work on newer machines running
System 7, but since I am doing everything on System 6 and am limited to 4 MB of
RAM, I opted to
<a href="https://jcs.org/2021/10/22/amend">create my own lightweight tool</a>
that I call
<a href="https://jcs.org/amend">Amend</a>.</p>

<p>I also created a lighthearted GitHub-like web interface to Amend repositories,
which I call
<a href="https://amendhub.com/">AmendHub</a>.
I periodically upload the Amend repo from my Mac Plus to my OpenBSD laptop, and
then upload it to AmendHub where new amendments are imported.</p>

<p>Continued development of Amend along the way also took quite a bit of time, like
<a href="https://jcs.org/2022/01/08/bile">having to change its on-disk database format</a>,
but at this point I consider it to be quite stable.</p>

<div>
	<p><a href="https://jcs.org/images/2022-07-15-amend-large.png"><img src="https://jcs.org/images/2022-07-15-amend-512x342.png" srcset="/images/2022-07-15-amend-512x342.png 1x, /images/2022-07-15-amend-1024x684@2x.png 2x" width="512" height="342"/></a>
	</p>
</div>

<h2 id="threading">Threading</h2>

<p>The next hurdle was needing a cooperative threading mechanism.
In the same way that my Ruby BBS used
<a href="https://ruby-doc.org/core-2.5.0/Fiber.html">Fibers</a>,
this would allow me to write code in a very top-down, procedural format without
having to use annoying callbacks, while still allowing concurrent interactive
user sessions.
This took a bit of research and development on classic Mac OS since I had never
built such a thing before, but ultimately resulted in a small
<a href="https://jcs.org/2021/12/01/uthread">uthread library</a>
(<a href="https://amendhub.com/jcs/subtext/files/uthread.c">code</a>)
that uses <code>setjmp</code> and <code>longjmp</code> to give each thread its own stack and then
switch between them once a thread calls <code>uthread_yield</code>.</p>

<p>In Subtext, this is done whenever the user’s session has to
<a href="https://amendhub.com/jcs/subtext/files/session.c#L514">wait for input</a>
or wait for its per-node module to flush its output.</p>

<h2 id="mactcp">MacTCP</h2>

<p>Some other BBS packages that I’ve come across for System 6 and 7 rely on the
<a href="https://en.wikipedia.org/wiki/Communications_ToolBox">Communications ToolBox</a>
for doing TCP/IP communication and modem access, but I decided not to go this
route.</p>

<p>Subtext is written to use the ubiquitous
<a href="https://archive.org/details/mac-tcp-programming">MacTCP</a>
system extension for TCP/IP access which is a bit quirky compared to Unix
sockets, especially when implementing servers.
A TCP stream is created to passively listen on a TCP port, but once a connection
is established on it, a second stream must be immediately setup to listen for
a second connection or that request will be lost.</p>

<p>There are also some
<a href="https://amendhub.com/jcs/subtext/amendments/150">quirks</a>
related to finding the state of a listening stream that were not documented and
took a lot of real-world debugging to figure out why the server would just stop
accepting new connections after a day or so.
Luckily the amount of bot-scanning traffic that the BBS receives just being
connected to the internet provides a lot of garbage traffic to experiment with.</p>

<h2 id="console">Console</h2>

<p>Since Subtext runs on a Mac with a screen, it seemed appropriate to allow
the sysop to log in locally on a console.
This required writing a
<a href="https://amendhub.com/jcs/subtext/files/console.c">VT100-capable terminal client</a>
which could now be easily extracted out into a dedicated telnet client.
I’m currently using
<a href="https://www.dalverson.com/zterm/">ZTerm</a>
on my Mac Plus workstation to connect to other BBSes via modem, but it doesn’t
support telnet without a <a href="https://jcs.org/2017/06/23/wifi232">Serial-&gt;WiFi adapter</a>.</p>

<h2 id="design-detours">Design Detours</h2>

<p>Winding along its
<a href="https://amendhub.com/jcs/subtext/amendments">8 month development</a>,
I had a few detours and over-engineering of obscure components.
While I’m most likely the only one that will ever use Subtext, I avoided
hard-coding anything specific to my BBS in it.
I made a templating mechanism to dynamically expand variables in views (like
<tt>{{ username }}</tt>, and a GUI-based view editor that can be used for creating
things like the menu:</p>

<div>
	<p><a href="https://jcs.org/images/2022-07-15-editor-large.png"><img src="https://jcs.org/images/2022-07-15-editor-512x342.png" srcset="/images/2022-07-15-editor-512x342.png 1x, /images/2022-07-15-editor-1024x684@2x.png 2x" width="512" height="342"/></a>
	</p>
</div>

<p>While I initially intended to add GUI-based editors for things like the user
database and message boards, once I had a working sysop console and could access
all of the BBS functionality locally, I ended up writing this into Subtext as
interactive menus.
This has the benefit that I can manage them remotely through telnet rather than
having to be at the console.</p>

<div>
	<p><a href="https://jcs.org/images/2022-07-15-menu-large.png"><img src="https://jcs.org/images/2022-07-15-menu-512x342.png" srcset="/images/2022-07-15-menu-512x342.png 1x, /images/2022-07-15-menu-1024x684@2x.png 2x" width="512" height="342"/></a>
	</p>
</div>

<h2 id="screen-saver">Screen Saver</h2>

<p>Since the Mac Plus will always have its screen on, I wanted to avoid CRT burn-in
while it’s just showing the log window waiting for a call.
I can’t rely on another screen saver like
<a href="https://mobile.twitter.com/jcs/status/1320385329229144067">After Dark</a>
because it doesn’t know anything about the BBS activity and can’t automatically
deactivate when there is activity that I want to see.
It’s also very CPU-intensive to make toasters fly, so I want it stopped as soon
as a new connection comes in.</p>

<p>I wrote a
<a href="https://amendhub.com/jcs/subtext/amendments/159">simple opportunistic screen blanker</a>
that kicks in at a configured timeout of inactivity when there are no active
sessions, and just blacks out the entire screen for a small amount of configured
time or until something is logged.</p>

<h2 id="web-login-over-websockets">Web Login over WebSockets</h2>

<p>Once telnet and modem connectivity were complete, I wanted to bring back web
access.
My Ruby BBS had an integrated web server which served some custom JavaScript
that talked back to the BBS over a WebSockets connection.
My JavaScript implemented a VT100-capable terminal so the BBS could send out
ANSI escape sequences just as if it were talking to a telnet client.</p>

<p>While the Mac Plus is capable of serving telnet clients on its own, I was not
going to implement the whole WebSockets spec in addition to a custom HTTP
server.
Additionally, due to MacTCP’s single-connection-on-a-socket limitation, it would
be difficult to make the HTTP server not drop HTTP requests during the
listen-&gt;open-&gt;listen state change.</p>

<p>Since my OpenBSD firewall is already in between, I setup nginx with
<a href="https://github.com/joewalnes/websocketd">websocketd</a>
to execute a stripped-down telnet binary on the OpenBSD firewall.</p>

<p>When a new connection comes in, nginx serves the front-end HTML and JavaScript.
The JavaScript makes a WebSockets connection back to nginx, which then passes it
to websocketsd, which launches telnet.
The telnet binary connects to the Mac Plus through its normal telnet server, but
passes the web client’s IP address as a telnet
<a href="https://datatracker.ietf.org/doc/html/rfc1572">environment variable</a>, which
Subtext will
<a href="https://amendhub.com/jcs/subtext/amendments/166">honor</a>
and display it as the remote IP it’s talking to, even though it’s actually
communicating with the firewall’s IP.
websocketsd automatically handles the shuffling of input and output data between
the telnet client and the WebSockets connection.</p>

<p>Since the previous HTML displayed a fake Windows 3.1-era telnet client, I
changed it to resemble a Mac running
<a href="https://www.dalverson.com/zterm/">ZTerm</a>.
The old interface used my
<a href="https://github.com/jcs/ansiterm">DOS 437-codepage font</a>
to display
<a href="https://en.wikipedia.org/wiki/Code_page_437">high-ascii (“ANSI”) box characters</a>
properly in the browser, but since the new BBS is only using plain ASCII and is
being displayed on a fake Mac screen, I needed
a TrueType version of the old Monaco 9 font from System 6.
I couldn’t find a proper one, so I made one by creating a BDF-format font with
all of the characters from a screenshot, then converted it to TrueType with
<a href="https://github.com/kreativekorp/bitsnpicas">Bits’N’Picas</a>.</p>

<figure>
<a href="https://jcs.org/images/2022-07-15-telix-large.png"><img src="https://jcs.org/images/2022-07-15-telix-335x266.png" srcset="/images/2022-07-15-telix-335x266.png 1x, /images/2022-07-15-telix-670x532@2x.png 2x" width="335" height="266"/></a>
<a href="https://jcs.org/images/2022-07-15-zterm-large.png"><img src="https://jcs.org/images/2022-07-15-zterm-335x245.png" srcset="/images/2022-07-15-zterm-335x245.png 1x, /images/2022-07-15-zterm-670x490@2x.png 2x" width="335" height="245"/></a>
<figcaption>
Fake Telix web interface to old BBS, fake ZTerm web interface of new BBS
</figcaption>
</figure>

<h2 id="file-transfers">File Transfers</h2>

<p>The last major part of the BBS was handling file transfers with
<a href="https://en.wikipedia.org/wiki/ZMODEM">ZMODEM</a>.
The
<a href="http://wiki.synchro.net/ref:zmodem">ZMODEM protocol</a>
is rather
<a href="https://web.archive.org/web/20220308112724/http://gallium.inria.fr/~doligez/zmodem/zmodem.txt">large</a>
and has a complicated state machine, so I wasn’t looking forward to writing my
own implementation, especially for something that has to be compatible with
other terminal software.
The few open-source C implementations available have
<a href="https://groups.google.com/g/comp.protocols.misc/c/kjQ3HWqR2Ck">questionable licensing</a>
or are
<a href="https://gitlab.synchro.net/main/sbbs/-/blob/master/src/sbbs3/zmodem.c">GPL’d</a>,
but I eventually found a
<a href="https://osdn.net/projects/ttssh2/scm/svn/blobs/head/trunk/teraterm/ttpfile/zmodem.c">BSD-licensed version from Tera Term</a>
that was easy to separate.</p>

<p>Integrating it with Subtext was
<a href="https://amendhub.com/jcs/subtext/amendments/zmodem.c">not terribly difficult</a>
but it did require a week of debugging with other terminal software to fix bugs
and set timeout limits appropriately.
There is still no ZMODEM support in the web front-end, so file transfers don’t
yet work there, and I’m sure there will be other minor compatibility issues that
need work, but to be honest, the file areas were barely used at all on the old
BBS.</p>

<h2 id="telnet-bots">Telnet Bots</h2>

<p>Once the new BBS was deployed last month, I started to get annoying bot traffic.
Thousands of bots and infected machines constantly scanning the internet are a
minor inconvenience to a modern server, but are troublesome to a very slow
server.
Every few minutes of every day, a random IP tries to login to my BBS with
default usernames and passwords like “root”, “sysadmin”, “enable”, etc.
If the connection is closed, they will try again, over and over as it runs
through its dictionary.
Since the Mac is very limited in resources, these connections can prevent
legitimate traffic from connecting or make their sessions very slow since the
BBS is using cooperative threading.</p>

<p>Subtext has a
<a href="https://amendhub.com/jcs/subtext/files/user.c#L27">list of banned usernames</a>
and when a login is attempted with one of these, the connection is dropped and
the
<a href="https://amendhub.com/jcs/subtext/amendments/150">IP is banned</a>.
Future connections from that IP will immediately close, but unfortunately there
is no way to refuse the connection before it opens so the BBS still has to do
its dance of accepting the new connection, then starting a new listening socket,
then closing the first connection.</p>

<p>A
<a href="https://amendhub.com/jcs/subtext/amendments/204">recent change</a>
goes a step further and sends a UDP packet to my OpenBSD firewall containing the
IP to be banned, and a small Ruby server running there adds the IP to a
<a href="https://man.openbsd.org/pf.conf#TABLES">pf table</a>,
immediately blocking all further IP access from the bot.</p>

<h2 id="future-work">Future Work</h2>

<p>I haven’t implemented SSH logins yet, which would also forward from the
OpenBSD firewall.
For my old Ruby BBS, it ran a small, custom
<a href="https://pkg.go.dev/golang.org/x/crypto/ssh">Go-based SSH server</a>.
When a user connected and provided a username and password over SSH, the Go SSH
server would connect to a local socket that the BBS was listening on and send
the username and password, the BBS server would authenticate it and respond with
an acknowledgment or failure, and if it succeeded, the Go SSH server would open
a new TCP connection to the BBS, proxying data between the BBS and the client.</p>

<p>I still need to implement this, but using the telnet client in-between.
The telnet protocol makes it easy to send data out-of-band, such as the
already-authenticated username.
However, since SSH-scanning bots are more prevalent and aggressive than the
occasional telnet-scanning bot, I’m not terribly motivated to write this new SSH
server.</p>

<h2 id="summary">Summary</h2>

<p>If you read this far and want to try out the BBS, you can
<a href="telnet://klud.ge">telnet to <code>klud.ge</code></a>,
call <code>+1 312-654-0090</code> with a modem (<code>8N1</code>),
or login with a fancy web browser at
<a href="https://klud.ge"><code>klud.ge</code></a>.
If the BBS doesn’t answer, please try again later as it might be seeing a large
spike in traffic (or has crashed and I’m scrambling to find the bug).</p>

<p>The freely-licensed C source code for the Subtext BBS server is available on
<a href="https://amendhub.com/jcs/subtext">AmendHub</a>.</p>

<p>If you’re interested in classic Mac development, check out my
<a href="https://jcs.org/system6c">C Programming on System 6 videos</a>
or chat with us in the
<a href="irc://irc.libera.chat/cyberpals"><tt>#cyberpals</tt></a>
IRC channel on
<a href="https://libera.chat/">Libera Chat</a>.</p>

</article></div>
  </body>
</html>
