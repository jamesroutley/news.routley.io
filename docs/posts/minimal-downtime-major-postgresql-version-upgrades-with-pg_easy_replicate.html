<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/shayonj/pg_easy_replicate">Original</a>
    <h1>Minimal downtime major PostgreSQL version upgrades with pg_easy_replicate</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><a href="https://github.com/shayonj/pg_easy_replicate/actions/workflows/ci.yaml"><img src="https://github.com/shayonj/pg_easy_replicate/actions/workflows/ci.yaml/badge.svg?branch=main" alt="CI"/></a>
<a href="https://badge.fury.io/rb/pg_easy_replicate" rel="nofollow"><img src="https://camo.githubusercontent.com/dd1bc69881776c15aa50e3cddefa6e760fcd12ea637950c4327f106896122d03/68747470733a2f2f62616467652e667572792e696f2f72622f70675f656173795f7265706c69636174652e737667" alt="Gem Version" data-canonical-src="https://badge.fury.io/rb/pg_easy_replicate.svg"/></a></p>
<p dir="auto"><code>pg_easy_replicate</code> is a CLI orchestrator tool that simplifies the process of setting up <a href="https://www.postgresql.org/docs/current/logical-replication.html" rel="nofollow">logical replication</a> between two PostgreSQL databases. <code>pg_easy_replicate</code> also supports switchover. After the source (primary database) is fully replicating, <code>pg_easy_replicate</code> puts it into read-only mode and via logical replication flushes all data to the new target database. This ensures zero data loss and minimal downtime for the application. This method can be useful for performing minimal downtime (up to &lt;1min, depending) major version upgrades between two PostgreSQL databases, load testing with blue/green database setup and other similar use cases.</p>
<p dir="auto">Battle tested in production at <a href="https://www.tines.com/" rel="nofollow">Tines</a> <g-emoji alias="rocket" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f680.png">ðŸš€</g-emoji></p>
<ul dir="auto">
<li><a href="#installation">Installation</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#limits">Limits</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#cli">CLI</a></li>
<li><a href="#replicating-all-tables-with-a-single-group">Replicating all tables with a single group</a>
<ul dir="auto">
<li><a href="#config-check">Config check</a></li>
<li><a href="#bootstrap">Bootstrap</a></li>
<li><a href="#start-sync">Start sync</a></li>
<li><a href="#stats">Stats</a></li>
<li><a href="#performing-switchover">Performing switchover</a></li>
</ul>
</li>
<li><a href="#replicating-single-database-with-custom-tables">Replicating single database with custom tables</a></li>
<li><a href="#switchover-strategies-with-minimal-downtime">Switchover strategies with minimal downtime</a>
<ul dir="auto">
<li><a href="#rolling-restart-strategy">Rolling restart strategy</a></li>
<li><a href="#dns-failover-strategy">DNS Failover strategy</a></li>
</ul>
</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Installation</h2>
<p dir="auto">Add this line to your application&#39;s Gemfile:</p>

<p dir="auto">And then execute:</p>

<p dir="auto">Or install it yourself as:</p>
<div data-snippet-clipboard-copy-content="$ gem install pg_easy_replicate"><pre><code>$ gem install pg_easy_replicate
</code></pre></div>
<p dir="auto">This will include all dependencies accordingly as well. Make sure the following requirements are satisfied.</p>
<p dir="auto">Or via Docker:</p>
<div data-snippet-clipboard-copy-content="docker pull shayonj/pg_easy_replicate:latest"><pre><code>docker pull shayonj/pg_easy_replicate:latest
</code></pre></div>
<p dir="auto"><a href="https://hub.docker.com/r/shayonj/pg_easy_replicate" rel="nofollow">https://hub.docker.com/r/shayonj/pg_easy_replicate</a></p>
<h2 tabindex="-1" dir="auto"><a id="user-content-requirements" aria-hidden="true" href="#requirements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Requirements</h2>
<ul dir="auto">
<li>PostgreSQL 10 and later</li>
<li>Ruby 2.7 and later</li>
<li>Database user should have permissions for <code>SUPERUSER</code></li>
<li>Both databases should have the same schema</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-limits" aria-hidden="true" href="#limits"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Limits</h2>
<p dir="auto">All <a href="https://www.postgresql.org/docs/current/logical-replication-restrictions.html" rel="nofollow">Logical Replication Restrictions</a> apply.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Usage</h2>
<p dir="auto">Ensure <code>SOURCE_DB_URL</code> and <code>TARGET_DB_URL</code> are present as environment variables in the runtime environment. The URL are of the postgres connection string format. Example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export SOURCE_DB_URL=&#34;postgres://USERNAME:PASSWORD@localhost:5432/DATABASE_NAME&#34;
$ export TARGET_DB_URL=&#34;postgres://USERNAME:PASSWORD@localhost:5433/DATABASE_NAME&#34;"><pre>$ <span>export</span> SOURCE_DB_URL=<span><span>&#34;</span>postgres://USERNAME:PASSWORD@localhost:5432/DATABASE_NAME<span>&#34;</span></span>
$ <span>export</span> TARGET_DB_URL=<span><span>&#34;</span>postgres://USERNAME:PASSWORD@localhost:5433/DATABASE_NAME<span>&#34;</span></span></pre></div>
<p dir="auto">Any <code>pg_easy_replicate</code> command can be run the same way with the docker image as well. As long the container is running in an environment where it has access to both the databases. Example</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run -e SOURCE_DB_URL=&#34;postgres://USERNAME:PASSWORD@localhost:5432/DATABASE_NAME&#34;  \
  -e TARGET_DB_URL=&#34;postgres://USERNAME:PASSWORD@localhost:5433/DATABASE_NAME&#34; \
  -it --rm shayonj/pg_easy_replicate:latest \
  pg_easy_replicate config_check"><pre>docker run -e SOURCE_DB_URL=<span><span>&#34;</span>postgres://USERNAME:PASSWORD@localhost:5432/DATABASE_NAME<span>&#34;</span></span>  \
  -e TARGET_DB_URL=<span><span>&#34;</span>postgres://USERNAME:PASSWORD@localhost:5433/DATABASE_NAME<span>&#34;</span></span> \
  -it --rm shayonj/pg_easy_replicate:latest \
  pg_easy_replicate config_check</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-cli" aria-hidden="true" href="#cli"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>CLI</h2>
<div dir="auto" data-snippet-clipboard-copy-content="$  pg_easy_replicate
pg_easy_replicate commands:
  pg_easy_replicate bootstrap -g, --group-name=GROUP_NAME    # Sets up temporary tables for information required during runtime
  pg_easy_replicate cleanup -g, --group-name=GROUP_NAME      # Cleans up all bootstrapped data for the respective group
  pg_easy_replicate config_check                             # Prints if source and target database have the required config
  pg_easy_replicate help [COMMAND]                           # Describe available commands or one specific command
  pg_easy_replicate start_sync -g, --group-name=GROUP_NAME   # Starts the logical replication from source database to target database provisioned in the group
  pg_easy_replicate stats  -g, --group-name=GROUP_NAME       # Prints the statistics in JSON for the group
  pg_easy_replicate stop_sync -g, --group-name=GROUP_NAME    # Stop the logical replication from source database to target database provisioned in the group
  pg_easy_replicate switchover  -g, --group-name=GROUP_NAME  # Puts the source database in read only mode after all the data is flushed and written
  pg_easy_replicate version                                  # Prints the version
"><pre>$  pg_easy_replicate
pg_easy_replicate commands:
  pg_easy_replicate bootstrap -g, --group-name=GROUP_NAME    <span><span>#</span> Sets up temporary tables for information required during runtime</span>
  pg_easy_replicate cleanup -g, --group-name=GROUP_NAME      <span><span>#</span> Cleans up all bootstrapped data for the respective group</span>
  pg_easy_replicate config_check                             <span><span>#</span> Prints if source and target database have the required config</span>
  pg_easy_replicate <span>help</span> [COMMAND]                           <span><span>#</span> Describe available commands or one specific command</span>
  pg_easy_replicate start_sync -g, --group-name=GROUP_NAME   <span><span>#</span> Starts the logical replication from source database to target database provisioned in the group</span>
  pg_easy_replicate stats  -g, --group-name=GROUP_NAME       <span><span>#</span> Prints the statistics in JSON for the group</span>
  pg_easy_replicate stop_sync -g, --group-name=GROUP_NAME    <span><span>#</span> Stop the logical replication from source database to target database provisioned in the group</span>
  pg_easy_replicate switchover  -g, --group-name=GROUP_NAME  <span><span>#</span> Puts the source database in read only mode after all the data is flushed and written</span>
  pg_easy_replicate version                                  <span><span>#</span> Prints the version</span>
</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-replicating-all-tables-with-a-single-group" aria-hidden="true" href="#replicating-all-tables-with-a-single-group"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Replicating all tables with a single group</h2>
<p dir="auto">You can create as many groups as you want for a single database. Groups are just a logical isolation of a single replication.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-config-check" aria-hidden="true" href="#config-check"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Config check</h3>
<div dir="auto" data-snippet-clipboard-copy-content="$ pg_easy_replicate config_check

âœ… Config is looking good."><pre>$ pg_easy_replicate config_check

âœ… Config is looking good.</pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-bootstrap" aria-hidden="true" href="#bootstrap"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Bootstrap</h3>
<p dir="auto">Every sync will need to be bootstrapped before you can set up the sync between two databases. Bootstrap creates a new super user to perform the orchestration required during the rest of the process. It also creates some internal metadata tables for record keeping.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ pg_easy_replicate bootstrap --group-name database-cluster-1

{&#34;name&#34;:&#34;pg_easy_replicate&#34;,&#34;hostname&#34;:&#34;PKHXQVK6DW&#34;,&#34;pid&#34;:21485,&#34;level&#34;:30,&#34;time&#34;:&#34;2023-06-19T15:51:11.015-04:00&#34;,&#34;v&#34;:0,&#34;msg&#34;:&#34;Setting up schema&#34;,&#34;version&#34;:&#34;0.1.0&#34;}
..."><pre>$ pg_easy_replicate bootstrap --group-name database-cluster-1

{<span><span>&#34;</span>name<span>&#34;</span></span>:<span><span>&#34;</span>pg_easy_replicate<span>&#34;</span></span>,<span><span>&#34;</span>hostname<span>&#34;</span></span>:<span><span>&#34;</span>PKHXQVK6DW<span>&#34;</span></span>,<span><span>&#34;</span>pid<span>&#34;</span></span>:21485,<span><span>&#34;</span>level<span>&#34;</span></span>:30,<span><span>&#34;</span>time<span>&#34;</span></span>:<span><span>&#34;</span>2023-06-19T15:51:11.015-04:00<span>&#34;</span></span>,<span><span>&#34;</span>v<span>&#34;</span></span>:0,<span><span>&#34;</span>msg<span>&#34;</span></span>:<span><span>&#34;</span>Setting up schema<span>&#34;</span></span>,<span><span>&#34;</span>version<span>&#34;</span></span>:<span><span>&#34;</span>0.1.0<span>&#34;</span></span>}
...</pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-start-sync" aria-hidden="true" href="#start-sync"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Start sync</h3>
<p dir="auto">Once the bootstrap is complete, you can start the sync. Starting the sync sets up the publication, subscription and performs other minor housekeeping things.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ pg_easy_replicate start_sync --group-name database-cluster-1

{&#34;name&#34;:&#34;pg_easy_replicate&#34;,&#34;hostname&#34;:&#34;PKHXQVK6DW&#34;,&#34;pid&#34;:22113,&#34;level&#34;:30,&#34;time&#34;:&#34;2023-06-19T15:54:54.874-04:00&#34;,&#34;v&#34;:0,&#34;msg&#34;:&#34;Setting up publication&#34;,&#34;publication_name&#34;:&#34;pger_publication_database_cluster_1&#34;,&#34;version&#34;:&#34;0.1.0&#34;}
..."><pre>$ pg_easy_replicate start_sync --group-name database-cluster-1

{<span><span>&#34;</span>name<span>&#34;</span></span>:<span><span>&#34;</span>pg_easy_replicate<span>&#34;</span></span>,<span><span>&#34;</span>hostname<span>&#34;</span></span>:<span><span>&#34;</span>PKHXQVK6DW<span>&#34;</span></span>,<span><span>&#34;</span>pid<span>&#34;</span></span>:22113,<span><span>&#34;</span>level<span>&#34;</span></span>:30,<span><span>&#34;</span>time<span>&#34;</span></span>:<span><span>&#34;</span>2023-06-19T15:54:54.874-04:00<span>&#34;</span></span>,<span><span>&#34;</span>v<span>&#34;</span></span>:0,<span><span>&#34;</span>msg<span>&#34;</span></span>:<span><span>&#34;</span>Setting up publication<span>&#34;</span></span>,<span><span>&#34;</span>publication_name<span>&#34;</span></span>:<span><span>&#34;</span>pger_publication_database_cluster_1<span>&#34;</span></span>,<span><span>&#34;</span>version<span>&#34;</span></span>:<span><span>&#34;</span>0.1.0<span>&#34;</span></span>}
...</pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-stats" aria-hidden="true" href="#stats"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Stats</h3>
<p dir="auto">You can inspect or watch stats any time during the sync process. The stats give you can an idea of when the sync started, current flush/write lag, how many tables are in <code>replicating</code>, <code>copying</code> or other stages, and more.</p>
<p dir="auto">You can poll these stats to perform any other after the switchover is done. The stats include a <code>switchover_completed_at</code> which is updated once the switch over is complete.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ pg_easy_replicate stats --group-name database-cluster-1

{
  &#34;lag_stats&#34;: [
    {
      &#34;pid&#34;: 66,
      &#34;client_addr&#34;: &#34;192.168.128.2&#34;,
      &#34;user_name&#34;: &#34;jamesbond&#34;,
      &#34;application_name&#34;: &#34;pger_subscription_database_cluster_1&#34;,
      &#34;state&#34;: &#34;streaming&#34;,
      &#34;sync_state&#34;: &#34;async&#34;,
      &#34;write_lag&#34;: &#34;0.0&#34;,
      &#34;flush_lag&#34;: &#34;0.0&#34;,
      &#34;replay_lag&#34;: &#34;0.0&#34;
    }
  ],
  &#34;message_lsn_receipts&#34;: [
    {
      &#34;received_lsn&#34;: &#34;0/1674688&#34;,
      &#34;last_msg_send_time&#34;: &#34;2023-06-19 19:56:35 UTC&#34;,
      &#34;last_msg_receipt_time&#34;: &#34;2023-06-19 19:56:35 UTC&#34;,
      &#34;latest_end_lsn&#34;: &#34;0/1674688&#34;,
      &#34;latest_end_time&#34;: &#34;2023-06-19 19:56:35 UTC&#34;
    }
  ],
  &#34;sync_started_at&#34;: &#34;2023-06-19 19:54:54 UTC&#34;,
  &#34;sync_failed_at&#34;: null,
  &#34;switchover_completed_at&#34;: null

  ...."><pre>$ pg_easy_replicate stats --group-name database-cluster-1

{
  <span><span>&#34;</span>lag_stats<span>&#34;</span></span>: [
    {
      <span><span>&#34;</span>pid<span>&#34;</span></span>: 66,
      <span><span>&#34;</span>client_addr<span>&#34;</span></span>: <span><span>&#34;</span>192.168.128.2<span>&#34;</span></span>,
      <span><span>&#34;</span>user_name<span>&#34;</span></span>: <span><span>&#34;</span>jamesbond<span>&#34;</span></span>,
      <span><span>&#34;</span>application_name<span>&#34;</span></span>: <span><span>&#34;</span>pger_subscription_database_cluster_1<span>&#34;</span></span>,
      <span><span>&#34;</span>state<span>&#34;</span></span>: <span><span>&#34;</span>streaming<span>&#34;</span></span>,
      <span><span>&#34;</span>sync_state<span>&#34;</span></span>: <span><span>&#34;</span>async<span>&#34;</span></span>,
      <span><span>&#34;</span>write_lag<span>&#34;</span></span>: <span><span>&#34;</span>0.0<span>&#34;</span></span>,
      <span><span>&#34;</span>flush_lag<span>&#34;</span></span>: <span><span>&#34;</span>0.0<span>&#34;</span></span>,
      <span><span>&#34;</span>replay_lag<span>&#34;</span></span>: <span><span>&#34;</span>0.0<span>&#34;</span></span>
    }
  ],
  <span><span>&#34;</span>message_lsn_receipts<span>&#34;</span></span>: [
    {
      <span><span>&#34;</span>received_lsn<span>&#34;</span></span>: <span><span>&#34;</span>0/1674688<span>&#34;</span></span>,
      <span><span>&#34;</span>last_msg_send_time<span>&#34;</span></span>: <span><span>&#34;</span>2023-06-19 19:56:35 UTC<span>&#34;</span></span>,
      <span><span>&#34;</span>last_msg_receipt_time<span>&#34;</span></span>: <span><span>&#34;</span>2023-06-19 19:56:35 UTC<span>&#34;</span></span>,
      <span><span>&#34;</span>latest_end_lsn<span>&#34;</span></span>: <span><span>&#34;</span>0/1674688<span>&#34;</span></span>,
      <span><span>&#34;</span>latest_end_time<span>&#34;</span></span>: <span><span>&#34;</span>2023-06-19 19:56:35 UTC<span>&#34;</span></span>
    }
  ],
  <span><span>&#34;</span>sync_started_at<span>&#34;</span></span>: <span><span>&#34;</span>2023-06-19 19:54:54 UTC<span>&#34;</span></span>,
  <span><span>&#34;</span>sync_failed_at<span>&#34;</span></span>: null,
  <span><span>&#34;</span>switchover_completed_at<span>&#34;</span></span>: null

  ....</pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-performing-switchover" aria-hidden="true" href="#performing-switchover"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Performing switchover</h3>
<p dir="auto"><code>pg_easy_replicate</code> doesn&#39;t kick off the switchover on its own. When you start the sync via <code>start_sync</code>, it starts the replication between the two databases. Once you have had the time to monitor stats and any other key metrics, you can kick off the <code>switchover</code>.</p>
<p dir="auto"><code>switchover</code> will wait until all tables in the group are replicating and the delta for lag is &lt;200kb (by calculating the <code>pg_wal_lsn_diff</code> between <code>sent_lsn</code> and <code>write_lsn</code>) and then perform the switch.</p>
<p dir="auto">The switch is made by putting the user on the source database in <code>READ ONLY</code> mode, so that it is not accepting any more writes and waits for the flush lag to be <code>0</code>. It is up to user to kick of a rolling restart of your application containers or failover DNS (more on these below in strategies) after the switchover is complete, so that your application isn&#39;t sending any read/write requests to the old/source database.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ pg_easy_replicate switchover  --group-name database-cluster-1

{&#34;name&#34;:&#34;pg_easy_replicate&#34;,&#34;hostname&#34;:&#34;PKHXQVK6DW&#34;,&#34;pid&#34;:24192,&#34;level&#34;:30,&#34;time&#34;:&#34;2023-06-19T16:05:23.033-04:00&#34;,&#34;v&#34;:0,&#34;msg&#34;:&#34;Watching lag stats&#34;,&#34;version&#34;:&#34;0.1.0&#34;}
..."><pre>$ pg_easy_replicate switchover  --group-name database-cluster-1

{<span><span>&#34;</span>name<span>&#34;</span></span>:<span><span>&#34;</span>pg_easy_replicate<span>&#34;</span></span>,<span><span>&#34;</span>hostname<span>&#34;</span></span>:<span><span>&#34;</span>PKHXQVK6DW<span>&#34;</span></span>,<span><span>&#34;</span>pid<span>&#34;</span></span>:24192,<span><span>&#34;</span>level<span>&#34;</span></span>:30,<span><span>&#34;</span>time<span>&#34;</span></span>:<span><span>&#34;</span>2023-06-19T16:05:23.033-04:00<span>&#34;</span></span>,<span><span>&#34;</span>v<span>&#34;</span></span>:0,<span><span>&#34;</span>msg<span>&#34;</span></span>:<span><span>&#34;</span>Watching lag stats<span>&#34;</span></span>,<span><span>&#34;</span>version<span>&#34;</span></span>:<span><span>&#34;</span>0.1.0<span>&#34;</span></span>}
...</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-replicating-single-database-with-custom-tables" aria-hidden="true" href="#replicating-single-database-with-custom-tables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Replicating single database with custom tables</h2>
<p dir="auto">By default all tables are added for replication but you can create multiple groups with custom tables for the same database. Example</p>
<div dir="auto" data-snippet-clipboard-copy-content="
$ pg_easy_replicate bootstrap --group-name database-cluster-1
$ pg_easy_replicate start_sync --group-name database-cluster-1 --schema-name public --tables &#34;users, posts, events&#34;

...

$ pg_easy_replicate bootstrap --group-name database-cluster-2
$ pg_easy_replicate start_sync --group-name database-cluster-2 --schema-name public --tables &#34;comments, views&#34;

...
$ pg_easy_replicate switchover  --group-name database-cluster-1
$ pg_easy_replicate switchover  --group-name database-cluster-2
..."><pre>$ pg_easy_replicate bootstrap --group-name database-cluster-1
$ pg_easy_replicate start_sync --group-name database-cluster-1 --schema-name public --tables <span><span>&#34;</span>users, posts, events<span>&#34;</span></span>

...

$ pg_easy_replicate bootstrap --group-name database-cluster-2
$ pg_easy_replicate start_sync --group-name database-cluster-2 --schema-name public --tables <span><span>&#34;</span>comments, views<span>&#34;</span></span>

...
$ pg_easy_replicate switchover  --group-name database-cluster-1
$ pg_easy_replicate switchover  --group-name database-cluster-2
...</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-switchover-strategies-with-minimal-downtime" aria-hidden="true" href="#switchover-strategies-with-minimal-downtime"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Switchover strategies with minimal downtime</h2>
<p dir="auto">For minimal downtime, it&#39;d be best to watch/tail the stats and wait until <code>switchover_completed_at</code> is updated with a timestamp. Once that happens you can perform any of the following strategies. Note: These are just suggestions and <code>pg_easy_replicate</code> doesn&#39;t provide any functionalities for this.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-rolling-restart-strategy" aria-hidden="true" href="#rolling-restart-strategy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Rolling restart strategy</h3>
<p dir="auto">In this strategy, you have a change ready to go which instructs your application to start connecting to the new database. Either using an environment variable or similar. Depending on the application type, it may or may not require a rolling restart.</p>
<p dir="auto">Next, you can set up a program that watches the <code>stats</code> and waits until <code>switchover_completed_at</code> is reporting as <code>true</code>. Once that happens it kicks off a rolling restart of your application containers so they can start making connections to the DNS of the new database.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-dns-failover-strategy" aria-hidden="true" href="#dns-failover-strategy"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>DNS Failover strategy</h3>
<p dir="auto">In this strategy, you have a weighted based DNS system (example <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-values-weighted.html" rel="nofollow">AWS Route53 weighted records</a>) where 100% of traffic goes to a primary origin and 0% to a secondary origin. The primary origin here is the DNS host for your source database and secondary origin is the DNS host for your target database. You can set up your application ahead of time to interact with the database using DNS from the weighted group.</p>
<p dir="auto">Next, you can set up a program that watches the <code>stats</code> and waits until <code>switchover_completed_at</code> is reporting as <code>true</code>. Once that happens it updates the weight in the DNS weighted group where 100% of the requests now go to the new/target database. Note: Keeping a low <code>ttl</code> is recommended.</p>
</article>
          </div></div>
  </body>
</html>
