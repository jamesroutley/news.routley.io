<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2022/05/31/power-on-tap-dynamic-control-of-p-cores-in-m1-chips/">Original</a>
    <h1>Power on Tap: Dynamic control of P cores in M1 chips</h1>
    
    <div id="readability-page-1" class="page"><article id="post-65728">
	
	<!-- .entry-header -->

	
		<div data-first_letter="S">
		<p>So far, I have concentrated on trying to understand how macOS allocates threads to the two different types of core in M1 series processors, and how running threads on the E cores can lead to increased energy efficiency. This article looks at how P core frequencies are controlled by macOS, and the dynamics of frequency change.</p>
<p><strong>Background</strong></p>
<p>There are two types of CPU core in M1 series chips:</p>
<ul>
<li>E cores contain roughly half the internal processing units of P cores, and have a maximum frequency of 2064 MHz.</li>
<li>P cores have a higher maximum frequency, of either 3204 MHz in the original M1, or 3228 MHz in M1 Pro/Max/Ultra.</li>
</ul>
<p>In this article, observations are limited to the cores in an M1 Max chip in a Mac Studio Max, which are essentially the same as those in the M1 Pro. These chips have 2 E cores and 8 P cores, arranged in three clusters: one cluster of two E cores, and two clusters P0 and P1 each containing four P cores. All cores within any given cluster are run at the same frequency, and generally (but not always) have their load balanced within that cluster.</p>
<p>macOS normally manages threads through Grand Central Dispatch using Quality of Service (QoS) settings. Those with the lowest QoS of 9 will only be run on the E cluster, while those with higher QoS can be assigned to either E or P clusters. macOS adopts a strategy where most, if not all, of its background tasks are run at lowest QoS. Most user tasks, including the GUI, are run on the P cores, unless they’re already fully loaded and the E cores available to take additional load.</p>
<p>A more detailed summary of previous work is in <a href="https://eclecticlight.co/2022/04/25/how-macos-manages-m1-cpu-cores/">this article</a> and many others here which precede it.</p>
<p>E cores are normally managed by macOS to run at frequencies of 600 MHz (idle), 972 MHz (one or few threads) or 2064 MHz (multiple threads). In observations of normal use, P cores are also seen to be operating at various intermediate frequencies between 600 and 3204/3228 MHz. These tests were designed to discover how macOS apparently manages P core frequencies more flexibly.</p>
<p><strong>Methods</strong></p>
<p>The only user-accessible tool which can provide measurements of power, frequency and active residency for cores and clusters is <code>powermetrics</code>. In these tests, <code>powermetrics</code> collected 100 <code>cpu_power</code> measurements for 50 ms periods while tasks lasting less than 5 seconds and consisting of fixed numbers of threads were performed using AsmAttic and Cormorant at various QoS settings.</p>
<p>Key among those were:</p>
<ul>
<li>Floating-point synthetic load in AsmAttic of 1-4 threads run at high QoS on cluster P0 alone</li>
<li>Floating-point synthetic load in AsmAttic of 50 short threads run at high QoS across all clusters</li>
<li>Apple Archive compression tasks in Cormorant of 4 threads at high QoS</li>
<li>Floating-point synthetic load in AsmAttic of 2 threads run at low QoS on the E cluster alone.</li>
</ul>
<p>Reported cluster power, HW active residency by frequency, and individual core total active residency were then analysed.</p>
<p><strong>Results</strong></p>
<p><span><img data-attachment-id="65723" data-permalink="https://eclecticlight.co/pcoredynamics1/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png" data-orig-size="1220,800" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pcoredynamics1" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=940" alt="pcoredynamics1" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png?w=1024 1024w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics1.png 1220w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>This graph shows an atypical result from a single-threaded synthetic task confined to the P0 cluster. Each point shown represents the value from one 50 ms sampling period, with only dominant frequencies shown. As active residency rose to 100% on the active core, frequency and power both rose. In this case, uniquely among these results, power spiked at over 2.5 W in the first period at 100% active residency; normally, power rose to its sustained level without that initial spike. Sustained high frequency was slower to attain than either high power or maximum active residency.</p>
<p>Once the thread(s) had completed, active residency, power and frequency all fell rapidly back to idle levels.</p>
<p>Detailed analysis of the <code>powermetrics</code> data showed a range of cluster frequencies in each sampling period prior to the sustained frequency being established. Although <code>powermetrics</code> doesn’t give frequency measurements by time within each sampling period, it does give the percentage active residency for each frequency measured during the sampling period. During the initial period of increasing frequency that represents the proportion of time in that sampling period during which the cluster was running at that frequency. It’s thus possible to estimate the duration of the on-ramp during which frequency is increasing, and the period within that spent at each frequency.</p>
<p>All tests on P cores showed an on-ramp lasting about 70 ms, the time taken for the cluster frequency to increase from 600 MHz at idle to exceed 3 GHz peak. Three different frequencies were seen for that peak: 3036 MHz, which was most common with more threads, 3132 MHz, seen with two threads, and the maximum frequency of 3228 MHz, which was usual with just one thread.</p>
<p><span><img data-attachment-id="65724" data-permalink="https://eclecticlight.co/pcoredynamics2/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png" data-orig-size="1000,800" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="pcoredynamics2" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=940" alt="pcoredynamics2" srcset="https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=940 940w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=150 150w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=300 300w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png?w=768 768w, https://eclecticlightdotcom.files.wordpress.com/2022/05/pcoredynamics2.png 1000w" sizes="(max-width: 940px) 100vw, 940px"/></span></p>
<p>This graph shows cluster frequency at different times during the on-ramp, estimated from figures for active residency by frequency across three consecutive collection periods. The line fitted has the quadratic equation</p>
<p>To confirm this, tests were run in which the duration of each task was about 30 ms, less than half the observed duration of the on-ramp. In those, active residency fell with thread completion before frequency could reach 3 GHz, demonstrating rapid response of control in returning frequency to 600 MHz once those shorter threads completed.</p>
<p>With the synthetic load, sustained power was 1000 mW for a single thread/core, increasing by 900 mW for each additional thread/core, to a maximum of 3700 mW. Those are about half the power required for Apple Archive compression, which reached a maximum of 7300 mW when run in four threads on the P0 cluster.</p>
<p>No significant off-ramp was seen on P cores. Within 5 ms of threads completing, cluster frequency fell to 600 MHz idle.</p>
<p>Repeating some of these tests on the E cores at a QoS of 9 showed no comparable on-ramp, although it wasn’t uncommon to see E cluster frequency rise first to 972 MHz before increasing to the maximum frequency of 2064 MHz within 15 ms. No significant off-ramp was observed in E cores, with their frequency falling to 972 or 600 MHz within 10 ms of threads completing.</p>
<p><strong>Conclusions</strong></p>
<ul>
<li>macOS runs P cores at two steady-state frequencies: idle at 600 MHz, and full speed, which can range between 3036, 3132 and 3228 MHz (3204 MHz on the original M1).</li>
<li>P cores typically take about 70 ms for their frequency to rise from idle to full speed.</li>
<li>Once threads complete on all P cores in a cluster, its frequency returns to 600 MHz idle almost immediately.</li>
<li>P cores run at intermediate frequencies with combinations of threads, and when threads complete during the on-ramp, before full speed is reached.</li>
<li>macOS runs E cores at three steady-state frequencies: idle at 600 MHz, economy at 972 MHz, and full speed at 2064 MHz. They don’t show significant on- or off-ramps, and intermediate frequencies appear uncommon.</li>
<li>P core frequency management is designed to deliver full power to complete threads quickly.</li>
<li>E core frequency management is designed to complete threads with efficiency of power used.</li>
</ul>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
