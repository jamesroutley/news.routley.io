<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.vamc19.dev/posts/dockerfile-copy-chmod/">Original</a>
    <h1>`COPY –chmod` reduced the size of my container image by 35%</h1>
    
    <div id="readability-page-1" class="page"><div>
  <article>
    
    
    <p>Earlier this week, I was writing a Dockerfile to download and run a binary when I noticed the image size was way more
than what I would expect. I’m using ubuntu:21.10 as the base image, which is about 70MB. The binary I’m running
is about 80MB. Other packages I’m installing would add 10-ish MB. But the image size is 267MB?</p>
<p>Clearly I’m doing something wrong. But what? My Dockerfile is fairly simple and, what I considered, idiomatic:</p>
<div><pre tabindex="0"><code data-lang="Dockerfile"><span><span><span>FROM</span><span> ubuntu:21.10 AS downloader</span><span>
</span></span></span><span><span><span></span><span># Install wget, gnupg; download a zip archive; verify checksum; unzip the binary</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>FROM</span><span> ubuntu:21.10</span><span>
</span></span></span><span><span><span></span><span>LABEL</span> ...<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>COPY</span> --from<span>=</span>downloader /bin/&lt;binary&gt; /bin/&lt;binary&gt;<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>RUN</span> apt-get update <span>&amp;&amp;</span> apt-get install -y openssl dumb-init iproute2 ca-certificates  <span>\
</span></span></span><span><span><span></span>    <span>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span>\
</span></span></span><span><span><span></span>    <span>&amp;&amp;</span> chmod +x /bin/&lt;binary&gt;<span>
</span></span></span><span><span><span></span>    <span>&amp;&amp;</span> mkdir -p &lt;couple of empty directories&gt; <span>\
</span></span></span><span><span><span></span>    <span>&amp;&amp;</span> ...<span>
</span></span></span><span><span><span></span>...<span>
</span></span></span></code></pre></div><p>I checked the history of the image to see the size of individual layers. The problem became very apparent…</p>
<div><pre tabindex="0"><code data-lang="cmd"><span><span>$ podman history vamc19/nomad:latest 
</span></span><span><span>ID            CREATED             CREATED BY                                     SIZE        COMMENT
</span></span><span><span>...    
</span></span><span><span>&lt;missing&gt;     36 minutes ago      /bin/sh -c apt-get update &amp;&amp; apt-get insta...  94.4 MB     
</span></span><span><span>374515aec770  36 minutes ago      /bin/sh -c # (nop) COPY file:6dbfa42743cc65... 87.7 MB     
</span></span><span><span>22cd380ad224  36 minutes ago      /bin/sh -c # (nop) LABEL maintainer=<span>&#34;Vamsi&#34;</span>... 0 B          FROM docker.io/library/ubuntu:21.10
</span></span><span><span>...
</span></span></code></pre></div><p>The layer created by <code>COPY</code> is 87.7MB, which is exactly the size of the extracted binary. So, that is normal. Why is the
layer created by <code>RUN</code> 94.4MB? What am I doing in it? I’m creating a couple of empty directories, running <code>chmod</code> on the
binary and installing 4 packages. Apt says the packages would only consume ~6MB of additional disk space and it is very
unlikely that these packages would do anything crazy post install. So, is <code>chmod</code> creating a problem?</p>
<p>To quickly test this, I removed <code>chmod</code> from <code>RUN</code> and rebuilt the image. And bingo - the image size is down to 174MB.
And the <code>RUN</code> layer’s size is down to 6.7MB. So, OverlayFS is copying the binary into <code>RUN</code> layer even though <code>chmod</code> is
only updating the metadata of the file…?</p>
<p>My understanding of CoW filesystems is very superficial - unless I write to a file, the filesystem would never
copy the file to upper layer. And since chmod is not writing to the binary (did file’s hash change?), it should not be
copied, correct? Obviously not. Honestly, I never thought about it. I looked up <a href="https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html#non-directories">OverlayFS’ documentation</a>.</p>
<blockquote>
<p>When a file in the lower filesystem is accessed in a way the requires write-access, such as opening for write access,
<strong><em>changing some metadata</em></strong> etc., the file is first copied from the lower filesystem to the upper filesystem (copy_up).</p>
</blockquote>
<p>Well, I have been doing it wrong all these years. I’ve written a lot of Dockerfiles with shell scripts in <code>COPY</code> and
<code>chmod</code> in <code>RUN</code>. Maybe I never realized this because these files are usually very small to make a noticable difference
in the image size.</p>
<p>So what’s the solution? In my case, since I’m using Podman (which uses Buildah), I can use <code>--chmod</code> arg with <code>COPY</code> to
copy a file and set proper permissions in the same layer. If you are using Docker, it is <a href="https://github.com/moby/moby/issues/34819#issuecomment-697130379">availabe</a> in
BuildKit.</p>
<p>Note that any metadata update will lead to the same result - not just <code>chmod</code>. Both Docker and Podman already support
<code>--chown</code> for both <code>COPY</code> and <code>ADD</code>. Maybe this should be added to the <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices">Dockerfile Best Practices</a> page.</p>

<p>PS: If you are wondering why a metadata update would make OverlayFS duplicate the entire file, it is for security
reasons. You can enable <a href="https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html#metadata-only-copy-up">“metadata only copy up”</a> feature which will only copy the metadata instead
of the whole file.</p>
<blockquote>
<p>Do not use metacopy=on with untrusted upper/lower directories. Otherwise it is possible that an attacker can create a
handcrafted file with appropriate REDIRECT and METACOPY xattrs, and gain access to file on lower pointed by REDIRECT.
This should not be possible on local system as setting “trusted.” xattrs will require CAP_SYS_ADMIN. But it should be
possible for untrusted layers like from a pen drive.</p>
</blockquote>

    
  </article>
</div></div>
  </body>
</html>
