<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/904776/aa7224d94a7c43c0/">Original</a>
    <h1>The growing image-processor unpleasantness</h1>
    
    <div id="readability-page-1" class="page"><p>

<h2>[LWN subscriber-only content]</h2>
</p><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://lwn.net/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>
<p>
There was a time when care had to be taking when buying hardware if the
goal was to run Linux on it.  The situation has improved considerably in
recent decades, and unsupported hardware is more the exception than the
rule.  That has, for many years, been especially true of Intel hardware;
that company has made a point of ensuring that its offerings work with
Linux.  So it is a bit surprising that the IPU6 image processor shipped
with <a href="https://en.wikipedia.org/wiki/Alder_Lake">Alder Lake</a> CPUs
lacks support in Linux, and is unlikely to get it anytime soon.  The
problem highlighted here goes beyond just Intel, though.
</p><p>
The IPU6, like most image processors, exists to accept a data stream from a
camera sensor and turn it into a useful video stream.  These processors can
take on a lot of tasks, including rotation, cropping, zooming, color-space
conversion, white-balance correction, noise removal, focus management, and
more.  They are complex 
devices; the kernel community has responded by creating some equally
complex APIs, including <a href="https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html">Video4Linux2</a>
(V4L2) and <a href="https://www.kernel.org/doc/html/latest/userspace-api/media/mediactl/media-controller.html">media
controller</a>, to allow user space to manage them.  As long as a device
comes with a suitable driver, the kernel can make a camera device available
to user space which, with care, can work with it without needing
to know the details of the hardware.
</p><p>
As Paul Menzel recently <a href="https://lwn.net/ml/linux-kernel/52c87d91-422d-fca0-4dd5-bbaa559c81b6@molgen.mpg.de/">pointed
out</a> on the linux-kernel mailing list, there is no such driver for the
IPU6, so a mainline Linux kernel cannot drive it.  As a result, the kernel
lacks support for <a href="https://www.mipi.org/specifications/csi-2?hsLang=en">MIPI</a> cameras
on some current laptops, including some 
versions of the Thinkpad X1 Carbon and Dell XPS 13, which are relatively
popular with Linux users (cameras using other interfaces, such as USB UVC,
are generally supported).  To get around this problem, Dell ships a
closed-source, user-space driver in the Ubuntu build it offers on the
XPS 13.  Lenovo, instead, <a href="https://lwn.net/ml/linux-kernel/9a396cc3-5b0f-6db3-bad5-b4d81ecdf834@lenovo.com/">is
not selling</a> the affected systems with Linux preloaded at all at this
point.  

</p><p>
Laurent Pinchart <a href="https://lwn.net/ml/linux-kernel/YvUKLbv%2FpOfbbeL+@pendragon.ideasonboard.com/">provided
more details</a> on this situation.  IPU6 support on Ubuntu is based on a
kernel driver that provides a V4L2 interface, but which interfaces with a
proprietary user-space driver to actually get the work done.  As Ubuntu&#39;s
<a href="https://wiki.ubuntu.com/Dell">Dell page</a> notes, this solution
is not without its costs: &#34;<q>CPU performance is impacted by a daemon doing
buffer copying for v4l2 loopback device</q>&#34; and the camera can only
provide 720p resolution.  Pinchart went on to say that
the IPU6 will not be the only problematic device out there:
</p><blockquote>
	Given the direction the industry is taking, this situation will
	become increasingly common in the future. With the notable
	exception of Raspberry Pi who is leading the way in open-source
	camera support, no SoC vendor is willing today to open their
	imaging algorithms.
</blockquote>
<p>
Improving this situation will require work on a couple of fronts.  On the
user-space side, Pinchart pointed out that the <a href="https://libcamera.org/">libcamera project</a> was created for the
explicit purpose of
supporting complex devices like the IPU6; this project was <a href="https://lwn.net/Articles/794555/">covered here</a> in 2019.  Among other things,
libcamera was designed to allow the plugging-in of proprietary
image-processing code while maximizing free-software choice.  It currently
supports the earlier IPU3 processor either with or without the proprietary
plugin, though not all functionality is available without it.
</p><p>
Providing a similar level of support for the IPU6 should be possible, but
it will take a fair amount of work.  It also is going to need a proper
kernel driver for the IPU6, which could be a problem.  Evidently, the
complexity of this device is such that the V4L2 API cannot support it, so a
new API will be required.

A candidate API exists in a preliminary form; it is called CAM (or KCAM) and,
<a href="https://lwn.net/ml/linux-kernel/YvmqL6Wz7o77ukF5@google.com/">according to Sergey
Senozhatsky</a>, the plan is to get that merged into the kernel, then to
add an IPU6 driver that implements this API.  Pinchart <a href="https://lwn.net/ml/linux-kernel/YvnYJut3qIvIMVWa@pendragon.ideasonboard.com/">responded</a>
that this merging will not happen quickly because the API, as proposed, is
not seen favorably in the kernel community.
</p><p>
The V4L2 API has required extensive development and evolution over many
years to reach its current point; it will not be replaced overnight.  That
is doubly true if the proposed alternative has been developed in isolation
and never been through any sort of public discussion, which is the case
here.  Senozhatsky <a href="https://lwn.net/ml/linux-kernel/YvnrJBI8599+E43T@google.com/">posted</a> a pointer
to <a href="https://chromium-review.googlesource.com/c/chromiumos/third_party/kernel/+/3668500/">a
repository</a> containing a CAM implementation, but that code is only
enlightening in the 
vaguest terms.  There is no documentation and no drivers actually
implementing this API.  It is highly abstracted; as Sakari Ailus <a href="https://lwn.net/ml/linux-kernel/YvoWSyWmmLvbW4Mr@paasikivi.fi.intel.com/">put
it</a>: &#34;<q>I wouldn&#39;t have guessed this is an API for cameras if
I hadn&#39;t been told so</q>&#34;.
</p><p>
Creating a new camera API will be, as Ailus <a href="https://lwn.net/ml/linux-kernel/YvyiLHBgRQ9XsTrW@paasikivi.fi.intel.com/">described
it</a>,  &#34;<q>a major and risky endeavour</q>&#34;; it
will require a long 
conversation, and it&#39;s not clear that CAM has moved the clock forward by
much.  <a href="https://lwn.net/ml/linux-kernel/YvnwtN1SwQjilJ97@google.com/">According to
Senozhatsky</a>, the CAM code will not be submitted upstream for
&#34;<q>several months</q>&#34;.  He later <a href="https://lwn.net/ml/linux-kernel/Yvn0o96K8j5gRaWM@google.com/">suggested</a> that
this plan could be accelerated, but the fact remains that the community has
not even begun the process of designing an API that is suitable for the
next generation of image processors.
</p><p>
The bottom line is that purchasers of Linux systems are going to have to be
more careful for some time; many otherwise nice systems will not work fully
without a proprietary camera driver and, as a result, will lack support in
many distributions.  Making this hardware work at all will involve losing
CPU performance to the current workaround.  Working 
all of this out is likely to take years and, even then, it&#39;s not clear that
there will be viable free-software solutions available.  It is a
significant step backward for Intel, for Linux, and for the industry as a
whole.</p>
               </div></div>
  </body>
</html>
