<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/">Original</a>
    <h1>Raspberry Pi security alarm – the basics</h1>
    
    <div id="readability-page-1" class="page"><div><p>In November last year — I started building a DIY security alarm system, using a Raspberry Pi as the controller. My plan was to make a self-sustained system, using proper alarm hardware — like PIR sensors and sirens.</p>
<p>Integration with <a href="https://www.home-assistant.io/">Home Assistant</a> would be an add-on, not a requirement. I wanted the system to be as redundant and fault-tolerant as I could make it.</p>
<p>This is a pretty long story, with some twists and turns — let’s get into it 👇</p>
<details>
  <summary>
    
  </summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#why">Why?</a></li>
      </ul>
    </li>
    <li><a href="#the-plan">The plan</a></li>
    <li><a href="#raspberry-pi">Raspberry Pi</a></li>
    <li><a href="#electronics">Electronics</a></li>
    <li><a href="#enclosure">Enclosure</a></li>
    <li><a href="#operation">Operation</a>
      <ul>
        <li><a href="#features">Features</a></li>
        <li><a href="#arming-and-disarming">Arming and disarming</a></li>
        <li><a href="#armed-home">Armed home</a></li>
        <li><a href="#armed-away">Armed away</a></li>
        <li><a href="#triggered-mode">Triggered mode</a></li>
        <li><a href="#zone-timers">Zone timers</a></li>
        <li><a href="#door-open-notification">Door open notification</a></li>
        <li><a href="#system-checks">System checks</a></li>
      </ul>
    </li>
    <li><a href="#sensors-sirens-and-keypad">Sensors, sirens, and keypad</a>
      <ul>
        <li><a href="#wireless-hardware">Wireless hardware</a></li>
        <li><a href="#wired-hardware">Wired hardware</a></li>
      </ul>
    </li>
    <li><a href="#software">Software</a>
      <ul>
        <li><a href="#python-script">Python script</a></li>
        <li><a href="#configuration">Configuration</a></li>
        <li><a href="#mqtt-payload">MQTT payload</a></li>
        <li><a href="#mqtt-broker">MQTT broker</a></li>
        <li><a href="#home-assistant">Home Assistant</a></li>
      </ul>
    </li>
    <li><a href="#ending-thoughts">Ending thoughts</a></li>
  </ul>
</nav>
</details>

<h2 id="introduction">Introduction <a href="#introduction"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>This is one blog post I’ve been putting of for a while — there is just so much to tell, and the system is still a work-in-progress. I will be splitting it up into multiple posts; starting at the beginning 🙂</p>
<h3 id="why">Why? <a href="#why"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>I’ve wanted a security alarm system for a while now, but I loathe the companies providing it here in Norway. Yes <em>Verisure</em> and <em>Sector Alarm</em> — I’m talking about you guys.</p>
<p>They charge an absurdly high monthly fee, and seems dedicated to get as much money from you as they possibly can. While offering no integrations with things like Home Assistant — they want you vendor locked to their system.</p>
<p>To add insult to injury; they both got fined last year for <a href="https://konkurransetilsynet.no/illegal-competition/?lang=en">cooperation that restricts competition</a> 😞 Combined they got fined 1.233 million NOK.</p>
<p>Making my own alarm system seemed like a cool challenge, that would eventually result in something useful 🙂</p>
<h2 id="the-plan">The plan <a href="#the-plan"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>Like I wrote; my plan changed multiple times. But the overall goal stayed the same, let’s go through that now.</p>
<p>I wanted to use a controller I could SSH into and easily make changes and adjustments. Enter the Raspberry Pi — it has a generous amount of GPIO pins, and libraries to make them easily accessible from a Python script.</p>
<p>I started with a Raspberry Pi Zero W, but later changed to a Raspberry Pi 3+. I needed something a bit more powerful, and with wired Ethernet — I didn’t want to rely on Wi-Fi, especially inside a grounded metal cabinet 😛</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211120_211703_hu96b63fe4f23c1506621ae6c48760c64d_484508_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Raspberry Pi Zero W and self-built interface circuit board"/>
  </picture>
  </a><figcaption>Raspberry Pi Zero W and self-built interface circuit board</figcaption></figure>

<p>Next I wanted the ability to use any kind of sensor and hardware — wired and wireless. Wired things would connect to the Raspberry Pi GPIO pins, and wireless through Zigbee using <a href="https://www.zigbee2mqtt.io/">Zigbee2MQTT</a> as I described in the <a href="https://blog.cavelab.dev/2021/11/home-assistant-manual-alarm/">previous post in this series</a>.</p>
<p>I’m a firm believer that everything that can be hardwired — should be hardwired, but for some things, like door sensors, it’s just not practical.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_205207_hu0d6a69c0a5016e73acfad0111a7a5e34_665980_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Zigbee CC2652P coordinator v4 USB stick"/>
  </picture>
  </a><figcaption>Zigbee CC2652P coordinator v4 USB stick</figcaption></figure>

<p>For the enclosure I started with a 200×120×75mm plastic box, but in time I realized that it wasn’t going to be big enough. Then I ordered a 400×300×150 mm metal cabinet — but soon after; I decided that the system needed a backup battery, and I needed an ever bigger enclosure.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211206_151340_hu152fc353191a826c3f94aceee0864b1f_494185_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Small plastic enclosure — with DIN rail, terminal blocks, and cable glands"/>
  </picture>
  </a><figcaption>Small plastic enclosure — with DIN rail, terminal blocks, and cable glands</figcaption></figure>

<p>So I ordered another metal cabinet, measuring 500×300×210 mm — and this is the one I ended up using 🙂</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211216_142028_hu92915231ac1e056e5eb7bcf780a8f2a9_642310_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Big metal cabinet, ELDON MAS0503021R5, with DIN rails"/>
  </picture>
  </a><figcaption>Big metal cabinet, ELDON MAS0503021R5, with DIN rails</figcaption></figure>

<p>Later on in the project I started worrying about the Python script dying while the sirens were turned on — which would have been a disaster. So I decided to include an Arduino microcontroller as a monitoring and fail-safe solution, but I think that story is better suited for a later blog post in this series.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211230_011223_hu8b7fe673c4212792afb1db12574096f3_772108_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Arduino Nano on self-built interface circuit board"/>
  </picture>
  </a><figcaption>Arduino Nano on self-built interface circuit board</figcaption></figure>

<h2 id="raspberry-pi">Raspberry Pi <a href="#raspberry-pi"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>As the main controller; I’m using a Raspberry Pi 3+ — it has a decent CPU and 1 GB RAM, together with an Ethernet and USB ports.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211225_224124_hu4b99e81cf368c40995de4bc93e7697e4_640215_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Raspberry Pi 3+ and self-built interface circuit board"/>
  </picture>
  </a><figcaption>Raspberry Pi 3+ and self-built interface circuit board</figcaption></figure>

<p>On the Raspberry Pi I:</p>
<ul>
<li>Added a new user, and deleted the default user <code>pi</code></li>
<li>Installed all updates and set the time zone</li>
<li>Install Supervisor, Vim, and Git</li>
<li>Installed Python libraries for MQTT and serial communication</li>
<li>Added my user to the <code>gpio</code> and <code>dialout</code> groups</li>
<li>Made a configuration file for Supervisor to make sure the alarm script was always running</li>
</ul>
<div><pre tabindex="0"><code data-lang="plain"><span><span>$ sudo userdel -r pi
</span></span><span><span>$ sudo apt update &amp;&amp; sudo apt upgrade
</span></span><span><span>$ sudo dpkg-reconfigure tzdata
</span></span><span><span>$ sudo apt install supervisor vim git
</span></span><span><span>
</span></span><span><span>$ sudo apt install python3-paho-mqtt python3-serial
</span></span><span><span>$ sudo adduser hebron gpio dialout
</span></span><span><span>
</span></span><span><span>$ sudo cp supervisor/alarm.conf /etc/supervisor/conf.d/
</span></span><span><span>$ sudo systemctl restart supervisor.service
</span></span></code></pre></div><p>My Supervisor program definition looks like this:</p>
<div><pre tabindex="0"><code data-lang="ini"><span><span><span>[program:alarm]</span>
</span></span><span><span><span>command</span><span>=</span><span>python3 alarm.py</span>
</span></span><span><span><span>directory</span><span>=</span><span>/home/hebron/rpi-alarm</span>
</span></span><span><span><span>autostart</span><span>=</span><span>true</span>
</span></span><span><span><span>autorestart</span><span>=</span><span>unexpected</span>
</span></span><span><span><span>user</span><span>=</span><span>hebron</span>
</span></span><span><span><span>stderr_logfile</span><span>=</span><span>syslog</span>
</span></span><span><span><span>stdout_logfile</span><span>=</span><span>syslog</span>
</span></span></code></pre></div><h2 id="electronics">Electronics <a href="#electronics"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>I made a circuit board to step down 12 volts to 5 — for the Raspberry Pi, and handle all the inputs and outputs. 7 outputs and 8 inputs, which I later expanded to 8 outputs and 13 inputs 🙂</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211117_231817_hu76ad55db6a34d901d43c3744ec8ccf88_821456_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Raspberry Pi Zero W and self-built interface circuit board"/>
  </picture>
  </a><figcaption>Raspberry Pi Zero W and self-built interface circuit board</figcaption></figure>

<p>The board has red and green LEDs, showing the status of the system:</p>
<ul>
<li>Slow flashing green: everything OK, unarmed</li>
<li>Fast flashing green: everything OK, armed</li>
<li>Flashing red: there is a problem</li>
<li>Steady or no light: dead/script not running 💀</li>
</ul>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_214947_hu4684bbcf040033cd15f893dbe344b951_502563_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Pull up resistors and status LEDs on interface circuit board"/>
  </picture>
  </a><figcaption>Pull up resistors and status LEDs on interface circuit board</figcaption></figure>

<p>On the interface board is:</p>
<ul>
<li>Darlington-driver for outputs</li>
<li>Pull up resistors for inputs (330 Ω and 10 kΩ)</li>
<li>Voltage step-down buck converter, with a diode for reverse polarity protection</li>
</ul>
<p>
  The buzzer didn’t play nice with the Darlington-driver I’m using, it caused leak current on other outputs. I used a NPN transistor for it instead, which solved that problem.
</p>

<p>The two boards are connected with Dupoint jumper wires. I had to use 18 AWG wire for the power — to prevent the voltage dropping below 5 V. Both cards are mounted to a styrene plastic sheet using brass stand-offs. On the backside is a DIN rail mounting bracket.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211226_152106_hudb276fed02ebbe8c8f45f9a1cc16d690_799182_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Dupoint jumper wires between Raspberry Pi and interface board"/>
  </picture>
  </a><figcaption>Dupoint jumper wires between Raspberry Pi and interface board</figcaption></figure>

<p>Here are the parts I used for the Raspberry Pi, and power and interface board:</p>




    <ul>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Darlington-driver, 7 step, ULN2003A, DIL16, In: 2.7K/5V
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        DIL socket, 16-pin, 7.62mm
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Diode, rectifier, 1 A, 400V, 1N4004
    </li>
	
    <li>
        <strong>20</strong>
        <i><small>×</small></i>
        Jump/dupont wire, female-female, 20cm, 2.54mm
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        LED 3mm, Green, 1.9-2.1V, 20mA, 10000-12000mcd
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        LED 3mm, Red, 1.9-2.1V, 20mA, 3000-4000mcd
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        microSDHC card, Samsung EVO, 32GB, UHS-1, 100MB/s
    </li>
	
    <li>
        <strong>2</strong>
        <i><small>×</small></i>
        Mounting bracket, DIN rail, Plastic
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        PCB, stripboard prototyping, 94x53mm, 50cm2
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Raspberry Pi 3 Model B, 1.2GHz Quad 64bit, 1GB RAM, BT, WLAN
    </li>
	
    <li>
        <strong>15</strong>
        <i><small>×</small></i>
        Resistor, carbon film, 0.25W, 330 Ω, 5%
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Resistor, carbon film, 0.25W, 4.7 kΩ, 5%
    </li>
	
    <li>
        <strong>13</strong>
        <i><small>×</small></i>
        Resistor, carbon film, 0.25W, 10 kΩ, 5%
    </li>
	
    <li>
        <strong>8</strong>
        <i><small>×</small></i>
        Stand-off PCB, M3, male-female, 10+6 mm, brass
    </li>
	
    <li>
        <strong>12</strong>
        <i><small>×</small></i>
        Straight pin header, female, Single row, 2.54mm
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Straight pin header, male, Dual row, 2.54mm
    </li>
	
    <li>
        <strong>55</strong>
        <i><small>×</small></i>
        Straight pin header, male, Single row, 2.54mm
    </li>
	
    <li>
        <strong>125</strong>
        <i><small>cm2</small></i>
        Styrene plastic sheet, 3.2 mm
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Transistor, NPN, 100 mA, 45V, 0.5W, BC547B
    </li>
	
    <li>
        <strong>1</strong>
        <i><small>×</small></i>
        Voltage step-down buck converter, In: 7-28V, Out: 5V/3A
    </li>
	
    <li>
        <strong>0.3</strong>
        <i><small>m</small></i>
        Wire, stranded, 2-cores, 0.75mm2, Red/Black
    </li>
	
    </ul>


<p>Below is an early test of the Python script on the Raspberry Pi Zero W, and Home Assistant integration:</p>
<video controls="" preload="none" width="1920" height="1080" poster="https://blog.cavelab.dev/video/c2d7d3f5-d272-4e83-88c3-09ed4cebdc32/thumbnail_05.jpg" data-setup="{}" crossorigin="anonymous">
  <source src="https://video.cavelab.dev/c2d7d3f5-d272-4e83-88c3-09ed4cebdc32/hls/master.m3u8" type="application/x-mpegURL"/>
  <source src="https://video.cavelab.dev/c2d7d3f5-d272-4e83-88c3-09ed4cebdc32/play_720p.mp4" type="video/mp4"/>
</video>

<h2 id="enclosure">Enclosure <a href="#enclosure"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>I’m delighted that I decided to get a large enclosure. There are more space efficient ways of doing it — but I like to have some room to work 🙂</p>
<p>The terminal blocks take up a fair bit of DIN-rail length, but having the wire connections clear and easy is definitely worth it.</p>
<p>I mounted three rows of DIN-rail:</p>
<ol>
<li>Sensor terminal blocks, Raspberry Pi, and interface board</li>
<li>Output terminal blocks, auxiliary I/O, supporting controllers, and relays</li>
<li>230V, fuses, and power distribution</li>
</ol>
<p>One strip-board on the 2nd row has been left unpopulated — the initial plan was to use an AVR microcontroller board for all the tamper circuits. But I’ve put that off for now.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220107_233941_hu65cd78c6d97abfca4e468d265932341e_1027011_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Components on mounting plate for metal cabinet"/>
  </picture>
  </a><figcaption>Components on mounting plate for metal cabinet</figcaption></figure>

<p>The cabinet has both a mounting and gland plate. A mounting plate is the removable plate that everything is mounted to — this is a huge advantage when doing the initial install.</p>
<p>The gland plate is a removable plate to drill holes for cable glands — being removable makes it a lot easier, as you can use a drill press. I’ve mounted my cabinet with the gland plate on top, since that’s where the cables will enter the cabinet.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133413_hu5f83a1b8e300fa324f8e1fd915cb941d_908052_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Inside metal cabinet, ELDON MAS0503021R5"/>
  </picture>
  </a><figcaption>Inside metal cabinet, ELDON MAS0503021R5</figcaption></figure>

<p>The 230 V power outlet is for a CTEK battery charger that will charge the backup battery. I’ve left enough space available to fit one, or two, 7.2Ah lead-acid batteries. I’ll write more about that later in the blog post series.</p>
<p>Excuse the current rat’s nest of cables, I’m still in the installation phase — or so I tell myself.</p>
<h2 id="operation">Operation <a href="#operation"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>There is just too much going on to explain it all in one sitting, so I’ll cover more of the functionality in future blog posts. For now; I’ll briefly explain the core security alarm functions — armed home, and away — and a few supporting functions.</p>
<figure>
    <video width="854" height="480" poster="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220122_105339.mp4.jpg" controls="" loop="" muted="" preload="none">
        <source src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220122_105339.mp4" type="video/mp4"/>
    </video><figcaption>Some glorious blinkenlights</figcaption></figure>

<h3 id="features">Features <a href="#features"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>There is a rough overview of the currently implemented features:</p>
<ul>
<li>Supports both hardwired and MQTT sensors and outputs</li>
<li>Support for multiple MQTT alarm panels, with set states †</li>
<li>Home Assistant integration with auto discovery</li>
<li>Push messages using <a href="https://pushover.net/">Pushover</a></li>
<li>Heartbeat monitoring using <a href="https://healthchecks.io/">Healthchecks</a></li>
<li>Fail-safe and monitoring with an Arduino †</li>
<li>Personal PIN-codes</li>
<li>Configurable zones with delay and direct trigger</li>
<li>Home and away arm mode, with configurable zones</li>
<li>Water sensor support †</li>
<li>Panic and emergency alarms</li>
<li>Zone timers, to use as triggers in Home Assistant automations</li>
<li>Front door open warning</li>
<li>Several system checks</li>
<li>Lead-acid battery backup, with charger †</li>
</ul>
<p>
  † : Will be further explained in future blog posts.
</p>

<h3 id="arming-and-disarming">Arming and disarming <a href="#arming-and-disarming"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>The system supports multiple MQTT alarm panels — as well as the Home Assistant <a href="https://www.home-assistant.io/integrations/alarm_control_panel.mqtt/">MQTT alarm control panel</a>.</p>
<p>The panels have no knowledge of PIN codes — they only send what has been entered, along with the chosen action. The system checks if the received PIN code belongs to a user — if so, the action is valid.</p>
<p>If the wrong code is entered multiple times, a system fault is set — notifying the system owner.</p>
<h3 id="armed-home">Armed home <a href="#armed-home"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>When the system is armed home; only the peripheral zones, such as doors and windows, are armed. The alarm will trigger immediately if any zones are opened, bypassing the entry delay.</p>
<h3 id="armed-away">Armed away <a href="#armed-away"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>Both entry and exit delays are used when the system is armed away. All zones are monitored, but some have delay enabled.</p>
<p>If a zone with delay is activated the system will enter pending mode, aka entry delay, giving the user time to input the PIN code and disarm the system.</p>
<p>If a zone without delay is activated — the alarm will directly trigger, even when in pending mode.</p>
<h3 id="triggered-mode">Triggered mode <a href="#triggered-mode"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>Triggered mode means the alarm has been triggered — the indoor siren start immediately, while the outdoor siren starts when ⅓ (one third) of the configured trigger time has passed.</p>
<p>So if the trigger time is 60 seconds, the outdoor siren will be delayed by 20 seconds.</p>
<h4 id="panic-and-emergency">Panic and emergency <a href="#panic-and-emergency"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h4>
<p>If supported by the keypad; the system can also enter triggered mode on panic or emergency.</p>
<p>Panic will trigger the regular alarm, with sirens — while emergency only gives a short signal to confirm, but alerts by push message as usual.</p>
<h3 id="zone-timers">Zone timers <a href="#zone-timers"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>Zone timers can be configured with one, or many zones, and a timeout value in seconds. They simplify the process of setting up automations in Home Assistant based on multiple zones, such as motion activated lights — based on several motion sensors.</p>
<p>A zone timer can be cancelled manually.</p>
<h3 id="door-open-notification">Door open notification <a href="#door-open-notification"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>If the front door is left open — a short buzzer signal will sound, as a reminder to close the door. The buzzer signal will gradually increase in intensity if the door is left open.</p>
<h3 id="system-checks">System checks <a href="#system-checks"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>The system keeps track of several statuses, and a notification is sent if a problem is detected.</p>
<p>The following conditions are monitored:</p>
<ul>
<li>Backup battery voltage</li>
<li>Cabinet temperature</li>
<li>Number of failed PIN code attempts</li>
<li>System and zone tamper</li>
<li>Heartbeat ping</li>
<li>Mains power present</li>
<li>MQTT connected</li>
<li>Sensors are alive</li>
<li>Sensor link quality and battery</li>
<li>Siren relay works</li>
<li>Zigbee bridge available</li>
</ul>
<p><a href="https://healthchecks.io/">Healthchecks</a> is used to externally monitor the system, and will notify if it stops receiving heartbeat pings.</p>
<h2 id="sensors-sirens-and-keypad">Sensors, sirens, and keypad <a href="#sensors-sirens-and-keypad"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>I consider all wireless communication to be varying degrees of unreliable — wired is always better than wireless. The wired sensors and devices are very reliable, have a battery backup, and no external dependencies.</p>
<p>While the wireless Zigbee sensors can have communication problems — and relies on a Docker container running Zigbee2MQTT, a MQTT broker, and network communication between the mentioned hosts and the Raspberry Pi. Backup power is provided by a UPS, but the run-time is limited.</p>
<p>I’ve tried to design the system in such a way that the core functionality will be operational — despite all external systems being offline. Even operate for days on battery backup.</p>
<h3 id="wireless-hardware">Wireless hardware <a href="#wireless-hardware"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>I’m currently using a Climax KP-23EL-ZBS-ACE keypad, located in the entryway, to arm and disarm the system. It works — but doesn’t support set states. Meaning that the panel doesn’t give any feedback of the current alarm state.</p>
<p>The user isn’t left completely in the dark though, as the buzzer is used to signal alarm state changes. But I’m planning to explore other alarm panels in the future 🙂</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201539_hud794482a7953bb8b3d28b4dafc9c01ff_697614_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Climax KP-23EL-ZBS-ACE keypad"/>
  </picture>
  </a><figcaption>Climax KP-23EL-ZBS-ACE keypad</figcaption></figure>

<p>For door and window sensors; I’m using Aqara MCCGQ11LM. It’s small, the battery lasts a long time, and they seem very reliable.</p>
<p>Ideally I’d like wired door sensors, but I don’t see that happening… It’s just not practical to retrofit those with the wires hidden.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201549_hu8acbc6dd4a823cf97eaafbcf7c14fba7_375079_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Aqara MCCGQ11LM door/window sensor"/>
  </picture>
  </a><figcaption>Aqara MCCGQ11LM door/window sensor</figcaption></figure>

<p>I also have a couple of Aqara RTCGQ11LM motion sensors — but those I use mainly as temporary sensors until I can get proper wired PIR sensors installed 😎</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211118_201646_hucc1073ad2b4f1f49c8f9c957ff5640d2_419774_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Aqara RTCGQ11LM motion sensor"/>
  </picture>
  </a><figcaption>Aqara RTCGQ11LM motion sensor</figcaption></figure>

<p>I already had a Philips Hue indoor motion sensor in the entryway — to control the lights, so I figured I might as well include it in the alarm system.</p>
<p>Since my Hue devices are on a separate Zigbee network — I’m relying on the Home Assistant <a href="https://www.home-assistant.io/integrations/mqtt_statestream/">MQTT statestream</a> to forward messages.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20221229_162933_hu1e986bd687f6a7039193f34d2dfc5d16_543616_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Philips Hue indoor motion sensor"/>
  </picture>
  </a><figcaption>Philips Hue indoor motion sensor</figcaption></figure>

<h3 id="wired-hardware">Wired hardware <a href="#wired-hardware"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>Indoor and outdoor sirens are wired, although I haven’t installed the outdoor siren yet — that’s a job for warmer weather 🙂</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211203_120712_hu2bb82bc097b8f56d4af8ab7260bb3c94_539694_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Testing wired sirens — Vanderbilt SP203 and SIR1992-V-LP"/>
  </picture>
  </a><figcaption>Testing wired sirens — Vanderbilt SP203 and SIR1992-V-LP</figcaption></figure>

<p>I’ve installed a buzzer in the entryway — utilizing an empty wall box. It’s used to signal entry and exit delay, alarm state changes, door open warnings, and more.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095530_hu434bbda21093697a259685cec2de174d_695220_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Entryway buzzer wired up"/>
  </picture>
  </a><figcaption>Entryway buzzer wired up</figcaption></figure>

<p>The buzzer is mounted to a wall box blanking plate — making it flush mounted buzzer, and almost invisible 🙂</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20211227_095814_hu36fa4816b6fe397eb1653e891c00dcc5_860866_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Entryway buzzer, flush mounted"/>
  </picture>
  </a><figcaption>Entryway buzzer, flush mounted</figcaption></figure>

<p>A 10-cores 0.34mm² (22 AWG) signal cable in a conduit — going into a junction box close to some wired devices. The junction box has a tamper switch — detecting if the lid is removed.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253.jpg">
  <picture><source type="image/webp" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_1200x0_resize_q40_h2_lanczos.webp 1200w"/><source type="image/jpeg" sizes="(min-width: 500px) 500px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_1200x0_resize_q40_lanczos.jpg 1200w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220110_205253_hu0ff5e61b917579ba931601ec112546ee_666390_800x0_resize_q80_lanczos.jpg" width="800" height="1067" alt="Junction box OBO T60, with custom added tamper switch"/>
  </picture>
  </a><figcaption>Junction box OBO T60, with custom added tamper switch</figcaption></figure>

<p>Indoor siren SP203 from Vanderbilt, and Bosch Blue Line Gen2 PIR motion sensor in the 1st floor hallway. I don’t think cables should be visible, so I go to great lengths to hide them. Hidden cables also means they are harder to tamper with 🙂</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443.jpg">
  <picture><source type="image/webp" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_500x0_resize_q85_h2_lanczos.webp 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_800x0_resize_q80_h2_lanczos.webp 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_1200x0_resize_q40_h2_lanczos.webp 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_1600x0_resize_q30_h2_lanczos.webp 1600w"/><source type="image/jpeg" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_500x0_resize_q85_lanczos.jpg 500w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_800x0_resize_q80_lanczos.jpg 800w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_1200x0_resize_q40_lanczos.jpg 1200w, https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_1600x0_resize_q30_lanczos.jpg 1600w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/20220111_133443_hu71a4efea5be2ba56dba8b98b1990ae6c_223644_800x0_resize_q80_lanczos.jpg" width="800" height="600" alt="Vanderbilt SP203 indoor siren and Bosch ISC-BPR2-W12 PIR motion sensor"/>
  </picture>
  </a><figcaption>Vanderbilt SP203 indoor siren and Bosch ISC-BPR2-W12 PIR motion sensor</figcaption></figure>

<h2 id="software">Software <a href="#software"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>The alarm application/script is written in Python — I like Python, and there are lots of libraries available for the Raspberry Pi GPIO pins, MQTT, serial port, and more.</p>
<p>
  Currently — the code is very poorly documented… It may, or may not, improve in the future — use at your own risk 😛
</p>

<h3 id="python-script">Python script <a href="#python-script"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<div>
    <ul>
        <li>Source code is available in a git repository:</li>
        <li><a href="https://github.com/thomasjsn/rpi-alarm">https://github.com/thomasjsn/rpi-alarm</a></li>
    </ul>
</div>

<h3 id="configuration">Configuration <a href="#configuration"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>Simple things like MQTT hostname, API tokens, user PIN codes, times, etc — are defined in <code>config.ini</code>. The alarm state is saved when changed, meaning that the system will enter the same state if the application restarts.</p>
<p>More complex configuration is defined as Python objects directly in the application — things like inputs, outputs, sensors, Home Assistant entities, zone timers, and alarm panels.</p>
<p><em>Inputs</em> are digital GPIO pins, while <em>sensors</em> come from MQTT messages — combined they are <em>zones</em>.
</p>

<p>Some things are just plain hard-coded 😛</p>
<h3 id="mqtt-payload">MQTT payload <a href="#mqtt-payload"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>The alarm system sends a single state object — which contains all states. It’s sent when any of the values changes, but at least once every 10 seconds.</p>
<div><pre tabindex="0"><code data-lang="json"><span><span><span>{</span>
</span></span><span><span>    <span>&#34;arm_not_ready&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>    <span>&#34;battery_chrg&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>    <span>&#34;battery_level&#34;</span><span>:</span> <span>100</span><span>,</span>
</span></span><span><span>    <span>&#34;battery_low&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>    <span>&#34;battery_voltage&#34;</span><span>:</span> <span>12.74</span><span>,</span>
</span></span><span><span>    <span>&#34;clear&#34;</span><span>:</span> <span>true</span><span>,</span>
</span></span><span><span>    <span>&#34;code_attempts&#34;</span><span>:</span> <span>0</span><span>,</span>
</span></span><span><span>    <span>&#34;config&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>        <span>&#34;walk_test&#34;</span><span>:</span> <span>false</span>
</span></span><span><span>    <span>},</span>
</span></span><span><span>    <span>&#34;fault&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>    <span>&#34;mains_power_ok&#34;</span><span>:</span> <span>true</span><span>,</span>
</span></span><span><span>    <span>&#34;state&#34;</span><span>:</span> <span>&#34;disarmed&#34;</span><span>,</span>
</span></span><span><span>    <span>&#34;tamper&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>    <span>&#34;temperature&#34;</span><span>:</span> <span>21.1</span><span>,</span>
</span></span><span><span>    <span>&#34;triggered&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>        <span>&#34;timestamp&#34;</span><span>:</span> <span>null</span><span>,</span>
</span></span><span><span>        <span>&#34;zone&#34;</span><span>:</span> <span>null</span>
</span></span><span><span>    <span>},</span>
</span></span><span><span>    <span>&#34;zigbee_bridge&#34;</span><span>:</span> <span>true</span><span>,</span>
</span></span><span><span>    <span>&#34;zone_timers&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>        <span>&#34;hallway_motion&#34;</span><span>:</span> <span>true</span><span>,</span>
</span></span><span><span>        <span>&#34;kitchen_motion&#34;</span><span>:</span> <span>true</span>
</span></span><span><span>    <span>},</span>
</span></span><span><span>    <span>&#34;zones&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>        <span>&#34;door1&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;door2&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;door3&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;emergency&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;ext_tamper&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;motion1&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;motion2&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;motion3&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;panel_tamper&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;panic&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;water_leak1&#34;</span><span>:</span> <span>false</span><span>,</span>
</span></span><span><span>        <span>&#34;zone01&#34;</span><span>:</span> <span>false</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><h3 id="mqtt-broker">MQTT broker <a href="#mqtt-broker"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>The Raspberry Pi runs it’s own <a href="https://mosquitto.org/">Mosquitto</a> MQTT broker, which the Python application connects to. This is to minimize the dependence on external services.</p>
<p>My main MQTT broker connects to the Raspberry Pi as a bridge — receiving all messages, and passing on what is relevant for the alarm system.</p>
<div><pre tabindex="0"><code data-lang="plain"><span><span>connection rpi-alarm
</span></span><span><span>address 192.168.1.190:1883
</span></span><span><span>
</span></span><span><span>topic # in 0
</span></span><span><span>topic zigbee2mqtt/# out 0
</span></span><span><span>topic home/alarm_test/# out 0
</span></span><span><span>topic homelab/src_status out 0
</span></span></code></pre></div><h3 id="home-assistant">Home Assistant <a href="#home-assistant"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h3>
<p>No configuration is required in Home Assistant; the alarm system will automatically be created as a device, using <a href="https://www.home-assistant.io/integrations/mqtt/#mqtt-discovery">MQTT discovery</a>.</p>
<p>All zones, zones timers, and alarm panels are automatically published — but any property included in the state object can be published as well, by defining it as an entity.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/screenshot-hass-device.png">
  <picture><source type="image/png" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/screenshot-hass-device.png 998w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/screenshot-hass-device.png" width="998" height="1233" alt="MQTT device in Home Assistant"/>
  </picture>
  </a><figcaption>MQTT device in Home Assistant</figcaption></figure>

<p>This is my security dashboard — it gives an overview of all sensors and features, as well as some system diagnostics.</p>
<figure>
  <a href="https://blog.cavelab.dev/2022/12/rpi-security-alarm/screenshot-hass-dashboard.png">
  <picture><source type="image/png" sizes="(min-width: 900px) 760px, (min-width: 684px) 620px, calc(100vw - 40px)" srcset="https://blog.cavelab.dev/2022/12/rpi-security-alarm/screenshot-hass-dashboard.png 886w"/>
    <img loading="lazy" src="https://blog.cavelab.dev/2022/12/rpi-security-alarm/screenshot-hass-dashboard.png" width="886" height="1213" alt="Security dashboard in Home Assistant"/>
  </picture>
  </a><figcaption>Security dashboard in Home Assistant</figcaption></figure>

<h2 id="ending-thoughts">Ending thoughts <a href="#ending-thoughts"><svg height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a>
</h2>
<p>I’m delighted to finally have this blog post done — it has felt insurmountable. The project has been going on for more than a year, and I’m still adding features and making adjustments.</p>
<p>There’s a lot happening and much of the logic is fairly complex and difficult to explain in detail — I feel like I have barely scratched the surface in this post.</p>
<p>I will be writing more in-depth blog posts in the future, as well as keep you updated as the project progresses 👷‍♂️</p>
<p>This project is incredibly rewarding, and provides useful features in our daily lives 🙂 I’m currently planning a big feature upgrade for water sensors and actions related to that. More on that later.</p>
<p>🖖</p>
    </div></div>
  </body>
</html>
