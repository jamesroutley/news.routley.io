<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://linusakesson.net/commodordion/index.php">Original</a>
    <h1>The Commodordion</h1>
    
    <div id="readability-page-1" class="page"><div>


<iframe width="560" height="315" src="https://www.youtube.com/embed/EBCYvoC4muc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p><span>The Commodordion is an 8-bit accordion primarily made of
C64s, floppy disks, and gaffer tape.</span></p>

<h2>About the project</h2>

<p>I&#39;ve been tinkering with this beast, on and off, for about three and a half
years. So from my point of view, the <a href="https://linusakesson.net/sixtyforgan/index.php">Sixtyforgan</a> and <a href="https://linusakesson.net/software/qwertuoso/index.php">Qwertuoso</a>, where I first demonstrated
the accordion-like keyboard layout, were spin-offs from this project. In fact,
when I released the Sixtyforgan video in 2021, I already had an early
version of the Commodordion standing by, but it wasn&#39;t presentable at the time.
There was no acrylic cover on the back so the guts kept spilling out, and I
hadn&#39;t coded the the rhythm-box mode for the left-hand side yet.</p>

<p>Things were slowly coming together, though. Once I was happy with the design
of the instrument, there was the small matter of learning how to play it. As
any budding accordion player can tell you, it&#39;s frustrating that you can&#39;t see
what your hands are doing. Mirrors can help to a degree, but in the end you
really have to go by feeling and muscle memory. The little red sticker on the
right-hand-side “U” key is there to help me find my way when I have to jump
from one area of the keyboard to another.</p>

<p><a href="https://linusakesson.net/commodordion/redsticker-large.jpg"><img src="https://linusakesson.net/commodordion/redsticker-small.jpg"/></a></p>

<h2>The rhythm box</h2>

<p>The melody side of the Commodordion runs Qwertuoso. The accompaniment side
runs a custom application for playing chords and loops, which I&#39;ll describe
here. Technically both C64s load exactly the same program, but it&#39;s possible to
switch between the two applications with a special key combination.</p>

<p>Once the accompaniment mode is up and running, the left-hand side is
operated with single keypresses only—no key combinations are required. Commonly
used keys are close together and, where possible, near the outer edge of the
keyboard. It&#39;s nevertheless hard to reach some of the functions with the left
hand, especially when setting up a loop. I&#39;ll return to the matter of
ergonomics later in this article.</p>

<p>There&#39;s a live mode and a programming mode. Shift lock—a mechanical toggle
switch on the C64—is used to select between them.</p>

<h3>Live mode</h3>

<p>In live mode, the three rows with letters on them represent chords. The
layout is very much inspired by the <a href="https://en.wikipedia.org/wiki/Stradella_bass_system">Stradella bass
system</a> found on many accordions. The bottom row, from Z to Cursor Right,
contains all the major chords arranged according to the circle of fifths. Thus,
from any given I chord (tonic), you&#39;ll find the IV and V chords on either side
of it. The second row, from A to Return, contains the minor chords, and the
third row contains diminished chords. Thus, for instance, the keys Z, A, and Q
represent C♯ major, C♯ minor, and C♯ dim, respectively.</p>

<p>When you press and hold a chord key and no loop is playing, the program simply
plays the chord as an arpeggio and a bass note.</p>

<p>The function keys (F1, F3, F5, F7) start playback of one of four loop
patterns stored in memory. When a loop is playing, pressing a chord key adapts
the contents of the loop to the desired chord. The digit keys 4–9 set the
tempo. Space stops playback.</p>

<h3>Programming mode</h3>

<p>In programming mode, most keys represent events (triggers or notes) that can
be inserted into the current loop. There are drum triggers in the area near the
right shift key. Five letters in the bottom row (Z–B) represent bass notes,
namely the 1st, 3rd, 5th, 7th, and 8th note from the scale of the current chord
(or in case of a dim chord, the actual chord notes). The nine letters on the
second row (A–L) invoke the current chord in some fashion, as arpeggios or
individual notes.</p>

<p>When no loop is playing, these keys simply trigger the event directly,
allowing you to play around and find what you&#39;re looking for.</p>

<p>When a loop is playing, the event is recorded. The four function keys start
playback—and thus recording—of a given pattern. Space stops playback. Clr/Home
clears the current pattern.</p>

<p>The loop is divided into a number of steps, currently always sixteen, and
recorded events are quantized to the nearest step. A metronome is heard
whenever a loop is playing in programming mode.</p>

<p><a href="https://linusakesson.net/commodordion/bellows-large.jpg"><img src="https://linusakesson.net/commodordion/bellows-small.jpg"/></a></p>

<h2>The bellows</h2>

<p>How the bellows work is explained in the video. But in the early stages of
this project (such as when the material for the “montage” part of the video was
shot), I had no idea of how I was going to measure the air flow. I went through
a number of failed attempts before settling on the final design.</p>

<h3>Hot wires and turbines</h3>

<p>One approach was inspired by the fuel injection systems used in car engines.
You attach a temperature sensor to a heating element (a resistor that&#39;s
designed to dissipate power). Then you create a feedback loop to keep them at a
constant temperature. If the air is still, most of the heat stays near the
heating element. But if the air moves, more energy is needed to stay warm, as
anybody who lives in a chilly, windy place will know. By measuring how much
electric power the system is consuming, you can work out the air flow.</p>

<p>It sounds convoluted, but I figured that if car engines rely on this
technique, it probably works. And I actually managed to build a working
prototype. Unfortunately it didn&#39;t respond to changes in air flow quickly
enough for musical articulation. My prototype ran at a temperature of around
50°C. I suspect that it would have responded faster if I had increased the
working temperature, but I worried that I&#39;d end up burning myself or even
starting a fire.</p>

<p>So I went to look for alternatives. While I was reading up on <a href="https://en.wikipedia.org/wiki/Anemometer">anemometers</a> and propellers,
I came to watch a YouTube video about renewable energy. A man was explaining
something—I don&#39;t remember what it was, though I&#39;m sure it was
interesting—while standing next to a wind turbine, and he had to shout in order
to make himself heard over the din. Some of that noise came from the machinery,
but a lot of it was unmistakably from the wind hitting the microphone. I
remember the “aha” moment vividly: <i>That&#39;s</i> how I&#39;m going to measure air
flow!</p>

<h3>The envelope follower</h3>

<p>The envelope follower is implemented on a microcontroller. I sample the
incoming noise rather crudely with an analogue comparator: If the signal is
above a fixed (but trimmable) threshold, that sample is considered a one.
Otherwise it&#39;s a zero. Summing the last 512 samples (i.e. counting how
many of them were above the threshold) gives a number that&#39;s proportional to
the amount of noise.</p>

<p>I compute this number as a running average, which has the side effect of
low-pass filtering the signal. Then I apply an extra filtering step to smooth
out the curve even more. This is a tradeoff: The response needs to be snappy
enough for musical phrasing, but slow enough not to contain audible
frequencies. With too little filtering, you&#39;ll actually hear some of the noise
from the microphone bleeding into the sound. As you can see in the “set-up”
part of the video, the volume changes are lagging behind the movement of the
bellows somewhat, and this is a result of the filtering. The response is quick
enough to work with musically, but I think there&#39;s room for improving this
algorithm.</p>

<p>The noise level doesn&#39;t vary linearly with the bellow pressure, so I apply a
<a href="https://en.wikipedia.org/wiki/Gamma_correction">gamma correction</a>
curve before sending the output to an off-the-shelf multiplying <a href="https://en.wikipedia.org/wiki/Digital-to-analog_converter">DAC</a>.</p>

<p>This particular multiplying DAC is essentially a very long resistor ladder,
dividing the analogue input voltage into 4096 equal parts. A 12-bit number
is used to select one of the intermediate voltages and bring it to the
output.</p>

<p><a href="https://linusakesson.net/commodordion/backside-large.jpg"><img src="https://linusakesson.net/commodordion/backside-small.jpg"/></a></p>

<h2>Mixing</h2>

<p>The audio outputs from the two C64s are mixed together in equal proportions,
and this combined signal becomes the analogue input to the DAC. As it happens,
I prefer the melody side to be louder than the accompaniment side, but that
balance is controlled from the application software by setting the master
volume of each SID chip.</p>

<p>As I mention in the video, when you hold the bellows still, the volume
doesn&#39;t drop all the way to zero. This feature would be easy to implement in
the microcontroller, or even bake into the gamma correction table. But it&#39;s
often a good idea, where possible, to defer mixing decisions until after
recording. Stereo cables are handy: I actually send the DAC <i>input</i> (the
mixed audio from both C64s, unaffected by the bellows) over the left channel
and its output over the right channel. Thus, the right channel drops all the
way to zero when the bellows stop, but the left channel is held at a constant
level. I listen to both channels on my monitor speaker when playing, but they
are recorded separately, so I can fine-tune the mix according to taste
later.</p>

<p>The recorded audio is also subjected to a bit of eq, compression, and stereo
reverb.</p>

<h2>Ergonomics</h2>

<p>The Commodordion has one huge flaw: It puts a lot of strain on the left
wrist, arm, and shoulder. Most keys on the left-hand side are hard to reach, so
the wrist ends up in a fully bent position, and at the same time the arm needs
to carry a lot of weight while working the bellows. As a musician I take
ergonomics seriously (and so should you!), so unfortunately I won&#39;t be playing
this instrument very often, and I most definitely won&#39;t practice for hours to
improve my left-hand technique. This rather undermines the potential for the
Commodordion as a viable musical instrument.</p>

<p>But on a brighter note, I&#39;m not worried about the right-hand side at all:
That arm is in a sound, relaxed position. I&#39;ll be sure to bring that lesson
with me as I continue to explore the design space of C64-based instruments.</p>

<p>Posted Friday 21-Oct-2022 17:14</p>
<div>
<h3>Discuss this page</h3><p>Disclaimer: I am not responsible for what people (other than myself) write in the forums. Please report any abuse, such as insults, slander, spam and illegal material, and I will take appropriate actions. Don&#39;t feed the trolls.</p><p>Jag tar inget ansvar för det som skrivs i forumet, förutom mina egna inlägg. Vänligen rapportera alla inlägg som bryter mot reglerna, så ska jag se vad jag kan göra. Som regelbrott räknas till exempel förolämpningar, förtal, spam och olagligt material. Mata inte trålarna.</p><div><p>This is truly incredible! Fantastic work on this!</p></div>
<div><p>aren&#39;t you afraid of anonymous comments? is this even rate limited or something?</p></div>
</div>
</div></div>
  </body>
</html>
