<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rachelbythebay.com/w/2024/10/22/nofs/">Original</a>
    <h1>sshfs isn&#39;t really what I wanted for my backup situation</h1>
    
    
<p>
Okay, it seems I missed the mark yesterday while telling my
<a href="https://rachelbythebay.com/w/2024/10/21/sb/">story</a>
about a dumb little backup scheme, because a bunch of people have 
reached out to ask &#34;why not sshfs&#34;?
</p>
<p>
So, okay, some assumptions, first.  I&#39;m assuming from some basic 
reading that sshfs is one of those things that lets you take a 
filesystem that&#39;s on a distant host and mount it (with FUSE, sigh) on a 
local host.  If that is in fact what it does, that is very much *not* 
what I want.
</p>
<p>
I don&#39;t want my stuff to be visible as a filesystem on the remote host.  
That is, I don&#39;t want the copies of my data to be sitting there, 
accessible to anyone who can get on that machine.  I want it to be a 
amorphous blob of (obviously?) encrypted data.  The only place where it 
should make sense is on the client machine after I&#39;ve supplied the key.
</p>
<p>
Speaking of keys, that key material (like a typed passphrase) never 
leaves the client system, since all of the crypto stuff happens 
locally.  If this stuff was a regular filesystem on the other end, then 
that host would need access to the key, and then it&#39;s no longer really 
under my control, right?
</p>
<p>
Given all that, let me come at this again.
</p>
<p>
I have a host.  I want to back it up to something that&#39;s not in the same 
physical location, and ideally is rather far away.  Having different 
power companies, ISPs, you name it?  That&#39;s all a good thing in this 
case.  (Also, &#34;different fault lines&#34; is always a consideration here.)
</p>
<p>
I have access to that host, but assume I don&#39;t have root access to it 
for whatever reason.  I&#39;m just a user on there, and I can ssh in, and I 
have a healthy amount of disk quota.  I&#39;m also welcome to use oodles of 
(network) bandwidth to do whatever I need to do.
</p>
<p>
I don&#39;t, however, want the contents of my backed-up data to be visible 
to anyone on that host, _even if_ they have root on it, whether 
legitimately or otherwise.  The remote host is just being a dumb block 
device for me.
</p>
<p>
I don&#39;t want to have any extra daemons running that would provide 
network access to the blob o&#39; bits that constitutes the encrypted image.  
It&#39;s a whole bunch of extra complications that I don&#39;t need or want, 
since ssh gives me a perfectly good pipe without changing anything 
fundamental about how that system works.
</p>
<p>
So, the end result is that I extend nbd over a wacky ssh connection to a 
Unix domain socket on the source machine, do my crypto magic to make it 
into a viable filesystem, then fsck it, mount it, and rsync my stuff 
onto it.
</p>
<p>
The only part of this I had to create was the aforementioned wacky ssh 
connection.  nbdclient itself won&#39;t do a &#34;ssh to far end, start nbdkit 
server, and then stay alive copying bytes around&#34; thing.  It&#39;s all about 
getting the connection up and handing it off to the kernel.  It only 
sticks around if it&#39;s doing TLS mode and since that means running a 
persistent server on the far end, I&#39;m not using it that way.
</p>
<p>
That&#39;s it.  It&#39;s just one of those dumb things you build to make other 
stuff possible.  Tools to make tools.
</p>

  </body>
</html>
