<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.davidrevoy.com/article995/how-a-kernel-update-broke-my-stylus-need-help">Original</a>
    <h1>A kernel update broke my stylus</h1>
    
    <div id="readability-page-1" class="page"><article>
      <section>
        
        
        30 Oct, 2023
      </section>

      
      <h2>Exploring Postgres internals by changing operator logic.</h2>
      <p><b>Disclaimer</b>: This is my first time diving deep into Postgres source code. I wrote this post after my short, 1-hour exploration in the code base, so I&#39;m unaware of any ideal tricks/techniques to use for implementing things.
</p>

<p><del>This is my first microblog! I‚Äôll be writing short-form content for smaller projects/experiments.</del> <em>Edit:</em> Moved this to the main blog.</p>

<p>Today‚Äôs experiment was something which I thought would be fun to write. Thanks to <a href="https://eatonphil.com/" rel="nofollow">Phil Eaton</a> for helping me out with this experiment!</p>

<h2>Why?</h2>

<p>During a conversation, Phil wrote this:</p>

<blockquote>
<p>I‚Äôve gone looking for where builtin SQL functions like +, - are defined and got lost. So if someone wants to find that and share that would be nice! üôÇ</p>
</blockquote>

<p>I got curious and wanted to know more. And since the job market has been <em>meh</em> this year, I decided to explore this further to overcome the monotonic, boring job search.</p>

<p>The goal for this exploration is to find where this logic is present, and tweak it to make the <code>+</code> operator <strong>subtract</strong> the passed values.</p>

<h2>Diving deep into source code</h2>

<p>Since Phil mentioned about the <code>+</code> operator, I thought it would be a good start to start checking references for <em>‚Äúadd‚Äù</em> as a keyword for the search.</p>

<p>I came across <code>numeric.c</code> in <code>src/backend/utils/adt</code>, which happens to be a gigantic ~10k+ LOC file. On doing a few more searches, I found something which does addition: <code>numeric_add</code>:</p>

<p><a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l2842" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l2842</a></p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * numeric_add() -
</span></span></span><span><span><span> *
</span></span></span><span><span><span> *	Add two numerics
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>Datum</span>
</span></span><span><span><span>numeric_add</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>Numeric</span>		<span>num1</span> <span>=</span> <span>PG_GETARG_NUMERIC</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>	<span>Numeric</span>		<span>num2</span> <span>=</span> <span>PG_GETARG_NUMERIC</span><span>(</span><span>1</span><span>)</span><span>;</span>
</span></span><span><span>	<span>Numeric</span>		<span>res</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>res</span> <span>=</span> <span>numeric_add_opt_error</span><span>(</span><span>num1</span><span>,</span> <span>num2</span><span>,</span> <span>NULL</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>PG_RETURN_NUMERIC</span><span>(</span><span>res</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>/*
</span></span></span><span><span><span> * numeric_add_opt_error() -
</span></span></span><span><span><span> *
</span></span></span><span><span><span> *	Internal version of numeric_add().  If &#34;*have_error&#34; flag is provided,
</span></span></span><span><span><span> *	on error it&#39;s set to true, NULL returned.  This is helpful when caller
</span></span></span><span><span><span> *	need to handle errors by itself.
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>Numeric</span>
</span></span><span><span><span>numeric_add_opt_error</span><span>(</span><span>Numeric</span> <span>num1</span><span>,</span> <span>Numeric</span> <span>num2</span><span>,</span> <span>bool</span> <span>*</span><span>have_error</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>NumericVar</span>	<span>arg1</span><span>;</span>
</span></span><span><span>	<span>NumericVar</span>	<span>arg2</span><span>;</span>
</span></span><span><span>	<span>NumericVar</span>	<span>result</span><span>;</span>
</span></span><span><span>	<span>Numeric</span>		<span>res</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>/*
</span></span></span><span><span><span>	 * Handle NaN and infinities
</span></span></span><span><span><span>	 */</span>
</span></span><span><span>	<span>if</span> <span>(</span><span>NUMERIC_IS_SPECIAL</span><span>(</span><span>num1</span><span>)</span> <span>|</span><span>|</span> <span>NUMERIC_IS_SPECIAL</span><span>(</span><span>num2</span><span>)</span><span>)</span>
</span></span><span><span>	<span>{</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>NUMERIC_IS_NAN</span><span>(</span><span>num1</span><span>)</span> <span>|</span><span>|</span> <span>NUMERIC_IS_NAN</span><span>(</span><span>num2</span><span>)</span><span>)</span>
</span></span><span><span>			<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_nan</span><span>)</span><span>;</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>NUMERIC_IS_PINF</span><span>(</span><span>num1</span><span>)</span><span>)</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>if</span> <span>(</span><span>NUMERIC_IS_NINF</span><span>(</span><span>num2</span><span>)</span><span>)</span>
</span></span><span><span>				<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_nan</span><span>)</span><span>;</span> <span>/* Inf + -Inf */</span>
</span></span><span><span>			<span>else</span>
</span></span><span><span>				<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_pinf</span><span>)</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>NUMERIC_IS_NINF</span><span>(</span><span>num1</span><span>)</span><span>)</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>if</span> <span>(</span><span>NUMERIC_IS_PINF</span><span>(</span><span>num2</span><span>)</span><span>)</span>
</span></span><span><span>				<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_nan</span><span>)</span><span>;</span> <span>/* -Inf + Inf */</span>
</span></span><span><span>			<span>else</span>
</span></span><span><span>				<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_ninf</span><span>)</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>/* by here, num1 must be finite, so num2 is not */</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>NUMERIC_IS_PINF</span><span>(</span><span>num2</span><span>)</span><span>)</span>
</span></span><span><span>			<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_pinf</span><span>)</span><span>;</span>
</span></span><span><span>		<span>Assert</span><span>(</span><span>NUMERIC_IS_NINF</span><span>(</span><span>num2</span><span>)</span><span>)</span><span>;</span>
</span></span><span><span>		<span>return</span> <span>make_result</span><span>(</span><span>&amp;</span><span>const_ninf</span><span>)</span><span>;</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>/*
</span></span></span><span><span><span>	 * Unpack the values, let add_var() compute the result and return it.
</span></span></span><span><span><span>	 */</span>
</span></span><span><span>	<span>init_var_from_num</span><span>(</span><span>num1</span><span>,</span> <span>&amp;</span><span>arg1</span><span>)</span><span>;</span>
</span></span><span><span>	<span>init_var_from_num</span><span>(</span><span>num2</span><span>,</span> <span>&amp;</span><span>arg2</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>init_var</span><span>(</span><span>&amp;</span><span>result</span><span>)</span><span>;</span>
</span></span><span><span>	<span>add_var</span><span>(</span><span>&amp;</span><span>arg1</span><span>,</span> <span>&amp;</span><span>arg2</span><span>,</span> <span>&amp;</span><span>result</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>res</span> <span>=</span> <span>make_result_opt_error</span><span>(</span><span>&amp;</span><span>result</span><span>,</span> <span>have_error</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>free_var</span><span>(</span><span>&amp;</span><span>result</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>return</span> <span>res</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<p><code>numeric_add_opt_error</code> calls <code>add_var</code>, which has sign handling logic, and calls other functions for addition/subtraction based on signs:</p>

<p><a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l8353" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l8353</a></p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * add_var() -
</span></span></span><span><span><span> *
</span></span></span><span><span><span> *	Full version of add functionality on variable level (handling signs).
</span></span></span><span><span><span> *	result might point to one of the operands too without danger.
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>static</span> <span>void</span>
</span></span><span><span><span>add_var</span><span>(</span><span>const</span> <span>NumericVar</span> <span>*</span><span>var1</span><span>,</span> <span>const</span> <span>NumericVar</span> <span>*</span><span>var2</span><span>,</span> <span>NumericVar</span> <span>*</span><span>result</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>/*
</span></span></span><span><span><span>	 * Decide on the signs of the two variables what to do
</span></span></span><span><span><span>	 */</span>
</span></span><span><span>	<span>if</span> <span>(</span><span>var1</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span><span>=</span> <span>NUMERIC_POS</span><span>)</span>
</span></span><span><span>	<span>{</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>var2</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span><span>=</span> <span>NUMERIC_POS</span><span>)</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>/*
</span></span></span><span><span><span>			 * Both are positive result = +(ABS(var1) + ABS(var2))
</span></span></span><span><span><span>			 */</span>
</span></span><span><span>			<span>add_abs</span><span>(</span><span>var1</span><span>,</span> <span>var2</span><span>,</span> <span>result</span><span>)</span><span>;</span>
</span></span><span><span>			<span>result</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span> <span>NUMERIC_POS</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>else</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>/*
</span></span></span><span><span><span>			 * var1 is positive, var2 is negative Must compare absolute values
</span></span></span><span><span><span>			 */</span>
</span></span><span><span>			<span>switch</span> <span>(</span><span>cmp_abs</span><span>(</span><span>var1</span><span>,</span> <span>var2</span><span>)</span><span>)</span>
</span></span><span><span>			<span>{</span>
</span></span><span><span>				<span>case</span> <span>0</span><span>:</span>
</span></span><span><span>					<span>/* ----------
</span></span></span><span><span><span>					 * ABS(var1) == ABS(var2)
</span></span></span><span><span><span>					 * result = ZERO
</span></span></span><span><span><span>					 * ----------
</span></span></span><span><span><span>					 */</span>
</span></span><span><span>					<span>zero_var</span><span>(</span><span>result</span><span>)</span><span>;</span>
</span></span><span><span>					<span>result</span><span>-</span><span>&gt;</span><span>dscale</span> <span>=</span> <span>Max</span><span>(</span><span>var1</span><span>-</span><span>&gt;</span><span>dscale</span><span>,</span> <span>var2</span><span>-</span><span>&gt;</span><span>dscale</span><span>)</span><span>;</span>
</span></span><span><span>					<span>break</span><span>;</span>
</span></span><span><span>
</span></span><span><span>				<span>case</span> <span>1</span><span>:</span>
</span></span><span><span>					<span>/* ----------
</span></span></span><span><span><span>					 * ABS(var1) &gt; ABS(var2)
</span></span></span><span><span><span>					 * result = +(ABS(var1) - ABS(var2))
</span></span></span><span><span><span>					 * ----------
</span></span></span><span><span><span>					 */</span>
</span></span><span><span>					<span>sub_abs</span><span>(</span><span>var1</span><span>,</span> <span>var2</span><span>,</span> <span>result</span><span>)</span><span>;</span>
</span></span><span><span>					<span>result</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span> <span>NUMERIC_POS</span><span>;</span>
</span></span><span><span>					<span>break</span><span>;</span>
</span></span><span><span>
</span></span><span><span>				<span>case</span> <span>-</span><span>1</span><span>:</span>
</span></span><span><span>					<span>/* ----------
</span></span></span><span><span><span>					 * ABS(var1) &lt; ABS(var2)
</span></span></span><span><span><span>					 * result = -(ABS(var2) - ABS(var1))
</span></span></span><span><span><span>					 * ----------
</span></span></span><span><span><span>					 */</span>
</span></span><span><span>					<span>sub_abs</span><span>(</span><span>var2</span><span>,</span> <span>var1</span><span>,</span> <span>result</span><span>)</span><span>;</span>
</span></span><span><span>					<span>result</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span> <span>NUMERIC_NEG</span><span>;</span>
</span></span><span><span>					<span>break</span><span>;</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>else</span>
</span></span><span><span>	<span>{</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>var2</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span><span>=</span> <span>NUMERIC_POS</span><span>)</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>/* ----------
</span></span></span><span><span><span>			 * var1 is negative, var2 is positive
</span></span></span><span><span><span>			 * Must compare absolute values
</span></span></span><span><span><span>			 * ----------
</span></span></span><span><span><span>			 */</span>
</span></span><span><span>			<span>switch</span> <span>(</span><span>cmp_abs</span><span>(</span><span>var1</span><span>,</span> <span>var2</span><span>)</span><span>)</span>
</span></span><span><span>			<span>{</span>
</span></span><span><span>				<span>case</span> <span>0</span><span>:</span>
</span></span><span><span>					<span>/* ----------
</span></span></span><span><span><span>					 * ABS(var1) == ABS(var2)
</span></span></span><span><span><span>					 * result = ZERO
</span></span></span><span><span><span>					 * ----------
</span></span></span><span><span><span>					 */</span>
</span></span><span><span>					<span>zero_var</span><span>(</span><span>result</span><span>)</span><span>;</span>
</span></span><span><span>					<span>result</span><span>-</span><span>&gt;</span><span>dscale</span> <span>=</span> <span>Max</span><span>(</span><span>var1</span><span>-</span><span>&gt;</span><span>dscale</span><span>,</span> <span>var2</span><span>-</span><span>&gt;</span><span>dscale</span><span>)</span><span>;</span>
</span></span><span><span>					<span>break</span><span>;</span>
</span></span><span><span>
</span></span><span><span>				<span>case</span> <span>1</span><span>:</span>
</span></span><span><span>					<span>/* ----------
</span></span></span><span><span><span>					 * ABS(var1) &gt; ABS(var2)
</span></span></span><span><span><span>					 * result = -(ABS(var1) - ABS(var2))
</span></span></span><span><span><span>					 * ----------
</span></span></span><span><span><span>					 */</span>
</span></span><span><span>					<span>sub_abs</span><span>(</span><span>var1</span><span>,</span> <span>var2</span><span>,</span> <span>result</span><span>)</span><span>;</span>
</span></span><span><span>					<span>result</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span> <span>NUMERIC_NEG</span><span>;</span>
</span></span><span><span>					<span>break</span><span>;</span>
</span></span><span><span>
</span></span><span><span>				<span>case</span> <span>-</span><span>1</span><span>:</span>
</span></span><span><span>					<span>/* ----------
</span></span></span><span><span><span>					 * ABS(var1) &lt; ABS(var2)
</span></span></span><span><span><span>					 * result = +(ABS(var2) - ABS(var1))
</span></span></span><span><span><span>					 * ----------
</span></span></span><span><span><span>					 */</span>
</span></span><span><span>					<span>sub_abs</span><span>(</span><span>var2</span><span>,</span> <span>var1</span><span>,</span> <span>result</span><span>)</span><span>;</span>
</span></span><span><span>					<span>result</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span> <span>NUMERIC_POS</span><span>;</span>
</span></span><span><span>					<span>break</span><span>;</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>else</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>/* ----------
</span></span></span><span><span><span>			 * Both are negative
</span></span></span><span><span><span>			 * result = -(ABS(var1) + ABS(var2))
</span></span></span><span><span><span>			 * ----------
</span></span></span><span><span><span>			 */</span>
</span></span><span><span>			<span>add_abs</span><span>(</span><span>var1</span><span>,</span> <span>var2</span><span>,</span> <span>result</span><span>)</span><span>;</span>
</span></span><span><span>			<span>result</span><span>-</span><span>&gt;</span><span>sign</span> <span>=</span> <span>NUMERIC_NEG</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<p>As we saw above, <code>add_var</code> uses the <code>add_abs</code> and <code>sub_abs</code> functions based on the signs. I took a look at <code>add_abs</code>, and it seems to be the exact place where the actual logic happens (carry bits, etc.):</p>

<p><a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l11331" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l11331</a></p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * add_abs() -
</span></span></span><span><span><span> *
</span></span></span><span><span><span> *	Add the absolute values of two variables into result.
</span></span></span><span><span><span> *	result might point to one of the operands without danger.
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>static</span> <span>void</span>
</span></span><span><span><span>add_abs</span><span>(</span><span>const</span> <span>NumericVar</span> <span>*</span><span>var1</span><span>,</span> <span>const</span> <span>NumericVar</span> <span>*</span><span>var2</span><span>,</span> <span>NumericVar</span> <span>*</span><span>result</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>NumericDigit</span> <span>*</span><span>res_buf</span><span>;</span>
</span></span><span><span>	<span>NumericDigit</span> <span>*</span><span>res_digits</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>res_ndigits</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>res_weight</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>res_rscale</span><span>,</span>
</span></span><span><span>				<span>rscale1</span><span>,</span>
</span></span><span><span>				<span>rscale2</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>res_dscale</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>i</span><span>,</span>
</span></span><span><span>				<span>i1</span><span>,</span>
</span></span><span><span>				<span>i2</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>carry</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>/* copy these values into local vars for speed in inner loop */</span>
</span></span><span><span>	<span>int</span>			<span>var1ndigits</span> <span>=</span> <span>var1</span><span>-</span><span>&gt;</span><span>ndigits</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>var2ndigits</span> <span>=</span> <span>var2</span><span>-</span><span>&gt;</span><span>ndigits</span><span>;</span>
</span></span><span><span>	<span>NumericDigit</span> <span>*</span><span>var1digits</span> <span>=</span> <span>var1</span><span>-</span><span>&gt;</span><span>digits</span><span>;</span>
</span></span><span><span>	<span>NumericDigit</span> <span>*</span><span>var2digits</span> <span>=</span> <span>var2</span><span>-</span><span>&gt;</span><span>digits</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>res_weight</span> <span>=</span> <span>Max</span><span>(</span><span>var1</span><span>-</span><span>&gt;</span><span>weight</span><span>,</span> <span>var2</span><span>-</span><span>&gt;</span><span>weight</span><span>)</span> <span>+</span> <span>1</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>res_dscale</span> <span>=</span> <span>Max</span><span>(</span><span>var1</span><span>-</span><span>&gt;</span><span>dscale</span><span>,</span> <span>var2</span><span>-</span><span>&gt;</span><span>dscale</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>/* Note: here we are figuring rscale in base-NBASE digits */</span>
</span></span><span><span>	<span>rscale1</span> <span>=</span> <span>var1</span><span>-</span><span>&gt;</span><span>ndigits</span> <span>-</span> <span>var1</span><span>-</span><span>&gt;</span><span>weight</span> <span>-</span> <span>1</span><span>;</span>
</span></span><span><span>	<span>rscale2</span> <span>=</span> <span>var2</span><span>-</span><span>&gt;</span><span>ndigits</span> <span>-</span> <span>var2</span><span>-</span><span>&gt;</span><span>weight</span> <span>-</span> <span>1</span><span>;</span>
</span></span><span><span>	<span>res_rscale</span> <span>=</span> <span>Max</span><span>(</span><span>rscale1</span><span>,</span> <span>rscale2</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>res_ndigits</span> <span>=</span> <span>res_rscale</span> <span>+</span> <span>res_weight</span> <span>+</span> <span>1</span><span>;</span>
</span></span><span><span>	<span>if</span> <span>(</span><span>res_ndigits</span> <span>&lt;</span><span>=</span> <span>0</span><span>)</span>
</span></span><span><span>		<span>res_ndigits</span> <span>=</span> <span>1</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>res_buf</span> <span>=</span> <span>digitbuf_alloc</span><span>(</span><span>res_ndigits</span> <span>+</span> <span>1</span><span>)</span><span>;</span>
</span></span><span><span>	<span>res_buf</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>0</span><span>;</span>				<span>/* spare digit for later rounding */</span>
</span></span><span><span>	<span>res_digits</span> <span>=</span> <span>res_buf</span> <span>+</span> <span>1</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>i1</span> <span>=</span> <span>res_rscale</span> <span>+</span> <span>var1</span><span>-</span><span>&gt;</span><span>weight</span> <span>+</span> <span>1</span><span>;</span>
</span></span><span><span>	<span>i2</span> <span>=</span> <span>res_rscale</span> <span>+</span> <span>var2</span><span>-</span><span>&gt;</span><span>weight</span> <span>+</span> <span>1</span><span>;</span>
</span></span><span><span>	<span>for</span> <span>(</span><span>i</span> <span>=</span> <span>res_ndigits</span> <span>-</span> <span>1</span><span>;</span> <span>i</span> <span>&gt;</span><span>=</span> <span>0</span><span>;</span> <span>i</span><span>-</span><span>-</span><span>)</span>
</span></span><span><span>	<span>{</span>
</span></span><span><span>		<span>i1</span><span>-</span><span>-</span><span>;</span>
</span></span><span><span>		<span>i2</span><span>-</span><span>-</span><span>;</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>i1</span> <span>&gt;</span><span>=</span> <span>0</span> <span>&amp;</span><span>&amp;</span> <span>i1</span> <span>&lt;</span> <span>var1ndigits</span><span>)</span>
</span></span><span><span>			<span>carry</span> <span>+</span><span>=</span> <span>var1digits</span><span>[</span><span>i1</span><span>]</span><span>;</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>i2</span> <span>&gt;</span><span>=</span> <span>0</span> <span>&amp;</span><span>&amp;</span> <span>i2</span> <span>&lt;</span> <span>var2ndigits</span><span>)</span>
</span></span><span><span>			<span>carry</span> <span>+</span><span>=</span> <span>var2digits</span><span>[</span><span>i2</span><span>]</span><span>;</span>
</span></span><span><span>
</span></span><span><span>		<span>if</span> <span>(</span><span>carry</span> <span>&gt;</span><span>=</span> <span>NBASE</span><span>)</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>res_digits</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>carry</span> <span>-</span> <span>NBASE</span><span>;</span>
</span></span><span><span>			<span>carry</span> <span>=</span> <span>1</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>else</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>res_digits</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>carry</span><span>;</span>
</span></span><span><span>			<span>carry</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>Assert</span><span>(</span><span>carry</span> <span>=</span><span>=</span> <span>0</span><span>)</span><span>;</span>			<span>/* else we failed to allow for carry out */</span>
</span></span><span><span>
</span></span><span><span>	<span>digitbuf_free</span><span>(</span><span>result</span><span>-</span><span>&gt;</span><span>buf</span><span>)</span><span>;</span>
</span></span><span><span>	<span>result</span><span>-</span><span>&gt;</span><span>ndigits</span> <span>=</span> <span>res_ndigits</span><span>;</span>
</span></span><span><span>	<span>result</span><span>-</span><span>&gt;</span><span>buf</span> <span>=</span> <span>res_buf</span><span>;</span>
</span></span><span><span>	<span>result</span><span>-</span><span>&gt;</span><span>digits</span> <span>=</span> <span>res_digits</span><span>;</span>
</span></span><span><span>	<span>result</span><span>-</span><span>&gt;</span><span>weight</span> <span>=</span> <span>res_weight</span><span>;</span>
</span></span><span><span>	<span>result</span><span>-</span><span>&gt;</span><span>dscale</span> <span>=</span> <span>res_dscale</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>/* Remove leading/trailing zeroes */</span>
</span></span><span><span>	<span>strip_var</span><span>(</span><span>result</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<p>A simple explanation of how it works:</p>

<ul>
<li><code>add_abs</code> function adds the absolute values of two <code>NumericVar</code>s, <code>var1</code> and <code>var2</code>, and stores the result in result.</li>
<li>A loop iterates through the digits of result, adding digits from <code>var1</code> and <code>var2</code> at corresponding positions while accounting for any carry from the previous iteration.</li>
<li>If the sum of digits exceeds <code>NBASE</code>, the carry is propagated to the next digit, and the result digit is set accordingly.</li>
<li>After the loop, an assertion checks that no carry remains to ensure a successful addition.</li>
<li>The function updates the result and removes leading/trailing zeroes to maintain a canonical form.</li>
</ul>

<p>The result is stored in a <code>NumericVar</code> type, which has a few fields to store the values and some metadata (signs, etc.). The documentation is well-written:</p>

<p><a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l254" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l254</a></p>
<pre tabindex="0"><code><span><span><span>typedef</span> <span>struct</span> <span>NumericVar</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>int</span>			<span>ndigits</span><span>;</span>		<span>/* # of digits in digits[] - can be 0! */</span>
</span></span><span><span>	<span>int</span>			<span>weight</span><span>;</span>			<span>/* weight of first digit */</span>
</span></span><span><span>	<span>int</span>			<span>sign</span><span>;</span>			<span>/* NUMERIC_POS, _NEG, _NAN, _PINF, or _NINF */</span>
</span></span><span><span>	<span>int</span>			<span>dscale</span><span>;</span>			<span>/* display scale */</span>
</span></span><span><span>	<span>NumericDigit</span> <span>*</span><span>buf</span><span>;</span>			<span>/* start of palloc&#39;d space for digits[] */</span>
</span></span><span><span>	<span>NumericDigit</span> <span>*</span><span>digits</span><span>;</span>		<span>/* base-NBASE digits */</span>
</span></span><span><span><span>}</span> <span>NumericVar</span><span>;</span>
</span></span></code></pre>
<p>Here‚Äôs an interesting comment talking about the format and <code>NBASE</code>:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l55" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/numeric.c;h=bf61fd7dbc09f6ede5799b0eaa00c306e31a1aa1;hb=HEAD#l55</a>)</p>
<pre tabindex="0"><code><span><span> <span>*</span> <span>Numeric</span> <span>values</span> <span>are</span> <span>represented</span> <span>in</span> <span>a</span> <span>base</span><span>-</span><span>NBASE</span> <span>floating</span> <span>point</span> <span>format</span><span>.</span>
</span></span><span><span> <span>*</span> <span>Each</span> <span></span><span>&#34;</span><span>digit</span><span>&#34;</span> <span>ranges</span> <span>from</span> <span>0</span> <span>to</span> <span>NBASE</span><span>-</span><span>1.</span>  <span>The</span> <span>type</span> <span>NumericDigit</span> <span>is</span> <span>signed</span>
</span></span><span><span> <span>*</span> <span>and</span> <span>wide</span> <span>enough</span> <span>to</span> <span>store</span> <span>a</span> <span>digit</span><span>.</span>  <span>We</span> <span>assume</span> <span>that</span> <span>NBASE</span><span>*</span><span>NBASE</span> <span>can</span> <span>fit</span> <span>in</span>
</span></span><span><span> <span>*</span> <span>an</span> <span>int</span><span>.</span>  <span>Although</span> <span>the</span> <span>purely</span> <span>calculational</span> <span>routines</span> <span>could</span> <span>handle</span> <span>any</span> <span>even</span>
</span></span><span><span> <span>*</span> <span>NBASE</span> <span>that</span><span>&#39;</span><span>s</span> <span>less</span> <span>than</span> <span>sqrt</span><span>(</span><span>INT_MAX</span><span>)</span><span>,</span> <span>in</span> <span>practice</span> <span>we</span> <span>are</span> <span>only</span> <span>interested</span>
</span></span><span><span> <span>*</span> <span>in</span> <span>NBASE</span> <span>a</span> <span>power</span> <span>of</span> <span>ten</span><span>,</span> <span>so</span> <span>that</span> <span>I</span><span>/</span><span>O</span> <span>conversions</span> <span>and</span> <span>decimal</span> <span>rounding</span>
</span></span><span><span> <span>*</span> <span>are</span> <span>easy</span><span>.</span>  <span>Also</span><span>,</span> <span>it</span><span>&#39;</span><span>s</span> <span>actually</span> <span>more</span> <span>efficient</span> <span>if</span> <span>NBASE</span> <span>is</span> <span>rather</span> <span>less</span> <span>than</span>
</span></span><span><span> <span>*</span> <span>sqrt</span><span>(</span><span>INT_MAX</span><span>)</span><span>,</span> <span>so</span> <span>that</span> <span>there</span> <span>is</span> <span></span><span>&#34;</span><span>headroom</span><span>&#34;</span> <span>for</span> <span>mul_var</span> <span>and</span> <span>div_var_fast</span> <span>to</span>
</span></span><span><span> <span>*</span> <span>postpone</span> <span>processing</span> <span>carries</span><span>.</span>
</span></span><span><span> <span>*</span>
</span></span><span><span> <span>*</span> <span>Values</span> <span>of</span> <span>NBASE</span> <span>other</span> <span>than</span> <span>10000</span> <span>are</span> <span>considered</span> <span>of</span> <span>historical</span> <span>interest</span> <span>only</span>
</span></span><span><span> <span>*</span> <span>and</span> <span>are</span> <span>no</span> <span>longer</span> <span>supported</span> <span>in</span> <span>any</span> <span>sense</span><span>;</span> <span>no</span> <span>mechanism</span> <span>exists</span> <span>for</span> <span>the</span> <span>client</span>
</span></span><span><span> <span>*</span> <span>to</span> <span>discover</span> <span>the</span> <span>base</span><span>,</span> <span>so</span> <span>every</span> <span>client</span> <span>supporting</span> <span>binary</span> <span>mode</span> <span>expects</span> <span>the</span>
</span></span><span><span> <span>*</span> <span>base</span><span>-</span><span>10000</span> <span>format</span><span>.</span>  <span>If</span> <span>you</span> <span>plan</span> <span>to</span> <span>change</span> <span>this</span><span>,</span> <span>also</span> <span>note</span> <span>the</span> <span>numeric</span>
</span></span><span><span> <span>*</span> <span>abbreviation</span> <span>code</span><span>,</span> <span>which</span> <span>assumes</span> <span>NBASE</span><span>=</span><span>10000.</span>
</span></span><span><span> <span>*</span> <span>-</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>
</span></span><span><span> <span>*/</span>
</span></span></code></pre>
<h2>Making changes</h2>

<p>Even before making any changes, I had to set up a working environment to compile and test changes. Thankfully, Phil had posted this set of commands with comments for getting started with a simple setup:</p>
<pre tabindex="0"><code><span><span>$ ./configure --prefix<span>=</span><span>$(</span><span>pwd</span><span>)</span>/test-install
</span></span><span><span>$ make -j8 <span>&amp;&amp;</span> make install
</span></span><span><span>$ ./test-install/bin/initdb <span>$(</span><span>pwd</span><span>)</span>/test-data <span># Create a database</span>
</span></span><span><span>$ <span>echo</span> <span>&#34;port=8080&#34;</span> &gt; <span>$(</span><span>pwd</span><span>)</span>/postgres.conf <span># This is the minimal postgres run config</span>
</span></span><span><span>$ mkdir test-run <span># Place for postgres to put lock files</span>
</span></span><span><span>$ ./test-install/bin/postgres --config-file<span>=</span><span>$(</span><span>pwd</span><span>)</span>/postgres.conf -D <span>$(</span><span>pwd</span><span>)</span>/test-data -k <span>$(</span><span>pwd</span><span>)</span>/test-run
</span></span></code></pre>
<p>Now that I had some context on how numeric addition works in Postgres, making the change was really easy; all I had to do was change the call from <code>add_var</code> to <code>sub_var</code> in <code>numeric_add_opt_error</code>. (keep in mind that I‚Äôm ignoring other cases)</p>

<p>Diff:</p>
<pre tabindex="0"><code><span><span>diff --git a/src/backend/utils/adt/numeric.c b/src/backend/utils/adt/numeric.c
</span></span><span><span>index bf61fd7dbc..e174f9a9ff <span>100644</span>
</span></span><span><span>--- a/src/backend/utils/adt/numeric.c
</span></span><span><span>+++ b/src/backend/utils/adt/numeric.c
</span></span><span><span>@@ -2905,7 +2905,7 @@ numeric_add_opt_error<span>(</span>Numeric num1, Numeric num2, bool *have_error<span>)</span>
</span></span><span><span>        init_var_from_num<span>(</span>num2, <span>&amp;</span>arg2<span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>        init_var<span>(</span><span>&amp;</span>result<span>)</span><span>;</span>
</span></span><span><span>-       add_var<span>(</span><span>&amp;</span>arg1, <span>&amp;</span>arg2, <span>&amp;</span>result<span>)</span><span>;</span>
</span></span><span><span>+       sub_var<span>(</span><span>&amp;</span>arg1, <span>&amp;</span>arg2, <span>&amp;</span>result<span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>        <span>res</span> <span>=</span> make_result_opt_error<span>(</span><span>&amp;</span>result, have_error<span>)</span><span>;</span>
</span></span></code></pre>
<p>Let‚Äôs recompile and restart the server:</p>
<pre tabindex="0"><code><span><span>$ make -j8 <span>&amp;&amp;</span> make install
</span></span><span><span>$ ./test-install/bin/postgres --config-file<span>=</span><span>$(</span><span>pwd</span><span>)</span>/postgres.conf -D <span>$(</span><span>pwd</span><span>)</span>/test-data -k <span>$(</span><span>pwd</span><span>)</span>/test-run
</span></span></code></pre>
<p>And run the shell:</p>
<pre tabindex="0"><code><span><span>$ ./test-install/bin/psql -p <span>8080</span> -h localhost -d postgres
</span></span></code></pre>
<p>To test it out, I created a new table (to prevent possible constant folding and just to be extra sure that it works):</p>
<pre tabindex="0"><code><span><span><span>postgres</span><span>=</span><span>#</span><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>numbers</span><span> </span><span>(</span><span>num1</span><span> </span><span>numeric</span><span>,</span><span> </span><span>num2</span><span> </span><span>numeric</span><span>)</span><span>;</span><span>
</span></span></span><span><span><span></span><span>CREATE</span><span> </span><span>TABLE</span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>INSERT</span><span> </span><span>INTO</span><span> </span><span>numbers</span><span> </span><span>(</span><span>num1</span><span>,</span><span> </span><span>num2</span><span>)</span><span> </span><span>VALUES</span><span> </span><span>(</span><span>5</span><span>.</span><span>25</span><span>,</span><span> </span><span>3</span><span>.</span><span>75</span><span>)</span><span>;</span><span>
</span></span></span><span><span><span></span><span>INSERT</span><span> </span><span>0</span><span> </span><span>1</span><span>
</span></span></span></code></pre>
<p>And the moment I had been waiting for:</p>
<pre tabindex="0"><code><span><span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>num1</span><span> </span><span>+</span><span> </span><span>num2</span><span> </span><span>AS</span><span> </span><span>sum</span><span> </span><span>FROM</span><span> </span><span>numbers</span><span>;</span><span>
</span></span></span><span><span><span> </span><span>sum</span><span>
</span></span></span><span><span><span></span><span>------
</span></span></span><span><span><span></span><span> </span><span>1</span><span>.</span><span>50</span><span>
</span></span></span><span><span><span></span><span>(</span><span>1</span><span> </span><span>row</span><span>)</span><span>
</span></span></span></code></pre>
<p>Yay! <code>5.25 - 3.75 = 1.50</code>, so it‚Äôs working as intended!</p>

<h2>What‚Äôs next?</h2>

<p>The above exploration was something I managed to do in an hour; I‚Äôm currently looking to explore more and have a project planned where I‚Äôd try to exploit Postgres internals and build something out of it!</p>

<p>Please email (<code>contact &lt;at&gt; aadhav.me</code>) or DM on <a href="https://twitter.com/carrotburnt" rel="nofollow">Twitter</a> if you have any questions, corrections, or if you are hiring.</p>

    </article></div>
  </body>
</html>
