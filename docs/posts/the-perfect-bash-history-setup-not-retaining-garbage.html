<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://benjaminwuethrich.dev/2022-10-10-what-goes-into-bash-history.html">Original</a>
    <h1>The perfect Bash history setup: not retaining garbage</h1>
    
    <div id="readability-page-1" class="page">


<p>In the <a href="https://benjaminwuethrich.dev/2022-03-03-infinite-history.html">first post</a>, we
looked at configuring an interactive shell session such that it retains
infinite command history. The recommended setup looks like this:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>HISTFILE</span><span>=</span><span>&#34;</span><span>$HOME</span><span>/.local/share/bash/history&#34;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span>shopt</span> <span>-u</span> histappend</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span>HISTSIZE</span><span>=</span>-1</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span>HISTFILESIZE</span><span>=</span>-1</span></code></pre></div>
<p>See the post for all the details.</p>

<p>If we think of the command history as a list of commands that might
be handy for reuse at some point, we probably don’t want absolutely
everything in there. For example, <code>ls</code> and related commands
are a) short and easy to write at any time without accessing history,
and b) only useful in the context or working directory they were
originally issued in, which we don’t really have available.</p>
<p>Another class of commands I never recall from history are those
interacting with the history itself, such as <a href="https://www.gnu.org/software/bash/manual/bash.html#index-history"><code>history</code></a>
and <a href="https://www.gnu.org/software/bash/manual/bash.html#index-fc"><code>fc</code></a>.</p>
<p>In my dotfiles, I have <a href="https://github.com/bewuethr/dotfiles/blob/7c5e5438a6641855cd473a3e58524e384e24a58d/.aliases.sh#L1-L2">aliases
for <code>cd ..</code> and <code>cd ../..</code></a>; I don’t need those
in history either.</p>
<p>And finally, I’m not interested in <code>exit</code>.</p>
<p>To specify which commands shouldn’t go into history, Bash provides
the <a href="https://www.gnu.org/software/bash/manual/bash.html#index-HISTIGNORE"><code>HISTIGNORE</code></a>
variable. It’s a colon-separated list of patterns, and commands matching
the pattern (anchored at the beginning of the line) aren’t stored to
history.</p>
<p>For example, for the commands described above as not interesting to
me, I can set</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>HISTIGNORE</span><span>=</span><span>&#39;exit:history:l:l[1als]:lla:+(.)&#39;</span></span></code></pre></div>
<p>to ignore <code>exit</code>, <code>history</code>, most of <a href="https://github.com/bewuethr/dotfiles/blob/7c5e5438a6641855cd473a3e58524e384e24a58d/.aliases.sh#L4-L16">my
<code>ls</code> aliases</a><a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a>, and commands consisting
of any number of periods. <code>+(.)</code> is an extended glob pattern
meaning “one or more periods”; <code>HISTIGNORE</code> understands
extended globs if the <code>extglob</code> shell option is enabled,
which by default it is in interactive shells.</p>
<p>The list is probably rather conservative and stores some commands I’m
not interested in, but I’d rather have that than missing out on stuff I
<em>do</em> want to see later on.</p>

<p>For more general control of what goes into history, Bash provides a
variable <a href="https://www.gnu.org/software/bash/manual/bash.html#index-HISTCONTROL"><code>HISTCONTROL</code></a>.
It is also colon-separated, with values taken from this list:</p>
<ul>
<li><p><code>ignorespace</code>: ignore commands starting with a space
character</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>$</span> echo <span>&#34;Hello&#34;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span>Hello</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span>$</span>  echo <span>&#34;Starts with blank&#34;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span>Starts</span> with blank</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span>$</span> history <span>|</span> <span>tail</span> <span>-n2</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span>6</span>  echo <span>&#34;Hello&#34;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span>7</span>  history <span>|</span> <span>tail</span> <span>-n2</span></span></code></pre></div></li>
<li><p><code>ignoredups</code>: don’t store commands that exactly match
the last stored command</p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 1</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span>1</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 2</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span>2</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 2</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span>2</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 3</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span>3</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span>$</span> history <span>|</span> <span>tail</span> <span>-n4</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span>9</span>  echo 1</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>   <span>10</span>  echo 2</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>   <span>11</span>  echo 3</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>   <span>12</span>  history <span>|</span> <span>tail</span> <span>-n4</span></span></code></pre></div></li>
<li><p><code>ignoreboth</code> is the same as
<code>ignorespace:ignoredups</code></p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 1</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span>1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span>$</span>  echo <span>&#34;Start with blank&#34;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span>Start</span> with blank</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 2</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span>2</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 2</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span>2</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span>$</span> history <span>|</span> <span>tail</span> <span>-n3</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>   <span>18</span>  echo 1</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>   <span>19</span>  echo 2</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>   <span>20</span>  history <span>|</span> <span>tail</span> <span>-n3</span></span></code></pre></div></li>
<li><p><code>erasedups</code> removes all lines from history matching
the current command before storing it</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 1</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span>1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 2</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span>2</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span>$</span> history <span>|</span> <span>tail</span> <span>-n3</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>   <span>16</span>  echo 1</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>   <span>17</span>  echo 2</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>   <span>18</span>  history <span>|</span> <span>tail</span> <span>-n3</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 3</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span>3</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span>$</span> echo 2</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span>2</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span>$</span> history <span>|</span> <span>tail</span> <span>-n5</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>   <span>15</span>  echo 1</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>   <span>16</span>  history <span>|</span> <span>tail</span> <span>-n3</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>   <span>17</span>  echo 3</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>   <span>18</span>  echo 2</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>   <span>19</span>  history <span>|</span> <span>tail</span> <span>-n5</span></span></code></pre></div></li>
</ul>
<p>I use <code>HISTCONTROL=&#39;ignoreboth&#39;</code>; the only reason I’m not
using <code>&#39;ignoreboth:erasedups&#39;</code> is because sometimes, I want
to repeat a sequence of commands from history using
<kbd>Ctrl</kbd>+<kbd>O</kbd> (execute the current line from history and
fetch the next one, <a href="https://www.gnu.org/software/bash/manual/bash.html#index-operate_002dand_002dget_002dnext-_0028C_002do_0029"><code>operate-and-get-next</code></a>),
and <code>erasedups</code> might remove commands from the middle of such
sequences.</p>
<p>Realistically, though, that’s a pretty unlikely edge case, and I
might enable <code>erasedups</code> at some point. It would get rid of
more than 7,500 commands in my history, apparently!</p>

<p>Taken all together, our history setup now provides infinite history,
and only stores what we want:</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span># No clutter in the home directory</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span>HISTFILE</span><span>=</span><span>&#34;</span><span>$HOME</span><span>/.local/share/bash/history&#34;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span># Overwrite when storing</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span>shopt</span> <span>-u</span> histappend</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span># Infinite session history</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span>HISTSIZE</span><span>=</span>-1</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span># Infinite history file</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span>HISTFILESIZE</span><span>=</span>-1</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span># Don&#39;t store commands that aren&#39;t useful in history</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span>HISTIGNORE</span><span>=</span><span>&#39;exit:history:l:l[1als]:lla:+(.)&#39;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span># Ignore commands starting with space, and duplicates</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span>HISTCONTROL</span><span>=</span><span>&#39;ignoreboth&#39;</span></span></code></pre></div>
<p>In the next post, we’ll examine how to get multi-line commands into
history, and add timestamps to commands.</p>




</div>
  </body>
</html>
