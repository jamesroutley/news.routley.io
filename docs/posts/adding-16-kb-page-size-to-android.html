<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://android-developers.googleblog.com/2024/08/adding-16-kb-page-size-to-android.html">Original</a>
    <h1>Adding 16 kb page size to Android</h1>
    
    <div id="readability-page-1" class="page"><div>
<meta content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2PUAPiFw_x3s9fodPRsZLeHyHZNjhdopBeaS5nE6V8R2skSt1eNB-FpbIbazyRtomkV9NMekcLWO4Ah88Cs2OiQPgIjkyRicbSWpstcK9OZeQymlM0IK6xsLyzBhsPIz0ZsJ5lm7BvnaoTiSDCeRbJKv_cv2JyoDxtaCkgkmzrp7b1mJHZkYj5QYScfk/s1600/header-Adding-16-KB-Page-Size-to-Android-.png" name="twitter:image"/>
<p>
  
<em>Posted by Steven Moreland – Staff Software Engineer, Sandeep Patil – Principal Software Engineer</em>

<a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2PUAPiFw_x3s9fodPRsZLeHyHZNjhdopBeaS5nE6V8R2skSt1eNB-FpbIbazyRtomkV9NMekcLWO4Ah88Cs2OiQPgIjkyRicbSWpstcK9OZeQymlM0IK6xsLyzBhsPIz0ZsJ5lm7BvnaoTiSDCeRbJKv_cv2JyoDxtaCkgkmzrp7b1mJHZkYj5QYScfk/s1600/header-Adding-16-KB-Page-Size-to-Android-.png"><img data-original-height="800" data-original-width="1058" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2PUAPiFw_x3s9fodPRsZLeHyHZNjhdopBeaS5nE6V8R2skSt1eNB-FpbIbazyRtomkV9NMekcLWO4Ah88Cs2OiQPgIjkyRicbSWpstcK9OZeQymlM0IK6xsLyzBhsPIz0ZsJ5lm7BvnaoTiSDCeRbJKv_cv2JyoDxtaCkgkmzrp7b1mJHZkYj5QYScfk/s1600/header-Adding-16-KB-Page-Size-to-Android-.png"/></a></p><p>A page is the granularity at which an operating system manages memory. Most CPUs today support a 4 KB page size and so the Android OS and applications have historically been built and optimized to run with a 4 KB page size. ARM CPUs support the larger 16 KB page size. When Android uses this larger page size, we observe an <a href="https://developer.android.com/guide/practices/page-sizes#benefits" target="_blank">overall performance boost of 5-10%</a> while using ~9% additional memory.</p>

<p>In order to improve the operating system performance overall and to give device manufacturers an option to make this trade-off, Android 15 can run with 4 KB or 16 KB page sizes.</p>

<p>The very first 16 KB enabled Android system will be made available on select devices as a developer option. This is so you can use the developer option to test and fix (if needed) your applications to prepare for Android devices with 16 KB page sizes in the near future.</p>

<h2><span>Details</span></h2>

<p>In most CPUs, dedicated hardware called memory management units (MMUs) translate addresses from what a program is using to a physical location in memory. This translation is done on a page-size basis. Every time a program needs more memory, the operating system needs to get involved and fill out a “page table” entry, assigning that piece of memory to a process. When the page size is 4 times larger, there is 4 times less bookkeeping. So, the system can spend more time making sure your videos look great, games play well, and applications run smoothly, and less time filling out low-level operating system paperwork.</p>
  
<p>Unlike 32-bit/64-bit mode, a page size is not an Application Binary Interface (ABI). In other words, <b>once an application is fixed to be page size agnostic, the same application binary can run on both 4 KB and 16 KB devices.</b></p>

<p>In Android 15, we’ve refactored Android from the ground up to support running at different page sizes, thus making it page-size agnostic.</p>
  
<h3><span>Major OS Changes</span></h3>
  
<p>On new Android 15 based devices:</p>

<ul><ul>
<li>The compile-time <span><a href="https://cs.android.com/android/platform/superproject/main/+/main:bionic/libc/include/bits/page_size.h" target="_blank">PAGE_SIZE</a></span> macro is replaced at runtime with <span><a href="https://man7.org/linux/man-pages/man2/getpagesize.2.html" target="_blank">getpagesize(2)</a></span>.</li></ul><ul>
<li>All OS binaries are 16 KB aligned (<span>-Wl,-z,max-page-size=16384</span>). 3rd party applications / libraries may not be 16 KB aligned.</li></ul><ul>
<li>All OS binaries are built with separate loadable segments (<span>-Wl,-z,separate-loadable-segments</span>) to ensure all memory regions mapped into a process are readable, which some applications depend on.</li>
</ul></ul>

<p>Many of our other OS components have been rewritten to avoid assuming the page size and to optimize for larger page size when available.</p>

  
<h4><span><b>Filesystems</b></span></h4>

<p>For performant operation, file system block size must match the page size. EROFS and F2FS file systems have been made 16 KB compatible, as has the UFS storage layer.</p>

<p>On 4 KB systems, ELF executable file size increases due to additional padding added for 16 KB alignment (<span>-Wl,-z,max-page-size=16384</span> option), but several optimizations help us avoid this cost.</p>
<ol>
<li>Sparse read-only file systems ensure that zero pages created for additional padding for 16 KB alignment are not written to disk. For example, EROFS knows a certain range of a file is zero filled, and it will not need to do any IO if this part of the file is accessed.</li>
<li>Read-writeable file systems handle zero pages on a case-by-case basis. For example, In Android 15, for files installed as part of applications <span><a href="https://developer.android.com/reference/android/content/pm/PackageManager" target="_blank">PackageManager</a></span> reclaims this space.</li>
</ol>
  
<h4><span><b>Memory Management</b></span></h4>
<ol>
<li>The Linux <a href="https://en.wikipedia.org/wiki/Page_cache" target="_blank">page cache</a> has been modified not to read ahead for these extra padding spaces, thereby saving unnecessary memory load.</li>
<li>These pages are blank padding, and programs never read this. It’s the space in-between usable parts of the program, purely for alignment reasons.</li>
</ol>

<h4><span><b>Linux Kernel</b></span></h4>

<p>The Linux kernel is deeply tied to a specific page size, so we must choose which page size to use when building the kernel, while the rest of the operating system remains the same.</p>

<h4><span><b>Android Applications</b></span></h4>

<p><b><em>All applications with native code or dependencies need to be recompiled for compatibility with 16 KB page size devices.</em></b></p>

<p>Since most native code within Android applications and SDKs have been built with 4 KB page size in mind, they need to be re-aligned to 16 KB so the binaries are compatible with both 4 KB and 16 KB devices. For most applications and SDKs, this is a 2 step process:</p>
<ol>
    <li>Rebuild the native code with 16 KB alignment.</li>
  	<li>Test and fix on a 16 KB device/emulator in case there are hardcode assumptions about page size.</li>
  </ol>

<p>Please see <a href="https://developer.android.com/16kb-page-size" target="_blank">our developer documentation</a> for more information.</p>

<blockquote><b>NOTE:</b> If you are an SDK or tools developer, you should add 16 KB support as soon as possible so that applications can work on 16 KB using your SDK or tools.</blockquote>
  
<h2><span>Developing for 16 KB devices</span></h2>

<p>There are no production Android devices available today or expected for the Android 15 release that support a 16 KB page size. In order to fix this problem, we are taking steps to work with our partners to make a developer option available on existing devices. This developer option is meant for application development and testing. We are also making a 16 KB emulator target available for developers in Android Studio.</p>

<h3><span>16 KB Developer option on device</span></h3>

<p>In Android 15, we implemented a developer option that lets users switch between 16 KB and 4 KB page size on the device in order to test their application with either of the page sizes. This option is available on Pixel 8 and Pixel 8 Pro starting in the Android 15 QPR1 Beta, and we&#39;re collaborating closely with SoC and OEM partners to enable the option on additional devices soon.</p>

<p><img/></p><p><img alt="screen grab of 16KB developer option on device" height="640" id="imgCaption" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgdO3BATJTnfIVhyphenhyphenbDVglPPckZgFwGB9rOzUpsFEntFS-LNllfA2Wu0_dZwwL5EIGYNWAt07o1MY1YAw_o0W_I3Rq1xEcvdrJcV6_nhyIuhu0ZsbrzzcVWJkvPLyJc-QaRUNyZCpZXD2m_xGNKg64TqrHEfBkSjJj-d4hb8tVemzzFvaVDYxSYu4_J1fXc/s1600/5e6vMM89mRtgQVE.png" width="288"/></p></div></div>
  </body>
</html>
