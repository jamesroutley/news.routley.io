<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wasmer.io/posts/running-php-blazingly-fast-at-the-edge-with-wasm">Original</a>
    <h1>Running PHP fast at the edge with WebAssembly</h1>
    
    <div id="readability-page-1" class="page"><div><p>PHP currently powers <a href="https://w3techs.com/technologies/details/pl-php">~75% of the websites</a> on the internet. It may not be the “sexy boi” of programming languages… but it has been an important actor since the internet&#39;s birth and our pulse to use it for sharing memes and cat images.
Starting today, in open beta, you’ll be able to run PHP fully in Wasmer and <a href="https://wasmer.io/products/edge">Wasmer Edge</a>.</p>
<p><em>But …why is running PHP in WebAssembly important?</em> Thanks to the properties of WebAssembly, we can safely restrict the resources that the program can access, and as such… we can run PHP safely without the overhead of OS or hardware virtualization.</p>
<p>The support for PHP in WebAssembly arrives after countless hours of work from the Wasmer team (Arshia and Amin in particular!) working to make PHP run flawlessly and as fast as possible.
<em>TL;DR: we got up to 3x faster speeds by enabling opcode caching inside WebAssembly, a feat never achieved before!</em></p>
<p>Bringing serverless-like scalability to any PHP app can unlock immense value, allowing you to run your PHP apps in the Edge and pay a fraction of the price that cloud providers charge.</p>
<p>This also means that you can run every PHP application out there with Wasmer without ever worrying that the app will break sandboxing and do harmful things they shouldn’t be able to.</p>
<p>You can now run the most popular PHP frameworks in Wasmer and Wasmer Edge:</p>
<ul>
<li><a href="https://wasmer.io/templates/wordpress-starter">WordPress</a> (<a href="https://wordpress-wasmer-examples.wasmer.app/">demo in Wasmer Edge</a>)</li>
<li><a href="https://wasmer.io/templates/symfony-starter">Symfony</a> (<a href="https://symfony-wasmer-examples.wasmer.app/">demo in Wasmer Edge</a>)</li>
<li><a href="https://wasmer.io/templates/laravel-starter">Laravel</a> (<a href="https://laravel-wasmer-examples.wasmer.app/">demo in Wasmer Edge</a>)</li>
</ul>
<p>All PHP templates: <a href="https://wasmer.io/templates?language=php">https://wasmer.io/templates?language=php</a></p>
<blockquote>
<p>Note: Wasmer Edge support for custom filesystem volumes is on the way. The deployed apps that are using SQLite (such as Wordpress or Symfony), currently only store database changes memory, not yet permanently.</p>
</blockquote>
<p>To squeeze the max out of WebAssembly and PHP we have been able to enable opcode caching, allowing Wasmer to run WordPress without any modification, at 3x the speed… going from 600ms to a reasonable 200ms to render a basic blogpost page.</p>
<p><img src="https://wasmer.io/_next/image?url=https%3A%2F%2Fcdn.wasmer.io%2Fimages%2FScreenshot_2024-05-23_at_3.09.40_PM.original.png&amp;w=1920&amp;q=75" alt="WebAssembly in PHP Wasm vs Native with opcode cache enabled"/></p>
<p>Do you want to try it?</p>
<p>If normally you would do:</p>
<pre><code> php -S localhost:8000 .
</code></pre>
<p>You can now simply run it fully sandboxed via Wasmer with:</p>
<pre><code>wasmer run php/php --mapdir:/app:. -- /app -S localhost:8000
</code></pre>
<blockquote>
<p>You can also run wordpress locally easily. Just clone the Wordpress repo: <a href="https://github.com/wasmer-examples/wordpress-wasmer-starter">https://github.com/wasmer-examples/wordpress-wasmer-starter</a> and run <code>wasmer run . --net</code> on the root! Note: you’ll need Wasmer 4.3.1</p>
</blockquote>
<p>And there you go… a fully functional PHP CLI running in your server, and fully sandboxed! You don’t have to worry anymore that the app will have access to your <code>/etc/passwd</code> or your precious bitcoins!</p>
<p>Welcome to the new frontier, where the software that we know and love can be compiled and run in a way that is fully sandboxed.</p>

<p>Getting PHP to work flawlessly in Wasm with Wasmer was not an easy feat. We solved many problems along the process:</p>
<ul>
<li>We found an obscure bug in our <code>longjmp</code>/<code>setjmp</code> implementation (required to have try/catch statements within PHP), where the stack was being overwritten and not properly restored</li>
<li>We discovered and fixed a bug slowing down outgoing HTTP calls by a 10x factor</li>
<li>We enabled PHP <code>opcache</code> by default, allowing up to 3x faster PHP times</li>
<li>Many small fixes on the filesystem virtualization layer and networking (oh, IPv6 our dear friend!)</li>
</ul>
<p>If you have followed our previous blogpost on running WordPress with Wasmer, you may have realized that we have had to do countless code adaptations (a.k.a. <em>hacks</em>) in WordPress to change its behavior and not trigger a blocking edge case. Namely, these are all the <em>hacks</em>:</p>
<ul>
<li>We had to standardize calls to the <code>exit</code> function: <a href="https://github.com/wasmerio/wcgi-wordpress-demo/commit/9116a7ba25bb14cc50f1a18b81490929347c8462">https://github.com/wasmerio/wcgi-wordpress-demo/commit/9116a7ba25bb14cc50f1a18b81490929347c8462</a></li>
<li>We had to comment out any fetch calls: <a href="https://github.com/wasmerio/wcgi-wordpress-demo/commit/ef1550ba3cce4fb6882a738d8409aacbc09784f0">https://github.com/wasmerio/wcgi-wordpress-demo/commit/ef1550ba3cce4fb6882a738d8409aacbc09784f0</a></li>
<li>We served the static assets using the PHP interpreter (there’s code I’ve been more proud of than this one! <a href="https://github.com/wasmerio/wcgi-wordpress-demo/blob/main/app/hacks.php#L44-L150">https://github.com/wasmerio/wcgi-wordpress-demo/blob/main/app/hacks.php#L44-L150</a>)</li>
</ul>
<p>As of today, none of those <em>hacks</em> are needed any longer.</p>
<p>The good news is that on the latest release of Wasmer, <strong>WordPress, Laravel, and Symfony run in Wasmer without any code modification</strong> whatsoever.</p>
<p>We are incredibly happy with this because running those frameworks successfully with no modifications required also means that Wasmer will likely be able to run every PHP program out there.</p>
<h2>But… how fast is it?</h2>
<p>Just running PHP at baseline speeds was not enough for our use case, we wanted to run it as fast as humanly possible in WebAssembly.</p>
<p>Thankfully for us, PHP has one module that makes its execution much faster: the <a href="https://www.php.net/manual/en/book.opcache.php">Zend Opcache</a>. The Opcode caching module works by optimizing and caching the bytecode that the PHP source is transformed into, thus saving time by not parsing the AST of the files that have already been processed.</p>
<p>Opcode caching can bring a 3x speed up to the number of requests an app can handle, so it seemed obvious to enable it on WebAssembly.</p>
<p>However, opcode caching (and Zend module loading) was disabled by default (as it requires <code>dlopen</code>, <code>dlsym</code>, and more support in Wasm, which is not available).</p>
<p>So we set on a unique quest: enabling opcode caching in PHP.</p>
<p>After some research, we found one novel way of doing it, and we were up for the races: we found a way to statically link it, and had to fix a bunch of things along the way… but we got it running at the end!</p>
<p>Here are the timings of WordPress without Opcache in Wasm: ~620ms</p>
<p>And the timings of WordPress with Opcache enabled in Wasm: ~205ms</p>
<p><strong>That’s a 3x speedup just by enabling Opcache!</strong></p>
<p>While doing the work, we also realized there are even further improvements that we can make to PHP to bring it close to native speeds. Stay tuned!</p>
<p>Our work opens up even more avenues for projects that are currently relying on Emscripten to run PHP in the browser, such as the <a href="https://wordpress.org/playground/">WordPress playground</a>, allowing those projects to work with packages that can run both in the browser and in the Edge!</p>
<hr/>
<p>But this is not all: we are working on a completely revolutionary approach to cold-starts that will supersede any other provider by a big factor (Cloudflare &amp; Fly.io, we are looking at you!)… exciting times are coming to the Edge market.</p>
<p>Did you like running PHP in WebAssembly with Wasmer? You can also:</p>
<ul>
<li>Join our <a href="https://discord.gg/rWkMNStrEW">Discord channel</a> and tell us what you are building!</li>
<li><a href="https://twitter.com/wasmerio">Follow Wasmer on X/Twitter</a> to hear updates about Wasmer</li>
<li>Deploy your first PHP app to Wasmer Edge: <a href="https://wasmer.io/templates/php-starter">https://wasmer.io/templates/php-starter</a></li>
</ul></div></div>
  </body>
</html>
