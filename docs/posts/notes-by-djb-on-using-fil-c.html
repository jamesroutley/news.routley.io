<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cr.yp.to/2025/fil-c.html">Original</a>
    <h1>Notes by djb on using Fil-C</h1>
    
    <div id="readability-page-1" class="page">


<p>
I&#39;m impressed with the level of compatibility
of the new memory-safe C/C++ compiler
<a href="https://fil-c.org">Fil-C</a>
(filcc, fil++).
Many libraries and applications that I&#39;ve tried
work under Fil-C without changes, and the exceptions haven&#39;t been hard to get working.
</p>
<p>
I&#39;ve started accumulating miscellaneous notes on this page regarding usage of Fil-C.
My selfish objective here is to protect various machines that I manage
by switching them over to code compiled with Fil-C,
but maybe you&#39;ll find something useful here too.
</p>
<p>
Timings below are from a mini-PC named <tt>phoenix</tt> except where otherwise mentioned.
This mini-PC has a 6-core (12-thread) AMD Ryzen 5 7640HS (Zen 4) CPU, 12GB RAM, and 36GB swap.
The OS is Debian 13.
(I normally run LTS software,
periodically upgrading from software that&#39;s 4–5 years old such as Debian 11 today
to software that&#39;s 2–3 years old such as Debian 12 today;
but some of the packages included in Fil-C expect newer utilities to be available.)
</p>
<p>
Related:
</p>
<ul>
<li>
I&#39;ve posted a
<a href="https://cr.yp.to/2025/filc-diffs-20251027.sh">script</a>
to help auditors see how Fil-C differs from upstream sources (clang, glibc, ...).
</li>
<li>
I&#39;ve posted a self-contained
<a href="https://cr.yp.to/2025/20251030-filian-install-compiler.sh"><tt>filian-install-compiler</tt></a>
script
(replacing the
<a href="https://cr.yp.to/2025/20251029-filian-install-compiler.sh">20251029 version</a>)
to download+compile+install Fil-C on Debian 13 in what I think are Debian-appropriate locations,
along with glibc and binutils compiled with Fil-C.
A run took 86 minutes real time (for 477 minutes user time and 52 minutes system time).
</li>
<li>
I&#39;ve posted the start of a
<a href="https://cr.yp.to/2025/20251030-filian-install-packages.sh"><tt>filian-install-packages</tt></a>
script to download+compile+install Debian source packages, using Fil-C as the compiler
(after <tt>filian-install-compiler</tt> has finished).
This script has various limitations that need fixing,
but it does work for a few packages already
(e.g., <tt>./filian-install-packages bzip2</tt>),
after the installation of <tt>dh-exec</tt> etc. described below.
</li>
<li>
I&#39;ve posted a
<a href="https://cr.yp.to/2025/20251028-filcc-vs-clang.html">graph</a>
showing nearly 9000 microbenchmarks of Fil-C vs. clang on cryptographic software (each run pinned to 1 core on the same Zen 4).
Typically code compiled with Fil-C takes between 1x and 4x as many cycles as the same code compiled with clang.
</li>
</ul>
<p>
Another way to run Fil-C is via
<a href="https://github.com/mbrock/filnix">Filnix</a>
from Mikael Brockman.
For example,
an unprivileged user under Debian 12 with about 10GB of free disk space
can download, compile, and install Fil-C,
and run a Fil-C-compiled Nethack, as follows:
</p>
<pre><code>unshare --user --pid echo YES # just to test
git clone https://github.com/nix-community/nix-user-chroot
cd nix-user-chroot
cargo build --release
mkdir -m 0755 ~/nix
~/nix-user-chroot/target/release/nix-user-chroot ~/nix \
  bash -c &#39;curl -L https://nixos.org/nix/install | sh&#39;
env TERM=vt102 \
  ~/nix-user-chroot/target/release/nix-user-chroot ~/nix \
  ~/nix/store/*-nix-2*/bin/nix \
  --extra-experimental-features &#39;nix-command flakes&#39; \
  run &#39;github:mbrock/filnix#nethack&#39;
</code></pre>

<h2><a name="compiler">Compiler and C library</a></h2>
<p>
Current recommendations for things to do at the beginning as <tt>root</tt>:
</p>
<pre><code>mkdir -p /var/empty
apt install \
  autoconf-dickey build-essential bison clang cmake flex gawk \
  gettext ninja-build patchelf quilt ruby texinfo time
</code></pre>
<p>
I created an unprivileged <tt>filc</tt> user.
Everything else is as that user.
</p>
<p>
I downloaded the Fil-C source package:
</p>
<pre><code>git clone https://github.com/pizlonator/fil-c.git
cd fil-c
</code></pre>
<p>
This isn&#39;t just the compiler;
there&#39;s also glibc and quite a few higher-level libraries and applications.
There are also binary Fil-C packages,
but I&#39;ve worked primarily with the source package at this point.
</p>
<p>
I compiled Fil-C and glibc:
</p>
<pre><code>time ./build_all_fast_glibc.sh
</code></pre>
<p>
There are also options to use musl instead of glibc,
but musl is incompatible with some of the packages shipped with Fil-C:
<tt>attr</tt> needs <tt>basename</tt>,
<tt>elfutils</tt> needs <tt>argp_parse</tt>,
<tt>sed</tt>&#39;s test suite needs the glibc variant of <tt>calloc</tt>,
and
<tt>vim</tt>&#39;s build needs <tt>iconv</tt>
to be able to convert from CP932 to UTF-8.
</p>
<p>
I had originally configured the server <tt>phoenix</tt> with only 12GB swap.
I then had to restart <tt>./build_all_fast_glibc.sh</tt> a few times
because the Fil-C compilation ran out of memory.
Switching to 36GB swap made everything work with no restarts;
monitoring showed that almost 19GB swap (plus 12GB RAM) was used at one point.
A larger server, 128 cores with 512GB RAM, took 8 minutes for Fil-C plus 6 minutes for musl,
with no restarts needed.
</p>
<h2><a name="batteries">More libraries and applications included with Fil-C</a></h2>
<p>
Fil-C includes a
<tt>./build_all_slow.sh</tt>
that builds many more libraries and applications
(sometimes with patches from the Fil-C author).
I wrote a replacement script
<a href="https://cr.yp.to/2025/build-parallel-20251023.py">https://cr.yp.to/2025/build-parallel-20251023.py</a>
with the following differences:
</p>
<ul>
<li>The <tt>build-parallel</tt> script
  runs through everything, putting results into <tt>build/logs/*</tt>,
  whereas <tt>build_all_slow</tt> stops at the first error.
</li>
<li>The <tt>build-parallel</tt> script tries to use multiple cores,
  while <tt>build_all_slow</tt> runs through targets serially,
  parallelizing only to the extent that each target&#39;s build mechanism is parallelized.
</li>
<li>The <tt>build-parallel</tt> script might produce wrong results if it&#39;s parallelizing things
  that shouldn&#39;t be parallelized.
  But this should be easy to fix via tweaking the dependencies listed in the script.
</li>
</ul>
<p>
On <tt>phoenix</tt>,
running
<tt>time PATH=&#34;$HOME/bin:$HOME/fil-c/build/bin:$HOME/fil-c/pizfix/bin:$PATH&#34; ./build-parallel.py</tt>
went through 61 targets in 101 minutes real time (467 minutes user time, 55 minutes system time),
successfully compiling 60 of them.
</p>

<p>
<b>libcap.</b>
This is the one that didn&#39;t compile:
<tt>/home/filc/fil-c/pizfix/bin/ld: /usr/libexec/gcc/x86_64-linux-gnu/14/liblto_plugin.so: error loading plugin: libc.so.6: cannot open shared object file: No such file or directory</tt>
</p>

<p>
<b>util-linux.</b>
I skipped this one.
It does compile,
but the compiled <tt>taskset</tt> utility needs to be patched to use
<tt>sched_getaffinity</tt> and <tt>sched_setaffinity</tt>
as library functions rather than via <tt>syscall</tt>,
or Fil-C needs to be patched for those syscalls.
This is an issue for <tt>build-parallel</tt>
since <tt>build-parallel</tt> relies on <tt>taskset</tt>;
maybe <tt>build-parallel</tt> should instead use Python&#39;s affinity functions.
</p>

<p>
<b>
attr, bash, benchmarks, binutils, bison, brotli, bzip2, bzip3, check, cmake, coreutils, cpython, curl, dash, diffutils, elfutils, emacs, expat, ffi, gettext, git,
gmp, grep, icu, jpeg-6b, libarchive, libcap, libedit, libevent, libpipeline, libuev, libuv, lua, lz4, m4, make, mg, ncurses, nghttp2, openssh, openssl, pcre2, pcre,
perl, pkgconf, procps, quickjs, sed, shadow, simdutf, sqlite, tcl, tmux, toybox, vim, wg14_signals, xml_parser, xz, zlib, zsh, zstd.</b>
No problems encountered so far
(given whatever patches were already applied from the Fil-C author!).
The benchmarks package is supplied with Fil-C and does a few miscellaneous measurements.
</p>

<h2><a name="further">Further libraries and applications</a></h2>
<p>
I did
<tt>export PATH=&#34;$HOME/bin:$HOME/fil-c/build/bin:$HOME/fil-c/pizfix/bin:$PATH&#34;</tt>
before these.
</p>

<p>
<b>boost 1.89.0</b>:
Seems to mostly work.
Most of the package is header-only;
a few simple tests worked fine.
</p>
<p>
I also looked a bit at the compiled parts.
Running
<tt>./bootstrap.sh --with-toolset=clang --prefix=$HOME</tt>
ran into <tt>vfork</tt>,
which Fil-C doesn&#39;t support,
but editing
<tt>tools/build/src/engine/execunix.cpp</tt>
to use <tt>defined(__APPLE__) || defined(__FILC__)</tt>
for the no-fork test got past this.
</p>
<p>
Running <tt>./b2 install --prefix=$HOME toolset=clang address-model=64 architecture=x86_64 binary-format=elf</tt>
produced an error message since I should have said <tt>x86</tt> instead of <tt>x86_64</tt>;
Fil-C said it caught a safety issue in the <tt>b2</tt> program after the error message:
<tt>filc safety error: argument size mismatch (actual = 8, expected = 16)</tt>.
I didn&#39;t compile with debugging so Fil-C didn&#39;t say where this is in <tt>b2</tt>.
</p>

<p>
<b>cdb-20251021</b>:
Seems to work.
One regression test, an artificial out-of-memory regression test,
currently produces a different error message with Fil-C:
<tt>filc panic: src/libpas/pas_compact_heap_reservation.c:65: pas_aligned_allocation_result pas_compact_heap_reservation_try_allocate(size_t, size_t):
assertion page_result.result failed.</tt>
</p>

<p>
<b>libcpucycles-20250925</b>:
Seems to work.
I commented out the first three lines of <tt>cpucycles/options</tt>.
</p>

<p>
<b>libgc</b>:
I replaced this with a small gcshim package
(<a href="https://cr.yp.to/2025/gcshim-20251022.tar.gz">https://cr.yp.to/2025/gcshim-20251022.tar.gz</a>)
that simply calls <tt>malloc</tt> etc.
So far this seems to be an adequate replacement.
(Fil-C includes a garbage collector.)
</p>

<p>
<b>libntruprime-20241021</b>:
Seems to work after a few tweaks but I didn&#39;t collect full notes yet.
<tt>chmod +t crypto_hashblocks/sha512/avx2</tt> disables assembly and makes things compile;
configured with <tt>--no-valgrind</tt> since Fil-C doesn&#39;t support valgrind;
did a bit more tweaking to make <tt>cpuid</tt> work.
</p>

<p>
<b>lpeg-1.1.0:</b>
Compiles, maybe works (depends on lua, dependency of neovim):
</p><pre><code>cd
PREFIX=$(dirname $(dirname $(which lua)))
wget https://www.inf.puc-rio.br/~roberto/lpeg/lpeg-1.1.0.tar.gz
tar -xf lpeg-1.1.0.tar.gz
cd lpeg-1.1.0
make CC=`which filcc` DLLFLAGS=&#39;-shared -fPIC&#39; test
cp lpeg.so $PREFIX/lib
</code></pre>


<p>
<b>luv-1.51.0:</b>
Compiles, maybe works (depends on lua, dependency of neovim):
</p><pre><code>cd
PREFIX=$(dirname $(dirname $(which lua)))
wget https://github.com/luvit/luv/releases/download/1.51.0-1/luv-1.51.0-1.tar.gz
tar -xf luv-1.51.0-1.tar.gz
cd luv-1.51.0-1
mkdir build
cd build
LUA_DIR=$HOME/fil-c/projects/lua-5.4.7
# lua install should probably do this:
cp $LUA_DIR/lua.h $PREFIX/include/
cp $LUA_DIR/lauxlib.h $PREFIX/include/
cp $LUA_DIR/luaconf.h $PREFIX/include/
cp $LUA_DIR/lualib.h $PREFIX/include/
# and then:
cmake -DCMAKE_C_COMPILER=`which filcc` -DCMAKE_INSTALL_PREFIX=$PREFIX -DWITH_LUA_ENGINE=Lua -DLUA_DIR=$HOME/fil-c/projects/lua-5.4.7/ ..
make test
make install
</code></pre>


<p>
<b>mutt-2-2-15-rel</b> (depends on ncurses):
</p><pre><code>wget https://github.com/muttmua/mutt/archive/refs/tags/mutt-2-2-15-rel.tar.gz
tar -xf mutt-2-2-15-rel.tar.gz
cd mutt-mutt-2-2-15-rel
CC=`which clang` ./prepare --prefix=$HOME/fil-c/pizfix --with-homespool
make -j12 install
</code></pre>
Seems to work, at least for reading email.


<p>
<b>tig</b> (depends on ncurses and maybe more):
</p><pre><code>wget https://github.com/jonas/tig/releases/download/tig-2.6.0/tig-2.6.0.tar.gz
tar -xf tig-2.6.0.tar.gz
cd tig-2.6.0
CC=`which filcc` ./configure --prefix=$(dirname $(dirname $(which git)))
make -j12
make test
make -j12 install
</code></pre>
Seems to work, at least for viewing the Fil-C repo.


<p>
<b>w3m</b> (depends on gcshim and ncurses):
Seems to work.
I tried the Debian version:
<tt>git clone https://salsa.debian.org/debian/w3m.git</tt>.
I used <tt>CFLAGS=-Wno-incompatible-function-pointer-types</tt>
(which is probably needed for clang anyway even without Fil-C).
</p>

<h2><a name="debian">Debian using Fil-C (Filian?)</a></h2>
<p>
I&#39;ve built and installed some replacement Debian packages using Fil-C as the compiler on a Debian 13 machine,
as explained below.
Hopefully this can rapidly scale to many packages,
taking advantage of the basic compile-install-test knowledge already built into Debian source packages,
although some packages will take more work because they need extra patches to work with Fil-C.
</p>
<p>
<b>Structure.</b>
Debian already understands how to have packages for multiple architectures (ABIs; Debian &#34;ports&#34;) installed at once.
For example,
<tt>dpkg --add-architecture i386; apt update; apt install bash:i386</tt>
installs a 32-bit version of bash,
replacing the usual 64-bit version;
you can do <tt>apt install bash:amd64</tt> to revert to the 64-bit version.
Meanwhile the 32-bit libraries and 64-bit libraries are installed in separate locations,
basically
<tt>/lib/i386-linux-gnu</tt>
or
<tt>/usr/lib/i386-linux-gnu</tt>
vs.
<tt>/lib/x86_64-linux-gnu</tt>
or
<tt>/usr/lib/x86_64-linux-gnu</tt>.
(On Debian 11 and newer, and on Ubuntu 22.04 and newer,
<tt>/lib</tt> is symlinked to <tt>/usr/lib</tt>.)
</p>
<p>
I&#39;m following this model for plugging Fil-C into Debian:
the goal is for <tt>apt install bash:amd64fil0</tt>
to install a Fil-C-compiled (<tt>amd64fil0</tt>) version of bash,
replacing the usual (<tt>amd64</tt>) version of bash,
while the <tt>amd64</tt> and <tt>amd64fil0</tt> libraries are installed in separate locations.
</p>
<p>
<b>The include-file complication.</b>
Debian
<a href="https://wiki.debian.org/Multiarch/LibraryPathOverview">expects</a>
library packages compiled for multiple ABIs
to all provide the same include files:
for example, <tt>/usr/include/ncurses.h</tt>
is provided by <tt>libncurses-dev:i386</tt>, <tt>libncurses-dev:amd64</tt>, etc.
This is safe because Debian forces
<tt>libncurses-dev:i386</tt> and <tt>libncurses-dev:amd64</tt> and so on
to all have the same version.
An occasional package with ABI-dependent include files
can still use <tt>/usr/include/x86_64-linux-gnu</tt> etc.
</p>
<p>
Fil-C instead omits <tt>/usr/include</tt>
in favor of a Fil-C-specific directory
(which will typically be different from <tt>/usr/include</tt>:
even if Fil-C is compiled with glibc,
probably the glibc version won&#39;t be the same as in <tt>/usr/include</tt>).
This difference is the top source of messiness below.
I&#39;m planning to tweak the Fil-C driver to use <tt>/usr/include</tt> on Debian.
[This is done in the <tt>filian-install-compiler</tt> script.]
</p>
<p>
Something else I&#39;m planning to tweak is Fil-C&#39;s glibc compilation,
so that it uses the final system prefix.
[This is also done in the <tt>filian-install-compiler</tt> script.]
The approach described below instead requires
<tt>/home/filian/fil-c</tt> to stay in place
for compiling and running programs.
</p><p>
<b>Building Debian packages.</b>
How does Debian package building work?
First, more packages to install as root:
</p>
<pre><code>apt install dpkg-dev devscripts docbook2x \
  dh-exec dh-python python3-setuptools fakeroot \
  sbuild mmdebstrap uidmap piuparts
</code></pre>
<p>
Debian has
<a href="https://wiki.debian.org/PackagingTools#Package_build_tools">multiple options</a>
for building a package.
The option that has the best isolation,
and that Debian uses to continually build new packages for distribution,
is sbuild,
but for fast development I&#39;ll focus on directly using the lower-level
dpkg-buildpackage.
</p>
<p>
<b>Baseline 1: using sbuild without Fil-C.</b>
In case you do want to try sbuild,
here&#39;s the basic setup,
and then an example of building a small package (tinycdb):
</p><pre><code>mkdir -p ~/shared/sbuild
time mmdebstrap --include=ca-certificates --skip=output/dev --variant=buildd unstable ~/shared/sbuild/unstable-amd64.tar.zst https://deb.debian.org/debian

mkdir -p ~/.config/sbuild
cat &lt;&lt; &#34;EOF&#34; &gt; ~/.config/sbuild/config.pl
$chroot_mode = &#39;unshare&#39;;
$external_commands = { &#34;build-failed-commands&#34; =&gt; [ [ &#39;%SBUILD_SHELL&#39; ] ] };
$build_arch_all = 1;
$build_source = 1;
$source_only_changes = 1;
$run_lintian = 1;
$lintian_opts = [&#39;--display-info&#39;, &#39;--verbose&#39;, &#39;--fail-on&#39;, &#39;error,warning&#39;, &#39;--info&#39;];
$run_autopkgtest = 1;
$run_piuparts = 1;
$piuparts_opts = [&#39;--no-eatmydata&#39;, &#39;--distribution=%r&#39;, &#39;--fake-essential-packages=systemd-sysv&#39;];
EOF

mkdir -p ~/shared/packages
cd ~/shared/packages
apt source tinycdb
cd tinycdb-*/
time sbuild
</code></pre>

<p>
<b>Baseline 2: using dpkg-buildpackage without Fil-C.</b>
Here&#39;s what it looks like compiling the same small package with dpkg-buildpackage:
</p><pre><code>mkdir -p ~/shared/packages
cd ~/shared/packages
apt source tinycdb
cd tinycdb-*/
time dpkg-buildpackage -us -uc -b
</code></pre>

<p>
<b>The goal: Using dpkg-buildpackage with Fil-C.</b>
As root, teach dpkg basic features of the new architecture,
imitating the current line
<tt>amd64 x86_64 (amd64|x86_64) 64 little</tt>
in the same file:
</p>
<pre><code>echo amd64fil0 x86_64+fil0 amd64fil0 64 little &gt;&gt; /usr/share/dpkg/cputable
</code></pre>

<p>
Also, allow <tt>apt</tt> to install packages compiled for this architecture
(beware that this will also later make <tt>apt update</tt> look for that architecture on servers,
and whimper a bit for not finding it,
but nothing breaks):
</p>
<pre><code>dpkg --add-architecture amd64fil0
</code></pre>
<p>
Also, teach <tt>autoconf</tt> to accept amd64fil0
(the third of these lines is what&#39;s critical for Debian builds):
</p>
<pre><code>sed -i &#39;/| x86_64 / a| x86_64+fil0 \\&#39; /usr/share/autoconf/build-aux/config.sub
sed -i &#39;/| x86_64 / a| x86_64+fil0 \\&#39; /usr/share/libtool/build-aux/config.sub
sed -i &#39;/| x86_64 / a| x86_64+fil0 \\&#39; /usr/share/misc/config.sub
</code></pre>
<p>
[Not necessary if you&#39;ve used <tt>filian-install-compiler</tt>:]
As a <tt>filian</tt> user,
compile Fil-C and its standard library:
</p>
<pre><code>cd
git clone https://github.com/pizlonator/fil-c.git
cd fil-c
time ./build_all_fast_glibc.sh
</code></pre>
<p>
[Not necessary if you&#39;ve used <tt>filian-install-compiler</tt>:]
As root,
copy Fil-C and its standard library into system locations:
</p>
<pre><code>mkdir -p /usr/libexec/fil/amd64/compiler
time cp -r /home/filian/fil-c/pizfix /usr/libexec/fil/amd64/
rm -rf /usr/lib/x86_64+fil0-linux-gnu
mv /usr/libexec/fil/amd64/pizfix/lib /usr/lib/x86_64+fil0-linux-gnu
ln -s /usr/lib/x86_64+fil0-linux-gnu /usr/libexec/fil/amd64/pizfix/lib
rm -rf /usr/include/x86_64+fil0-linux-gnu
mv /usr/libexec/fil/amd64/pizfix/include /usr/include/x86_64+fil0-linux-gnu
ln -s /usr/include/x86_64+fil0-linux-gnu /usr/libexec/fil/amd64/pizfix/include
time cp -r /home/filian/fil-c/build/bin /usr/libexec/fil/amd64/compiler/
time cp -r /home/filian/fil-c/build/include /usr/libexec/fil/amd64/compiler/
time cp -r /home/filian/fil-c/build/lib /usr/libexec/fil/amd64/compiler/
( echo &#39;#!/bin/sh&#39;
  echo &#39;exec /usr/libexec/fil/amd64/compiler/bin/filcc &#34;$@&#34;&#39; ) &gt; /usr/bin/x86_64+fil0-linux-gnu-gcc
chmod 755 /usr/bin/x86_64+fil0-linux-gnu-gcc
( echo &#39;#!/bin/sh&#39;
  echo &#39;exec /usr/libexec/fil/amd64/compiler/bin/fil++ &#34;$@&#34;&#39; ) &gt; /usr/bin/x86_64+fil0-linux-gnu-g++
chmod 755 /usr/bin/x86_64+fil0-linux-gnu-g++
ln -s /usr/libexec/fil/amd64/compiler/bin/llvm-objdump /usr/bin/x86_64+fil0-linux-gnu-objdump
ln -s x86_64+fil0-linux-gnu-gcc /usr/bin/filcc
ln -s x86_64+fil0-linux-gnu-g++ /usr/bin/fil++
</code></pre>
<p>
Now, as user <tt>filian</tt> (or whichever other user),
let&#39;s make a little helper script to adjust a Debian source package:
</p>
<pre><code>mkdir -p $HOME/bin
( echo &#39;#!/bin/sh&#39;
  echo &#39;sed -i &#39;\&#39;&#39;s/^ \([^&#34;]*\)$/ pizlonated_\1/&#39;\&#39;&#39; debian/*.symbols&#39;
  echo &#39;find . -name &#39;\&#39;&#39;*.map&#39;\&#39;&#39; | while read fn&#39;
  echo &#39;do&#39;
  echo &#39;  awk &#39;\&#39;&#39;{&#39;
  echo &#39;    if ($1 == &#34;local:&#34;) global = 0&#39;
  echo &#39;    if ($1 == &#34;}&#34;) global = 0&#39;
  echo &#39;    if (global &amp;&amp; NF &gt; 0 &amp;&amp; !index($0,&#34;c++&#34;)) $1 = &#34;pizlonated_&#34;$1&#39;
  echo &#39;    if ($1 == &#34;global:&#34;) global = 1&#39;
  echo &#39;    print&#39;
  echo &#39;  }&#39;\&#39;&#39; &lt; $fn &gt; $fn.tmp&#39;
  echo &#39;  mv $fn.tmp $fn&#39;
  echo &#39;done&#39;
  echo &#39;find debian -name &#39;\&#39;&#39;*.install&#39;\&#39;&#39; | while read fn&#39;
  echo &#39;do&#39;
  echo &#39;  awk &#39;\&#39;&#39;{&#39;
  echo &#39;    if (NF == 2 &amp;&amp; $2 == &#34;usr/include&#34;) $2 = $2&#34;/${DEB_HOST_MULTIARCH}&#34;&#39;
  echo &#39;    if (NF == 1 &amp;&amp; $1 == &#34;usr/include&#34;) { $2 = $1&#34;/${DEB_HOST_MULTIARCH}&#34;; $1 = $1&#34;/*&#34; }&#39;
  echo &#39;    print&#39;
  echo &#39;  }&#39;\&#39;&#39; &lt; $fn &gt; $fn.tmp&#39;
  echo &#39;  mv $fn.tmp $fn&#39;
  echo &#39;done&#39;
) &gt; $HOME/bin/fillet
chmod 755 $HOME/bin/fillet
</code></pre>
And now let&#39;s try building a small package:

<pre><code>mkdir -p ~/shared/packages
cd ~/shared/packages
apt source tinycdb
cd tinycdb-*/
$HOME/bin/fillet
time env DPKG_GENSYMBOLS_CHECK_LEVEL=0 \
  DEB_BUILD_OPTIONS=&#39;crossbuildcanrunhostbinaries nostrip&#39; \
  dpkg-buildpackage -d -us -uc -b -a amd64fil0
</code></pre>

<p>
Explanation of the differences from a normal build:
</p>
<ul>
<li>
<tt>DEB_BUILD_OPTIONS=nostrip</tt> skips removing symbols from binaries,
in part because Debian&#39;s <tt>dh_dwz</tt> utility doesn&#39;t currently work with Fil-C,
in part because we&#39;ll look at symbols later.
</li>
<li>
<tt>DEB_BUILD_OPTIONS=crossbuildcanrunhostbinaries</tt> silences a warning
about cross-compilation not necessarily working with tests.
</li>
<li>
<tt>-a amd64fil0</tt> specifies the <tt>amd64fil0</tt> ABI,
which triggers using the <tt>x86_64+fil0-linux-gnu-gcc</tt> compiler.
</li>
<li>
<tt>-d</tt> stops <tt>dpkg-buildpackage</tt>
from checking for dependencies.
(This doesn&#39;t matter for this package.)
</li>
<li>
[Superseded by the <tt>binutils</tt> patch in in <tt>filian-install-compiler</tt> starting with version 20251030:]
The tweak to <tt>*.map</tt> in the helper script
tries to stop Debian from hiding the shared-library symbols after Fil-C mangling.
</li>
<li>
The tweak to <tt>*.symbols</tt> in the helper script
tries to notify Debian regarding the expected shared-library symbols after Fil-C mangling.
[Not necessary given <tt>DPKG_GENSYMBOLS_CHECK_LEVEL=0</tt>.]
</li>
<li>
<tt>DPKG_GENSYMBOLS_CHECK_LEVEL=0</tt>
should stop Debian from complaining that there are wrong symbols.
</li>
<li>
[Not necessary if you&#39;ve used <tt>filian-install-compiler</tt>:]
The tweak to <tt>*.install</tt> in the helper script
installs <tt>/usr/include/x86_64+fil0/cdb.h</tt>
(where Fil-C will see it for programs using this library)
instead of <tt>/usr/include/cdb.h</tt>.
</li>
</ul>
<p>
For me this worked and produced three <tt>../*.deb</tt> packages.
Installing them as root also worked:
</p>
<pre><code>apt install /home/filian/shared/packages/*.deb
# some sanity checks:
apt list | grep tinycdb
# prints &#34;tinycdb/stable 0.81-2 amd64&#34; (available package)
# and prints &#34;tinycdb/now 0.81-2 amd64fil0 [installed,local]&#34;
dpkg -L tinycdb:amd64fil0
# lists various files such as /usr/bin/cdb
nm /usr/bin/cdb
# shows various symbols including &#34;pizlonated&#34; (Fil-C) symbols
ldd /usr/bin/cdb
# shows dependence on libraries in /usr/libexec/fil
/usr/bin/cdb -h
# prints a help message: &#34;cdb: Constant DataBase&#34; etc.
</code></pre>
<p>
Compiling a deliberately wrong test program
with the newly installed library also works,
and triggers Fil-C&#39;s run-time protection:
</p>
<pre><code>cd /root
( echo &#39;#include &lt;cdb.h&gt;&#39;
  echo &#39;int main() { cdb_init(0,0); return 0; }&#39; ) &gt; usecdb.c
filcc -o usecdb usecdb.c -lcdb
./usecdb &lt; /bin/bash
# ... &#34;filc panic: thwarted a futile attempt to violate memory safety.&#34;
</code></pre>

<h2><a name="moredebian">More Debian packages</a></h2>
<p>
<b>libc-dev.</b>
Some packages depend on libc-dev,
so let&#39;s build a fake libc-dev package
(probably there&#39;s an easier way to do this):
</p>
<pre><code>FAKEPACKAGE=libc-dev
mkdir -p ~/shared/packages/$FAKEPACKAGE/debian
cd ~/shared/packages/$FAKEPACKAGE
( echo $FAKEPACKAGE&#39; (0.0) unstable; urgency=medium&#39;
  echo &#39;&#39;
  echo &#39;  * Initial Release.&#39;
  echo &#39;&#39;
  echo &#39; -- djb &lt;djb@cr.yp.to&gt;  Sun, 26 Oct 2025 16:05:17 +0000&#39;
) &gt; debian/changelog
( echo &#39;Source: &#39;$FAKEPACKAGE
  echo &#39;Build-Depends: debhelper-compat (= 13)&#39;
  echo &#39;Maintainer: djb <djb@cr.yp.to>&#39;
  echo &#39;&#39;
  echo &#39;Package: &#39;$FAKEPACKAGE
  echo &#39;Architecture: any&#39;
  echo &#39;Multi-Arch: same&#39;
  echo &#39;Description: fake &#39;$FAKEPACKAGE
) &gt; debian/control
( echo &#39;#!/usr/bin/make -f&#39;
  echo &#39;&#39;
  echo &#39;build-arch   build-indep   build \&#39;
  echo &#39;install-arch install-indep install \&#39;
  echo &#39;binary-arch  binary-indep  binary \&#39;
  echo &#39;:&#39;
  echo &#39;Xdh $@&#39; | tr X &#39;\011&#39;
  echo &#39;&#39;
  echo &#39;clean:&#39;
  echo &#39;Xdh_clean&#39; | tr X &#39;\011&#39;
) &gt; debian/rules
time env DPKG_GENSYMBOLS_CHECK_LEVEL=0 \
  DEB_BUILD_OPTIONS=&#39;crossbuildcanrunhostbinaries nostrip&#39; \
  dpkg-buildpackage -d -us -uc -b -a amd64fil0
</djb@cr.yp.to></code></pre>
<p>
<b>ncurses.</b>
</p>
<pre><code>mkdir -p ~/shared/packages
cd ~/shared/packages
apt source ncurses
cd ncurses-*/
$HOME/bin/fillet
time env DPKG_GENSYMBOLS_CHECK_LEVEL=0 \
  DEB_BUILD_OPTIONS=&#39;crossbuildcanrunhostbinaries nostrip&#39; \
  dpkg-buildpackage -d -us -uc -b -a amd64fil0
rm ../ncurses-*deb # apt won&#39;t let us touch the binaries
</code></pre>
<p>
As root, install the above libraries:
</p>
<pre><code>apt install /home/filian/shared/packages/lib*.deb
</code></pre>
<p>
<b>libmd.</b>
Seems to work.
At first this didn&#39;t install
since the compiled version (for amd64fil0) was 1.1.0-2
while the installed version (for amd64) was 1.1.0-2+b1.
Debian requires the same version number across architectures
(see above regarding include-file compatibility),
so <tt>apt</tt> said that 1.1.0-2+b1 breaks 1.1.0-2.
I resolved this by compiling and installing 1.1.0-2 for both amd64 and amd64fil0.
This is a downgrade since &#34;+b&#34; refers to
a &#34;binNMU&#34;, a &#34;binary-only non-maintainer upload&#34;,
a patch beyond the official source;
I don&#39;t know what the patch is.
</p>
<p>
<b>readline.</b>
Needs
<tt>ln -s /usr/include/readline /usr/include/x86_64+fil0-linux-gnu/readline</tt>
after installation.
Could have tweaks in <tt>debian/rules</tt>
(which seems to predate <tt>*.install</tt>),
but this is in any case an example of the messiness that I&#39;m planning to get rid of.
</p>
<p>
<b>lua5.4.</b>
Seems to work.
Depends on readline.
</p>


</div>
  </body>
</html>
