<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://alew.is/lava.html">Original</a>
    <h1>Love C, hate C: Web framework memory problems</h1>
    
    <div id="readability-page-1" class="page">
<p>I love C. I could give you rational reasons for that. Like the fact that it works everywhere and how it goes fast. But mostly I love C because when I write C I feel an intimate connection with my computer. To me, C has soul. In fact all my personal project are written in C, like the graphics rendering engines that I&#39;m currently writing. The problem is that C is dangerous and sharing new C projects to wider audiences is borderline malicious.</p>
<p>Today on hacker news a cool little <a href="https://news.ycombinator.com/item?id=45526890">web framework written in C</a> was posted. As a security researcher I&#39;m always trying to sharpen my skills so I thought I&#39;d given the app a look. And yup sure enough, there&#39;s memory safety issues.</p>
<pre><code>HttpParser parseRequest(<span>char</span> *request) {
    HttpParser parser = {
        .isValid = <span>true</span>,
        .requestBuffer = strdup(request), 
        .requestLength = <span>strlen</span>(request),
        .position = <span>0</span>,
    };

    

    <span>for</span> (<span>int</span> i = <span>0</span>; i &lt; parser.request.headerCount; i++) {
        <span>if</span> (strcasecmp(parser.request.headers[i].name, <span>&#34;Content-Length&#34;</span>) == <span>0</span>) {
            parser.request.bodyLength = atoi(parser.request.headers[i].value); 
            <span>break</span>;
        }
    }
    
    parser.request.body = <span>malloc</span>(parser.request.bodyLength + <span>1</span>); 
    <span>for</span> (<span>int</span> i = parser.position; i &lt; parser.position + parser.request.bodyLength; i++) {
        parser.request.body[i - parser.position] = parser.requestBuffer[i]; 
    }</code></pre>
<p>line [1] takes Content-Length off the http packet. This is a non validated value basically straight from the socket. line [2] allocates based on that size. Line [3] copies data into that buffer based on that size. But it&#39;s copying <strong>out</strong> of a buffer of <em>any</em> size. So passing a <code>Content-Length</code> Larger than the <code>request</code> sent in will start copying heap data into the <code>parser.request.body</code>.</p>
<p>Another interesting choice in this project is to make lengths signed:</p>
<pre><code><span>typedef</span> <span>struct</span> {
    

    <span>int</span>        headerCount;
    <span>int</span>        headerCapacity;

    
    <span>int</span>        bodyLength;
} HttpRequest;

<span>typedef</span> <span>struct</span> {
    
    
    <span>int</span>         position;
    
    <span>int</span>         requestLength;
} HttpParser;</code></pre>
<p>What does it mean to have a negative <code>headerCount</code> or negative of anything here? Maybe there is a valid meaning, but we need to ask ourselves that question. Going back to the original code sample. A malicious user can pass <code>Content-Length</code> of <code>4294967295</code>. <code>malloc(parser.request.bodyLength + 1)</code> which becomes <code>malloc(0)</code> actually returns a  valid pointer in glibc. Now you won&#39;t immediately buffer overflow here because <code>i &lt; parser.position + parser.request.bodyLength</code> where i is initialized to <code>parser.position</code> and it&#39;s basically <code>parser.position-1</code> so <code>i</code> will always be greater. But these mangled request body and length values get routed to the webdevs App. You&#39;d better hope they catch the issue.</p>
<p>I love C it&#39;s simple, elegant but also so dang annoying.</p>
<p>Comments to be found on <a href="https://news.ycombinator.com/item?id=45535183">this hackernews thread</a>. Ping me there to talk security, C, or graphics and rendering haha :)</p>

<hr/>


</div>
  </body>
</html>
