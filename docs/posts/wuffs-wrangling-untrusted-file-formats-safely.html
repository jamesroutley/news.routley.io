<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/google/wuffs">Original</a>
    <h1>Wuffs: Wrangling Untrusted File Formats Safely</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto">Wuffs is a <strong>memory-safe programming language</strong> (and a <strong>standard library</strong>
written in that language) for <strong>Wrangling Untrusted File Formats Safely</strong>.
Wrangling includes parsing, decoding and encoding. Example file formats include
images, audio, video, fonts and compressed archives.</p>
<p dir="auto">It is <a href="https://twitter.com/richgel999/status/1481027198530248714" rel="nofollow"><strong>&#34;ridiculously
fast&#34;</strong></a>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/google/wuffs/blob/main/test/data/ridiculously-fast.png"><img src="https://github.com/google/wuffs/raw/main/test/data/ridiculously-fast.png" alt="Screenshot of a tweet saying &#34;ridiculously fast&#34;"/></a></p>
<p dir="auto">Per its <a href="https://github.com/google/wuffs/blob/main/doc/benchmarks.md">benchmarks</a> and other linked-to blog posts:</p>
<ul dir="auto">
<li>It can decode bzip2 <strong><a href="https://nigeltao.github.io/blog/2022/wuffs-bzip2-decoder.html" rel="nofollow">1.3x faster than <code>/usr/bin/bzcat</code>
(C)</a></strong>.</li>
<li>It can decode deflate up to <strong>1.4x faster than zlib-the-library (C)</strong>.</li>
<li>It can decode GIF <strong>2x-6x faster than &#34;giflib&#34; (C), &#34;image/gif&#34; (Go) and
&#34;gif&#34; (Rust)</strong>.</li>
<li>It can decode PNG <strong><a href="https://nigeltao.github.io/blog/2021/fastest-safest-png-decoder.html" rel="nofollow">1.2x-2.7x faster than &#34;libpng&#34; (C), &#34;image/png&#34; (Go) and
&#34;png&#34;
(Rust)</a></strong>.</li>
</ul>

<p dir="auto">Wuffs&#39; goal is to produce software libraries that are as safe as Go or Rust,
roughly speaking, but as fast as C, and that can be used anywhere C libraries
are used. This includes very large C/C++ projects, such as popular web browsers
and operating systems (using that term to include desktop and mobile user
interfaces, not just the kernel).</p>
<p dir="auto"><a href="https://github.com/google/wuffs/blob/main/doc/wuffs-the-library.md">Wuffs the Library</a> is <a href="https://github.com/google/wuffs/blob/main/release/c">available</a> as
transpiled C code. Other C/C++ projects can <strong>use that library without
requiring the <a href="https://github.com/google/wuffs/blob/main/doc/wuffs-the-language.md">Wuffs the Language</a> toolchain</strong>.
Those projects can use Wuffs the Library like using any other third party C
library. It&#39;s just not hand-written C.</p>
<p dir="auto">However, unlike hand-written C, Wuffs the Language is safe with respect to
buffer overflows, integer arithmetic overflows and null pointer dereferences. A
key difference between Wuffs and other memory-safe languages is that <strong>all such
checks are done at compile time, not at run time</strong>. If it compiles, it is safe,
with respect to those three bug classes.</p>
<p dir="auto">The trade-off in aiming for both safety and speed is that Wuffs programs take
longer for a programmer to write, as they have to <strong>explicitly annotate their
programs with proofs of safety</strong>. A statement like <code>x += 1</code> unsurprisingly
means to increment the variable <code>x</code> by <code>1</code>. However, in Wuffs, such a statement
is a compile time error unless the compiler can also prove that <code>x</code> is not the
maximal value of <code>x</code>&#39;s type (e.g. <code>x</code> is not <code>255</code> if <code>x</code> is a <code>base.u8</code>), as
the increment would otherwise overflow. Similarly, an integer arithmetic
expression like <code>x / y</code> is a compile time error unless the compiler can also
prove that <code>y</code> is not zero.</p>

<p dir="auto">Wuffs is not a general purpose programming language. <strong>It is for writing
libraries, not programs</strong>. Wuffs code is <a href="https://github.com/google/wuffs/blob/main/doc/note/hermeticity.md">hermetic</a>
and can only compute (e.g. convert &#34;compressed bytes&#34; to &#34;decompressed bytes&#34;).
<strong>It cannot make any syscalls</strong> (e.g. it has no ambient authority to read your
files), implying that it cannot allocate or free memory (and is therefore
trivially safe against things like memory leaks, use-after-frees and
double-frees).</p>
<p dir="auto">It produces <a href="https://sans-io.readthedocs.io/" rel="nofollow">Sans I/O style</a> libraries (but C
libraries, not Python), meaning that they are agnostic to <a href="https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/" rel="nofollow">&#39;function
colors&#39;</a>.
They can be combined with synchronous or asynchronous I/O, as the library
caller (not library implementation) is responsible for the actual I/O.</p>
<p dir="auto">The idea isn&#39;t to write your whole program in Wuffs, <strong>only the parts that are
both performance-conscious and security-conscious</strong>. For example, while
technically possible, it is unlikely that a Wuffs compiler would be worth
writing entirely in Wuffs.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">What Does Wuffs Code Look Like?</h2><a id="user-content-what-does-wuffs-code-look-like" aria-label="Permalink: What Does Wuffs Code Look Like?" href="#what-does-wuffs-code-look-like"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The <a href="https://github.com/google/wuffs/blob/main/std/lzw/decode_lzw.wuffs"><code>/std/lzw/decode_lzw.wuffs</code></a> file is a good
example. The <a href="https://github.com/google/wuffs/blob/main/doc/wuffs-the-language.md">Wuffs the Language</a> document has more
information on how it differs from other languages in the C family.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">What Does Compile Time Checking Look Like?</h2><a id="user-content-what-does-compile-time-checking-look-like" aria-label="Permalink: What Does Compile Time Checking Look Like?" href="#what-does-compile-time-checking-look-like"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">For example, making this one-line edit to the LZW codec leads to a compile time
error. <code>wuffs gen</code> fails to generate the C code, i.e. fails to compile
(transpile) the Wuffs code to C code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="diff --git a/std/lzw/decode_lzw.wuffs b/std/lzw/decode_lzw.wuffs
index f878c5e..f10dcee 100644
--- a/std/lzw/decode_lzw.wuffs
+++ b/std/lzw/decode_lzw.wuffs
@@ -98,7 +98,7 @@ pub func lzw_decoder.decode?(dst ptr buf1, src ptr buf1, src_final bool)() {
                        in.dst.write?(x:s)

                        if use_save_code {
-                               this.suffixes[save_code] = c as u8
+                               this.suffixes[save_code] = (c + 1) as u8
                                this.prefixes[save_code] = prev_code as u16
                        }"><pre><span>diff --git a/std/lzw/decode_lzw.wuffs b/std/lzw/decode_lzw.wuffs</span>
index f878c5e..f10dcee 100644
<span>--- a/std/lzw/decode_lzw.wuffs</span>
<span>+++ b/std/lzw/decode_lzw.wuffs</span>
<span>@@ -98,7 +98,7 @@</span> pub func lzw_decoder.decode?(dst ptr buf1, src ptr buf1, src_final bool)() {
                        in.dst.write?(x:s)

                        if use_save_code {
<span><span>-</span>                               this.suffixes[save_code] = c as u8</span>
<span><span>+</span>                               this.suffixes[save_code] = (c + 1) as u8</span>
                                this.prefixes[save_code] = prev_code as u16
                        }</pre></div>
<div data-snippet-clipboard-copy-content="$ wuffs gen std/gif
check: expression &#34;(c + 1) as u8&#34; bounds [1 ..= 256] is not within bounds [0 ..= 255] at
/home/n/go/src/github.com/google/wuffs/std/lzw/decode_lzw.wuffs:101. Facts:
    n_bits &lt; 8
    c &lt; 256
    this.stack[s] == (c as u8)
    use_save_code"><pre><code>$ wuffs gen std/gif
check: expression &#34;(c + 1) as u8&#34; bounds [1 ..= 256] is not within bounds [0 ..= 255] at
/home/n/go/src/github.com/google/wuffs/std/lzw/decode_lzw.wuffs:101. Facts:
    n_bits &lt; 8
    c &lt; 256
    this.stack[s] == (c as u8)
    use_save_code
</code></pre></div>
<p dir="auto">In comparison, this two-line edit will compile (but the &#34;does it decode GIF
correctly&#34; tests then fail):</p>
<div dir="auto" data-snippet-clipboard-copy-content="diff --git a/std/lzw/decode_lzw.wuffs b/std/lzw/decode_lzw.wuffs
index f878c5e..b43443d 100644
--- a/std/lzw/decode_lzw.wuffs
+++ b/std/lzw/decode_lzw.wuffs
@@ -97,8 +97,8 @@ pub func lzw_decoder.decode?(dst ptr buf1, src ptr buf1, src_final bool)() {
                        // type checking, bounds checking and code generation for it).
                        in.dst.write?(x:s)

-                       if use_save_code {
-                               this.suffixes[save_code] = c as u8
+                       if use_save_code and (c &lt; 200) {
+                               this.suffixes[save_code] = (c + 1) as u8
                                this.prefixes[save_code] = prev_code as u16
                        }"><pre><span>diff --git a/std/lzw/decode_lzw.wuffs b/std/lzw/decode_lzw.wuffs</span>
index f878c5e..b43443d 100644
<span>--- a/std/lzw/decode_lzw.wuffs</span>
<span>+++ b/std/lzw/decode_lzw.wuffs</span>
<span>@@ -97,8 +97,8 @@</span> pub func lzw_decoder.decode?(dst ptr buf1, src ptr buf1, src_final bool)() {
                        // type checking, bounds checking and code generation for it).
                        in.dst.write?(x:s)

<span><span>-</span>                       if use_save_code {</span>
<span><span>-</span>                               this.suffixes[save_code] = c as u8</span>
<span><span>+</span>                       if use_save_code and (c &lt; 200) {</span>
<span><span>+</span>                               this.suffixes[save_code] = (c + 1) as u8</span>
                                this.prefixes[save_code] = prev_code as u16
                        }</pre></div>
<div data-snippet-clipboard-copy-content="$ wuffs gen std/gif
gen wrote:      /home/n/go/src/github.com/google/wuffs/gen/c/gif.c
gen unchanged:  /home/n/go/src/github.com/google/wuffs/gen/h/gif.h
$ wuffs test std/gif
gen unchanged:  /home/n/go/src/github.com/google/wuffs/gen/c/gif.c
gen unchanged:  /home/n/go/src/github.com/google/wuffs/gen/h/gif.h
test:           /home/n/go/src/github.com/google/wuffs/test/c/gif
gif/basic.c     clang   PASS (8 tests run)
gif/basic.c     gcc     PASS (8 tests run)
gif/gif.c       clang   FAIL test_lzw_decode: bufs1_equal: wi: got 19311, want 19200.
contents differ at byte 3 (in hex: 0x000003):
  000000: dcdc dc00 00d9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3b 618e c8e4 e4e4 e5e4 e600 00e4 bbbb  :;a.............
  000020: eded 8f91 9191 9090 9090 9190 9192 9192  ................
  000030: 9191 9292 9191 9293 93f0 f0f0 f1f1 f2f2  ................
excerpts of got (above) versus want (below):
  000000: dcdc dcdc dcd9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3a 618e c8e4 e4e4 e5e4 e6e4 e4e4 bbbb  ::a.............
  000020: eded 8f91 9191 9090 9090 9090 9191 9191  ................
  000030: 9191 9191 9191 9193 93f0 f0f0 f1f1 f2f2  ................

gif/gif.c       gcc     FAIL test_lzw_decode: bufs1_equal: wi: got 19311, want 19200.
contents differ at byte 3 (in hex: 0x000003):
  000000: dcdc dc00 00d9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3b 618e c8e4 e4e4 e5e4 e600 00e4 bbbb  :;a.............
  000020: eded 8f91 9191 9090 9090 9190 9192 9192  ................
  000030: 9191 9292 9191 9293 93f0 f0f0 f1f1 f2f2  ................
excerpts of got (above) versus want (below):
  000000: dcdc dcdc dcd9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3a 618e c8e4 e4e4 e5e4 e6e4 e4e4 bbbb  ::a.............
  000020: eded 8f91 9191 9090 9090 9090 9191 9191  ................
  000030: 9191 9191 9191 9193 93f0 f0f0 f1f1 f2f2  ................

wuffs-test-c: some tests failed
wuffs test: some tests failed"><pre><code>$ wuffs gen std/gif
gen wrote:      /home/n/go/src/github.com/google/wuffs/gen/c/gif.c
gen unchanged:  /home/n/go/src/github.com/google/wuffs/gen/h/gif.h
$ wuffs test std/gif
gen unchanged:  /home/n/go/src/github.com/google/wuffs/gen/c/gif.c
gen unchanged:  /home/n/go/src/github.com/google/wuffs/gen/h/gif.h
test:           /home/n/go/src/github.com/google/wuffs/test/c/gif
gif/basic.c     clang   PASS (8 tests run)
gif/basic.c     gcc     PASS (8 tests run)
gif/gif.c       clang   FAIL test_lzw_decode: bufs1_equal: wi: got 19311, want 19200.
contents differ at byte 3 (in hex: 0x000003):
  000000: dcdc dc00 00d9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3b 618e c8e4 e4e4 e5e4 e600 00e4 bbbb  :;a.............
  000020: eded 8f91 9191 9090 9090 9190 9192 9192  ................
  000030: 9191 9292 9191 9293 93f0 f0f0 f1f1 f2f2  ................
excerpts of got (above) versus want (below):
  000000: dcdc dcdc dcd9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3a 618e c8e4 e4e4 e5e4 e6e4 e4e4 bbbb  ::a.............
  000020: eded 8f91 9191 9090 9090 9090 9191 9191  ................
  000030: 9191 9191 9191 9193 93f0 f0f0 f1f1 f2f2  ................

gif/gif.c       gcc     FAIL test_lzw_decode: bufs1_equal: wi: got 19311, want 19200.
contents differ at byte 3 (in hex: 0x000003):
  000000: dcdc dc00 00d9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3b 618e c8e4 e4e4 e5e4 e600 00e4 bbbb  :;a.............
  000020: eded 8f91 9191 9090 9090 9190 9192 9192  ................
  000030: 9191 9292 9191 9293 93f0 f0f0 f1f1 f2f2  ................
excerpts of got (above) versus want (below):
  000000: dcdc dcdc dcd9 f5f9 f6df dc5f 393a 3a3a  ..........._9:::
  000010: 3a3a 618e c8e4 e4e4 e5e4 e6e4 e4e4 bbbb  ::a.............
  000020: eded 8f91 9191 9090 9090 9090 9191 9191  ................
  000030: 9191 9191 9191 9193 93f0 f0f0 f1f1 f2f2  ................

wuffs-test-c: some tests failed
wuffs test: some tests failed
</code></pre></div>

<ul dir="auto">
<li><code>lang</code> holds the Go libraries that implement Wuffs the Language: tokenizer,
AST, parser, renderer, etc. The Wuffs tools are written in Go, but as
mentioned above, Wuffs transpiles to C code, and Go is not necessarily
involved if all you want is to use the C edition of Wuffs.</li>
<li><code>lib</code> holds other Go libraries, not specific to Wuffs the Language per se.</li>
<li><code>internal</code> holds internal implementation details, as per Go&#39;s <a href="https://golang.org/s/go14internal" rel="nofollow">internal
packages</a> convention.</li>
<li><code>cmd</code> holds Wuffs the Language&#39; command line tools, also written in Go.</li>
<li><code>std</code> holds Wuffs the Library&#39;s code.</li>
<li><code>release</code> holds the releases (e.g. in their C form) of Wuffs the Library.</li>
<li><code>test</code> holds the regular tests for Wuffs the Library.</li>
<li><code>fuzz</code> holds the fuzz tests for Wuffs the Library.</li>
<li><code>script</code> holds miscellaneous utility programs.</li>
<li><code>doc</code> holds documentation.</li>
<li><code>example</code> holds example programs for Wuffs the Library.</li>
<li><code>hello-wuffs-c</code> holds an example program for Wuffs the Language.</li>
</ul>

<p dir="auto">See the <a href="https://github.com/google/wuffs/blob/main/BUILD.md">BUILD</a> instructions.</p>

<ul dir="auto">
<li><a href="https://github.com/google/wuffs/blob/main/doc/getting-started.md">Getting Started</a>. <strong>Start here</strong> if you want to
play but aren&#39;t sure how (and <a href="https://github.com/google/wuffs/blob/main/BUILD.md">BUILD</a> doesn&#39;t help).</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/background.md">Background</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/benchmarks.md">Benchmarks</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/binary-size.md">Binary Size</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/changelog.md">Changelog</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/glossary.md">Glossary</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/related-work.md">Related Work</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/roadmap.md">Roadmap</a>.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/wuffs-the-language.md">Wuffs the Language</a> overview.</li>
<li><a href="https://github.com/google/wuffs/blob/main/doc/wuffs-the-library.md">Wuffs the Library</a> overview and see also <a href="https://github.com/google/wuffs/blob/main/doc/std">API
categories</a>.</li>
</ul>
<p dir="auto">The <a href="https://github.com/google/wuffs/blob/main/doc/note">Note</a> directory also contains various short articles.</p>

<ul dir="auto">
<li><a href="https://github.com/dev0x13/pywuffs">dev0x13/pywuffs</a> holds Python bindings
for Wuffs the Library.</li>
<li>Bindings for Go, Rust and other languages are tracked as <a href="https://github.com/google/wuffs/issues/38" data-hovercard-type="issue" data-hovercard-url="/google/wuffs/issues/38/hovercard">issue
#38</a>.</li>
</ul>

<p dir="auto">Version 0.3 (April 2023) is the latest stable version. Stable means that
its API won&#39;t change any further, but being a &#34;version 0.x&#34; means that:</p>
<ul dir="auto">
<li>It will not have long term support.</li>
<li>Newer versions make no promises about compatibility.</li>
</ul>
<p dir="auto">The compiler undoubtedly has bugs. Assertion checking needs more rigor,
especially around side effects and aliasing, and being sufficiently well
specified to allow alternative implementations. Lots of detail needs work, but
the broad brushstrokes are there.</p>
<p dir="auto">Nonetheless, Wuffs&#39; GIF decoder has shipped in the Google Chrome web browser
<a href="https://chromium-review.googlesource.com/c/chromium/src/+/2940044" rel="nofollow">since June
2021</a>
(milestone M93). See also the <a href="https://twitter.com/richgel999/status/1481027198530248714" rel="nofollow">&#34;ridiculously
fast&#34;</a> tweet already
mentioned above.</p>

<p dir="auto">The mailing list is at
<a href="https://groups.google.com/forum/#!forum/wuffs" rel="nofollow">https://groups.google.com/forum/#!forum/wuffs</a>.</p>

<p dir="auto">The <a href="https://github.com/google/wuffs/blob/main/CONTRIBUTING.md">CONTRIBUTING.md</a> file contains instructions on how to
file the Contributor License Agreement before sending any pull requests (PRs).
Of course, if you&#39;re new to the project, it&#39;s usually best to discuss any
proposals and reach consensus before sending your first PR.</p>
<p dir="auto">Source code is <a href="https://github.com/google/wuffs/blob/main/doc/note/auto-formatting.md">auto-formatted</a>.</p>

<p dir="auto">This software is distributed under the terms of both the MIT license and the
Apache License (Version 2.0).</p>
<p dir="auto">See LICENSE for details.</p>

<p dir="auto">This is not an official Google product, it is just code that happens to be
owned by Google.</p>

<p dir="auto">Tony is an arse-kicking wombat who loves playing
<a href="https://en.wikipedia.org/wiki/Full-forward" rel="nofollow">full-forward</a> and hates buffer
overflows.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/google/wuffs/blob/main/doc/logo/wuffs-acronym-logo-1536x1024.png"><img src="https://github.com/google/wuffs/raw/main/doc/logo/wuffs-acronym-logo-1536x1024.png" alt="WUFFS Logo"/></a></p>
<hr/>
<p dir="auto">Updated on November 2023.</p>
</article></div></div>
  </body>
</html>
