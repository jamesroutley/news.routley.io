<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/surban/memstop">Original</a>
    <h1>Memstop: Use LD_PRELOAD to delay process execution when low on memory</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A lightweight <code>LD_PRELOAD</code> shared object that delays process execution when system memory is critically low. Memstop monitors available memory and waits until a configurable percentage of memory becomes available before allowing the application to start.</p>

<p dir="auto">Memstop is designed to prevent crashes caused by memory exhaustion in parallel processing systems. It can be particularly useful in:</p>
<ul dir="auto">
<li>Parallel build systems (like <code>make -j</code>) where you want to prevent the build from failing due to the OOM (out-of-memory) killer</li>
<li>Batch processing systems where you want to ensure adequate memory before starting jobs</li>
<li>High-memory applications that might crash the system if started when memory is low</li>
</ul>

<p dir="auto">When loaded as a shared object (via <code>LD_PRELOAD</code>), memstop automatically runs before your application&#39;s and all subprocesses&#39; <code>main()</code> functions. It:</p>
<ol dir="auto">
<li>Reads system memory information from <code>/proc/meminfo</code></li>
<li>Calculates the required available memory percentage (default: 10%)</li>
<li>Waits until the specified percentage of memory is available</li>
<li>Releases control to your application once memory requirements are met</li>
</ol>


<ul dir="auto">
<li>GCC compiler</li>
<li>Linux system with <code>/proc/meminfo</code> support</li>
<li>Make</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="# Build the shared library
make

# The build creates memstop.so"><pre><span><span>#</span> Build the shared library</span>
make

<span><span>#</span> The build creates memstop.so</span></pre></div>


<div dir="auto" data-snippet-clipboard-copy-content="# Install to /usr/local/lib (requires root privileges)
sudo make install"><pre><span><span>#</span> Install to /usr/local/lib (requires root privileges)</span>
sudo make install</pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="# Copy to a directory in your library path
cp memstop.so /path/to/your/lib/directory"><pre><span><span>#</span> Copy to a directory in your library path</span>
cp memstop.so /path/to/your/lib/directory</pre></div>


<p dir="auto">Use <code>LD_PRELOAD</code> to load memstop before running your build process:</p>
<div dir="auto" data-snippet-clipboard-copy-content="LD_PRELOAD=/usr/local/lib/memstop.so make -j"><pre>LD_PRELOAD=/usr/local/lib/memstop.so make -j</pre></div>

<p dir="auto">Memstop is configured using environment variables:</p>

<p dir="auto">Sets the percentage of total memory that must be available before allowing execution.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Require 20% of total memory to be available before make can spawn a task
MEMSTOP_PERCENT=20 LD_PRELOAD=/usr/local/lib/memstop.so make -j

# Require 5% of total memory to be available
MEMSTOP_PERCENT=5 LD_PRELOAD=/usr/local/lib/memstop.so make -j"><pre><span><span>#</span> Require 20% of total memory to be available before make can spawn a task</span>
MEMSTOP_PERCENT=20 LD_PRELOAD=/usr/local/lib/memstop.so make -j

<span><span>#</span> Require 5% of total memory to be available</span>
MEMSTOP_PERCENT=5 LD_PRELOAD=/usr/local/lib/memstop.so make -j</pre></div>
<ul dir="auto">
<li><strong>Default</strong>: 10</li>
<li><strong>Range</strong>: 0-100</li>
</ul>

<p dir="auto">Enables verbose output showing memory statistics and blocking status.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Enable verbose mode
MEMSTOP_VERBOSE=1 LD_PRELOAD=/usr/local/lib/memstop.so your_application"><pre><span><span>#</span> Enable verbose mode</span>
MEMSTOP_VERBOSE=1 LD_PRELOAD=/usr/local/lib/memstop.so your_application</pre></div>
<p dir="auto">When enabled, memstop outputs to stderr:</p>
<ul dir="auto">
<li>Current memory statistics (required %, available %, MB available/total)</li>
<li>Hold notifications when delaying execution</li>
<li>Release notifications when allowing execution to continue</li>
</ul>
<p dir="auto"><strong>Warning:</strong> Verbose mode can interfere with normal process execution and
should <strong>normally be disabled</strong>.</p>

<p dir="auto">With <code>MEMSTOP_VERBOSE=1</code>:</p>
<div data-snippet-clipboard-copy-content="==== memstop: 10% required, 15% available (1234 MB / 8192 MB) ===="><pre><code>==== memstop: 10% required, 15% available (1234 MB / 8192 MB) ====
</code></pre></div>
<p dir="auto">If memory is insufficient:</p>
<div data-snippet-clipboard-copy-content="==== memstop: 10% required, 5% available (410 MB / 8192 MB) ====
==== memstop hold ====
(after enough memory becomes available)
==== memstop release ===="><pre><code>==== memstop: 10% required, 5% available (410 MB / 8192 MB) ====
==== memstop hold ====
(after enough memory becomes available)
==== memstop release ====
</code></pre></div>

<p dir="auto">This project is licensed under the GNU General Public License v3.0 (GPLv3).</p>
</article></div></div>
  </body>
</html>
