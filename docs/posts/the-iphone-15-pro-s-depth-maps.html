<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.marksblogg.com/apple-iphone-15-pro-depth-map-heic.html">Original</a>
    <h1>The iPhone 15 Pro&#39;s Depth Maps</h1>
    
    <div id="readability-page-1" class="page"><div id="article_text">
            <p>Since 2017, Apple have supported depth maps in the images its iPhones capture either via LiDAR scanners, 3D <a href="https://en.wikipedia.org/wiki/Time-of-flight_camera">time-of-flight</a> scanner-less LIDAR or <a href="https://en.wikipedia.org/wiki/Structured-light_3D_scanner">structured-light</a> 3D scanning.</p>
<p><a href="https://tech.marksblogg.com/theme/images/iphone_depth/brave_j61zCFLlcU.png">
<img alt="iPhone 15 Pro Depth Maps" src="https://tech.marksblogg.com/theme/images/iphone_depth/brave_j61zCFLlcU.png"/>
</a></p><p>These depth maps, along with other imagery, are stored in High Efficiency Image File Format (HEIF) container files. These files can contain multiple images and vast amounts of metadata. This format was originally designed between 2013 and 2015 and Apple adopted its HEIC variant in 2017.</p>
<p>Since then, HEIC files are the default storage container format for images captured on the iPhone. But with that said, it is possible to use the JPEG format instead if things like depth maps and HDR are not of interest.</p>
<p>Finn Jaeger, who is the head of VFX at Replayboys, a film production firm in Hamburg, Germany, <a href="https://www.linkedin.com/posts/finn-j%C3%A4ger-b44058176_did-you-know-your-iphone-heic-files-are-activity-7319460880750940162-Rn23/">posted</a> a screenshot a few weeks ago showing how multiple depth maps were being produced by his iPhone.</p>
<p><a href="https://tech.marksblogg.com/theme/images/iphone_depth/brave_qqlvRZSjK9.png">
<img alt="iPhone 15 Pro Depth Maps" src="https://tech.marksblogg.com/theme/images/iphone_depth/brave_qqlvRZSjK9.png"/>
</a></p><p>He announced he was working on a project called <a href="https://github.com/finnschi/heic-shenanigans">HEIC Shenanigans</a>. This project contains scripts to separate out images and their metadata from HEIC containers as well as convert them into EXR Files. As of this writing, the project contains 374 lines of Python.</p>
<p>In this post, I&#39;ll walk through Finn&#39;s codebase on an example image from an iPhone 15 Pro.</p>
<div id="my-workstation">
<h2>My Workstation</h2>
<p>I&#39;m using a 5.7 GHz AMD Ryzen 9 9950X CPU. It has 16 cores and 32 threads and 1.2 MB of L1, 16 MB of L2 and 64 MB of L3 cache. It has a liquid cooler attached and is housed in a spacious, full-sized Cooler Master HAF 700 computer case.</p>
<p>The system has 96 GB of DDR5 RAM clocked at 4,800 MT/s and a 5th-generation, Crucial T700 4 TB NVMe M.2 SSD which can read at speeds up to 12,400 MB/s. There is a heatsink on the SSD to help keep its temperature down. This is my system&#39;s C drive.</p>
<p>The system is powered by a 1,200-watt, fully modular Corsair Power Supply and is sat on an ASRock X870E Nova 90 Motherboard.</p>
<p>I&#39;m running Ubuntu 24 LTS via Microsoft&#39;s Ubuntu for Windows on Windows 11 Pro. In case you&#39;re wondering why I don&#39;t run a Linux-based desktop as my primary work environment, I&#39;m still using an Nvidia GTX 1080 GPU which has better driver support on Windows and ArcGIS Pro only supports Windows natively.</p>
</div>
<div id="installing-prerequisites">
<h2>Installing Prerequisites</h2>
<p>I&#39;ll use Python 3.12.3 and a few other tools in this post.</p>
<div><pre><span></span>$<span> </span>sudo<span> </span>add-apt-repository<span> </span>ppa:deadsnakes/ppa
$<span> </span>sudo<span> </span>apt<span> </span>update
$<span> </span>sudo<span> </span>apt<span> </span>install<span> </span><span>\</span>
<span>    </span>jq<span> </span><span>\</span>
<span>    </span>openexr<span> </span><span>\</span>
<span>    </span>libimage-exiftool-perl<span> </span><span>\</span>
<span>    </span>libopenexr-dev<span> </span><span>\</span>
<span>    </span>python3-pip<span> </span><span>\</span>
<span>    </span>python3.12-venv
</pre></div>
<p>Note, the <tt><span>libimage-exiftool-perl</span></tt> package installs <tt>exiftool</tt> version 12.76+dfsg-1 which was released at the end of January 2024. Since then, there have been at least ten releases that have addressed issues or enhanced exiftool&#39;s HEIC support.</p>
<p>The above version should work fine for the steps in this post but be mindful that any issues you encounter going forward might be resolved with a more up to date version of exiftool.</p>
<p>I&#39;ll be using <a href="https://github.com/kellyjonbrazil/jc?tab=readme-ov-file">JSON Convert</a> (jc) to convert the output of various CLI tools into JSON.</p>
<div><pre><span></span>$<span> </span>wget<span> </span>https://github.com/kellyjonbrazil/jc/releases/download/v1.25.2/jc_1.25.2-1_amd64.deb
$<span> </span>sudo<span> </span>dpkg<span> </span>-i<span> </span>jc_1.25.2-1_amd64.deb
</pre></div>
<p>I&#39;ll clone Finn Jaeger&#39;s HEIC Shenanigans repo.</p>
<div><pre><span></span>$<span> </span>git<span> </span>clone<span> </span>https://github.com/finnschi/heic-shenanigans<span> </span><span>\</span>
<span>    </span>~/heic-shenanigans
</pre></div>
<p>I&#39;ll set up a Python Virtual Environment and install the a few dependencies.</p>
<div><pre><span></span>$<span> </span>python3<span> </span>-m<span> </span>venv<span> </span>~/.iphone_depth
$<span> </span><span>source</span><span> </span>~/.iphone_depth/bin/activate

$<span> </span>python3<span> </span>-m<span> </span>pip<span> </span>install<span> </span>-r<span> </span><span>\</span>
<span>    </span>~/heic-shenanigans/requirements.txt
$<span> </span>python3<span> </span>-m<span> </span>pip<span> </span>install<span> </span><span>\</span>
<span>    </span>OpenImageIO
</pre></div>
<p>I&#39;ll use <a href="https://github.com/darbyjohnston/DJV/releases">DJV</a> v2.0.8 to view EXR imagery produced in this post.</p>
</div>
<div id="an-iphone-15-pro-image">
<h2>An iPhone 15 Pro Image</h2>
<p><a href="https://www.linkedin.com/in/joel-joseph-b865981ab/">Joel Joseph</a>, a subject matter expert on the ArcGIS Desktop Products Suite in Mumbai, India, was kind enough to send me an HEIC-contained image he took on his iPhone 15 Pro. I&#39;ll use this image in this post. Below is a screenshot.</p>
<p><a href="https://tech.marksblogg.com/theme/images/iphone_depth/Photos_5WbqRgJbWO.jpg">
<img alt="iPhone 15 Pro Depth Maps" src="https://tech.marksblogg.com/theme/images/iphone_depth/Photos_5WbqRgJbWO.jpg"/>
</a>
</p></div>

<div id="converting-an-heic-into-exr">
<h2>Converting an HEIC into EXR</h2>
<p>The <a href="https://github.com/AcademySoftwareFoundation">Academy Software Foundation</a> fosters various <a href="https://www.aswf.io/projects/">open source projects</a> and standards used in film, television and other creative industries. It&#39;s <a href="https://www.aswf.io/members/">members</a> include the Academy of Motion Picture Arts and Sciences, Disney, Nvidia and Netflix to name a few.</p>
<p>Below is a screenshot of their <a href="https://landscape.aswf.io/">landscape</a> of projects.</p>
<p><a href="https://landscape.aswf.io/">
<img alt="iPhone 15 Pro Depth Maps" src="https://tech.marksblogg.com/theme/images/iphone_depth/brave_g5ZWZ7GWLE.png"/>
</a></p><p>One of their projects is <a href="https://github.com/AcademySoftwareFoundation/openexr">OpenEXR</a>, a high-dynamic range (HDR) image file format. It was originally developed by Industrial Light and Magic (ILM) in 1999 and was later made open source in 2003. It&#39;s used in producing visual effects and 3D renderings.</p>
<p>Below I&#39;ll convert iPhone 15 Pro image into an OpenEXR file.</p>
<div><pre><span></span>$<span> </span>python<span> </span>~/heic-shenanigans/heic_to_exr.py<span> </span><span>\</span>
<span>    </span>IMG_E2153.HEIC
</pre></div>
<p>The resulting file is 468 MB. Below is a screenshot of it in DJV.</p>
<p><a href="https://tech.marksblogg.com/theme/images/iphone_depth/djv_EIMLqnjJmM.jpg">
<img alt="iPhone 15 Pro Depth Maps" src="https://tech.marksblogg.com/theme/images/iphone_depth/djv_EIMLqnjJmM.jpg"/>
</a></p><p>The above file was produced by making several calls to <tt>oiiotool</tt>, an image processing tool from the <a href="https://github.com/AcademySoftwareFoundation/OpenImageIO">OpenImageIO</a> project, which is also apart of the Academy Software Foundation.</p>
<p>Below I&#39;ve annotated the calls to oiiotool made by the above script.</p>
<p>The script will first get the dimensions of the source image.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>--info<span> </span>/tmp/tmpc3kmiaka/input_base.tiff
</pre></div>
<p>It will then produce a base image, converting the source image from an sRGB curve through Linear P3 and onto ACEScg.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/input_base.tiff<span> </span><span>\</span>
<span>    </span>--ch<span> </span>R,G,B<span> </span><span>\</span>
<span>    </span>--chnames<span> </span>sdr.R,sdr.G,sdr.B<span> </span><span>\</span>
<span>    </span>--colorconfig<span> </span>studio-config-v1.0.0_aces-v1.3_ocio-v2.1.ocio<span> </span><span>\</span>
<span>    </span>--colorconvert<span> </span><span>&#39;sRGB - Texture&#39;</span><span> </span><span>&#39;Linear Rec.709 (sRGB)&#39;</span><span> </span><span>\</span>
<span>    </span>--colorconvert<span> </span><span>&#39;Linear P3-D65&#39;</span><span>  </span><span>&#39;ACES - ACEScg&#39;</span><span> </span><span>\</span>
<span>    </span>-o<span> </span>/tmp/tmpc3kmiaka/base.exr
</pre></div>
<p>The above OCIO file is an <a href="https://opencolorio.org/">OpenColorIO</a> colour profile file. OpenColorIO, also under the Academy Software Foundation, is a colour management suite. The project provides several <a href="https://github.com/AcademySoftwareFoundation/OpenColorIO-Config-ACES/releases">reference configurations</a> including one from the <a href="https://en.wikipedia.org/wiki/Academy_Color_Encoding_System">Academy Color Encoding System (ACES)</a>. The OCIO file is text-based and contains 1,242 lines of content.</p>
<div><pre><span></span>$<span> </span>head<span> </span>studio-config-v1.0.0_aces-v1.3_ocio-v2.1.ocio
</pre></div>
<div><pre><span></span>ocio_profile_version: 2.1

environment:
  {}
search_path: &#34;&#34;
strictparsing: true
luma: [0.2126, 0.7152, 0.0722]
name: studio-config-v1.0.0_aces-v1.3_ocio-v2.1
description: |
  Academy Color Encoding System - Studio Config [COLORSPACES v1.0.0] [ACES v1.3] [OCIO v2.1]
</pre></div>
<p>Then, an EXR-based gain map will be produced by converting the source HDR gain map from Rec709 curve to Linear.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/input_hdrgainmap_50.tiff<span> </span><span>\</span>
<span>    </span>--ch<span> </span>Y<span> </span><span>\</span>
<span>    </span>--chnames<span> </span>gainmap.Y<span> </span><span>\</span>
<span>    </span>--resize<span> </span>4032x3024<span> </span><span>\</span>
<span>    </span>--colorconfig<span> </span>studio-config-v1.0.0_aces-v1.3_ocio-v2.1.ocio<span> </span><span>\</span>
<span>    </span>--ocionamedtransform<span> </span><span>&#39;Rec.709 - Curve&#39;</span><span> </span><span>\</span>
<span>    </span>-o<span> </span>/tmp/tmpc3kmiaka/gainmap.exr
</pre></div>
<p>That gain map will then be converted into RGB by duplicating the Y channel three times.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/gainmap.exr<span> </span><span>\</span>
<span>    </span>--ch<span> </span>gainmap.Y,gainmap.Y,gainmap.Y<span> </span><span>\</span>
<span>    </span>--chnames<span> </span>gainmap.R,gainmap.G,gainmap.B<span> </span><span>\</span>
<span>    </span>-o<span> </span>/tmp/tmpc3kmiaka/gainmap_rgb.exr
</pre></div>
<p>The HDR gain map&#39;s headroom value will be extracted and used below.</p>
<div><pre><span></span>$<span> </span>exiftool<span> </span>-HDRGainMapHeadroom<span> </span>-b<span> </span>/tmp/tmpc3kmiaka/input_base.tiff
</pre></div>
<p>The gain map will then be scaled using the inverse of the HDR headroom value captured above.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/gainmap_rgb.exr<span> </span><span>\</span>
<span>    </span>--mulc<span> </span>-0.12135654640000004<span> </span><span>\</span>
<span>    </span>--addc<span> </span><span>1</span>.0<span> </span><span>\</span>
<span>    </span>-o<span> </span>/tmp/tmpc3kmiaka/gainmap_scaled.exr
</pre></div>
<p>Then, the base image will be multiplied by the scaled gain map to create an HDR base image.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/base.exr<span> </span><span>\</span>
<span>           </span>/tmp/tmpc3kmiaka/gainmap_scaled.exr<span> </span><span>\</span>
<span>           </span>--mul<span> </span><span>\</span>
<span>           </span>--chnames<span> </span>R,G,B<span> </span><span>\</span>
</pre></div>
<p>Then, the Y channel from the depth map will be used to create an EXR-formatted depth map.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/input_depth_0.tiff<span> </span><span>\</span>
<span>    </span>--ch<span> </span>Y<span> </span><span>\</span>
<span>    </span>--chnames<span> </span>depth.Y<span> </span><span>\</span>
<span>    </span>--resize<span> </span>4032x3024<span> </span><span>\</span>
<span>    </span>-o<span> </span>/tmp/tmpc3kmiaka/depth.exr
</pre></div>
<p>If the source image contained mattes they would be processed at this stage.</p>
<p>The first step in constructing the final EXR file starts by copying in the RGB channels from the EXR-formatted HDR base image.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/hdr_base.exr<span> </span><span>\</span>
<span>    </span>--ch<span> </span>R,G,B<span> </span><span>\</span>
<span>    </span>-o<span> </span>/tmp/tmpc3kmiaka/final.exr
</pre></div>
<p>Then the SDR channels are added.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/final.exr<span> </span><span>\</span>
<span>           </span>/tmp/tmpc3kmiaka/base.exr<span> </span><span>\</span>
<span>      </span>--ch<span> </span>sdr.R,sdr.G,sdr.B<span> </span><span>\</span>
<span>      </span>--siappend<span> </span><span>\</span>
<span>      </span>-o<span> </span>/tmp/tmpc3kmiaka/final.exr
</pre></div>
<p>Then the gain map is added.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/final.exr<span> </span><span>\</span>
<span>           </span>/tmp/tmpc3kmiaka/gainmap_rgb.exr<span> </span><span>\</span>
<span>      </span>--ch<span> </span>gainmap.R,gainmap.G,gainmap.B<span> </span><span>\</span>
<span>      </span>--siappend<span> </span><span>\</span>
<span>      </span>-o<span> </span>/tmp/tmpc3kmiaka/final.exr
</pre></div>
<p>Then the depth map is added.</p>
<div><pre><span></span>$<span> </span>oiiotool<span> </span>/tmp/tmpc3kmiaka/final.exr<span> </span><span>\</span>
<span>           </span>/tmp/tmpc3kmiaka/depth.exr<span> </span><span>\</span>
<span>      </span>--ch<span> </span>depth.Y<span> </span><span>\</span>
<span>      </span>--siappend<span> </span><span>\</span>
<span>      </span>-o<span> </span>/tmp/tmpc3kmiaka/final.exr
</pre></div>
<p>If there were any matte layers, they would be added here.</p>
<p>The <tt>final.exr</tt> file is then moved to a <tt>&lt;prefix&gt;_acesCG.exr</tt> file alongside the source imagery.</p>
</div>

        </div><p>
            Thank you for taking the time to read this post. I offer both consulting and hands-on development services to clients in North America and Europe. If you&#39;d like to discuss how my offerings can help your business please contact me via <a href="https://uk.linkedin.com/in/marklitwintschik/">LinkedIn</a>.
        </p></div>
  </body>
</html>
