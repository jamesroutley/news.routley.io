<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://machinelearning.apple.com/research/transporting-activations">Original</a>
    <h1>Controlling Language and Diffusion Models by Transporting Activations</h1>
    
    <div id="readability-page-1" class="page"><div role="main"><section></section><section><div><p>Large generative models are becoming increasingly capable and more widely deployed to power production applications, but getting these models to produce exactly what&#39;s desired can still be challenging. Fine-grained control over these models&#39; outputs is important to meet user expectations and to mitigate potential misuses, ensuring the models&#39; reliability and safety. To address these issues, Apple machine learning researchers have developed a new technique that is modality-agnostic and provides fine-grained control over the model&#39;s behavior with negligible computational overhead, while minimally impacting the model&#39;s abilities. <a href="https://machinelearning.apple.com/research/controlling-language-and-diffusion">Activation Transport (AcT)</a> is a general framework to steer activations guided by optimal transport theory that generalizes many previous activation-steering works. The work will be presented as a Spotlight at <a href="https://iclr.cc" target="_blank" aria-label="ICLR 2025 - Opens in a new window" rel="noopener nofollow">ICLR 2025</a>, and code is available <a href="https://github.com/apple/ml-act" target="_blank" aria-label="here - Opens in a new window" rel="noopener nofollow">here</a>.</p>
<p>To help generative models produce output that aligns with their users&#39; expectations, researchers often rely on reinforcement learning with human feedback (RLHF) or instruction fine-tuning, but these approaches are resource-intensive and become increasingly impractical as models grow in complexity. In addition, changing a model&#39;s parameters can have unintended consequences, affecting its overall performance on other tasks.</p>
<p>To control the output of these generative models, users often try crafting precise prompts, but while this is more accessible, it offers limited controls. Even with carefully constructed prompts, a model’s output can be unpredictable and lacking the nuance a user might need. For example, it’s common for models to fail when prompted with instructions not to include something <a href="#figure1">(see figure 1)</a>:</p>
<figure id="figure1" aria-label="Figure 1"><p><a href="https://mlr.cdn-apple.com/media/Fig1_pink_elephant_1d858a2715.jpg" tabindex="-1" target="_blank"><img src="https://mlr.cdn-apple.com/media/Fig1_pink_elephant_1d858a2715.jpg" loading="lazy"/></a></p><figcaption id="figure-figure1-caption" aria-hidden="true">Figure 1: Text-to-Image model such as SDXL and FLUX.1.dev tend to generate pink elephants even when instructed not to generate one. Left: “An astronaut in a space station. Do not show a pink elephant”. Right: “A dog running on the beach splashing water. Do not show a pink elephant”.</figcaption></figure>
<p>In many applications, such as content generation, creative writing, or even AI-assisted design, having fine-grained control over the model&#39;s output is crucial. For example, a user might want to adjust the tone of text without altering its content, change the style of generated images while maintaining their context, or to ensure sensitive topics are handled with care, without compromising overall coherence. Activation Transport (AcT) delivers this, without the computational overhead, complexity, and volume of data required by RLHF or fine-tuning, and with more reliable results than prompt engineering.</p>
<h2>Activation Steering: A simple-yet-powerful solution</h2>
<p>The computational and economic cost of fine-tuning large models as well as the need for fine-grained control has motivated research on targeted interventions upon model activations to modify specific behaviors in a fine-grained way. The main advantage of these &#34;activation steering&#34; methods is that they do not require back-propagation and typically can be merged into the model weights.</p>
<p>Unlike RLHF or fine-tuning, activation steering doesn&#39;t impact a model&#39;s parameters, but instead leverages an understanding of the model&#39;s operations to dynamically steer its outputs in a desired direction at inference time.</p>
<p>Prior approaches to activation steering have used a vector-based intervention that take the source activations of expert neurons, and shift them toward a learned target <a href="#figure2">(see figure 2)</a>. However, the degree to which activations are shifted is controlled by an unbounded model-level parameter (λ\lambda), making interpretable interventions challenging. Additionally, these interventions can shift activations out of distribution, meaning that the shifted activations can end up far from what the model has learned to expect during training, resulting in a disruption of the model&#39;s natural dynamics, which can lead to unexpected behavior and reduced performance.</p>
<figure id="figure2" aria-label="Figure 2"><video autoplay="" muted="" controls="" playsinline="" data-testid="video"><source src="https://mlr.cdn-apple.com/video/Fig2_f26acfe2a1.mov" type="video/mp4"/></video><figcaption id="figure-figure2-caption" aria-hidden="true">Figure 2: Prior Activation Steering works using vector-based steering will likely move activations out of distribution. The intervention strength parameter λ is unbounded and non-interpretable.</figcaption></figure>
<h2>Activation Transport (AcT) and Linear-AcT</h2>
<p>Activation Transport (AcT) is a novel intervention framework that surpasses the prior limitations of activation steering by accounting for distributions of source and target activations, and using an interpretable and actionable strength parameter for fine-grained control.</p>
<p>AcT learns the Optimal Transport (OT) map between the source and target activation distributions. This ensures that an activation transported from the source will comply with the target distribution, minimizing the compounding effects on the dynamics of the model itself. To estimate the OT map, a small number of example sentences (e.g., hundreds) are run through the model, revealing the sets of activations for both source (e.g., impolite language) and target (e.g., polite language).</p>
<p>Estimating a multi-dimensional and possibly non-linear OT map would require a prohibitive amount of data, and its inference would slow down the overall LLM text generation. Therefore, we make two simplifications: (1) we consider independent activations, which allows estimating a 1D map per neuron and (2) we consider linear maps, limiting the memory footprint and ensuring fast inference. The steering with linear and independent transports is coined LinearAcT  <a href="#figure3">(see figure 3)</a>.</p>
<p>Linear-AcT works out-of-the-box for LLMs as well Text-to-Image (T2I) diffusion models, achieving strong results in both cases. This is the first work to propose a conditioning algorithm that can be used without any modification for language and image generation.</p>
<figure id="figure3" aria-label="Figure 3"><video autoplay="" muted="" controls="" playsinline="" data-testid="video"><source src="https://mlr.cdn-apple.com/video/Fig3_2c97d0c5ef.mov" type="video/mp4"/></video><figcaption id="figure-figure3-caption" aria-hidden="true">Figure 3: Linear-AcT unlocks interpretable controllability for both LLMs and Diffusion, offering explicit control over the strength of conditioning, via a parameter λ between 0 (no transport) and 1 (full transport).</figcaption></figure>
<h2>Controlling LLM Outputs with Linear-AcT</h2>
<p>To demonstrate Linear-AcT&#39;s effectiveness in controlling LLMs&#39; outputs, we benchmarked its performance on two important tasks: toxicity mitigation and truthfulness induction, while monitoring how other performance indicators are affected via the perplexity (PPL) and MMLU metrics.</p>
<p>We tested Linear-AcT on toxicity mitigation on Gemma-2-2b and Llama-3-8b (evaluated using the RealToxicityPrompts dataset), obtaining a 7.5x and 4.3x reduction respectively.</p>
<figure id="table1" aria-labelledby="figure-table1-caption"><div><table><thead><tr><td></td><td>Best λ</td><td>Toxicity mitigation</td><td>PPL</td><td>MMLU</td></tr></thead><tbody><tr><td>Original</td><td></td><td></td><td>13.98</td><td>53.1</td></tr><tr><td>ActAdd</td><td>0.5</td><td>1.1x</td><td>14.69</td><td>53.0</td></tr><tr><td>AurA</td><td>-</td><td>2.0x</td><td>14.18</td><td>53.0</td></tr><tr><td>ITI-c</td><td>8.0</td><td>5.6x</td><td>14.90</td><td>52.6</td></tr><tr><td>Linear-AcT</td><td>1.0</td><td><span>7.5x</span></td><td>14.79</td><td>51.3</td></tr></tbody></table></div><figcaption id="figure-table1-caption" aria-hidden="false">Table 1. Comparison of toxicity mitigation results on Gemma-2-2b.</figcaption></figure>
<figure id="table2" aria-labelledby="figure-table2-caption"><div><table><thead><tr><td></td><td>Best λ</td><td>Toxicity mitigation</td><td>PPL</td><td>MMLU</td></tr></thead><tbody><tr><td>Original</td><td></td><td></td><td>9.06</td><td>65.3</td></tr><tr><td>ActAdd</td><td>0.3</td><td>1.0x</td><td>9.71</td><td>65.5</td></tr><tr><td>AurA</td><td>-</td><td>3.1x</td><td>9.52</td><td>65.5</td></tr><tr><td>ITI-c</td><td>3.0</td><td>3.6x</td><td>9.48</td><td>64.7</td></tr><tr><td>Linear-AcT</td><td>1.0</td><td><span>4.3x</span></td><td>9.56</td><td>64.5</td></tr></tbody></table></div><figcaption id="figure-table2-caption" aria-hidden="false">Table 2. Comparison of toxicity mitigation results on Llama-3-8B.</figcaption></figure>
<p>We tested truthfulness induction (using the TruthfulQA dataset), showing a 4.9x and 7.5x increase for each model.</p>
<figure id="table3" aria-labelledby="figure-table3-caption"><div><table><thead><tr><td></td><td>Best λ</td><td>Truthfullness (MC1 acc)</td><td>MMLU</td></tr></thead><tbody><tr><td>Original</td><td></td><td>21.05</td><td>53.10</td></tr><tr><td>ActAdd</td><td>3.0</td><td>23.01</td><td>52.83</td></tr><tr><td>AurA</td><td>-</td><td>21.20</td><td>52.73</td></tr><tr><td>ITI-c</td><td>2.0</td><td>24.53</td><td>51.39</td></tr><tr><td>Linear-AcT</td><td>1.0</td><td><span>26.00</span></td><td>51.47</td></tr></tbody></table></div><figcaption id="figure-table3-caption" aria-hidden="false">Table 3. Comparison of truthfullness induction results on Gemma-2-2b.</figcaption></figure>
<figure id="table4" aria-labelledby="figure-table4-caption"><div><table><thead><tr><td></td><td>Best λ</td><td>Truthfullness (MC1 acc)</td><td>MMLU</td></tr></thead><tbody><tr><td>Original</td><td></td><td>25.46</td><td>65.35</td></tr><tr><td>ActAdd</td><td>0.7</td><td>26.19</td><td>65.42</td></tr><tr><td>AurA</td><td>-</td><td>25.34</td><td>65.37</td></tr><tr><td>ITI-c</td><td>2.0</td><td>30.11</td><td>64.71</td></tr><tr><td>Linear-AcT</td><td>1.0</td><td><span>33.22</span></td><td>64.78</td></tr></tbody></table></div><figcaption id="figure-table4-caption" aria-hidden="false">Table 4. Comparison of truthfullness induction results on Llama-3-8B.</figcaption></figure>
<h2>Controlling Text-to-Image Diffusion Models with Linear-AcT</h2>
<p>Text-to-image diffusion models (T2Is) are powerful tools that allow users to generate stunning images from simple text descriptions. Fine-grained control, however, is challenging; for instance, it is impossible to enforce incremental changes—such as adding more trees or making the style slightly more cartoonish—or to reliably predict how terms like &#39;many trees&#39; will affect the generated image.</p>
<p>Because AcT can transport activations from one distribution to another no matter the model architecture or modality, it can enable fine-grained control over details like this for T2Is <a href="#figure4">(see figure 4)</a>. To do this, AcT needs only a list of prompts that describe the source (e.g., no people) and the target (e.g., people) activation distributions.</p>
<figure id="figure4" aria-label="Figure 4"><video autoplay="" muted="" controls="" playsinline="" data-testid="video"><source src="https://mlr.cdn-apple.com/video/Fig4_76d16ecb7d.mov" type="video/mp4"/></video><figcaption id="figure-figure4-caption" aria-hidden="true">Figure 4: Text to image generation with <a href="https://arxiv.org/abs/2402.13929" target="_blank" rel="noopener noreferrer">SDXL-Lightning</a> intervening on all layernorm layers to incrementally add more trees.</figcaption></figure>
<h2>AcT for Fine-Control of Pictorial Style</h2>
<p>AcT also enables control over the artistic style of generated images. To demonstrate this, we appended stylistic tags (e.g., anime, cyberpunk, watercolor) to a subset of prompts from the COCO Captions dataset (32 prompts per concept).</p>
<p>In this setup, the original prompts serve as the source distribution, while the style-modified prompts represent the target distribution. By learning OT maps between these distributions, and by applying those maps through the interpretable strength parameter, AcT gains the ability to induce just the right amount of a desired style  <a href="#figure5">(see figure 5)</a>.</p>
<figure id="figure5" aria-label="figure 5"><div></div><figcaption id="figure-figure5-caption" aria-hidden="true">Figure 5: Interactive illustration of fine-grained control of pictorial style with AcT. Select an original image and a style to apply, then use the slider to adjust the transport strength to see the resulting impact on the generated image.</figcaption></figure>
<h2>Do Not Think About a Pink Elephant</h2>
<p>The header above will likely cause readers to think about a pink elephant - interestingly, the same phenomenon has been found to happen to T2Is <a href="#figure6">(see figure 6)</a>. This may happen if T2Is&#39; text encoders embed sentences as a bag of words and is not powerful enough to interpret negations, but it&#39;s often the case that including a negative instruction in the prompt (e.g., &#34;do not show a pink elephant&#34;) will in fact lead a T2I model to include that undesired element in the image.</p>
<figure id="figure6" aria-label="Figure 6"><p><a href="https://mlr.cdn-apple.com/media/Screenshot_2024_12_11_at_1_50_47_PM_2f03362c77.png" tabindex="-1" target="_blank"><img src="https://mlr.cdn-apple.com/media/Screenshot_2024_12_11_at_1_50_47_PM_2f03362c77.png" loading="lazy"/></a></p><figcaption id="figure-figure6-caption" aria-hidden="true">Figure 6: When prompted to create images that do not include a pink elephant, text-to-image models such as SDXL-Lightning and FLUX.1.Schnell often generate images that include one. </figcaption></figure>
<p>Linear-AcT is an intervention that can address this challenge and remove undesired concepts from generated images. To do this, a set of source prompts that contain the concept to be removed (e.g. &#34;a house and a tree with a pink elephant next to it&#34;) is needed, as well as a set of target prompts where the concept is not present (e.g. &#34;a house and a tree&#34;). The main idea is to &#34;isolate&#34; the concept to be removed as the main difference between the sets of prompts. Linear-AcT learns a transport map from the source to the target set, resulting in a controllable intervention that can remove a negated concept (like &#34;pink elephant&#34;) that otherwise would have been included in the generated model, as shown in <a href="#figure7">figure 7</a>.</p>
<figure id="figure7" aria-label="Figure 7"><p><a href="https://mlr.cdn-apple.com/media/16314_21931c77d9.jpg" tabindex="-1" target="_blank"><img src="https://mlr.cdn-apple.com/media/16314_21931c77d9.jpg" loading="lazy"/></a></p><figcaption id="figure-figure7-caption" aria-hidden="true">Figure 7: &#34;An older man downhill skiing down a slope. not featuring a {gorilla, pink elephant, white bear}&#34;. Removing the concepts &#34;gorilla&#34; (top), &#34;pink elephant&#34; (middle), and &#34;white bear&#34; (bottom) from SDXL-Lightning when prompted not to include these concepts explicitly. Each column shows a different transport strength (λ). The rightmost column corresponds to the highest strength that does not result in a noisy image (λ=1 for Linear-AcT and λ=4 for ITI.).</figcaption></figure>
<h2>Conclusion</h2>
<p>As the capabilities and production deployments of generative language and text-to-image models continue to grow, providing fine-grained controls over their outputs is increasingly important. While common approaches like RLHF and instruction fine-tuning have been effective in improving the alignment of LLM output with users’ expectations, these methods are resource intensive, and become impractical as models grow in complexity. Activation Transport (AcT) provides fine-grained control of the output of LLMs and T2I diffusion models, without the limitations of RLHF and fine-tuning. This general framework for steering activations according to optimal transport theory is modality-agnostic and requires negligible computational overhead, and researchers and practitioners can now use and build on AcT with the code available <a href="https://github.com/apple/ml-act" target="_blank" aria-label="here - Opens in a new window" rel="noopener nofollow">here</a>.</p></div></section><section><div><div><div data-testid="card-controlling-language-and-diffusion"><div><p>The increasing capabilities of large generative models and their ever more widespread deployment have raised concerns about their reliability, safety, and potential misuse. To address these issues, recent works have proposed to control model generation by steering model activations in order to effectively induce or prevent the emergence of concepts or behaviours in the generated output. In this paper we introduce Activation Transport (AcT), a…</p><p><a href="https://machinelearning.apple.com/research/controlling-language-and-diffusion" aria-label="See full paper details regarding Controlling Language and Diffusion Models by Transporting Activations">See paper details</a></p></div></div><div data-testid="card-introducing-apple-foundation-models"><div><div><p>At the 2024 <a href="https://developer.apple.com/wwdc24/">Worldwide Developers Conference</a>, we introduced Apple Intelligence, a personal intelligence system integrated deeply into iOS 18, iPadOS 18, and macOS Sequoia.</p>
<p>Apple Intelligence is comprised of multiple highly-capable generative models that are specialized for our users’ everyday tasks, and can adapt on the fly for their current activity. The foundation models built into Apple Intelligence have been fine-tuned for user experiences such as writing and refining text, prioritizing and summarizing notifications, creating playful images for conversations with family and friends, and taking in-app actions to simplify interactions across apps.</p></div><p><a href="https://machinelearning.apple.com/research/introducing-apple-foundation-models" aria-label="See full highlight details regarding Introducing Apple’s On-Device and Server Foundation Models">See highlight details</a></p></div></div></div></div></section><section></section></div></div>
  </body>
</html>
