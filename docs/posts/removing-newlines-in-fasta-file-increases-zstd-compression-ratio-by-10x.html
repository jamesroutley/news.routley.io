<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://log.bede.im/2025/09/12/zstandard-long-range-genomes.html">Original</a>
    <h1>Removing newlines in FASTA file increases ZSTD compression ratio by 10x</h1>
    
    <div id="readability-page-1" class="page"><div> <div>  <info datetime="2025-09-12">September 12, 2025</info> <p>First released with Zstandard 1.3.2 in 2017, the <code>--long</code> range match finder increases the compressor’s search window to at least 128MiB, improving deduplication inside large files. This optional feature had substantial performance overheads at launch, but various optimisations have since brought its performance within shooting distance of Zstandard’s fast defaults. As a fan of Zstandard’s speed and efficiency, I hoped that <code>--long</code> might improve genome compression and bridge the chasm between fast general-purpose compressors with low compression ratios (CRs), and much slower specialist DNA sequence compressors capable of far higher CRs.</p> <p>Grace Blackwell’s 2.6Tbp <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC8577725/">661k</a> <a href="https://ftp.ebi.ac.uk/pub/databases/ENA2018-bacteria-661k/">dataset</a> is a classic choice for benchmarking methods in microbial genomics. Comprising many similar DNA sequences, its 661,405 bacterial genome assemblies in FASTA text format are very compressible. Karel Břinda’s specialist <a href="https://www.nature.com/articles/s41592-025-02625-2">MiniPhy approach</a> takes this dataset from 2.46TiB to just 27GiB (CR: 91) by clustering and compressing similar genomes together. By comparison, naive Zstandard with default parameters compresses an order of magnitude faster, but achieves a CR of just 3.</p> <p>I was initially underwhelmed by <code>--long</code>’s modest reduction of the 661k dataset from 777GiB (Zstandard default) to 641GiB (CR: 4). I speculated that this poor performance might be caused by the newline bytes (<code>0x0A</code>) punctuating every 60 characters of sequence, breaking the hashes used for long range pattern matching. Indeed, removing within-record newlines using <a href="https://github.com/lh3/seqtk?tab=readme-ov-file#seqtk-examples"><code>seqtk seq -l 0</code></a> tripled <code>zstd --long</code>’s CR to 11, yielding a 232GiB file while increasing compression time by only ~20% over Zstandard defaults. Increasing the window size to the 2GiB maximum on 64bit systems using <code>--long=31</code> tripled CR again to 31, yielding an 80GiB file, increasing compression time by ~80% over Zstandard defaults. Using larger-than-default window sizes has the drawback of requiring that the same <code>--long=xx</code> argument be passed during decompression reducing compatibility somewhat. Results naturally vary between datasets, but given its low overheads, <code>--long</code> is often worth a try. In this case <code>zstd --long=31</code> achieved a compression ratio within an order of magnitude of slower state-of-the-art methods, representing a useful compromise. Just remember to remove within-record newlines from your fasta files beforehand.</p> <p><strong>661k, single FASTA file</strong></p> <table> <thead> <tr> <th>Compression</th> <th>Line length</th> <th>Size (GiB)</th> <th>Ratio</th> </tr> </thead> <tbody> <tr> <td>Uncompressed</td> <td>60</td> <td>2460</td> <td>1</td> </tr> <tr> <td>Gzip (pigz)</td> <td>60</td> <td>751</td> <td>3.3</td> </tr> <tr> <td>Zstandard</td> <td>60</td> <td>777</td> <td>3.2</td> </tr> <tr> <td>Zstandard <code>--long</code></td> <td>60</td> <td>641</td> <td>3.8</td> </tr> <tr> <td>Zstandard <code>--long</code></td> <td>0 (infinite)</td> <td>232</td> <td>11</td> </tr> <tr> <td>Zstandard <code>--long=31</code></td> <td>0 (infinite)</td> <td>80</td> <td>31</td> </tr> </tbody> </table> <blockquote data-bluesky-uri="at://did:plc:hin5jjyb5dgi5wtjudeb62xm/app.bsky.feed.post/3lyfizwhenk2q" data-bluesky-cid="bafyreiajvdpuggyggtzbwiuvjockrtamnsbqfblvrsipmcqzqmbi3p6ieq" data-bluesky-embed-color-mode="system"><p lang="en">Zstandard&#39;s --long range mode works wonders for assemblies, but needs uninterrupted single line sequences. *AllTheBacteria 661k, multiline fasta* gzip (pigz): 751GB zstandard --long: 641GB (30% original size) *Single line fasta* gzip (pigz): 700GB zstandard --long: 232GB (10% original size)</p>— Bede Constantinides (<a href="https://bsky.app/profile/did:plc:hin5jjyb5dgi5wtjudeb62xm?ref_src=embed">@bedec.bsky.social</a>) <a href="https://bsky.app/profile/did:plc:hin5jjyb5dgi5wtjudeb62xm/post/3lyfizwhenk2q?ref_src=embed">Sep 9, 2025 at 11:27</a></blockquote>  </div> </div></div>
  </body>
</html>
