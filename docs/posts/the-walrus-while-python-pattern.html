<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nickdrozd.github.io/2022/12/14/walrus-while.html">Original</a>
    <h1>The Walrus-While Python Pattern</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>Suppose you are reading from an <strong>unbounded data source</strong> in increments of a certain size. This is a common sort of situation; for example, reading lines from stdin. The total length of the data source is not known in advance, so the only thing to do is <strong>keep reading until there is nothing left to read</strong>.</p>

<p>Up through Python 3.7, this kind of activity would usually be written with an <strong>unbounded loop</strong>:</p>

<figure><pre><code data-lang="python"><span>while</span> <span>True</span><span>:</span>
    <span>line</span> <span>=</span> <span>getline</span><span>()</span>

    <span>if</span> <span>line</span> <span>is</span> <span>None</span><span>:</span>
        <span>break</span>

    <span>process</span><span>(</span><span>line</span><span>)</span></code></pre></figure>

<p>This is a <strong>clunky</strong> way to express what’s going on. On its face it says: do the following forever. But it clearly isn’t meant to run forever. So really it’s: do the following forever (but stop at some point).</p>

<p>It’s also <strong>misleading</strong>. The <code>while True</code> idiom is often used in Python to indicate a loop that will run forever, like an event loop. But that isn’t what this loop is. Instead, the loop will run until there are no more lines to get. So the loop condition <strong>violates a common convention</strong> and does something unexpected.</p>

<p>Python 3.8 (2019) introduced <strong><em><a href="https://peps.python.org/pep-0572/">assignment expressions</a></em></strong>, which allow for assigning values to variables in contexts where regular assignment would be illegal. The syntax used for assignment expressions <code>:=</code> vaguely resembles a walrus, and so it is known as the <strong><em>walrus operator</em></strong>.</p>

<p>The line-processing code above can be <strong>dramatically simplified</strong> by using an assignment expression:</p>

<figure><pre><code data-lang="python"><span>while</span> <span>(</span><span>line</span> <span>:</span><span>=</span> <span>getline</span><span>())</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
    <span>process</span><span>(</span><span>line</span><span>)</span></code></pre></figure>

<p>This code matches <strong>the natural informal description of the process it implements</strong>: <em>as long as there is a line to get, process it</em>.</p>

<p>The <code>while True</code> version implements the same process, but it includes some <strong>extraneous details</strong>. Namely, it explicitly and procedurally specifies the meaning of “as long as there is a line to get”. But that’s a low-level concern that doesn’t have anything to do with line processing. And besides, it’s obvious what that means, so why not just say it?</p>

<p>This is known as the <strong><em>walrus-while</em></strong> pattern.</p>

<p>Recently I went through the <strong>Python standard library</strong> and <a href="https://github.com/python/cpython/pull/29347/files">updated all the instances of the unbounded loop pattern to the walrus-while pattern</a>. Or at least, all the instances I could find. There ended up being thirty or so. That means thirty or so sites of loop-handling logic that could potentially get screwed up. <strong>Thirty or so <code>break</code> statements deleted altogether</strong>. Poof! Gone, just like that.</p>

<p><strong>Less code is better than more code</strong>, and the walrus-while pattern results in a lot less code.</p>



<p>Rewrite the following snippet to use the walrus-while pattern:</p>

<figure><pre><code data-lang="python"><span>while</span> <span>True</span><span>:</span>
    <span>s</span> <span>=</span> <span>input</span><span>.</span><span>read</span><span>(</span><span>MAXBINSIZE</span><span>)</span>
    <span>if</span> <span>not</span> <span>s</span><span>:</span>
        <span>break</span>
    <span>while</span> <span>len</span><span>(</span><span>s</span><span>)</span> <span>&lt;</span> <span>MAXBINSIZE</span><span>:</span>
        <span>ns</span> <span>=</span> <span>input</span><span>.</span><span>read</span><span>(</span><span>MAXBINSIZE</span><span>-</span><span>len</span><span>(</span><span>s</span><span>))</span>
        <span>if</span> <span>not</span> <span>ns</span><span>:</span>
            <span>break</span>
        <span>s</span> <span>+=</span> <span>ns</span>
    <span>line</span> <span>=</span> <span>binascii</span><span>.</span><span>b2a_base64</span><span>(</span><span>s</span><span>)</span>
    <span>output</span><span>.</span><span>write</span><span>(</span><span>line</span><span>)</span></code></pre></figure>


  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
