<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.quantitativo.com/p/the-devil-is-in-the-details">Original</a>
    <h1>Implement algorithms that minimize slippage</h1>
    
    <div id="readability-page-1" class="page"><div><div dir="auto"><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png" width="1430" height="956" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:956,&#34;width&#34;:1430,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:1412054,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:false,&#34;topImage&#34;:true,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8cb29b83-9742-48e1-a131-64fe7515237e_1430x956.png 1456w" sizes="100vw" fetchpriority="high"/></picture></div></a><figcaption>Jim Simons, one of the most successful investors ever</figcaption></figure></div><blockquote><p>“The group coined a name for the difference between the prices they were getting and the theoretical trades their model made without the pesky costs. They called it The Devil.” Gregory Zuckerman.</p></blockquote><p><span>The quote above is from the great book </span><em>The Man Who Solved the Market</em><span>. In it, Gregory Zuckerman tells the story of Jim Simons, a brilliant mathematician who revolutionized the world of finance with his groundbreaking use of quantitative trading. Simons, who founded Renaissance Technologies, applied complex mathematical models to identify patterns in financial markets, a method that transformed how hedge funds operate. Zuckerman&#39;s account explores how Simons, known for his emphasis on precision and data-driven decisions, not only built one of the most successful funds in history but also reshaped the financial landscape by focusing on the importance of minimizing trading costs and maximizing efficiency.</span></p><p><strong>Minimizing trading costs</strong><span> is crucial for any trading strategy, particularly in quantitative finance, where high-frequency trades and small margins are common. Even slight discrepancies between a model&#39;s theoretical performance and its real-world execution, often caused by </span><strong>transaction fees, slippage</strong><span>, and </span><strong>market impact</strong><span>, can erode profits significantly over time. This is why Simons and his team at Renaissance Technologies paid close attention to these &#34;pesky costs&#34; and coined the term &#34;The Devil&#34; to describe the gap between the ideal and the actual trades.</span></p><p><span>A while ago, </span></p><p><span> interviewed Greg Zuckerman on </span></p><p><span> podcast. It&#39;s a great interview:</span></p><div id="youtube2-86SRqEbWcBs" data-attrs="{&#34;videoId&#34;:&#34;86SRqEbWcBs&#34;,&#34;startTime&#34;:null,&#34;endTime&#34;:null}" data-component-name="Youtube2ToDOM"><p><iframe src="https://www.youtube-nocookie.com/embed/86SRqEbWcBs?rel=0&amp;autoplay=0&amp;showinfo=0&amp;enablejsapi=0" frameborder="0" loading="lazy" gesture="media" allow="autoplay; fullscreen" allowautoplay="true" allowfullscreen="true" width="728" height="409"></iframe></p></div><p><span>This week, I will share a code snippet that aims to </span><strong>minimizes slippage while placing orders at the openings</strong><span> in live forward tests. This article will be a follow-up on the </span><a href="https://www.quantitativo.com/p/coding-live-forward-tests" rel="">Coding live forward tests</a><span> article, released on Sep-1st. It&#39;s going to be another one about coding and with deliberate attention to detail. Let me explain why.</span></p><p>First, I received an overwhelmingly positive reaction from last article. This was a surprise I wasn&#39;t expecting. Based on it, I will try to include more texts about logic, showing code snippets that help me on live forward tests and trading.</p><p>Second, the strategy I was planning on share didn&#39;t quite work. I&#39;m working on sharing new classes of strategies other than mean reversion, as well as new asset classes: next week we will see strategies different than mean reversion/momentum. But that might become a better approach to the weekly articles: I will try to share a new strategy every week; whenever it doesn&#39;t quite work, I will share logic and code.</p><p>Finally, I&#39;ve been receiving an increasing number of requests to share my backtesting software. I&#39;m still figuring out the best way to do it. More on that soon :)</p><p>This article won&#39;t be long, but will help with keeping costs in check - which is crucial while live forward testing and running strategies that trade often. Here&#39;s the plan we will follow:</p><ol><li><p>First, we will quickly review a strategy that trades often, for which keeping slippage in check is critical to its success;</p></li><li><p>Second, we will briefly describe the problem: how minimizing the slippage while placing orders at market open is challenging;</p></li><li><p>Then, we will show a solution to the problem;</p></li><li><p>Finally, we will share an implementation to that solution.</p></li></ol><p>People say the devil is in the details. Let&#39;s see how we can exorcise him.</p><p><span>We will use the long &amp; short strategy described in the “</span><a href="https://www.quantitativo.com/p/long-and-short-mean-reversion-machine" rel="">Long &amp; Short Mean Reversion Machine Learning</a><span>” article. I&#39;ve chosen this strategy because:</span></p><ul><li><p><span>The strategy has a high number of trades: 1,907 trades/year on average, which means </span><strong>7-8 trades/day</strong><span>;</span></p></li><li><p><span>The strategy has a strong performance, which is sensitive to the slippage: the backtested annual return might be </span><strong>between 23.1%</strong><span> (20 bps of slippage/trade) and </span><strong>41.9%</strong><span> (2 bps of slippage/trade).</span></p></li></ul><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png" width="1456" height="1005" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1005,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:697703,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F080b6eea-daff-4b24-9699-18155f699faa_2000x1381.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Impact of slippage and trading costs</figcaption></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png" width="1456" height="1396" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/ea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1396,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:998266,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea52c334-19ee-4f96-a204-3a5be1b6dc5c_2000x1917.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Equity curve, drawdown curve, and annual returns for the long &amp; short portfolio with the VIX regime filter</figcaption></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png" width="1456" height="1158" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/ebdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1158,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:530412,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Febdc55df-39c1-4544-85bc-ba8c59147201_2000x1590.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Summary of the trade statistics</figcaption></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png" width="1456" height="637" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/c84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:637,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:1020797,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc84ea43f-7a66-4801-92b3-110f16dcb474_2000x875.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a><figcaption>Monthly and annual returns</figcaption></figure></div><p>It is a strong strategy, but highly dependent on our ability to automate it and minimize its slippage. Let&#39;s see how to do it.</p><p><span>For more details on how the strategy was created, please </span><a href="https://www.quantitativo.com/p/long-and-short-mean-reversion-machine" rel="">check the original article</a><span>.</span></p><p>The strategy described above (as well as most of the strategies I develop) require us to place orders at market open. They assume we can execute the orders at the opening price +/- some basis points to account for slippage and trading costs (depending on the direction of the order).</p><p><span>At first, using Market-on-Open (MOO) orders seem like a great solution to the system requirement. According to </span><a href="https://www.interactivebrokers.com/en/trading/orders/moo.php" rel="">Interactive Brokers documentation</a><span>:</span></p><blockquote><p>A Market-on-Open (MOO) order combines a market order with the OPG time in force to create an order that is automatically submitted at the market&#39;s open and fills at the market price.</p></blockquote><p>So, the only thing we need to do would be running a script that generates and places MOO orders at anytime before 9:30 am US/Eastern, right? Not so fast.</p><p>MOO orders have two problems:</p><ul><li><p>First and foremost, they are not well simulated in a paper trading account, which is critical for us to live forward test a strategy before deploying real capital into it;</p></li><li><p>Furthermore, even in live trading, sometimes they do not fill at the official open price; several factors can impact the fill price (the instrument&#39;s liquidity, the exchange to which the order is routed, etc.)</p></li></ul><p>How can we address these issues?</p><div data-attrs="{&#34;url&#34;:&#34;https://www.quantitativo.com/p/the-devil-is-in-the-details?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;}" data-component-name="CaptionedButtonToDOM"><p>Thanks for reading Quant Trading Rules! This post is public so feel free to share it.</p><p data-attrs="{&#34;url&#34;:&#34;https://www.quantitativo.com/p/the-devil-is-in-the-details?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&#34;,&#34;text&#34;:&#34;Share&#34;}" data-component-name="ButtonCreateButton"><a href="https://www.quantitativo.com/p/the-devil-is-in-the-details?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p></div><p>Let&#39;s design a simple execution algorithm that solves the problem. First, let&#39;s spell out the program requirements:</p><ol><li><p><span>The algorithm must </span><strong>execute orders as close as the opening price as possible</strong><span>, thus minimizing slippage;</span></p></li><li><p><span>It&#39;s </span><strong>OK for the algorithm to eventually miss an order</strong><span>.</span></p></li></ol><p>We will start with this simple requirement, then evolve it to ensure it never misses an order.</p><p>Before describing the solution, it is also important to understand some aspects about how IBKR API currently works during market openings, which will be useful in the program:</p><ul><li><p>We can set up IBKR API to continuously stream prices (bid/ask/last) for a list of instruments we provide;</p></li><li><p>When we ask IBKR API to stream us prices from an instrument during a trading session, the API will send us the open price once right at the start of the streaming, and then will start streaming bid/ask/last prices continuously as the session goes by;</p></li><li><p>If we request IBKR API to stream us prices from an instrument before the market opens, it will start streaming bid/ask/last prices continuously from the pre-market action (as well as the close price from the previous day and a trove of other data), but it won&#39;t send us the open price;</p></li><li><p>As soon as the market opens at 9:30 am US/Eastern, the API will start streaming the open prices; it will do it only once, as soon as the opening auction finishes;</p></li><li><p>The opening auction for each instrument might take milliseconds, seconds, or even minutes, depending on the liquidity of each specific instrument.</p></li></ul><p>Based on these requirements and our understanding about how the broker&#39;s API work, let&#39;s describe a simple procedure before translating it into code:</p><ol><li><p>The program starts (anytime before the market opens), taking as input the list of orders to be executed;</p></li><li><p>As soon as it starts, our program sets up requests to acquire real time pricing data for all instruments in the list of orders;</p></li><li><p>In the callback method that allow our program to read the prices streamed for each instrument, we instruct it to hold the opening prices in memory as soon clock hits 9:30 am US/Eastern;</p></li><li><p>After starting, our program enters in an infinite loop that continuously check if the opening prices for each of the tracked instruments are already in memory (which might take milliseconds, seconds, or even minutes, depending on each instrument);</p></li><li><p>As soon as each opening price is set, inside the infinite loop iteration, we place a limit order setting the limit price as the open price;</p></li><li><p>Finally, we set a time limit inside the infinite loop, after which we cancel any pending/partially filled orders, break the loop and end the program.</p></li></ol><p>Before translating the logic into code, let&#39;s see how it translate into pseudocode.</p><p>The logic described has three main methods that must be implemented:</p><ol><li><p>The method to place the orders (the main program);</p></li><li><p>A callback method that listens to the prices being streamed by IBKR API and hold the open prices into memory;</p></li><li><p>A callback method that fires as soon as we get the open/pending/partially filled orders from IBKR API, after a while, and cancels these orders.</p></li></ol><p>Here&#39;s the pseudocode for each of these methods:</p><ul><li><p>Connect to IBKR API</p></li><li><p>Loop (only once) though all orders to be executed:</p><ul><li><p>For each instrument (aka contract), request the IBKR API to stream its prices</p></li><li><p>Hold the orders to be executed in memory</p></li></ul></li><li><p>Start an infinite loop:</p><ul><li><p>Loop through all open prices already set:</p><ul><li><p>Check if this order was already placed; if yes, skip; otherwise, continue</p></li><li><p>Set up limit order for this instrument, using the open price</p></li><li><p>Place the order</p></li><li><p>Save this order as already placed</p></li></ul></li><li><p>Check if time already limit; if yes, request all open/pending/partially filled orders (in this callback, we will cancel them)</p></li></ul></li></ul><ul><li><p>Check current time; if before 9:30 am US/Eastern, return; otherwise, continue</p></li><li><p>Check the price received; if it is an open price, save it into memory</p></li></ul><ul><li><p>Loop through all open/pending/partially filled orders:</p><ul><li><p>Cancel each of them</p></li></ul></li></ul><p>That&#39;s it. Now, let&#39;s see how all this translates into Python code.</p><p>Let&#39;s check the implementation now. It&#39;s important to highlight that I use logs a lot. Why? In my view, this practice significantly improves debugging. While writing code, we spend most of our time debugging, and bugs are an inevitable part of writing code.</p><blockquote><p>&#34;If debugging is the process of removing software bugs, then programming must be the process of putting them in.” Edsger W. Dijkstra. :)</p></blockquote><p>First, let&#39;s check the main method:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png" width="1456" height="1513" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/ae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:1513,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:443105,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fae3681ff-4dd2-4f9b-ab0d-d01164b9bf92_1580x1642.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>The code above should be straightforward, especially after seeing the logic and the pseudocode. An interesting and important highlight on the code above are the several data structures used to hold data into memory:</p><ul><li><p><code>orders_to_execute</code><span> and </span><code>app.contracts_orders</code><span>, dictionaries that hold the orders to execute using the contracts’ symbols as keys;</span></p></li><li><p><code>app.symbols_to_track</code><span>, a dictionary that holds the symbols to stream prices, using the request IDs as keys;</span></p></li><li><p><code>placed_orders</code><span>, a list of symbols to control whether an order was already placed, thus ensuring we do not duplicate any order.</span></p></li></ul><p>The line 149 is extremely important to ensure we will only cancel the unfilled/partially filled orders up until that moment.</p><p><span>Finally, let&#39;s check the </span><code>IBapi</code><span> class, that implements the interface needed to communicate with IBKR API and receive data from it through the callback methods:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png" width="1456" height="2109" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:2109,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:693971,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54cf1a6e-95ea-42cb-8e46-16564b11eb21_1584x2294.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>The code above is also straightforward and well documented, so it should be pretty readable even for people unfamiliar with IBKR native Python API. Some interesting highlights:</p><ul><li><p>Lines 55-59 set data structures to hold important data into memory throughout the program duration;</p></li><li><p>Lines 76-79 save all pricing being streamed into a CSV file, which might be handy to debug later;</p></li></ul><p>That&#39;s all there is to it. Now, we will see an improved version of the program above which</p><ol><li><p>Ensures all orders are executed, no matter what;</p></li><li><p>Provides a good start for the more adventurous readers to implement more complex and interesting logic.</p></li></ol><p>The first version of our program is my simplest possible implementation to the requirements described earlier. Now that we have it as our baseline, we can build upon it to express more interesting ideas.</p><p>Now, let&#39;s change our requirements. Let&#39;s say that, after a few minutes past the opening, instead of just cancelling the unfilled/partially filled orders, we want to replace them by market orders. How would we express this idea into code?</p><p><span>To accomplish that, we need to add a few lines of code to the </span><code>openOrderEnd</code><span> callback method:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png" width="1456" height="935" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:935,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:320205,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null,&#34;isProcessing&#34;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1d172adb-c7b0-4154-bee6-fb35969ac947_1560x1002.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>The new lines are from 110 to 124. Here&#39;s what they do in detail:</p><ul><li><p>Line 112 change the canceled order from limit to market;</p></li><li><p>Line 114 re-place the canceled limit order as market order;</p></li><li><p>Lines 106-107 are extremely important to ensure we do not replace orders more than once;</p></li><li><p>Lines 119 to 124 deal with an odd edge case: sometimes, the IBKR API take longer to stream the open price or not even stream it at all during the life of our program. In that case, must place the orders directly as market orders.</p></li></ul><p>All the rest is the same.</p><p>There&#39;s it! The building blocks shared above complete an important piece of the puzzle on the last article, ensuring we can live forward test strategies that require us to minimize slippage.</p><p>On top of that, the logic shared above is a good starting point upon which you can live forward test and live trade more interesting algorithms.</p><p>Imagine, for example, that we wanted an execution algorithm to place limit orders on the opening, and move the limit price 1 cent over the open price every 5 minutes until we get everything filled, up to a limit after which the algorithm would cancel the unfilled/partially filled orders. Imagine, in another example, that we wanted an algorithm to move the limit price using a different function (1 cent over the open price after the first 5 minutes, 2 cents after 10 minutes, 4 cents after 15, etc). We can get creative. The code above is a good starting point. Just expand it.</p><p>After two articles about execution, next week I intend to resume dissecting new strategies. Hopefully, now in a new class of strategies. There&#39;s nothing wrong with mean reversion; it&#39;s just that it&#39;s good to show ideas in other spaces as well.</p><p><span>I&#39;d love to hear your thoughts about this article. If you have any questions or comments, </span><strong><span>just reach out via </span><a href="https://x.com/quantitativo1" rel="">Twitter</a><span> or </span><a href="mailto:cs@quantitativo.com" rel="">email</a></strong><span>.</span></p><p>Cheers!</p></div></div></div>
  </body>
</html>
