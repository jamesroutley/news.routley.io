<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eighty-twenty.org/2023/01/27/sirtunnel-personal-ngrok">Original</a>
    <h1>SirTunnel, a Personal Ngrok Alternative</h1>
    
    <div id="readability-page-1" class="page"><div>
    <section>
      <p>Happy New Year!</p>

<p>From time to time I need to expose a development web site or web service to the world. In the
past, I’ve used <a href="https://ngrok.com/">ngrok</a> for that, and of course long ago I built
<a href="http://reversehttp.net/">ReverseHTTP</a> which is somewhere in the same ballpark, but I recently
got fed up with the state of affairs and decided to see whether there was something simple I
could run myself to do the job.</p>

<p>I found Anders Pitman’s <a href="https://github.com/anderspitman/SirTunnel">SirTunnel</a>:</p>

<blockquote>
  <p>Minimal, self-hosted, 0-config alternative to ngrok. Caddy+OpenSSH+50 lines of Python.</p>
</blockquote>

<p>It really is desperately simple. A beautiful bit of engineering. At its heart, it scripts
<a href="https://caddyserver.com/">Caddy</a>’s API to add and remove tunnels on the fly. When you SSH into
your server, you invoke the script, and for the duration of the SSH connection, a subdomain of
your server’s domain forwards traffic across the SSH link.</p>

<p>I’ve <a href="https://github.com/tonyg/SirTunnel">forked</a> the code for myself. So far, I haven’t
changed much: the script cleans up stale registrations at startup, as well as at exit, in case
a previous connection was interrupted somehow; and I’ve added support for forwarding to local
TLS services, with optional “insecure-mode” for avoiding certificate identity checks.</p>

<p>To get it running on a VM in the cloud, install Caddy (there’s a
<a href="https://packages.debian.org/sid/caddy"><code>caddy</code></a> package for Debian bookworm and sid), then
<em>disable</em> the systemd <code>caddy</code> service and <em>enable</em> the <code>caddy-api</code> service:</p>

<figure><pre><code data-lang="shell">apt <span>install </span>caddy
systemctl disable caddy
systemctl <span>enable </span>caddy-api
systemctl stop caddy
systemctl start caddy-api</code></pre></figure>

<p>Set up a wildcard DNS record for your server - something like <code>*.demo.example.com</code>. Each tunnel
will be made available on a subdomain of <code>demo.example.com</code>.</p>

<p>Then use the API to upload a simple “global” config. Here’s mine:</p>

<figure><pre><code data-lang="json"><span>{</span><span>
  </span><span>&#34;apps&#34;</span><span>:</span><span> </span><span>{</span><span>
    </span><span>&#34;http&#34;</span><span>:</span><span> </span><span>{</span><span>
      </span><span>&#34;servers&#34;</span><span>:</span><span> </span><span>{</span><span>
        </span><span>&#34;default&#34;</span><span>:</span><span> </span><span>{</span><span>
          </span><span>&#34;logs&#34;</span><span>:</span><span> </span><span>{},</span><span>
          </span><span>&#34;listen&#34;</span><span>:</span><span> </span><span>[</span><span>&#34;:443&#34;</span><span>],</span><span>
          </span><span>&#34;routes&#34;</span><span>:</span><span> </span><span>[]</span><span>
        </span><span>}</span><span>
      </span><span>}</span><span>
    </span><span>}</span><span>
  </span><span>}</span><span>
</span><span>}</span></code></pre></figure>

<p>Upload it by putting it in a file <code>caddy_global.json</code> and run</p>

<figure><pre><code data-lang="shell">curl <span>-L</span> localhost:2019/load <span>-H</span> <span>&#39;Content-Type: application/json&#39;</span> <span>-d</span> @caddy_global.json</code></pre></figure>

<p>Then, make sure SirTunnel’s <code>sirtunnel.py</code> script is available somewhere on the server to your
SSH user account.</p>

<p>At that point, to expose a local development service running on port 8443 to the world:</p>

<figure><pre><code data-lang="shell">ssh <span>-t</span> <span>-R</span> 8443:localhost:8443 YOURSERVER path/to/sirtunnel.py YOURAPP.demo.example.com 8443</code></pre></figure>

<p>I wrapped that up in a tiny script so that I didn’t have to remember the details of that
incantation, but it’s simple enough that you could easily just type it in the terminal each
time.</p>

<p>Many thanks to Anders Pitman for a really nice piece of software!</p>

    </section>
    
    
    
  </div></div>
  </body>
</html>
