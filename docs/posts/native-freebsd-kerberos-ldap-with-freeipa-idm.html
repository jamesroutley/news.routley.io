<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vermaden.wordpress.com/2026/02/18/native-freebsd-kerberos-ldap-with-freeipa-idm/">Original</a>
    <h1>Native FreeBSD Kerberos/LDAP with FreeIPA/IDM</h1>
    
    <div id="readability-page-1" class="page"><div>
			<p>I want to make this clear in the first sentence because its biggest chance that people will read it â€“ this article is entirely based on work done by <a href="https://blog.hofstede.it/"><b>Christian Hofstede-Kuhn (Larvitz)</b></a> that wrote <a href="https://blog.hofstede.it/integrating-freebsd-15-with-freeipa-native-kerberos-and-ldap-authentication/">Integrating FreeBSD 15 with FreeIPA: Native Kerberos and LDAP Authentication</a> recently. Credit goes to him. Besides that I like to share everything that could be useful â€“ I also treat my blog as a place where I keep and maintain my FreeBSD documentation â€¦ and I have seen many blogs and sources of knowledge disappear from the Internet over time â€¦ and as I use free <i>WordPress</i> tear I am sure this blog (and knowledge) should be here long after I am gone.</p>
<p><img src="https://vermaden.wordpress.com/wp-content/uploads/2025/11/freebsd-logo.png" width="360"/></p>
<p>So as You see there are several motivations for this:</p>
<ul>
<li>Keep and maintain personal version with more code snippets that I can copy/paste fast.</li>
<li>More detailed commands and outputs.</li>
<li>Some additional improvements that may be useful â€“ like local console login.</li>
</ul>
<p>I just hope <b>Christian</b> will not be mad at me for this ðŸ™‚</p>
<p>â€¦ and I will directly notify him about this article.</p>
<p><img src="https://vermaden.wordpress.com/wp-content/uploads/2022/11/freeipa-logo.png"/></p>
<p>First of all â€“ this new method is possible to work because FreeBSD switched from Heimdal Kerberos implementation to MIT Kerberos in FreeBSD 15.0-RELEASE â€¦ and I am really glad that FreeBSD finally did it.</p>
<p>As You know I already messed with that topic several times in the past:</p>
<ul>
<li><a href="https://vermaden.wordpress.com/2022/11/17/connect-freebsd-freeipa-idm/">Connect FreeBSD to FreeIPA/IDM</a></li>
<li><a href="https://vermaden.wordpress.com/2023/03/29/connect-freebsd-13-2-to-freeipa-idm/">Connect FreeBSD 13.2 to FreeIPA/IDM</a></li>
<li><a href="https://vermaden.wordpress.com/2023/08/10/freebsd-on-freeipa-idm-with-poudriere-repo/">FreeBSD on FreeIPA/IDM with Poudriere Repo</a></li>
<li><a href="https://vermaden.wordpress.com/2024/03/06/connect-freebsd-14-0-stable-to-freeipa-idm/">Connect FreeBSD 14.0-STABLE to FreeIPA/IDM</a></li>
</ul>
<p>All of these previous attempts had many downsides:</p>
<ul>
<li>You needed to (re)compile multiple custom packages from <i>FreeBSD Ports</i>.</li>
<li>Sometimes it was needed to use custom code by <a href="https://oshogbo.com/"><b>Mariusz Zaborski (oshogbo)</b></a> for example.</li>
<li>Complex <tt><b>sssd(8)</b></tt> daemon with many deps/reqs including D-Bus or Python and more.</li>
<li>Setup was complicated/fragile and prune to errors â€“ especially during upgrades.</li>
</ul>
<p>This new way is using MIT Kerberos from FreeBSD 15.0-RELEASE and small lightweight <tt><b>nslcd(8)</b></tt> daemon from <tt><b>net/nss-pam-ldapd</b></tt> package. The only (non technical) downside is that it uses LGPL21/LGPL3 license â€¦ but as we connect to entire Linux domain with FreeIPA/IDM it does not matter much, does it? :)Now â€“ we first need FreeIPA/IDM server â€¦ use instructions from older <a href="https://vermaden.wordpress.com/2024/03/06/connect-freebsd-14-0-stable-to-freeipa-idm/">Connect FreeBSD 14.0-STABLE to FreeIPA/IDM</a> article.Now for the new way â€¦ lets start by switching the <tt><b>pkg(8)</b></tt> repository from <tt><b>quarterly</b></tt> to <tt><b>latest</b></tt>.</p>
<pre><span><strong>FreeBSD # <span>mkdir -p /usr/local/etc/pkg/repos</span>

FreeBSD # <span>sed s/quarterly/latest/g /etc/pkg/FreeBSD.conf &gt; /usr/local/etc/pkg/repos/FreeBSD.conf
</span></strong></span></pre>
<p>Next we will install needed packages.</p>
<pre><span><strong>FreeBSD # <span>pkg install -y nss-pam-ldapd pam_mkhomedir sudo doas</span></strong></span></pre>
<p>If your DNS configured at <tt><b>/etc/resolv.conf</b></tt> does not resolve FreeIPA/IDM use <tt><b>/etc/hosts</b></tt> instead.</p>
<pre><span><strong>FreeBSD # <span>cat &lt;&lt; __EOF &gt;&gt; /etc/hosts
</span></strong></span>172.27.33.200  rhidm.lab.org   rhidm
172.27.33.215  fbsd15.lab.org  fbsd15
<span><strong>__EOF
</strong></span></pre>
<p>Add our new FreeBSD host and its IP on FreeIPA/IDM server.</p>
<pre><span><strong>[root@idm ~]# <span>kinit admin
</span></strong></span>Password for admin@LAB.ORG: 
<span><strong>
[root@idm ~]# <span>ipa dnsrecord-add lab.org fbsd15 --a-rec=172.27.33.215 --a-create-reverse</span></strong></span>
  Record name: fbsd15
  A record: 172.27.33.215

<span><strong>[root@idm ~]# <span>ipa host-add fbsd15.lab.org</span></strong></span>
---------------------------
Added host &#34;fbsd15.lab.org&#34;
---------------------------
  Host name: fbsd15.lab.org
  Principal name: host/fbsd15.lab.org@LAB.ORG
  Principal alias: host/fbsd15.lab.org@LAB.ORG
  Password: False
  Keytab: False
  Managed by: fbsd15.lab.org

<strong><span>[root@idm ~]# </span><span>ipa-getkeytab -s rhidm.lab.org -p host/fbsd15.lab.org@LAB.ORG -k /root/fbsd15.keytab</span></strong>
Keytab successfully retrieved and stored in: /root/fbsd15.keytab

<span><strong>[root@idm ~]# <span>cp /root/fbsd15.keytab /usr/share/ipa/html/</span>

[root@idm ~]# <span>chmod 644 /usr/share/ipa/html/fbsd15.keytab

</span></strong></span></pre>
<p>On FreeBSD host copy the keytab from FreeIPA/IDM server and put it into right place with proper permissions.</p>
<pre><span><strong>FreeBSD # <span>fetch -o /etc/krb5.keytab http://rhidm.lab.org/ipa/config/fbsd15.keytab</span></strong></span>
/root/fbsd15.keytab                            314  B  804 kBps    00s

<span><strong>FreeBSD # <span>chmod 640 /etc/krb5.keytab
</span></strong></span></pre>
<p>Verify FreeBSD keytab.</p>
<pre><span><strong>FreeBSD # <span>klist -k</span></strong></span>
Keytab name: FILE:/etc/krb5.keytab
KVNO Principal
---- --------------------------------------------------------------------------
   1 host/fbsd15.lab.org@LAB.ORG
   1 host/fbsd15.lab.org@LAB.ORG
   1 host/fbsd15.lab.org@LAB.ORG
   1 host/fbsd15.lab.org@LAB.ORG
</pre>
<p>The <tt><b>nslcd(8)</b></tt> daemon will need <tt><b>/etc/krb5.keytab</b></tt> keytab read access to work â€“ to achieve that we will add <tt><b>sshd</b></tt> user to its <tt><b>nslcd</b></tt> group.</p>
<pre><span><strong>FreeBSD # <span>groups sshd</span></strong></span>
sshd

<span><strong>FreeBSD # <span>pw groupmod nslcd -m sshd</span>

FreeBSD # <span>groups sshd</span></strong></span>
sshd nslcd</pre>
<p>Prepare <tt><b>/etc/krb5.conf</b></tt> config.</p>
<pre><span><strong>FreeBSD # <span>cat &lt;&lt; __EOF &gt; /etc/krb5.conf</span></strong></span>
[libdefaults]
  default_realm    = LAB.ORG
  dns_lookup_kdc   = false
  dns_lookup_realm = false

[realms]
  LAB.ORG = {
    kdc          = rhidm.lab.org
    admin_server = rhidm.lab.org
  }

[domain_realm]
  .lab.org = LAB.ORG
   lab.org = LAB.ORG
<strong><span>__EOF
</span></strong></pre>
<p>Create <tt><b>/usr/local/etc/nslcd.conf</b></tt> config for <tt><b>nslcd(8)</b></tt> daemon.</p>
<pre><span><strong>FreeBSD # <span>cat &lt;&lt; __EOF &gt; /usr/local/etc/nslcd.conf</span></strong></span>
<span># RUN AS nslcd USER </span>
uid nslcd
gid nslcd

<span># LDAP CONNECTION DETAILS</span>
uri  ldap://rhidm.lab.org
base dc=lab,dc=org

<span># USE SYSTEM KEYTAB FOR AUTH</span>
sasl_mech  GSSAPI
sasl_realm LAB.ORG

<span># FORCE /bin/sh SHELL</span>
map passwd loginShell &#34;/bin/sh&#34;
<span><strong>__EOF</strong></span></pre>
<p>Enable and start the <tt><b>nslcd(8)</b></tt> daemon.</p>
<pre><span><strong>FreeBSD # <span>service nslcd enable</span></strong></span>
nslcd enabled in /etc/rc.conf

<span><strong>FreeBSD # <span>service nslcd start</span></strong></span>
Starting nslcd.
</pre>
<p>Modify <tt><b>/etc/nsswitch.conf</b></tt> config the following way with simple <tt><b>sed(1)</b></tt> one liner.</p>
<pre><strong><span>FreeBSD #</span> <span>sed -i &#39;.OLD&#39; -E \
              -e &#39;s/^group:.*/group: files ldap/g&#39;   \
              -e &#39;s/^passwd:.*/passwd: files ldap/g&#39; \
              /etc/nsswitch.conf
</span></strong></pre>
<p>This is what we changed.</p>
<pre><span><strong>FreeBSD # <span>diff -u /etc/nsswitch.conf.OLD /etc/nsswitch.conf</span></strong></span>
--- /etc/nsswitch.conf.OLD 2026-02-18 04:54:41.487608000 +0000
+++ /etc/nsswitch.conf     2026-02-18 04:59:00.234662000 +0000
@@ -1,9 +1,9 @@
<span>-group: compat</span>
<span>+group: files ldap</span>
 group_compat: nis
 hosts: files dns
 netgroup: compat
 networks: files
<span>-passwd: compat</span>
<span>+passwd: files ldap</span>
 passwd_compat: nis
 shells: files
 services: compat
</pre>
<p>One can use even more compact <tt><b>/etc/nsswitch.conf</b></tt> as shown by <a href="https://blog.hofstede.it/"><b>Christian Hofstede-Kuhn (Larvitz)</b></a> below.</p>
<pre><span><strong>FreeBSD # <span>cat &lt;&lt; __EOF &gt; /etc/nsswitch.conf</span></strong></span>
group: files ldap
passwd: files ldap
hosts: files dns
networks: files
shells: files
services: compat
protocols: files
rpc: files
<strong><span>__EOF
</span></strong></pre>
<p>Now lets test how it works.</p>
<pre><span><strong>FreeBSD # <span>id vermaden</span></strong></span>
uid=854800003(vermaden) gid=854800003(vermaden) groups=854800003(vermaden)

</pre>
<p>Now the <tt><b>sshd(8)</b></tt> part.</p>
<pre><span><strong>FreeBSD # <span>cat &lt;&lt; __EOF &gt;&gt; /etc/ssh/sshd_config</span></strong></span>
<span># KRB5/GSSAPI AUTH</span>
GSSAPIAuthentication      yes
GSSAPICleanupCredentials  yes
GSSAPIStrictAcceptorCheck no
<strong><span>__EOF
</span></strong></pre>
<p>Time to restart <tt><b>sshd(8)</b></tt> daemon.</p>
<pre><span><strong>FreeBSD # <span>service sshd restart</span></strong></span>
Performing sanity check on sshd configuration.
Stopping sshd.
Waiting for PIDS: 1089.
Performing sanity check on sshd configuration.
Starting sshd.
</pre>
<p>Now lets test how it works over SSH.</p>
<pre><span><strong>[root@rhidm ~]# <span>kinit vermaden</span></strong></span>
Password for vermaden@LAB.ORG: 

<span><strong>[root@rhidm ~]# <span>ssh fbsd15 -l vermaden</span></strong></span>
FreeBSD 15.0-RELEASE-p2 (GENERIC) releng/15.0-n281005-5fb0f8e9e61d

Welcome to FreeBSD!

Release Notes, Errata: https://www.FreeBSD.org/releases/
Security Advisories:   https://www.FreeBSD.org/security/
FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
FreeBSD FAQ:           https://www.FreeBSD.org/faq/
Questions List:        https://www.FreeBSD.org/lists/questions/
FreeBSD Forums:        https://forums.FreeBSD.org/

Documents installed with the system are in the /usr/local/share/doc/freebsd/
directory, or can be installed later with:  pkg install en-freebsd-doc
For other languages, replace &#34;en&#34; with a language code like de or fr.

Show the version of FreeBSD installed:  freebsd-version ; uname -a
Please include that output and any error messages when posting questions.
Introduction to manual pages:  man man
FreeBSD directory layout:      man hier

To change this login announcement, see motd(5).

<span>Could not chdir to home directory /home/vermaden: No such file or directory</span>

<span><strong>vermaden@fbsd15:/ $ <span>id admin</span></strong></span>
uid=854800000(admin) gid=854800000(admins) groups=854800000(admins)

<span><strong>vermaden@fbsd15:/ $ <span>id</span></strong></span>
uid=854800003(vermaden) gid=854800003(vermaden) groups=0(wheel),854800003(vermaden)</pre>
<p>Works but â€¦ the <tt><b>${HOME}</b></tt> directory is not automatically created because we did not configured it yet.</p>
<p>Lets use <tt><b>sed(1)</b></tt> again â€¦ and yes it has to be spread over two lines.</p>
<pre><span><strong>FreeBSD # <span>sed -i &#39;.OLD&#39; &#39;/^session.*/i\
session optional pam_mkhomedir.so mode=0700&#39; /etc/pam.d/sshd</span></strong>

<strong>FreeBSD # <span>ls -l /etc/pam.d/sshd*</span></strong></span>
-rw-r--r--  1 root wheel 608 Feb 18 05:18 /etc/pam.d/sshd
-rw-r--r--  1 root wheel 564 Feb 18 05:18 /etc/pam.d/sshd.OLD

<span><strong>FreeBSD # <span>diff -u /etc/pam.d/sshd.OLD /etc/pam.d/sshd</span></strong></span>
--- /etc/pam.d/sshd.OLD 2026-02-18 05:20:50.344139000 +0000
+++ /etc/pam.d/sshd     2026-02-18 05:20:53.552277000 +0000
@@ -16,6 +16,7 @@
 
 # session
 #session       optional        pam_ssh.so              want_agent
<span>+session        optional        pam_mkhomedir.so        mode=0700</span>
 session        required        pam_permit.so
 
 # password
</pre>
<p>We use <tt><b>optional</b></tt> instead of <tt><b>required</b></tt> if for some reason <tt><b>pam_mkhomedir.so</b></tt> fails or is not available.</p>
<p>For the record the entire <tt><b>/etc/pam.d/sshd</b></tt> PAM config looks like that.</p>
<pre><span><strong>FreeBSD # <span>cat /etc/pam.d/sshd</span></strong></span>
<span># auth</span>
auth            required        pam_unix.so             no_warn try_first_pass

<span># account</span>
account         required        pam_nologin.so
account         required        pam_login_access.so
account         required        pam_unix.so

<span># session</span>
<span>session         optional        pam_mkhomedir.so        mode=0700</span>
session         required        pam_permit.so

<span># password</span>
password        required        pam_unix.so             no_warn try_first_pass
</pre>
<p>We will now configure <tt><b>sudo(8)</b></tt> for more permissions.</p>
<pre><span><strong>FreeBSD # <span>pw groupmod wheel -m vermaden</span>

FreeBSD # <span>cat &lt;&lt; __EOF &gt;&gt; /usr/local/etc/sudoers</span></strong></span>
%wheel ALL=(ALL:ALL) NOPASSWD: ALL
<strong><span>__EOF
</span></strong></pre>
<p>We will also do <tt><b>doas(1)</b></tt> here as its simpler and more secure.</p>
<pre><span><strong>FreeBSD # <span>cat &lt;&lt; __EOF &gt; /usr/local/etc/doas.conf</span></strong></span>
permit nopass keepenv root   as root
permit nopass keepenv :wheel as root
<span><strong>__EOF
</strong></span></pre>
<p>Now lets try to login again.</p>
<pre><span><strong>[root@rhidm ~]# <span>kinit vermaden</span></strong></span>
Password for vermaden@LAB.ORG: 

<span><strong>[root@rhidm ~]# <span>ssh fbsd15 -l vermaden</span>

vermaden@fbsd15:~ $ <span>pwd</span></strong></span>
/home/vermaden

<span><strong>vermaden@fbsd15:~ $ <span>sudo -i</span></strong></span>
root@fbsd15:~ #
</pre>
<p>Better.</p>
<p>I also â€˜silencedâ€™ the login a little by creating empty <tt><b>~/.hushlogin</b></tt> file and by removing <tt><b>/usr/bin/fortune</b></tt> from the <tt><b>~/.profile</b></tt> file.</p>
<pre><span><strong>vermaden@fbsd15~/ $ <span>:&gt; ~/.hushlogin</span>

vermaden@fbsd15:~ $ <span>sed -i &#39;.OLD&#39; &#39;/fortune/d&#39; ~/.profile
</span></strong></span></pre>
<p>â€¦ and this is the part I added â€“ using FreeIPA/IDM user for console access â€“ because right now â€“ it does not work.</p>
<pre><strong>FreeBSD/amd64 (fbsd15.lab.org) (ttyu0)</strong>

login: <span><strong>vermaden</strong></span>
Password:
Login incorrect

</pre>
<p>To allow that we will uncomment all lines matching the <tt><b>pam_krb5.so</b></tt> module within <tt><b>/etc/pam.d/system</b></tt> config.</p>
<pre><span><strong>FreeBSD # <span>sed -i &#39;.OLD&#39; &#39;/pam_krb5.so/s/^#//g&#39; /etc/pam.d/system</span></strong>

<strong>FreeBSD # <span>ls -l /etc/pam.d/system*</span></strong></span>
-rw-r--r--  1 root wheel 568 Feb 18 05:34 /etc/pam.d/system
-rw-r--r--  1 root wheel 571 Feb 18 05:33 /etc/pam.d/system.OLD

<span><strong>FreeBSD # <span>diff -u /etc/pam.d/system.OLD /etc/pam.d/system</span></strong></span>
--- /etc/pam.d/system.OLD 2026-02-18 05:33:48.171585000 +0000
+++ /etc/pam.d/system     2026-02-18 05:34:24.444767000 +0000
@@ -4,12 +4,12 @@
 #
 
 # auth
<span>-#auth          sufficient      pam_krb5.so             no_warn try_first_pass</span>
<span>+auth           sufficient      pam_krb5.so             no_warn try_first_pass</span>
 #auth          sufficient      pam_ssh.so              no_warn try_first_pass
 auth           required        pam_unix.so             no_warn try_first_pass nullok
 
 # account
<span>-#account       required        pam_krb5.so</span>
<span>+account        required        pam_krb5.so</span>
 account                required        pam_login_access.so
 account                required        pam_unix.so
 
@@ -19,5 +19,5 @@
 session         required        pam_xdg.so
 
 # password
<span>-#password      sufficient      pam_krb5.so             no_warn try_first_pass</span>
<span>+password       sufficient      pam_krb5.so             no_warn try_first_pass</span>
 password       required        pam_unix.so             no_warn try_first_pass
</pre>
<p>Lets try again.</p>
<pre><strong>FreeBSD/amd64 (fbsd15.lab.org) (ttyu0)</strong>

login: <strong><span>vermaden</span></strong>
Password: 

<strong><span>vermaden@fbsd15:~ $ <span>klist</span></span></strong>
klist: No credentials cache found (filename: /tmp/krb5cc_854800003_AeF9er)

<span><strong>vermaden@fbsd15:~ $ <span>kinit</span></strong> </span>
Password for vermaden@LAB.ORG: 

<span><strong>vermaden@fbsd15:~ $ <span>klist</span></strong></span>
Ticket cache: FILE:/tmp/krb5cc_854800003_AeF9er
Default principal: vermaden@LAB.ORG

Valid starting     Expires            Service principal
02/18/26 05:27:47  02/19/26 05:07:21  krbtgt/LAB.ORG@LAB.ORG

</pre>
<p>You have reached the end of this article â€“ see you in the next one ðŸ™‚</p>
<p>EOF</p>
					</div></div>
  </body>
</html>
