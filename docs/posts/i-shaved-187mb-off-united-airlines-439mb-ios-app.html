<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://telkins.dev/posts/how-i-shaved-187mb-off-uniteds-airlines-439mb-ios-app/">Original</a>
    <h1>I shaved 187MB off United Airlines&#39; 439MB iOS app</h1>
    
    <div id="readability-page-1" class="page"><article>
    
    <div>
        <p><time datetime="02-21-2022T18:06:00-05:00">02-21-2022</time> / 
        

        
        tags — <a href="https://telkins.dev/tags/ios">iOS</a> / 
        
        categories — <a href="https://telkins.dev/categories/dev">dev</a></p><p><b>By Trevor Elkins</b> (7 minute read)</p>
    </div>
    <h2 id="preface">Preface</h2>
<p>In today’s continuation of my saga against ridiculous app sizes, I take a look at United Airlines&#39; iOS app.</p>
<p>There I was, boarding my United plane and walking past the rows and rows of seats, when I finally noticed none of them had built-in headrest screens. <em>I swear I double-checked this before booking my ticket</em>. As I sat down, an intercom announcement came on reminding passengers to download the United app if they wanted access to in-flight movies and entertainment. This wasn’t the first time I had seen this, Hawaiian Airlines pulled the same stunt on me before. It’s becoming somewhat of a popular trend in the airline industry to cut costs by having the passenger bring the hardware, and as an added bonus they get to force their way into your coveted list of installed apps. No worries then, I’ll download their app and be on my way…</p>
<p>… wait, it’s 439MB?! This can’t be right.</p>
<figure>
    <img src="https://telkins.dev/images/united_app.jpg" alt="United Airlines App" width="300px"/> 
</figure>

<p><strong>Note</strong>: as mentioned in my previous article, download and install sizes are a tricky subject for iOS. Apple heavily compresses the download size (which is great!) but doesn’t make this easy to find. Apple also supports incremental downloads, meaning you can download a “diff” of app binaries in some cases (also amazing!), but this is even harder to measure on an actual device. In my case I was trying to download the United app for the first time on a runway before my flight took off.</p>
<h2 id="under-the-hood">Under the hood</h2>
<p>An app being this bloated is seriously impressive and had me intrigued – most bloated apps are within the 100-200MB range, not 400MB. Netflix itself is only 101.5MB, does United really need 4x the space to stream movies? Let’s take a look.</p>
<p>Using the wonderful <a href="https://github.com/majd/ipatool">ipatool</a>, you can download app binaries locally for inspection. After downloading the IPA file, simply rename the file extension to <code>zip</code> and then extract like normally.</p>
<div><pre><code data-lang="bash">--- UnitedCustomerFacingIPhone.app -----------
  414.8 MiB <span>[</span>█████████████████████<span>]</span> /Frameworks
    3.8 MiB <span>[</span>                     <span>]</span> /PlugIns
    2.3 MiB <span>[</span>                     <span>]</span> /LPMessagingSDKModels.bundle
    2.3 MiB <span>[</span>                     <span>]</span>  UnitedCustomerFacingIPhone
    1.5 MiB <span>[</span>                     <span>]</span>  Assets.car
    1.4 MiB <span>[</span>                     <span>]</span> /_CodeSignature
    1.4 MiB <span>[</span>                     <span>]</span> /Watch
  500.0 KiB <span>[</span>                     <span>]</span> /Button.bundle
   40.0 KiB <span>[</span>                     <span>]</span> /SC_Info
   12.0 KiB <span>[</span>                     <span>]</span>  Info.plist
   12.0 KiB <span>[</span>                     <span>]</span> /Base.lproj
    8.0 KiB <span>[</span>                     <span>]</span>  <a href="https://telkins.dev/cdn-cgi/l/email-protection" data-cfemail="d392a3a39ab0bcbde4e5abe4e593e1ab">[email protected]</a>~ipad.png
    8.0 KiB <span>[</span>                     <span>]</span>  <a href="https://telkins.dev/cdn-cgi/l/email-protection" data-cfemail="95d4e5e5dcf6fafba3a5eda3a5d5a7edbbe5fbf2">[email protected]</a>
    4.0 KiB <span>[</span>                     <span>]</span> /UALFlightStatus.bundle
    4.0 KiB <span>[</span>                     <span>]</span> /UALReservation.bundle
    4.0 KiB <span>[</span>                     <span>]</span> /UALBagTracking.bundle
    4.0 KiB <span>[</span>                     <span>]</span> /UALPayment.bundle
    4.0 KiB <span>[</span>                     <span>]</span> /UALBooking.bundle
    4.0 KiB <span>[</span>                     <span>]</span>  Localizable.strings
    4.0 KiB <span>[</span>                     <span>]</span>  PkgInfo
</code></pre></div><p>Nearly all of the app size comes from frameworks! This isn’t too surprising though, pushing code into frameworks has been a best practice for a while.</p>
<div><pre><code data-lang="bash">--- UnitedCustomerFacingIPhone.app/Frameworks
                                    /..
   86.0 MiB <span>[</span>█████████████████████<span>]</span> /UALAppCore.framework
   44.7 MiB <span>[</span>██████████▌          <span>]</span> /UALBooking.framework
   40.3 MiB <span>[</span>█████████▌           <span>]</span> /NodeMobile.framework
   36.1 MiB <span>[</span>████████▌            <span>]</span> /UALHomeScreen.framework
   25.7 MiB <span>[</span>██████               <span>]</span> /UALCheckIn.framework
   25.0 MiB <span>[</span>██████               <span>]</span> /UALReservation.framework
   17.5 MiB <span>[</span>████                 <span>]</span> /UALCommonUI.framework
   15.9 MiB <span>[</span>███▌                 <span>]</span> /UALPayment.framework
   14.7 MiB <span>[</span>███▌                 <span>]</span> /LocusLabsSDK.framework
    8.7 MiB <span>[</span>██                   <span>]</span> /Mapbox.framework
    8.6 MiB <span>[</span>██                   <span>]</span> /UALFlightStatus.framework
    8.6 MiB <span>[</span>██                   <span>]</span> /widevine_cdm_secured_ios.framework
    7.2 MiB <span>[</span>█▌                   <span>]</span> /LPMessagingSDK.framework
    6.8 MiB <span>[</span>█▌                   <span>]</span> /Netverify.framework
    6.6 MiB <span>[</span>█▌                   <span>]</span> /BlinkCard.framework
    6.4 MiB <span>[</span>█▌                   <span>]</span> /UALMyAccount.framework
    5.7 MiB <span>[</span>█                    <span>]</span> /WebRTC.framework
    5.3 MiB <span>[</span>█                    <span>]</span> /UnifiedPlayerLibrary.framework
    4.4 MiB <span>[</span>█                    <span>]</span> /UALLogin.framework
    4.1 MiB <span>[</span>▌                    <span>]</span> /UALAirportMaps.framework
    3.9 MiB <span>[</span>▌                    <span>]</span> /INPlayUtils.framework
    3.5 MiB <span>[</span>▌                    <span>]</span> /UALEntertainment.framework
    2.5 MiB <span>[</span>▌                    <span>]</span> /UALUnitedClubs.framework
    2.4 MiB <span>[</span>▌                    <span>]</span> /UALBagTracking.framework
    2.3 MiB <span>[</span>▌                    <span>]</span> /DashToHls.framework
    2.3 MiB <span>[</span>▌                    <span>]</span> /InMobileMME.framework
    1.9 MiB <span>[</span>                     <span>]</span> /AcquireIOSDK.framework
    1.8 MiB <span>[</span>                     <span>]</span> /Optimizely.framework
    1.8 MiB <span>[</span>                     <span>]</span> /GoogleInteractiveMediaAds.framework
    1.7 MiB <span>[</span>                     <span>]</span> /Qualtrics.framework
    1.7 MiB <span>[</span>                     <span>]</span> /UALDocumentScanning.framework
    1.4 MiB <span>[</span>                     <span>]</span> /PACStreaming.framework
    1.3 MiB <span>[</span>                     <span>]</span> /INPLAYControlsLibrary.framework
    1.1 MiB <span>[</span>                     <span>]</span> /JumioCore.framework
  968.0 KiB <span>[</span>                     <span>]</span> /UALCommonSearch.framework
  892.0 KiB <span>[</span>                     <span>]</span> /PACCoreKit.framework
  876.0 KiB <span>[</span>                     <span>]</span> /UnifiedPlayerViewController.framework
  868.0 KiB <span>[</span>                     <span>]</span> /SocketIO.framework
  856.0 KiB <span>[</span>                     <span>]</span> /INPLAYiOSLibrary.framework
  632.0 KiB <span>[</span>                     <span>]</span> /UpLiftSDK.framework
  540.0 KiB <span>[</span>                     <span>]</span> /Starscream.framework
  424.0 KiB <span>[</span>                     <span>]</span> /MapboxMobileEvents.framework
  384.0 KiB <span>[</span>                     <span>]</span> /McPicker.framework
  284.0 KiB <span>[</span>                     <span>]</span> /UALUnifiedPlayer.framework
  164.0 KiB <span>[</span>                     <span>]</span> /iOSAdLibrary.framework
  124.0 KiB <span>[</span>                     <span>]</span> /iOSVastAdLibrary.framework
</code></pre></div><p>I’d categorize most of these as:</p>
<ul>
<li>Core architecture split into various <code>UAL</code> frameworks</li>
<li><code>NodeMobile</code> for some NodeJS functionality, curious what this is for</li>
<li>Map providers [<code>LocusLabsSDK</code>, <code>Mapbox</code>]</li>
<li>App services like identity verification [<code>Netverify</code>, <code>JumioCore</code>], customer support [<code>LPMessagingSDK</code>], customer feedback [<code>Qualtrics</code>]</li>
<li>Video playback [<code>WebRTC</code>, <code>DashToHls</code>, <code>widevine_cdm_secured_ios</code>, <code>UnifiedPlayerViewController</code>, <code>PACStreaming</code>, <code>PACCoreKit</code>, <code>INPLAYControlsLibrary</code>]</li>
<li>Websockets [both <code>Starscream</code> and <code>SocketIO</code>?]</li>
<li>Ad tech [<code>AcquireIOSDK</code>, <code>iOSAdLibrary</code>, <code>iOSVastAdLibrary</code>, <code>GoogleInteractiveMediaAds</code>]</li>
<li>User Acquisition [<code>AcquireIOSDK</code>, <code>Optimizely</code>]</li>
</ul>
<p>Let’s inspect the biggest framework, <code>UALAppCore</code>.</p>
<div><pre><code data-lang="bash">--- Frameworks/UALAppCore.framework
                              /..
   76.8 MiB <span>[</span>███████████████<span>]</span>  UALAppCore
    6.9 MiB <span>[</span>█              <span>]</span> /UnitediPhoneCoreDataModel.momd
  760.0 KiB <span>[</span>               <span>]</span>  DefaultAirports.json
  708.0 KiB <span>[</span>               <span>]</span>  UA_AppCore_database.sqlite
  412.0 KiB <span>[</span>               <span>]</span> /SC_Info
  116.0 KiB <span>[</span>               <span>]</span> /UAAppCoreDataModel.momd
  108.0 KiB <span>[</span>               <span>]</span> /HomeScreenDataModel.momd
   44.0 KiB <span>[</span>               <span>]</span>  UAAppCoreDataModelv3v4.cdm
   36.0 KiB <span>[</span>               <span>]</span> /_CodeSignature
   20.0 KiB <span>[</span>               <span>]</span> /ReservationDataModel.momd
   16.0 KiB <span>[</span>               <span>]</span>  LoginDataModelv3_v4.cdm
</code></pre></div><p>OK, so the vast majority of the size is within <code>UALAppCore.framework</code> itself. 77MB is very large for a framework. We can dig in further with our trusty <code>nm</code> tool to inspect the framework’s symbols.</p>
<div><pre><code data-lang="text">➜  UnitedCustomerFacingIPhone.app nm -m Frameworks/UALAppCore.framework/UALAppCore
000000000153c36c (__TEXT,__text) non-external +[CYFBackgroundEventFormatter formatEvent:]
0000000001542bec (__TEXT,__text) non-external +[CYFBackgroundEventManager sharedBackgroundEventManager]
0000000001538764 (__TEXT,__text) non-external +[CYFChallengeActionView showDialog:title:message:cancelButtonTitle:delegate:]
0000000001533e78 (__TEXT,__text) non-external +[CYFCircularProgressTheme standardTheme]
0000000001533e50 (__TEXT,__text) non-external +[CYFCircularProgressTheme themeWithName:]
000000000152f3d4 (__TEXT,__text) non-external +[CYFCryptoChallengeAction sharedInstance]
000000000152a99c (__TEXT,__text) non-external +[CYFDCTEncoder dctEncode:withLength:andCompression:]
000000000152aff4 (__TEXT,__text) non-external +[CYFDCTEncoder encode:withLength:]
000000000152b010 (__TEXT,__text) non-external +[CYFDCTEncoder encode:withLength:andCompression:]
000000000152ad54 (__TEXT,__text) non-external +[CYFDCTEncoder simpleEncode:withLength:]
...
</code></pre></div><p>Now we’re getting somewhere. I’m not an expert at how symbols are packed into an executable, but I do remember Swift symbols need to be stripped, unlike ObjC (fact check pls?). Let’s see if we can find some.</p>
<div><pre><code data-lang="text">0000000001a4c760 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV06createB10DataObject33_4C5DED22C8FD26C81E26FA4955E2A94ALL10difficulty3num6puzzle8solutionys5Int16V_s5Int32VS2StF
0000000001a4c7a0 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV19fixUnresponsiveGame33_4C5DED22C8FD26C81E26FA4955E2A94ALLyyF
0000000001a4c808 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV19fixUnresponsiveGame33_4C5DED22C8FD26C81E26FA4955E2A94ALLyyFSSyKXEfu0_
0000000001a4c800 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV19fixUnresponsiveGame33_4C5DED22C8FD26C81E26FA4955E2A94ALLyyFSSyKXEfu_
0000000001a4c7c8 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV21prepopulatedCDManager33_4C5DED22C8FD26C81E26FA4955E2A94ALLAA0B11DataManagerCSgyF
0000000001a4c7d8 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV21prepopulatedCDManager33_4C5DED22C8FD26C81E26FA4955E2A94ALLAA0B11DataManagerCSgyFyycfU_
0000000001a4c738 (__DATA,__llvm_prf_cnts) non-external (was a private external) ___profc_/Users/uasvcagent/Go_Pipeline/pipelines/UA-AppCore-Release-iOS/UALAppCore/Classes/CoreData/Handlers/HomeScreen/UASudokuPuzzle.swift:$s10UALAppCore14UASudokuPuzzleV24fetchRequestFromTemplate33_4C5DED22C8FD26C81E26FA4955E2A94ALL8withName21substitutionVariablesSo07NSFetchF0CySo0vF6Result_pGSgSS_SDySSypGtF
</code></pre></div><p>Interesting! It looks like none of the Swift framework symbols have been stripped, severely bloating our binary size. We can actually see United’s CI pipeline as part of the symbol name. 🤣</p>
<p>Like I said before, none of these symbols are actually needed. Let’s whip up a Bash script to run the frameworks through <code>strip</code>:</p>
<div><pre><code data-lang="bash"><span>#!/bin/bash
</span><span></span>
<span>function</span> strip_framework<span>()</span> <span>{</span>
    <span>FRAMEWORK_NAME</span><span>=</span><span>$(</span>basename <span>&#34;</span><span>$1</span><span>&#34;</span><span>)</span>
    strip -rSTx -no_code_signature_warning <span>&#34;</span><span>$1</span><span>&#34;</span> -o <span>&#34;StrippedFrameworks/</span><span>$FRAMEWORK_NAME</span><span>&#34;</span>
<span>}</span>

<span>function</span> copy_framework<span>()</span> <span>{</span>
    <span>FRAMEWORK_NAME</span><span>=</span><span>$(</span>basename <span>&#34;</span><span>$1</span><span>&#34;</span><span>)</span>
    cp -- <span>&#34;</span><span>$1</span><span>&#34;</span> <span>&#34;OriginalFrameworks/</span><span>$FRAMEWORK_NAME</span><span>&#34;</span>
<span>}</span>

<span>export</span> -f strip_framework
<span>export</span> -f copy_framework

<span># I couldn&#39;t figure out how to &#39;find&#39; for only binary files =[</span>
find <span>&#34;</span><span>$1</span><span>&#34;</span> -perm +111 -type f -not -name <span>&#34;*.js&#34;</span> -not -name <span>&#34;*.png&#34;</span> <span>\
</span><span></span>-not -name <span>&#34;*.json&#34;</span> -not -name <span>&#34;*.svg&#34;</span> -not -name <span>&#34;*.plist&#34;</span> -not -name <span>&#34;*.md&#34;</span> -not -name <span>&#34;*.sh&#34;</span> <span>\
</span><span></span>-exec bash -c <span>&#34;strip_framework \&#34;{}\&#34;; copy_framework \&#34;{}\&#34;&#34;</span> <span>\;</span>
</code></pre></div><p>and see how we did:</p>
<div><pre><code data-lang="bash">➜  United Analysis du -s -h OriginalFrameworks
350M	OriginalFrameworks
➜  United Analysis du -s -h StrippedFrameworks
163M	StrippedFrameworks
</code></pre></div><p>Wow! I honestly wasn’t expecting that much of an improvement. We shaved <strong>187MB</strong> off the app size in five minutes by stripping framework symbols. I bet there are some additional low-hanging fruit but I’ll stop short here.</p>
<h2 id="learnings">Learnings</h2>
<p>While the United dev team should have noticed this much earlier – I originally started writing this in August 2021 but life happened – it is fair to say this area of app development is complicated to understand.</p>
<p>My biggest takeaway is that the developer tooling remains extremely poor for monitoring app sizes. The App Store should be sending all sorts of red flags to developers that have such easy fixes to make. It begs the question of whether Apple is even incentivized to make the tooling better. I’ll give a shoutout to <a href="https://www.emergetools.com/">Emerge Tools</a> as the only startup I’m aware of trying to tackle this problem.</p>
<p>Anyway, I hope you had fun reading this! And I really hope this gets fixed and saves people real bandwidth and stress on the runway!</p>

</article></div>
  </body>
</html>
