<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/chrispsn/mesh-spreadsheet">Original</a>
    <h1>Mesh Spreadsheet: A data and code editor that feels like a spreadsheet</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Mesh is a data and code editor that feels like a spreadsheet.</p>
<p dir="auto">This is Mesh v3. The formula language is <a href="https://codeberg.org/ngn/k" rel="nofollow">ngn/k</a>, and the backend logic is also written in ngn/k.</p>
<p dir="auto">This is a very early release, and it may not receive any updates. See <a href="#what-needs-work">What needs work</a>.</p>
<p dir="auto">Sheets eval on each recalc, and those evals are not sandboxed! Take care with what you write in the formula bar.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/chrispsn/mesh-spreadsheet/blob/main/demo.gif"><img src="https://github.com/chrispsn/mesh-spreadsheet/raw/main/demo.gif" alt="Mesh v3 demo" data-animated-image=""/></a></p>

<p dir="auto">Mesh is a spreadsheet program that fits into software&#39;s typical development and release workflows.</p>
<ul dir="auto">
<li>calculations are stored as text files</li>
<li>data can be of arbitrary length and defined structure (including empty data)</li>
<li>data can optionally be stored in external files (eg <code>data.json</code>), instead of being stored in the sheet</li>
<li>changes and releases can be managed via Git or other version control tools</li>
<li>calculations can be run &#39;headlessly&#39;, independently of the program used to write the code.</li>
</ul>
<p dir="auto">If you maintain <a href="https://xkcd.com/2347/" rel="nofollow">load-bearing</a> spreadsheets - files that are part of a processing pipeline - you might like Mesh.</p>


<ul dir="auto">
<li>Write data straight into cells. Mesh will try to figure out the datatype you meant.</li>
<li>Formulas start with a <code>=</code> prefix: <code>=1+B2</code>.</li>
<li>Press <code>F2</code> or click the formula bar to edit a formula instead of overwriting it. Precedents are highlighted in the grid.</li>
<li>Hardcode cells look different to formula cells.</li>
<li>Data type is indicated by alignment (strings on the left, numbers on the right, everything else in the center).</li>
<li>Format cell contents using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat" rel="nofollow">Intl.NumberFormat syntax</a>. For example, highlight a cell and press <code>Ctrl-Shift-4</code> to show values in dollars.</li>
<li>Cell names: toggle with <code>F3</code>. Change a cell&#39;s name by writing to its name cell. Mesh will update other cell formulas to use the new name.</li>
<li>Connect to external data: drag a file onto the grid. For now, the file needs to be stored in the same folder as <code>server.py</code>.</li>
<li>Quick calcs about the selected data (count, sum, average), shown above the code pane.</li>
<li>Calculated table columns - add modified assignments below the top-level definition:</li>
</ul>
<div data-snippet-clipboard-copy-content="table:+`existingColumn!1 2 3
table[`newColumn]:1+table`existingColumn"><pre><code>table:+`existingColumn!1 2 3
table[`newColumn]:1+table`existingColumn
</code></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Unusual spreadsheet things</h3><a id="user-content-unusual-spreadsheet-things" aria-label="Permalink: Unusual spreadsheet things" href="#unusual-spreadsheet-things"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>A completely different - but very powerful - formula language.</li>
<li>Sheets are stored as one or more text files, so that you can manage changes using Git. If you want to share it with someone, then manually zip the files into a folder.</li>
<li>Data can optionally be stored in external files, while still being displayed in and being editable from the UI of your sheet. Just click where you want the data to &#39;live&#39;, open the hamburger menu, and drag-and-drop it under &#39;read-and-write files&#39;. For now, the file needs to be stored in the same place as <code>server.py</code>.</li>
<li>Headless calculations. You don&#39;t need to run Mesh to run a Mesh sheet - just ngn/k.</li>
<li>Separate logic and presentation. If two data structures visually overlap, the calculations still work, because element cells don&#39;t get their own cell reference (they have to be referenced via their parent).</li>
<li>Export results to files by adding an <code>exportTo</code> path in the cell&#39;s meta dict.</li>
</ul>

<ul dir="auto">
<li>Excel formulas (<a href="https://en.wikipedia.org/wiki/OpenFormula" rel="nofollow">OpenFormula</a> compatibility).</li>
<li>Excel file import (<a href="https://en.wikipedia.org/wiki/OpenDocument" rel="nofollow">OpenDocument</a> &#39;zipped XML&#39; sheets).</li>
<li>Charting - instead, use an external program such as <a href="https://observablehq.com/framework/" rel="nofollow">Observable Framework</a> to re-render charts on file change.</li>
<li>Streaming data, or recalc when a file updates - instead, schedule or trigger data updates using cron or systemd timers.</li>
<li>Range references (<code>A1:B2</code>). Mesh doesn&#39;t use location-based references (which is why visual overlaps don&#39;t break calculations); however, values typed into an empty cell will be named based on their location.</li>
<li>Case-insensitive cell references.</li>
</ul>

<ol dir="auto">
<li>Clone this repo.</li>
<li><a href="https://codeberg.org/ngn/k" rel="nofollow">Get and build ngn/k</a>.</li>
<li>Make sure you have Python 3 and its <code>websockets</code> module installed. In Ubuntu, the latter is <code>sudo apt install python3-websockets</code>.</li>
<li>Update the values in <code>vars.py</code>.</li>
<li>Run <code>server.py</code> - this starts the backend.</li>
<li>Start a second server to serve <code>index.html</code>. Try <code>python3 -m http.server</code> in the Mesh directory.</li>
<li>Go to <code>localhost:8000</code> in your browser.</li>
</ol>
<p dir="auto">Alternatively, you can skip steps 2-5 and run the backend server via Docker. Clone this repo, then in the repo&#39;s directory:</p>
<div data-snippet-clipboard-copy-content="docker build -t mesh-spreadsheet .
docker run --publish 8765:8765 mesh-spreadsheet"><pre><code>docker build -t mesh-spreadsheet .
docker run --publish 8765:8765 mesh-spreadsheet
</code></pre></div>
<p dir="auto">You&#39;ll still need a way to access <code>index.html</code> per step 6 above, and so you&#39;ll need a copy of <code>index.html</code> available to serve (clone this repo again?). Maybe that can be done in a higher-level Docker Compose file.</p>

<p dir="auto">Mesh sheets are stored as ngn/k code in text files. The sheet is shown in your web browser, the client; it&#39;s connected via WebSockets to a backend server that does calculations and updates files on your disk.</p>
<p dir="auto">When you change a cell:</p>
<ul dir="auto">
<li>the client sends an instruction to the server</li>
<li>the server:
<ul dir="auto">
<li>turns the sheet text into an abstract syntax tree (or &#39;AST&#39;)</li>
<li>modifies the cell&#39;s node in the tree</li>
<li>turns the tree back into code text (using <a href="https://github.com/chrispsn/ngn-k-unparser">this ngn/k unparser</a>)</li>
<li>re-runs the code text</li>
<li>passes visual info back to the client.</li>
</ul>
</li>
</ul>
<p dir="auto">If the data you&#39;re editing is stored in a file that lives outside the sheet, the server will instead:</p>
<ul dir="auto">
<li>update the data structure in memory</li>
<li>serialise that data to text</li>
<li>write that text to disk</li>
<li>re-run the sheet calcs.</li>
</ul>
<p dir="auto">Version 3 of Mesh updates cell calculation order when the sheet is written, not when it&#39;s run.</p>

<p dir="auto">Mesh records information that&#39;s just for the Mesh app as a dictionary that appears just above the data&#39;s definition. The Mesh app can still see it in the parse tree and extract info from it, but because that name is immediately redefined by the next line, it doesn&#39;t affect the calculations.</p>
<p dir="auto">Here&#39;s a list that&#39;s named <code>amounts</code>, located at <code>G4</code>, and formatted in AUD:</p>
<div data-snippet-clipboard-copy-content="amounts:`number`loc!(`style`currency!(&#34;currency&#34;;&#34;AUD&#34;);`G4)
amounts:1 2 3"><pre><code>amounts:`number`loc!(`style`currency!(&#34;currency&#34;;&#34;AUD&#34;);`G4)
amounts:1 2 3
</code></pre></div>
<p dir="auto">Here&#39;s a read-write table connection to the file <code>analysis.json</code>:</p>
<div data-snippet-clipboard-copy-content="B2:`path!,&#34;analysis.json&#34;
B2:`j?1:&#34;analysis.json&#34;"><pre><code>B2:`path!,&#34;analysis.json&#34;
B2:`j?1:&#34;analysis.json&#34;
</code></pre></div>
<p dir="auto">Here&#39;s a calculation that&#39;s exported to the file <code>somePath.json</code>:</p>
<div data-snippet-clipboard-copy-content="B2:`exportTo!,&#34;somePath.json&#34;
B2:1 2 3 4"><pre><code>B2:`exportTo!,&#34;somePath.json&#34;
B2:1 2 3 4
</code></pre></div>


<ul dir="auto">
<li>Obvious quality of life features: error handling, scrolling, undo/redo.</li>
<li>Upstream issues in the unparser.</li>
<li>Storing external data in directories other than that of <code>server.py</code>.</li>
<li>A prettier code unparser and data serialiser, to make it easy to review changes via text comparison.</li>
<li>No limit on the number of cells (which probably means changing the backend/calc language).</li>
<li>Nicer data literals (which probably means changing the backend/calc language).</li>
<li>Nested sheets and name lookup.</li>
<li>Watching input files and automatically recalcing when they change.</li>
<li>Cut-and-paste data.</li>
<li>Pivot table wizard.</li>
<li>Database connectivity, though that might be less important if (de-)serialisation is fast.</li>
<li>Partial recalc from the point of change onwards, rather than recalculating the entire sheet on every change.</li>
<li>Allowing an external program to swap out cell values with new ones so that sheets can be used as functions (eg swapping from test input to production input).</li>
<li>Serialisation formats other than JSON and plain text. I&#39;d like CSV and maybe <a href="https://github.com/ndjson/ndjson-spec">NDJSON</a> or <a href="https://jsonlines.org/" rel="nofollow">JSONL</a>.</li>
<li>A syntax that has nice dict and table literals and lets you specify expected/conversion types for external files.</li>
<li>Sandboxing.</li>
<li>A UI for editing calculated columns, and per-column formatting rules.</li>
<li>Maybe a dialect that treats strings as atoms? Strings (char lists) are special-cased in Mesh to only take up one cell, so backend logic would be simpler if this was done.</li>
</ul>

<ul dir="auto">
<li>A fully-in-browser WASM version, to make Mesh easier to try out.</li>
<li>Electron (or similar?), so that Mesh can interact more with the filesystem without needing a server.</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto">Deep dive: editable dicts and tables</h3><a id="user-content-deep-dive-editable-dicts-and-tables" aria-label="Permalink: Deep dive: editable dicts and tables" href="#deep-dive-editable-dicts-and-tables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Sheets can store data in external files, or in the sheet source itself. This section talks about the latter.</p>
<p dir="auto">Mesh provides UI handles for editing list literals: inserting, deleting, or in-place edits of elements of simple lists such as <code>1 2 3</code> and general lists such as <code>(1;`sym)</code>. It can do this because the ngn/k AST has special representations of list literals, instead of just making them a function call. Mesh can just look at the first item in an AST list node to figure out what to do.</p>
<p dir="auto">But this approach isn&#39;t clean for dicts and tables, since the AST represents them as calls of functions that can do things other than make a data structure. For example, ngn/k uses <code>!</code> as make-dict and <code>+!</code> as make-table, but <code>!</code> has overloads such as &#39;mod&#39;. General lists are also represented in the AST as a function call, but that function is internal-only (<a href="https://ngn.codeberg.page/k/#eJxLKFDSMLRO0FQCAAw8AjI=" rel="nofollow"><code>5:</code></a>), and it doesn&#39;t have any overloads, so Mesh knows that its arguments should be treated as list literal elements.</p>
<p dir="auto">Conceivably Mesh could check the type and structure of the arguments to <code>!</code> (and generate a UI handle if the args are editable), but it makes the backend code complex. If Mesh did go down this route, it might be good to require editable tables to use a composition (<code>(+!)[`a;1 2]</code>) rather than a simple function call (<code>+![`a;1 2]</code>): that way, the make-table function would appear as an easy-to-recognise single-node composition (<code>(&#39;;+;!)</code>) instead of being split across nodes in the AST.</p>
<p dir="auto">Ideally, Mesh&#39;s formula language would:</p>
<ol dir="auto">
<li>include special dict and table literal representations (ngn/k doesn&#39;t), that</li>
<li>have unique AST representations.</li>
</ol>
<p dir="auto">Potentially those representations could <em>literally</em> be dict and table data structures. Then the backend could just edit them like we would in userland, and they&#39;d also be much easier for Mesh to losslessly unparse: if dict literals just appeared in the AST as <code>!</code> function calls, the unparser wouldn&#39;t know whether they intended a make-dict function call or a dict literal.</p>
<p dir="auto">Ideally dict literals would be a list of key:value pairs, and table literals would be defined row-wise to flow with the portrait shape of a text file - even if that data was stored as columns behind the scenes.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Why the k family? Why not Python or JavaScript?</h2><a id="user-content-why-the-k-family-why-not-python-or-javascript" aria-label="Permalink: Why the k family? Why not Python or JavaScript?" href="#why-the-k-family-why-not-python-or-javascript"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Officially, ngn/k is <a href="https://codeberg.org/ngn/k" rel="nofollow">no longer supported</a>. But Mesh could potentially be ported to other k dialects or other languages.</p>
<p dir="auto">To work with Mesh&#39;s approach to spreadsheets, the language needs certain features:</p>
<ol dir="auto">
<li>Its syntax should be simple and stable, so that it&#39;s (a) easy for Mesh to modify the AST and (b) fast to parse and unparse.</li>
<li>Formulas for simple data processing, such as sums and table joins, should be short.</li>
<li>It should have literals for lists, dicts, and tables. Those literals should have unique AST representations so that they are easy for Mesh to edit and can be losslessly round-tripped.</li>
</ol>
<p dir="auto">Bonus points if it has built-in serialisation formats (JSON, CSV) and is already on every machine or otherwise small enough to quickly download.</p>

<p dir="auto">Thanks to Arthur Whitney for inventing and refining k, to ngn for his implementation of k6, and to my family and friends for their support.</p>
</article></div></div>
  </body>
</html>
