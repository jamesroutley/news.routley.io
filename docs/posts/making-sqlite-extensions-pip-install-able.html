<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://observablehq.com/@asg017/making-sqlite-extensions-pip-install-able">Original</a>
    <h1>Making SQLite extensions pip install-able</h1>
    
    <div id="readability-page-1" class="page"><article><p><em>Brian Hicks, February 6, 2023</em></p><p>I sign all my git commits. “Why” is not super important here (but basically: I participate in some open source organizations for whom supply chain security is important.) Right now, I want to focus on nice ways to make the signatures.</p><p>To start with, <a href="https://docs.github.com/en/authentication/managing-commit-signature-verification/signing-commits">here are some GitHub docs</a> on signing commits with different kinds of keys. I currently use GPG keys, but they&#39;re kind of annoying to manage (at least for me.) A better option for me might be to sign my commits with SSH keys. But, what are the consequences of doing that?</p><p>I&#39;m gonna run some experiments to figure that out. To start with, I use two git forges: GitHub and <a href="https://gitea.io/en-us/">Gitea</a> (although I plan to migrate to <a href="https://forgejo.org/">Forgejo</a> once it&#39;s in a stable version of nixpkgs.) I want to make sure that I can get verified commits on both.</p><p>I&#39;m <em>most</em> interested in what happens when I revoke keys. Generally speaking, I generate one SSH key per machine I use for development. That way, no key ever has to leave the machine it was generated on. So what happens if I retire a machine, along with its key? Will all my commits turn into unsigned commits? GitHub&#39;s documentation implies that it might be fine, but I don&#39;t know.</p><h2 id="testing-stuff-out">Testing Stuff Out</h2><p>Well, then: let&#39;s try! I&#39;m gonna create a new repo and key:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> git init test-ssh-key-signing
</span><span>Initialized</span><span> empty Git repository in test-ssh-key-signing/.git/
</span><span>
</span><span>$</span><span> cd test-ssh-key-signing
</span><span>
</span><span>$</span><span> ssh-keygen</span><span> -t</span><span> ed25519</span><span> -f</span><span> test-key.ed25519
</span><span>Generating</span><span> public/private ed25519 key pair.
</span><span>Enter</span><span> passphrase (empty for no passphrase)</span><span>:
</span><span>Enter</span><span> same passphrase again:
</span><span>Your</span><span> identification has been saved in test-key.ed25519
</span><span>Your</span><span> public key has been saved in test-key.ed25519.pub
</span><span>The</span><span> key fingerprint is:
</span><span>SHA256:mevdSg3mn8+unpYYaB7+Sw2D6k4/VmViamKCEHHma0M</span><span> brianhicks@sequoia.local
</span><span>The</span><span> key</span><span>&#39;s randomart image is:
</span><span>+--[ED25519 256]--+
</span><span>|..o              |
</span><span>|.+               |
</span><span>| .E              |
</span><span>|.. .     +o o    |
</span><span>| .+.    S+=+     |
</span><span>| .... o.*+o*     |
</span><span>|     oo*.o+oo.   |
</span><span>|     o o=+.oo+   |
</span><span>|     .o.oo==B++  |
</span><span>+----[SHA256]-----+
</span></code></pre><p>First, I&#39;ll make a commit that&#39;s signed with my normal GPG key (which I have set globally):</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> git commit</span><span> --allow-empty -S -m </span><span>&#34;this commit has been signed with my regular GPG key&#34;
</span></code></pre><p>Then I&#39;ll reconfigure the repo to sign using the local key and make another commit:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> git config gpg.format ssh
</span><span>$</span><span> git config user.signingKey </span><span>&#34;$(</span><span>pwd</span><span>)/test-key.ed25519&#34;
</span><span>
</span><span>$</span><span> git commit</span><span> --allow-empty -S -m </span><span>&#34;this commit has been signed with the test SSH key&#34;
</span></code></pre><p>Now I can check the signatures on the commits. Unfortunately, it looks like <code>git</code> needs some additional configuration to verify the signature with the SSH key:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> git log</span><span> --show-signature
</span><span>error:</span><span> gpg.ssh.allowedSignersFile needs to be configured and exist for ssh signature verification
</span><span>commit</span><span> 60c4afaae4bb3a2013648a26a99b994e868ee4ae (HEAD -</span><span>&gt;</span><span> main)
</span><span>No</span><span> signature
</span><span>Author:</span><span> Brian Hicks </span><span>&lt;</span><span>brian@brianthicks.com</span><span>&gt;
</span><span>Date:</span><span>   Thu Jan 19 11:02:37 2023</span><span> -0600
</span><span>
</span><span>    </span><span>this</span><span> commit has been signed with the test SSH key
</span><span>
</span><span>commit</span><span> 04627098cc096584dac81c43ad70b40851880c18
</span><span>gpg:</span><span> Signature made Thu Jan 19 11:02:12 2023 CST
</span><span>gpg:</span><span>                using RSA key 66BAD9732604D23EF4A55B75C4F324B9CAAB0D50
</span><span>gpg:</span><span>                issuer </span><span>&#34;brian@brianthicks.com&#34;
</span><span>gpg:</span><span> Good signature from </span><span>&#34;Brian Hicks &lt;brian@brianthicks.com&gt;&#34; </span><span>[</span><span>ultimate</span><span>]
</span><span>Author:</span><span> Brian Hicks </span><span>&lt;</span><span>brian@brianthicks.com</span><span>&gt;
</span><span>Date:</span><span>   Thu Jan 19 11:02:12 2023</span><span> -0600
</span><span>
</span><span>    </span><span>this</span><span> commit has been signed with my regular GPG key
</span></code></pre><p>Very well, let&#39;s set an allowed signers file up. I found <a href="https://docs.gitlab.com/ee/user/project/repository/ssh_signed_commits/#verify-commits">some instructions on GitLab to set up the allowed signers file</a>:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> echo </span><span>&#34;$(</span><span>git</span><span> config</span><span> --get</span><span> user.email) namespaces=</span><span>\&#34;</span><span>git</span><span>\&#34; </span><span>$(</span><span>cat</span><span> test-key.ed25519.pub)&#34; </span><span>&gt;</span><span> allowed_signers
</span><span>$</span><span> git config gpg.ssh.allowedSignersFile </span><span>&#34;$(</span><span>pwd</span><span>)/allowed_signers&#34;
</span></code></pre><p>Now I can get both signatures verified:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> git log</span><span> --show-signature
</span><span>commit</span><span> 60c4afaae4bb3a2013648a26a99b994e868ee4ae (HEAD -</span><span>&gt;</span><span> main)
</span><span>Good </span><span>&#34;git&#34;</span><span> signature for brian@brianthicks.com with ED25519 key SHA256:mevdSg3mn8+unpYYaB7+Sw2D6k4/VmViamKCEHHma0M
</span><span>Author:</span><span> Brian Hicks </span><span>&lt;</span><span>brian@brianthicks.com</span><span>&gt;
</span><span>Date:</span><span>   Thu Jan 19 11:02:37 2023</span><span> -0600
</span><span>
</span><span>    </span><span>this</span><span> commit has been signed with the test SSH key
</span><span>
</span><span>commit</span><span> 04627098cc096584dac81c43ad70b40851880c18
</span><span>gpg:</span><span> Signature made Thu Jan 19 11:02:12 2023 CST
</span><span>gpg:</span><span>                using RSA key 66BAD9732604D23EF4A55B75C4F324B9CAAB0D50
</span><span>gpg:</span><span>                issuer </span><span>&#34;brian@brianthicks.com&#34;
</span><span>gpg:</span><span> Good signature from </span><span>&#34;Brian Hicks &lt;brian@brianthicks.com&gt;&#34; </span><span>[</span><span>ultimate</span><span>]
</span><span>Author:</span><span> Brian Hicks </span><span>&lt;</span><span>brian@brianthicks.com</span><span>&gt;
</span><span>Date:</span><span>   Thu Jan 19 11:02:12 2023</span><span> -0600
</span><span>
</span><span>    </span><span>this</span><span> commit has been signed with my regular GPG key
</span></code></pre><p>Cool. Now let&#39;s test how forges deal with rotating these keys.</p><h2 id="github">GitHub</h2><p>GitHub says that SSH key signing is less involved but lacks features, namely that an SSH signing key can&#39;t be revoked. Fair enough; there&#39;s no mechanism for that. They <em>don&#39;t</em> say what happens when you roll keys, though, so let&#39;s try it.</p><p>First, I&#39;ll push my test repo to GitHub:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> gh repo create</span><span> --private --source</span><span> .</span><span> --push
</span><span>✓</span><span> Created repository BrianHicks/test-ssh-key-signing on GitHub
</span><span>✓</span><span> Added remote https://github.com/BrianHicks/test-ssh-key-signing.git
</span><span>Enumerating</span><span> objects: 3, done.
</span><span>Counting</span><span> objects: 100% (3/3)</span><span>,</span><span> done.
</span><span>Delta</span><span> compression using up to 10 threads
</span><span>Compressing</span><span> objects: 100% (2/2)</span><span>,</span><span> done.
</span><span>Writing</span><span> objects: 100% (3/3)</span><span>,</span><span> 1.25 KiB </span><span>| </span><span>1.25</span><span> MiB/s, done.
</span><span>Total</span><span> 3 (delta 0)</span><span>,</span><span> reused 0 (delta 0)</span><span>,</span><span> pack-reused 0
</span><span>To</span><span> https://github.com/BrianHicks/test-ssh-key-signing.git
</span><span> </span><span>* </span><span>[</span><span>new branch</span><span>]</span><span>      HEAD -</span><span>&gt;</span><span> main
</span><span>branch </span><span>&#39;main&#39;</span><span> set up to track </span><span>&#39;origin/main&#39;</span><span>.
</span><span>✓</span><span> Pushed commits to https://github.com/BrianHicks/test-ssh-key-signing.git
</span></code></pre><p>I haven&#39;t uploaded the new key, but I have enabled <a href="https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits">vigilant mode</a>, so their web UI shows the commit as unverified:</p><p><img src="https://bytes.zone/images/unverified-commits-on-GitHub-in-the-test-ssh-key-signing-repo.png" alt="the GitHub UI, showing the commit history with one verified commit signed by GPG and one unverified commit signed by SSH"/></p><p>However, if I go to my settings and add the SSH key as a signing key, it shows as verified!</p><p><img src="https://bytes.zone/images/verified-commits-on-GitHub-in-the-test-ssh-key-signing-repo.png" alt="the GitHub UI, showing both commits verified"/></p><p>If I remove the signing key, the commit status goes back to unverified, which makes sense.</p><p>Since I uploaded this key as a signing key instead of an authentication key, it does not let me log in:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> ssh</span><span> -o </span><span>&#34;IdentitiesOnly=yes&#34;</span><span> -i</span><span> test-key.ed25519 git@github.com
</span><span>git@github.com:</span><span> Permission denied (publickey)</span><span>.
</span></code></pre><p>Good! I&#39;d be uncomfortable allowing authentication from machines with decommissioned keys, but I&#39;m at least OK-ish with saying “the commits that I made with this are still valid forever”, as long as I can be reasonably confident that the key material is completely destroyed, so no new commits can be made. If I wanted to say &#34;any commits with signatures after this date should not be considered verified&#34;, I could use a GPG key (but you can maybe still mess around with that, since you can change the date of a commit?)</p><p>Anyway, signing commits in this way seems like it satisfies my security requirements, so it might be possible. I still need to look at Gitea, though!</p><h2 id="gitea-forgejo">Gitea/Forgejo</h2><p>For Gitea/Forgejo, there&#39;s <a href="https://docs.gitea.io/en-us/signing/">some documentation by Gitea</a>. It only mentions GPG keys. I wonder if it&#39;d “just work” for SSH-based signing, though? Let&#39;s find out!</p><p>I don&#39;t have the CLI installed for Gitea, so I created a private repo in my account and pushed to it. Afterward, the commit shows up as unverified, as expected:</p><p><img src="https://bytes.zone/images/unverified-commits-on-gitea-in-the-test-ssh-key-signing-repo.png" alt="the Gitea UI, showing the commit history with one verified commit signed by GPG and one unverified commit signed by SSH"/></p><p>I added the key to my account as a regular authentication key, but that didn&#39;t change anything. However, I noticed a new “Verify” button in the web UI. Once I verified my SSH key (by signing a string with some instructions provided on the page) the commit showed up as verified:</p><p><img src="https://bytes.zone/images/verified-commits-on-gitea-in-the-test-ssh-key-signing-repo.png" alt="the Gitea UI, showing both commits verified"/></p><p>This creates a problem, though: it doesn&#39;t look like I can accept the key for signing but not authentication. For example, if I try to authenticate to my git host with the key it lets me:</p><pre data-lang="bash"><code data-lang="bash"><span>$</span><span> ssh</span><span> -o </span><span>&#34;IdentitiesOnly=yes&#34;</span><span> -i</span><span> test-key.ed25519 git@git.bytes.zone
</span><span>PTY</span><span> allocation request failed on channel 0
</span><span>Hi</span><span> there, brian! You</span><span>&#39;ve successfully authenticated with the key named brianhicks@..., but Gitea does not provide shell access.
</span><span>If this is unexpected, please log in with password and setup Gitea under another user.
</span><span>Connection to git.bytes.zone closed.
</span></code></pre><p>This is maybe worth asking either the Gitea or Forgejo development teams about. Of course, I could just be thinking incorrectly about the security model here: it could be the case that they don&#39;t want to allow this because you can&#39;t revoke SSH keys.</p><p>Either way, it seems like if I rotate my keys, I either have to allow authentication access to old keys forever, which I really don&#39;t want to do. Looks like I&#39;ll be sticking with my GPG key for signing commits for now!</p></article></div>
  </body>
</html>
