<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.cyberdemon.org/2023/03/17/lab-confusing-myself-with-data.html">Original</a>
    <h1>Lab Notes: Confusing myself with data</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>Yesterday, I started investigating what happens when you ask your system to write to disk. Today, I won’t have much time to work as we are unpacking over 400 sq ft of crap we brought from the States. But I wanted to run an experiment I thought of yesterday: write far more than 512 bytes, and see how much total data we write instantly, and 30s later. I want to see the ratio so that maybe we can identify how it scales.</p>

<ul>
  <li>512 bytes 512 instantly 20480 30s</li>
  <li>2048 bytes (current fs block size) 2048 instantly 20480 30s</li>
  <li>4096 bytes (the virtual disk sector size) 4096 instantly 20480 30s</li>
  <li>8192 bytes 8192 instantly 20480 30s</li>
  <li>16384 bytes 16384 instantly 20480 30s</li>
  <li>65536 bytes 65536 instantly 28672 30s</li>
  <li>131072 bytes 131072 instantly 12288 30s</li>
  <li>1024*1024 bytes (1 mebibyte) 1048576 instantly 20480 30s</li>
</ul>

<p>The 30s numbers get interesting at 65536 bytes. Let me rerun those to make sure the numbers are consistent between runs.</p>

<p>Interesting. This time around, the after-30s bytes written changed, but it was always either 20480 or 12288.</p>

<p>For sanity, let me try deleting <code>/data/foo</code> before each run. I’ll rerun the entire experiment.</p>

<div><div><pre><code><span>declare</span> <span>-a</span> <span>sizes</span><span>=(</span>
    512
    2048
    4096
    8192
    16384
    65536
    131072
    1048576
<span>)</span>

<span>for </span>size <span>in</span> <span>${</span><span>sizes</span><span>[@]</span><span>}</span><span>;</span> <span>do
    </span><span>echo</span> <span>&#34;### running experiment for </span><span>$size</span><span> ###&#34;</span>
    <span>rm</span> /data/foo
    python3 disk_stat_diff.py sda5 &amp;&gt; /dev/null
    <span>dd </span><span>if</span><span>=</span>/dev/zero <span>of</span><span>=</span>/data/foo <span>bs</span><span>=</span><span>$size</span> <span>count</span><span>=</span>1
    python3 disk_stat_diff.py sda5
    <span>sleep </span>30
    python3 disk_stat_diff.py sda5
<span>done</span>
</code></pre></div></div>

<p>Wow. Removing <code>/data/foo</code> first had a huge effect: the “instantly” bytes copied stat is now always 0. However, the after-30s stat is now really random, and for bytes above 65536, smaller than the number of bytes I’m asking it to write! I think this is because I’m not waiting long enough for the cache to be flushed (or something). I will now wait 60s.</p>

<p>All of these are after 60s. Instantly, it’s always 0.</p>
<ul>
  <li>512 38912</li>
  <li>2048 45056</li>
  <li>4096 47104</li>
  <li>8192 45056</li>
  <li>16384 59392</li>
  <li>65536 108544</li>
  <li>131072 174080</li>
  <li>1048576 1091584</li>
</ul>

<p>These are very different than before! Also note that from 4096 to 8192 it got smaller.</p>

<p>I want to try something else now. Now that I know that removing <code>/data/foo</code> first makes the instant number 0, I want to try the same with O_DIRECT, bypassing the filesystem cache, to see what the results will be.</p>

<ul>
  <li>512 2048 32768</li>
  <li>2048 2048 32768</li>
  <li>4096 4096 32768</li>
  <li>8192 8192 32768</li>
  <li>16384 16384 32768</li>
  <li>65536 65536 40960</li>
  <li>131072 131072 36864</li>
  <li>1048576 1048576 36864</li>
</ul>

<p>I am rerunning the 65536 test to see if it comes back with 40960 again. Ah, no, this time it’s 36864. So, unfortunately this test is not quite repeatable, but I think 36864 is the number that gives the clue about what’s going on.</p>

<p>I think 32768 might be the true block size of the SSD.</p>

<p>Oh, yesterday I was looking at what happens when we write 512 bytes with various settings. I want to try 2 more experiments: 1) don’t remove the file first, and wait 60s 2) remove the file first, and wait 30s.</p>

<ul>
  <li>Yesterday’s result with O_DIRECT that I want to compare to: when we write 512 bytes with oflag=direct, right after dd exits, we see we see 2048 bytes getting written, and 30 seconds later, a further 20480 bytes.</li>
  <li>When we write 512 bytes with oflag=direct and deleting <code>/data/foo</code> first, right after dd exits, we see we see 2048 bytes getting written, and 30 seconds later, a further 18432 bytes.</li>
  <li>When we write 512 bytes with oflag=direct but not deleting <code>/data/foo</code> first, right after dd exits, we see we see 2048 bytes getting written, and 60 seconds later, a further 20480 bytes. (This was the same as waiting 30 seconds).</li>
</ul>

<p>Note that 20480 - 18432 = 2048.</p>

<p>It’s clear that removing <code>/data/foo</code> first has some sort of effect.</p>

<p>Anyway, I didn’t have much time today, but I wanted to collect some numbers, mostly just to confuse myself, because I am definitely more more confused. That’s OK, though! We just filled our house with 80 boxes of shit we brought from the States. First, everything will be a mess. But hopefully we’ll come out better off. Same thing with my file writing adventure.</p>

<p>If you read this far, maybe you’ll want to hear from me again.</p>
<ul>
  <li>Sign up to an <a href="https://www.cyberdemon.org/feed.xml">RSS feed of my posts on this site</a>.</li>
  <li><a href="https://file-explorers.club/@dmitry">Follow me on Mastodon</a>.</li>
  <li>Sign up to <a href="https://docs.google.com/forms/d/e/1FAIpQLSePJIQBenOoP1GGe26exOhgPCKdqgY4j36D_WAvhTzudcioWA/viewform?usp=sf_link">get my posts via email</a>.</li>
</ul>

<p>If you’d like to discuss this post, please do reach out! My email is <a href="">dm@cyberdemon.org</a>.</p>

    
  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
