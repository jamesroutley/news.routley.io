<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/tcdi/plrust">Original</a>
    <h1>A Rust procedural language handler for PostgreSQL</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><a href="https://docs.rs/plrust-trusted-pgrx" rel="nofollow"><img src="https://camo.githubusercontent.com/030504c3c8009a02ddeee7e7449a667866b69a804ac032215e84819077876eee/68747470733a2f2f646f63732e72732f706c727573742d747275737465642d706772782f62616467652e737667" alt="docs.rs badge" data-canonical-src="https://docs.rs/plrust-trusted-pgrx/badge.svg"/></a></p>

<p dir="auto"><a href="https://tcdi.github.io/plrust/spi.html" rel="nofollow">PL/Rust</a> is a loadable procedural language that enables <a href="https://tcdi.github.io/plrust/use-plrust.html" rel="nofollow">writing PostgreSQL functions in the Rust programming language</a>. These functions are compiled to native machine code. Unlike other procedural languages, PL/Rust functions are not interpreted.</p>
<p dir="auto">The primary advantages of PL/Rust include writing natively-compiled functions to achieve the absolute best performance,
access to Rust&#39;s large development ecosystem, and Rust&#39;s compile-time safety guarantees.</p>
<p dir="auto">PL/Rust provides access to Postgres&#39; <a href="https://tcdi.github.io/plrust/spi.html" rel="nofollow">Server Programming Interface</a> (<a href="https://tcdi.github.io/plrust/spi.html" rel="nofollow">SPI</a>) including dynamic queries, prepared
statements, and cursors. It also provides safe Rust types over most of Postgres built-in <a href="https://tcdi.github.io/plrust/data-types.html" rel="nofollow">data types</a>, including (but
not limited to), <code>TEXT</code>, <code>INT</code>/<code>BIGINT</code>, <code>NUMERIC</code>, <code>FLOAT</code>/<code>DOUBLE PRECISION</code>, <code>JSON</code>/<code>JSONB</code>, arrays, and more. You can also use PL/Rust to write <a href="https://tcdi.github.io/plrust/triggers.html" rel="nofollow">trigger functions</a>.</p>
<p dir="auto">On x86_64 and aarch64 Linux systems PL/Rust can be a &#34;<a href="https://tcdi.github.io/plrust/trusted-untrusted.html" rel="nofollow">trusted</a>&#34; procedural language, assuming the proper compilation requirements are met. On other systems, it is perfectly usable as an &#34;<a href="https://tcdi.github.io/plrust/trusted-untrusted.html" rel="nofollow">untrusted</a>&#34; language but cannot provide the same level of safety guarantees.</p>

<p dir="auto">PL/Rust&#39;s <a href="https://tcdi.github.io/plrust" rel="nofollow">documentation</a> can be found at <a href="https://tcdi.github.io/plrust" rel="nofollow">https://tcdi.github.io/plrust</a>.  Also see the
<a href="https://docs.rs/plrust-trusted-pgrx/latest/plrust_trusted_pgrx/" rel="nofollow"><code>plrust-trusted-pgrx</code></a> Rust documentation.</p>

<p dir="auto">Head on over to the PL/Rust <a href="https://github.com/tcdi/plrust/releases">releases page</a> to get the latest release and check out <a href="https://tcdi.github.io/plrust/install-plrust-on-debian-ubuntu.html" rel="nofollow">the documentation page</a> to get started with PL/Rust.</p>

<p dir="auto">The PL/Rust team at <a href="https://www.tcdi.com/" rel="nofollow">TCDI</a> manages a Discord server where we discuss PL/Rust and related technologies
such as <a href="https://github.com/tcdi/pgrx"><code>pgrx</code></a>, Rust, and Postgres.  Feel free to join:  <a href="https://discord.gg/mHKrj55zyh" rel="nofollow">https://discord.gg/mHKrj55zyh</a></p>

<p dir="auto">An example PL/Rust function:</p>
<div dir="auto" data-snippet-clipboard-copy-content="psql&gt; CREATE FUNCTION add_two_numbers(a NUMERIC, b NUMERIC) RETURNS NUMERIC STRICT LANGUAGE plrust AS $$
    Ok(Some(a + b))
$$;

psql&gt; SELECT add_two_numbers(2, 2);
add_two_numbers 
-----------------
               4"><pre>psql<span>&gt;</span> CREATE FUNCTION add_two_numbers(a <span>NUMERIC</span>, b <span>NUMERIC</span>) RETURNS <span>NUMERIC</span> STRICT LANGUAGE plrust <span>AS</span> $$
    Ok(Some(a <span>+</span> b))
$$;

psql<span>&gt;</span> <span>SELECT</span> add_two_numbers(<span>2</span>, <span>2</span>);
add_two_numbers 
<span><span>--</span>---------------</span>
               <span>4</span></pre></div>
<p dir="auto">PL/Rust itself is a <a href="https://github.com/tcdi/pgrx"><code>pgrx</code></a>-based Postgres extension.  Furthermore, each <code>LANGUAGE plrust</code> function are themselves mini-pgrx extensions. <code>pgrx</code>is a generalized framework for developing Postgres extensions
with Rust.  Like this project, <code>pgrx</code> is developed by <a href="https://www.tcdi.com" rel="nofollow">TCDI</a>.</p>
<p dir="auto">The following sections discuss PL/Rusts safety guarantees, configuration settings, and installation instructions.</p>

<p dir="auto">Installing PL/Rust and especially <code>postgrestd</code> requires a normal installation of Rust via
<a href="https://rustup.rs" rel="nofollow"><code>rustup</code></a> and for the relevant locations to be writeable on the building host.
See the <a href="https://tcdi.github.io/plrust/install-plrust.html" rel="nofollow">Install PL/Rust</a>
section of the documentation for notes on installing PL/Rust and its dependencies.</p>
<p dir="auto">Debian packages are also available -- see <a href="https://tcdi.github.io/plrust/install-plrust-on-debian-ubuntu.html" rel="nofollow">the documentation page</a> for installation instructions.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Cross Compilation Support</h2><a id="user-content-cross-compilation-support" aria-label="Permalink: Cross Compilation Support" href="#cross-compilation-support"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See the
<a href="https://tcdi.github.io/plrust/install-cross-compile.html" rel="nofollow">Cross compliation</a>
section of the documentation for cross-compilation details.</p>

<p dir="auto">See the <a href="https://tcdi.github.io/plrust/config-pg.html" rel="nofollow">PostgreSQL Configuration</a>
section of the documentation for notes on configuring PL/Rust in
<code>postgresql.conf</code>.</p>
<hr/>

<p dir="auto">See the <a href="https://tcdi.github.io/plrust/config-lints.html" rel="nofollow">Lints section</a>
of the documentation.</p>

<p dir="auto">See the <a href="https://tcdi.github.io/plrust/config-env-var.html" rel="nofollow">Environment variables section</a>
of the documentation.</p>

<p dir="auto">To quickly evaluate PL/Rust from this repository...</p>
<p dir="auto">First, install and initialize the required build environment tools:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ cargo install cargo-pgrx --locked
$ cargo pgrx init"><pre>$ cargo install cargo-pgrx --locked
$ cargo pgrx init</pre></div>
<p dir="auto">Then clone this repository and build/run PL/Rust once to complete the <code>cargo-pgrx</code> environment initialization:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ git clone https://github.com/tcdi/plrust.git
$ cd plrust

# build plrustc, our custom rustc driver and copy it to ~/.cargo/bin
$ cd plrustc &amp;&amp; ./build.sh    
$ cp ../build/bin/plrustc ~/.cargo/bin

# build and run plrust itself
$ cd ../plrust/plrust
$ cargo pgrx run pg14 --release

# which drops you into a psql shell.  just \quit it for now
psql&gt; \q"><pre>$ git clone https://github.com/tcdi/plrust.git
$ <span>cd</span> plrust

<span><span>#</span> build plrustc, our custom rustc driver and copy it to ~/.cargo/bin</span>
$ <span>cd</span> plrustc <span>&amp;&amp;</span> ./build.sh    
$ cp ../build/bin/plrustc <span>~</span>/.cargo/bin

<span><span>#</span> build and run plrust itself</span>
$ <span>cd</span> ../plrust/plrust
$ cargo pgrx run pg14 --release

<span><span>#</span> which drops you into a psql shell.  just \quit it for now</span>
psql<span>&gt;</span> <span>\q</span></pre></div>
<p dir="auto">Apply the required <code>postgresql.conf</code> configuration:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ SCRATCH_DIR=${HOME}/plrust-scratch
$ mkdir -p ${SCRATCH_DIR}
$ cat &lt;&lt;-EOF &gt;&gt; ~/.pgrx/data-14/postgresql.conf
shared_preload_libraries = &#39;plrust&#39;
plrust.work_dir = &#39;${SCRATCH_DIR}&#39;
EOF"><pre>$ SCRATCH_DIR=<span>${HOME}</span>/plrust-scratch
$ mkdir -p <span>${SCRATCH_DIR}</span>
$ cat <span><span>&lt;&lt;</span>-<span>EOF</span> &gt;&gt; ~/.pgrx/data-14/postgresql.conf</span>
<span>shared_preload_libraries = &#39;plrust&#39;</span>
<span>plrust.work_dir = &#39;<span>${SCRATCH_DIR}</span>&#39;</span>
<span><span>EOF</span></span></pre></div>
<p dir="auto">Finally, run it for real and start writing functions!</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ cargo pgrx run pg14
psql&gt; CREATE EXTENSION plrust;
psql&gt; CREATE FUNCTION add_two_numbers(a NUMERIC, b NUMERIC) RETURNS NUMERIC STRICT LANGUAGE plrust AS $$
    Ok(Some(a + b))
$$;

psql&gt; SELECT add_two_numbers(2, 2);
add_two_numbers 
-----------------
               4"><pre>$ cargo pgrx run pg14
psql<span>&gt;</span> CREATE EXTENSION plrust<span>;</span>
psql<span>&gt;</span> CREATE FUNCTION add_two_numbers(a NUMERIC, b NUMERIC) RETURNS NUMERIC STRICT LANGUAGE plrust AS <span>$$</span>
    Ok(Some(a + b))
<span>$$</span><span>;</span>

psql<span>&gt;</span> SELECT add_two_numbers(2, 2)<span>;</span>
add_two_numbers 
-----------------
               4</pre></div>

<p dir="auto">In the Postgres world it seems common for procedural languages to have two styles, &#34;trusted&#34; and &#34;untrusted&#34;.  The consensus is to name those as &#34;lang&#34; and &#34;langu&#34;, respectively -- where the &#34;u&#34; is supposed to represent &#34;untrusted&#34; (see &#34;plperl&#34; v/s &#34;plperlu&#34; for example).</p>
<p dir="auto">PL/Rust does not do this.  The only thing that Postgres uses to determine if a language handler is considered &#34;trusted&#34; is if it was created using <code>CREATE TRUSTED LANGUAGE</code>.  It does not inspect the name.</p>
<p dir="auto">PL/Rust stores user functions in <code>pg_catalog.pg_proc</code>&#39;s <code>prosrc</code> field as a complex json structure where the compiled
function is a compressed, base64 encoded string, with the key-value pairs mapping each target tuple to compiled object code.</p>
<p dir="auto">As such, compiling a function with an &#34;untrusted&#34; version of PL/Rust, then installing the &#34;trusted&#34; version and trying to run that function will fail -- &#34;trusted&#34; and &#34;untrusted&#34; are considered different compilation targets and are not compatible with each other, even if the underlying hardware is exactly the same.</p>
<p dir="auto">This does mean that it is not possible to install both &#34;trusted&#34; and &#34;untrusted&#34; versions of PL/Rust on the same Postgres database cluster.</p>
<p dir="auto">In the future, as <code>postgrestd</code> is ported to more platforms, we will seriously consider having both <code>plrust</code> and <code>plrustu</code>.  Right now, since &#34;trusted&#34; is only possible on Linux <code>x86_64</code>/<code>aarch64</code>, our objective is to drive production installations to be &#34;trusted&#34;, while allowing non-Linux developers the ability to use <code>LANGUAGE plrust</code> too.</p>

<p dir="auto">Please read the <a href="https://github.com/tcdi/plrust/blob/main/SECURITY.md">Security</a> for directions on reporting a potential security issue.</p>

<p dir="auto">PL/Rust is licensed under &#34;The PostgreSQL License&#34;, which can be found <a href="https://github.com/tcdi/plrust/blob/main/LICENSE.md">here</a>.</p>
</article></div></div>
  </body>
</html>
