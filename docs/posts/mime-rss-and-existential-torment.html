<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xeiaso.net/blog/2024/fixing-rss-mailcap/">Original</a>
    <h1>MIME, RSS, and Existential Torment</h1>
    
    <div id="readability-page-1" class="page"><div>
            <article>
    
    <p>
        Published on <time datetime="2024-06-23">06/23/2024</time>, 1362 words, 5 minutes to read
    </p>

    
        <p>TL;DR: how I fixed my RSS feed by installing mailcap so I don&#39;t get tormented by mimes</p>
    

    
        
            
    

    

        
    

    
        <figure><picture><source type="image/avif" srcset="https://cdn.xeiaso.net/file/christine-static/hero/spring-peace.avif"/><source type="image/webp" srcset="https://cdn.xeiaso.net/file/christine-static/hero/spring-peace.webp"/><img alt="An image of Greenery next to a retaining pond, with a path and a trashcan. The sky is reflecting off of the water." loading="lazy" src="https://cdn.xeiaso.net/file/christine-static/hero/spring-peace.jpg"/></picture></figure>
        <small>Greenery next to a retaining pond, with a path and a trashcan. The sky is reflecting off of the water. - Photo by Xe Iaso, Canon EOS R6 mark ii, Helios 44-2 58mm at f/8</small>
    

    <p>This morning, I woke up with a flurry of emails in my inbox. When people tried to read my blog&#39;s RSS feed, they got an error like this:</p>
<pre><code><span>$ curl https://xeiaso.net
</span><span>seeker can&#39;t seek
</span></code></pre>
<p>This should not happen. When I first encountered this, I had to do a double-take. When I remade my website for <a href="https://ryleealanza.org/blog/xesite-v4/">version 4</a> I did make some weird technical decisions and I figured one of those was coming back to bite me. One of the weirdest things my website does is that it serves everything from a .zip file. As far as I understand my blog, here&#39;s what I expect to happen when somebody requests a file:</p>
<p><img src="https://ryleealanza.org/static/blog/fixing-rss-mailcap/how-it-should-work.excalidraw.svg" alt=""/></p>
<p>When someone fetches a file I expect it to interact with the lume FileSystem component, pass it to the zip file, get a file back, and then serve it back to the user with happy puppies and HTTP 200 responses. This was not happening, and the error that I got was initially very confusing.</p>
<p>The actual reason why this was happening trolled me so hard that I felt the need to write about it so that y&#39;all are able to understand all of the moving parts and why it failed in this way in particular.</p>
<h2>Go interfaces</h2>
<p>In Go, interfaces are used to describe abstract behaviors that apply between types. As an absurd example, let&#39;s imagine something that has the behavior of quacking. In Go you&#39;d probably write an interface like this to represent this behavior:</p>
<pre><code><span><span>type</span> Quacker <span>interface</span> <span>{</span>
</span><span>    <span>Quack</span><span>(</span><span>)</span>
</span><span><span>}</span>
</span></code></pre>
<p>So, for some type <code>Duck</code>, you could make it quack like this:</p>
<pre><code><span><span>type</span> Duck <span>struct</span><span>{</span><span>}</span>
</span><span>
</span><span><span>func</span> <span>(</span>Duck<span>)</span> <span>Quack</span><span>(</span><span>)</span> <span>{</span> fmt<span>.</span><span>Println</span><span>(</span><span>&#34;Quack!&#34;</span><span>)</span> <span>}</span>
</span></code></pre>
<p>And then you can pass a <code>Duck</code> value anywhere that takes a <code>Quacker</code>, even if the underlying implementation is something absurd:</p>
<pre><code><span><span>type</span> Sheep <span>struct</span><span>{</span><span>}</span>
</span><span>
</span><span><span>func</span> <span>(</span>Sheep<span>)</span> <span>Quack</span><span>(</span><span>)</span> <span>{</span> fmt<span>.</span><span>Println</span><span>(</span><span>&#34;Baaaaa&#34;</span><span>)</span> <span>}</span>
</span></code></pre>
<p>Interfaces are used all over the standard library and they make a lot of things really damn convenient in practice. Want to override how a HTTP request works? Define your own <a href="https://pkg.go.dev/net/http#RoundTripper"><code>net/http#RoundTripper</code></a>. When you define HTTP handlers, you&#39;re dealing with the <a href="https://pkg.go.dev/net/http#Handler"><code>net/http#Handler</code></a> interface. Interfaces are everywhere and they are lovely.</p>
<p>One of the more recent and exciting interfaces is <a href="https://pkg.go.dev/io/fs#FS"><code>io/fs.FS</code></a>, which represents an abstract &#34;filesystem&#34;. This allows you to make filesystem logic pluggable so that you can <a href="https://pkg.go.dev/embed#hdr-File_Systems">embed filesystems into your code</a>, or read stuff out of anything that implements the <code>io/fs#FS</code> interface. One of these things is a .zip file reader, AKA <a href="https://pkg.go.dev/archive/zip#Reader"><code>archive/zip#Reader</code></a>.</p>
<p>This is the core of how my website works. Every time you read anything from my site, you&#39;re actually looking at the contents of a zipfile full of gzip streams.</p>
<p>So anyways, you go to the RSS feed and then you get a HTTP 500 back. The flow looks like this:</p>
<p><img src="https://ryleealanza.org/static/blog/fixing-rss-mailcap/how-it-broke.excalidraw.svg" alt=""/></p>
<p>The Go HTTP package <a href="https://pkg.go.dev/net/http#FileSystem">has had its own filesystem logic</a> for a while, since Go 1.0. Here&#39;s its view of what a <code>File</code> should be:</p>
<pre><code><span>
</span><span><span>package</span> http
</span><span>
</span><span><span>import</span> <span>&#34;io/fs&#34;</span>
</span><span>
</span><span><span>type</span> File <span>interface</span> <span>{</span>
</span><span>	io<span>.</span>Closer
</span><span>	io<span>.</span>Reader
</span><span>	io<span>.</span>Seeker
</span><span>	<span>Readdir</span><span>(</span>count <span>int</span><span>)</span> <span>(</span><span>[</span><span>]</span>fs<span>.</span>FileInfo<span>,</span> <span>error</span><span>)</span>
</span><span>	<span>Stat</span><span>(</span><span>)</span> <span>(</span>fs<span>.</span>FileInfo<span>,</span> <span>error</span><span>)</span>
</span><span><span>}</span>
</span></code></pre>
<p>Here&#39;s what <code>io/fs</code> thinks a file should be:</p>
<pre><code><span><span>package</span> fs
</span><span>
</span><span><span>type</span> File <span>interface</span> <span>{</span>
</span><span>	<span>Stat</span><span>(</span><span>)</span> <span>(</span>FileInfo<span>,</span> <span>error</span><span>)</span>
</span><span>	<span>Read</span><span>(</span><span>[</span><span>]</span><span>byte</span><span>)</span> <span>(</span><span>int</span><span>,</span> <span>error</span><span>)</span>
</span><span>	<span>Close</span><span>(</span><span>)</span> <span>error</span>
</span><span><span>}</span>
</span></code></pre>
<p>A <code>net/http#File</code> is a <em>more specific</em> interface than a <code>io/fs#File</code>, which means that not all things that can be represented as an <code>io/fs#File</code> can work as a <code>net/http#File</code>.</p>
<div><p><img alt="Mara is hacker" loading="lazy" src="https://cdn.xeiaso.net/sticker/mara/hacker/128"/></p><div><p>&lt;<a href="https://ryleealanza.org/characters#mara"><b>Mara</b></a>&gt; </p><p>In Go, you generally call interfaces with more methods &#34;more specific&#34; than ones that have less methods. When you are making interfaces in Go, it&#39;s generally seen that a smaller interface is better than a bigger one because those are more easy to compose. A file can be read from, but so can a network socket or a HTTP response body. If you make your interfaces vague, then they can apply many other places.</p><p>Consider this <a href="https://go-proverbs.github.io/">Go proverb</a>:</p><div><p>&gt; </p><p>The bigger the interface, the weaker the abstraction.</p></div></div></div>
<p>This all matters because when the standard library HTTP fileserver tries to serve a file, it has to figure out the <code>Content-Type</code> of that file. The code is <a href="https://github.com/golang/go/blob/2073b35e07ce9cea47ee1fbe763b304d2371954f/src/net/http/fs.go#L242-L254">in a function imaginatively named <code>serveContent</code></a>, but the overall flow looks kinda like this:</p>
<p><img src="https://ryleealanza.org/static/blog/fixing-rss-mailcap/serveContent-flow.excalidraw.svg" alt=""/></p>
<p>Whenever you try to serve a file that doesn&#39;t already have a <code>Content-Type</code> header defined, it tries to detect it from the extension. If it can&#39;t, it&#39;ll try to read the first 512 bytes of the file to detect what kind of file it is, and then rewind the file back so that it can be served to the user.</p>
<p>Unless that file doesn&#39;t have a working <code>.Seek</code> method.</p>
<p>As it turns out, when you read <code>io/fs#File</code>s from a zipfile, they don&#39;t have a <code>.Seek</code> method defined. This makes sense because any file in a zipfile exists in a superposition of both being compressed and not being compressed that only gets resolved when the file is read from. It doesn&#39;t make sense to be able to rewind a compressed stream and then get back data from earlier in it. You&#39;d have to put everything in memory and then you could run out of memory and crash.</p>
<p>The reason we got this <code>seeker can&#39;t seek</code> error is because they added a &#34;type shim&#34; to allow an <code>io/fs#File</code> to act as a <code>net/http#File</code>. Here&#39;s the codepath I hit:</p>
<pre><code><span><span>var</span> errMissingSeek <span>=</span> errors<span>.</span><span>New</span><span>(</span><span>&#34;seeker can&#39;t seek&#34;</span><span>)</span>
</span><span>
</span><span><span>func</span> <span>(</span>f ioFile<span>)</span> <span>Seek</span><span>(</span>offset <span>int64</span><span>,</span> whence <span>int</span><span>)</span> <span>(</span><span>int64</span><span>,</span> <span>error</span><span>)</span> <span>{</span>
</span><span>	s<span>,</span> ok <span>:=</span> f<span>.</span>file<span>.</span><span>(</span>io<span>.</span>Seeker<span>)</span>
</span><span>	<span>if</span> <span>!</span>ok <span>{</span>
</span><span>		<span>return</span> <span>0</span><span>,</span> errMissingSeek
</span><span>	<span>}</span>
</span><span>	<span>return</span> s<span>.</span><span>Seek</span><span>(</span>offset<span>,</span> whence<span>)</span>
</span><span><span>}</span>
</span></code></pre>
<p>A zipfile&#39;s <code>io/fs#File</code> isn&#39;t an <a href="https://pkg.go.dev/io#Seeker"><code>io.Seeker</code></a>. This means that any time the <code>net/http#FileSystem</code> logic tried to seek, it instantly got that <code>seeker can&#39;t seek</code> error and blew up.</p>
<h2>Getting trolled by MIMEs</h2>
<p>However, we don&#39;t have to fix this problem today. We can work around it with the power of the MIME registry.</p>
<div><p><img alt="Aoi is wut" loading="lazy" src="https://cdn.xeiaso.net/sticker/aoi/wut/128"/></p><div><p>&lt;<a href="https://ryleealanza.org/characters#aoi"><b>Aoi</b></a>&gt; </p><p>I don&#39;t get it, if this is broken now, then how did it ever work in the first
place?</p></div></div>
<p>That first step of the diagram is the relevant bit. If the file extension is in the MIME registry, then it&#39;ll be returned to the user:</p>
<p><img src="https://ryleealanza.org/static/blog/fixing-rss-mailcap/mime-registry.excalidraw.svg" alt=""/></p>
<p>Go has a <a href="https://github.com/golang/go/blob/2073b35e07ce9cea47ee1fbe763b304d2371954f/src/mime/type.go#L60-L77">minimal subset</a> of very very commonly used MIME types so that things will Just Work™️, but when the program starts, it tries to read all of the other common MIME-extension pairs out of <code>/etc/mime.types</code> (and a few other places).</p>
<p>Guess what file wasn&#39;t present in the Docker image I made with Earthly?</p>
<p>In Alpine Linux, this file is <a href="https://pkgs.alpinelinux.org/contents?file=mime.types&amp;path=&amp;name=&amp;branch=edge&amp;repo=main&amp;arch=ppc64le">in the <code>mailcap</code> package</a>. Fixing this was as easy as changing a single line in my Earthly configuration:</p>
<pre><code><span><span><span>-</span><span>    RUN apk add -U ca-certificates deno typst
</span></span></span><span><span><span></span></span><span><span>+</span><span>    RUN apk add -U ca-certificates deno typst mailcap
</span></span></span></code></pre>
<div><p><img alt="Cadey is coffee" loading="lazy" src="https://cdn.xeiaso.net/sticker/cadey/coffee/128"/></p><div><p>&lt;<a href="https://ryleealanza.org/characters#cadey"><b>Cadey</b></a>&gt; </p><p>God, I feel like a buffoon. How the hell am I employable???</p></div></div>
<div><p><img alt="Numa is happy" loading="lazy" src="https://cdn.xeiaso.net/sticker/numa/happy/128"/></p><div><p>&lt;<a href="https://ryleealanza.org/characters#numa"><b>Numa</b></a>&gt; </p><p>Don&#39;t worry, this is why we get paid the big bucks. The more you fuck around
like this, the weirder it is when you find out why.</p></div></div>
<h2>Conclusion</h2>
<p>This is why the RSS feed was broken. It was broken because I got trolled by a bunch of MIMEs. No (mail)cap, fr fr.</p>
<div><p><img alt="Aoi is coffee" loading="lazy" src="https://cdn.xeiaso.net/sticker/aoi/coffee/128"/></p></div>
<p>If you want to watch me suffer through explaining things like this, <a href="https://twitch.tv/princessxen">follow me on Twitch</a>. We&#39;ll all learn together.</p>

    <hr/>

    

    

    <p>Facts and circumstances may have changed since publication. Please contact me before jumping to conclusions if something seems wrong or unclear.</p>

    <p>Tags: </p>
</article>
        </div><div>
            <p>Copyright 2012-2024 Xe Iaso (Christine Dodrill). Any and all opinions listed here are my own and
                not representative of any of my employers, past, future, and/or present.</p>
            
            <p>Served by xesite v4 (/app/xesite) with site version 
                        <a href="https://github.com/Xe/site/commit/b8f0cd5c12f97af41444723d6fead11a1fef9f0d">b8f0cd5c</a>
                    , source code available <a href="https://github.com/Xe/site">here</a>.</p>
        </div></div>
  </body>
</html>
