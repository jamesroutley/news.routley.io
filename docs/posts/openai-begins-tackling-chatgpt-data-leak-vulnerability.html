<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://embracethered.com/blog/posts/2023/openai-data-exfiltration-first-mitigations-implemented/">Original</a>
    <h1>OpenAI Begins Tackling ChatGPT Data Leak Vulnerability</h1>
    
    <div id="readability-page-1" class="page"><section>
    <p>OpenAI seems to have implemented some mitigation steps for a well-known data exfiltration vulnerability in ChatGPT. Attackers can use image markdown rendering during prompt injection attacks to send data to third party servers without the users&#39; consent.</p>
<p>The fix is not perfect, but a step into the right direction. In this post I share what I figured out so far about the fix after looking at it briefly this morning.</p>
<h2 id="background">Background</h2>
<p>Yesterday I was doing a live demo of the <a href="https://embracethered.com/blog/posts/2023/openai-custom-malware-gpt/">data theft GPT</a> with a consenting victim. ChatGPT was still vulnerable to data exfiltration via image markdown injection and my server received the conversation details:</p>
<p><a href="https://embracethered.com/blog/images/2023/openai-last.png"><img src="https://embracethered.com/blog/images/2023/openai-last.png" alt="OpenAI Raeuber"/></a></p>
<p>Needless to say, and as you can read in the screenshot above (sorry it‚Äôs in German), the victim user was not too amused about this.</p>
<p>The data exfiltration vulnerability was first reported to OpenAI early April 2023, but remained unaddressed.</p>
<p>Starting today it appears that some mitigations have been implemented. üéâüéâüéâ</p>
<h2 id="the-mitigation">The Mitigation</h2>
<p>The mitigation is different from fixes of other vendors, and currently only applies to the web app.</p>
<p>When the server returns an image tag with a hyperlink there is now a ChatGPT <strong>client side call to a validation API</strong> before deciding to display an image.</p>
<p>The call is to an endpoit called <code>url_safe</code>:</p>
<pre tabindex="0"><code>https://chat.openai.com/backend-api/conversation/[id]/url_safe
</code></pre><p>where it appends the target URL as query parameter</p>
<pre tabindex="0"><code>?url=https://wuzzi.net/r?thief=johannr@example.org
</code></pre><p>and in this case it returns:</p>
<pre tabindex="0"><code>{&#34;safe&#34;:false}
</code></pre><p><code>safe=false</code> means that it will not render the image and perform the request to the attackers server!</p>
<p><a href="https://embracethered.com/blog/images/2023/openai-fix-3.png"><img src="https://embracethered.com/blog/images/2023/openai-fix-3.png" alt="OpenAI Mitigation"/></a></p>
<p>It still at times renders <strong>other</strong> images (from arbitrary domains) though.</p>
<p>Since ChatGPT is not open source and the fix is not via a Content-Security-Policy (that is visible and inspectable by users and researchers) the exact validation details are not known.</p>
<p>There is some internal decision making happening when an image is considered safe and when not, maybe ChatGPT queries the Bing index to see if an image is valid and pre-existing or have other tracking capabilities and/or other checks.</p>
<p>Having a central validation API hopefully also means that Enterprises customers will be able configure this setting to further increase the security posture of ChatGPT for their environments.</p>
<h2 id="not-a-perfect-fix---remaining-concerns">Not a Perfect Fix - Remaining Concerns</h2>
<p>As stated, it‚Äôs not a perfect fix.</p>
<h3 id="still-allows-leaks">Still Allows Leaks</h3>
<p>It is still renders requests to arbitrary domains at times, and hence can be used to send data out. Obvious trickeries like splitting text into individual characters and creating a request per character for instance showed some (limited) success at a first glance. It only leaks small amounts this way, is slow and more noticable to a user and also to OpenAI if logs of the <code>url_safe</code> API are reviewed and monitored.</p>
<p>To give an example out of 36 characters (a-z 0-9) I got nine of them rendered via unique URLs. So for instance this URLs exfiltrates (and also renders) the letter <code>a</code> and passed the check: <code>/url_safe?url=https://wuzzi.net/img/a.png</code></p>
<p>Here is a demo showing leaking of individual characters (from experience we know that attacks usually get better over time):</p>
<p><a href="https://embracethered.com/blog/images/2023/openai-fix-bypass-char-by-char.png"><img src="https://embracethered.com/blog/images/2023/openai-fix-bypass-char-by-char.png" alt="OpenAI Bypass Char by Char"/></a></p>
<p>Above exfiltrates the text ‚Äúhi‚Äù to the third party server by sending each letter as a separate request.</p>
<p>So, the current mitigation is a step in the right direction, more might be needed.</p>
<p><strong>I would suggest to OpenAI to limit the number of images that are rendered per response to just one or maybe a handful maximum, as that will further mitigate some of these bypass trickeries.</strong></p>
<p>Its unclear why:</p>
<ul>
<li><code>https://wuzzi.net/img/a.png</code> is a safe URL and is rendered but</li>
<li><code>https://wuzzi.net/img/d.png</code> is not a safe URL?</li>
</ul>
<p>Sharing the details of the validation check would also improve confidence in the mitigation, after all I hope it is not an LLM alone that checks if the URL is safe. :)</p>
<h3 id="client-side-validation-call---mobile-apps-remain-vulnerable">Client Side Validation Call - Mobile apps remain vulnerable</h3>
<p>The current iOS version <code>1.2023.347 (16603)</code> does not have these improvements (yet?). Since the ChatGPT web application change is a <em>client side validation</em> call to a server API, the fix will have to be implemented separately for each client‚Ä¶</p>
<p>The decision to implement it client side might have to do with wanting to stream the results to the client for performance reasons. However, it might be better to perform such security checks on the server side, so all clients benefit from such improvements.</p>
<h2 id="conclusion">Conclusion</h2>
<p>To summarize what I observed so far:</p>
<ul>
<li>
<p>There is a client side validation check for safe URLs which improves the security posture and should allow OpenAI to monitor for attacks and notice patterns, which is good</p>
</li>
<li>
<p>The decision details on when a URL is considered safe are not known</p>
</li>
<li>
<p>It‚Äôs not a 100% perfect mitigation to prevent sending information to third party servers. Some quick tests show that bits of info can steal leak (in the end we don‚Äôt know if its indeed an attempt for a fix), but it seems like a step in the right direction for sure</p>
</li>
<li>
<p>iOS (and probably Android) remain vulnerable to the original attacks</p>
</li>
</ul>
<p>As you can imagine I‚Äôm quite happy about this improvement (even though it‚Äôs not perfect).</p>
<p>After the lengthy discussions I had with OpenAI in April and the many more demos I created to raise awareness. With each new feature release risks increased (Plugins, Browsing, Code Interpreter, GPTs, GPT Store,‚Ä¶) and its good to see these attack avenues being taken seriously now.</p>

  </section></div>
  </body>
</html>
