<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.narrator.ai/blog/postgres-missing-datediff-function/">Original</a>
    <h1>PostgreSQL&#39;s Missing DateDiff Function</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
    <article>

        <header>

            <section>
                <a href="https://www.narrator.ai/blog/tag/sql/">SQL</a>
            </section>

            

            <p>DATEDIFF is an extremely useful function for analytical queries. Given two timestamps it&#39;ll tell you how many days, weeks, months, hours, etc they are apart. Here we show an implementation of this function for Postgres.</p>

            <div>
                <section>
                    <ul>
                        <li>
                            <a href="https://www.narrator.ai/blog/author/cedric/">
                                <img src="https://www.narrator.ai/blog/content/images/size/w100/2020/12/cropped_cedric.jpg" alt="Cedric Dussud"/>
                            </a>
                        </li>
                    </ul>
                    <div>
                        
                        <p><time datetime="2021-06-28">Jun 28, 2021</time>
                            <span><span>•</span> 3 min read</span>
                        </p>
                    </div>
                </section>
            </div>

            <figure>
                <img srcset="/blog/content/images/size/w300/2021/07/photo-1546525506-495a7647977b--1-.webp 300w,/blog/content/images/size/w600/2021/07/photo-1546525506-495a7647977b--1-.webp 600w,/blog/content/images/size/w1000/2021/07/photo-1546525506-495a7647977b--1-.webp 1000w,/blog/content/images/size/w2000/2021/07/photo-1546525506-495a7647977b--1-.webp 2000w" sizes="(min-width: 1400px) 1400px, 92vw" src="https://www.narrator.ai/blog/content/images/size/w2000/2021/07/photo-1546525506-495a7647977b--1-.webp" alt="PostgreSQL&#39;s missing DateDiff function"/>
            </figure>
        </header>

        <section>
            <p><em>Photo by <a href="https://unsplash.com/@yogidan2012?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit">Daniele Levis Pelusi</a> / <a href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit">Unsplash</a></em></p><p>Data warehouses like Redshift and Snowflake have a super useful <code>DATEDIFF</code> function – given two timestamps and a date part (hour, year, week, etc) it&#39;ll return how far apart they are. For example, </p><p><code>DATEDIFF(&#39;week&#39;, &#39;06-01-2021&#39;, &#39;06-28-2021&#39;)</code> returns <code>4</code></p><p>This function can be used to bucket times together, like when doing a cohort analysis. Unfortunately Postgres simply doesn&#39;t have it. For operational data it&#39;s probably not often used, but if you do analytical queries it can be pretty helpful.</p><p>If you want to use <a href="https://www.narrator.ai/blog/using-postgresql-as-a-data-warehouse/">Postgres as a data warehouse</a> you&#39;ll probably want it. A great blog by <a href="https://www.sqlines.com/postgresql/how-to/datediff">sqlines</a> suggests an implementation, but I found it didn&#39;t quite match the functionality of most data warehouses.</p><blockquote>Why is this even a function? Why not just use <a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT">date_part</a>? Because time rolls over: the last month of the year is 12 and the first is 1, so naively using date part would give us -11. </blockquote><hr/><h2 id="the-datediff-code">The DATEDIFF code</h2><p>I&#39;ll jump straight to the code for those who like to see the answer first, and further down explain how it works</p><!--kg-card-begin: html--><!--kg-card-end: html--><p>This gist creates a function in Postgres that implements the <code>DATEDIFF</code> function found in <a href="https://docs.snowflake.com/en/sql-reference/functions/datediff.html">Snowflake</a>, <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_diff">BigQuery</a>, and <a href="https://docs.aws.amazon.com/redshift/latest/dg/r_DATEDIFF_function.html">Redshift</a>.</p><p>This function take a time unit and two dates, and counts the<em> number of date boundaries crossed</em> between them. It will always return an integer, so it&#39;s very useful for grouping date differences together.</p><p>So what does counting date boundaries mean? It&#39;s best illustrated with an example</p><p><code>DATEDIFF(&#39;year&#39;, &#39;12-31-2020&#39;, &#39;01-01-2021&#39;)</code> returns <code>1</code> because even though the two dates are a day apart, they&#39;ve crossed the year boundary.</p><p>Similarly <code>DateDiff(&#39;week&#39;, &#39;05-02-2021&#39;, &#39;05-03-2021&#39;)</code> is <code>1</code>, because 5/02/21 is a Sunday and 5/03/21 is a Monday</p><blockquote>Note that Postgres uses <a href="https://en.wikipedia.org/wiki/ISO_week_date">ISO 8601</a> week numbering, so weeks will always start on Mondays. This isn&#39;t consistent across databases – Redshift uses Sunday, while in Snowflake it&#39;s <a href="https://docs.snowflake.com/en/sql-reference/functions-date-time.html#label-calendar-weeks-weekdays">configurable</a>. </blockquote><h2 id="how-datediff-works">How DATEDIFF works</h2><p>The code basically works in two parts. It computes year, quarter, and month boundaries by subtracting integers. It computes weeks and below by truncating.</p><h3 id="years-quarters-and-months">Years, Quarters, and Months</h3><p><strong>Years</strong> is easy: <code>2021 - 2020 = 1</code></p><p><strong>Months</strong> – just use <code>DATE_PART</code> to get the month as an integer (1-12). Subtract the two and add in the year expressed in months to handle rollover.</p><p>2021/2 - 2020/11 would be <code>(2 - 11) + 1 * 12 = 3</code></p><p><strong>Quarters</strong> is effectively the same as months (since <code>DATE_PART</code> gives us quarters as an integer from 1-4).</p><h3 id="weeks-and-days">Weeks and Days</h3><p>Weeks and days use a slightly different approach. Weeks are special because they don&#39;t fit evenly into months, years or anything bigger. They only fit evenly into days. </p><p>The way to count <strong>weeks</strong> is to truncate the start and end timestamps to the first day of the week, then subtract days. That will give us an integer that&#39;s a multiple of 7. Note that the &#39;first day of the week&#39; is not uniform across databases. Postgres uses Monday. </p><p><code>RETURN DATE_PART(&#39;day&#39;, (DATE_TRUNC(&#39;week&#39;, end_t) - DATE_TRUNC(&#39;week&#39;, start_t)) / 7);</code></p><p>Subtracting the days returns an <code>interval</code>, so we use <code>DATE_PART</code> to get an integer number of days. Since this is always divisible by 7, we now have our number of weeks.</p><p><strong>Days</strong> is computed the same way, without dividing by 7. Instead of the start of the week we truncate to the beginning of the day to ensure the interval is an exact number of days.</p><h3 id="hours-on-down">Hours on down</h3><p>Hours, minutes, and seconds are built out just like months and quarters. </p><p><code>hours = days * 24 + (DATE_PART(&#39;hour&#39;, end_t) - DATE_PART(&#39;hour&#39;, start_t));</code></p><p>We extract the <strong>hour</strong> as an integer (0-23) for each timestamp, subtract from each other, and multiply by the days expressed as hours. </p><p><strong>Minutes</strong> is the same calculation, but it uses <code>hours * 60</code> since we already have it. </p><p><strong>Seconds</strong> is also the same, using <code>minutes * 60</code>. </p><p>If you need to handle milliseconds or below it&#39;s easy to extend the code. I stopped at seconds.</p>
        </section>


    </article>
</div></div>
  </body>
</html>
