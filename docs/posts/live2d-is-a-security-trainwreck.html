<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://undeleted.ronsor.com/live2d-a-security-trainwreck/">Original</a>
    <h1>Live2D Is a Security Trainwreck</h1>
    
    <div id="readability-page-1" class="page"><div>
  <p><em>Translations of this article are welcome. If you know Japanese or any other language, feel free to
contact me. The markdown source for this article is <a href="https://words.filippo.io/dispatches/avoid-the-randomness-from-the-sky/article.txt">here</a>.</em></p>
<p><strong>Update: the vulnerability discovered here has been assigned <a href="https://www.cve.org/CVERecord?id=CVE-2023-27566">CVE-2023-27566</a>.</strong></p>
<p><a href="https://live2d.com">Live2D</a> Cubism is a popular 2D puppet animation software most known for its use
by VTubers<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> and in certain mobile games. In order to load the models generated by the software,
developers need to include their proprietary “Cubism SDK,” for which there is no alternative. At the
heart of this SDK is “Cubism Core,” a small C library responsible for parsing and loading <strong>MOC3 files</strong>,
the format Live2D Cubism uses to store the 2D puppets. <strong>Unfortunately, Cubism Core is a deeply flawed
and potentially unfixable piece of software.</strong></p>
<p>If you’re just interested in the code, <a href="#source-code">jump to the bottom</a>.</p>
<p><strong>If you don’t feel like reading the whole thing, please at least look at the
<a href="#key-takeaways">Key Takeaways</a>.</strong></p>
<h2 id="an-introduction-to-moc3">An Introduction to MOC3</h2>
<p>MOC3 is a proprietary binary format that contains a list of offsets to sections containing data for
the 2D puppet, such as meshes and adjustable parameters. This format is effectively a raw dump of C
arrays and structs. While ugly and obtuse, it does work, and it should be possible to write a safe
loader for such a format. MOC3 files do not contain the actual textures.</p>
<h3 id="reversing-moc3">Reversing MOC3</h3>
<p>A minimal MOC3 file needs only two components: a header, with the magic string “MOC3” along with
a version and endianness; and a <strong>Section Offset Table</strong>. The Section Offset Table contains offsets
to the sections in the file, and its entries are stored as a signed 32-bit integer. The Section Offset
Table closely follows the <a href="https://en.wikipedia.org/wiki/AoS_and_SoA">Structure of Arrays</a> paradigm.</p>
<p>After some poking and prodding, I figured out the exact layout of MOC3 files and used the
<a href="https://imhex.werwolv.net/">ImHex</a> hex editor to explore all the properties.</p>
<p><img src="https://words.filippo.io/dispatches/avoid-the-randomness-from-the-sky/moc3_properties.png" alt="MOC3 Properties"/></p>
<p>ImHex supports patterns, scripts that allow you to define structures and other elements of a binary
format. This made it simple to craft an interface to read and edit the sections of MOC3 files.</p>
<p>The resulting pattern file is about 400 lines long, honestly shorter than I was expecting. One notable
MOC3 section is the <strong>Count Info Table</strong>, which specifies the number of elements for the arrays of each
type of object stored in the file.</p>
<h2 id="mocsup3supingbird-the-security-problem">MOC<sup>3</sup>ingbird: The Security Problem</h2>
<p><strong>Cubism Core is not even a remotely safe solution for loading MOC3 files, despite currently being the
only solution!</strong> Changing entries in the Section Offset Table reveals that it will blindly add whatever
offset is given to the MOC3 data’s base address, meaning that <strong>a rogue MOC3 file could easily instruct
Cubism Core to overwrite any memory within ~2 GiB of where the MOC3 data is located.</strong> The whole file
is effectively a write-what-where primitive<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>. In addition to that, the Count Info Table is not
bounds checked either, so one could easily specify that there are 500,000 parameters in a 8,192
byte MOC3 file. Overall, it is far too easy to go “off the rails” in Cubism Core.</p>
<p>MOC<sup>3</sup>ingbird is a simple MOC3 file crafted to crash the official Live2D viewer and any third
party software that uses Cubism Core. It does not contain a payload, but it likely could easily be
modified to execute one. In fact, the screenshot above shows the sections of the MOC<sup>3</sup>ingbird
<code>exploit.moc3</code> file.</p>
<h3 id="defective-by-lack-of-design">Defective by Lack of Design?</h3>
<p>The MOC3 format, while technically usable, is an unmitigated disaster, and Cubism Core has far too many
problems to require <a href="https://www.live2d.com/en/download/cubism-sdk/release-license/">expensive licenses</a>
for production use. Although it is possible that the format is intentionally yet poorly designed, it is
much more likely that was not designed at all. It seems as if fields and sections were simply added to
the format whenever needed, without regard to proper implementation. Of course, there are solutions that
allow for this to be done in a somewhat reasonable manner, the simplest of which would be to use a
standard serialization format like JSON, MessagePack, CBOR, or Protocol Buffers. Sadly, I suspect the
developers at Live2D avoided this, hoping that a proprietary format would keep others from competing with
their products.</p>
<p>The end result of these decisions and “not decisions” is an opaque, insecure mess that likely cannot be
cleaned up without a complete rewrite. I honestly do not care whether they were simply negligent or
motivated by a desire for increasing profit; exposing users to such simple, easily avoided vulnerabilities
is unacceptable.</p>
<h3 id="privacy-apocalypse">Privacy Apocalypse</h3>
<p>The blatant disregard for proper security practices shown by Live2D appears even worse when you consider
that a significant portion of their userbase, i.e. VTubers<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>, go to great lengths to protect their privacy.
Doxing<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup> was and continues to be a significant problem in that community, and bad actors could easily take
advantage of these vulnerabilities in order to deploy spyware on unsuspecting users’ computers.</p>
<h3 id="so-why-publish-this">So Why Publish This?</h3>
<p>I honestly do not feel that Live2D will fix any of their problems without significant pushback, and
reporting these problems directly to them would not count as “significant.” Live2D appears heavily invested
in secrecy and security through obscurity, rather than transparency and real “non-hopeful” security,
as evidenced in the FreeLive<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup> incident among other anecdotes I cannot disclose. There is no doubt
in my mind that, if this article were not published, a cybercrime group would eventually discover these
flaws and exploit them in secret, while Live2D’s users would have no idea what would be happening.</p>
<p>It is up to their users and their community to push for them to fix these issues, or switch to open
alternatives like <a href="https://inochi2d.com">Inochi2D</a>. It doesn’t matter whether Live2D likes this or not.<sup id="fnref1:5"><a href="#fn:5" role="doc-noteref">5</a></sup></p>
<h2 id="anticompetitive-practices">Anticompetitive Practices</h2>
<p>Earlier in the article I mentioned that there was no alternative to the Cubism SDK for loading MOC3
models. While the simple assumption could be made that the format is too opaque and confusing for most
developers to figure out, there is possibly another reason.</p>
<blockquote>
<p>5.1.9 Other Restrictions</p>
<ul>
<li>The Customer may not use the Output File with software(s) or middleware(s) that compete with or could
compete with the Software or any other software(s) or middleware(s) produced by Live2D;</li>
</ul>
</blockquote>
<p><em>from the <a href="https://www.live2d.com/eula/live2D-editor-software-license-agreement_en.html">Live2D EULA</a></em></p>
<p>In case you’re not sure you read it right, or if you don’t understand it, Live2D’s EULA prohibits people
from using the models they create (with Live2D’s <a href="https://store.live2d.com/en/">expensive</a>, licensed editor
software) with a hypothetical, more secure Cubism Core replacement. If you use their editor software, you
are in fact required to use their insecure, proprietary SDK.</p>
<p>If you are a developer of software using Live2D’s, I encourage you or your employer to vote with your
wallet and not support these practices. In case you need extra encouragement, let me remind you:</p>
<blockquote>
<ul>
<li>The Customer may not otherwise engage in any acts which Live2D judges inappropriate.</li>
</ul>
</blockquote>
<p>And let’s also scroll down a bit…</p>
<blockquote>
<p>7.4 If this Agreement is terminated pursuant to Section 7.1, the Customer shall promptly destroy the
Software, all copies thereof, and all Derivative Work including the Output Files and any other derivatives
arising from use of the Software.</p>
</blockquote>
<p>It is quite plainly stated that Live2D can quite literally destroy your business at any time.</p>
<p>It is also unclear if people who receive a Live2D model from a third-party would be bound to such terms
(potentially not, since they never signed the agreement, assuming they haven’t installed the Live2D Cubism
Editor on their own).</p>
<p>Let’s read some more restrictions…</p>
<blockquote>
<ul>
<li>The Customer may not release any software code or content of the Software included in the Software of
the Output File under a license that is not from Live2D;</li>
</ul>
</blockquote>
<p>I can confirm that MOC3 files don’t contain any trace of the editor software, certainly not any code anyway.
In fact, I just showed you can craft a MOC3 file from scratch, without taking anything from the editor.</p>
<h3 id="unlawful-provisions">Unlawful Provisions?</h3>
<p>These large license agreements tend to contain heaps of “you must” and “you must not” that may not even
be legal where you live. I look forward to them attempting to enforce their “No Reverse Engineering”
provision in Europe, but I digress. At least they acknowledge this:</p>
<blockquote>
<p>5.1 Restricted Acts</p>
<p>Live2D reserves all rights not expressly granted to the Customer in this Agreement.
<strong>Unless applicable law gives the Customer more rights</strong> notwithstanding this limitation, the Customer
may use the Software only as expressly permitted in this Agreement.</p>
</blockquote>
<h2 id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>It is NEVER safe to open untrusted files or models with Live2D applications.</strong>
<ul>
<li>At worse, Live2D models could be carrying <strong>spyware, ransomware, or some other malware.</strong></li>
</ul>
</li>
<li><strong>You CANNOT be sure whether a Live2D model is safe or not, which means you CANNOT
safely accept Live2D models from anyone online.</strong>
<ul>
<li>There is no software that can verify the integrity of a Live2D model, and Live2D
will likely attempt to prevent the development of such software.</li>
</ul>
</li>
<li><strong>Live2D the company engages in anticompetitive practices that should not be supported.<sup id="fnref2:5"><a href="#fn:5" role="doc-noteref">5</a></sup></strong></li>
<li><strong>You should support free, open alternatives to Live2D’s software.</strong></li>
</ul>
<h2 id="source-code">Source Code</h2>
<p>The exploit as well as the pattern file for the MOC3 format are available at
<a href="https://github.com/openl2d/moc3ingbird">https://github.com/openl2d/moc3ingbird</a>.</p>
<p>MOC<sup>3</sup>ingbird © 2023 The OpenL2D Project Developers.
<a href="https://freedevproject.org/fdpl-1.0-us">License information.</a></p>


</div></div>
  </body>
</html>
