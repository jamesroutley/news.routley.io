<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://twitter.com/marcan42/status/1494213855387734019">Original</a>
    <h1>Apple&#39;s custom NVMes are amazingly fast â€“ if you don&#39;t care about data integrity</h1>
    
    <div id="readability-page-1" class="page"><div role="main"><div><div><div><div data-testid="primaryColumn"><div><div itemscope="" itemtype="https://schema.org/Collection"><meta content="Tweet with replies" itemprop="name"/><section aria-labelledby="accessible-list-132388" role="region"><div aria-label="Timeline: Conversation"><div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213855387734019" itemprop="identifier"/><meta content="1" itemprop="position"/><meta content="23" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:18.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:18.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213855387734019" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213855387734019" itemprop="mainEntityOfPage"/><div><article aria-labelledby="id__hfd0zgkf0qa id__wwctxtnjro9 id__ijw9atsxlo id__mzrb407h65f id__jssymqswft id__chpjnsx1z7a id__yrm20azxcqo id__zmlsn9livlf id__b169xlf8b4l id__hsdng8hqhx id__6hfxjc2vz7x id__8aq9ybh5se5 id__sp24993nkz id__kt7m409d3z" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__chpjnsx1z7a"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div></div><div><div><div itemprop="articleBody"><div><p><span>Well, this is unfortunate. It turns out Apple&#39;s custom NVMe drives are amazingly fast - if you don&#39;t care about data integrity.

If you do, they drop down to HDD performance. Thread.</span></p></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213859594616834" itemprop="identifier"/><meta content="2" itemprop="position"/><meta content="3" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:19.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:19.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213859594616834" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213855387734019" itemprop="isPartOf"/><div><article aria-labelledby="id__ou5rfp7s7h id__cqk2wss58o id__bi3d6oetyk id__ss5zm1sp1i id__sa8w892l3d id__torpbc8v1w id__fahkpb1d5iu id__i5k38kipeir id__0fsvvpm9jwtm id__uyp9y5d04ks id__ufcu0jlnxp id__yfz4yyminx id__yjxxbsgbk3 id__8kuojcvocwd" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__torpbc8v1w"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>For a while, we&#39;ve noticed that random write performance with fsync (data integrity) on Asahi Linux (and also on Linux on T2 Macs) was terrible. As in 46 IOPS terrible. That&#39;s slower than many modern HDDs.

We thought we were missing something, since this didn&#39;t happen on macOS.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213862970707969" itemprop="identifier"/><meta content="3" itemprop="position"/><meta content="7" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:20.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:20.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213862970707969" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213859594616834" itemprop="isPartOf"/><div><article aria-labelledby="id__voqj1pan4am id__792bjg5v8gd id__dkucecvcmd id__s5iq2oomnqm id__uinxui0b56c id__tussbu1soe id__in2g5q05zda id__4nqiommbf2h id__mtde9dfimv id__l9xm5tr421 id__i4al3hte43d id__hs73imep53r id__iieq7muuxp8 id__ttyptx9me48" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__tussbu1soe"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>As it turns out, macOS cheats. On Linux, fsync() will both flush writes to the drive, and ask it to flush its write cache to stable storage.

But on macOS, fsync() only flushes writes to the drive. Instead, they provide an F_FULLSYNC operation to do what fsync() does on Linux.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213865613426688" itemprop="identifier"/><meta content="4" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:21.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:21.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213865613426688" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213862970707969" itemprop="isPartOf"/><div><article aria-labelledby="id__417xk04bp6l id__bmrjzpnnyj id__dsasscem0s8 id__n2wjivaju5 id__kobaca5xst8 id__tdahk9akto id__a6xb3e4auu4 id__2r78gwe8ih3 id__1vpi82bhi9b id__w7tn729gzad id__hqndk3i6r4m id__2w912jvkii9 id__3r9511ul38e id__c2owpuzo5mw" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__tdahk9akto"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So effectively macOS cheats on benchmarks; fio on macOS does not give numbers comparable to Linux, and databases and other applications requiring data integrity on macOS need to special case it and use F_FULLSYNC.

How bad is it if you use F_FULLSYNC? It&#39;s bad.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213868201324546" itemprop="identifier"/><meta content="5" itemprop="position"/><meta content="4" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:21.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:21.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213868201324546" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213865613426688" itemprop="isPartOf"/><div><article aria-labelledby="id__picgmad9zz id__gbvr1gwjlap id__ur9t2mmrjph id__n57zajd4qjj id__wvn2xj70gg id__h7emy0aqyd id__tnm7mwhm0gh id__vt8xa16h8gg id__8ekf9m8gr9s id__etp93zv821i id__4rtynp1seu id__bwlttsw9s2e id__3327kzh758r id__cu51x2zf28" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__h7emy0aqyd"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Single threaded, simple Python file rewrite test:

Macbook Air M1 (macOS):
- flushing: 46 IOPS
- not: 40000 IOPS

x86 iMac + WD SN550 1TB NVMe (Linux):
- flushing: 2000 IOPS
- not: 20000 IOPS

x86 laptop + Samsung SSD 860 EVO 500GB SATA:
- flushing: 143 IOPS
- not: 5000 IOPS</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213871149940737" itemprop="identifier"/><meta content="6" itemprop="position"/><meta content="2" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:22.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:22.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213871149940737" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213868201324546" itemprop="isPartOf"/><div><article aria-labelledby="id__wtucirc8kss id__x6o17hdjbdk id__qzk2ooz593g id__qgche38mxjm id__9kb3kunmolj id__1ejl386l7bl id__pv42mkuo3x id__jn0kv2zcc id__srl1i5gyujg id__sj7jtpex3o id__wqzu4st8nnb id__nfw2y0spnw id__4gobm6qw4mf id__tvzy3wefw9o" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__1ejl386l7bl"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So, effectively, Apple&#39;s drive is faster than all the others without cache flushes, but it is more than 3 times slower than a lowly SATA SSD at flushing its cache. Even if all you wrote is a couple of sectors. You pay a huge flush penalty if you do *any* writes.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213873993682946" itemprop="identifier"/><meta content="7" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:23.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:23.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213873993682946" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213871149940737" itemprop="isPartOf"/><div><article aria-labelledby="id__8ydgr1xvno7 id__z4l31k7371l id__jxnyhkgsxt id__7nbuhfmd11v id__ffxgzl06zz id__zllz5ka3t7 id__qqsh4x2qelf id__1g34tu2ckph id__iy8o3n9g7r id__abq0jiqrw7s id__kq6fw8qwve id__35mo5idk69a id__rq6cnpa6uxn id__rbre558jcao" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__zllz5ka3t7"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Here, &#34;flushing&#34; on macOS means F_FULLSYNC and &#34;not&#34; means fsync(); on Linux both are fsync(), but &#34;not flushing&#34; is measured by telling Linux that the drive write cache is write-through (which stops it from issuing cache flushes).</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213876657049600" itemprop="identifier"/><meta content="8" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:24.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:24.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213876657049600" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213873993682946" itemprop="isPartOf"/><div><article aria-labelledby="id__9zrn6ak007f id__aj40obovy0s id__nsf1oihnko id__msc3gshk04i id__b3e4df8kig id__v9gc0hv2on8 id__su7agwgtt8a id__cqqhcxxqzzq id__6d99jcojtwe id__wq61dg4k5ks id__9rqe5yjdi9p id__lw094nwe54s id__bb20sw8vxsv id__g3bh1wx75ud" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__v9gc0hv2on8"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Note that the numbers are filesystem-dependent (and encryption makes things more complicated); e.g. the SATA SSD numbers double on VFAT vs. my root filesystem (ext4 on LVM on dm-crypt), but the pattern is clear.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213879089737729" itemprop="identifier"/><meta content="9" itemprop="position"/><meta content="4" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:24.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:24.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213879089737729" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213876657049600" itemprop="isPartOf"/><div><article aria-labelledby="id__tywg0pewts id__qnh6s041jw id__4fr374f3zfj id__uutdolsitaf id__aixf0ywa1q id__jez1wmbzf1 id__iszup5xl7h id__djx2d57u1b6 id__pnn9w79vmms id__gphvnakhlwn id__owvcizlk2fr id__05kdb83tozc3 id__zzsjbz9ycu id__cekkz2wu8cu" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__jez1wmbzf1"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>macOS doesn&#39;t even seem to try to proactively issue syncs; you can write a file on macOS, fsync() it, wait 5 seconds, issue a hard reboot (e.g. via USB-PD command), and the data is gone. That&#39;s pretty bad.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213881509875712" itemprop="identifier"/><meta content="10" itemprop="position"/><meta content="6" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:25.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:25.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213881509875712" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213879089737729" itemprop="isPartOf"/><div><article aria-labelledby="id__a2g8q66dstd id__ulnw9u6cdw8 id__xxiwlf724qi id__anv1naoa28r id__vlhmt45un6l id__93o79bas5en id__pbzzl8n0mg id__v3p2lixvn4 id__xok9q5kxv9 id__2gm4l3ka20c id__447wov95pff id__6czk59trzos id__z0fps9j3i8 id__dmaop1xusb9" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__93o79bas5en"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Of course, in normal usage, this is basically never an issue on laptops; given the right software hooks, they should never run out of power before the OS has a chance to issue a disk flush command. But it certainly is for desktops. And it&#39;s a bit fragile re: panics and such.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213883976101888" itemprop="identifier"/><meta content="11" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:25.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:25.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213883976101888" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213881509875712" itemprop="isPartOf"/><div><article aria-labelledby="id__3lgh43sfejf id__jhwsdm5gdmh id__0jqq4nb3kqen id__0yo44dpc5txf id__2mszf1y745i id__qxc0zbrd30a id__st3quzpx02g id__xqbpcodw3s7 id__u0p3qo7976 id__cfsfosf4amo id__x51vuxwjarj id__g8dips8msze id__wea8t31548r id__aql917o8yrp" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__qxc0zbrd30a"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Unfortunately, this manifests itself as quite visible issues on Linux. For example, apt-get on Asahi Linux is noticeably slow. Making fsync() not really flush on macOS is not fair; lots of portable software is written to assume fsync() means your data is safe.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213886928908288" itemprop="identifier"/><meta content="12" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:26.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:26.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213886928908288" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213883976101888" itemprop="isPartOf"/><div><article aria-labelledby="id__tr06d3tfk2t id__2fftsozjoyg id__r1uj7lgd4id id__x52zt99omu id__oytifj7ayv id__z7jnu9xh5l id__n3obfsd9o5m id__2wii2u0st7s id__ebqzm73m9sk id__gpiow5zcsja id__oubwf6c86ok id__5sybpguyjl id__plxducs9zq id__dq9zkijik0o" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__z7jnu9xh5l"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Our current thinking is we&#39;re going to add a knob to the NVMe driver to defer flush requests up to a maximum time of e.g. 1 second. That would ensure that a hard shutdown never loses you more than 1 second of data, which is better than what macOS can claim right now.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213889646796802" itemprop="identifier"/><meta content="13" itemprop="position"/><meta content="3" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:27.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:27.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213889646796802" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213886928908288" itemprop="isPartOf"/><div><article aria-labelledby="id__ml34zfayu5 id__pl0ruot3yf id__7lowzjauvuu id__6jeblg7nbds id__hfhk7czigym id__h9w2dzjaceu id__hemi0b6au3u id__xt82va61c7 id__qzbrckfxdp id__s6ddxn52b1d id__3wojupcrgap id__sybz1ewcfen id__tns9ym23dd id__37spoo30zze" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__h9w2dzjaceu"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Alas, that&#39;s still not quite safe. Not flushing means we cannot guarantee ordering of writes, which means you could end up with actual data corruption in e.g. a database, not just data loss. There&#39;s no good way around this other than doing full flushes.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213892331163649" itemprop="identifier"/><meta content="14" itemprop="position"/><meta content="5" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:27.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:27.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213892331163649" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213889646796802" itemprop="isPartOf"/><div><article aria-labelledby="id__i38bry5ox1j id__2pgoyja08np id__5p7nzzwz3rp id__77484ortkx8 id__phnrbzmzd9c id__nk9hx125bhp id__23nh2firfzt id__tnypo29v9nr id__uvemfi0rfn id__3gfahtz6kfm id__73k6ct601qx id__x5i11z9igio id__n6vgt7lvn4j id__97wp8rslmtr" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__nk9hx125bhp"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So the unfortunate conclusion is that if you&#39;re e.g. running a transactional database on Apple hardware, and you need to be able to survive a hard poweroff without data corruption, you&#39;re never going to get more than ~46 TPS.

Unless Apple improves their ANS firmware to fix this.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494215160218939392" itemprop="identifier"/><meta content="15" itemprop="position"/><meta content="6" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:40:30.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:40:30.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494215160218939392" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213892331163649" itemprop="isPartOf"/><div><article aria-labelledby="id__tw8kokuwvs id__yv5ekc9h4vq id__0qgrpgwuh1k id__2oyqxogg8ig id__rp1ww0nn3c8 id__5lwu1oaejkv id__ibmhc4xl8gg id__2ee3wviz3uh id__dn0wzy7hkws id__5ztbswrs77c id__jwcpqfz9kg id__9dlodqv283c id__82qchih11k7 id__jv5y3jkq0yp" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__5lwu1oaejkv"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>And for what it&#39;s worth, I inadvertently triggered a data consistency issue in macOS while testing this. Before running any tests I had GarageBand open. I closed it without saving the open project. After the first hard reboot later, it tried to reopen it and threw up an error.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494215321125007362" itemprop="identifier"/><meta content="16" itemprop="position"/><meta content="2" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:41:08.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:41:08.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494215321125007362" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494215160218939392" itemprop="isPartOf"/><div><article aria-labelledby="id__je2j4wq9i id__c4zcdes0eyf id__ydtoq7cigfp id__23dlf05bmfk id__jggtjqj3cgo id__y4896v9y2nc id__1rs53yh73f6 id__r0nygaj2r4s id__6hyjrve7lo6 id__nr63rb3w18s id__1pk1vc54x1o id__r67m9786pt id__tw9jf06g5cl id__5yyfsjfehul" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__y4896v9y2nc"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So I guess the unsaved project file got (partially?) deleted, but not the state that tells it to reopen the currently open file on startup.

Data consistency matters.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494221053220257795" itemprop="identifier"/><meta content="17" itemprop="position"/><meta content="10" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T08:03:55.000Z" itemprop="dateCreated"/><meta content="2022-02-17T08:03:55.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494221053220257795" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494215321125007362" itemprop="isPartOf"/><div><article aria-labelledby="id__r88ybidwjl id__bg3kuev032g id__a71dws73pj id__nu6ld0thyw id__sic9wejerjc id__biqjqqoz87c id__wppy0uzgzle id__gjbwktut1wo id__6xuo53zhmbp id__1cl9y8lo8ua id__8vip4hu922b id__rzaviq3uo8 id__3kl53hgbzy5 id__whg9f32m7pb" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__biqjqqoz87c"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Update: tested on the Mac Mini by pulling the plug (which is a &#34;normal&#34; case; the USB-PD thing was a bit special). Still lost seconds of fsync()ed data. There is no (working) last-gasp flush mechanism.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494255642202484743" itemprop="identifier"/><meta content="18" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:21:21.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:21:21.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494255642202484743" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494221053220257795" itemprop="isPartOf"/><div><article aria-labelledby="id__4d18crgz7wv id__fjnz16pxlpj id__q5r1kbmoac id__dqtmbkamwb id__7jyvgmv4qr8 id__2fbv4xxx52i id__pdxzah84iy id__3bcvhcrn42b id__f9uaqpezstn id__ej8vvffa1im id__4w9eqh4asgk id__pkg6p6orsj id__aurh2ink9ad id__88tbdlwch9x" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__2fbv4xxx52i"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Further testing: doing this on FAT32 (to avoid APFS write amplification, which is a separate problem...) doesn&#39;t help with the IOPS on flush, but then I can look at powermetrics bandwidth stats to see what NVMe is doing.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494255645612474369" itemprop="identifier"/><meta content="19" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:21:22.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:21:22.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494255645612474369" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494255642202484743" itemprop="isPartOf"/><div><article aria-labelledby="id__d1pfx6jeqyn id__to2tuboik5f id__e0r8p8cc8ju id__viqpg5qefo id__g15j1xv227g id__aga12cbdj3r id__ao4r4lshjve id__7n9xad0sdpq id__02wf5g2g41k7 id__cpx0gg3yqw6 id__723o043wa6l id__k81hc1vqkl id__9ewuw2z9p6e id__hs7b2vjy6rw" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__aga12cbdj3r"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Artificially throttled ~30 IOPS without full cache flushes, I get 93.52 ops/s 397.77 KBytes/s disk IO, which is reasonable, and:

ANS2 RD                         : 0.328 MB/s
ANS2 WR                         : 0.399 MB/s

That&#39;s NVMe controller DRAM bandwidth. Reasonable.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494255649026625537" itemprop="identifier"/><meta content="20" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:21:23.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:21:23.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494255649026625537" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494255645612474369" itemprop="isPartOf"/><div><article aria-labelledby="id__prmcy7rtry id__uzsex6jwhts id__g1u9b93xhcf id__f5769j756d7 id__h8btbjzwso8 id__zar2gvnrd9 id__7qf23vi7wcu id__l03gsn6xad id__wnqmpqen75 id__1zg7i2k5fwc id__66ec3zbrj3v id__vdfj7kwo7xb id__v06yyh0r1i8 id__sj6ovqyk9ll" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__zar2gvnrd9"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>But doing flushes, this jumps to:

ANS2 RD                         : 6.248 MB/s
ANS2 WR                         : 9.909 MB/s

So that NVMe controller is doing *something* memory-intensive on flush commands. Maybe it does a linear scan over a large cache hashtable?</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494256049150640129" itemprop="identifier"/><meta content="21" itemprop="position"/><meta content="2" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:22:58.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:22:58.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494256049150640129" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494255649026625537" itemprop="isPartOf"/><div><article aria-labelledby="id__lyx0co11rdo id__pjwvjsod03 id__vjxq47na408 id__rq7dhdx8759 id__uay6ha14ysp id__43t4sj7mv8r id__5wcvyzvwpp id__yg2uops3vg id__9el8t6pogh4 id__2nndr6347o id__dyvfs2m4zp id__a11xt0pu645 id__kc9y1443qf id__pw8oc795b3" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__43t4sj7mv8r"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>I can get these stats because the NVMe controller is integrated into the SoC and &#34;drive cache&#34; is just normal memory (it&#39;s unified just like GPU memory), and Apple have very good instrumentation of things like DRAM bandwidth utilization from different SoC agents.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494293060020506626" itemprop="identifier"/><meta content="22" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T12:50:02.000Z" itemprop="dateCreated"/><meta content="2022-02-17T12:50:02.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494293060020506626" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494256049150640129" itemprop="isPartOf"/><div><article aria-labelledby="id__p59b3r3vcc9 id__lajrx72hj5 id__ezqgu9zklhs id__h7xn4ogneg8 id__jtu8amb8qwn id__3tsiff26s3u id__w8pzasn00p9 id__6levd8rm7fo id__dwk8xwyri5i id__yyl5zknb1k id__v706yknddh id__17v6iph8ilc id__1974zntiil4 id__k2lz7vvekpn" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__3tsiff26s3u"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Uh, guys? I&#39;m not saying &#34;the machines are only fast because they cheat on data durability&#34;. I&#39;m saying there&#39;s a stupid, unfortunate performance bug when you *do* want durability that most people won&#39;t notice because macOS gives you poor durability by default.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494293064579686400" itemprop="identifier"/><meta content="23" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T12:50:03.000Z" itemprop="dateCreated"/><meta content="2022-02-17T12:50:03.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494293064579686400" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494293060020506626" itemprop="isPartOf"/><div><article aria-labelledby="id__n1805y20f5 id__c338u7q3yqp id__9ot08du06c id__wpf249bf5r id__fyybqam6pwd id__ug8kwx16kc id__0m57zstjhqrq id__xrj3d65rwl id__k65y5fukbl8 id__x46yajxx8ml id__56lvd99exx id__ow48tootte9 id__9axvw7xgajq id__3igrnsqfh7t" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__ug8kwx16kc"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>These SSDs are still fast for many use cases, and on laptops you don&#39;t care about this issue because there&#39;s a battery backup anyway.

And besides, Apple can almost certainly fix this in a firmware upgrade.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494293067771564040" itemprop="identifier"/><meta content="24" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T12:50:04.000Z" itemprop="dateCreated"/><meta content="2022-02-17T12:50:04.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494293067771564040" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494293064579686400" itemprop="isPartOf"/><div><article aria-labelledby="id__cniusivo7fq id__bn2llvnoir id__thzvkv2filf id__uj0em8rjo1 id__jj8bcfa76zc id__i5v0rfo8ce id__3zmgh2xvmti id__lkcf34lt60d id__hhsbvcf3hrb id__5oh6m0kpqav id__exzbu414zfe id__8dxbnorwvkb id__glc8c9ozahi id__0f5rg2ljep49" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__i5v0rfo8ce"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Chances are this happened because this design came from iDevices, where there&#39;s always a battery, so software will never hit drive cache related consistency/durability issues, so probably ~no iOS software ever uses a full sync, so nobody noticed it&#39;s slow.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494293071118614529" itemprop="identifier"/><meta content="25" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T12:50:05.000Z" itemprop="dateCreated"/><meta content="2022-02-17T12:50:05.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494293071118614529" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494293067771564040" itemprop="isPartOf"/><div><article aria-labelledby="id__3h3zybc77bj id__gsox5qnfsfp id__h3tpl6t034 id__nc47m38b0qh id__2usoenzwc7w id__ise72me4leb id__0grygpgtutgh id__ob5e1n4xjdd id__lmvchmqj56h id__3ugu3ewajij id__s4jjhqnsf1 id__8t8wnny7jik id__w5a6i1owame id__7mqdsgd8wq" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__ise72me4leb"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>And I&#39;m just the Nth guy to facepalm when I found out that macOS makes data durability double-opt-in with a nonstandard request. That&#39;s dumb, but it has nothing to do with the machines. It&#39;s just the reason why fio was magically fast on macOS and not on Linux.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494293769134690305" itemprop="identifier"/><meta content="26" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T12:52:51.000Z" itemprop="dateCreated"/><meta content="2022-02-17T12:52:51.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494293769134690305" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494293071118614529" itemprop="isPartOf"/><div><article aria-labelledby="id__iz7v5g3ovub id__qvavbo2goo id__2by7sy1rlez id__m9l5kbrq46 id__z1dav400ili id__donfwkntrje id__ixg86nsp9n id__2t0gjbgfxy9 id__9zgx5a3h2q id__wje0n081drq id__l9hf0l2jl id__subk41yeifo id__0pr1un0bfshl id__eoexg6bgnnw" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__donfwkntrje"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Note that the NVMe controller behaves in a perfectly spec-compliant way as far as data durability. It&#39;s just (ridiculously) slow when you ask for it. Probably a bug.</span></p></div></div></div></div></div></div></div></div></article></div></div></div></div></div></section></div></div></div></div></div></div></div></div>
  </body>
</html>
