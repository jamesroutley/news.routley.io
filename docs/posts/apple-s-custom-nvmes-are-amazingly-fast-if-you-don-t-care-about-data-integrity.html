<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://twitter.com/marcan42/status/1494213855387734019">Original</a>
    <h1>Apple&#39;s custom NVMes are amazingly fast â€“ if you don&#39;t care about data integrity</h1>
    
    <div id="readability-page-1" class="page"><div role="main"><div><div><div><div data-testid="primaryColumn"><div><div itemscope="" itemtype="https://schema.org/Collection"><meta content="Tweet with replies" itemprop="name"/><section aria-labelledby="accessible-list-459975" role="region"><div aria-label="Timeline: Conversation"><div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213855387734019" itemprop="identifier"/><meta content="1" itemprop="position"/><meta content="23" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:18.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:18.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213855387734019" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213855387734019" itemprop="mainEntityOfPage"/><div><article aria-labelledby="id__qm5px1zcv59 id__6iro0hp1d9f id__txiwberycxg id__ie3lyyk69tk id__cu6vyqz9tph id__6z1r083z67w id__jiv46oz70z id__0lkyqqznotlm id__t4lifq76sbm id__hj9etxwwsie id__i4e7i04flm id__nv3nj95thqn id__p3cbvo974gd id__p5a13c6jui" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__6z1r083z67w"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div></div><div><div><div itemprop="articleBody"><div><p><span>Well, this is unfortunate. It turns out Apple&#39;s custom NVMe drives are amazingly fast - if you don&#39;t care about data integrity.

If you do, they drop down to HDD performance. Thread.</span></p></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213859594616834" itemprop="identifier"/><meta content="2" itemprop="position"/><meta content="3" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:19.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:19.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213859594616834" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213855387734019" itemprop="isPartOf"/><div><article aria-labelledby="id__wr0gbd3an7a id__atp43fwllap id__iqu286yltk id__bx3zvljdxel id__v9jumnidn9f id__cikugu2kij id__1vu86vbbbga id__7v1yuf31cps id__qiqcz7zlpx id__3n0rtu3llu7 id__rg0j1rr8c id__yhpls4fyjog id__vc4w53f4cr id__39jwow9asvg" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__cikugu2kij"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>For a while, we&#39;ve noticed that random write performance with fsync (data integrity) on Asahi Linux (and also on Linux on T2 Macs) was terrible. As in 46 IOPS terrible. That&#39;s slower than many modern HDDs.

We thought we were missing something, since this didn&#39;t happen on macOS.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213862970707969" itemprop="identifier"/><meta content="3" itemprop="position"/><meta content="7" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:20.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:20.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213862970707969" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213859594616834" itemprop="isPartOf"/><div><article aria-labelledby="id__o2xaho8wmz id__v8fwjddtnp id__ysffepsdxxm id__qzkh0m2uqom id__qyt8qoi731 id__c6zy8bqlb5d id__cachn3tiboi id__jh1i9ipymse id__rwr6magxh5h id__m7j5kv0szck id__9r6s0j2q44l id__legcc1ob5r id__uyinn38bzqo id__42x88cdi6ry" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__c6zy8bqlb5d"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>As it turns out, macOS cheats. On Linux, fsync() will both flush writes to the drive, and ask it to flush its write cache to stable storage.

But on macOS, fsync() only flushes writes to the drive. Instead, they provide an F_FULLSYNC operation to do what fsync() does on Linux.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213865613426688" itemprop="identifier"/><meta content="4" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:21.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:21.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213865613426688" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213862970707969" itemprop="isPartOf"/><div><article aria-labelledby="id__ny1f96jizv id__g2hpzi0kvmf id__feuxcppdtxl id__6akvhaswrhy id__gp6movcktq9 id__zobi3tcel1o id__35qd6ssrj86 id__zpvf3v9v6pp id__u5yp71gshfn id__d0e0foer4hf id__kp4tmksvbad id__5mt0doow55x id__xpxb7fya1s id__xwnigjwt4le" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__zobi3tcel1o"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So effectively macOS cheats on benchmarks; fio on macOS does not give numbers comparable to Linux, and databases and other applications requiring data integrity on macOS need to special case it and use F_FULLSYNC.

How bad is it if you use F_FULLSYNC? It&#39;s bad.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213868201324546" itemprop="identifier"/><meta content="5" itemprop="position"/><meta content="4" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:21.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:21.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213868201324546" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213865613426688" itemprop="isPartOf"/><div><article aria-labelledby="id__lwtsbmzquv id__s0438ohw09 id__vff2h58ie id__djmt1huucj9 id__ko5jbpgjwqd id__dz96qu6mqwj id__4a4xr9bc2yp id__bs1ow1xpizq id__7gkhnos2dte id__1udyql7x9vkk id__2gp4twc0wuy id__4ekyuupnni2 id__ih9g4pkigjd id__m3ya9jrymeb" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__dz96qu6mqwj"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Single threaded, simple Python file rewrite test:

Macbook Air M1 (macOS):
- flushing: 46 IOPS
- not: 40000 IOPS

x86 iMac + WD SN550 1TB NVMe (Linux):
- flushing: 2000 IOPS
- not: 20000 IOPS

x86 laptop + Samsung SSD 860 EVO 500GB SATA:
- flushing: 143 IOPS
- not: 5000 IOPS</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213871149940737" itemprop="identifier"/><meta content="6" itemprop="position"/><meta content="2" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:22.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:22.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213871149940737" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213868201324546" itemprop="isPartOf"/><div><article aria-labelledby="id__c4m8z7e0kw id__gf0pacey0w id__cmbaqd0udin id__5em9ilzmy87 id__tmgpgafr5r id__xq3hvi9bhc id__41f0be8ycvo id__31oqiswfjcq id__p3pj38gz3y id__r6jbt3fp5le id__n6lqn3bld6 id__r7nzti3rs2d id__j96z3lho2w id__c81zsmsp6z6" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__xq3hvi9bhc"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So, effectively, Apple&#39;s drive is faster than all the others without cache flushes, but it is more than 3 times slower than a lowly SATA SSD at flushing its cache. Even if all you wrote is a couple of sectors. You pay a huge flush penalty if you do *any* writes.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213873993682946" itemprop="identifier"/><meta content="7" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:23.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:23.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213873993682946" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213871149940737" itemprop="isPartOf"/><div><article aria-labelledby="id__upy63g5vfo id__r1yru4fiq3f id__fkkyun3b11 id__w2kht0965k9 id__wkcslr10sk id__ob3rkzavxho id__wbk56s9epbb id__p9io1sg8cgh id__ms2g9hos2x id__ots3l8e7otc id__ybqf82mhxkk id__siqsa62zjus id__x00z9fpc2h id__txouvwgkedh" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__ob3rkzavxho"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Here, &#34;flushing&#34; on macOS means F_FULLSYNC and &#34;not&#34; means fsync(); on Linux both are fsync(), but &#34;not flushing&#34; is measured by telling Linux that the drive write cache is write-through (which stops it from issuing cache flushes).</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213876657049600" itemprop="identifier"/><meta content="8" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:24.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:24.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213876657049600" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213873993682946" itemprop="isPartOf"/><div><article aria-labelledby="id__2nb1jj7jhte id__f9w6d5xk0no id__kog09zkx6u id__vavam1u8d0i id__1sdqmjgg6to id__a9d8p8156uf id__cr6bvz6znj id__r2xwalx1ixa id__wd6spie8gqs id__wjrruhfddl id__2yq5j2p0lpw id__nkxcdwcdaz id__cnqgni20ch5 id__ej7s7jk4s5s" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__a9d8p8156uf"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Note that the numbers are filesystem-dependent (and encryption makes things more complicated); e.g. the SATA SSD numbers double on VFAT vs. my root filesystem (ext4 on LVM on dm-crypt), but the pattern is clear.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213879089737729" itemprop="identifier"/><meta content="9" itemprop="position"/><meta content="4" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:24.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:24.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213879089737729" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213876657049600" itemprop="isPartOf"/><div><article aria-labelledby="id__femszl3gonr id__t12cem0ez48 id__lgmbby6r5am id__m5avoq7gm4q id__1sqwym7i5wx id__ukz0qajil8i id__9jxu0k4kitl id__udvo262mgw id__cucetejbfbd id__rjdpnotp72r id__z9lzpp0xv5o id__nd2aqheg6y9 id__lpwc097u4q id__6m4wgq9fl0m" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__ukz0qajil8i"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>macOS doesn&#39;t even seem to try to proactively issue syncs; you can write a file on macOS, fsync() it, wait 5 seconds, issue a hard reboot (e.g. via USB-PD command), and the data is gone. That&#39;s pretty bad.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213881509875712" itemprop="identifier"/><meta content="10" itemprop="position"/><meta content="5" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:25.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:25.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213881509875712" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213879089737729" itemprop="isPartOf"/><div><article aria-labelledby="id__k965pmybei id__wtuau8ua4mb id__6bldfe71zd id__z1iw88umjzh id__z2xh9r8dtnm id__qn0819mllw id__8bvz2afdu5n id__t3zpjbev34 id__hismutl5eg id__htx5c5vtrde id__ljthnafrluj id__y8uavabklvs id__6cj4qnwpfq5 id__vvb52bi4za" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__qn0819mllw"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Of course, in normal usage, this is basically never an issue on laptops; given the right software hooks, they should never run out of power before the OS has a chance to issue a disk flush command. But it certainly is for desktops. And it&#39;s a bit fragile re: panics and such.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213883976101888" itemprop="identifier"/><meta content="11" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:25.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:25.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213883976101888" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213881509875712" itemprop="isPartOf"/><div><article aria-labelledby="id__wyh71w6usm id__00aypxr22kxqq id__ugxqup58ibd id__uf5s75du5fs id__dxuv860e21j id__s43my740hko id__n7xnweodm69 id__z9rhcyth3z id__8lcq5q30ndv id__o9o4xdnetv id__8rk69kwcuc9 id__jew69x77k4h id__8cjbg6r37a id__a1mi1ezy1zr" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__s43my740hko"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Unfortunately, this manifests itself as quite visible issues on Linux. For example, apt-get on Asahi Linux is noticeably slow. Making fsync() not really flush on macOS is not fair; lots of portable software is written to assume fsync() means your data is safe.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213886928908288" itemprop="identifier"/><meta content="12" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:26.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:26.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213886928908288" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213883976101888" itemprop="isPartOf"/><div><article aria-labelledby="id__63ol58t70r4 id__t60bu05t89 id__xd7un9frkd id__0zjjjnhmw2ni id__etvza07cljj id__1u92y8cdbe9 id__fd14ns9orz id__djlj5biqwo id__o1prpbaflc id__envwvaxalw id__clt3e4s2i7q id__vw5kpm7ssa id__30eg3d0kv2u id__62i4ayps98u" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__1u92y8cdbe9"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Our current thinking is we&#39;re going to add a knob to the NVMe driver to defer flush requests up to a maximum time of e.g. 1 second. That would ensure that a hard shutdown never loses you more than 1 second of data, which is better than what macOS can claim right now.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213889646796802" itemprop="identifier"/><meta content="13" itemprop="position"/><meta content="3" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:27.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:27.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213889646796802" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213886928908288" itemprop="isPartOf"/><div><article aria-labelledby="id__oihvbjw9zy9 id__nh6i4jw21y id__w9vx1kfdcck id__q5wrkd3u5s id__fca2lr6c7mv id__sgw3zgpci6 id__9bx90040zii id__pdnqcjz67s id__l3dsjaf2dwg id__6ajz5xy425r id__klvmjv5k1f id__jio6quw3pr id__a6y3qa2far id__9714v9hvhjh" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__sgw3zgpci6"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Alas, that&#39;s still not quite safe. Not flushing means we cannot guarantee ordering of writes, which means you could end up with actual data corruption in e.g. a database, not just data loss. There&#39;s no good way around this other than doing full flushes.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494213892331163649" itemprop="identifier"/><meta content="14" itemprop="position"/><meta content="5" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:35:27.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:35:27.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494213892331163649" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213889646796802" itemprop="isPartOf"/><div><article aria-labelledby="id__outohq23pt id__e3nf8vm7ejh id__3mvkij60w61 id__7tlljjgst3n id__xrvnnqky1k id__inbcdx76kqh id__fgoj304o4ku id__9h5xu01fq45 id__4zlsq7qzzxa id__zds4qeujr8i id__juosmzscmb8 id__64j838x61y id__lcjrwcpcbpk id__dtg9uakgige" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__inbcdx76kqh"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So the unfortunate conclusion is that if you&#39;re e.g. running a transactional database on Apple hardware, and you need to be able to survive a hard poweroff without data corruption, you&#39;re never going to get more than ~46 TPS.

Unless Apple improves their ANS firmware to fix this.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494215160218939392" itemprop="identifier"/><meta content="15" itemprop="position"/><meta content="5" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:40:30.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:40:30.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494215160218939392" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494213892331163649" itemprop="isPartOf"/><div><article aria-labelledby="id__c4zw6mkkig id__c6mv3y4s55 id__ztd6nj70i3j id__462xbu0n78m id__7v0c5szcfsa id__91puw1hls44 id__livf24c994f id__si4ttx9tj2 id__nndd06v4fdl id__bzudaazdzys id__ghx3ghl57kg id__pxe60fm5kws id__hs6paahg5a7 id__pt5coxn77i" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__91puw1hls44"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>And for what it&#39;s worth, I inadvertently triggered a data consistency issue in macOS while testing this. Before running any tests I had GarageBand open. I closed it without saving the open project. After the first hard reboot later, it tried to reopen it and threw up an error.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494215321125007362" itemprop="identifier"/><meta content="16" itemprop="position"/><meta content="2" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T07:41:08.000Z" itemprop="dateCreated"/><meta content="2022-02-17T07:41:08.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494215321125007362" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494215160218939392" itemprop="isPartOf"/><div><article aria-labelledby="id__k6if7r7f2mp id__76gns5f4lx8 id__l127hfrrdrj id__cp0h3l668xi id__mexfyvllj6 id__vq67a9fm5ra id__3n9eefu1crd id__t6a80gdhpd8 id__f0wzu9bfstc id__hk295vtty6j id__ezsuolkjobi id__ckdgfk0wa6 id__4mymons5se3 id__wuh2cgn15le" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__vq67a9fm5ra"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>So I guess the unsaved project file got (partially?) deleted, but not the state that tells it to reopen the currently open file on startup.

Data consistency matters.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494221053220257795" itemprop="identifier"/><meta content="17" itemprop="position"/><meta content="10" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T08:03:55.000Z" itemprop="dateCreated"/><meta content="2022-02-17T08:03:55.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494221053220257795" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494215321125007362" itemprop="isPartOf"/><div><article aria-labelledby="id__lewtip4uzxn id__6x1payqzfdn id__5bxonxfll7b id__2cqcryvfp06 id__61or9161td id__nnq63rgx74p id__tuxawxdvqn7 id__qy2avs1tqd id__925lj6lnuj7 id__8x0nf45kik8 id__sm59qmlrts id__z6s9o07f9 id__0rfn1j4g7r1 id__3iypda35jtf" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__nnq63rgx74p"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Update: tested on the Mac Mini by pulling the plug (which is a &#34;normal&#34; case; the USB-PD thing was a bit special). Still lost seconds of fsync()ed data. There is no (working) last-gasp flush mechanism.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494255642202484743" itemprop="identifier"/><meta content="18" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:21:21.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:21:21.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494255642202484743" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494221053220257795" itemprop="isPartOf"/><div><article aria-labelledby="id__v5nrv75tlrb id__qysp71ui82 id__vdpfm3ym3sn id__bo60u9wv31n id__ibgdfq3qj79 id__8j1o5myytmi id__6hdq3bldkdg id__uukzx3rkq1e id__90abgdba1je id__7ttulcy3gxh id__a8gpc53m9bg id__iwjhq2nt1b id__kd96dbn3zz id__faq4kmnu8o" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__8j1o5myytmi"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Further testing: doing this on FAT32 (to avoid APFS write amplification, which is a separate problem...) doesn&#39;t help with the IOPS on flush, but then I can look at powermetrics bandwidth stats to see what NVMe is doing.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494255645612474369" itemprop="identifier"/><meta content="19" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:21:22.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:21:22.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494255645612474369" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494255642202484743" itemprop="isPartOf"/><div><article aria-labelledby="id__pnvi2c5wyp id__pcc9g0pf6t id__yz10856a35 id__t3wt7ft905 id__ute2247rl3 id__amfcgmsv70k id__h5dxv7fmfcm id__iq8ja3tj73p id__0cn7olr8bi95 id__xkfqz2j51dk id__ykbkwvd8zak id__9gp7h2bo36 id__x4hzypp01e id__w2t7iezdum9" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__amfcgmsv70k"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>Artificially throttled ~30 IOPS without full cache flushes, I get 93.52 ops/s 397.77 KBytes/s disk IO, which is reasonable, and:

ANS2 RD                         : 0.328 MB/s
ANS2 WR                         : 0.399 MB/s

That&#39;s NVMe controller DRAM bandwidth. Reasonable.</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494255649026625537" itemprop="identifier"/><meta content="20" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:21:23.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:21:23.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494255649026625537" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494255645612474369" itemprop="isPartOf"/><div><article aria-labelledby="id__a4jha33d03u id__f75pn5xjuim id__b5qzz86rmka id__z6p0jjyi0dp id__nwfhhdzoxi id__i1ru2j54yzr id__qemav9c5k1q id__ropkagvjn5j id__745c8j1amvd id__w9yvblcqtha id__6cjgydpkxib id__4choslvw3r4 id__eydbw5qjnst id__dhxlmx0vojh" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__i1ru2j54yzr"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>But doing flushes, this jumps to:

ANS2 RD                         : 6.248 MB/s
ANS2 WR                         : 9.909 MB/s

So that NVMe controller is doing *something* memory-intensive on flush commands. Maybe it does a linear scan over a large cache hashtable?</span></p></div></div></div></div></div></div></div></div></article></div></div></div><div><div itemprop="hasPart" itemscope="" itemtype="https://schema.org/SocialMediaPosting"><meta content="1494256049150640129" itemprop="identifier"/><meta content="21" itemprop="position"/><meta content="1" itemprop="commentCount"/><meta content="" itemprop="contentRating"/><meta content="2022-02-17T10:22:58.000Z" itemprop="dateCreated"/><meta content="2022-02-17T10:22:58.000Z" itemprop="datePublished"/><meta content="https://twitter.com/marcan42/status/1494256049150640129" itemprop="url"/><meta content="https://twitter.com/marcan42/status/1494255649026625537" itemprop="isPartOf"/><div><article aria-labelledby="id__wnbjyvihtz id__176y9s7q0ro id__g3h3jlw4pb id__azxy8ia92gb id__ilhvm5xbdbe id__fg1c1ra9bj id__kde7k0dukza id__vyi2evt9i4 id__0djoktfak2c id__uv196cicfc id__69a5xjmcvta id__ax272zexva id__ks27luxcp3 id__9zytot4nao" role="article" data-testid="tweet"><div><div><div><div><div><div><div><div id="id__fg1c1ra9bj"><div><div><div><div><a href="http://jimkang.com/marcan42" role="link"><div><div><div><div aria-label=""><p><img alt="" draggable="true" src="https://pbs.twimg.com/profile_images/642190731122114560/oXAYC93Z_400x400.png"/></p></div></div></div></div></a></div></div></div></div></div></div></div></div><div><div><div><div itemprop="articleBody"><p><span>I can get these stats because the NVMe controller is integrated into the SoC and &#34;drive cache&#34; is just normal memory (it&#39;s unified just like GPU memory), and Apple have very good instrumentation of things like DRAM bandwidth utilization from different SoC agents.</span></p></div></div></div></div></div></div></div></div></article></div></div></div></div></div></section></div></div></div></div></div></div></div></div>
  </body>
</html>
