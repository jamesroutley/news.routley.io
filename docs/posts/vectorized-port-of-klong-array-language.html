<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/briangu/klongpy">Original</a>
    <h1>Vectorized port of Klong array language</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/briangu/klongpy/workflows/Unit%20Tests/badge.svg"><img src="https://github.com/briangu/klongpy/workflows/Unit%20Tests/badge.svg" alt="Unit Tests"/></a></p>

<p dir="auto">KlongPy is a vectorized port of <a href="https://t3x.org/klong" rel="nofollow">Klong</a>, making it a blazingly fast <a href="https://en.wikipedia.org/wiki/Array_programming" rel="nofollow">array language</a> that supports direct Python integration.</p>
<p dir="auto"><a href="https://numpy.org/" rel="nofollow">NumPy</a> is used as the runtime target because it itself is an <a href="https://analyzethedatanotthedrivel.org/2018/03/31/NumPy-another-iverson-ghost/" rel="nofollow">Iverson Ghost</a>, or rather a descendent of APL, making the mapping from Klong to NumPy <em>relatively</em> straightforward.</p>
<p dir="auto">Using NumPy also means that, via <a href="https://github.com/cupy/cupy">CuPy</a>, both CPU and GPU backends are supported (where possible, see Status section).</p>
<p dir="auto">Klong was created by Nils M Holm and he has also written a <a href="https://t3x.org/klong/book.html" rel="nofollow">Klong Book</a>.</p>

<ul dir="auto">
<li><a href="https://github.com/briangu/aoc/tree/main/22">Advent Of Code &#39;22</a></li>
<li><a href="https://github.com/briangu/kdfs">Example Ticker Plant with streaming and dataframes</a></li>
</ul>

<p dir="auto">KlongPy brings together the Klong terse array language notation with the performance of NumPy.  I wanted to use Klong but I also wanted it to be a fast as possible.  Bonus is the ability to mix Klong with Python libraries making it easy to pick and choose the tools as appropriate.</p>
<p dir="auto">Here&#39;s simple example of mixing Python and KlongPy to compute average of a 1B entry array.</p>
<p dir="auto">To get an idea of what the following examples are about, let&#39;s first look at how average is computed in Klong. Assume &#39;a&#39; represents an array, and we want to compute the average of &#39;a&#39;.</p>

<p dir="auto">This directly translates into (from right to left): length of x (#a) divides sum over x (+/a).</p>
<p dir="auto">Now, with that in hand, we can try it in the REPL.  First we&#39;ll make a function called &#39;avg&#39; and then find the average over the range 0..99 inclusive (!100).  Note, functions in Klong require the parameter names to be x, y, and z.</p>
<div data-snippet-clipboard-copy-content="Welcome to KlongPy REPL
author: Brian Guarraci
repo  : https://github.com/briangu/klongpy
crtl-c to quit

?&gt; avg::{(+/x)%#x}
:monad
?&gt; avg(!100)
49.49999999999999"><pre><code>Welcome to KlongPy REPL
author: Brian Guarraci
repo  : https://github.com/briangu/klongpy
crtl-c to quit

?&gt; avg::{(+/x)%#x}
:monad
?&gt; avg(!100)
49.49999999999999
</code></pre></div>
<p dir="auto">Now let&#39;s time it using the REPL system command ]T, which uses the Python timeit facility.  First, we&#39;ll run it once and see it takes about 374us, then we&#39;ll run it 100 times.</p>
<div data-snippet-clipboard-copy-content="?&gt; ]T avg(!100)
0.0003741057589650154
?&gt; ]T:100 avg(!100)
0.01385202500387095"><pre><code>?&gt; ]T avg(!100)
0.0003741057589650154
?&gt; ]T:100 avg(!100)
0.01385202500387095
</code></pre></div>
<p dir="auto">Let&#39;s use Klong from Python:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from klongpy import KlongInterpreter

# instantiate the KlongPy interpeter
klong = KlongInterpreter()

# define average function in Klong (Note the &#39;+/&#39; (sum over) uses np.add.reduce under the hood)
klong(&#39;avg::{(+/x)%#x}&#39;)

# create a billion random uniform values [0,1)
data = np.random.rand(10**9)

# reference the &#39;avg&#39; function in Klong interpeter and call it directly from Python.
r = klong[&#39;avg&#39;](data)

print(f&#34;avg={np.round(r,6)}&#34;)"><pre><span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>

<span># instantiate the KlongPy interpeter</span>
<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()

<span># define average function in Klong (Note the &#39;+/&#39; (sum over) uses np.add.reduce under the hood)</span>
<span>klong</span>(<span>&#39;avg::{(+/x)%#x}&#39;</span>)

<span># create a billion random uniform values [0,1)</span>
<span>data</span> <span>=</span> <span>np</span>.<span>random</span>.<span>rand</span>(<span>10</span><span>**</span><span>9</span>)

<span># reference the &#39;avg&#39; function in Klong interpeter and call it directly from Python.</span>
<span>r</span> <span>=</span> <span>klong</span>[<span>&#39;avg&#39;</span>](<span>data</span>)

<span>print</span>(<span>f&#34;avg=<span><span>{</span><span>np</span>.<span>round</span>(<span>r</span>,<span>6</span>)<span>}</span></span>&#34;</span>)</pre></div>
<p dir="auto">Let&#39;s compare CPU vs GPU backends:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import time
from klongpy.backend import np
from klongpy import KlongInterpreter

klong = KlongInterpreter()
klong(&#39;avg::{(+/x)%#x}&#39;)

data = np.random.rand(10**9)

start = time.perf_counter_ns()
r = klong[&#39;avg&#39;](data)
stop = time.perf_counter_ns()

print(f&#34;avg={np.round(r,6)} in {round((stop - start) / (10**9), 6)} seconds&#34;)"><pre><span>import</span> <span>time</span>
<span>from</span> <span>klongpy</span>.<span>backend</span> <span>import</span> <span>np</span>
<span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>

<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
<span>klong</span>(<span>&#39;avg::{(+/x)%#x}&#39;</span>)

<span>data</span> <span>=</span> <span>np</span>.<span>random</span>.<span>rand</span>(<span>10</span><span>**</span><span>9</span>)

<span>start</span> <span>=</span> <span>time</span>.<span>perf_counter_ns</span>()
<span>r</span> <span>=</span> <span>klong</span>[<span>&#39;avg&#39;</span>](<span>data</span>)
<span>stop</span> <span>=</span> <span>time</span>.<span>perf_counter_ns</span>()

<span>print</span>(<span>f&#34;avg=<span><span>{</span><span>np</span>.<span>round</span>(<span>r</span>,<span>6</span>)<span>}</span></span> in <span><span>{</span><span>round</span>((<span>stop</span> <span>-</span> <span>start</span>) <span>/</span> (<span>10</span><span>**</span><span>9</span>), <span>6</span>)<span>}</span></span> seconds&#34;</span>)</pre></div>
<p dir="auto">Run (CPU)</p>
<div data-snippet-clipboard-copy-content="$ python3 tests/perf_avg.py
avg=0.5 in 0.16936 seconds"><pre><code>$ python3 tests/perf_avg.py
avg=0.5 in 0.16936 seconds
</code></pre></div>
<p dir="auto">Run (GPU)</p>
<div data-snippet-clipboard-copy-content="$ USE_GPU=1 python3 tests/perf_avg.py
avg=0.500015 in 0.027818 seconds"><pre><code>$ USE_GPU=1 python3 tests/perf_avg.py
avg=0.500015 in 0.027818 seconds
</code></pre></div>

<p dir="auto">KlongPy supports direct Python integration, making it easy to mix Klong with Python and use it in the most suitable scenarios.  For example, KlongPy can be part of an ML/Pandas workflow or be part of the website backend.</p>
<p dir="auto">Extending KlongPy with custom functions and moving data in / out of the KlongPy interpeter is easy since the interpreter operates as a dictionary. The dictionary contents are the current KlongPy state.</p>
<p dir="auto">Data generated elsewhere can be set in KlongPy and seamlessly accessed and processed via Klong language.  Also, Python lambdas or functions may be exposed directly as Klong functions, allowing easy extensions to the Klong language.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-function-example" aria-hidden="true" href="#function-example"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Function example</h2>
<p dir="auto">Call a Python function from Klong:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from klongpy import KlongInterpreter
klong = KlongInterpreter()
klong[&#39;f&#39;] = lambda x, y, z: x*1000 + y - z
r = klong(&#39;f(3; 10; 20)&#39;)
assert r == 2990"><pre><span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>
<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
<span>klong</span>[<span>&#39;f&#39;</span>] <span>=</span> <span>lambda</span> <span>x</span>, <span>y</span>, <span>z</span>: <span>x</span><span>*</span><span>1000</span> <span>+</span> <span>y</span> <span>-</span> <span>z</span>
<span>r</span> <span>=</span> <span>klong</span>(<span>&#39;f(3; 10; 20)&#39;</span>)
<span>assert</span> <span>r</span> <span>==</span> <span>2990</span></pre></div>
<p dir="auto">and vice versa, you can call a Klong function from Python:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from klongpy import KlongInterpreter
klong = KlongInterpreter()
klong(&#34;f::{(x*1000) + y - z}&#34;)
r = klong[&#39;f&#39;](3, 10, 20)
assert r == 2990"><pre><span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>
<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
<span>klong</span>(<span>&#34;f::{(x*1000) + y - z}&#34;</span>)
<span>r</span> <span>=</span> <span>klong</span>[<span>&#39;f&#39;</span>](<span>3</span>, <span>10</span>, <span>20</span>)
<span>assert</span> <span>r</span> <span>==</span> <span>2990</span></pre></div>
<p dir="auto">As you can see, it&#39;s easy to interop with Python and Klong allowing the best tool for the job.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-data-example" aria-hidden="true" href="#data-example"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Data example</h2>
<p dir="auto">Since the Klong interpreter context is basically a dictionary, you can store values there for access in Klong:</p>
<div dir="auto" data-snippet-clipboard-copy-content="data = np.arange(10*9)
klong[&#39;data&#39;] = data
r = klong(&#39;1+data&#39;)
assert r == 1 + data"><pre><span>data</span> <span>=</span> <span>np</span>.<span>arange</span>(<span>10</span><span>*</span><span>9</span>)
<span>klong</span>[<span>&#39;data&#39;</span>] <span>=</span> <span>data</span>
<span>r</span> <span>=</span> <span>klong</span>(<span>&#39;1+data&#39;</span>)
<span>assert</span> <span>r</span> <span>==</span> <span>1</span> <span>+</span> <span>data</span></pre></div>
<p dir="auto">Variables may be directly retrieved from KlongPy context:</p>
<div dir="auto" data-snippet-clipboard-copy-content="klong(&#39;Q::1+data&#39;)
Q = klong[&#39;Q&#39;]
print(Q)"><pre><span>klong</span>(<span>&#39;Q::1+data&#39;</span>)
<span>Q</span> <span>=</span> <span>klong</span>[<span>&#39;Q&#39;</span>]
<span>print</span>(<span>Q</span>)</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-python-library-access" aria-hidden="true" href="#python-library-access"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Python library access</h2>
<p dir="auto">In order to simplify Klong development, Python functions can be easily added to support common operations:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from datetime import datetime
from klongpy import KlongInterpreter
klong = KlongInterpreter()
klong[&#39;strptime&#39;] = lambda x: datetime.strptime(x, &#34;%d %B, %Y&#34;)
klong(&#34;&#34;&#34;
    a::strptime(&#34;21 June, 2018&#34;)
    .p(a)
    d:::{};d,&#34;timestamp&#34;,a
    .p(d)
&#34;&#34;&#34;)"><pre><span>from</span> <span>datetime</span> <span>import</span> <span>datetime</span>
<span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>
<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
<span>klong</span>[<span>&#39;strptime&#39;</span>] <span>=</span> <span>lambda</span> <span>x</span>: <span>datetime</span>.<span>strptime</span>(<span>x</span>, <span>&#34;%d %B, %Y&#34;</span>)
<span>klong</span>(<span>&#34;&#34;&#34;</span>
<span>    a::strptime(&#34;21 June, 2018&#34;)</span>
<span>    .p(a)</span>
<span>    d:::{};d,&#34;timestamp&#34;,a</span>
<span>    .p(d)</span>
<span>&#34;&#34;&#34;</span>)</pre></div>
<p dir="auto">prints the following dictionary to the console:</p>
<div data-snippet-clipboard-copy-content="2018-06-21 00:00:00
{&#39;timestamp&#39;: datetime.datetime(2018, 6, 21, 0, 0)}"><pre><code>2018-06-21 00:00:00
{&#39;timestamp&#39;: datetime.datetime(2018, 6, 21, 0, 0)}
</code></pre></div>
<p dir="auto">You can go one step further and call back into Python from Klong with the result:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from datetime import datetime
from klongpy import KlongInterpreter
klong = KlongInterpreter()
klong[&#39;strptime&#39;] = lambda x: datetime.strptime(x, &#34;%d %B, %Y&#34;)
klong[&#39;myprint&#39;] = lambda x: print(f&#34;called from KlongPy: {x}&#34;)
klong(&#34;&#34;&#34;
    a::strptime(&#34;21 June, 2018&#34;)
    myprint(a)
    d:::{};d,&#34;timestamp&#34;,a
    myprint(d)
&#34;&#34;&#34;)"><pre><span>from</span> <span>datetime</span> <span>import</span> <span>datetime</span>
<span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>
<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
<span>klong</span>[<span>&#39;strptime&#39;</span>] <span>=</span> <span>lambda</span> <span>x</span>: <span>datetime</span>.<span>strptime</span>(<span>x</span>, <span>&#34;%d %B, %Y&#34;</span>)
<span>klong</span>[<span>&#39;myprint&#39;</span>] <span>=</span> <span>lambda</span> <span>x</span>: <span>print</span>(<span>f&#34;called from KlongPy: <span><span>{</span><span>x</span><span>}</span></span>&#34;</span>)
<span>klong</span>(<span>&#34;&#34;&#34;</span>
<span>    a::strptime(&#34;21 June, 2018&#34;)</span>
<span>    myprint(a)</span>
<span>    d:::{};d,&#34;timestamp&#34;,a</span>
<span>    myprint(d)</span>
<span>&#34;&#34;&#34;</span>)</pre></div>
<p dir="auto">outputs</p>
<div data-snippet-clipboard-copy-content="called from KlongPy: 2018-06-21 00:00:00
called from KlongPy: {&#39;timestamp&#39;: datetime.datetime(2018, 6, 21, 0, 0)}"><pre><code>called from KlongPy: 2018-06-21 00:00:00
called from KlongPy: {&#39;timestamp&#39;: datetime.datetime(2018, 6, 21, 0, 0)}
</code></pre></div>

<p dir="auto">This a work in progress, but it&#39;s very interesting to think about what DataFrames look like in Klong since they are basically a dictionary of columns.</p>
<p dir="auto">For now, the following works where we convert a DataFrame into a dictionary of columns:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from klongpy import KlongInterpreter
import pandas as pd
import numpy as np

data = {&#39;Name&#39;: [&#39;Alice&#39;, &#39;Bob&#39;, &#39;Charlie&#39;, &#39;David&#39;],
        &#39;Age&#39;: [25, 30, 35, 40]}
df = pd.DataFrame(data)

klong = KlongInterpreter()
klong[&#39;df&#39;] = {col: np.array(df[col]) for col in df.columns}
klong(&#39;df?&#34;Name&#34;&#39;) # ==&gt; [&#39;Alice&#39;, &#39;Bob&#39;, &#39;Charlie&#39;, &#39;David&#39;]
klong(&#39;df?&#34;Age&#34;&#39;)  # ==&gt; [25, 30, 35, 40]"><pre><span>from</span> <span>klongpy</span> <span>import</span> <span>KlongInterpreter</span>
<span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
<span>import</span> <span>numpy</span> <span>as</span> <span>np</span>

<span>data</span> <span>=</span> {<span>&#39;Name&#39;</span>: [<span>&#39;Alice&#39;</span>, <span>&#39;Bob&#39;</span>, <span>&#39;Charlie&#39;</span>, <span>&#39;David&#39;</span>],
        <span>&#39;Age&#39;</span>: [<span>25</span>, <span>30</span>, <span>35</span>, <span>40</span>]}
<span>df</span> <span>=</span> <span>pd</span>.<span>DataFrame</span>(<span>data</span>)

<span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
<span>klong</span>[<span>&#39;df&#39;</span>] <span>=</span> {<span>col</span>: <span>np</span>.<span>array</span>(<span>df</span>[<span>col</span>]) <span>for</span> <span>col</span> <span>in</span> <span>df</span>.<span>columns</span>}
<span>klong</span>(<span>&#39;df?&#34;Name&#34;&#39;</span>) <span># ==&gt; [&#39;Alice&#39;, &#39;Bob&#39;, &#39;Charlie&#39;, &#39;David&#39;]</span>
<span>klong</span>(<span>&#39;df?&#34;Age&#34;&#39;</span>)  <span># ==&gt; [25, 30, 35, 40]</span></pre></div>

<p dir="auto">The Klong language is simple, so the overhead is low.  The bulk of the compute time will likely be spent in NumPy doing actual work.</p>
<p dir="auto">Here&#39;s a contrived rough benchmark to show the magnitude differences between Python, KlongPy (CPU + GPU) and Numpy (CPU).</p>
<p dir="auto"><strong>Spoiler</strong>: GPU-backed KlongPy is about 790x faster than naive Python and 36x faster than NumPy-backed KlongPy.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-python" aria-hidden="true" href="#python"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Python</h3>
<div dir="auto" data-snippet-clipboard-copy-content="def python_vec(number=100):
    r = timeit.timeit(lambda: [2 * (1 + x) for x in range(10000000)], number=number)
    return r/number"><pre><span>def</span> <span>python_vec</span>(<span>number</span><span>=</span><span>100</span>):
    <span>r</span> <span>=</span> <span>timeit</span>.<span>timeit</span>(<span>lambda</span>: [<span>2</span> <span>*</span> (<span>1</span> <span>+</span> <span>x</span>) <span>for</span> <span>x</span> <span>in</span> <span>range</span>(<span>10000000</span>)], <span>number</span><span>=</span><span>number</span>)
    <span>return</span> <span>r</span><span>/</span><span>number</span></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-klongpy-1" aria-hidden="true" href="#klongpy-1"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>KlongPy</h3>
<div dir="auto" data-snippet-clipboard-copy-content="# NumPy and CuPy (CuPy is enabled via USE_GPU=1 environment variable
def klong_vec(number=100):
    klong = KlongInterpreter()
    r = timeit.timeit(lambda: klong(&#34;2*1+!10000000&#34;), number=number)
    return r/number"><pre><span># NumPy and CuPy (CuPy is enabled via USE_GPU=1 environment variable</span>
<span>def</span> <span>klong_vec</span>(<span>number</span><span>=</span><span>100</span>):
    <span>klong</span> <span>=</span> <span>KlongInterpreter</span>()
    <span>r</span> <span>=</span> <span>timeit</span>.<span>timeit</span>(<span>lambda</span>: <span>klong</span>(<span>&#34;2*1+!10000000&#34;</span>), <span>number</span><span>=</span><span>number</span>)
    <span>return</span> <span>r</span><span>/</span><span>number</span></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-numpy-explicit-usage" aria-hidden="true" href="#numpy-explicit-usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>NumPy (explicit usage)</h3>
<div dir="auto" data-snippet-clipboard-copy-content="def NumPy_vec(number=100):
    r = timeit.timeit(lambda: np.multiply(np.add(np.arange(10000000), 1), 2), number=number)
    return r/number"><pre><span>def</span> <span>NumPy_vec</span>(<span>number</span><span>=</span><span>100</span>):
    <span>r</span> <span>=</span> <span>timeit</span>.<span>timeit</span>(<span>lambda</span>: <span>np</span>.<span>multiply</span>(<span>np</span>.<span>add</span>(<span>np</span>.<span>arange</span>(<span>10000000</span>), <span>1</span>), <span>2</span>), <span>number</span><span>=</span><span>number</span>)
    <span>return</span> <span>r</span><span>/</span><span>number</span></pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-results" aria-hidden="true" href="#results"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Results</h2>
<h3 tabindex="-1" dir="auto"><a id="user-content-cpu-amd-ryzen-9-7950x" aria-hidden="true" href="#cpu-amd-ryzen-9-7950x"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>CPU (AMD Ryzen 9 7950x)</h3>
<div data-snippet-clipboard-copy-content="$ python3 tests/perf_vector.py
Python: 0.369111s
KlongPy USE_GPU=None: 0.017946s
Numpy: 0.017896s
Python / KlongPy =&gt; 20.568334
Numpy / KlongPy =&gt; 0.997245"><pre><code>$ python3 tests/perf_vector.py
Python: 0.369111s
KlongPy USE_GPU=None: 0.017946s
Numpy: 0.017896s
Python / KlongPy =&gt; 20.568334
Numpy / KlongPy =&gt; 0.997245
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-gpu-same-cpu-w-nvidia-geforce-rtx-3090" aria-hidden="true" href="#gpu-same-cpu-w-nvidia-geforce-rtx-3090"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>GPU (Same CPU w/ NVIDIA GeForce RTX 3090)</h3>
<div data-snippet-clipboard-copy-content="$ USE_GPU=1 python3 tests/perf_vector.py
Python: 0.364893s
KlongPy USE_GPU=1: 0.000461s
NumPy: 0.017053s
Python / KlongPy =&gt; 790.678069
Numpy / KlongPy =&gt; 36.951443"><pre><code>$ USE_GPU=1 python3 tests/perf_vector.py
Python: 0.364893s
KlongPy USE_GPU=1: 0.000461s
NumPy: 0.017053s
Python / KlongPy =&gt; 790.678069
Numpy / KlongPy =&gt; 36.951443
</code></pre></div>

<h3 tabindex="-1" dir="auto"><a id="user-content-cpu" aria-hidden="true" href="#cpu"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>CPU</h3>

<h3 tabindex="-1" dir="auto"><a id="user-content-gpu-support" aria-hidden="true" href="#gpu-support"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>GPU support</h3>
<div data-snippet-clipboard-copy-content="Choose your CuPy prebuilt binary or from source.  Note, the ROCM support for CuPy is experimental and likely will have issues.

&#39;cupy&#39; =&gt; build from source
&#39;cuda12x&#39; =&gt; &#34;cupy-cuda12x&#34;
&#39;cuda11x&#39; =&gt; &#34;cupy-cuda11x&#34;
&#39;cuda111&#39; =&gt; &#34;cupy-cuda111&#34;
&#39;cuda110&#39; =&gt; &#34;cupy-cuda110&#34;
&#39;cuda102&#39; =&gt; &#34;cupy-cuda102&#34;
&#39;rocm-5-0&#39; =&gt; &#34;cupy-rocm-5-0&#34;
&#39;rocm-4-3&#39; =&gt; &#34;cupy-rocm-4-3&#34;

$ pip3 install klongpy[cupy]"><pre><code>Choose your CuPy prebuilt binary or from source.  Note, the ROCM support for CuPy is experimental and likely will have issues.

&#39;cupy&#39; =&gt; build from source
&#39;cuda12x&#39; =&gt; &#34;cupy-cuda12x&#34;
&#39;cuda11x&#39; =&gt; &#34;cupy-cuda11x&#34;
&#39;cuda111&#39; =&gt; &#34;cupy-cuda111&#34;
&#39;cuda110&#39; =&gt; &#34;cupy-cuda110&#34;
&#39;cuda102&#39; =&gt; &#34;cupy-cuda102&#34;
&#39;rocm-5-0&#39; =&gt; &#34;cupy-rocm-5-0&#34;
&#39;rocm-4-3&#39; =&gt; &#34;cupy-rocm-4-3&#34;

$ pip3 install klongpy[cupy]
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-everything" aria-hidden="true" href="#everything"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Everything</h3>
<div data-snippet-clipboard-copy-content="$ pip3 install klongpy[cupy,repl]"><pre><code>$ pip3 install klongpy[cupy,repl]
</code></pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-develop" aria-hidden="true" href="#develop"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Develop</h3>
<div data-snippet-clipboard-copy-content="$ git clone https://github.com/briangu/klongpy.git
$ cd klongpy
$ python3 setup.py develop"><pre><code>$ git clone https://github.com/briangu/klongpy.git
$ cd klongpy
$ python3 setup.py develop
</code></pre></div>

<p dir="auto">KlongPy has a REPL similar to Klong&#39;s REPL.</p>
<div data-snippet-clipboard-copy-content="$ pip3 install klongpy[repl]
$ rlwrap kgpy

Welcome to KlongPy REPL
author: Brian Guarraci
repo  : https://github.com/briangu/klongpy
crtl-c to quit

?&gt; 1+1
2
&gt;? &#34;hello, world!&#34;
hello, world!
?&gt; prime::{&amp;/x!:\2+!_x^1%2}
:monad
?&gt; prime(4)
0
?&gt; prime(251)
1
?&gt; ]T prime(251)
0.0005430681630969048"><pre><code>$ pip3 install klongpy[repl]
$ rlwrap kgpy

Welcome to KlongPy REPL
author: Brian Guarraci
repo  : https://github.com/briangu/klongpy
crtl-c to quit

?&gt; 1+1
2
&gt;? &#34;hello, world!&#34;
hello, world!
?&gt; prime::{&amp;/x!:\2+!_x^1%2}
:monad
?&gt; prime(4)
0
?&gt; prime(251)
1
?&gt; ]T prime(251)
0.0005430681630969048
</code></pre></div>
<p dir="auto">Read about the <a href="https://t3x.org/klong/prime.html" rel="nofollow">prime example here</a>.</p>

<p dir="auto">KlongPy aims to be a complete implementation of klong.  It currently passes all of the integration tests provided by klong.</p>
<p dir="auto">Since CuPy is <a href="https://docs.cupy.dev/en/stable/user_guide/difference.html" rel="nofollow">not 100% compatible with NumPy</a>, there are currently some gaps in KlongPy between the two backends.  Notably, strings are supported in CuPy arrays so KlongPy GPU support currently is limited to math.</p>
<p dir="auto">Primary ongoing work includes:</p>
<ul dir="auto">
<li>Actively switch between CuPy and NumPy when incompatibilities are present
<ul dir="auto">
<li>Work on CuPy kernels is in this branch: _cupy_reduce_kernels</li>
</ul>
</li>
<li>Additional syntax error help</li>
<li>Additional tests to
<ul dir="auto">
<li>ensure proper vectorization</li>
<li>increase Klong grammar coverage</li>
</ul>
</li>
<li>Make REPL (kgpy) compatible with original Klong (kg) REPL</li>
</ul>

<p dir="auto">The main difference between Klong and KlongPy is that KlongPy doesn&#39;t infinite precision because it&#39;s backed by NumPy which is restricted to doubles.</p>



<p dir="auto">The following operators are yet to be used:</p>


<p dir="auto">HUGE thanks to Nils M Holm for his work on Klong and providing the foundations for this interesting project.</p>
</article>
          </div></div>
  </body>
</html>
