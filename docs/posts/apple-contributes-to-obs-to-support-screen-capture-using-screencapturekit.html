<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/obsproject/obs-studio/pull/5875/commits/551c54ba8440fcdf4cdc221f5d50a30a68b87a7e">Original</a>
    <h1>Apple contributes to OBS to support screen capture using ScreenCaptureKit</h1>
    
    <div id="readability-page-1" class="page"><div><pre>### Description
Add a new capture plugin called General Capture that allows for capture of an entire desktop, a single window, or all windows of an application. Performs similarly to the existing macOS Display Capture and includes the ability to hide the cursor. Outperforms Window Capture with significantly higher framerates, with lower CPU/GPU utilization in both OBS and WindowServer. New application capture capabilities allow users to show an application and all of its windows without displaying the content of their desktop.
### Motivation and Context
The current implementation of Window Capture uses `CGWindowListCreateImage` to generate individual frames for window capture. This process requries a significant amount of CPU and GPU utilization from both OBS and WindowServer. ScreenCaptureKit allows General Capture to use the same video plugin style as Display Capture with better performance and lower resource utilization. ScreenCaptureKit provides `IOSurfaceRef`s instead of having to render `CGImage`s on a timer.
Display Capture uses `CGDisplayStream` which provides efficient access to the screen buffer. Unfortunately, that means that operations like cursor removal are not possible. ScreenCaptureKit allows for the cursor, applications, or windows to be excluded from a display capture. Therefore, General Capture can provide a desktop capture similar to Display Capture with additional features to the existing Display Capture.
Application captures will allow use cases like application tutorials to include only the application in question and the menu bar. This can prevent accidental display of the desktop, notifications, or windows from other applications that may appear on screen. Window Capture allows users to hide other applications and only show the main window of an application, but any additional windows would have to be manually added. Additionally, the menu bar would not be visible in a Window Capture.
&lt;details&gt;
	&lt;summary&gt;Baldur’s Gate 3 Demo&lt;/summary&gt;
![Baldur’s Gate 3- Window Capture vs General Capture Comparison]()
&lt;/details&gt;
&lt;details&gt;
	&lt;summary&gt;Shadow of the Tomb Raider&lt;/summary&gt;
![Shadow of the Tomb Raider - Window Capture vs General Capture Comparison]()
&lt;/details&gt;
&lt;details&gt;
	&lt;summary&gt;Shadow of the Tomb Raider (25% Speed Playback)&lt;/summary&gt;
![Shadow of the Tomb Raider - Window Capture vs General Capture Comparison - Running at 25% speed]()
&lt;/details&gt;
### How Has This Been Tested
Tested on a 2019 16&#34; Macbook Pro with 2.3 GHz 8-Core i9 and AMD Radeon Pro 5500M graphics and an 8GB M1 Mac Mini on macOS Monetery 12.3.
Games tested include: Dota 2, Shadow of the Tomb Raider, Deus Ex: Mankind Divided, Baldur’s Gate 3, and Civilization 6. Games were run through benchmark suites where available, recorded games in the case of Dota 2, or consistent camera movements in the case of BG3. Window Captures were compared side by side with General Captures where the game was running at 1080p, windowed, at at least 60fps. The resulting encoded videos were compared frame-by-frame to analyze framerate differences. Activity Monitor was used to track CPU, GPU, and RAM utilization during the tests.
Demo videos consist of two shots composited in OBS. Each scene shows a game captured using either a Window Capture or General Capture as noted, and a cropped General Capture of the Activity Monitor at time of capture.
### Types of Changes
- Bug fix (non-breaking change which fixes an issue)
- Performance enhancement (non-breaking change which improves efficiency)
- Code cleanup (non-breaking change which makes code smaller or more readable)
#### Summary of Changes
- `libobs-opengl/gl-cocoa.m` - Removed a requirement that frames sent to `gl-cocoa` be the same dimensions as the original frame. This is a requirement to support resizing windows. Without this change, window streams would freeze if the window was ever resized. Testing seems to show that this change does not introduce any issues.
- `plugins/mac-capture/CMakeLists.txt:15,16` - Clean up consistency of tabs/spaces in `include_directories`.
- `plugins/mac-capture/CMakeLists.txt:28` - Inclusion of new capture into compile list.
- `plugins/mac-capture/CMakeLists.txt:42,53` - Inclusion of new libraries needed for General Capture. `CoreVideo` and `CoreMedia` are needed for managing the `CVSampleBuffer` format of source frame buffers. `ScreenCaptureKit` enables the new capture type. Include `ScreenCaptureKit` as `weak_framework` to support compiling on pre-12.3 systems.
- `plugins/mac-capture/mac-display-capture.m:621` - The `__MAC_10_15` define may not exist on devices running &lt; 10.15, resulting in this section not being appropriately avoided during compilation. Swapping to `101500` should work for all versions of macOS.
- `plugins/mac-capture/mac-general-capture.m` - Inclusion of new capture type. A significant amount of code is similar to existing code in `mac-display-capture.m`, intentionally.
- `plugins/mac-capture/mac-general-capture.m:4,6` - Availability check for weak linking.
- `plugins/mac-capture/mac-general-capture.m:8,10` - Blocking compilation on 12.3 and later. Since the compilation block is here, availability is left unchecked for each call. The warning is ignored for this file to reduce noise of warnings. Future additions to this plugin type will need attention paid to potential unguarded checks in availability after 12.3.
- `plugins/mac-capture/mac-general-capture.m:164,211` - Given the different availability tools provided by `ScreenCaptureKit`, matches must be generated from the way OBS stores windows/displays to the format `ScreenCaptureKit` provides.
- `plugins/mac-capture/mac-general-capture.m:296,312` - Initial fetch of available capture targets when plugin created. Fetches are also run whenever the plugin properties are opened to ensure accurate listings in the properties.
### Future Work
- Localization of General Capture not included in PR.
- OBS might want to exclude itself from captures (or provide an option to do so) to avoid the “Hall of Mirrors” problem of bringing OBS within capture bounds to edit.
-“General Capture” UI is simplistic to duplicate whats already present, we’d expect the project to revisit how it exposes this mode
- Areas of code reuse are intentional to ensure familiarity with future maintainers and current implementations. If the project desires abstractions to reduce duplication, that should be discussed.
### Checklist:
- [x] My code has been run through clang-format.
- [x] I have read the contributing document.
- [x] My code is not on the master branch.
- [x] The code has been tested.
- [x] All commit messages are properly formatted and commits squashed where appropriate.
- [x] I have included updates to all appropriate documentation.</pre></div></div>
  </body>
</html>
