<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://and0uille.net/misc/debug90.html">Original</a>
    <h1>Reverse Engineering DOS Software as If It Were 1990</h1>
    
    <div id="readability-page-1" class="page"><div id="__next"><article dir="ltr"><div><div><div><p>Jonas Santoso</p><!-- --><p>,<time datetime="2023-11-19T00:00:00.000Z">Last updated at Sun Nov 19 2023</time><span>•</span>7 min read</p></div></div></div><h2>Quick Start<a href="#quick-start" id="quick-start" aria-label="Permalink for this section"></a></h2>
<p><iframe src="https://www.youtube-nocookie.com/embed/_KemTF5Yfkg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe></p>
<p>The video above shows a speed run of what&#39;s being done in the <a href="https://and0uille.net/misc/debug90#how-to-build-and-install">How to Build and Install</a> section. <strong>TL;DR:</strong> This is about running SoftICE, a popular DOS and Windows debugger, in an emulated MS-DOS environment. And about overcoming a limitation of <a href="https://bochs.sourceforge.io/" target="_blank" rel="noreferrer">Bochs<span> (opens in a new tab)</span></a>, the IA-32 (x86) PC emulator.</p>
<p>All of the following assumes a Linux host system. I don&#39;t know if and how it would work in macOS, let alone Windows.</p>
<h2>Emulating SoftICE<a href="#emulating-softice" id="emulating-softice" aria-label="Permalink for this section"></a></h2>
<p>NuMega started making SoftICE, which became the most widely used tool for debugging DOS, and later Windows software, in 1987. The last version that was released exclusively for DOS is SoftICE 2.80 from 1997. For someone who wishes to use live debugging sessions in an effort to reverse engineer old software today, there is a number of options:</p>
<ul>
<li><a href="https://dosbox-x.com/" target="_blank" rel="noreferrer">DOSBox-X<span> (opens in a new tab)</span></a>, a fork of DOSBox, features a debugger that bears some resemblance to SoftICE.</li>
<li><a href="https://hex-rays.com/ida-free/" target="_blank" rel="noreferrer">IDA<span> (opens in a new tab)</span></a>, whilst primarily a disassembler, has a debugger mode too, and there&#39;s <a href="https://github.com/lab313ru/dsbxida" target="_blank" rel="noreferrer">dsbxida<span> (opens in a new tab)</span></a> which interfaces IDA with DOSBox-X in order to facilitate debugging DOS software.</li>
<li>Custom tooling may be built using the <a href="https://www.unicorn-engine.org/" target="_blank" rel="noreferrer">Unicorn<span> (opens in a new tab)</span></a> CPU emulator framework. See <a href="https://github.com/aquynh/unidos" target="_blank" rel="noreferrer">UniDOS<span> (opens in a new tab)</span></a> for a (yet limited) Unicorn-based DOS emulator.</li>
</ul>
<p>However, when the intention is not solely to attain a reverse engineering objective, but also to (re-)live the experience of using period tooling, there&#39;s nothing like SoftICE for DOS. Where period hardware is not available, we&#39;ll be looking at running it in an emulator, and that&#39;s where things get a little bit hairy.</p>
<p>SoftICE doesn&#39;t work in DOSBox-X. It does work in Bochs which, unlike DOSBox, is based on full emulation of an x86 CPU. Setting up Bochs is a little more involved though, and that aside, there&#39;s another problem.</p>
<p>Say we&#39;re done installing MS-DOS and SoftICE in a Bochs environment. Pressing <code dir="ltr">Ctrl+d</code> brings up SoftICE, and all is good and well <em>until</em> we try doing that while running something that&#39;s using a VGA graphics mode―a game? Execution is paused, and SoftICE is actually in the foreground, but we don&#39;t see it, because text mode is not being restored properly. The Bochs window just shrinks to the height of the UI.</p>
<p>The solution, in actual hardware terms, would be to connect a second monitor to a secondary graphics adapter providing output from an <a href="https://en.wikipedia.org/wiki/Motorola_6845" target="_blank" rel="noreferrer">MC6845<span> (opens in a new tab)</span></a> display controller, i.e. an MDA/Hercules card. By issuing <code dir="ltr">ALTSCR ON</code> in SoftICE, the debugger&#39;s display could then be switched to the secondary monitor.</p>
<p>Unfortunately Bochs doesn&#39;t emulate either MDA or a secondary display. Emulating MDA text mode isn&#39;t hard though, and ultimately that&#39;s what I ended up doing. I found a discussion about adding MDA emulation to Bochs in an <a href="https://sourceforge.net/p/bochs/discussion/39593/thread/5a1bab61/" target="_blank" rel="noreferrer">old thread<span> (opens in a new tab)</span></a> on SourceForge. There wasn&#39;t a complete implementation anywhere, so I created a Bochs fork with the necessary changes:</p>
<p><a href="https://github.com/santosoj/bochs-dual-monitor" target="_blank" rel="noreferrer">https://github.com/santosoj/bochs-dual-monitor<span> (opens in a new tab)</span></a></p>
<p>Implementation details can be found in the repo readme. The most important thing to note is probably that the MDA text screen isn&#39;t displayed in Bochs itself. It&#39;s written to a named pipe as UTF-8 code points, along with ANSI escape sequences for rendering the MC6845&#39;s character attributes. The named pipe would then be polled by an external program which dumps the text screen on a terminal. (A sample program doing that was <a href="https://github.com/santosoj/bochs-dual-monitor/blob/master/mda_viewer/__main__.py" target="_blank" rel="noreferrer">added to the repo<span> (opens in a new tab)</span></a>.)</p>
<p>This screenshot shows Bochs running a game while SoftICE is displayed in a terminal window:</p>
<p><img alt="Bochs running a game while SoftICE is displayed in a terminal window" loading="lazy" width="1043" height="756" decoding="async" data-nimg="1" src="https://and0uille.net/_next/static/media/screenshot-bochs-dual-monitor.c310092a.jpg"/></p>
<h2>How to Build and Install<a href="#how-to-build-and-install" id="how-to-build-and-install" aria-label="Permalink for this section"></a></h2>
<h3>Build Bochs<a href="#build-bochs" id="build-bochs" aria-label="Permalink for this section"></a></h3>
<p>Clone my <a href="https://github.com/santosoj/bochs-dual-monitor" target="_blank" rel="noreferrer">Bochs fork<span> (opens in a new tab)</span></a> and compile it with CPU level 3 in order to target 386. (More on compiling Bochs <a href="https://bochs.sourceforge.io/doc/docbook/user/compiling.html" target="_blank" rel="noreferrer">here<span> (opens in a new tab)</span></a>.) E.g.</p>

<p>Use <code dir="ltr">bximage</code> (part of the Bochs build) to create a harddisk image. The defaults (<code dir="ltr">hd</code> / <code dir="ltr">flat</code> / <code dir="ltr">512</code>) and a size of 30mb will be fine. I&#39;m calling it <code dir="ltr">hdd.img</code>.</p>
<p>We need a <code dir="ltr">.bochsrc</code> file, which we initialize by starting Bochs and picking <code dir="ltr">4. Save options to...</code>. Then we edit it and make these changes (YMMV):</p>

<p>I had to comment <code dir="ltr">port_e9_hack_all_rings</code> because otherwise Bochs would throw an error. <code dir="ltr">dos622_d1.img</code> is the first of the MS-DOS 6.22 install disks. You can find these in the <a href="https://and0uille.net/misc/debug90#downloads"><em>Downloads</em></a> section below.</p>
<h3>Install DOS<a href="#install-dos" id="install-dos" aria-label="Permalink for this section"></a></h3>
<p>One little annoyance observed in other versions of Bochs―it doesn&#39;t seem to be occurring in the version the fork is based on―is that Bochs goes straight into the debugger after picking <code dir="ltr">6. Begin simulation</code>, requiring you to enter <code dir="ltr">c &lt;newline&gt;</code> to continue execution. This can be mitigated by creating a file (named <code dir="ltr">bochs_init</code> here) containing <code dir="ltr">c</code> and a newline, and passing this file as an argument to Bochs&#39;s <code dir="ltr">-rc</code> command line option. Also, the startup menu can be skipped by passing <code dir="ltr">-q</code>, so the following should make for a quick Bochs startup:</p>

<p>Another annoyance is that Bochs will segfault on starting when a harddisk image lock file is left over from an unclean exit. So when there&#39;s a dangling <code dir="ltr">hdd.img.lock</code>, delete it before starting Bochs.</p>
<p>Start Bochs and proceed with the MS-DOS installation. When prompted to insert another disk, click <code dir="ltr">CONFIG</code> in the Bochs UI, and change the image file for <code dir="ltr">Floppy disk 0</code>. Once installation is finished, change the <code dir="ltr">boot</code> option in <code dir="ltr">.bochsrc</code> from <code dir="ltr">floppy</code> to <code dir="ltr">disk</code>. When you start Bochs again, it should boot straight into DOS.</p>
<h3>Install a CD-ROM Driver<a href="#install-a-cd-rom-driver" id="install-a-cd-rom-driver" aria-label="Permalink for this section"></a></h3>
<p>Next, use <code dir="ltr">bximage</code> again to create a floppy image (options: <code dir="ltr">fd</code> / <code dir="ltr">1.44M</code>). I&#39;m naming it <code dir="ltr">floppy.img</code>. In Bochs, insert this disk (<code dir="ltr">CONFIG</code> / <code dir="ltr">1. Floppy disk 0</code>) and format it by entering <code dir="ltr">format a:</code> in DOS. We may as well change the <code dir="ltr">floppya</code> option in <code dir="ltr">.bochsrc</code> so this disk image is used by default. Once formatted, we mount this floppy image on our host system and copy <code dir="ltr">oakcdrom.sys</code>, the Oak CD-ROM driver (also found in the <a href="https://and0uille.net/misc/debug90#downloads"><em>Downloads</em></a> section):</p>

<p>Install the driver in DOS.</p>

<p>Add this line to <code dir="ltr">CONFIG.SYS</code>:</p>

<p>And this line to <code dir="ltr">AUTOEXEC.BAT</code>:</p>

<h3>Install SoftICE<a href="#install-softice" id="install-softice" aria-label="Permalink for this section"></a></h3>
<p>Now that we can use CD images, let&#39;s create one on our host system. Assuming the SoftICE 2.80 files (those found in <em>S-ICE280.ZIP</em> inside <em>sice280_and_extras.zip</em> from the <a href="https://and0uille.net/misc/debug90#downloads"><em>Downloads</em></a> section) are in a directory called <code dir="ltr">sice</code>, this command creates an ISO image from it:</p>

<p>Change the <code dir="ltr">ata1-master</code> option in <code dir="ltr">.bochsrc</code> to insert the CD:</p>

<p>After booting into DOS again, we can proceed to install SoftICE.</p>

<p>Add <code dir="ltr">C:\SICE</code> to the <code dir="ltr">PATH</code> environment variable in <code dir="ltr">AUTOEXEC.BAT</code>. Note that, unlike Bash, DOS uses the semicolon as path separator.</p>

<p>In <code dir="ltr">CONFIG.SYS</code>, load SoftICE before any other driver:</p>

<p>That&#39;s it. After rebooting, you can bring up SoftICE by pressing <code dir="ltr">Ctrl+d</code>.</p>
<p><img alt="Bochs running SoftICE" loading="lazy" width="721" height="480" decoding="async" data-nimg="1" src="https://and0uille.net/_next/static/media/screenshot-bochs-softice.17cb36f1.png"/></p>
<h3>Displaying SoftICE on the MDA Adapter<a href="#displaying-softice-on-the-mda-adapter" id="displaying-softice-on-the-mda-adapter" aria-label="Permalink for this section"></a></h3>
<p>One step is left in order to be able to debug games and such. The forked Bochs&#39;s MDA emulation is enabled when Bochs finds an environment variable named <code dir="ltr">MDA_PIPE</code> containing the path to a named pipe. Create the pipe on the host system:</p>

<p>Note that, once MDA is enabled, execution is blocked unless there&#39;s a program running that consumes the pipe. So let&#39;s start that, the program being the <a href="https://github.com/santosoj/bochs-dual-monitor/blob/master/mda_viewer/__main__.py" target="_blank" rel="noreferrer">mda_viewer<span> (opens in a new tab)</span></a> example from the repo.</p>

<p>Start Bochs, also specifying <code dir="ltr">MDA_PIPE</code>:</p>

<p>You can verify that MDA is enabled by looking for this line in Bochs&#39;s console output:</p>

<p>Run a game, or something that uses a VGA graphics mode. Press <code dir="ltr">Ctrl+d</code>. The graphics display will disappear. But confident that SoftICE is now in the foreground (and with the Bochs window still focused), enter the following SoftICE command.</p>

<p>The graphics display comes back, and the terminal window where <code dir="ltr">mda_viewer</code> is running now shows SoftICE. It may take a little getting used to not to try typing into the terminal window. It&#39;s still the Bochs window that needs to be focused when entering SoftICE commands. But with this setup, we can reverse engineer DOS software as if it were 1990.</p>
<h3>Downloads<a href="#downloads" id="downloads" aria-label="Permalink for this section"></a></h3>
<p>De facto abandonware, as none of this is more recent than from 1997.</p>
<p><a href="https://storage.googleapis.com/20kbps-static/00_MISC/jscom/dos622.tar.bz2" target="_blank" rel="noreferrer">MS-DOS 6.22<span> (opens in a new tab)</span></a></p>
<pre>[ ::.. AND0UiLLE 2023 ..:: ]
A 𝘛𝘩𝘦 𝘏𝘢𝘳𝘥𝘭𝘪𝘯𝘦𝘳 série.</pre><small><abbr title="This site and all its content are licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.">CC BY-NC 4.0</abbr> <!-- -->2024<!-- --> © Jonas Santoso.</small></article></div></div>
  </body>
</html>
