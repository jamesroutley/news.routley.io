<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://push.cx/large-refactors.html">Original</a>
    <h1>Wrapping Large-Scale Refactors</h1>
    
    <div id="readability-page-1" class="page"><article id="content" role="main" aria-label="Content">
        <section>
  

  <p>
    
    <span>
      <time datetime="2024-01-27T11:10:05-06:00" itemprop="datePublished">Published:
          
            <a href="https://push.cx/nixos.html">←</a>
          
          2024-01-27
          
      </time></span>
  </p>

  <p>I really liked a “<a href="https://max.engineer/long-term-refactors">Long Term Refactors</a>” by Max Chernyak explaining a nice development practice.
I was reminded of a thing that surprised me about refactors and dependency management.</p>

<p>My last job had a codebase large enough (~50M LOC) that there were always large-scale refactors in flight, which was a new experience for me.</p>

<p>One thing this article doesn’t specifically call out is that any kind of dependency update or replacement, whether an internal or external library, is a large-scale refactor.
You benefit enormously if you can do this incrementally as the author describes instead of a <a href="https://en.wikipedia.org/wiki/Flag_day_(computing)">flag day</a> or One Giant Merge to update all uses.
A counterintuitive result is that replacing one dep with another (foolib -&gt; barlib) is <em>easier</em> than updating one (foolib 1 -&gt; foolib 2)!
Most languages do not allow you to depend on multiple versions of a package and have different sections of your codebase call different versions.
Sometimes internally-maintained dependencies will rename just to get around this limitation.</p>

<p>There’s a style of managing dependencies that mandates you must wrap usage of libraries or APIs.
Rather than calling <code>Foolib::Thing.new</code>, you’ll create your own <code>FooThing</code> (maybe using the decorator or facade patterns) and that class is the only place allowed to import from or call into foolib.
With less exposure of foolib, it’s easier to create internal documentation, audit or control usage, or replace foolib with barlib.
I don’t find this a cost worth paying in smaller codebases, but easily worth it in large ones.</p>

<p>Part of why it’s worthwhile is that it gives you two new methods for dealing with dependency updates.
First (hopefully), you have a single codesite that uses foolib so a single team can make a small change to update foolib.
Or second, if there are extensive changes that mandate changes at callsites, you can rename <code>FooThing</code> to <code>FooThing1</code> (usually an easy, if large diff), introduce <code>FooThing2</code> with the new API, and then use a process like the one this article describes to make that change incrementally to the entire codebase.
Either you update foolib at the start of this process and <code>FooThing1</code> maps old usage to new, or <code>FooThing2</code> maps new usage to old and you bump foolib at the end.
This process works quite well, whether foolib is an internal or external dependency.
Whereas, say, emailing all-dev@example.com a link to the foolib release notes and dictum that on some particular date that all foolib usage must be updated will inevitably produce significant internal discord and never, ever an on-schedule completion.
An even worse and more common failure mode for internal libs is to quietly mark foolib deprecated and direct people to rewrite to barlib when they show up with urgent questions about foolib during an outage - but of course good sense and steps 6-8 of the process described in the post would avoid such an outlandish footgunning.</p>

<p>(This post was originally a <a href="https://lobste.rs/s/bi2b1j">comment on Lobste.rs</a>
but then I realized it’s a nice excuse to break the 5.5 year dry spell here.)</p>

</section>



    </article></div>
  </body>
</html>
