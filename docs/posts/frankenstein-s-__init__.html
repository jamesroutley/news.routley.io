<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ohadravid.github.io/posts/2025-04-19-frank/">Original</a>
    <h1>Frankenstein&#39;s `__init__`</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><div><div><p>Inspired by <a href="https://blog.glyph.im/2025/04/stop-writing-init-methods.html">a recent post</a> about the woes of <code>__init__</code> methods in Python,
I thought I’d share the untold story of the absolute craziest <code>__init__</code> I’ve come across in a production codebase.</p><p>It all started when I tried to <a href="https://matklad.github.io/2023/12/31/git-things.html#Git-Things:~:text=When%20fixing%20a%20bug%2C%20add%20a%20failing%20test%20first%2C%20as%20a%20separate%20commit.%20That%20way%20it%20becomes%20easy%20to%20verify%20for%20anyone%20that%20the%20test%20indeed%20fails%20without%20the%20follow%20up%20fix.">add a failing test</a> to a Python service.</p><p>The test was indeed failing, but every now and then it would fail on something unexpected.</p><h2 id="the-evidence-of-the-test">The Evidence of the Test</h2><p>After some minimization, this was the test I had:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>def</span> <span>test_foobar</span><span>():</span>
</span></span><span><span>    f <span>=</span> FooBarWidget<span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>with</span> contextlib<span>.</span>closing<span>(</span>f<span>):</span>
</span></span><span><span>        <span>assert</span> <span>False</span>
</span></span></code></pre></div><p>which <em>sometimes</em> failed with this error:</p><div><pre tabindex="0"><code data-lang="python"><span><span>self <span>=</span> <span>&lt;</span>foobar<span>.</span>FooBarWidget <span>object</span> at <span>0x10512ed80</span><span>&gt;</span>
</span></span><span><span>
</span></span><span><span>    <span>def</span> <span>close</span><span>(</span>self<span>):</span>
</span></span><span><span><span>&gt;</span>       <span>if</span> self<span>.</span>should_exit <span>is</span> <span>False</span><span>:</span>
</span></span><span><span>E       <span>AttributeError</span><span>:</span> <span>&#39;FooBarWidget&#39;</span> <span>object</span> has no attribute <span>&#39;should_exit&#39;</span>
</span></span><span><span>
</span></span><span><span>foo<span>.</span>py<span>:</span><span>28</span><span>:</span> <span>AttributeError</span>
</span></span></code></pre></div><p>And not (only) the expected <code>AssertionError</code>.</p><p>Searching for <code>self.should_exit =</code> yielded <code>FooWidget.__init__</code> in <code>foo.py</code>:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>class</span> <span>AbstractWidget</span><span>:</span>
</span></span><span><span>    <span>def</span> __init__<span>(</span>self<span>):</span>
</span></span><span><span>        self<span>.</span>config <span>=</span> Path<span>(</span><span>&#34;config.json&#34;</span><span>)</span><span>.</span>read_text<span>()</span>
</span></span><span><span>
</span></span><span><span><span>class</span> <span>FooWidget</span><span>(</span>AbstractWidget<span>):</span>
</span></span><span><span>    <span>def</span> __init__<span>(</span>self<span>):</span>
</span></span><span><span>        <span>super</span><span>()</span><span>.</span>__init__<span>()</span>
</span></span><span><span>
</span></span><span><span>        self<span>.</span>ctx <span>=</span> zmq<span>.</span>Context<span>.</span>instance<span>()</span>
</span></span><span><span>        self<span>.</span>consumer<span>:</span> zmq<span>.</span>Socket <span>=</span> self<span>.</span>ctx<span>.</span>socket<span>(</span>zmq<span>.</span>PULL<span>)</span>
</span></span><span><span>        self<span>.</span>should_exit <span>=</span> <span>False</span>
</span></span><span><span>
</span></span><span><span>    <span>def</span> <span>run</span><span>(</span>self<span>):</span>
</span></span><span><span>        <span>while</span> self<span>.</span>should_exit <span>is</span> <span>False</span><span>:</span>
</span></span><span><span>            <span>...</span>
</span></span><span><span>
</span></span><span><span>        self<span>.</span>consumer<span>.</span>close<span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>def</span> <span>close</span><span>(</span>self<span>):</span>
</span></span><span><span>        <span>if</span> self<span>.</span>should_exit <span>is</span> <span>False</span><span>:</span>
</span></span><span><span>            self<span>.</span>should_exit <span>=</span> <span>True</span>
</span></span></code></pre></div><p>Which didn’t make sense at all: assuming none of these lines fail, how can the <code>should_exit</code> attribute <em>sometimes</em> not be to set?</p><h2 id="the-__init__">The <code>__init__</code></h2><blockquote><p>The impossible could not have happened,</p></blockquote><p>The only other clue we have is that <code>self</code> is a <code>FooBarWidget</code>, not a <code>FooWidget</code>.
So, to the <code>class FooBarWidget(FooWidget)</code> definition I went, which is where I found it.</p><p>The craziest <code>__init__</code> I’ve ever seen:</p><div><pre tabindex="0"><code data-lang="python"><span><span><span>class</span> <span>FooBarWidget</span><span>(</span>FooWidget<span>):</span>
</span></span><span><span>    <span>def</span> __init__<span>(</span>self<span>):</span>
</span></span><span><span>        self<span>.</span>publisher<span>:</span> zmq<span>.</span>Socket <span>=</span> zmq<span>.</span>Context<span>.</span>instance<span>()</span><span>.</span>socket<span>(</span>zmq<span>.</span>PUSH<span>)</span>
</span></span><span><span>
</span></span><span><span>        self<span>.</span>_init<span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>def</span> <span>_init</span><span>(</span>self<span>):</span>
</span></span><span><span>        <span>def</span> <span>worker_thread_start</span><span>():</span>
</span></span><span><span>            FooWidget<span>.</span>__init__<span>(</span>self<span>)</span>
</span></span><span><span>            self<span>.</span>run<span>()</span>
</span></span><span><span>
</span></span><span><span>        worker_thread <span>=</span> Thread<span>(</span>target<span>=</span>worker_thread_start<span>,</span> daemon<span>=</span><span>True</span><span>)</span>
</span></span><span><span>        worker_thread<span>.</span>start<span>()</span>
</span></span></code></pre></div><p>Yep. You read that right: this class kicks off it’s parent’s <code>__init__</code> <strong>to a new thread</strong>.</p><p>So if you <code>close</code> a <code>FooBarWidget</code> instance <em>too quickly</em>, you just might do it before <code>FooWidget.__init__</code> has finished,
resulting in pain, suffering, and a deep questioning of one’s life choices.</p><p><img src="https://ohadravid.github.io/2025-04-19-frank.jpg" alt="Trump Interview Reaction meme to an init"/></p><h2 id="why-though">Why, Though?</h2><p>Since you might be wondering why someone would even do this, first you need to know that a <code>zmq.Socket</code> <em>cannot be moved between threads</em>,
as explained in the legendary <a href="https://zguide.zeromq.org/py:all">ZeroMQ Guide</a>.</p><p>To avoid blocking the main thread, <code>FooBarWidget</code> wants to let the <code>run</code> method execute in a different thread.</p><p>However, it cannot do so once <code>FooWidget.__init__</code> has been called (since the <code>self.consumer</code> socket will be created on the main thread).</p><p>A solution, then: let both the <code>__init__</code> and the <code>run</code> execute in the new thread,
solving an annoying problem with a complete and utter disregard to sanity, common sense, and the feelings of other human beings.</p><p>You can view the full code <a href="https://gist.github.com/ohadravid/25f0a4de72bd54042351541ef061ac49">here</a>.</p><blockquote><p>I had desired it with an ardour that far exceeded moderation; but now that I had finished, the beauty of the dream vanished, and breathless horror and disgust filled my heart.</p></blockquote><p><em>If you liked this, you might also like <a href="https://ohadravid.github.io/posts/2024-09-yells-at-cloud/">My most downvoted StackOverflow answer</a> and <a href="https://ohadravid.github.io/posts/2023-03-rusty-python/">Making Python 100x faster with less than 100 lines of Rust</a></em>.</p></div></div></div></div>
  </body>
</html>
