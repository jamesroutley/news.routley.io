<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://maxadamski.com/blog/2025/10/email.html">Original</a>
    <h1>Self-hosting email like it&#39;s 1984</h1>
    
    <div id="readability-page-1" class="page"><div>

<h2>Introduction</h2>

<p>
Self-hosting an email server is useful for automating tasks like mailing lists, newsletters, or email verification APIs.
</p>

<p>
The elephant in the room is real-world deliverability. <b>With self-hosting you risk not receiving mail or someone missing your mail.</b> I accept this for my personal projects, but you may not. Keep this in mind.
</p>

<p>
For me the selling point of self-hosting is that it’s practically free. If you’re already self-hosting a website, installing some extra packages on your server and just a bit of your time is all that’s required. Mail takes very little storage and the software is light, so you’re unlikely to significantly change energy consumption or disk usage.
</p>

<p>
For the longest time, I perceived self-hosting email as too difficult, but after doing it for one of my projects, I can say it’s not much harder or more time-consuming than configuring some email SaaS.
</p>

<p>
I changed my goals a bit to make the setup easier though. Self-hosting a multi-user webmail looks heavy and is more involved than I was willing to get into, so I just skipped it. That way, I didn’t have to bother with user accounts, databases, or the web at all, and the task became easy.
</p>

<p>
With my config, manually sending and receiving email is possible if you SSH to your mail server and use the minimal sendmail or mailx commands, or Mutt if you like TUI. I&#39;ve been semi-comfortably using mailx for a month already (with its <a href="https://heirloom.sourceforge.net/mailx_history.html">ancient</a> user interface!), so the setup is enough for me now, but I could expand it in the future, and multi-user webmail isn’t completely off the table. Maybe I’ll even write a simple webmail package myself!
</p>


<h2>Setting up Postfix</h2>

<p>
You just need to open port 25, and install and configure <a href="https://www.postfix.org">Postfix</a> and <a href="http://www.opendkim.org">OpenDKIM</a> on your machine. Postfix is a complete SMTP server, and is enough for basic mail alone, but in practice you also need OpenDKIM to get your mail delivered to popular services like Gmail.
</p>

<p>
Here&#39;s my Postfix config to show how easy it is. I left the master.cf file as it was, because I’m always submitting email locally.
</p>

<p>
The default alias and header check config files are practically self-explanatory (just open them and read the comments!).
</p>

<details>
<summary>/etc/postfix/main.cf</summary>
<pre>compatibility_level = 3.8
mail_owner = postfix

myhostname = mx.idx.cy
myorigin = idx.cy
mydestination = localhost, idx.cy, maxadamski.com, localchat.cc
inet_interfaces = all
inet_protocols = ipv4

# Addresses
alias_maps = hash:/etc/postfix/aliases
alias_database = $alias_maps
recipient_delimiter = +

# I&#39;m the only user on my machine, so I send from whichever address I want.
#smtpd_sender_login_maps = hash:/etc/postfix/sender_login_maps
#smtpd_sender_restrictions = reject_authenticated_sender_login_mismatch

# spam
#in_flow_delay = 1s
header_checks = regexp:/etc/postfix/header_checks
setgid_group = postdrop

# TLS (strict)
smtpd_tls_cert_file = /etc/ssl/tls/mx.idx.cy.crt
smtpd_tls_key_file = /etc/ssl/tls/mx.idx.cy.key
smtpd_tls_security_level = encrypt
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_security_level = encrypt
smtp_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1

# DKIM
smtpd_milters = inet:localhost:8891
non_smtpd_milters = inet:localhost:8891
milter_default_action = accept
</pre>
</details>

<p>
Notice that there&#39;s no mention of POP3 or IMAP! I did waste some time trying to set them up with Dovecot (because they changed their config format too much, so guides became outdated, and their web docs were just hard to read for me). Ultimately I can just SSH to my server and I feel comfortable with mailx, so I skipped Dovecot. One package less in my system :)
</p>

<h2>TLS</h2>

<p>
You will also need an SSL certificate for encryption in transit. I hate getting and renewing SSL certificates, because the tools are bulky and automation is yet another moving part in your system (I used the lego package, with the manual DNS challenge for simplicity, but I’m not too happy about it). I won’t give you a tutorial on getting SSL certificates, but note that you don’t have to get and renew a certificate for each of your custom domains!
</p>

<p>
You just need one SSL certificate for your machine to encrypt data in transit to other SMTP servers. If you create an A record mx.example.com pointing to your email machine’s IP address, then grab a free certificate for mx.example.com from Let’s Encrypt. Then point to it in the Postfix configuration, and you’ve got transport encryption! In short, only the MX hostname needs a cert for STARTTLS to be used for encryption.
</p>

<p>
Why no certificates for your actual email domains like example.com? Because the email domain has little to do with transport encryption. TLS only secures the connection between servers. You can still set whatever you want in the From header.
</p>

<h2>DKIM, SPF, and DMARC</h2>

<p>
You should prove that your emails actually come from your domain to make your mail trustworthy and deliver to Gmail and co. That’s what DKIM is for, and fortunately it’s a one-time deal per email domain. First you generate a key pair for each domain with OpenDKIM, and then you publish the public key in a TXT record in DNS. The keys don’t expire automatically, but it’s best practice to rotate them periodically. My config uses a naming scheme that allows smooth rotation, but it doesn’t complicate things if you skip it.
</p>

<p>
There are two more TXT records that you need to publish in DNS: the SPF and DMARC records. You say which hosts are allowed to send mail from your email domain, and give instructions to other email servers about what to do with mail that fails DKIM checks. In my case I told others to reject mail that can’t be verified as coming from my domains, and send reports to my postmaster address.
</p>

<p>
Take a look at my OpenDKIM config to understand how things come together.
</p>

<details>
<summary>/etc/opendkim.conf</summary>
<pre>UserID             opendkim:opendkim
Socket             inet:8891@localhost
KeyTable           refile:/etc/opendkim/KeyTable
SigningTable       refile:/etc/opendkim/SigningTable
ExternalIgnoreList refile:/etc/opendkim/TrustedHosts
InternalHosts      refile:/etc/opendkim/TrustedHosts

Canonicalization   relaxed/relaxed
ReportAddress      postmaster@idx.cy
SendReports        no

LogWhy             yes
Syslog             yes
SyslogSuccess      no
</pre>
</details>

<details>
<summary>/etc/opendkim/KeyTable</summary>
<pre>key1._domainkey.idx.cy         idx.cy:key1:/etc/opendkim/keys/idx.cy/key1.private
key1._domainkey.maxadamski.com maxadamski.com:key1:/etc/opendkim/keys/maxadamski.com/key1.private
key1._domainkey.localchat.cc   localchat.cc:key1:/etc/opendkim/keys/localchat.cc/key1.private
</pre>
</details>

<details>
<summary>/etc/opendkim/SigningTable</summary>
<pre>*@idx.cy         key1._domainkey.idx.cy
*@maxadamski.com key1._domainkey.maxadamski.com
*@localchat.cc   key1._domainkey.localchat.cc
</pre>
</details>

<details>
<summary>/etc/opendkim/TrustedHosts</summary>
<pre>127.0.0.1
localhost
</pre>
</details>

<p>
I generate DKIM keys with the following command:
</p>

<pre>opendkim-genkey -D /etc/opendkim/keys/example.com -d example.com -s key1
</pre>

<p>
And for each email domain I have the following records in DNS:
</p>

<div>
<table>
  <thead>
    <tr><th>Type</th><th>Name</th><th>Value</th></tr>
  </thead>
  <tbody>
    <tr><td>MX</td><td>example.com</td><td>mx.idx.cy</td></tr>
    <tr><td>TXT</td><td>example.com</td><td>v=spf1 mx a -all</td></tr>
    <tr><td>TXT</td><td>key1._domainkey</td><td>v=DKIM1; k=rsa; s=email; p=&lt;public-key&gt;</td></tr>
    <tr><td>TXT</td><td>_dmarc</td><td>v=DMARC1; p=reject; rua=mailto:postmaster@idx.cy</td></tr>
  </tbody>
</table>
</div>

<h2>Reverse DNS</h2>

<p>
One more thing about self-hosted email deliverability. I&#39;ve read that reverse DNS (PTR record) will boost the reputation of your email server. The thing is that your ISP has to set it up, and I suspect my ISP to reply with a polite &#34;no&#34;, so I didn&#39;t do it yet. As you&#39;ll see in the next section, my email gets delivered to Gmail just fine. GMX and Outlook also didn&#39;t mark my mail as spam. Maybe my IP is lucky :)
</p>

<p>
But in general, if you want wide deliverability, PTR isn&#39;t optional.
</p>

<h2>Testing with Gmail</h2>

<p>To try it out, let&#39;s send a test mail to Gmail with the sendmail command:</p>

<pre>sendmail -vt &lt; test.mail</pre>

<details>
<summary>test.mail</summary>
<pre>Content-Type: text/html
From: max@idx.cy
To: myaddress@gmail.com
Subject: DKIM test
Test message from idx.cy!
</pre>
</details>

<p>I got the mail instantly and Gmail confirmed TLS encryption.</p>

<img src="https://maxadamski.com/blog/2025/10/test-mail-1.png"/>

<p>Click &#34;Show original&#34; in Gmail to see the raw mail. There&#39;s lots of text in the headers, so let&#39;s just focus on passing SPF, DKIM, and DMARC :)</p>

<img src="https://maxadamski.com/blog/2025/10/test-mail-2.png"/>

<p>You&#39;ll also get a mail with a report because of the <tt>-v</tt> option. I receive mail with Heirloom Mail like this:</p>

<pre>You have new mail in /var/mail/max
fool ~ | mailx
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
&#34;/var/mail/max&#34;: 1 message 1 new
&gt;N  1 Mail Delivery System  Sat Oct  4 15:40  74/2437  &#34;Mail Delivery Status Report&#34;
</pre>

<p>I use the <tt>p</tt> command to print the mail.</p>

<details>
<summary>&amp; p</summary>
<pre>Message  1:
From MAILER-DAEMON  Sat Oct  4 15:40:50 2025
X-Original-To: max@idx.cy
Delivered-To: max@idx.cy
Date: Sat,  4 Oct 2025 15:40:50 +0200 (CEST)
From: Mail Delivery System &lt;MAILER-DAEMON@idx.cy&gt;
Subject: Mail Delivery Status Report
To: max@idx.cy
Auto-Submitted: auto-replied
Content-Type: multipart/report; report-type=delivery-status;
	boundary=&#34;3C311BFF8D.1759585250/mx.idx.cy&#34;
Status: R

Part 1:
Content-Description: Notification
Content-Type: text/plain; charset=utf-8

This is the mail system at host mx.idx.cy.

Enclosed is the mail delivery report that you requested.

                   The mail system

&lt;myaddress@gmail.com&gt;: delivery via
    gmail-smtp-in.l.google.com[X.X.X.X]:25: 250 2.0.0 OK  1759585250
    4fb4d7f45d1cf-6393b6ba951si3187039a12.40 - gsmtp
</pre>
</details>

<p>Great, everything is working! And I&#39;m feeling the spirit of the 80s thanks to mailx :)</p>

<p>
If something isn&#39;t working for you, please double-check your DNS records, and triple-check that TLS certificates are readable by the Postfix user, and that DKIM keys are readable by the OpenDKIM user. Postfix and OpenDKIM logs will also be useful. The OpenDKIM config file is especially unforgiving of typos, so watch out for small mistakes!
</p>

<h2>Next steps</h2>

<p>
In my next post on email, I&#39;ll show you how to use Python to build useful email applications. Thanks for reading!
</p>

<p>
Btw, if you notice anything about my config (or just want to share some thoughts) just email me at <a href="mailto:max@idx.cy">max@idx.cy</a> :)
</p>
</div></div>
  </body>
</html>
