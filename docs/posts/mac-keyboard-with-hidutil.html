<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://amitp.blogspot.com/2023/04/mac-keyboard-with-hidutil.html">Original</a>
    <h1>Mac Keyboard with Hidutil</h1>
    
    <div id="readability-page-1" class="page"><div>
<!--Can't find substitution for tag [adStart]-->
<section id="5471762343848443086">
<time timestamp="2023-04-12T16:54:00-07:00">Wednesday, April 12, 2023</time>
<p>
[Updated 13-Apr-2023 with some of the background context and some things I learned from <a href="https://news.ycombinator.com/item?id=35555475">hackernews</a>]
</p>

<p>
On my Mac, I&#39;ve used KeyRemap4Macbook, Karabiner, Karabiner Elements, and FunctionFlip for some of my key remapping needs. The main things I want:
</p>

<ol>
<li>On the laptop keyboard, <em>some</em> media keys should be function keys but other media keys should stay media keys. When using <kbd>fn</kbd> I want to get the other version of the key.</li>
<li>On external keyboards, make the function keys act like the laptop keyboard.</li>
<li>On external keyboards, the numpad should act like &#34;numlock off&#34;. For example, <kbd>4</kbd> should be Left Arrow.</li>
<li>On external keyboards, the Windows key should act as Option, and the Alt key should act as Command. This can usually be set in the System Preferences. (Except it doesn&#39;t work on one of my keyboards)</li>
<li>I also use those same external keyboards with my Windows and Linux machines, so I prefer to make these changes through software rather than firmware.</li>
</ol>

<a name="more"></a>

<p>
I recently learned about <code>hidutil</code>. It&#39;s built-in but has no user-friendly UI. Someone has created <a href="https://hidutil-generator.netlify.app/">this config generator</a> for it; I learned about it from <a href="https://rakhesh.com/mac/using-hidutil-to-map-macos-keyboard-keys/">Rakhesh Sasidharan&#39;s blog post</a>. Using that generator, I can change a media/function key to do something else, but I can&#39;t seem to set <kbd>fn+key</kbd>. I instead learned how to do that from <a href="https://www.nanoant.com/mac/macos-function-key-remapping-with-hidutil">Adam Strzelecki&#39;s blog post</a>. Also from the <em>comments</em> in Adam&#39;s blog post, I learned that there&#39;s a way to have a different configuration for each type of keyboard using the <kbd>--matching</kbd> flag.
</p>

<p>
I have three keyboards but at first I&#39;m going to try using a single <code>hidutil</code> configuration for all three, and then later I will refine it as needed. I ended up writing a Python program to run <code>hidutil</code> with my desired configuration, a combination of the keys I can set using the config generator website and the keys I can set using Adam&#39;s blog post:
</p>

<div>
<pre><span>import</span> subprocess, json

<span>output</span> <span>=</span> <span>&#39;{&#34;UserKeyMapping&#34;:[</span><span>\n</span><span>&#39;</span>




<span>output</span> <span>+=</span> <span>&#34;&#34;&#34;</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x700000059,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x70000004D</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x70000005A,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x700000051</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x70000005B,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x70000004E</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x70000005C,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x700000050</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x70000005E,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x70000004F</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x70000005F,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x70000004A</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x700000060,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x700000052</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x700000061,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x70000004B</span>
<span>    },</span>
<span>    {&#34;HIDKeyboardModifierMappingSrc&#34;: 0x700000063,</span>
<span>     &#34;HIDKeyboardModifierMappingDst&#34;: 0x70000004C</span>
<span>    },</span>
<span>&#34;&#34;&#34;</span>





<span>key_mappings</span> <span>=</span> [] 

<span>function_keys</span> <span>=</span> subprocess.check_output(
    <span>&#34;&#34;&#34;ioreg -l |</span>
<span>         grep FnFunctionUsageMap |</span>
<span>         grep -Eo &#39;0x[0-9a-fA-F]+,0x[0-9a-fA-F]+&#39;</span>
<span>      &#34;&#34;&#34;</span>, shell<span>=</span><span>True</span>).decode(<span>&#39;utf-8&#39;</span>).split(<span>&#39;</span><span>\n</span><span>&#39;</span>)

<span>for</span> fn_key <span>in</span> [1, 2, 3, 10, 11, 12]:
    <span>src_key</span>, <span>dst_key</span> <span>=</span> function_keys[fn_key<span>-</span>1].replace(<span>&#34;0x&#34;</span>, <span>&#34;&#34;</span>).split(<span>&#34;,&#34;</span>)
    <span>src_key</span> <span>=</span> <span>&#39;0x&#39;</span> <span>+</span> src_key[:4] <span>+</span> <span>&#39;0000&#39;</span> <span>+</span> src_key[4:]
    <span>dst_key</span> <span>=</span> <span>&#39;0x&#39;</span> <span>+</span> dst_key[:4] <span>+</span> <span>&#39;0000&#39;</span> <span>+</span> dst_key[4:]
    key_mappings.append((src_key, dst_key))
    key_mappings.append((dst_key, src_key))

<span>output</span> <span>+=</span> <span>&#39;,</span><span>\n</span><span>&#39;</span>.join([
   <span>&#39;  {&#34;HIDKeyboardModifierMappingSrc&#34;: &#39;</span> <span>+</span> src <span>+</span> 
   <span>&#39;, &#34;HIDKeyboardModifierMappingDst&#34;: &#39;</span> <span>+</span> dst <span>+</span> <span>&#39;}&#39;</span>
   <span>for</span> (src, dst) <span>in</span> key_mappings])
<span>output</span> <span>+=</span> <span>&#39;]}&#39;</span>


<span>process</span> <span>=</span> subprocess.run([<span>&#34;hidutil&#34;</span>, <span>&#34;property&#34;</span>, <span>&#34;--set&#34;</span>, output],
                         capture_output<span>=</span><span>True</span>)

</pre>
</div>

<p>
The script handles most of what I want. One remaining mystery is that the <kbd>fn</kbd> versions are incomplete â€” <kbd>fn+F7</kbd>, <kbd>fn+F8</kbd>, <kbd>fn+F9</kbd>  work for me as media keys, but <kbd>fn+F4</kbd>, <kbd>fn+F5</kbd>, <kbd>fn+F6</kbd> don&#39;t work for me as apple-specific media keys. One missing feature is that on one external keyboard, I want to map the Windows key to Option, and the Alt key to Command. System Preferences didn&#39;t do it, so my workaround is to to it with firmware, and toggle that on/off when switching operating systems.
</p>

<p>
Other useful commands:
</p>

<div>
<pre>


hidutil property --get <span>&#34;UserKeyMapping&#34;</span>



</pre>
</div>

<p>
I currently run this manually on boot, but a <code>launchctl</code> file can be used to make it run automatically on boot. If using per-device configurations, they don&#39;t apply unless you run this while the keyboard is plugged in. That&#39;s inconvenient. <a href="https://www.digihunch.com/2022/11/key-mapping-on-external-pc-keyboard-on-macbook/">Digi Hunch&#39;s blog post</a> covers how to automatically load that configuration when the keyboard is plugged in.
</p>

<p>
{ <a href="https://amitp.blogspot.com/2023/04/mac-keyboard-with-hidutil.html">https://amitp.blogspot.com/2023/04/mac-keyboard-with-hidutil.html</a> }
</p>
<p>
Labels:
<a href="https://amitp.blogspot.com/search/label/howto" rel="tag">howto</a>,
<a href="https://amitp.blogspot.com/search/label/mac" rel="tag">mac</a>
</p>

</section>
<p>
<h4>
3 comments:
                  
</h4>
</p>

<!--Can't find substitution for tag [adEnd]-->
</div></div>
  </body>
</html>
