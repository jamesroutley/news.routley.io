<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nee.lv/2021/02/28/How-I-cut-GTA-Online-loading-times-by-70/">Original</a>
    <h1>I cut GTA Online loading times (2021)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
    <p>GTA Online. <a target="_blank" rel="noopener" href="https://www.reddit.com/r/gtaonline/comments/9vgo0g/how_the_fuck_are_20_minute_load_times_acceptable/">Infamous</a> for its slow loading times. Having picked up the game again to finish some of the newer heists I was <em>shocked</em> (/s) to discover that it still loads just as slow as the day it was released 7 years ago.</p>
<p>It was time. Time to get to the bottom of this.</p>
<h2 id="Recon"><a href="#Recon" title="Recon"></a>Recon</h2><p>First I wanted to check if someone had already solved this problem. Most of the results I found pointed towards anecdata about <a target="_blank" rel="noopener" href="https://metro.co.uk/2017/11/01/why-does-gta-v-take-so-long-to-load-7041927/">how the game is so sophisticated</a> that it needs to load so long, stories on how the <a target="_blank" rel="noopener" href="https://steamcommunity.com/app/271590/discussions/0/217690940938819317/">p2p network architecture</a> is rubbish (not saying that it isn‚Äôt), some elaborate ways of <a target="_blank" rel="noopener" href="https://gtaforums.com/topic/908000-fastest-way-to-load-into-gtao-single-player-first-or-straight-in/">loading into story mode and a solo session after that</a> and a couple of mods that allowed skipping the startup R* logo video. Some more reading told me we could save a whopping 10-30 seconds with these combined!</p>
<p>Meanwhile on my PC‚Ä¶</p>
<h2 id="Benchmark"><a href="#Benchmark" title="Benchmark"></a>Benchmark</h2><figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span>Story mode load time:  ~1m 10s</span></pre></td></tr></tbody></table></figure>

<p>I know my setup is dated but what on <em>earth</em> could take 6x longer to load into online mode? I couldn‚Äôt measure any difference using the story-to-online loading technique <a target="_blank" rel="noopener" href="https://www.reddit.com/r/gtaonline/comments/kycy7a/gtao_loading_times_using_different_methods/">as others have found before me</a>. Even if it did work the results would be down in the noise.</p>
<h2 id="I-Am-Not-Alone"><a href="#I-Am-Not-Alone" title="I Am (Not) Alone"></a>I Am (Not) Alone</h2><p>If <a target="_blank" rel="noopener" href="https://www.reddit.com/r/gtaonline/comments/ht4i56/your_average_online_loading_time/">this poll</a> is to be trusted then the issue is widespread enough to mildly annoy more than 80% of the player base. It‚Äôs been 7 years R*!</p>
<p><img src="https://nee.lv/images/pasted-0.png" alt="üéµWhat does the poll say?üéµ"/></p>
<p>Looking around a bit to find who are the lucky ~20% that get sub 3 minute load times I came across <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=RdCqDdjp6iU">a</a> <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=pJzr3qfyCyg">few</a> <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=RK7BUFx_NGk">benchmarks</a> with high-end gaming PCs and an online mode load time of about 2 minutes. I would <del>kill</del> <em>hack</em> for a 2 minute load time! It does seem to be hardware-dependent but something doesn‚Äôt add up here‚Ä¶</p>
<p>How come their story mode still takes near a minute to load? (The M.2 one didn‚Äôt count the startup logos btw.) Also, loading story to online takes them only a minute more while I‚Äôm getting about five more. I know that their hardware specs are a lot better but surely not 5x better.</p>
<h2 id="Highly-accurate-measurements"><a href="#Highly-accurate-measurements" title="Highly accurate measurements"></a>Highly accurate measurements</h2><p>Armed with such powerful tools as <em>the Task Manager</em> I began to investigate what resources could be the bottleneck.</p>
<p><img src="https://nee.lv/images/pasted-1.png" alt="Can you smell it?"/></p>
<p>After taking a minute to load the common resources used for both story and online modes (which is near on par with high-end PCs) GTA decides to max out a single core on my machine for four minutes and do nothing else.</p>
<p>Disk usage? None! Network usage? There‚Äôs a bit, but it drops basically to zero after a few seconds (apart from loading the rotating info banners). GPU usage? Zero. Memory usage? Completely flat‚Ä¶</p>
<p>What, is it mining crypto or something? I smell code. <em>Really bad code</em>.</p>
<h2 id="Single-thread-bound"><a href="#Single-thread-bound" title="Single thread-bound"></a>Single thread-bound</h2><p>While my old AMD CPU has 8 cores and it does pack a punch, it was made in the olden days. Back when AMD‚Äôs <a target="_blank" rel="noopener" href="https://valid.x86.fr/bench/6u7sdy/1">single-thread performance</a> was <em>way</em> behind Intel‚Äôs. This might not explain all of the load time differences but it should explain most of it.</p>
<p>What‚Äôs odd is that it‚Äôs using up <em>just</em> the CPU. I was expecting vast amounts of disk reads loading up resources or loads of network requests trying to negotiate a session in the p2p network. But this? This is probably a bug.</p>
<h2 id="Profiling"><a href="#Profiling" title="Profiling"></a>Profiling</h2><p>Profilers are a great way of finding CPU bottlenecks. There‚Äôs only one problem - most of them rely on instrumenting the source code to get a perfect picture of what‚Äôs happening in the process. And I don‚Äôt have the source code. Nor do I need microsecond-perfect readings - I have 4 minutes‚Äô worth of a bottleneck.</p>
<p>Enter stack sampling: for closed source applications there‚Äôs only one option. Dump the running process‚Äô stack and current instruction pointer‚Äôs location to build a calling tree in set intervals. Then add them up to get statistics on what‚Äôs going on. There‚Äôs only one profiler that I know of (might be ignorant here) that can do this on Windows. And it hasn‚Äôt been updated in over 10 years. It‚Äôs <a target="_blank" rel="noopener" href="http://lukestackwalker.sourceforge.net/">Luke Stackwalker</a>! Someone, please give this project some love :)</p>
<p><img src="https://nee.lv/images/pasted-2.png" alt="The power of statistics compels you!"/></p>
<p>Normally Luke would group the same functions together but since I don‚Äôt have debugging symbols I had to eyeball nearby addresses to guess if it‚Äôs the same place. And what do we see? Not one bottleneck but two of them!</p>
<h2 id="Down-the-rabbit-hole"><a href="#Down-the-rabbit-hole" title="Down the rabbit hole"></a>Down the rabbit hole</h2><p>Having borrowed <em>my friend‚Äôs</em> completely legitimate copy of <em>the industry-standard disassembler</em> (no, I really can‚Äôt afford the thing‚Ä¶ gonna learn to <a target="_blank" rel="noopener" href="https://ghidra-sre.org/">ghidra</a> one of these days) I went to take GTA apart.</p>
<p><img src="https://nee.lv/images/pasted-3.png" alt="Gibberish Galore"/></p>
<p>That doesn‚Äôt look right at all. Most high-profile games come with built-in protection against reverse engineering to keep away pirates, cheaters, and modders. Not that it has ever stopped them.</p>
<p>There seems to be some sort of an obfuscation/encryption at play here that has replaced most instructions with gibberish. Not to worry, we simply need to dump the game‚Äôs memory while it‚Äôs executing the part we want to look at. The instructions have to be de-obfuscated before running one way or another. I had <a target="_blank" rel="noopener" href="https://github.com/glmcdona/Process-Dump">Process Dump</a> lying around, so I used that, but there are plenty of other tools available to do this sort of thing.</p>
<h2 id="Problem-one-It‚Äôs‚Ä¶-strlen"><a href="#Problem-one-It‚Äôs‚Ä¶-strlen" title="Problem one: It‚Äôs‚Ä¶ strlen?!"></a>Problem one: It‚Äôs‚Ä¶ strlen?!</h2><p>Disassembling the now-less-obfuscated dump reveals that one of the addresses has a label pulled out of somewhere! It‚Äôs <code>strlen</code>? Going down the call stack the next one is labeled <code>vscan_fn</code> and after that the labels end, tho I‚Äôm fairly confident it‚Äôs <a target="_blank" rel="noopener" href="https://github.com/chakra-core/ChakraCore/blob/master/pal/src/safecrt/sscanf.c#L47"><code>sscanf</code></a>.</p>
<p><img src="https://nee.lv/images/pasted-4.png" alt="A graph a day keeps the skeptics away"/></p>
<p>It‚Äôs parsing something. Parsing what? Untangling the disassembly would take forever so I decided to dump some samples from the running process using <a target="_blank" rel="noopener" href="https://x64dbg.com/">x64dbg</a>. Some debug-stepping later it turns out it‚Äôs‚Ä¶ JSON! They‚Äôre parsing JSON. A whopping <strong>10 megabytes</strong> worth of JSON with some <strong>63k item entries</strong>.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span>...,</span></pre></td></tr></tbody></table></figure>

<p>What is it? It appears to be data for a ‚Äúnet shop catalog‚Äù according to some references. I assume it contains a list of all the possible items and upgrades you can buy in GTA Online.</p>
<p><strong>Clearing up some confusion: I beleive these are in-game money purchasable items, not directly linked with <a target="_blank" rel="noopener" href="https://gta.fandom.com/wiki/Cash_Cards">microtransactions</a>.</strong></p>
<p>But 10 megs? That‚Äôs nothing! And using <code>sscanf</code> may not be optimal but surely it‚Äôs not that bad? Well‚Ä¶</p>
<p><img src="https://nee.lv/images/pasted-5.png" alt="Ouch!"/></p>
<p>Yeah, that‚Äôs gonna take a while‚Ä¶ To be fair I had no idea most <code>sscanf</code> implementations called <code>strlen</code> so I can‚Äôt blame the developer who wrote this. I would assume it just scanned byte by byte and could stop on a <code>NULL</code>.</p>
<h2 id="Problem-two-Let‚Äôs-use-a-Hash-‚Ä¶-Array"><a href="#Problem-two-Let‚Äôs-use-a-Hash-‚Ä¶-Array" title="Problem two: Let‚Äôs use a Hash- ‚Ä¶ Array?"></a>Problem two: Let‚Äôs use a Hash- ‚Ä¶ Array?</h2><p>Turns out the second offender is called right next to the first one. They‚Äôre both even called in the same <code>if</code> statement as seen in this ugly decompilation:</p>
<p><img src="https://nee.lv/images/pasted-6.png" alt="Beggar thy neighbour"/></p>
<p>All labels are mine, no idea what the functions/parameters are actually called.</p>
<p>The second problem? Right after parsing an item, it‚Äôs stored in an array (or an inlined C++ list? not sure). Each entry looks something like this:</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span><span>struct</span> {</span></span></pre></td></tr></tbody></table></figure>

<p>But before it‚Äôs stored? It checks the <em>entire</em> array, one by one, comparing the hash of the item to see if it‚Äôs in the list or not. With ~63k entries that‚Äôs <code>(n^2+n)/2 = (63000^2+63000)/2 = 1984531500</code> checks if my math is right. Most of them useless. You have unique <em>hashes</em> why not use a <em>hash map</em>.</p>
<p><img src="https://nee.lv/images/pasted-7.png" alt="Oof!"/></p>
<p>I named it <code>hashmap</code> while reversing but it‚Äôs clearly <code>not_a_hashmap</code>. And it gets even better. The hash-array-list-thing is empty before loading the JSON. And all of the items in the JSON are unique! They don‚Äôt even <em>need</em> to check if it‚Äôs in the list or not! They even have a function to directly insert the items! Just use that! Srsly, WAT!?</p>
<h2 id="PoC"><a href="#PoC" title="PoC"></a>PoC</h2><p>Now that‚Äôs nice and all, but no one is going to take me seriously unless I test this so I can write a clickbait title for the post.</p>
<p>The plan? Write a <code>.dll</code>, inject it in GTA, <a target="_blank" rel="noopener" href="https://github.com/TsudaKageyu/minhook">hook</a> some functions, ???, profit.</p>
<p>The JSON problem is hairy, I can‚Äôt realistically replace their parser. Replacing <code>sscanf</code> with one that doesn‚Äôt depend on <code>strlen</code> would be more realistic. But there‚Äôs an even easier way.</p>
<ul>
<li>hook strlen</li>
<li>wait for a long string</li>
<li>‚Äúcache‚Äù the start and length of it</li>
<li>if it‚Äôs called again within the string‚Äôs range, return cached value</li>
</ul>
<p>Something like:</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span><span>size_t</span> <span>strlen_cacher</span><span>(<span>char</span>* str)</span></span></span></pre></td></tr></tbody></table></figure>

<p>And as for the hash-array problem, it‚Äôs more straightforward - just skip the duplicate checks entirely and insert the items directly since we know the values are unique.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span><span>char</span> __fastcall <span>netcat_insert_dedupe_hooked</span><span>(<span>uint64_t</span> catalog, <span>uint64_t</span>* key, <span>uint64_t</span>* item)</span></span></span></pre></td></tr></tbody></table></figure>

<p>Full source of PoC <a target="_blank" rel="noopener" href="https://github.com/tostercx/GTAO_Booster_PoC">here</a>.</p>
<h2 id="Results"><a href="#Results" title="Results"></a>Results</h2><p>Well, did it work then?</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span>Original online mode load time:        ~6m flat</span></pre></td></tr></tbody></table></figure>

<p>Hell yes, it did! :))</p>
<p>Most likely, this won‚Äôt solve everyone‚Äôs load times - there might be other bottlenecks on different systems, but it‚Äôs such a gaping hole that I have no idea how R* has missed it all these years.</p>
<h2 id="tl-dr"><a href="#tl-dr" title="tl;dr"></a>tl;dr</h2><ul>
<li>There‚Äôs a single thread CPU bottleneck while starting up GTA Online</li>
<li>It turns out GTA struggles to parse a 10MB JSON file</li>
<li>The JSON parser itself is poorly built / naive and</li>
<li>After parsing there‚Äôs a slow item de-duplication routine</li>
</ul>
<h2 id="R-please-fix"><a href="#R-please-fix" title="R* please fix"></a>R* please fix</h2><p>If this somehow reaches Rockstar: the problems shouldn‚Äôt take more than a day for a single dev to solve. Please do something about it :&lt;</p>
<p>You could either switch to a hashmap for the de-duplication or completely skip it on startup as a faster fix. For the JSON parser - just swap out the library for a more performant one. I don‚Äôt think there‚Äôs any easier way out.</p>
<p>ty &lt;3</p>
<h2 id="Small-update"><a href="#Small-update" title="Small update"></a>Small update</h2><p>I was expecting to get some attention but nowhere near this much! After reaching the top of <a target="_blank" rel="noopener" href="https://news.ycombinator.com/item?id=26296339">HN</a> this post has spread like wildfire! <strong>Thank you for the overwhelming response :)</strong></p>
<p>I‚Äôll do more writing if something interesting comes along, but don‚Äôt expect anything of this scale soon - there was a lot of luck involved.</p>
<p>A few people suggested spamming this post to Rockstar‚Äôs support - please don‚Äôt! I‚Äôm sure they‚Äôve seen this by now. Continuing would only bog down support tickets for everyone else. Social media is fair game in my book tho.</p>
<p>Several HN comments suggested I add a donate button, as they would like to buy me a beer (thank you!) so I‚Äôm placing a link in the footer.</p>
<p>Thank you for reading and all the support :)</p>
<h2 id="Update-2021-03-15"><a href="#Update-2021-03-15" title="Update 2021-03-15"></a>Update 2021-03-15</h2><ul>
<li>Got confirmation from R* that this is getting a fix soon</li>
<li>Just got awarded $10k through their H1 in-game bounty as an exception :)) (usually only for security issues)</li>
<li>Trying to figure out what‚Äôs a W8 and how to fill it (lol)</li>
<li>I did try asking for more technical details but they couldn‚Äôt say anything</li>
<li>Will do another  benchmark on my same old setup as soon as the update is out, I‚Äôm sure their engineers won‚Äôt disappoint :)</li>
</ul>
<h2 id="Update-2021-03-16"><a href="#Update-2021-03-16" title="Update 2021-03-16"></a>Update 2021-03-16</h2><p>R* <a target="_blank" rel="noopener" href="https://support.rockstargames.com/articles/360061161574/">released the update</a>! Downloaded it and got my first run results - same hardware, same measurement - from R* logo to fully online.</p>
<p><img src="https://nee.lv/images/pasted-8.png" alt="upload successful"/></p>
<p>Fully fixed! t0st approves!</p>
<p>Thanks again for all the coffees, and thanks to R* for taking the time to look into this and the generous bounty!</p>

  </div></div>
  </body>
</html>
