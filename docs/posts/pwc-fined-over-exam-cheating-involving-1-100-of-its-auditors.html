<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ft.com/content/2e246b48-a6a9-4dc6-b4fb-136b62ab3a3a">Original</a>
    <h1>PwC fined over exam cheating involving 1,100 of its auditors</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Hello! Here are some things you may or may not have noticed about DNS:</p>
<ul>
<li>when you resolve a DNS name in a Python program, it checks <code>/etc/hosts</code>, but when you use <code>dig</code>, it doesn’t.</li>
<li>switching Linux distributions can sometimes change how your DNS works, for example if you use Alpine Linux instead of Ubuntu it can cause problems.</li>
<li>Mac OS has DNS caching, but Linux doesn’t necessarily unless you use <code>systemd-resolved</code> or something</li>
</ul>
<p>To understand all of these, we need to learn about a function called
<code>getaddrinfo</code> which is responsible for doing DNS lookups.</p>
<p>There are a bunch of surprising-to-me things about <code>getaddrinfo</code>, and once I
learned about them, it explained a bunch of the confusing DNS behaviour I’d
seen in the past.</p>
<h3 id="where-does-getaddrinfo-come-from">where does <code>getaddrinfo</code> come from?</h3>
<p><code>getaddrinfo</code> is part of a library called <code>libc</code> which is the standard C
library. There are at least 3 versions of libc:</p>
<ol>
<li>glibc (GNU libc)</li>
<li>musl libc</li>
<li>the Mac OS version of libc (I don’t know if this has a name)</li>
</ol>
<p>There are definitely more (I assume FreeBSD and OpenBSD each have their own
version for example), but those are the 3 I know about.</p>
<p>Each of those have their own version of <code>getaddrinfo</code>.</p>
<h3 id="not-all-programs-use-getaddrinfo-for-dns">not all programs use <code>getaddrinfo</code> for DNS</h3>
<p>The first thing I found surprising is that <code>getaddrinfo</code> is very widely used
but not universally used.</p>
<p>Every program has basically 2 options:</p>
<ol>
<li>use <code>getaddrinfo</code>. I think that Python, Ruby, and Node use <code>getaddrinfo</code>, as well as Go sometimes. Probably many more languages too but I did not have the time to go hunting through every language’s DNS library.</li>
<li>use a custom DNS resolver function. Examples of this:
<ul>
<li>dig. I think this is because dig needs more control over the DNS query
than <code>getaddrinfo</code> supports so it implements its own DNS logic.</li>
<li>Go also has a pure-Go DNS resolver if you don’t want to use CGo</li>
<li>There’s a Ruby gem with a <a href="https://ruby-doc.org/stdlib-2.5.1/libdoc/resolv/rdoc/Resolv.html">custom DNS resolver</a> that you can use to replace <code>getaddrinfo</code>.</li>
<li><code>getaddrinfo</code> doesn’t support DNS over HTTPS, so I assume that browsers
that use DoH are not using <code>getaddrinfo</code> for those DNS lookups</li>
<li>probably lots more that I’m not aware of</li>
</ul></li>
</ol>
<h3 id="you-ll-sometimes-see-getaddrinfo-in-your-dns-error-messages">you’ll sometimes see <code>getaddrinfo</code> in your DNS error messages</h3>
<p>Because <code>getaddrinfo</code> is so widely used, you’ll often see it in error messages related to DNS.</p>
<p>For example if I run this Python program which looks up nonexistent domain name:</p>
<pre><code>import requests

requests.get(&#34;http://xyxqqx.com&#34;)
</code></pre>
<p>I get this error message:</p>
<pre><code>Traceback (most recent call last):
  File &#34;/usr/lib/python3.10/site-packages/urllib3/connection.py&#34;, line 174, in _new_conn
    conn = connection.create_connection(
  File &#34;/usr/lib/python3.10/site-packages/urllib3/util/connection.py&#34;, line 72, in create_connection
    for res in socket.getaddrinfo(host, port, family, socket.SOCK_STREAM):
  File &#34;/usr/lib/python3.10/socket.py&#34;, line 955, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno -2] Name or service not known
</code></pre>
<p>I think <code>socket.getaddrinfo</code> is calling libc <code>getaddrinfo</code> somewhere under the
hood, though I did not read all of the source code to check.</p>
<p>Before you learn what <code>getaddrinfo</code> is, it’s not at all obvious that
<code>socket.gaierror: [Errno -2] Name or service not known</code> means “that domain
doesn’t exist”. It doesn’t even say the words “DNS” or “domain” in it
anywhere!</p>
<h3 id="getaddrinfo-on-mac-doesn-t-use-etc-resolv-conf"><code>getaddrinfo</code> on Mac doesn’t use <code>/etc/resolv.conf</code></h3>
<p>I used to use a Mac for work, and I always felt vaguely unsettled by DNS on
Mac. I could tell that <strong>something</strong> was different from how it worked on my
Linux machine, but I couldn’t figure out what it was.</p>
<p>I still don’t totally understand this and it’s hard for me to investigate
because I don’t currently have access to a Mac but here’s what I’ve gathered
so far.</p>
<p>On Linux systems, <code>getaddrinfo</code> decides which DNS resolver to talk to using a
file called <code>/etc/resolv.conf</code>. <small>(there’s apparently some additional
complexity with <code>/etc/nsswitch.conf</code> but I have never looked at
<code>/etc/nsswitch.conf</code> so I’m going to ignore it).</small></p>
<p>For example, this is the contents of my <code>/etc/resolv.conf</code> right now:</p>
<pre><code># Generated by NetworkManager
nameserver 192.168.1.1
nameserver fd13:d987:748a::1
</code></pre>
<p>This means that to make DNS queries, <code>getaddrinfo</code> makes a request to
<code>192.168.1.1</code> on port 53. That’s my router’s DNS resolver.</p>
<p>I assumed this was <code>getaddrinfo</code> on Mac also just used <code>/etc/resolv.conf</code> but I was wrong.
Instead, <code>getaddrinfo</code> makes a request to a program called <code>mDNSResponder</code>
which is a Mac thing.</p>
<p>I don’t know much about <code>mDNSResponder</code> except that it does DNS caching and
that apparently you can clear the cache with <code>dscacheutil</code>. This explains one
of the mysteries at the beginning of the post – why Macs have DNS caching and
Linux machines don’t always.</p>
<h3 id="musl-libc-getaddrinfo-is-different-from-glibc-s-version">musl libc <code>getaddrinfo</code> is different from glibc’s version</h3>
<p>You might think ok, Mac OS <code>getaddrinfo</code> is different, but the two versions of
<code>getaddrinfo</code> in glibc and musl libc must be mostly the same, right?</p>
<p>But they have some pretty significant differences. The main difference I know
about is that musl libc does not support TCP DNS. I couldn’t find anything in
the documentation about it but it’s mentioned in <a href="https://twitter.com/RichFelker/status/994667677112156161">this tweet</a>)</p>
<p>I talked a bit more about this TCP DNS thing in <a href="https://jvns.ca/blog/2022/01/15/some-ways-dns-can-break/">ways DNS can break</a>.</p>
<p>Some more differences:</p>
<ul>
<li>the way search domains (in <code>/etc/resolv.conf</code>) are handled is slightly different (<a href="https://wiki.musl-libc.org/functional-differences-from-glibc.html#Name-Resolver/DNS">discussed here</a>)</li>
<li>this post mentions that <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/GlibcAndLinuxAPI">musl doesn’t support nsswitch.conf</a>.
I have never used nsswitch.conf and I’m not sure why it’s useful but I think
there are reasons I don’t know about.</li>
</ul>
<h3 id="more-weird-things-nscd">more weird things: nscd?</h3>
<p>When looking up getaddrinfo I also found this interesting <a href="https://jameshfisher.com/2018/02/03/what-does-getaddrinfo-do/">post about getaddrinfo from James Fisher</a> that
straces glibc <code>getaddrinfo</code> and discovers that apparently calls some
program called <code>nscd</code> which is supposed to do DNS caching. That blog post
describes nscd as “unstable” and “badly designed” and it’s not clear to me how
widely used it is.</p>
<p>I don’t know anything about nscd but I checked and apparently it’s on my
computer. I tried it out and this is what happened:</p>
<pre><code>$ nscd 
child exited with status 4
</code></pre>
<p>My impression is that people who want to do DNS caching on Linux are more
likely to use a DNS forwarder like <code>dnsmasq</code> or <code>systemd-resolved</code> instead of
something like <code>nscd</code> – that’s what I’ve seen in the past.</p>
<h3 id="that-s-all">that’s all!</h3>
<p>When I first learned about all of this I found it really surprising that such
a widely used library function has such different behaviour on different
platforms.</p>
<p>I mean, it makes sense that the people who built Mac OS would want to handle
DNS caching in a different way than it’s handled on Linux, so it’s reasonable
that they implemented <code>getaddrinfo</code> differently. And it makes sense that some
programs choose not to use <code>getaddrinfo</code> to make DNS queries.</p>
<p>But it definitely makes DNS a bit more difficult to reason about.</p>
</div></div>
  </body>
</html>
