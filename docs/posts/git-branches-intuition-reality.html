<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2023/11/23/branches-intuition-reality/">Original</a>
    <h1>git branches: intuition &amp; reality</h1>
    
    

<p>Hello! I&rsquo;ve been working on writing a zine about git so I&rsquo;ve been thinking
about git branches a lot. I keep hearing from people that they find the way git
branches work to be counterintuitive. It got me thinking:  what might an
&ldquo;intuitive&rdquo; notion of a branch be, and how is it different from how git
actually works?</p>

<p>So in this post I want to briefly talk about</p>

<ul>
<li>an intuitive mental model I think many people have</li>
<li>how git actually represents branches internally (the &ldquo;technically correct&rdquo; definition)</li>
<li>how the &ldquo;intuitive model&rdquo; and the real way it works are actually pretty closely related</li>
<li>some limits of the intuitive model and why it might cause problems</li>
</ul>

<p>Nothing in this post is remotely groundbreaking so I&rsquo;m going to try to keep it pretty short.</p>

<h3 id="an-intuitive-model-of-a-branch">an intuitive model of a branch</h3>

<p>Of course, people have many different intuitions about branches. Here&rsquo;s the one
that I think corresponds to the most closely to the physical &ldquo;a branch of an
apple tree&rdquo; metaphor.</p>

<p>My guess is that a lot of people think about a git branch like this: the 2
commits in pink in this picture are on a &ldquo;branch&rdquo;.</p>

<p><img src="https://jvns.ca/images/git-branch.png" width="200px"></p>

<p>I think there are two important things about this diagram:</p>

<ol>
<li>the branch has 2 commits on it</li>
<li>the branch has a &ldquo;parent&rdquo; (<code>main</code>) which it&rsquo;s an offshoot of</li>
</ol>

<p>That seems pretty reasonable, but that&rsquo;s not how git defines a branch &ndash; most
importantly, git doesn&rsquo;t have any concept of a branch&rsquo;s &ldquo;parent&rdquo;. So how does
git define a branch?</p>

<h3 id="in-git-a-branch-is-the-full-history">in git, a branch is the full history</h3>

<p>In git, a branch is the full history of every previous commit, not just the &ldquo;offshoot&rdquo; commits. So in our picture above both branches (<code>main</code> and <code>branch</code>) have 4 commits on them.</p>

<p>I made an example repository at <a href="https://github.com/jvns/branch-example">https://github.com/jvns/branch-example</a> which
has its branches set up the same way as in the picture above. Let&rsquo;s look at the
2 branches:</p>

<p><code>main</code> has 4 commits on it:</p>

<pre><code>$ git log --oneline main
70f727a d
f654888 c
3997a46 b
a74606f a
</code></pre>

<p>and <code>mybranch</code> has 4 commits on it too. The bottom two commits are shared
between both branches.</p>

<pre><code>$ git log --oneline mybranch
13cb960 y
9554dab x
3997a46 b
a74606f a
</code></pre>

<p>So <code>mybranch</code> has 4 commits on it, not just the 2 commits <code>13cb960</code> and <code>9554dab</code> that are &ldquo;offshoot&rdquo; commits.</p>

<p>You can get git to draw all the commits on both branches like this:</p>

<pre><code>$ git log --all --oneline --graph
* 70f727a (HEAD -&gt; main, origin/main) d
* f654888 c
| * 13cb960 (origin/mybranch, mybranch) y
| * 9554dab x
|/
* 3997a46 b
* a74606f a
</code></pre>

<h3 id="a-branch-is-stored-as-a-commit-id">a branch is stored as a commit ID</h3>

<p>Internally in git, branches are stored as tiny text files which have a commit ID in
them. That commit is the latest commit on the branch. This is the &ldquo;technically correct&rdquo; definition I was talking about at the beginning.</p>

<p>Let&rsquo;s look at the text files for <code>main</code> and <code>mybranch</code> in our example repo:</p>

<pre><code>$ cat .git/refs/heads/main
70f727acbe9ea3e3ed3092605721d2eda8ebb3f4
$ cat .git/refs/heads/mybranch
13cb960ad86c78bfa2a85de21cd54818105692bc
</code></pre>

<p>This makes sense: <code>70f727</code> is the latest commit on <code>main</code> and <code>13cb96</code> is the latest commit on <code>mybranch</code>.</p>

<p>The reason this works is that every commit contains a pointer to its parent(s),
so git can follow the chain of pointers to get every commit on the branch.</p>

<p>Like I mentioned before, the thing that&rsquo;s missing here is any relationship at
all between these two branches. There&rsquo;s no indication that <code>mybranch</code> is an
offshoot of <code>main</code>.</p>

<p>Now that we&rsquo;ve talked about how the intuitive notion of a branch is &ldquo;wrong&rdquo;, I
want to talk about how it&rsquo;s also right in some very important ways.</p>

<h3 id="people-s-intuition-is-usually-not-that-wrong">people&rsquo;s intuition is usually not that wrong</h3>

<p>I think it&rsquo;s pretty popular to tell people that their intuition about git is
&ldquo;wrong&rdquo;. I find that kind of silly &ndash; in general, even if people&rsquo;s intuition
about a topic is technically incorrect in some ways, people usually have the
intuition they do for very legitimate reasons! &ldquo;Wrong&rdquo; models can be super useful.</p>

<p>So let&rsquo;s talk about 3 ways the intuitive &ldquo;offshoot&rdquo; notion of a branch matches
up very closely with how we actually use git in practice.</p>

<h3 id="rebases-use-the-intuitive-notion-of-a-branch">rebases use the &ldquo;intuitive&rdquo; notion of a branch</h3>

<p>Now let&rsquo;s go back to our original picture.</p>

<p><img src="https://jvns.ca/images/git-branch.png" width="200px"></p>

<p>When you rebase <code>mybranch</code> on <code>main</code>, it takes the commits on the &ldquo;intuitive&rdquo;
branch (just the 2 pink commits) and replays them onto <code>main</code>.</p>

<p>The result is that just the 2 (<code>x</code> and <code>y</code>) get copied. Here&rsquo;s what that looks like:</p>

<pre><code>$ git switch mybranch
$ git rebase main
$ git log --oneline mybranch
952fa64 (HEAD -&gt; mybranch) y
7d50681 x
70f727a (origin/main, main) d
f654888 c
3997a46 b
a74606f a
</code></pre>

<p>Here <code>git rebase</code> has created two new commits (<code>952fa64</code> and <code>7d50681</code>) whose
information comes from the previous two <code>x</code> and <code>y</code> commits.</p>

<p>So the intuitive model isn&rsquo;t THAT wrong! It tells you exactly what happens in a
rebase.</p>

<p>But because git doesn&rsquo;t know that <code>mybranch</code> is an offshoot of <code>main</code>, you need
to tell it explicitly where to rebase the branch.</p>

<h3 id="merges-use-the-intuitive-notion-of-a-branch-too">merges use the &ldquo;intuitive&rdquo; notion of a branch too</h3>

<p>Merges don&rsquo;t copy commits, but they do need a &ldquo;base&rdquo; commit: the way merges
work is that it looks at two sets of changes (starting from the shared base)
and then merges them.</p>

<p>Let&rsquo;s undo the rebase we just did and then see what the merge base is.</p>

<pre><code>$ git switch mybranch
$ git reset --hard 13cb960  # undo the rebase
$ git merge-base main mybranch
3997a466c50d2618f10d435d36ef12d5c6f62f57
</code></pre>

<p>This gives us the &ldquo;base&rdquo; commit where our branch branched off, <code>3997a4</code>.
That&rsquo;s exactly the commit you would think it might be based on our intuitive
picture.</p>

<h3 id="github-pull-requests-also-use-the-intuitive-idea">github pull requests also use the intuitive idea</h3>

<p>If we create a pull request on GitHub to merge <code>mybranch</code> into <code>main</code>, it&rsquo;ll
also show us 2 commits: the commits <code>x</code> and <code>y</code>. That makes sense and also
matches our intuitive notion of a branch.</p>

<p><img src="https://jvns.ca/images/gh-pr.png" width="300px"></p>

<p>I assume if you make a merge request on GitLab it shows you something similar.</p>

<h3 id="intuition-is-pretty-good-but-it-has-some-limits">intuition is pretty good, but it has some limits</h3>

<p>This leaves our intuitive definition of a branch looking pretty good actually!
The &ldquo;intuitive&rdquo; idea of what a branch is matches exactly with how merges and
rebases and GitHub pull requests work.</p>

<p>You do need to explicitly
specify the other branch when merging or rebasing or making a pull request (like <code>git rebase main</code>),
because git doesn&rsquo;t know what branch you think your offshoot is based on.</p>

<p>But the intuitive notion of a branch has one fairly serious problem: the way
you intuitively think about <code>main</code> and an offshoot branch are very different,
and git doesn&rsquo;t know that.</p>

<p>So let&rsquo;s talk about the different kinds of git branches.</p>

<h3 id="trunk-and-offshoot-branches">trunk and offshoot branches</h3>

<p>To a human, <code>main</code> and <code>mybranch</code> are pretty different, and you probably have
pretty different intentions around how you want to use them.</p>

<p>I think it&rsquo;s pretty normal to think of some branches as being &ldquo;trunk&rdquo; branches,
and some branches as being &ldquo;offshoots&rdquo;. Also you can have an offshoot of an
offshoot.</p>

<p>Of course, git itself doesn&rsquo;t make any such distinctions (the term &ldquo;offshoot&rdquo;
is one I just made up!), but what kind of a branch it is definitely affects how
you treat it.</p>

<p>For example:</p>

<ul>
<li>you might rebase <code>mybranch</code> onto <code>main</code> but you probably wouldn&rsquo;t rebase <code>main</code> onto <code>mybranch</code> &ndash; that would be weird!</li>
<li>in general people are much more careful around rewriting the history on &ldquo;trunk&rdquo; branches than short-lived offshoot branches</li>
</ul>

<h3 id="git-lets-you-do-rebases-backwards">git lets you do rebases &ldquo;backwards&rdquo;</h3>

<p>One thing I think throws people off about git is &ndash; because git doesn&rsquo;t
have any notion of whether a branch is an &ldquo;offshoot&rdquo; of another branch, it
won&rsquo;t give you any guidance about if/when it&rsquo;s appropriate to rebase branch X
on branch Y. You just have to know.</p>

<p>for example, you can do either:</p>

<pre><code>$ git checkout main
$ git rebase mybranch
</code></pre>

<p>or</p>

<pre><code>$ git checkout mybranch
$ git rebase main
</code></pre>

<p>Git will happily let you do either one, even though in this case <code>git rebase main</code> is
extremely normal and <code>git rebase mybranch</code> is pretty weird. A lot of people
said they found this confusing so here&rsquo;s a picture of the two kinds of rebases:</p>

<p><img src="https://jvns.ca/images/backwards-rebase.png"></p>

<p>Similarly, you can do merges &ldquo;backwards&rdquo;, though that&rsquo;s much more normal than
doing a backwards rebase &ndash; merging <code>mybranch</code> into <code>main</code> and <code>main</code> into
<code>mybranch</code> are both useful things to do for different reasons.</p>

<p>Here&rsquo;s a diagram of the two ways you can merge:</p>

<p><img src="https://jvns.ca/images/merge-two-ways.png"></p>

<h3 id="git-s-lack-of-hierarchy-between-branches-is-a-little-weird">git&rsquo;s lack of hierarchy between branches is a little weird</h3>

<p>I hear the statement &ldquo;the <code>main</code> branch is not special&rdquo; a lot and I&rsquo;ve been
puzzled about it &ndash; in most of the repositories I work in, <code>main</code> <strong>is</strong>
pretty special! Why are people saying it&rsquo;s not?</p>

<p>I think the point is that even though branches <strong>do</strong> have relationships
between them (<code>main</code> is often special!), git doesn&rsquo;t know anything about those
relationships.</p>

<p>You have to tell git explicitly about the relationship between branches every
single time you run a git command like <code>git rebase</code> or <code>git merge</code>, and if you
make a mistake things can get really weird.</p>

<p>I don&rsquo;t know whether git&rsquo;s design here is &ldquo;right&rdquo; or &ldquo;wrong&rdquo; (it definitely has
some pros and cons, and I&rsquo;m very tired of reading endless arguments about
it), but I do think it&rsquo;s surprising to a lot of people for good reason.</p>

<h3 id="in-github-the-default-branch-is-special">in GitHub, the default branch is special</h3>

<p>Also, it&rsquo;s worth mentioning that GitHub does have a &ldquo;special branch&rdquo;: every
github repo has a &ldquo;default branch&rdquo; (in git terms, it&rsquo;s what <code>HEAD</code> points at),
which is special in the following ways:</p>

<ul>
<li>it&rsquo;s what you check out when you <code>git clone</code> the repository</li>
<li>it&rsquo;s the default destination for pull requests</li>
<li>github will suggest that you protect the default branch from force pushes</li>
</ul>

<p>and probably even more that I&rsquo;m not thinking of.</p>

<h3 id="that-s-all">that&rsquo;s all!</h3>

<p>This all seems extremely obvious in retrospect, but it took me a long time to
figure out what a more &ldquo;intuitive&rdquo; idea of a branch even might be because I was
so used to the technical &ldquo;a branch is a reference to a commit&rdquo; definition.</p>

<p>I also hadn&rsquo;t really thought aoout how git makes you tell it about the
hierarchy between your branches every time you run a <code>git rebase</code> or <code>git
merge</code> command &ndash; for me it&rsquo;s second nature to do that and it&rsquo;s not a big deal,
but now that I&rsquo;m thinking about it, it&rsquo;s pretty easy to see how somebody could
get mixed up.</p>

  </body>
</html>
