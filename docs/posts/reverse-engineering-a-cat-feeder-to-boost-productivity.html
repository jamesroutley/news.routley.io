<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.sensibledefaults.io/blog/reverse-engineering-cat-feeder/index">Original</a>
    <h1>Reverse Engineering a Cat Feeder to Boost Productivity</h1>
    
    <div id="readability-page-1" class="page"><div><p><img src="https://www.sensibledefaults.io/static/images/feeder/idea.jpg" alt="overview"/></p>
<p>I&#39;ve been laughing about it this weekend and had to write it up - After some late-night Amazon&#39;ing I got a <a target="_blank" rel="noopener noreferrer" href="https://amzn.to/3ecgCF7">PetKit FreshElement Solo</a>. I had two problems it could solve: low side project motivation, and loving <a target="_blank" rel="noopener noreferrer" href="https://www.target.com/p/himalayan-salted-dark-chocolate-almonds-37oz-good-38-gather-8482/-/A-81418159">Target&#39;s Dark Chocolate Sea Salt Almonds</a> way too much. I&#39;m a codemonkey - Why not feed my monkey brain when I push code?</p>
<p>I couldn&#39;t find a USB candy dispenser (I even checked thinkgeek, nothing close!), so I figured I&#39;d try a cat feeder. This thing rocks, and I&#39;ll show you how to replicate what I did.</p>
<h2>Teaser</h2>
<iframe width="420" height="640" src="https://www.youtube.com/embed/D2GqVWuo-yY" title="Commit Candy Dispenser" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<p>Code: <a target="_blank" rel="noopener noreferrer" href="https://github.com/morganpartee/pyPetKit/blob/master/run.py"><code>https://github.com/morganpartee/pyPetKit/blob/master/run.py</code></a></p>
<p>To run yourself, you&#39;ll have to set your username and password here: <a target="_blank" rel="noopener noreferrer" href="https://github.com/morganpartee/pyPetKit/blob/master/settings.py"><code>https://github.com/morganpartee/pyPetKit/blob/master/settings.py</code></a></p>
<h2>An Overview</h2>
<p>REST API&#39;s are basically the language of the internet. Most products use them to talk from devices to servers. I saw some old Python code that had the authentication flow worked out already, so I had somewhere to start!</p>
<p>I snooped for the API request that did a manual feeding, replicated that in Python with Requests, and tied that script to a button on my streamdeck, which also sends a <code>ctl+enter</code> to send the commit!</p>
<p>There are other (better) ways to do this - AWS, webhooks, git hooks (git hooks probably being the best bet), but I wanted this to work locally only, so I&#39;m not dispensing candy while I&#39;m out of town. No need to overcomplicate! Worst case I forget to use the button and eat less candy.</p>
<h2>The Hardware</h2>
<p>I really can&#39;t overstate - This thing is perfect for dispensing snacks. The food is portioned by this neat little silicone auger system, with silicone fingers that limit the amount that can pass into the dispenser. It&#39;s clever, and gentle on the food. And food safe!</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/auger-down.jpg" alt="Auger Top View"/>
<img src="https://www.sensibledefaults.io/static/images/feeder/auger-side.jpg" alt="Auger Side View"/></p>
<p>And this was just cute:</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/neat.jpg" alt="Cute"/></p>
<p>They include a sizing chart for food that says it should be under 12mm:</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/sizer.jpg" alt="Sizing"/></p>
<p>But it filters and portions food like:</p>

<p><a href="https://giphy.com/gifs/77wE44ZtsIhZAT2ma0">via GIPHY</a></p>
<p>So if it is 12mm tall sideways, it&#39;ll work fine. I plan to test jerky chunks and cheez balls in the future. It includes a desiccant packet in the lid to keep stuff fresh... So I expect it&#39;s pretty safe to get wild.</p>
<p>As of writing they&#39;re about 70$, but they work great and are built well: <a target="_blank" rel="noopener noreferrer" href="https://amzn.to/3ecgCF7">Buy Here</a></p>
<h2>App</h2>
<p>The app is pretty good. It&#39;s a little weird if you don&#39;t have a pet... I had to add myself as a dog and pick my &#34;breed&#34;:
<img src="https://www.sensibledefaults.io/static/images/feeder/app.png" alt="Breed Picker"/></p>
<p>But after that I was able to use the API. After testing the serving size with the app a few times! 1/10th of a cup is one half of the rotor - Which averages out to about five almonds.</p>
<h2>Snooping</h2>
<p>I used <a target="_blank" rel="noopener noreferrer" href="https://play.google.com/store/apps/details?id=app.greyshirts.sslcapture&amp;hl=en_US&amp;gl=US">Packet Capture for Android</a> while I ran a manual feeding:</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/feed.png" alt="Packet"/></p>
<p>And found this request:</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/packet.png" alt="Packet"/></p>
<p>There&#39;s no real silver bullet here, I had to look through a few groups of requests to find the right one. But we can see it hits the <code>/latest/d4/saveDailyFeed</code> endpoint, which gives us a big hint! The <code>URLENCODED</code> section tells us that <code>amount</code>, <code>time</code>, and <code>deviceId</code> are included in the URL... So we can replicate it locally!</p>
<p>Andy and I have covered how to do this on desktop <a target="_blank" rel="noopener noreferrer" href="https://www.sensibledefaults.io/blog/dont-scrape/index">Here!</a></p>
<h2>Coding</h2>
<p>Code is available <a target="_blank" rel="noopener noreferrer" href="https://github.com/morganpartee/pyPetKit">here!</a></p>
<p>I started with <a target="_blank" rel="noopener noreferrer" href="https://github.com/geeks4hire/pyPetKit"><code>geeks4hire</code>&#39;s fork of PyPetKit</a>. It had the auth flow worked out for me, I just had to add a way to hit the API. I knew the endpoint I had to hit from the packet above, so I added a generic function to send requests to the API to my fork of the package:</p>
<div><pre><code> def send_api_request(self, path, method=&#34;POST&#34;, params=None, json=None):
        &#34;&#34;&#34;
        Sends an API request.
        &#34;&#34;&#34;
        custom_headers = {
            &#34;X-Session&#34;: self._access_token,
            &#34;User-Agent&#34;: &#34;PETKIT/7.26.1 (iPhone; iOS 14.7.1; Scale/3.00)&#34;,
            &#34;X-Timezone&#34;: f&#34;{round(self._tzone._utcoffset.seconds/60/60)}.0&#34;,
            &#34;X-Api-Version&#34;: &#34;7.26.1&#34;,
            &#34;X-Img-Version&#34;: &#34;1&#34;,
            &#34;X-TimezoneId&#34;: self._tzone.zone,
            &#34;X-Client&#34;: &#34;ios(14.7.1;iPhone13,4)&#34;,
            &#34;X-Locale&#34;: self._locale.replace(&#34;-&#34;, &#34;_&#34;),
        }

        return requests.request(
            method,
            self._apiServerBaseURL + path,
            headers=custom_headers,
            params=params,
            json=json,
        ).json()
</code></pre></div>
<p>This looks complicated, but the headers were copied from someone doing exactly what I did from an iphone. This uses requests (<code>requests.request</code>) to make an HTTP request, with whatever method. This is exactly what a browser does, but with Python! We cover this in detail in the scraping talk mentioned above - If you can copy the headers, you can do a lot!</p>
<p>Then getting those sweet sweet almonds is as easy as:</p>
<div><pre><code>from pypetkit import PetKitAPI
from settings import (
    API_USERNAME,
    API_PASSWORD,
    API_COUNTRY_CODE,
    API_LOCALE_CODE,
    API_TIMEZONE,
)
from pprint import pprint

petkit_api = PetKitAPI(
    API_USERNAME, API_PASSWORD, API_COUNTRY_CODE, API_LOCALE_CODE, API_TIMEZONE
)

#! Sign in
petkit_api.request_token()

print(f&#34;Authorized: {petkit_api.is_authorized}&#34;)

#! Send the actual feeding request
pprint(
    petkit_api.send_api_request(
        &#34;d4/saveDailyFeed&#34;, params={&#34;deviceId&#34;: 10019856, &#34;amount&#34;: 10, &#34;time&#34;: -1}
    )
)
</code></pre></div>
<p>We leverage the existing code&#39;s authentication flow, then send our request. The parameters match the request we found when we did a manual feeding from the app! I did try a smaller serving size, but 10 seems to be the smallest amount it can dispense. The <code>-1</code> seems to make it feed immediately. You can schedule feedings in the app, I&#39;d bet you can do that with dates too.</p>
<p>If it works, you&#39;ll see an output like this from <code>run.py</code>:</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/works.png" alt="It works!"/></p>
<p>And a little beep, followed by the beautiful sound of a reward hitting your <em>(don&#39;t think about it too much, it&#39;s only slightly degrading)</em> bowl:</p>

<p><a href="https://giphy.com/gifs/ZhB7JUPMlTsdWnqIi0">via GIPHY</a></p>
<h2>&#34;Deploying&#34;</h2>
<p>Deploying is a strong word, but that&#39;s what I&#39;d call it. I&#39;m running this locally so I don&#39;t dispense food when I&#39;m away from home. I have an <a target="_blank" rel="noopener noreferrer" href="https://amzn.to/3CJsbwM">Elgato Stream Deck</a> that I love, that I used to make the hotkey.</p>
<p><img src="https://www.sensibledefaults.io/static/images/feeder/hotkey.png" alt="Hotkey"/></p>
<p>The <code>System:Hotkey</code> sends <code>Ctl+Enter</code> to send the commit when I&#39;m done writing the message. The <code>System:Open</code> key opens <code>python c:/&lt;path&gt;/run.py</code>, which feeds me sweet chocolatey reinforcement for my good coding habits!</p>
<p>You could 100% do this &#34;better&#34;, but there&#39;s no need for cloud stuff or whatever for a goofy little project. It&#39;s just part of the fun!</p>
<h2>Conclusion</h2>
<p>Huge thanks to everyone that had reverse-engineered this gear before me. All that was left was finding the endpoint and making the request, which was too easy! Who knows if it&#39;ll be a real coding reinforcement, but I hadn&#39;t seen someone do it before, and I&#39;m glad I gave it a shot. Troubleshooting CI problems has gotten a lot sweeter.</p>
<h2>Security Note</h2>
<p>You&#39;ll see that the data for these products is sent in plaintext to and from their servers... No HTTPS... That&#39;s just sketchy. They send your complete location too, which is further sketchy. I&#39;d avoid using the app as much as you can, and use a one time password for when it gets breached... Because it really might happen at some point.</p>
<h2>Resources</h2>
<p><a target="_blank" rel="noopener noreferrer" href="https://amzn.to/3ecgCF7">PETKIT Fresh Element Solo</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/morganpartee/pyPetKit">Github Repo</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://play.google.com/store/apps/details?id=app.greyshirts.sslcapture&amp;hl=en_US&amp;gl=US">Packet Capture for Android</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://amzn.to/3CJsbwM">Elgato Stream Deck</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://www.target.com/p/himalayan-salted-dark-chocolate-almonds-37oz-good-38-gather-8482/-/A-81418159">Target&#39;s Dark Chocolate Sea Salt Almonds</a> (Seriously, they rock)</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/_JohnPartee?s=20&amp;t=hVajnrlA4otHIAyu81VRjQ">Follow Me On Twitter</a></p></div></div>
  </body>
</html>
