<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://justine.lol/redbean2/">Original</a>
    <h1>Redbean 2.0 turned into more than a hobby project</h1>
    
    <div id="readability-page-1" class="page">

<p>
June 16<sup>th</sup>, 2022 @ <a href="https://justine.lol/index.html">justine&#39;s web page</a>
</p>

<img src="https://storage.googleapis.com/justine/redbean2/redbean.png" alt="[lobbie the lobster]" width="223" height="223"/>
<p>
<a href="https://redbean.dev">redbean</a> is a webserver in a zip
executable that runs on six operating systems. The basic idea is if you
want to build a web app that runs anywhere, then you download the
redbean.com file, put your .html and .lua files inside it using the zip
command, and then you&#39;ve got a hermetic app you can deploy and share. I
introduced this web server about a year ago on Hacker News, where it
became the <a href="https://bestofshowhn.com/">third most upvoted hobby
project</a> of all time.

</p><p>
Over the last year, we&#39;ve turned redbean into more than a hobby project.
It&#39;s grown to become a 1.9mb file that self-hosts a Lua + SQLite
development stack. There&#39;s builtin MbedTLS support. It does sandboxing.
It has argon2 password hashing. It can geolocate IPs with MaxMind. It
has a readline-like REPL. You can use it as a Lua shebang interpreter.
It has an <a href="https://redbean.dev/2.0.html#functions">easy-mode API</a> and a
<a href="https://github.com/pkulchenko/fullmoon">Fullmoon</a> web
framework for high-level development. It also has a hard-mode API that
provides direct access to <a href="https://justine.lol/cosmopolitan/">Cosmopolitan
Libc</a> Unix system calls. You can use Unix on Windows, or even from
JavaScript too, since redbean is great for spinning up a web GUI in
Chrome via localhost. You can also use redbean as a production web
server on the public-facing internet. I stand by that statement since I
eat my own dogfood. redbean hosts all my websites now, including this
one (justine.lol). There&#39;s no need for a proxy like nginx; redbean is
vertically integrated.

</p><h2 class="page" id="download">
  <a href="#download">
    Download
     
    <img src="https://storage.googleapis.com/justine/redbean/linux.png" title="Linux" alt="[Linux]" width="28" height="32"/>
    <img src="https://storage.googleapis.com/justine/redbean/windows10.png" title="Windows" alt="[Windows]" width="32" height="32"/>
    <img src="https://storage.googleapis.com/justine/redbean/macos.png" title="MacOS" alt="[MacOS]" width="26" height="32"/>
    <img src="https://storage.googleapis.com/justine/redbean/freebsd64.png" title="FreeBSD" alt="[FreeBSD]" width="29" height="32"/>
    <img src="https://storage.googleapis.com/justine/redbean/openbsd.png" title="OpenBSD" alt="[OpenBSD]" width="34" height="32"/>
    <img src="https://storage.googleapis.com/justine/redbean/netbsd2.png" title="NetBSD" alt="[NetBSD]" width="32" height="32"/>
  </a>
</h2>

<p>
Your redbean supports x86-64 Linux, MacOS, FreeBSD, NetBSD, or OpenBSD.
Visit <a href="https://redbean.dev/2.0.html">redbean.dev/2.0.html</a> to
download the release binary. redbean is permissively licensed under the
ISC license. The
<a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/redbean.c">source
code</a> is available on GitHub. Instructions
for <a href="https://redbean.dev/#source1">building redbean from
source</a> on Linux are available at redbean.dev.

</p><pre>curl https://redbean.dev/redbean-demo-2.0.3.com &gt;redbean.com
chmod +x redbean.com
./redbean.com -v
</pre>

<p>
PowerShell users can use:

</p><pre>wget -O redbean.com https://redbean.dev/redbean-demo-2.0.3.com
./redbean.com -v
</pre>

<h2 class="page" id="loader">
  <a href="#loader">
    APE Loader
  </a>
</h2>

<p>
redbean 2.0 uses the new
<a href="https://justine.lol/apeloader/">APE Loader</a> which lets your
redbean execute without having to self-modify its header. What happens
instead is the <code>ape</code> command will <code>mmap()</code> your
redbean into memory. It&#39;s just as fast. If APE isn&#39;t installed on a
system, then the shell script header will extract it automatically.
There&#39;s shebang support and binfmt_misc support on Linux too. These
changes will have an enabling impact for distros and build systems, who
had difficulties packaging and distributing APE software. For users who
want the original behavior, an <code>--assimilate</code> flag is
introduced that will turn your redbean into the platform-local ELF or
Mach-O format.

</p><p>
In addition to helping distributors, the redbean 2.0 release helps
self-distributors too. You can now place a
<a href="https://redbean.dev/2.0.html#argfile"><code>.args</code>
file</a> in your redbean that specifies the default CLI arguments. This
can help make it easier to white-label redbean, especially if it&#39;s being
used as an alternative to the standard Lua interpreter command.

</p><h2 class="page" id="repl">
  <a href="#repl">
    REPL
  </a>
</h2>

<p>
redbean 2.0 introduces a Read Eval Print Loop or REPL for short. It&#39;s
built on the <a href="https://github.com/jart/bestline">bestline</a>
library, since it provides near parity with GNU Readline in terms of
features, except it&#39;s licensed MIT instead of LGPL, so there&#39;s no
dynamic linking requirement. redbean can&#39;t dynamically link things,
since then it wouldn&#39;t be a single file. I put a lot of work into
creating bestline, a linenoise fork, for that very reason. Here&#39;s a
short screencast of the redbean repl being used.

</p>


<p>
Since the video goes by quickly, here&#39;s an explanation of what happened.
The video starts by running
<code>redbean-demo.com -Zv</code> in the terminal. The <code>-v</code>
flag increases the logging verbosity. The <code>-Z</code> flag enables
system call tracing, so you can monitor all the powerful things you&#39;re
doing with the new UNIX module. It works similar to
the <code>--strace</code> flag that I blogged about last week under
<a href="https://justine.lol/ftrace/">Logging C Functions</a>. Once you see
the <code>&gt;:</code> prompt, your redbean REPL is ready to receive
commands.

</p><pre>&gt;: Benchmark(unix.clock_gettime)
125     389      594       1
</pre>

<p>
You can call most of the redbean Lua APIs from this shell. If you&#39;ve
defined global variables and functions in the zip file
<code>.init.lua</code> then you can call those functions too. The
example shown above in the video is of microbenchmarking. In the video
you&#39;ll notice <a href="https://justine.lol/redbean2/unix.clock_gettime">unix.clock_gettime()</a>
takes 125 nanoseconds to run. It&#39;s helpful to be able to run one-off
live experiments like this, since when I made that video for the
sponsors-only pre-release, it helped me realize I could use the Linux
vDSO to make <code>unix.clock_gettime()</code> 10x faster!

</p><pre>&gt;: Benchmark(unix.clock_gettime)
17      53      88      1
</pre>

<p>
So 17 nanoseconds is now the performance you can expect in 2.0. You&#39;ll
also see me computing binary numbers on the command line, like SHA-256.

</p><pre>&gt;: Sha256(<span>&#39;hello&#39;</span>)
<span>&#34;,\xf2M\xba_\xb0\xa3\x0e&amp;\xe8;*\xc5\xb9\xe2\x9e\x1b\x16\x1e\\x1f\xa7B^s\x043b\x93\x8b\x98$&#34;</span>
</pre>

<p>
redbean embraces and extends Lua in many ways. For example, the normal
Lua command line will print <code>,�M�_��&amp;�;*Ź�\x1f�B^s3b���$</code> for the
binary value above. I figured if a REPL&#39;s input is code, then its output
<em>must</em> be code too, since that&#39;s how LISP does things. Anything
your redbean REPL outputs, can usually be copy and pasted back into your
scripts.

</p><h3>Code Completion</h3>

<p>
The next thing you&#39;ll see in the video is the new tab completion
feature. Like bash, you can press <code>&lt;tab&gt;&lt;tab&gt;</code> to
see a listing of all available global functions and objects. If you
press <code>unix.&lt;tab&gt;&lt;tab&gt;</code> then you&#39;ll see all the
objects and functions available in the unix module.

</p><h3>GNU Emacs Keyboard Shortcuts</h3>

<p>
Users of GNU Emacs will be delighted to hear that your redbean REPL
supports nearly all the common GNU-style keyboard chording shortcuts,
including <code>CTRL-R</code> for reverse search. See the
<a href="https://redbean.dev/#keyboard">keyboard reference</a> for
further details.

</p><h3>Monkey Patching</h3>

<p>
One of the use cases for having a REPL on a live web server, is you can
monkey patch code while your server is running. redbean is a forking web
server. That means the main process behaves like a master template from
which worker processes are cloned. Therefore, anything you change in the
REPL will propagate lazily into client connections, as new ones roll in,
without impacting the connections currently active.

</p><h2 class="page" id="tracing">
  <a href="#tracing">
    Tracing Support
  </a>
</h2>

<p>
redbean 2.0 introduces optional system call logging. The last thing
you&#39;ll notice in the REPL video above (but can&#39;t actually see) is I fire
off a request to redbean from curl. Since we passed <code>-Z</code> we
get a nice system call trace. This logging can all be happening
seamlessly while you&#39;re typing on the REPL.

</p><pre>SYS  15987              7&#39;977 close(4) → 0
SYS  15987             14&#39;055 close(5) → 0
SYS  15987            191&#39;846 read(6, [u&#34;GET /tool/net/demo/index.html HTTP/1.1♪◙&#34;...], 65&#39;536) → 137
I2022-06-13T16:37:34+000400:tool/net/redbean.c:5798:redbean-demo:15987] (req) received 127.0.0.1:57542 HTTP11 GET http://127.0.0.1:8080/tool/net/demo/index.html &#34;&#34; &#34;curl/7.79.1&#34;
SYS  15987            308&#39;231 sigaction(SIGINT, {.sa_handler=0x41da5e, .sa_flags=0x80000000, .sa_mask={}}, [{.sa_handler=0x419305, .sa_flags=0x4000000, .sa_mask={}}]) → 0
V2022-06-13T16:37:34+000063:tool/net/redbean.c:6004:redbean-demo:15987] (rsp) 200 OK
SYS  15987            341&#39;459 sigaction(SIGINT, {.sa_handler=0x419305, .sa_flags=0x4000000, .sa_mask={}}, [NULL]) → 0
SYS  15987            352&#39;506 writev(6, {{u&#34;HTTP/1.1 200 OK♪◙Content-Type: text/html&#34;..., 306}, {u&#34;▼ï◘      ♥&#34;, 10}, {u&#34;àRMN▌0►▐τ¶So╪└ïTuüP^╢E]s☺█↓↕âc╗€q≤┬Ü♂!⌡]&#34;..., 511}, {u&#34;╠↑♦φü♥  &#34;, 8}}, 4) → 835
SYS  15987            679&#39;711 read(6, [u&#34;&#34;], 65&#39;536) → 0
SYS  15987            683&#39;584 _Exit(0)
&gt;:
</pre>

<p>
Here we see the redbean worker process closing the server socket file
descriptors. The nicest thing about using fork() as the basis of a web
server, is it creates a very safe level of isolation between clients.
For instance, if a redbean worker processes dies, then it&#39;ll die in a
safe space that won&#39;t impact the server as a whole. redbean will also do
things like wipe SSL keys from memory after fork(), so a compromised
worker won&#39;t be able to read them. We also see some sigaction() overhead
in the trace from the video. That&#39;s only needed since redbean is running
in a mode where the REPL is active.

</p><p>
Once the worker process has established itself, the thing that makes
redbean so lightning fast is that it only needs a single system call to
serve each response message. That system call is writev(), which helps
us avoid having to copy buffers. In fact, it&#39;s an even nicer paradigm
than sendfile() since you&#39;ll notice the writev() call has two buffers.
The first is the headers we had to generate. The second is compressed
zip executable content, which is a zero copy operation that happens in
kernelspace, because we used mmap() to load it into memory.

</p><h2 class="page" id="benchmark">
  <a href="#benchmark">
    Benchmark
  </a>
</h2>

<p>
When I spoke about redbean at
<a href="https://youtu.be/1ZTRb-2DZGs?t=761">SpeakEasy JS [YouTube
Video]</a> last year, I loved bragging about how redbean, a supposedly
slow forking web server, benchmarked at a million qps on my PC when
nginx could only do half that. Is it possible to improve upon
perfection? It turns out, I ran
<a href="https://github.com/wg/wrk">wrk</a> again for our 2.0 release,
and redbean did 1.1 million qps.

</p><pre><span># Note: Benchmarked on an Intel® Core™ i9-9900 CPU</span>
<span># Note: Use redbean-demo.com -s</span>
$ wrk --latency -t 10000 -c 10000 -H <span>&#39;Accept-Encoding: gzip&#39;</span> \
    http://127.0.0.1:8080/tool/net/demo/index.html
Running 10s test @ http://127.0.0.1:8080/tool/net/demo/index.html
  10000 threads and 10000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    10.44ms   46.76ms   1.76s    98.41%
    Req/Sec   189.08    259.45    39.10k    98.67%
  Latency Distribution
     50%    5.68ms
     75%    6.87ms
     90%    8.77ms
     99%  197.91ms
  4327728 requests in 3.72s, 3.37GB read
  Socket errors: connect 0, read 5, write 0, timeout 2
Requests/sec: 1163062.91
Transfer/sec:      0.90GB
</pre>

<h2 class="page" id="unix">
  <a href="#unix">
    Unix Module
  </a>
</h2>

<p>
redbean 2.0 introduces a
new <a href="https://redbean.dev/2.0.html#unix">unix</a> module implemented in
<a href="https://github.com/jart/cosmopolitan/tree/master/tool/net/lunix.c">tool/net/lunix.c</a>.
I love the unix operating system and I hope you will too. In fact, I
love it so much, that I wrote Lua wrappers for all of the following
system interfaces.

</p><p>
<a href="https://redbean.dev/2.0.html#unix.exit">exit</a>,
<a href="https://redbean.dev/2.0.html#unix.fork">fork</a>,
<a href="https://redbean.dev/2.0.html#unix.read">read</a>,
<a href="https://redbean.dev/2.0.html#unix.write">write</a>,
<a href="https://redbean.dev/2.0.html#unix.open">open</a>,
<a href="https://redbean.dev/2.0.html#unix.close">close</a>,
<a href="https://redbean.dev/2.0.html#unix.stat">stat</a>,
<a href="https://redbean.dev/2.0.html#unix.fstat">fstat</a>,
<a href="https://redbean.dev/2.0.html#unix.lseek">lseek</a>,
<a href="https://redbean.dev/2.0.html#unix.access">access</a>,
<a href="https://redbean.dev/2.0.html#unix.pipe">pipe</a>,
<a href="https://redbean.dev/2.0.html#unix.dup">dup</a>,
<a href="https://redbean.dev/2.0.html#unix.poll">poll</a>,
<a href="https://redbean.dev/2.0.html#unix.execve">execve</a>,
<a href="https://redbean.dev/2.0.html#unix.environ">environ</a>,
<a href="https://redbean.dev/2.0.html#unix.link">link</a>,
<a href="https://redbean.dev/2.0.html#unix.unlink">unlink</a>,
<a href="https://redbean.dev/2.0.html#unix.symlink">symlink</a>,
<a href="https://redbean.dev/2.0.html#unix.mkdir">mkdir</a>,
<a href="https://redbean.dev/2.0.html#unix.makedirs">makedirs</a>,
<a href="https://redbean.dev/2.0.html#unix.chdir">chdir</a>,
<a href="https://redbean.dev/2.0.html#unix.rmdir">rmdir</a>,
<a href="https://redbean.dev/2.0.html#unix.sigaction">sigaction</a>,
<a href="https://redbean.dev/2.0.html#unix.setitimer">setitimer</a>,
<a href="https://redbean.dev/2.0.html#unix.nanosleep">nanosleep</a>,
<a href="https://redbean.dev/2.0.html#unix.clock_gettime">clock_gettime</a>,
<a href="https://redbean.dev/2.0.html#unix.gmtime">gmtime</a>,
<a href="https://redbean.dev/2.0.html#unix.localtime">localtime</a>,
<a href="https://redbean.dev/2.0.html#unix.opendir">opendir</a>,
<a href="https://redbean.dev/2.0.html#unix.fdopendir">fdopendir</a>,
<a href="https://redbean.dev/2.0.html#unix.fsync">fsync</a>,
<a href="https://redbean.dev/2.0.html#unix.fdatasync">fdatasync</a>,
<a href="https://redbean.dev/2.0.html#unix.getpid">getpid</a>,
<a href="https://redbean.dev/2.0.html#unix.getppid">getppid</a>,
<a href="https://redbean.dev/2.0.html#unix.getsockname">getsockname</a>, <a href="https://redbean.dev/2.0.html#unix.getsockopt">getsockopt</a>, <a href="https://redbean.dev/2.0.html#unix.getuid">getuid</a>, <a href="https://redbean.dev/2.0.html#unix.kill">kill</a>,
<a href="https://redbean.dev/2.0.html#unix.listen">listen</a>, <a href="https://redbean.dev/2.0.html#unix.major">major</a>,
<a href="https://redbean.dev/2.0.html#unix.minor">minor</a>,
<a href="https://redbean.dev/2.0.html#unix.pledge">pledge</a>, <a href="https://redbean.dev/2.0.html#unix.raise">raise</a>, <a href="https://redbean.dev/2.0.html#unix.readlink">readlink</a>, <a href="https://redbean.dev/2.0.html#unix.accept">accept</a>,
<a href="https://redbean.dev/2.0.html#unix.realpath">realpath</a>, <a href="https://redbean.dev/2.0.html#unix.recv">recv</a>, <a href="https://redbean.dev/2.0.html#unix.bind">bind</a>, <a href="https://redbean.dev/2.0.html#unix.recvfrom">recvfrom</a>,
<a href="https://redbean.dev/2.0.html#unix.rename">rename</a>, <a href="https://redbean.dev/2.0.html#unix.chmod">chmod</a>, <a href="https://redbean.dev/2.0.html#unix.chown">chown</a>, <a href="https://redbean.dev/2.0.html#unix.send">send</a>, <a href="https://redbean.dev/2.0.html#unix.chroot">chroot</a>,
<a href="https://redbean.dev/2.0.html#unix.sendto">sendto</a>, <a href="https://redbean.dev/2.0.html#unix.setgid">setgid</a>,
<a href="https://redbean.dev/2.0.html#unix.commandv">commandv</a>, <a href="https://redbean.dev/2.0.html#unix.setpgid">setpgid</a>, <a href="https://redbean.dev/2.0.html#unix.connect">connect</a>, <a href="https://redbean.dev/2.0.html#unix.setpgrp">setpgrp</a>,
<a href="https://redbean.dev/2.0.html#unix.setresgid">setresgid</a>, <a href="https://redbean.dev/2.0.html#unix.setresuid">setresuid</a>, <a href="https://redbean.dev/2.0.html#unix.setrlimit">setrlimit</a>,
, <a href="https://redbean.dev/2.0.html#unix.setsid">setsid</a>, <a href="https://redbean.dev/2.0.html#unix.fcntl">fcntl</a>, <a href="https://redbean.dev/2.0.html#unix.setsockopt">setsockopt</a>,
<a href="https://redbean.dev/2.0.html#unix.setuid">setuid</a>, <a href="https://redbean.dev/2.0.html#unix.shutdown">shutdown</a>,
<a href="https://redbean.dev/2.0.html#unix.sigprocmask">sigprocmask</a>, <a href="https://redbean.dev/2.0.html#unix.sigsuspend">sigsuspend</a>, <a href="https://redbean.dev/2.0.html#unix.ftruncate">ftruncate</a>,
<a href="https://redbean.dev/2.0.html#unix.siocgifconf">siocgifconf</a>, <a href="https://redbean.dev/2.0.html#unix.getcwd">getcwd</a>, <a href="https://redbean.dev/2.0.html#unix.socket">socket</a>, <a href="https://redbean.dev/2.0.html#unix.getegid">getegid</a>, <a href="https://redbean.dev/2.0.html#unix.socketpair">socketpair</a>,
<a href="https://redbean.dev/2.0.html#unix.geteuid">geteuid</a>, <a href="https://redbean.dev/2.0.html#unix.getgid">getgid</a>, <a href="https://redbean.dev/2.0.html#unix.strsignal">strsignal</a>, <a href="https://redbean.dev/2.0.html#unix.gethostname">gethostname</a>,
<a href="https://redbean.dev/2.0.html#unix.getpeername">getpeername</a>, <a href="https://redbean.dev/2.0.html#unix.sync">sync</a>, <a href="https://redbean.dev/2.0.html#unix.getpgid">getpgid</a>, <a href="https://redbean.dev/2.0.html#unix.syslog">syslog</a>,
<a href="https://redbean.dev/2.0.html#unix.getpgrp">getpgrp</a>, <a href="https://redbean.dev/2.0.html#unix.truncate">truncate</a>, <a href="https://redbean.dev/2.0.html#unix.umask">umask</a>,
<a href="https://redbean.dev/2.0.html#unix.getrlimit">getrlimit</a>, <a href="https://redbean.dev/2.0.html#unix.wait">wait</a>, <a href="https://redbean.dev/2.0.html#unix.getrusage">getrusage</a>,
<a href="https://redbean.dev/2.0.html#unix.getsid">getsid</a>

</p><p>
We&#39;ve put a lot of work into documenting these functions and making sure
they work on all supported platforms, included Windows, where we&#39;ve
sought to model the Linux kernel behaviors as accurately as possible.
Our goal has been making sure doing anything from Lua will be possible
rather than impossible. As such, this module abstracts very little and
is nearly identical to the APIs provided for the C language.

</p><pre>fd = <span>assert</span>(unix.open(<span>&#34;hello.txt&#34;</span>))
st = <span>assert</span>(unix.fstat(fd))
Log(kLogInfo, <span>&#39;hello.txt is %d bytes in size&#39;</span> % {st:size()})
unix.close(fd)
</pre>

<p>
In many cases, Lua makes using the C syscall functions much easier. For
example, you&#39;ll notice we didn&#39;t need to pass <code>unix.O_RDONLY</code>
to <code>open()</code> since Lua function calls can have default
parameters. You&#39;ll also notice the object oriented access to
the <code><span>struct</span> <span>stat</span></code>.
The unix module implements this with a user data object metatable. That
means it goes 10x faster than if we were to construct a table, because
Cosmopolitan&#39;s stat has 16 fields! Thanks to Lua udata objects, we can
return those without needing to copy them.

</p><pre>Write(<span>&#39;&lt;ul&gt;&#39;</span>)
<span>for</span> name, kind, ino, off <span>in</span> <span>assert</span>(unix.opendir(<span>&#39;/etc&#39;</span>)) do
   <span>if</span> kind == unix.DT_REG <span>then</span>
      Write(<span>&#39;&lt;li&gt;%s&#39;</span> % {name})
   <span>end</span>
<span>end</span>
Write(<span>&#39;&lt;/ul&gt;&#39;</span>)
</pre>

<p>
The dirstream interface is particularly nice, since it&#39;s one of the few
system call interfaces that the C language explicitly defines as
object-oriented. What <code>opendir()</code> does is return an object
that can be <code>__call</code>&#39;d to receive each directory entry, and
as such, Lua lets it integrate neatly and automatically with all its
lovely language features.

</p><h3>Berkeley Sockets</h3>

<p>
Thanks to the system call interface designed at UC Berkeley, redbean&#39;s
new unix module means that redbean can now be much more than just an
HTTP server. For example, you can fork() off a daemon:

</p><pre><span>if</span> <span>assert</span>(unix.fork()) &gt; 0 <span>then</span> <span>return</span> <span>end</span>
unix.close(GetClientFd())
unix.setsid()
<span>if</span> <span>assert</span>(unix.fork()) &gt; 0 <span>then</span> unix.exit(0) <span>end</span>
unix.close(1)
<span>assert</span>(unix.open(<span>&#39;/var/log/daemon.log&#39;</span>, unix.O_WRONLY | unix.O_CREAT | unix.O_TRUNC, 0600))
unix.dup(1, 2)
<span>assert</span>(unix.setgid(1000))
<span>assert</span>(unix.setuid(1000))
</pre>

<p>
That listens for client connections on another port:

</p><pre>sock = <span>assert</span>(unix.socket())  <span>-- create ipv4 tcp socket</span>
<span>assert</span>(unix.bind(sock))       <span>-- all interfaces ephemeral port</span>
ip, port = assert(unix.getsockname(sock))
<span>print</span>(<span>&#34;listening on ip&#34;</span>, FormatIp(ip), <span>&#34;port&#34;</span>, port)
<span>assert</span>(unix.listen(sock))
<span>while</span> <span>true</span> <span>do</span>
   client, clientip, clientport = <span>assert</span>(unix.accept(sock))
   <span>print</span>(<span>&#34;got client ip&#34;</span>, FormatIp(clientip), <span>&#34;port&#34;</span>, clientport)
   unix.close(client)
<span>end</span>
</pre>

<p>
That port can be any one of your choosing: smtp, irc, name it.

</p><h3>Further Examples</h3>

<p>
There&#39;s also a few demo scripts included in the redbean-demo.com binary
release file. You can also read the example code on GitHub. The
unix-webserver.lua demo is particularly nice, since it shows how you can
create a web server within your web server.

</p><ul>
<li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/unix-dir.lua">//tool/net/demo/unix-dir.lua</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/unix-info.lua">//tool/net/demo/unix-info.lua</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/unix-raise.lua">//tool/net/demo/unix-raise.lua</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/unix-rawsocket.lua">//tool/net/demo/unix-rawsocket.lua</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/unix-subprocess.lua">//tool/net/demo/unix-subprocess.lua</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/unix-webserver.lua">//tool/net/demo/unix-webserver.lua</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/binarytrees.lua">//tool/net/demo/binarytrees.lua</a>
</li></ul>

<h2 class="page" id="sandboxing">
  <a href="#sandboxing">
    Sandboxing
  </a>
</h2>

<p>
Let&#39;s say you&#39;re downloading Lua extensions for redbean off the web and
you don&#39;t want them poking around in /etc like in the example above.
redbean provides a sandboxing solution for this, that&#39;s available on
Linux and OpenBSD. It works by exposing the OpenBSD
<a href="https://redbean.dev/2.0.html#unix.pledge">unix.pledge()</a>
system call, which we&#39;ve polyfilled for Linux using SECCOMP BPF.

</p><pre><span>function</span> <span>OnWorkerStart</span>()
   unix.pledge(<span>&#39;stdio&#39;</span>)
<span>end</span>
</pre>

<p>
If you do something like that, to reduce privileges on forked workers,
then <code>unix.opendir()</code> will return <code>unix.EPERM</code>
rather than exposing your <code>/etc</code> folder. OpenBSD will just
kill the process whenever a sandbox violation occurs, but we&#39;ve chosen
to be more forgiving with Linux since Lua code that behaves badly should
have the opportunity to react to the error by mending its wicked ways.
For example, many of the unix demo scripts included in redbean won&#39;t run
if you&#39;re using sandboxing. So they&#39;ll print a helpful error if the
system call reports a permission error.

</p><p>
Another important security feature is
<a href="https://redbean.dev/2.0.html#unix.setrlimit">unix.setrlimit()</a>
which has a usage example in the
<a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/demo/binarytrees.lua">binarytrees.lua</a>
benchmark game. The form takes an exponential parameter for how complex
the game should be. If that number is high, like 25 rather than 18, then
the Lua script will allocate gigabytes of memory and use a ton of CPU.
The <code>setrlimit()</code> function lets you place a limit on how many
resources a connection is allowed to use, before it either receives a
notification signal or gets killed.

</p><h2 class="page" id="maxmind">
  <a href="#maxmind">
    Maxmind Module
  </a>
</h2>

<p>
redbean 2.0 introduces support for reading MaxMind&#39;s free GeoLite2 IP
and ASN databases. It works locally in a self-hosted way, but you have
to sign up on their website to download the necessary data files. Once
you have them, your redbean will gain the superpower of knowing where
everyone lives.

</p><pre>geodb = maxmind.open(<span>&#39;/usr/local/share/maxmind/GeoLite2-City.mmdb&#39;</span>)
geo = geodb:lookup(GetRemoteAddr())
<span>if</span> geo <span>then</span>
   Write(<span>&#39;hello citizen of %s!&#39;</span> % {geo:get(<span>&#39;country&#39;</span>, <span>&#39;names&#39;</span>, <span>&#39;en&#39;</span>)})
<span>end</span>
</pre>

<p>
This can be an invaluable tool for defending your redbean from the bad
guys on the web. For example, let&#39;s say you want to have a comments
section on your blog. One thing you could do to reduce abuse, while
remaining completely open, is to simply use MaxMind to check that the
visitor is using their home internet connection.

</p><pre><span>if</span> geo:get(<span>&#39;location&#39;</span>, <span>&#39;accuracy_radius&#39;</span>) &gt;= 100 <span>then</span>
   SetStatus(403)
   Write(<span>&#39;you can only post comments from your home internet connection&#39;</span>)
   <span>return</span>
<span>end</span>
</pre>

<p>
IPs that come from a data center usually have an accuracy of 1000km. So
if the accuracy is less than 100, then the visitor is much less likely
to be a robot or a bad guy concealing their identity. This is by no
means a perfect criterion for fighting abuse, but it can keep a lot of
unsavory traffic at bay in a scrappy way that doesn&#39;t require FAANG
accounts. It works because the list of bad guys who&#39;ve hacked a fleet of
Comcast home routers is much shorter than the list of bad guys who just
rent cheap virtual servers from the usual suspects in the cloud.

</p><pre>asndb = maxmind.open(<span>&#39;/usr/local/share/maxmind/GeoLite2-ASN.mmdb&#39;</span>)
as = asndb:lookup(GetRemoteAddr())
asname = as:get(<span>&#39;autonomous_system_organization&#39;</span>)
</pre>

<p>
Logging the autonomous system name will let you know who the usual
suspects are. When bad guys send unreasonable amounts of traffic, they
love doing it using a fleet of seemingly unrelated IPs from countries
around the world. But one of their weaknesses is that, like most devs,
they&#39;re usually wedded to just one platform. Knowing what the platform
is can be an invaluable tool in drawing the dots and filing complaints
accordingly.

</p><h2 class="page" id="lua">
  <a href="#lua">
    Lua Enhancements
  </a>
</h2>

<p>
  redbean 2.0 introduces enhancements to the Lua language that are
  intended to help C/C++ and Python developers feel more comfortable.

</p><ul>
<li>printf modulus operator, like Python. For example, you can
      say <code>&#34;hello %s&#34; % {&#34;world&#34;}</code> instead of
      <code>string.format(&#34;hello %s&#34;, &#34;world&#34;)</code>.

</li><li>octal (base 8) integer literals. For example
      <code>0644 == 420</code> is the case in redbean, whereas in upstream Lua
      <code>0644 == 644</code> would be the case. There&#39;s also a new
      <a href="https://redbean.dev/2.0.html#oct">oct</a> function.

</li><li>
  binary (base 2) integer literals. For example
  <code>0b1010 == 10</code> is the case in redbean, whereas in upstream Lua
  <code>0b1010</code> would result in an error. There&#39;s also a new
       <a href="https://redbean.dev/2.0.html#bin">bin</a> function.

</li><li>GNU syntax for the ASCII ESC character in string literals. For
      example, <code>&#34;\e&#34;</code> is the same as <code>&#34;\x1b&#34;</code>.
</li></ul>

<h2 class="page" id="apis">
  <a href="#apis">
    APIs
  </a>
</h2>

<p>
redbean 2.0 introduces the following native functions:

</p><p>
<a href="https://redbean.dev/2.0.html#EncodeJson">EncodeJson</a>,
<a href="https://redbean.dev/2.0.html#EncodeLua">EncodeLua</a>,
<a href="https://redbean.dev/2.0.html#Compress">Compress</a>,
<a href="https://redbean.dev/2.0.html#Uncompress">Uncompress</a>,
<a href="https://redbean.dev/2.0.html#GetMonospaceWidth">GetMonospaceWidth</a>,
<a href="https://redbean.dev/2.0.html#ProgramMaxPayloadSize">ProgramMaxPayloadSize</a>,
<a href="https://redbean.dev/2.0.html#ProgramSslRequired">ProgramSslRequired</a>,
<a href="https://redbean.dev/2.0.html#ProgramSslClientVerify">ProgramSslClientVerify</a>,
<a href="https://redbean.dev/2.0.html#MeasureEntropy">MeasureEntropy</a>,
<a href="https://redbean.dev/2.0.html#Decimate">Decimate</a>,
<a href="https://redbean.dev/2.0.html#Benchmark">Benchmark</a>,
<a href="https://redbean.dev/2.0.html#Rdtsc">Rdtsc</a>,
<a href="https://redbean.dev/2.0.html#Lemur64">Lemur64</a>,
<a href="https://redbean.dev/2.0.html#Rand64">Rand64</a>,
<a href="https://redbean.dev/2.0.html#Rdrand">Rdrand</a>,
<a href="https://redbean.dev/2.0.html#Rdseed">Rdseed</a>,
<a href="https://redbean.dev/2.0.html#GetCpuCount">GetCpuCount</a>,
<a href="https://redbean.dev/2.0.html#GetCpuCore">GetCpuCore</a>,
<a href="https://redbean.dev/2.0.html#GetCpuNode">GetCpuNode</a>,
<a href="https://redbean.dev/2.0.html#oct">oct</a>,
<a href="https://redbean.dev/2.0.html#hex">hex</a>,
<a href="https://redbean.dev/2.0.html#bin">bin</a>

</p><p>
redbean 2.0 adds support for modern password hashing. See
<a href="https://redbean.dev/2.0.html#argon2.hash_encoded">argon2.hash_encoded</a> and
<a href="https://redbean.dev/2.0.html#argon2.verify">argon2.verify</a>.

</p><p>
redbean now defines the
<a href="https://redbean.dev/2.0.html#arg">arg</a> global the same way
as the upstream <code>lua</code> command interpreter.
</p><h2 class="page" id="bugs">
  <a href="#bugs">
    Bug Fixes
  </a>
</h2>

<p>
This release includes many upstream fixes from Cosmopolitan Libc. The
quality of the Windows platform support has improved considerably. For
example, fork() now works well enough on Windows that this release
enables it by default. Many other bugs on Windows that would cause
redbean to become unresponsive to CTRL-C interrupts have also now been
resolved.

</p><h2 class="page" id="see">
  <a href="#see">
    See Also
  </a>
</h2>

<ul>
<li><a href="https://discord.gg/EZwQUAcx">Redbean Discord</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/tool/net/redbean.c">//tool/net/redbean.c</a>
</li></ul>

<h2 class="page" id="funding">
  <a href="#funding">
    Funding
  </a>
</h2>

<p>
  <a href="https://justine.lol/lemuria.png">
    <picture>
      <source srcset="//storage.googleapis.com/justine/sectorlisp2/lemuria.webp" type="image/webp"/>
      <img src="https://storage.googleapis.com/justine/sectorlisp2/lemuria.png" width="850" height="360" alt="[United States of Lemuria - two dollar bill - all debts public and primate]"/>
    </picture>
  </a>

</p><p>
Funding for the development of redbean was crowdsourced from Justine Tunney&#39;s
<a href="https://github.com/sponsors/jart">GitHub sponsors</a>
and <a href="https://www.patreon.com/jart">Patreon subscribers</a>. Your
support is what makes projects like redbean possible. Thank you.

</p>
</div>
  </body>
</html>
