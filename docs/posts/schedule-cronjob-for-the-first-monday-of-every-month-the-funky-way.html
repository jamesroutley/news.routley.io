<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.healthchecks.io/2022/09/schedule-cron-job-the-funky-way/">Original</a>
    <h1>Schedule cronjob for the first Monday of every month, the funky way</h1>
    
    <div id="readability-page-1" class="page"><article id="post-1158" itemtype="https://schema.org/CreativeWork" itemscope="itemscope">
<div>

<div itemprop="text">
<p>The crontab man page (“man 5 crontab” or <a href="https://man7.org/linux/man-pages/man5/crontab.5.html">read online</a>) contains this bit:</p>
<blockquote><p>Note: The day of a command’s execution can be specified by two fields — day of month, and day of week. If both fields are restricted (i.e., don’t start with *), the command will be run when either field matches the current time. For example, <code>30 4 1,15 * 5</code> would cause a command to be run at 4:30 am on the 1st and 15th of each month, plus every Friday.</p></blockquote>
<p>What does it mean precisely? If you specify both the day of month and the day of week field, then cron will run the command when <em>either</em> of the fields match. In other words, there’s a logical OR relationship between the two fields. Let’s look at an example:</p>
<pre><code>0 0 1 * MON</code></pre>
<p>This expression translates to “Run at the midnight if it’s the first day of the month OR Monday”. An expression like this could be handy for a job that sends weekly and monthly reports as it probably needs to run at the start of every week, and the start of every month. However, if either field is unrestricted, the logical relationship between the fields changes to “AND”. For example:</p>
<pre><code>0 0 * * MON</code></pre>
<p>Here, the day of month field is unrestricted. Cron will run this command when both the day of month field AND the day of week fields match. Since <code>*</code> matches any day of month, this expression effectively translates to “Run at midnight every Monday”.</p>
<p>So far so good! The sometimes-OR relationship between the two fields is a relatively well-known cron gotcha. But let’s look closer at what values cron considers “unrestricted”. Star (<code>*</code>) is of course unrestricted, but, according to the man page, any value that starts with the star character is <em>also</em> unrestricted. For example, <code>*/2</code> is unrestricted too. Can we think of any useful schedules that exploit this fact? Yes, we can:</p>
<pre><code>0 0 1-7 * */7</code></pre>
<p>Here, the day of month is restricted to dates 1 to 7. Cron will interpret <code>*/7</code> in the day of week field as “every 7 days starting from 0 (Sunday)”, so, effectively, “Every Sunday”. Since the day of week field starts with <code>*</code>, cron will run the command on dates 1 to 7 which are <em>also</em> Sunday. In other words, this will match <strong>midnight of the first Sunday of every month</strong>.</p>
<p>In the above example, <code>*/7</code> is a trick to say “every Sunday” in a way that starts with the star. Unfortunately, this trick only works for Sunday. Can we make an expression that runs on, say, the first Monday of every month? Yes, we can!</p>
<pre><code>0 0 */100,1-7 * MON</code></pre>
<p>The day of month field here is <code>*/100,1-7</code>, meaning “every 100 days starting from date 1, and also on dates 1-7”. Since there are no months with 100+ days, this again is a trick to say “on dates 1 to 7” but with a leading star. Because of the star, cron will run the command on dates 1 to 7 that are <em>also</em> Monday.</p>
<p>OK, but does any of this work? Is the man page accurate? Yes: you can check <a href="https://salsa.debian.org/debian/cron/-/blob/8836264d360843f3294a986fede165385d847827/entry.c#L183">the cron source here</a> and see how it initializes the <code>DOW_STAR</code> and <code>DOM_STAR</code> flags by testing just the first character of the fields. I’ve also tested both expressions empirically by setting up dummy cron jobs and monitoring when they run. I ran them in a VM with an accelerated clock, <a href="https://blog.healthchecks.io/2021/10/how-debian-cron-handles-dst-transitions/#qemu-magic">which I’ve used for experiments before</a>.</p>
<p>An important caveat before you use these tricks for scheduling your tasks: there are many systems that support cron-like syntax for scheduling tasks. It’s a safe bet not all of them implement all the quirks of the classic cron. Always check if your scheduler supports the syntax and logic you are planning to use. And always monitor if your scheduled tasks do run at the expected times (<a href="https://healthchecks.io/docs/monitoring_cron_jobs/">wink wink</a>)!</p>
</div>
</div>
</article></div>
  </body>
</html>
