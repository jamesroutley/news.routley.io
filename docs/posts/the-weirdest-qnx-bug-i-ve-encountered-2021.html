<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mental-reverb.com/blog.php?id=29">Original</a>
    <h1>The weirdest QNX bug I&#39;ve encountered (2021)</h1>
    
    <div id="readability-page-1" class="page"><div>



			<div><p><h3>30 May 2021</h3></p><p><h2>The weirdest bug I&#39;ve ever encountered</h2></p><div><p>I am responsible for the reliability of the firmware updates on our devices and this work never gets boring. The thing about firmware updates is that by definition, every bug is caused by the updater because before installing the affected version, the bug was not present. You could say that updates are the cause and the solution of all software problems. So, a lot of update bug reports that find their way to me have nothing to do with the updater per se, they just manifest themselves immediately, giving the impression that the updater is broken. But I&#39;m getting ahead of myself, so let&#39;s start from the beginning.</p>

<p>A new bug comes in: Update failed from version X to version Y, error getting log files from sensor. After that, the user manually rebooted the machine and it worked again.</p>

<p>I connect to the machine and download all the logfiles. In the logs, I see that the update installed successfully. After the reboot which starts the newly installed firmware, there were some minor problems: Some processes took a bit longer to start than expected. Other than that, the log looks clean, no errors that could explain this behaviour.</p>

<p>I try to install the affected Firmware version Y on various devices. The problem does not appear. But as luck has it, a co-worker encountered the problem and had the presence of mind to recognize it and leave the system undisturbed for analysis. Connecting to the system is difficult because it is laggy and slow. The device can barely handle simple commands. Weird. Let&#39;s run <code>top</code>.</p>

<p><code>60 processes; 646 threads;
CPU states: 16.0% user, 35.0% kernel
CPU  0 Idle: 55.4%
CPU  1 Idle: 42.4%
Memory: 0 total, 543M avail, page size 4K

      PID   TID PRI STATE    HH:MM:SS    CPU  COMMAND
        1    12  10 Run       1:51:21  17.72% kernel
        1     5  10 Run       2:13:10  17.04% kernel
   602168     1  10 Rdy       3:30:01  13.98% ps
   229398     1  21 Rcv       0:09:32   0.67% smb-tunnelcreek
   778301     1  10 Rply      0:00:00   0.62% top
   253978     2  21 NSlp      0:05:43   0.40% devi-tsc2007
        1     6  10 Rcv       2:08:09   0.25% kernel
        7     2  21 Rcv       0:01:41   0.07% io-pkt-v4-hc
   581675    15  10 CdV       0:00:17   0.07% telescope
     8200     9  21 Rcv       0:00:35   0.05% io-usb

             Min        Max       Average
CPU 0 idle:   55%        55%        55%
CPU 1 idle:   42%        42%        42%
Mem Avail:   543MB      543MB      543MB
Processes:    60         60         60
Threads:     646        646        646
</code></p>

<p>Okay, we immediately have some clues here. The QNX kernel is doing a lot of stuff and so is <code>ps</code>. We see that the CPU load of the two cores is about 50%. But we know that the system has hyperthreading and only has one physical core, so the real load is actually more like 100%. To me, it looks like <code>ps</code> is saturating the core completely, the kernel load is probably caused by <i>whatever</i> ps is doing.</p>

<p>Who is calling <code>ps</code>? With <code>ps -ef</code> we can see the <code>PPID</code>, the parent process id, to track down who spawned this process. Ironically, we use <code>ps</code> to debug this <code>ps</code> problem. Like this, I find that it was spawned by the shell <code>sh</code>, which in turn was spawned by one of our proprietary processes. Equipped with the knowledge of which process is affected and analysing the logs to find out where this process got stuck, I quickly find the offending line of code. It looks like this: <code>int rc = system( &#34;ps -e | grep Foo&#34; );</code> where <code>Foo</code> is some program whose presence we need to check. Not the prettiest way to implement it, but it is legacy code that worked for many years. I also see that this code only gets executed on certain old hardwares. This explains why the problem never reproduced on most systems, they have newer hardware. Even on the old hardware, it is exceedingly rare and hard to reproduce. Killing the offending <code>ps</code> process, which loops infinitely otherwise, unblocks the system and restores normal operation.</p>

<p>We now know a lot about this problem, but what is the root cause? The <code>ps</code> program causes 100% CPU load... What is this? We use QNX 6.6 and <code>ps</code> is supplied as a closed source binary. To understand this problem, we need to analyse the <code>ps</code> utility itself. We can already do that at the assembly level. The QNX Momentics IDE has an option &#34;Attach to Remote Process via QConn&#34; with which I can tap right into the running process. We see that it is stuck in a loop that calls <code>devctl()</code> over and over again. The return value of this <code>devctl()</code> is <code>3</code> which is <code>ESRCH</code>: No such process. This error comes straight from <code>MsgSendv_r</code> which returned <code>-3</code>. It documents that <code>ESRCH</code> means <code>The server died while the calling thread was SEND-blocked or REPLY-blocked.</code>.</p>

<p>Okay, so, <code>ps</code> gets stuck in an infinite loop. Dare I say it: Do we have a <code>ps</code> bug on our hands? The QNX ecosystem is generally quite robust. In the past, it almost always ended up being my own mistake when I suspected problems in QNX and its utilities. But how can the infinite loop seen in live assembly debugging be explained with a user error of <code>ps</code>?</p>

<p>At this point, an intermezzo with some QNX history is in order. A bit more than a decade ago, the QNX source code was available to the public. Back then, QNX had a vibrant open source community. People would experiment with the kernel, write various useful utilities and help each other in forums. QNX even had a fully featured Desktop GUI, ran Firefox and was self-hosting, so you could develop for QNX right on QNX itself with full IDE and compiler support. It was beautiful. Then QNX was bought, source code access was revoked and the community largely withered away. Questions were increasingly asked via private support tickets directly to QNX, locked away from the public. QNX know-how becomes harder and harder to acquire, open source software for modern QNX releases is essentially non-existent and the driver situation is a catastrophe. The QNX kernel is the most beautiful and interesting kernel I have ever had the pleasure of working with, but it lies in the shackles of corporate ownership.</p>

<p>Back to the bug. So there is old QNX source code lying around. Do you think anyone has modified the source code of the <code>ps</code> utility throughout the last 15 years? Me neither! Let&#39;s dive right into the <a href="https://github.com/BenjaminRi/openqnx/tree/master/trunk/utils/p/ps">old code</a>.</p>

<p>The old <code>ps</code> utility compiles for QNX 6.6 on the first try. Nice! It works just like the closed source binary we have. I install my newly compiled <code>ps</code>, write some software to automatically test reboots in a loop overnight and am able to reproduce the problem with this custom <code>ps</code> binary. Perfect! Now we can use the &#34;Attach to Remote Process via QConn&#34; feature again, but this time we have the source code of our <code>ps</code>. I already read the source code of the old <code>ps</code> before I did all of this, and I already had my suspicions as to which <code>devctl()</code> call was being repeated endlessly in the loop, so it comes as no surprise when the debugger points me to the <a href="https://github.com/BenjaminRi/openqnx/blob/master/trunk/utils/p/ps/nto/ps.c#L396">following line</a>:</p>

<p><code>	if (devctl (fd, DCMD_PROC_TIDSTATUS, &amp;tinfo, sizeof (tinfo), 0) == EOK)
</code></p>

<p>The root cause of the bug is the following. For every process in the <code>/proc</code> directory, <code>ps</code> opens a file descriptor to this process&#39; address space (<code>as</code>) file to read the process information to be displayed. For each process, it loops through all the threads of this process, and the bug is that this loop has insufficient termination criteria (in other words, in some cases, it loops infinitely). The problem occurs when the process whose threads we want to inspect terminates right before <code>ps</code> enters this loop. In that case, the <code>devctl()</code> call fails and as you can see in the following simplified snippet, it will never terminate because the <code>if</code>-clause is never entered.</p>

<p><code>while (1)
{
	if (devctl (fd, DCMD_PROC_TIDSTATUS, &amp;tinfo, sizeof (tinfo), 0) == EOK)
	{	
		//[...]

		tcount++;
		// stop when we have gone through each thread, or when
		// the user only want process info
		if ((usingThreads == 0) || (tcount == info.num_threads))
			break;
	}
	tinfo.tid++;
}
</code></p>

<p>I also verify this hypothesis by halting the <code>ps</code> process in the debugger, killing the process whose threads we are about to inspect and resuming <code>ps</code> and it hangs in precisely the same way. This is what it looks like in the QNX Momentics IDE:</p>

<p>
<img src="https://mental-reverb.com/img/weirdestbug_debug_screenshot.png"/>
</p>

<p>After this analysis, I&#39;m quite sure that this 15 years old bug is still alive and well in our closed source binary.</p>

<p>Why did this problem suddenly appear in our firmware? We can only speculate, it must have been changes in the scheduling order or timing at boot time. The bug is a race condition, so it can rear its ugly head whenever it wants. The affected code was old and deployed in production for many years.</p>

<p>How did I fix it? I briefly considered shipping our own <code>ps</code> utility, but I was still unsure about other bugs that might potentially be fixed in the latest closed source binary, those fixes would be lost again if I revert to the old open source version. At the end of the day, I decided to comb through our code base and just eliminate the usage of <code>ps</code> in non-interactive code, there weren&#39;t that many instances. Our <code>ps</code> utility remains buggy as it is, but it&#39;s pretty much impossible to reproduce this bug in an interactive terminal, and our firmware no longer uses it. Needless to say, this particular update problem never occurred again after that.</p>

<p>Does the <code>ps</code> bug still exist in QNX ecosystems more recent than QNX 6.6? Most likely, yes. If it was open source, I would fix it and send a pull request. Because it&#39;s not, they have to deal with the issue themselves. Maybe in a decade, an unfortunate soul runs into this bug again. Let&#39;s hope this blog post will save them some trouble.</p>

<p>What do we learn?

</p><ul>
<li>No matter how battle-tested and old the code and how reputable the distributor - the code contains bugs.</li>
<li>Old bugs can manifest themselves seemingly out of nowhere, caused by subtle changes in timing or memory layout.</li>
<li>Whenever the file system is involved, there is a significant danger that bugs are caused by race conditions.</li>
<li>Closed source operating systems and ecosystems are a pain to debug. Even old open source releases help.</li>
<li>Do not use interactive shell utilities in non-interactive code. Avoid <code>system()</code> whenever possible. Not only is the performance terrible, it can give rise to bugs like this one.</li>
<li>Make sure your loops terminate. Bounded loop variants that increase or decrease strictly monotonically guarantee loop termination. Don&#39;t be too clever with loops!</li>
</ul>


</div><h2>Comments</h2><div><p>I am a real person wrote on 01 July 2024</p></div><div><p><a rel="ugc" href="http://No.websote">Lolol </a> wrote on 30 June 2024</p></div><div><p>some_joker wrote on 30 June 2024</p></div><div><p><a rel="ugc" href="https://www.aloki.in/">aloki</a> wrote on 27 June 2024</p></div><div><p>&lt;a href=&#34;https://www.shreenandini.in/delhi-call-girls.html&#34;&gt;Delhi Escort Service&lt;/a&gt; || wrote on 22 June 2024</p></div><div><p>Tanya singh wrote on 22 June 2024</p></div><div><p>asd wrote on 22 June 2024</p></div><div><p><a rel="ugc" href="http://briansclub.co.in/">bclub</a> wrote on 12 June 2024</p></div><div><p><a rel="ugc" href="https://bookmarkerz.com/story17181439/what-you-need-to-know-about-on-the-web-gaming-to-maintain-your-loved-ones-safe">page</a> wrote on 06 June 2024</p></div><div><p><a rel="ugc" href="https://www.urfi.in/">Urfi</a> wrote on 26 April 2024</p></div><div><p><a rel="ugc" href="https://www.adventistsingles.org/">QH88</a> wrote on 28 January 2024</p></div><div><p><a rel="ugc" href="https://slot.sga508puh.com/">sga508</a> wrote on 24 January 2024</p></div><div><p><a rel="ugc" href="https://789bet.works/">789bet</a> wrote on 06 January 2024</p></div><div><p><a rel="ugc" href="https://tubular-concha-020db1.netlify.app/">ads508</a> wrote on 05 January 2024</p></div><div><p><a rel="ugc" href="https://ads508slot.framer.website/">ads508</a> wrote on 05 January 2024</p></div><div><p><a rel="ugc" href="https://start.me/p/xjnGEJ/ads508-pragmatic-slot-gacor">ads508</a> wrote on 05 January 2024</p></div><div><p><a rel="ugc" href="https://www.anchorofgold.com/users/ide777gacor">ide777</a> wrote on 31 December 2023</p></div><div><p><a rel="ugc" href="https://github.com/ads508link">ads508</a> wrote on 27 December 2023</p></div><div><p><a rel="ugc" href="https://socialmediainuk.com/story16295381/ads508-situs-slot-gacor-provider-slot-terlengkap-gampang-maxwin-jackpot">ads508</a> wrote on 26 December 2023</p></div><div><p><a rel="ugc" href="https://id.carousell.com/p/1273508689/">ads508</a> wrote on 23 December 2023</p></div><div><p>Woah wrote on 22 December 2023</p></div><div><p><a rel="ugc" href="https://jose7i29dlr4.iamthewiki.com/user">ads508</a> wrote on 22 December 2023</p></div><div><p><a rel="ugc" href="https://pvp777up.com/">pvp777</a> wrote on 18 December 2023</p></div><div><p><a rel="ugc" href="https://starrdustcrusader.tumblr.com/">ads508</a> wrote on 16 December 2023</p></div><div><p><a rel="ugc" href="https://groups.google.com/g/ide777a/c/45tdudjMFG8">ide777</a> wrote on 15 December 2023</p></div><div><p><a rel="ugc" href="https://leo8m41ktz8.wikicorrespondent.com/user">sga508</a> wrote on 25 November 2023</p></div><div><p><a rel="ugc" href="https://ke68.art/">ke68</a> wrote on 25 November 2023</p></div><div><p><a rel="ugc" href="https://ke68.art/">ke68</a> wrote on 25 November 2023</p></div><div><p><a rel="ugc" href="https://wlo.link/@sga508">sga508</a> wrote on 08 November 2023</p></div><div><p><a rel="ugc" href="https://pxhere.com/en/photographer-me/4107490">Visit</a> wrote on 28 October 2023</p></div><div><p><a rel="ugc" href="https://camden8q41lsz7.blogsvirals.com/">spg138</a> wrote on 26 October 2023</p></div><div><p><a rel="ugc" href="https://audiomack.com/ads508bet">ads508</a> wrote on 22 October 2023</p></div><div><p><a rel="ugc" href="https://luke6y74rye9.bloggip.com/profile">ads508</a> wrote on 15 October 2023</p></div><div><p><a rel="ugc" href="https://789bet.info/">xnxx</a> wrote on 10 October 2023</p></div><div><p><a rel="ugc" href="https://500px.com/p/pokerbeer">Visit</a> wrote on 08 October 2023</p></div><div><p><a rel="ugc" href="https://us.community.sony.com/s/profile/005Dp000003xhdA?language=en_US">Source</a> wrote on 05 October 2023</p></div><div><p><a rel="ugc" href="https://hi8866.com/">sex</a> wrote on 28 September 2023</p></div><div><p><a rel="ugc" href="https://Jaxson2q41jpu5.wikifiltraciones.com/user">ads508</a> wrote on 20 September 2023</p></div><div><p><a rel="ugc" href="https://jose7m30ipw6.wonderkingwiki.com/user">ads508</a> wrote on 19 September 2023</p></div><div><p><a rel="ugc" href="https://159.203.64.221/">ads508</a> wrote on 09 February 2024</p></div><div><p><a rel="ugc" href="https://community.ibm.com/community//user/watsonstudio/network/members/profile?UserKey=8be3b830-426c-4714-9a31-018a91c88bcc">URL</a> wrote on 18 September 2023</p></div><div><p><a rel="ugc" href="https://www.pearltrees.com/coldskill86/item536380036">Visit</a> wrote on 07 September 2023</p></div><div><p><a rel="ugc" href="https://jaxson8j29gmt5.wikirecognition.com/user">ads508</a> wrote on 06 September 2023</p></div><div><p><a rel="ugc" href="https://postheaven.net/cherryoval29/the-eco-friendly-option-paper-straws-and-their-favorable-ecological-impact">URL</a> wrote on 05 September 2023</p></div><div><p><a rel="ugc" href="https://www.reverbnation.com/artist/zenithstore">Source</a> wrote on 04 September 2023</p></div><div><p><a rel="ugc" href="https://postheaven.net/washdoubt20/unlock-the-possible-of-your-business-with-aws-consulting-services">Visit</a> wrote on 02 September 2023</p></div><div><p><a rel="ugc" href="https://blake7h18cip3.nico-wiki.com/user">ads508</a> wrote on 10 August 2023</p></div><div><p><a rel="ugc" href="https://www.quia.com/profiles/cleaning136">Source</a> wrote on 03 August 2023</p></div><div><p><a rel="ugc" href="https://500px.com/p/kingads508?view=photos">ads508</a> wrote on 02 August 2023</p></div><div><p><a rel="ugc" href="https://joshua2v64qxc8.blogars.com/profile">ads508</a> wrote on 25 October 2023</p></div><div><p><a rel="ugc" href="http://highthere.idea.informer.com/">Visit</a> wrote on 01 August 2023</p></div><div><p><a rel="ugc" href="https://www.tumblr.com/brandstruparnold05/723212519874920448/revamp-your-home-with-stunning-window-treatments">URL</a> wrote on 25 July 2023</p></div><div><p><a rel="ugc" href="https://jun88.fund">jun88</a> wrote on 16 July 2023</p></div><div><p><a rel="ugc" href="https://jun88.mobi">jun88</a> wrote on 13 July 2023</p></div><div><p><a rel="ugc" href="https://clefsmoke0.bloggersdelight.dk/2023/07/09/the-benefits-of-nicotine-salt-shots-elevating-your-vaping-experience/">URL</a> wrote on 12 July 2023</p></div><div><p><a rel="ugc" href="http://idea.informer.com/users/drdickerson45/?what=personal">URL</a> wrote on 11 July 2023</p></div><div><p><a rel="ugc" href="https://www.pearltrees.com/breadlayer76/item529048934">Visit</a> wrote on 08 July 2023</p></div><div><p><a rel="ugc" href="https://writeablog.net/l1fqmuj393/new-tech-gadgets-you-must-be-acquiring-right-now-have-you-ever-thought-about">Visit</a> wrote on 01 July 2023</p></div><div><p><a rel="ugc" href="https://jacobs-porter.federatedjournals.com/unlocking-the-power-of-ai-seo-changing-digital-marketing-techniques-1686532005">URL</a> wrote on 24 June 2023</p></div><div><p><a rel="ugc" href="https://us.community.sony.com/s/profile/005Dp000003YfYO?language=en_US">Visit</a> wrote on 20 June 2023</p></div><div><p><a rel="ugc" href="https://www.tripadvisor.in/Profile/amarnisangels">Visit</a> wrote on 28 May 2023</p></div><div><p><a rel="ugc" href="http://devinlhbs88877.tribunablog.com">here</a> wrote on 26 May 2023</p></div><div><p>dingle wrote on 15 May 2023</p></div><div><p><a rel="ugc" href="https://www.senangpoker.website/">Asu</a> wrote on 17 November 2022</p></div><div><p><a rel="ugc" href="https://www.selaluwd.top/">anjing</a> wrote on 05 September 2022</p></div><div><p><a rel="ugc" href="https://sga508slot.vzy.io/">sga508</a> wrote on 10 November 2023</p></div><div><p><a rel="ugc" href="https://slotgacor.sga508maxwin.repl.co/">sga508</a> wrote on 20 September 2023</p></div><div><p><a rel="ugc" href="https://louiszhqv51841.ampedpages.com/Argumen-Dibalik-Tenarnya-Permainan-Slot-Online-43573368">sga508</a> wrote on 15 January 2023</p></div><div><p><a rel="ugc" href="https://sga508resmi.vzy.io/">sga508</a> wrote on 12 December 2023</p></div><div><p><a rel="ugc" href="https://sleek.bio/sga508">sga508</a> wrote on 11 November 2023</p></div><div><p><a rel="ugc" href="https://bit.ly/m/sga508_slot">sga508</a> wrote on 21 October 2023</p></div><div><p>james alot wrote on 15 September 2023</p></div><div><p><a rel="ugc" href="https://dobryakschool.ru/user/tmpbnprofileetoiledunordorg3736138vb">poker</a> wrote on 27 June 2022</p></div><div><p><a rel="ugc" href="https://www.sbnation.com/users/sga508_slotgacor">sga508</a> wrote on 08 January 2023</p></div><div><p><a rel="ugc" href="https://linktr.ee/ayosga508">sga508</a> wrote on 22 December 2023</p></div><div><p><a rel="ugc" href="https://idolink.com/slotsga508">sga508</a> wrote on 12 November 2023</p></div><div><p><a rel="ugc" href="https://Link.Gallery/sga508">sga508</a> wrote on 21 September 2023</p></div><div><p><a rel="ugc" href="https://jos777mpo4dslot2022.blogspot.com/">jos777</a> wrote on 02 November 2022</p></div><div><p><a rel="ugc" href="https://jeremiah5d08gqa8.bloggazza.com/profile">ads508</a> wrote on 18 January 2023</p></div><div><p><a rel="ugc" href="https://nolan9n41ksz8.slypage.com/profile">ads508</a> wrote on 07 October 2023</p></div><div><p><a rel="ugc" href="https://leo2q41jqw6.ouyawiki.com/user">ads508</a> wrote on 04 December 2023</p></div><div><p><a rel="ugc" href="https://zachary1n20fls4.verybigblog.com/profile">ads508</a> wrote on 10 November 2023</p></div><div><p><a rel="ugc" href="https://owen4f08dkr4.bloggip.com/profile">site</a> wrote on 03 April 2023</p></div><div><p><a rel="ugc" href="https://carter3u63oua8.buyoutblog.com/profile">GOO777</a> wrote on 07 January 2023</p></div><div><p>595955995 wrote on 15 November 2021</p></div></div>
</div></div>
  </body>
</html>
