<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/libuv/libuv/pull/3952">Original</a>
    <h1>io_uring support for libuv â€“ 8x increase in throughput</h1>
    
    <div id="readability-page-1" class="page"><div disabled="" sortable="">
<div>
          <p dir="auto">Oh, that&#39;s interesting. Yes, I&#39;m getting the same warning with clang.</p>
<p dir="auto">gcc emits this code for the syscall wrapper:</p>
<div dir="auto" data-snippet-clipboard-copy-content="   0x00000000000997f0 &lt;+0&gt;:     endbr64
   0x00000000000997f4 &lt;+4&gt;:     sub    $0x10,%rsp
   0x00000000000997f8 &lt;+8&gt;:     mov    %ecx,%r8d
   0x00000000000997fb &lt;+11&gt;:    xor    %r9d,%r9d
   0x00000000000997fe &lt;+14&gt;:    mov    %edx,%ecx
   0x0000000000099800 &lt;+16&gt;:    push   $0x0
   0x0000000000099802 &lt;+18&gt;:    mov    %esi,%edx
   0x0000000000099804 &lt;+20&gt;:    xor    %eax,%eax
   0x0000000000099806 &lt;+22&gt;:    mov    %edi,%esi
   0x0000000000099808 &lt;+24&gt;:    mov    $0x1aa,%edi
   0x000000000009980d &lt;+29&gt;:    call   0xe810 &lt;syscall@plt&gt;
   0x0000000000099812 &lt;+34&gt;:    add    $0x18,%rsp
   0x0000000000099816 &lt;+38&gt;:    ret"><pre><span>   </span><span>0x00000000000997f0</span><span> &lt;</span><span>+</span><span>0</span><span>&gt;:     endbr64</span>
<span>   </span><span>0x00000000000997f4</span><span> &lt;</span><span>+</span><span>4</span><span>&gt;:     </span><span>sub</span>    <span>$</span><span>0x10</span><span>,</span><span>%</span><span>rsp</span>
<span>   </span><span>0x00000000000997f8</span><span> &lt;</span><span>+</span><span>8</span><span>&gt;:     </span><span>mov</span><span>    %</span><span>ecx</span><span>,</span><span>%</span><span>r8d</span>
<span>   </span><span>0x00000000000997fb</span><span> &lt;</span><span>+</span><span>11</span><span>&gt;:    </span><span>xor</span><span>    %</span><span>r9d</span><span>,</span><span>%</span><span>r9d</span>
<span>   </span><span>0x00000000000997fe</span><span> &lt;</span><span>+</span><span>14</span><span>&gt;:    </span><span>mov</span><span>    %</span><span>edx</span><span>,</span><span>%</span><span>ecx</span>
<span>   </span><span>0x0000000000099800</span><span> &lt;</span><span>+</span><span>16</span><span>&gt;:    </span><span>push</span>   <span>$</span><span>0x0</span>
<span>   </span><span>0x0000000000099802</span><span> &lt;</span><span>+</span><span>18</span><span>&gt;:    </span><span>mov</span><span>    %</span><span>esi</span><span>,</span><span>%</span><span>edx</span>
<span>   </span><span>0x0000000000099804</span><span> &lt;</span><span>+</span><span>20</span><span>&gt;:    </span><span>xor</span><span>    %</span><span>eax</span><span>,</span><span>%</span><span>eax</span>
<span>   </span><span>0x0000000000099806</span><span> &lt;</span><span>+</span><span>22</span><span>&gt;:    </span><span>mov</span><span>    %</span><span>edi</span><span>,</span><span>%</span><span>esi</span>
<span>   </span><span>0x0000000000099808</span><span> &lt;</span><span>+</span><span>24</span><span>&gt;:    </span><span>mov</span>    <span>$</span><span>0x1aa</span><span>,</span><span>%</span><span>edi</span>
<span>   </span><span>0x000000000009980d</span><span> &lt;</span><span>+</span><span>29</span><span>&gt;:    </span><span>call</span><span>   </span><span>0xe810</span><span> &lt;</span><span>syscall</span><span>@plt&gt;</span>
<span>   </span><span>0x0000000000099812</span><span> &lt;</span><span>+</span><span>34</span><span>&gt;:    </span><span>add</span>    <span>$</span><span>0x18</span><span>,</span><span>%</span><span>rsp</span>
<span>   </span><span>0x0000000000099816</span><span> &lt;</span><span>+</span><span>38</span><span>&gt;:    </span><span>ret</span></pre></div>
<p dir="auto">While clang emits this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="   0x00000000000a31f0 &lt;+0&gt;:     push   %rax
   0x00000000000a31f1 &lt;+1&gt;:     mov    %ecx,%r8d
   0x00000000000a31f4 &lt;+4&gt;:     mov    %edx,%ecx
   0x00000000000a31f6 &lt;+6&gt;:     mov    %esi,%edx
   0x00000000000a31f8 &lt;+8&gt;:     mov    %edi,%esi
   0x00000000000a31fa &lt;+10&gt;:    movl   $0x0,(%rsp)
   0x00000000000a3201 &lt;+17&gt;:    mov    $0x1aa,%edi
   0x00000000000a3206 &lt;+22&gt;:    xor    %r9d,%r9d
   0x00000000000a3209 &lt;+25&gt;:    xor    %eax,%eax
   0x00000000000a320b &lt;+27&gt;:    call   0xd780 &lt;syscall@plt&gt;
   0x00000000000a3210 &lt;+32&gt;:    pop    %rcx
   0x00000000000a3211 &lt;+33&gt;:    ret"><pre><span>   </span><span>0x00000000000a31f0</span><span> &lt;</span><span>+</span><span>0</span><span>&gt;:     </span><span>push</span><span>   %</span><span>rax</span>
<span>   </span><span>0x00000000000a31f1</span><span> &lt;</span><span>+</span><span>1</span><span>&gt;:     </span><span>mov</span><span>    %</span><span>ecx</span><span>,</span><span>%</span><span>r8d</span>
<span>   </span><span>0x00000000000a31f4</span><span> &lt;</span><span>+</span><span>4</span><span>&gt;:     </span><span>mov</span><span>    %</span><span>edx</span><span>,</span><span>%</span><span>ecx</span>
<span>   </span><span>0x00000000000a31f6</span><span> &lt;</span><span>+</span><span>6</span><span>&gt;:     </span><span>mov</span><span>    %</span><span>esi</span><span>,</span><span>%</span><span>edx</span>
<span>   </span><span>0x00000000000a31f8</span><span> &lt;</span><span>+</span><span>8</span><span>&gt;:     </span><span>mov</span><span>    %</span><span>edi</span><span>,</span><span>%</span><span>esi</span>
<span>   </span><span>0x00000000000a31fa</span><span> &lt;</span><span>+</span><span>10</span><span>&gt;:    movl</span>   <span>$</span><span>0x0</span><span>,</span><span>(%</span><span>rsp</span><span>)</span>
<span>   </span><span>0x00000000000a3201</span><span> &lt;</span><span>+</span><span>17</span><span>&gt;:    </span><span>mov</span>    <span>$</span><span>0x1aa</span><span>,</span><span>%</span><span>edi</span>
<span>   </span><span>0x00000000000a3206</span><span> &lt;</span><span>+</span><span>22</span><span>&gt;:    </span><span>xor</span><span>    %</span><span>r9d</span><span>,</span><span>%</span><span>r9d</span>
<span>   </span><span>0x00000000000a3209</span><span> &lt;</span><span>+</span><span>25</span><span>&gt;:    </span><span>xor</span><span>    %</span><span>eax</span><span>,</span><span>%</span><span>eax</span>
<span>   </span><span>0x00000000000a320b</span><span> &lt;</span><span>+</span><span>27</span><span>&gt;:    </span><span>call</span><span>   </span><span>0xd780</span><span> &lt;</span><span>syscall</span><span>@plt&gt;</span>
<span>   </span><span>0x00000000000a3210</span><span> &lt;</span><span>+</span><span>32</span><span>&gt;:    </span><span>pop</span><span>    %</span><span>rcx</span>
<span>   </span><span>0x00000000000a3211</span><span> &lt;</span><span>+</span><span>33</span><span>&gt;:    </span><span>ret</span></pre></div>
<p dir="auto">I&#39;m guessing that valgrind gets confused by that <code>movl $0x0,(%rsp)</code> for the <code>sigsz</code> argument somehow.</p>
      </div>
</div></div>
  </body>
</html>
