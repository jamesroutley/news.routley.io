<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/934692/5046d466490d9220/">Original</a>
    <h1>Merging bcachefs</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- $Id: slink-trial,v 1.1 2005-11-04 21:27:01 corbet Exp $ -->
<center>
<table>
<tbody><tr><td>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider accepting the trial offer on the right.  Thank you
for visiting LWN.net!
</p></td><td>
<div>
<h3>Free trial subscription</h3>
           <p>
           Try LWN for free for 1 month: no payment
           or credit card required.  <a href="https://lwn.net/Promo/slink-trial2-3/claim">Activate
           your trial subscription now</a> and see why thousands of
           readers subscribe to LWN.net.
           
</p></div>
</td>
</tr>

</tbody></table>
</center>

<p>
The <a href="https://bcachefs.org/">bcachefs filesystem</a>, and the
process for getting it upstream, were the topics
of a session led remotely by 
Kent Overstreet, creator of bcachefs, at the 
<a href="https://lwn.net/Articles/lsfmmbpf2023">2023 Linux Storage, Filesystem,
Memory-Management and BPF Summit</a>.  He has also discussed bcachefs in
previous editions of the summit, <a href="https://lwn.net/Articles/755276/">first
in 2018</a> and <a href="https://lwn.net/Articles/895266/">at last year&#39;s event</a>;
in both of those cases, the question of getting bcachefs merged
into the mainline kernel came up, but that merge has not happened yet.
This time 
around, though, Overstreet seemed 
closer than ever to being ready to actually start that process.
</p>

<p>
He began his talk by noting that he had been saying bcachefs is almost
ready for merging for some time now; &#34;now I&#39;m saying, let&#39;s finally do
it&#34;.  He wanted to report on the status of the filesystem and on why it is
ready now for upstreaming, but he wanted to use the bulk of the session to
discuss 
the process of doing so.  &#34;It&#39;s a massive, 90,000-lines-of-code
beast&#34; that needs to get reviewed, so there is a need to figure out the
process to do that review.
</p>

<p>
His goal with bcachefs is to have the &#34;performance, reliability,
scalability, and robustness of XFS with modern features&#34;.  That&#39;s a high
bar, and one that bcachefs has not yet reached, but &#34;I think we&#39;re pretty
far along&#34;. People are running bcachefs on 100TB filesystems &#34;without any
issues or complaints&#34;; he is waiting for the first 1PB filesystem.
&#34;Snapshots scale beautifully&#34;, which is not true for Btrfs, based on user
complaints, 
he said.
</p>

<h4>Status</h4>

<p>
In the last year, there has been a lot of scalability work done, much of
which required deep rewrites, including for the allocator, which dates back
to <a href="https://bcache.evilpiepirate.org/">bcache</a>. There is a new
&#34;no copy-on-write&#34; (nocow) mode and snapshots have been implemented. People
are using the snapshots to do backups of MySQL databases, he said, which is
a test of the robustness of the feature.
</p>

<p><a href="https://lwn.net/Articles/934695/">
<img src="https://static.lwn.net/images/2023/lsfmb-overstreet-sm.png" alt="[Kent Overstreet]" title="Kent Overstreet" width="260" height="237"/>
</a></p><p>
<a href="https://en.wikipedia.org/wiki/Erasure_code">Erasure coding</a> is
the last really big feature that he would like to get into bcachefs before
upstreaming it.  But he thinks &#34;it&#39;s time to draw a line in the sand&#34;, so
that can wait for a bit.  There is still a lot of work to do, but &#34;the big
feature work is lessening&#34;; he will be able to work on being a maintainer
without having to disappear for a month to work on something, as he did for
snapshots, for example.
</p>

<p>
The bcachefs team is growing; Brian Foster at Red Hat has been doing a lot
of great work on bug fixes, Overstreet said.  Eric Sandeen has helped in
attracting interest in bcachefs at Red Hat as well.  There is a bi-weekly
call on bcachefs development.  There is automated testing infrastructure
that has been added and it is &#34;making my life much easier&#34;, Overstreet
said.  The test system runs in about half an hour and includes multiple
runs of fstests as well as the &#34;huge test suite&#34; for bcachefs.
</p>

<p>
Rust is something that he has been evangelizing about to &#34;anyone who will
listen&#34;; he thinks &#34;writing code in C, when we finally have a better option
available, is madness&#34;.  He loves to write code, but not to debug it;
writing in Rust &#34;just means a lot less time debugging&#34;. He intends to
slowly rewrite bcachefs in Rust, which will be a ten-plus-year project, but
the use of Rust in bcachefs has already started.  Some of the user-space
tools have been rewritten in Rust and someone is looking at moving some of
that work into the kernel.
</p>

<h4>Upstreaming</h4>

<p>
That morning he had <a href="https://lwn.net/ml/linux-fsdevel/20230509165657.1735798-1-kent.overstreet@linux.dev/">posted</a> 32
preliminary patches adding infrastructure that bcachefs will need; those
patches were already being reviewed, he said.  The 
rest is 90,000 lines of code in 2,500 patches that he did not
post; he did include a link to his <a href="https://evilpiepirate.org/git/bcachefs.git">Git repository</a>, where
those patches live in a <a href="https://evilpiepirate.org/git/bcachefs.git/log/?h=bcachefs-for-upstream">bcachefs-for-upstream
branch</a>.  He then opened up the floor to discuss how those patches would
be reviewed and, eventually, merged.
</p>

<p>
Josef Bacik said that he thinks the response will be much the same as last
year; filesystem developers are &#34;really excited&#34; to see bcachefs get
merged.  He does not plan to review the implementation of the filesystem
itself and suspects that is generally true.  The people who are working on
it will review it; &#34;trust yourselves for that part&#34;.  The &#34;generic stuff is
what we need to review&#34;, once that is done, the rest of the filesystem code
can be merged as far as he is concerned.  That is, of course, up to Linus
Torvalds. 
</p>

<p>
Overstreet said that one of his questions is: &#34;what do we take to Linus?&#34;
He has spent the last year on process and infrastructure, getting a team
together, working with Red Hat, putting together an automated test suite,
and so on.  Mike Snitzer remotely pointed out that a patch set that had
recently been rejected contained two enormous patches that were essentially
impossible to review;  he contrasted that with the 2,500 fine-grained
patches that make up bcachefs, which is much easier to digest.
</p>  

<p>
While Snitzer is
not sure that having everyone go through them one-by-one in review is the right
approach, the obvious effort that went into that patch series makes it
easier to trust the code and the process that went into developing it.
&#34;You&#39;ve done the heavy lifting by doing all of that work to split up
patches.&#34;  Overstreet said that it was a lot of work to rebase nearly the
entire history, but that it came in handy around six months ago when Red
Hat noticed some big performance regressions.  He was able to use that
history to do automated bisection and got almost all of the performance back.
</p>

<p>
Bacik said that Torvalds is the &#34;maintainer&#34; responsible for merging a new
filesystem, so it will be up to him to decide if he is willing to pull the
full history into the mainline.  It would be Bacik&#39;s preference to do so,
because the history is &#34;super useful&#34;, but that is not something that the
people in the room can decide.  He suggested that the pull request be more
of a question about whether the full history was acceptable and, if not,
what would be.
</p>

<p>
One concern is that once bcachefs gets merged, it will be difficult for
anyone besides Overstreet to deal with the bug reports, Amir Goldstein
said.  It is important that it be explained in the pull request; &#34;I want to
merge this and I have a team that can support this&#34;.   Getting more help
was one of the criteria before upstreaming, Overstreet said.  He knew that
if it was a one-man show and he got deluged with bug reports, he would &#34;go
insane and run away to South America&#34;; Foster has been &#34;a huge help&#34;, which
is one of the things that makes him feel comfortable about merging at this
point. 
</p>

<p>
Paradoxically, the recent <a href="https://lwn.net/Articles/886708/">push to remove some
filesystems</a> (e.g. ReiserFS) 
from the kernel is actually going to make it easier to add new ones, Ted
Ts&#39;o said.  He can remember Hans Reiser being enthusiastic about his new
filesystem, with a team to support it, but that all fell into disrepair
over the years.  The kernel project now has a path for removing filesystems
after a deprecation cycle.  The idea that &#34;accepting a filesystem isn&#39;t
forever, makes it a whole lot easier&#34; to merge new ones.
</p>

<p>
He also suggested breaking up the patch series into smaller, more reviewable
chunks that collect up a small number of related patches. That would make
it easier 
for people to review, say, all of the lockdep patches in one chunk.  It
would mean relaxing the general guideline about not merging infrastructure
until 
its first caller is merged, which he is in favor of; he would amend that
guideline to allow merging 
when it includes a pointer to the Git tree of the first caller.
</p>

<p>
Overstreet thinks that the preliminaries that he posted earlier that day
will not be too controversial and other than perhaps one or two &#34;will just
sail through&#34;.  He noted that Christoph Hellwig had objected to the <a href="https://lwn.net/ml/linux-fsdevel/20230509165657.1735798-8-kent.overstreet@linux.dev/"><tt>vmalloc_exec()</tt>
patch</a>, though that functionality is needed for bcachefs, Overstreet
said. Since the 
talk, Mike Rapoport has <a href="https://lwn.net/Articles/933867/">proposed the JIT allocator</a>, which would
solve the 
underlying problem.
</p>

<p>
A remote participant said that Foster&#39;s experience had shown that the code
base is approachable; once bcachefs is available, interested developers will be
able to come up to speed and start working on it with few difficulties.
Christian Brauner asked that there be a clear delineation for who else
could step in and merge patches if Overstreet is unavailable.  Brauner noted
that the NTFS/NTFS3 maintainer disappeared and, even though there were people
who were contributing to the filesystem, it was not clear &#34;who could route
patches upstream&#34;.  Overstreet said that he would trust Foster in that role
if &#34;he is willing to step up to that&#34;. 
</p>

<p>
Brauner said that he thinks bcachefs is in &#34;excellent shape to be
upstreamed&#34;, but he is concerned with the number of filesystems in the
kernel;  he is glad to see that there are efforts to remove some of them.
Changes that impact all of the filesystems in the tree &#34;get painful very
very fast&#34; and, in some cases, there is no one available to review the
changes.  He would like the acceptance process to be more conservative;
accepting NTFS/NTFS3 was &#34;a huge mistake&#34;, for example.  Brauner said that
none of that was directed at bcachefs, but was a more general concern;
filesystem acceptance and deprecation
was taken up in a lightning talk  (<a href="https://www.youtube.com/watch?v=-fpgPrTnX2g">YouTube video</a>) later
that day.
</p>

<p>
Darrick Wong said that he had already started doing what Ts&#39;o suggested in
his <a href="https://lwn.net/ml/linux-fsdevel/20230526000020.GJ11620@frogsfrogsfrogs/">patches</a>
for <a href="https://lwn.net/Articles/934561/">XFS online repair</a>.  He has a collection
of infrastructure patches that refer to callers that are coming soon; he
has convinced Dave Chinner that there is value in reviewing the
infrastructure pieces while also looking at the bigger picture of where it
is all leading.  That helps him because he can stop &#34;rebasing things
repeatedly and having to play code golf, like moving small helper functions
up and down in the patch set&#34;.  Putting all of that stuff in a separate set
of infrastructure patches helped him, though it did cause some complaints
from reviewers, but there is now some precedent for that approach, he said.
</p>

<p>
Overstreet said that he is not particularly concerned about the 30 or
so &#34;relatively uncomplicated&#34; infrastructure patches that he needs to
land.  He is going to wait for the Acked-by and Reviewed-by tags to come
in, but if they do not, then he will use the suggested approach &#34;as a Plan
B&#34;.  With that, the 
session came to a close.
</p></div></div>
  </body>
</html>
