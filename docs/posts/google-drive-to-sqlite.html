<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://simonwillison.net/2022/Feb/20/google-drive-to-sqlite/">Original</a>
    <h1>Show HN: Google Drive to SQLite</h1>
    
    <div id="readability-page-1" class="page"><div id="primary">

<div>




<p>I released a new tool this week: <a href="https://datasette.io/tools/google-drive-to-sqlite">google-drive-to-sqlite</a>. It’s a CLI utility for fetching metadata about files in your <a href="https://drive.google.com/">Google Drive</a> and writing them to a local SQLite database.</p>
<p>It’s pretty fun!</p>
<p>Here’s how to create a SQLite database of every file you’ve started in your Google Drive, including both files created in Google Docs/Sheets and files you’ve uploaded to your drive:</p>
<pre><code>% pip install google-drive-to-sqlite
% google-drive-to-sqlite auth
Visit the following URL to authenticate with Google Drive

https://accounts.google.com/o/oauth2/v2/auth?access_type=offline&amp;...

Then return here and paste in the resulting code:
Paste code here: 
# Authentication is now complete, so run:
% google-drive-to-sqlite files starred.db --starred
% ls -lah starred.db
-rw-r--r--@ 1 simon  staff    40K Feb 20 14:14 starred.db
</code></pre>
<p>The OAuth client ID it is using hasn’t been verified by Google yet, which I think means that only the first 100 people to use it will be able to authenticate. If you need to you can work around that by creating your own client ID, as <a href="https://datasette.io/tools/google-drive-to-sqlite#user-content-authentication">described in the README</a>.</p>
<p>Having created that <code>starred.db</code> file you can explore the resulting database using <a href="https://datasette.io/">Datasette</a> or <a href="https://datasette.io/desktop">Datasette Desktop</a>:</p>
<pre><code>datasette starred.db

# or if you have the Datasette Desktop macOS app installed:
open starred.db
</code></pre>
<p>Here’s Datasette running against one of my larger metadata collections:</p>
<p><img alt="Screenshot showing the drive_files, drive_folders and drive_users tables" src="https://static.simonwillison.net/static/2022/google-drive-to-sqlite.png"/></p>
<h4>Why build this?</h4>
<p>I recently got involved with a participatory journalism project, where a team of reporters have used FOIA requests to gather a huge corpus of thousands of files. The files are in a complex folder hierarchy a Google Drive. I wanted to start getting a feel for what’s in there.</p>
<p>Pulling the metadata—file names, sizes, file types, file owners, creation dates—into a SQLite database felt like a great way to start understanding the size and scope of what had been collected so far.</p>
<p>Outside of that project, there’s something very exciting to me about being able to use Google Drive to collate all kinds of different data and then tie it into the larger Datasette and <a href="https://dogsheep.github.io/">Dogsheep</a> ecosystems. I think there’s a lot of potential here for all kinds of interesting projects.</p>
<h4>How it works</h4>
<p>The tool is written in Python using <a href="https://click.palletsprojects.com/">Click</a> (based on my <a href="https://github.com/simonw/click-app">click-app template</a>) and <a href="https://sqlite-utils.datasette.io/">sqlite-utils</a>. It works by calling the <a href="https://developers.google.com/drive/api">Google Drive API</a>.</p>
<p>The <code>auth</code> command needs to get hold of an OAuth access token scoped to make read-only calls to the user’s Google Drive contents.</p>
<p>This took a bit of figuring out. I wrote up what I learned in this TIL: <a href="https://til.simonwillison.net/googlecloud/google-oauth-cli-application">Google OAuth for a CLI application</a></p>
<p>Notably, the end result of that flow is a JSON response containing both an <code>access_token</code> and a <code>refresh_token</code>.</p>
<p>The access token can be used to make authenticated API calls, but it expires after an hour and that expiration cannot be extended.</p>
<p>The refresh token lasts forever, and can be used at any time to obtain a fresh access token.</p>
<p>So the <code>auth</code> command writes the refresh token to a file called <code>auth.json</code>, then future calls to other commands use that token to retrieve a fresh access token on every run.</p>
<p>The most useful command is <a href="https://datasette.io/tools/google-drive-to-sqlite#user-content-google-drive-to-sqlite-files">google-drive-to-sqlite files</a>, which retrieves file metadata based on various criteria, then either writes that to a SQLite database or dumps it out as JSON or newline-delimited JSON. It does this by paginating through results from the Google Drive <a href="https://developers.google.com/drive/api/v3/reference/files/list">files list API</a>.</p>
<p>The <code>files --folder ID</code> option is a special case. It retrieves every nested file and subfolder starting at the specified folder. The Google Drive API doesn’t support this operation directly, so the tool instead has to recursively call directory listings on every folder until it has pulled back all of the data. See my TIL <a href="https://til.simonwillison.net/googlecloud/recursive-fetch-google-drive">Recursively fetching metadata for all files in a Google Drive folder</a> for more details.</p>
<p>This operation took over an hour for the largest folder I tested it against! So long that the access token it was using expired and I had to <a href="https://github.com/simonw/google-drive-to-sqlite/issues/11">implement code</a> to refresh the token in the middle of the operation.</p>
<h4>Some other neat tricks</h4>
<p>The <a href="https://datasette.io/tools/google-drive-to-sqlite#user-content-google-drive-to-sqlite-download-file_id">download command</a> downloads the specified file to disk:</p>
<pre><code>google-drive-to-sqlite download \
  0B32uDVNZfiEKLUtIT1gzYWN2NDI4SzVQYTFWWWxCWUtvVGNB
</code></pre>
<p>It detects the file type and uses that as the extension—in the above example, it saves the file as <code>0B32uDVNZfiEKLUtIT1gzYWN2NDI4SzVQYTFWWWxCWUtvVGNB.pdf</code>.</p>
<p>The <a href="https://datasette.io/tools/google-drive-to-sqlite#user-content-google-drive-to-sqlite-export-format-file_id">export command</a> only works against the file IDs for docs, sheets and presentations create using Google Apps. It can export to a variety of different formats:</p>
<pre><code>google-drive-to-sqlite export html \
  10BOHGDUYa7lBjUSo26YFCHTpgEmtXabdVFaopCTh1vU
</code></pre>
<p>This writes to <code>10BOHGDUYa7lBjUSo26YFCHTpgEmtXabdVFaopCTh1vU-export.html</code>.</p>
<p>The <a href="https://datasette.io/tools/google-drive-to-sqlite#user-content-google-drive-to-sqlite-get-url">get command</a> takes a URL to a Google Drive API endpoint and fetches it using a valid access token. This is a great tool for debugging and API exploration—my <code>github-to-sqlite</code> tool <a href="https://datasette.io/tools/github-to-sqlite#user-content-making-authenticated-api-calls">has this too</a>.</p>
<pre><code>google-drive-to-sqlite get &#39;https://www.googleapis.com/drive/v3/about?fields=*&#39;
</code></pre>
<p>It also knows how to paginate! Adding <code>--paginate files</code> will cause it to fetch all of the subsequent pages of the API and return just the items from the <code>&#34;files&#34;</code> key combined into a single JSON array, for example:</p>
<pre><code>google-drive-to-sqlite get \
  https://www.googleapis.com/drive/v3/files \
  --paginate files
</code></pre>
<h4>Exploring other APIs with the same tools</h4>
<p>While I was building this, I realized that with just a little extra work the auth and get commands could be used to explore other Google APIs too.</p>
<p>If you are a developer, you can create your own OAuth credentials and enable access to other APIs using <a href="https://console.cloud.google.com/apis/credentials">the Google Cloud console</a>. You can then take the resulting client ID and secret, pick a scope and run the following:</p>
<pre><code>google-drive-to-sqlite auth -a calendar-auth.json \
  --scope &#39;https://www.googleapis.com/auth/calendar.readonly&#39; \
  --google-client-id &#39;184325416553-nu5ci563v36rmj9opdl7mah786anbkrq.apps.googleusercontent.com&#39; \
  --google-client-secret &#39;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&#39;
</code></pre>
<p><code>calendar-auth.json</code> will now be a JSON file that looks something like this:</p>
<div><pre>{
  <span>&#34;google-drive-to-sqlite&#34;</span>: {
    <span>&#34;refresh_token&#34;</span>: <span><span>&#34;</span>1//...<span>&#34;</span></span>,
    <span>&#34;google_client_id&#34;</span>: <span><span>&#34;</span>184325416553-nu5ci563v36rmj9opdl7mah786anbkrq.apps.googleusercontent.com<span>&#34;</span></span>,
    <span>&#34;google_client_secret&#34;</span>: <span><span>&#34;</span>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<span>&#34;</span></span>,
    <span>&#34;scope&#34;</span>: <span><span>&#34;</span>https://www.googleapis.com/auth/calendar.readonly<span>&#34;</span></span>
  }
}</pre></div>
<p>You can now fetch your Google Calendar items by adding your email address to the following:</p>
<pre><code>google-drive-to-sqlite get \
  https://www.googleapis.com/calendar/v3/calendars/...@gmail.com/events \
  --auth calendar-auth.json
</code></pre>
<p>This will output JSON to the console. For newline-delimited JSON, add <code>--nl</code>.</p>
<p>Since we can paginate with <code>--paginate items</code>, this means we can pipe the results to <a href="https://sqlite-utils.datasette.io/en/stable/cli-reference.html#insert">sqlite-utils insert</a> and create a SQLite database of our calendar items!</p>
<pre><code>google-drive-to-sqlite get \
  https://www.googleapis.com/calendar/v3/calendars/...@gmail.com/events \
  --auth calendar-auth.json \
  --paginate items --nl \
  | sqlite-utils insert calendar.db events \
    - --pk id --nl --alter --replace
</code></pre>
<p>Maybe <code>google-drive-to-sqlite</code> wasn’t the right name for this after all!</p>
<h4>What’s next?</h4>
<p>Google severely <a href="https://cloud.google.com/blog/products/identity-security/enhancing-security-controls-for-google-drive-third-party-apps">tightened their policies</a> on apps that can access Google Drive a few years ago. I’m currently waiting to see if my app will make it through their verification process, see <a href="https://github.com/simonw/google-drive-to-sqlite/issues/15">issue #15</a>.</p>
<p>If it doesn’t the tool will still be usable, but users will have to jump through some extra hoops to set up their own client ID. I don’t see this as a huge concern.</p>
<p>I’ve started thinking about ways to import additional data from the Google Drive APIs. I’m particularly interested in the idea of creating a full-text search index in SQLite based on plain text exports of documents created in Google Docs, see <a href="https://github.com/simonw/google-drive-to-sqlite/issues/28">issue #28</a>.</p>
<p>For other short-term future plans, take a look at the project’s <a href="https://github.com/simonw/google-drive-to-sqlite/issues">open issues</a>.</p>




</div>

</div></div>
  </body>
</html>
