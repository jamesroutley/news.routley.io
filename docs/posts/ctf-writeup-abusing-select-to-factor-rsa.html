<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://threadreaderapp.com/thread/1723398619313603068.html">Original</a>
    <h1>CTF Writeup: Abusing select() to factor RSA</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<div data-controller="mentions">

<div>
<p><a href="https://threadreaderapp.com/user/moyix"><img src="https://pbs.twimg.com/profile_images/851124181995589638/67s_2qnD_bigger.jpg" alt="Brendan Dolan-Gavitt Profile picture" data-controller="twitter-profile" data-twtrid="15194897" data-action="error-&gt;twitter-profile#error"/></a>
</p>

</div> 
<p>
Will still try to do a blog post on my @CSAW_NYUTandon CTF challenge, NERV Center, but for now here&#39;s a thread explaining the key mechanics. I put a lot of work into the aesthetics, like this easter egg credit sequence (all ANSI colors+unicode text) that contains key hints: <span><video controls="" poster="https://pbs.twimg.com/ext_tw_video_thumb/1723398329193603073/pu/img/BOjilHxex46DHgNz.jpg"><source src="https://video.twimg.com/ext_tw_video/1723398329193603073/pu/vid/avc1/320x270/T7o7Rg69CJYAflcu.mp4?tag=12" type="video/mp4"/></video></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon (Note the karaoke subtitles timed to the credits at the bottom üòÅ)
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon First, the vulnerability. If you read the man page for select(), you&#39;ll see this warning: select() is limited to monitoring file descriptors numbered less than 1024. But modern systems can have many more open files, and importantly the kernel select() interface is NOT limited. <span><a href="https://pbs.twimg.com/media/F-q-tpjXwAAKWQk.jpg" target="_blank"><img alt="DESCRIPTION  WARNING: select() can monitor only file descriptors numbers  that  are  less than  FD_SETSIZE  (1024)‚Äîan  unreasonably low limit for many modern applications‚Äîand this limitation will not change.  All modern  applications  should instead use poll(2) or epoll(7), which do not suffer this limitation." src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-q-tpjXwAAKWQk.jpg"/></a></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon But IMO the man page understates the severity of the problem. So what happens if you *do* try to monitor fds higher than 1024? Well, the fd_set struct is just a bitset of 1024 bits (128 bytes). So attempting to monitor fds larger than 1024 will cause memory corruption!
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon And the really cool part (to me) is that a) the corruption is bitwise, since the data structure is a bitset, and b) the exact bits that will be written out of bounds depend on the *state* of the file descriptors being monitored.
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon So if the fds correspond to, say, network connections, an attacker can make a large number of connections, arrange for them to be in just the right state, and thereby get precise control over the bit pattern that gets written.
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon (Side note: I discovered this because very old versions of QEMU‚Äîincluding the one used by our PANDA 1.0-based malware sandbox‚Äîhad this bug and guests could trigger it in the SLIRP user mode networking by making a large number of connections. Yikes! )<a data-preview="true" href="https://bugzilla.redhat.com/show_bug.cgi?id=892977">bugzilla.redhat.com/show_bug.cgi?i‚Ä¶</a>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon select() takes up to three bitsets: readfds, writefds, and exceptfds, so each is susceptible to this overflow. I decided to have the intended overflow occur on exceptfds.
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Why? Two reasons: 1) it&#39;s third in the argument list so it naturally would be the last one listed in, say, a struct; 2) the fd states can be controlled more easily‚Äîwith TCP connections, exceptfds is used to indicate connections with pending TCP out-of-band (OOB) data.
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon So now the basic exploit strategy is clear: make more than 1024 connections to the server, an send TCP OOB data to the ones with fds higher than 1024 to set your desired bit pattern. But exactly what should get overwritten?
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon That&#39;s when this challenge moved from just Pwn to Pwn+Crypto :D I decided to place an RSA public key used for ssh-style challenge/response auth right after the exceptfds bitset, so you can control the upper 64 bits using the vuln. <span><a href="https://pbs.twimg.com/media/F-rD9ZUXEAAySUm.jpg" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rD9ZUXEAAySUm.jpg"/></a></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon What can you do with the ability to control the top 64 bits of a 1024-bit RSA public key N? Well, N = pq, which is hard to factor. But the *corrupted* N&#39; is very likely to be a product of a bunch of smaller primes‚Äîwhich is easy to factor!
<sup><i></i></sup>
</p>
<div id="tweet_13" data-controller="thread" data-action="click-&gt;thread#showTweet" data-screenname="moyix" data-tweet="1723406926829047962" dir="auto"><p>
@CSAW_NYUTandon I first learned of this trick from the super cool USENIX Security 2016 paper Flip Feng Shui by Kaveh Razavi, @bjg et al., who used it in conjunction with RowHammer and memory deduplication to bypass SSH authentication. <a data-preview="true" href="https://www.usenix.org/conference/usenixsecurity16/technical-sessions/presentation/razavi">usenix.org/conference/use‚Ä¶</a></p></div>
<p>
@CSAW_NYUTandon (One of the players who solved the challenge during CSAW CTF finals actually found an even sweeter way to exploit this vuln: figure out a bit pattern that makes N *prime* and set that. Then the corresponding private key d is just: pow(65537, -1, n-1). Slick!)
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Once you&#39;ve factored the key (or made it prime) and figured out the secret key d for the corrupted public key, you can use it to forge signatures and bypass the authentication, allowing you to download the flag (encrypted with RSA+AES-256-GCM). <span><a href="https://pbs.twimg.com/media/F-rInsJXEAAuE0Q.jpg" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rInsJXEAAuE0Q.jpg"/></a></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Okay, but now on to the important stuff: ~aesthetics~. The theme of the challenge was based around Episode 13 of Neon Genesis Evangelion, which features an Angel that hacks NERV&#39;s MAGI supercomputer cluster.
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon I realized that three computers in the MAGI cluster (Casper, Balthasar, and Melchior) correspond neatly to the three fd_sets readfds, writefds, and exceptds. So I was able to make a cute UI that shows the state of the fd_sets in real-time. <span><video controls="" poster="https://pbs.twimg.com/ext_tw_video_thumb/1723411409579429888/pu/img/8Bjj0p8WU4HfW3jo.jpg"><source src="https://video.twimg.com/ext_tw_video/1723411409579429888/pu/vid/avc1/320x270/qYrDaeco3ZV7Csnc.mp4?tag=12" type="video/mp4"/></video></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Aside from being my best attempt at recreating the UI from the show (pictured here), the UI elements also have some key clues to the vulnerability. <span><a href="https://pbs.twimg.com/media/F-rKhHpWsAAmxom.png" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rKhHpWsAAmxom.png"/></a></span>
<sup><i></i></sup>
</p>
<div id="tweet_19" data-controller="thread" data-action="click-&gt;thread#showTweet" data-screenname="moyix" data-tweet="1723415151502602441" dir="auto"><p>
@CSAW_NYUTandon - The CODE field shows the highest file descriptor in use, and the EXTENTION (sic) shows the server&#39;s max fd ulimit.</p></div>
<p>
@CSAW_NYUTandon All of the visuals in the challenge were created using plain unicode characters and ANSI colors, so you can just cat the text files to see them (or dump them over a network socket). <span><video controls="" poster="https://pbs.twimg.com/ext_tw_video_thumb/1723415475378393089/pu/img/nUXZ6x6EkzpNC3jm.jpg"><source src="https://video.twimg.com/ext_tw_video/1723415475378393089/pu/vid/avc1/320x270/gcU1d77FxNPgoyFt.mp4?tag=12" type="video/mp4"/></video></span>
<sup><i></i></sup>
</p>
<div id="tweet_21" data-controller="thread" data-action="click-&gt;thread#showTweet" data-screenname="moyix" data-tweet="1723416020134564123" dir="auto"><p>
@CSAW_NYUTandon The credit sequence was made with some rather, uh, &#34;rough and ready&#34; techniques. <span><span><blockquote data-conversation="none" data-align="center" data-dnt="true"><a href="https://twitter.com/moyix/status/1723409266051051904">https://twitter.com/moyix/status/1723409266051051904</a></blockquote></span></span>
<sup><i></i></sup>
</p></div>
<p>
@CSAW_NYUTandon The code for credits generation is also available, though it is not what I would call production-quality <a data-preview="true" href="https://github.com/moyix/csaw23_nervcenter_credits">github.com/moyix/csaw23_n‚Ä¶</a>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Finally, a bit on the mechanics of developing this challenge. First, it ended up being rather a lot of C code, so I was super worried about accidentally introducing an unintended vuln that would make the challenge boring. <span><a href="https://pbs.twimg.com/media/F-rPWU8WIAAVCx8.jpg" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rPWU8WIAAVCx8.jpg"/></a></span>
<sup><i></i></sup>
</p>
<div id="tweet_24" data-controller="thread" data-action="click-&gt;thread#showTweet" data-screenname="moyix" data-tweet="1723419330090615180" dir="auto"><p>
@CSAW_NYUTandon To guard against this I wrote a bunch of libfuzzer targets, network torture tests in Python, and traditional CTest unit tests. I think it worked! I didn&#39;t hear of anyone finding a vuln in the challenge except the one I intended. </p></div>
<p>
@CSAW_NYUTandon Another bit that took some work was making the challenge consistently solvable. With select(), you fill the fd_set with 1s, call select, and the kernel fills the set with the actual fd state. But that means that 1/2 the time the key is corrupted by all 1s instead of your bits!
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon This makes exploitation annoying, to say the least. So I introduced a mechanism that lets players pause and resume the thread calling select(), so the corrupted key stays in place during factoring/signing/encrypting. <span><a href="https://pbs.twimg.com/media/F-rThOzXcAAPWzh.jpg" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rThOzXcAAPWzh.jpg"/></a></span>
<sup><i></i></sup>
</p>
<div id="tweet_27" data-controller="thread" data-action="click-&gt;thread#showTweet" data-screenname="moyix" data-tweet="1723423812996243773" dir="auto"><p>
@CSAW_NYUTandon Oh, a couple more bits of aesthetics. The sensor port (the one you actually use for the overflow, lets you look at some cards for the various angels: </p></div>
<p>
@CSAW_NYUTandon That functionality also hides the easter egg: by calling EXAMINE on three angels in a row where the first letter of their names spell out &#34;RSA&#34; (e.g., Ramiel, Sandalphon, Adam), you can activate the credit sequence shown in the first tweet. <span><span><blockquote data-conversation="none" data-align="center" data-dnt="true"><a href="https://twitter.com/moyix/status/1723398619313603068">https://twitter.com/moyix/status/1723398619313603068</a></blockquote></span></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon And I think it&#39;s always fun to taunt the players a little bit. That&#39;s why when you fail the challenge-response authentication, Asuka shows up to make fun of you. (There are a few other images included for other errors, but they&#39;re harder to trigger.) <span><a href="https://pbs.twimg.com/media/F-rVjxLW0AAlWIQ.jpg" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rVjxLW0AAlWIQ.jpg"/></a></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon I learned a few fun things while making this challenge. First, Python crypto libraries like pycryptodome do NOT enjoy working with prime or multi-prime keys. I used OpenSSL directly instead in my solver, but some players monkeypatched the Python library. <a data-preview="true" href="https://github.com/moyix/csaw23_nervcenter/tree/main/solver">github.com/moyix/csaw23_n‚Ä¶</a>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Second, one variant of the challenge I tried ran into an interesting issue. I considered byte-swapping the key so that players could only set the LSB. But it turns out half of those keys are unusable, because OpenSSL uses Montgomery multiplication, which requires an odd modulus.
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Tommaso Gagliardoni of Kudelski Security also suggested a variant on the core RSA overwrite that would also have been fun - allow the overwrite to make the key BIGGER by extending into adjacent data in memory. Sadly I didn&#39;t have time to implement this. <span><a href="https://pbs.twimg.com/media/F-rYbWoW8AA561k.jpg" target="_blank"><img alt="Image" src="https://threadreaderapp.com/images/1px.png" data-src="https://pbs.twimg.com/media/F-rYbWoW8AA561k.jpg"/></a></span>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon Okay this thread is now officially WAY too long, so I&#39;ll wrap up by saying that I had a great time writing the challenge, and I&#39;m thrilled that it all came together and people enjoyed playing it! The challenge source and solver can be found here: <a data-preview="true" href="https://github.com/moyix/csaw23_nervcenter">github.com/moyix/csaw23_n‚Ä¶</a>
<sup><i></i></sup>
</p>
<p>
@CSAW_NYUTandon @threadreaderapp unroll
<sup><i></i></sup>
</p>
<p>‚Ä¢ ‚Ä¢ ‚Ä¢</p>
<p><span>
Missing some Tweet in this thread? You can try to
<a id="force-click" href="#" data-category="refresh" data-action="1723398619313603068">force a refresh</a>
</span>
</p>
„ÄÄ
</div>
</div>
</div></div>
  </body>
</html>
