<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rosenzweig.io/blog/asahi-gpu-part-n.html">Original</a>
    <h1>Dissecting the Apple M1 GPU, the end</h1>
    
    <div id="readability-page-1" class="page">
<header><p>26 Aug 2025</p></header><p>In 2020, Apple
released the M1 with a custom GPU. We got to work reverse-engineering
the hardware and porting Linux. Today, you can run Linux on a range of
M1 and M2 Macs, with almost all hardware working: wireless, audio, and
full graphics acceleration.</p>
<p>Our story begins in December 2020, when <a href="https://marcan.st/">Hector Martin</a> kicked off <a href="https://asahilinux.org">Asahi Linux</a>. I was working for <a href="http://collabora.com/">Collabora</a> working on Panfrost, the open
source Mesa3D driver for Arm Mali GPUs. Hector put out a public call for
guidance from upstream open source maintainers, and I bit. I just
intended to give some quick pointers. Instead, I <a href="https://xkcd.com/356/">bought myself a Christmas present</a> and
got to work. In between my university coursework and Collabora work, I
poked at the <a href="https://rosenzweig.io/blog/asahi-gpu-part-1.html">shader
instruction set</a>.</p>
<p>One thing led to another. Within a few weeks, I <a href="https://rosenzweig.io/blog/asahi-gpu-part-2.html">drew a
triangle</a>.</p>
<p>In 3D graphics, once you can draw a triangle, you can do <a href="https://www.youtube.com/watch?v=dKmzEgpEdNw">anything</a>.</p>
<p>Pretty soon, I started work on a <a href="https://rosenzweig.io/blog/asahi-gpu-part-3.html">shader
compiler</a>. After my final exams that semester, I took a few days off
from Collabora to bring up <a href="https://rosenzweig.io/blog/asahi-gpu-part-4.html">an OpenGL
driver</a> capable of spinning gears with my new compiler.</p>
<p>Over the next year, I kept <a href="https://rosenzweig.io/blog/asahi-gpu-part-5.html">reverse-engineering</a>
and improving the driver until <a href="https://rosenzweig.io/blog/asahi-gpu-part-6.html">it could run 3D
games on macOS</a>.</p>
<p>Meanwhile, <a href="https://lina.yt">Asahi Lina</a> wrote a kernel
driver for the Apple GPU. My userspace OpenGL driver ran on macOS,
leaving her kernel driver as the missing piece for an open source
graphics stack. In December 2022, we <a href="https://rosenzweig.io/blog/asahi-gpu-part-7.html">shipped graphics
acceleration in Asahi Linux</a>.</p>
<p>In January 2023, I started my final semester in my Computer Science
program at the <a href="https://www.utoronto.ca/">University of
Toronto</a>. For years I juggled my courses with my part-time job and my
hobby driver. I faced the same question as my peers: what will I do
after graduation?</p>
<p>Maybe Panfrost? I started reverse-engineering of the Mali Midgard GPU
back in 2017, when I was still in high school. That led to an internship
at Collabora in 2019 once I graduated, turning into my job throughout
four years of university. During that time, Panfrost grew from a kid’s
pet project based on blackbox reverse-engineering, to a professional
driver engineered by a team with Arm’s backing and hardware
documentation. I did what I set out to do, and the project succeeded
beyond my dreams. <a href="https://rosenzweig.io/blog/passing-reins-panfrost.html">It was
time to move on</a>.</p>
<p>What <em>did</em> I want to do next?</p>
<ul>
<li>Finish what I started with the M1. Ship a great driver.</li>
<li>Bring full, conformant OpenGL drivers to the M1. Apple’s drivers are
not conformant, but we should strive for the industry standard.</li>
<li>Bring full, conformant Vulkan to Apple platforms, disproving the
myth that Vulkan isn’t suitable for Apple hardware.</li>
<li>Bring Proton gaming to Asahi Linux. Thanks to Valve’s work for the
Steam Deck, Windows games can run better on Linux than even on Windows.
Why not reap those benefits on the M1?</li>
</ul>
<p>Panfrost was my challenge until we “won”. My next challenge? Gaming
on Linux on M1.</p>
<p>Once I finished my coursework, I started full-time on gaming on
Linux. Within a month, we shipped <a href="https://rosenzweig.io/blog/opengl3-on-asahi-linux.html">OpenGL 3.1
on Asahi Linux</a>. A few weeks later, we passed <a href="https://rosenzweig.io/blog/first-conformant-m1-gpu-driver.html">official
conformance for OpenGL ES 3.1</a>. That put us at feature parity with
Panfrost. I wanted to go further.</p>
<p>OpenGL (ES) 3.2 requires geometry shaders, a legacy feature not
supported by either Arm or Apple hardware. The proprietary OpenGL
drivers emulate geometry shaders with compute, but there was no open
source prior art to borrow. Even though multiple Mesa drivers need
geometry/tessellation emulation, nobody did the work to get there.</p>
<p>My early progress on OpenGL was fast thanks to the mature common code
in Mesa. It was time to pay it forward. Over the rest of the year, I
implemented geometry/tessellation shader emulation. And also the rest of
the owl. In January 2024, I passed conformance for the full <a href="https://rosenzweig.io/blog/conformant-gl46-on-the-m1.html">OpenGL
4.6</a> specification, finishing up OpenGL.</p>
<p>Vulkan wasn’t too bad, either. I polished the OpenGL driver for a few
months, but once I started typing a Vulkan driver, I passed <a href="https://rosenzweig.io/blog/vk13-on-the-m1-in-1-month.html">1.3
conformance</a> in a few weeks.</p>
<p>What remained was wiring up the geometry/tessellation emulation to my
shiny new Vulkan driver, since those are required for Direct3D. Et
voilà, <a href="https://rosenzweig.io/blog/aaa-gaming-on-m1.html">Proton
games</a>.</p>
<p>Along the way, <a href="https://chaos.social/@karolherbst">Karol
Herbst</a> passed OpenCL 3.0 conformance on the M1, running my compiler
atop his “rusticl” frontend.</p>
<p>Meanwhile, when the Vulkan 1.4 specification was published, we were
ready and <a href="https://rosenzweig.io/blog/vulkan-14-sur-asahi-linux.html">shipped
a conformant implementation on the same day</a>.</p>
<p>After that, I implemented sparse texture support, unlocking Direct3D
12 via Proton.</p>
<p>…Now what?</p>
<ul>
<li><p>Ship a great driver? <strong>Check</strong>.</p></li>
<li><p>Conformant OpenGL 4.6, OpenGL ES 3.2, and OpenCL 3.0?
<strong>Check</strong>.</p></li>
<li><p>Conformant Vulkan 1.4? <strong>Check</strong>.</p></li>
<li><p>Proton gaming? <strong>Check</strong>.</p></li>
</ul>
<p>That’s a wrap.</p>
<p>We’ve succeeded beyond my dreams. The challenges I chased, I have
tackled. The drivers are fully upstream in Mesa. Performance isn’t too
bad. With the Vulkan on Apple myth busted, conformant Vulkan is now
coming to macOS via <a href="https://www.lunarg.com/a-vulkan-on-metal-mesa-3d-graphics-driver/">LunarG’s
KosmicKrisp</a> project building on my work.</p>
<p>Satisfied, I am now stepping away from the Apple ecosystem. My
friends in the Asahi Linux orbit will carry the torch from here. As for
me?</p>
<p><a href="https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-the-xe-hpg-architecture.html">Onto
the next challenge!</a></p>
<p><a href="https://rosenzweig.io/">Back to home</a></p>
</div>
  </body>
</html>
