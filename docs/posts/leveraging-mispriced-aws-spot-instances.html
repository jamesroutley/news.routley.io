<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pauley.me/post/2022/spot-instance-pricing/">Original</a>
    <h1>Leveraging mispriced AWS spot instances</h1>
    
    <div id="readability-page-1" class="page"><div><p>AWS Spot instances allow cloud customers to bid on spare compute capacity. This is a win-win for Amazon and customers: Amazon gets extra revenue on otherwise idle instances, and customers can drastically reduce compute costs for services that are tolerant of interruption. AWS makes this process easy by offering tooling to create and manage fleets of spot instances, but constraints in Amazon’s compute infrastructure, combined with sub-optimal use of spot instances by other customers, leaves opportunity when selecting instances.</p><p>Anyone familiar with spot instances knows that it can be advantageous to select from multiple similar instance types, selecting the cheapest or diversifying to improve availability. But in some cases, it may not even be necessary to reach for similar-enough instances: amazon’s spot market often prices instances that are <em>strictly more powerful</em> for less money. By looking at this mispricing, we can gain a better understanding of how Amazon is provisioning infrastructure under the hood, and save an average of 15% on existing spot prices when instances are mispriced.</p><p>EC2 instances are divided into <a href="https://aws.amazon.com/ec2/instance-types/" target="_blank" rel="noopener">families</a>. Each family has consistent architecture, underlying hardware, and rough performance per core, and has instance types of with varying CPU and memory. Within a family, each instance type has a set ratio of CPU to memory: compute-optimized instances simply have less memory per core (and sometimes slightly better CPUs), and memory-optimized instances have more memory per core. Each instance type is noted by its family (generation, what it’s optimized for, architecture, and any other features), and size in CPU cores. For instance, a <code>c6gd.12xlarge</code> is a <strong>C</strong>ompute-optimized, <strong>6</strong>th-generation <strong>G</strong>raviton instance with an NVMe <strong>D</strong>rive, and 48 cores (<code>xlarge</code> is 4 cores).</p><p>Within these instance families, we quickly see that some instance types are <em>strictly</em> better than others. Clearly (aside from benchmarking), a <code>.12xlarge</code> instance is always more desirable than a <code>.4xlarge</code> instance within the same family. But instance types across families can also be direct substitutes, and instances with storage are a direct substitute for those without. In theory, Amazon could ignore some CPU, memory, or disk resource when hosting a VM on the underlying hardware, and the VM would have no way of knowing. As we’ll see below, Amazon is almost certainly not doing that. By just modeling substitute instances that a <em>strictly</em> better than the desired instance, we can be sure that workloads deployed to substitute instances will have no issues running.</p><p>With some caveats, we can make the following substitutions:</p><ul><li>Any instance can substitute for instances in the same family of a smaller size.</li><li>Compute-optimized (<code>C</code>) instances can substitute for a general-purpose (<code>M</code>) instances of half the size, and <code>M</code> instances can substitute for <code>C</code> instances of the same size<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.</li><li>Memory-optimized (<code>R</code>) instances can substitute for <code>M</code> instances of the same size, and <code>M</code> instances can substitute for <code>R</code> instances of double the size.</li></ul><p>For example, you can make all these substitutions:</p><p><code>c6g.2xlarge</code>→<code>c6g.4xlarge</code>→<code>m6g.4xlarge</code>→<code>r6g.4xlarge</code>→<code>r6gd.4xlarge</code></p><p>If you’re looking to maximize your savings, you can likely also substitute later- and earlier-generation instance families, or different CPU vendors (Intel vs. AMD), but we’re going to focus on just those substitutions that Amazon could make <em>transparently</em>.</p><p>Taking a look at spot instance price history, we can pretty quickly discover instances of mispricing. Case in point:</p><figure><div><p><img alt="Mispriced AWS Spot Instance" srcset="/post/2022/spot-instance-pricing/example-mispricing_huc3afe305265324a32f17bec8cfff0f0e_156433_0e521ed6e348668a5b9c2fae7f1f692d.webp 400w,
/post/2022/spot-instance-pricing/example-mispricing_huc3afe305265324a32f17bec8cfff0f0e_156433_9b71b4d74814fc7ab01b3e026e5bcc7f.webp 760w,
/post/2022/spot-instance-pricing/example-mispricing_huc3afe305265324a32f17bec8cfff0f0e_156433_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src="https://pauley.me/post/2022/spot-instance-pricing/example-mispricing_huc3afe305265324a32f17bec8cfff0f0e_156433_0e521ed6e348668a5b9c2fae7f1f692d.webp" width="760" height="591" loading="lazy" data-zoomable=""/></p></div></figure><p>Here, we see the price of a <code>c6g.8xlarge</code> steadily climbing while the price of a <code>c6gd.8xlarge</code> stays relatively constant. Likely this is caused by naive customers bidding on <code>c6g</code> instances directly, instead of specifying their compute requirements and accepting the equivalent <code>c6gd</code> instance. Clearly, the market is not operating efficiently, and we can take advantage of that to get better instance pricing.</p><p>Next, let’s figure out just how prevalent this mispricing is, analyzing data across all AWS regions.</p><p>At this point we’ve shown that spot pricing isn’t perfectly efficient, but just how inefficient is it, and how much can we save by taking advantage of this? To answer these questions, we’ll analyze pricing data from 3 months across all AWS regions. As before, we’ll limit analysis to substitute instances that are <em>strictly</em> better than the desired instance.</p><p>We’ll look at time-series data across regions. When processing historical pricing data, we track which substitute instance is cheapest for every spot instance type, then compute the potential savings in percent and absolute terms. We’ll also track what percentage of instance types are mispriced in each availability zone, region, and geography. First, let’s look at mispricing by geography:</p><figure><div><p><img alt="Percent of mispriced instances by AWS geography" srcset="/post/2022/spot-instance-pricing/instance-mispricing-percent_hu4bfd75050cf84d6677687d46707156c8_128693_9d86c10dbe2784bc555f182949537b1c.webp 400w,
/post/2022/spot-instance-pricing/instance-mispricing-percent_hu4bfd75050cf84d6677687d46707156c8_128693_ebd56435a580a4ff98c5e3cabe5bd649.webp 760w,
/post/2022/spot-instance-pricing/instance-mispricing-percent_hu4bfd75050cf84d6677687d46707156c8_128693_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src="https://pauley.me/post/2022/spot-instance-pricing/instance-mispricing-percent_hu4bfd75050cf84d6677687d46707156c8_128693_9d86c10dbe2784bc555f182949537b1c.webp" width="760" height="448" loading="lazy" data-zoomable=""/></p></div></figure><p>There’s a lot of aggregation going on here! Each series represents the percentage of instance types that are mispriced (i.e., some other instance type is <em>better</em> and <em>cheaper</em>) across all regions and availability zones in a given geography. We see some broad trends, as as US and South America having the highest rate of mispricing. Overall, 11% of instance types are mispriced. But this doesn’t tell the whole story, as each region (and availability zone!) has its own spot market:</p><figure><div><p><img alt="Percent of mispriced instances by AWS availability zone" srcset="/post/2022/spot-instance-pricing/instance-mispricing-percent-zone_huf987a56627068c57539e252cd80987b0_284087_e4fe94c37974c77867597931aae05efc.webp 400w,
/post/2022/spot-instance-pricing/instance-mispricing-percent-zone_huf987a56627068c57539e252cd80987b0_284087_08398b12e295bbe21b6eed673cdea309.webp 760w,
/post/2022/spot-instance-pricing/instance-mispricing-percent-zone_huf987a56627068c57539e252cd80987b0_284087_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src="https://pauley.me/post/2022/spot-instance-pricing/instance-mispricing-percent-zone_huf987a56627068c57539e252cd80987b0_284087_e4fe94c37974c77867597931aae05efc.webp" width="760" height="447" loading="lazy" data-zoomable=""/></p></div></figure><p>Results here are all over the place, but one group of zones is by far the most mispriced. These zones (blue at the top of the graph) are all in <code>us-east-1</code>, the original and largest AWS region. Generally, it looks like the bigger the zone, the more potential mispricing there is! This is a little counter-intuitive as we’d expect the thicker market of larger regions to improve on these price inefficiencies. Perhaps percent of instances mispriced doesn’t tell the whole story; let’s look at the actual average <em>discount</em> of the cheapest substitute instance for mispriced instances:</p><figure><div><p><img alt="Percent discount of mispriced instances by AWS geography" srcset="/post/2022/spot-instance-pricing/instance-mispricing-discount_hu295a929faaf8115bc314f947182f457e_166884_b857754f537f5ba726e373714a8cfa0e.webp 400w,
/post/2022/spot-instance-pricing/instance-mispricing-discount_hu295a929faaf8115bc314f947182f457e_166884_029d9462410c85c60b390d448b08edc7.webp 760w,
/post/2022/spot-instance-pricing/instance-mispricing-discount_hu295a929faaf8115bc314f947182f457e_166884_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src="https://pauley.me/post/2022/spot-instance-pricing/instance-mispricing-discount_hu295a929faaf8115bc314f947182f457e_166884_b857754f537f5ba726e373714a8cfa0e.webp" width="760" height="450" loading="lazy" data-zoomable=""/></p></div></figure><p>Here we see an opposite (and more intuitive) effect! Larger regions may have more mispriced instance types, but the average price discrepancy is indeed lower, in line with what we might expect in a thicker market. Among mispriced instances, around 15% can be saved on average by switching to a substitute instance that is strictly better.</p><h2 id="estimating-overall-mispricing">Estimating overall mispricing</h2><p>Next, we’ll try to (<em>roughly</em>) estimate the total amount of mispricing going on across all of AWS. To do this, we’ll look at the absolute difference in instance pricing (in dollars, instead of percent) across types, and then take a wild guess at the number of overall spot instances. From this, we’ll see how much more money Amazon could (theoretically) make by reselling substitute instances on the spot market. Let’s look at overall price discrepancy across geographies:</p><figure><div><p><img alt="Sum of mispricing across instance types by AWS geography" srcset="/post/2022/spot-instance-pricing/instance-total-mispricing_hu7926f826e56ebb306b70ed667f6759a6_102018_6960dfc19df178044ab4241f03440c72.webp 400w,
/post/2022/spot-instance-pricing/instance-total-mispricing_hu7926f826e56ebb306b70ed667f6759a6_102018_7d9372212524c18419299ad9407851f9.webp 760w,
/post/2022/spot-instance-pricing/instance-total-mispricing_hu7926f826e56ebb306b70ed667f6759a6_102018_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src="https://pauley.me/post/2022/spot-instance-pricing/instance-total-mispricing_hu7926f826e56ebb306b70ed667f6759a6_102018_6960dfc19df178044ab4241f03440c72.webp" width="760" height="448" loading="lazy" data-zoomable=""/></p></div></figure><p>Mispricing varies over time, but averages between $5-10/hour <em>per availability zone</em>. This number means that, if a single instance of each type is mispriced, the instances are being sold for $5-10/hr less than the could be. Of course, in reality Amazon couldn’t make up that entire amount by reselling the instances under a different type, as this would move the market. Instead let’s assume they could recoup <em>half</em> that amount, a conservative estimate as substitute instance types are usually less popular types (larger or with attached disks).</p><p>Across all AWS availability zones instances are mispriced by roughly $400/hr at any given time. This means that, with just a single instance of each type, Amazon is missing out on $200/hr or roughy $1.7 million each year. This is over roughly 15,000 pools of instances. Given Amazon controls roughly 100 million IPs, we can guess that each instance pool probably has on the order of 1000 instances (more for smaller instances, less for larger instances). Given this, the average mispriced pool might have hundreds of instances, meaning hundreds of millions each year in missed revenue due to mispriced spot instances. Because amazon keeps their number of instances a secret, it’s difficult to make a precise estimate from the outside, but the missed revenue probably falls somewhere in this range.</p><p>EC2 instances make up a large portion of profit for the world’s largest cloud provider, so there’s no doubt Amazon has thought a lot about the market economics here. Given that, there is likely a good reason why Amazon doesn’t resell instances under different IDs. A few come to mind:</p><ul><li><em>Complexity</em>. Amazon’s current setup likely contains homogeneous sets of instances within a given server, and there could be deep architectural assumptions that would be violated by changing this.</li><li><em>Hidden differences</em>. There may be hidden differences in the underlying hardware that are not immediately apparent to customers, but that would cause issues if hardware were reused under other instance types.</li><li><em>Expected workload</em>. Instances provisioned under a given family may tend to have certain characteristics that Amazon plans around. For instance, a compute-optimized instance may have lower disk I/O than a memory-optimized one, and this could be used for planning.</li><li><em>Minimal benefit</em>. While the missed revenue appears large in absolute terms, it may simply be too small for Amazon to optimize around, especially given the other points.</li></ul><p>With all this said, the lingering question is how to leverage this mispricing to reduce costs. The most important trick here is to be flexible about your instance types, and think outside the box. <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-request-examples.html" target="_blank" rel="noopener">Example launch specifications</a> from Amazon use only single instance types, and while multi-availability-zone deployments may make this acceptable, accepting broad families and sizes of instances will allow a spot request to be filled at the lowest possible price. For instance, this spot request specifies attributes and automatically allows instance types of larger sizes or with disks:</p><figure><div><p><img alt="Example spot request using instance attributes instead of types" srcset="/post/2022/spot-instance-pricing/spot-request-example_hu605914f2e68ea9f5be4329ad1c017032_447664_4ec2c566ec8667fbaea2202f7874c6ad.webp 400w,
/post/2022/spot-instance-pricing/spot-request-example_hu605914f2e68ea9f5be4329ad1c017032_447664_f2340fe78c3ff9ab5bb79f5a29e539c4.webp 760w,
/post/2022/spot-instance-pricing/spot-request-example_hu605914f2e68ea9f5be4329ad1c017032_447664_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src="https://pauley.me/post/2022/spot-instance-pricing/spot-request-example_hu605914f2e68ea9f5be4329ad1c017032_447664_4ec2c566ec8667fbaea2202f7874c6ad.webp" width="640" height="760" loading="lazy" data-zoomable=""/></p></div></figure><p>You can use features such as <em>Spot price protection</em> and <em>Lowest price</em> allocation to ensure compatible expensive instances don’t cause you to go over budget. By using instance attributes instead of families we can take advantage of market inefficiencies to save money!</p><hr/><p>The spot market is vast and complex, and as we’ve seen it often contains inefficiencies that create unexpected deals on equivalent instance types. By crafting intelligent spot requests, we can reduce costs while getting equivalent or better performance.</p></div></div>
  </body>
</html>
