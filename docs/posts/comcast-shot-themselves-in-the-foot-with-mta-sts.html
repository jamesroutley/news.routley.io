<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.agwa.name/blog/post/comcast_shot_themselves_in_the_foot_with_mta-sts">Original</a>
    <h1>Comcast Shot Themselves in the Foot with MTA-STS</h1>
    
    <div id="readability-page-1" class="page"><div>





<p>
I recently heard from someone, let&#39;s call them Alex, who was unable to
email comcast.net addresses.  Alex&#39;s emails were being bounced back with
an MTA-STS policy error:
</p>

<p><code>MX host mx2h1.comcast.net does not match any MX pattern in MTA-STS policy
MTA-STS failure for Comcast.net: Validation error (E_HOST_MISMATCH)
MX host mx1a1.comcast.net does not match any MX pattern in MTA-STS policy
MTA-STS failure for Comcast.net: Validation error (E_HOST_MISMATCH)</code></p><p>
MTA-STS is a relatively new <a href="https://datatracker.ietf.org/doc/html/rfc8461" rel="external">standard</a>
that allows domain owners such as Comcast to opt in to authenticated encryption for their mail servers.
(By default, SMTP traffic between mail servers uses opportunistic
encryption, which can be defeated by active attackers to intercept email.)
MTA-STS requires the domain owner to duplicate their MX
record (the DNS record that lists a domain&#39;s mail servers) in a text
file served over HTTPS.  Sending mail servers, like Alex&#39;s, refuse
to contact mail servers that aren&#39;t listed in the MTA-STS text file.  Since HTTPS uses authenticated encryption, the
text file can&#39;t be altered by active attackers.  (In contrast, the MX record
is vulnerable to manipulation unless DNSSEC is used, but people don&#39;t like DNSSEC which
is why MTA-STS was invented.)
</p>

<p>
The above error messages mean that although <code>mx2h1.comcast.net</code> and
<code>mx1a1.comcast.net</code> are listed in comcast.net&#39;s MX record, they are not
listed in comcast.net&#39;s MTA-STS policy file.  Consequentially, Alex&#39;s
mail server thinks that the MX record was altered by attackers, and is
refusing to deliver mail to what it assumes are rogue mail servers.
</p>

<p>
However, <code>mx2h1.comcast.net</code> and <code>mx1a1.comcast.net</code> are
not rogue mail servers.  They are in fact listed in <a href="https://mta-sts.comcast.net/.well-known/mta-sts.txt" rel="external">Comcast&#39;s
current MTA-STS policy</a>:
</p>

<p><code>version: STSv1
mode: enforce 
mx: mx2c1.comcast.net
<strong>mx: mx2h1.comcast.net</strong>
<strong>mx: mx1a1.comcast.net</strong>
mx: mx1h1.comcast.net
mx: mx1c1.comcast.net
mx: mx2a1.comcast.net
max_age: 2592000</code></p><p>
This means that Alex&#39;s mail server is not consulting comcast.net&#39;s
current MTA-STS policy.  Instead, it&#39;s consulting a cached policy which
does not list <code>mx2h1.comcast.net</code> and <code>mx1a1.comcast.net</code>.
</p>

<p>
This can happen because mail servers cache MTA-STS policies to avoid
having to re-download an unchanged policy file every time an email is
sent.  To determine whether a domain&#39;s policy has changed, mail servers
query the domain&#39;s <code>_mta-sts</code> TXT record (e.g. <code>_mta-sts.comcast.net</code>), and
only re-download the MTA-STS policy file if the ID in the TXT record is
different from the ID of the currently-cached policy.
</p>

<p>
The obvious implication of the above is that if you ever change your domain&#39;s
MTA-STS policy, you have to remember to update the TXT record as well.
</p>

<p>
A more subtle implication is that you have to do the updates in the
right order.  If you update the TXT record before changing the policy file,
and a mail server fetches the policy in the intervening time,
it will download the <em>old</em> policy file but cache it under the <em>new</em> ID.
It won&#39;t ever download the new policy because it thinks it already
has it in its cache.
</p>

<p>
This pitfall could have been avoided had MTA-STS required the ID to
also be specified in the policy file instead of just in the TXT record.
That would have prevented mail servers from caching policies under the wrong ID.
</p>

<p>
There&#39;s some evidence that this is what happened with comcast.net.
The ID in the <code>_mta-sts.comcast.net</code> TXT record appears to be a UNIX
timestamp (seconds since the Epoch):
</p>

<p><code>_mta-sts.comcast.net.	7200	IN	TXT	&#34;v=STSv1; id=1638997389;&#34;</code></p><p>That timestamp translates to <strong>2021-12-08 21:03:09 UTC</strong>.</p>

<p>
However, the <code>Last-Modified</code> time of
<a href="https://mta-sts.comcast.net/.well-known/mta-sts.txt" rel="external">https://mta-sts.comcast.net/.well-known/mta-sts.txt</a> is three minutes
later:
</p>

<p><code>Last-Modified: Wed, 08 Dec 2021 <strong>21:06:05</strong> GMT</code></p><p>
If the ID in the TXT record reflects when the TXT record was
updated, there was a three minute gap between the updates.  If Alex&#39;s
mail server fetched comcast.net&#39;s MTA-STS policy during this window, it would
have cached the old policy under the new ID, causing the errors seen
above.
</p>


<h4>Recommendations for Domain Owners Who Use MTA-STS</h4>

<p>
You should <a href="https://www.agwa.name/blog/post/mta_sts_automation">automate
MTA-STS policy publication</a> to ensure that your MTA-STS policy
always matches your MX records and that the TXT record is reliably
updated, <em>in the correct order</em>, when your policy changes.
If your policy file is served by a CDN, you have to be extra careful not
to update the TXT record until your new policy file is fully propagated
throughout the CDN.
</p>

<p>
I further recommend that you rotate the ID in the TXT record daily
even if no changes have been made to your policy.  This will force mail
servers to re-download your policy file if it&#39;s more than a day old,
which provides a backstop in case something goes wrong with the order
of updates.
</p>

<p>
It may be tempting, but you should <em>not</em> reduce your policy&#39;s <code>max_age</code> value as this will
diminish your protection against active attackers who block retrieval of your policy.
Having a long <code>max_age</code> but a frequently rotating ID keeps your policy up-to-date
in mail servers but ensures that in an attack scenario mail servers will fail safe
by using a cached policy.
</p>

<p>
It&#39;s quite a bit of work to get this all right.  If you want the easy option,
<a href="https://sslmate.com/blog/post/mta_sts_monitoring_and_automation" rel="external">SSLMate will
automate all aspects of MTA-STS for you</a>: all you need to do is publish two CNAME records
delegating the <code>mta-sts</code> and <code>_mta-sts</code> subdomains to SSLMate-operated servers and SSLMate takes
care of the rest.
</p>


<h4>Recommendations for Mail Server Developers</h4>

<p>
You should assume that domain operators are not going to properly update their TXT records
and you should always attempt to re-download policy files that are more than a day old,
regardless of what the ID in the TXT record says.
</p>


<h4>Is this Really Better than DNSSEC/DANE?</h4>

<p>
Thanks to MTA-STS&#39; duplication of information and requirement for updates
to be done in the right order, there is a high chance of human error
when MTA-STS is deployed manually.  Unfortunately, it&#39;s very likely to be
deployed manually because there&#39;s a dearth of automation software,
and on the surface it looks easy to manage by hand.  To make matters
worse, MTA-STS&#39; caching semantics mean that the inevitable human error
leads to hard-to-diagnose problems, such as a subset of mail servers
being unable to mail your domain.  I suspect that many problems will
never be detected - email delivery will just become less reliable than
it was before MTA-STS was deployed.
</p>

<p>
Meanwhile, DNSSEC is increasingly automated, and if you use a modern
cloud provider like Route 53, Google Cloud DNS, or Cloudflare, you don&#39;t
have to worry about correct key management or remembering to sign zones
before they expire, which was traditionally a major source of DNSSEC mistakes.
</p>

<p>
However, not all mail server
operators support DNSSEC/DANE.  Although Microsoft <a href="https://techcommunity.microsoft.com/t5/exchange-team-blog/support-of-dane-and-dnssec-in-office-365-exchange-online/ba-p/1275494" rel="external">recently
added DNSSEC/DANE support to Office 365 Exchange</a>, Gmail only
supports MTA-STS.  Thus, there is still value to deploying MTA-STS
despite its flaws.  But we should not be happy about this state of affairs.
</p>


</div></div>
  </body>
</html>
