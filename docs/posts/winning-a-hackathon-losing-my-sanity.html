<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jero.zone/posts/meal-plan-wrapped">Original</a>
    <h1>Winning a hackathon, losing my sanity</h1>
    
    <div id="readability-page-1" class="page"><article> <article> <p>A few weeks ago, my friend <a href="https://ben.page">Ben</a> and I won <a href="https://jumbohack.vercel.app">JumboHack</a>, a hackathon at Tufts University. <a href="https://devpost.com/software/meal-plan-wrapped">Our entry</a> generates a Spotify Wrapped-like summary of students’ dining habits by scraping Tufts’ meal plan portal. Through some <a href="https://ben.page/wrapped">clever promotion</a> on Ben’s part, we managed to get hundreds of students to use it in just a couple of days. We won the <a href="https://jumbohack.vercel.app/certificate/ZK0liWzGnQBjaa8H3XySbBBhQ6M%2BwqzmPkTZ5mp8YDUfBMp81NnO3wxPVr8n3CdabzBqR4BYhq3ejKFzNp6%2FltjwXchCCkEd6%2BJDOH6sZc690n5TKBNWwiSdrOVKtKQ4H1gHCh4wCxYt8JGvMmdpZF4KlVPVnZDk2SHNJjdUHOA%3D">general track</a>, ”<a href="https://jumbohack.vercel.app/certificate/Xq8%2FM1JsUNBzNSTwwmADOaOq%2Buhc6ka0HVB%2FHmb4X09C5Llpo8u%2Br7jrxkU7qY518Uvb8LK0m6vhtWVplDl21THeCnBTmOXrUN%2FOHl7gPnM2ET%2B%2BvzeRo9VhoIst51sBzNgOLl0FutdtHg77mESikgFnxupeieQIqypuYEaUZgE%3D">most complete project</a>,” and <a href="https://jumbohack.vercel.app/certificate/jPTIFF4Z4rAUXLZHX3t18OIyNMVdQGwnYaABi8rEDAtQZ5KzuqqL6LIWXxxvTL0LRcs2dJ19Yu15%2BgyGRnugy3Ofd89QKv2kdJvpnolnGPuGJypv3UxC83A6nA4UQHJahGTDoRvQfW1qP91MrR75p0CcUbcyFKngC%2B8CeGW7O8w%3D">the whole shebang</a>.</p>
<p>You can try a live demo of our project <a href="https://jumbo.cash/share/y5uybwdf3aac">here</a>.</p>
<figure><img src="https://lamroger.com/_astro/2024-02-18.CbU5izJ2_eXDq2.webp" alt="Ben and I during judging" width="853" height="1280" loading="lazy" decoding="async"/><figcaption>Ben and I during judging</figcaption></figure>
<p>Tufts, like Brown and many other colleges, uses a piece of software (protected under an <a href="https://patents.google.com/patent/US6963857B1/">expired patent</a> that’s older than both of us) from a company called Atrium. Their marketing claims, in contrast to “legacy” systems, that it will “delight” users. As we will see, the irony of claiming Atrium’s software isn’t “legacy” is just too good.</p>
<p>Tufts calls their installation “JumboCash” and it can be accessed at <code>www.jumbocash.net</code>. (Don’t forget the <code>www.</code>—it won’t resolve without it.) However, the site that is ultimately loaded is determined by the <code>cid</code> (campus/college/customer ID?) parameter. Here’s Brown’s portal loaded through Tufts’ domain: <a href="https://www.jumbocash.net/index.php?cid=248"><code>www.jumbocash.net/index.php?cid=248</code></a>. You can even use the raw IP: <a href="http://3.131.28.213/index.php?cid=248"><code>3.131.28.213/index.php?cid=248</code></a> in all its <code>http://</code> glory.</p>
<figure><img src="https://tuftsesociety.files.wordpress.com/2014/01/tufts-university.jpg" alt="Bonus web development crime: Just as I&#39;ve done here, the header of Tufts&#39; JumboCash portal is hotlinked from the WordPress.com site of a long-deceased student organization"/><figcaption>Bonus web development crime: Just as I&#39;ve done here, the header of Tufts&#39; JumboCash portal is hotlinked from the WordPress.com site of a long-deceased student organization</figcaption></figure>
<p>The portal is really a wrapper around the reanimated corpse of much older software, its rotting flesh visible through nonsensical decisions and the occasional XML response.</p>
<p>The first thing Ben and I noticed when logging into the JumboCash portal is that the session key is stored as a URL parameter, just like the <code>cid</code>.</p>
<pre tabindex="0"><code><span><span>https://www.jumbocash.net/index.php?skey=20613b5ef40f04e15ecc5d5f56513b92&amp;cid=233</span></span></code></pre>
<p>While a cookie is set, it is ignored. You can copy the URL into a private browsing window (or change the domain to another school’s) and it will work just fine; remove the <code>skey</code> parameter and it won’t. Change to another IP address, and it…breaks? Clearly some attempt at security was made, and it feels a bit too complex to be the result of purely ignorance.</p>
<h2 id="guest-access">Guest access</h2>
<p>Because we can’t instruct students to copy-and-paste the URL (and thus their session key), we needed another way to access students’ transaction history. We turned our attention to JumboCash’s guest access feature.</p>
<p>Presumably intended for parents to reload their children’s accounts, it allows students to given an email address access and choose from a deceptively fine-grained set of permissions. I say “deceptively” because guests can change their own permissions and even add other guests. “Disabling” a guest’s access doesn’t actually restrict any features, and guests can re-enable themselves.</p>
<img src="https://lamroger.com/_astro/add-guest.CRsawLLW_15bnN7.webp" alt="" width="2664" height="2016" loading="lazy" decoding="async"/>
<p>Adding a new guest sends them an email with a password. We purchased the excellent domain <code>jumbo.cash</code> and had students add <code><a href="https://lamroger.com/cdn-cgi/l/email-protection" data-cfemail="e78092829493a78d928a8588c98486948f">[email protected]</a></code> to their accounts. We intercepted the emails with Postmark and pulled out the password, running a job to log in and scrape the requisite information.</p>
<figure><img src="https://lamroger.com/_astro/email.CY2KmnK-_wyoPW.webp" alt="The email from JumboCash is pretty much the same" width="1928" height="830" loading="lazy" decoding="async"/><figcaption>The email from JumboCash is pretty much the same</figcaption></figure>
<p>When it came to scraping the transaction history itself, we finally caught a small break: the portal allowed CSV export, making our job a bit easier. However, an HTML table, which is essentially XML, wouldn’t have been much trouble.</p>
<h2 id="the-final-hurdle">The final hurdle</h2>
<p>At the time, we decided adding a guest to Atrium’s “delightful” portal was already enough friction and decided not to ask students for their email. In hindsight, we should have collected them at the beginning and given students a custom <code>@jumbo.cash</code> email address to keep things straight.</p>
<p>To achieve this ✨magical✨ experience, we needed to figure out students’ email addresses from their name, since that’s all the portal seems to have. After an unsuccessful attempt at scraping Tufts’ Outlook directory, we took a closer look at the <a href="https://directory.tufts.edu">public directory</a>, which includes the names and emails of every student. Popping the hood, it makes a nice little request to a JSON API, which appears to be a wrapper around one or more LDAP directories. But unfortunately, it’s not allowed to be that easy.</p>
<p>The JumboCash portal displays students’ legal first and last names (e.g. Benjamin not Ben). The directory, on the other hand, can only be searched by students’ preferred names. Though not displayed in the interface, its API does return their legal names in <code>Lastname, Firstname M.</code> format.</p>
<p>Our first idea was to search the directory by last name and lazily use the PHP standard library’s <a href="https://www.php.net/manual/en/function.levenshtein.php">levenshtein() function</a> to find the closest match. However, this doesn’t work well with common or short last names—for example, “Li” is not only common but is included in lots of names like Julian and Colin and returns dozens of matches. Since the directory’s pagination was broken (while I have a theory as to why, it looks like it’s already been fixed), we couldn’t page through to find an exact match. Our gross solution was to try a bunch of formats: <code>Lastname</code>, <code>F. Lastname</code>, etc. and pick the closest name. This works…enough of the time.</p>
<h2 id="logging-in">Logging in</h2>
<p>Actually logging into JumboCash required two HTTP requests and four hours of reverse engineering. I spent so long on it that Ben, who had already scraped JumboCash for <a href="https://ben.page/swipes">a previous project</a>, started working on a Puppeteer solution in parallel.</p>
<p>But first, here’s how authentication actually works. A <code>POST</code> request is sent to <code>/login.php</code> with a <code>username</code> and <code>loginphrase</code>, which creates a session key. Then, second, a <code>GET</code> request to the same page “activates” the token. Failing to do this second request puts the UI into a weird “half-logged-in” state.</p>
<p>The first request returns, instead of a <code>Location</code> header, a snippet of JavaScript (<code>&lt;script type=&#39;JavaScript&#39;&gt;</code> to be exact) to rediect to another page. The second page (also <code>/login.php</code>, just with some URL parameters) contains a loader and some nasty JavaScript.</p>
<img src="https://lamroger.com/_astro/login-loader.X7OXQNdD_Z2akkiF.webp" alt="" width="2664" height="2016" loading="lazy" decoding="async"/>
<figure>
<pre tabindex="0"><code><span><span>&lt;!-- loader --&gt;</span></span>
<span><span>&lt;</span><span>div</span><span> class</span><span>=</span><span>&#34;loader&#34;</span><span>&gt;</span></span>
<span><span>    &lt;</span><span>div</span><span> class</span><span>=</span><span>&#34;inner one&#34;</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span></span>
<span><span>    &lt;</span><span>div</span><span> class</span><span>=</span><span>&#34;inner two&#34;</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span></span>
<span><span>    &lt;</span><span>div</span><span> class</span><span>=</span><span>&#34;inner three&#34;</span><span>&gt;&lt;/</span><span>div</span><span>&gt;</span></span>
<span><span>&lt;/</span><span>div</span><span>&gt;</span></span>
<span><span>&lt;</span><span>h1</span><span>&gt;Processing...&lt;/</span><span>h1</span><span>&gt;</span></span>
<span><span>&lt;!-- your message could go here --&gt;</span></span></code></pre>
<figcaption>The spinner, unceremoniously copy-pasted from some tutorial</figcaption>
</figure>
<p>While abnormal, this dance wouldn’t have taken the hours it did had one of our tools not <em>lied</em> to us. When using HTTPie to poke around the site, it would render the HTML returned by the first <code>POST</code> request, including executing the JavaScript it contained. However, while HTTPie’s webview still made the request (as a normal browser, without any of our headers), it didn’t show that it had.</p>
<p>We were baffled as to why session keys generated with requests from HTTPie worked, but those using even the cURL code it generated did not. As it turned out, HTTPie was secretly making the second “activation” request. HTTPie’s webview should probably not execute JavaScript, especially without showing the result. (It would also be nice if the webview stayed disabled instead of turning itself back on after every request.)</p>
<p>The JavaScript on the intermediary “loading” screen very responsibly checks if the browser supports the newfangled <code>XMLHttpRequest</code> API before polling an XML API for the status of the <code>skey</code>. While the concatenation in this script (included below) is out of control, I was luckily unable to find an XSS. That would have been quite fun, given the number of <code>.edu</code> domains this software runs on.</p>
<p><em>Keep scrolling! There’re goodies after, I promise!</em></p>
<pre tabindex="0"><code><span><span>var</span><span> isIE </span><span>=</span><span> false</span><span>;</span></span>
<span><span>var</span><span> req;</span></span>
<span><span>var</span><span> messageHash </span><span>=</span><span> -</span><span>1</span><span>;</span></span>
<span><span>var</span><span> targetId </span><span>=</span><span> -</span><span>1</span><span>;</span></span>
<span><span>var</span><span> centerCell;</span></span>
<span><span>var</span><span> size</span><span>=</span><span>40</span><span>;</span></span>
<span><span>var</span><span> increment </span><span>=</span><span> 100</span><span>/</span><span>size;</span></span>
<span><span>var</span><span> attempts</span><span>=</span><span>0</span><span>;</span></span>
<span></span>
<span><span>function</span><span> pollTaskmaster</span><span>() {</span></span>
<span><span>    attempts</span><span>++</span><span>;</span></span>
<span><span>    var</span><span> url </span><span>=</span><span> &#34;login-check.php?cid=248&amp;skey=3620efdb97b88d111e8ec5388244e978&#34;</span><span>; </span></span>
<span><span>    validate</span><span>(url);</span></span>
<span><span>}</span></span>
<span></span>
<span><span>function</span><span> validate</span><span>(</span><span>url</span><span>) {</span></span>
<span><span>    if</span><span> (window.XMLHttpRequest) {</span></span>
<span><span>        req </span><span>=</span><span> new</span><span> XMLHttpRequest</span><span>();</span></span>
<span><span>    } </span><span>else</span><span> if</span><span> (window.ActiveXObject) {</span></span>
<span><span>        isIE </span><span>=</span><span> true</span><span>;</span></span>
<span><span>        req </span><span>=</span><span> new</span><span> ActiveXObject</span><span>(</span><span>&#34;Microsoft.XMLHTTP&#34;</span><span>);</span></span>
<span><span>    }</span></span>
<span><span>    req.</span><span>open</span><span>(</span><span>&#34;GET&#34;</span><span>, url, </span><span>true</span><span>);</span></span>
<span><span>    req.onreadystatechange </span><span>=</span><span> processPollRequest;</span></span>
<span><span>    req.</span><span>send</span><span>(</span><span>null</span><span>);</span></span>
<span><span>}</span></span>
<span></span>
<span><span>function</span><span> processPollRequest</span><span>() {</span></span>
<span><span>    if</span><span> (req.readyState </span><span>==</span><span> 4</span><span>) {</span></span>
<span><span>        if</span><span> (req.status </span><span>==</span><span> 200</span><span>) {</span></span>
<span><span>            var</span><span> message </span><span>=</span><span> req.responseXML.</span><span>getElementsByTagName</span><span>(</span><span>&#34;message&#34;</span><span>)[</span><span>0</span><span>];</span></span>
<span><span>            if</span><span> (</span><span>!</span><span>message) {</span></span>
<span><span>              window.location.href</span><span>=</span><span>&#39;login.php?cid=248&amp;&#39;</span><span>;</span></span>
<span><span>              return</span><span>;</span></span>
<span><span>            }</span></span>
<span><span>            var</span><span> remotestatus </span><span>=</span><span> message.childNodes[</span><span>0</span><span>].nodeValue;</span></span>
<span><span>            if</span><span> (remotestatus </span><span>==</span><span> 1</span><span> )</span></span>
<span><span>               window.location.href</span><span>=</span><span>&#39;index.php?skey=3620efdb97b88d111e8ec5388244e978&amp;cid=248&amp;&#39;</span><span>;</span></span>
<span><span>            if</span><span> (remotestatus </span><span>==</span><span> -</span><span>1</span><span> )</span></span>
<span><span>               window.location.href</span><span>=</span><span>&#39;login.php?cid=248&amp;&#39;</span><span>;</span></span>
<span><span>        } </span><span>else</span><span> {</span></span>
<span><span>            window.status </span><span>=</span><span> &#34;No Update &#34;</span><span>;</span></span>
<span><span>        }</span></span>
<span><span>        window.status </span><span>=</span><span> &#34;Processing request...&#34;</span><span>;    </span></span>
<span><span>        setTimeout</span><span>(</span><span>&#34;pollTaskmaster()&#34;</span><span>, </span><span>5000</span><span>);</span></span>
<span><span>    }</span></span>
<span><span>}</span></span>
<span></span>
<span><span>function</span><span> gotobadpage</span><span>() {</span></span>
<span><span>  window.location.href</span><span>=</span><span>&#39;login.php?cid=248&amp;&#39;</span><span>;</span></span>
<span><span>}</span></span>
<span><span>setTimeout</span><span>(</span><span>&#34;pollTaskmaster()&#34;</span><span>, </span><span>2000</span><span>);</span></span>
<span><span>setTimeout</span><span>(</span><span>&#34;gotobadpage()&#34;</span><span>, </span><span>300000</span><span>);</span></span></code></pre>
<h2 id="winning-jumbohack">Winning JumboHack</h2>
<figure><img src="https://lamroger.com/_astro/watch.CBnkEgt0_1CLrb7.webp" alt="Our site is responsive...but not that responsive" width="1280" height="960" loading="lazy" decoding="async"/><figcaption>Our site is responsive...but not that responsive</figcaption></figure>
<p>With all the reverse-engineering out of the way, we had a lot of fun designing the actual product. We went for a vivid and bold design, similar to Spotify Wrapped. Given how much time we spent on everything else (and a solid 8 hours of sleep!), I think it turned out alright.</p>
<figure><img src="https://lamroger.com/_astro/screenshots.CFONoMTY_5THbR.webp" alt="The app&amp;#x27;s interface behaved like Instagram Stories" width="1494" height="939" loading="lazy" decoding="async"/><figcaption>The app&#39;s interface behaved like Instagram Stories</figcaption></figure>
<p>We put posters up around campus and, as Ben details in <a href="https://ben.page/wrapped">his post</a>, made a few anonymous posts on Sidechat pretending to be users. They went (relatively) viral, and because we’d conspicuously included the URL on every slide, hundreds of students flocked to try it for themselves.</p>
<p>Overall, JumboHack was a lot of fun! Taking the train down from Providence (<a href="https://www.mbta.com/fares/commuter-rail-weekends">for just 10 bucks!</a>), hanging out with Ben, and taking home some AirPods was a great way to spend my Presidents’ Day weekend.</p>
<figure><img src="https://lamroger.com/_astro/poster.BvqeRoay_Z2a08KS.webp" alt="A poster a few weeks later, photo courtesy of Ben" width="960" height="1280" loading="lazy" decoding="async"/><figcaption>A poster a few weeks later, photo courtesy of Ben</figcaption></figure> </article> </article></div>
  </body>
</html>
