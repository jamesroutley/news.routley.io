<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ThousandBirdsInc/chidori">Original</a>
    <h1>Chidori â€“ Declarative framework for AI agents (Rust, Python, and Node.js)</h1>
    
    <div id="readability-page-1" class="page"><div>
<td>
<div dir="auto" data-snippet-clipboard-copy-content="const axios = require(&#39;axios&#39;);
const {Chidori, GraphBuilder} = require(&#34;@1kbirds/chidori&#34;);

class Story {
    constructor(title, url, score) {
        this.title = title;
        this.url = url;
        this.score = score;
    }
}

const HN_URL_TOP_STORIES = &#34;https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty&#34;;

function fetchStory(id) {
    return axios.get(`https://hacker-news.firebaseio.com/v0/item/${id}.json?print=pretty`)
        .then(response =&gt; response.data);
}

function fetchHN() {
    return axios.get(HN_URL_TOP_STORIES)
        .then(response =&gt; {
            const storyIds = response.data;
            const tasks = storyIds.slice(0, 30).map(id =&gt; fetchStory(id));  // Limit to 30 stories
            return Promise.all(tasks)
                .then(stories =&gt; {
                    return stories.map(story =&gt; {
                        const { title, url, score } = story;
                        return new Story(title, url, score);
                    });
                });
        });
}

class ChidoriWorker {
    constructor() {
        this.c = new Chidori(&#34;0&#34;, &#34;http://localhost:9800&#34;);  // Assuming this is a connection object, replaced with an empty object for now
    }

    async buildGraph() {
        const g = new GraphBuilder();

        const h = g.customNode({
            name: &#34;FetchTopHN&#34;,
            nodeTypeName: &#34;FetchTopHN&#34;,
            output: &#34;type FetchTopHN { output: String }&#34;
        });

        const hInterpret = g.promptNode({
            name: &#34;InterpretTheGroup&#34;,
            template: `
                Based on the following list of HackerNews threads,
                filter this list to only launches of new AI projects: {{FetchTopHN.output}}
            `
        });
        hInterpret.runWhen(g, h);

        const hFormatAndRank = g.promptNode({
            name: &#34;FormatAndRank&#34;,
            template: `
                Format this list of new AI projects in markdown, ranking the most 
                interesting projects from most interesting to least. 
                
                {{InterpretTheGroup.promptResult}}
            `
        });
        hFormatAndRank.runWhen(g, hInterpret);

        await g.commit(this.c, 0)
    }

    async run() {
        // Construct the agent graph
        await this.buildGraph();

        // Start graph execution from the root
        // Implement the functionality of the play function
        await this.c.play(0, 0);

        // Run the node execution loop
        // Implement the functionality of the run_custom_node_loop function
        await this.c.runCustomNodeLoop()
    }
}


async function handleFetchHN(nodeWillExec, cb) {
    const stories = await fetchHN();
    // return JSON.stringify(stories);
    return cb({ &#34;output&#34;: JSON.stringify(stories) });
    // return ;
}

async function main() {
    let w = new ChidoriWorker();
    await w.c.startServer(&#34;:memory:&#34;)
    await w.c.registerCustomNodeHandle(&#34;FetchTopHN&#34;, handleFetchHN);
    await w.run()
}


main();
"><pre><span>const</span> <span>axios</span> <span>=</span> <span>require</span><span>(</span><span>&#39;axios&#39;</span><span>)</span><span>;</span>
<span>const</span> <span>{</span>Chidori<span>,</span> GraphBuilder<span>}</span> <span>=</span> <span>require</span><span>(</span><span>&#34;@1kbirds/chidori&#34;</span><span>)</span><span>;</span>

<span>class</span> <span>Story</span> <span>{</span>
    <span>constructor</span><span>(</span><span>title</span><span>,</span> <span>url</span><span>,</span> <span>score</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>title</span> <span>=</span> <span>title</span><span>;</span>
        <span>this</span><span>.</span><span>url</span> <span>=</span> <span>url</span><span>;</span>
        <span>this</span><span>.</span><span>score</span> <span>=</span> <span>score</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>const</span> <span>HN_URL_TOP_STORIES</span> <span>=</span> <span>&#34;https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty&#34;</span><span>;</span>

<span>function</span> <span>fetchStory</span><span>(</span><span>id</span><span>)</span> <span>{</span>
    <span>return</span> <span>axios</span><span>.</span><span>get</span><span>(</span><span>`https://hacker-news.firebaseio.com/v0/item/<span><span>${</span><span>id</span><span>}</span></span>.json?print=pretty`</span><span>)</span>
        <span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>response</span><span>.</span><span>data</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>fetchHN</span><span>(</span><span>)</span> <span>{</span>
    <span>return</span> <span>axios</span><span>.</span><span>get</span><span>(</span><span>HN_URL_TOP_STORIES</span><span>)</span>
        <span>.</span><span>then</span><span>(</span><span>response</span> <span>=&gt;</span> <span>{</span>
            <span>const</span> <span>storyIds</span> <span>=</span> <span>response</span><span>.</span><span>data</span><span>;</span>
            <span>const</span> <span>tasks</span> <span>=</span> <span>storyIds</span><span>.</span><span>slice</span><span>(</span><span>0</span><span>,</span> <span>30</span><span>)</span><span>.</span><span>map</span><span>(</span><span>id</span> <span>=&gt;</span> <span>fetchStory</span><span>(</span><span>id</span><span>)</span><span>)</span><span>;</span>  <span>// Limit to 30 stories</span>
            <span>return</span> <span>Promise</span><span>.</span><span>all</span><span>(</span><span>tasks</span><span>)</span>
                <span>.</span><span>then</span><span>(</span><span>stories</span> <span>=&gt;</span> <span>{</span>
                    <span>return</span> <span>stories</span><span>.</span><span>map</span><span>(</span><span>story</span> <span>=&gt;</span> <span>{</span>
                        <span>const</span> <span>{</span> title<span>,</span> url<span>,</span> score <span>}</span> <span>=</span> <span>story</span><span>;</span>
                        <span>return</span> <span>new</span> <span>Story</span><span>(</span><span>title</span><span>,</span> <span>url</span><span>,</span> <span>score</span><span>)</span><span>;</span>
                    <span>}</span><span>)</span><span>;</span>
                <span>}</span><span>)</span><span>;</span>
        <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>class</span> <span>ChidoriWorker</span> <span>{</span>
    <span>constructor</span><span>(</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>c</span> <span>=</span> <span>new</span> <span>Chidori</span><span>(</span><span>&#34;0&#34;</span><span>,</span> <span>&#34;http://localhost:9800&#34;</span><span>)</span><span>;</span>  <span>// Assuming this is a connection object, replaced with an empty object for now</span>
    <span>}</span>

    <span>async</span> <span>buildGraph</span><span>(</span><span>)</span> <span>{</span>
        <span>const</span> <span>g</span> <span>=</span> <span>new</span> <span>GraphBuilder</span><span>(</span><span>)</span><span>;</span>

        <span>const</span> <span>h</span> <span>=</span> <span>g</span><span>.</span><span>customNode</span><span>(</span><span>{</span>
            <span>name</span>: <span>&#34;FetchTopHN&#34;</span><span>,</span>
            <span>nodeTypeName</span>: <span>&#34;FetchTopHN&#34;</span><span>,</span>
            <span>output</span>: <span>&#34;type FetchTopHN { output: String }&#34;</span>
        <span>}</span><span>)</span><span>;</span>

        <span>const</span> <span>hInterpret</span> <span>=</span> <span>g</span><span>.</span><span>promptNode</span><span>(</span><span>{</span>
            <span>name</span>: <span>&#34;InterpretTheGroup&#34;</span><span>,</span>
            <span>template</span>: <span>`</span>
<span>                Based on the following list of HackerNews threads,</span>
<span>                filter this list to only launches of new AI projects: {{FetchTopHN.output}}</span>
<span>            `</span>
        <span>}</span><span>)</span><span>;</span>
        <span>hInterpret</span><span>.</span><span>runWhen</span><span>(</span><span>g</span><span>,</span> <span>h</span><span>)</span><span>;</span>

        <span>const</span> <span>hFormatAndRank</span> <span>=</span> <span>g</span><span>.</span><span>promptNode</span><span>(</span><span>{</span>
            <span>name</span>: <span>&#34;FormatAndRank&#34;</span><span>,</span>
            <span>template</span>: <span>`</span>
<span>                Format this list of new AI projects in markdown, ranking the most </span>
<span>                interesting projects from most interesting to least. </span>
<span>                </span>
<span>                {{InterpretTheGroup.promptResult}}</span>
<span>            `</span>
        <span>}</span><span>)</span><span>;</span>
        <span>hFormatAndRank</span><span>.</span><span>runWhen</span><span>(</span><span>g</span><span>,</span> <span>hInterpret</span><span>)</span><span>;</span>

        <span>await</span> <span>g</span><span>.</span><span>commit</span><span>(</span><span>this</span><span>.</span><span>c</span><span>,</span> <span>0</span><span>)</span>
    <span>}</span>

    <span>async</span> <span>run</span><span>(</span><span>)</span> <span>{</span>
        <span>// Construct the agent graph</span>
        <span>await</span> <span>this</span><span>.</span><span>buildGraph</span><span>(</span><span>)</span><span>;</span>

        <span>// Start graph execution from the root</span>
        <span>// Implement the functionality of the play function</span>
        <span>await</span> <span>this</span><span>.</span><span>c</span><span>.</span><span>play</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>)</span><span>;</span>

        <span>// Run the node execution loop</span>
        <span>// Implement the functionality of the run_custom_node_loop function</span>
        <span>await</span> <span>this</span><span>.</span><span>c</span><span>.</span><span>runCustomNodeLoop</span><span>(</span><span>)</span>
    <span>}</span>
<span>}</span>


<span>async</span> <span>function</span> <span>handleFetchHN</span><span>(</span><span>nodeWillExec</span><span>,</span> <span>cb</span><span>)</span> <span>{</span>
    <span>const</span> <span>stories</span> <span>=</span> <span>await</span> <span>fetchHN</span><span>(</span><span>)</span><span>;</span>
    <span>// return JSON.stringify(stories);</span>
    <span>return</span> <span>cb</span><span>(</span><span>{</span> <span>&#34;output&#34;</span>: <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>stories</span><span>)</span> <span>}</span><span>)</span><span>;</span>
    <span>// return ;</span>
<span>}</span>

<span>async</span> <span>function</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>let</span> <span>w</span> <span>=</span> <span>new</span> <span>ChidoriWorker</span><span>(</span><span>)</span><span>;</span>
    <span>await</span> <span>w</span><span>.</span><span>c</span><span>.</span><span>startServer</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span>
    <span>await</span> <span>w</span><span>.</span><span>c</span><span>.</span><span>registerCustomNodeHandle</span><span>(</span><span>&#34;FetchTopHN&#34;</span><span>,</span> <span>handleFetchHN</span><span>)</span><span>;</span>
    <span>await</span> <span>w</span><span>.</span><span>run</span><span>(</span><span>)</span>
<span>}</span>


<span>main</span><span>(</span><span>)</span><span>;</span></pre></div>
</td>
<td>
<div dir="auto" data-snippet-clipboard-copy-content="import aiohttp
import asyncio
from typing import List, Optional
import json
from chidori import Chidori, GraphBuilder


class Story:
    def __init__(self, title: str, url: Optional[str], score: Optional[float]):
        self.title = title
        self.url = url
        self.score = score


HN_URL_TOP_STORIES = &#34;https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty&#34;


async def fetch_story(session, id):
    async with session.get(f&#34;https://hacker-news.firebaseio.com/v0/item/{id}.json?print=pretty&#34;) as response:
        return await response.json()


async def fetch_hn() -&gt; List[Story]:
    async with aiohttp.ClientSession() as session:
        async with session.get(HN_URL_TOP_STORIES) as response:
            story_ids = await response.json()

        tasks = []
        for id in story_ids[:30]:  # Limit to 30 stories
            tasks.append(fetch_story(session, id))

        stories = await asyncio.gather(*tasks)

        stories_out = []
        for story in stories:
            for k in (&#39;title&#39;, &#39;url&#39;, &#39;score&#39;):
                stories_out.append(Story(**dict((k, story.get(k, None)))))

        return stories_out


# ^^^^^^^^^^^^^^^^^^^^^^^^^^^
# Methods for fetching hacker news posts via api

class ChidoriWorker:
    def __init__(self):
        self.c = Chidori(&#34;0&#34;, &#34;http://localhost:9800&#34;)
        self.staged_custom_nodes = []

    async def build_graph(self):
        g = GraphBuilder()

        # Create a custom node, we will implement our
        # own handler for this node type
        h = await g.custom_node(
            name=&#34;FetchTopHN&#34;,
            node_type_name=&#34;FetchTopHN&#34;,
            output=&#34;type O { output: String }&#34;
        )

        # A prompt node, pulling in the value of the output from FetchTopHN
        # and templating that into the prompt for GPT3.5
        h_interpret = await g.prompt_node(
            name=&#34;InterpretTheGroup&#34;,
            template=&#34;&#34;&#34;
                Based on the following list of HackerNews threads, 
                filter this list to only launches of new AI projects: {{FetchTopHN.output}}
            &#34;&#34;&#34;
        )
        await h_interpret.run_when(g, h)

        h_format_and_rank = await g.prompt_node(
            name=&#34;FormatAndRank&#34;,
            template=&#34;&#34;&#34;
                Format this list of new AI projects in markdown, ranking the most 
                interesting projects from most interesting to least. 
                
                {{InterpretTheGroup.promptResult}}
            &#34;&#34;&#34;
        )
        await h_format_and_rank.run_when(g, h_interpret)

        # Commit the graph, this pushes the configured graph
        # to our durable execution runtime.
        await g.commit(self.c, 0)

    async def run(self):
        # Construct the agent graph
        await self.build_graph()

        # Start graph execution from the root
        await self.c.play(0, 0)

        # Run the node execution loop
        await self.c.run_custom_node_loop()


async def handle_fetch_hn(node_will_exec):
    stories = await fetch_hn()
    result = {&#34;output&#34;: json.dumps([story.__dict__ for story in stories])}
    return result


async def main():
    w = ChidoriWorker()
    await w.c.start_server(&#34;:memory:&#34;)
    await w.c.register_custom_node_handle(&#34;FetchTopHN&#34;, handle_fetch_hn)
    await w.run()


if __name__ == &#34;__main__&#34;:
    asyncio.run(main())"><pre><span>import</span> <span>aiohttp</span>
<span>import</span> <span>asyncio</span>
<span>from</span> <span>typing</span> <span>import</span> <span>List</span>, <span>Optional</span>
<span>import</span> <span>json</span>
<span>from</span> <span>chidori</span> <span>import</span> <span>Chidori</span>, <span>GraphBuilder</span>


<span>class</span> <span>Story</span>:
    <span>def</span> <span>__init__</span>(<span>self</span>, <span>title</span>: <span>str</span>, <span>url</span>: <span>Optional</span>[<span>str</span>], <span>score</span>: <span>Optional</span>[<span>float</span>]):
        <span>self</span>.<span>title</span> <span>=</span> <span>title</span>
        <span>self</span>.<span>url</span> <span>=</span> <span>url</span>
        <span>self</span>.<span>score</span> <span>=</span> <span>score</span>


<span>HN_URL_TOP_STORIES</span> <span>=</span> <span>&#34;https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty&#34;</span>


<span>async</span> <span>def</span> <span>fetch_story</span>(<span>session</span>, <span>id</span>):
    <span>async</span> <span>with</span> <span>session</span>.<span>get</span>(<span>f&#34;https://hacker-news.firebaseio.com/v0/item/<span><span>{</span><span>id</span><span>}</span></span>.json?print=pretty&#34;</span>) <span>as</span> <span>response</span>:
        <span>return</span> <span>await</span> <span>response</span>.<span>json</span>()


<span>async</span> <span>def</span> <span>fetch_hn</span>() <span>-&gt;</span> <span>List</span>[<span>Story</span>]:
    <span>async</span> <span>with</span> <span>aiohttp</span>.<span>ClientSession</span>() <span>as</span> <span>session</span>:
        <span>async</span> <span>with</span> <span>session</span>.<span>get</span>(<span>HN_URL_TOP_STORIES</span>) <span>as</span> <span>response</span>:
            <span>story_ids</span> <span>=</span> <span>await</span> <span>response</span>.<span>json</span>()

        <span>tasks</span> <span>=</span> []
        <span>for</span> <span>id</span> <span>in</span> <span>story_ids</span>[:<span>30</span>]:  <span># Limit to 30 stories</span>
            <span>tasks</span>.<span>append</span>(<span>fetch_story</span>(<span>session</span>, <span>id</span>))

        <span>stories</span> <span>=</span> <span>await</span> <span>asyncio</span>.<span>gather</span>(<span>*</span><span>tasks</span>)

        <span>stories_out</span> <span>=</span> []
        <span>for</span> <span>story</span> <span>in</span> <span>stories</span>:
            <span>for</span> <span>k</span> <span>in</span> (<span>&#39;title&#39;</span>, <span>&#39;url&#39;</span>, <span>&#39;score&#39;</span>):
                <span>stories_out</span>.<span>append</span>(<span>Story</span>(<span>**</span><span>dict</span>((<span>k</span>, <span>story</span>.<span>get</span>(<span>k</span>, <span>None</span>)))))

        <span>return</span> <span>stories_out</span>


<span># ^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span># Methods for fetching hacker news posts via api</span>

<span>class</span> <span>ChidoriWorker</span>:
    <span>def</span> <span>__init__</span>(<span>self</span>):
        <span>self</span>.<span>c</span> <span>=</span> <span>Chidori</span>(<span>&#34;0&#34;</span>, <span>&#34;http://localhost:9800&#34;</span>)
        <span>self</span>.<span>staged_custom_nodes</span> <span>=</span> []

    <span>async</span> <span>def</span> <span>build_graph</span>(<span>self</span>):
        <span>g</span> <span>=</span> <span>GraphBuilder</span>()

        <span># Create a custom node, we will implement our</span>
        <span># own handler for this node type</span>
        <span>h</span> <span>=</span> <span>await</span> <span>g</span>.<span>custom_node</span>(
            <span>name</span><span>=</span><span>&#34;FetchTopHN&#34;</span>,
            <span>node_type_name</span><span>=</span><span>&#34;FetchTopHN&#34;</span>,
            <span>output</span><span>=</span><span>&#34;type O { output: String }&#34;</span>
        )

        <span># A prompt node, pulling in the value of the output from FetchTopHN</span>
        <span># and templating that into the prompt for GPT3.5</span>
        <span>h_interpret</span> <span>=</span> <span>await</span> <span>g</span>.<span>prompt_node</span>(
            <span>name</span><span>=</span><span>&#34;InterpretTheGroup&#34;</span>,
            <span>template</span><span>=</span><span>&#34;&#34;&#34;</span>
<span>                Based on the following list of HackerNews threads, </span>
<span>                filter this list to only launches of new AI projects: {{FetchTopHN.output}}</span>
<span>            &#34;&#34;&#34;</span>
        )
        <span>await</span> <span>h_interpret</span>.<span>run_when</span>(<span>g</span>, <span>h</span>)

        <span>h_format_and_rank</span> <span>=</span> <span>await</span> <span>g</span>.<span>prompt_node</span>(
            <span>name</span><span>=</span><span>&#34;FormatAndRank&#34;</span>,
            <span>template</span><span>=</span><span>&#34;&#34;&#34;</span>
<span>                Format this list of new AI projects in markdown, ranking the most </span>
<span>                interesting projects from most interesting to least. </span>
<span>                </span>
<span>                {{InterpretTheGroup.promptResult}}</span>
<span>            &#34;&#34;&#34;</span>
        )
        <span>await</span> <span>h_format_and_rank</span>.<span>run_when</span>(<span>g</span>, <span>h_interpret</span>)

        <span># Commit the graph, this pushes the configured graph</span>
        <span># to our durable execution runtime.</span>
        <span>await</span> <span>g</span>.<span>commit</span>(<span>self</span>.<span>c</span>, <span>0</span>)

    <span>async</span> <span>def</span> <span>run</span>(<span>self</span>):
        <span># Construct the agent graph</span>
        <span>await</span> <span>self</span>.<span>build_graph</span>()

        <span># Start graph execution from the root</span>
        <span>await</span> <span>self</span>.<span>c</span>.<span>play</span>(<span>0</span>, <span>0</span>)

        <span># Run the node execution loop</span>
        <span>await</span> <span>self</span>.<span>c</span>.<span>run_custom_node_loop</span>()


<span>async</span> <span>def</span> <span>handle_fetch_hn</span>(<span>node_will_exec</span>):
    <span>stories</span> <span>=</span> <span>await</span> <span>fetch_hn</span>()
    <span>result</span> <span>=</span> {<span>&#34;output&#34;</span>: <span>json</span>.<span>dumps</span>([<span>story</span>.<span>__dict__</span> <span>for</span> <span>story</span> <span>in</span> <span>stories</span>])}
    <span>return</span> <span>result</span>


<span>async</span> <span>def</span> <span>main</span>():
    <span>w</span> <span>=</span> <span>ChidoriWorker</span>()
    <span>await</span> <span>w</span>.<span>c</span>.<span>start_server</span>(<span>&#34;:memory:&#34;</span>)
    <span>await</span> <span>w</span>.<span>c</span>.<span>register_custom_node_handle</span>(<span>&#34;FetchTopHN&#34;</span>, <span>handle_fetch_hn</span>)
    <span>await</span> <span>w</span>.<span>run</span>()


<span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span>:
    <span>asyncio</span>.<span>run</span>(<span>main</span>())</pre></div>
</td>
<td>
<div dir="auto" data-snippet-clipboard-copy-content="extern crate chidori;
use std::collections::HashMap;
use std::env;
use std::net::ToSocketAddrs;
use anyhow;
use futures::stream::{self, StreamExt, TryStreamExt};
use reqwest;
use serde::{Deserialize, Serialize};
use serde_json::json;
use chidori::{create_change_value, NodeWillExecuteOnBranch};
use chidori::register_node_handle;
use chidori::translations::rust::{Chidori, CustomNodeCreateOpts, DenoCodeNodeCreateOpts, GraphBuilder, Handler, PromptNodeCreateOpts, serialized_value_to_string};

#[derive(Debug, Deserialize, Serialize)]
struct Story {
    title: String,
    url: Option&lt;String&gt;,
    score: Option&lt;f32&gt;,
}

const HN_URL_TOP_STORIES: &amp;&#39;static str = &#34;https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty&#34;;

async fn fetch_hn() -&gt; anyhow::Result&lt;Vec&lt;Story&gt;&gt; {
    let client = reqwest::Client::new();
    // Fetch the top 60 story ids
    let story_ids: Vec&lt;u32&gt; = client.get(HN_URL_TOP_STORIES).send().await?.json().await?;

    // Fetch details for each story
    let stories: anyhow::Result&lt;Vec&lt;Story&gt;&gt; = stream::iter(story_ids.into_iter().take(30))
        .map(|id| {
            let client = &amp;client;
            async move {
                let resource = format!(&#34;https://hacker-news.firebaseio.com/v0/item/{}.json?print=pretty&#34;, id);
                let mut story: Story = client.get(&amp;resource).send().await?.json().await?;
                Ok(story)
            }
        })
        .buffer_unordered(10)  // Fetch up to 10 stories concurrently
        .try_collect()
        .await;
    stories
}

async fn handle_fetch_hn(_node_will_exec: NodeWillExecuteOnBranch) -&gt; anyhow::Result&lt;serde_json::Value&gt; {
    let stories = fetch_hn().await.unwrap();
    let mut result = HashMap::new();
    result.insert(&#34;output&#34;, format!(&#34;{:?}&#34;, stories));
    Ok(serde_json::to_value(result).unwrap())
}

/// Maintain a list summarizing recent AI launches across the week
#[tokio::main]
async fn main() -&gt; anyhow::Result&lt;()&gt; {
    let mut c = Chidori::new(String::from(&#34;0&#34;), String::from(&#34;http://localhost:9800&#34;));
    c.start_server(Some(&#34;:memory:&#34;.to_string())).await?;

    let mut g = GraphBuilder::new();

    let h = g.custom_node(CustomNodeCreateOpts {
        name: &#34;FetchTopHN&#34;.to_string(),
        node_type_name: &#34;FetchTopHN&#34;.to_string(),
        output: Some(&#34;type O { output: String }&#34;.to_string()),
        ..CustomNodeCreateOpts::default()
    })?;

    let mut h_interpret = g.prompt_node(PromptNodeCreateOpts {
        name: &#34;InterpretTheGroup&#34;.to_string(),
        template: &#34;Based on the following list of HackerNews threads, filter this list to only launches of new AI projects: {{FetchTopHN.output}}&#34;.to_string(),
        ..PromptNodeCreateOpts::default()
    })?;
    h_interpret.run_when(&amp;mut g, &amp;h)?;

    let mut h_format_and_rank = g.prompt_node(PromptNodeCreateOpts {
        name: &#34;FormatAndRank&#34;.to_string(),
        template: &#34;Format this list of new AI projects in markdown, ranking the most interesting projects from most interesting to least. {{InterpretTheGroup.promptResult}}&#34;.to_string(),
        ..PromptNodeCreateOpts::default()
    })?;
    h_format_and_rank.run_when(&amp;mut g, &amp;h_interpret)?;

    // Commit the graph
    g.commit(&amp;c, 0).await?;

    // Start graph execution from the root
    c.play(0, 0).await?;

    // Register the handler for our custom node
    register_node_handle!(c, &#34;FetchTopHN&#34;, handle_fetch_hn);

    // Run the node execution loop
    if let Err(x) = c.run_custom_node_loop().await {
        eprintln!(&#34;Custom Node Loop Failed On - {:?}&#34;, x);
    };
    Ok(())
}"><pre><span>extern</span> <span>crate</span> chidori<span>;</span>
<span>use</span> std<span>::</span>collections<span>::</span><span>HashMap</span><span>;</span>
<span>use</span> std<span>::</span>env<span>;</span>
<span>use</span> std<span>::</span>net<span>::</span><span>ToSocketAddrs</span><span>;</span>
<span>use</span> anyhow<span>;</span>
<span>use</span> futures<span>::</span>stream<span>::</span><span>{</span><span>self</span><span>,</span> <span>StreamExt</span><span>,</span> <span>TryStreamExt</span><span>}</span><span>;</span>
<span>use</span> reqwest<span>;</span>
<span>use</span> serde<span>::</span><span>{</span><span>Deserialize</span><span>,</span> <span>Serialize</span><span>}</span><span>;</span>
<span>use</span> serde_json<span>::</span>json<span>;</span>
<span>use</span> chidori<span>::</span><span>{</span>create_change_value<span>,</span> <span>NodeWillExecuteOnBranch</span><span>}</span><span>;</span>
<span>use</span> chidori<span>::</span>register_node_handle<span>;</span>
<span>use</span> chidori<span>::</span>translations<span>::</span>rust<span>::</span><span>{</span><span>Chidori</span><span>,</span> <span>CustomNodeCreateOpts</span><span>,</span> <span>DenoCodeNodeCreateOpts</span><span>,</span> <span>GraphBuilder</span><span>,</span> <span>Handler</span><span>,</span> <span>PromptNodeCreateOpts</span><span>,</span> serialized_value_to_string<span>}</span><span>;</span>

<span>#<span>[</span>derive<span>(</span><span>Debug</span><span>,</span> <span>Deserialize</span><span>,</span> <span>Serialize</span><span>)</span><span>]</span></span>
<span>struct</span> <span>Story</span> <span>{</span>
    <span>title</span><span>:</span> <span>String</span><span>,</span>
    <span>url</span><span>:</span> <span>Option</span><span>&lt;</span><span>String</span><span>&gt;</span><span>,</span>
    <span>score</span><span>:</span> <span>Option</span><span>&lt;</span><span>f32</span><span>&gt;</span><span>,</span>
<span>}</span>

<span>const</span> <span>HN_URL_TOP_STORIES</span><span>:</span> <span>&amp;</span><span>&#39;</span><span>static</span> <span>str</span> = <span>&#34;https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty&#34;</span><span>;</span>

<span>async</span> <span>fn</span> <span>fetch_hn</span><span>(</span><span>)</span> -&gt; anyhow<span>::</span><span>Result</span><span>&lt;</span><span>Vec</span><span>&lt;</span><span>Story</span><span>&gt;</span><span>&gt;</span> <span>{</span>
    <span>let</span> client = reqwest<span>::</span><span>Client</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    <span>// Fetch the top 60 story ids</span>
    <span>let</span> story_ids<span>:</span> <span>Vec</span><span>&lt;</span><span>u32</span><span>&gt;</span> = client<span>.</span><span>get</span><span>(</span><span>HN_URL_TOP_STORIES</span><span>)</span><span>.</span><span>send</span><span>(</span><span>)</span><span>.</span><span>await</span>?<span>.</span><span>json</span><span>(</span><span>)</span><span>.</span><span>await</span>?<span>;</span>

    <span>// Fetch details for each story</span>
    <span>let</span> stories<span>:</span> anyhow<span>::</span><span>Result</span><span>&lt;</span><span>Vec</span><span>&lt;</span><span>Story</span><span>&gt;</span><span>&gt;</span> = stream<span>::</span><span>iter</span><span>(</span>story_ids<span>.</span><span>into_iter</span><span>(</span><span>)</span><span>.</span><span>take</span><span>(</span><span>30</span><span>)</span><span>)</span>
        <span>.</span><span>map</span><span>(</span>|id| <span>{</span>
            <span>let</span> client = <span>&amp;</span>client<span>;</span>
            <span>async</span> <span>move</span> <span>{</span>
                <span>let</span> resource = <span>format</span><span>!</span><span>(</span><span>&#34;https://hacker-news.firebaseio.com/v0/item/{}.json?print=pretty&#34;</span>, id<span>)</span><span>;</span>
                <span>let</span> <span>mut</span> story<span>:</span> <span>Story</span> = client<span>.</span><span>get</span><span>(</span><span>&amp;</span>resource<span>)</span><span>.</span><span>send</span><span>(</span><span>)</span><span>.</span><span>await</span>?<span>.</span><span>json</span><span>(</span><span>)</span><span>.</span><span>await</span>?<span>;</span>
                <span>Ok</span><span>(</span>story<span>)</span>
            <span>}</span>
        <span>}</span><span>)</span>
        <span>.</span><span>buffer_unordered</span><span>(</span><span>10</span><span>)</span>  <span>// Fetch up to 10 stories concurrently</span>
        <span>.</span><span>try_collect</span><span>(</span><span>)</span>
        <span>.</span><span>await</span><span>;</span>
    stories
<span>}</span>

<span>async</span> <span>fn</span> <span>handle_fetch_hn</span><span>(</span><span>_node_will_exec</span><span>:</span> <span>NodeWillExecuteOnBranch</span><span>)</span> -&gt; anyhow<span>::</span><span>Result</span><span>&lt;</span>serde_json<span>::</span><span>Value</span><span>&gt;</span> <span>{</span>
    <span>let</span> stories = <span>fetch_hn</span><span>(</span><span>)</span><span>.</span><span>await</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>let</span> <span>mut</span> result = <span>HashMap</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>
    result<span>.</span><span>insert</span><span>(</span><span>&#34;output&#34;</span><span>,</span> <span>format</span><span>!</span><span>(</span><span>&#34;{:?}&#34;</span>, stories<span>)</span><span>)</span><span>;</span>
    <span>Ok</span><span>(</span>serde_json<span>::</span><span>to_value</span><span>(</span>result<span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>)</span>
<span>}</span>

<span>/// Maintain a list summarizing recent AI launches across the week</span>
<span>#<span>[</span>tokio<span>::</span>main<span>]</span></span>
<span>async</span> <span>fn</span> <span>main</span><span>(</span><span>)</span> -&gt; anyhow<span>::</span><span>Result</span><span>&lt;</span><span>(</span><span>)</span><span>&gt;</span> <span>{</span>
    <span>let</span> <span>mut</span> c = <span>Chidori</span><span>::</span><span>new</span><span>(</span><span>String</span><span>::</span><span>from</span><span>(</span><span>&#34;0&#34;</span><span>)</span><span>,</span> <span>String</span><span>::</span><span>from</span><span>(</span><span>&#34;http://localhost:9800&#34;</span><span>)</span><span>)</span><span>;</span>
    c<span>.</span><span>start_server</span><span>(</span><span>Some</span><span>(</span><span>&#34;:memory:&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>)</span><span>)</span><span>.</span><span>await</span>?<span>;</span>

    <span>let</span> <span>mut</span> g = <span>GraphBuilder</span><span>::</span><span>new</span><span>(</span><span>)</span><span>;</span>

    <span>let</span> h = g<span>.</span><span>custom_node</span><span>(</span><span>CustomNodeCreateOpts</span> <span>{</span>
        <span>name</span><span>:</span> <span>&#34;FetchTopHN&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span>
        <span>node_type_name</span><span>:</span> <span>&#34;FetchTopHN&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span>
        <span>output</span><span>:</span> <span>Some</span><span>(</span><span>&#34;type O { output: String }&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>)</span><span>,</span>
        ..<span>CustomNodeCreateOpts</span><span>::</span><span>default</span><span>(</span><span>)</span>
    <span>}</span><span>)</span>?<span>;</span>

    <span>let</span> <span>mut</span> h_interpret = g<span>.</span><span>prompt_node</span><span>(</span><span>PromptNodeCreateOpts</span> <span>{</span>
        <span>name</span><span>:</span> <span>&#34;InterpretTheGroup&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span>
        <span>template</span><span>:</span> <span>&#34;Based on the following list of HackerNews threads, filter this list to only launches of new AI projects: {{FetchTopHN.output}}&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span>
        ..<span>PromptNodeCreateOpts</span><span>::</span><span>default</span><span>(</span><span>)</span>
    <span>}</span><span>)</span>?<span>;</span>
    h_interpret<span>.</span><span>run_when</span><span>(</span><span>&amp;</span><span>mut</span> g<span>,</span> <span>&amp;</span>h<span>)</span>?<span>;</span>

    <span>let</span> <span>mut</span> h_format_and_rank = g<span>.</span><span>prompt_node</span><span>(</span><span>PromptNodeCreateOpts</span> <span>{</span>
        <span>name</span><span>:</span> <span>&#34;FormatAndRank&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span>
        <span>template</span><span>:</span> <span>&#34;Format this list of new AI projects in markdown, ranking the most interesting projects from most interesting to least. {{InterpretTheGroup.promptResult}}&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span>
        ..<span>PromptNodeCreateOpts</span><span>::</span><span>default</span><span>(</span><span>)</span>
    <span>}</span><span>)</span>?<span>;</span>
    h_format_and_rank<span>.</span><span>run_when</span><span>(</span><span>&amp;</span><span>mut</span> g<span>,</span> <span>&amp;</span>h_interpret<span>)</span>?<span>;</span>

    <span>// Commit the graph</span>
    g<span>.</span><span>commit</span><span>(</span><span>&amp;</span>c<span>,</span> <span>0</span><span>)</span><span>.</span><span>await</span>?<span>;</span>

    <span>// Start graph execution from the root</span>
    c<span>.</span><span>play</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>)</span><span>.</span><span>await</span>?<span>;</span>

    <span>// Register the handler for our custom node</span>
    <span>register_node_handle</span><span>!</span><span>(</span>c, <span>&#34;FetchTopHN&#34;</span>, handle_fetch_hn<span>)</span><span>;</span>

    <span>// Run the node execution loop</span>
    <span>if</span> <span>let</span> <span>Err</span><span>(</span>x<span>)</span> = c<span>.</span><span>run_custom_node_loop</span><span>(</span><span>)</span><span>.</span><span>await</span> <span>{</span>
        <span>eprintln</span><span>!</span><span>(</span><span>&#34;Custom Node Loop Failed On - {:?}&#34;</span>, x<span>)</span><span>;</span>
    <span>}</span><span>;</span>
    <span>Ok</span><span>(</span><span>(</span><span>)</span><span>)</span>
<span>}</span></pre></div>
</td>
</div></div>
  </body>
</html>
