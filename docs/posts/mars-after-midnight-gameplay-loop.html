<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dukope.itch.io/mars-after-midnight/devlog/495856/gameplay-loop">Original</a>
    <h1>Mars After Midnight: Gameplay Loop</h1>
    
    <div id="readability-page-1" class="page"><div><section id="object_text_widget_4744501"><p>I just finished a vertical slice of the game and it looks like this:</p>
<ol>
<li>Work the door to admit martians matching some criteria.</li>
<li>Everyone makes a huge mess of the FREE refreshments, which you have to clean up. </li>
<li>Repeat 1 &amp; 2 a bunch of times until you have enough martians.</li>
<li>Choose the next day&#39;s event, where to promote it, and which refreshments to serve.</li>
<li>Repeat from 1.</li>
</ol>
<p>Everything here is alpha level at best, which means I expect some or all of it to change before final. Still, there was a sale on gifs so let&#39;s not waste the opportunity.</p>


<p>There&#39;s a knock on the door. Flip the crank up to lift the window and have a look. Press the A button to open the whole door and admit the entrant or close the window to reject them.</p>

<p>Panning around with the D-PAD reveals more of the face, and some satisfying parallax.</p>

<p>I experimented with using the Playdate&#39;s accelerometer to control looking around but,</p>
<ol>
<li>The accelerometer is oriented for holding the device flat on its back. You&#39;re looking through a vertical window here so the metaphor doesn&#39;t hold. There&#39;s a missing axis that precludes vertically-oriented readings.</li>
<li>The screen, while beautiful, is fairly sensitive to viewing angle when it comes to illumination. Tilting it around means the brightness is constantly shifting. It&#39;s not a typical viewing angle problem, more of a frontlighting-is-best-from-this-one-angle thing.</li>
<li>I prefer the explicit control of a D-PAD over wobbly gyro controls.</li>
</ol>
<p>The 3D effect on the window panel is done by pre-scaling the 2D texture in wide strips and drawing the right ones based on some perspective 1/z calculations. Rough but good enough.</p>

<p>This window action was my original wafer-thin concept for using the Playdate&#39;s crank in a novel way. I threw together the game code and procedural martian generation pretty quickly almost two years (!) ago. Flipping the window open and seeing some random martian is fun. Sometimes even funny. Job done on this part. </p>
<p>Unfortunately the wafer was too thin here. One of those &#34;great where&#39;s the rest&#34; concepts that I didn&#39;t feel the true shallowness of until it was implemented. Working the door at night on Mars is a cool idea but for what? A bar? Gym? Casino? Store? Hairdresser? And once they&#39;re inside, then what? Something cool? Nothing? Maybe more happens at the window? Can you shoot things? I rarely do combat so probably not. The martian faces are procedurally generated, if there&#39;s more gaming beyond the window, how far beyond the face do I need to go? Not far please.</p>
<p>Anyways, some potential but still a lot missing. As part of my strategy to just keep trucking on random shit until an idea comes to me, I put together an exterior scene of the bar/gym/restaurant/whatever. </p>

<p>To inform the player of their current bouncer rules, I made a big sign and filled it with text.</p>

<p>&#34;Cyclops Anger Management&#34; sounded good and that was enough to establish that this would be screening for community support sessions -- therapy in this case. I figured there were a lot of ways to make visually interesting criteria to match different kinds of help sessions. Ok, so it&#39;s not a bar or a casino, it&#39;s a community support center.</p>

<p>At the bottom of the sign, I added &#34;Refreshments Provided&#34; to really pack the place. Who can resist free refreshments? This phrase somehow unfurled in my mind and grew to define the game&#39;s core mechanic. What if refreshments are actually provided? What would an angry cyclops on Mars eat, and how?</p>



<p>Martians are slobs and they love their dune bug pie. You let &#39;em in, they see your nicely prepared spread of delicious refreshments, and they desecrate it. If the food suits them, they&#39;ll toss you a few credits.</p>

<p>Each visitor expects a spotless table, so you&#39;ll need to clean it up afterwards to prepare for the next one.</p>

<p>To clean the table, the game uses a relatively simple stack manipulation mechanic with the slight novelty that you can lift two stacks at once but the left and right hands/tentacles move together. The D-PAD adjusts the position, the B button lifts/drops with the left tentacle, and the A button lifts/drops with the right tentacle. These controls take some getting used to.</p>

<p>There are a few basic stacking rules like plates must be aligned, and narrower items can&#39;t support wider ones, but we&#39;re not quite Tower Of Hanoi here. Each mess only takes a few seconds to clean up.</p>
<p>To remind you this is a Playdate game, there&#39;s also a crank-controlled table sweeper to suck up the crumbs. All the items on the table have to be lifted at once to get a full sweep.</p>

<p>Implementing this table cleaning part was mostly straightforward, with a handful of edge cases. Design-wise it&#39;s just stacking stuff so there aren&#39;t especially complex mechanics that need to be carefully explained or aligned with player expectations. Still:</p>
<ul>
<li>The tentacles move in discrete steps, which feels a little odd at first but this isn&#39;t a full physics simulation so I think it&#39;s ok.</li>
<li>It&#39;s not always perfectly clear which item you&#39;ll pick up with A/B -- there&#39;s no highlight, plate stacks are pretty tight vertically, and the tentacles are wiggly. It&#39;s not hard to get used to but I may address this later. </li>
</ul>
<p>Also, I was a little stuck on how to illustrate the &#34;clean&#34; state that you need to restore the table to, and ended up with two imperfect ways:</p>

<p>The table has marks to indicate where items should be placed: open circle for plates, closed circle for pie, triangle for knife, square for note. Never explained in-game, not great.</p>

<p>A thought bubble that appears after idling for a few seconds to show the proper arrangement. Also not great. I should probably just stick a note on the back wall instead.</p>
<p>Things were a little trickier with performance. I&#39;ve got more about this below but the brief version here is that some of the drawing functions were written in C (most of the game is in Lua) in order to maintain 30fps.</p>


<p>After admitting enough martians, feeding them, and cleaning up their mess, the help session fills up and kicks off. Since you&#39;re not a licensed therapist whatever happens in the meeting room is out of sight. Someone else handles that I guess.</p>

<p>When the session finishes, you can see the results. First, martians that were helped by the topic will pay out a bonus. A happy two-eyed martian won&#39;t get much out of &#34;Cyclops Anger Management&#34; for instance, so it&#39;s important to admit the right ones from the start.</p>

<p>Next, your progress is shown in the context of the entire settlement.</p>




<p>At this point you need to lay out the plan for tomorrow. Choose the topic, where to promote the session, and which food to serve. Each choice is made against a map of the settlement, showing martians that need help.</p>
<p><strong>1 // Session Topic</strong></p>

<p>Most topics are free to host but a few require paid accessories. I haven&#39;t worked out the exact details for all the sessions and accessories. One example is a &#34;Night Glowers&#34; topic, which requires installing a switch to cut the lights and check if the martians are appropriately glowing or not.</p>

<p>Accessories are activated with the B button while working the door, and are only available if the session requires it. Theoretically. I haven&#39;t implemented any yet.</p>
<p><strong>2 // Regional Promotion</strong></p>

<p>After selecting a topic, you&#39;ll need to promote it in the areas where affected martians live. The settlement on Mars is split into large districts, where the price of advertising varies slightly. Failing to promote in a district that contains your target group means they won&#39;t know about the session and won&#39;t show up tomorrow.</p>
<p><strong>3 // Refreshments</strong></p>

<p>And finally, you need to order the refreshments. Some foods are more popular than others in certain areas. Different foods need to be handled and cleaned in slightly different ways. Soup, for example, may spill if moved too quickly. Martians will pay higher refreshment bonuses for foods they like.</p>
<p><strong>4 // Checkout</strong></p>
<p>Once the planning is done, you pay and the day ends.</p>

<p>If working the door was the catchy-but-shallow concept to get this project going, and cleaning the table was adding meat to the core loop, this planning phase is intended to tie everything together into a complete game with high-level goals, narrative, and gradual progress. Maybe it&#39;ll work.</p>
<p>I had a hell of a time designing the presentation and flow for this planning phase. Even now it&#39;s probably not final. The combination of unfamiliar task, small screen size, long text list navigation, and map display is all a bit much. Tilting the map back in 3D gave me enough space to show a list below, and I tried to whittle the displayed information down to the minimum. Part of me thinks I&#39;m still trying to do too much here.</p>


<p>Coding this game in Lua has been an experience. This is the first time I&#39;ve used Lua and I can&#39;t say I&#39;m a huge fan. It has some nice stuff like php-style do-everything collections, first-class functions, and... well I&#39;m struggling to finish a triumvirate here but I guess I can say that the 1-indexing isn&#39;t <strong>that</strong> bad. Wait no, I remember a proper third: <em>coroutines</em> are great and enable a kind of concurrent programming that can work well to replace state machines and other finicky patterns.</p>
<p>I could get along better with Lua if it was just a little more performant. I really miss things like true consts, macros, inlines, and other basic performance-focused features. Overall it feels very much like a good scripting extension for a core compiled system and using it to build an entire game, even at the relatively high level I&#39;m working at, is beyond the spec.</p>
<p>A few other complaints:</p>
<ul>
<li>Lua documentation is weird. The official docs are written like a wordy book with chapters and stuff and I still haven&#39;t found a clear, clinical, versioned language+API reference for the thing.</li>
<li>Features that are convenient are often slow, or have poorly-defined performance. Iterating a table, for instance, can be done in multiple ways and the easy Lua way is almost always slower.</li>
<li>I use Visual Studio Code for everything and the Lua step-debugging doesn&#39;t work right for me. Back to print() debugging.</li>
<li>The usual problems with dynamic languages: no static type-checking, no compiler to catch basic errors, plus an extra dash of wonky/expensive error handling.</li>
</ul>
<p>Luckily, the Playdate SDK also includes robust C support. If something&#39;s too slow in Lua, it&#39;s relatively straightforward to move that logic to C. A few of the things I&#39;m doing in C:</p>
<p><strong>// Line-drawing</strong></p>
<p>The Playdate API has built-in line-drawing support but since I&#39;m filling the screen with lines in some cases, I wrote my own slightly faster functions in C. This is used for the wiggly fonts and pictograms everywhere.</p>
<p><strong>// Bezier spline code</strong></p>
<p>The tentacles use some auto-tangent calculation code I&#39;ve dragged around with me over the years and this is the exact kind of thing you don&#39;t want to do in Lua.</p>
<p><strong>// Optimized image drawing</strong></p>
<p>1-bit is nice for saving memory but a huge pain in the ass for image manipulation. Every pixel write to a buffer also requires a read, so there&#39;s a much higher cost to even simple draw operations. Calculating bit offsets can be painful too. Playdate already has great image drawing functions but I added a few optimized ones for my specific use cases.</p>
<ul>
<li>Pre-shifted image plotting. This works like the old ZX Spectrum trick of saving 8 pre-shifted copies of each image so it can be pasted quickly at the byte-level instead of the bit-level. Trading memory for speed.</li>
<li>Sweeper rendering. Drawing the table sweeper requires enough math, lines, and fills that just porting the logic to C is much, much faster.</li>
<li>Tentacle rendering. This uses the bezier code and pre-shifted filled-circle images to get the tentacles drawing at a decent speed.</li>
<li>Shadow rendering. The tabletop shadows are specific enough -- spaced horizontal black lines -- that custom drawing functions in C gave me a few frame speedup on hardware.</li>
</ul>
<p><strong>// Silhouette rendering</strong></p>
<p>When working with the Playdate hardware, an early surprise was trying to scale/rotate/transform images in realtime. Basically, you can&#39;t -- it&#39;s too slow. In almost every case it&#39;s better to precompute the transformed image offline or during loads.</p>
<p>When admitting a martian, I really wanted them to enter the room, walking in from outside. To save me from having to make more art, this is shown from the back, in silhouette. The scene is drawn with depth so they need to start large and shrink while walking into the screen.</p>

<p>Doing this the naive way, by drawing the images scaled and rotated is either a slide show or requires gobs of pre-compute time and memory. My solution was to divide the silhouette into 8x8 patches and rotate/scale the position of each patch instead of each pixel. I call it a <em>tarp</em> and it works ok.</p>

<p>Rotating too much will expose seams and scaling down too much looks pretty rough. Overlapping the patches slightly and keeping the scale within safe ranges gives a nice organic look that&#39;s even better imo than proper transformations in this narrow case.</p>


<p>At this point I need to deal with some long-pending maintenance for <em>Papers, Please</em> and <em>Obra Dinn</em>. Once that&#39;s handled I&#39;ll get back on this to fill out all the session topics, accessories, and foods -- only one topic and one food is currently implemented. I estimate at least a few months of work and my estimates are always a joke.</p></section></div></div>
  </body>
</html>
