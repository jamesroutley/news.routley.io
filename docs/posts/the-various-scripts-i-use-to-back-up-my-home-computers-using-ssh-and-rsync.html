<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/eamonnsullivan/backup-scripts">Original</a>
    <h1>The various scripts I use to back up my home computers using SSH and rsync</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">These are my current scripts for backing up three laptops around the house to a desktop PC. It is also a small experiment in using <a href="https://github.com/babashka/babashka">babashka</a>, a scripting flavour of the Clojure language.</p>
<p dir="auto">I had never used babaskha, so this is very unlikely to be a good example for anyone else. For much better information and examples, see babashka&#39;s <a href="https://book.babashka.org/#introduction" rel="nofollow">online book</a>.</p>
<h2 dir="auto"><a id="user-content-main-goals-and-outcomes" aria-hidden="true" href="#main-goals-and-outcomes"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Main goals and outcomes</h2>
<p dir="auto">The main reason I was revisiting my home backup scripts it that we&#39;ve transitioned over the years from a household of two or three standard PCs, to one with three laptops.</p>
<p dir="auto">I used to mirror my family&#39;s home directories to an external drive. I used Time Machine on the Mac and <a href="http://manpages.ubuntu.com/manpages/focal/en/man3/cron.3tcl.html" rel="nofollow">cron</a> and <a href="http://manpages.ubuntu.com/manpages/focal/man1/rsync.1.html" rel="nofollow">rsync</a> on Linux. That mostly just worked.</p>
<p dir="auto">Laptops are a new challenge, though. You can&#39;t just go around with an external drive hanging off them. They&#39;re often sleeping, with the lid down, on a sofa somewhere and (unless it&#39;s the work laptop) used intermittently.</p>
<p dir="auto">My solution, at the moment, is to back up centrally (using the <a href="https://www.recurse.com/eamonnsullivan/backup-scripts/blob/main/src/eamonnsullivan/backup.clj">server-side script</a> that is the main focus of this repo), but have the laptops initiate the process by running small shell scripts over ssh. I&#39;m using <a href="http://manpages.ubuntu.com/manpages/focal/man8/anacron.8.html" rel="nofollow">anacron</a> on Ubuntu and launchctl/launchd on the Mac to configure the laptops to back themselves up once a day.</p>
<h3 dir="auto"><a id="user-content-why-do-i-still-need-backups" aria-hidden="true" href="#why-do-i-still-need-backups"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Why do I still need backups?</h3>
<p dir="auto">That&#39;s a question worth considering. Why not just use Dropbox, Google Drive or whatever Apple&#39;s pushing these days? I do actually already use these things, plus Github for all of my source code.</p>
<p dir="auto">But these aren&#39;t back up systems. If I accidentally delete an important file, for example, it&#39;s very shortly gone from these systems as well.</p>
<p dir="auto">Also, my wife (who doesn&#39;t use Dropbox or anything like it) keeps her entire digital life (word processing documents, presentation, spreadsheets, etc.) on a Thinkpad running Ubuntu. She counts on me to keep those safe. (Well, actually, she just assumes they are safe... I&#39;m the IT Guy in the house and it&#39;s my job to worry about such things.)</p>
<p dir="auto">Mostly, though, I like having control over my own data and I want to understand how it is being stored and moved around. I will probably extend this system to the cloud in the future -- periodically sending monthly backups offsite -- but I will likely use S3 on my own AWS account for that, keeping it under my understanding and control.</p>
<h2 dir="auto"><a id="user-content-prerequisites" aria-hidden="true" href="#prerequisites"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Prerequisites</h2>
<p dir="auto">You&#39;ll need a PC that&#39;s either always on or reliably turned on when it&#39;s needed. It will need plenty of disk storage. A Raspberry Pi 4 with an attached USB disk is what I use at the moment. I installed the ARM port of Ubuntu server on it, and babashka now has ARM support as well.</p>
<p dir="auto">I use a 1TB SSD USB disk, mounted permanently at /media/backup. Here&#39;s <a href="https://www.techrepublic.com/article/how-to-properly-automount-a-drive-in-ubuntu-linux/" rel="nofollow">one random guide</a> on how to mount an external disk automatically on boot.</p>
<p dir="auto">You will also need to set up password-less SSH access, both from the back up PC to the devices, and from the devices to the back up PC. This will allow the back up PC to run rsync to the devices, and also allow to the devices to kick off the process by running a small shell script via SSH. There are a lot of guides on the Internet for this, such as <a href="https://linuxize.com/post/how-to-setup-passwordless-ssh-login/" rel="nofollow">this one</a>.</p>
<p dir="auto">I don&#39;t use Windows at the moment and don&#39;t really mount network drives, either. That might be a good alternative to consider.</p>
<h2 dir="auto"><a id="user-content-back-up-approach" aria-hidden="true" href="#back-up-approach"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Back up approach</h2>
<p dir="auto">I used to just mirror everyone&#39;s home directory on another device. Just periodically run rsync and sync all of the files to the external hard drive. This works, but it has a couple of disadvantages. One important disadvantage is that if you delete a file on Tuesday and discover on Thursday that you really actually needed that file, it&#39;s probably now gone from the back up, as well.</p>
<p dir="auto">So, instead I took a cue from Apple&#39;s Time Machine and take advantage of hard links, a relatively underused facility in most Unix based file systems. Basically, it just gives the file another name, somewhere else. If you delete one of the names, the same file still lives under the other name. And hard links don&#39;t take up any extra space (or hardly any).</p>
<p dir="auto">I also mitigate against creeping bad sectors (which happen even on SSDs) by periodically starting over again with a fresh, full back up.</p>
<p dir="auto">The basic algorithm:</p>
<ol dir="auto">
<li>Run rsync to sync the files from one place to another.</li>
<li>Make a hard link of all of the files to another location on the file system, under a directory with the date in the name.</li>
<li>Check the remaining free space on the back up device and compare it with the last full back I just did. If free space is less than twice the size of the last backup, I start removing the oldest backups (the ones created in the last step) until I have that much remaining.</li>
<li>Once a month, I start a new full back up from scratch. This is to guard against bad sectors in the disk, which can make older files become unreadable, and you would never know until you tried to restore it.</li>
</ol>
<h2 dir="auto"><a id="user-content-example-scripts" aria-hidden="true" href="#example-scripts"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Example scripts</h2>
<ul dir="auto">
<li><a href="https://www.recurse.com/eamonnsullivan/backup-scripts/blob/main/LaunchAgent">LaunchAgent on the Mac laptop</a></li>
<li><a href="https://www.recurse.com/eamonnsullivan/backup-scripts/blob/main/anacron">Anacron script for the Ubuntu laptops</a></li>
<li><a href="https://www.recurse.com/eamonnsullivan/backup-scripts/blob/main/server">Starter script on the server</a></li>
<li><a href="https://www.recurse.com/eamonnsullivan/backup-scripts/blob/main/src/eamonnsullivan/backup.clj">Main back up script</a></li>
</ul>
<h2 dir="auto"><a id="user-content-license" aria-hidden="true" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>License</h2>
<p dir="auto">Copyright © 2021 Eamonn Sullivan</p>
<p dir="auto">Distributed under the Eclipse Public License version 1.0.</p>
</article>
          </div></div>
  </body>
</html>
