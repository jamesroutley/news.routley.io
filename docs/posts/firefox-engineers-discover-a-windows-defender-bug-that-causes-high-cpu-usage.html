<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c82">Original</a>
    <h1>Firefox engineers discover a Windows Defender bug that causes high CPU usage</h1>
    
    <div id="readability-page-1" class="page"><div id="main-inner">










<section>
  <div>
  <div id="summary-container">
    <div id="field-status_summary">


  
    <p><span id="field-value-status_summary">
      <span data-status="closed">Closed</span>
      <span id="field-value-bug_id">
        <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918">Bug 1441918</a>
      </span>
      <span>
        <span>Opened <span title="2018-02-28 09:19 PST" data-time="1519838394">5 years ago</span></span>
          <span>Closed <span title="2023-03-21 03:37 PDT" data-time="1679395022">15 days ago</span></span>
      </span>
        </span>
    </p>

  
</div>


    
  </div>
  </div>
</section>


<section id="module-categories">
    
  <div id="module-categories-content"><div>

    <div id="field-product">
    


  
    <p><span id="field-value-product">
      <div>
        <p><span id="product-name" tabindex="0" role="button" aria-haspopup="menu" aria-controls="product-info">External Software Affecting Firefox
          <span aria-hidden="true">▾</span>
        </span></p>
      </div>
        </span>
    </p>

  
</div>

    

    

    
</div>
  </div>
</section>


<section id="module-tracking">
    
  
</section>



<section id="module-people">
    
  
</section>


<section id="module-references">
    
  
</section>


<section id="module-details">
    
  
</section>
















<section id="module-attachments">
    
  
</section>







<meta name="firefox-versions" content="{&#34;FIREFOX_AURORA&#34;:&#34;&#34;,&#34;FIREFOX_DEVEDITION&#34;:&#34;112.0b9&#34;,&#34;FIREFOX_ESR&#34;:&#34;102.9.0esr&#34;,&#34;FIREFOX_ESR_NEXT&#34;:&#34;&#34;,&#34;FIREFOX_NIGHTLY&#34;:&#34;113.0a1&#34;,&#34;FIREFOX_PINEBUILD&#34;:&#34;&#34;,&#34;LAST_MERGE_DATE&#34;:&#34;2023-03-13&#34;,&#34;LAST_RELEASE_DATE&#34;:&#34;2023-03-14&#34;,&#34;LAST_SOFTFREEZE_DATE&#34;:&#34;2023-03-09&#34;,&#34;LAST_STRINGFREEZE_DATE&#34;:&#34;2023-03-10&#34;,&#34;LATEST_FIREFOX_DEVEL_VERSION&#34;:&#34;112.0b9&#34;,&#34;LATEST_FIREFOX_OLDER_VERSION&#34;:&#34;3.6.28&#34;,&#34;LATEST_FIREFOX_RELEASED_DEVEL_VERSION&#34;:&#34;112.0b9&#34;,&#34;LATEST_FIREFOX_VERSION&#34;:&#34;111.0.1&#34;,&#34;NEXT_MERGE_DATE&#34;:&#34;2023-04-10&#34;,&#34;NEXT_RELEASE_DATE&#34;:&#34;2023-04-11&#34;,&#34;NEXT_SOFTFREEZE_DATE&#34;:&#34;2023-04-06&#34;,&#34;NEXT_STRINGFREEZE_DATE&#34;:&#34;2023-04-07&#34;}"/>



<div id="c3"><div><p>Flags: needinfo?(mjaritz)</p></div></div><div id="c4"><div><p>Flags: <span>needinfo?(mjaritz)</span></p></div></div><div id="c12"><div><p>Flags: needinfo?(mjaritz)</p></div></div><div id="c13"><div><p>Flags: <span>needinfo?(mjaritz)</span></p></div></div><div id="c22"><div><p>Flags: needinfo?(mozilla)</p></div></div><div id="c23"><div><p>Flags: needinfo?(nirbheek.chauhan)</p></div></div><div id="c24"><div><p>Flags: <span>needinfo?(nirbheek.chauhan)</span></p></div></div><div id="c26"><div><p>Flags: needinfo?(mozilla) → needinfo?(jmathies)</p></div></div><div id="c27"><div><p>Flags: <span>needinfo?(jmathies)</span></p></div></div><div id="c47"><div><p>Component: Storage → General</p><p>Product: Toolkit → Firefox</p></div></div><div id="a13025397_420453"><div><p>Component: General → Other</p><p>Product: Firefox → External Software Affecting Firefox</p></div></div><div id="c56"><div><p>Flags: needinfo?(jmathies)</p></div></div><div id="c60"><div><p>Flags: needinfo?(ke5trel)</p></div></div><div id="c61"><div><p>Flags: <span>needinfo?(ke5trel)</span></p></div></div><div id="c63"><div><p>Flags: <span>needinfo?(jmathies)</span></p></div></div><div id="c64"><div><p>Flags: needinfo?(ke5trel)</p></div></div><div id="a22466583_269762"><div><p>Assignee: nobody → honzab.moz</p></div></div><div id="c67"><p>Sorry, I&#39;m constantly not getting to this; releasing for anyone else to take over.</p><div><p>Assignee: honzab.moz → nobody</p><p>Flags: <span>needinfo?(ke5trel)</span></p></div></div><div id="c68"><p>Marco - what has happened with Microsoft here?  Do you know if it&#39;s still happening; if so can you guess how common it is?</p><div><p>Flags: needinfo?(mcastelluccio)</p></div></div><div id="c69"><p>Marking this as p2 since any user with an HDD will likely experience real pain from anything that triggers windows defender to be more active.</p><div><p>Whiteboard: [qf] → [qf:p2:resource]</p></div></div><div id="c70"><div><p>Flags: <span>needinfo?(mcastelluccio)</span></p></div></div><div id="c71"><p>Thunderbird also sometimes encounters performance issues with defender - <a href="https://mzl.la/2X0xpze" rel="nofollow">https://mzl.la/2X0xpze</a></p><div><p>Summary: Antimalware Service Executable very active when using Firefox → Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox</p></div></div><div id="c72"><p>Still happening today. After a while with Firefox Nightly 80 open the laptop fans start going to max and I check the Task Manager, lo and behold there&#39;s Firefox choking the entire CPU and the AntiMalware service CPU usage a little bit higher whenever that is happening. Every single day this annoying thing happens and every single time I have to close Firefox and open it again to stop it. Every single time I have to lose any progress I have just to stop this idiotic nonsense.</p></div><div id="c73"><div><p>Flags: needinfo?(particlecore)</p></div></div><div id="c74"><div id="ct-74" data-comment-id="15183833" data-ismarkdown="true"><p>(In reply to Gian-Carlo Pascutto [:gcp] from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c73" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #73</a>)</p>
<blockquote>
<p>Hi, can you follow the steps in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c66">https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c66</a> and report the feedback ID? We can try to nudge Microsoft to look into it perhaps.</p>
<p>There&#39;s nothing actionable in Firefox itself here, unfortunately.</p>
</blockquote>
<p>I already disabled the AntiMalware service entirely and Firefox continues to lock at 25% cpu usage after a while, randomly. This is on a fresh profile with no addons installed. I have to restart the browser to get this under control, otherwise it just chugs the process constantly for absolutely no reason whatsoever.</p>
<p>Is there any way we can inspect what Firefox is writing to during that time? This is f*ing annoying and is driving me nuts for months.</p>
</div><div><p>Flags: <span>needinfo?(particlecore)</span></p></div></div><div id="c75"><div id="ct-75" data-comment-id="15198806" data-ismarkdown="true"><p>I have been able to reproduce the high CPU usage on my end consistently and it is always always always after Firefox updates itself while I am still using it and I do not restart it for a while.</p>
<p>This is how I am reproducing it (at least on Nightly, regardless of which version it is):</p>
<p>Use the browser for an entire day without restarting it once, keep it always open and use it as normal with as around 12 tabs or just 4, makes no difference</p>
<p>Firefox options menu will eventually show a green dot notification typically associated with the restart prompt, ignore it</p>
<p>Keep using the browser and, again, never restart it or close the browser once during this whole process</p>
<p>Eventually the CPU usage will start ramping up on its own, especially when you&#39;re idle, and will stay locked at that CPU usage permanently. For me it has been lately locked at constant 25% usage</p>
<hr/>
<p>How do I know this is because of the update? Because I disabled the auto update option in the browser and now it has NEVER EVER DONE IT AGAIN until I tell it to download the update. Then it happens again, without exception.</p>
<p>This is the difference between keeping the browser open for 3 days, never closing it once, with the PC going into sleep mode at the end of the day and the CPU NEVER RAMPS UP on its own. It only does whenever it is doing demanding tasks, like watching high FPS videos on YouTube.</p>
<p>vs</p>
<p>Letting the browser update itself and never restarting it, guaranteed to start ramping up the CPU over time and staying completely locked at 25% CPU usage for no fng reason whatsoever. And I mean, I am away from the PC with nothing running and I start hearing the fans blowing constantly as a result of this. Every. Single. Time. It&#39;s Firefox locked at 25% cpu usage. EVERY. SINGLE. TIME.</p>
</div></div><div id="c76"><p>I am seeing Firefox become unusable sometime after an update becomes available,   but if it is related I am not in a position to say. I use the update restart to reduce memory usage as at that time memory will be out to around 4Gb and my system frantically paging,  a restart will bring it back to less that 500mb usually.  I use ESET, not Defender, though.</p></div><div id="a126399581_396948"><div><p>Performance Impact: --- → P2</p><p>Whiteboard: <span>[qf:p2:resource]</span></p></div></div><div id="a145684825_546015"><div><p>Severity: normal → S3</p><p>Performance Impact: medium → ---</p></div></div><div id="c77"><div id="ct-77" data-comment-id="16286696" data-ismarkdown="true"><p>Some new reports of this popping up: <a href="https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/" rel="nofollow">https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/</a></p>
<p>I&#39;m personally running Win10 22H2 Build 19045.2604, all latest updates and I encounter this problem too.</p>
<p>Excluding the Appdata/Roaming/Mozilla and Appdata/Local/Mozilla folders alleviates the problem and brings the CPU usage down to what other browsers (Edge, Chrome) cause.</p>
<p>Things I&#39;ve tried to alleviate</p>
<ul>
<li>Disable accessibility services</li>
<li>Uninstall Firefox, manually getting rid of all Mozilla folders, and reinstalling, starting a new profile</li>
</ul>
<p>I&#39;ve started noticing it now because I have a new CPU (5900X) that gets a bit hotter when a thread spins up, resulting in a variation of my fan speed.</p>
</div></div><div id="c80"><div id="ct-80" data-comment-id="16313467" data-ismarkdown="true"><p>(In reply to Jeroen Baert from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c77" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #77</a>)</p>
<blockquote>
<p>Some new reports of this popping up: <a href="https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/" rel="nofollow">https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/</a></p>
<p>I&#39;m personally running Win10 22H2 Build 19045.2604, all latest updates and I encounter this problem too.</p>
</blockquote>
<p>Hello,</p>
<p>Thank you for sharing this. I think I can reproduce the problem, so I will provide some data that describes what happens on my machine in this comment. It would be helpful if you could confirm if the data looks similar on your machine, to be sure that I can use my own machine as a basis for investigating this issue. I will describe how to collect similar data by yourself in a second comment.</p>
<p>I recorded a session with Windows Performance Recorder, then opened it in Windows Performance Analyzer. I only had Firefox open when I did the test. What I did was launch <code>youtube.com</code> once, wait for 10 seconds, refresh it, and again (in total, 5 loads). I did the same in Chrome (after <a href="https://thegeekpage.com/high-cpu-usage-by-google-chromes-software-reporter-tool/" rel="nofollow">disabling Software Reporter Tool</a> which was somehow having a lot of CPU activity on my machine, which could have affected the experiment). Attachments show the activity graph for the most active processes in each session, then the details of where <code>MsMpEng.exe</code> spent CPU time in both sessions. Firefox session is always shown at the top, and Chrome at the bottom.</p>
<p><code>MsMpEng.exe</code>&#39;s CPU activity is shown with red bars, while the useful processes are shown with other colors. We can see that with both Firefox and Chrome, <code>MsMpEng.exe</code>&#39;s activity is correlated to the activity of the other processes: it is high when Firefox or Chrome processes themselves have high CPU activity. This is explained by the fact that <code>MsMpEng.exe</code> spends most of its CPU time in <code>sechost.dll!ProcessTrace</code>, in other words it is busy processing ETW events that result from the activity of other processes. However, the CPU time used overall by <code>MsMpEng.exe</code> seems indeed much higher (5x) with Firefox compared to Chrome. By trying to list the specific ETW events which <code>MsMpEng.exe</code> is listening to, we may identify that there are some events which Firefox&#39;s current behavior generates a lot of, and in that case we could then try to reduce the amount that we generate. So, if the Firefox graph looks similar on the reporter&#39;s machine, then I can try doing that.</p>
<p>Note: I see no disk activity from <code>MsMpEng.exe</code>, so for the moment this looks like legitimate <code>MsMpEng.exe</code> activity (although high) to me, unlike (my understanding of) the original bug.</p>
</div></div><div id="c81">

  <div id="ct-81" data-comment-id="16313658" data-ismarkdown="true"><p>To produce the data, first I recommend looking at the short video tutorial <a href="https://learn.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-analyzer" rel="nofollow">here</a> from Microsoft to have an overview of the interface of Windows Performance Analyzer. Then, here are the steps to reproduce the graph and numbers from the first image:</p>
<ol>
<li>Install Windows Performance Recorder and Windows Performance Analyzer from <a href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install" rel="nofollow">the Windows ADK</a> for your version of Windows. For Windows 10 22H2 I think <a href="https://go.microsoft.com/fwlink/?linkid=2120254" rel="nofollow">this one</a> should work. You only need to select Windows Performance Toolkit as a feature after launching the ADK installer.</li>
<li>Close as many open applications as possible to avoid noise in collecting the data.</li>
<li>Open Windows Performance Recorder and configure it as shown in attachment. Click <code>Start</code>.</li>
<li>Open Firefox and do the steps for which you want to analyze performance (e.g. load YouTube 5 times separated by intervals of 10 seconds).</li>
<li>Back in Windows Performance Recorder, click <code>Save</code>, click <code>Save</code>, click <code>Open in WPA</code>.</li>
<li>If Windows Performance Analyzer fails to load with error 0x80070032, install <a href="https://apps.microsoft.com/store/detail/windows-performance-analyzer-preview/9N58QRW40DFW" rel="nofollow">Windows Performance Analyzer Preview from the Windows Store</a> and load the saved file from there to avoid the error (I personally have to do this).</li>
<li>In Windows Performance Analyzer, unroll <code>Computation</code>, drag and drop <code>CPU Usage (Precise)</code> to the currently empty <code>Analysis</code> tab. A graph shows up.</li>
<li>Under <code>Series</code>, navigate to the top. The processes are sorted based on which were the most active (hopefully, some <code>firefox.exe</code> processes and <code>MsMpEng.exe</code>). By using shift-clicking or control-clicking, select the most active <code>firefox.exe</code> processes and <code>MsMpEng.exe</code>, but not <code>Idle</code> (which is not a process). Then, right-click, <code>Disable</code>, <code>All but selection</code>.</li>
<li>Near, <code>Utilization by Process, Thread, Stack</code>, there is a <code>Select Chart Type</code> button. Click it and select <code>Stacked bars</code>, then move the cursor towards <code>Max</code>.</li>
<li>(Optional) Select the relevant portion of the graph, right-click, <code>Zoom</code>.</li>
<li>Use Snipping Tool to save and share the graph.</li>
</ol>
<p><strong>Note: Please share only the graph, and not the raw file saved by Windows Performance Recorder which may contain private information.</strong></p>
<p>Note: The graph and numbers should be enough assuming that it looks reasonably similar to mine. To reproduce the detailed activity of <code>MsMpEng.exe</code>, the steps are mostly the same, but you would need to set <code>Detail level</code> to <code>Verbose</code> when recording, then after all the previous steps in WPA you would click the <code>Trace</code> menu, click <code>Load Symbols</code>, wait a long time, and then progressively unroll the top-most entries under <code>MsMpEng.exe</code> like in the image I shared.</p>
</div></div><div id="c82"><div id="ct-82" data-comment-id="16323586" data-ismarkdown="true"><p>Hello,</p>
<p>Here is a short update on this issue:</p>
<ul>
<li>There is a serious performance issue in the current version of <code>MsMpEng.exe</code>, which I was able to pinpoint using the WPR profiles from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c78" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 78</a> and some debugging. We have reported the details to Microsoft, and they have acknowledged it.</li>
<li>This performance issue makes calls to <code>VirtualProtect</code> (among other things) unreasonably expensive on Windows platforms when Windows Defender&#39;s Real-time Protection feature is active (the unreasonably expensive computations execute in the <code>MsMpEng.exe</code> process). Microsoft has applied a patch that will mitigate the issue with <a href="https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/manage-updates-baselines-microsoft-defender-antivirus#monthly-platform-and-engine-versions" rel="nofollow">the upcoming March release (engine version 1.1.20200.2)</a>, which means that users will gradually get the fix within the next 4 weeks. People who would like to bypass the progressive rollout and get the patch sooner (i.e. next week) can use <a href="https://learn.microsoft.com/en-us/powershell/module/defender/set-mppreference#-engineupdateschannel" rel="nofollow"><code>Set-MpPreference -EngineUpdatesChannel Preview</code></a>.</li>
<li>With a standard Firefox configuration, the amount of calls to <code>VirtualProtect</code> is currently very high, and that is what explains the high CPU usage with Firefox. The information that the most impactful event originates from calls to <code>VirtualProtect</code> was forwarded to us by Microsoft, and I confirm it. In both Firefox and Chrome, disabling JIT makes <code>MsMpEng.exe</code> behave much more reasonably, as JIT engines are the source of the vast majority of calls to <code>VirtualProtect</code>.</li>
<li>On Firefox&#39;s side, independently from the issue mentioned above, we should not consider that calls to <code>VirtualProtect</code> are cheap. We should look for opportunities to group multiple calls to <code>VirtualProtect</code> together, if possible. Even after the performance issue will be mitigated, each call to <code>VirtualProtect</code> will still trigger some amount of computation in <code>MsMpEng.exe</code> (or third-party AV software); the computation will just be more reasonably expensive.</li>
</ul>
<p>I will provide more details with numbers later.</p>
</div></div><div id="c83"><div id="ct-83" data-comment-id="16323610" data-ismarkdown="true"><p>(In reply to Jeroen Baert from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c77" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #77</a>)</p>
<blockquote>
<p>Some new reports of this popping up: <a href="https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/" rel="nofollow">https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/</a></p>
<p>I&#39;m personally running Win10 22H2 Build 19045.2604, all latest updates and I encounter this problem too.</p>
</blockquote>
<p>Can you confirm if <code>MsMpEng.exe</code> behaves more reasonably after navigating to <code>about:config</code> in Firefox and changing the following preferences:</p>
<ul>
<li>set <code>javascript.options.baselinejit</code> to <code>false</code>;</li>
<li>set <code>javascript.options.wasm_baselinejit</code> to <code>false</code>;</li>
<li>set <code>javascript.options.wasm_optimizingjit</code> to <code>false</code>.</li>
</ul>
<p>If that doesn&#39;t solve the issue, you might be experiencing a different issue from the one mentioned in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c82" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 82</a>.</p>
</div></div><div id="c84">

  <div id="ct-84" data-comment-id="16323724" data-ismarkdown="true"><p>This image shows the impact of the preferences listed in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c83" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 83</a> on my personal machine: top is with JIT, bottom is without JIT. We can see that for the specific case of loading youtube.com 5 times in Firefox:</p>
<ul>
<li><code>MsMpEng.exe</code> total CPU time decreases from 16s to 6s by disabling JIT in Firefox (so 63% less CPU time);</li>
<li><code>firefox.exe</code> total CPU time summed for the most active processes is around 23.5s independently of whether or not we are using JIT in Firefox.</li>
</ul>
</div></div><div id="c85"><p>I would also like to add that this high CPU usage issue while using Firefox is not exclusive to Microsoft Defender. It&#39;s an issue for Norton&#39;s AV products also and should be the same for Symantec Endpoint products too.</p></div><div id="c86"><div id="ct-86" data-comment-id="16325160" data-ismarkdown="true"><p>(In reply to SeriousHoax from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c85" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #85</a>)</p>
<blockquote>
<p>I would also like to add that this high CPU usage issue while using Firefox is not exclusive to Microsoft Defender. It&#39;s an issue for Norton&#39;s AV products also and should be the same for Symantec Endpoint products too.</p>
</blockquote>
<p>Hello, if you have one of these AV products installed, can you confirm if the steps <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c83" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 83</a> impact the CPU usage of your AV processes? Can you share some CPU usage measurements like described in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c81" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 81</a>?</p>
</div><div><p>Flags: needinfo?(serioushoax)</p></div></div><div id="c87"><div id="ct-87" data-comment-id="16325214" data-ismarkdown="true"><p>(In reply to Yannis Juglaret from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c82" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #82</a>)</p>
<blockquote>
<ul>
<li>There is a serious performance issue in the current version of <code>MsMpEng.exe</code>, which I was able to pinpoint using the WPR profiles from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c78" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 78</a> and some debugging. We have reported the details to Microsoft, and they have acknowledged it.</li>
</ul>
</blockquote>
<p>Let me share more details on this, as this may be interesting for other AV vendors who would be watching this discussion. The <code>TdhFormatProperty</code> can be used to get information associated with ETW events. This function has the following prototype:</p>
<pre><code>TDHSTATUS TdhFormatProperty(
  ...,
  [in, out]       PULONG            BufferSize,
  [out, optional] PWCHAR            Buffer,
  ...
);
</code></pre>
<p>This is a classic Windows API pattern: you can first call it with a <code>NULL</code> pointer as Buffer to know the required buffer size. Then you can call it a second time with a properly-sized buffer.</p>
<pre><code>// First call to get the required buffer size
ULONG BufferSize = 0;
if (TdhFormatProperty(..., &amp;BufferSize, NULL, ...) == ERROR_INSUFFICIENT_BUFFER &amp;&amp; BufferSize &gt; 0) {
    // BufferSize now holds the required buffer size: allocate a buffer and call again
    LPVOID Buffer = HeapAlloc(GetProcessHeap(), 0, BufferSize);
    if (TdhFormatProperty(..., &amp;BufferSize, Buffer, ...) == ERROR_SUCCESS) {
         // All good, we can now use Buffer
    }
}
</code></pre>
<p>Except that if you use this classic pattern here, you will have very bad performance with the current implementation of <code>TdhFormatProperty</code>. The code above is, in the best case scenario, equivalent to the one below:</p>
<pre><code>#define KB 1024
// First call to get the required buffer size
ULONG BufferSize = 64 * KB;
LPVOID Buffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, BufferSize);
if (TdhFormatProperty(..., &amp;BufferSize, Buffer, ...) == ERROR_SUCCESS) {
    HeapFree(GetProcessHeap(), 0, Buffer);
    // BufferSize now holds the required buffer size: allocate a buffer and call again
    Buffer = HeapAlloc(GetProcessHeap(), 0, BufferSize);
    if (TdhFormatProperty(..., &amp;BufferSize, Buffer, ...) == ERROR_SUCCESS) {
         // All good, we can now use Buffer
    }
}
</code></pre>
<p>In other words, with the current implementation of <code>TdhFormatProperty</code>, every call to <code>TdhFormatProperty</code> with a <code>NULL</code> buffer yields an allocation of a 64-KB zero-ed heap buffer. So, for example, because <a href="https://github.com/repnz/etw-providers-docs/blob/master/Manifests-Win10-17134/Microsoft-Windows-Threat-Intelligence.xml#L72" rel="nofollow">the ETW event for monitoring <code>VirtualProtect</code> has 18 properties</a>, if as an AV vendor you are listening to this event and calling <code>TdhFormatProperty</code> on each of its property using the pattern described above, each call to <code>VirtualProtect</code> on the system will result in the allocation and zero-ing of 18 64-KB buffers in your AV process. If moreover the AV code considers that <code>TdhFormatProperty</code> is not expensive, and calls it multiple times for the same property, that makes the situation even worse.</p>
<p>As a result of using the pattern described above, <code>MsMpEng.exe</code> was spending 48% of its time allocating and zero-ing 64-KB buffers in the recording from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c78" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 78</a>. Microsoft coincidentally already had a new implementation for <code>TdhFormatProperty</code> on its way when we reported the issue; the new implementation is not there yet but it should enhance the performance of the pattern described above when it gets shipped. However the best fix is to not rely on the pattern from above, and instead reuse the same buffer all the time, and something along those lines will get shipped with Windows Defender engine version 1.1.20200.2.</p>
</div></div><div id="c88"><p>All this investigation is worth a blog post along the lines of the blog written by Bruce Dawson.</p></div><div id="c89"><div id="ct-89" data-comment-id="16325690" data-ismarkdown="true"><p>(In reply to Yannis Juglaret from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c83" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #83</a>)</p>
<blockquote>
<p>(In reply to Jeroen Baert from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c77" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #77</a>)</p>
<blockquote>
<p>Some new reports of this popping up: <a href="https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/" rel="nofollow">https://www.reddit.com/r/firefox/comments/zyzsk6/high_cpu_usage_from_windows_defenderantimalware/</a></p>
<p>I&#39;m personally running Win10 22H2 Build 19045.2604, all latest updates and I encounter this problem too.</p>
</blockquote>
<p>Can you confirm if <code>MsMpEng.exe</code> behaves more reasonably after navigating to <code>about:config</code> in Firefox and changing the following preferences:</p>
<ul>
<li>set <code>javascript.options.baselinejit</code> to <code>false</code>;</li>
<li>set <code>javascript.options.wasm_baselinejit</code> to <code>false</code>;</li>
<li>set <code>javascript.options.wasm_optimizingjit</code> to <code>false</code>.</li>
</ul>
<p>If that doesn&#39;t solve the issue, you might be experiencing a different issue from the one mentioned in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c82" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 82</a>.</p>
</blockquote>
<p>I can confirm that toggling these options does seem to have an impact, but haven&#39;t reduced the CPU usage of <code>MsMpEng.exe</code> to the low levels of Chrome or Edge. I&#39;m still seeing loads that are 3x that of loading the same website (I usually test with cnn.com, because it&#39;s large and full of mixed content) in Chrome/Edge.</p>
</div></div><div id="c90"><div id="ct-90" data-comment-id="16329612" data-ismarkdown="true"><p>(In reply to Jeroen Baert from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c89" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #89</a>)</p>
<blockquote>
<p>I can confirm that toggling these options does seem to have an impact, but haven&#39;t reduced the CPU usage of <code>MsMpEng.exe</code> to the low levels of Chrome or Edge. I&#39;m still seeing loads that are 3x that of loading the same website (I usually test with cnn.com, because it&#39;s large and full of mixed content) in Chrome/Edge.</p>
</blockquote>
<p>Thanks. Your observations align well with the numbers I have obtained experimenting with this. I counted how many events are generated on the <a href="https://github.com/repnz/etw-providers-docs/blob/master/Manifests-Win10-17134/Microsoft-Windows-Threat-Intelligence.xml" rel="nofollow">Microsoft-Windows-Threat-Intelligence ETW provider</a> when loading YouTube (didn&#39;t see significant difference with CNN), and here are the numbers I obtained:</p>
<ul>
<li>Firefox with normal configuration: ~14000 events, 98% of which are <code>PROTECTVM_LOCAL</code>;</li>
<li>Firefox with the preferences from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c83" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 83</a>: ~6500 events, 95% of which are <code>PROTECTVM_LOCAL</code>;</li>
<li>Edge: ~2000 events, 91% of which are <code>ALLOCVM_LOCAL</code>;</li>
<li>Chrome: ~300 events.</li>
</ul>
<p>So indeed, even with switching the prefs, we still have a high number of calls to <code>VirtualProtect</code>. This problem has two sides: Microsoft was doing a lot of useless computations upon each event; and we are generating a lot of events. The combination is explosive. Now that Microsoft has done their part of the job (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c82" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 82</a>), we need to reduce our dependency to <code>VirtualProtect</code>. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1822650" title="NEW - Batch BaselineCompiles">Bug 1822650</a> in particular will help with that.</p>
<p>(In reply to SeriousHoax from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c85" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment #85</a>)</p>
<blockquote>
<p>I would also like to add that this high CPU usage issue while using Firefox is not exclusive to Microsoft Defender. It&#39;s an issue for Norton&#39;s AV products also and should be the same for Symantec Endpoint products too.</p>
</blockquote>
<p>It is true that we should analyze the situation with other AV vendors, however, given the numbers shared above, and given how relevant it is to keep track of memory protection changes in order to detect malicious behavior, it is very likely that the explanation for Windows Defender also applies (at least in part) to other AV vendors.</p>
</div></div><div id="c91">

  <div id="ct-91" data-comment-id="16333815" data-ismarkdown="true"><p>I was able to install <code>mpengine.dll</code> version 1.1.20200.3, which should incorporate the fix for the performance issue mentioned in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c82" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 82</a> and described in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c87" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 87</a>. I confirm that this performance issue has correctly been addressed. Attached is a comparison of a previous recording (top) with a new recording (bottom).</p>
<p>The numbers suggest a ~75% improvement in CPU usage from MsMpEng.exe when browsing with Firefox (the specific number applies to browsing youtube.com on my machine), bringing it close to where CPU usage was when browsing with Chrome back in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c78" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 78</a> (of course, since the performance improvement benefits all programs installed on the system, the new numbers for Chrome should be lower if measured with version 1.1.20200.3 of <code>mpengine.dll</code>).</p>
<p>You can get <code>mpengine.dll</code> version 1.1.20200.3 (currently Beta) as follows:</p>
<ul>
<li>run a Powershell terminal as administrator;</li>
<li>type <code>Set-MpPreference -EngineUpdatesChannel Beta</code>, press Enter;</li>
<li>open Windows Update, browse updates, a new update should appear, install it;</li>
<li>back in the terminal, you can type <code>Set-MpPreference -EngineUpdatesChannel Broad</code> and press Enter if you don&#39;t want to stay in Beta for the future.</li>
</ul>
<p>You can then check your version of <code>mpengine.dll</code> as follows:</p>
<ul>
<li>navigate to <code>C:\ProgramData\Microsoft\Windows Defender\Definition Updates\</code>;</li>
<li>look for a folder named something like <code>{7C9E9F14-9A1B-4833-AC74-DA15E21884D4}</code>, open it;</li>
<li>right click on <code>mpengine.dll</code>, <code>Properties</code>, <code>Details</code>, look for <code>Product version</code>.</li>
</ul>
<p>Disclaimer: I have also received updates for my whole system and Firefox between the two recordings, which may also partially affect the numbers observed here.</p>
</div></div><div id="c92"><div id="ct-92" data-comment-id="16335492" data-ismarkdown="true"><p>I am closing this bug as per <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1441918#c91" title="RESOLVED FIXED - Antimalware Service Executable (Windows Defender) very active / high CPU when using Firefox">comment 91</a> the specific problem for Windows Defender seems fixed. I filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1823634" title="NEW - Reduce the CPU usage of antivirus software on Windows when Firefox is running">bug 1823634</a> for future work. Thank you!</p>
<p>Note: Feel free to reopen if the problem is not fixed on your own computer with a version of <code>mpengine.dll</code> higher than 1.1.20200.2.</p>
</div><div><p>Status: NEW → RESOLVED</p><p>Closed: <span title="2023-03-21 03:37 PDT" data-time="1679395022">15 days ago</span></p><p>Resolution: --- → FIXED</p></div></div><div id="c93"><p>Yannis, is the fix by Microsoft going to be deployed to all users or only users on recent updates of Windows?</p></div><div id="c94"><p>According to Microsoft, this will be deployed to all users as part of regular definition updates, which are packaged independently from OS updates. This includes even Windows 7 and 8.1 users, even though these platforms should not have had the performance issue with Firefox in the first place because the ETW events that cause it do not exist on these older versions of Windows. So as far as I understand, only users that would explicitly reject definition updates (which does not sound like something reasonable to do with your AV) would not get the fix.</p></div>



</div></div>
  </body>
</html>
