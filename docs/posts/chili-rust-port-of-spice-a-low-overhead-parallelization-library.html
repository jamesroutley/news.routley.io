<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/dragostis/chili">Original</a>
    <h1>Show HN: Chili. Rust port of Spice, a low-overhead parallelization library</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a href="https://crates.io/crates/chili" rel="nofollow"><img src="https://camo.githubusercontent.com/c46860cb575bafe36a6be9f31657ea7284156b402dacac251c2e11e590fb8d2f/68747470733a2f2f696d672e736869656c64732e696f2f6372617465732f762f6368696c692e737667" alt="Crates.io" data-canonical-src="https://img.shields.io/crates/v/chili.svg"/></a>
<a href="https://docs.rs/chili" rel="nofollow"><img src="https://camo.githubusercontent.com/ba01867190b37ab33b8213bf36d07e90c21058c078ed3f5dd262694f7b6bd0b8/68747470733a2f2f646f63732e72732f6368696c692f62616467652e737667" alt="Docs" data-canonical-src="https://docs.rs/chili/badge.svg"/></a></p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Rust port of <a href="https://github.com/judofyr/spice">Spice</a>, a low-overhead parallelization library</h2><a id="user-content-rust-port-of-spice-a-low-overhead-parallelization-library" aria-label="Permalink: Rust port of Spice, a low-overhead parallelization library" href="#rust-port-of-spice-a-low-overhead-parallelization-library"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Very low-overhead parallelization primitive, almost identical to
<a href="https://docs.rs/rayon/latest/rayon/fn.join.html" rel="nofollow"><code>rayon::join</code></a>. At any fork point during computation, it <em>may</em> run the two
passed closures in parallel.</p>
<p dir="auto">It works best in cases where there are many small computations and where it is
expensive to estimate how many are left on the current branch in order to stop trying to share work across threads.</p>

<p dir="auto">The following example sums up all nodes in a binary tree in parallel.</p>
<div dir="auto" data-snippet-clipboard-copy-content="fn sum(node: &amp;Node, scope: &amp;mut Scope&lt;&#39;_&gt;) -&gt; u64 {
    let (left, right) = scope.join(
        |s| node.left.as_deref().map(|n| sum(n, s)).unwrap_or_default(),
        |s| node.right.as_deref().map(|n| sum(n, s)).unwrap_or_default(),
    );

    node.val + left + right
}"><pre><span>fn</span> <span>sum</span><span>(</span><span>node</span><span>:</span> <span>&amp;</span><span>Node</span><span>,</span> <span>scope</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Scope</span><span>&lt;</span><span>&#39;</span>_<span>&gt;</span><span>)</span> -&gt; <span>u64</span> <span>{</span>
    <span>let</span> <span>(</span>left<span>,</span> right<span>)</span> = scope<span>.</span><span>join</span><span>(</span>
        |s| node<span>.</span><span>left</span><span>.</span><span>as_deref</span><span>(</span><span>)</span><span>.</span><span>map</span><span>(</span>|n| <span>sum</span><span>(</span>n<span>,</span> s<span>)</span><span>)</span><span>.</span><span>unwrap_or_default</span><span>(</span><span>)</span><span>,</span>
        |s| node<span>.</span><span>right</span><span>.</span><span>as_deref</span><span>(</span><span>)</span><span>.</span><span>map</span><span>(</span>|n| <span>sum</span><span>(</span>n<span>,</span> s<span>)</span><span>)</span><span>.</span><span>unwrap_or_default</span><span>(</span><span>)</span><span>,</span>
    <span>)</span><span>;</span>

    node<span>.</span><span>val</span> + left + right
<span>}</span></pre></div>
<p dir="auto">This is the ideal example since per-node computation is very cheap and the
nodes don&#39;t keep track of how many descendants are left.</p>

<p dir="auto">The following benchmarks measure the time it takes to sum up all the values in
a balanced binary tree with varying number of nodes.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">AMD Ryzen 7 4800HS (8 cores)</h3><a id="user-content-amd-ryzen-7-4800hs-8-cores" aria-label="Permalink: AMD Ryzen 7 4800HS (8 cores)" href="#amd-ryzen-7-4800hs-8-cores"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">While the improvement over the baseline in the 134M nodes case is close to the
theoretical maximum, it&#39;s worth noting that the actual time per node is 0.8ns
vs. a theoretical 1.8 / 8 = 0.2ns, if we&#39;re to compare against the 1K nodes
case.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Number of nodes</th>
<th>Baseline</th>
<th>Rayon</th>
<th>chili</th>
<th>Baseline / chili</th>
</tr>
</thead>
<tbody>
<tr>
<td>1023</td>
<td>1.8 µs</td>
<td>51.1 µs</td>
<td>3.4 µs</td>
<td><strong>x0.53</strong></td>
</tr>
<tr>
<td>16777215</td>
<td>94.4 ms</td>
<td>58.1 ms</td>
<td>13.6 ms</td>
<td><strong>x6.94</strong></td>
</tr>
<tr>
<td>134217727</td>
<td>797.5 ms</td>
<td>497.2 ms</td>
<td>101.8 ms</td>
<td><strong>x7.83</strong></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Number of nodes</th>
<th>Baseline</th>
<th>Rayon</th>
<th>chili</th>
<th>Baseline / chili</th>
</tr>
</thead>
<tbody>
<tr>
<td>1023</td>
<td>1.6 µs</td>
<td>29.2 µs</td>
<td>3.5 µs</td>
<td><strong>x0.46</strong></td>
</tr>
<tr>
<td>16777215</td>
<td>39.4 ms</td>
<td>40.5 ms</td>
<td>11.2 ms</td>
<td><strong>x3.51</strong></td>
</tr>
<tr>
<td>67108863</td>
<td>156.5 ms</td>
<td>167.1 ms</td>
<td>44.3 ms</td>
<td><strong>x3.53</strong></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">chili overhead on AMD Ryzen 7 4800HS (8 cores)</h3><a id="user-content-chili-overhead-on-amd-ryzen-7-4800hs-8-cores" aria-label="Permalink: chili overhead on AMD Ryzen 7 4800HS (8 cores)" href="#chili-overhead-on-amd-ryzen-7-4800hs-8-cores"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The overhead in the 1K nodes case remains approximately constant with respect
to the number of threads.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Number of nodes</th>
<th>Baseline</th>
<th>1 thread</th>
<th>2 threads</th>
<th>4 threads</th>
<th>8 threads</th>
</tr>
</thead>
<tbody>
<tr>
<td>1023</td>
<td>1.8 ns</td>
<td>3.5 ns</td>
<td>3.5 ns</td>
<td>3.5 ns</td>
<td>3.5 ns</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
</article></div></div>
  </body>
</html>
