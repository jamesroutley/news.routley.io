<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jnsgr.uk/2024/08/tailscale-on-the-rocks">Original</a>
    <h1>Libations: Tailscale on the Rocks</h1>
    
    <div id="readability-page-1" class="page"><article><header><ol><li><a href="https://tech.michaelaltfield.net/"></a><span>/</span></li><li><a href="https://tech.michaelaltfield.net/posts/">Blog</a><span>/</span></li><li><a href="https://tech.michaelaltfield.net/2024/08/tailscale-on-the-rocks/">Libations: Tailscale on the Rocks</a><span>/</span></li></ol><div><p><time datetime="2024-08-21 00:00:00 +0000 UTC">21 August 2024</time><span>·</span><span>2567 words</span><span>·</span><span title="Reading time">13 mins</span></p></div><div><picture><source srcset="/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_330x0_resize_q75_h2_box.webp 330w,/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_660x0_resize_q75_h2_box.webp 660w
,/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_1024x0_resize_q75_h2_box.webp 1024w
,/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_1280x512_resize_q75_h2_box.webp 1280w" sizes="100vw" type="image/webp"/><img width="1280" height="512" alt="A dimly lit, prohibition style cocktail bar with chesterfield sofas
and a jazz band performing in front of a neon sign in the background.
Prominent orange cocktail in the foreground.
" src="https://tech.michaelaltfield.net/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_660x0_resize_q75_box.jpg" srcset="/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_330x0_resize_q75_box.jpg 330w,/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_660x0_resize_q75_box.jpg 660w
,/2024/08/tailscale-on-the-rocks/cover_hu56fc2a3dadaf1130e3051f6ec97a2250_254425_1024x0_resize_q75_box.jpg 1024w
,/2024/08/tailscale-on-the-rocks/cover.jpg 1280w" sizes="100vw"/></picture></div></header><section><div><h2 id="introduction">Introduction <span><a href="#introduction" aria-label="Anchor">#</a></span></h2><p>I’m a long-time, self-professed connoisseur of cocktails. I’ve always enjoyed making (and drinking!) the classics, but I also like experimenting with new base spirits, techniques, bitters etc.</p><p>Over the years, I’ve collected recipes from a variety of sources. Some originated from books (such as <a href="https://www.amazon.co.uk/dp/160774970X" target="_blank" rel="noreferrer">Cocktail Codex</a> and <a href="https://www.amazon.co.uk/dp/1770857753" target="_blank" rel="noreferrer">Cocktails Made Easy</a>), others from websites (<a href="https://www.diffordsguide.com/" target="_blank" rel="noreferrer">Difford’s Guide</a>), and most importantly those that I’ve either guessed from things I’ve drunk elsewhere (like my favourite bar in Bristol, <a href="https://milkthistlebristol.com/" target="_blank" rel="noreferrer">The Milk Thistle</a>), or modifications to recipes from the referenced sources.</p><p>I wanted somewhere to store all these variations: somewhere that I could search easily from my iPhone (which is nearly always close to me when I’m making drinks). I wanted each recipe to fit in its entirety on my iPhone screen without the need to scroll.</p><p>Around the time I started thinking about this problem, I also learned about <a href="https://tailscale.com/kb/1244/tsnet" target="_blank" rel="noreferrer"><code>tsnet</code></a> and was desperate for an excuse to try it out - and thus <a href="https://github.com/jnsgruk/libations" target="_blank" rel="noreferrer">Libations</a> was born as the product of two things I love: <a href="https://tailscale.com/" target="_blank" rel="noreferrer">Tailscale</a> and cocktails!</p><h2 id="tswhat">tswhat? <span><a href="#tswhat" aria-label="Anchor">#</a></span></h2><p>Some time ago, Tailscale released a Go library named <a href="https://tailscale.com/kb/1244/tsnet" target="_blank" rel="noreferrer"><code>tsnet</code></a>. To quote the website:</p><blockquote><p>tsnet is a library that lets you embed Tailscale inside of a Go program</p></blockquote><p>In this case, the embedded Tailscale works slightly different to how <code>tailscaled</code> works (by default, anyway…). Rather than using the universal TUN/TAP driver in the Linux kernel, <code>tsnet</code> instead uses a userspace TCP/IP networking stack, which enables the process embedding it to make direct connections to other devices on your <a href="https://tailscale.com/kb/1136/tailnet" target="_blank" rel="noreferrer">tailnet</a> as if it were “just another machine”. This makes it easy to embed, and drops the requirement for the process to be privileged enough to access <code>/dev/tun</code>.</p><p>One of the things I like about how <code>tsnet</code> presents applications as devices on the tailnet, is that you can employ <a href="https://tailscale.com/kb/1018/acls" target="_blank" rel="noreferrer">ACLs</a> to control who and what on your tailnet can access <em>the application</em>, rather than <em>the device</em>. I’ve solved this problem before by putting applications in <a href="https://github.com/jnsgruk/nixos-config/blob/main/host/common/services/servarr/lib.nix" target="_blank" rel="noreferrer">their own <code>systemd-nspawn</code> container</a> and joining those containers to my tailnet. Another nice option is <a href="https://github.com/boinkor-net/tsnsrv" target="_blank" rel="noreferrer"><code>tsnsrv</code></a> which essentially acts as a Tailscale-aware proxy for individual applications, but in this case I wanted to bake it into the application - which I would <em>only</em> access over my tailnet.</p><p>Getting started with <code>tsnet</code> couldn’t be easier:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>mkdir tsnet-app<span>;</span> <span>cd</span> tsnet-app
</span></span><span><span>go mod init tsnet-app
</span></span><span><span>go get tailscale.com/tsnet
</span></span></code></pre></td></tr></tbody></table></div></div><p>That will get you set up with a basic Go project, with the <code>tsnet</code> library available. Create a new <code>main.go</code> file with the following contents:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span></code></pre></td><td><pre tabindex="0"><code data-lang="go"><span><span><span>package</span> <span>main</span>
</span></span><span><span>
</span></span><span><span><span>import</span> <span>(</span>
</span></span><span><span>	<span>&#34;fmt&#34;</span>
</span></span><span><span>	<span>&#34;log&#34;</span>
</span></span><span><span>	<span>&#34;net/http&#34;</span>
</span></span><span><span>
</span></span><span><span>	<span>&#34;tailscale.com/tsnet&#34;</span>
</span></span><span><span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>func</span> <span>main</span><span>()</span> <span>{</span>
</span></span><span><span>    <span>// Create a new tsnet server instance
</span></span></span><span><span><span></span>	<span>s</span> <span>:=</span> <span>tsnet</span><span>.</span><span>Server</span><span>{</span><span>Hostname</span><span>:</span> <span>&#34;tsnet-test&#34;</span><span>}</span>
</span></span><span><span>	<span>defer</span> <span>s</span><span>.</span><span>Close</span><span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>// Have the tsnet server listen on :8080
</span></span></span><span><span><span></span>	<span>ln</span><span>,</span> <span>err</span> <span>:=</span> <span>s</span><span>.</span><span>Listen</span><span>(</span><span>&#34;tcp&#34;</span><span>,</span> <span>&#34;:8080&#34;</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>log</span><span>.</span><span>Fatal</span><span>(</span><span>err</span><span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>defer</span> <span>ln</span><span>.</span><span>Close</span><span>()</span>
</span></span><span><span>
</span></span><span><span>    <span>// Define a very simple handler with a simple Hello, World style message
</span></span></span><span><span><span></span>	<span>handler</span> <span>:=</span> <span>http</span><span>.</span><span>HandlerFunc</span><span>(</span><span>func</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span> <span>{</span>
</span></span><span><span>		<span>fmt</span><span>.</span><span>Fprintf</span><span>(</span><span>w</span><span>,</span> <span>&#34;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello from %s, tailnet!&lt;/h1&gt;\n&#34;</span><span>,</span> <span>s</span><span>.</span><span>Hostname</span><span>)</span>
</span></span><span><span>	<span>})</span>
</span></span><span><span>
</span></span><span><span>    <span>// Start an HTTP server on the tsnet listener
</span></span></span><span><span><span></span>	<span>err</span> <span>=</span> <span>http</span><span>.</span><span>Serve</span><span>(</span><span>ln</span><span>,</span> <span>handler</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>log</span><span>.</span><span>Fatal</span><span>(</span><span>err</span><span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>This is about the most minimal example I could contrive. The code creates a simple instance of <code>tsnet.Server</code> with the hostname <code>tsnet-app</code>, listens on port <code>8080</code> and serves up a simple <code>Hello, World!</code> style message. On running the application you’ll see the following:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>❯ go run .
</span></span><span><span>2024/08/13 15:03:37 tsnet running state path /home/jon/.config/tsnet-tsnet-app/tailscaled.state
</span></span><span><span>2024/08/13 15:03:37 tsnet starting with hostname <span>&#34;tsnet-test&#34;</span>, varRoot <span>&#34;/home/jon/.config/tsnet-tsnet-app&#34;</span>
</span></span><span><span>2024/08/13 15:03:38 LocalBackend state is NeedsLogin<span>;</span> running StartLoginInteractive...
</span></span><span><span>2024/08/13 15:03:43 To start this tsnet server, restart with TS_AUTHKEY set, or go to: https://login.tailscale.com/a/deadbeeffeebdaed
</span></span></code></pre></td></tr></tbody></table></div></div><p>Clicking the link will open a page in your browser that runs you through Tailscale’s authentication flow, after which you should be able to <code>curl</code> the page directly from any of your devices (assuming you’re not doing anything complicated with ACLs that might prevent it)!</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span><span>7
</span><span>8
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>❯ tailscale status
</span></span><span><span><span># ...</span>
</span></span><span><span>100.93.165.28   kara                 jnsgruk@     linux   -
</span></span><span><span>100.106.82.10   tsnet-test           jnsgruk@     linux   -
</span></span><span><span><span># ...</span>
</span></span><span><span>
</span></span><span><span>❯ curl http://tsnet-test:8080
</span></span><span><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello from tsnet-test, tailnet!&lt;/h1&gt;
</span></span></code></pre></td></tr></tbody></table></div></div><p>The library has a pretty small API surface, all of which is documented on <a href="https://pkg.go.dev/tailscale.com/tsnet" target="_blank" rel="noreferrer">pkg.go.dev</a>.</p><h2 id="libations">Libations <span><a href="#libations" aria-label="Anchor">#</a></span></h2><p>For my cocktail app, I wanted to employ a similar, albeit simplified, set of techniques that I <a href="https://jnsgr.uk/2024/01/building-a-blog-with-go-nix-hugo/" target="_blank" rel="noreferrer">use to build this blog</a>. I love Go’s ability to embed static files that can be served as web assets.</p><h3 id="recipe-schema">Recipe Schema <span><a href="#recipe-schema" aria-label="Anchor">#</a></span></h3><p>I wanted to represent recipes in a format that could be updated by hand if necessary, and easily parsed into a web frontend. I decided to use JSON for this, representing the recipes as a list:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span></code></pre></td><td><pre tabindex="0"><code data-lang="json"><span><span><span>[</span>
</span></span><span><span>  <span>{</span>
</span></span><span><span>    <span>&#34;id&#34;</span><span>:</span> <span>10</span><span>,</span>
</span></span><span><span>    <span>&#34;name&#34;</span><span>:</span> <span>&#34;New York Sour&#34;</span><span>,</span>
</span></span><span><span>    <span>&#34;base&#34;</span><span>:</span> <span>[</span><span>&#34;Bourbon&#34;</span><span>],</span>
</span></span><span><span>    <span>&#34;glass&#34;</span><span>:</span> <span>[</span><span>&#34;12oz Lowball&#34;</span><span>],</span>
</span></span><span><span>    <span>&#34;method&#34;</span><span>:</span> <span>[</span><span>&#34;Dry Shake&#34;</span><span>,</span> <span>&#34;Shake&#34;</span><span>],</span>
</span></span><span><span>    <span>&#34;ice&#34;</span><span>:</span> <span>[</span><span>&#34;Cubed&#34;</span><span>],</span>
</span></span><span><span>    <span>&#34;ingredients&#34;</span><span>:</span> <span>[</span>
</span></span><span><span>      <span>{</span> <span>&#34;name&#34;</span><span>:</span> <span>&#34;Lemon Juice&#34;</span><span>,</span> <span>&#34;measure&#34;</span><span>:</span> <span>&#34;20&#34;</span><span>,</span> <span>&#34;unit&#34;</span><span>:</span> <span>&#34;ml&#34;</span> <span>},</span>
</span></span><span><span>      <span>{</span> <span>&#34;name&#34;</span><span>:</span> <span>&#34;Sugar&#34;</span><span>,</span> <span>&#34;measure&#34;</span><span>:</span> <span>&#34;20&#34;</span><span>,</span> <span>&#34;unit&#34;</span><span>:</span> <span>&#34;ml&#34;</span> <span>},</span>
</span></span><span><span>      <span>{</span> <span>&#34;name&#34;</span><span>:</span> <span>&#34;Red Wine&#34;</span><span>,</span> <span>&#34;measure&#34;</span><span>:</span> <span>&#34;10&#34;</span><span>,</span> <span>&#34;unit&#34;</span><span>:</span> <span>&#34;ml&#34;</span> <span>},</span>
</span></span><span><span>      <span>{</span> <span>&#34;name&#34;</span><span>:</span> <span>&#34;Bourbon&#34;</span><span>,</span> <span>&#34;measure&#34;</span><span>:</span> <span>&#34;40&#34;</span><span>,</span> <span>&#34;unit&#34;</span><span>:</span> <span>&#34;ml&#34;</span> <span>},</span>
</span></span><span><span>      <span>{</span> <span>&#34;name&#34;</span><span>:</span> <span>&#34;Egg White&#34;</span><span>,</span> <span>&#34;measure&#34;</span><span>:</span> <span>&#34;20&#34;</span><span>,</span> <span>&#34;unit&#34;</span><span>:</span> <span>&#34;ml&#34;</span> <span>}</span>
</span></span><span><span>    <span>],</span>
</span></span><span><span>    <span>&#34;garnish&#34;</span><span>:</span> <span>[</span><span>&#34;Lemon Sail&#34;</span><span>],</span>
</span></span><span><span>    <span>&#34;notes&#34;</span><span>:</span> <span>&#34;Use claret or malbec&#34;</span>
</span></span><span><span>  <span>}</span>
</span></span><span><span><span>]</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>This schema is able to capture all the relevant details from the different formats I’ve seen over the years. It would take some time to format my favourites into this schema, but that was always going to be the case.</p><p>I was fortunate enough to get access to the recipe collection from a well regarded cocktail bar in the UK. Unfortunately it was given to me in a hard-to-parse PDF, which resulted in many hours of playing with OCR tools and manual data cleaning - but enabled me to bootstrap the app with around 450 high quality recipes. I didn’t include their recipes in the libations <a href="https://github.com/jnsgruk/libations" target="_blank" rel="noreferrer">repository</a>, but I did include some of my own favourite concoctions in a <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/static/sample.json" target="_blank" rel="noreferrer">sample recipe file</a>. My <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/static/sample.json#L2-L20" target="_blank" rel="noreferrer">Mezcal Margarita</a> gets pretty good reviews 😉.</p><h3 id="server">Server <span><a href="#server" aria-label="Anchor">#</a></span></h3><p>The server implementation needed to fulfil a few requirements:</p><ul><li>Parse a specific recipes file, optionally passed via the command line</li><li>Have an embedded filesystem to contain static assets and templates</li><li>Be able to render HTML templates with the given recipes</li><li>Listen on either a tailnet (via <code>tsnet</code>), or locally (for testing convenience)</li><li>When listening on the tailnet, listen on HTTPS, redirecting HTTP traffic accordingly</li></ul><p>I wanted to keep dependencies to a minimum to make things easier to maintain over time. The <code>tsnet</code> library pulls in a few indirect dependencies, but everything else Libations uses is in the Go standard library.</p><p>The recipes JSON schema is very simple, and is modelled with a couple of Go structs:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span></code></pre></td><td><pre tabindex="0"><code data-lang="go"><span><span><span>// Ingredient represents the name and quantity of a given ingredient in a recipe.
</span></span></span><span><span><span></span><span>type</span> <span>Ingredient</span> <span>struct</span> <span>{</span>
</span></span><span><span>	<span>Name</span>    <span>string</span>
</span></span><span><span>	<span>Measure</span> <span>string</span>
</span></span><span><span>	<span>Unit</span>    <span>string</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>// Drink represents all of the details for a given drink.
</span></span></span><span><span><span></span><span>type</span> <span>Drink</span> <span>struct</span> <span>{</span>
</span></span><span><span>	<span>ID</span>          <span>int</span>
</span></span><span><span>	<span>Name</span>        <span>string</span>
</span></span><span><span>	<span>Base</span>        <span>[]</span><span>string</span>
</span></span><span><span>	<span>Glass</span>       <span>[]</span><span>string</span>
</span></span><span><span>	<span>Method</span>      <span>[]</span><span>string</span>
</span></span><span><span>	<span>Ice</span>         <span>[]</span><span>string</span>
</span></span><span><span>	<span>Ingredients</span> <span>[]</span><span>Ingredient</span>
</span></span><span><span>	<span>Garnish</span>     <span>[]</span><span>string</span>
</span></span><span><span>	<span>Notes</span>       <span>string</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>The <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/main.go#L73-L101" target="_blank" rel="noreferrer"><code>parseRecipes</code></a> function checks whether or not the user passed the path to a specific recipe file, or whether it should default to parsing the sample recipes file. Once it’s determined the right file to parse, and validated its existence, it unmarshals the JSON using the Go standard library.</p><p>Users have the option of passing the <code>-local</code> flag when starting Libations, which bypasses <code>tsnet</code> completely and starts a local HTTP listener on the specific port. This makes for easier testing when iterating through changes to the web UI and other elements:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span></code></pre></td><td><pre tabindex="0"><code data-lang="go"><span><span><span>// ...
</span></span></span><span><span><span></span><span>addr</span> <span>:=</span> <span>flag</span><span>.</span><span>String</span><span>(</span><span>&#34;addr&#34;</span><span>,</span> <span>&#34;:8080&#34;</span><span>,</span> <span>&#34;the address to listen on in the case of a local listener&#34;</span><span>)</span>
</span></span><span><span><span>local</span> <span>:=</span> <span>flag</span><span>.</span><span>Bool</span><span>(</span><span>&#34;local&#34;</span><span>,</span> <span>false</span><span>,</span> <span>&#34;start on local addr; don&#39;t attach to a tailnet&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>// ...
</span></span></span><span><span><span></span><span>var</span> <span>listener</span> <span>*</span><span>net</span><span>.</span><span>Listener</span>
</span></span><span><span><span>if</span> <span>*</span><span>local</span> <span>{</span>
</span></span><span><span>    <span>listener</span><span>,</span> <span>err</span> <span>=</span> <span>localListener</span><span>(</span><span>*</span><span>addr</span><span>)</span>
</span></span><span><span><span>}</span> <span>else</span> <span>{</span>
</span></span><span><span>    <span>listener</span><span>,</span> <span>err</span> <span>=</span> <span>tailscaleListener</span><span>(</span><span>*</span><span>hostname</span><span>,</span> <span>*</span><span>tsnetLogs</span><span>)</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>    <span>slog</span><span>.</span><span>Error</span><span>(</span><span>&#34;failed to create listener&#34;</span><span>,</span> <span>&#34;error&#34;</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>())</span>
</span></span><span><span>    <span>os</span><span>.</span><span>Exit</span><span>(</span><span>1</span><span>)</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>//...
</span></span></span></code></pre></td></tr></tbody></table></div></div><p>Setting up the <code>tsnet</code> server and listener is only <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/main.go#L141-L183" target="_blank" rel="noreferrer">mildly more complicated</a> – but mostly due to my requirement that all HTTP traffic is redirected to HTTPS, using the <a href="https://letsencrypt.org/" target="_blank" rel="noreferrer">LetsEncrypt</a> certificates that Tailscale <a href="https://tailscale.com/kb/1153/enabling-https" target="_blank" rel="noreferrer">provides automatically</a>. The redirects are handled by a separate Goroutine in this case:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span></code></pre></td><td><pre tabindex="0"><code data-lang="go"><span><span><span>// Start a standard HTTP server in the background to redirect HTTP -&gt; HTTPS.
</span></span></span><span><span><span></span><span>go</span> <span>func</span><span>()</span> <span>{</span>
</span></span><span><span>    <span>httpLn</span><span>,</span> <span>err</span> <span>:=</span> <span>tsnetServer</span><span>.</span><span>Listen</span><span>(</span><span>&#34;tcp&#34;</span><span>,</span> <span>&#34;:80&#34;</span><span>)</span>
</span></span><span><span>    <span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>        <span>slog</span><span>.</span><span>Error</span><span>(</span><span>&#34;unable to start HTTP listener, redirects from http-&gt;https will not work&#34;</span><span>)</span>
</span></span><span><span>        <span>return</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>slog</span><span>.</span><span>Info</span><span>(</span><span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>&#34;started HTTP listener with tsnet at %s:80&#34;</span><span>,</span> <span>hostname</span><span>))</span>
</span></span><span><span>
</span></span><span><span>    <span>err</span> <span>=</span> <span>http</span><span>.</span><span>Serve</span><span>(</span><span>httpLn</span><span>,</span> <span>http</span><span>.</span><span>HandlerFunc</span><span>(</span><span>func</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>newURL</span> <span>:=</span> <span>fmt</span><span>.</span><span>Sprintf</span><span>(</span><span>&#34;https://%s%s&#34;</span><span>,</span> <span>r</span><span>.</span><span>Host</span><span>,</span> <span>r</span><span>.</span><span>RequestURI</span><span>)</span>
</span></span><span><span>        <span>http</span><span>.</span><span>Redirect</span><span>(</span><span>w</span><span>,</span> <span>r</span><span>,</span> <span>newURL</span><span>,</span> <span>http</span><span>.</span><span>StatusMovedPermanently</span><span>)</span>
</span></span><span><span>    <span>}))</span>
</span></span><span><span>    <span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>        <span>slog</span><span>.</span><span>Error</span><span>(</span><span>&#34;unable to start http server, redirects from http-&gt;https will not work&#34;</span><span>)</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span><span>}()</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>With the correct listener selected, I create an <code>http.ServeMux</code> to <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/main.go#L103-L124" target="_blank" rel="noreferrer">handle routing to static assets and rendering templates</a>, and pass that mux to the <code>http.Serve</code> method from the Go standard library - and that’s it! At the time of writing the Go code totals 235 lines - not bad!</p><h3 id="web-interface">Web Interface <span><a href="#web-interface" aria-label="Anchor">#</a></span></h3><p>The web interface was designed primarily for mobile devices, and I’ve not yet done the work to make it excellent for larger-screened devices - though it’s certainly bearable. It’s also read-only at the moment: you can browse all the recipes, and there is a simple full-text search which can narrow the list of recipes down by searching for an ingredient, method, glass type, notes, etc.</p><p>As mentioned in <a href="https://jnsgr.uk/2024/05/tracking-software-across-teams/" target="_blank" rel="noreferrer">an earlier post</a>, I’m a big fan of the <a href="https://vanillaframework.io/" target="_blank" rel="noreferrer">Vanilla Framework</a>, which is a “simple, extensible CSS framework” from <a href="https://canonical.com" target="_blank" rel="noreferrer">Canonical</a>, and is used for all of Canonical’s apps and websites. Given that I had some prior experience using it, I decided to use it again here. I started using my tried and tested recipe of Vanilla + <a href="https://gohugo.io" target="_blank" rel="noreferrer">Hugo</a>, but later <a href="https://github.com/jnsgruk/libations/commit/d2783cf1adebd2432e832b27b335d2037d485da2" target="_blank" rel="noreferrer">reverted</a> to using simple HTML templates with Go’s <a href="https://pkg.go.dev/html/template" target="_blank" rel="noreferrer"><code>html/template</code></a> package.</p><p>The result is a set of <a href="https://github.com/jnsgruk/libations/tree/main/templates" target="_blank" rel="noreferrer">templates</a>, which iterate over the recipe data from the JSON file, and output nicely styled HTML elements:</p><figure><a href="https://tech.michaelaltfield.net/2024/09/03/container-download-curl-wget/01.png"><picture><source srcset="/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_330x0_resize_q75_h2_box_3.webp 330w,/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_660x0_resize_q75_h2_box_3.webp 660w
,/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_1024x0_resize_q75_h2_box_3.webp 1024w
,/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_1170x2532_resize_q75_h2_box_3.webp 1170w" sizes="100vw" type="image/webp"/><img width="1170" height="2532" alt="screenshot of the libations app displaying the recipe for a mezcal margarita" loading="lazy" decoding="async" src="https://tech.michaelaltfield.net/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_660x0_resize_box_3.png" srcset="/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_330x0_resize_box_3.png 330w,/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_660x0_resize_box_3.png 660w
,/2024/08/tailscale-on-the-rocks/01_hu58137e504e0b75945788b4a7ec219e64_277862_1024x0_resize_box_3.png 1024w
,/2024/08/tailscale-on-the-rocks/01.png 1170w" sizes="100vw"/></picture></a></figure><p>There is nothing fancy going on here - it’s nearly all stock Vanilla Framework. I do specify some <a href="https://github.com/jnsgruk/libations/blob/main/static/css/overrides.css" target="_blank" rel="noreferrer">overrides</a> to make the colours a bit less Ubuntu-ish, but that’s it!</p><p>One detail I’m pleased with is the dynamic drink icons. The icons indicate the type of glass the particular drink should be served in. This is a simple trick: for each drink the HTML template renders a <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/templates/glass-icon.html" target="_blank" rel="noreferrer"><code>glass-icon</code></a> partial, which reads the glass type specified in the recipe, and renders the <a href="https://github.com/jnsgruk/libations/tree/dc1e50c60ba992a01dfab82d7550ca76a2655efd/templates/icons" target="_blank" rel="noreferrer">appropriate SVG file</a> which is then <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/static/css/overrides.css#L42" target="_blank" rel="noreferrer">coloured with CSS</a>.</p><h2 id="packaging-for-nixos">Packaging for NixOS <span><a href="#packaging-for-nixos" aria-label="Anchor">#</a></span></h2><p>There were two main tasks in this category: creating the Nix package itself, and writing a simple NixOS module that would make it simple for me to run it on my NixOS server.</p><p>The project uses a <a href="https://nixos.wiki/wiki/Flakes" target="_blank" rel="noreferrer">Flake</a> to provide the package, overlay and module. The standard library in Nix has good tooling for Go applications now, meaning the <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/nix/libations.nix" target="_blank" rel="noreferrer">derivation</a> is short:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span>
</span></span><span><span>  <span>buildGo122Module</span><span>,</span>
</span></span><span><span>  <span>lastModifiedDate</span><span>,</span>
</span></span><span><span>  <span>lib</span><span>,</span>
</span></span><span><span>  <span>...</span>
</span></span><span><span><span>}:</span>
</span></span><span><span>
</span></span><span><span><span>let</span>
</span></span><span><span>  <span>version</span> <span>=</span> <span>builtins</span><span>.</span><span>substring</span> <span>0</span> <span>8</span> <span>lastModifiedDate</span><span>;</span>
</span></span><span><span><span>in</span>
</span></span><span><span><span>buildGo122Module</span> <span>{</span>
</span></span><span><span>  <span>pname</span> <span>=</span> <span>&#34;libations&#34;</span><span>;</span>
</span></span><span><span>  <span>inherit</span> <span>version</span><span>;</span>
</span></span><span><span>  <span>src</span> <span>=</span> <span>lib</span><span>.</span><span>cleanSource</span> <span>../.</span><span>;</span>
</span></span><span><span>  <span>vendorHash</span> <span>=</span> <span>&#34;sha256-AWvaHyJL7Cm+zCY/vTuTAsgLbVy6WUNfmaGbyQOzMMQ=&#34;</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>I haven’t cut any versioned releases of Libations at the time of writing - I’m using the last modified date of the flake to version the binaries.</p><p>The <a href="https://github.com/jnsgruk/libations/blob/dc1e50c60ba992a01dfab82d7550ca76a2655efd/nix/module.nix" target="_blank" rel="noreferrer">module</a> starts the application with <code>systemd</code>, and optionally provides it with a recipes file. There are four options defined at the time of writing: <code>services.libations.{enable,recipesFile,tailscaleKeyFile,package}</code>:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>options</span> <span>=</span> <span>{</span>
</span></span><span><span>  <span>services</span><span>.</span><span>libations</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>enable</span> <span>=</span> <span>mkEnableOption</span> <span>&#34;Enables the libations service&#34;</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>recipesFile</span> <span>=</span> <span>mkOption</span> <span>{</span>
</span></span><span><span>      <span>type</span> <span>=</span> <span>nullOr</span> <span>path</span><span>;</span>
</span></span><span><span>      <span>default</span> <span>=</span> <span>null</span><span>;</span>
</span></span><span><span>      <span>example</span> <span>=</span> <span>&#34;/var/lib/libations/recipes.json&#34;</span><span>;</span>
</span></span><span><span>      <span>description</span> <span>=</span> <span>&#39;&#39;
</span></span></span><span><span><span>        A file containing drinks recipes per the Libations file format.
</span></span></span><span><span><span>        See https://github.com/jnsgruk/libations.
</span></span></span><span><span><span>      &#39;&#39;</span><span>;</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>
</span></span><span><span>    <span>tailscaleKeyFile</span> <span>=</span> <span>mkOption</span> <span>{</span>
</span></span><span><span>      <span>type</span> <span>=</span> <span>nullOr</span> <span>path</span><span>;</span>
</span></span><span><span>      <span>default</span> <span>=</span> <span>null</span><span>;</span>
</span></span><span><span>      <span>example</span> <span>=</span> <span>&#34;/run/agenix/libations-tsauthkey&#34;</span><span>;</span>
</span></span><span><span>      <span>description</span> <span>=</span> <span>&#39;&#39;
</span></span></span><span><span><span>        A file containing a key for Libations to join a Tailscale network.
</span></span></span><span><span><span>        See https://tailscale.com/kb/1085/auth-keys/.
</span></span></span><span><span><span>      &#39;&#39;</span><span>;</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>
</span></span><span><span>    <span>package</span> <span>=</span> <span>mkPackageOption</span> <span>pkgs</span> <span>&#34;libations&#34;</span> <span>{</span> <span>};</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>The <code>tailscaleKeyFile</code> option enables the service to automatically join a tailnet using an API key, rather than prompting the user to click a link and authorise manually.</p><p>These options are translated into a simple <code>systemd</code> unit:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>config</span> <span>=</span> <span>mkIf</span> <span>cfg</span><span>.</span><span>enable</span> <span>{</span>
</span></span><span><span>  <span>systemd</span><span>.</span><span>services</span><span>.</span><span>libations</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>description</span> <span>=</span> <span>&#34;Libations cocktail recipe viewer&#34;</span><span>;</span>
</span></span><span><span>    <span>wantedBy</span> <span>=</span> <span>[</span> <span>&#34;multi-user.target&#34;</span> <span>];</span>
</span></span><span><span>    <span>after</span> <span>=</span> <span>[</span> <span>&#34;network.target&#34;</span> <span>];</span>
</span></span><span><span>    <span>environment</span> <span>=</span> <span>{</span>
</span></span><span><span>      <span>&#34;XDG_CONFIG_HOME&#34;</span> <span>=</span> <span>&#34;/var/lib/libations/&#34;</span><span>;</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>    <span>serviceConfig</span> <span>=</span> <span>{</span>
</span></span><span><span>      <span>DynamicUser</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>      <span>ExecStart</span> <span>=</span> <span>&#34;</span><span>${</span><span>cfg</span><span>.</span><span>package</span><span>}</span><span>/bin/libations -recipes-file </span><span>${</span><span>cfg</span><span>.</span><span>recipesFile</span><span>}</span><span>&#34;</span><span>;</span>
</span></span><span><span>      <span>Restart</span> <span>=</span> <span>&#34;always&#34;</span><span>;</span>
</span></span><span><span>      <span>EnvironmentFile</span> <span>=</span> <span>cfg</span><span>.</span><span>tailscaleKeyFile</span><span>;</span>
</span></span><span><span>      <span>StateDirectory</span> <span>=</span> <span>&#34;libations&#34;</span><span>;</span>
</span></span><span><span>      <span>StateDirectoryMode</span> <span>=</span> <span>&#34;0750&#34;</span><span>;</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>The <code>XDG_CONFIG_HOME</code> variable is set so that <code>tsnet</code> stores it’s state in <code>/var/lib/libations</code>, rather than trying to store it in the home directory of the <a href="https://0pointer.net/blog/dynamic-users-with-systemd.html" target="_blank" rel="noreferrer">dynamically created user</a> for the <code>systemd</code> unit.</p><p>I use <a href="https://github.com/ryantm/agenix" target="_blank" rel="noreferrer">agenix</a> on my NixOS machines to manage encrypted secrets, and for this project I used it to encrypt both the initial Tailscale <a href="https://tailscale.com/kb/1085/auth-keys" target="_blank" rel="noreferrer">auth key</a>, and my super-secret recipe collection! The configuration to provide the secrets and configure the server to run libations is available <a href="https://github.com/jnsgruk/nixos-config/blob/0f4df26871c1cacc5d9c24cdd46e495c808f6639/host/common/services/libations.nix" target="_blank" rel="noreferrer">on Github</a>, but looks like so:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span></code></pre></td><td><pre tabindex="0"><code data-lang="nix"><span><span><span>{</span> <span>config</span><span>,</span> <span>self</span><span>,</span> <span>...</span> <span>}:</span>
</span></span><span><span><span>{</span>
</span></span><span><span>  <span>age</span><span>.</span><span>secrets</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>libations-auth-key</span> <span>=</span> <span>{</span>
</span></span><span><span>      <span>file</span> <span>=</span> <span>&#34;</span><span>${</span><span>self</span><span>}</span><span>/secrets/thor-libations-tskey.age&#34;</span><span>;</span>
</span></span><span><span>      <span>owner</span> <span>=</span> <span>&#34;root&#34;</span><span>;</span>
</span></span><span><span>      <span>group</span> <span>=</span> <span>&#34;root&#34;</span><span>;</span>
</span></span><span><span>      <span>mode</span> <span>=</span> <span>&#34;400&#34;</span><span>;</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>
</span></span><span><span>    <span>libations-recipes</span> <span>=</span> <span>{</span>
</span></span><span><span>      <span>file</span> <span>=</span> <span>&#34;</span><span>${</span><span>self</span><span>}</span><span>/secrets/thor-libations-recipes.age&#34;</span><span>;</span>
</span></span><span><span>      <span>owner</span> <span>=</span> <span>&#34;root&#34;</span><span>;</span>
</span></span><span><span>      <span>group</span> <span>=</span> <span>&#34;root&#34;</span><span>;</span>
</span></span><span><span>      <span>mode</span> <span>=</span> <span>&#34;444&#34;</span><span>;</span>
</span></span><span><span>    <span>};</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span>
</span></span><span><span>  <span>services</span><span>.</span><span>libations</span> <span>=</span> <span>{</span>
</span></span><span><span>    <span>enable</span> <span>=</span> <span>true</span><span>;</span>
</span></span><span><span>    <span>recipesFile</span> <span>=</span> <span>config</span><span>.</span><span>age</span><span>.</span><span>secrets</span><span>.</span><span>libations-recipes</span><span>.</span><span>path</span><span>;</span>
</span></span><span><span>    <span>tailscaleKeyFile</span> <span>=</span> <span>config</span><span>.</span><span>age</span><span>.</span><span>secrets</span><span>.</span><span>libations-auth-key</span><span>.</span><span>path</span><span>;</span>
</span></span><span><span>  <span>};</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>As a result, the application is now available at <code>https://libations</code>, with a valid LetsEncrypt certificate, on all of my machines! 🎉</p><h2 id="summary">Summary <span><a href="#summary" aria-label="Anchor">#</a></span></h2><p>This was a really fun project. It felt like a fun way to explore <code>tsnet</code>, and resulted in something that I’ve used a lot over the past year. I don’t have many plans to adjust things in the near future - though I do find myself wanting a nice interface to add new recipes from time to time.</p><p>And now for the twist: three weeks ago I gave up drinking alcohol (likely for good), so now I’m on a mission to find some non-alcoholic recipes to make life a little tastier! I suspect this will be hard work - and I’ll certainly miss some of my favourites, but my wife and I have already found some compelling alternatives.</p><p>If you’ve got a favourite recipe (alcoholic or not) and you liked the article, then perhaps open a PR and add it to the <a href="https://github.com/jnsgruk/libations/blob/main/static/sample.json" target="_blank" rel="noreferrer">sample recipes file</a>!</p></div></section></article></div>
  </body>
</html>
