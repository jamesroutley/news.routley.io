<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fathy.fr/carbonyl">Original</a>
    <h1>Forking Chrome to render in a terminal</h1>
    
    <div id="readability-page-1" class="page"><div id="root"><div><main>
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->
<!-- -->

<blockquote>
<p>January 27, 2023</p>
</blockquote>
<!-- -->
<p>I wrote about <a href="https://fathy.fr/html2svg">forking Chrome to turn HTML to SVG</a> two months ago, today we&#39;re going to do something similar by making it render into a terminal.</p>
<p>Let me introduce you to <a href="https://github.com/fathyb/carbonyl" target="_blank">the Carbonyl web browser</a>!</p>
<h2 id="drawing">Drawing<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#drawing"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div><div><div><p>There isn&#39;t much you can draw in a terminal, you&#39;re guaranteed to be able to render monospace characters in a fixed grid, and that&#39;s it. Escape sequences exist to perform actions like moving the cursor, changing the text color, or mouse tracking. Some came from the days of physical terminals like the DEC VT100, others came from the xterm project.</p><p>Assuming a popular terminal emulator, we can:</p><ul>
<li>Move the cursor</li>
<li>Write Unicode characters</li>
<li>Set a character&#39;s background and foreground color</li>
<li>Use a 6x6x6 RGB palette, or 24 bits RGB if <code>COLORTERM</code> is set the <code>truecolor</code></li>
</ul><p>One of the unicode characters we can render is the lower half block element <code>U+2584</code>: <code>▄</code>. Knowing that cells generally have an aspect ratio of 1:2, we can render perfectly square pixels by setting the background color to the top pixel color, and the foregound color to the bottom pixel color.</p></div></div></div>
<hr/>
<p>Let&#39;s hook <code>html2svg</code>&#39;s output into a Rust program:</p>
<div><p><a href="https://fathy.fr/assets/32b4d7552f48aa964ea3.png" target="_blank"><img src="https://fathy.fr/assets/32b4d7552f48aa964ea3.png" alt="The text is now correctly hidden"/></a></p><div><pre><code><span>fn</span> <span>move_cursor</span><span>(</span><span>(</span>x<span>,</span> y<span>)</span><span>:</span> <span>(</span><span>usize</span><span>,</span> <span>usize</span><span>)</span><span>)</span> <span>{</span>
    <span>println!</span><span>(</span><span>&#34;\x1b[{};{}H&#34;</span><span>,</span> y <span>+</span> <span>1</span><span>,</span> x <span>+</span> <span>1</span><span>)</span>
<span>}</span>

<span>fn</span> <span>set_foreground</span><span>(</span><span>(</span>r<span>,</span> g<span>,</span> b<span>)</span><span>:</span> <span>(</span><span>u8</span><span>,</span> <span>u8</span><span>,</span> <span>u8</span><span>)</span><span>)</span> <span>{</span>
    <span>println!</span><span>(</span><span>&#34;\x1b[38;2;{};{};{}m&#34;</span><span>,</span> r<span>,</span> g<span>,</span> b<span>)</span>
<span>}</span>

<span>fn</span> <span>set_background</span><span>(</span><span>(</span>r<span>,</span> g<span>,</span> b<span>)</span><span>:</span> <span>(</span><span>u8</span><span>,</span> <span>u8</span><span>,</span> <span>u8</span><span>)</span><span>)</span> <span>{</span>
    <span>println!</span><span>(</span><span>&#34;\x1b[48;2;{};{};{}m&#34;</span><span>,</span> r<span>,</span> g<span>,</span> b<span>)</span>
<span>}</span>

<span>fn</span> <span>print_pixels_pair</span><span>(</span>
    top<span>:</span> <span>(</span><span>u8</span><span>,</span> <span>u8</span><span>,</span> <span>u8</span><span>)</span><span>,</span>
    bottom<span>:</span> <span>(</span><span>u8</span><span>,</span> <span>u8</span><span>,</span> <span>u8</span><span>)</span><span>,</span>
    cursor<span>:</span> <span>(</span><span>usize</span><span>,</span> <span>usize</span><span>)</span>
<span>)</span> <span>{</span>
    <span>move_cursor</span><span>(</span>cursor<span>)</span><span>;</span>
    <span>set_background</span><span>(</span>top<span>)</span><span>;</span>
    <span>set_foreground</span><span>(</span>bottom<span>)</span><span>;</span>
    <span>println!</span><span>(</span><span>&#34;▄&#34;</span><span>)</span><span>;</span>
<span>}</span>
</code></pre></div></div>
<hr/>
<p>Not bad. To render text, we need to create a new Skia device using C++, lets call it <code>TextCaptureDevice</code>. We&#39;ll make it call a <code>draw_text</code> function written in Rust. Just like in <code>html2svg</code>, we need to convert glyph IDs into unicode characters.</p>
<div><p><a href="https://fathy.fr/assets/21f52779391c0364080d.png" target="_blank"><img src="https://fathy.fr/assets/21f52779391c0364080d.png" alt="The text is now correctly hidden"/></a></p><div><pre><code><span>class</span> <span>TextCaptureDevice</span><span>:</span> <span><span>public</span> <span>SkClipStackDevice</span></span> <span>{</span>
  <span>void</span> <span>onDrawGlyphRunList</span><span>(</span>SkCanvas<span>*</span><span>,</span>
                          <span>const</span> sktext<span>::</span>GlyphRunList<span>&amp;</span> glyphRunList<span>,</span>
                          <span>const</span> SkPaint<span>&amp;</span><span>,</span>
                          <span>const</span> SkPaint<span>&amp;</span> paint<span>)</span> <span>override</span> <span>{</span>
    <span>// Get the text position</span>
    <span>auto</span> position <span>=</span> <span>localToDevice</span><span>(</span><span>)</span><span>.</span><span>mapRect</span><span>(</span>glyphRunList<span>.</span><span>origin</span><span>(</span><span>)</span><span>)</span><span>;</span>

    <span>for</span> <span>(</span><span>auto</span><span>&amp;</span> glyphRun <span>:</span> glyphRunList<span>)</span> <span>{</span>
      <span>auto</span> runSize <span>=</span> glyphRun<span>.</span><span>runSize</span><span>(</span><span>)</span><span>;</span>
      SkAutoSTArray<span>&lt;</span><span>64</span><span>,</span> SkUnichar<span>&gt;</span> <span>unichars</span><span>(</span>runSize<span>)</span><span>;</span>

      <span>// Convert glyph IDs to Unicode characters</span>
      <span>SkFontPriv</span><span>::</span><span>GlyphsToUnichars</span><span>(</span>glyphRun<span>.</span><span>font</span><span>(</span><span>)</span><span>,</span>
                                  glyphRun<span>.</span><span>glyphsIDs</span><span>(</span><span>)</span><span>.</span><span>data</span><span>(</span><span>)</span><span>,</span>
                                  runSize<span>,</span>
                                  unichars<span>.</span><span>get</span><span>(</span><span>)</span><span>)</span><span>;</span>

      <span>// Draw that text on the terminal</span>
      <span>draw_text</span><span>(</span>unichars<span>.</span><span>data</span><span>(</span><span>)</span><span>,</span> runSize<span>,</span> position<span>,</span> paint<span>.</span><span>getColor</span><span>(</span><span>)</span><span>)</span><span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>
<hr/>
<p>Better! But the text is scrambled at the center. Our <code>TextCaptureDevice</code> does not account for occlusion, drawing a rectangle does not clear the text behind it.</p>
<p><a href="https://fathy.fr/assets/72599f231e123b8c1537.png" target="_blank"><img src="https://fathy.fr/assets/72599f231e123b8c1537.png" alt=""/></a></p>
<p>Let&#39;s add some code to the <code>drawRect</code> and <code>drawRRect</code> methods to clear the text if we&#39;re filling with a solid color:</p>
<div><p><a href="https://fathy.fr/assets/57a89b4c81a3f81ec068.png" target="_blank"><img src="https://fathy.fr/assets/57a89b4c81a3f81ec068.png" alt="The text is now correctly hidden"/></a></p><div><pre><code><span>void</span> <span>drawRRect</span><span>(</span><span>const</span> SkRRect<span>&amp;</span> rect<span>,</span> <span>const</span> SkPaint<span>&amp;</span> paint<span>)</span> <span>override</span> <span>{</span>
    <span>drawRect</span><span>(</span>rect<span>.</span><span>rect</span><span>(</span><span>)</span><span>,</span> paint<span>)</span><span>;</span>
<span>}</span>

<span>void</span> <span>drawRect</span><span>(</span><span>const</span> SkRect<span>&amp;</span> rect<span>,</span> <span>const</span> SkPaint<span>&amp;</span> paint<span>)</span> <span>override</span> <span>{</span>
    <span>if</span> <span>(</span>
        paint<span>.</span><span>getStyle</span><span>(</span><span>)</span> <span>==</span> SkPaint<span>::</span>Style<span>::</span>kFill_Style <span>&amp;&amp;</span>
        paint<span>.</span><span>getAlphaf</span><span>(</span><span>)</span> <span>==</span> <span>1.0</span>
    <span>)</span> <span>{</span>
        <span>clear_text</span><span>(</span><span>localToDevice</span><span>(</span><span>)</span><span>.</span><span>mapRect</span><span>(</span>rect<span>)</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div>
<hr/>
<p>The gray background behind text elements is caused by the software rasterizer rendering text in our bitmap. Let&#39;s remove it:</p>
<div><p><a href="https://fathy.fr/assets/a7af4a712a6811423325.png" target="_blank"><img src="https://fathy.fr/assets/a7af4a712a6811423325.png" alt="The text is now correctly hidden"/></a></p><div><div><div><pre><code>void SkBitmapDevice::onDrawGlyphRunList(SkCanvas* canvas,
<span><span> </span><span>                                       const sktext::GlyphRunList&amp; glyphRunList,
</span><span> </span><span>                                       const SkPaint&amp; initialPaint,
</span><span> </span><span>                                       const SkPaint&amp; drawingPaint) {
</span></span><span><span>-</span><span>    SkASSERT(!glyphRunList.hasRSXForm());
</span><span>-</span><span>    LOOP_TILER( drawGlyphRunList(canvas, &amp;fGlyphPainter, glyphRunList, drawingPaint), nullptr )
</span></span>}
</code></pre></div></div></div></div>
<hr/>
<p>That was the easy part, let&#39;s handle inputs!</p>
<h2 id="input">Input<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#input"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div><div><pre><code><span>fn</span> <span>report_mouse_move</span><span>(</span><span>(</span>x<span>,</span> y<span>)</span><span>:</span> <span>(</span><span>usize</span><span>,</span> <span>usize</span><span>)</span><span>)</span> <span>{</span>
    <span>write!</span><span>(</span><span>get_stdin</span><span>(</span><span>)</span><span>,</span> <span>&#34;\x1b[&lt;35;{};{}M&#34;</span><span>,</span> y <span>+</span> <span>1</span><span>,</span> x <span>+</span> <span>1</span><span>)</span>
<span>}</span>
<span>fn</span> <span>report_mouse_down</span><span>(</span><span>(</span>x<span>,</span> y<span>)</span><span>:</span> <span>(</span><span>usize</span><span>,</span> <span>usize</span><span>)</span><span>)</span> <span>{</span>
    <span>write!</span><span>(</span><span>get_stdin</span><span>(</span><span>)</span><span>,</span> <span>&#34;\x1b[&lt;0;{};{}M&#34;</span><span>,</span> y <span>+</span> <span>1</span><span>,</span> x <span>+</span> <span>1</span><span>)</span>
<span>}</span>
<span>fn</span> <span>report_mouse_up</span><span>(</span><span>(</span>x<span>,</span> y<span>)</span><span>:</span> <span>(</span><span>usize</span><span>,</span> <span>usize</span><span>)</span><span>)</span> <span>{</span>
    <span>write!</span><span>(</span><span>get_stdin</span><span>(</span><span>)</span><span>,</span> <span>&#34;\x1b[&lt;0;{};{}m&#34;</span><span>,</span> y <span>+</span> <span>1</span><span>,</span> x <span>+</span> <span>1</span><span>)</span>
<span>}</span>
</code></pre></div><p>Some sequences exist to get a terminal emulator to track and report mouse events. For example, if you print <code>\x1b[?1003h</code>, the terminal should start sending events using this format:</p></div>
<p>These are similar to the sequences we use for styling our output. The <code>\x1b[</code> prefix is called the Control Sequence Introducer.</p>
<div><div><pre><code>carbonyl<span>::</span>browser<span>-&gt;</span><span>BrowserMainThread</span><span>(</span><span>)</span><span>-&gt;</span><span>PostTask</span><span>(</span>
    FROM_HERE<span>,</span>
    base<span>::</span><span>BindOnce</span><span>(</span>
        <span>&amp;</span>HeadlessBrowserImpl<span>::</span>OnMouseDownInput<span>,</span>
        x<span>,</span>
        y
    <span>)</span>
<span>)</span><span>;</span>
</code></pre></div><p>We need to notify the browser to wrap this up, but there is a catch: we
need to block a thread to read stdin, but the browser methods should be
called from the main thread. Thankfully, messages passing is available
almost everywhere through the
<a href="https://source.chromium.org/chromium/chromium/src/+/main:base/task/task_runner.h;drc=63e1f9974bc57b0ca12d790b2a73e5ba7f5cec6e;l=60" target="_blank"><code>TaskRunner</code></a>
class.</p></div>
<div><p><figure><video src="/assets/26fa84f7239e4c1fa504.mp4" autoplay="" loop="" controls=""></video><figcaption>Google recommending me Chrome, lol</figcaption></figure></p><div><div><div><pre><code><span>for</span> <span>&amp;</span>key <span>in</span> input <span>{</span>
    sequence <span>=</span> <span>match</span> sequence <span>{</span>
        <span>Sequence</span><span>::</span><span>Char</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
            <span>0x1b</span> <span>=&gt;</span> <span>Sequence</span><span>::</span><span>Escape</span><span>,</span>
            <span>0x03</span> <span>=&gt;</span> <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>Exit</span><span>)</span><span>,</span>
            key <span>=&gt;</span> <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key <span>}</span><span>)</span><span>,</span>
        <span>}</span><span>,</span>
        <span>Sequence</span><span>::</span><span>Escape</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
            <span>b&#39;[&#39;</span> <span>=&gt;</span> <span>Sequence</span><span>::</span><span>Control</span><span>,</span>
            <span>b&#39;P&#39;</span> <span>=&gt;</span> <span>Sequence</span><span>::</span><span>DeviceControl</span><span>(</span><span>DeviceControl</span><span>::</span><span>new</span><span>(</span><span>)</span><span>)</span><span>,</span>
            <span>0x1b</span> <span>=&gt;</span>
                <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key<span>:</span> <span>0x1b</span> <span>}</span><span>;</span> <span>continue</span><span>)</span><span>,</span>
            key <span>=&gt;</span> <span>{</span>
                <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key<span>:</span> <span>0x1b</span> <span>}</span><span>)</span><span>;</span>
                <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key <span>}</span><span>)</span>
            <span>}</span>
        <span>}</span><span>,</span>
        <span>Sequence</span><span>::</span><span>Control</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
            <span>b&#39;&lt;&#39;</span> <span>=&gt;</span> <span>Sequence</span><span>::</span><span>Mouse</span><span>(</span><span>Mouse</span><span>::</span><span>new</span><span>(</span><span>)</span><span>)</span><span>,</span>
            <span>b&#39;A&#39;</span> <span>=&gt;</span> <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key<span>:</span> <span>0x26</span> <span>}</span><span>)</span><span>,</span>
            <span>b&#39;B&#39;</span> <span>=&gt;</span> <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key<span>:</span> <span>0x28</span> <span>}</span><span>)</span><span>,</span>
            <span>b&#39;C&#39;</span> <span>=&gt;</span> <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key<span>:</span> <span>0x27</span> <span>}</span><span>)</span><span>,</span>
            <span>b&#39;D&#39;</span> <span>=&gt;</span> <span>emit!</span><span>(</span><span>Event</span><span>::</span><span>KeyPress</span> <span>{</span> key<span>:</span> <span>0x25</span> <span>}</span><span>)</span><span>,</span>
            _ <span>=&gt;</span> <span>Sequence</span><span>::</span><span>Char</span><span>,</span>
        <span>}</span><span>,</span>
        <span>Sequence</span><span>::</span><span>Mouse</span><span>(</span><span>ref</span> <span>mut</span> mouse<span>)</span> <span>=&gt;</span> <span>parse!</span><span>(</span>mouse<span>,</span> key<span>)</span><span>,</span>
        <span>Sequence</span><span>::</span><span>DeviceControl</span><span>(</span><span>ref</span> <span>mut</span> dcs<span>)</span> <span>=&gt;</span> <span>parse!</span><span>(</span>dcs<span>,</span> key<span>)</span><span>,</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div></div></div>
<h2 id="pipe">Pipe<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#pipe"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<p>We have something that sorts of work, at the cost of a steady 400% CPU usage, and that&#39;s not counting iTerm2 which uses ~200%. We&#39;ve got a few problems:</p>
<ul>
<li>We need too much resources to render at 5 FPS</li>
<li>We render every time, even when nothing changes</li>
<li>We print all characters even if they didn&#39;t change on an individual level</li>
</ul>
<p>Modern browsers employ a multi-process architecture to improve security. It separates websites into different processes, reducing the potential damage caused by vulnerabilities. The renderer process is running in an OS-level sandboxed environment that blocks certain system calls, such as file-system access. The GPU process, is also considered unprivileged and cannot reach renderer process in order to protect against vulnerabilities in GPU APIs such as WebGL. In contrast, the browser process, considered privileged, can communicate freely with any process.</p>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1347 764.1508768480842" width="2694" height="1528.3017536961684"><g stroke-linecap="round" transform="translate(730 270) rotate(0 210 60)"><path d="M30 0 M30 0 C157.04 0.46, 284.43 0.31, 390 0 M30 0 C135.95 -1.31, 242.95 -1.78, 390 0 M390 0 C411.81 2.47, 420.51 6.29, 420 30 M390 0 C413.02 -4.44, 422.08 8.32, 420 30 M420 30 C419.91 45.26, 417.11 56.14, 420 90 M420 30 C420.97 50.46, 418.25 69.52, 420 90 M420 90 C419.23 111.17, 407.26 121.67, 390 120 M420 90 C421.66 111.18, 411.88 117.61, 390 120 M390 120 C256.58 125.8, 126.15 123.73, 30 120 M390 120 C248.98 122.52, 105.46 120.63, 30 120 M30 120 C8.72 119.2, -0.04 106.2, 0 90 M30 120 C6.71 119.94, -2.21 111.74, 0 90 M0 90 C0.74 66.11, -2.59 45.15, 0 30 M0 90 C0.96 76.74, -2.03 60.13, 0 30 M0 30 C0.34 9.9, 8.66 -3.41, 30 0 M0 30 C1.19 14.25, 8.86 3.42, 30 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(861.6728068622378 289.921875) rotate(0 76.5 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Google Chrome</text></g><g stroke-linecap="round" transform="translate(192.2109375 270.765625) rotate(0 200.34179687500003 58.0078125)"><path d="M29 0 M29 0 C161.85 -4.09, 295.82 -5.23, 371.68 0 M29 0 C140.36 1.45, 250.69 -0.6, 371.68 0 M371.68 0 C393.64 -3.86, 402.49 8.21, 400.68 29 M371.68 0 C387.95 -2.91, 398.25 10.44, 400.68 29 M400.68 29 C401.09 48.05, 396.68 69.49, 400.68 87.01 M400.68 29 C399.31 49.65, 398.33 69.96, 400.68 87.01 M400.68 87.01 C402.13 107.38, 392.65 113.93, 371.68 116.02 M400.68 87.01 C403.64 105.48, 395.2 111.87, 371.68 116.02 M371.68 116.02 C249.1 115.04, 122.52 117.22, 29 116.02 M371.68 116.02 C246.44 111.9, 122.03 110.91, 29 116.02 M29 116.02 C6.8 115.96, -1.92 107.86, 0 87.01 M29 116.02 C12.82 119.43, -1.19 108.22, 0 87.01 M0 87.01 C-1.98 72.58, 0.34 59.52, 0 29 M0 87.01 C1.28 66.6, 0.44 44.59, 0 29 M0 29 C1.04 13.37, 8.67 2.98, 29 0 M0 29 C1.71 7.26, 7.98 -2.34, 29 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(848.4401120382331 348.29664913910244) rotate(0 88.5 12)"><text x="88.5" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">Browser Process</text></g><g stroke-linecap="round" transform="translate(470 610) rotate(0 203.5 57.5)"><path d="M28.75 0 M28.75 0 C129.22 1.79, 228.12 3.78, 378.25 0 M28.75 0 C156.06 2.97, 282.25 3.75, 378.25 0 M378.25 0 C394.75 -2.53, 404.89 10.26, 407 28.75 M378.25 0 C398.86 -2.45, 404.85 10.77, 407 28.75 M407 28.75 C407.86 42.35, 406.9 61.97, 407 86.25 M407 28.75 C406.94 48.2, 407.03 65.59, 407 86.25 M407 86.25 C409.57 104.66, 401.06 111.4, 378.25 115 M407 86.25 C409.99 102.58, 396.66 119.34, 378.25 115 M378.25 115 C278.1 117.02, 172.39 117.5, 28.75 115 M378.25 115 C279.45 110.66, 181.9 111.17, 28.75 115 M28.75 115 C12.32 117.97, -1.03 107.05, 0 86.25 M28.75 115 C7.54 113.04, -0.72 102.57, 0 86.25 M0 86.25 C2.08 64.62, -2.57 50.96, 0 28.75 M0 86.25 C0.9 70.99, -0.11 53.53, 0 28.75 M0 28.75 C1.49 7.49, 8.11 -2.03, 28.75 0 M0 28.75 C-3.37 12.89, 10.35 3.27, 28.75 0" stroke="white" stroke-width="1" fill="none"></path></g><g stroke-opacity="0.5" fill-opacity="0.5" stroke-linecap="round" transform="translate(10 610) rotate(0 203.49999999999997 57.5)"><path d="M28.75 0 M28.75 0 C113.3 2.59, 200.19 1.74, 378.25 0 M28.75 0 C101.75 3.91, 172.7 3.56, 378.25 0 M378.25 0 C395.3 0.67, 408.26 7.45, 407 28.75 M378.25 0 C395.27 1.18, 406.8 5.69, 407 28.75 M407 28.75 C408.4 48.15, 408.7 66.37, 407 86.25 M407 28.75 C408.23 47.36, 408.7 67.67, 407 86.25 M407 86.25 C410.64 101.82, 400.02 112.53, 378.25 115 M407 86.25 C406.25 109.75, 397.02 116.72, 378.25 115 M378.25 115 C245.54 111.87, 116.74 112.68, 28.75 115 M378.25 115 C305.95 115.43, 235.8 115.91, 28.75 115 M28.75 115 C8.55 116.63, -1.78 103.71, 0 86.25 M28.75 115 C8.86 112.15, 0.45 105.24, 0 86.25 M0 86.25 C-3.2 66.23, -0.69 44.19, 0 28.75 M0 86.25 C-0.8 75.4, 0.44 60.52, 0 28.75 M0 28.75 C-1.47 7.55, 6.65 2.87, 28.75 0 M0 28.75 C0.77 12.85, 6.45 3.24, 28.75 0" stroke="white" stroke-width="1" fill="none"></path></g><g stroke-opacity="0.5" fill-opacity="0.5" stroke-linecap="round" transform="translate(930 610) rotate(0 203.5 57.5)"><path d="M28.75 0 M28.75 0 C124.39 -1.73, 214.4 -0.36, 378.25 0 M28.75 0 C99.03 0.84, 170.36 1.88, 378.25 0 M378.25 0 C398.67 -2.13, 405.13 10.61, 407 28.75 M378.25 0 C397.21 -3.89, 409.34 11.69, 407 28.75 M407 28.75 C408.43 38.37, 408.92 54.92, 407 86.25 M407 28.75 C408.76 47.1, 409.29 64.41, 407 86.25 M407 86.25 C409.6 102.95, 396.76 118.77, 378.25 115 M407 86.25 C406.6 107.14, 400.79 117.96, 378.25 115 M378.25 115 C290.51 113.52, 201.34 111.68, 28.75 115 M378.25 115 C274.75 117.69, 169.13 117.25, 28.75 115 M28.75 115 C7.81 113.3, -0.63 102.94, 0 86.25 M28.75 115 C10.04 114.82, 2.49 107.76, 0 86.25 M0 86.25 C0.65 73.14, -2.66 63.75, 0 28.75 M0 86.25 C1.03 62.64, -0.45 40.1, 0 28.75 M0 28.75 C-2.93 12.46, 10.25 2.84, 28.75 0 M0 28.75 C-3.13 12.82, 13.01 -1.44, 28.75 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(491.5466383381638 625.914296502428) rotate(0 182 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Google Chrome Helper (Renderer)</text></g><g stroke-linecap="round"><g transform="translate(951.9118742957429 391.2) rotate(0 -134.21471413755773 108.71608656182883)"><path d="M1.84 -2.7 C-3.02 13.5, 12.34 76.16, -28.79 94.58 C-69.91 113.01, -205 87.39, -244.92 107.84 C-284.83 128.28, -264.76 199.36, -268.25 217.27 M-0.61 2.01 C-5.76 18.83, 9.41 79.66, -30.34 97.66 C-70.09 115.65, -199.41 89.57, -239.1 109.98 C-278.78 130.4, -263.51 202.56, -268.47 220.13" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(951.9118742957429 391.2) rotate(0 -134.21471413755773 108.71608656182883)"><path d="M-281.53 193.38 C-276.78 197.73, -274.97 207.21, -267.8 221.39 M-277.76 189.89 C-274.65 199.49, -275.1 206.06, -268.86 220.72" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(951.9118742957429 391.2) rotate(0 -134.21471413755773 108.71608656182883)"><path d="M-261.02 194.15 C-262.68 198.52, -267.28 207.76, -267.8 221.39 M-257.25 190.65 C-259.2 200.17, -264.7 206.55, -268.86 220.72" stroke="white" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(628.274146870492 608) rotate(0 -127.43022652601434 -109.8545016936958)"><path d="M1.26 -1.02 C-4.09 -17.57, 8.42 -83.18, -30.28 -101.96 C-68.97 -120.75, -193.68 -94.27, -230.89 -113.72 C-268.1 -133.18, -249.39 -201.56, -253.53 -218.69 M-1.5 -4.04 C-6.12 -20.02, 13.78 -81.58, -24.89 -99.3 C-63.56 -117.02, -195.57 -90.76, -233.5 -110.36 C-271.43 -129.96, -249.51 -199.42, -252.47 -216.89" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(628.274146870492 608) rotate(0 -127.43022652601434 -109.8545016936958)"><path d="M-245.53 -190.75 C-249.12 -200.66, -248.99 -207.82, -254.6 -218.76 M-243.05 -187.18 C-248.48 -197.18, -249.91 -206.41, -253.84 -216.06" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(628.274146870492 608) rotate(0 -127.43022652601434 -109.8545016936958)"><path d="M-266.01 -192.09 C-262.13 -201.69, -254.52 -208.36, -254.6 -218.76 M-263.53 -188.51 C-262.29 -197.73, -257.04 -206.53, -253.84 -216.06" stroke="white" stroke-width="1" fill="none"></path></g></g><mask></mask><g transform="translate(731 430) rotate(0 89 19.5)"><text x="178" y="15.5" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr">mouseMove(250, 250)</text><text x="178" y="35" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr">mouseDown(250, 250)</text></g><g transform="translate(410 430) rotate(0 66 10)"><text x="0" y="16" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">glBindBuffer()</text></g><g transform="translate(410 450) rotate(0 61.5 10)"><text x="0" y="16" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">glDrawArray()</text></g><g stroke-linecap="round" transform="translate(310 10) rotate(0 73 70.5)"><path d="M109.02 8.55 C118.25 12.41, 127.16 20.05, 133.3 28.58 C139.44 37.1, 144.14 49.28, 145.85 59.71 C147.57 70.13, 146.85 81.24, 143.58 91.12 C140.3 101, 133.4 111.24, 126.19 118.98 C118.97 126.72, 110.17 133.7, 100.27 137.57 C90.38 141.43, 77.48 143.14, 66.8 142.17 C56.12 141.2, 44.79 136.95, 36.19 131.73 C27.58 126.52, 20.92 118.92, 15.17 110.88 C9.43 102.84, 3.55 93.68, 1.73 83.49 C-0.1 73.29, 1.67 59.83, 4.22 49.69 C6.78 39.55, 10.29 30.07, 17.07 22.66 C23.86 15.25, 35.21 9.23, 44.95 5.23 C54.69 1.24, 63.98 -2.31, 75.5 -1.3 C87.02 -0.3, 106.8 7.98, 114.07 11.27 C121.34 14.56, 119.55 17.4, 119.12 18.45 M101.44 3.91 C111.35 6.96, 121.16 15.91, 128.43 24.17 C135.7 32.44, 142.81 43.97, 145.06 53.5 C147.3 63.03, 144.07 71.6, 141.92 81.35 C139.78 91.11, 138.1 103.92, 132.18 112.05 C126.25 120.18, 115.6 124.85, 106.38 130.13 C97.15 135.41, 87.32 142.49, 76.81 143.71 C66.31 144.94, 52.98 142.23, 43.34 137.47 C33.7 132.71, 25.96 123.47, 18.98 115.14 C12 106.82, 4.79 96.73, 1.46 87.51 C-1.86 78.29, -3.17 69.26, -0.98 59.84 C1.2 50.42, 8.32 39.24, 14.58 31 C20.84 22.77, 26.97 15.73, 36.58 10.42 C46.18 5.11, 61.09 -0.33, 72.2 -0.88 C83.3 -1.42, 98.72 5.97, 103.21 7.14 C107.71 8.3, 99.87 5.28, 99.2 6.11" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(349.5 46.5) rotate(0 33.5 32)"><text x="33.5" y="26" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="28px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">👀</text><text x="33.5" y="58" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="28px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">Eyes</text></g><g stroke-linecap="round" transform="translate(590 10) rotate(0 73 70.5)"><path d="M18.72 22.62 C24.58 14.83, 35.59 9.95, 45.3 6.33 C55.01 2.71, 66.73 0.32, 76.96 0.89 C87.19 1.47, 97.56 4.76, 106.7 9.78 C115.84 14.8, 125.72 22.75, 131.78 31.01 C137.84 39.28, 141.34 49.69, 143.06 59.37 C144.78 69.05, 144.31 79.51, 142.09 89.09 C139.87 98.66, 136.38 108.87, 129.75 116.83 C123.11 124.8, 112.1 133.01, 102.28 136.86 C92.47 140.7, 81.79 140.74, 70.84 139.91 C59.89 139.08, 46.13 136.55, 36.56 131.86 C26.99 127.18, 19.66 120.18, 13.44 111.79 C7.22 103.39, 1.04 91.69, -0.76 81.5 C-2.55 71.3, -6.4 63.52, 2.65 50.63 C11.7 37.73, 38.18 11.93, 53.56 4.12 C68.94 -3.69, 94.58 3.02, 94.93 3.77 M43.16 6.17 C52.19 1.77, 66.29 1.62, 76.32 1.55 C86.35 1.48, 94.15 1.38, 103.33 5.75 C112.51 10.12, 124.67 19.74, 131.37 27.76 C138.07 35.78, 141.33 43.39, 143.52 53.85 C145.72 64.32, 147.1 79.87, 144.55 90.55 C142.01 101.24, 134.97 110.86, 128.26 117.96 C121.54 125.05, 113.93 129.56, 104.25 133.14 C94.58 136.73, 81.31 139.07, 70.2 139.46 C59.1 139.84, 46.75 139.47, 37.61 135.45 C28.47 131.42, 21.75 123.42, 15.39 115.3 C9.02 107.17, 1.25 97.2, -0.57 86.7 C-2.39 76.2, 1.32 62.29, 4.46 52.29 C7.61 42.28, 12.26 34.47, 18.3 26.65 C24.35 18.83, 36.51 8.53, 40.73 5.34 C44.94 2.15, 42.63 6.3, 43.62 7.49" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(621.5 46.5) rotate(0 41.5 32)"><text x="41.5" y="26" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="28px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">🧠</text><text x="41.5" y="58" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="28px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">Brain</text></g><g stroke-linecap="round" transform="translate(869.318882426343 10) rotate(0 73 70.5)"><path d="M59.78 2.04 C69.4 -0.5, 82.03 0.43, 91.94 3.1 C101.84 5.76, 111.3 11.28, 119.2 18.04 C127.1 24.81, 135.17 34.38, 139.33 43.7 C143.49 53.02, 144.63 64.13, 144.17 73.96 C143.7 83.8, 140.79 93.9, 136.53 102.7 C132.28 111.5, 126.75 120.36, 118.63 126.77 C110.5 133.18, 98.26 139.33, 87.8 141.15 C77.34 142.97, 66.49 140.63, 55.86 137.71 C45.24 134.79, 32.39 130.04, 24.06 123.6 C15.73 117.17, 10.21 108.55, 5.89 99.1 C1.57 89.65, -2.25 77.25, -1.86 66.9 C-1.48 56.55, 2.89 45.59, 8.21 37.01 C13.52 28.43, 18.15 21.66, 30.02 15.43 C41.88 9.2, 68.24 1.51, 79.37 -0.36 C90.51 -2.23, 97.32 2.99, 96.84 4.2 M32.24 14.63 C39.25 7.83, 47.57 1.06, 57.74 -0.94 C67.92 -2.94, 82.84 -0.07, 93.3 2.63 C103.77 5.33, 112.54 8.01, 120.51 15.26 C128.49 22.52, 137.05 35.93, 141.16 46.14 C145.26 56.35, 145.66 67.07, 145.15 76.52 C144.64 85.98, 143.23 94.58, 138.09 102.89 C132.94 111.2, 123.43 119.84, 114.28 126.38 C105.13 132.92, 93.33 139.79, 83.19 142.13 C73.06 144.47, 63.58 143.23, 53.45 140.42 C43.33 137.61, 30.04 132.58, 22.44 125.29 C14.84 118, 11.36 106.23, 7.86 96.69 C4.35 87.16, 1.57 78.27, 1.41 68.08 C1.25 57.9, 2 44.77, 6.89 35.59 C11.79 26.41, 26.55 16.61, 30.77 13.01 C34.99 9.42, 31.97 12.95, 32.22 14.02" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(900.818882426343 46.5) rotate(0 41.5 32)"><text x="41.5" y="26" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="28px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">🤌</text><text x="41.5" y="58" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="28px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">Hands</text></g><g stroke-linecap="round"><g transform="translate(935.0486609819828 149.6799425749015) rotate(0 -0.4261813352072181 57.187294683394065)"><path d="M-0.54 0.82 C-0.47 19.98, -2.19 96.52, -1.93 115.57 M-4.28 -1.2 C-3.1 17.05, 2.76 91.23, 3.43 111.2" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(935.0486609819828 149.6799425749015) rotate(0 -0.4261813352072181 57.187294683394065)"><path d="M-7.29 80.92 C-4.12 91.07, -2.2 97.18, 1.35 113.77 M-7.16 82.42 C-4.95 93.5, -1.45 100.1, 4.9 112.48" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(935.0486609819828 149.6799425749015) rotate(0 -0.4261813352072181 57.187294683394065)"><path d="M13.2 79.72 C11.97 90.05, 9.48 96.41, 1.35 113.77 M13.32 81.22 C9.8 92.26, 7.54 99.2, 4.9 112.48" stroke="white" stroke-width="1" fill="none"></path></g></g><mask></mask><g transform="translate(578.8784669840671 679.8894989044489) rotate(0 82.5 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Render Process</text></g><g stroke-linecap="round"><g transform="translate(458.2949566502142 82.04691014625813) rotate(0 64.30948462329874 -1.149495066976673)"><path d="M1.01 0.72 C23.08 0.02, 108.81 -2.55, 130.5 -3.02 M-1.88 -1.36 C20.09 -1.81, 106.85 -0.53, 128.88 -0.18" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(458.2949566502142 82.04691014625813) rotate(0 64.30948462329874 -1.149495066976673)"><path d="M101.58 11.3 C104.95 9.75, 112.83 8.54, 125.28 2.42 M100.37 10.42 C108.8 8.07, 113.08 2.74, 128.24 -0.58" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(458.2949566502142 82.04691014625813) rotate(0 64.30948462329874 -1.149495066976673)"><path d="M101.88 -9.22 C105.35 -6.01, 113.16 -2.47, 125.28 2.42 M100.67 -10.1 C108.96 -7.55, 113.16 -7.99, 128.24 -0.58" stroke="white" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(868.3281103955014 79.37086802206923) rotate(0 -63.97348310991066 1.1776855524617709)"><path d="M1.14 -1.46 C-20.33 -1.82, -106.46 -1.13, -127.83 -1.47 M-1.68 3.92 C-23.46 3.93, -108.12 2.81, -129.09 1.87" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(868.3281103955014 79.37086802206923) rotate(0 -63.97348310991066 1.1776855524617709)"><path d="M-29.12 11.4 C-18.38 8.78, -11.75 4.28, -1.33 -2.11 M-25.57 10.11 C-16.92 2.86, -5.44 0.11, 1.12 -3.36" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(868.3281103955014 79.37086802206923) rotate(0 -63.97348310991066 1.1776855524617709)"><path d="M-29.14 -9.13 C-18.28 -4.85, -11.65 -2.44, -1.33 -2.11 M-25.59 -10.41 C-16.96 -9.57, -5.48 -4.23, 1.12 -3.36" stroke="white" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(382.5210329235799 270.0708617603566) rotate(0 0.5661792292823691 -60.56847381778317)"><path d="M1.8 -0.53 C1.87 -20.39, 1.71 -100.73, 1.54 -120.61 M-0.67 -3.29 C-0.85 -22.76, 0.58 -99.29, 0.69 -118.34" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(382.5210329235799 270.0708617603566) rotate(0 0.5661792292823691 -60.56847381778317)"><path d="M9.83 -86.39 C3.91 -96.95, 1.67 -109.86, 4.46 -118.69 M9.58 -91.72 C6.19 -99.85, 3.47 -110.91, -0.74 -118.37" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(382.5210329235799 270.0708617603566) rotate(0 0.5661792292823691 -60.56847381778317)"><path d="M-10.69 -86.65 C-9.62 -97.39, -4.87 -110.2, 4.46 -118.69 M-10.94 -91.98 C-7.4 -100.29, -3.2 -111.25, -0.74 -118.37" stroke="white" stroke-width="1" fill="none"></path></g></g><mask></mask><g transform="translate(811 190.2076543973717) rotate(0 47 19.5)"><text x="94" y="15.5" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr">mechanical</text><text x="94" y="35" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr">energy</text></g><g transform="translate(410 190) rotate(0 70.5 19.5)"><text x="0" y="15.5" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">electromagnetic</text><text x="0" y="35" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">energy</text></g><g transform="translate(544.2040650782787 734.1508768480842) rotate(0 127.00000000000003 10)"><text x="145" y="16" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr">GitHub</text></g><g transform="translate(31 730) rotate(0 183.5 10)"><text x="380" y="16" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr" opacity="0.5">superintelligent ants risks - Google Search</text></g><g stroke-opacity="0.5" fill-opacity="0.5" transform="translate(30 630) rotate(0 182 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Google Chrome Helper (Renderer)</text></g><g stroke-opacity="0.5" fill-opacity="0.5" transform="translate(117.33182864590333 683.9752024020208) rotate(0 82.5 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Render Process</text></g><g stroke-opacity="0.5" fill-opacity="0.5" transform="translate(950 630) rotate(0 182 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Google Chrome Helper (Renderer)</text></g><g stroke-opacity="0.5" fill-opacity="0.5" transform="translate(1037.3318286459032 683.9752024020208) rotate(0 82.5 12)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Render Process</text></g><g transform="translate(971 730) rotate(0 174 10)"><text x="308" y="16" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="16px" fill="white" text-anchor="end" style="white-space:pre" direction="ltr" opacity="0.5">diy ant farm keyboard - YouTube</text></g><g transform="translate(228.90144904599777 285.03811366027253) rotate(0 153 11.999999999999986)"><text x="0" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Google Chrome Helper (GPU)</text></g><g transform="translate(313.4348661962879 349.77106768080404) rotate(0 65 12)"><text x="65" y="20" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">GPU Process</text></g></svg>
<div><div><figure><p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 460" width="1400" height="920"><g stroke-linecap="round" transform="translate(10 190) rotate(0 150 40)"><path d="M20 0 M20 0 C89.71 2.15, 153.08 1.8, 280 0 M20 0 C91.67 -1.12, 164.37 -2.05, 280 0 M280 0 C294.55 0.65, 297.5 9.13, 300 20 M280 0 C293.47 -0.14, 303.05 2.68, 300 20 M300 20 C300.76 30.79, 302.25 37.43, 300 60 M300 20 C300.79 30.63, 298.77 43.92, 300 60 M300 60 C298.92 70.22, 292.76 82.1, 280 80 M300 60 C303.65 76.88, 289.69 79.88, 280 80 M280 80 C182.81 82.88, 82.82 78.66, 20 80 M280 80 C180.38 83.55, 81.28 84.17, 20 80 M20 80 C5.9 77.15, -0.94 74.36, 0 60 M20 80 C4.43 78.08, -1.16 76.21, 0 60 M0 60 C1.98 48.47, 0.76 37.6, 0 20 M0 60 C-2.66 49.83, -1.77 39.76, 0 20 M0 20 C1.9 5.84, 9.15 0.14, 20 0 M0 20 C2.53 7.39, 10.02 -3.99, 20 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(70 210) rotate(0 89 22)"><text x="89" y="18" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="19.047619047619044px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">Renderer process</text><text x="89" y="40" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="19.047619047619044px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">(main)</text></g><g stroke-linecap="round" transform="translate(190 10) rotate(0 160 30)"><path d="M15 0 M15 0 C84.29 0.75, 156.29 1.62, 305 0 M15 0 C124.83 1, 236.31 0.6, 305 0 M305 0 C318.64 2.81, 317.4 1.25, 320 15 M305 0 C312.23 3.8, 316.37 4.58, 320 15 M320 15 C320.01 25.12, 318.7 35.45, 320 45 M320 15 C321.48 28.32, 317.98 38.65, 320 45 M320 45 C319.81 52.11, 311.55 62.63, 305 60 M320 45 C316.75 50.86, 314.59 62.02, 305 60 M305 60 C219.22 63.56, 131.09 59.02, 15 60 M305 60 C210.32 58.49, 113.62 58.99, 15 60 M15 60 C6.58 61.62, -0.46 52.01, 0 45 M15 60 C8.78 57.52, 2.39 56.34, 0 45 M0 45 C0.8 34.47, -1.65 31.89, 0 15 M0 45 C-1.07 38.57, 1.88 31.21, 0 15 M0 15 C3.63 4.02, 4.85 0.26, 15 0 M0 15 C-2.08 1.22, 1.82 -3.35, 15 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(270 30) rotate(0 84 11)"><text x="0" y="18" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="19.047619047619044px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">Browser process</text></g><g stroke-linecap="round" transform="translate(390 190) rotate(0 150 40)"><path d="M20 0 M20 0 C78.65 -3.16, 135.31 0.38, 280 0 M20 0 C78.2 0.06, 139.19 -0.16, 280 0 M280 0 C290.35 3.41, 296.63 8.51, 300 20 M280 0 C294.86 0.06, 298.98 7.04, 300 20 M300 20 C297.49 27.95, 298.25 36.75, 300 60 M300 20 C299.19 30.23, 301.28 36.94, 300 60 M300 60 C303.99 70.27, 290.64 83.66, 280 80 M300 60 C302.63 75.26, 293.61 76.5, 280 80 M280 80 C214.16 78.62, 145.92 81.64, 20 80 M280 80 C221.04 79.12, 161.29 80.89, 20 80 M20 80 C2.99 83.23, -2.06 75.01, 0 60 M20 80 C9.25 77.12, 2.15 71.41, 0 60 M0 60 C-1.6 48.58, 0.85 39.11, 0 20 M0 60 C-2.43 45.5, 1.13 31.13, 0 20 M0 20 C0.78 5.54, 2.8 -1.35, 20 0 M0 20 C-0.43 9.45, 8.06 1.77, 20 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(450 210) rotate(0 89 22)"><text x="89" y="18" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="19.047619047619044px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">Renderer process</text><text x="89" y="40" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="19.047619047619044px" fill="white" text-anchor="middle" style="white-space:pre" direction="ltr">(iframe)</text></g><g mask="url(#mask-QWNoY6lUo_I-lRB1Zocts)" stroke-linecap="round"><g transform="translate(142.84848484848476 189) rotate(0 104.1087779157383 -60.86877761483192)"><path d="M-1.66 -0.86 C3.14 -11.06, -4.55 -51.56, 27.19 -60.92 C58.94 -70.29, 158.61 -47.06, 188.84 -57.05 C219.06 -67.05, 205.72 -110.54, 208.54 -120.88 M2.64 -3.8 C7.21 -13.72, -5.91 -48.72, 24.98 -58.34 C55.86 -67.96, 157.13 -51.37, 187.94 -61.53 C218.76 -71.69, 206.17 -109.85, 209.88 -119.29" stroke="#6991de" stroke-width="1" fill="none"></path></g><g transform="translate(142.84848484848476 189) rotate(0 104.1087779157383 -60.86877761483192)"><path d="M217.85 -90.67 C214.03 -95.39, 217.32 -102.77, 207.2 -121.25 M218.23 -91.43 C214.43 -99.15, 213.33 -107.5, 209.38 -120.39" stroke="#6991de" stroke-width="1" fill="none"></path></g><g transform="translate(142.84848484848476 189) rotate(0 104.1087779157383 -60.86877761483192)"><path d="M197.34 -91.44 C198.52 -95.73, 206.8 -102.92, 207.2 -121.25 M197.72 -92.2 C200.03 -99.75, 205.03 -107.87, 209.38 -120.39" stroke="#6991de" stroke-width="1" fill="none"></path></g></g><mask id="mask-QWNoY6lUo_I-lRB1Zocts"><rect x="0" y="0" fill="#fff" width="450" height="408"></rect><rect x="164.28880584060266" y="118.43921456949435" fill="#000" width="175" height="24" opacity="1"></rect></mask><g transform="translate(194.28880584060266 118.43921456949434) rotate(0 52.6684569236204 9.692007815673726)"><text x="59" y="19" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="20px" fill="#6991de" text-anchor="middle" style="white-space:pre" direction="ltr">1. Get capture</text></g><g stroke-linecap="round" transform="translate(190 390) rotate(0 160 30)"><path d="M15 0 M15 0 C109.41 -1.4, 208.81 -1.93, 305 0 M15 0 C95.9 1.71, 173.44 1.69, 305 0 M305 0 C315.89 -1.43, 316.25 7.9, 320 15 M305 0 C311.18 3.37, 319.03 3.75, 320 15 M320 15 C321.88 18.71, 316.6 29.55, 320 45 M320 15 C320.81 21.41, 321.35 32.53, 320 45 M320 45 C323.11 57.61, 313.78 63.18, 305 60 M320 45 C322.99 51.3, 311.8 61.12, 305 60 M305 60 C246.72 61.82, 182.17 61.54, 15 60 M305 60 C211.24 63.77, 118.79 64.12, 15 60 M15 60 C1.2 59.18, 0.79 51.84, 0 45 M15 60 C6.34 61.51, 4.21 56.68, 0 45 M0 45 C1.69 39.49, 3.52 24.39, 0 15 M0 45 C-1.91 34.28, -1.82 25.72, 0 15 M0 15 C-0.23 4.81, 3.08 -1.76, 15 0 M0 15 C-1.88 4.64, 1.17 -1.91, 15 0" stroke="white" stroke-width="1" fill="none"></path></g><g transform="translate(290 410) rotate(0 61.5 11)"><text x="0" y="18" font-family="Inconsolata, Monaco, Consolas, Courier New, Courier, monospace" font-size="19.047619047619044px" fill="white" text-anchor="start" style="white-space:pre" direction="ltr">GPU process</text></g></svg></p><figcaption>doing this 60 times a second isn&#39;t very efficient</figcaption></figure></div><div><div><p><a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/public/web/web_local_frame.h;drc=e95ee489e7a4aee5408d8bb0e13bebc61adcca0d;l=786" target="_blank"><code>CapturePaintPreview</code></a> is great for <code>html2svg</code>, but it&#39;s not designed for real-time rendering. It&#39;s using IPC calls to correctly support out-of-process iframes, making roundtrips between the browser, GPU, and renderer processes. It downloads hardware accelerated images from the GPU, explaining the surprising memory bandwidth usage. We can disable the fetching, and even disable hardware acceleration, but we still have an expensive IPC machinery holding us back.</p><p>Software rendering is still very common, it even used to be the default if you can believe it. It was fairly easy back in the single-process days, but nowadays shared memory regions are configured to efficiently render using multiple processes. If we can get our pixels into one of these memory regions, we would just have to notify our browser process using a simple IPC message.</p></div></div></div>
<div><div><div><div><div><pre><code><span>void</span> <span>LayeredWindowUpdater</span><span>::</span><span>OnAllocatedSharedMemory</span><span>(</span>
    <span>const</span> gfx<span>::</span>Size<span>&amp;</span> pixel_size<span>,</span>
    base<span>::</span>UnsafeSharedMemoryRegion region
<span>)</span> <span>{</span>
    <span>if</span> <span>(</span>region<span>.</span><span>IsValid</span><span>(</span><span>)</span><span>)</span>
        shm_mapping_ <span>=</span> region<span>.</span><span>Map</span><span>(</span><span>)</span><span>;</span>
<span>}</span>

<span>void</span> <span>LayeredWindowUpdater</span><span>::</span><span>Draw</span><span>(</span>
    <span>const</span> gfx<span>::</span>Rect<span>&amp;</span> damage_rect<span>,</span>
    DrawCallback draw_callback
<span>)</span> <span>{</span>
    <span>carbonyl_draw_bitmap</span><span>(</span>
        shm_mapping_<span>.</span><span><span>GetMemoryAs</span><span><span>&lt;</span><span>uint8_t</span><span>&gt;</span></span></span><span>(</span><span>)</span><span>,</span>
        shm_mapping_<span>.</span><span>size</span><span>(</span><span>)</span>
    <span>)</span><span>;</span>

    std<span>::</span><span>move</span><span>(</span>draw_callback<span>)</span><span>.</span><span>Run</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre></div></div></div></div></div>
<hr/>
<p>We solved the bitmap problem, now how can we extract text data? This data lives in the renderer process, but our windowing code lives in the browser process. We need to make the renderer interact with the browser process.</p>
<h2 id="mojo">Mojo<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#mojo"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div><div><div><div><pre><code><span>// Our C++ bindings will be in the carbonyl::mojom namespace</span>
<span>module</span> carbonyl<span>.</span>mojom<span>;</span>

<span>// Import existing bindings to common structures</span>
<span>import</span> <span>&#34;ui/gfx/geometry/mojom/geometry.mojom&#34;</span><span>;</span>
<span>import</span> <span>&#34;skia/public/mojom/skcolor.mojom&#34;</span><span>;</span>

<span>// Define a structure to hold text to render</span>
<span>struct</span> TextData <span>{</span>
    <span>// An UTF-8 string with the contents</span>
    <span>string</span> contents<span>;</span>
    <span>// Bounds, size only defined for clearing</span>
    gfx<span>.</span>mojom<span>.</span>RectF bounds<span>;</span>
    <span>// Color of the text</span>
    skia<span>.</span>mojom<span>.</span>SkColor color<span>;</span>
<span>}</span><span>;</span>

<span>// The browser process runs this service</span>
<span>interface</span> <span>CarbonylRenderService</span> <span>{</span>
    <span>// The renderer process calls this method</span>
    <span>DrawText</span><span>(</span>array<span>&lt;</span>TextData<span>&gt;</span> data<span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre></div></div></div><div><div><p>Mojo is a library for inter-process communication. It defines an IDL for serializing data which supports native handles (i.e. file descriptors, shared memory regions, callbacks), and can be used to generate C++, Java (Android), and JavaScript (DevTools) bindings. It&#39;s extensively documented, and fairly simple to use.</p><p>We&#39;ll start by making an interface <code>CarbonylRenderService</code> that runs on the browser process, with a method <code>DrawText</code> called from the renderer process.</p></div></div></div>
<p>This <code>.mojom</code> code generates C++ temporary files which we can then include to write the implementation code.</p>
<p>Mojo receivers such as our service are part of the native handles we can send between processes, to register the implementation we just need to add it to the <code>BrowserInterfaceBroker</code>, which will get called by the renderer through <code>BrowserInterfaceBrokerProxy</code>:</p>
<div><div><pre><code>map<span>-&gt;</span><span><span>Add</span><span><span>&lt;</span>carbonyl<span>::</span>mojom<span>::</span>CarbonylRenderService<span>&gt;</span></span></span><span>(</span>
    base<span>::</span><span>BindRepeating</span><span>(</span><span>&amp;</span>RenderFrameHostImpl<span>::</span>GetCarbonylRenderService<span>,</span>
                        base<span>::</span><span>Unretained</span><span>(</span>host<span>)</span><span>)</span><span>)</span><span>;</span>
</code></pre></div></div>
<div><div><pre><code><span>GetBrowserInterfaceBroker</span><span>(</span><span>)</span><span>.</span><span>GetInterface</span><span>(</span>
  std<span>::</span><span>move</span><span>(</span>carbonyl_render_service_receiver_<span>)</span>
<span>)</span><span>;</span>
</code></pre></div></div>
<p>Now, we need to get our text data without any expensive round-trip. Blink has a <code>GetPaintRecord()</code> method to get the latest paint data for a page, but it&#39;s not behind a public API, which we need because our code runs in the content renderer. Ideally we should hook into the compositor (<code>cc</code>), but it&#39;s way more involved. It&#39;s dirty but we can workaround this by casting to the private <code>blink::WebViewImpl</code>:</p>
<pre><code><span>auto</span><span>*</span> view <span>=</span> <span><span>static_cast</span><span><span>&lt;</span>blink<span>::</span>WebViewImpl<span>*</span><span>&gt;</span></span></span><span>(</span><span>GetWebFrame</span><span>(</span><span>)</span><span>-&gt;</span><span>View</span><span>(</span><span>)</span><span>)</span><span>;</span>

view<span>-&gt;</span><span>MainFrameImpl</span><span>(</span><span>)</span><span>-&gt;</span><span>GetFrame</span><span>(</span><span>)</span><span>-&gt;</span><span>View</span><span>(</span><span>)</span><span>-&gt;</span><span>GetPaintRecord</span><span>(</span><span>)</span><span>.</span><span>Playback</span><span>(</span><span>&amp;</span>canvas<span>)</span><span>;</span>
carbonyl_render_service_<span>-&gt;</span><span>DrawText</span><span>(</span>std<span>::</span><span>move</span><span>(</span>data<span>)</span><span>)</span><span>;</span>
</code></pre>
<p>Surprise after the first run: the text content doesn&#39;t follow the bitmap. Aaah, scrolling and animating is done on the compositor thread, which frees the main thread and makes everything smoother. Let&#39;s procastinate doing things right by adding <code>--disable-threaded-scrolling</code> <code>--disable-threaded-animation</code> to the command line arguments.</p>
<p><figure><video src="/assets/86793ae6785e6325c6db.mp4" autoplay="" loop="" controls=""></video><figcaption>Threaded compositing enabled</figcaption></figure><figure><video src="/assets/470674f7207bd5e55a41.mp4" autoplay="" loop="" controls=""></video><figcaption>Threaded compositing disabled</figcaption></figure></p>
<p>Pretty smooth, it&#39;ll be even smoother when threaded compositing is fixed! And we&#39;ve fixed our biggest problem: we don&#39;t use any CPU when idling, and scrolling consumes ~15%.</p>
<h2 id="layout">Layout<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#layout"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div><div><div><div><div><pre><code><span>auto</span> font <span>=</span> state<span>.</span><span>StyleBuilder</span><span>(</span><span>)</span><span>.</span><span>GetFontDescription</span><span>(</span><span>)</span><span>;</span>

font<span>.</span><span>SetStretch</span><span>(</span><span>ExtraExpandedWidthValue</span><span>(</span><span>)</span><span>)</span><span>;</span>
font<span>.</span><span>SetKerning</span><span>(</span>FontDescription<span>::</span>kNoneKerning<span>)</span><span>;</span>
font<span>.</span><span>SetComputedSize</span><span>(</span><span>11.75</span> <span>/</span> <span>7.0</span><span>)</span><span>;</span>
font<span>.</span><span>SetGenericFamily</span><span>(</span>FontDescription<span>::</span>kMonospaceFamily<span>)</span><span>;</span>
font<span>.</span><span>SetIsAbsoluteSize</span><span>(</span><span>true</span><span>)</span><span>;</span>
state<span>.</span><span>StyleBuilder</span><span>(</span><span>)</span><span>.</span><span>SetFontDescription</span><span>(</span>font<span>)</span><span>;</span>
state<span>.</span><span>StyleBuilder</span><span>(</span><span>)</span><span>.</span><span>SetLineHeight</span><span>(</span><span>Length</span><span>::</span><span>Fixed</span><span>(</span><span>14.0</span> <span>/</span> <span>7.0</span><span>)</span><span>)</span><span>;</span>
</code></pre></div></div></div></div><div><div><p>Thing is, we can only render one font-size, but Blink doesn&#39;t know that. This causes the layout to be messed up, with text chunks overlapping or overly spaced. This is especially visible on websites with a lot of textual content and links like Wikipedia.</p><p>Another dirty - yet effective - hack we can use is forcing a monospaced font on every element. We can do that by adding some code to <a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/css/resolver/style_resolver.cc;l=954;drc=a67b5c344bfa8645cb2f66685e010b425ac19ea1" target="_blank"><code>StyleResolver::ResolveStyle</code></a>.</p></div></div></div>
<hr/>

<h2 id="lodpi">LoDPI<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#lodpi"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div><div><div><div><pre><code><span>// static</span>
<span>float</span> <span>Display</span><span>::</span><span>GetForcedDeviceScaleFactor</span><span>(</span><span>)</span> <span>{</span>
    <span>return</span> <span>1.0</span> <span>/</span> <span>7.0</span><span>;</span>
<span>}</span>

<span>// static</span>
<span>bool</span> <span>Display</span><span>::</span><span>HasForceDeviceScaleFactor</span><span>(</span><span>)</span> <span>{</span>
    <span>return</span> <span>true</span><span>;</span>
<span>}</span>
</code></pre></div></div></div><div><p>One expensive step in our rendering pipeline is downscaling: we need to resize the framebuffer from its virtual space to its physical space. What we&#39;re doing is kind of the opposite of HiDPI rendering, whose most common ratio is 2x which means 1 pixel on the web equals 2 pixels on the screen. Our ratio is <code>1 / 7</code> which means 7 pixels on the web renders to 1 block on our terminal.</p><p>The annoying thing about HiDPI is that it can make rendering ~2x slower, whereas Carbonyl LoDPI® makes rendering run ~7x faster. We just need to force our scaling into the <a href="https://source.chromium.org/chromium/chromium/src/+/main:ui/display/display.h;drc=8d3b4cc374e70dcfef858a355ac13e75d08c4f67;l=31" target="_blank"><code>Display</code></a> class.</p></div></div>
<h2 id="color">Color<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#color"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<p>I looked for examples of RGB color conversion to <code>xterm-256</code> but the code I found was either wrong or slow because it did a nearest neighbor search. We&#39;re going to do it for every pixel so it should run fast.</p>
<p>The formula for the conversion is fairly simple, assuming color values between 0 and 1: <code>16 + r * 5 * 36 + g * 5 * 6 + b * 5</code>.</p>
<div><div><pre><code><span>pub</span> <span>fn</span> <span>to_xterm</span><span>(</span><span>&amp;</span><span>self</span><span>)</span> <span>-&gt;</span> <span>u8</span> <span>{</span>
    <span>let</span> r <span>=</span> <span>(</span><span>self</span><span>.</span>r <span>as</span> <span>f32</span> <span>-</span> <span>(</span><span>95.0</span> <span>-</span> <span>40.0</span><span>)</span><span>)</span><span>.</span><span>max</span><span>(</span><span>0.0</span><span>)</span> <span>/</span> <span>40.0</span><span>;</span>
    <span>let</span> g <span>=</span> <span>(</span><span>self</span><span>.</span>g <span>as</span> <span>f32</span> <span>-</span> <span>(</span><span>95.0</span> <span>-</span> <span>40.0</span><span>)</span><span>)</span><span>.</span><span>max</span><span>(</span><span>0.0</span><span>)</span> <span>/</span> <span>40.0</span><span>;</span>
    <span>let</span> b <span>=</span> <span>(</span><span>self</span><span>.</span>b <span>as</span> <span>f32</span> <span>-</span> <span>(</span><span>95.0</span> <span>-</span> <span>40.0</span><span>)</span><span>)</span><span>.</span><span>max</span><span>(</span><span>0.0</span><span>)</span> <span>/</span> <span>40.0</span><span>;</span>

    <span>(</span><span>16.0</span> <span>+</span>
        r<span>.</span><span>round</span><span>(</span><span>)</span> <span>*</span> <span>36.0</span> <span>+</span>
        g<span>.</span><span>round</span><span>(</span><span>)</span> <span>*</span> <span>6.0</span> <span>+</span>
        b<span>.</span><span>round</span><span>(</span><span>)</span><span>)</span> <span>as</span> <span>u8</span>
<span>}</span>
</code></pre></div><div><p>The twist that most code online gets wrong is that the 6 color levels are not linear: 0, 95, 135, 175, 215, 255; there is a 95 gap between the first and second values, and 40 for the rest.</p><p>It makes sense to limit the dark range, color differences are more visible with bright colors. For us, it means that we can convert a value between 0 and 255 using <code>max(0, color - 95 - 40) / 40</code>.</p></div></div>
<hr/>
<hr/>
<div><div><div><div><pre><code><span>pub</span> <span>fn</span> <span>to_xterm</span><span>(</span><span>&amp;</span><span>self</span><span>)</span> <span>-&gt;</span> <span>u8</span> <span>{</span>
    <span>if</span> <span>self</span><span>.</span><span>max_val</span><span>(</span><span>)</span> <span>-</span> <span>self</span><span>.</span><span>min_val</span><span>(</span><span>)</span> <span>&lt;</span> <span>8</span> <span>{</span>
        <span>match</span> <span>self</span><span>.</span>r <span>{</span>
            <span>0</span><span>..=</span><span>4</span> <span>=&gt;</span> <span>16</span><span>,</span>
            <span>5</span><span>..=</span><span>8</span> <span>=&gt;</span> <span>232</span><span>,</span>
            <span>238</span><span>..=</span><span>246</span> <span>=&gt;</span> <span>255</span><span>,</span>
            <span>247</span><span>..=</span><span>255</span> <span>=&gt;</span> <span>231</span><span>,</span>
            r <span>=&gt;</span> <span>232</span> <span>+</span> <span>(</span>r <span>-</span> <span>8</span><span>)</span> <span>/</span> <span>10</span><span>,</span>
        <span>}</span>
    <span>}</span> <span>else</span> <span>{</span>
        <span>let</span> scale <span>=</span> <span>5.0</span> <span>/</span> <span>200.0</span><span>;</span>

        <span>(</span><span>16.0</span>
            <span>+</span> <span>self</span>
                <span>.</span><span>cast</span><span>::</span><span>&lt;</span><span>f32</span><span>&gt;</span><span>(</span><span>)</span>
                <span>.</span><span>mul_add</span><span>(</span>scale<span>,</span> scale <span>*</span> <span>-</span><span>55.0</span><span>)</span>
                <span>.</span><span>max</span><span>(</span><span>0.0</span><span>)</span>
                <span>.</span><span>round</span><span>(</span><span>)</span>
                <span>.</span><span>dot</span><span>(</span><span>(</span><span>36.0</span><span>,</span> <span>6.0</span><span>,</span> <span>1.0</span><span>)</span><span>)</span><span>)</span> <span>as</span> <span>u8</span>
    <span>}</span>
<span>}</span>
</code></pre></div></div></div><div><p>The conversion itself can be thought of as a dot product of <code>(r, g, b)</code> and <code>(36, 6, 1)</code>. We can move the substraction to an <code>mul_add</code> call to help the compiler use a fused multiply-add instruction.</p><p>The last step is grayscale: our xterm profile offers 256 colors, there are the 216 colors from the RGB cube (<code>6 * 6 * 6</code>), the 16 configurable system colors, and 24 gray levels which go from <code>rgb(8,8,8)</code> to <code>rgb(238,238,238)</code>.</p><p>To find out if a color is on a grayscale, we can substract its minimal value to its maximum value and check if it&#39;s under a threshold, let&#39;s say 8.</p></div></div>

<p>We still have one tiny problem: how can you detect if a terminal supports true-color
or 256 colors? A quick Google search leads us to the <code>COLORTERM</code> environment variable,
which is <code>24bit</code> or <code>truecolor</code> if true-color is supported. But that won&#39;t work in
Docker or SSH, which are our primary targets.</p>
<div><div><div><div><pre><code><span>self</span><span>.</span>sequence <span>=</span> <span>match</span> <span>self</span><span>.</span>sequence <span>{</span>
</code></pre></div></div><pre><code><span>    // </span><span>^[P</span><span>1</span><span>$r0;48:2:1:13:37:42m^[\</span></code></pre><pre><code>    <span>Code</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
        <span>b&#39;0&#39;</span> <span>|</span> <span>b&#39;1&#39;</span> <span>=&gt;</span> <span>Type</span><span>(</span>key<span>)</span><span>,</span>
        _ <span>=&gt;</span> <span>control_flow!</span><span>(</span><span>break</span><span>)</span><span>?</span><span>,</span>
    <span>}</span><span>,</span>
</code></pre><pre><code><span>    // </span><span>^[P1</span><span>$</span><span>r0;48:2:1:13:37:42m^[\</span></code></pre><pre><code>    <span>Type</span><span>(</span>code<span>)</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
        <span>b&#39;$&#39;</span> <span>=&gt;</span> <span>Status</span><span>(</span><span>StatusParser</span><span>::</span><span>new</span><span>(</span>code<span>)</span><span>)</span><span>,</span>
        <span>b&#39;+&#39;</span> <span>=&gt;</span> <span>Resource</span><span>(</span><span>ResourceParser</span><span>::</span><span>new</span><span>(</span>code<span>)</span><span>)</span><span>,</span>
        _ <span>=&gt;</span> <span>control_flow!</span><span>(</span><span>break</span><span>)</span><span>?</span><span>,</span>
    <span>}</span><span>,</span>
</code></pre><pre><code><span>    // </span><span>^[P1$</span><span>r0;48:2:1:13:37:42m^[\</span></code></pre><pre><code>    <span>Status</span><span>(</span><span>ref</span> <span>mut</span> status<span>)</span> <span>=&gt;</span> <span>return</span> status<span>.</span><span>parse</span><span>(</span>key<span>)</span><span>,</span>
    <span>Resource</span><span>(</span><span>ref</span> <span>mut</span> resource<span>)</span> <span>=&gt;</span> <span>return</span> resource<span>.</span><span>parse</span><span>(</span>key<span>)</span><span>,</span>
<span>}</span><span>;</span>
</code></pre><div><div><pre><code><span>self</span><span>.</span>sequence <span>=</span> <span>match</span> <span>self</span><span>.</span>sequence <span>{</span>
</code></pre></div></div><pre><code><span>    // </span><span>^[P1$</span><span>r</span><span>0;48:2:1:13:37:42m^[\</span></code></pre><pre><code>    <span>Start</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
        <span>b&#39;r&#39;</span> <span>=&gt;</span> <span>Value</span><span>,</span>
        _ <span>=&gt;</span> <span>control_flow!</span><span>(</span><span>break</span><span>)</span><span>?</span><span>,</span>
    <span>}</span><span>,</span>
</code></pre><pre><code><span>    // </span><span>^[P1$r</span><span>0;48:2:1:13:37:42m^[</span><span>\</span></code></pre><pre><code>    <span>Value</span> <span>=&gt;</span> <span>match</span> key <span>{</span>
</code></pre><pre><code><span>        // </span><span>^[P1$r0;48:2:1:13:37:42m</span><span>^[</span><span>\</span></code></pre><pre><code>        <span>0x1b</span> <span>=&gt;</span> <span>self</span><span>.</span><span>terminate</span><span>(</span><span>)</span><span>,</span>
</code></pre><pre><code><span>        // </span><span>^[P1$r0</span><span>;</span><span>48:2:1:13:37:42m^[\</span></code></pre><pre><code>        <span>b&#39;;&#39;</span> <span>=&gt;</span> <span>self</span><span>.</span><span>push_value</span><span>(</span><span>)</span><span>,</span>
</code></pre><pre><code><span>        // </span><span>^[P1$r</span><span>0</span><span>;</span><span>48:2:1:13:37:42m</span><span>^[\</span></code></pre><pre><code>        <span>char</span> <span>=&gt;</span> <span>self</span><span>.</span><span>push_char</span><span>(</span><span>char</span><span>)</span><span>,</span>
    <span>}</span><span>,</span>
</code></pre><pre><code><span>    // </span><span>^[P1$r0;48:2:1:13:37:42m^[</span><span>\</span></code></pre><pre><code>    <span>Terminator</span> <span>=&gt;</span> <span>control_flow!</span><span>(</span><span>break</span> <span>self</span><span>.</span><span>parse_event</span><span>(</span>key<span>)</span><span>)</span><span>?</span><span>,</span>
<span>}</span><span>;</span>
</code></pre></div><div><p>A trick we can use is a DCS (Device Control Sequence) to fetch a setting value, like the current background color. If we set an RGB value and get an RGB value back, we can enable true-color.</p><p>You can try it by running the following on your terminal:</p><pre><code>$ <span>printf</span> <span>&#34;<span title="\e">\e</span>[48;2;13;37;42m<span title="\e">\e</span>P\<span>$qm</span><span title="\e">\e</span><span title="\\">\\</span>&#34;</span><span>;</span> <span>cat</span>
</code></pre><ul>
<li><code>\e</code>: start escape sequence<!-- -->
<ul>
<li><code>[</code>: introduce control sequence</li>
<li><code>48</code>: set foreground</li>
<li><code>2</code>: using an RGB color</li>
<li><code>13</code>: R is 13</li>
<li><code>37</code>: G is 37</li>
<li><code>42</code>: B is 42</li>
<li><code>m</code>: select graphic rendition</li>
</ul>
</li>
<li><code>\e</code>: start escape sequence<!-- -->
<ul>
<li><code>P</code>: introduce device control sequence</li>
<li><code>$</code>: enter status mode</li>
<li><code>q</code>: query current setting</li>
<li><code>m</code>: select graphic rendition</li>
</ul>
</li>
</ul><p>If the commands are supported, you should get the following output with a dark turquoise background:</p><p><code> ^[P1$r0;48:2:1:13:37:42m^[\ </code></p><p>This is what the terminal emulator sends to stdin, and what we can parse to toggle true-color on.</p></div></div>
<h2 id="title">Title<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#title"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div><p><figure><video src="/assets/4e858fad04b7bdef5b92.mp4" autoplay="" loop="" controls=""></video><figcaption>nice</figcaption></figure></p><div><p>A few xterm sequences allow setting the terminal window title, we could use that to display the current page title.</p><pre><code><span>fn</span> <span>set_title</span><span>(</span>title<span>:</span> <span>&amp;</span><span>str</span><span>)</span> <span>{</span>
    <span>// Set icon name and window title to string</span>
    <span>println!</span><span>(</span><span>&#34;\x1b]0;{}\x07&#34;</span><span>,</span> title<span>)</span><span>;</span>
    <span>// Set icon name to string</span>
    <span>println!</span><span>(</span><span>&#34;\x1b]1;{}\x07&#34;</span><span>,</span> title<span>)</span><span>;</span>
    <span>// Set window title to string</span>
    <span>println!</span><span>(</span><span>&#34;\x1b]2;{}\x07&#34;</span><span>,</span> title<span>)</span><span>;</span>
<span>}</span>
</code></pre><p>To get notified when the title changes, we can simply implement <a href="https://source.chromium.org/chromium/chromium/src/+/main:content/public/browser/web_contents_observer.h;drc=d868f781dd811d46a0a5ae88ccaf4b5afb0f0f3c;l=576" target="_blank"><code>WebContentsObserver::TitleWasSet()</code></a>:</p><pre><code><span>void</span> <span>HeadlessWebContentsImpl</span><span>::</span><span>TitleWasSet</span><span>(</span>content<span>::</span>NavigationEntry<span>*</span> entry<span>)</span> <span>{</span>
    carbonyl<span>::</span><span>Renderer</span><span>::</span><span>Main</span><span>(</span><span>)</span><span>-&gt;</span><span>SetTitle</span><span>(</span>
        base<span>::</span><span>UTF16ToUTF8</span><span>(</span>entry<span>-&gt;</span><span>GetTitleForDisplay</span><span>(</span><span>)</span><span>)</span>
    <span>)</span><span>;</span>
<span>}</span>
</code></pre></div></div>
<h2 id="final-thoughts">Final thoughts<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#final-thoughts"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<p>That&#39;s all for today folks, <a href="https://github.com/fathyb/carbonyl" target="_blank">check out Carbonyl on GitHub</a>!</p>
<p>This was my first Rust project and I finally get the hype now. What a cool language!</p>
<h3 id="stay-tuned">Stay tuned<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#stay-tuned"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>The post for next month <a href="https://fathy.fr/every-sin">will be a visual introduction to Fourier Analysis</a>. After that, we&#39;ll look into a speculative JS VM in Rust.</p>
<p>Use <a href="https://fathy.fr/rss.xml" target="_blank">the RSS feed</a> to stay tuned, you can also watch <a href="https://github.com/fathyb/fathy.fr" target="_blank">the website repo</a> for releases on GitHub.</p>
<h3 id="discuss">Discuss<a aria-label="Link to this title" href="https://fathy.fr/carbonyl#discuss"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkIcon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p><a href="https://news.ycombinator.com/item?id=34547259" target="_blank">Discuss on HN</a> - <a href="https://old.reddit.com/r/programming/comments/10mnt0l/forking_chrome_to_render_in_a_terminal/" target="_blank">Discuss on r/programming</a></p></main></div></div></div>
  </body>
</html>
