<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.fb.com/2022/08/31/open-source/velox/">Original</a>
    <h1>Velox: An open-source unified execution engine</h1>
    
    <div id="readability-page-1" class="page"><div>

		<ul>
<li aria-level="1"><span>Meta is introducing Velox, an open source unified execution engine aimed at accelerating data management systems and streamlining their development.</span></li>
<li aria-level="1"><span>Velox is under active development. </span><span>Experimental results from our paper published at the International Conference on </span><span>Very Large Data Bases (VLDB) 2022 show how Velox improves efficiency and consistency in data management systems.</span></li>
<li aria-level="1"><span>Velox helps consolidate and unify data management systems in a manner we believe will be of benefit to the industry. We’re hoping the larger open source community will join us in contributing to the project.</span></li>
</ul>
<p><span>Meta’s infrastructure plays an important role in supporting our products and services. Our data infrastructure ecosystem is composed of dozens of specialized data computation engines, all focused on different workloads for a variety of use cases ranging from SQL analytics (batch and interactive) to transactional workloads, stream processing, data ingestion, and more. Recently, the rapid growth of artificial intelligence (AI) and machine learning (ML) use cases</span><a href="https://engineering.fb.com/2022/06/14/production-engineering/federated-learning-differential-privacy/" target="_blank" rel="noopener"> <span>within Meta’s infrastructure</span></a><span> has led to additional engines and libraries targeted at feature engineering, data preprocessing, and other workloads for ML training and serving pipelines. </span></p>
<p><span>However, despite the similarities, these engines have largely evolved independently. This fragmentation has made maintaining and enhancing them difficult, especially considering that as workloads evolve, the hardware that executes these workloads also changes. Ultimately, this fragmentation results in systems with different feature sets and inconsistent semantics — reducing the productivity of data users that need to interact with multiple engines to finish tasks.</span></p>
<p><span>In order to address these challenges and to create a stronger, more efficient data infrastructure for our own products and the world, Meta has created and open sourced </span><a href="http://velox-lib.io/" target="_blank" rel="noopener"><span>Velox</span></a><span>. It’s a novel, state-of-the-art unified execution engine that aims to speed up data management systems as well as streamline their development. Velox unifies the common data-intensive components of data computation engines while still being extensible and adaptable to different computation engines. It democratizes optimizations that were previously implemented only in individual engines, providing a framework in which consistent semantics can be implemented. This reduces work duplication, promotes reusability, and improves overall efficiency and consistency.  </span></p>
<p><span>Velox is under active development, but it’s already in various stages of integration with more than a dozen data systems at Meta, including Presto, Spark, and PyTorch (the latter through a data preprocessing library called TorchArrow), as well as other internal stream processing platforms, transactional engines, data ingestion systems and infrastructure, ML systems for feature engineering, and others. </span></p>
<p><span>Since it was first </span><a href="https://github.com/facebookincubator/velox" target="_blank" rel="noopener"><span>uploaded to GitHub</span></a><span>, the Velox open source project has attracted more than 150 code contributors, including key collaborators such as Ahana, Intel, and Voltron Data, as well as various academic institutions. By open-sourcing and fostering a community for Velox, we believe we can accelerate the pace of innovation in the data management system’s development industry. We hope more individuals and companies will join us in this effort. </span></p>
<h2><span>An overview of Velox</span></h2>
<p><span>While data computation engines may seem distinct at first, they are all composed of a similar set of logical components: a language front end, an intermediate representation (IR), an optimizer, an execution runtime, and an execution engine. Velox provides the building blocks required to implement execution engines, consisting of all data-intensive operations executed within a single host, such as expression evaluation, aggregation, sorting, joining, and more — also commonly referred to as the data plane. Therefore, Velox expects an optimized plan as input and efficiently executes it using the resources available in the local host.</span></p>
<figure id="attachment_19229" aria-describedby="caption-attachment-19229"><img src="https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?w=1024" alt="Velox" width="1024" height="512" srcset="https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png 1999w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?resize=916,458 916w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?resize=768,384 768w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?resize=1024,512 1024w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?resize=1536,768 1536w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?resize=96,48 96w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-1.png?resize=192,96 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19229">Data management systems like Presto and Spark typically have their own execution engines and other components. Velox can function as a common execution engine across different data management systems. <em>(Diagram by Philip Bell.)</em></figcaption></figure>
<p><span>Velox leverages numerous runtime optimizations, such as filter and conjunct reordering, key normalization for array and hash-based aggregations and joins, dynamic filter pushdown, and adaptive column prefetching. These optimizations provide optimal local efficiency given the available knowledge and statistics extracted from incoming batches of data. Velox is also designed from the ground up to efficiently support complex data types due to their ubiquity in modern workloads, and hence extensively relies on dictionary encoding for cardinality-increasing and cardinality-reducing operations such as joins and filtering, while still providing fast paths for primitive data types.</span></p>
<p><span>The main components provided by Velox are:</span><span><br/>
</span></p>
<ul>
<li><b>Type:</b><span><span><span><span><span> a generic type system that allows developers to represent scalar, complex, and nested data types, including structs, maps, arrays, functions (lambdas), decimals, tensors, and more.</span></span></span></span></span></li>
<li><b>Vector:</b><span><span><span><span><span> an Apache Arrow–compatible columnar memory layout module supporting multiple encodings, such as flat, dictionary, constant, sequence/RLE, and frame of reference, in addition to a lazy materialization pattern and support for out-of-order result buffer population.</span></span></span></span></span></li>
<li><b>Expression Eval:</b><span><span><span><span><span> a state-of-the-art vectorized expression evaluation engine built based on vector-encoded data, leveraging techniques such as common subexpression elimination, constant folding, efficient null propagation, encoding-aware evaluation, dictionary peeling, and memoization.</span></span></span></span></span></li>
<li><b>Functions:</b><span> APIs that can be used by developers to build custom functions, providing a simple (row by row) and vectorized (batch by batch) interface for scalar functions and an API for aggregate functions. </span>
<ul>
<li><span>A function package</span> <span><span>compatible with the popular PrestoSQL dialect is also provided as part of the library.</span></span></li>
</ul>
</li>
<li><b>Operators:</b><span><span><span><span><span> implementation of common SQL operators such as TableScan, Project, Filter, Aggregation, Exchange/Merge, OrderBy, TopN, HashJoin, MergeJoin, Unnest, and more.</span></span></span></span></span></li>
<li><b>I/O:</b><span> a set of APIs that allows Velox to be integrated in the context of other engines and runtimes, such as:</span>
<ul>
<li><b>Connectors:</b><span> enables developers to specialize data sources and sinks for TableScan and TableWrite operators.</span></li>
<li><b>DWIO:</b><span> an extensible interface providing support for encoding/decoding popular file formats such as Parquet, ORC, and DWRF.</span></li>
<li><b>Storage adapters:</b><span> a byte-based extensible interface that allows Velox to connect to storage systems such as </span><a href="https://engineering.fb.com/2021/06/21/data-infrastructure/tectonic-file-system/" target="_blank" rel="noopener"><span>Tectonic</span></a><span>, S3, HDFS, and more. </span></li>
<li><b>Serializers:</b><span> a serialization interface targeting network communication where different wire protocols can be implemented, supporting</span><a href="https://prestodb.io/docs/current/develop/serialized-page.html" target="_blank" rel="noopener"> <span>PrestoPage</span></a><span><span> and Spark’s UnsafeRow formats.</span></span></li>
</ul>
</li>
<li><b>Resource management:</b><span> a collection of primitives for handling computational resources, such as CPU and memory management, spilling, and memory and SSD caching.</span></li>
</ul>
<h2><span>Velox’s main integrations and experimental results</span></h2>
<p><span>Beyond efficiency gains, Velox provides value by unifying the execution engines across different data computation engines. The three most popular integrations are Presto, Spark, and TorchArrow/PyTorch.</span></p>
<h3><span>Presto — Prestissimo </span></h3>
<p><span>Velox is being integrated into Presto as part of the</span><a href="https://github.com/prestodb/presto/tree/master/presto-native-execution" target="_blank" rel="noopener"> <span>Prestissimo</span></a><span> project, where Presto Java workers are replaced by a C++ process based on Velox. The project was originally created by Meta in 2020 and is under continued development in collaboration with Ahana, along with other open source contributors.</span></p>
<p><span>Prestissimo provides a C++ implementation of Presto’s HTTP REST interface, including worker-to-worker exchange serialization protocol, coordinator-to-worker orchestration, and status reporting endpoints, thereby providing a drop-in C++ replacement for Presto workers. The main query workflow consists of receiving a Presto plan fragment from a Java coordinator, translating it into a Velox query plan, and handing it off to Velox for execution.</span></p>
<p><span>We conducted two different experiments to explore the speedup provided by Velox in Presto. Our first experiment used the TPC-H benchmark and measured close to an order of magnitude speedup in some CPU-bound queries. We saw a more modest speedup (averaging 3-6x) for shuffle-bound queries.</span></p>
<p><span>Although the TPC-H dataset is a standard benchmark, it’s not representative of real workloads. To explore how Velox might perform in these scenarios, we created an experiment where we executed production traffic generated by a variety of interactive analytical tools found at Meta. In this experiment, we saw an average of 6-7x speedups in data querying, with some results increasing speedups by over an order of magnitude. You can learn more about the details of the experiments and their results in our <a href="https://research.facebook.com/publications/velox-metas-unified-execution-engine/" target="_blank" rel="noopener">research paper</a>.</span></p>
<figure id="attachment_19230" aria-describedby="caption-attachment-19230"><img loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-2.png?w=916" alt="Velox" width="916" height="640" srcset="https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-2.png 977w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-2.png?resize=916,640 916w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-2.png?resize=768,537 768w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-2.png?resize=96,67 96w, https://engineering.fb.com/wp-content/uploads/2022/08/Velox-image-2.png?resize=192,134 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19230">Prestissimo results on real analytic workloads. The histogram above shows relative speedup of Prestissimo over Presto Java. The y-axis indicates the number of queries (in thousands [K]). Zero on the x-axis means Presto Java is faster; 10 indicates that Prestissimo is at least 10 times faster than Presto Java.</figcaption></figure><p><a href="https://github.com/prestodb/presto/tree/master/presto-native-execution" target="_blank" rel="noopener"><span>Prestissimo’s codebase</span></a><span> is available on GitHub. </span><span> </span></p>
<h3><span>Spark — Gluten</span></h3>
<p><span>Velox is also being integrated into Spark as part of the</span><a href="https://github.com/oap-project/gluten" target="_blank" rel="noopener"> <span>Gluten project</span></a><span> created by Intel. Gluten allows C++ execution engines (such as Velox) to be used within the Spark environment while executing Spark SQL queries. Gluten decouples the Spark JVM and execution engine by creating a JNI API based on the Apache Arrow data format and Substrait query plans, thus allowing Velox to be used within Spark by simply integrating with Gluten’s JNI API.</span></p>
<p><a href="https://github.com/oap-project/gluten" target="_blank" rel="noopener"><span>Gluten’s codebase</span></a><span> is available on GitHub. </span><span> </span></p>
<h3><span>TorchArrow</span></h3>
<p><a href="https://pytorch.org/torcharrow/beta/index.html" target="_blank" rel="noopener"><span>TorchArrow</span></a><span> is a dataframe Python library for data preprocessing in deep learning, and part of the PyTorch project. TorchArrow internally translates the dataframe representation into a Velox plan and delegates it to Velox for execution. In addition to converging the otherwise fragmented space of ML data preprocessing libraries, this integration allows Meta to consolidate execution-engine code between analytic engines and ML infrastructure. It provides a more consistent experience for ML end users, who are commonly required to interact with different computation engines to complete a particular task, by exposing the same set of functions/UDFs and ensuring consistent behavior across engines.</span></p>
<p><span>TorchArrow was recently released in</span><a href="https://github.com/pytorch/torcharrow" target="_blank" rel="noopener"> <span>beta mode</span></a><span> on GitHub.</span></p>
<h2><span>The future of database system development</span></h2>
<p><span>Velox demonstrates that it is possible to make data computation systems more adaptable by consolidating their execution engines into a single unified library. As we continue to integrate Velox into our own systems, we are committed to building a sustainable open source community to support the project as well as to speed up library development and industry adoption. We are also interested in continuing to blur the boundaries between ML infrastructure and traditional data management systems by unifying function packages and semantics between these silos.</span></p>
<p><span>Looking at the future, we believe Velox’s unified and modular nature has the potential to be beneficial to industries that utilize, and especially those that develop, data management systems. It will allow us to partner with hardware vendors and proactively adapt our unified software stack as hardware advances. Reusing unified and highly efficient components will also allow us to innovate faster as data workloads evolve. We believe that modularity and reusability are the future of database system development, and we hope that data companies, academia, and individual database practitioners alike will join us in this effort. </span></p>
<p><span>In-depth documentation about Velox and these components can be found on our </span><a href="http://velox-lib.io" target="_blank" rel="noopener"><span>website</span></a><span> and in our research paper “<a href="https://research.facebook.com/publications/velox-metas-unified-execution-engine/" target="_blank" rel="noopener">Velox: Meta’s unified execution engine</a>.”</span></p>
<h2><span>Acknowledgements</span></h2>
<p><i><span>We would like to thank all contributors to the Velox project. A special thank-you to Sridhar Anumandla, Philip Bell, Biswapesh Chattopadhyay, Naveen Cherukuri, Wei He, Jiju John, Jimmy Lu, Xiaoxuang Meng, Krishna Pai, Laith Sakka, Bikramjeet Vigand, Kevin Wilfong from the Meta team, and to countless community contributors, including Frank Hu, Deepak Majeti, Aditi Pandit, and Ying Su.</span></i></p>

		
	</div></div>
  </body>
</html>
