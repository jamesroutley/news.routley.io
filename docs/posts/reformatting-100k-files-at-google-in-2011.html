<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://laurent.le-brun.eu/blog/the-story-of-reformatting-100k-files-at-google-in-2011">Original</a>
    <h1>Reformatting 100k Files at Google in 2011</h1>
    
    <div id="readability-page-1" class="page"><article>



    

    <div>
                    <h2>A Mysterious Meeting</h2>
<p>Back in September 2012, I was a junior engineer at Google, working on <a href="https://bazel.build">Bazel</a> (Google’s build tool, also known internally as Blaze). One day, a mysterious calendar invite landed in my inbox. It was sent by two engineers in the US, and I was invited along with my team lead.</p>
<p>I quickly recognized the names: Rob Pike and Russ Cox. Though I hadn&#39;t worked with them, I knew them by reputation: <a href="https://swtch.com/~rsc/">Russ Cox</a> because I enjoyed reading his blog posts, and <a href="https://en.wikipedia.org/wiki/Rob_Pike">Rob Pike</a> because, well… he’s famous. During the meeting, Rob and Russ shared their ambitious plan: to reformat every single Bazel BUILD file in Google’s codebase and enforce this formatting with a presubmit script.</p>
<h2>Code Formatting</h2>
<p>At that time, code formatters were not common. Popular tools like Python’s Black, Clang Format, or Prettier didn&#39;t exist yet. The main example of a formatter was <a href="https://research.swtch.com/gofmt">gofmt</a>. As Russ and Rob worked in the Go team, they wanted to replicate this success for Bazel’s BUILD files.</p>
<p>BUILD files had inconsistent formatting, mixing various indentation styles without a standard guide. It was often easy to spot copy-pasted blocks of code because their formatting stood out. Past discussions about style guides showed there were lots of disagreements among engineers. The previous attempt to write a formatting tool had limited adoption. It had some issues and it was hard to get adoption.</p>
<p>Russ had already developed a new version of the tool, called Buildifier, using Go. <a href="https://journal.stuffwithstuff.com/2015/09/08/the-hardest-program-ive-ever-written/">Writing a formatter can be very difficult</a> in some cases, but the complexity depends on a few things:</p>
<ul>
<li>How to deal with comments? Buildifier attaches the comments to a nearby node in the <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">syntax tree</a> (the data structure is not super fine-grained, so in some cases, Buildifier will move the comment).</li>
<li>How to split lines? Buildifier splits lines in a few hard-coded cases, but it doesn’t care about line length. This is a significant simplification.</li>
<li>How to preserve existing line splits? Buildifier preserves some of them in the syntax tree, <a href="https://github.com/bazelbuild/buildtools/blob/80f1f6802857db4d74983ee7ffa0b83e2bbeeda4/build/syntax.go#L537">in a few specific places</a>.</li>
<li>Do we need partial formatting? Buildifier always reformats the entire file, not just the lines that were modified.</li>
</ul>
<p>Because of the design choices, Buildifier was fairly simple. The implementation looked promising, but we had to consider how to roll it out. Russ tested it on the entire codebase and was able to reformat all files in a few minutes. He was asking us for the permission to roll out the tool and enforce it as a presubmit check.</p>
<p>The idea of reformatting every BUILD file sounded crazy and very disruptive. With around 10,000 engineers changing BUILD files every day in the codebase, enforcing a strict formatting rule seemed scary. Could we reject every commit that doesn&#39;t match the output byte for byte? Could we relax the presubmit rules or make the tool opt-in? Russ insisted: yes, it had to be strictly enforced for everyone. No exceptions, no settings in the tool, no personal preferences.</p>
<p>After a few days, the plan was formally approved.</p>
<h2>Rollout</h2>
<p>I got to help with the rollout in a few places. For example, I made changes to the grammar to formalize the build language, and I wrote a style guide -- so I decided, once and for all, how BUILD files should look like. I also needed to document which lists could be safely reordered since one notable feature of Buildifier is its ability to sort lists in certain cases (e.g., in a build, the list of source files is sometimes order-independent).</p>
<p>Of course, we had to integrate Buildifier in every major code editor. If the code is formatted on save, no one will get bad surprises when trying to submit the code. In the codebase, some tools generated BUILD files. Tools shouldn’t try to generate formatted code by themselves; they should delegate it to the formatting tool, which acts as a source of truth and may change over time.</p>
<p>How do you test if the formatter doesn’t break code? The first idea is to compare the syntax trees, but this doesn’t work when we reorder list items. Bazel has a very convenient feature, called Bazel Query, which can output the information about a package. I taught Bazel which lists are order-independent, so we could use Bazel Query to check that the reformatting didn’t impact Bazel understanding of a file. On top of that, Google has a nice testing infrastructure. It’s of course possible (but slow, and computationally expensive) to run the tests after this kind of change.</p>
<p>How do you submit changes to 100,000+ files? At that scale, lots of tools break. So Google has a tool to split a large change in smaller changes that can be submitted independently. In case of conflict, the tool was instructed to revert any conflicting file. To bypass code approvals, the changes were sent to a “global approver”, able to approve changes anywhere in the Google codebase.</p>
<h2>Aftermath</h2>
<p>Contrary to my expectations, this was relatively uneventful. Almost no one complained about the new requirement. Almost no one complained about the new formatting style.</p>
<p>I remember the previous lengthy discussions about indentation, parentheses position, etc. without any consensus. Yet, when Buildifier was rolled out, people didn’t actually care about the style decisions. They just enjoyed the uniformity.</p>
<blockquote>
<p>“The formatting issue is a problem that should not exist and that we care enough about to spend our own engineering time eliminating it. I understand that it does not seem a priori that automated formatting would make a significant difference. I didn&#39;t truly understand it myself until we eliminated it from the Go code review and code editing processes. Hopefully in six months or a year, when everything is converted and we look back at this, the benefits will be clearer in retrospect.” — Russ Cox</p>
</blockquote>
<p>So, was it worth it? Yes, a thousand times. This experience taught me the value of uniformity and the power of automated tools to improve productivity.</p>
<p>The benefits of reformatting became apparent very quickly. Buildifier didn’t just reformat our BUILD files; it radically changed our approach to code maintenance and large-scale changes. Before Buildifier, large-scale changes in BUILD files were extremely hard to perform. Refactoring tools tried to detect and match the existing formatting style, but they couldn&#39;t work well (in particular in presence of code comments and multiline expressions) and there were lots of pushback in code reviews. With Buildifier, such changes became routine. This enabled lots of enhancements in Bazel that were previously considered impossible. This allowed us to fix legacy design issues.</p>
<p>In particular, this made it later possible for me to replace the Bazel build language, from Python to <a href="https://www.rileynwong.com/blog/an-overview-of-starlark">Starlark</a>.</p>
<h3>Updates</h3>
<ul>
<li>See <a href="https://news.ycombinator.com/item?id=40693264">the discussion on HackerNews</a>. In particular, Russ Cox (rsc) adds more background information.</li>
<li>Or <a href="https://www.reddit.com/r/programming/comments/1dh87j1/the_story_of_reformatting_100k_files_at_google_in/">discuss the article on Reddit</a>.</li>
<li>Credits also go to Nilton Volpato who wrote the original version of Buildifier, helped the transition and maintenance to the new implementation.</li>
<li>Why not enable the new formatter without updating all the files? This would lead to long diffs whenever someone modifies a file, making the change hard to review. The cost would be spread over all the engineers in the company.</li>
<li>The number of files was actually 193k at the beginning of the migration and 216k at the end.</li>
<li>It was in 2012. The title previously said 2011.</li>
</ul>
                        </div>

                
    
</article></div>
  </body>
</html>
