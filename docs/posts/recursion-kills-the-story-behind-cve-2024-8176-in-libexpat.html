<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.hartwork.org/posts/expat-2-7-0-released/">Original</a>
    <h1>Recursion kills: The story behind CVE-2024-8176 in libexpat</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody text">
    <p>For readers new to Expat:</p>
<blockquote>
<p><a href="https://libexpat.github.io/">libexpat</a> is a fast streaming XML parser.
Alongside libxml2, Expat is one of the
<a href="https://libexpat.github.io/doc/users/">most widely used</a>
software libre XML parsers written in C, specifically C99.
It is cross-platform and licensed under
<a href="https://opensource.org/licenses/MIT">the MIT license</a>.</p>
</blockquote>
<p><a href="https://github.com/libexpat/libexpat/releases/tag/R_2_7_0">Expat 2.7.0</a> has been released earlier today.
I will make this a more detailed post than usual
because in many ways there is more to tell about this release
than the average libexpat release: there is a story this time.</p>
<h2>What is in release 2.7.0?</h2>
<p>The key motivation for cutting a release now is to get the fix to
a long-standing vulnerability out to users: I will get to that vulnerability
— <code>CVE-2024-8176</code> — in detail in a moment.  First, what else is in this release?</p>
<p>There are also fixes to the two official build systems as usual,
as well as improvements to the documentation.</p>
<p>There is a <a href="https://github.com/libexpat/libexpat/pull/950">new fuzzer <code>xml_lpm_fuzzer</code></a>
by <a href="https://github.com/c01db33f">Mark Brand</a>
that OSS-Fuzz has already started to include with their daily
<a href="https://introspector.oss-fuzz.com/project-profile?project=expat">continuous fuzzing</a>;
the fuzzer is based on
Clang&#39;s <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer</a> and
Google&#39;s <a href="https://github.com/google/libprotobuf-mutator">libprotobuf-mutator (LPM)</a> that
applies a variant of
<a href="https://google.github.io/clusterfuzz/reference/coverage-guided-vs-blackbox/">coverage-guided fuzzing</a> called
<a href="https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md">structured fuzzing</a>.
A side job of integrating that new fuzzer was making dependency libprotobuf-mutator support
the versions of Protobuf that are shipped by Ubuntu 24.04, 22.04 and 20.04:
<a href="https://github.com/google/libprotobuf-mutator/pulls?q=is%3Amerged+is%3Apr+author%3Ahartwork">my related work upstream</a>
is available to everyone.</p>
<p>Another interesting sideshow of this release is the (harmless)
<a href="https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use">TOCTTOU issue</a>
that was uncovered by static analysis
in a benchmarking helper tool shipped next to core libexpat.  If you have not heard
of that class of race condition vulnerability but are curious,
the <a href="https://github.com/libexpat/libexpat/pull/959">related pull request</a>
could be of interest: it is textbook TOCTTOU in a real-world example.</p>
<p>One other thing that is new in this release is that Windows binaries are now built
by GitHub Actions rather than AppVeyor and not just 32bit but also 64bit.
I have added 64bit binaries post-release to the
<a href="https://github.com/libexpat/libexpat/releases/tag/R_2_6_4">previous release Expat 2.6.4</a>
already on January 21st, but only now it is becoming a regular part of the release process.</p>
<h2>The vulnerability report</h2>
<p>So what is that long-standing vulnerability about?
In July 2022 — roughly two and a half years ago —
<a href="https://thejh.net/">Jann Horn</a> of <a href="https://googleprojectzero.blogspot.com/">Google Project Zero</a>
and <a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">Spectre/Meltdown</a> fame
reached out to me via e-mail with a finding
in libexpat, including an idea for a fix.</p>
<p>What he found can be thought of as
&#34;the linear version of <a href="https://en.wikipedia.org/wiki/Billion_laughs_attack">billion laughs</a>&#34;
— a linear chain
(of so-called <a href="https://www.w3.org/TR/2006/REC-xml-20060816/#sec-physical-struct">general entities</a>)
rather than a tree — like this:</p>
<div><pre><span>&lt;!DOCTYPE doc [</span>
<span>  &lt;!ENTITY g0 &#39;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY g1 &#39;&amp;g0;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY g2 &#39;&amp;g1;&#39;&gt;</span>
]&gt;
<span>&lt;doc&gt;</span><span>&amp;g2;</span><span>&lt;/doc&gt;</span>
</pre></div>

<p>Except not with two (or three) levels, but thousands.
Why would a chain of thousands of entity references be a problem to libexpat?
Because of recursion, because of recursive C function calls:
each call to a function increases the stack, and
if functions are calling each other recursively, and
attacker-controlled input can influence the number of recursive calls,
then with the right input, attackers can force the stack to overflow
into the heap: stack overflow, segmentation fault,
<a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">denial of service</a>.
It depends on the stack size of the target machine how many levels of nesting
it takes for this to hit: 23,000 levels of nesting would be enough
to hit on one machine, but not another.</p>
<p>The education that introduces or leads people towards recursion should come
with a warning; recursion is not just beautiful, a thinking tool and allowing
for often simpler solutions — it also has a dark side to it:
a big inherent security problem.
The article
<a href="https://www.researchgate.net/publication/220477862_The_Power_of_10_Rules_for_Developing_Safety-Critical_Code">The Power of 10: Rules for Developing Safety-Critical Code</a>
warned about the use of recursion in 2006, but Expat development already started in 1997.</p>
<p>Already in that initial e-mail, Jann shared what he considered the fix —
avoiding (or resolving) recursion — and there was a proof-of-concept patch
attached of how that could be done in general.
Unlike other Project Zero findings, there would be
no <a href="https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-policy.html">90-days-deadline</a>
for this issue,
because
— while <a href="https://www.qualys.com/2017/06/19/stack-clash/stack-clash.txt">stack clashing</a>
was considered and is a theoretical possibility —
denial of service was considered to be the realistic impact.
It should be noted that this risk assessment comes without any guarantees.</p>
<h2>The vulnerability process</h2>
<p>Two things became apparent to me:</p>
<ol>
<li>It seemed likely that this vulnerability had multiple &#34;faces&#34; or variants,
   and that the only true fix would indeed be to effectively remove <em>all</em> remaining
   recursion from Expat.
   It is not the first time that recursion has been an issue in C software, or even
   libexpat in particular: <a href="https://github.com/ferivoz">Samanta Navarro</a>
   <a href="https://github.com/libexpat/libexpat/pull/558">resolved vulnerable recursion</a>
   in a different place in libexpat code in February 2022 already.
   Thanks again!</li>
<li>That it would be a pile of work,
   not a good match to my unpaid voluntary role in Expat as an addition to my
   unrelated-to-Expat day job,
   and not without risk without a partner at detail level on the topic.
   My prior work on
   <a href="https://blog.hartwork.org/posts/cve-2013-0340-billion-laughs-fixed-in-expat-2-4-0/">fixing billion laughs for Expat 2.4.0</a>
   made me expect this to be similar, but bigger.</li>
</ol>
<p>And with that expectation, the issue started aging without a fix,
and in some sense, I felt paralyzed about the topic and kept procrastinating
about it for a long time.
Every now and the topic came up with my friend,
journalist and security researcher <a href="https://hboeck.de/">Hanno Böck</a>
whom I had shared the issue with.
He was arguing that even without a fix, the issue should be made public
at some point.</p>
<p>One reason why I was objecting to publication without a fix was that it was clear
that in lack of a cheap clean fix, vendors and distributions would start
applying quick hacks that would produce false positives
(i.e. rejecting well-formed benign XML misclassified as an attack),
leave half of the issue
unfixed, and leave the ecosystem with a potentially heterogeneous state
of downstream patches where — say — in openSUSE a file would be rejected but
in Debian it would parse fine — or the other way around: a great mess.</p>
<p>I eventually concluded that the vulnerability could not
keep sitting in my inbox unfixed for another year,
that it needed a fix before publication to not cause a mess, and
that I had to take action.</p>
<h2>Reaching out to companies for help</h2>
<p>In early 2024, I started considering ways of finding help more, and
<a href="https://github.com/libexpat/libexpat/commit/8548bc03fdb887c8720f01e95440f1406bd15ffa">added a call for help banner</a>
to the change log that was included with Expat 2.6.2.
I started drafting an e-mail that I would send out to companies known to
use libexpat in hardware.
I had started maintaining a (by no means complete)
<a href="https://libexpat.github.io/doc/users/#hardware">public list of companies using Expat in hardware</a>
that now came in handy.</p>
<p>On April 14th, 2024 I started finding looking for security
contacts for companies on <a href="https://libexpat.github.io/doc/users/#hardware">that list</a>.
For some, it was easy to find and for others, I gave up eventually;
for some, I am still not sure whether I got the right address
or whether they are ghosting me as part of an <a href="https://en.wikipedia.org/wiki/Ostrich_policy">ostrich policy</a>.
I wish more companies would <a href="https://securitytxt.org/">start serving <code>/.well-known/security.txt</code></a>;
finding vulnerability report contacts is still actual work in 2025 and should not be.</p>
<p>So then I mailed to circa 40 companies using a template, like this:</p>
<div><pre>Hello ${company},


this e-mail is about ${company} product IT security.
Are you the right contact for that?  If not please forward
it to the responsible contact within ${company} — thank you!

On the security matter:

It has come to my attention that ${company} products and
business rely on libexpat or the &#34;Expat&#34; XML parser library,
e.g. product ${product} is using libexpat according to
document [1].  I am contacting you as the maintainer of
libexpat and its most active contributor for the last 8
years, as can be seen at [2]; I am reaching out to you today
to raise awareness that:

- All but the latest release of libexpat (2.6.2) have
  security issues known to the public, so every product
  using older versions of libexpat can be attacked through
  vulnerable versions of libexpat.

- Both automated fuzzing [3] and reports from security
  researchers keep uncovering vulnerabilities in libexpat,
  so it needs a process of updating the copy of libexpat
  that you bundle and ship with your products, if not
  already present.

- My time on libexpat is unfunded and limited, and there is
  no one but me to constantly work on libexpat security and
  to also progress on bigger lower priority tasks in
  libexpat.

- There is a non-public complex-to-fix security issue in
  libexpat that I have not been able to fix alone in my
  spare time for months now, that some attackers may have
  managed to find themselves and be actively exploiting
  today.

I need partners in fixing that vulnerability.
Can ${company} be a partner in fixing that vulnerability,
so that your products using libexpat will be secure to use
in the future?

I am looking forward to your reply, best



Sebastian Pipping

Maintainer of libexpat


[1] ${product_open_source_copyright_pdf_url}
[2] https://github.com/libexpat/libexpat/graphs/contributors
[3] https://en.wikipedia.org/wiki/Fuzzing
</pre></div>

<h2>Replies are coming in</h2>
<p>The responses I got from companies were all over the map:</p>
<ul>
<li>
<p>My &#34;favorite&#34; reply was &#34;We cannot understand what you want from us&#34;
  when everyone else had understood me just fine.  Nice!</p>
</li>
<li>
<p>Though that competes with the reply &#34;A patch will be released after the fall.&#34;
  when they had not received any details from me.  Okay!</p>
</li>
<li>
<p>There was arguing that the example product that I had mentioned was no
  longer receiving updates
  (rather than addressing their affected other products
  that are not end-of-life and continue to use libexpat).</p>
</li>
<li>
<p>I was asked to prove a concrete attack on the company&#39;s products
  (which would not scale, need access to the actual product, etc).</p>
</li>
<li>
<p>That they &#34;do not have sufficient resources to assist you on
  this matter even if libexpat is employed in some of .....&#39;s products&#34;
  came back a few times.</p>
</li>
</ul>
<p>It was interesting and fun in some sense, and not fun in another.</p>
<h2>Next stop: confidentiality</h2>
<p>What came next was that I asked companies to sign a simple freeform
<a href="https://en.wikipedia.org/wiki/Non-disclosure_agreement">NDA</a> with me.
Companies were not prepared for that.  Why was I asking for an NDA and
<a href="https://en.wikipedia.org/wiki/Traffic_Light_Protocol"><code>TLP:RED</code></a>?
To (1) make sure that who got the details would need to collaborate
on a true fix and not just monkey-patch their own setups and (2)
to avoid the scenario of heterogeneous trouble fixes
that I mentioned before
that would have been likely in case of a leak before there was a true fix.</p>
<p>Some discussions failed at NDA stage already, while others survived
and continued to video calls with me explaining Jann&#39;s findings in detail.</p>
<p>It is worth noting that I knew going in that many vulnerability reward
programs exclude the whole class of denial of service and so
I tied sharing the expected impact to signing an NDA to reduce the chances
of everyone discarding it &#34;Oh &#39;just&#39; denial of service, we&#39;ll pass&#34;.</p>
<h2>The eventual team and security work</h2>
<p>Simplifying a bit, I found two main partner companies in this:
<a href="https://www.siemens.com/">Siemens</a> and
<em>a company that would not like to be named</em>, let&#39;s call them &#34;Unnamed Company&#34;.
Siemens started development towards a candidate fix, and Unnamed Company
started evaluating options of what other companies they could pay to help for them,
which got <a href="https://www.linutronix.de/">Linutronix</a>
and also <a href="https://www.redhat.com/">Red Hat</a> involved.</p>
<p>Siemens took the builder role
while Linutronix, Red Hat and I provided quality assurance of various kinds.
While we did not work day and night, it is fair to say that we have been working
on the issue since May 2024 — <em>for about 10 months</em>.</p>
<h2>The three faces of the vulnerability</h2>
<p>It did indeed turn out that the vulnerability has multiple — three — faces:</p>
<h3>1. General entities in character data</h3>
<div><pre><span>&lt;!DOCTYPE doc [</span>
<span>  &lt;!ENTITY g0 &#39;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY g1 &#39;&amp;g0;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY g2 &#39;&amp;g1;&#39;&gt;</span>
]&gt;
<span>&lt;doc&gt;</span><span>&amp;g2;</span><span>&lt;/doc&gt;</span>
</pre></div>

<h3>2. General entities in attribute values</h3>
<div><pre><span>&lt;!DOCTYPE doc [</span>
<span>  &lt;!ENTITY g0 &#39;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY g1 &#39;&amp;g0;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY g2 &#39;&amp;g1;&#39;&gt;</span>
]&gt;
<span>&lt;doc</span><span> </span><span>key=</span><span>&#39;&amp;g2;&#39;</span><span>/&gt;</span>
</pre></div>

<h3>3. Parameter entities</h3>
<div><pre><span>&lt;!DOCTYPE doc [</span>
<span>  &lt;!ENTITY % p0 &#39;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY % p1 &#39;&amp;#37;p0;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY % p2 &#39;&amp;#37;p1;&#39;&gt;</span>
<span>  </span><span>&lt;!ENTITY % define_g0 &#34;&lt;!ENTITY g0 &#39;&amp;#37;p2;&#39;&gt;</span>&#34;&gt;
<span>  </span>%define_g0;
]&gt;
<span>&lt;doc/&gt;</span>
</pre></div>

<p>The third variant &#34;Parameter entities&#34; reuses ideas from my 2013 exploit for vulnerability
<a href="https://blog.hartwork.org/posts/cve-2021-3541-parameter-laughs-fixed-in-libxml2-2-9-11/">Parameter Laughs (CVE-2021-3541)</a>:
It used the same mechanism of delayed interpretation.</p>
<h2>Conclusions and gratitude</h2>
<p>It is no overstatement to say that without
<a href="https://github.com/berkayurun">Berkay Eren Ürün</a>
— the main author of the fix —
and his manager
<a href="https://www.linkedin.com/in/thomas-pr%C3%B6ll-5a8b8519b/">Dr. Thomas Pröll</a>
at Siemens there would be no fix today: a big and personal &#34;thank you!&#34; from me.</p>
<p>Thanks to Unnamed Company, to Linutronix, to Red Hat for your help making this plane fly!</p>
<p>Thanks to Jann Horn for his whitehat research and the demo patch that lead the path to a fix!</p>
<p>Thanks to everyone who contributed to this release of Expat!</p>
<p>And please tell your friends:</p>
<blockquote>
<p>Please leave recursion to math and keep it out of (in particular C) software:
it kills and will kill again.</p>
</blockquote>
<p>For more details about this release, please
<a href="https://github.com/libexpat/libexpat/blob/R_2_7_0/expat/Changes">check out the change log</a>.</p>
<p>If <em>you</em> maintain Expat packaging
or
a bundled copy of Expat
or
a pinned version of Expat somewhere,
please update to 2.7.0.  Thank you!</p>
<p>Sebastian Pipping</p>
    </div></div>
  </body>
</html>
