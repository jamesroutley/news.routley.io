<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://datasette.io/tools/openai-to-sqlite">Original</a>
    <h1>OpenAI-to-SQLite</h1>
    
    <div id="readability-page-1" class="page"><div>
    <div id="readme" data-path="README.md"><article itemprop="text">
<p dir="auto"><a href="https://pypi.org/project/openai-to-sqlite/" rel="nofollow"><img src="https://camo.githubusercontent.com/ae161be3743f7124d192fcaf01865e91518cde394473faa93c3431ae8cdbe18d/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f6f70656e61692d746f2d73716c6974652e737667" alt="PyPI" data-canonical-src="https://img.shields.io/pypi/v/openai-to-sqlite.svg"/></a>
<a href="https://github.com/simonw/openai-to-sqlite/releases"><img src="https://camo.githubusercontent.com/d54f195cd3391312fd9ac4edb3e6e90f1be3e440153de84ce5fe12f69d508c48/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f762f72656c656173652f73696d6f6e772f6f70656e61692d746f2d73716c6974653f696e636c7564655f70726572656c6561736573266c6162656c3d6368616e67656c6f67" alt="Changelog" data-canonical-src="https://img.shields.io/github/v/release/simonw/openai-to-sqlite?include_prereleases&amp;label=changelog"/></a>
<a href="https://github.com/simonw/openai-to-sqlite/actions?query=workflow%3ATest"><img src="https://github.com/simonw/openai-to-sqlite/workflows/Test/badge.svg" alt="Tests"/></a>
<a href="https://github.com/simonw/openai-to-sqlite/blob/master/LICENSE"><img src="https://camo.githubusercontent.com/1698104e976c681143eb0841f9675c6f802bb7aa832afc0c7a4e719b1f3cf955/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d417061636865253230322e302d626c75652e737667" alt="License" data-canonical-src="https://img.shields.io/badge/license-Apache%202.0-blue.svg"/></a></p>
<p dir="auto">This tool provides utilities for interacting with OpenAI APIs and storing the results in a SQLite database.</p>
<p dir="auto">See <a href="https://simonwillison.net/2023/Jan/13/semantic-search-answers/" rel="nofollow">Semantic search answers: Q&amp;A against documentation with GPT3 + OpenAI embeddings</a> for background on this project.</p>
<h2 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#user-content-installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h2>
<p dir="auto">Install this tool using <code>pip</code>:</p>
<div data-snippet-clipboard-copy-content="pip install openai-to-sqlite"><pre><code>pip install openai-to-sqlite
</code></pre></div>
<h2 dir="auto"><a id="user-content-configuration" aria-hidden="true" href="#user-content-configuration"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuration</h2>
<p dir="auto">You will need an OpenAI API key to use this tool.</p>
<p dir="auto">You can create one at <a href="https://beta.openai.com/account/api-keys" rel="nofollow">https://beta.openai.com/account/api-keys</a></p>
<p dir="auto">You can then either set the API key as an environment variable:</p>
<div data-snippet-clipboard-copy-content="export OPENAI_API_KEY=sk-..."><pre><code>export OPENAI_API_KEY=sk-...
</code></pre></div>
<p dir="auto">Or pass it to each command using the <code>--token sk-...</code> option.</p>
<h2 dir="auto"><a id="user-content-embeddings" aria-hidden="true" href="#user-content-embeddings"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Embeddings</h2>
<p dir="auto">The <code>embeddings</code> command can be used to calculate and store <a href="https://beta.openai.com/docs/guides/embeddings" rel="nofollow">OpenAI embeddings</a> for strings of text.</p>
<p dir="auto">Each embedding has a cost, so be sure to familiarize yourself with <a href="https://openai.com/api/pricing/" rel="nofollow">the pricing</a> for the embedding model.</p>
<p dir="auto">The command can accept data in four different ways:</p>
<ul dir="auto">
<li>As a JSON file containing a list of objects</li>
<li>As a CSV file</li>
<li>As a TSV file</li>
<li>By running queries against a SQLite database</li>
</ul>
<p dir="auto">For all of these formats there should be an <code>id</code> column, followed by one or more text columns.</p>
<p dir="auto">The ID will be stored as the content ID. Any other columns will be concatenated together and used as the text to be embedded.</p>
<p dir="auto">The embeddings from the API will then be saved as binary blobs in the <code>embeddings</code> table of the specified SQLite database - or another table, if you pass the <code>-t/--table</code> option.</p>
<h3 dir="auto"><a id="user-content-json-csv-and-tsv" aria-hidden="true" href="#user-content-json-csv-and-tsv"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>JSON, CSV and TSV</h3>
<p dir="auto">Given a CSV file like this:</p>
<div data-snippet-clipboard-copy-content="id,content
1,This is a test
2,This is another test"><pre><code>id,content
1,This is a test
2,This is another test
</code></pre></div>
<p dir="auto">Embeddings can be stored like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="openai-to-sqlite embeddings embeddings.db data.csv"><pre>openai-to-sqlite embeddings embeddings.db data.csv</pre></div>
<p dir="auto">The resulting schema looks like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="CREATE TABLE [embeddings] (
   [id] TEXT PRIMARY KEY,
   [embedding] BLOB
);"><pre>CREATE TABLE [embeddings] (
   [id] <span>TEXT</span> <span>PRIMARY KEY</span>,
   [embedding] BLOB
);</pre></div>
<p dir="auto">The same data can be provided as TSV data:</p>
<div data-snippet-clipboard-copy-content="id    content
1     This is a test
2     This is another test"><pre><code>id    content
1     This is a test
2     This is another test
</code></pre></div>
<p dir="auto">Then imported like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="openai-to-sqlite embeddings embeddings.db data.tsv"><pre>openai-to-sqlite embeddings embeddings.db data.tsv</pre></div>
<p dir="auto">Or as JSON data:</p>
<div dir="auto" data-snippet-clipboard-copy-content="[
  {&#34;id&#34;: 1, &#34;content&#34;: &#34;This is a test&#34;},
  {&#34;id&#34;: 2, &#34;content&#34;: &#34;This is another test&#34;}
]"><pre>[
  {<span>&#34;id&#34;</span>: <span>1</span>, <span>&#34;content&#34;</span>: <span><span>&#34;</span>This is a test<span>&#34;</span></span>},
  {<span>&#34;id&#34;</span>: <span>2</span>, <span>&#34;content&#34;</span>: <span><span>&#34;</span>This is another test<span>&#34;</span></span>}
]</pre></div>
<p dir="auto">Imported like this:</p>
<div data-snippet-clipboard-copy-content="openai-to-sqlite embeddings embeddings.db data.json"><pre><code>openai-to-sqlite embeddings embeddings.db data.json
</code></pre></div>
<p dir="auto">In each of these cases the tool automatically detects the format of the data. It does this by inspecting the data itself - it does not consider the file extension.</p>
<p dir="auto">If the automatic detection is not working, you can pass <code>--format json</code>, <code>csv</code> or <code>tsv</code> to explicitly specify a format:</p>
<div dir="auto" data-snippet-clipboard-copy-content="openai-to-sqlite embeddings embeddings.db data.tsv --format tsv"><pre>openai-to-sqlite embeddings embeddings.db data.tsv --format tsv</pre></div>
<h3 dir="auto"><a id="user-content-importing-data-from-standard-input" aria-hidden="true" href="#user-content-importing-data-from-standard-input"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Importing data from standard input</h3>
<p dir="auto">You can use a filename of <code>-</code> to pipe data in to standard input:</p>
<div dir="auto" data-snippet-clipboard-copy-content="cat data.tsv | openai-to-sqlite embeddings embeddings.db -"><pre>cat data.tsv <span>|</span> openai-to-sqlite embeddings embeddings.db -</pre></div>
<h3 dir="auto"><a id="user-content-data-from-a-sql-query" aria-hidden="true" href="#user-content-data-from-a-sql-query"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Data from a SQL query</h3>
<p dir="auto">The <code>--sql</code> option can be used to read data to be embedded from the attached SQLite database. The query must return an <code>id</code> column and one or more text columns to be embedded.</p>
<div data-snippet-clipboard-copy-content="openai-to-sqlite embeddings content.db \
  --sql &#34;select id, title from documents&#34;"><pre><code>openai-to-sqlite embeddings content.db \
  --sql &#34;select id, title from documents&#34;
</code></pre></div>
<p dir="auto">This will create a <code>embeddings</code> table in the <code>content.db</code> database and populate it with embeddings calculated from the <code>title</code> column in that query.</p>
<p dir="auto">You can also store embeddings in one database while reading data from another database, using the <code>--attach alias filename.db</code> option:</p>
<div data-snippet-clipboard-copy-content="openai-to-sqlite embeddings embeddings.db \
  --attach documents documents.db \
  --sql &#34;select id, title from documents.documents&#34;"><pre><code>openai-to-sqlite embeddings embeddings.db \
  --attach documents documents.db \
  --sql &#34;select id, title from documents.documents&#34;
</code></pre></div>
<p dir="auto">A progress bar will be displayed when using <code>--sql</code> that indicates how long the embeddings are likely to take to calculate.</p>
<p dir="auto">The CSV/TSV/JSON options do not correctly display the progress bar. You can work around this by importing your data into SQLite first (e.g. <a href="https://sqlite-utils.datasette.io/en/stable/cli.html#inserting-json-data" rel="nofollow">using sqlite-utils</a>) and then running the embeddings using <code>--sql</code>.</p>
<h3 dir="auto"><a id="user-content-batching" aria-hidden="true" href="#user-content-batching"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Batching</h3>
<p dir="auto">Embeddings will be sent to the OpenAI embeddings API in batches of 100. If you know that your data is short strings you can increase the batch size, up to 2048, using the <code>--batch-size</code> option:</p>
<div dir="auto" data-snippet-clipboard-copy-content="openai-to-sqlite embeddings embeddings.db data.csv --batch-size 2048"><pre>openai-to-sqlite embeddings embeddings.db data.csv --batch-size 2048</pre></div>
<h3 dir="auto"><a id="user-content-working-with-the-stored-embeddings" aria-hidden="true" href="#user-content-working-with-the-stored-embeddings"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Working with the stored embeddings</h3>
<p dir="auto">The <code>embedding</code> column is a SQLite blob containing 1536 floating point numbers encoded as a sequence of 4 byte values.</p>
<p dir="auto">You can extract them back to an array of floating point values in Python like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import struct

vector = struct.unpack(
    &#34;f&#34; * 1536, binary_embedding
)"><pre><span>import</span> <span>struct</span>

<span>vector</span> <span>=</span> <span>struct</span>.<span>unpack</span>(
    <span>&#34;f&#34;</span> <span>*</span> <span>1536</span>, <span>binary_embedding</span>
)</pre></div>
<h3 dir="auto"><a id="user-content-searching-embeddings-with-the-search-command" aria-hidden="true" href="#user-content-searching-embeddings-with-the-search-command"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Searching embeddings with the search command</h3>
<p dir="auto">Having saved the embeddings for content, you can run searches using the <code>search</code> command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="openai-to-sqlite search embeddings.db &#39;this is my search term&#39;"><pre>openai-to-sqlite search embeddings.db <span><span>&#39;</span>this is my search term<span>&#39;</span></span></pre></div>
<p dir="auto">The output will be a list of cosine similarity scores and content IDs:</p>
<div data-snippet-clipboard-copy-content="% openai-to-sqlite search blog.db &#39;cool datasette demo&#39;
0.843 7849
0.830 8036
0.828 8195
0.826 8098
0.818 8086
0.817 8171
0.816 8121
0.815 7860
0.815 7872
0.814 8169"><pre><code>% openai-to-sqlite search blog.db &#39;cool datasette demo&#39;
0.843 7849
0.830 8036
0.828 8195
0.826 8098
0.818 8086
0.817 8171
0.816 8121
0.815 7860
0.815 7872
0.814 8169
</code></pre></div>
<p dir="auto">Add the <code>-t/--table</code> option if your embeddings are stored in a different table:</p>
<div dir="auto" data-snippet-clipboard-copy-content="openai-to-sqlite search content.db &#39;this is my search term&#39; -t documents"><pre>openai-to-sqlite search content.db <span><span>&#39;</span>this is my search term<span>&#39;</span></span> -t documents</pre></div>
<h2 dir="auto"><a id="user-content-development" aria-hidden="true" href="#user-content-development"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Development</h2>
<p dir="auto">To contribute to this tool, first checkout the code. Then create a new virtual environment:</p>
<div data-snippet-clipboard-copy-content="cd openai-to-sqlite
python -m venv venv
source venv/bin/activate"><pre><code>cd openai-to-sqlite
python -m venv venv
source venv/bin/activate
</code></pre></div>
<p dir="auto">Now install the dependencies and test dependencies:</p>

<p dir="auto">To run the tests:</p>

</article></div>
    </div></div>
  </body>
</html>
