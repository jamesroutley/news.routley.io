<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://matklad.github.io/2024/09/06/fix-one-level-deeper.html">Original</a>
    <h1>Try to fix it one level deeper</h1>
    
    <div id="readability-page-1" class="page"><div>
  <article>


<p><span>I had a productive day today! I did many different and unrelated things, but they all had the same</span>
<span>unifying theme:</span></p>
<p><span>There</span>’<span>s a bug! And it is sort-of obvious how to fix it. But if you don</span>’<span>t laser-focus on that, and</span>
<span>try to perceive the surrounding context, it turns out that the bug is valuable, and it is pointing</span>
<span>in the direction of a bigger related problem. So, instead of fixing the bug directly, a detour is</span>
<span>warranted to close off the avenue for a class of bugs.</span></p>
<p><span>Here are the examples!</span></p>
<p><span>In the morning, my colleague pointed out that we are giving substandard error message for a pretty</span>
<span>stressful situation when the database runs out of disk space. I went ahead and added appropriate log</span>
<span>messages to make it clearer. But then I stopped for a moment and noticed that the problem is bigger</span>
—<span> we are missing an infrastructure for fatal errors, and </span><code>NoSpaceLeft</code><span> is just one of a kind. So I</span>
<span>went ahead and added that along the way:</span>
<a href="https://github.com/tigerbeetle/tigerbeetle/pull/2289"><span>#2289</span></a><span>.</span></p>
<p><span>Then, I was reviewing a PR by </span><code>@martinconic</code><span> which was fixing some typos, and noticed that it was</span>
<span>also changing the formatting of our Go code. The latter is by far the biggest problem, as it is the</span>
<span>sign that we somehow are not running </span><code>gofmt</code><span> during our CI, which I fixed in</span>
<a href="https://github.com/tigerbeetle/tigerbeetle/pull/2287"><span>#2287</span></a><span>.</span></p>
<p><span>Then, there was a PR from yesterday, where we again had a not quite right log message. The cause was</span>
<span>a confusion between two compile-time configuration parameters, which were close, but not quite</span>
<span>identical. So, instead of fixing the error message I went ahead and made the two parameters</span>
<em><span>exactly</span></em><span> the same. But then my colleague noticed that I actually failed to fix it one level deeper</span>
<span>in this case! Turns out, it is possible to remove this compile-time parametrization altogether,</span>
<span>which I did in </span><a href="https://github.com/tigerbeetle/tigerbeetle/pull/2292"><span>#2292</span></a><span>.</span></p>
<p><span>But these all were randomly-generated side quests. My intended story line for today was to refactor</span>
<span>the piece of code I had trouble explaining (and understanding!) on </span><a href="https://www.youtube.com/watch?v=C3XAteN_lYk&amp;list=PL9eL-xg48OM3pnVqFSRyBFleHtBBw-nmZ&amp;index=41"><span>yesterday</span>’<span>s</span>
<span>episode</span></a>
<span>of Iron Beetle. To get into the groove, I decided to first refactor the code that </span><em><span>calls</span></em><span> the</span>
<span>problematic piece of logic, as I noticed a couple of minor stylistic problems there. Of course, when</span>
<span>doing that, I discovered that we have a bit of dead code, which luckily doesn</span>’<span>t affect correctness,</span>
<span>but does obscure the logic. While fixing that, I used one of my favorite Zig patterns:</span>
<span><code>defer assert(postcondition);</code></span></p>
<p><span>It of course failed in the simulator in a way postcondition checks tend to fail </span>—<span> there was an</span>
<span>unintended reentrancy in the code. So I slacked my colleague something like</span></p>

<figure>
<blockquote><p><span>I thought myself to be so clever adding this assert, but now it fails and I have to fix it TT</span>
<span>I think I</span>’<span>ll just go and </span><code>.next_tick</code><span> the prefetch path. It feels like there should be a more</span>
<span>elegant solution here, but I am not seeing it.</span></p>
</blockquote>

</figure>
<p><span>But of course I can</span>’<span>t just </span>“<span>go and </span><code>.next_tick</code><span> it</span>”<span>, so here I am, trying to figure out how to</span>
<span>encode a </span><a href="https://en.wikipedia.org/wiki/Duff%27s_device"><span>Duff</span>’<span>s device</span></a><span> in Zig</span>
<span>pre-</span><a href="https://github.com/ziglang/zig/issues/8220"><span>#8220</span></a><span>, so as to make this class of issues much</span>
<span>less likely.</span></p>
</article>
  </div></div>
  </body>
</html>
