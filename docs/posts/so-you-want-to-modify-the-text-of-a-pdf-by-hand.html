<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/senderle/8ad6aae251c4ddf9424f8a05dd0e8c18">Original</a>
    <h1>So you want to modify the text of a PDF by hand</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-hand-modify-pdf-md">
      
      <div id="file-hand-modify-pdf-md-readme">
    <article itemprop="text">
<p dir="auto">If you, like me, resent every dollar spent on commercial PDF tools,
you might want to know how to change the text content of a PDF without
having to pay for Adobe Acrobat or another PDF tool. I didn&#39;t see an
obvious open-source tool that lets you dig into PDF internals, but I
did discover a few useful facts about how PDFs are structured that
I think may prove useful to others (or myself) in the future. They
are recorded here. They are surely not universally applicable --</p>
<p dir="auto">This guide is Mac-oriented, but the tools are all available via most
linux distributions as well.</p>
<h2 dir="auto"><a id="user-content-viewing-compressed-text-data" aria-hidden="true" tabindex="-1" href="#viewing-compressed-text-data"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Viewing compressed text data</h2>
<p dir="auto">You can open a PDF in a text editor and see some stuff that looks kinda
readable, in a vague way, but find that none of it is the actual text
of the PDF. It turns out that many PDFs store the text data in a
compressed form. To view the compressed data, you can use a command line
tool called <code>qpdf</code>. For Macs, there&#39;s a <a href="https://formulae.brew.sh/formula/qpdf" rel="nofollow">homebrew formula</a>.</p>
<p dir="auto">Here&#39;s a command that decompresses all compressed text streams in a
given PDF (via <a href="https://stackoverflow.com/a/11732099/577088" rel="nofollow">this stackoverflow post</a>):</p>
<pre><code>qpdf --qdf --object-streams=disable in.pdf out.pdf
</code></pre>
<p dir="auto">You can recompress the streams like so:</p>
<pre><code>qpdf out-edited.pdf out-recompressed.pdf
</code></pre>
<p dir="auto">This second command generated some errors for me, but the resulting PDF
was readable using Preview.</p>
<h2 dir="auto"><a id="user-content-finding-the-text-data" aria-hidden="true" tabindex="-1" href="#finding-the-text-data"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Finding the text data</h2>
<p dir="auto">Once you&#39;ve decompressed the compressed text streams, you can open the
PDF in a text editor and view them! Except you have to find them. Here&#39;s
what they look like in a basic form:</p>
<pre><code>BT
  /Font_0 12 Tf
  288 720 Td
  &lt;002a004800570003003600480057&gt; Tj
ET
</code></pre>
<p dir="auto">The <a href="https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/pdf_reference_archives/PDFReference.pdf" rel="nofollow">PDF Reference</a>
(Third Edition, p.293) has this to say about the above:</p>
<blockquote>
<p dir="auto">The five lines of this example perform the following steps:</p>
<ol dir="auto">
<li>Begin a text object.</li>
<li>Set the font and font size to use, installing them as parameters in the text state...</li>
<li>Specify a starting position on the page, setting parameters in the text object.</li>
<li>Paint the glyphs for a string of characters there.</li>
<li>End the text object.</li>
</ol>
</blockquote>
<h2 dir="auto"><a id="user-content-actually-reading-the-text" aria-hidden="true" tabindex="-1" href="#actually-reading-the-text"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Actually reading the text</h2>
<p dir="auto">As you can see from the above example, we <em>still</em> can&#39;t read the text.
It is encoded. And if you thought to yourself &#34;look at that hex string,
I bet it&#39;s a bunch of unicode code points&#34; -- well, I wish we lived in
a kinder world too. It seems there are a million ways to specify encodings
in PDFs, including <em>custom encodings that are embedded in the file itself</em>.
Those encodings <em>do</em> map to unicode code points (most of the time?), so that&#39;s
good. Let&#39;s assume that the file you&#39;re working with does have embedded
encodings (because I have no idea how to handle other cases).</p>
<h3 dir="auto"><a id="user-content-identifying-fonts-associated-with-embedded-encodings" aria-hidden="true" tabindex="-1" href="#identifying-fonts-associated-with-embedded-encodings"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Identifying fonts associated with embedded encodings</h3>
<p dir="auto">Text encodings in PDFs are linked to specific fonts. Information about those
encodings is embedded in the PDF in ways I don&#39;t understand, but there&#39;s an
existing command line tool that extracts it: <code>pdffonts</code>. Here&#39;s an example
of the output it generates:</p>
<pre><code>$ pdffonts sample.pdf
name                                 type              emb sub uni prob object ID
------------------------------------ ----------------- --- --- --- ---- ---------
CLDQZB+TrebuchetMS,Bold              CID TrueType      yes yes yes           9  0
YQBAIZ+TrebuchetMS                   CID TrueType      yes yes yes          10  0
</code></pre>
<p dir="auto">Here, the relevant fields are &#34;emb&#34; (meaning the encoding is embedded in
the PDF) and &#34;uni&#34; (meaning the encoding is to unicode code points rather
than to raw glyphs). Assuming both are set to &#34;yes,&#34; we&#39;re in luck.</p>
<p dir="auto">In the text example above, you&#39;ll notice the <code>\Font_0</code> descriptor. Not
all fonts in all PDFs will work this way, but in my case, those labels
lined up in a straightforward way with the listing of fonts above. (So
<code>\Font_0</code> is referring to the font named <code>CLDQZB+TrebuchetMS,Bold</code> in the
above table.)</p>
<h3 dir="auto"><a id="user-content-finding-the-embedded-encoding-table-for-the-given-font" aria-hidden="true" tabindex="-1" href="#finding-the-embedded-encoding-table-for-the-given-font"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Finding the embedded encoding table for the given font</h3>
<p dir="auto">Once you have determined the full name of your text&#39;s font (like
<code>CLDQZB+TrebuchetMS,Bold</code>) you can search for it. In my case it appeared
several times, but in one particular case, it appeared in a short
block of commands including one that looked like this:</p>
<pre><code>/ToUnicode 19 0 R
</code></pre>
<p dir="auto">This appears to specify the object id of the encoding table. If you then
search for <code>19 0 obj</code>, you&#39;ll find the table. (Or at least that&#39;s how
it worked in my case!)</p>
<h3 dir="auto"><a id="user-content-the-encoding-table-format" aria-hidden="true" tabindex="-1" href="#the-encoding-table-format"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>The encoding table format</h3>
<p dir="auto">The salient part of the encoding table looks like this:</p>
<pre><code>38 beginbfrange^M
&lt;0036&gt;&lt;0036&gt;&lt;0053&gt;^M
&lt;0057&gt;&lt;0057&gt;&lt;0074&gt;^M
&lt;0044&gt;&lt;0044&gt;&lt;0061&gt;^M
&lt;0048&gt;&lt;0048&gt;&lt;0065&gt;^M
&lt;0050&gt;&lt;0050&gt;&lt;006D&gt;^M
...
</code></pre>
<p dir="auto">If yours looks different, check out the <a href="https://www.adobe.com/content/dam/acom/en/devnet/acrobat/pdfs/5411.ToUnicode.pdf" rel="nofollow">ToUnicode mapping file tutorial</a>
which describes a bunch of possible variations. In this case, the table is
mapping ranges of custom encoding points to unicode points -- except these
are ranges of just one character. So here, the custom point <code>0036</code> maps to the
unicode point <code>0053</code> -- that is, the digit <code>5</code>.</p>
<p dir="auto">To perform this translation in an automated way, I used Python to convert the
table into a dictionary, and wrote some simple encoding and decoding functions.
This isn&#39;t a Python tutorial, sadly, but if you know Python or any other scripting
language, you can probably work out a few different ways to solve this part of
the problem.</p>
<p dir="auto">Equipped with my encoder and decoder, I determined the custom-encoded version of
the text I wanted to replace, wrote the replacement text and custom-encoded it,
and used find-and-replace to swap them out. The end!</p>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
