<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ersei.net/en/blog/its-nixin-time">Original</a>
    <h1>NixOS and my descent into insanity</h1>
    
    <div id="readability-page-1" class="page"><div><article><h2><a href="https://basicbitch.software/en/blog/its-nixin-time">NixOS and my Descent into Insanity</a></h2><p><small> Published: [ <b><time datetime="2023-06-29T10:00:00-04:00">2023-06-29 10:00</time></b> ] </small></p><p>As I tend to do, I picked a topic to write about that is much larger in scope than I could manage in a reasonable amount of time. Did I learn? Apparently not. This article started off with switching from <a href="https://www.zsh.org">zsh</a> to <a href="https://fishshell.com">fish</a>. Then I thought, &#34;Might as well manage it all with Nix!&#34;, which led me to switch to <a href="https://github.com/nix-community/home-manager">home manager</a> to manage my dotfiles which led me to using Nix everywhere I possibly could.</p><p>As expected, using Nix where it&#39;s not supported caused some issues. Buckle up, and watch my slow descent into madness (Nix).</p><p>Want to see the fruits of my labour? Find my Nix configurations <a href="https://git.sr.ht/~fd/nix-configs">on Sourcehut</a>.</p><p>Our story begins in the sweet month of March. The semester at college was winding down, I was suffering through the second set of midterms this semester, and I brought it upon myself to make a Matrix client for the PS Vita.</p><p>This was, predictably, a mess. The toolchain system was a mess. I was patching CMake scripts and it was no fun. I heard about Nix first when <a href="https://blog.replit.com/nix">Replit</a> added support for it way back when. It also seems like all the cool people on Mastodon were using Nix.</p><p>The seed had been planted.</p><p>Later on, I started having issues with my few-year-old Arch Linux install. It was slowing down, had weird bugs, and was all-around unpleasant to use. It culminated in realizing that my SSD performance was miserable. Probably some combination of age, LUKS, btrfs, and who knows what else I changed. I thought to myself, &#34;This would be a good time to reinstall Arch. I could have the BIOS do a low-level wipe of the SSD and bring it back to the original performance!&#34;</p><p>It was not a good time to reinstall. The semester was winding down, finals were coming up, and I definitely did not have the time to do anything complicated.</p><p>It is now the 19<sup>th</sup> of April. I am sitting in <a href="https://mastodon.lilysthings.org/users/i_lost_my_bagel">my friend&#39;s</a> dorm room backing up my files to her server so I could install NixOS. The thing I had practically no experience with. Being installed. On my only computer. That I prepare for my exams with.</p><p>Surprisingly, it went pretty well. Ignoring how it took me nearly thirty minutes to make the font size of the installer bigger because my laptop has a HiDPI screen, I had a functioning install in a few hours (after some weird issues that I don&#39;t remember anymore but <a href="https://social.ersei.net/@ersei/110227618228628965">put on Mastodon</a>) and a usable one a day later.</p><p>Things were going great. I did my final exams, semester over, went home. All the while tweaking Nvidia configurations and whatnot.</p><p>I follow <a href="https://octodon.social/users/faho">one of the lead Fish devs on Mastodon</a> and he talks about the Fish shell sometimes. It looked cool, and I was getting kinda sick of Zsh being slow in big Git repositories. Instead of fixing Zsh, I decided to give Fish a shot. Thankfully, the <a href="https://nixos.wiki/wiki/Fish">NixOS wiki had a page on installing Fish</a>.</p><p>I just had to put the following code in my NixOS configuration:</p><pre><code>programs.fish.<span>enable</span> = <span>true</span>;
users.<span>defaultUserShell</span> = pkgs.fish;</code></pre><p>I&#39;m pretty happy with the defaults. Let&#39;s load in my aliases from Zsh:</p><p>In <code>~/.config/fish/conf.d/aliases.fish</code>:</p><pre><code><span>alias</span> ls=<span>&#34;exa --color=auto -a -g&#34;</span>
<span>alias</span> cp=<span>&#34;cp -v&#34;</span>
<span>alias</span> sl=<span>&#34;ls&#34;</span>
<span>alias</span> clear=<span>&#34;clear -x&#34;</span>
<span>alias</span> ip=<span>&#34;ip -c&#34;</span>
<span>alias</span> vi=<span>&#34;nvim&#34;</span>
<span>alias</span> vim=<span>&#34;nvim&#34;</span>
<span>alias</span> cat=<span>&#34;bat&#34;</span>
<span>alias</span> rm=<span>&#34;trash-put&#34;</span>
<span>alias</span> netcat=<span>&#34;ncat&#34;</span>
<span>alias</span> nc=<span>&#34;ncat&#34;</span>
<span>alias</span> diff=<span>&#34;delta&#34;</span>
<span>alias</span> wp=<span>&#34;woodpecker-cli&#34;</span>

<span>alias</span> nvidia-on=<span>&#34;sudo nvidia-on&#34;</span>
<span>alias</span> nvidia-off=<span>&#34;sudo nvidia-off&#34;</span>

<span>alias</span> feh=<span>&#34;echo imv&#34;</span>
<span>alias</span> paru=<span>&#34;sudo sh -c &#39;nix-channel --update &amp;&amp; nixos-rebuild switch&#39;&#34;</span></code></pre><p><a href="https://git.sr.ht/~fd/nix-configs/tree/f4b1270b71e6ffd72c21ea4d78c6eb13ab13cddd">This</a> is what my NixOS configuration looked like before I decided to make everything harder for myself.</p><p>As I was first installing NixOS and setting up <a href="https://swaywm.org">Sway</a>, I saw that it could be installed with home-manager, whatever that was. When I clicked on it first, I got this wonderful warning:</p><blockquote><p>Unfortunately, it is quite possible to get difficult to understand errors when working with Home Manager, such as infinite loops with no clear source reference. You should therefore be comfortable using the Nix language and the various tools in the Nix ecosystem. Reading through the Nix Pills document is a good way to familiarize yourself with them.</p></blockquote><p>I <em>tried</em> reading the <a href="https://nixos.org/guides/nix-pills">Nix Pills</a> but it was so boring and technical so I stopped. I also literally just installed NixOS and had no idea how to use it. I thought to myself, <em>maybe another day</em>.</p><p>That day is upon us now. <a href="https://nix-community.github.io/home-manager/index.html#sec-install-standalone">Time to install!</a></p><p>There were a couple of options for installing home-manager: standalone, or as a NixOS module. I decided to go with the first one and not have it be a part of NixOS for a few reasons:</p><ul><li>I wanted to have the same home-manager workflow on multiple machines, even the ones that don&#39;t have NixOS</li><li>I wanted to manage my OS and my user separately</li><li>It looked like it was easier</li></ul><p>I started off with using home-manager to configure the Fish shell (I just copy-pasted from the wiki):</p><pre><code>programs.<span>fish</span> = {
  <span>enable</span> = <span>true</span>;
  <span>interactiveShellInit</span> = <span>&#39;&#39;
    set fish_greeting # Disable greeting
  &#39;&#39;</span>;
  <span>plugins</span> = [
    { <span>name</span> = <span>&#34;grc&#34;</span>; <span>src</span> = pkgs.fishPlugins.grc.src; }
    { <span>name</span> = <span>&#34;done&#34;</span>; <span>src</span> = pkgs.fishPlugins.done.src; }
    { <span>name</span> = <span>&#34;tide&#34;</span>; <span>src</span> = pkgs.fishPlugins.tide.src; }
    { <span>name</span> = <span>&#34;autopair&#34;</span>; <span>src</span> = pkgs.fishPlugins.autopair.src; }
    
    
    
    
    
    
    
    
    
    
  ];
};</code></pre><p>…and it worked? Kinda. I still had to install <code>fish</code> globally (in my NixOS configuration along with the home-manager configuration) so I could change my shell properly (foreshadowing).</p><h2 id="a-little-fishy-diversion">A Little (Fishy) Diversion<a href="#a-little-fishy-diversion" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>I wanted the <a href="https://github.com/franciscolourenco/done">done</a> plugin to work. It&#39;s pretty simple: it&#39;ll notify you when your terminal is unfocused and a long-running command finishes. I find it pretty cool. I set it up to use <code>notify-send</code>, and it worked just fine!</p><pre><code>programs.fish.<span>shellInit</span> = <span>&#39;&#39;
  set __done_notification_command &#39;<span>${pkgs.libnotify}</span>/bin/notify-send \$title \$message&#39;
&#39;&#39;</span>;</code></pre><p>Forgetting to put the <code>/bin/</code> bit of the path really messed me up, and it kinda drove me insane why it wasn&#39;t working. Building the home-manager generation did not throw an error, and neither did Fish.</p><h2 id="fish-and-nix-don-t-play-n">Fish and Nix Don&#39;t Play Nice<a href="#fish-and-nix-don-t-play-n" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>So Fish has this thing called &#34;universal variables&#34; that are set once and are persisted forever in a file called <code>fish_variables</code>. This is kinda antithetical to what Nix is—declarative configuration. Throwing universal variables into that mix doesn&#39;t really gel with Nix.</p><p>So, I had to do a little bit of trickery to get the variables to load in right. You see, Fish loads configuration in a specific order<sup id="fnref1:1"><a href="#fn:1">1</a></sup>: most importantly, it&#39;ll read <code>config.fish</code><em>last</em>. Guess what home-manager saves your configuration to? That&#39;s right. <code>config.fish</code>. So, we have to find a way to load in variables <em>without</em> universal variables that will be loaded in before the Fish plugins are loaded.</p><p>Home-manager keeps the Fish plugins in <code>~/.config/fish/conf.d</code> named <code>plugin-pluginname.fish</code>. Naturally, we just need to save a file that&#39;ll load variables before those plugins are loaded. Home-manager can do that for you, with <a href="https://nix-community.github.io/home-manager/options.html#opt-xdg.configFile"><code>xdg.configFile</code></a>!</p><pre><code>xdg.<span>configFile</span> = {
<span>&#34;fish/conf.d/00-home-manager-vars.fish&#34;</span> = {
  <span>enable</span> = <span>true</span>;
  <span>text</span> = <span>&#39;&#39;
    set tide_cmd_duration_threshold 3000
    set tide_prompt_add_newline_before false
    set tide_prompt_color_frame_and_connection 6C6C6C
    [...]
  &#39;&#39;</span>;
}</code></pre><p>Because <code>00</code> comes before <code>pl</code>, the text in that file will be loaded first! Of course, I&#39;m sure there&#39;s a better way to do this, but I&#39;m not familiar enough with Nix to figure it out. Yet.</p><h2 id="everything-else">Everything Else<a href="#everything-else" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>Now that I got a taste of home-manager to manage my dotfiles, of course I had to move everything else over. Over the next few days, I had the 800+ page <a href="https://nix-community.github.io/home-manager/options.html">&#34;Appendix A: configuration reference&#34;</a> open in one window, the NixOS wiki for the program I was trying to configure open in another.</p><p>Day in, day out, I pieced together my configuration for Sway, Waybar, and Neovim. It took a <em>while</em>. I moved my custom shell scripts over to <a href="https://github.com/NixOS/nixpkgs/blob/808125fff694e4eb4c73952d501e975778ffdacd/pkgs/build-support/trivial-builders.nix#L225-L250"><code>writeShellScriptBin</code></a>. I read through the very-hard-to-navigate Appendix A.</p><p>And then I ran the incantation.</p><pre><code>home-manager switch</code></pre><p>I did not realize that it would reload Sway. That was unexpected. I thought everything that I had open would just keep going until I reloaded it to use the new config. But home-manager did that for me.</p><p>And now my desktop was broken. Joy. <a href="https://github.com/swaywm/swayidle">Swayidle</a> went to sleep but did not wake the computer, the keybinds were ever-so-slightly off (<code>hjkl</code> instead of <code>jkl;</code>), and startup applications refused to work.</p><p>Time to debug.</p><h2 id="debugging-everything-else">Debugging Everything Else<a href="#debugging-everything-else" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>My problems boiled down to a few main issues:</p><ol><li>I forgot to put <code>/bin/</code> in the Nix paths</li><li>I tried to adapt my shell scripts instead of using the idiomatic home-manager or Nix methods</li><li>The documentation was so clunky and painful that I couldn&#39;t figure out how to do the idiomatic solution</li></ol><p>Seriously, if it weren&#39;t for sample configurations that I found online<sup id="fnref1:2"><a href="#fn:2">2</a></sup>, then I would be dead in the water.</p><p>Over the course of the next few days, I expanded my home-manager configuration to encompass everything I had dotfiles for. As part of this process, I also changed up my theming stack a little bit. I moved away from <code>qt5ct</code> and just used Kvantum the whole way (since that&#39;s what qt5ct was using anyway). A nice upside is that using home-manager to manage cursor themes and whatnot meant that my desktop was a lot easier to manage! I fixed all the fonts! Long-standing issues (inconsistent fonts, cursors, GTK file chooser bookmarks) that I never really bothered to fix are now fixed!</p><h2 id="what-isn-t-everything-els">What Isn&#39;t Everything Else?<a href="#what-isn-t-everything-els" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>There is one notable exception to programs I am not managing with home-manager, and that&#39;s SSH. Although it&#39;s pretty easy to use home-manager to manage SSH configurations, I&#39;d prefer the security-through-obscurity of people <em>not</em> knowing my SSH aliases (since, y&#39;know, I&#39;m making <a href="https://git.sr.ht/~fd/nix-configs">my nix configuration public</a>).</p><h2 id="carving-up-the-leviathan">Carving Up The Leviathan<a href="#carving-up-the-leviathan" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>At this point I had a <code>home.nix</code> that spanned a couple of thousand lines. This is a bad idea, mostly because it&#39;s hard to manage.</p><p>The main issue with splitting up the configuration is that I&#39;m bad at the Nix programming language and I have only an inkling of what I&#39;m doing. Eventually, I just did a &#34;best effort&#34; split. I split it into:</p><ol><li>User-specific things (username, home directory)</li><li>Common data (environment variables, etc)</li><li>Shell configuration (Fish)</li><li>Wayland configuration (Sway, GTK/Qt themes, Waybar, Autostart, <a href="https://codeberg.org/dnkl/foot">Foot terminal</a>, <a href="https://gitlab.com/chinstrap/gammastep">Gammastep</a>)</li><li>Neovim configuration (plugins and all)</li><li>Git configuration</li><li>Tmux configuration</li></ol><p>Why did I split it up like this? Simple! I don&#39;t need Sway on machines I&#39;m only going to be connecting remotely into!</p><p>Now that I have migrated all of my dotfiles over to being managed by home-manager, I gotta have everything managed by home-manager. I use only a couple of other machines: my server (SSH), <a href="https://exozy.me">exozyme</a> (SSH), and my college&#39;s servers for doing school projects. I don&#39;t do development on my server (only maintainence stuff), so I don&#39;t really need to install Nix there. exozyme, however, has Nix already installed…</p><h2 id="home-manager-on-arch-linu">Home-Manager on Arch Linux<a href="#home-manager-on-arch-linu" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>exozyme is a multi-user Arch Linux server. Only the administrator can install packages. As such, Nix was installed so users can install packages for themselves without muddying the whole OS and without going through administrator privileges. This shouldn&#39;t be too hard, right?</p><p>I clone my <code>nix-config</code> repository, install home-manager, create the symlink to the exozyme configuration (loads in shell, common, and Neovim), and switch. Of course, it worked perfectly. I don&#39;t know what you all expected. Sans the <code>chsh</code> issues (resolved by just putting <code>exec fish</code> into the <code>.bash_profile</code>), everything just worked.</p><p>It wasn&#39;t that bad, until I got nerd-sniped.</p><h2 id="in-which-the-fish-takes-r">In Which The Fish Takes Revenge<a href="#in-which-the-fish-takes-r" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>Remember the <code>done</code> plugin we installed for Fish <a href="#a-little-fishy-diversion">earlier</a>? Yeah, that won&#39;t work over SSH, since <code>notify-send</code> only works if your shell has access to that <a href="https://specifications.freedesktop.org/notification-spec/notification-spec-latest.html">FreeDesktop socket</a>. Over SSH, I don&#39;t have that.</p><p>But I had an idea. In the course of configuring my terminal, <a href="https://codeberg.org/dnkl/foot">Foot</a>, I saw something in the configuration files:</p><pre><code><span>[main]</span>
<span>notify</span>=notify-send -a <span>${app-id}</span> -i <span>${app-id}</span> <span>${title}</span> <span>${body}</span></code></pre><p>That&#39;s weird. I&#39;ve never gotten a notification from my terminal. Opening the <a href="https://codeberg.org/dnkl/foot/src/branch/master/README.md">README</a> showed me that the terminal supports something called OSC777.</p><p>What is an OSC? An OSC is a special escape sequence that makes the terminal Do Things™, such as changing cursor colours, changing the window title, accessing the clipboard, etc etc. One of these things that an OSC can do is send a desktop notification.</p><p>Implementing OSC777 to send a notification from Fish shouldn&#39;t be too hard, right? It&#39;s just a bunch of nested escape sequences and oh no it&#39;s gonna be painful.</p><p>I&#39;ll spare you that pain.</p><pre><code><span>set</span> __done_notification_command <span>&#39;echo -e &#34;\e]777;notify;$title;$message\e\\ &#34;&#39;</span>
<span>set</span> __done_allow_nongraphical 1</code></pre><p>Yes, that space at the end before the first double quote is important. Yes, the order of the quotes matter. Yes, I learned the hard way that this has to be in the XDG-managed Fish configuration. No, I don&#39;t even know what backslashes are anymore.</p><p>But it works. Over SSH, I get notifications.</p><p>Was it worth the pain? Reading through the manpages realizing that the capitalization of <code>e</code> matters? Trial and error and maybe forty home-manager generations? Countless hours figuring this out?</p><p>Absolutely.</p><p>Oh yeah, the (relevant) terminal configuration:</p><pre><code>programs.<span>foot</span> = {
  <span>enable</span> = <span>true</span>;
  <span>settings</span> = {
    <span>main</span> = {
      <span>notify</span> = <span>&#34;<span>${pkgs.libnotify}</span>/bin/notify-send -a \<span>${app-id}</span> -i utilities-terminal \<span>${title}</span> \<span>${body}</span>&#34;</span>;
      <span>notify-focus-inhibit</span> = <span>&#34;yes&#34;</span>;
    };
  };
};</code></pre><h2 id="home-manager-where-no-hom">Home-Manager Where No Home Has Been Managed Before<a href="#home-manager-where-no-hom" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>See, my university&#39;s machines don&#39;t have Nix installed. I originally didn&#39;t think this was going to be a problem.</p><p><img alt="ersei: they should add nix to data.cs.purdue.edu tbh. I wanna manage my neovim configs from there. Red person: oats, didn&#39;t you manage to get nix running unprivileged on a uni machine once? oats: Oh yeah, I don&#39;t think it was even that hard. https://nixos.wiki/wiki/Nix_Installation_Guide . Scroll down a bit and there&#39;s a &#34;installing without root&#34; section" src="https://basicbitch.software/user/pages/03.blog/32.its-nixin-time/chat-nix-rootless.png"/></p><p>So, I went on down to the <a href="https://nixos.wiki/wiki/Nix_Installation_Guide#Installing_without_root_permissions">NixOS wiki page</a>. The first option that I had was use <code>nix-user-chroot</code></p><h2 id="the-climb">The Climb<a href="#the-climb" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>The first item on the list was <a href="https://github.com/nix-community/nix-user-chroot">nix-user-chroot</a>. The university&#39;s server supported <a href="https://www.man7.org/linux/man-pages/man7/user_namespaces.7.html">user namespaces</a>, so I went ahead and ran the command on the wiki:</p><pre><code>mkdir -m 0755 ~/.nix
./nix-user-chroot ~/.nix bash -c &#39;curl -L https://nixos.org/nix/install | sh&#39;</code></pre><p>And it worked! I now had Nix! Now to have it load in the chroot by default:</p><p>In <code>.profile</code>:</p><pre><code><span>if</span> [[ ! -e ~/.nix-profile ]]; <span>then</span> <span>exec</span> ~/nix-user-chroot ~/.nix bash; <span>fi</span></code></pre><p>This checks if symlink is not working (which means we are not in the chroot yet), then loads the chroot.</p><p>And to finish it off, we add this to the <code>.bashrc</code> so we can get proper Nix paths:</p><pre><code><span>if</span> [ -f ~/.nix-profile/etc/profile.d/nix.sh ]; <span>then</span>
    <span>source</span> ~/.nix-profile/etc/profile.d/nix.sh
<span>fi</span></code></pre><p>Now to move my dotfiles over! Let&#39;s first install home-manager the normal way (standalone) like we did earlier (and like how it&#39;s <a href="https://nix-community.github.io/home-manager/index.html#sec-install-standalone">documented</a>).</p><p>This is where I ran into my first issue. You see, in an attempt to curb backup costs, each user has a quota of 3072 MB (4096 MB hard). Installing home-manager used about 1.5 gigs. I do not see good things in the future.</p><p>Running the <code>home-manager switch</code> incantation after creating the symlinks caused my user to hit the quota. Luckily, there&#39;s a &#34;scratch&#34; directory every user has that has no such quota and is not backed up. I don&#39;t need my Nix store to be backed up. This is an acceptable tradeoff. One purging of the <code>.nix</code> folder and moving to the scratch directory later, I am no longer constrained by follies such as &#34;storage&#34;.</p><p>But now I have another problem. As part of my Neovim configuration, I use <code>typescript-language-server</code>. That package refuses to install:</p><pre><code>post-installation fixup
chmod: changing permissions of &#39;/nix/store/6977681wxwspnc15l87zzr3zh9bavscn-typescript-language-server-3.3.2&#39;: Operation not permitted
chmod: changing permissions of &#39;/nix/store/6977681wxwspnc15l87zzr3zh9bavscn-typescript-language-server-3.3.2/lib/node_modules/.bin&#39;: Operation not permitted
[many more]</code></pre><h2 id="the-stumble">The Stumble<a href="#the-stumble" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>Looks like a recursive <code>chmod</code> is being run. Let&#39;s find out what is happening.</p><p>I run <code>home-manager switch -n --debug</code> to get hopefully some more information about the build failure. I see <code>auto-disabling sandboxing because the prerequisite namespaces are not available</code>. It seems like nested namespaces aren&#39;t working, which causes <code>chmod</code> to fail. Disabling sandboxing in my Nix configuration did not help.</p><p>The final nail in the coffin is that the <code>nix-user-chroot project</code> is abandoned.</p><p><img alt="nix-user-chroot: Maintainance status: unmaintained. I currently do not have any use for the tool and therefore do not activly fix bugs or add features. I don&#39;t expect many regressions over time as kernel APIs are stable but new use cases might break with it. If you are a user having issues with it, you may also try out if nix-portable solves your use case. If you have recommendations from one over the other please, feel free to make a pull request to update this description." src="https://basicbitch.software/user/pages/03.blog/32.its-nixin-time/nix-user-chroot-unmaintained.png"/></p><p>Wonderful. Let&#39;s go over to <a href="https://github.com/DavHau/nix-portable">nix-portable</a> and see if that does anything.</p><h2 id="the-fall">The Fall<a href="#the-fall" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>After installing and getting <code>nix-portable</code> set up, I come across the bit in the documentation: &#34;Missing Features: managing nix channels via <code>nix-channel</code>&#34;.</p><p>Home-manager needs to add a channel to install it. This will not do.</p><p>And I kept falling.</p><p>In a fit of desperation, I go back to the NixOS wiki and see if there are any other solutions that could help me on my self-inflicted journey of unifying my dotfiles.</p><p>Maybe <a href="https://gitlab.com/proot/proot">proot</a> can help? Turns out it can! As long as I disable Nix sandboxing. Ideally, I could keep this enabled to ensure consistent build environments and security and whatnot. It also looks like it works by intercepting syscalls and not all syscalls are supported, which causes some programs, like—oh I don&#39;t know, the Nix installer—to fail.</p><p>Can you taste the desperation?</p><h2 id="the-pit">The Pit<a href="#the-pit" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>And now, after reading through those options and trying each one out, I come across this lovely tidbit:</p><blockquote><p>You can make all nix commands use the alternate store by specifying it in <code>~/.config/nix/nix.conf</code> as <code>store = /home/USERNAME/my-nix</code>.</p></blockquote><p>Was it… was it really so easy all this time? I just needed to get a standalone Nix binary and then set the configuration?</p><p>Turns out, no. Getting a standalone Nix binary is hard enough, but also changing the Nix store path messes with everything (and also it would be a symlink).</p><blockquote><p>Normally, the Nix store directory (typically <code>/nix/store</code>) is not allowed to contain any symlink components. This is to prevent &#34;impure&#34; builds. Builders sometimes &#34;canonicalise&#34; paths by resolving all symlink components. Thus, builds on different machines (with <code>/nix/store</code> resolving to different locations) could yield different results. This is generally not a problem, except when builds are deployed to machines where <code>/nix/store</code> resolves differently. If you are sure that you’re not going to do that, you can set NIX_IGNORE_SYMLINK_STORE to 1.</p></blockquote><p>Yeah, this would be catastrophically bad.</p><p>I&#39;m flat out of ideas.</p><h2 id="escaping-the-pit">Escaping The Pit<a href="#escaping-the-pit" data-anchor-icon="#" aria-label="Anchor"></a></h2><p>And then there was a glimmer of recognition in my eye. As I was reading through <a href="https://github.com/DavHau/nix-portable/blob/master/README.md"><code>nix-portable</code>&#39;s README</a>, it mentioned <code>bwrap</code>. And that got the brain-gears going.</p><p>In response to the <a href="https://prismlauncher.org/news/cf-compromised-alert">fractureiser malware</a>, I wrote <a href="https://basicbitch.software/en/blog/isolate-minecraft">a post</a> describing how I can isolate Minecraft. I used <code>bwrap</code>. This time, instead of isolating the program, I wanted to isolate as little as possible while still messing with the program-facing filesystem.</p><pre><code><span>#!/usr/bin/env bash
</span>
<span>if</span> [ -z <span>${NIXDIR+x}</span> ]; <span>then</span> 
    <span>echo</span> <span>&#34;NIXDIR is unset! It needs to be set in the code. Edit this shell file and read the instructions.&#34;</span>
    <span>echo</span> <span>&#34;Executing bash without Bubblewrap…&#34;</span>
    <span>exec</span> bash
<span>fi</span>

<span>if</span> [ ! -e <span>$NIXDIR</span> ]; <span>then</span>
    <span>echo</span> <span>&#34;NIXDIR doesn&#39;t point to a valid location! Falling back to Bash&#34;</span>
    <span>exec</span> bash
<span>fi</span>

<span><span>_bind</span></span>() {
    _bind_arg=<span>$1</span>
    <span>shift</span>
    <span>for</span> _path <span>in</span> <span>&#34;<span>$@</span>&#34;</span>; <span>do</span>
        args+=(<span>&#34;<span>$_bind_arg</span>&#34;</span> <span>&#34;<span>$_path</span>&#34;</span> <span>&#34;<span>$_path</span>&#34;</span>)
    <span>done</span>
}

<span><span>bind</span></span>() {
    _bind --<span>bind</span>-try <span>&#34;<span>$@</span>&#34;</span>
}

<span><span>robind</span></span>() {
    _bind --ro-bind-try <span>&#34;<span>$@</span>&#34;</span>
}

<span><span>devbind</span></span>() {
    _bind --dev-bind-try <span>&#34;<span>$@</span>&#34;</span>
}

args=(
    --<span>bind</span> <span>$NIXDIR</span> /nix
)

<span>bind</span> \
    <span>$HOME</span>

devbind \
    /dev \
    /proc \
    /tmp \
    /run \
    /u \
    /p \
    /bin \
    /boot \
    /etc \
    /home \
    /lib \
    /lib32 \
    /lib64 \
    /libx32 \
    /media \
    /usr \
    /var

<span>exec</span> bwrap <span>&#34;<span>${args[@]}</span>&#34;</span> <span>&#34;<span>$@</span>&#34;</span></code></pre><p>And to use the Nix environment by default, I put the following into my <code>.profile</code>:</p><pre><code><span>if</span> [ -e <span>$HOME</span>/.nix-profile/etc/profile.d/nix.sh ]; <span>then</span> 
    <span>source</span> <span>$HOME</span>/.nix-profile/etc/profile.d/nix.sh 
<span>else</span>
    <span>if</span> [ -e <span>$HOME</span>/nix-configs/bwrap.sh ]; <span>then</span>
        <span>exec</span> env NIXDIR=<span>$HOME</span>/scratch/nix <span>$HOME</span>/nix-configs/bwrap.sh <span>$HOME</span>/.nix-profile/bin/fish
    <span>fi</span>
<span>fi</span></code></pre><p>The good: Everything works. Yes really.</p><p>The bad: All the other users show up as <code>nobody</code>. I guess that&#39;s fine?</p><p>The ugly: It&#39;s kinda slow (because the scratch directory (and thus Nix and all of the binaries and configuration files created by home-manager) are being stored on NFS). I feel like this is an acceptable tradeoff, and the slowness is only really noticeable when opening Neovim or starting a new Fish instance.</p><p>Absolutely. I have Nix working in a rootless environment (practically) perfectly. What more could I ask for? I can finally one-up the Plan 9 folks adding their smart-bulbs to their grids and instead go use Nix where nobody right in their minds would use it.</p><p>And also it&#39;s nice having my dotfiles fun to manage again.</p><p>Now to figure out what a &#34;flake&#34; is…</p><p><a href="https://social.ersei.net/users/ersei">Follow me on Mastodon</a> to see me get mad at Nix more!</p><p>Corrections? Comments? Just wanna say hi? <a href="https://basicbitch.software/en/contact-me">Get in touch!</a></p></article></div></div>
  </body>
</html>
