<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/kkuchta/css-only-chat">Original</a>
    <h1>GitHub â€“ kkuchta/CSS-only-chat: A monstrous async web chat using no JavaScript</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/1eee94f904421fdcf75ac8ef41e2d4fd04a96c1582b25d2b2a523ff88cfdeac6/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f64576b78415a5467394e6241687652714f652f67697068792e676966"><img src="https://camo.githubusercontent.com/1eee94f904421fdcf75ac8ef41e2d4fd04a96c1582b25d2b2a523ff88cfdeac6/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f64576b78415a5467394e6241687652714f652f67697068792e676966" alt="" data-animated-image="" data-canonical-src="https://media.giphy.com/media/dWkxAZTg9NbAhvRqOe/giphy.gif"/></a></p>

<p dir="auto">A truly monstrous async web chat using no JS whatsoever on the frontend.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/5ba15e4b34015d34832c7f6eeac47c8c37822706f59a168f6d9799f421acf15f/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f6d43436c5353367862693875732f67697068792e676966"><img src="https://camo.githubusercontent.com/5ba15e4b34015d34832c7f6eeac47c8c37822706f59a168f6d9799f421acf15f/68747470733a2f2f6d656469612e67697068792e636f6d2f6d656469612f6d43436c5353367862693875732f67697068792e676966" alt="" data-animated-image="" data-canonical-src="https://media.giphy.com/media/mCClSS6xbi8us/giphy.gif"/></a></p>

<p dir="auto">This is an asynchronous chat that sends + receives messages in the browser with no reloads and no javascript.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-ok-so-how" aria-hidden="true" href="#ok-so-how"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Ok so how</h2>
<p dir="auto">Background-images loaded via pseudoselectors + a forever-loading index page (remember <a href="https://en.wikipedia.org/wiki/Comet_(programming)" rel="nofollow">Comet</a>?).</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-say-that-again" aria-hidden="true" href="#say-that-again"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Say that again?</h2>
<p dir="auto">Ok, so there are two things we need the browser to do: send data and receive data.  Let&#39;s start with the first.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-sending-data" aria-hidden="true" href="#sending-data"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Sending Data</h3>
<p dir="auto">CSS is really limited in what it can do.  However, we <em>can</em> use it to effectively detect button presses:</p>
<div data-snippet-clipboard-copy-content=".some-button:active {
  background-image: url(&#39;some_image.jpg&#39;)
}"><pre><code>.some-button:active {
  background-image: url(&#39;some_image.jpg&#39;)
}
</code></pre></div>
<p dir="auto">What&#39;s cool is that a browser won&#39;t actually load that background image until this selector is used - that is, when this button is pressed.  So now we have a way to trigger a request to a server of our choice on a button press.  That sounds like data sending!</p>
<p dir="auto">Now, of course, this only works once per button (since a browser won&#39;t try to load that image twice), but it&#39;s a start.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-receiving-data" aria-hidden="true" href="#receiving-data"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Receiving Data</h3>
<p dir="auto">Since we can&#39;t use JS, it&#39;s really hard to change a page after it&#39;s already been loaded.  But it <em>is</em> possible.</p>
<p dir="auto">Back before websockets were widely supported, we had to use clever hacks if we wanted to push data from a server to a client in an ongoing basis.  One such hack was just to make the page never finish loading.  It turns out that you can tell the browser to start rendering a page before it&#39;s finished loading (using the <code>Transfer-Encoding: chunked</code> http header).  And when you do that, you don&#39;t <em>actually</em> have to stop loading the page.  You can just keep adding stuff to the bottom of the html forever, at whatever rate you want.</p>
<p dir="auto">So, for example, you could start sending a normal html page, then just stop sending html (while still telling the client you&#39;re sending) until you&#39;re ready to deliver another message.</p>
<p dir="auto">Now, all this lets us do is periodically append html to the page.  What can we do with that?  How about, when you load the index page, this happens:</p>
<ol dir="auto">
<li>We load up the first pile of html we want to show.  A welcome message, etc.</li>
<li>We stop loading html for a while until we want to send some sort of update.</li>
<li>Now we load up a <code>&lt;style&gt;</code> element that <code>display: none</code>&#39;s all the previous html</li>
<li>Then we load up whatever <em>new</em> html we want to show</li>
<li>Finally we wait until the next update we want to send and GOTO 3.</li>
</ol>
<h3 tabindex="-1" dir="auto"><a id="user-content-single-use-buttons" aria-hidden="true" href="#single-use-buttons"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Single-use buttons?</h3>
<p dir="auto">Ok, so we have that problem earlier where each button is only single-use.  It tries to send a get request once, then never will again.</p>
<p dir="auto">Thankfully, our method of receiving data fixes that for us.  Here&#39;s what happens:</p>
<ol dir="auto">
<li>We show an &#34;a&#34; button whose background image is like &#34;img/a&#34;.</li>
<li>When you press it, the server receives the image request for &#34;a&#34;</li>
<li>The server then pushes an update to the client to hide the current button and replace it with one whose background images is &#34;image/aa&#34;.</li>
</ol>
<p dir="auto">If the buttons you pressed were &#34;h&#34;, &#34;e&#34;, and &#34;l&#34;, then the &#34;a&#34; button&#39;s background image url would be &#34;img/hela&#34;.  And since we&#39;re replacing all buttons every time you press one, the single-use button problem goes away!</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-misc-other-details" aria-hidden="true" href="#misc-other-details"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Misc other details</h3>
<ul dir="auto">
<li>We actually encode a bit more info into the button urls (like each client&#39;s id)</li>
<li>Because the data-sending and data-receiving happens on different threads, we need inter-thread communication.  That sounds like work, so we&#39;ll just use Redis pubsub for that.</li>
</ul>
<h3 tabindex="-1" dir="auto"><a id="user-content-faq" aria-hidden="true" href="#faq"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>FAQ</h3>
<p dir="auto"><strong>What inspired this?</strong> Chernobyl, Hindenburg, The Tacoma Narrows Bridge...</p>
<p dir="auto"><strong>Really?</strong> No, it was this <a href="https://twitter.com/davywtf/status/1124130932573839360" rel="nofollow">clever tweet</a> by davywtf.</p>
<p dir="auto"><strong>Why&#39;s your code suck</strong> Why do <em>you</em> suck?</p>
<p dir="auto"><strong>No but really</strong> Because I was mostly making this up as I went.  There&#39;s a lot of exploratory coding here that I only minimally cleaned up.  If I rebuilt it I&#39;d store the UI state for a client in redis and just push it out in its entirety when needed via a single generic screen-updating mechanism.</p>
<p dir="auto"><strong>What could go wrong with this technique?</strong> Broken by browser bg-image handling changes; long-request timeouts; running out of threads; fast-clicking bugs; generic concurrency headaches; poor handling by proxies; it&#39;s crazy inaccessible; etc etc</p>
<p dir="auto"><strong>Should I use this in real life?</strong> Dear god yes.</p>
<p dir="auto"><strong>I have an idea for how this could be made better/worse/hackier</strong> <a href="https://twitter.com/kkuchta" rel="nofollow">Tweet at me (@kkuchta)</a>.  I&#39;m always down to see a terrible idea taken further!</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-practical-details" aria-hidden="true" href="#practical-details"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Practical Details</h3>
<p dir="auto">If you want to install and use this locally you should:</p>
<ol dir="auto">
<li>Re-evaluate your life choices</li>
<li>If you simply must continue, check out INSTALL.md</li>
</ol>
<p dir="auto">If you want to contribute, see number 1 above.  After that, just fork this repo, make a change, and then open a PR against this repo.</p>
</article>
          </div></div>
  </body>
</html>
