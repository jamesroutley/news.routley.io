<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://til.simonwillison.net/clickhouse/github-explorer">Original</a>
    <h1>Querying the GitHub archive with the ClickHouse playground</h1>
    
    <div id="readability-page-1" class="page"><section>



<p>Via <a href="https://news.ycombinator.com/item?id=34197637" rel="nofollow">this comment</a> on Hacker News I started exploring the <a href="https://clickhouse.com/docs/en/getting-started/playground/" rel="nofollow">ClickHouse Playground</a>. It&#39;s really cool, and among other things it allows CORS-enabled API hits that can query a decade of history from the GitHub events archive in less than a second.</p>
<h2><a id="user-content-clickhouse" aria-hidden="true" href="#clickhouse"><span aria-hidden="true"></span></a>ClickHouse</h2>
<p><a href="https://clickhouse.com/" rel="nofollow">ClickHouse</a> is an open source column-oriented database, originally developed at Yandex but spun out into a separate, VC-funded company in 2021. It&#39;s designed for big data analytical queries - in a similar space to HBase, BigQuery and DuckDB.</p>
<p>It turns out it can do <a href="https://news.ycombinator.com/item?id=34197637" rel="nofollow">that trick with HTTP range queries</a> where you can point it at the URL to a Parquet or <code>.native.zst</code> file (ClickHouse native format, optionally compressed using <a href="https://github.com/facebook/zstd">Facebook Zstandard</a>) and run queries without downloading the entire file first.</p>
<h2><a id="user-content-exploring-the-playground" aria-hidden="true" href="#exploring-the-playground"><span aria-hidden="true"></span></a>Exploring the Playground</h2>
<p>The ClickHouse Playground is a free hosted environment for trying out ClickHouse. You can access it here:</p>
<p><a href="https://play.clickhouse.com/play?user=play" rel="nofollow">https://play.clickhouse.com/play?user=play</a></p>
<p>Try this query, taken from the <a href="https://ghe.clickhouse.tech/" rel="nofollow">ClickHouse Everything You Always Wanted To Know
About GitHub (But Were Afraid To Ask)</a> tutorial:</p>
<div><pre><span>SELECT</span> <span>count</span>() <span>FROM</span> github_events <span>WHERE</span> event_type <span>=</span> <span><span>&#39;</span>WatchEvent<span>&#39;</span></span></pre></div>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/9599/210161204-5ec2c8fa-3d22-44f7-b95d-5d5f71bdce8a.png"><img width="834" alt="The playground interface says Elapsed: 0.043 sec, read 341.54 million rows, 341.54 MB - and returns a count() of 341429632" src="https://user-images.githubusercontent.com/9599/210161204-5ec2c8fa-3d22-44f7-b95d-5d5f71bdce8a.png"/></a></p>
<h2><a id="user-content-github_events" aria-hidden="true" href="#github_events"><span aria-hidden="true"></span></a>github_events</h2>
<p>The <code>github_events</code> table contains a copy of the <a href="https://www.gharchive.org/" rel="nofollow">GH Archive</a> - a project that archives and makes available the public GitHub timeline, I think using data from the <a href="https://docs.github.com/en/rest/activity/events?apiVersion=2022-11-28#list-public-events">public events API</a>. GH Archive then makes that data available as compressed newline-delimited JSON in <a href="https://data.gharchive.org/" rel="nofollow">this bucket</a>. The archive stretches back to February 2011, and is constantly updated.</p>
<p>The ClickHouse demo table is continually updated with the latest archived data, by <a href="https://github.com/ClickHouse/github-explorer/blob/main/update.sh">this script</a>, which runs every 10 minutes.</p>
<p>You can do all sorts of fun stuff with it. Here&#39;s my recent activity acrosss all of GitHub:</p>
<div><pre><span>SELECT</span>
  created_at,
  actor_login,
  repo_name,
  event_type,
  title
<span>FROM</span>
  github_events
<span>WHERE</span>
  actor_login <span>=</span> <span><span>&#39;</span>simonw<span>&#39;</span></span>
  <span>AND</span> repo_name <span>!=</span> <span><span>&#39;</span>simonw/disaster-data<span>&#39;</span></span>
<span>ORDER BY</span>
  created_at <span>DESC</span>
<span>LIMIT</span>
  <span>100</span></pre></div>
<p><a href="https://play.clickhouse.com/play?user=play#U0VMRUNUCiAgY3JlYXRlZF9hdCwKICBhY3Rvcl9sb2dpbiwKICByZXBvX25hbWUsCiAgZXZlbnRfdHlwZSwKICB0aXRsZQpGUk9NCiAgZ2l0aHViX2V2ZW50cwpXSEVSRQogIGFjdG9yX2xvZ2luID0gJ3NpbW9udycKICBBTkQgcmVwb19uYW1lICE9ICdzaW1vbncvZGlzYXN0ZXItZGF0YScKT1JERVIgQlkKICBjcmVhdGVkX2F0IERFU0MKTElNSVQKICAxMDA=" rel="nofollow">This link</a> executes that query - note how it includes a base64 encoded copy of the SQL query following the <code>#</code> in the URL.</p>
<p>There are 77 tables total in the Playground instance - you can get a list of them like this:</p>
<div><pre><span>SELECT</span> database, name <span>FROM</span> <span>system</span>.<span>tables</span></pre></div>
<h2><a id="user-content-api-access" aria-hidden="true" href="#api-access"><span aria-hidden="true"></span></a>API access</h2>
<p>You can access the API via <code>curl</code> like this:</p>
<div><pre>curl <span><span>&#39;</span>https://play.clickhouse.com/<span>&#39;</span></span> \
  -X POST \
  -H <span><span>&#39;</span>Authorization: Basic cGxheTo=<span>&#39;</span></span> \
  --data-raw <span><span>$&#39;</span></span>
<span>    SELECT created_at, actor_login, repo_name</span>
<span>    FROM github_events</span>
<span>    WHERE event_type = <span>\&#39;</span>WatchEvent<span>\&#39;</span></span>
<span>    ORDER BY created_at DESC LIMIT 100<span>&#39;</span></span></pre></div>
<p>This defaults to returning TSV without column headers, like this:</p>
<div><pre><span>2023-01-01 03</span>:<span>59</span>:<span>59</span>	<span>Willmac16</span>	<span>nlohmann/json</span>
<span>2023-01-01 03</span>:<span>59</span>:<span>59</span>	<span>Samrose-Ahmed</span>	<span>Stebalien/stash-rs</span>
<span>2023-01-01 03</span>:<span>59</span>:<span>57</span>	<span>CodePromoter</span>	<span>aplus-framework/image</span></pre></div>
<p>To get back data in JSON instead, add <code>?default_format=JSON</code> to the URL. Here I&#39;m piping that through <code>jq</code> to pretty print it:</p>
<div><pre>curl <span><span>&#39;</span>https://play.clickhouse.com/?default_format=JSON<span>&#39;</span></span> \
  -X POST \
  -H <span><span>&#39;</span>Authorization: Basic cGxheTo=<span>&#39;</span></span> \
  --data-raw <span><span>$&#39;</span></span>
<span>    SELECT created_at, actor_login, repo_name</span>
<span>    FROM github_events</span>
<span>    WHERE event_type = <span>\&#39;</span>WatchEvent<span>\&#39;</span></span>
<span>    ORDER BY created_at DESC LIMIT 1<span>&#39;</span></span> <span>|</span> jq</pre></div>
<p>Output:</p>
<div><pre>{
  <span>&#34;meta&#34;</span>: [
    {
      <span>&#34;name&#34;</span>: <span><span>&#34;</span>created_at<span>&#34;</span></span>,
      <span>&#34;type&#34;</span>: <span><span>&#34;</span>DateTime<span>&#34;</span></span>
    },
    {
      <span>&#34;name&#34;</span>: <span><span>&#34;</span>actor_login<span>&#34;</span></span>,
      <span>&#34;type&#34;</span>: <span><span>&#34;</span>LowCardinality(String)<span>&#34;</span></span>
    },
    {
      <span>&#34;name&#34;</span>: <span><span>&#34;</span>repo_name<span>&#34;</span></span>,
      <span>&#34;type&#34;</span>: <span><span>&#34;</span>LowCardinality(String)<span>&#34;</span></span>
    }
  ],
  <span>&#34;data&#34;</span>: [
    {
      <span>&#34;created_at&#34;</span>: <span><span>&#34;</span>2023-01-01 03:59:59<span>&#34;</span></span>,
      <span>&#34;actor_login&#34;</span>: <span><span>&#34;</span>Willmac16<span>&#34;</span></span>,
      <span>&#34;repo_name&#34;</span>: <span><span>&#34;</span>nlohmann/json<span>&#34;</span></span>
    }
  ],
  <span>&#34;rows&#34;</span>: <span>1</span>,
  <span>&#34;rows_before_limit_at_least&#34;</span>: <span>341429632</span>,
  <span>&#34;statistics&#34;</span>: {
    <span>&#34;elapsed&#34;</span>: <span>0.925636889</span>,
    <span>&#34;rows_read&#34;</span>: <span>341540363</span>,
    <span>&#34;bytes_read&#34;</span>: <span>10567093585</span>
  }
}</pre></div>
<p>More format options <a href="https://clickhouse.com/docs/en/interfaces/formats/" rel="nofollow">are documented here</a>.</p>
<h2><a id="user-content-cors-requests-from-javascript" aria-hidden="true" href="#cors-requests-from-javascript"><span aria-hidden="true"></span></a>CORS requests from JavaScript</h2>
<p>This pattern works for running queries from JavaScript. CORS is enabled - I pasted this into the Firefox DevTools console on <a href="https://www.example.com/" rel="nofollow">https://www.example.com/</a> and it returned the results I expected:</p>
<div><pre><span>r</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>&#34;https://play.clickhouse.com/?user=play&#34;</span><span>,</span> <span>{</span>
  <span>method</span>: <span>&#34;POST&#34;</span><span>,</span>
  <span>body</span>: <span>`SELECT</span>
<span>        created_at,</span>
<span>        event_type,</span>
<span>        actor_login,</span>
<span>        repo_name,</span>
<span>        number,</span>
<span>        title,</span>
<span>        body</span>
<span>      FROM</span>
<span>        github_events</span>
<span>      WHERE</span>
<span>         actor_login = &#39;simonw&#39;</span>
<span>      ORDER BY</span>
<span>        created_at desc</span>
<span>      LIMIT</span>
<span>        100</span>
<span>      FORMAT JSON`</span><span>,</span>
<span>}</span><span>)</span><span>;</span>
<span>d</span> <span>=</span> <span>await</span> <span>r</span><span>.</span><span>json</span><span>(</span><span>)</span><span>;</span></pre></div>
<p>Here I&#39;m using <code>FORMAT JSON</code> at the end of the query itself, and passing the requested user as <code>?user=play</code> rather than sending an <code>Authorization</code> header.</p>




  <h3>Related</h3>
  


<p>Created 2022-12-31T21:06:14-08:00, updated 2023-01-01T10:37:42-08:00 · <a href="https://github.com/simonw/til/commits/main/clickhouse/github-explorer.md">History</a> · <a href="https://github.com/simonw/til/blob/main/clickhouse/github-explorer.md">Edit</a></p>

</section></div>
  </body>
</html>
