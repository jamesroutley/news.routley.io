<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.evanjones.ca/isspace_locale.html">Original</a>
    <h1>The C Standard Library Function Isspace() Depends on Locale</h1>
    
    <div id="readability-page-1" class="page"><div>

<h3>[ 2023-June-06 09:41 ]</h3>
<p>This is a post for myself, because I wasted a lot of time understanding this bug, and I want to be able to remember it in the future. I expect close to zero others to be interested. The C standard library function <a href="https://en.cppreference.com/w/c/string/byte/isspace">isspace()</a> returns a non-zero value (true) for the six &#34;standard&#34; ASCII white-space characters (&#39;\t&#39;, &#39;\n&#39;, &#39;\v&#39;, &#39;\f&#39;, &#39;\r&#39;, &#39; &#39;), <em>and</em> any locale-specific characters. By default, a program starts in the &#34;C&#34; locale, which will <em>only</em> return true for the six ASCII white-space characters. However, if the program changes locales, it can return true for other values. As a result, unless you really understand locales, you should use your own version of this function, or <a href="https://unicode-org.github.io/icu/userguide/icu4c/">ICU4C</a>&#39;s <a href="https://unicode-org.github.io/icu-docs/apidoc/dev/icu4c/uchar_8h.html#a48dd198b451e691cf81eb41831474ddc">u_isspace()</a> function. An implementation of isspace() for ASCII is one line:</p>

<pre><code>/* Returns true for the 6 ASCII white-space characters: \t \n \v \f \r &#39; &#39;. */
int isspace_ascii(int c)
{
  return c == &#39;\t&#39; || c == &#39;\n&#39; || c == &#39;\v&#39; || c == &#39;\f&#39; || c == &#39;\r&#39; || c == &#39; &#39;;
}
</code></pre>

<p>I ran into this because On Mac OS X, Postgres switches to the system&#39;s default locale, which is something that uses UTF-8 (e.g. <code>en_US.UTF-8</code>, <code>fr_CA.UTF-8</code>, etc). In this case, <code>isspace()</code> returns true for Unicode white-space values, which includes <a href="https://codepoints.net/U+0085">0x85 = NEL = Next Line</a>, and <a href="https://codepoints.net/U+00A0">0xA0 = NBSP = No-Break Space</a>. This caused a bug in parsing <a href="https://www.postgresql.org/docs/current/hstore.html">Postgres Hstore</a> values that use Unicode. I have attempted to submit a patch to fix this (<a href="https://www.postgresql.org/message-id/CA%2BHWA9awUW0%2BRV_gO9r1ABZwGoZxPztcJxPy8vMFSTbTfi4jig%40mail.gmail.com">mailing list post</a>, <a href="https://commitfest.postgresql.org/43/4341/">commitfest entry</a>).</p>

<p>For a program to demonstrate the behaviour on different systems, see <a href="https://github.com/evanj/isspace_locale">isspace_locale on Github</a>.</p>

</div></div>
  </body>
</html>
