<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rgoswami.me/posts/xonsh-excursion/">Original</a>
    <h1>xonsh Excursions</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="background">Background</h2><p>Recently I found myself writing a bunch of search and replace one-liners.</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span><span>export</span> <span>FROM</span><span>=</span><span>&#39;Matrix3d&#39;</span><span>;</span> <span>export</span> <span>TO</span><span>=</span><span>&#39;Matrix3S&#39;</span><span>;</span> ag -l <span>$FROM</span> <span>|</span> xargs -I <span>{}</span> sd <span>$FROM</span> <span>$TO</span> <span>{}</span>
</span></span></code></pre></div><p>Which works, especially since both <code>ag</code> and <code>sd</code> are rather good, but it is still:</p><ul><li>Slightly non-ergonomic to type</li><li>Difficult to keep track of<ul><li>Modulo dumping everything in a <code>.sh</code> file</li></ul></li></ul><p>These reminded me of the rich set of alternate shells<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.</p><h2 id="reaching-for-xonsh">Reaching for <code>xonsh</code></h2><p>Although <code>nushell</code>, <code>elvish</code> and even <code>oil</code> seemed promising, I settled on the
<a href="https://xon.sh/">Python based xonsh</a>.</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>pipx install xonsh<span>[</span>full<span>]</span>
</span></span><span><span>2</span><span>pipx inject xonsh xcontrib-sh
</span></span><span><span>3</span><span><span>echo</span> <span>&#39;xontrib load sh&#39;</span> &gt;&gt; ~/.xonshrc
</span></span></code></pre></div><p>Where we use the <a href="https://pipx.pypa.io/latest/docs/#pipx-inject">injection mechanism</a> to add the <a href="https://github.com/anki-code/xontrib-sh">xcontrib-sh</a> plugin for running
shell commands without using <code>xonsh</code>, since we might not want to <a href="https://xon.sh/bash_to_xsh.html">translate</a> every
command to be compliant with <code>xonsh</code>.</p><h3 id="additions">Additions</h3><ul><li><code>xonsh-mode</code> works well with <code>emacs</code> and is on MELPA</li><li><a href="https://github.com/xxh/xxh">xxh</a> makes it pretty trivial to take into foreign SSH machines</li></ul><h2 id="scripting-substitutions">Scripting substitutions</h2><p>Directly leveraging <code>xonsh</code> we can rewrite the earlier <code>bash</code> script into:</p><div><pre tabindex="0"><code data-lang="python"><span><span> 1</span><span><span>from</span> <span>pathlib</span> <span>import</span> <span>Path</span>
</span></span><span><span> 2</span><span>
</span></span><span><span> 3</span><span><span>def</span> <span>replace_make_shared</span><span>():</span>
</span></span><span><span> 4</span><span>    <span>FROM_MAKE</span> <span>=</span> <span>&#39;Matter&#39;</span>
</span></span><span><span> 5</span><span>    <span>TO_MAKE</span> <span>=</span> <span>&#39;Matter&#39;</span>
</span></span><span><span> 6</span><span>
</span></span><span><span> 7</span><span>    <span>files</span> <span>=</span> <span>$</span><span>(</span><span>ag</span> <span>-</span><span>l</span> <span>@</span><span>(</span><span>FROM_MAKE</span><span>))</span><span>.</span><span>splitlines</span><span>()</span>
</span></span><span><span> 8</span><span>
</span></span><span><span> 9</span><span>    <span>for</span> <span>f</span> <span>in</span> <span>files</span><span>:</span>
</span></span><span><span>10</span><span>        <span>if</span> <span>Path</span><span>(</span><span>f</span><span>)</span><span>.</span><span>exists</span><span>():</span>
</span></span><span><span>11</span><span>            <span>sd</span> <span>@</span><span>(</span><span>FROM_MAKE</span><span>)</span> <span>@</span><span>(</span><span>TO_MAKE</span><span>)</span> <span>@</span><span>(</span><span>f</span><span>)</span>
</span></span><span><span>12</span><span>        <span>else</span><span>:</span>
</span></span><span><span>13</span><span>            <span>echo</span> <span>&#34;File not found: @(file)&#34;</span>
</span></span><span><span>14</span><span>
</span></span><span><span>15</span><span><span>replace_make_shared</span><span>()</span>
</span></span></code></pre></div><h3 id="leveraging-python">Leveraging Python</h3><p>It is instructive to recall how this would work in pure <code>python</code>.</p><div><pre tabindex="0"><code data-lang="python"><span><span> 1</span><span><span>import</span> <span>subprocess</span>
</span></span><span><span> 2</span><span><span>from</span> <span>pathlib</span> <span>import</span> <span>Path</span>
</span></span><span><span> 3</span><span>
</span></span><span><span> 4</span><span><span>def</span> <span>replace_make_shared</span><span>():</span>
</span></span><span><span> 5</span><span>    <span>FROM_MAKE</span> <span>=</span> <span>&#39;std::shared_ptr&lt;Matter&gt;&#39;</span>
</span></span><span><span> 6</span><span>    <span>TO_MAKE</span> <span>=</span> <span>&#39;Matter*&#39;</span>
</span></span><span><span> 7</span><span>
</span></span><span><span> 8</span><span>    <span>result</span> <span>=</span> <span>subprocess</span><span>.</span><span>run</span><span>([</span><span>&#39;ag&#39;</span><span>,</span> <span>&#39;-l&#39;</span><span>,</span> <span>FROM_MAKE</span><span>],</span>
</span></span><span><span> 9</span><span>                            <span>capture_output</span><span>=</span><span>True</span><span>,</span> <span>text</span><span>=</span><span>True</span><span>)</span>
</span></span><span><span>10</span><span>    <span>files</span> <span>=</span> <span>result</span><span>.</span><span>stdout</span><span>.</span><span>splitlines</span><span>()</span>
</span></span><span><span>11</span><span>    <span>actionable_files</span> <span>=</span> <span>[</span><span>x</span> <span>for</span> <span>x</span> <span>in</span> <span>files</span> <span>if</span> <span>&#39;migrator&#39;</span> <span>not</span> <span>in</span> <span>x</span><span>]</span>
</span></span><span><span>12</span><span>
</span></span><span><span>13</span><span>    <span>for</span> <span>f</span> <span>in</span> <span>actionable_files</span><span>:</span>
</span></span><span><span>14</span><span>        <span>file_path</span> <span>=</span> <span>Path</span><span>(</span><span>f</span><span>)</span>
</span></span><span><span>15</span><span>        <span>if</span> <span>file_path</span><span>.</span><span>exists</span><span>():</span>
</span></span><span><span>16</span><span>            <span>subprocess</span><span>.</span><span>run</span><span>([</span><span>&#39;sd&#39;</span><span>,</span> <span>FROM_MAKE</span><span>,</span> <span>TO_MAKE</span><span>,</span>
</span></span><span><span>17</span><span>                            <span>str</span><span>(</span><span>file_path</span><span>)],</span> <span>check</span><span>=</span><span>True</span><span>)</span>
</span></span><span><span>18</span><span>        <span>else</span><span>:</span>
</span></span><span><span>19</span><span>            <span>print</span><span>(</span><span>f</span><span>&#34;File not found: </span><span>{</span><span>file_path</span><span>}</span><span>&#34;</span><span>)</span>
</span></span><span><span>20</span><span>
</span></span><span><span>21</span><span><span>replace_make_shared</span><span>()</span>
</span></span></code></pre></div><p>With <a href="https://sh.readthedocs.io/en/latest/index.html">sh</a>, shell calls become more ergonomic, however, it is still easier to
interoperate between the shell outputs and Python code (e.g. using <code>echo</code>) using
<code>xonsh</code>.</p><h2 id="conclusions">Conclusions</h2><p>Personally, <code>xonsh</code> hits the sweet-spot of being slightly less finicky than
POSIX shells while being less verbose than the pure <code>python</code> variant. It isn’t
perfect though:</p><ul><li>The <code>python</code> dependence, even with <code>pipx</code> can be an issue <sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup><ul><li>Packages which are needed have to be injected into the same environment..<ul><li><code>nix</code> maybe…</li></ul></li></ul></li><li>There is no good testing framework<ul><li>Ugly <code>subprocess</code> based <code>pytest</code> tests could be written</li></ul></li></ul><p>For now, though, this is sufficiently advantageous.</p></div></div>
  </body>
</html>
