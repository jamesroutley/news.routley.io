<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bytepawn.com/python-decorators-for-data-scientists.html">Original</a>
    <h1>Useful Python Decorators for Data Scientists</h1>
    
    <div id="readability-page-1" class="page"><div>
    <h2>Introduction</h2>
<p>In this post, I will show some <code>@decorators</code> that may be useful for Data Scientists. It may also be useful to revisit previous Bytepawn posts on decorators:</p>
<ul>
<li><a href="https://bytepawn.com/building-a-toy-python-dataclass-decorator.html">Building a toy Python @dataclass decorator</a></li>
<li><a href="https://bytepawn.com/python-decorator-patterns.html">Python decorator patterns</a></li>
<li><a href="https://bytepawn.com/tag/python.html">all Bytepawn posts tagged with python</a></li>
</ul>
<p>The <a href="https://github.com/mtrencseni/playground/blob/master/Decorators%20for%20Data%20Scientists.ipynb">ipython notebook is up on Github</a>.</p>
<h2><code>@parallel</code></h2>
<p>Let&#39;s assume I write a really inefficient way to find primes:</p>
<div><pre><span></span><span>from</span> <span>sympy</span> <span>import</span> <span>isprime</span>

<span>def</span> <span>generate_primes</span><span>(</span><span>domain</span><span>:</span> <span>int</span><span>=</span><span>1000</span><span>*</span><span>1000</span><span>,</span> <span>num_attempts</span><span>:</span> <span>int</span><span>=</span><span>1000</span><span>)</span> <span>-&gt;</span> <span>list</span><span>[</span><span>int</span><span>]:</span>
    <span>primes</span><span>:</span> <span>set</span><span>[</span><span>int</span><span>]</span> <span>=</span> <span>set</span><span>()</span>
    <span>seed</span><span>(</span><span>time</span><span>())</span>
    <span>for</span> <span>_</span> <span>in</span> <span>range</span><span>(</span><span>num_attempts</span><span>):</span>
        <span>candidate</span><span>:</span> <span>int</span> <span>=</span> <span>randint</span><span>(</span><span>4</span><span>,</span> <span>domain</span><span>)</span>
        <span>if</span> <span>isprime</span><span>(</span><span>candidate</span><span>):</span>
            <span>primes</span><span>.</span><span>add</span><span>(</span><span>candidate</span><span>)</span>
    <span>return</span> <span>sorted</span><span>(</span><span>primes</span><span>)</span>

<span>print</span><span>(</span><span>len</span><span>(</span><span>generate_primes</span><span>()))</span>
</pre></div>


<p>Outputs something like:</p>



<p>Then I realize that I could get a &#34;free&#34; speedup if I run the original <code>generate_primes()</code> on all my CPU threads in parallel. This is pretty common, it makes sense to define a <code>@parallel</code>:</p>
<div><pre><span></span><span>def</span> <span>parallel</span><span>(</span><span>func</span><span>=</span><span>None</span><span>,</span> <span>args</span><span>=</span><span>(),</span> <span>merge_func</span><span>=</span><span>lambda</span> <span>x</span><span>:</span><span>x</span><span>,</span> <span>parallelism</span> <span>=</span> <span>cpu_count</span><span>()):</span>
    <span>def</span> <span>decorator</span><span>(</span><span>func</span><span>:</span> <span>Callable</span><span>):</span>
        <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
            <span>results</span> <span>=</span> <span>Parallel</span><span>(</span><span>n_jobs</span><span>=</span><span>parallelism</span><span>)(</span><span>delayed</span><span>(</span><span>func</span><span>)(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span> <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>parallelism</span><span>))</span>
            <span>return</span> <span>merge_func</span><span>(</span><span>results</span><span>)</span>
        <span>return</span> <span>inner</span>
    <span>if</span> <span>func</span> <span>is</span> <span>None</span><span>:</span>
        <span># decorator was used like @parallel(...)</span>
        <span>return</span> <span>decorator</span>
    <span>else</span><span>:</span>
        <span># decorator was used like @parallel, without parens</span>
        <span>return</span> <span>decorator</span><span>(</span><span>func</span><span>)</span>
</pre></div>


<p>With this, with one line we can parallelize our function:</p>
<div><pre><span></span><span>@parallel</span><span>(</span><span>merge_func</span><span>=</span><span>lambda</span> <span>li</span><span>:</span> <span>sorted</span><span>(</span><span>set</span><span>(</span><span>chain</span><span>(</span><span>*</span><span>li</span><span>))))</span>
<span>def</span> <span>generate_primes</span><span>(</span><span>...</span><span>):</span> <span># same signature, nothing changes</span>
    <span>...</span> <span># same code, nothing changes</span>

<span>print</span><span>(</span><span>len</span><span>(</span><span>generate_primes</span><span>()))</span>
</pre></div>


<p>Outputs something like:</p>



<p>In my case, my Macbook has 8 cores, 16 threads (<code>cpu_count()</code> is 16), so I generated 16x as many primes. Notes:</p>
<ul>
<li>The only overhead is having to define a <code>merge_func</code>, which merges the results of the different runs of the function into one result, to hide the parallelism from outside callers of the decorated function (<code>generate_primes()</code> in this case). In this toy example, I just merge the lists and make sure the primes are uniques by using <code>set()</code>.</li>
<li>There are many Python libraries and approches (eg. threads vs processes) to achieve parallelism. This example uses <a href="https://joblib.readthedocs.io/en/latest/generated/joblib.Parallel.html">process parallelism with <code>joblib.Parallel()</code></a>, which works well on Darwin + python3 + ipython and avoids locking on the <a href="https://realpython.com/python-gil/">Python Global Interpreter Lock (GIL)</a>.</li>
</ul>
<h2><code>@production</code></h2>
<p>Sometimes we write a big complicated pipeline, with extra steps which we only want to run in certain environments. Eg. do something on our local dev environment, but not in production or vica versa. It&#39;d be nice to be able to decorate functions and get them to only run in certain environments, and do nothing elsewhere.</p>
<p>One way to achieve this is with a few simple decorators: <code>@production</code> for stuff we want to only run on prod, <code>@development</code> for stuff we only want to run in dev, we can even introduce an <code>@inactive</code> which just turns the function off altogether. The benefit of this approach is that this way the deployment history and current state is tracked in code/Github. Also, we can make these changes in one line, leading to cleaner commits; eg. <code>@inactive</code> is cleaner than a big commit where an entire block of code is commented out.</p>
<div><pre><span></span><span>production_servers</span> <span>=</span> <span>[</span><span>...</span><span>]</span>

<span>def</span> <span>production</span><span>(</span><span>func</span><span>:</span> <span>Callable</span><span>):</span>
    <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
        <span>if</span> <span>gethostname</span><span>()</span> <span>in</span> <span>production_servers</span><span>:</span>
            <span>return</span> <span>func</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
        <span>else</span><span>:</span>
            <span>print</span><span>(</span><span>&#39;This host is not a production server, skipping function decorated with @production...&#39;</span><span>)</span>
    <span>return</span> <span>inner</span>

<span>def</span> <span>development</span><span>(</span><span>func</span><span>:</span> <span>Callable</span><span>):</span>
    <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
        <span>if</span> <span>gethostname</span><span>()</span> <span>not</span> <span>in</span> <span>production_servers</span><span>:</span>
            <span>return</span> <span>func</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
        <span>else</span><span>:</span>
            <span>print</span><span>(</span><span>&#39;This host is a production server, skipping function decorated with @development...&#39;</span><span>)</span>
    <span>return</span> <span>inner</span>

<span>def</span> <span>inactive</span><span>(</span><span>func</span><span>:</span> <span>Callable</span><span>):</span>
    <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
        <span>print</span><span>(</span><span>&#39;Skipping function decorated with @inactive...&#39;</span><span>)</span>
    <span>return</span> <span>inner</span>

<span>@production</span>
<span>def</span> <span>foo</span><span>():</span>
    <span>print</span><span>(</span><span>&#39;Running in production, touching databases!&#39;</span><span>)</span>

<span>foo</span><span>()</span>

<span>@development</span>
<span>def</span> <span>foo</span><span>():</span>
    <span>print</span><span>(</span><span>&#39;Running in production, touching databases!&#39;</span><span>)</span>

<span>foo</span><span>()</span>

<span>@inactive</span>
<span>def</span> <span>foo</span><span>():</span>
    <span>print</span><span>(</span><span>&#39;Running in production, touching databases!&#39;</span><span>)</span>

<span>foo</span><span>()</span>
</pre></div>


<p>Output:</p>
<div><pre><span></span>Running in production, touching databases!
This host is a production server, skipping function decorated with @development...
Skipping function decorated with @inactive...
</pre></div>


<p>This idea can be adapted to other frameworks/environments.</p>
<h2><code>@deployable</code></h2>
<p>At my current work, we use <a href="https://airflow.apache.org/">Airflow</a> for ETL/data pipelines. We have a rich library of helper functions which internally construct the appropriate DAG, so users (Data Scientists) don&#39;t have to worry about it.</p>
<p>The most commonly used one is <code>dag_vertica_create_table_as()</code>, which runs a <code>SELECT</code> on our Vertica DWH and dumps the result into a table every night:</p>
<div><pre><span></span><span>dag</span> <span>=</span> <span>dag_vertica_create_table_as</span><span>(</span>
    <span>table</span><span>=</span><span>&#39;my_aggregate_table&#39;</span><span>,</span>
    <span>owner</span><span>=</span><span>&#39;Marton Trencseni (marton.trencseni@maf.ae)&#39;</span><span>,</span>
    <span>schedule_interval</span><span>=</span><span>&#39;@daily&#39;</span><span>,</span>
    <span>...</span>
    <span>select</span><span>=</span><span>&#34;&#34;&#34;</span>
<span>    SELECT</span>
<span>        ...</span>
<span>    FROM</span>
<span>        ...</span>
<span>    &#34;&#34;&#34;</span>
<span>)</span>
</pre></div>


<p>This then becomes a query on the DWH, roughly like:</p>
<div><pre><span></span><span>CREATE</span> <span>TABLE</span> <span>my_aggregate_table</span> <span>AS</span>
<span>SELECT</span> <span>...</span>
</pre></div>


<p>In reality it&#39;s more complicated: we first run the query for today, and conditionally delete yesterday&#39;s if today&#39;s was successfully created. This conditional logic (and some other accidental complexity specific to our environment, such as having to issue <code>GRANT</code>s) results in the DAG having 9 steps, but this is not the point here, and is beyond the scope of the article.</p>
<p>Over the last 2 years we have created almost 500 DAGs, so we scaled up our Airflow EC2 instances and introduced seperate development and production environments. It&#39;d be nice to have a way to tag DAGs whether they should be running on dev or prod, track this in the code/Github, and use the same mechanism to make sure the DAGs don&#39;t accidentally run in the wrong environment.</p>
<p>There are about 10 similar convenience functions, such as <code>dag_vertica_create_or_replace_view_as()</code> and <code>dag_vertica_train_predict_model()</code>, etc, and we&#39;d like all <strong>calls</strong> of these <code>dag_xxx()</code> functions to be switchable between production and development (or skip everywhere).</p>
<p>However, the <code>@production</code> and <code>@development</code> decorators from the previous section won&#39;t work here, because we don&#39;t want to switch <code>dag_vertica_create_table_as()</code> to never run on one of the environments. We want to be able to set it per invocation, and have this feature in all of our <code>dag_xxxx()</code> functions, without having to copy/paste code. What we want is to add a <code>deploy</code> parameter to all of our in all of our <code>dag_xxxx()</code> functions (with a good default), so we can just add this parameter in our DAGs for added security. We can achieve this with the <code>@deployable</code> decorator:</p>
<div><pre><span></span><span>def</span> <span>deployable</span><span>(</span><span>func</span><span>):</span>
    <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
        <span>if</span> <span>&#39;deploy&#39;</span> <span>in</span> <span>kwargs</span><span>:</span>
            <span>if</span> <span>kwargs</span><span>[</span><span>&#39;deploy&#39;</span><span>]</span><span>.</span><span>lower</span><span>()</span> <span>in</span> <span>[</span><span>&#39;production&#39;</span><span>,</span> <span>&#39;prod&#39;</span><span>]</span> <span>and</span> <span>gethostname</span><span>()</span> <span>not</span> <span>in</span> <span>production_servers</span><span>:</span>
                <span>print</span><span>(</span><span>&#39;This host is not a production server, skipping...&#39;</span><span>)</span>
                <span>return</span>
            <span>if</span> <span>kwargs</span><span>[</span><span>&#39;deploy&#39;</span><span>]</span><span>.</span><span>lower</span><span>()</span> <span>in</span> <span>[</span><span>&#39;development&#39;</span><span>,</span> <span>&#39;dev&#39;</span><span>]</span> <span>and</span> <span>gethostname</span><span>()</span> <span>not</span> <span>in</span> <span>development_servers</span><span>:</span>
                <span>print</span><span>(</span><span>&#39;This host is not a development server, skipping...&#39;</span><span>)</span>
                <span>return</span>
            <span>if</span> <span>kwargs</span><span>[</span><span>&#39;deploy&#39;</span><span>]</span><span>.</span><span>lower</span><span>()</span> <span>in</span> <span>[</span><span>&#39;skip&#39;</span><span>,</span> <span>&#39;none&#39;</span><span>]:</span>
                <span>print</span><span>(</span><span>&#39;Skipping...&#39;</span><span>)</span>
                <span>return</span>
            <span>del</span> <span>kwargs</span><span>[</span><span>&#39;deploy&#39;</span><span>]</span> <span># to avoid func() throwing an unexpected keyword exception</span>
        <span>return</span> <span>func</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
    <span>return</span> <span>inner</span>
</pre></div>


<p>Then we can add the decorator to our function definitions (1 line added for each):</p>
<div><pre><span></span><span>@deployable</span>
<span>def</span> <span>dag_vertica_create_table_as</span><span>(</span><span>...</span><span>):</span> <span># same signature, nothing changes</span>
    <span>...</span> <span># code signature, nothing changes</span>

<span>@deployable</span>
<span>def</span> <span>dag_vertica_create_or_replace_view_as</span><span>(</span><span>...</span><span>):</span> <span># same signature, nothing changes</span>
    <span>...</span> <span># code signature, nothing changes</span>

<span>@deployable</span>
<span>def</span> <span>dag_vertica_train_predict_model</span><span>(</span><span>...</span><span>):</span> <span># same signature, nothing changes</span>
    <span>...</span> <span># code signature, nothing changes</span>
</pre></div>


<p>If we stop here, nothing happens, we don&#39;t break anything. However, now we can go to the DAG files where we use these functions, and add 1 line:</p>
<div><pre><span></span><span>dag</span> <span>=</span> <span>dag_vertica_create_table_as</span><span>(</span>
    <span>deploy</span><span>=</span><span>&#39;development&#39;</span><span>,</span> <span># the function will return None on production</span>
    <span>...</span>
<span>)</span>
</pre></div>


<h2><code>@redirect</code> (stdout)</h2>
<p>Sometimes we write a big function, which also calls other code, and all sorts of messages are <code>print()</code>ed. Or, we may have a bug, have a bunch of <code>print()</code>s, and want to add line numbers to the printouts so it&#39;s easier to refer to them. In these cases, <code>@redirect</code> may be useful. This decorator redirects <code>print()</code> standard output to our own line-by-line printer, and we can do whatever we&#39;d like with it (including throwing it away):</p>
<div><pre><span></span><span>def</span> <span>redirect</span><span>(</span><span>func</span><span>=</span><span>None</span><span>,</span> <span>line_print</span><span>:</span> <span>Callable</span> <span>=</span> <span>None</span><span>):</span>
    <span>def</span> <span>decorator</span><span>(</span><span>func</span><span>:</span> <span>Callable</span><span>):</span>
        <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
            <span>with</span> <span>StringIO</span><span>()</span> <span>as</span> <span>buf</span><span>,</span> <span>redirect_stdout</span><span>(</span><span>buf</span><span>):</span>
                <span>func</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
                <span>output</span> <span>=</span> <span>buf</span><span>.</span><span>getvalue</span><span>()</span>
            <span>lines</span> <span>=</span> <span>output</span><span>.</span><span>splitlines</span><span>()</span>
            <span>if</span> <span>line_print</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
                <span>for</span> <span>line</span> <span>in</span> <span>lines</span><span>:</span>
                    <span>line_print</span><span>(</span><span>line</span><span>)</span>
            <span>else</span><span>:</span>
                <span>width</span> <span>=</span> <span>floor</span><span>(</span><span>log</span><span>(</span><span>len</span><span>(</span><span>lines</span><span>),</span> <span>10</span><span>))</span> <span>+</span> <span>1</span>
                <span>for</span> <span>i</span><span>,</span> <span>line</span> <span>in</span> <span>enumerate</span><span>(</span><span>lines</span><span>):</span>
                    <span>i</span> <span>+=</span> <span>1</span>
                    <span>print</span><span>(</span><span>f</span><span>&#39;{i:0{width}}: {line}&#39;</span><span>)</span>
        <span>return</span> <span>inner</span>
    <span>if</span> <span>func</span> <span>is</span> <span>None</span><span>:</span>
        <span># decorator was used like @redirect(...)</span>
        <span>return</span> <span>decorator</span>
    <span>else</span><span>:</span>
        <span># decorator was used like @redirect, without parens</span>
        <span>return</span> <span>decorator</span><span>(</span><span>func</span><span>)</span>
</pre></div>


<p>If we use <code>redirect()</code> without specifying an explicit <code>line_print()</code> function, it will print the lines, but with line numbers added:</p>
<div><pre><span></span><span>@redirect</span>
<span>def</span> <span>print_lines</span><span>(</span><span>num_lines</span><span>):</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_lines</span><span>):</span>
        <span>print</span><span>(</span><span>f</span><span>&#39;Line #{i+1}&#39;</span><span>)</span>

<span>print_lines</span><span>(</span><span>10</span><span>)</span>
</pre></div>


<p>Output:</p>
<div><pre><span></span><span>01</span><span>:</span> <span>Line</span> <span>#</span><span>1</span>
<span>02</span><span>:</span> <span>Line</span> <span>#</span><span>2</span>
<span>03</span><span>:</span> <span>Line</span> <span>#</span><span>3</span>
<span>04</span><span>:</span> <span>Line</span> <span>#</span><span>4</span>
<span>05</span><span>:</span> <span>Line</span> <span>#</span><span>5</span>
<span>06</span><span>:</span> <span>Line</span> <span>#</span><span>6</span>
<span>07</span><span>:</span> <span>Line</span> <span>#</span><span>7</span>
<span>08</span><span>:</span> <span>Line</span> <span>#</span><span>8</span>
<span>09</span><span>:</span> <span>Line</span> <span>#</span><span>9</span>
<span>10</span><span>:</span> <span>Line</span> <span>#</span><span>10</span>
</pre></div>


<p>If we want to save all printed text to a variable, we can also achieve that:</p>
<div><pre><span></span><span>lines</span> <span>=</span> <span>[]</span>
<span>def</span> <span>save_lines</span><span>(</span><span>line</span><span>):</span>
    <span>lines</span><span>.</span><span>append</span><span>(</span><span>line</span><span>)</span>

<span>@redirect</span><span>(</span><span>line_print</span><span>=</span><span>save_lines</span><span>)</span>
<span>def</span> <span>print_lines</span><span>(</span><span>num_lines</span><span>):</span>
    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>num_lines</span><span>):</span>
        <span>print</span><span>(</span><span>f</span><span>&#39;Line #{i+1}&#39;</span><span>)</span>

<span>print_lines</span><span>(</span><span>3</span><span>)</span>
<span>print</span><span>(</span><span>lines</span><span>)</span>
</pre></div>


<p>Output:</p>
<div><pre><span></span>[&#39;Line #1&#39;, &#39;Line #2&#39;, &#39;Line #3&#39;]
</pre></div>


<p>The actual heavy lifting of <a href="https://docs.python.org/3/library/contextlib.html#contextlib.redirect_stdout">redirecting stdout is done by <code>contextlib.redirect_stdout</code></a>, as shown in <a href="https://stackoverflow.com/questions/1218933/can-i-redirect-the-stdout-into-some-sort-of-string-buffer">this StackOverflow thread</a>.</p>
<h2><code>@stacktrace</code></h2>
<p>The next decorator pattern is <code>@stacktrace</code>, which emits useful messages when functions are called and values are returned from functions:</p>
<div><pre><span></span><span>def</span> <span>stacktrace</span><span>(</span><span>func</span><span>=</span><span>None</span><span>,</span> <span>exclude_files</span><span>=</span><span>[</span><span>&#39;anaconda&#39;</span><span>]):</span>
    <span>def</span> <span>tracer_func</span><span>(</span><span>frame</span><span>,</span> <span>event</span><span>,</span> <span>arg</span><span>):</span>
        <span>co</span> <span>=</span> <span>frame</span><span>.</span><span>f_code</span>
        <span>func_name</span> <span>=</span> <span>co</span><span>.</span><span>co_name</span>
        <span>caller_filename</span> <span>=</span> <span>frame</span><span>.</span><span>f_back</span><span>.</span><span>f_code</span><span>.</span><span>co_filename</span>
        <span>if</span> <span>func_name</span> <span>==</span> <span>&#39;write&#39;</span><span>:</span>
            <span>return</span> <span># ignore write() calls from print statements</span>
        <span>for</span> <span>file</span> <span>in</span> <span>exclude_files</span><span>:</span>
            <span>if</span> <span>file</span> <span>in</span> <span>caller_filename</span><span>:</span>
                <span>return</span> <span># ignore in ipython notebooks</span>
        <span>args</span> <span>=</span> <span>str</span><span>(</span><span>tuple</span><span>([</span><span>frame</span><span>.</span><span>f_locals</span><span>[</span><span>arg</span><span>]</span> <span>for</span> <span>arg</span> <span>in</span> <span>frame</span><span>.</span><span>f_code</span><span>.</span><span>co_varnames</span><span>]))</span>
        <span>if</span> <span>args</span><span>.</span><span>endswith</span><span>(</span><span>&#39;,)&#39;</span><span>):</span>
            <span>args</span> <span>=</span> <span>args</span><span>[:</span><span>-</span><span>2</span><span>]</span> <span>+</span> <span>&#39;)&#39;</span>
        <span>if</span> <span>event</span> <span>==</span> <span>&#39;call&#39;</span><span>:</span>
            <span>print</span><span>(</span><span>f</span><span>&#39;--&gt; Executing: {func_name}{args}&#39;</span><span>)</span>
            <span>return</span> <span>tracer_func</span>
        <span>elif</span> <span>event</span> <span>==</span> <span>&#39;return&#39;</span><span>:</span>
            <span>print</span><span>(</span><span>f</span><span>&#39;--&gt; Returning: {func_name}{args} -&gt; {repr(arg)}&#39;</span><span>)</span>
        <span>return</span>
    <span>def</span> <span>decorator</span><span>(</span><span>func</span><span>:</span> <span>Callable</span><span>):</span>
        <span>def</span> <span>inner</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
            <span>settrace</span><span>(</span><span>tracer_func</span><span>)</span>
            <span>func</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
            <span>settrace</span><span>(</span><span>None</span><span>)</span>
        <span>return</span> <span>inner</span>
    <span>if</span> <span>func</span> <span>is</span> <span>None</span><span>:</span>
        <span># decorator was used like @stacktrace(...)</span>
        <span>return</span> <span>decorator</span>
    <span>else</span><span>:</span>
        <span># decorator was used like @stacktrace, without parens</span>
        <span>return</span> <span>decorator</span><span>(</span><span>func</span><span>)</span>
</pre></div>


<p>With this, we can decorate the topmost function where we want tracing to start, and we will get useful output about the branching:</p>
<div><pre><span></span>def b():
    print(&#39;...&#39;)

@stacktrace
def a(arg):
    print(arg)
    b()
    return &#39;world&#39;

a(&#39;foo&#39;)
</pre></div>


<p>Output:</p>
<div><pre><span></span>--&gt; Executing: a(&#39;foo&#39;)
foo
--&gt; Executing: b()
...
--&gt; Returning: b() -&gt; None
--&gt; Returning: a(&#39;foo&#39;) -&gt; &#39;world&#39;
</pre></div>


<p>The only trick here is hiding parts of the callstack which is not interesting. In my case, I&#39;m running this code in ipython over Anaconda, so I hide parts of the callstack where the code is in a file which is has <code>anaconda</code> in its path (otherwise I would get about 50-100 useless callstack entries in the snippet above). This is accomplished by the <code>exclude_files</code> parameter of the decorator.</p>
<h2><code>@traceclass</code></h2>
<p>Similarly to the above, we can define a decorator <code>@traceclass</code> which we use with classes, to get traces of its members&#39; execution. This was included in <a href="https://bytepawn.com/python-decorator-patterns.html">the previous decorator post</a>, there it was just called <code>@trace</code> and had a bug (since fixed in the original post). The decorator:</p>
<div><pre><span></span><span>def</span> <span>traceclass</span><span>(</span><span>cls</span><span>:</span> <span>type</span><span>):</span>
    <span>def</span> <span>make_traced</span><span>(</span><span>cls</span><span>:</span> <span>type</span><span>,</span> <span>method_name</span><span>:</span> <span>str</span><span>,</span> <span>method</span><span>:</span> <span>Callable</span><span>):</span>
        <span>def</span> <span>traced_method</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
            <span>print</span><span>(</span><span>f</span><span>&#39;--&gt; Executing: {cls.__name__}::{method_name}()&#39;</span><span>)</span>
            <span>return</span> <span>method</span><span>(</span><span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>)</span>
        <span>return</span> <span>traced_method</span>
    <span>for</span> <span>name</span> <span>in</span> <span>cls</span><span>.</span><span>__dict__</span><span>.</span><span>keys</span><span>():</span>
        <span>if</span> <span>callable</span><span>(</span><span>getattr</span><span>(</span><span>cls</span><span>,</span> <span>name</span><span>))</span> <span>and</span> <span>name</span> <span>!=</span> <span>&#39;__class__&#39;</span><span>:</span>
            <span>setattr</span><span>(</span><span>cls</span><span>,</span> <span>name</span><span>,</span> <span>make_traced</span><span>(</span><span>cls</span><span>,</span> <span>name</span><span>,</span> <span>getattr</span><span>(</span><span>cls</span><span>,</span> <span>name</span><span>)))</span>
    <span>return</span> <span>cls</span>
</pre></div>


<p>We can use it like:</p>
<div><pre><span></span><span>@traceclass</span>
<span>class</span> <span>Foo</span><span>:</span>
    <span>i</span><span>:</span> <span>int</span> <span>=</span> <span>0</span>
    <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>i</span><span>:</span> <span>int</span> <span>=</span> <span>0</span><span>):</span>
        <span>self</span><span>.</span><span>i</span> <span>=</span> <span>i</span>
    <span>def</span> <span>increment</span><span>(</span><span>self</span><span>):</span>
        <span>self</span><span>.</span><span>i</span> <span>+=</span> <span>1</span>
    <span>def</span> <span>__str__</span><span>(</span><span>self</span><span>):</span>
        <span>return</span> <span>f</span><span>&#39;This is a {self.__class__.__name__} object with i = {self.i}&#39;</span>

<span>f1</span> <span>=</span> <span>Foo</span><span>()</span>
<span>f2</span> <span>=</span> <span>Foo</span><span>(</span><span>4</span><span>)</span>
<span>f1</span><span>.</span><span>increment</span><span>()</span>
<span>print</span><span>(</span><span>f1</span><span>)</span>
<span>print</span><span>(</span><span>f2</span><span>)</span>
</pre></div>


<p>Output:</p>
<div><pre><span></span>--&gt; Executing: Foo::__init__()
--&gt; Executing: Foo::__init__()
--&gt; Executing: Foo::increment()
--&gt; Executing: Foo::__str__()
This is a Foo object with i = 1
--&gt; Executing: Foo::__str__()
This is a Foo object with i = 4
</pre></div>


<h2>Conclusion</h2>
<p>In Python functions are first class citizens, and decorators are powerful syntactic sugar exploiting this functionality to give programmers a seemingly &#34;magic&#34; way to construct useful compositions of functions and classes. These are 5 decorators that may useful specifically for Data Scientists working in ipython notebooks.</p>
<p>Thanks <a href="https://github.com/zsol">Zsolt</a> for bugfixes and improvement suggestions.</p>
  </div></div>
  </body>
</html>
