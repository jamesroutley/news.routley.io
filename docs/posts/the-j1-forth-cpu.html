<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://excamera.com/sphinx/fpga-j1.html">Original</a>
    <h1>The J1 Forth CPU</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>
          <div>
            
  <div id="the-j1-forth-cpu">

<p><a href="https://excamera.com/files/j1.pdf"><img alt="_images/timing.jpg" src="https://excamera.com/sphinx/_images/timing.jpg"/></a></p><p>(Here is the <a href="https://excamera.com/files/j1.pdf">J1 paper</a> I presented at <a href="http://www.complang.tuwien.ac.at/anton/euroforth/ef10/">EuroForth 2010</a>).</p>

<p>J1 is a small (<a href="https://excamera.com/files/j1demo/verilog/j1.v">200 lines</a> of Verilog) stack-based CPU, intended for FPGAs.  A complete J1 with 16Kbytes of RAM fits easily on a small Xilinx FPGA.  Some highlights:</p>
<blockquote>
<div><ul>
<li>Extremely high code density.  A complete system including the TCP/IP stack fits in under 8K bytes.</li>
<li>Single cycle call, zero cycle return</li>
<li>Instruction set maps trivially to Forth</li>
<li>Cross compiler runs on Windows, Mac and Unix</li>
<li>Basic software includes a sizeable subset of <a href="http://forth.sourceforge.net/std/dpans/">ANS Forth</a> and a portable TCP/IP networking stack.</li>
</ul>
</div></blockquote>
<p>J1 was originally designed to run the six
<a href="http://www.ros.org/wiki/wge100_camera_firmware">WGE100 Ethernet cameras</a>
in the
<a href="http://www.willowgarage.com/pages/pr2/overview">Willow Garage PR2 robot</a>.</p>
<p>More recently it was shown at
<a href="http://forth.org/svfig/kk/11-2010.html">SVFIG Forth Day 2010</a>
on
an <a href="http://www.xess.com/prods/prod039.php">XESS FPGA board</a> (see <a href="https://excamera.com/sphinx/fpga-xess-python.html#xess-lpt"><em>Loading the XESS XSA-3S1000 from Python</em></a>) running a few demonstration programs, including
space invaders, Forth source <a href="https://excamera.com/files/j1demo/docforth/invaders.fs.html">invaders.fs</a>.</p>
<p><img alt="_images/invaders.jpg" src="https://excamera.com/sphinx/_images/invaders.jpg"/>
<img alt="_images/closeup.jpg" src="https://excamera.com/sphinx/_images/closeup.jpg"/></p><p>The code is at <a href="https://excamera.com/files/j1demo.tar.gz">j1demo.tar.gz</a>.</p>
<div id="about-the-j1">
<h2>About the J1<a href="#about-the-j1" title="Permalink to this headline">¶</a></h2>
<p>The J1 is a simple 16-bit CPU.  It has some RAM, a program counter
(PC), a data stack and a call/return stack.  It has a small set of
built-in arithmetic instructions.  Fields in the J1 instructions
control the arithmetic function, and write the results back to the
data stacks.  There are more details on instruction coding in the
<a href="https://excamera.com/files/j1.pdf">paper</a>.</p>
<p>The J1 is probably close to the simplest possible useful CPU.</p>
</div>
<div id="forth-on-the-j1">
<h2>Forth on the J1<a href="#forth-on-the-j1" title="Permalink to this headline">¶</a></h2>
<p>The CPU was designed to run Forth programs very efficiently: the
machine’s instructions are so close to Forth that there is little
benefit to writing code in assembler.  Effectively Forth <em>is</em> the
assembly language.  J1 runs at about 100 Forth MIPS on a typical
FPGA.  This compares with about 0.1 Forth MIPS for a
traditional threaded Forth running on an embedded 8-bit CPU.</p>
<p>To build the j1 binary <tt><span>j1.bin</span></tt> with gforth, do:</p>
<div><div><pre>$ cd j1demo/firmware
$ make j1.bin
</pre></div>
</div>
<p>The code that defines the basic Forth operations as J1
instructions is in <a href="https://excamera.com/files/j1demo/docforth/basewords.fs.html">basewords.fs</a></p>
<p>The next layer up defines basic operations in terms of these simple
words.  These include many of the CORE words from the DPANS94 Forth
standard.  Some of the general facilities provided by
<a href="https://excamera.com/files/j1demo/docforth/nuc.fs.html">nuc.fs</a></p>
<blockquote>
<div><ul>
<li>byte memory access</li>
<li>string handling</li>
<li>double precision (i.e. 32 bit) math</li>
<li>one’s complement addition</li>
<li>memory copy and fill</li>
<li>multiplication and division, fractional arithmetic</li>
<li>pictured numeric output</li>
<li>debug words: memory and stack dump, assert</li>
</ul>
</div></blockquote>
<p>The above files - about 2K of code - bring the J1 to the point where
it can start to define application-specific code.</p>
</div>
<div id="the-tcp-ip-stack">
<h2>The TCP/IP Stack<a href="#the-tcp-ip-stack" title="Permalink to this headline">¶</a></h2>
<div id="ethernet-driver">
<h3>Ethernet driver<a href="#ethernet-driver" title="Permalink to this headline">¶</a></h3>
<p>The Ethernet driver is responsible for packet reception and
transmission.  This component deals with the various supported
pieces of <a href="http://en.wikipedia.org/wiki/Media_Access_Control">MAC</a> hardware
above.</p>
<p>Supported hardware for the Ethernet driver:</p>
<blockquote>
<div><ul>
<li>The Microchip ENC28J60</li>
<li>The open source MAC used in the PR2’s cameras</li>
<li>The AX88796 used in the XESS development board <a href="https://excamera.com/files/j1demo/docforth/eth-ax88796.fs.html">eth-ax88796.fs</a></li>
</ul>
</div></blockquote>
</div>
<div id="network-components">
<h3>Network components<a href="#network-components" title="Permalink to this headline">¶</a></h3>
<dl>
<dt>ARP</dt>
<dd>Address Resolution Protocol.  The ARP module maintains a small
cache of ARP network addresses, and responds to ARP queries for
our Ethernet address. <a href="https://excamera.com/files/j1demo/docforth/arp.fs.html">arp.fs</a></dd>
<dt>IP</dt>
<dd>Internet Protocol.  The ip module constructs the IP header.  <a href="https://excamera.com/files/j1demo/docforth/ip.fs.html">ip.fs</a></dd>
<dt>UDP</dt>
<dd>User Datagram Protocol packet construction. <a href="https://excamera.com/files/j1demo/docforth/udp.fs.html">udp.fs</a></dd>
<dt>DHCP</dt>
<dd>Optional DHCP client implementation.  This allows the network device
to get its IP address automatically.
<a href="https://excamera.com/files/j1demo/docforth/dhcp.fs.html">dhcp.fs</a></dd>
<dt>NTP</dt>
<dd>Optional Network Time Protocol client.
<a href="https://excamera.com/files/j1demo/docforth/ntp.fs.html">ntp.fs</a></dd>
<dt>DNS</dt>
<dd>Optional Domain Name System client.
<a href="https://excamera.com/files/j1demo/docforth/dns.fs.html">dns.fs</a></dd>
</dl>
<p>More <a href="https://excamera.com/sphinx/fpga-vhdl-verilog.html#main"><em>VHDL, Verilog and FPGA notes</em></a>.</p></div>
</div>
</div>


          </div>
        </div>
      </div>
      
      
    </div></div>
  </body>
</html>
