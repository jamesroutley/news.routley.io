<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/NAlexPear/pg_branch">Original</a>
    <h1>Pg_branch: Experimental Postgres extension brings Neon-like branching</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://raw.githubusercontent.com/NAlexPear/pg_branch/main/assets/logo.svg"><img src="https://raw.githubusercontent.com/NAlexPear/pg_branch/main/assets/logo.svg" width="50%" height="50%" alt="AI-generated logo that confers more legitimacy than this project deserves"/></a></p>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/NAlexPear/pg_branch/actions/workflows/check.yml/badge.svg?branch=main"><img src="https://github.com/NAlexPear/pg_branch/actions/workflows/check.yml/badge.svg?branch=main" alt="Pre-release Checks"/></a></p>
<p dir="auto">A Postgres extension for quickly creating &#34;branches&#34; of individual databases within a Postgres cluster using copy-on-write file systems like <a href="https://wiki.archlinux.org/title/btrfs" rel="nofollow"><code>BTRFS</code></a>.</p>
<h2 tabindex="-1" id="user-content-table-of-contents" dir="auto"><a href="#table-of-contents">Table of Contents<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ol dir="auto">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#future-work">Future Work</a></li>
<li><a href="#similar-projects">Similar Projects</a></li>
</ol>
<h2 tabindex="-1" id="user-content-introduction" dir="auto"><a href="#introduction">Introduction<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto"><span><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</span></p>
<p dir="auto">Postgres makes it easy to create new, empty databases with the <code>CREATE DATABASE</code> command. It&#39;s so easy, in fact, that one would think that creating new databases from existing databases would be easy, too. <a href="https://stackoverflow.com/questions/876522/creating-a-copy-of-a-database-in-postgresql" rel="nofollow">But it&#39;s not</a>.</p>
<p dir="auto">Postgres provides the option to create one database from another using <a href="https://www.postgresql.org/docs/current/sql-createdatabase.html" rel="nofollow"><code>CREATE DATABASE name [WITH] [TEMPLATE template]</code></a>, but doing so has two major restrictions:</p>
<ol dir="auto">
<li>there can be <em>no active connections to the <code>template</code> database</em>, and...</li>
<li>performance degrades rapidly as the size of the database increases</li>
</ol>
<p dir="auto"><code>pg_branch</code> is a Postgres extension that solves those problems by giving <code>CREATE DATABASE</code> the power of snapshots. If your <code>PGDATA</code> directory is on a copy-on-write file system like <a href="https://wiki.archlinux.org/title/btrfs" rel="nofollow"><code>BTRFS</code></a>, the <code>pg_branch</code> extension turns every <code>CREATE DATABASE</code> into an atomic file system snapshot that takes seconds instead of minutes (or hours). In addition, the copy-on-write strategy keeps disk usage low by only writing new segment data files to disk when they&#39;re modified (rather than read).</p>
<p dir="auto">TL;DR: <code>CREATE EXTENSION pg_branch</code> makes <code>CREATE DATABASE &lt;dbname&gt; WITH TEMPLATE &lt;bigdbname&gt;</code> super fast</p>
<h2 tabindex="-1" id="user-content-getting-started" dir="auto"><a href="#getting-started">Getting Started<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">Before installing <code>pg_branch</code>, it&#39;s important to configure the file system that the database cluster will use. The following steps will get you started:</p>
<blockquote>
<p dir="auto"><strong>Disclaimer</strong>: these steps are written with Linux in mind, and have only been testing on Linux.</p>
</blockquote>
<ol start="0" dir="auto">
<li>
<p dir="auto"><strong>install prerequisites</strong></p>
<p dir="auto">You&#39;ll need an installation of <code>btrfs</code> (usually packaged as <code>btrfs-progs</code>) as well as an up-to-date <a href="https://rustup.rs/" rel="nofollow">Rust toolchain</a> and the <a href="https://github.com/pgcentralfoundation/pgrx/blob/master/cargo-pgrx/README.md#cargo-pgrx"><code>pgrx</code> subcommand for <code>cargo</code></a>.</p>
</li>
<li>
<p dir="auto"><strong>format a disk as BTRFS</strong></p>
<p dir="auto">The easiest thing to do here is plug in a USB and check which disk it is with <code>lsblk</code>. Once you&#39;ve figure out which disk you&#39;d like to reformat, you can do so with:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo mkfs.btrfs /dev/sdX # replace sdX with your drive"><pre>sudo mkfs.btrfs /dev/sdX <span><span>#</span> replace sdX with your drive</span></pre></div>
</li>
<li>
<p dir="auto"><strong>mount your <code>btrfs</code>-formatted disk</strong></p>
<p dir="auto">You need a directory to mount this disk to, first. Something like:</p>

<p dir="auto">...which you can then use as a mount point for your new <code>btrfs</code> drive with:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo mount /dev/sdX /mnt/database"><pre>sudo mount /dev/sdX /mnt/database</pre></div>
</li>
<li>
<p dir="auto"><strong>intialize a Postgres cluster on your mounted disk</strong></p>
<p dir="auto"><a href="https://github.com/pgcentralfoundation/pgrx/blob/master/cargo-pgrx/README.md#cargo-pgrx"><code>cargo pgrx</code> can take care of initialization</a> as long as it knows where to initialize the data through the <code>PGRX_HOME</code> variable. Something like:</p>
<div dir="auto" data-snippet-clipboard-copy-content="PGRX_HOME=/mnt/database cargo pgrx init"><pre>PGRX_HOME=/mnt/database cargo pgrx init</pre></div>
</li>
<li>
<p dir="auto"><strong>clone this repo</strong></p>
<p dir="auto">The rest of these steps will be done from within this repo, so make sure you&#39;ve run <code>git clone git@github.com:NAlexPear/pg_branch.git</code> and <code>cd pg_branch</code>.</p>
</li>
<li>
<p dir="auto"><strong>convert all segment data directories to subvolumes</strong></p>
<p dir="auto">Before <code>pg_branch</code> can take over database creation, the subdirectories in the newly-initialized data directory of your database need to be converted to <code>btrfs</code> subvolumes. This repo provides an <code>init.sh</code> script for doing just this that, as long as it&#39;s provided a <code>PGDATA</code> variable that points to the data directory of your cluster.</p>
<p dir="auto"><code>pgrx</code> data directories have a structure of <code>$PGRX_HOME/data-$PG_VERSION</code>. So if you initialized your project as instructed in step 3, you should be able to run the <code>init.sh</code> script in this repository like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="PGDATA=/mnt/database/data-15 ./init.sh"><pre>PGDATA=/mnt/database/data-15 ./init.sh</pre></div>
<p dir="auto">...and you should have successfully converted all of the initial databases in your cluster to subvolumes.</p>
</li>
<li>
<p dir="auto"><strong>get into <code>psql</code></strong></p>
<p dir="auto">The quickest way to jump into a <code>psql</code> session that recognizes <code>pg_branch</code> is to run the following:</p>
<div dir="auto" data-snippet-clipboard-copy-content="PGX_HOME=/your/mounted/btrfs/disk cargo pgrx run"><pre>PGX_HOME=/your/mounted/btrfs/disk cargo pgrx run</pre></div>
</li>
<li>
<p dir="auto"><strong>create the extension in <code>psql</code> with <code>CREATE EXTENSION pg_branch</code></strong></p>
</li>
<li>
<p dir="auto"><strong>create some databases</strong></p>
<p dir="auto">After creating the extension, you can run <code>CREATE DATABASE &lt;dbname&gt; WITH TEMPLATE &lt;template_dbname&gt;</code> commands to quickly and atomically copy databases without requiring an exclusive lock or dedicated connection. To use the default <code>CREATE DATABASE</code> behavior again, pick an explicit <code>STRATEGY</code> other than <code>SNAPSHOT</code> (i.e. <code>WAL_COPY</code> or <code>FILE_COPY</code>).</p>
</li>
</ol>
<h2 tabindex="-1" id="user-content-future-work" dir="auto"><a href="#future-work">Future Work<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<ol dir="auto">
<li>distribute as pre-compiled extension</li>
<li>implement a cluster-wide <code>fork</code></li>
<li>support more of the options supported by <code>CREATE DATABASE</code></li>
<li>streamline setup of the data directory and its file system</li>
<li>support additional copy-on-write file systems like <code>ZFS</code> and <code>XFS</code></li>
<li>include an example Dockerfile</li>
</ol>
<h2 tabindex="-1" id="user-content-similar-projects" dir="auto"><a href="#similar-projects">Similar Projects<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">This project&#39;s use of file system snapshots as a branching mechanism is heavily inspired by <a href="https://github.com/Photonios/pgcow"><code>pgcow</code></a> and <a href="https://postgres.ai/" rel="nofollow">Postgres.ai</a>. And credit for the concept of &#34;forking&#34; Postgres clusters goes to <a href="https://devcenter.heroku.com/articles/heroku-postgres-fork" rel="nofollow">Heroku&#39;s Database Fork</a> feature.</p>
</article>
          </div></div>
  </body>
</html>
