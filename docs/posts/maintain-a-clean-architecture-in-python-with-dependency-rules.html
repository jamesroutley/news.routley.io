<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sourcery.ai/blog/dependency-rules/">Original</a>
    <h1>Maintain a clean architecture in Python with dependency rules</h1>
    
    <div id="readability-page-1" class="page"><div><p><span>
      <span></span>
  <img alt="clean architecture" title="clean architecture" src="https://sourcery.ai/static/05300f06cb847360719e2aa31dc5a31b/8c857/dependencies.png" srcset="/static/05300f06cb847360719e2aa31dc5a31b/772e8/dependencies.png 200w,
/static/05300f06cb847360719e2aa31dc5a31b/e17e5/dependencies.png 400w,
/static/05300f06cb847360719e2aa31dc5a31b/8c857/dependencies.png 761w" sizes="(max-width: 761px) 100vw, 761px" loading="lazy" decoding="async"/>
    </span></p>
<h2>Packages, Dependencies, And Architecture</h2>
<p>As soon as your application gets a bit bigger, you&#39;ll probably divide it into
subsystems. In Python, this usually means packages. How well the boundaries
between those packages are defined and how the communication flows between them
greatly influences the maintainability of your project.</p>
<p>In this blog post, we&#39;re going to:</p>
<ol>
<li>Visualize the optimal flow of communication between packages.</li>
<li>Phrase some rules (in English) about the dependencies between those packages
based on the visual.</li>
<li>Translate the rules into code, so that we can check how much our application
follows the optimal architecture.</li>
</ol>
<p>Following this example, you can create architecture rules for your own projects.</p>
<h3>The Example API</h3>
<p>We&#39;re using a FastAPI application as an example. It stores its data in a
PostgreSQL database via SQLAlchemy. It&#39;s divided into 4 packages:</p>
<ul>
<li><code>app.api</code></li>
<li><code>app.core</code></li>
<li><code>app.db</code></li>
<li><code>app.schemas</code></li>
</ul>
<h2>Visualizing the Communication Between Packages</h2>
<p>How do these packages communicate with each other? And with the external
libraries powering them?</p>
<p>This might take many different forms. One possible architecture is this:</p>
<p><span>
      <span></span>
  <img alt="clean architecture" title="clean architecture" src="https://sourcery.ai/static/05300f06cb847360719e2aa31dc5a31b/8c857/dependencies.png" srcset="/static/05300f06cb847360719e2aa31dc5a31b/772e8/dependencies.png 200w,
/static/05300f06cb847360719e2aa31dc5a31b/e17e5/dependencies.png 400w,
/static/05300f06cb847360719e2aa31dc5a31b/8c857/dependencies.png 761w" sizes="(max-width: 761px) 100vw, 761px" loading="lazy" decoding="async"/>
    </span></p>
<p>But it can also look something like this:</p>
<p><span>
      <span></span>
  <img alt="various dependencies" title="various dependencies" src="https://sourcery.ai/static/72fcc4e9e62a5913bdec0fc787f5d1a8/8c857/dependencies-multiple.png" srcset="/static/72fcc4e9e62a5913bdec0fc787f5d1a8/772e8/dependencies-multiple.png 200w,
/static/72fcc4e9e62a5913bdec0fc787f5d1a8/e17e5/dependencies-multiple.png 400w,
/static/72fcc4e9e62a5913bdec0fc787f5d1a8/8c857/dependencies-multiple.png 761w" sizes="(max-width: 761px) 100vw, 761px" loading="lazy" decoding="async"/>
    </span></p>
<p>You can make things even more complicated by introducing circular dependencies:</p>
<p><span>
      <span></span>
  <img alt="circular dependencies" title="circular dependencies" src="https://sourcery.ai/static/da89c9659ed8524821db10af3ff1c995/8c857/dependencies-circular.png" srcset="/static/da89c9659ed8524821db10af3ff1c995/772e8/dependencies-circular.png 200w,
/static/da89c9659ed8524821db10af3ff1c995/e17e5/dependencies-circular.png 400w,
/static/da89c9659ed8524821db10af3ff1c995/8c857/dependencies-circular.png 761w" sizes="(max-width: 761px) 100vw, 761px" loading="lazy" decoding="async"/>
    </span></p>
<p>While Python doesn&#39;t allow circular dependencies between modules, it won&#39;t stop
you from introducing circular dependencies between packages.</p>
<p>The first architecture looks more simple. And this has some advantages:</p>
<ul>
<li>It&#39;s easier to understand and reason about.</li>
<li>It&#39;s easier to see the consequences of a change.</li>
<li>It&#39;s easier to replace a single element of the application.</li>
</ul>
<h2>Defining the Dependency Rules</h2>
<p>Now, we have a picture of how these packages should communicate. Let&#39;s define
some rules to achieve this architecture. First, we&#39;ll establish some rules on
how the packages of our application communicate with each other:</p>
<ul>
<li>No other package depends on <code>api</code>.</li>
<li>Only <code>api</code> depends <code>core</code>.</li>
<li>Only <code>core</code> depends on <code>db</code>.</li>
</ul>
<p>Let&#39;s turn to the external dependencies. We want to ensure that each of them is
accessed only by the relevant package of our system:</p>
<ul>
<li>FastAPI from <code>api</code></li>
<li>SQLAlchemy from <code>db</code></li>
<li>Pydantic from <code>models</code></li>
</ul>
<p>Note that you probably don&#39;t want to define such a rule for every single
dependency. But for libraries that are a crucial part of the architecture, it&#39;s
a good idea to keep the interface clean.</p>
<h2>Express the Dependency Rules as Code</h2>
<p>So far, we&#39;ve defined the dependency rules of our system: in a picture and in
some sentences. Let&#39;s see how it matches up with the reality of our system. üòè
For that, we&#39;ll take the rules from the previous section and translate them into
code.</p>
<p>For this translation, we&#39;ll use the tool
<a href="https://github.com/sourcery-ai/sourcery-rules-generator">Sourcery Rules Generator</a>
It creates
<a href="https://docs.sourcery.ai/Reference/Custom-Rules/pattern-syntax/">Sourcery&#39;s custom rules</a>
in YAML format based on your input. You can install it
<a href="https://github.com/sourcery-ai/sourcery-rules-generator">from PyPI</a>:</p>
<div data-language="bash"><pre><code>pip <span>install</span> sourcery-rules-generator</code></pre></div>
<h3>Setting Up Our Boundaries</h3>
<p>Let&#39;s start with the first rule:</p>
<p><strong>No other package depends on <code>api</code>.</strong></p>
<p>To create such a rule about dependencies, run the command:</p>
<div data-language="text"><pre><code>sourcery-rules dependencies create</code></pre></div>
<p>You&#39;ll see:</p>
<ul>
<li>a brief introduction to the Dependencies rule template</li>
<li>a prompt where you can enter the package&#39;s name</li>
<li>after that, a second prompt where you can enter which packages are allowed to
import the first package</li>
</ul>
<p>Provide the parameters, so that the dependency rules can be generated:</p>
<ul>
<li>In the first prompt, enter the fully qualified name of the package: app.api</li>
<li>Leave the second prompt empty. (Because no package is allowed to import
<code>app.api</code>.)</li>
</ul>
<p><span>
      <span></span>
  <img alt="screenshot: sourcery-rules dependencies create input parameters" title="screenshot: sourcery-rules dependencies create input parameters" src="https://sourcery.ai/static/83a4c570e9d80cacaa22f3e92276bb54/5a190/sourcery-rules_dependencies_create_input_parameters.png" srcset="/static/83a4c570e9d80cacaa22f3e92276bb54/772e8/sourcery-rules_dependencies_create_input_parameters.png 200w,
/static/83a4c570e9d80cacaa22f3e92276bb54/e17e5/sourcery-rules_dependencies_create_input_parameters.png 400w,
/static/83a4c570e9d80cacaa22f3e92276bb54/5a190/sourcery-rules_dependencies_create_input_parameters.png 800w,
/static/83a4c570e9d80cacaa22f3e92276bb54/c1b63/sourcery-rules_dependencies_create_input_parameters.png 1200w,
/static/83a4c570e9d80cacaa22f3e92276bb54/29007/sourcery-rules_dependencies_create_input_parameters.png 1600w,
/static/83a4c570e9d80cacaa22f3e92276bb54/ca3c3/sourcery-rules_dependencies_create_input_parameters.png 1850w" sizes="(max-width: 800px) 100vw, 800px" loading="lazy" decoding="async"/>
    </span></p>
<p>Now, you&#39;ll get an output with 2 rules in YAML format:</p>
<ul>
<li>one detecting <code>import</code> statements</li>
<li>one detecting <code>from ... import</code> statements</li>
</ul>
<p>These rules detect if <code>app.api</code> or any of its subpackages gets imported within
your project.</p>
<div data-language="yaml"><pre><code><span>rules</span><span>:</span>
  <span>-</span> <span>id</span><span>:</span> dependency<span>-</span>rules<span>-</span>app<span>-</span>api<span>-</span>import
    <span>description</span><span>:</span> Do not import `app.api` in other packages
    <span>pattern</span><span>:</span> import <span>...</span><span>,</span> $<span>{</span>module<span>}</span><span>,</span> <span>...</span>
    <span>condition</span><span>:</span> module.matches_regex(r&#34;^app\.api&#34;)
    <span>paths</span><span>:</span>
      <span>exclude</span><span>:</span>
        <span>-</span> app/api/
        <span>-</span> tests/
    <span>tags</span><span>:</span>
      <span>-</span> architecture
      <span>-</span> dependencies
  <span>-</span> <span>id</span><span>:</span> dependency<span>-</span>rules<span>-</span>app<span>-</span>api<span>-</span>from
    <span>description</span><span>:</span> Do not import `app.api` in other packages
    <span>pattern</span><span>:</span> from $<span>{</span>module<span>}</span> import <span>...</span>
    <span>condition</span><span>:</span> module.matches_regex(r&#34;^app\.api&#34;)
    <span>paths</span><span>:</span>
      <span>exclude</span><span>:</span>
        <span>-</span> app/api/
        <span>-</span> tests/
    <span>tags</span><span>:</span>
      <span>-</span> architecture
      <span>-</span> dependencies</code></pre></div>
<p>What do these rules contain?</p>
<ul>
<li>A <strong>pattern</strong> with the syntax that we want to detect.</li>
<li>A <strong>condition</strong> ensuring that the rule detects only imports referencing the
<code>app.api</code> package.</li>
<li>Some <strong>excluded paths</strong>: It&#39;s OK to reference the <code>app.api</code> package in itself
and in tests.</li>
<li>The <code>architecture</code> and <code>dependencies</code> <strong>tags</strong>. This way, we can check for all
the architecture rules together.</li>
</ul>
<p>You can copy these rules into your projects <code>.sourcery.yaml</code> config file. For
that it&#39;s recommended to use the <code>--plain</code> option:</p>
<div data-language="text"><pre><code>sourcery-rules dependencies create --plain</code></pre></div>
<p>Now, you can run the <code>sourcery review</code> command of the
<a href="https://docs.sourcery.ai/Guides/Getting-Started/Command-Line/">Sourcery CLI</a> to
check for these rules:</p>
<div data-language="bash"><pre><code>sourcery review <span>--enable</span> architecture <span>.</span></code></pre></div>
<h3>Further Rules for Internal Dependencies</h3>
<p>Now, we can create similar Sourcery custom rules for our other internal
dependency rules.</p>
<p><strong>Only <code>api</code> depends <code>core</code>.</strong></p>
<p>Again, we run the same command:</p>
<div data-language="text"><pre><code>sourcery-rules dependencies create</code></pre></div>
<p>This time, we fill both parameters:</p>
<ul>
<li><code>app.core</code> is the package</li>
<li><code>app.api</code> is the only package importing it</li>
</ul>
<p><span>
      <span></span>
  <img alt="screenshot: sourcery-rules dependencies create for core &lt;- api" title="screenshot: sourcery-rules dependencies create for core &lt;- api" src="https://sourcery.ai/static/be7521adc1801184049b60bf06d07f8a/5a190/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png" srcset="/static/be7521adc1801184049b60bf06d07f8a/772e8/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png 200w,
/static/be7521adc1801184049b60bf06d07f8a/e17e5/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png 400w,
/static/be7521adc1801184049b60bf06d07f8a/5a190/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png 800w,
/static/be7521adc1801184049b60bf06d07f8a/c1b63/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png 1200w,
/static/be7521adc1801184049b60bf06d07f8a/29007/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png 1600w,
/static/be7521adc1801184049b60bf06d07f8a/ca3c3/sourcery-rules_dependencies_create_input_parameters_with_1_allowed_importer.png 1850w" sizes="(max-width: 800px) 100vw, 800px" loading="lazy" decoding="async"/>
    </span></p>
<p>Again, 2 rules are created:</p>
<div data-language="yaml"><pre><code><span>rules</span><span>:</span>
  <span>-</span> <span>id</span><span>:</span> dependency<span>-</span>rules<span>-</span>app<span>-</span>core<span>-</span>import
    <span>description</span><span>:</span> Only `app.api` should import `app.core`
    <span>pattern</span><span>:</span> import <span>...</span><span>,</span> $<span>{</span>module<span>}</span><span>,</span> <span>...</span>
    <span>condition</span><span>:</span> module.matches_regex(r&#34;^app\.core&#34;)
    <span>paths</span><span>:</span>
      <span>exclude</span><span>:</span>
        <span>-</span> app/core/
        <span>-</span> tests/
        <span>-</span> app/api/
    <span>tags</span><span>:</span>
      <span>-</span> architecture
      <span>-</span> dependencies
  <span>-</span> <span>id</span><span>:</span> dependency<span>-</span>rules<span>-</span>app<span>-</span>core<span>-</span>from
    <span>description</span><span>:</span> Only `app.api` should import `app.core`
    <span>pattern</span><span>:</span> from $<span>{</span>module<span>}</span> import <span>...</span>
    <span>condition</span><span>:</span> module.matches_regex(r&#34;^app\.core&#34;)
    <span>paths</span><span>:</span>
      <span>exclude</span><span>:</span>
        <span>-</span> app/core/
        <span>-</span> tests/
        <span>-</span> app/api/
    <span>tags</span><span>:</span>
      <span>-</span> architecture
      <span>-</span> dependencies</code></pre></div>
<p>You can also create similar rules ensuring that only <code>app.core</code> should import
<code>app.db</code>.</p>
<h3>Rules for External Dependencies</h3>
<p>Let&#39;s turn to the rules regarding the external dependencies:</p>
<ul>
<li>Only <code>api</code> depends on FastAPI</li>
<li>Only <code>db</code> depends on SQLAlchemy</li>
<li>Only <code>models</code> depends on Pydantic</li>
</ul>
<p>We can create these rules the same way we did for the internal dependencies.
This time, the <code>package</code> won&#39;t be a package in our project, but an external
dependency.</p>
<p><strong>Only <code>app.api</code> imports FastAPI.</strong></p>
<div data-language="text"><pre><code>sourcery-rules dependencies create</code></pre></div>
<p>This time, we fill both parameters:</p>
<ul>
<li><code>fastapi</code> is the package</li>
<li><code>app.api</code> is the only package importing it</li>
</ul>
<p><span>
      <span></span>
  <img alt="screenshot sourcery-rules dependencies create fastapi and app.api" title="screenshot sourcery-rules dependencies create fastapi and app.api" src="https://sourcery.ai/static/aa3876cf3e6a49156a7d402327a718bd/5a190/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png" srcset="/static/aa3876cf3e6a49156a7d402327a718bd/772e8/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png 200w,
/static/aa3876cf3e6a49156a7d402327a718bd/e17e5/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png 400w,
/static/aa3876cf3e6a49156a7d402327a718bd/5a190/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png 800w,
/static/aa3876cf3e6a49156a7d402327a718bd/c1b63/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png 1200w,
/static/aa3876cf3e6a49156a7d402327a718bd/29007/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png 1600w,
/static/aa3876cf3e6a49156a7d402327a718bd/ca3c3/sourcery-rules_dependencies_create_input_parameters_fastapi_api.png 1850w" sizes="(max-width: 800px) 100vw, 800px" loading="lazy" decoding="async"/>
    </span></p>
<p>Again, the output shows 2 rules:</p>
<div data-language="yaml"><pre><code><span>rules</span><span>:</span>
  <span>-</span> <span>id</span><span>:</span> dependency<span>-</span>rules<span>-</span>fastapi<span>-</span>import
    <span>description</span><span>:</span> Only `app.api` should import `fastapi`
    <span>pattern</span><span>:</span> import <span>...</span><span>,</span> $<span>{</span>module<span>}</span><span>,</span> <span>...</span>
    <span>condition</span><span>:</span> module.matches_regex(r&#34;^fastapi&#34;)
    <span>paths</span><span>:</span>
      <span>exclude</span><span>:</span>
        <span>-</span> fastapi/
        <span>-</span> tests/
        <span>-</span> app/api/
    <span>tags</span><span>:</span>
      <span>-</span> architecture
      <span>-</span> dependencies
  <span>-</span> <span>id</span><span>:</span> dependency<span>-</span>rules<span>-</span>fastapi<span>-</span>from
    <span>description</span><span>:</span> Only `app.api` should import `fastapi`
    <span>pattern</span><span>:</span> from $<span>{</span>module<span>}</span> import <span>...</span>
    <span>condition</span><span>:</span> module.matches_regex(r&#34;^fastapi&#34;)
    <span>paths</span><span>:</span>
      <span>exclude</span><span>:</span>
        <span>-</span> fastapi/
        <span>-</span> tests/
        <span>-</span> app/api/
    <span>tags</span><span>:</span>
      <span>-</span> architecture
      <span>-</span> dependencies</code></pre></div>
<p>You can create rules in the same way for the 2 other external dependencies as
well:</p>
<ul>
<li>only <code>app.db</code> imports SQLAlchemy</li>
<li>only <code>app.models</code> imports Pydantic</li>
</ul>
<p>Now, we have 12 Sourcery custom rules to express our 6 architecture rules. We
can run all of them with the <code>sourcery review</code> command in the Sourcery CLI:</p>
<div data-language="bash"><pre><code>sourcery review <span>--enable</span> architecture <span>.</span></code></pre></div>
<h2>Generalization: Create Architecture Rules in Your Project</h2>
<p>Following the examples above, you can create rules for dependencies in your own
projects. The recommended steps:</p>
<ol>
<li>Draw a diagram showing the optimal dependencies between your packages.</li>
<li>Phrase some rules in a human language based on the diagram: Which package
should depend on which?</li>
<li>Translate the rules into code with Sourcery custom rules with
<a href="https://github.com/sourcery-ai/sourcery-rules-generator">Sourcery Rules Generator</a>.</li>
</ol>
<p>If you&#39;re working on a huge application, don&#39;t try to tackle the whole
architecture at once. Pick a subset of packages and go through the 3 steps with
this smaller scope.</p>
<p>You can also check out the how-to guide
<a href="https://docs.sourcery.ai/Guides/Custom-Rules/Recipes/dependencies-between-your-packages/">Establish Rules for Dependencies Between Your Packages</a>
in the Sourcery docs.</p>
<p>Have you created architecture rules for your system? Do you have any questions,
thoughts on this? Let us know.</p>
<p>Reach out at <a href="mailto:hello@sourcery.ai">hello@sourcery.ai</a> or on Twitter
<a href="https://twitter.com/SourceryAI">@SourceryAI</a>. Join the
<a href="https://discord.gg/angsCwXFAY">Sourcery Discord Community</a>.</p></div></div>
  </body>
</html>
