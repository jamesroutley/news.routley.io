<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.wedesoft.de/software/2025/09/05/clojure-game/">Original</a>
    <h1>Developing a Space Flight Simulator in Clojure</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
  
  <p><span>05 Sep 2025</span></p><p>    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/38FGT7SWVh0" frameborder="0" allowfullscreen=""></iframe></p>

<p>In 2017 I discovered the free of charge <a href="http://orbit.medphys.ucl.ac.uk/">Orbiter 2016</a> space flight simulator which was proprietary at the time and it inspired me to develop a space flight simulator myself.
I prototyped some rigid body physics in C and later in <a href="https://www.gnu.org/software/guile/">GNU Guile</a> and also prototyped loading and rendering of Wavefront OBJ files.
I used GNU Guile (a Scheme implementation) because it has a good native interface and of course it has hygienic macros.
Eventually I got interested in Clojure because unlike GNU Guile it has multi-methods as well as fast hash maps and vectors.
I finally decided to develop the game for real in Clojure.
I have been developing a space flight simulator in Clojure for almost 5 years now.
While using Clojure I have come to appreciate the immutable values and safe parallelism using atoms, agents, and refs.</p>

<p>In the beginning I decided to work on the hard parts first, which for me were 3D rendering of a planet, an atmosphere, shadows, and volumetric clouds.
I read the <a href="https://www.informit.com/store/opengl-superbible-comprehensive-tutorial-and-reference-9780672337475">OpenGL Superbible</a> to get an understanding on what functionality OpenGL provides.
When Orbiter was eventually open sourced and released unter MIT license <a href="https://github.com/orbitersim/orbiter">here</a>, I inspected the source code and discovered that about 90% of the code is graphics-related.
So starting with the graphics problems was not a bad decision.</p>

<h2 id="software-dependencies">Software dependencies</h2>

<p>The following software is used for development.
The software libraries run on both GNU/Linux and Microsoft Windows.</p>

<ul>
  <li><a href="https://clojure.org/">Clojure</a> the programming language</li>
  <li><a href="https://www.lwjgl.org/">LWJGL</a> provides Java wrappers for various libraries
    <ul>
      <li>lwjgl-opengl for 3D graphics</li>
      <li>lwjgl-glfw for windowing and input devices</li>
      <li>lwjgl-nuklear for graphical user interfaces</li>
      <li>lwjgl-stb for image I/O and using truetype fonts</li>
      <li>lwjgl-assimp to load glTF 3D models with animation data</li>
    </ul>
  </li>
  <li><a href="https://github.com/jrouwe/JoltPhysics">Jolt Physics</a> to simulate wheeled vehicles and collisions with meshes</li>
  <li><a href="https://generateme.github.io/fastmath/">Fastmath</a> for fast matrix and vector math as well as spline interpolation</li>
  <li><a href="https://github.com/weavejester/comb">Comb</a> for templating shader code</li>
  <li><a href="https://github.com/Engelberg/instaparse">Instaparse</a> to parse NASA Planetary Constant Kernel (PCK) files</li>
  <li><a href="https://github.com/clj-commons/gloss">Gloss</a> to parse NASA Double Precision Array Files (DAF)</li>
  <li><a href="https://github.com/IGJoshua/coffi">Coffi</a> as a foreign function interface</li>
  <li><a href="https://github.com/clojure/core.memoize">core.memoize</a> for least recently used caching of function results</li>
  <li><a href="https://commons.apache.org/proper/commons-compress/">Apache Commons Compress</a> to read map tiles from tar files</li>
  <li><a href="https://github.com/metosin/malli">Malli</a> to add schemas to functions</li>
  <li><a href="https://github.com/levand/immuconf">Immuconf</a> to load the configuration file</li>
  <li><a href="https://github.com/weavejester/progrock">Progrock</a> a progress bar for long running builds</li>
  <li><a href="https://github.com/clj-commons/claypoole">Claypoole</a> to implement parallel for loops</li>
  <li><a href="https://clojure.org/guides/tools_build">tools.build</a> to build the project</li>
  <li><a href="https://github.com/clojure-goes-fast/clj-async-profiler">clj-async-profiler</a> Clojure profiler creating flame graphs</li>
  <li><a href="https://github.com/fzakaria/slf4j-timbre">slf4j-timbre</a> Java logging implementation for Clojure</li>
</ul>

<p>The <em>deps.edn</em> file contains operating system dependent LWJGL bindings.
For example on GNU/Linux the <em>deps.edn</em> file contains the following:</p>

<figure><pre><code data-lang="clojure"><span>{</span><span>:deps</span><span> </span><span>{</span><span>; ...</span><span>
        </span><span>org.lwjgl/lwjgl</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl$natives-linux</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-opengl</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-opengl$natives-linux</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-glfw</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-glfw$natives-linux</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-nuklear</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-nuklear$natives-linux</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-stb</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-stb$natives-linux</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-assimp</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}</span><span>
        </span><span>org.lwjgl/lwjgl-assimp$natives-linux</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;3.3.6&#34;</span><span>}}</span><span>
        </span><span>; ...</span><span>
        </span><span>}</span></code></pre></figure>

<p>In order to manage the different dependencies for Microsoft Windows, a separate Git branch is maintained.</p>

<h2 id="atmosphere-rendering">Atmosphere rendering</h2>


<p>    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/q9aWd_14qhA" frameborder="0" allowfullscreen=""></iframe></p>

<p>For the atmosphere, <a href="https://ebruneton.github.io/precomputed_atmospheric_scattering/">Bruneton’s precomputed atmospheric scattering</a> was used.
The implementation uses a 2D transmittance table, a 2D surface scattering table, a 4D Rayleigh scattering, and a 4D Mie scattering table.
The tables are computed using several iterations of numerical integration.
Higher order functions for integration over a sphere and over a line segment were implemented in Clojure.
Integration over a ray in 3D space (using fastmath vectors) was implemented as follows for example:</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>defn</span><span> </span><span>integral-ray</span><span>
  </span><span>&#34;Integrate given function over a ray in 3D space&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>ray</span><span> </span><span>N</span><span> </span><span>:double</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>[</span><span>:vector</span><span> </span><span>:double</span><span>]]</span><span> </span><span>:some</span><span>]]</span><span> </span><span>:some</span><span>]}</span><span>
  </span><span>[{</span><span>::keys</span><span> </span><span>[</span><span>origin</span><span> </span><span>direction</span><span>]}</span><span> </span><span>steps</span><span> </span><span>distance</span><span> </span><span>fun</span><span>]</span><span>
  </span><span>(</span><span>let</span><span> </span><span>[</span><span>stepsize</span><span>      </span><span>(</span><span>/</span><span> </span><span>distance</span><span> </span><span>steps</span><span>)</span><span>
        </span><span>samples</span><span>       </span><span>(</span><span>mapv</span><span> </span><span>#</span><span>(</span><span>*</span><span> </span><span>(</span><span>+</span><span> </span><span>0.5</span><span> </span><span>%</span><span>)</span><span> </span><span>stepsize</span><span>)</span><span> </span><span>(</span><span>range</span><span> </span><span>steps</span><span>))</span><span>
        </span><span>interpolate</span><span>   </span><span>(</span><span>fn</span><span> </span><span>interpolate</span><span> </span><span>[</span><span>s</span><span>]</span><span> </span><span>(</span><span>add</span><span> </span><span>origin</span><span> </span><span>(</span><span>mult</span><span> </span><span>direction</span><span> </span><span>s</span><span>)))</span><span>
        </span><span>direction-len</span><span> </span><span>(</span><span>mag</span><span> </span><span>direction</span><span>)]</span><span>
    </span><span>(</span><span>reduce</span><span> </span><span>add</span><span> </span><span>(</span><span>mapv</span><span> </span><span>#</span><span>(</span><span>-&gt;</span><span> </span><span>%</span><span> </span><span>interpolate</span><span> </span><span>fun</span><span> </span><span>(</span><span>mult</span><span> </span><span>(</span><span>*</span><span> </span><span>stepsize</span><span> </span><span>direction-len</span><span>)))</span><span> </span><span>samples</span><span>))))</span></code></pre></figure>

<p>Precomputing the atmospheric tables takes several hours even though <a href="https://clojuredocs.org/clojure.core/pmap">pmap</a> was used.
When sampling the multi-dimensional functions, <em>pmap</em> was used as a top-level loop and <em>map</em> was used for interior loops.
Using <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/ByteBuffer.html">java.nio.ByteBuffer</a> the floating point values were converted to a byte array and then written to disk using a <a href="https://clojuredocs.org/clojure.java.io/output-stream">clojure.java.io/output-stream</a>:</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>defn</span><span> </span><span>floats-&gt;bytes</span><span>
  </span><span>&#34;Convert float array to byte buffer&#34;</span><span>
  </span><span>[</span><span>^</span><span>floats</span><span> </span><span>float-data</span><span>]</span><span>
  </span><span>(</span><span>let</span><span> </span><span>[</span><span>n</span><span>           </span><span>(</span><span>count</span><span> </span><span>float-data</span><span>)</span><span>
        </span><span>byte-buffer</span><span> </span><span>(</span><span>.order</span><span> </span><span>(</span><span>ByteBuffer/allocate</span><span> </span><span>(</span><span>*</span><span> </span><span>n</span><span> </span><span>4</span><span>))</span><span> </span><span>ByteOrder/LITTLE_ENDIAN</span><span>)]</span><span>
    </span><span>(</span><span>.put</span><span> </span><span>(</span><span>.asFloatBuffer</span><span> </span><span>byte-buffer</span><span>)</span><span> </span><span>float-data</span><span>)</span><span>
    </span><span>(</span><span>.array</span><span> </span><span>byte-buffer</span><span>)))</span><span>

</span><span>(</span><span>defn</span><span> </span><span>spit-bytes</span><span>
  </span><span>&#34;Write bytes to a file&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>non-empty-string</span><span> </span><span>bytes?</span><span>]</span><span> </span><span>:nil</span><span>]}</span><span>
  </span><span>[</span><span>^</span><span>String</span><span> </span><span>file-name</span><span> </span><span>^</span><span>bytes</span><span> </span><span>byte-data</span><span>]</span><span>
  </span><span>(</span><span>with-open</span><span> </span><span>[</span><span>out</span><span> </span><span>(</span><span>io/output-stream</span><span> </span><span>file-name</span><span>)]</span><span>
    </span><span>(</span><span>.write</span><span> </span><span>out</span><span> </span><span>byte-data</span><span>)))</span><span>

</span><span>(</span><span>defn</span><span> </span><span>spit-floats</span><span>
  </span><span>&#34;Write floating point numbers to a file&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>non-empty-string</span><span> </span><span>seqable?</span><span>]</span><span> </span><span>:nil</span><span>]}</span><span>
  </span><span>[</span><span>^</span><span>String</span><span> </span><span>file-name</span><span> </span><span>^</span><span>floats</span><span> </span><span>float-data</span><span>]</span><span>
  </span><span>(</span><span>spit-bytes</span><span> </span><span>file-name</span><span> </span><span>(</span><span>floats-&gt;bytes</span><span> </span><span>float-data</span><span>)))</span></code></pre></figure>

<p>When launching the game, the lookup tables get loaded and copied into OpenGL textures.
Shader functions are used to lookup and interpolate values from the tables.
When rendering the planet surface or the space craft, the atmosphere essentially gets superimposed using ray tracing.
After rendering the planet, a background quad is rendered to display the remaining part of the atmosphere above the horizon.</p>

<h2 id="templating-opengl-shaders">Templating OpenGL shaders</h2>

<p>It is possible to make programming with OpenGL shaders more flexible by using a templating library such as <em>Comb</em>.
The following shader defines multiple octaves of noise on a base noise function:</p>

<figure><pre><code data-lang="glsl"><span>#version 410 core
</span>
<span>float</span> <span>&lt;%=</span> <span>base</span><span>-</span><span>function</span> <span>%&gt;</span><span>(</span><span>vec3</span> <span>idx</span><span>);</span>

<span>float</span> <span>&lt;%=</span> <span>method</span><span>-</span><span>name</span> <span>%&gt;</span><span>(</span><span>vec3</span> <span>idx</span><span>)</span>
<span>{</span>
  <span>float</span> <span>result</span> <span>=</span> <span>0</span><span>.</span><span>0</span><span>;</span>
<span>&lt;%</span> <span>(</span><span>doseq</span> <span>[</span><span>multiplier</span> <span>octaves</span><span>]</span> <span>%&gt;</span>
  <span>result</span> <span>+=</span> <span>&lt;%=</span> <span>multiplier</span> <span>%&gt;</span> <span>*</span> <span>&lt;%=</span> <span>base</span><span>-</span><span>function</span> <span>%&gt;</span><span>(</span><span>idx</span><span>);</span>
  <span>idx</span> <span>*=</span> <span>2</span><span>;</span>
<span>&lt;%</span> <span>)</span> <span>%&gt;</span>
  <span>return</span> <span>result</span><span>;</span>
<span>}</span></code></pre></figure>

<p>One can then for example define the function <em>fbm_noise</em> using octaves of the base function <em>noise</em> as follows:</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>def</span><span> </span><span>noise-octaves</span><span>
  </span><span>&#34;Shader function to sum octaves of noise&#34;</span><span>
  </span><span>(</span><span>template/fn</span><span> </span><span>[</span><span>method-name</span><span> </span><span>base-function</span><span> </span><span>octaves</span><span>]</span><span> </span><span>(</span><span>slurp</span><span> </span><span>&#34;resources/shaders/core/noise-octaves.glsl&#34;</span><span>)))</span><span>

</span><span>; ...</span><span>

</span><span>(</span><span>def</span><span> </span><span>fbm-noise-shader</span><span> </span><span>(</span><span>noise-octaves</span><span> </span><span>&#34;fbm_noise&#34;</span><span> </span><span>&#34;noise&#34;</span><span> </span><span>[</span><span>0.57</span><span> </span><span>0.28</span><span> </span><span>0.15</span><span>]))</span></code></pre></figure>

<h2 id="planet-rendering">Planet rendering</h2>


<p>    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/Ce3oWQflYOY" frameborder="0" allowfullscreen=""></iframe></p>

<p>To render the planet, <a href="https://visibleearth.nasa.gov/collection/1484/blue-marble">NASA Bluemarble</a> data, <a href="https://earthobservatory.nasa.gov/features/NightLights/page3.php">NASA Blackmarble</a> data, and <a href="https://www.ngdc.noaa.gov/mgg/topo/gltiles.html">NASA Elevation</a> data was used.
The images were converted to a multi resolution pyramid of map tiles.
The following functions were implemented for color map tiles and for elevation tiles:</p>

<ul>
  <li>a function to load and cache map tiles of given 2D tile index and level of detail</li>
  <li>a function to extract a pixel from a map tile</li>
  <li>a function to extract the pixel for a specific longitude and latitude</li>
</ul>

<p>The functions for extracting a pixel for given longitude and latitude then were used to generate a cube map with a quad tree of tiles for each face.
For each tile, the following files were generated:</p>

<ul>
  <li>A daytime texture</li>
  <li>A night time texture</li>
  <li>An image of 3D vectors defining a surface mesh</li>
  <li>A water mask</li>
  <li>A normal map</li>
</ul>

<p>Altogether 655350 files were generated.
Because the Steam ContentBuilder does not support a large number of files, each row of tile data was aggregated into a tar file.
The <em>Apache Commons Compress</em> library allows you to open a tar file to get a list of entries and then perform random access on the contents of the tar file.
A Clojure LRU cache was used to maintain a cache of open tar files for improved performance.</p>

<p>At run time, a future is created, which returns an updated tile tree, a list of tiles to drop, and a path list of the tiles to load into OpenGL.
When the future is realized, the main thread deletes the OpenGL textures from the drop list, and then uses the path list to get the new loaded images from the tile tree, load them into OpenGL textures, and create an updated tile tree with the new OpenGL textures added.
The following functions to manipulate quad trees were implemented to realize this:</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>defn</span><span> </span><span>quadtree-add</span><span>
  </span><span>&#34;Add tiles to quad tree&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]</span><span> </span><span>[</span><span>:sequential</span><span> </span><span>[</span><span>:vector</span><span> </span><span>:keyword</span><span>]]</span><span> </span><span>[</span><span>:sequential</span><span> </span><span>:map</span><span>]]</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]]}</span><span>
  </span><span>[</span><span>tree</span><span> </span><span>paths</span><span> </span><span>tiles</span><span>]</span><span>
  </span><span>(</span><span>reduce</span><span> </span><span>(</span><span>fn</span><span> </span><span>add-title-to-quadtree</span><span> </span><span>[</span><span>tree</span><span> </span><span>[</span><span>path</span><span> </span><span>tile</span><span>]]</span><span> </span><span>(</span><span>assoc-in</span><span> </span><span>tree</span><span> </span><span>path</span><span> </span><span>tile</span><span>))</span><span> </span><span>tree</span><span> </span><span>(</span><span>mapv</span><span> </span><span>vector</span><span> </span><span>paths</span><span> </span><span>tiles</span><span>)))</span><span>

</span><span>(</span><span>defn</span><span> </span><span>quadtree-extract</span><span>
  </span><span>&#34;Extract a list of tiles from quad tree&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]</span><span> </span><span>[</span><span>:sequential</span><span> </span><span>[</span><span>:vector</span><span> </span><span>:keyword</span><span>]]]</span><span> </span><span>[</span><span>:vector</span><span> </span><span>:map</span><span>]]}</span><span>
  </span><span>[</span><span>tree</span><span> </span><span>paths</span><span>]</span><span>
  </span><span>(</span><span>mapv</span><span> </span><span>(</span><span>partial</span><span> </span><span>get-in</span><span> </span><span>tree</span><span>)</span><span> </span><span>paths</span><span>))</span><span>

</span><span>(</span><span>defn</span><span> </span><span>quadtree-drop</span><span>
  </span><span>&#34;Drop tiles specified by path list from quad tree&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]</span><span> </span><span>[</span><span>:sequential</span><span> </span><span>[</span><span>:vector</span><span> </span><span>:keyword</span><span>]]]</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]]}</span><span>
  </span><span>[</span><span>tree</span><span> </span><span>paths</span><span>]</span><span>
  </span><span>(</span><span>reduce</span><span> </span><span>dissoc-in</span><span> </span><span>tree</span><span> </span><span>paths</span><span>))</span><span>

</span><span>(</span><span>defn</span><span> </span><span>quadtree-update</span><span>
  </span><span>&#34;Update tiles with specified paths using a function with optional arguments from lists&#34;</span><span>
  </span><span>{</span><span>:malli/schema</span><span> </span><span>[</span><span>:=&gt;</span><span> </span><span>[</span><span>:cat</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]</span><span> </span><span>[</span><span>:sequential</span><span> </span><span>[</span><span>:vector</span><span> </span><span>:keyword</span><span>]]</span><span> </span><span>fn?</span><span> </span><span>[</span><span>:*</span><span> </span><span>:any</span><span>]]</span><span> </span><span>[</span><span>:maybe</span><span> </span><span>:map</span><span>]]}</span><span>
  </span><span>[</span><span>tree</span><span> </span><span>paths</span><span> </span><span>fun</span><span> </span><span>&amp;</span><span> </span><span>arglists</span><span>]</span><span>
  </span><span>(</span><span>reduce</span><span> </span><span>(</span><span>fn</span><span> </span><span>update-tile-in-quadtree</span><span>
            </span><span>[</span><span>tree</span><span> </span><span>[</span><span>path</span><span> </span><span>&amp;</span><span> </span><span>args</span><span>]]</span><span>
            </span><span>(</span><span>apply</span><span> </span><span>update-in</span><span> </span><span>tree</span><span> </span><span>path</span><span> </span><span>fun</span><span> </span><span>args</span><span>))</span><span> </span><span>tree</span><span> </span><span>(</span><span>apply</span><span> </span><span>map</span><span> </span><span>list</span><span> </span><span>paths</span><span> </span><span>arglists</span><span>)))</span></code></pre></figure>

<h2 id="other-topics">Other topics</h2>

<h3 id="solar-system">Solar system</h3>

<p>The astronomy code for getting the position and orientation of planets was implemented according to the <a href="https://rhodesmill.org/skyfield/">Skyfield</a> Python library.
The Python library in turn is based on the <a href="https://naif.jpl.nasa.gov/naif/index.html">SPICE</a> toolkit of the NASA JPL.
The JPL basically provides sequences of <a href="https://en.wikipedia.org/wiki/Chebyshev_polynomials">Chebyshev polynomials</a> to interpolate positions of Moon and planets as well as the orientation of the Moon as binary files.
Reference coordinate systems and orientations of other bodies are provided in text files which consist of human and machine readable sections.
The binary files were parsed using <em>Gloss</em> (see <a href="https://github.com/clj-commons/gloss/wiki/Introduction">Wiki</a> for some examples) and the text files using <em>Instaparse</em>.</p>

<h3 id="jolt-bindings">Jolt bindings</h3>

<p>The required Jolt functions for wheeled vehicle dynamics and collisions with meshes were wrapped in C functions and compiled into a shared library.
The <em>Coffi</em> Clojure library (which is a wrapper for Java’s new Foreign Function &amp; Memory API) was used to make the C functions and data types usable in Clojure.</p>

<p>For example the following code implements a call to the C function <em>add_force</em>:</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>defcfn</span><span> </span><span>add-force</span><span>
  </span><span>&#34;Apply a force in the next physics update&#34;</span><span>
  </span><span>add_force</span><span> </span><span>[</span><span>::mem/int</span><span> </span><span>::vec3</span><span>]</span><span> </span><span>::mem/void</span><span>)</span></code></pre></figure>

<p>Here <em>::vec3</em> refers to a custom composite type defined using basic types.
The memory layout, serialisation, and deserialisation for <em>::vec3</em> are defined as follows:</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>def</span><span> </span><span>vec3-struct</span><span>
  </span><span>[</span><span>::mem/struct</span><span>
   </span><span>[[</span><span>:x</span><span> </span><span>::mem/double</span><span>]</span><span>
    </span><span>[</span><span>:y</span><span> </span><span>::mem/double</span><span>]</span><span>
    </span><span>[</span><span>:z</span><span> </span><span>::mem/double</span><span>]]])</span><span>


</span><span>(</span><span>defmethod</span><span> </span><span>mem/c-layout</span><span> </span><span>::vec3</span><span>
  </span><span>[</span><span>_vec3</span><span>]</span><span>
  </span><span>(</span><span>mem/c-layout</span><span> </span><span>vec3-struct</span><span>))</span><span>


</span><span>(</span><span>defmethod</span><span> </span><span>mem/serialize-into</span><span> </span><span>::vec3</span><span>
  </span><span>[</span><span>obj</span><span> </span><span>_vec3</span><span> </span><span>segment</span><span> </span><span>arena</span><span>]</span><span>
  </span><span>(</span><span>mem/serialize-into</span><span> </span><span>{</span><span>:x</span><span> </span><span>(</span><span>obj</span><span> </span><span>0</span><span>)</span><span> </span><span>:y</span><span> </span><span>(</span><span>obj</span><span> </span><span>1</span><span>)</span><span> </span><span>:z</span><span> </span><span>(</span><span>obj</span><span> </span><span>2</span><span>)}</span><span> </span><span>vec3-struct</span><span> </span><span>segment</span><span> </span><span>arena</span><span>))</span><span>


</span><span>(</span><span>defmethod</span><span> </span><span>mem/deserialize-from</span><span> </span><span>::vec3</span><span>
  </span><span>[</span><span>segment</span><span> </span><span>_vec3</span><span>]</span><span>
  </span><span>(</span><span>let</span><span> </span><span>[</span><span>result</span><span> </span><span>(</span><span>mem/deserialize-from</span><span> </span><span>segment</span><span> </span><span>vec3-struct</span><span>)]</span><span>
    </span><span>(</span><span>vec3</span><span> </span><span>(</span><span>:x</span><span> </span><span>result</span><span>)</span><span> </span><span>(</span><span>:y</span><span> </span><span>result</span><span>)</span><span> </span><span>(</span><span>:z</span><span> </span><span>result</span><span>))))</span></code></pre></figure>

<h3 id="performance">Performance</h3>

<p>The <em>clj-async-profiler</em> was used to create flame graphs visualising the performance of the game.
In order to get reflection warnings for Java calls without sufficient type declarations, <em>*unchecked-math*</em> was set to <em>:warn-on-boxed</em>.</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>set!</span><span> </span><span>*unchecked-math*</span><span> </span><span>:warn-on-boxed</span><span>)</span></code></pre></figure>

<p>Furthermore to discover missing declarations of numerical types, <em>*warn-on-reflection*</em> was set to <em>true</em>.</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>set!</span><span> </span><span>*warn-on-reflection*</span><span> </span><span>true</span><span>)</span></code></pre></figure>

<p>To reduce garbage collector pauses, the ZGC low-latency garbage collector for the JVM was used.
The following section in <em>deps.edn</em> ensures that the ZGC garbage collector is used when running the project with <em>clj -M:run</em>:</p>

<figure><pre><code data-lang="clojure"><span>{</span><span>:deps</span><span> </span><span>{</span><span>; ...</span><span>
        </span><span>}</span><span>
 </span><span>:aliases</span><span> </span><span>{</span><span>:run</span><span> </span><span>{</span><span>:jvm-opts</span><span> </span><span>[</span><span>&#34;-Xms2g&#34;</span><span> </span><span>&#34;-Xmx4g&#34;</span><span> </span><span>&#34;--enable-native-access=ALL-UNNAMED&#34;</span><span> </span><span>&#34;-XX:+UseZGC&#34;</span><span>
                            </span><span>&#34;--sun-misc-unsafe-memory-access=allow&#34;</span><span>]</span><span>
                 </span><span>:main-opts</span><span> </span><span>[</span><span>&#34;-m&#34;</span><span> </span><span>&#34;sfsim.core&#34;</span><span>]}}}</span></code></pre></figure>

<p>The option to use ZGC is also specified in the Packr JSON file used to deploy the application.</p>

<h3 id="building-the-project">Building the project</h3>

<p>In order to build the map tiles, atmospheric lookup tables, and other data files using <em>tools.build</em>, the project source code was made available in the <em>build.clj</em> file using a <em>:local/root</em> dependency:</p>

<figure><pre><code data-lang="clojure"><span>{</span><span>:deps</span><span> </span><span>{</span><span>; ...</span><span>
        </span><span>}</span><span>
 </span><span>:aliases</span><span> </span><span>{</span><span>; ...</span><span>
           </span><span>:build</span><span> </span><span>{</span><span>:deps</span><span> </span><span>{</span><span>io.github.clojure/tools.build</span><span> </span><span>{</span><span>:mvn/version</span><span> </span><span>&#34;0.10.10&#34;</span><span>}</span><span>
                          </span><span>sfsim/sfsim</span><span> </span><span>{</span><span>:local/root</span><span> </span><span>&#34;.&#34;</span><span>}}</span><span>
                   </span><span>:ns-default</span><span> </span><span>build</span><span>
                   </span><span>:exec-fn</span><span> </span><span>all</span><span>
                   </span><span>:jvm-opts</span><span> </span><span>[</span><span>&#34;-Xms2g&#34;</span><span> </span><span>&#34;-Xmx4g&#34;</span><span> </span><span>&#34;--sun-misc-unsafe-memory-access=allow&#34;</span><span>]}}}</span></code></pre></figure>

<p>Various targets were defined to build the different components of the project.
For example the atmospheric lookup tables can be build by specifying <em>clj -T:build atmosphere-lut</em> on the command line.</p>

<p>The following section in the <em>build.clj</em> file was added to allow creating an “Uberjar” JAR file with all dependencies by specifying <em>clj -T:build uber</em> on the command-line.</p>

<figure><pre><code data-lang="clojure"><span>(</span><span>defn</span><span> </span><span>uber</span><span> </span><span>[</span><span>_</span><span>]</span><span>
  </span><span>(</span><span>b/copy-dir</span><span> </span><span>{</span><span>:src-dirs</span><span> </span><span>[</span><span>&#34;src/clj&#34;</span><span>]</span><span>
               </span><span>:target-dir</span><span> </span><span>class-dir</span><span>})</span><span>
  </span><span>(</span><span>b/compile-clj</span><span> </span><span>{</span><span>:basis</span><span> </span><span>basis</span><span>
                  </span><span>:src-dirs</span><span> </span><span>[</span><span>&#34;src/clj&#34;</span><span>]</span><span>
                  </span><span>:class-dir</span><span> </span><span>class-dir</span><span>})</span><span>
  </span><span>(</span><span>b/uber</span><span> </span><span>{</span><span>:class-dir</span><span> </span><span>class-dir</span><span>
           </span><span>:uber-file</span><span> </span><span>&#34;target/sfsim.jar&#34;</span><span>
           </span><span>:basis</span><span> </span><span>basis</span><span>
           </span><span>:main</span><span> </span><span>&#39;sfsim.core</span><span>}))</span></code></pre></figure>

<p>To create a Linux executable with Packr, one can then run <em>java -jar packr-all-4.0.0.jar scripts/packr-config-linux.json</em> where the JSON file has the following content:</p>

<figure><pre><code data-lang="json"><span>{</span><span>
  </span><span>&#34;platform&#34;</span><span>:</span><span> </span><span>&#34;linux64&#34;</span><span>,</span><span>
  </span><span>&#34;jdk&#34;</span><span>:</span><span> </span><span>&#34;/usr/lib/jvm/jdk-24.0.2-oracle-x64&#34;</span><span>,</span><span>
  </span><span>&#34;executable&#34;</span><span>:</span><span> </span><span>&#34;sfsim&#34;</span><span>,</span><span>
  </span><span>&#34;classpath&#34;</span><span>:</span><span> </span><span>[</span><span>&#34;target/sfsim.jar&#34;</span><span>],</span><span>
  </span><span>&#34;mainclass&#34;</span><span>:</span><span> </span><span>&#34;sfsim.core&#34;</span><span>,</span><span>
  </span><span>&#34;resources&#34;</span><span>:</span><span> </span><span>[</span><span>&#34;LICENSE&#34;</span><span>,</span><span> </span><span>&#34;libjolt.so&#34;</span><span>,</span><span> </span><span>&#34;venturestar.glb&#34;</span><span>,</span><span> </span><span>&#34;resources&#34;</span><span>],</span><span>
  </span><span>&#34;vmargs&#34;</span><span>:</span><span> </span><span>[</span><span>&#34;Xms2g&#34;</span><span>,</span><span> </span><span>&#34;Xmx4g&#34;</span><span>,</span><span> </span><span>&#34;XX:+UseZGC&#34;</span><span>],</span><span>
  </span><span>&#34;output&#34;</span><span>:</span><span> </span><span>&#34;out-linux&#34;</span><span>
</span><span>}</span></code></pre></figure>

<p>In order to distribute the game on Steam, three depots were created:</p>

<ul>
  <li>a data depot with the operating system independent data files</li>
  <li>a Linux depot with the Linux executable and Uberjar including LWJGL’s Linux native bindings</li>
  <li>and a Windows depot with the Windows executable and an Uberjar including LWJGL’s Windows native bindings</li>
</ul>

<p>When updating a depot, the Steam ContentBuilder command line tool creates and uploads a patch in order to preserve storage space and bandwidth.</p>

<h2 id="future-work">Future work</h2>

<p>Although the hard parts are mostly done, there are still several things to do:</p>

<ul>
  <li>control surfaces and thruster graphics</li>
  <li>launchpad and runway graphics</li>
  <li>sound effects</li>
  <li>a 3D cockpit</li>
  <li>the Moon</li>
  <li>a space station</li>
</ul>

<p>It would also be interesting to make the game modable in a safe way (maybe evaluating Clojure files in a sandboxed environment?).</p>

<h2 id="conclusion">Conclusion</h2>


<p>    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/1PqmVLUt5_g" frameborder="0" allowfullscreen=""></iframe></p>

<p>You can find the <a href="https://github.com/wedesoft/sfsim">source code on Github</a>.
Currently there is only a playtest build, but if you want to get notified, when the game gets released, you can <a href="https://store.steampowered.com/app/3687560/sfsim/">wishlist it here</a>.</p>

<p>Anyway, let me know any comments and suggestions.</p>

<p>Enjoy!</p>



<ul>
  <li><a href="https://www.wedesoft.de/simulation/2025/06/06/flight-model-physics-venturestar/">Flight dynamics model for simulating Venturestar style spacecraft</a></li>
  <li><a href="https://www.wedesoft.de/software/2022/07/01/tdd-with-opengl/">Test Driven Development with OpenGL</a></li>
  <li><a href="https://www.wedesoft.de/software/2024/05/11/clojure-nuklear/">Implementing GUIs using Clojure and LWJGL Nuklear bindings</a></li>
  <li><a href="https://www.wedesoft.de/software/2023/05/03/volumetric-clouds/">Procedural Volumetric Clouds</a></li>
  <li><a href="https://www.wedesoft.de/software/2023/03/20/procedural-global-cloud-cover/">Procedural generation of global cloud cover</a></li>
  <li><a href="https://www.wedesoft.de/software/2021/09/20/reversed-z-rendering/">Reversed-Z Rendering in OpenGL</a></li>
  <li><a href="https://www.wedesoft.de/software/2023/12/25/clojure-function-schemas-with-malli/">Specifying Clojure function schemas with Malli</a></li>
  <li><a href="https://www.wedesoft.de/software/2024/07/05/clojure-instaparse/">Implement an Interpreter using Clojure Instaparse</a></li>
  <li><a href="https://www.wedesoft.de/simulation/2025/08/09/orbits-with-jolt-physics/">Orbits with Jolt Physics</a></li>
  <li><a href="https://www.wedesoft.de/simulation/2024/09/26/jolt-physics-engine/">Getting started with the Jolt Physics Engine</a></li>
  <li><a href="https://www.wedesoft.de/graphics/2023/09/29/blender-animate-bones-assimp/">Create Blender bones and animate and import with Assimp</a></li>
</ul>


</div>








    </div></div>
  </body>
</html>
