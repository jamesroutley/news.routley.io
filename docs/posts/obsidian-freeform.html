<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://macwright.com/2024/06/02/freeform.html">Original</a>
    <h1>Obsidian Freeform</h1>
    
    <div id="readability-page-1" class="page"><div><p><em>Prefer video? You can also <a href="https://www.youtube.com/watch?v=7LhMavEpNSE">watch an intro video that I recorded for this on YouTube</a>.</em></p><p><a href="https://github.com/tmcw/obsidian-freeform">Obsidian Freeform</a> is an extremely small <a href="https://obsidian.md">Obsidian</a> plugin that enables totally custom JavaScript-powered frames alongside your notes. I created it because I use Obsidian as my note-taking application, and I found myself wanting to create charts for certain concepts.</p><p>For example, I recently learned about the availability of <em>mortgage discounts</em> from some banks in exchange for having a high balance. I am <a href="https://macwright.com/2023/12/21/homeownership">not buying a house</a>, but nevertheless, these were numbers from multiple sources that could be charted and compared and nobody was doing it, so I had to. So I made a chart:</p><p><img alt="Chart of mortgage discounts" src="https://macwright.com/images/2024-06-02-freeform-chart-of-mortgage-discounts.png"/></p><p>It seems like mortgage discounts are mostly <a href="https://www.reddit.com/r/fatFIRE/comments/q7od36/brokerage_mortgage_discounts/">a bad idea</a>, but now I at least have a quick visual reference for how they work across multiple banks.</p><p><em>The font I’m using in that screenshot is <a href="https://github.com/iaolo/iA-Fonts">iA Writer Quattro</a>, and the theme is <a href="https://github.com/kepano/obsidian-minimal">minimal</a>, both of which I learned about from <a href="https://www.everydayobsidian.com">Everyday Obsidian</a>.</em></p><h3 id="how-it-works">How it works</h3><p>The code is <a href="https://github.com/tmcw/obsidian-freeform/blob/6ec2e0e391650cdad8a89399b2d1c0420f5643d7/main.js">small enough to read in a few minutes</a>.</p><p>Obsidian Freeform adds a new code block type to Obsidian, tagged with <code>freeform</code>. Here’s the simplest possible block:</p><div><div><pre><code>```freeform
display(1);
```
</code></pre></div></div><p>When this block is displayed, it creates an iframe in your Obsidian document and injects the code <code>display(1)</code> into it via a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import">dynamic import</a>.</p><p><em>Why inject the code as a dynamic import? Because I want to make it possible to use <code>import</code> within your custom code to import modules, and import <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#description">needs to be top-level</a>. In practice, this detail shouldn’t matter to you.</em></p><p>The display method comes from <a href="https://github.com/observablehq/inspector">observablehq/inspector</a>, which is added to the global namespace as <strong>display</strong>, just like how it works <a href="https://observablehq.com/framework/javascript#display(value)">in Observable Framework</a>.</p><p><em>There is no <a href="https://observablehq.com/framework/javascript#implicit-display">implicit display</a> in Obsidian Freeform, and while it provides a <code>width</code> variable, that variable isn’t reactive. I’m trying to avoid adding too much magic. It’s just your JavaScript, as verbatim as I can make it.</em></p><h3 id="example-making-charts-with-observable-plot">Example: Making charts with Observable Plot</h3><p><img alt="Observable Plot example of a house" src="https://macwright.com/images/2024-06-02-freeform-observable-plot-example-of-a-house.png"/></p><p>You can recreate a lot of <a href="https://observablehq.com">Observable</a> examples in Freeform. Generally, the gap between the two is:</p><p><strong>Plot</strong> isn’t available globally. You have to import it from <code>jsdelivr</code> like:</p><div><div><pre><code><span>import</span> <span>*</span> <span>as</span> <span>Plot</span> <span>from</span> <span>&#34;</span><span>https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm</span><span>&#34;</span><span>;</span>
</code></pre></div></div><p>But then you’re basically good to go, as long as you remember:</p><ul><li>It’s just JavaScript, not Observable-flavored JavaScript, so you need to use <code>let</code> or <code>const</code> in front of variables.</li><li>There’s no implicit display, so you need to call <code>display()</code> if you want to display something.</li></ul><h3 id="example-loading-data-from-dataview">Example: Loading data from Dataview</h3><p>I use the fantastic <a href="https://blacksmithgu.github.io/obsidian-dataview/">Dataview Obsidian plugin</a> to do things like show charts of all the electronics I have in my house and which batteries they require.</p><p>Because the Obsidian context is available via <code>window.top</code> in Obsidian Freeform, I can access the Dataview JavaScript API:</p><p><img alt="Things I own cost vs when I bought them" src="https://macwright.com/images/2024-06-02-freeform-things-i-own-cost-vs-when-i-bought-them.png"/></p><div><div><pre><code><span>import</span> <span>*</span> <span>as</span> <span>Plot</span> <span>from</span> <span>&#34;</span><span>https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm</span><span>&#34;</span><span>;</span>

<span>const</span> <span>items</span> <span>=</span> <span>await</span> <span>window</span><span>.</span><span>top</span><span>.</span><span>app</span><span>.</span><span>plugins</span><span>.</span><span>plugins</span><span>.</span><span>dataview</span><span>.</span><span>api</span>
  <span>.</span><span>query</span><span>(</span><span>`table price, purchased, color
from &#34;03 Stuff&#34;
where price and sold = undefined
sort purchased desc`</span><span>);</span>

<span>const</span> <span>mapped</span> <span>=</span> <span>items</span><span>.</span><span>value</span><span>.</span><span>values</span>
  <span>.</span><span>map</span><span>((</span><span>item</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>if </span><span>(</span><span>!</span><span>item</span><span>[</span><span>2</span><span>])</span> <span>return</span><span>;</span>
    <span>return</span> <span>{</span>
      <span>price</span><span>:</span> <span>item</span><span>[</span><span>1</span><span>],</span>
      <span>date</span><span>:</span> <span>new</span> <span>Date</span><span>(</span><span>item</span><span>[</span><span>2</span><span>].</span><span>toMillis</span><span>()),</span>
    <span>};</span>
  <span>})</span>
  <span>.</span><span>filter</span><span>((</span><span>r</span><span>)</span> <span>=&gt;</span> <span>r</span><span>);</span>

<span>display</span><span>(</span><span>Plot</span><span>.</span><span>dot</span><span>(</span><span>mapped</span><span>,</span> <span>{</span> <span>y</span><span>:</span> <span>&#34;</span><span>price</span><span>&#34;</span><span>,</span> <span>x</span><span>:</span> <span>&#34;</span><span>date</span><span>&#34;</span> <span>}).</span><span>plot</span><span>());</span>
</code></pre></div></div><p>No, I don’t think <code>window.top.app.plugins.plugins.dataview.api</code> is a graceful, beautiful line of code, but it works and it’s explicit.</p><h3 id="example-loading-data-from-a-table">Example: Loading data from a table</h3><p>One of my few complaints with Obsidian is that it doesn’t <a href="https://github.com/obsidianmd/obsidian-api/issues/84">expose its own Markdown parser</a> and the internal syntax tree for its CodeMirror instance tree is <a href="https://forum.obsidian.md/t/using-a-decoration-instead-of-a-markdown-code-block-postprocessor/79718">oddly structured and undocumented</a>. So it’s tough for a plugin to interact with notes in a structured way.</p><p><img alt="Parsing a table" src="https://macwright.com/images/2024-06-02-freeform-parsing-a-table.png"/></p><p>But Freeform makes this <del>easy</del> possible! Here’s some magic that parses the current document, finds its first table, and turns that table’s contents into data that you can use in charts:</p><div><div><pre><code><span>import</span> <span>{</span> <span>unified</span> <span>}</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/unified?bundle</span><span>&#34;</span><span>;</span>
<span>import</span> <span>remarkGfm</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/remark-gfm?bundle</span><span>&#34;</span><span>;</span>
<span>import</span> <span>{</span> <span>toString</span> <span>}</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/mdast-util-to-string?bundle</span><span>&#34;</span><span>;</span>
<span>import</span> <span>remarkParse</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/remark-parse@11?bundle</span><span>&#34;</span><span>;</span>
<span>import</span> <span>remarkFrontmatter</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/remark-frontmatter?bundle</span><span>&#34;</span><span>;</span>
<span>import</span> <span>{</span> <span>selectAll</span> <span>}</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/unist-util-select?bundle</span><span>&#34;</span><span>;</span>
<span>import</span> <span>{</span> <span>autoType</span> <span>}</span> <span>from</span> <span>&#34;</span><span>https://esm.sh/d3-dsv</span><span>&#34;</span><span>;</span>

<span>const</span> <span>md</span> <span>=</span> <span>window</span><span>.</span><span>top</span><span>.</span><span>app</span><span>.</span><span>workspace</span><span>.</span><span>activeEditor</span><span>?.</span><span>editor</span><span>.</span><span>getDoc</span><span>().</span><span>getValue</span><span>();</span>

<span>const</span> <span>file</span> <span>=</span> <span>await</span> <span>unified</span><span>()</span>
  <span>.</span><span>use</span><span>(</span><span>remarkParse</span><span>)</span>
  <span>.</span><span>use</span><span>(</span><span>remarkGfm</span><span>)</span>
  <span>.</span><span>use</span><span>(</span><span>remarkFrontmatter</span><span>)</span>
  <span>.</span><span>parse</span><span>(</span><span>md</span><span>);</span>

<span>const</span> <span>table</span> <span>=</span> <span>selectAll</span><span>(</span><span>&#34;</span><span>table</span><span>&#34;</span><span>,</span> <span>file</span><span>)[</span><span>0</span><span>];</span>

<span>const</span> <span>[</span><span>header</span><span>,</span> <span>...</span><span>rows</span><span>]</span> <span>=</span> <span>table</span><span>.</span><span>children</span><span>.</span><span>map</span><span>((</span><span>row</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>return</span> <span>row</span><span>.</span><span>children</span><span>.</span><span>map</span><span>((</span><span>child</span><span>)</span> <span>=&gt;</span> <span>toString</span><span>(</span><span>child</span><span>));</span>
<span>});</span>

<span>const</span> <span>data</span> <span>=</span> <span>body</span><span>.</span><span>map</span><span>((</span><span>row</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>return</span> <span>autoType</span><span>(</span><span>Object</span><span>.</span><span>fromEntries</span><span>(</span><span>row</span><span>.</span><span>map</span><span>((</span><span>text</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>[</span><span>header</span><span>[</span><span>i</span><span>],</span> <span>text</span><span>])));</span>
<span>});</span>

<span>display</span><span>(</span><span>data</span><span>);</span>
</code></pre></div></div><p>I think this is pretty cool. The magic ingredients here are totally free access to NPM modules like <a href="https://remark.js.org">remark</a>, a Markdown parser, plus access to the Obsidian API via window.top.app, plus the ability to display any kind of data pretty easily using @observablehq/inspector.</p><p>The plugin is basically those things and not much more, but it adds up to a lot.</p><h2 id="annoyance-the-edit-cycle">Annoyance: the edit cycle</h2><p>The cycle of editing code and seeing the results is pretty rough: you need to stop editing and click outside of the fenced code block to see what will happen. Plus, Obsidian doesn’t highlight freeform code blocks as JavaScript. This seems like a common problem for plugins, given that Dataview, one of the most popular plugins in the entire ecosystem, doesn’t have code highlighting for its query blocks.</p><p>I wish that this plugin used a <a href="https://forum.obsidian.md/t/using-a-decoration-instead-of-a-markdown-code-block-postprocessor/79718">Decoration instead of a markdown code block processor</a>: that’d make the editing cycle a lot smoother. I think that, possibly, if I were to re-parse the document using remark like I do in the table example above, it’d be somewhat possible, but it’d be a lot more complicated, and there is the unknown of how <a href="https://help.obsidian.md/Editing+and+formatting/Obsidian+Flavored+Markdown">Obsidian flavored Markdown</a> will play with these parsers.</p><p>You can technically set variables in one block using <code>window.top.foo = 1</code> and get that variable in another block. After I announced the plugin, a few people requested some kind of shared variable namespace, like in Observable.</p><p>Honestly, this doesn’t seem like a great thing to invest time in; making blocks reactive would make the scope of this project much broader. It might require parsing code to find references (like Observable does) and running blocks in a more magical way. Plus, it’d open up the question of how cross-document block references would work. So also unlike Observable, there isn’t <a href="https://github.com/tmcw/obsidian-freeform/issues/8">an idea of response caching</a> at the moment: it’s just JavaScript, and without changing the language or implementing a heavyweight middle layer, it isn’t possible to do that.</p><p>I don’t use “small cells” in my own editing and am inclined to think that they just aren’t worth it - they make it harder to refactor, harder to repurpose code, and add a bunch of cognitive overhead for “where things are.”</p><p>But I’m open to ideas for how to implement something like reactive cells without blowing up the scope. It’d be neat to use <a href="https://github.com/tldraw/signia">a reactive signals module like signia</a> for them and put them in userspace.</p><h2 id="caveats-security">Caveats: Security</h2><p>As some of these examples demonstrate, you can reach up to <code>window.top</code> and access APIs from Obsidian. This is super powerful: it enables access to the Dataview API, lets you access Obsidian’s own APIs.</p><p>This does mean that if you import a module, you need to trust that they aren’t going to try to do something nefarious. And you shouldn’t blindly copy-and-paste huge amounts of code into a code block from someone you don’t trust. It’s your vault, you have the power, hence the responsibility.</p><p>I think that a separate-origin version of this plugin is possible in which <code>window.top</code> is inaccessible, which would give a different power / security tradeoff.</p><h2 id="caveats-just-javascript">Caveats: Just JavaScript</h2><p>There are more accessible ways to create charts in Obsidian, like the <a href="https://charts.phib.ro/Meta/Charts/Charts+Documentation">Charts plugin</a>. There is basically no abstraction in using Freeform, so it requires knowledge of JavaScript.</p><h2 id="how-does-this-compare-to-dataviewjs-blocks">How does this compare to DataviewJS blocks?</h2><p>I love the Dataview plugin, and it has a <a href="https://blacksmithgu.github.io/obsidian-dataview/api/intro/">codeblock way to run JavaScript code, including access to its API</a>. How is Freeform different?</p><ul><li>dataviewjs codeblocks run in the Obsidian top frame, so if you add weird CSS, it affects the whole application. You can get into more trouble doing things in the top frame. Freeform runs in an iframe, so by default, at most you’re mucking up the iframe.</li><li>dataviewjs runs via <code>eval</code>, whereas Freeform runs code via a dynamic <code>import()</code>, so you can use ES module <code>import</code> statements to pull in new modules in Freeform, whereas you can’t in dataviewjs</li></ul><p>Lest I be interpreted as throwing shade on Dataview: its tradeoffs make a lot of sense for what it’s targeted to do: create inline tables and listings based on Dataview information with clickable links. Dataview is amazing. To access the dataview API from Freeform, you need to write that tedious <code>window.top.app.plugins.plugins.dataview.api</code> variable reference and deal with the fact that <code>Date</code> objects have separate prototype identities when transferred between frame contexts.</p><p>Also, that being said: someone has probably already implemented something similar to this plugin, but I haven’t found it yet.</p><hr/><p>I don’t think I can link to a “install this” link in Obsidian, so just search for “Freeform” in the Obsidian Community Plugins list. And here’s <a href="https://github.com/tmcw/obsidian-freeform">a link to the GitHub repo for the plugin!</a></p></div></div>
  </body>
</html>
