<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://adguard.com/en/blog/adguard-mv3.html">Original</a>
    <h1>AdGuard publishes the first ad blocker built on Manifest V3</h1>
    
    <div id="readability-page-1" class="page"><article>
                
                <!--kg-card-begin: markdown--><p>Manifest V3, Chrome&#39;s new extension API, is no longer an illusory threat. It&#39;s now the new reality in which dozens of ad-blocking extensions, including the AdGuard Browser extension, will (<a href="https://www.zdnet.com/article/chrome-api-update-will-kill-a-bunch-of-other-extensions-not-just-ad-blockers/">or won&#39;t</a>) work.</p>
<p>The wave of Manifest V3 has been building gradually but inexorably. In 2018, when Google first released a <a href="https://docs.google.com/document/d/1nPu6Wy4LWR66EFLeYInl3NzzhHzc-qnk4w4PX-0XMw8/edit#">document describing the new API</a>, the developer community erupted in criticism. We didn&#39;t stand aside either and published several articles describing the <a href="https://adguard.com/en/blog/how-ad-blocking-is-done.html">possible negative consequences of Manifest V3 implementation</a> and even expressed hope that <a href="https://adguard.com/en/blog/our-comment-on-chrome-ad-blocking.html">&#34;things won&#39;t turn out so badly&#34;</a>.</p>
<p>Despite the public outcry, Manifest V3 became available in late 2020 along with Chrome 88 Beta. Since January 2022, it became impossible to add new extensions based on Manifest V2 to the Chrome Web Store. The last phase of the launch will come very soon: starting in January 2023, all extensions on Manifest V2 will stop working, even those that were added to Chrome Web Store earlier.</p>
<blockquote>
<p>If you&#39;re using AdGuard for <a href="https://adguard.com/adguard-windows/overview.html">Windows</a>, <a href="https://adguard.com/adguard-mac/overview.html">Mac</a> or <a href="https://adguard.com/adguard-android/overview.html">Android</a>, you should not worry about MV3 at all. These products are not limited by any browser.</p>
</blockquote>
<p>Fortunately, we&#39;re ready for it.</p>
<h2 id="experimentaladguardmv3browserextension">Experimental AdGuard MV3 Browser extension</h2>
<p><img src="https://cdn.adguard.com/content/blog/articles/extension_mv3/1.png" alt="Experimental AdGuard MV3 Browser extension"/></p>
<p>In mid-2021, we started working on the prototype of a new extension that would be able to block ads even within the strict limits of Manifest V3. The task was not an easy one: the new API was still raw, some aspects were being finalized and did not work as intended. But we coped with it, of course, and proved that ad blockers will survive even after the apocalypse that is Manifest V3.</p>
<p>While developing the prototype, we faced a lot of serious problems caused by the features of the new API: some of them we managed to overcome, and some we had to reconcile with. We will talk about each of them in detail.</p>
<p>Meanwhile, if you want to try it, you can <a href="https://agrd.io/adguard_mv3">install it from Chrome WebStore</a>.</p>
<iframe src="https://www.youtube-nocookie.com/embed/vC9kMLYTV2I" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<p><em>Here&#39;s a short video that shows how it works</em></p>
<h3 id="rulelimits">Rule limits</h3>
<blockquote>
<p>If you don&#39;t know what filtering rules are and how ad blocking works in general, or if you&#39;d like to refresh your knowledge, <a href="https://kb.adguard.com/en/general/how-ad-blocking-works">visit our Knowledge base</a> for a brief explanation.</p>
</blockquote>
<p>All the rules included in the extension filters were divided by Manifest V3 into static (built-in) and dynamic rules and their number was drastically limited.</p>
<p>For static rules, Chrome set a minimum guaranteed limit of 30,000 rules per extension and a total limit of 330,000 rules for all extensions installed by a single user (this also takes into account the limit of 1,000 regexp rules per extension). The trick is that one extension may get all of the allowed amount of rules, or there may be more than one, and then perhaps some of the extensions will fall short of the limit.</p>
<p><img src="https://cdn.adguard.com/content/blog/articles/extension_mv3/2.png" alt="Notification about changes in the list of active filters"/></p>
<p>If this occurs with our extension (and this can happen at any time, e.g. after an update, service worker restart, change of filter set in our or third-party blockers), it will show a message saying that the browser has modified the list of active filters and left only AdGuard basic ad filter enabled. In the worst case, even the basic filter might not be enabled, because it contains more than 30,000 rules. Then the user would be left without AdGuard protection.</p>
<p>All of these cases are envisaged by us and are displayed on a separate screen with a description of what the browser has disabled and what it has left enabled.</p>
<p><img src="https://cdn.adguard.com/content/blog/articles/extension_mv3/3.png" alt="The list of enabled and disabled filters"/></p>
<p>For dynamic rules, within which users can add their own rules or filters, there is a tiny limit of 5,000, including the limit of 1,000 regexp rules. If this limit is exceeded, AdGuard MV3 will only be able to apply the first 5,000 rules and the rest will remain inactive.</p>
<p>Notifications about exceeding the limit will look this way:</p>
<p><img src="https://cdn.adguard.com/content/blog/articles/extension_mv3/4.png?123" alt="Notification about reaching the limit"/></p>
<blockquote>
<p>Manifest V3&#39;s restrictions harm not only filtering quality and user experience, but also the filter development community. Previously, anyone could create a filter for themselves, and over time such a filter could become popular and get on the list of recommended blockers. Now it is much more difficult to accomplish this. After all, blockers must use pre-set filters (no more than 50), and we have to be very selective about which filters will be available to users. Of course, you can still set your own filter manually. But don&#39;t forget the 5000 rule limit <strong>on all</strong> custom filters and user rules.</p>
</blockquote>
<p>The further description of the problems includes a lot of details, mostly understandable to developers. If you&#39;re not a techie, you can <a href="#conclusion">feel free to skip this part</a>.</p>
<h3 id="declarativerules">Declarative rules</h3>
<p>Before Manifest V3 was introduced, the filtering engine was dynamically built from filters downloaded from the server by the extension. Further, the rules which made up the filters were applied at different stages of page loading.</p>
<p>For example, rules could have been triggered before the browser sends the request: within the <code>onBeforeRequest</code> event, the browser asked the extension what to do with a particular request, and the extension reacted dynamically by blocking or redirecting it. The cosmetic rules were applied a little later, when the page was already loaded and the <a href="https://en.wikipedia.org/wiki/Document_Object_Model">DOM</a> appeared.</p>
<p>Now that Manifest V3 has taken effect, the <code>onBeforeRequest</code> method can no longer be applied. Instead, Chrome suggests using the <code>declarativeNetRequest API</code>, with which the right to modify requests is given to the browser. The extension only announces a set of declarative rules according to which the browser will modify or block network requests.</p>
<h3 id="declarativerulessyntax">Declarative rules syntax</h3>
<p>The syntax for declarative rules is quite different from the syntax commonly used by modern ad blockers. Many members of the community will probably give up working within Manifest V3 to avoid taking the time to create Chrome-only rules.</p>
<p>Each rule should consist of fields:</p>
<ul>
<li><code>id</code> – the identifier of the rule. It can be used to associate a declarative rule with a text rule.</li>
<li><code>priority</code> – the priority of the rule. It determines how the rule will be applied to the query.</li>
<li><code>action</code> – the action of a rule.</li>
<li><code>condition</code> – condition under which the rule is applied</li>
</ul>
<p>Example rule:</p>
<pre><code>{
  &#34;id&#34;: 1,
  &#34;priority&#34;: 1,
  &#34;action&#34;: { &#34;type&#34; : &#34;block&#34; },
  &#34;condition&#34;: {
    &#34;urlFilter&#34;: &#34;abc&#34;,
    &#34;domains&#34;: [&#34;example.org&#34;],
    &#34;resourceTypes&#34;: [&#34;script&#34;]
  }
}
</code></pre>
<p><em>This rule will block all requests to scripts that have an <code>abc</code> substring in their address and originate from the site with the domain <code>example.org</code>.</em></p>
<p>The current situation causes an acute sense of deja vu: when developing the ad-blocking extension for Safari, we had to work out a way to convert our rules syntax to the syntax imposed by the browser&#39;s developers. This time we&#39;re using a similar solution to turn our syntax into declarative Chrome rules.</p>
<p>To convert static and dynamic rules we added a module to our <a href="https://www.npmjs.com/package/@adguard/tsurlfilter">@adguard/tsurlfilter</a> library. The library runs through the filter rules and converts them into declarative rules, then combines them into rulesets and stores them in <code>.json</code> files. The library builds a mapping table between text rules and JSON rules so that the connection between them is not lost.</p>
<p><strong>A couple of examples of how the converter works:</strong></p>
<p>The rule <code>||example.com^$script</code> is converted to</p>
<pre><code>{
    &#34;id&#34;: 1,
    &#34;action&#34;: {
        &#34;type&#34;: &#34;block&#34;
    },
    &#34;condition&#34;: {
        &#34;urlFilter&#34;: &#34;||example.com^&#34;,
        &#34;resourceTypes&#34;: [
            &#34;script&#34;
        ],
        &#34;isUrlFilterCaseSensitive&#34;: false
    }
}
</code></pre>
<p>The rule <code>@@||example.com^$script$domain=example.org</code> is converted to</p>
<pre><code>{
    &#34;priority&#34;: 1,
    &#34;id&#34;: 23,
    &#34;action&#34;: {
        &#34;type&#34;: &#34;allow&#34;
    },
    &#34;condition&#34;: {
        &#34;urlFilter&#34;: &#34;||example.com^$script&#34;,
        &#34;initiatorDomains&#34;: [
            &#34;example.org&#34;
        ],
        &#34;isUrlFilterCaseSensitive&#34;: false
    }
}
</code></pre>
<p>Most of the rules are converted correctly, but some functionality is lost because of various restrictions:</p>
<ul>
<li><code>$removeparam</code> does not support exclusions (~) and regular expressions (regexp)</li>
<li>For regular expressions, Chrome uses <a href="https://github.com/google/re2/wiki/Syntax">its own implementation of such expressions</a>, so part of the standard functionality is not supported. For example, these are regular expressions containing backreferences, negative lookaheads, and possessive quantifiers.</li>
<li><code>negative lookahead</code> is often used in filters. A quick search showed that there are currently 43 rules with this expression in AdGuard filters. At first glance, this is not many, but keep in mind that most of these rules are supposed to work on many different domains so I&#39;d say this limitation alone cripples ad blocking on 1000+ websites.</li>
<li>Regular expressions are additionally validated within Chrome for the amount of memory consumed. Since we&#39;re not quite sure what kind of implementation is used in this case, there may be some problems with some regular expressions.</li>
<li>Cookie rules are not supported.</li>
<li>There are many more issues that we have not mentioned here to not pollute the post.</li>
</ul>
<p>The problem with declarative rules is rather obvious: their syntax severely limits what our extension can do. And, frustratingly, there is nothing we can do about it, other than hope that the Chrome developers will improve it over time.</p>
<h3 id="rulesets">Rulesets</h3>
<p>According to the new API, declarative rules must be combined into rulesets.</p>
<p><strong>An example of integrating a ruleset in Manifest V3:</strong></p>
<pre><code>{
  &#34;name&#34;: &#34;AdGuard AdBlocker MV3&#34;,
  &#34;version&#34;: &#34;1&#34;,
  &#34;declarative_net_request&#34;: {
     &#34;rule_resources&#34;: [{
       &#34;id&#34;: &#34;ruleset_1&#34;,
       &#34;enabled&#34;: true,
       &#34;path&#34;: &#34;rules.json&#34;
     }]
   },
   …
}
</code></pre>
<p>Rulesets are specified in the <code>manifest.json</code> file and are loaded only when the extension is installed or updated. And this is also a huge problem. Sometimes a filtering rule breaks the layout or performance of one or several websites. With such an incredibly high amount of rules, it is almost impossible statistically to completely avoid such incidents. To add to that, websites are constantly changing, and rules that used to be fine earlier might cause issues now. But that&#39;s fine: we had a simple solution for this problem.</p>
<p>Imagine that such a rule is in the filter and you need to disable it quickly. In Manifest V2 extension, modifier <code>$badfilter</code> was used for this purpose. Filter developers would add a rule with the specified modifier, the extension would get updated dynamically, the new rule would disable the referred rule, and things would get better. As you understand, this &#34;trick&#34; won&#39;t work with Manifest V3.</p>
<p>Now you can expect filters not to be updated for several days on end: after adding the new version to the Chrome Store, you need to wait for the review to be passed. Sadly, there is no other way to provide users with updated filters. <a href="https://github.com/w3c/webextensions/issues/162">The discussion about the ability to enable and disable individual rules</a> gives some hope. There is a small chance that extensions will be given the functionality to update filters quickly after all.</p>
<h3 id="statsandfilteringlog">Stats and filtering log</h3>
<p>AdGuard Browser extension, based on Manifest V2, has a filtering log that shows all the requests sent by your browser and detailed information about them. In particular, you can see which filtering rule was used to block this or that rule.</p>
<p>Due to the fact that Chrome itself now blocks requests and shares statistics only with extensions unzipped and installed in Developer Mode, we can&#39;t implement the filtering log as we used to. But we can come up with a peculiar alternative, which we plan to do in the final version of the extension.</p>
<p>So, when you open the filtering log, an engine that works by the rules of Manifest V2 will be launched. It won&#39;t do anything with the requests, only show which rules may have been applied. By comparing the Chrome statistics with the results of the old engine, we will get a rough picture of how requests are processed.</p>
<p>The current version of the prototype does not implement a filtering log. Instead, filter developers will have to use the mechanism recommended by Chrome developers. The point is that you can still get information about which rule triggered. But there is a caveat: you need to install the extension in an &#34;unpacked&#34; form. That is, you will need to clone <a href="https://github.com/AdguardTeam/AdGuardMV3">our repository</a>, &#34;build&#34; the extension, switch the browser to Developer Mode, and only in this case you will be able to use the tools for debugging filters.</p>
<p><img src="https://cdn.adguard.com/content/blog/articles/extension_mv3/5.png" alt="Filtering log"/></p>
<h3 id="serviceworker">Service worker</h3>
<p>With Manifest V3, the background page is gone. The background page is a separate background process where extensions could maintain their state and work with the browser APIs (like beforementioned <code>onBeforeRequest</code>). In Manifest V3, this page is replaced by a service worker, which is often interrupted by the browser.</p>
<p>When the browser stops the service worker, the extension goes into a kind of sleep mode: the declarative rules work, but the cosmetic rules that are loaded dynamically do not. For the extension to be functional, something must wake up the service worker: it can be loading a page or a message that has been sent to the service worker.</p>
<p>When the service worker is waking up, the extension starts to read filtering rules from the repository and process them so that it can then find them quickly. During this time, for 1.5-2 seconds, the extension does not apply cosmetic filtering, but ad requests are blocked by the browser itself. Then the engine launches and the ads disappear. We plan to reduce the wake-up time of the service worker and strive to move most of the cosmetic rules to the content script (which works in the context of the web page and is not getting killed every minute), but for some cases we will still need the service worker.</p>

<h2 id="conclusion">Conclusion</h2>
<p>Despite the limitations of Manifest V3, AdGuard MV3 still protects against ads and tracking quite well:</p>
<ul>
<li>Blocks requests to trackers proactively</li>
<li>Hides banners, social widgets and other annoying elements</li>
<li>Blocks adverts on video sharing platforms, including YouTube</li>
</ul>
<p>Although the experimental extension is not as effective as its predecessor, most users won&#39;t feel the difference. The only thing you might notice is ad flickering due to the lag in the application of cosmetic rules.</p>
<p>Our goal with this prototype is to test the new approach and get your feedback. So please, <a href="https://agrd.io/adguard_mv3">try it out</a> and let us know what can be improved. As usual, this prototype is <a href="https://github.com/AdguardTeam/AdGuardMV3">open source and published on Github</a>. If you have any issue with it or have any suggestion, please post it to Github and we will listen.</p>
<p>By releasing an extension built with Manifest V3 today — first among developers of ad blockers – we can say that we&#39;ve met the challenge that Google posed to us. There is still a lot of work to be done, but we can already claim that even after the discontinuation of Manifest V2, Google Chrome users will be able to protect themselves from ads and trackers with the AdGuard Browser Extension.</p>
<!--kg-card-end: markdown-->
            </article></div>
  </body>
</html>
