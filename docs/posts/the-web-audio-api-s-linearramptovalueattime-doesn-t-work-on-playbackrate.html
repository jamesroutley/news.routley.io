<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://jimkang.com/weblog/articles/no-ramps-for-playback-rate/">Original</a>
    <h1>The Web Audio API&#39;s linearRampToValueAtTime doesn&#39;t work on playbackRate</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
      <div>
        <article>
          <section><p>As a public service, I’m explicitly stating that <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/linearRampToValueAtTime">linearRampToValueAtTime</a> does not work on an AudioBufferSourceNode’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/playbackRate">playbackRate</a>, as of February 24, 2023, on Firefox. It does work on Chrome. I’ve included a simple demo here.
<span></span></p>


<hr/>
<span id="message-field">Loading sample…</span>

<hr/>




<p>If you click “Play sample with linearRampToValueAtTime”, the browser will play a flute sample and run code that attempts to change the <code>playbackRate</code> of the <code>AudioBufferSourceNode</code> from 1.0 to 2.0 over the course of four seconds. It should sound something like a slide whistle, but on Firefox, it just plays at a normal rate and pitch for four seconds, then jumps up to the target playbackRate, an octave up. Here’s what that code looks like:</p>
<pre><code>  samplerNode.playbackRate.linearRampToValueAtTime(
    2.0,
    ctx.currentTime + 4
  );
</code></pre><p>However, if you click “Play sample with homemade ramp”, which doesn’t use <code>linearRampToValueAtTime</code> and instead sets <code>playbackRate.value</code> during a series of callbacks from <code>requestAnimationFrame</code>, then it slides up as expected in both Firefox and Chrome. Here’s what that code looks like, which you can use as a polyfill:</p>
<pre><code>// Warning: cancelScheduledValues doesn&#39;t cancel this.
function homemadeLinearRamp({ param, targetVal, ctx, durationSeconds }) {
  const startTime = ctx.currentTime;
  const startVal = param.value;
  const valDelta = targetVal - startVal;
  window.requestAnimationFrame(updateParam);

  function updateParam() {
    const elapsed = ctx.currentTime - startTime;
    const progress = elapsed / durationSeconds;
    param.value = startVal + progress * valDelta;
    if (progress &lt; 1) {
      window.requestAnimationFrame(updateParam);
    }
  }
}
</code></pre><p>(Here, <code>param</code> should be the <code>playbackRate</code> instance from your <code>AudioBufferSourceNode</code>. <code>ctx</code> should be your <code>AudioContext</code>.)</p>
<p>You can use View Source to see the code in context.</p>
<p><strong>Update, 2023-02-27:</strong> Same situation in Firefox with <a href="https://developer.mozilla.org/en-US/docs/Web/API/StereoPannerNode">StereoPannerNode</a>s and the <code>pan</code> property.</p>
<h2 id="not-mad">Not mad</h2>
<p>I’m not writing to complain about Firefox’s implementation! I know that team has <a href="https://arstechnica.com/information-technology/2020/08/firefox-maker-mozilla-lays-off-250-workers-says-covid-19-lowered-revenue/">dev resource issues</a>.</p>
<p>I wrote this because I was in this situation in which I was working on a generative music piece which has gotten complex, and I was trying unsuccessfully to use this <span>API</span> method. I was hoping the internet would tell me definitively whether I was using it wrong or if it just didn’t work.</p>
<p>It did not tell me anything conclusive.</p>
<p>Searching the web just seems bad lately, both on Duck Duck Go and Google, and the closest I could get is a <a href="https://stackoverflow.com/questions/37027694/audio-api-setvaluecurveattime-firefox">Stack Overflow post from six years ago</a> about <code>setValueCurveAtTime</code> not working on <code>playbackRate</code> on Firefox.</p>
<p>So, I had to take the time to test it for myself, which I loathed having to do because I have a lot to do. But now, you don’t have to! I hope this helps, Internet Searcher of the future!</p>
</section>
        </article>
      </div>
    </div></div>
  </body>
</html>
