<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://taras.glek.net/post/optimized-zip-format/">Original</a>
    <h1>Firefox&#39;s Optimized Zip Format: Reading Zip Files Quickly</h1>
    
    <div id="readability-page-1" class="page"><div role="main">
  <div>
    <div>
      <article role="main">
        <p>This post is about minimizing amount of disk IO and CPU overhead when reading Zip files.</p>
<p>I recently saw an article about a <a href="https://news.ycombinator.com/item?id=29178710">new format</a> that was faster than zip.</p>
<p>This is quite surprising as to my mind, zip is one of the most flexible and low-overhead formats I’ve encountered.</p>
<p>Some googling showed me that over past 11 years people have <a href="https://www.raymond.cc/blog/edit-files-inside-firefox-4-omni-jar-to-auto-save-password/">noticed</a> that Firefox uses <em>optimized</em> zip files. This inspired me to document thinking behind the optimized zip format I implemented in Firefox in the pre-pandemic 2010. I had a lot of fun writing this code, was surprised that I failed to blog about it.</p>
<h3 id="zip-format">Zip format</h3>
<p>The following diagram is borrowed from <a href="https://www.codeproject.com/Articles/8688/Extracting-files-from-a-remote-ZIP-archive">codeproject article</a>. <a href="https://en.wikipedia.org/wiki/ZIP_(file_format)">Wikipedia</a> and <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">ZIP specification</a> are also helpful.</p>
<p><img src="https://www.codeproject.com/KB/cs/remotezip/diagram1.png" alt="zip structure" title="hello"/></p>
<p>Zip files seem to be designed for cheap appends. For every file inside a zip, there is a <code>Local Header</code> + optionally compressed <code>file #</code> contents.</p>
<p>This is followed by a <code>Central Directory</code> which acts as an index for zip contents.</p>
<p>To extract a file from zip file one must:</p>
<ol>
<li>Scan backwards through zip file for <code>End of Central Directory</code> marker.</li>
<li>Read offset to begining of <code>Central Directory</code></li>
<li>Find relevant <code>Local Header</code> offset in <code>Central Directory</code> index</li>
<li>Read + optionally decompress stored file.</li>
</ol>
<h3 id="writing-optimized-zip-files">Writing Optimized Zip Files</h3>
<p>In order to optimize file IO on Firefox startup I wanted to make use of OS readahead<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>.</p>
<p>Unfortunately reading files started from ending precludes readahead. It is also suboptimal to read files from zip in random order.</p>
<p>The following creative interpretation of Zip spec results in optimized zip files:</p>
<ol>
<li>
<p>Since we already do PGO<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> for Firefox builds, I added a <a href="https://searchfox.org/mozilla-central/source/modules/libjar/nsZipArchive.cpp#79"><code>ZipArchiveLogger</code></a> for logging zip-entries being accessed to the Firefox profiling stage.</p>
</li>
<li>
<p>Then during the build phase, I added <a href="https://github.com/humphd/mozilla-central-old/blob/9d4d9f265e24e6358c067ae1e300c1ce3227a91d/config/optimizejars.py"><code>optimizejars.py</code></a><sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>
to move the <code>Central Directory</code></p>
</li>
<li>
<p>Additionally <code>optimizejars.py</code> would lay out zip entries in order specified by <code>ZipArchiveLogger</code> log.</p>
</li>
<li>
<p>Wrote down length of <code>Central Directory</code> + entries in step 3.</p>
</li>
</ol>
<p>Zip file now looks like: | 4 bytes | <code>Central Directory</code> | <em>Hot</em> Files | <em>Cold</em> Files | <code>End Of Central Directory Marker</code> |.</p>
<p>Thus we have a sequentual-read-friendly zip file that can still be ready by zip tools that follow the spec.</p>
<h3 id="reading-optimized-zip-files">Reading Optimized Zip Files</h3>
<ol>
<li>Speculatively check if we can find the <code>Central Directory</code> signature 4 bytes in.</li>
<li>If step 1 succeeded, assume first 4 bytes are our read-ahead length. Issue a platform-specific read-ahead call.</li>
</ol>
<p>So for all cases where zip file access pattern matches one recorded during profiling phase Firefox can read the relevant resources in a single IO!</p>
<h3 id="further-zip-trivia">Further Zip Trivia</h3>
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=701875">https://bugzilla.mozilla.org/show_bug.cgi?id=701875</a> renamed .jar files .ja so Microsoft System restore wouldn’t corrupt Firefox.</li>
<li>At the time optimized jar change broke antivirus scanners, which further sped up Firefox startup :)</li>
<li>Zip reader in Firefox uses mmap thus zip files can be nested with 0 overhead (without compression). This also broke OS/2 support as OS/2 did not have a concept of memory mapping.</li>
<li>This work would not have worked-out without massive amounts of help and follow-on work from Mike Hommey, Michael Wu and Robert Kaiser.</li>
</ul>
<hr/>
<p><a href="https://twitter.com/tarasglek/status/1462821094881206279">Comment on Twitter</a></p>
<hr/>



        

        

        
      </article>

      
        
      


      

    </div>
  </div>
</div></div>
  </body>
</html>
