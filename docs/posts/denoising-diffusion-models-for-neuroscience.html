<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/">Original</a>
    <h1>Denoising diffusion models for neuroscience</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>2022 was the year of generative AI models: DALL-E 2, MidJourney, Stable Diffusion, and Imagen all showed that it’s possible to generate grounded, photorealistic images. These generative AIs are instances of conditional <a href="https://arxiv.org/abs/2006.11239">denoising diffusion probabilistic models</a>, or DDPMs. Despite these flashy applications, DDPMs have thus far had little impact on neuroscience.</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png"><img decoding="async" loading="lazy" width="1024" height="1024" data-attachment-id="8137" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/dalle_2023-01-30_12-04-10_-_a_cute_oil_painting_of_a_sloth_birthday_party/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png" data-orig-size="1024,1024" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png 1024w, https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/dalle_2023-01-30_12.04.10_-_a_cute_oil_painting_of_a_sloth_birthday_party.png?w=768 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>An oil painting of a cute sloth birthday party. Generated by Dall-E 2, a conditional DDPM.</figcaption></figure>



<p>I want to change that! I think DDPMs are very cool models. Not only can they be used to generate oil paintings of cute sloth birthday parties, but they’re also useful, general-purpose generative models: tractable, and easy to train. Perhaps surprisingly, they’re also related to a lot of common models in neuroscience, like hierarchical Bayesian predictive coding models and Hopfield networks. They contain a lot of interesting ideas about how the brain might implement complex generative models, and I think they would benefit from being studied from a neuroscience perspective.</p>



<p>I wrote this article both for neuroscientists who want to keep up with the latest in ML, and for ML practitioners who are curious about neuroscience. First, I give a high-level overview of diffusion models, how to train them and how they compare and contrast to other generative models. I won’t get into the math but I’ll give references to tutorial introductions if you’re interested in that. I’ll discuss current applications in neuroscience, and speculate about some potential future applications. Finally, I’ll relate the structure of DDPMs to some common neuroscience models like Hopfield networks and Bayesian predictive coding. Let’s get started!</p>



<h2>How DDPMs work</h2>



<p>DD<strong>PM</strong>s are generative <strong>P</strong>robability <strong>M</strong>odels: they learn a complex probability distribution p(<strong>x<sub>0</sub></strong>) from empirical data. Here <strong>x</strong> is a D-dimensional vector representing an image, sounds, time series, graphs, etc. To generate a new sample from a learned <strong>D</strong>DPM, you repeatedly apply a <strong>D</strong>enoiser – a deep neural network like a U-Net or a transformer – to noise vectors. Think of these noise vectors as the latent variables of the model. At the end of the process, a sample is generated. It’s a little bit like <a href="https://en.wikipedia.org/wiki/Pareidolia">pareidolia</a> (seeing faces in clouds): if I present a bunch of noise stimuli (e.g. clouds) to a human, and ask them what they see, they’ll generate a probability distribution over familiar things (e.g. faces). This process thus maps noise to a learned probability distribution.</p>



<h3>Training a DDPM</h3>



<p><em>This section follows the exposition from Kevin Murphy’s second book, Probabilistic Machine Learning: Advanced Topics. <a rel="noreferrer noopener" href="https://probml.github.io/pml-book/book2.html" target="_blank">A free draft of the book is here</a>. Another great resource is <a rel="noreferrer noopener" href="https://calvinyluo.com/2022/08/26/diffusion-tutorial.html" target="_blank">Calvin Luo’s blog post</a>.</em></p>



<p>But how do you learn a DDPM? Rather than repeat all the math from other excellent tutorials, I will to give you a flavour of why DDPMs are built the way they are, how they’re trained, and give you a bit of wayfinding so you can learn independently.</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled.png"><img decoding="async" loading="lazy" width="2018" height="500" data-attachment-id="8143" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-10/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled.png" data-orig-size="2018,500" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled.png?w=768 768w, https://xcorr.files.wordpress.com/2023/02/untitled.png 2018w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption><span>A DDPM in action. Data is on the left, noise on the right. We learn a denoising DNN <strong>μ</strong>(x<sub>t</sub>, t). From Kevin Murphy’s book.</span></figcaption></figure>



<p>Training D<strong>D</strong>PMs involves two <strong>d</strong>iffusion processes. First, a word of warning: the diagram that you will see in every DDPM paper to illustrate these processes, by convention, has samples on the left (<strong>x</strong><sub>0</sub>), and noise on the right (<strong>x</strong><sub>T</sub>). I think that’s very confusing, because usually we’re going from noise to sample (right to left), and the diagram breaks expectations about how you should read it, so watch out for that.</p>



<p>Let’s talk about the <strong>forward</strong> process first (left to right): Take any probability distribution and add a little bit of normal noise to it, while also rescaling it; if you repeat this process enough times, you will obtain a normal distribution. This is a consequence of the central limit theorem. This process is Markovian (q(x<sub>T</sub>) = <strong>Π</strong> q(x<sub>t</sub>|x<sub>t-1</sub>) q(x<sub>0</sub>)). Each of the probability distributions in this expression has a simple Gaussian functional form, save for q(x<sub>0</sub>).</p>



<p>Our goal is to learn the <strong>reverse</strong> process: going from noise to samples, right to left. We write another Markov chain, p(x<sub>0</sub>) = <strong>Π</strong> p(x<sub>t-1</sub>|x<sub>t</sub>) p(x<sub>T</sub>). If we want p(x<sub>0</sub>) to approximate q(x<sub>0</sub>), the diffusion kernel p(x<sub>t-1</sub>|x<sub>t</sub>) has to be different for different x<sub>t</sub>: it has to be a biased diffusion process, otherwise we’d just turn noise into noise. We keep the same functional form for the diffusion kernel – a normal distribution – but we make its mean depend on x<sub>t</sub> via a deep neural network <span><strong>μ</strong></span>(x<sub>t</sub>, t).</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-1.png"><img decoding="async" loading="lazy" width="5542" height="2176" data-attachment-id="8144" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-1-6/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-1.png" data-orig-size="5542,2176" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-1" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=2048 2048w, https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-1.png?w=768 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>The denoising objective comes from approximating getting the forward densities q to match the backward densities p. The pink and green arrows must match. From Calvin Luo’s blog post.</figcaption></figure>



<p>It doesn’t seem like we’ve accomplished much thus far, but here comes the magic: you can write down an expression for the likelihood of different samples (q(x<sub>0</sub>)) in terms of ratios of p’s and q’s. You can lower-bound these expressions using Jensen’s inequality – the ELBO, or evidence lower bound, the same trick used in VAEs – and now you’ve got an expression involving the KL divergences of different Gaussian distributions. All of these KL divergences can be calculated symbolically, a bunch of stuff cancels out, you’re left with a really simple expression for the ELBO. It turns out you can then optimize using this straightforward algorithm:</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-2.png"><img decoding="async" loading="lazy" width="1574" height="454" data-attachment-id="8145" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-2-4/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-2.png" data-orig-size="1574,454" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-2" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-2.png?w=768 768w, https://xcorr.files.wordpress.com/2023/02/untitled-2.png 1574w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></figure>



<p>Here, ϵ(x) is a deep neural network (a U-Net or transformer) that takes a sample and predicts the noise that was added into it: the denoiser. The DDPM learning algorithm holds in five lines of pseudo-code. It’s quite accessible for us mere mortals: you can code and train a DDPM in an afternoon. Yet, the structure of a DDPM is quite rich, and it is very flexible. That’s a big reason why I find DDPMs so interesting.</p>



<h3>Sampling</h3>



<p>Sampling is done by running the learned denoising process many times, starting from noise samples p(x<sub>T</sub>). You denoise, add a little bit of noise, denoise, add a little bit of noise, etc. until you have a sample. That can be pretty slow, but there are strategies to accelerate. The most common is probably DDIM (the I is for implicit), which removes the continuous addition of noise with a modified sampling chain. With DDIM, you only take one noise sample p(x<sub>T</sub>), and the rest of the chain is deterministic. It’s possible to take DDIM samples from a vanilla-trained DDPM; you can reduce the number of sampling steps from, say, 1024, down to a more manageable 16 or so without much loss in sample quality. Because DDIM sampling is deterministic after the initial noise injection, it preserves the latent structure of the model, so you can use it for things like latent space interpolation.</p>



<figure><figcaption>Walking through the latent space of a diffusion transformer (DiT). From <a href="https://www.wpeebles.com/DiT">Peebles and Xie (2022)</a>.</figcaption></figure>



<p>So far I’ve focused on unconditional DDPMs, but it’s just as easy to build a conditional DDPM. The most common way to condition during training and generation is to take the conditioning information, pass it through an MLP, and let it bias the denoiser every denoising iteration. The timestep <em>t</em> is also embedded in this way. Biasing can be done by changing the mean and scale of different feature maps of the U-Net, or by biasing attentional blocks. This mechanism is very flexible; to take a specific example, <a href="https://github.com/CompVis/latent-diffusion">latent diffusion</a>, which drives Stable Diffusion, can condition on:</p>



<ul>
<li>text via a dense CLIP-based embedding</li>



<li>one-hot encoded image categories</li>



<li>segmentation masks</li>



<li>other images (e.g. for image-to-image translation or upsampling)</li>
</ul>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-3.png"><img decoding="async" loading="lazy" width="2104" height="1056" data-attachment-id="8147" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-3-2/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-3.png" data-orig-size="2104,1056" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-3" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=2048 2048w, https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-3.png?w=768 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Latent diffusion can accommodate multiple types of conditioning information (right). From <a href="https://github.com/CompVis/latent-diffusion">Rombach et al. (2022)</a>.</figcaption></figure>



<p>There’s an additional way of conditioning DDPMs only at generation time. This late-binding is a bit of a mindfuck so bear with me or skip to the next section. The DDPM likelihood (reverse chain) can be multiplied with other distributions (e.g. priors) easily. Because each diffusion step moves the distribution only a little, it turns out that multiplying by a prior ends up only changing the mean of each diffusion step (see Appendix Table 1 in Sohl-Dickstein 2015). That means you can add a late-bound generation “penalty” (the log of the prior) to bias the generation. This trick is used in both <a href="https://github.com/openai/guided-diffusion">classifier-guided diffusion</a> and <a href="https://arxiv.org/abs/2207.12598">classifier-free guided diffusion</a> to improve visual quality of generation. Basically, they bias the generation process away from low-quality, easily confusable images towards canonical, visually striking poses.</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-4.png"><img decoding="async" loading="lazy" width="2150" height="1082" data-attachment-id="8149" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-4-2/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-4.png" data-orig-size="2150,1082" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-4" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=2048 2048w, https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-4.png?w=768 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Left: DDPM samples with no guidance, right: DDPM samples with classifier-free guidance. Class is malamute in both cases. From <a href="https://arxiv.org/abs/2207.12598">Ho and Salimans (2022)</a>.</figcaption></figure>



<p>This late binding opens up many possibilities: sometimes you need to generate images which are just slightly off of the image manifold. Here I show a toy example of using a late-bound critic to make a batch of samples more easily discriminable from each other. I trained a vanilla DDPM on Google Fonts to generate lowercase letters. Next, I used the intermediate layer of an AlexNet to generate a confusion matrix to determine how likely AlexNet is to confuse these letters (see <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1010522">Janini et al. 2022</a> for background information). Then I nudged the generation so that letters are less confusable according to this critic, creating a modified font with improved readability in peripheral vision. This kind of late binding is very hard to do with other types of deep generative models.</p>



<figure><p><img decoding="async" loading="lazy" id="8150" src="https://xcorr.files.wordpress.com/2023/02/ddim.png" alt="" width="994" height="502"/><img decoding="async" loading="lazy" id="8151" src="https://xcorr.files.wordpress.com/2023/02/ddim_nudged.png" alt="" width="994" height="502"/></p><figcaption><em>Left</em>: a sample from a DDIM trained on sans-serif Google fonts. Right: a sample from the same model, nudged so the letters are more distinct according to a critic. The critic is aligned to the brain.</figcaption></figure>



<h2>How DDPMs compare and contrast to other generative models</h2>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-5.png"><img decoding="async" loading="lazy" width="1420" height="1164" data-attachment-id="8154" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-5-2/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-5.png" data-orig-size="1420,1164" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-5" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-5.png?w=768 768w, https://xcorr.files.wordpress.com/2023/02/untitled-5.png 1420w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Common generative architectures, from Kevin Murphy’s book (2023).</figcaption></figure>



<p>It can be hard to keep track of all the deep generative architectures and all their plusses and minuses: when should you use one versus another? DDPMs are frequently used in lieu of a GAN or a VAE. Compared with GANs:</p>



<ul>
<li>DDPM samples, like those from GANs, can be of very high visual (or auditory…) quality</li>



<li>DDPMs can sample from the actual distribution of the data; GANs can suffer from mode collapse</li>



<li>It’s really easy to train a DDPM, unlike a GAN which can suffer from instability</li>



<li>You can calculate a likelihood lower bound for a given sample in a DDPM, unlike a GAN</li>



<li>However, DDPMs are slower to sample (though tricks like DDIM help)</li>
</ul>



<p>DDPMs are quite similar under the hood to hierarchical VAEs. Compared with vanilla VAEs however, DDPM samples are sharper.</p>



<p>Another thing that differentiates DDPMs is that they have some unusual capabilities out of the box. That means that, for instance, they can denoise images out of the box. Upsampling, inpainting and outpainting are also straightforward.</p>



<p>They do have one big drawback compared to GANs and VAEs: the latent space of a vanilla DDPM has the same dimensionality as the data (e.g. the number of pixels). This is different than GANs or VAEs which typically have compressed latents. For some applications, compression is the whole point: <a href="https://xcorr.net/2021/07/26/dimensionality-reduction-in-neural-data-analysis/">see my previous post on dimensionality reduction in neuroscience</a>. A notable exception to this rule is <a href="https://github.com/CompVis/latent-diffusion">latent diffusion</a>, which uses a complex pipeline involving a VQ-GAN in addition to diffusion in the compressed space; but technically, it’s not the diffusion model that learns the compressed latent, it’s the GAN. That being said, as discussed above, while DDPMs don’t have compressed latents, they do have high-dimensional latents which can be manipulated and interpolated.</p>



<p><strong>TL;DR:</strong> DDPMs are easy to train, they generate high-quality samples, and they have some unusual properties which allow them to be used in interesting scenarios. However, they don’t have compressed latents, so we can’t use them for dimensionality reduction. That’s unfortunate for us neuroscientists because we love dimensionality reduction. So what can we use them for?</p>



<h2>What are they good for (in neuroscience)?</h2>



<h3>Generating brain-data-conditioned samples</h3>



<p>There are neuroscience applications which require generating high-quality samples. Brain decoding is a good example: you attempt to back out what a person saw (or imagined, or even dreamt) from the pattern of their brain activity. Ideally, you’d like to generate natural-looking samples. Two recent papers (<a href="https://arxiv.org/abs/2211.06956">Chen et al. 2022</a>, <a href="https://www.biorxiv.org/content/10.1101/2022.11.18.517004v2.abstract">Takagi &amp; Nishimoto 2022</a>), which <a href="https://xcorr.net/2023/01/01/2022-in-review-neuroai-comes-of-age/">I reported on in the last post</a>, demonstrate these ideas. They mapped fMRI data to the latents of a latent diffusion model to decode images from the brain. You could imagine doing this with single neuron data as well (e.g <a href="https://www.science.org/doi/abs/10.1126/science.aav9436">Bashivan et al. 2019</a>, <a href="https://www.sciencedirect.com/science/article/pii/S0092867419303915">Ponce et al. 2019</a>).</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-6.png"><img decoding="async" loading="lazy" width="1936" height="904" data-attachment-id="8155" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-6-2/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-6.png" data-orig-size="1936,904" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-6" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-6.png?w=768 768w, https://xcorr.files.wordpress.com/2023/02/untitled-6.png 1936w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Brain decoding with DDPMs, from Chen et al. (2022).</figcaption></figure>



<p>This Brain DALL-E idea is very cool, but you might think it’s a curiosity rather than a practical idea. However, there’s a domain where generating good, brain-conditioned samples is essential. Patients with ALS or brainstem strokes can end up in a locked-in state, where they’re unable to communicate despite remaining fully conscious. This was eloquently documented in the book <a href="https://en.wikipedia.org/wiki/The_Diving_Bell_and_the_Butterfly">The Diving Bell And The Butterfly</a>, which was dictated, letter by letter, through a series of eyeblinks by the author Jean-Dominique Bauby. It’s been recently demonstrated that we can an invasive brain-computer interface can directly read attempted speech from a patient’s brain. <a href="https://www.nejm.org/doi/full/10.1056/nejmoa2027540">Moses et al. (2021)</a> demonstrated decoding brain activity in speech-motor cortex in a locked-in patient, classifying attempted spoken words and displaying them on a screen, thus allowing the patient to communicate.</p>



<p>You could imagine pushing this idea forward by making a custom voice box for the locked-in patient. First, capture a patient’s voice and intonation in a generative model, similar to the recent <a href="https://valle-demo.github.io/">VALL-E</a> (VALL-E is a VQ-VAE, but you could also do this with a DDPM). In the case of a neurodegenerative disease, it should be possible to record a patient’s voice after the diagnosis but before being locked-in. Then one could create a voice-box BCI that sounds like the patient’s own voice, which can be deployed once the patient is unable to communicate. It sounds like science-fiction, but I don’t think this is far off.</p>



<h3>MRI, medical images and data augmentation</h3>



<p>We’ve seen a number of papers applying DDPMs to medical imaging and MRI data. This is less neuroscience-proper and more neurology, but you can see how these ideas could be adapted and used as neuroscience tooling. Consider a compressed sensing scenario, where one wants to infer images from sparse measurements, for example to accelerate an MRI or PET scan. <a href="https://arxiv.org/abs/2203.03623">It’s easy to rig up a conditional diffusion model that takes, for example, an undersampled k-space representation of an MRI and spits out a plausible corresponding brain image</a>. Not only are these images visually plausible, they come with their own error bars! It’s indeed possible to run the diffusion process several times to get multiple samples from the posterior and figure out where the model is certain of its reconstruction and where the model is just spitballing. A related application is in denoising images, whether these images are MRIs, PET scans or microscopy images (including 2p-imaging).</p>



<p>Because we can evaluate the likelihood of an image through a diffusion model, we can do <a href="https://ieeexplore.ieee.org/document/9857019/">anomaly detection</a>, for instance to determine whether there’s a tumour in an MRI. Another application area is label-efficient segmentation. The image-space diffusion process means that the network must learn foreground/background relationships or object boundaries implicitly (this is a bit of foreshadowing for our section on how DDPMs are brain-like). <a href="https://openreview.net/forum?id=SlxSY2UZQT">Baranchuk et al. (2022)</a> show how you can use this to do label-efficient segmentation, which could be expanded to medical images or MRIs, which are normally extremely expensive to annotate.</p>



<p>Indeed, data augmentation is something that DDPMs excel at. Learn an unconditional generative model for segmentation masks, learn a conditional generative model for an MRI, and you’ve got yourself a sequence of models that can generate fake (segmentation, MRI) pairs, which you can then use for downstream classification, defining biomarkers, etc.</p>



<h2>Why DDPMs might be a little brain-like</h2>



<p>We’ve covered sober applications of DDPMs for neuroscience. If DDPMs become just another tool in the toolbox of neuroscience, that’s a win for neuroscience. However, I’d like to go further and claim that DDPMs might be a little brain-like. This is still highly speculative (read: half-baked), but I think there’s a real opportunity to use DDPMs as a wedge to build new neuroAI models of the brain. I’m putting this out there not as a fully worked-out proposal but to make the community aware of the opportunity and find potential collaborators.</p>



<h3>Hierarchical Bayesian predictive coding</h3>



<p>Let’s consider the current state of visual neuroAI. Convolutional neural networks trained for image classification on ImageNet have been the de facto default models of the ventral stream of the visual cortex – V1, V2, V4 and IT – over the last decade. Self-supervised models have recently been shown to be just as good as supervised CNNs at explaining the ventral stream, and are more biologically plausible (<a href="https://xcorr.net/2021/12/31/2021-in-review-unsupervised-brain-models/">see previous post on this subject</a>). However, we know many ways in which the ventral stream is different than feedforward neural nets trained with supervised or self-supervised learning. Here are 4 facts we need to reconcile with the ventral stream:</p>



<ol>
<li>The ventral stream has feedforward, recurrent and feedback connections, while CNNs only have feedforward connections</li>



<li>The ventral stream (and all of the brain) is noisy, CNNs are deterministic</li>



<li>The ventral stream is involved in visual imagery during waking, and <a href="https://www.science.org/doi/10.1126/science.1234330">in dreams</a>; I have no idea how to get a CNN to dream</li>



<li>The ventral stream and humans as a whole <a href="http://www.cns.nyu.edu/malab/bayesianbook.html">seem to act <em>as though</em> vision is Bayesian</a>; it’s not clear to me that CNNs do the same kind of Bayesian inference</li>
</ol>



<p>We can add more features to a basic CNN to better match the ventral stream. For instance, recurrent connections allow computations to unfold in time. While there’s nothing wrong with empirically motivated additions to CNNs, it’d be nice for additions to be more theoretically grounded.</p>



<p>Prior to CNNs taking over the study of the ventral stream, a dominant view of the visual cortex was as a hierarchical Bayesian inference machine. A prototypical example is the proposal of <a href="https://pubmed.ncbi.nlm.nih.gov/12868647/">Mumford and Lee</a> (2003):</p>



<blockquote>
<p>In this framework, the recurrent feedforward/feedback loops in the cortex serve to integrate top-down contextual priors and bottom-up observations so as to implement concurrent probabilistic inference along the visual hierarchy. We suggest that the algorithms of particle filtering and Bayesian-belief propagation might model these interactive cortical computations.</p>
</blockquote>



<p>In Mumford and Lee’s model, the brain is Bayesian (point 4), it contains a generative model (point 3), and inference of the contents of an image from noisy measurements from the retina involves recurrent noisy algorithms (points 1 and 2). These recurrent noisy algorithms include particle filtering, loopy belief propagation, or MCMC. There was some early progress in scaling up this idea: the <a href="https://direct.mit.edu/neco/article-abstract/18/7/1527/7065/A-Fast-Learning-Algorithm-for-Deep-Belief-Nets">restricted Boltzmann machine (RBM) papers</a> from Bengio &amp; Hinton from the late 2000’s cite Mumford &amp; Lee. However, the idea fizzled as discriminative approaches to classification became popular. Generative approaches are currently not competitive in explaining the ventral stream compared to other image-computable models (<a href="http://www.brain-score.org/">Brain-Score</a> and the like; see also <a href="https://openreview.net/forum?id=i_xiyGq6FNT">Conwell et al. 2021</a>, <a href="https://www.pnas.org/doi/10.1073/pnas.2014196118">Zhuang et al. 2021</a>).</p>



<p>I think there’s an opportunity to resurrect and modernize this class of models using DDPMs. The most straightforward mapping to the ventral stream is to think of the first half of the denoising U-Net as equivalent to a feedforward pass up the ventral stream, the second half as a backward pass; the multiple iterations of the denoiser correspond to recurrent activity. The information communicated at every denoising step back to V1 is the delta between an image and its projection on the image manifold at this point in the process, producing a nice link to predictive coding models.</p>



<p>Regardless of the exact way in which we embody these ideas, DDPMs give us access to a lot of new machinery to work with, in both discrete &amp; continuous formulations. That’s on top of related ideas of denoising score matching on probabilistic graphic models and related progress in hierarchical VAEs (see Kevin Murphy’s book for more on these subjects).</p>



<h3>Content addressable memories and the hippocampus</h3>



<p>DDPMs are also related to ideas about content addressable memories and the hippocampus. Consider the famous <a href="http://www.scholarpedia.org/article/Hopfield_network">Hopfield network</a>, a recurrent neural network which stores discrete memories inside of its weights. It can retrieve memories at will as the steady state of recurrent activity: starting from an incomplete pattern, it can complete the pattern by repeated application of a simple rule. Such a content-addressable memory is often a core component of computational models of the hippocampus, for instance the <a href="https://www.sciencedirect.com/science/article/pii/S009286742031388X#sec4.3.20.2">Tolman-Eichenbaum machine</a>.</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-7.png"><img decoding="async" loading="lazy" width="472" height="331" data-attachment-id="8156" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-7-3/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-7.png" data-orig-size="472,331" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-7" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-7.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-7.png?w=472" src="https://xcorr.files.wordpress.com/2023/02/untitled-7.png?w=472" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-7.png 472w, https://xcorr.files.wordpress.com/2023/02/untitled-7.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-7.png?w=300 300w" sizes="(max-width: 472px) 100vw, 472px"/></a><figcaption>Hopfield networks can fill in missing information to retrieve partial memories; so can DDPMs. <a href="https://ml-jku.github.io/hopfield-layers/">From this excellent blog post</a> on modern Hopfield networks.</figcaption></figure>



<p>I like to think of DDPMs as continuous content-addressable memories. Corrupted images can be retrieved by the repeated application of the denoiser. Importantly, the network stores continuous memories: instead of representing discrete memories (mixture of Dirac deltas) like a Hopfield network, they represent an ensemble of memories (continuous distribution). DDPMs can recover from different corruptions, including additive noise and masking.</p>



<p>Lest we think that this analogy is a bit vacuous, DDPMs are capable of complex tasks traditionally ascribed to the hippocampus. A striking example is the recent work from <a href="https://arxiv.org/abs/2205.11495">Harvey et al. 2022</a>, who showed that you could train a DDPM to generate hour-long videos. They took videos of a car driving in a virtual environment, and let the DDPM learn conditional generation, for example predicting the next frame in a sequence from the previous 4. By repeating this process with different temporal horizons, the model could generate hour-long videos of a car driving through the town, starting from a random location hallucinated by unconditional sampling (<a href="https://plai.cs.ubc.ca/2022/05/20/flexible-diffusion-modeling-of-long-videos/">see samples here</a>).</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/untitled-8.png"><img decoding="async" loading="lazy" width="2578" height="650" data-attachment-id="8157" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/untitled-8-2/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/untitled-8.png" data-orig-size="2578,650" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="untitled-8" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=2048 2048w, https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/untitled-8.png?w=768 768w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Generated sequences from a video DDPM mimic navigation in the real world. From Harvey et al. (2022)</figcaption></figure>



<p>It’s really quite striking that this simple model learned to generate complex sequences from scratch. In fact, it’s possible to map back hallucinated sequences to locations within the virtual town where the sequence was generated, and in most cases, the sequences are spatially coherent. Occasionally, the denoiser gets confused and warps to a different part of the map, relying on landmarks to do its thing. I think it’s really interesting how the generative task learned by the DDPM coaxes it to memorize and navigate through an environment, and how this could relate to the hippocampus’ role in navigation and memory.</p>



<h3>As separate objects of study</h3>



<p>I hope to have convinced you that DDPMs are sufficiently analogous to the brain to advance the <a href="https://arxiv.org/abs/2209.03718">neuroAI research programme</a>. However, if it turns out, after careful study, that these machines are mechanistically quite different than the brain (Marr’s level 3), they might still contain some insights about the brain’s goals and potential algorithmic solutions (Marr’s levels 1 and 2). I think that neuroAI and AI itself would benefit from studying how DDPMs work and what they’re capable of. There are some really interesting potential insights into human visual cognition lurking inside these models.</p>



<figure><a href="https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png"><img decoding="async" loading="lazy" width="1178" height="499" data-attachment-id="8158" data-permalink="https://xcorr.net/2023/02/06/denoising-diffusion-models-for-neuroscience/screen_shot_2023-01-30_at_3-06-42_pm/" data-orig-file="https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png" data-orig-size="1178,499" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="screen_shot_2023-01-30_at_3.06.42_pm" data-image-description="" data-image-caption="" data-medium-file="https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=300" data-large-file="https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=1024" src="https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=1024" alt="" srcset="https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=1024 1024w, https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=150 150w, https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=300 300w, https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png?w=768 768w, https://xcorr.files.wordpress.com/2023/02/screen_shot_2023-01-30_at_3.06.42_pm.png 1178w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>A DDPM implicitly computes semantic segmentations. From <a href="https://openreview.net/forum?id=SlxSY2UZQT">Baranchuk et al. (2022)</a>.</figcaption></figure>



<p>For example, I’ve mentioned previously that DDPMs are useful for unsupervised segmentation. As part of their objective to model the distribution of natural images, they perform what appears to be implicit, approximate segmentation, propagating information about object relationships across long distances, all in the service of generating spatially coherent images. This opens up a number of follow-up questions, for example, are DDPMs susceptible to foreground/background illusions, like Kanisza squares? Can they solve Mooney images? More generally, do they follow Gestalt rules? We can take <a href="https://psyarxiv.com/5zf4s/">recent criticisms of feedforward CNNs as models of vision</a> as compendia of interesting phenomena that should be investigated in DDPMs.</p>



<p>Of key importance in these investigations is carefully controlling the natural image dataset DDPMs are trained on. ImageNet is not representative of what’s ecologically relevant to primates: it has too many dogs and not enough faces and body parts. Using ImageNet might be acceptable when the task is just a means to an end (e.g. learning good general-purpose features in a self-supervised manner), but not when the task is learning the manifold of images. We should carefully comparatively study DDPM behaviour trained on ImageNet or LAION vs. ecologically motivated datasets, e.g. <a href="https://www.pnas.org/doi/10.1073/pnas.2011417118">EcoSet</a> and <a href="https://direct.mit.edu/opmi/article/doi/10.1162/opmi_a_00039/97495/SAYCam-A-Large-Longitudinal-Audiovisual-Dataset">SAYCam</a>.</p>







<p>DDPMs are a class of conditional generative models that have found widespread use in generating images, sounds and time series. They strike a nice balance between complexity of implementation, flexibility, ease of sampling and evaluation. They may be useful in neuroscience where we need to generate fake data – for semi-supervised learning or for decoding. However, there’s a wider and more speculative horizon of possible links to neuroscience: hierarchical Bayesian models and content-addressable memories. It’ll be really interesting to break these models apart and figure out how they really work.</p>
</div></div>
  </body>
</html>
