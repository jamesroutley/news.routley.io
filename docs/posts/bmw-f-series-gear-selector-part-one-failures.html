<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.projectgus.com/2022/06/bmw-f-series-gear-selector-part-one-failures/">Original</a>
    <h1>BMW F Series Gear Selector, Part One: Failures</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="description articleBody">
<p>I&#39;m overdue to write up some of my vague electric vehicle conversion project, so here&#39;s a small part of it.</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw_gws.webp"><img alt="BMW GWS sitting on my desk" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw_gws.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw_gws.webp 4x"/></a></p>
<p><em>Note: This post is a journey through the awkward process of reverse engineering. If you&#39;re here to find out what CAN messages control a BMW F series GWS module, skip this post and read the later parts.</em></p>
<h2>Shifting Gears</h2>
<p>My goal was to find a gear selector to suit a car converted to an EV-style &#34;fixed reduction gear&#34; gearbox. This is basically an &#34;automatic transmission&#34; but without any different gear ratios, only a fixed gear ratio and a motor that drives forward and reverse:</p>
<p><a href="https://www.projectgus.com/images/2022-06/outlander-rear-drive-unit.webp"><img alt="Mitsubishi Outlander rear drive unit with fixed reduction gear" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/outlander-rear-drive-unit.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/outlander-rear-drive-unit.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/outlander-rear-drive-unit.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/outlander-rear-drive-unit.webp 4x"/></a></p>
<p>(That motor and reduction gear is from a Mitsubishi Outlander PHEV.)</p>
<p>Most older auto transmission gear selectors aren&#39;t great for this because they depend on a mechanical linkage to the transmission. On newer models the physical linkage may only be to get in and out of Park Lock, but on older models it can be how every &#34;gear&#34; is selected (Neutral, Drive, Reverse, etc.).</p>
<p>After looking at a few options that wouldn&#39;t fit, I stumbled across these really nice looking gear selectors from BMW:</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw_gws_2.webp"><img alt="BMW GWS sitting on my desk" src="https://www.projectgus.com/images/2022-06/derivatives/small/1x/bmw_gws_2.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small/1x/bmw_gws_2.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small/2x/bmw_gws_2.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small/4x/bmw_gws_2.webp 4x"/></a></p>
<p>(BMW calls this a &#34;GWS&#34;, please comment if you know what this stands for in German.)</p>
<p>They are fully electronic, basically a glorified computer joystick with electro-mechanical features to unlock and re-lock manual shift mode, and even to move out of that mode.</p>
<p>BMW North America made this video about how to use them:</p>
<p>
<iframe allowfullscreen="" frameborder="0" seamless="" src="https://www.youtube.com/embed/S3JGVovi7qQ"></iframe>
</p>
<p>Many of the &#34;F&#34; series model code BMWs (2008 and newer), plus some &#34;G&#34; series, have a version of this gear selector but the specifics vary.</p>
<p>The particular one I have is part number &#34;GW 9 296 899-01&#34;/&#34;100999952-00&#34;:</p>
<p><a href="https://www.projectgus.com/images/2022-06/part_number_closeup.webp"><img alt="Close up of GWS part numbers" src="https://www.projectgus.com/images/2022-06/derivatives/small/1x/part_number_closeup.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small/1x/part_number_closeup.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small/2x/part_number_closeup.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small/4x/part_number_closeup.webp 4x"/></a></p>
<p>It&#39;s from an F20 model: a 2014 BMW 125i LCI that was crashed.</p>
<p><img alt="Crashed BMW one series with no wheels" src="https://www.projectgus.com/images/2022-06/derivatives/article-nolink/1x/one-series-wrecked.jpg" srcset="https://www.projectgus.com/images/2022-06/derivatives/article-nolink/1x/one-series-wrecked.jpg 1x, https://www.projectgus.com/images/2022-06/derivatives/article-nolink/2x/one-series-wrecked.jpg 2x, https://www.projectgus.com/images/2022-06/derivatives/article-nolink/4x/one-series-wrecked.jpg 4x"/></p>
<p>The person parting out this car was kind enough to give me the plug and a length of wire from the loom, which is useful because this inline connector seems pretty custom:</p>
<p><a href="https://www.projectgus.com/images/2022-06/plug.webp"><img alt="Close up of the custom TE/BMW inline plug" src="https://www.projectgus.com/images/2022-06/derivatives/small/1x/plug.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small/1x/plug.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small/2x/plug.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small/4x/plug.webp 4x"/></a></p>
<p>The plug is BMW part 9132576-02. It&#39;s also marked with the OEM TE part number 2-929423-2, but this comes up on the TE website as <a href="https://www.te.com/usa-en/product-2-929423-2.html">&#34;RESTRICTED PRODUCT&#34;</a>...</p>
<h2>About these selectors</h2>
<p>Like most automotive-grade hardware, the PCB inside this thing is pretty classy:</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw_gws_side_off.webp"><img alt="BMW GWS with side panel removed showing PCB" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws_side_off.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws_side_off.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw_gws_side_off.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw_gws_side_off.webp 4x"/></a></p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw_gws_pcb_top.webp"><img alt="Close up of PCB top side" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws_pcb_top.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws_pcb_top.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw_gws_pcb_top.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw_gws_pcb_top.webp 4x"/></a></p>
<p>On the back of the PCB there&#39;s a nifty circuit that interacts with the lever movements:</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw_gws_pcb_bottom.webp"><img alt="Close up of PCB bottom side" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws_pcb_bottom.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw_gws_pcb_bottom.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw_gws_pcb_bottom.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw_gws_pcb_bottom.webp 4x"/></a></p>
<p><a href="https://www.projectgus.com/images/2022-06/actuator.webp"><img alt="Lever actuator internals" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/actuator.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/actuator.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/actuator.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/actuator.webp 4x"/></a></p>
<p>I think this circuit exists to detect movement, there&#39;s a separate motor that seems to do locking and for the GWS to move the lever.</p>
<p>Keeping with automotive tradition, there is also an obscure Automotive Market Microcontroller (tm) on there:</p>
<p><a href="https://www.projectgus.com/images/2022-06/infineon-mcu.webp"><img alt="Close up of Infineon XC2336B MCU on PCB" src="https://www.projectgus.com/images/2022-06/derivatives/small/1x/infineon-mcu.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small/1x/infineon-mcu.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small/2x/infineon-mcu.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small/4x/infineon-mcu.webp 4x"/></a></p>
<p>This one is an Infineon XC2336B, which actually has a <a href="https://www.infineon.com/cms/en/product/microcontroller/legacy-microcontroller/legacy-8-bit-16-bit-microcontroller/xc2300-family-safety/">public product page</a> with a datasheet (<em>gasp</em>). You can even find a pinout and (maybe) download an SDK, all from the manufacturer&#39;s website. What an age we live in...</p>
<h2>Hooking it up</h2>
<p>First step, work out how to wire this up without cooking it...</p>
<p><a href="https://www.projectgus.com/images/2022-06/cut_wiring.webp"><img alt="Plug and loose wires cut from loom" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/cut_wiring.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/cut_wiring.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/cut_wiring.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/cut_wiring.webp 4x"/></a></p>
<p>Having original wires from the loom is a huge head start:</p>
<ul>
<li>There are two obvious twisted pairs - those are probably CAN</li>
<li>Red/blue striped and brown wires are described online as being BMW&#39;s usual colours for &#34;Switched 12V&#34; and Ground. A quick check on the PCB shows that the red/blue wire is diode protected against reverse polarity and feeds closely into the power section of the board, so that seems like a sure thing for 12V.</li>
</ul>
<p>Drifting around the internet are some BMW technical documents that show how many F-series cars have two powertrain CAN buses, PT-CAN and PT-CAN2. Here&#39;s part of the diagram showing modules connected to each bus:</p>
<p><img alt="PT-CAN and PT-CAN2 diagram for BMW F01 series" src="https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/1x/ptcan2-diagram.png" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/1x/ptcan2-diagram.png 1x, https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/2x/ptcan2-diagram.png 2x, https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/4x/ptcan2-diagram.png 4x"/></p>
<p>It&#39;s like the engineers said &#34;OK, we&#39;re making another Powertrain Bus - <em>But Only The Real Powertrain Modules are allowed this time!</em>&#34;. The BMW documents note that PT-CAN2 is a redundant link so we can hope it carries the same messages as PT-CAN for the three connected modules (Engine controller <em>DME</em>, transmission controller <em>EGS</em>, gear selector <em>GWS</em>).</p>
<p>BMW forum posts also suggested that PT-CAN is often Red and Blue/Red wires. That identifies PT-CAN, so the other twisted pair is probably PT-CAN2:</p>
<table>
<thead>
<tr>
<th>Pin</th>
<th>Wire Colour</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td>NC</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>NC</td>
</tr>
<tr>
<td>3</td>
<td>Red</td>
<td>PT-CAN Low</td>
</tr>
<tr>
<td>4</td>
<td>Blue/Red</td>
<td>PT-CAN High</td>
</tr>
<tr>
<td>5</td>
<td>White/Blue</td>
<td>PT-CAN2 Low</td>
</tr>
<tr>
<td>6</td>
<td>White/Yellow</td>
<td>PT-CAN2 High</td>
</tr>
<tr>
<td>7</td>
<td>Green/Brown</td>
<td>???</td>
</tr>
<tr>
<td>8</td>
<td>Brown</td>
<td>Ground</td>
</tr>
<tr>
<td>9</td>
<td></td>
<td>NC</td>
</tr>
<tr>
<td>10</td>
<td>Red/Blue</td>
<td>+12V</td>
</tr>
</tbody>
</table>
<p>Connecting up all the known wires, no smoke came out... but nothing else either, no lights and no CAN messages. Current draw almost zero...</p>
<p>Looking on the PCB, mystery pin 7 (green/brown) was connected to what looked like a 51K/1.5K voltage divider. This seemed enough reason to try plugging it directly to 12V and check if it was an Enable or &#34;Wake-up&#34; signal. Sure enough, CAN messages immediately started transmitting on both buses at 500kbps!</p>
<h2>CAN Output</h2>
<p>This post doesn&#39;t include a primer on CAN protocol, there are a lot of good CAN introductions online including <a href="https://www.linkedin.com/pulse/automotive-can-bus-system-explained-kiril-mucevski/">this short one</a>. As a quick refresher, recall that each standard CAN message is up to 8 bytes of data with an associated ID that is either 11 or 29 bits long.</p>
<p>Looking at the CAN output, two regular messages showed up:</p>
<h3>0x553 &#34;Heartbeat&#34; message</h3>
<div><pre><span></span><code>ID: 055e   00 00 00 00 01 00 00 5e
ID: 055e   00 00 00 00 01 00 00 5e
ID: 055e   00 00 00 00 01 00 00 5e
ID: 055e   00 00 00 00 01 00 00 5e
</code></pre></div>
<p>This message is sent every 640ms. The data payload doesn&#39;t seem to change over time.</p>
<p>Byte 4 of the message is 01 on &#34;PT-CAN&#34; and 02 on &#34;PT-CAN2&#34;, so it provides a way to tell which bus you are listening to (and also confirms my guesses.)</p>
<h3>0x197 &#34;Selector Status&#34; message</h3>
<div><pre><span></span><code>ID: 0197   85 08 0e c0
ID: 0197   0a 09 0e c0
ID: 0197   86 0a 0e c0
ID: 0197   09 0b 0e c0
ID: 0197   83 0c 0e c0
ID: 0197   0c 0d 0e c0
</code></pre></div>
<p>This shorter message is sent every 30ms on ID 0x197.</p>
<p>The first two bytes change on every message, and they are probably an in-message checksum and a &#34;counter&#34; value that other modules use to ignore accidentally repeated or &#34;stuck&#34; messages.</p>
<p>The third byte changes if you move the gear selector forward or back, and the last byte changes from c0 to d5 if you press the Park button. Pressing the &#34;Unlock&#34; button (needed in a real car to move out of Park or into Reverse) didn&#39;t change anything in this message. The gear lever also stayed locked from moving left to select &#34;manual/sport shift&#34; mode.</p>
<p>So I think this is the message that the GWS uses to indicate its position.</p>
<h2>0x65e mystery message</h2>
<p>I noticed a few other intermittent messages on ID 0x65e, with nearly identical data bytes but no clear timing or pattern:</p>
<div><pre><span></span><code>ID: 065e   f0 10 0a 62 17 04 e0 94
ID: 065e   f0 10 0a 62 17 04 e0 94
ID: 065e   f0 10 0a 62 17 04 e0 94
ID: 065e   f0 10 11 62 17 04 e0 94
</code></pre></div>
<p>A burst of these 0x65e messages seems to be sent a short while after power-on, and then more bursts later at seemingly random times. We&#39;ll get back to those...</p>
<h2>What next?</h2>
<p>Applying power was enough to read the lever position, but the GWS itself is still blank - none of the LEDs for the gear modes have lit up:</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw-gws-idle.webp"><img alt="BMW GWS powered on bench with no LEDs lit" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw-gws-idle.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw-gws-idle.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw-gws-idle.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw-gws-idle.webp 4x"/></a></p>
<p>There also is no way to tell if the driver pressed the &#34;Unlock&#34; button, or to let them select the &#34;manual/sport&#34; shift mode. So clearly there are some CAN messages the GWS is expecting to receive from the rest of the powertrain (probably the gearbox itself, maybe from other modules too.)</p>
<p>Best case, it needs to receive some valid control messages. Worst case, it has some &#34;VIN locking&#34; or &#34;coding&#34; in it that means it needs to see a car-specific sequence to start working at all.</p>
<p>The fastest way to figure this out is to have a full working car, to capture all the CAN bus traffic in a log to replay and analyse.</p>
<p>I&#39;ve never even driven a BMW, so all I have is my lonely lever on the bench...</p>
<h2>Failure 1 - Other BMW Selectors</h2>
<p>I started by looking at some other BMW gear selectors that had already been documented by good people on the internet.</p>
<h3>BMW E60</h3>
<p><a href="https://evbmw.com/">Damien Maguire</a>, the undisputed champion of hacking EV parts into BMWs, had posted some <a href="https://openinverter.org/forum/viewtopic.php?p=22563#p22563">notes on his BMW E60 gear lever&#39;s CAN messages</a>:</p>
<p><a href="https://openinverter.org/forum/viewtopic.php?p=22510#p22510"><img alt="BMW E60 Lever on the bench, as posted on openinverter" src="https://www.projectgus.com/images/2022-06/derivatives/small-nolink/1x/bmw-e60-lever.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small-nolink/1x/bmw-e60-lever.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small-nolink/2x/bmw-e60-lever.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small-nolink/4x/bmw-e60-lever.webp 4x"/></a></p>
<p>(Photo courtesy &#34;sheselectric&#34; <a href="https://openinverter.org/forum/viewtopic.php?p=22510#p22510">on the openinverter forums</a>.)</p>
<p>E60 is an earlier generation than this F20 model, but looking at the gear selector you can see the family resemblance. Maybe BMW has reused the message IDs or formats? The E60 lever sends status on ID 0x198, this lever sends status on 0x197 - that seems hopeful, right?</p>
<p><em>No dice</em>. Even sending variations on the E60 message IDs and the message payloads, my GWS continued to stare back at me blank and unresponsive.</p>
<h3>OpenDBC E9x/E8x</h3>
<p>The OpenDBC project is part of <a href="https://comma.ai/">comma.ai</a>&#39;s efforts to document the CAN message formats of as many cars as possible, particularly the driver assistance features. @dzid26 has <a href="https://github.com/dzid26/opendbc-BMW-E8x-E9x/blob/master/bmw_e9x_e8x.dbc#L160">a fork of this repo with some BWM E9x and E8x CAN messages</a>.</p>
<p>You probably guessed already, none of these messages (or slight variations on them) got as much of a glimmer of response when sent to the GWS.</p>
<h3>Internet Hunting</h3>
<p>Obsessive internet searching didn&#39;t lead to much else. <a href="https://www.bimmerfest.com/threads/f30-gws-can-bus-data.1420406/">There is a BMW forum post</a> by someone looking for the same info for an F30 model, but they had no luck. Someone did post a pinout that looked the same as mine - so that&#39;s encouraging.</p>
<p>I also found the forums for the PicoScope (a useful automotive debugging tool) had posted a short CAN capture from a <a href="https://www.picoauto.com/support/topic21680.html#p98295">BMW F31</a> to debug something else. Sadly, no likely looking messages in there.</p>
<h2>Failure 2 - Random CAN messages</h2>
<p>I retreated to the classic resort of the confused programmer: do random things and look at what happens.</p>
<p>It&#39;s possible to do a little better than sending purely random CAN messages: if one field in the message is probably a checksum, then it&#39;s possible to send a sequence of bytes where we increment one byte only each time and try all values 0x00 - 0xFF, then move to trying the next byte, etc, etc. For example:</p>
<div><pre><span></span><code>00 55 55 55 55 55 55 55
01 55 55 55 55 55 55 55
02 55 55 55 55 55 55 55
[...]
fe 55 55 55 55 55 55 55
ff 55 55 55 55 55 55 55
55 00 55 55 55 55 55 55
55 01 55 55 55 55 55 55
55 02 55 55 55 55 55 55
[...]
</code></pre></div>
<p>This way, it&#39;s possible to send 8 * 255 = 2040 different 8 byte messages and know that at least one should have a valid 8-bit checksum in it, even without knowing which field is the checksum (provided the checksum is no more than a single byte, and doesn&#39;t span across two bytes in the message). I repeated this test with a range of possible CAN IDs, and then repeated again with some different data bytes (all 55, all 00, all FF, etc.)</p>
<p>Of course, as we saw above from the &#34;status&#34; message 0x197, the CAN messages may also contain a <em>counter</em> field. Sending random messages like this may not work at all if the GWS needs to see two messages with different counter values before it validates one of them. Also, of course, I have no idea if any of EE, 00, FF will be parsed as valid data values.</p>
<p>The worst part of this process was not having any automated way to check if something had happened. I was literally sitting and staring at the GWS in case it blinked an LED at me. I also tried automatically monitoring the current draw of the GWS, as I figured it would go up once it started doing things. However I wasn&#39;t sure if one valid message would spike the current enough to detect it.</p>
<p><a href="https://www.projectgus.com/images/2022-06/gws-multimeter.webp"><img alt="BMW GWS with multimeter and CAN interface connected" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/gws-multimeter.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/gws-multimeter.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/gws-multimeter.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/gws-multimeter.webp 4x"/></a></p>
<p>This process... found something! Suddenly, the GWS lit up its backlight:</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw-gws-backlight-on.webp"><img alt="BMW GWS with backlight on" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw-gws-backlight-on.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw-gws-backlight-on.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw-gws-backlight-on.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw-gws-backlight-on.webp 4x"/></a></p>
<p>Replaying the messages around this value revealed message ID 0x202 would trigger illumination:</p>
<div><pre><span></span><code><span>bus</span><span>.</span><span>send</span><span>(</span><span>can</span><span>.</span><span>Message</span><span>(</span><span>arbitration_id</span><span>=</span><span>0x202</span><span>,</span>
                     <span>data</span><span>=</span><span>[</span><span>0xFF</span><span>]</span> <span>*</span> <span>8</span><span>,</span>
                     <span>is_extended_id</span><span>=</span><span>False</span><span>))</span>
</code></pre></div>
<p>Searching online turned up discussion that it&#39;s a <a href="https://www.bimmerfest.com/threads/k-can2-messages-to-wake-a-cic-idrive-controller.890419/">common &#34;Dimmer&#34; BMW CAN ID used for this purpose</a>, with only two meaningful bytes. The first byte is a brightness level:</p>
<div><pre><span></span><code><span>brightness</span> <span>=</span> <span>0x40</span>
<span>bus</span><span>.</span><span>send</span><span>(</span><span>can</span><span>.</span><span>Message</span><span>(</span><span>arbitration_id</span><span>=</span><span>0x202</span><span>,</span>
                     <span>data</span><span>=</span><span>[</span><span>brightness</span><span>,</span> <span>0x00</span><span>],</span>
                     <span>is_extended_id</span><span>=</span><span>False</span><span>))</span>
</code></pre></div>
<p>So that&#39;s useful, but not what I was looking for...</p>
<h3>Failure 3 - Find a real BMW</h3>
<p>Getting a bit desperate, I started wondering about the ethics of renting a BMW so that I could capture a CAN log from it. I found a couple not that far away down in Melbourne... At the same time I wasn&#39;t sure this was a great idea, as you need to dismantle the interior a bit to access PT-CAN. It&#39;s probably a violation of the rental terms to partially dismantle the car for no good reason...</p>
<p>I was very excited to hear that a friend had just now bought a BMW 1 series, but equally devastated to learn it was a late &#34;E&#34; model code not an &#34;F&#34;. <em>What&#39;s the point of buying a shiny car if it&#39;s the wrong shiny car for me?</em> Boo.</p>
<h3>Failure 4 - Zero Budget Side Channels</h3>
<p>Did I give up now? <strong>Almost!</strong> I mean, <strong>Heck No!</strong>. That would be the sensible thing to do, but nothing about this EV project is sensible.</p>
<p>Instead, I started looking for ways to do <em>passive side channel analysis</em> on the GWS&#39; XC2336B microcontroller. In my case, I was thinking differential power analysis - closely measure the power consumption of the chip under two different conditions (in my case, valid CAN message received vs invalid CAN message received) and use this as a feedback function to guess (or fuzz) valid CAN messages. I figured the CAN peripheral is probably programmed to ignore most CAN IDs, so the CPU and digital logic is likely to work for a different amount of time depending on whether it sees a valid CAN ID or an invalid one. If it&#39;s possible to measure the current draw over time, it might be possible to differentiate an ignored CAN ID from a valid one and maybe even an invalid checksum from a valid checksum.</p>
<p>To start, I pulled the PCB out of the GWS and powered it up on my bench.</p>
<p><a href="https://www.projectgus.com/images/2022-06/pcb-on-bench.webp"><img alt="PCB in a clamp mount on my bench" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/pcb-on-bench.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/pcb-on-bench.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/pcb-on-bench.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/pcb-on-bench.webp 4x"/></a></p>
<p>Then I looked long and hard at the datasheet for the XC2300 series microcontroller, particularly the power pins:</p>
<p><img alt="XC2336B pinout" src="https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/1x/xc2336b_pinout.png" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/1x/xc2336b_pinout.png 1x, https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/2x/xc2336b_pinout.png 2x, https://www.projectgus.com/images/2022-06/derivatives/medium-nolink/4x/xc2336b_pinout.png 4x"/></p>
<p>Some bad news, on the multi-layer PCB I could see no power trace that would be easily cut to isolate only the power consumption of the MCU. To measure full power consumption, the easiest method would probably be to make a dedicated carrier board, like a ChipWhisperer UFO target board. This lets you analyse the microcontroller away from the rest of the PCB:</p>
<p><img alt="ChipWhisperer UFO board" src="https://www.projectgus.com/images/2022-06/derivatives/small-nolink/1x/chipwhisperer-ufo.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small-nolink/1x/chipwhisperer-ufo.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small-nolink/2x/chipwhisperer-ufo.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small-nolink/4x/chipwhisperer-ufo.webp 4x"/></p>
<p>I do have a ChipWhisperer Lite, but I wasn&#39;t ready to make a target board or desolder my only working GWS yet (<em>coward</em>).</p>
<p>Looking harder at the datasheet, I saw there are two internally regulated 1.1V &#34;core voltage&#34; power supplies (VDDIM and VDDI1) that require decent external decoupling capacitors:</p>
<p><img alt="XC2336B pin descriptions for VDDIM and VDDI1" src="https://www.projectgus.com/images/2022-06/derivatives/article-nolink/1x/xc2336b_core_voltage_pins.png" srcset="https://www.projectgus.com/images/2022-06/derivatives/article-nolink/1x/xc2336b_core_voltage_pins.png 1x, https://www.projectgus.com/images/2022-06/derivatives/article-nolink/2x/xc2336b_core_voltage_pins.png 2x, https://www.projectgus.com/images/2022-06/derivatives/article-nolink/4x/xc2336b_core_voltage_pins.png 4x"/></p>
<p>These power the core digital logic, including (I believe) the CPU. What if I removed the decoupling capacitors and monitored the voltage on this rail? Would the noise level allow me to tell the difference between &#34;idle chip&#34; and &#34;chip doing something&#34;?</p>
<p>This is pretty lo-fi, but lo-fi is all I need: I&#39;m not looking to extract any actual data like an encryption key out of the chip (which is possible with &#34;real&#34; power analysis techniques). All I need is the difference between &#34;the CPU is doing something&#34; (like processing a valid looking CAN message) and &#34;nothing is happening&#34; (assuming the CPU spends most of its time in a wait-for-interrupt state or busy-looping).</p>
<p><img alt="Distracted Boyfriend meme with him looking at Crappy Lo-Fi Power Analysis, not the Chipwhisperer Lite in my cupboard" src="https://www.projectgus.com/images/2022-06/derivatives/article-nolink/1x/distracted.jpg" srcset="https://www.projectgus.com/images/2022-06/derivatives/article-nolink/1x/distracted.jpg 1x, https://www.projectgus.com/images/2022-06/derivatives/article-nolink/2x/distracted.jpg 2x, https://www.projectgus.com/images/2022-06/derivatives/article-nolink/4x/distracted.jpg 4x"/></p>
<p>Decoupling caps off:</p>
<p><img alt="Oscilloscope probe wired to GWS PCB" src="https://www.projectgus.com/images/2022-06/derivatives/small-nolink/1x/bmw-gws-oscilloscope.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/small-nolink/1x/bmw-gws-oscilloscope.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/small-nolink/2x/bmw-gws-oscilloscope.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/small-nolink/4x/bmw-gws-oscilloscope.webp 4x"/></p>
<p>I rigged up a small firmware (in Rust, woo) to send CAN messages and trigger the oscilloscope exactly after each new message was sent.</p>
<div><pre><span></span><code><span>    </span><span>loop</span><span> </span><span>{</span><span></span>
<span>        </span><span>trigger</span><span>.</span><span>set_low</span><span>().</span><span>ok</span><span>();</span><span></span>

<span>        </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>id</span><span>)</span><span> </span><span>=</span><span> </span><span>try_read_id</span><span>(</span><span>usart1</span><span>,</span><span> </span><span>&amp;</span><span>mut</span><span> </span><span>buffer</span><span>)</span><span> </span><span>{</span><span></span>
<span>            </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>can_id</span><span>)</span><span> </span><span>=</span><span> </span><span>StandardId</span>::<span>new</span><span>(</span><span>id</span><span>)</span><span> </span><span>{</span><span></span>
<span>                </span><span>let</span><span> </span><span>can_data</span>: <span>[</span><span>u8</span><span>;</span><span> </span><span>8</span><span>]</span><span> </span><span>=</span><span> </span><span>[</span><span>0xFF</span><span>;</span><span> </span><span>8</span><span>];</span><span></span>
<span>                </span><span>let</span><span> </span><span>can_frame</span><span> </span><span>=</span><span> </span><span>Frame</span>::<span>new_data</span><span>(</span><span>can_id</span><span>,</span><span> </span><span>can_data</span><span>);</span><span></span>

<span>                </span><span>/* Wait until gear lever has sent a</span>
<span>                    heartbeat and then a status, and then</span>
<span>                    immediately send our message (this is</span>
<span>                    to try and make sure the status of the</span>
<span>                    GWS CPU is consistent each time) */</span><span></span>
<span>                </span><span>wait_for_can_frame</span><span>(</span><span>HEARTBEAT_ID</span><span>,</span><span> </span><span>&amp;</span><span>mut</span><span> </span><span>can</span><span>,</span><span> </span>
<span>                    </span><span>&amp;</span><span>timer</span><span>,</span><span> </span><span>Milliseconds</span>::<span>new</span><span>(</span><span>1000</span><span>))</span><span></span>
<span>                    </span><span>.</span><span>unwrap</span><span>();</span><span></span>
<span>                </span><span>wait_for_can_frame</span><span>(</span><span>STATUS_ID</span><span>,</span><span> </span><span>&amp;</span><span>mut</span><span> </span><span>can</span><span>,</span><span></span>
<span>                    </span><span>&amp;</span><span>timer</span><span>,</span><span> </span><span>Milliseconds</span>::<span>new</span><span>(</span><span>250</span><span>))</span><span></span>
<span>                    </span><span>.</span><span>unwrap</span><span>();</span><span></span>

<span>                </span><span>// Note: this retries until it gets an ACK</span>
<span>                </span><span>can</span><span>.</span><span>transmit</span><span>(</span><span>&amp;</span><span>can_frame</span><span>).</span><span>expect</span><span>(</span><span>&#34;Cannot send CAN frame&#34;</span><span>);</span><span></span>
<span>                </span><span>trigger</span><span>.</span><span>set_high</span><span>().</span><span>ok</span><span>();</span><span></span>
<span>                </span><span>defmt</span>::<span>trace</span><span>!</span><span>(</span><span>&#34;sent CAN frame&#34;</span><span>);</span><span></span>
<span>            </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span><span></span>
<span>                </span><span>defmt</span>::<span>error</span><span>!</span><span>(</span><span>&#34;bad CAN ID {}&#34;</span><span>,</span><span> </span><span>id</span><span>);</span><span></span>
<span>            </span><span>}</span><span></span>
<span>        </span><span>}</span><span></span>
<span>    </span><span>}</span><span></span>
</code></pre></div>
<p>And... nothing! The power rails remained pretty much rock solid, even with all the decoupling capacitors removed. Damn you, cautious and competent Automotive EEs!</p>
<h3>Non-Starter: Reversing the firmware</h3>
<p>Reversing the binary firmware seemed too hard. The XC2300 series MCUs have a &#34;C166SV1 16/32-bit microcontroller core&#34;. As far as I can tell, this is the C166 16-bit CPU first released in 1990 but extended with some &#34;32-bit extension&#34; instructions to bring it into the 21st century. There are some open source C166 decoding plugins, but nothing that looks mature and nothing for these particular CPU extensions.</p>
<p>A friend of mine is reversing an automotive component with the Renesas V850 CPU architecture. Several smart and motivated people have been looking at that for over a year now, and they still only have part of it figured out. It&#39;s a big job!</p>
<p>Not to mention, I don&#39;t have the firmware binary and there&#39;s no debug pins on the board, or documentation for any debug protocol. Maybe there&#39;s an update file hidden in some proprietary BMW software somewhere, but this is also a pain.</p>
<p>So yeah, even I have limits of how far I&#39;ll go for a little gear lever...</p>
<h2>End of the story?</h2>
<p>The GWS continued to sit on my desk silently mocking me for a couple of months, until I got COVID.</p>
<p><a href="https://www.projectgus.com/images/2022-06/bmw-gws-idle.webp"><img alt="BMW GWS powered on bench with no LEDs lit" src="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw-gws-idle.webp" srcset="https://www.projectgus.com/images/2022-06/derivatives/medium/1x/bmw-gws-idle.webp 1x, https://www.projectgus.com/images/2022-06/derivatives/medium/2x/bmw-gws-idle.webp 2x, https://www.projectgus.com/images/2022-06/derivatives/medium/4x/bmw-gws-idle.webp 4x"/></a></p>
<p>More about that coming soon, in Part Two. In the meantime, please leave a comment if you have any ideas about what I could have done to glean the secrets of the GWS...</p>
<p>Please also comment if you like this style of &#34;walkthrough reverse engineering failures&#34;, or not. I like reading this kind of thing, but if I&#39;m the only one then I&#39;ll skip these details next time.</p>
</div></div>
  </body>
</html>
