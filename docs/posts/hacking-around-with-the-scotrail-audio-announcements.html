<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://simonwillison.net/2022/Aug/21/scotrail/">Original</a>
    <h1>Hacking around with the ScotRail audio announcements</h1>
    
    <div id="readability-page-1" class="page"><div id="primary">

<div>




<p>Scottish train operator ScotRail released a two-hour long MP3 file containing all of the components of its automated station announcements. Messing around with them is proving to be a huge amount of fun.</p>
<p>I now have a Datasette instance running at <a href="https://scotrail.datasette.io/">scotrail.datasette.io</a> with a table of 2,440 MP3 files of announcement snippets. You can search them, filter them and play them there—either individual clips or as a sequence of clips attached together.</p>
<p>A few examples of things you can do with it:</p>
<ul>
<li>Here are all of <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Reason">421 reasons</a> that a train might be delayed or cancelled</li>
<li>A <a href="https://scotrail.datasette.io/scotrail/announcements?_search=bomb">search for bomb</a> turns up four audio clips about a “wartime bomb near the railway”</li>
<li>Here’s every clip in <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Special+train">the Special Train category</a>
</li>
<li>Here are <a href="https://scotrail.datasette.io/scotrail?sql=select+*+from+announcements+order+by+random()+limit+100">100 random clips</a>—hit “Play 100 MP3s on this page” to listen to them all in sequence</li>
<li>This page generates <a href="https://scotrail.datasette.io/scotrail/random_apology">a random apology</a> by gluing together six different clips, mad libs style</li>
</ul>
<p><img alt="random_apology query returning 7 rows: I am sorry to announce that the South West Trains service to Wilmslow has been cancelled due to Overcrowding because an earlier train had fewer coaches than normal" src="https://static.simonwillison.net/static/2022/scotrail-apology.jpg"/></p>
<p>The rest of this post is a detailed account of how I built this Datasette instance, from early prototypes on <a href="https://lite.datasette.io/">Datasette Lite</a> to a full, customized instance of Datasette running on Vercel and with build and deploy automation powered by GitHub Actions.</p>
<h4>Origins of the data</h4>
<p>Yesterday, Daily Record journalist Jon Brady <a href="https://twitter.com/jonbradyphoto/status/1560630522002321408">tweeted this</a>:</p>
<blockquote>
<p>Bizarre FOI find of the day: Scotrail has openly published a two-hour long sound file containing every single element of its automated station announcements <a href="https://files.scotrail.co.uk/ScotRail_Station_Announcements_June2022.mp3">https://files.scotrail.co.uk/ScotRail_Station_Announcements_June2022.mp3</a></p>
</blockquote>
<p>An hour and a half later, developer Matt Eason <a href="https://twitter.com/MattEason/status/1560653413783744512">replied</a>:</p>
<blockquote>
<p>If anyone needs this split into 2,440 individual mp3s—because why wouldn’t you—I’ve put them here: <a href="https://drive.google.com/drive/folders/172W6sXnvlr7UcNLipO8BTw417_KRz9c5?usp=sharing">https://drive.google.com/drive/folders/172W6sXnvlr7UcNLipO8BTw417_KRz9c5?usp=sharing</a></p>
<p>And if anyone wants to help transcribe all the files, here’s a shared sheet, which has a good chance of descending into chaos:</p>
<p><a href="https://docs.google.com/spreadsheets/d/1jAtNLBXLYwTraaC_IGAAs53jJWWEQUtFrocS5jW31JM/edit#gid=2073317291">https://docs.google.com/spreadsheets/d/1jAtNLBXLYwTraaC_IGAAs53jJWWEQUtFrocS5jW31JM/edit#gid=2073317291</a></p>
</blockquote>
<p>(Matt later <a href="https://github.com/matteason/scotrail-announcements-june-2022/blob/main/README.md">shared notes</a> about how he used <a href="https://www.nch.com.au/wavepad/index.html">WavePad</a> to do this.)</p>
<p>It took two hours for a collective of anonymous volunteers to dive through all of the files and transcribe every single one of them.</p>
<p>I first heard about this all earlier today, when Matt shared his project <a href="https://www.matteason.co.uk/scotbeats/">Ambient Scotrail Beats</a>—an absolutely superb project that overlays random snippets of ScotRail announcement on top of ambient “lofi hip hop radio”—or any YouTube clip you want to enhance in that way.</p>
<p><img alt="Ambient ScotRail Beats - a UI that lets you select a track, or paste in a YouTube URL, pick an announcement volume and delay and  then click Play to listen to the result" src="https://static.simonwillison.net/static/2022/scotrail-ambient-beats.jpg"/></p>
<p>I love how Matt credits Voiceover artist <a href="https://www.alisonmckay.com/">Alison McKay</a>, who originally recorded the announcements for ScotRail, in his work.</p>
<p>I couldn’t resist throwing the data into <a href="https://datasette.io/">Datasette</a> to see what kind of things I could do with it.</p>
<h4>Starting out with Datasette Lite</h4>
<p>My first step to explore the data was to try it out in <a href="https://lite.datasette.io/">Datasette Lite</a>, my build of Datasette that <a href="https://simonwillison.net/2022/May/4/datasette-lite/">runs in WebAssembly entirely in the browser</a>.</p>
<p>The great thing about Datasette Lite is that you don’t need to deploy anything anywhere in order to use it for a new project.</p>
<p>I exported a CSV file from <a href="https://docs.google.com/spreadsheets/d/1jAtNLBXLYwTraaC_IGAAs53jJWWEQUtFrocS5jW31JM/edit#gid=2073317291">the Google Sheet</a>, pasted it into <a href="https://gist.github.com/simonw/8a2494a3402450716f4c8129d280b133">this GitHub Gist</a>, grabbed the URL to the <a href="https://gist.githubusercontent.com/simonw/8a2494a3402450716f4c8129d280b133/raw/76f4f030a64318082496c51ffa6e572f3d8d00bd/ScotRail%2520announcements%2520June%25202022%2520index%2520-%2520Index.csv">raw CSV file</a> and pasted that into Datasette Lite.</p>
<p>I ran it through GitHub Gists because Datasette Lite needs data to have open CORS headers in order to load it, and GitHub Gists (and files on GitHub itself) have these headers.</p>
<p><a href="https://lite.datasette.io/?csv=https%3A%2F%2Fgist.githubusercontent.com%2Fsimonw%2F8a2494a3402450716f4c8129d280b133%2Fraw%2F76f4f030a64318082496c51ffa6e572f3d8d00bd%2FScotRail%252520announcements%252520June%2525202022%252520index%252520-%252520Index.csv#/data/ScotRail~252520announcements~252520June~2525202022~252520index~252520-~252520Index?_facet=Category">Here’s the result</a>. Just being able to facet by Category was already pretty interesting:</p>
<p><img alt="A table of snippets, faceted by Category so you can see there are 1,271 destinations, 421 reasons, 161 times and so on." src="https://static.simonwillison.net/static/2022/scotrail-facets.jpg"/></p>
<p>I <a href="https://twitter.com/simonw/status/1561024141121048576">started a Twitter thread</a> sharing my progress so far. This ended up running for the next eight hours as my experiments got increasingly ambitious.</p>
<h4>Adding an audio player</h4>
<p>Wouldn’t it be neat if you could listen to those MP3 files right there in the Datasette interface?</p>
<p>A few days ago I added <a href="https://simonwillison.net/2022/Aug/17/datasette-lite-plugins/">plugin support to Datasette Lite</a>—you can now add <code>?install=name-of-plugin</code> to the URL to install and use a new plugin.</p>
<p>This seemed like the perfect opportunity to put that new capability to good use!</p>
<p>Matt had uploaded all of the individual MP3 files to <a href="https://github.com/matteason/scotrail-announcements-june-2022">his scotrail-announcements-june-2022 GitHub repository</a>. This meant that you could get the URL for a snippet called <code>0008.mp3</code> by constructing the following URL:</p>
<p><code>https://github.com/matteason/scotrail-announcements-june-2022/raw/main/announcements/0008.mp3</code></p>
<p>What I needed was a Datasette plugin that could spot URLs ending in <code>.mp3</code> and turn them into an interactive audio player.</p>
<p>The easiest way to create a player in modern HTML is like this:</p>
<div><pre><span>&lt;</span><span>audio</span> <span>controls</span> <span>src</span>=&#34;<span>https://github.com/matteason/scotrail-announcements-june-2022/raw/main/announcements/0008.mp3</span>&#34;<span>&gt;</span>
  Audio not supported
<span>&lt;/</span><span>audio</span><span>&gt;</span></pre></div>
<p>Datasette has a <a href="https://docs.datasette.io/en/stable/plugin_hooks.html#render-cell-row-value-column-table-database-datasette">render_cell() plugin hook</a> which allows plugins to customize the way individual table cells are rendered.</p>
<p>Here’s the full implementation of a plugin that turns <code>.mp3</code> URLs into audio elements:</p>
<pre><span>from</span> <span>datasette</span> <span>import</span> <span>hookimpl</span>
<span>from</span> <span>markupsafe</span> <span>import</span> <span>Markup</span>, <span>escape</span>


<span>@<span>hookimpl</span></span>
<span>def</span> <span>render_cell</span>(<span>value</span>):
    <span>if</span> <span>not</span> <span>isinstance</span>(<span>value</span>, <span>str</span>):
        <span>return</span>
    <span>if</span> <span>value</span>.<span>endswith</span>(<span>&#34;.mp3&#34;</span>) <span>and</span> (
        <span>value</span>.<span>startswith</span>(<span>&#34;http://&#34;</span>)
        <span>or</span> <span>value</span>.<span>startswith</span>(<span>&#34;https://&#34;</span>)
        <span>or</span> <span>value</span>.<span>startswith</span>(<span>&#34;/&#34;</span>)
    ):
        <span>return</span> <span>Markup</span>(
            <span>&#39;&lt;audio controls src=&#34;{}&#34;&gt;Audio not supported&lt;/audio&gt;&#39;</span>.<span>format</span>(<span>escape</span>(<span>value</span>))
        )</pre>
<p>I fired up a new plugin using my <a href="https://github.com/simonw/datasette-plugin-template-repository">datasette-plugin</a> cookiecutter/GitHub repository template called <a href="https://github.com/simonw/datasette-mp3-audio">datasette-mp3-audio</a>, dropped in that implementation, added <a href="https://github.com/simonw/datasette-mp3-audio/blob/0.1/tests/test_mp3_audio.py">a basic test</a> and shipped it <a href="https://pypi.org/project/datasette-mp3-audio">to PyPI</a>.</p>
<p>Now, adding <code>?install=datasette-mp3-audio</code> to the Datasette Lite URL would install that plugin!</p>
<p>I built a <a href="https://gist.github.com/simonw/0a30d52feeb3ff60f7d8636b0bde296b">new copy of the CSV file</a> with those full MP3 URLs in it, and loaded that up in Datasette Lite:</p>
<p><a href="https://lite.datasette.io/?install=datasette-mp3-audio&amp;csv=https://gist.githubusercontent.com/simonw/0a30d52feeb3ff60f7d8636b0bde296b/raw/c078a9e5a0151331e2e46c04c1ebe7edc9f45e8c/scotrail-announcements.csv#/data/scotrail-announcements">https://lite.datasette.io/?install=datasette-mp3-audio&amp;csv=https://gist.githubusercontent.com/simonw/0a30d52feeb3ff60f7d8636b0bde296b/raw/c078a9e5a0151331e2e46c04c1ebe7edc9f45e8c/scotrail-announcements.csv#/data/scotrail-announcements</a></p>
<p><img alt="The scotrail announcements table, now with each row featuring an interactive MP3 player widget in the mp3 column." src="https://static.simonwillison.net/static/2022/scotrail-mp3-players.jpg"/></p>
<p>Being able to listen to the clips right there in the Datasette interface made the whole project instantly enormously more fun and interesting.</p>
<h4>Upgrading to a full Datasette</h4>
<p>Prototyping this on Datasette Lite had been fast and fun, but the long load times were beginning to grate—downloading and running a full copy of Python-compiled-to-WebAssembly every time someone loads the site didn’t make for a great first impression.</p>
<p>I decided to ship a server-side Datasette instance. The database is tiny—just 504KB—so I decided to use <a href="https://vercel.com/">Vercel</a> for this. I tend to switch to Cloud Run when my databases grow above about 100MB.</p>
<p>I like to automate my projects as early as possible, so I started a <a href="https://github.com/simonw/scotrail-datasette">simonw/scotrail-datasette</a> GitHub repository so I could run the deploys using GitHub Actions.</p>
<h4>Fetching the CSV with GitHub Actions</h4>
<p>First, I wanted a copy of the data in my repository—so that any future changes to the Google Sheet wouldn’t break my project.</p>
<p>I followed my <a href="https://simonwillison.net/2020/Oct/9/git-scraping/">Git scraping</a> pattern and built <a href="https://github.com/simonw/scotrail-datasette/blob/b1126635050303476f691a074a77ba6b1dae6b18/.github/workflows/fetch-csv.yml">a quick GitHub Actions workflow</a> to download the Google Sheets data as CSV and stash it in the repository:</p>
<div><pre><span>name</span>: <span>Fetch CSV from Google Sheets</span>

<span>on</span>:
  <span>workflow_dispatch</span>:

<span>permissions</span>:
  <span>contents</span>: <span>write</span>

<span>jobs</span>:
  <span>fetch-csv</span>:
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>steps</span>:
    - <span>uses</span>: <span>actions/checkout@v3</span>
    - <span>name</span>: <span>Set up Python 3.10</span>
      <span>uses</span>: <span>actions/setup-python@v3</span>
      <span>with</span>:
        <span>python-version</span>: <span><span>&#34;</span>3.10<span>&#34;</span></span>
        <span>cache</span>: <span><span>&#34;</span>pip<span>&#34;</span></span>
    - <span>name</span>: <span>Install dependencies</span>
      <span>run</span>: <span>|</span>
<span>        pip install -r requirements.txt</span>
<span>    - <span>name</span>: <span>Fetch</span>
      <span>run</span>: <span>|        </span>
<span>        curl -s -L &#39;https://docs.google.com/spreadsheets/d/1jAtNLBXLYwTraaC_IGAAs53jJWWEQUtFrocS5jW31JM/export?format=csv&#39; | \</span>
<span>          sqlite-utils memory stdin:csv \</span>
<span>          &#39;select [File], [NRE ID], Transcription, Category, Notes, Timestamp, [mp3 file] from stdin&#39; \</span>
<span>          --no-detect-types \</span>
<span>          --csv &gt; announcements.csv</span>
<span>    - <span>name</span>: <span>Commit and push</span>
      <span>run</span>: <span>|-</span>
<span>        git config user.name &#34;Automated&#34;</span>
<span>        git config user.email &#34;actions@users.noreply.github.com&#34;</span>
<span>        git add -A</span>
<span>        timestamp=$(date -u)</span>
<span>        git commit -m &#34;${timestamp}&#34; || exit 0</span>
<span>        git pull --rebase</span>
<span>        git push</span></span></span></pre></div>
<p>I was hoping I could just grab the CSV file and save it directly to the repo, but it turned out the raw data had some weirdness to it:</p>
<pre><code>% curl -s -L &#39;https://docs.google.com/spreadsheets/d/1jAtNLBXLYwTraaC_IGAAs53jJWWEQUtFrocS5jW31JM/export?format=csv&#39; | head -n 5 
File,NRE ID,Transcription,Category,Notes,Timestamp,Length,mp3 file,,,,,,,,,,,,,,,,,,,,,,,,
1869,BAI,Blairhill,Destination,,,00:00:00,1869.mp3,,,,,,,,,,,,,,,,,,,,,,,,
1703,BYK,Bentley,Destination,,,00:00:00,1703.mp3,,,,,,,,,,,,,,,,,,,,,,,,
0083,HEX,Hexham,Destination,,,00:00:00,0083.mp3,,,,,,,,,,,,,,,,,,,,,,,,
0004,,South West Trains service to,Train operating company,Bit of a detour,0:00:07,00:00:02,0004.mp3,Progress,#DIV/0!,Progress,#DIV/0!,Progress,#DIV/0!,,,,,,,,,,,,,,,,,,
</code></pre>
<p>What’s with all of those <code>,,,,,</code> blank lines?</p>
<p>It turned out enthusiastic data entry volunteers had scattered some emoji around in the spreadsheet grid to the right of the data, resulting in a whole bunch of extra blank columns in the CSV!</p>
<p>I decided to solve this using by using my <a href="https://sqlite-utils.readthedocs.io/">sqlite-utils</a> tool to clean up the data—in particular, the <a href="https://simonwillison.net/2021/Jun/19/sqlite-utils-memory/">sqlite-utils memory</a> mechanism. That’s what this bit does:</p>
<pre><code>curl -s -L &#39;https://docs.google.com/spreadsheets/d/1jAtNLBXLYwTraaC_IGAAs53jJWWEQUtFrocS5jW31JM/export?format=csv&#39; | \
    sqlite-utils memory stdin:csv \
    &#39;select [File], [NRE ID], Transcription, Category, Notes, Timestamp, [mp3 file] from stdin&#39; \
    --no-detect-types \
    --csv &gt; announcements.csv
</code></pre>
<p>This fetches the raw CSV data with <code>curl</code> and loads it into an in-memory database, using <code>stdin:csv</code> to hint to <code>sqlite-utils</code> that the data being piped to standard input is in CSV format rather than the default JSON.</p>
<p>Then it runs a SQL query directly against that in-memory database to pull out just the columns I want to keep.</p>
<p>The tool automatically detects types in CSV data. In this particular case filenames such as <code>0001</code> were being truncated to the integer <code>1</code>, which I didn’t want to happen—so I added the <code>--no-detect-types</code> option to turn that off.</p>
<p>Finally, I told it to output <code>--csv</code> and write that to the <code>announcements.csv</code> file.</p>
<p>The workflow ends by writing that new file back to the repository and pushing it, if it has changed.</p>
<p>The workflow is triggered on <code>workflow_dispatch</code>, which means I have to click a button in the GitHub Actions UI to trigger it. I clicked that button, waited a few seconds and GitHub Actions wrote <a href="https://github.com/simonw/scotrail-datasette/blob/main/announcements.csv">this CSV file</a> back to my repo.</p>
<h4>Building the SQLite database</h4>
<p>The next step was to write a script that would load that CSV file into a SQLite database. Again, I used <code>sqlite-utils</code> for this. Here’s the <code>build-db.sh</code> script I wrote:</p>
<div><pre><span><span>#!</span>/bin/bash</span>
sqlite-utils insert scotrail.db announcements announcements.csv --csv --pk File
sqlite-utils transform scotrail.db announcements \
  --rename <span><span>&#39;</span>NRE ID<span>&#39;</span></span> NRE_ID \
  --rename <span><span>&#39;</span>mp3 file<span>&#39;</span></span> <span><span>&#39;</span>mp3<span>&#39;</span></span> \
  -o File \
  -o Transcription \
  -o Category \
  -o mp3 \
  -o Notes \
  -o Timestamp \
  -o NRE_ID
sqlite-utils scotrail.db <span><span>&#34;</span>update announcements set mp3 = &#39;https://github.com/matteason/scotrail-announcements-june-2022/raw/main/announcements/&#39; || mp3<span>&#34;</span></span>

<span><span>#</span> Enable search</span>
sqlite-utils enable-fts scotrail.db announcements Transcription --tokenize porter</pre></div>
<p>It took a few iterations to get this exactly right.</p>
<p>The first line imports the CSV data into a table.</p>
<p>The second line does most of the work: it uses <a href="https://simonwillison.net/2020/Sep/23/sqlite-advanced-alter-table/">sqlite-utils transform</a> to rename a couple of columns, then change the order of the columns in that table to present them in a more useful order in the Datasette UI.</p>
<p>Next the script updates the <code>mp3</code> column to turn those filenames into full URLs.</p>
<p>Finally, it configures <a href="https://sqlite-utils.datasette.io/en/stable/cli.html#configuring-full-text-search">full-text search</a> on the <code>Transcription</code> column, with porter stemming enabled.</p>
<h4>Deploying to Vercel</h4>
<p>Build script in place, the last step was to automate the process of building the database and then deploying it to Vercel.</p>
<p>I wrote <a href="https://github.com/simonw/scotrail-datasette/blob/88173856254018614c9620d8099a4bb8d80fbb5b/.github/workflows/build-and-deploy.yml">a second workflow</a> for that:</p>
<div><pre><span>name</span>: <span>Build and deploy</span>

<span>on</span>:
  <span>workflow_dispatch</span>:
  <span>push</span>:

<span>jobs</span>:
  <span>build-and-deploy</span>:
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>steps</span>:
    - <span>uses</span>: <span>actions/checkout@v3</span>
    - <span>name</span>: <span>Set up Python 3.10</span>
      <span>uses</span>: <span>actions/setup-python@v3</span>
      <span>with</span>:
        <span>python-version</span>: <span><span>&#34;</span>3.10<span>&#34;</span></span>
        <span>cache</span>: <span><span>&#34;</span>pip<span>&#34;</span></span>
    - <span>name</span>: <span>Install dependencies</span>
      <span>run</span>: <span>|</span>
<span>        pip install -r requirements.txt</span>
<span>    - <span>name</span>: <span>Build SQLite database</span>
      <span>run</span>: <span>./build-db.sh</span>
    - <span>name</span>: <span>Deploy to Vercel</span>
      <span>env</span>:
        <span>VERCEL_TOKEN</span>: <span>${{ secrets.VERCEL_TOKEN }}</span>
      <span>run</span>: <span>|-</span>
<span>        datasette publish vercel scotrail.db \</span>
<span>          --token $VERCEL_TOKEN \</span>
<span>          --scope datasette \</span>
<span>          --project scotrail \</span>
<span>          --install datasette-mp3-audio \</span>
<span>          --metadata metadata.yml</span></span></pre></div>
<p>This workflow runs on every push to the repo, but can also be triggered manually.</p>
<p>It installs Python 3.10 and the dependencies I need, then runs the build script to build the database.</p>
<p>The interesting bit is that last block, titled “Deploy to Vercel”.</p>
<p>I created a Vercel API token in their dashboard and saved that as the <code>VERCEL_TOKEN</code> secret in the repository.</p>
<p>The final block uses the <a href="https://datasette.io/plugins/datasette-publish-vercel">datasette-publish-vercel</a> plugin to deploy the site:</p>
<div><pre>datasette publish vercel scotrail.db \
  --token <span>$VERCEL_TOKEN</span> \
  --scope datasette \
  --project scotrail \
  --install datasette-mp3-audio \
  --metadata metadata.yml</pre></div>
<p>Here we’re deploying the <code>scotrail.db</code> database that was created by our earlier build script. I’m using <code>--scope datasette</code> to specify the Vercel organization that I want to deploy to, and <code>--project scotrail</code> to specify the project.</p>
<p>Vercel will create a new project the first time you use that name, then deploy to that existing project on subsequent runs.</p>
<p>I install the <a href="https://datasette.io/plugins/datasette-mp3-audio">datasette-mp3-audio plugin</a>, described earlier.</p>
<p>Finally, I specify <code>--metadata metadata.yml</code> to upload a metadata file with details to be displayed on the homepage of the site. You can see an early version of that file <a href="https://github.com/simonw/scotrail-datasette/blob/15a40c70ca4e21e267fad84d75be96fb61e025c8/metadata.yml">here</a>.</p>
<p>This worked! I pushed the new workflow, it ran, and Vercel made my new application available at <code>scotrail.vercel.app</code>. I used their dashboard to assign a vanity URL of <a href="https://scotrail.datasette.io">scotrail.datasette.io</a>.</p>
<h4>Adding a “play all” button</h4>
<p>I quickly found myself frustrated at having to click the play button on so many different clips!</p>
<p>I decided to see if I could use JavaScript to hit play on everything in succession instead.</p>
<p>I opened up the Firefox DevTools console and started messing around in JavaScript. I eventually found that this recipe did what I wanted:</p>
<div><pre><span>function</span> <span>playAllAudios</span><span>(</span><span>)</span> <span>{</span>
  <span>let</span> <span>audios</span> <span>=</span> <span>Array</span><span>.</span><span>from</span><span>(</span><span>document</span><span>.</span><span>querySelectorAll</span><span>(</span><span>&#39;audio&#39;</span><span>)</span><span>)</span><span>;</span>
  <span>function</span> <span>playNext</span><span>(</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>audios</span><span>.</span><span>length</span><span>)</span> <span>{</span>
      <span>return</span><span>;</span>
    <span>}</span>
    <span>let</span> <span>next</span> <span>=</span> <span>audios</span><span>.</span><span>shift</span><span>(</span><span>)</span><span>;</span>
    <span>next</span><span>.</span><span>addEventListener</span><span>(</span><span>&#39;ended&#39;</span><span>,</span> <span>playNext</span><span>)</span><span>;</span>
    <span>next</span><span>.</span><span>play</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
  <span>playNext</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
<span>playAllAudios</span><span>(</span><span>)</span><span>;</span></pre></div>
<p>I <a href="https://github.com/simonw/datasette-mp3-audio/issues/2">opened an issue</a> to record my prototype.</p>
<p>This was while I was still working with Datasette Lite, which still <a href="https://github.com/simonw/datasette-lite/issues/8">has some limitations</a> in terms of executing JavaScript from plugins.</p>
<p>Once I’d upgraded to a full Datasette, I revisited the issue.</p>
<p>I figured out an extended version of my JavaScript prototype which would add a “Play 33 MP3s on this page” button to any page with two or more audio elements. Here’s <a href="https://github.com/simonw/datasette-mp3-audio/blob/7206b759c7888c10cb823f10962fa8f393d61261/datasette_mp3_audio/static/datasette-mp3-audio.js">the code</a>. I <a href="https://github.com/simonw/datasette-mp3-audio/commit/4885926f5cd015af29e41928ef272cba1dd9c150">implemented that in datasette-mp3-audio</a>, shipped a <a href="https://github.com/simonw/datasette-mp3-audio/releases/0.2">0.2 release</a> and added that to the site.</p>
<p>The new button is really fun! Here it is on <a href="https://scotrail.datasette.io/scotrail?sql=select+*+from+announcements+order+by+random%28%29+limit+100">a query that returns 100 random snippets</a>:</p>
<p><img alt="A custom SQL query: select * from announcements order by random() limit 100 - with a Play 100 MPs3 on this page button." src="https://static.simonwillison.net/static/2022/scotrail-random.jpg"/></p>
<h4>Generating random apologies with a SQL query</h4>
<p>To really exercise this new feature, I decided to try and build a <a href="https://en.wikipedia.org/wiki/Mad_Libs">mad lib</a>.</p>
<p>I figured out a SQL query that would construct a random apology, stringing together random snippets from a number of different categories.</p>
<p>I used CTEs (common table expressions—the <code>with x as (query)</code> blocks) to pick each of the random components of the final sentence.</p>
<p>Here’s <a href="https://scotrail.datasette.io/scotrail?sql=with+apology+as+%28%0A++++select+Transcription%2C+mp3+from+announcements+where%0A++++++++Category+%3D+%27Apology%27%0A++++order+by+random%28%29+limit+1%0A%29%2C%0Atrain_company+as+%28%0A++++select+Transcription%2C+mp3+from+announcements+where%0A++++++++Category+%3D+%27Train+operating+company%27%0A++++++++and+Transcription+like+%27%25to%25%27%0A++++order+by+random%28%29+limit+1%0A%29%2C%0Adestination+as+%28%0A++++select+Transcription%2C+mp3+from+announcements+where%0A++++++++Category+%3D+%27Destination%27%0A++++order+by+random%28%29+limit+1%0A%29%2C%0Acancelled+as+%28%0A++++select+Transcription%2C+mp3+from+announcements+where%0A++++++++Transcription+%3D+%27has+been+cancelled%27%0A++++limit+1%0A%29%2C%0Adue_to+as+%28%0A++++select+Transcription%2C+mp3+from+announcements+where%0A++++++++Transcription+%3D+%27due+to%27%0A++++limit+1%0A%29%2C%0Areason+as+%28%0A++++select+Transcription%2C+mp3+from+announcements+where%0A++++++++Category+%3D+%27Reason%27%0A++++order+by+random%28%29+limit+1%0A%29%2C%0Acombined+as+%28%0A++select+1+as+sort%2C+%2A+from+apology%0A++union+select+2%2C+%2A+from+train_company%0A++union+select+3%2C+%2A+from+destination%0A++union+select+4%2C+%2A+from+cancelled%0A++union+select+5%2C+%2A+from+due_to%0A++union+select+6%2C+%2A+from+reason%0A%29%0Aselect+%2A+from+combined+order+by+sort">the query I came up with</a>, with some extra inline commentary:</p>
<div><pre>with apology <span>as</span> (
    <span>select</span> Transcription, mp3 <span>from</span> announcements <span>where</span>
        Category <span>=</span> <span><span>&#39;</span>Apology<span>&#39;</span></span>
    <span>order by</span> random() <span>limit</span> <span>1</span>
),</pre></div>
<p>The <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Apology">Apology category</a> only has 8 rows, each along the lines of “I am sorry to announce that the” or “We are sorry to announce that the”.</p>
<div><pre>train_company <span>as</span> (
    <span>select</span> Transcription, mp3 <span>from</span> announcements <span>where</span>
        Category <span>=</span> <span><span>&#39;</span>Train operating company<span>&#39;</span></span>
        <span>and</span> Transcription <span>like</span> <span><span>&#39;</span>%to%<span>&#39;</span></span>
    <span>order by</span> random() <span>limit</span> <span>1</span>
),</pre></div>
<p>There are <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Train+operating+company">76 Train operating company</a> snippets, in formats that include “Midland Main Line service from” and “Southeastern Trains service to”. I filterled for just the ones with <code>to</code> in the text.</p>
<div><pre>destination <span>as</span> (
    <span>select</span> Transcription, mp3 <span>from</span> announcements <span>where</span>
        Category <span>=</span> <span><span>&#39;</span>Destination<span>&#39;</span></span>
    <span>order by</span> random() <span>limit</span> <span>1</span>
),</pre></div>
<p>There are <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Destination">1,271</a> potential destinations—single word names of places, like “Bath Spa” or “Dunfermline Queen Margaret”.</p>
<div><pre>cancelled <span>as</span> (
    <span>select</span> Transcription, mp3 <span>from</span> announcements <span>where</span>
        Transcription <span>=</span> <span><span>&#39;</span>has been cancelled<span>&#39;</span></span>
    <span>limit</span> <span>1</span>
),
due_to <span>as</span> (
    <span>select</span> Transcription, mp3 <span>from</span> announcements <span>where</span>
        Transcription <span>=</span> <span><span>&#39;</span>due to<span>&#39;</span></span>
    <span>limit</span> <span>1</span>
),</pre></div>
<p>There’s probably a neater way to do this—I just wanted the literal text “has been cancelled due to” in every result.</p>
<div><pre>reason <span>as</span> (
    <span>select</span> Transcription, mp3 <span>from</span> announcements <span>where</span>
        Category <span>=</span> <span><span>&#39;</span>Reason<span>&#39;</span></span>
    <span>order by</span> random() <span>limit</span> <span>1</span>
),</pre></div>
<p>These are the really fun ones. There are <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Reason">421</a> snippets marked “Reason”, everything from “Bad weather conditions” to “...a burst water main near the railway, yesterday” to “A wartime bomb near the railway earlier today”!</p>
<p>The final piece of the query combined these together into a list, with an artificially added <code>sort</code> column to guarantee the order (which I don’t think is strictly necessary in SQLite, but better safe than sorry):</p>
<div><pre>combined <span>as</span> (
  <span>select</span> <span>1</span> <span>as</span> sort, <span>*</span> <span>from</span> apology
  <span>union</span> <span>select</span> <span>2</span>, <span>*</span> <span>from</span> train_company
  <span>union</span> <span>select</span> <span>3</span>, <span>*</span> <span>from</span> destination
  <span>union</span> <span>select</span> <span>4</span>, <span>*</span> <span>from</span> cancelled
  <span>union</span> <span>select</span> <span>5</span>, <span>*</span> <span>from</span> due_to
  <span>union</span> <span>select</span> <span>6</span>, <span>*</span> <span>from</span> reason
)
<span>select</span> <span>*</span> <span>from</span> combined <span>order by</span> sort</pre></div>
<p>This totally works!</p>
<p>Since the bookmarked query is a pretty long URL I decided to use Datasette’s <a href="https://docs.datasette.io/en/stable/sql_queries.html#canned-queries">canned query</a> mechanism to turn it into a more easily discovered page:</p>
<p><a href="https://scotrail.datasette.io/scotrail/random_apology">scotrail.datasette.io/scotrail/random_apology</a></p>
<p>I also chose to hide the SQL query by default, to put the essential “Play 6 MP3s on this page” button above the fold.</p>
<p>I linked to it from the <a href="https://scotrail.datasette.io/">site homepage</a> too, using <code>description_html</code> in <a href="https://github.com/simonw/scotrail-datasette/blob/b1126635050303476f691a074a77ba6b1dae6b18/metadata.yml">the site metadata.yml</a>:</p>
<p><img alt="The homepage of the site reads: ScotRail announcements. ScotRail released an audio file of all of their announcements, voiced by Alison McKay. Matt Eason and a team of volunteers split the file into separate mp3s and transcribed them. This Datasette instance provides an interface and JSON API to that data. Search for an announcement snippet, or assemble and listen to a random apology." src="https://static.simonwillison.net/static/2022/scotrail-homepage.jpg"/></p>
<h4>Make fun stuff with the API</h4>
<p>As you can probably tell, I had a ridiculous amount of fun playing with this data.</p>
<p>If you want to build some things with this, you should know that every page on the Datasette instance has an accompanying API. Look for the <code>JSON</code> links on each page—Datasette serves them with CORS headers so you can fetch data from them from any domain on the Web.</p>
<p>I recommend adding <code>?_shape=objects</code> to the array, since this shape of data is closer to the breaking change I have planned for Datasette 1.0. Here’s an example returning one of those random apologies:</p>
<p><a href="https://scotrail.datasette.io/scotrail/random_apology.json?_shape=objects">https://scotrail.datasette.io/scotrail/random_apology.json?_shape=objects</a></p>
<p>I also installed the <a href="https://datasette.io/plugins/datasette-graphql">datasette-graphql</a> plugin, so if you want to use GraphQL instead you can do something <a href="https://scotrail.datasette.io/graphql/scotrail?query=%7B%0A%20%20announcements(filter%3A%20%7BCategory%3A%20%7Beq%3A%20%22Special%20train%22%7D%7D)%20%7B%0A%20%20%20%20nodes%20%7B%0A%20%20%20%20%20%20File%0A%20%20%20%20%20%20Transcription%0A%20%20%20%20%20%20Category%0A%20%20%20%20%20%20mp3%0A%20%20%20%20%20%20Notes%0A%20%20%20%20%20%20Timestamp%0A%20%20%20%20%20%20NRE_ID%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D">like this</a>:</p>
<div><pre>{
  <span>announcements</span>(<span>filter</span>: {<span><span>Category</span></span>: {<span><span>eq</span></span>: <span><span>&#34;</span>Special train<span>&#34;</span></span>}}) {
    <span>nodes</span> {
      <span>File</span>
      <span>Transcription</span>
      <span>Category</span>
      <span>mp3</span>
      <span>Notes</span>
      <span>Timestamp</span>
      <span>NRE_ID</span>
    }
  }
}</pre></div>
<p>That query returns the <a href="https://scotrail.datasette.io/scotrail/announcements?Category=Special+train">12 rows in the Special train category</a>.</p>
<p>Let me know <a href="https://twitter.com/simonw">on Twitter</a> if you build something fun!</p>




</div>

</div></div>
  </body>
</html>
