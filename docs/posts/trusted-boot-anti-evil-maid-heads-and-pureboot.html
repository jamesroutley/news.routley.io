<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.michaelaltfield.net/2023/02/16/evil-maid-heads-pureboot/">Original</a>
    <h1>Trusted Boot (Anti-Evil-Maid, Heads, and PureBoot)</h1>
    
    <div id="readability-page-1" class="page"><div><p>This post will help to provide historical context and demystify what&#39;s under the hood of Heads, PureBoot, and other tools to provide Trusted Boot.</p>
<p>I will not be presenting anything new in this article; I merely hope to provide a historical timeline and a curated list of resources.</p>
<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/evil-maid-heads-pureboot_featuredImage6.jpg"><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6.jpg.pagespeed.ic.NA_0ffrQ_1.jpg" alt="Verifying Boot Integrity with Heads, PureBoot" width="1200" height="628" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6.jpg.pagespeed.ic.NA_0ffrQ_1.jpg 1200w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6-300x157.jpg.pagespeed.ic.jSVQFDEL9t.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6-1024x536.jpg.pagespeed.ic.GGsgm98G3X.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6-768x402.jpg.pagespeed.ic.gMlwu2_6_y.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6-150x79.jpg.pagespeed.ic.RU7aJY7AEe.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_featuredImage6-400x209.jpg.pagespeed.ic.w3jV-oScAr.jpg 400w" sizes="(max-width: 1200px) 100vw, 1200px"/></a></p>

<div id="attachment_3118"><p><a href="https://shop.puri.sm/product-category/usb-security-tokens/?wpam_id=229"><img aria-describedby="caption-attachment-3118" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem_key_red1-300x300.jpg.pagespeed.ic.A9mfoMVTIZ.jpg" alt="Image shows the Librem Key plugged into a computer with a red LED lit" width="300" height="300" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem_key_red1-300x300.jpg.pagespeed.ic.A9mfoMVTIZ.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem_key_red1-150x150.jpg.pagespeed.ic.stssJnx0aR.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem_key_red1-400x400.jpg.pagespeed.ic.qPF95M-ZNz.jpg 400w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem_key_red1.jpg.pagespeed.ic.ClfwFycjDy.jpg 500w" sizes="(max-width: 300px) 100vw, 300px"/></a></p><p id="caption-attachment-3118">The <a href="https://shop.puri.sm/product-category/usb-security-tokens/?wpam_id=229">Librem Key</a> cryptographically verifies the system&#39;s integrity and flashes red if it&#39;s detected tampering</p></div>
<p>I&#39;ve always felt bad about two things:</p>
<ol>
<li>Because I run QubesOS, I usually <a href="https://www.qubes-os.org/faq/#is-secure-boot-supported">disable &#34;Secure Boot&#34;</a> on my laptop</li>
<li>I travel a lot, and I don&#39;t have a good way to verify the integrity of my laptop (eg from an <a href="#evilmaid">Evil Maid</a> that gains physical access to my computer)</li>
</ol>
<p>To address this, I have turned to <a href="#heads">Heads</a> and <a href="#pureboot">PureBoot</a> -- a collection of technologies including an open-source firmware/BIOS, TPM, and a <a href="https://shop.puri.sm/product-category/usb-security-tokens/?wpam_id=229">USB security key</a> that can cryptographically verify the integrity of the lowest firmware (and up the chain to the OS).</p>
<p>While Purism has written many articles about PureBoot and has some (minimal) <a href="https://docs.puri.sm/PureBoot.html">documentation</a>, I found they did a lot of hand waving without explaining how the technology works (what the hell is a &#34;BIOS measurement&#34;?). So I spent a great deal of time trying to research the technologies leveraged by PureBoot -- but it wasn&#39;t easy.</p>
<p>One of the biggest issues I&#39;ve had in understanding these technologies is the <a href="https://en.wikipedia.org/wiki/Trusted_Computing#Criticism">controversial approach to Trusted Computing</a>. To quote wikipedia:</p>
<blockquote><p>
&#34;TC is controversial as the hardware is not only secured for its owner, but also secured <strong>against its owner</strong>.&#34;</p></blockquote>

<p>Unfortunately, when learning about some infosec topics, it takes an enormous amount of information literacy and prerequisite knowledge to separate information sources that are designed merely for Enterprise from those that are adequate for Cypherpunks.</p>
<h2>Enterprise Security vs Cypherpunk Security</h2>
<p>Working as a cybersecurity consultant, I&#39;ve fought (and sometimes failed) to prevent management from installing <a href="https://en.wikipedia.org/wiki/Endpoint_detection_and_response">remote-access backdoor rootkits</a> company-wide.</p>
<p>I can&#39;t even believe I have to say this, but I firmly believe that remote-access <strong>backdoors with the power to [a] execute arbitrary commands as root and [b] upload/download any files from a machine should <em>never</em> be deployed</strong>. Especially when it&#39;s provided by an <a href="https://en.wikipedia.org/wiki/CrowdStrike">untrustworthy MSP</a> based in a country whose government has the <a href="https://en.wikipedia.org/wiki/National_security_letter">legal authority to force them</a> to do nasty things to their customers (and they have a <a href="https://en.wikipedia.org/wiki/American_Civil_Liberties_Union_v._Ashcroft">history</a> of <a href="https://en.wikipedia.org/wiki/Lavabit">doing it</a>).</p>

<p>But in an Enterprise environment, security doesn&#39;t mean the same thing as it does to Cypherpunks. Largely, Enterprises (or, more specifically, capitalist organizations) aren&#39;t so interested in protecting secrets. They&#39;re interested in protecting their capital. And capital can be protected by non-technical solutions (eg insurance). Because of this, technology targeting Enterprise Security may not meet your threat model&#39;s requirement. And because they&#39;re trying to sell you something, they may not clearly state which risk models are not protected-against. So you can easily spend a whole day reading well-funded security research, only to realize in the end that it&#39;s useless. <a href="https://en.wikipedia.org/wiki/UEFI#Secure_Boot">Secure Boot</a> and <a href="https://en.wikipedia.org/wiki/Intel_Active_Management_Technology">AMT</a> are an examples of this.</p>
<p>Enterprise Security is more aligned with <a href="https://en.wikipedia.org/wiki/Authoritarianism">Authoritarianism</a> -- an ideology that champions hierarchy and power given to a centralized authority.</p>
<p><a href="https://en.wikipedia.org/wiki/Cypherpunk">Cypherpunk Security</a>, on the other hand, is more aligned with <a href="https://en.wikipedia.org/wiki/Anarchism">Anarchism</a> -- an ideology that champions individual autonomy.</p>
<p>While Secure Boot provides weak protections and strips power away from the user, Heads and PureBoot provide strong protections and empowers the user. But they do so while still using the same <a href="https://en.wikipedia.org/wiki/Trusted_Platform_Module">hardware</a> technology that&#39;s traditionally used in an Enterprise environment -- which was designed with the intention to strip the user of their autonomy.</p>
<p>With this article, I hope to provide the resources to help to understand how PureBoot was able to leverage tools like TPMs yet also cover the Cyberpunk&#39;s threat model.</p>
<h2>Assumptions &amp; Scope</h2>
<div id="attachment_3064"><p><a href="https://shop.puri.sm/product-category/laptops/?wpam_id=229"><img aria-describedby="caption-attachment-3064" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem-14-heads-300x169.png.pagespeed.ic.BkHuyzbk_G.jpg" alt="Picture of the Purism Librem 14 running Heads, prompting the user how to proceed on-boot" width="300" height="169" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem-14-heads-300x169.png.pagespeed.ic.BkHuyzbk_G.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem-14-heads-768x432.png.pagespeed.ic.CFXonReZmy.png 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem-14-heads-150x84.png.pagespeed.ic.ffEvSTunZN.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem-14-heads-400x225.png.pagespeed.ic.zxv6tSUUiT.png 400w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xlibrem-14-heads.png.pagespeed.ic.ZePEWc2-b2.png 1024w" sizes="(max-width: 300px) 100vw, 300px"/></a></p><p id="caption-attachment-3064">The Purism <a href="https://shop.puri.sm/product-category/laptops/?wpam_id=229">Librem 14</a> ships with Heads pre-installed</p></div>
<p>We assume the reader has basic understanding of <a href="https://en.wikipedia.org/wiki/Digital_signature">cryptographic authentication</a>, but not <a href="https://en.wikipedia.org/wiki/Trusted_Computing">Trusted Computing</a>.</p>
<p>This article won&#39;t show how to <a href="https://osresearch.net/Install-and-Configure">install Heads</a> on your system.</p>
<p>We&#39;re also not going to talk about hardware. You should probably buy a device that is <a href="https://osresearch.net/Prerequisites#supported-devices">known to work</a> with Heads. Or make your life easy by buying one that already <a href="https://shop.puri.sm/product-category/laptops/?wpam_id=229">ships with Heads pre-installed</a>.</p>

<p>For context, I&#39;ll provide a chronological timeline of important developments on the road to Trusted Boot that was appropriate for Cypherpunk Security.</p>
<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/evil-maid-heads-pureboot_timeline1.png"><img loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1.png.pagespeed.ic.mWQFcyQrZS.png" alt="Visual timeline of the technology developed from 1999 (Coreboot) to 2019 (PureBoot)" width="3454" height="909" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1.png.pagespeed.ic.mWQFcyQrZS.png 3454w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-300x79.png.pagespeed.ic.6_6ETSRl0t.png 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-1024x269.png.pagespeed.ic.dFcBj-HO3I.png 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-768x202.png.pagespeed.ic.UodOBk37J7.png 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-1536x404.png.pagespeed.ic.IxaV9YKo9G.png 1536w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-2048x539.png.pagespeed.ic.F2vYW2ntjP.png 2048w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-150x39.png.pagespeed.ic.bzpXQAbCXD.png 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xevil-maid-heads-pureboot_timeline1-400x105.png.pagespeed.ic.toPKbBd2d0.png 400w" sizes="(max-width: 3454px) 100vw, 3454px"/></a></p>
<p>While Trusted Computing goes back to 1999, much of the technology for Trusted Boot was built over the next 20 years, closer to 2019.</p>


<p>This section will briefly describe the following technologies:</p>
<ol>
<li><a href="#coreboot">Coreboot</a></li>
<li><a href="#fde">Full Disk Encryption</a></li>
<li><a href="#secureboot">Secure Boot</a></li>
<li><a href="#tpm">The TPM</a></li>
<li><a href="#bootguard">Intel Boot Guard</a></li>
<li><a href="#evilmaid">(Anti) Evil Maid</a></li>
<li><a href="#tpmtotp">Beyond Anti Evil Maid (TPMTOTP)</a></li>
<li><a href="#heads">Heads</a></li>
<li><a href="#pureboot">PureBoot</a></li>
</ol>
<h2 id="coreboot">Coreboot</h2>
<div id="attachment_3138"><p><img aria-describedby="caption-attachment-3138" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcoreboot_logo1-300x259.jpg.pagespeed.ic.YQyOPhVi_O.jpg" alt="Coreboot Logo (icon of a bunny)" width="300" height="259" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcoreboot_logo1-300x259.jpg.pagespeed.ic.YQyOPhVi_O.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcoreboot_logo1-150x129.jpg.pagespeed.ic.Iyu9YzRbVf.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xcoreboot_logo1.jpg.pagespeed.ic._cQPn2J0tQ.jpg 400w" sizes="(max-width: 300px) 100vw, 300px"/></p><p id="caption-attachment-3138">Coreboot, the open-source firmware</p></div>
<p>Trusted Boot follows as a chain of trust. As you climb up the stack from the firmware to the OS, the previous link in the chain verifies the next link in the chain before it executes it.</p>
<p>It&#39;s super important that the very first link in the chain (the root of trust that is the first bit of code executed by the processor) is trustworthy. This root-of-trust firmware is your BIOS (aka &#34;UEFI Firmware&#34; on modern systems).</p>
<p>Unfortunately, most devices on the market used closed-source BIOS that can&#39;t be audited or patched by the community. This is important, because if an attacker compromises your firmware, their malware can persist even if you reinstall the OS or replace the HDD. <a href="https://www.zdnet.com/article/lenovo-rootkit-ensured-its-software-could-not-be-deleted/">Historically</a>, this <a href="https://www.pcworld.com/article/428561/hacking-teams-malware-uses-uefi-rootkit-to-survive-os-reinstalls.html">has</a> been a <a href="https://trmm.net/Thunderstrike/">problem</a>.</p>
<p>Fortunately, in 1999, a group of Linux hackers at <a href="https://en.wikipedia.org/wiki/Los_Alamos_National_Laboratory">LANL</a> wanted to fix this; they published &#34;Linux BIOS&#34;. In 2008, the project was <a href="https://mail.coreboot.org/pipermail/coreboot/2008-January/029135.html">renamed</a> to <a href="https://en.wikipedia.org/wiki/Coreboot">Coreboot</a>.</p>
<h2 id="fde">Full Disk Encryption</h2>
<div id="attachment_3143"><p><img aria-describedby="caption-attachment-3143" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xluks_logo1-150x150.png.pagespeed.ic.47D38R_P7I.png" alt="Icon of the LUKS project shows a safe&#39;s dial lock" width="150" height="150" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xluks_logo1-150x150.png.pagespeed.ic.47D38R_P7I.png 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xluks_logo1.png.pagespeed.ic.exX7Uzw8eY.png 240w" sizes="(max-width: 150px) 100vw, 150px"/></p><p id="caption-attachment-3143"><a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">LUKS</a>, the dominant Disk Encryption for Linux</p></div>
<p>Of course, it&#39;s assumed that you&#39;re using Full Disk Encryption (eg <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">LUKS</a> or <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">veracrypt</a>).</p>
<p>At some point you&#39;ll type a password to decrypt your disk. But how do you know that someone hasn&#39;t swapped your laptop with one that looks identical -- but this malicious laptop is merely going to relay your keystrokes to an attacker that&#39;s stolen your <em>real</em> laptop? You need a fast way for your computer to authenticate itself to <em>you</em> before you&#39;re prompted to type your FDE password.</p>
<h2 id="secureboot">Secure Boot</h2>
<p>Secure Boot was a <a href="https://en.wikipedia.org/wiki/UEFI#Secure_Boot_criticism">highly controversial</a> technology <a href="https://uefi.org/sites/default/files/resources/UEFI_2_3_1_C.pdf">released in 2012</a> as part of UEFI 2.3.1.</p>
<blockquote><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/150xNxtrammell_hudson_headshot1.jpg.pagespeed.ic.h00TrGSHIl.jpg" alt="Matthew Garrett Headshot" width="150"/></p>
<p>[Heads uses a] user provided GPG signing key (preferably in an external hardware token). This is a significant change from UEFI [Secure Boot], where the vendor and OEMs control the keys. It is important that updates and changes are signed by the user who installs them, not by random OEMs who may not have the best key management policies. We know that <a href="http://arstechnica.com/security/2015/06/stuxnet-spawn-infected-kaspersky-using-stolen-foxconn-digital-certificates/">stuxnet used stolen kernel driver certificates</a>, which were trusted by the OS.</p>
<p>-Trammell Hudson, creator of Heads</p></blockquote>
<p>Due to its <a href="https://arstechnica.com/information-technology/2015/06/stuxnet-spawn-infected-kaspersky-using-stolen-foxconn-digital-certificates/">design flaws</a>, Secure Boot was widely rejected by many in the security community, and many Operating Systems (<a href="https://www.qubes-os.org/faq/#is-secure-boot-supported">QubesOS included</a>) do not support it.</p>
<p>For cypherpunks, <a href="#heads">Heads</a> is a more suitable solution for Trusted Boot.</p>

<h2 id="tpm">The TPM</h2>
<div id="attachment_3015"><p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/TPM_Asus.jpeg"><img aria-describedby="caption-attachment-3015" loading="lazy" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xTPM_Asus-300x255.jpeg.pagespeed.ic.KAhhXHUSMG.jpg" alt="Photo of a TPM that&#39;s installed on an Asus motherboard" width="300" height="255" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xTPM_Asus-300x255.jpeg.pagespeed.ic.KAhhXHUSMG.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xTPM_Asus-768x652.jpeg.pagespeed.ic.YMndSMpC0t.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xTPM_Asus-150x127.jpeg.pagespeed.ic.R3vq6ddek7.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xTPM_Asus-400x340.jpeg.pagespeed.ic.IEDZSfAowH.jpg 400w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xTPM_Asus.jpeg.pagespeed.ic.3QWxHEdmXU.jpg 830w" sizes="(max-width: 300px) 100vw, 300px"/></a></p><p id="caption-attachment-3015">TPM installed on an Asus motherboard (<a href="https://en.wikipedia.org/wiki/Trusted_Platform_Module#/media/File:TPM_Asus.jpg">source</a>)</p></div>
<p>One of the main reasons I wrote this article was because I found it very difficult to find information about how the TPM plays into Heads. If you read the Purism documentation or google it, mostly what you find is that the TPM will only reveal its secret if the &#34;measurements&#34; match. But <strong>what the hell are these &#34;measurements&#34;</strong>?</p>
<p>First, the reason why most docs vaguely say &#34;measurements&#34; is because that&#39;s the word used in the official TPM specification (and, more generally, by the <a href="https://en.wikipedia.org/wiki/Trusted_Computing_Group">Trusted Computing Group</a>), and that spec intentionally doesn&#39;t define how such &#34;measurements&#34; are used.</p>
<blockquote><p>
A &#34;measurement&#34; is a cryptographic hash of a blob (of code and/or read-only data)</p>
<p>And &#34;measurements&#34; are a set of cryptographic hashes that are stored in a subset of the TPM&#39;s PCRs.
</p></blockquote>
<p>In the context of Trusted Boot with a TPM, <strong>a &#34;measurement&#34; is a cryptographic hash of a blob (of code and/or read-only data). And &#34;measurements&#34; are a set of cryptographic hashes that are stored in a subset of the TPM&#39;s PCRs</strong> (Platform Configuration Registers).</p>
<p>PCRs (as defined in the TPM spec) are a type of memory register that is volatile (ie its values are lost on reboot). It&#39;s also special in that you cannot actually write data to a PCR. To change the value of a PCR, you must use the <code>extend()</code> operation, which is <a href="https://trustedcomputinggroup.org/wp-content/uploads/TPM-Main-Part-3-Commands_v1.2_rev116_01032011.pdf">defined (Sec 16.1)</a> as follows:</p>
<h4>PCR<sub>new</sub> = Hash( PCR<sub>old</sub> + value )</h4>
<p>In <a href="https://trustedcomputinggroup.org/resource/tpm-main-specification/">TPM v1.2</a>, the hash algorithm was SHA-1. In <a href="https://trustedcomputinggroup.org/resource/tpm-library-specification/">TPM v2</a>, SHA-256 can be used.</p>
<p>If you&#39;re using Heads, then the actual &#34;measurements&#34; and which PCRs they&#39;re <code>extend()</code>ed to are listed <a href="https://osresearch.net/Keys/#tpm-pcrs">here</a>:</p>
<blockquote><p>
0: Nothing for the moment (Populated by binary blobs where applicable for SRTM)</p>
<p>1: Nothing for the moment</p>
<p>2: coreboot’s Boot block, ROM stage, RAM stage, Payload (Heads linux kernel and initrd)</p>
<p>3: Nothing for the moment</p>
<p>4: Boot mode (0 during /init, then recovery or normal-boot)</p>
<p>5: Heads Linux kernel modules</p>
<p>6: Drive LUKS headers</p>
<p>7: Heads user-specific files stored in CBFS (config.user, GPG keyring, etc).</p>
<p>(16): Used for TPM futurecalc of LUKS header when setting up a TPM disk encryption key
</p></blockquote>
<p>The TPM 1.2 spec also defines a number of important <a href="https://trustedcomputinggroup.org/wp-content/uploads/TPM-Main-Part-3-Commands_v1.2_rev116_01032011.pdf">storage operations (Sec 10)</a>, including</p>
<ol>
<li>TPM_Seal()</li>
<li>TPM_Unseal()</li>
</ol>
<p>These two functions are used to store (seal) and retrieve previously-stored (unseal) secrets into and out-of the TPM, respectively.</p>
<p>At the time that a secret is sealed into the TPM, you tell the TPM to note a subset of PCRs. When it comes time to unseal the secret, the TPM will only do so if the value of these PCRs exactly match what they were at the time the secret was sealed.</p>
<p><strong>Understanding these three TPM functions is critical to understanding Trusted Boot</strong>. If you&#39;re struggling to wrap your head around these three functions, I recommend watching the TPM explanations in the 10-20 minute sections of these two videos:</p>
<ol>
<li>Attacking Intel TXT (<a href="https://youtu.be/kja8ATnvW00?t=63">start @ 1m 03s</a> - 12m 15s)</li>
<li>Beyond Anti Evil Maid (<a href="https://media.ccc.de/v/32c3-7343-beyond_anti_evil_maid#t=1753">start @ 6m 20s</a> - 22m 13s)</li>
</ol>
<table>
<tbody><tr>
<td>
<iframe loading="lazy" width="560" height="315" src="https://www.youtube-nocookie.com/embed/kja8ATnvW00?start=63&amp;rel=0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe><br/>
</td></tr>

<tr>
<td>
<a href="https://en.wikipedia.org/wiki/Joanna_Rutkowska">Joanna Rutkowska</a> describes a TPM, PCRs, extend, seal/unseal, and TC &#34;measurements&#34;<br/>
</td></tr>

</tbody></table>
<p>Of course, anyone with physical access to your machine could force the TPM to unseal a secret if they could read the value of the blobs being &#34;measured&#34; and called the PCR <code>extend()</code> before calling <code>unseal()</code>. This is important to keep in mind because some tools that leverage the TPM will &#34;measure&#34; user input (eg a password), but many just &#34;measure&#34; blobs stored on the machine in plaintext.</p>
<p>These three functions of a TPM (<code>extend()</code>, <code>seal()</code>, <code>unseal()</code>) are general enough to be useful to Cyperpunks, and we&#39;ll see below how they were utilized by tools (eg Heads) to verify the integrity of a Trusted Boot chain.</p>
<h2 id="bootguard">Intel Boot Guard</h2>

<p>Intel Boot Guard (first released in June 2013) aimed to provide a way to verify the authenticity of the system&#39;s firmware. It can do this in two ways:</p>
<ol>
<li>Verified Boot (for Enterprises)</li>
<li>Measured Boot (for Cypherpunks)</li>
</ol>
<p>Boot Guard&#39;s Verified Boot mode checks that the firmware is signed by a key managed by the OEM. While this may be fine for Enterprises, it means that [a] if the vendor <a href="http://arstechnica.com/security/2015/06/stuxnet-spawn-infected-kaspersky-using-stolen-foxconn-digital-certificates/">doesn&#39;t follow good key management practices</a>, you could be at risk and [b] it literally prevents you from booting your computer if you modify the firmware yourself. This means that <a href="https://osresearch.net/FAQ/#why-use-ancient-thinkpads-instead-of-modern-macbooks">processors with Verified Boot cannot use Coreboot and cannot use Heads</a> and should not be trusted.</p>
<p>On the other hand, <strong>Intel Boot Guard&#39;s Measured Boot is actually good</strong>. Rather than preventing you from booting the computer, the Measured Boot mode just takes a cryptographic hash of the firmware and stores that in a PCR on the TPM so that subsequent steps (eg Heads) can check it during boot.</p>
<p>Unfortunately, you cannot toggle between Verified Boot and Measured Boot. They&#39;re permanently &#34;set&#34; by the OEM using <a href="https://en.wikipedia.org/wiki/EFuse">Field Programmable Fuses</a>.</p>

		
		


<h2 id="evilmaid">(Anti) Evil Maid</h2>
<p>The <a href="https://en.wikipedia.org/wiki/Evil_maid_attack">&#34;Evil Maid&#34;</a> attack was <a href="https://theinvisiblethings.blogspot.com/2009/01/why-do-i-miss-microsoft-bitlocker.html">coined</a> by <a href="https://en.wikipedia.org/wiki/Joanna_Rutkowska">Joanna Rutkowska</a> in 2009.</p>
<p>The &#34;Evil Maid Attack&#34; is one where the attacker (a maid of a hotel or cleaning staff of your office) gains physical access to your device when &#34;cleaning&#34; your hotel room or office while you&#39;re away. &#34;Anti-Evil Maid&#34; (or &#34;Trusted Boot&#34;) are mitigations of this attack that can alert us if the device&#39;s integrity has been modified in any way by an &#34;Evil Maid&#34;.</p>
<p>Rutkowska proposed a <a href="https://theinvisiblethings.blogspot.com/2009/10/evil-maid-goes-after-truecrypt.html">solution to the Evil Maid attack</a> that involved the user sealing a secret (eg a phrase or photo) into the TPM. Because of the TPM&#39;s design, it will only unseal (and display) the secret to the user if the &#34;measurements&#34; were valid (ie if the set of defined PCR registers had values exactly matching their values at the time the secret was sealed). And to to protect the secret, the PCR registers used to unseal it should be wiped after the user views the secret.</p>
<blockquote><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/150xNxjoanna_rutkowska_headshot1.jpg.pagespeed.ic.kvGQYM8W_y.jpg" alt="Joanna Rutkowska Headshot" width="150"/></p>
<p>-Joanna Rutkowska, coined &#34;Evil Maid&#34; attack</p></blockquote>
<p>She suggested that the secret stored in the TPM be a photo taken by the user, which is a form of <a href="https://pv-magazine-usa.com/2023/01/31/hvdc-transmission-line-to-connect-three-iso-regions/en.wikipedia.org/wiki/Knowledge-based_authentication">Knowledge-Based Authentication</a> that reminds me of a popular (yet unfortunately uncommon) anti-phishing tech known as <a href="https://en.wikipedia.org/wiki/SiteKey">SiteKey</a></p>
<p>But there&#39;s a problem with Rutkowska&#39;s Anti-Evil Maid solution: what if the attacker just boots your device, gets the secret, and then replaces your device with a malicious one that just outputs the secret and then prompts you for your password -- simulating your existing boot process, but relaying your password to the attacker?</p>
<p>An improvement to mitigate this is to encrypt the secret phrase (or photo) and always carry it with you (eg on a USB drive on your keyring) and not store the secret on your computer. Rather, the TPM stores the symmetric decryption key and that&#39;s only unsealed if the system is trustworthy (ie if the set of defined PCR registers had values exactly matching their values at the time the encryption key was sealed).</p>
<h2 id="tpmtotp">Beyond Anti Evil Maid (TPMTOTP)</h2>
<p>In 2015, (several years after Rutkowska&#39;s Anti-Evil Maid solution was published), <a href="https://en.wikipedia.org/wiki/Matthew_Garrett">Matthew Garrett</a> suggested <a href="https://mjg59.dreamwidth.org/35742.html">solving</a> the &#34;displaying the shared secret on boot&#34; problem with an OTP. Specifically, by using <a href="https://en.wikipedia.org/wiki/Time-based_one-time_password">TOTP</a>.</p>
<blockquote><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/150xNxmatthew_garrett_headshot1.jpg.pagespeed.ic._Y1l7Uucrv.jpg" alt="Matthew Garrett Headshot" width="150"/></p>
<p>Exposing a static secret [on boot] is a little bit sub-optimal. Ideally, we would not have a static secret. We would think of some sort of dynamic exposure -- something that changes over time. Something where merely having possession of a single instance of the secret being presented does not allow you to present the correct secret in the future. We want a shared secret with some sort of dynamic component..This is basically the design goal of TOTP -- the protocol that&#39;s used for the majority of 2FA.</p>
<p>-Matthew Garrett, creator of TPMTOTP</p></blockquote>
<p>One problem with this is that the TPM doesn&#39;t have a clock, which means the TOTP secret must be (temporarily) stored on the system&#39;s RAM in order to produce the 6-digit OTP code. When presenting Beyond Evil Maid at 32c3 in 2015, Garrett also pointed-out that <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine">Intel Management Engine</a> (with <a href="https://en.wikipedia.org/wiki/Direct_memory_access">Direct Memory Access</a>) was another huge security risk that could undermine Trusted Boot (or your whole OS post-boot).</p>
<p>Another vulnerability of Garrett&#39;s proposed TPMTOTP solution is a replay attack: an attacker could steal your laptop and leave behind an identical-looking malicious &#34;relay&#34; laptop. On booting the malicious relay laptop, it communicates out to your real laptop -- which relays the 6-digit OTP code down to the malicious laptop. You verify that the 6-digit OTP is correct and type your FDE decryption password -- which is relayed out to the attacker with your real laptop.</p>

<h2 id="heads">Heads</h2>
<p>One year after Garrett presented TPMTOTP, <a href="https://trmm.net/About/">Trammell Hudson</a> forked the idea to create <a href="https://osresearch.net/">Heads</a>. Hudson&#39;s version shrank the codebase to fit inside the SPI flash ROM, so the TOTP auth occurs sooner in the boot chain and reduces the attack surface.</p>
<p>Unlike (most) Enterprise Security solutions (eg &#34;Secure&#34; Boot), Heads actually has great documentation on the <a href="https://osresearch.net/Heads-threat-model/">threat models</a> that are and are not covered by their solution.</p>
<blockquote><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/150xNxtrammell_hudson_headshot1.jpg.pagespeed.ic.h00TrGSHIl.jpg" alt="Matthew Garrett Headshot" width="150"/></p>
<p>I&#39;m a huge fan of the TPM...I know in the Free Software Community it&#39;s been largely unwelcome...because of the way it&#39;s been used for DRM. Since we control the TPM from the first instruction in the boot block, we&#39;re able to use it in ways that <em>we</em> want to, so we don&#39;t have to enable DRM, but we can use it to protect our secrets.</p>
<p>-Trammell Hudson, creator of Heads</p></blockquote>
<p>Heads uses a lot of auth keys, and their docs clearly list each of <a href="https://osresearch.net/Keys/">the (private) keys</a> Heads uses and how they&#39;re protected.</p>


<p>Another feature added by Heads is the ability to set a <a href="https://theinvisiblethings.blogspot.com/2009/01/why-do-i-miss-microsoft-bitlocker.html">TPM Disk Unlock Key</a>. This allows LUKS users to store their symmetrically-encrypted FDE master key sealed inside the TPM. With this, you can only extract the master encryption key from the TPM if all the PCR registers match their expected values and the user enters the correct password. An important benefit here is that, because the key is sealed inside the TPM, you can do clever things like hardware rate limiting or have the key securely wiped after X failed attempts.</p>
<h2 id="pureboot">PureBoot</h2>
<p>A few years later, the company Purism was <a href="https://wp.puri.sm/posts/making-heads-more-usable-with-menus/">actively contributing</a> to improve the usability of Heads, and they came out with <a href="https://docs.puri.sm/PureBoot.html">PureBoot</a> in 2019.</p>
<p>PureBoot isn&#39;t a software project or a specific tool. It&#39;s a marketing term for the collection of <a href="https://wp.puri.sm/posts/pureboot-the-high-security-boot-process/">the following technologies</a>:</p>
<ol>
<li><s><a href="https://forums.puri.sm/t/librem-14s-me-disabled-but-not-neutralized/12238/31">Neutralized</a> and</s> <a href="https://puri.sm/learn/intel-me/">Disabled</a> IME</li>
<li>Coreboot</li>
<li>A TPM</li>
<li>Heads</li>
<li>The <a href="https://shop.puri.sm/product-category/usb-security-tokens/?wpam_id=229">Librem Key</a></li>
</ol>
<p>The addition of the Librem Key adds the following notable improvements to Heads:</p>
<ol>
<li>Usability</li>
<li>2FA Disk Decryption</li>
<li>PGP Smartcard</li>
</ol>
<p>While displaying a 6-digit token on-boot is a brilliant way to verify boot integrity, it&#39;s not practical because most people aren&#39;t <em>actually</em> going to pull out their phone and verify the OTP code.</p>
<p>The Librem Key (which is a <a href="https://wp.puri.sm/posts/the-librem-key-makes-tamper-detection-easy/">modified</a> version of the <a href="https://shop.nitrokey.com/shop/product/nkpr2-nitrokey-pro-2-3">Nitrokey Pro 2</a>) simplifies this with an LED that <a href="https://puri.sm/posts/pureboot-101-first-boot-first-update-and-detecting-software-tampering/">flashes green if everything is OK</a> or red if not.</p>


<p>Another benefit of the Librem Key is that you can generate PGP keys on it that cannot be extracted. This allows you to use <a href="https://docs.puri.sm/Librem_Key/Getting_Started/User_Manual.html#decrypt-luks-encrypted-drives-with-librem-key">2FA decryption</a> of your LUKS-encrypted drive (though, <a href="https://docs.puri.sm/Librem_Key/Getting_Started/User_Manual.html#decrypt-luks-encrypted-drives-with-librem-key">not easily</a>). And, of course, if the user always inserts their librem key to decrypt their disk at-boot, then they&#39;ll always be able to see the integrity LED at-boot.</p>
<p>And you can use the PGP key stored on your Librem Key to <a href="https://osresearch.net/BootOptions/#boot-config-files">sign all the files</a> in <code>/boot/</code> (to detect tampering of your linux kernel, for example).</p>


<h2>Processor, TPM Trust</h2>
<p>Trusted Boot only works if you can trust your processor and your TPM.</p>
<p>Most processors (since 2013) include a <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine">remote-access backdoor</a> that lives on a distinct microprocessor that can turn itself on (even when your machine is off), install software, and exfiltrate data from your system. Fortunately, this can be <a href="https://puri.sm/learn/intel-me/">disabled</a> <s>and mostly neutralized</s> (Update: IME neutralization <a href="https://forums.puri.sm/t/librem-14s-me-disabled-but-not-neutralized/12238/31">no longer works</a> on newer processors).</p>
<h2>Relay attack</h2>
<p>While the TOTP solution cleverly solves the re<strong>play</strong> attack, it&#39;s still vulnerable to a re<strong>lay</strong> attack.</p>
<p>An attacker could steal your laptop and leave behind an identical-looking malicious laptop. When you (unknowingly) boot the malicious relay laptop, it communicates out to your real laptop -- which relays the 6-digit OTP code down to the malicious laptop. You verify that the 6-digit OTP is correct and type your FDE decryption password -- which is relayed out to the attacker with your real laptop.</p>
<h2>Security vs Convenience</h2>
<p>While using a Hardware Security Key (eg Librem Key) is more convenient than using your phone&#39;s TOTP app, it&#39;s also less secure.</p>
<p>If someone gains access to both your laptop and your Librem Key, then they can change your firmware, reset your TPM, reset your Librem Key, and sync them all back up with each-other. This attack can happen, for example, [a] during the ~1/3 daily hours where you&#39;re not awake or [b] when you&#39;re going through a security screening and an authority demands that you pass your laptop and your keyring through a machine out of your sight (until we have metal-free hardware security keys or, uhh, <a href="https://en.wikipedia.org/wiki/Microchip_implant_(human)#Usage">subcutaneous</a> OpenPGP smartcards?).</p>
<p>The consequence is that the &#34;flashing green LED&#34; on-boot can give a false sense of security.</p>
<p>This sort of tampering can still be detected by double-checking the TOTP secret against your phone on-boot (assuming your phone is protected with a strong passphrase), but there inlies the tradeoff between Security &amp; Convenience.</p>
<h2>TOTP Secret</h2>
<p>If the TOTP secret is stolen by an adversary, then they could build a malicious replica of your device that simulates your authenticated boot process correctly (outputting a valid 6-digit OTP code) before prompting you for (and stealing) your password.</p>
<p>Because [a] the TOTP secret needs to be combined with the current time to produce an OTP code and [b] the TPM doesn&#39;t have an onboard clock, the TOTP secret is designed to be unsealed (as opposed, for example, an RSA key generated inside the TPM which cannot be exported from the TPM). This design means that if someone has physical access to the TPM, then they can <a href="https://osresearch.net/Keys/#tpmtotp-shared-secret">manually extend the PCR values</a> with to a known-good state to unseal/extract the TOTP secret.</p>
<p>Additionally, an attacker may also be able to steal the TOTP secret if you stored it on your phone; handsets are generally less secure devices since most people don&#39;t use strong passphrases on their mobile devices.</p>
<p>It shouldn&#39;t be possible to steal the TOTP (or HOTP) secret from a hardware security key.</p>

<h2>Suspend Attack</h2>
<p>Heads does not verify the integrity of your system when unsuspending your computer.</p>
<p>If you&#39;re using your laptop in an insecure place or moving it between secure spaces, it&#39;s best-practice to shutdown your computer -- not suspend.</p>
<p>For example: how would you know that your xscreensaver password prompt isn&#39;t a malicious simulation that&#39;ll relay your unlock password to your attacker?</p>
<p>To mitigate this risk:</p>
<ol>
<li>Shutdown your device (not suspend) when moving</li>
<li>Use a distinct passphrase for [a] booting (FDE decryption) and [b] screen unlock</li>
</ol>
<h2>Duress Password</h2>

<p>One thing I&#39;d really like to see Heads include is a <a href="https://en.wikipedia.org/wiki/Duress_code">duress password</a>.</p>
<p>Especially for users who store their FDE master key in the TPM, it would be great if a user could type a special string into the boot password prompt that would cause the TPM to reset, thereby rendering the entire disks&#39; contents permanently useless (eg if being forced to enter a password against your will).</p>
<h2>Nail Polish</h2>
<p>One of the best ways to make your device tamper-evident is very low-tech: (rainbow) <a href="https://trmm.net/Glitter/">glitter nail polish</a>.</p>
<table>
<tbody><tr>
<td>
<video controls="" width="100%"><source src="https://videos.puri.sm/promo/ai_v5_1080p.mp4" type="video/mp4"/><source src="https://videos.puri.sm/promo/ai_v5_1080p.webm" type="video/webm"/>Your browser does not support HTML video.</video><br/>
</td></tr>

<tr>
<td>
Glitter Nail Polish and PureBoot<br/>
</td></tr>

</tbody></table>

<ul>
<li><a href="https://blog.invisiblethings.org/papers/2015/x86_harmful.pdf">Intel x86 considered Harmful</a></li>
<li><a href="https://www.kicksecure.com/wiki/Verified_Boot">(Android) Verified Boot (dm-verity)</a></li>
<li><a href="https://trmm.net/NERF/">Linux Boot (NERF)</a></li>
<li><a href="https://trenchboot.org/FAQ/">Trench Boot</a></li>
</ul>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/2019/04/100x100xavatar_square_150.jpg.pagespeed.ic.lvLST4AWRQ.jpg" width="100" height="100" alt="headshot of Michael Altfield" itemprop="image"/></p><div><div itemprop="description"><p>Hi, I’m Michael Altfield. I write articles about opsec, privacy, and devops <a href="https://michaelaltfield.net/biography/">➡</a></p>
<p><a href="https://michaelaltfield.net/biography/">About Michael</a></p>
</div></div></div></div></div></div>
  </body>
</html>
