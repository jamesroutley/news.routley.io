<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://angelolloti.com/blog/crypto-space-heater">Original</a>
    <h1>Thermostatic Crypto Mining Rig/Space Heater</h1>
    
    <div id="readability-page-1" class="page"><div>   <div><div><div> <div><p><a href="https://angelolloti.com/blog/" data-svelte-h="svelte-6j3ym0">other posts</a> <span>10/27/2024</span></p></div></div> <p><a href="https://angelolloti.com/blog/?tag=crypto">crypto</a><span>, </span><a href="https://angelolloti.com/blog/?tag=hvac">hvac</a><span>, </span><a href="https://angelolloti.com/blog/?tag=microcontroller">microcontroller</a><span>, </span><a href="https://angelolloti.com/blog/?tag=mining">mining</a><span></span></p><!-- HTML_TAG_START --><p>Let me start this off by saying I really dislike electric space heaters. They use a ridiculous amount of electricity for the amount of heat that they produce. That might seem strange if you consider the fact that a space heater is nearly 100% efficient. Well, that depends on what metric you use. If your metric of efficiency is electricity to heat, a 1,000-Watt space heater generates exactly 1,000 Watts of heat. 1,000 Watts of heat is also equivalent to 5,120 BTU/hr. Surely, we can&#39;t get above 100% efficiency, right? Well, we actually can.</p>
<h3>Heat Pumps</h3>
<p>This is where a heat pump comes into play. Nowadays, many AC systems on the market will come with &#34;heat pump&#34; mode. What does a heat pump do? Basically a heat pump is a reverse AC. Normally, an AC will cool a space by pulling the heat into its refrigerant, carrying the hot refrigerant outside, and rejecting the heat into the environment. We are not creating cool air. We are simply moving hot air outside. A heat pump does the opposite. It pulls whatever heat it can from outside and &#34;rejects&#34; it into the space we are trying to heat. According to <a href="https://www.technologyreview.com/2023/02/14/1068582/everything-you-need-to-know-about-heat-pumps/">this article</a>, a heat pump by the same efficiency metric that we used before is 300% to 400% efficient. Awesome!</p>
<p>However, this blog post is not to talk about heat pumps. They are great pieces of technology which I would recommend over a space heater (although obviously a space heater is a lot smaller and cheaper than a heat pump AC system).</p>
<h3>Motivation</h3>
<p>My girlfriend lives in a rented bedrooom. She has asked the landlord increase the heat, but he refuses, saying it will get too hot upstairs for the other tenants. He mentioned that she may get an electric space heater for her room. Her utility bill is the same every month, so she may spend as much electricity as she wants in her room. Luckily, I have a space heater that I bought when I lived in a college dorm.</p>
<p><img src="https://angelolloti.com/crypto_1.jpg" alt="crypto mining rig"/></p>
<p>Yup, one of my biggest mistakes. Now, why do I call it an electric space heater? Well, it draws about 1,500 Watts, and any device that uses electricity produces heat. This means that this guy produces about 7,680 BTU/hr, which is enough to heat up a single bedroom. In fact, I used to run this in my dorm and would leave the windows open in the middle of an upstate New York winter to get the room down to a bearable temperature.</p>
<p>By the way, don&#39;t actually call it a space heater. The majority of campuses and lease agreements do not allow electric space heaters. A crypto mining rig is basically just a computer, which almost all campuses and lease agreements allow. Unless they make direct mention of crypto mining, it&#39;s all good.</p>
<h3>Problem</h3>
<p>I was able to endure the ridiculously high temperatures that my dorm reached because I knew the rig was making me money. Unfortunately, crypto mining is far less profitable now, and I don&#39;t want to turn my girlfriend&#39;s room into an oven. This means I need to control just how hot the room gets. I thought about using just an Arduino and a <a href="https://en.wikipedia.org/wiki/Thermistor">thermistor</a> to do this, but since I want her to be able to easily interface with it, I decided to purchase a <a href="https://www.amazon.com/dp/B018A3DHJY?ref=ppx_yo2ov_dt_b_fed_asin_title">used Honeywell thermostat</a> for $15.81 after tax.</p>
<p>The idea is to have the mining rig continuously run until the room reaches the set point on the thermostat. Once the set point is reached, the miner should stop. Once the room temperature drops a few degrees, the miner will start again.</p>
<h3>Using the Thermostat</h3>
<p>So we have this thermostat and this mining rig. How do we make them work together? All we need to know is what terminals to use on our thermostat for heating. The back of the thermostat looks like this.</p>
<p>Almost all thermostats across all brands follow the same color/letter scheme. A Google search will tell us that R means power and W means heating. When the measured temperature is less than the set point, the thermostat closes a switch between R and W using a <a href="https://en.wikipedia.org/wiki/Relay">relay</a>, allowing the flow of current. To determine whether the thermostat is calling for heating using an Arduino, we would need one of our digital read pins going to W and the R terminal going to ground. If the pin measures high, that means we have a call for heating.</p>
<p><img src="https://angelolloti.com/crypto_3.jpg" alt="wiring between thermostat and arduino"/></p>
<p>At this point, we have a couple of ways we could control the mining rig. However, I would like to do it using serial communication via USB. When the Arduino detects the thermostat is either calling for heating or not, it will send that information on the serial line. At this point, the mining rig will have a script running on it to receive information from the Arduino.</p>
<p>Since I am using <a href="https://hiveon.com/knowledge-base/guides/what_is_hive/">HiveOS</a>, a free operating system for crypto mining, I can just execute the bash commands <code>miner start</code> and <code>miner stop</code> to control the miner.</p>
<h4>Caveats</h4>
<ul>
<li>Because the thermostat uses a mechanical relay that electrically isolates the coil side from the load side, a +5V DC signal from an Arduino will work just fine. If we were using a thermostat that internally uses a <a href="https://en.wikipedia.org/wiki/Field-effect_transistor">FET</a> and only expects 24V AC, we may run into issues.</li>
<li>Depending on the thermostat that is used, it may be more likely to short cycle. This means we will be constantly starting and stopping and the miner. If the thermostat that is used tends to short cycle, then that will have to be prevented in code.</li>
<li>When communicating over serial, the same baud rate must be used on the device that is sending and the device that is receiving.</li>
</ul>
<h3>Arduino Code</h3>
<p>First, let&#39;s establish the pin that we will connect W to and store it in a constant <code>W_PIN</code>.</p>
<pre><code><span>#<span>define</span> W_PIN 2</span>
</code></pre><p>Next, we write our setup code. All we need to do is make the <code>W_PIN</code> an input with a pull-up resistor. Doing this allows the pin to read <code>HIGH</code> when the circuit is open and <code>LOW</code> when the thermostat closes the circuit between <code>R</code> and <code>W</code>. We also need to establish the serial communication baud rate using <code>Serial.begin</code>. A baud rate of <code>9600</code> must also be used on the receiving end.</p>
<pre><code><span><span>void</span> <span>setup</span><span>()</span> </span>{
  <span>pinMode</span>(W_PIN, INPUT_PULLUP);
  Serial.<span>begin</span>(<span>9600</span>);
}
</code></pre><p>Finally, let&#39;s get the state of the <code>W_PIN</code>. If we use digitalRead, the only possible results are <code>HIGH</code> and <code>LOW</code>. Let&#39;s send 1 for <code>LOW</code> and 0 for <code>HIGH</code> since <code>LOW</code> would mean the thermostat is calling for heating.</p>
<pre><code><span><span>void</span> <span>loop</span><span>()</span> </span>{
  Serial.<span>write</span>(<span>digitalRead</span>(W_PIN) == LOW ? <span>1</span> : <span>0</span>);
}
</code></pre><p>That&#39;s all the Arduino code. I would like to keep it minimal since any other logic can be done in a script running on the rig.</p>
<h3>Miner Code</h3>
<p>The following Python code can be used to read the serial port at a baud rate of 9600.</p>
<pre><code><span>import</span> serial

ser = serial.Serial(<span>&#39;&lt;&lt;DEVICE PATH HERE&gt;&gt;&#39;</span>, <span>9600</span>)
<span>while</span> <span>True</span>:
    <span>print</span>(ser.read())
</code></pre><p>To determine the device&#39;s serial port path, you can use the following command on HiveOS.</p>
<pre><code>root@rig2D4AFF:~# ls /dev/serial/by-id/
usb-Arduino__www.arduino.cc__0043_7503530313035130B1C1-if00
</code></pre><p>So, the path to my Arduino is <code>/dev/serial/by-id/usb-Arduino__www.arduino.cc__0043_7503530313035130B1C1-if00</code>.</p>
<p>Running the script with this path, it will print 1&#39;s when there is a call for heating and 0&#39;s when there is not.</p>
<p>Let&#39;s modify our code to actually send the appropriate commands to the miner. We also want this script automatically retry whenever it encounters an error such as Arduino not being plugged in. This is because I plan to have this script run at startup and hopefully never crash.</p>
<pre><code><span>from</span> serial <span>import</span> Serial
<span>from</span> subprocess <span>import</span> call
<span>from</span> time <span>import</span> sleep

<span>while</span> <span>True</span>:
    <span>try</span>:
        ser = Serial(<span>&#39;&lt;&lt;DEVICE PATH HERE&gt;&gt;&#39;</span>, <span>9600</span>) 
        prev_val = <span>None</span> 

        <span>while</span> <span>True</span>:
            val = ser.read()[<span>0</span>]
            <span>if</span> val == prev_val: 
                <span>continue</span>
            <span>if</span> val == <span>1</span>:
                call([<span>&#39;miner&#39;</span>, <span>&#39;start&#39;</span>]) 
            <span>elif</span> val == <span>0</span>:
                call([<span>&#39;miner&#39;</span>, <span>&#39;stop&#39;</span>])
            <span>else</span>:
                <span>print</span>(<span>&#39;device should only send 1 or 0; got&#39;</span>, val)
            prev_val = val

    <span>except</span>:
        <span>print</span>(<span>&#39;arduino not found, retrying in 5 seconds&#39;</span>)
        sleep(<span>5</span>)
</code></pre><p>Now, let&#39;s make this script run at startup in the background. I was trying to get this working using Systemctl, but I simply could not. I turned to <a href="https://github.com/thagrol/Guides/blob/main/boot.pdf">this book</a> which provides an incredibly simple way to use cron for this task. </p>
<p><img src="https://angelolloti.com/crypto_2.png" alt="how to schedule a boot script with crontab"/></p>
<p>After all that, I restarted the rig and it worked as intended. Short cycling turned out not to be a problem. This is because even after the miner stops running, the card still holds a lot of thermal energy. Since the card regulates its fans at all times, the card&#39;s fans will continue to run for a few minutes, allowing the room to get just a little bit hotter even after the miner has stopped. Additionally, this rig still uses ~400W at idle, which is a pretty good amount to maintain the room&#39;s temperature.</p>
<p>And voila. I tried to make it look as nice as possible using the hardware I had available to me. I jammed a piece of cardboard behind the Arduino to make sure none of the pins would accidentally short out agains the metal plate.</p>
<p><img src="https://angelolloti.com/crypto_4.jpg" alt="finished product"/></p>
<!-- HTML_TAG_END --></div></div> 
			
			
		</div></div>
  </body>
</html>
