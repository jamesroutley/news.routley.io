<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/litements/s3sqlite">Original</a>
    <h1>Show HN: Query SQLite files stored in S3</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<blockquote>
<p dir="auto">Query SQLite databases in S3 using s3fs</p>
</blockquote>
<p dir="auto"><a href="https://rogerbinns.github.io/apsw/" rel="nofollow">APSW</a> SQLite VFS. This VFS enables reading
databases from S3 using
<a href="https://s3fs.readthedocs.io/en/latest/index.html" rel="nofollow">s3fs</a>. This only supports
reading operations, any operation that tries to modify the DB file is ignored.</p>
<p dir="auto">Inspired by <a href="https://github.com/uktrade/sqlite-s3vfs">sqlite-s3vfs</a> and
<a href="https://github.com/michalc/sqlite-s3-query">sqlite-s3-query</a>.</p>
<h2 dir="auto"><a id="user-content-notes-about-journal-mode" aria-hidden="true" href="#notes-about-journal-mode"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Notes about journal mode</h2>
<p dir="auto">This VFS will only work when the DB file is in any journal mode that is <strong>not</strong>
<a href="https://sqlite.org/wal.html" rel="nofollow">WAL</a>. However, it will work if you set the journal
mode to something else just before uploading the file to S3. You can (and
probably should) use WAL mode to generate the DB. Then you can change the
journal mode (and the page size if you neeed) before uploading it to S3.</p>
<p dir="auto">The test suite
<a href="https://github.com/litements/s3sqlite/blob/3719f1ce50a7b5cfae754776bc9b2c17292f8d72/test.py#L198">includes</a>
tests for that use case. Take into account that the page size can&#39;t be changed
when the database is in WAL mode. You need to change it before setting the WAL
mode or by setting the database to rollback journal mode. <a href="https://www.sqlite.org/pragma.html#pragma_page_size" rel="nofollow">You need to execute
<code>VACUUM;</code> after changing the page
size</a> in a SQLite database.</p>
<h2 dir="auto"><a id="user-content-example-usage" aria-hidden="true" href="#example-usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Example usage</h2>
<div dir="auto" data-snippet-clipboard-copy-content="import s3fs
import s3sqlite
import apsw

# Create an S3 filesystem. Check the s3fs docs for more examples:
# https://s3fs.readthedocs.io/en/latest/
s3 = s3fs.S3FileSystem(
    key=&#34;somekey&#34;,
    secret=&#34;secret&#34;,
    client_kwargs={&#34;endpoint_url&#34;: &#34;http://...&#34;},
)

s3vfs = s3sqlite.S3VFS(name=&#34;s3-vfs&#34;, fs=s3)

# Define the S3 location
key_prefix = &#34;mybucket/awesome.sqlite3&#34;

# Upload the file to S3
s3vfs.upload_file(&#34;awesome.sqlite3&#34;, dest=key_prefix)

# Create a database and query it
with apsw.Connection(
    key_prefix, vfs=s3vfs.name, flags=apsw.SQLITE_OPEN_READONLY
) as conn:

    cursor = conn.execute(&#34;...&#34;)
    print(cursor.fetchall())
"><pre><span>import</span> <span>s3fs</span>
<span>import</span> <span>s3sqlite</span>
<span>import</span> <span>apsw</span>

<span># Create an S3 filesystem. Check the s3fs docs for more examples:</span>
<span># https://s3fs.readthedocs.io/en/latest/</span>
<span>s3</span> <span>=</span> <span>s3fs</span>.<span>S3FileSystem</span>(
    <span>key</span><span>=</span><span>&#34;somekey&#34;</span>,
    <span>secret</span><span>=</span><span>&#34;secret&#34;</span>,
    <span>client_kwargs</span><span>=</span>{<span>&#34;endpoint_url&#34;</span>: <span>&#34;http://...&#34;</span>},
)

<span>s3vfs</span> <span>=</span> <span>s3sqlite</span>.<span>S3VFS</span>(<span>name</span><span>=</span><span>&#34;s3-vfs&#34;</span>, <span>fs</span><span>=</span><span>s3</span>)

<span># Define the S3 location</span>
<span>key_prefix</span> <span>=</span> <span>&#34;mybucket/awesome.sqlite3&#34;</span>

<span># Upload the file to S3</span>
<span>s3vfs</span>.<span>upload_file</span>(<span>&#34;awesome.sqlite3&#34;</span>, <span>dest</span><span>=</span><span>key_prefix</span>)

<span># Create a database and query it</span>
<span>with</span> <span>apsw</span>.<span>Connection</span>(
    <span>key_prefix</span>, <span>vfs</span><span>=</span><span>s3vfs</span>.<span>name</span>, <span>flags</span><span>=</span><span>apsw</span>.<span>SQLITE_OPEN_READONLY</span>
) <span>as</span> <span>conn</span>:

    <span>cursor</span> <span>=</span> <span>conn</span>.<span>execute</span>(<span>&#34;...&#34;</span>)
    <span>print</span>(<span>cursor</span>.<span>fetchall</span>())</pre></div>
<h2 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h2>
<div data-snippet-clipboard-copy-content="python3 -m pip install s3sqlite"><pre><code>python3 -m pip install s3sqlite
</code></pre></div>
<h2 dir="auto"><a id="user-content-run-tests" aria-hidden="true" href="#run-tests"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Run tests</h2>
<p dir="auto">The testing script will use the <a href="https://github.com/lerocha/chinook-database/">Chinook
database</a>, it will modify (and
<code>VACUUM;</code>) the file to use all the possible combinations of journal modes and
page sizes</p>
<ol dir="auto">
<li>Download the chinook database:</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="curl https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite_AutoIncrementPKs.sqlite -o chinook.sqlite3"><pre>curl https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite_AutoIncrementPKs.sqlite -o chinook.sqlite3</pre></div>
<ol start="2" dir="auto">
<li>Make sure you have Docker installed.</li>
</ol>
<p dir="auto">The testing script will start a <a href="https://min.io/" rel="nofollow">MinIO</a> container to run the
tests locally. After the tests finish, the container will be stopped
atuomatically.</p>
<ol start="3" dir="auto">
<li>Run the tests:</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="python3 -m pytest test.py"><pre>python3 -m pytest test.py</pre></div>
<h2 dir="auto"><a id="user-content-alternatives" aria-hidden="true" href="#alternatives"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Alternatives</h2>
<ul dir="auto">
<li><a href="https://github.com/uktrade/sqlite-s3vfs">sqlite-s3vfs</a>: This VFS stores the
SQLite file as separate DB pages. This enables having a single writer without
having to overwrite the whole file. <code>s3sqlite</code>&#39;s main difference is that this
just needs uploading a single file to S3. <code>sqlite-s3vfs</code> will split the
database in pages and upload the pages separately to a bucket prefix. Having
just a single file has some advantages, like making use of object <a href="https://s3fs.readthedocs.io/en/latest/index.html?highlight=version#bucket-version-awareness" rel="nofollow">versioning
in the
bucket</a>.
I also think that relying on
<a href="https://s3fs.readthedocs.io/en/latest/index.html" rel="nofollow">s3fs</a> makes the VFS more
<a href="https://s3fs.readthedocs.io/en/latest/index.html#s3-compatible-storage" rel="nofollow">flexible</a>
than calling <code>boto3</code> as <code>sqlite3-s3vfs</code> does.</li>
<li><a href="https://github.com/michalc/sqlite-s3-query">sqlite-s3-query</a>: This VFS is very
similar to <code>s3sqlit</code>, but it uses <code>ctypes</code> directly to create the VFS and uses
<code>httpx</code> to make requests to S3.</li>
</ul>
<p dir="auto">I decided to create a new VFS that didn&#39;t require using <code>ctypes</code> so that it&#39;s
easier to understand and maintain, but I still want to have a single file in S3
(vs. separate DB pages). At the same time, by using
<a href="https://s3fs.readthedocs.io/en/latest/" rel="nofollow">s3f3</a> I know I can use any S3
storage supported by that library.</p>
<h2 dir="auto"><a id="user-content-other" aria-hidden="true" href="#other"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Other</h2>
<p dir="auto">The Chinook database used for testing can be obtained from: <a href="https://github.com/lerocha/chinook-database/">https://github.com/lerocha/chinook-database/</a></p>
<p dir="auto">The testing section in this README contains a command you can run to get the file.</p>
<h2 dir="auto"><a id="user-content-license" aria-hidden="true" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>License</h2>
<p dir="auto">Distributed under the Apache 2.0 license. See <code>LICENSE</code> for more information.</p>
</article>
          </div></div>
  </body>
</html>
