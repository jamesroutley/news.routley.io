<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.tweag.io/blog/2022-11-01-hard-user-separation-with-nixos/">Original</a>
    <h1>Hard User Separation with NixOS</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>This guide explains how to install NixOS on a computer, with a twist.</p>
<p>If you use the same computer in different contexts, let’s say for work
and for your private life, you may wish to install two different
operating systems to protect your private life data from mistakes or
hacks from your work. For instance a cryptolocker you got from a
compromised work email won’t lock out your family photos.</p>
<p>But then you have two different operating systems to manage, and you
may consider that it’s not worth the effort and simply use the same
operating system for your private life and for work, at the cost of
the security you desired.</p>
<p>I offer you a third alternative, a single NixOS managing two securely
separated contexts. You choose your context at boot time, and you can
configure both context from either of them.</p>
<p>You can safely use the same machine at work with your home directory and
confidential documents, and you can get into your personal context with
your private data by doing a reboot. Compared to a dual boot system, you
have the benefits of a single system to manage and no duplicated package.</p>
<p>For this guide, you need a system either physical or virtual that is
supported by NixOS, and some knowledge like using a command line. You
don’t necessarily need to understand all the commands. The system disk
will be erased during the process.</p>
<p>You can find an example of NixOS configuration files to help
you understand the structure of the setup on <a href="https://github.com/tweag/nixos-specialisation-dual-boot">this GitHub
repository</a>.</p>
<h2 id="disks"><a href="#disks" aria-label="disks permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Disks</h2>
<p>Here is a diagram showing the whole setup and the partitioning.</p>
<p><span>
      <a href="https://www.tweag.io/static/1ccb81a52eb667a0fc5ef6811ca5a958/ea64c/setup-diagram.png" target="_blank" rel="noopener">
    <span></span>
  <img alt="Picture showing a diagram of disks and partitions" title="Picture showing a diagram of disks and partitions" src="https://www.tweag.io/static/1ccb81a52eb667a0fc5ef6811ca5a958/fcda8/setup-diagram.png" srcset="/static/1ccb81a52eb667a0fc5ef6811ca5a958/12f09/setup-diagram.png 148w,
/static/1ccb81a52eb667a0fc5ef6811ca5a958/e4a3f/setup-diagram.png 295w,
/static/1ccb81a52eb667a0fc5ef6811ca5a958/fcda8/setup-diagram.png 590w,
/static/1ccb81a52eb667a0fc5ef6811ca5a958/efc66/setup-diagram.png 885w,
/static/1ccb81a52eb667a0fc5ef6811ca5a958/ea64c/setup-diagram.png 1116w" sizes="(max-width: 590px) 100vw, 590px" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<h3 id="partitioning"><a href="#partitioning" aria-label="partitioning permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Partitioning</h3>
<p>We will create a 512 MB space for the /boot partition that will contain
the kernels, and allocate the space left for an LVM partition we can
split later.</p>
<div data-language="shell"><pre><code><span>parted</span> /dev/sda -- mklabel gpt
<span>parted</span> /dev/sda -- mkpart ESP fat32 1MiB 512MiB
<span>parted</span> /dev/sda -- mkpart primary 512MiB <span>100</span>%
<span>parted</span> /dev/sda -- mkpart <span>set</span> <span>1</span> esp on</code></pre></div>
<p>Note that these instructions are valid for UEFI systems, for older
systems you can refer to the NixOS manual to create a MBR partition.</p>
<p>In <a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-partitioning">the NixOS Manual</a>
you can find documentation with regard to disks and partitioning.</p>
<h3 id="create-lvm-volumes"><a href="#create-lvm-volumes" aria-label="create lvm volumes permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create LVM volumes</h3>
<p>We will use LVM so we need to initialize the partition and create a
Volume Group with all the free space.</p>
<div data-language="shell"><pre><code>pvcreate /dev/sda2
vgcreate pool /dev/sda2</code></pre></div>
<p>We will then create three logical volumes, one for the store and two
for our environments:</p>
<div data-language="shell"><pre><code>lvcreate -L 15G -n root-private pool
lvcreate -L 15G -n root-work pool
lvcreate -l <span>100</span>%FREE -n nix-store pool</code></pre></div>
<p>NOTE: The sizes to assign to each volume is up to you, the nix store
should have at least 30GB for a system with graphical sessions. LVM
allows you to keep free space in your volume group so you can increase
your volumes size later when needed.</p>
<h3 id="encryption"><a href="#encryption" aria-label="encryption permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Encryption</h3>
<p>We will enable encryption for the three volumes, but we want the nix-store
partition to be unlockable with either of the keys used for the two
root partitions. This way, you don’t have to type two passphrases at boot.</p>
<div data-language="shell"><pre><code>cryptsetup luksFormat /dev/pool/root-work
cryptsetup luksFormat /dev/pool/root-private
cryptsetup luksFormat /dev/pool/nix-store 
cryptsetup luksAddKey /dev/pool/nix-store </code></pre></div>
<p>We unlock our partitions to be able to format and mount them. Which
passphrase is used to unlock the nix-store doesn’t matter.</p>
<div data-language="shell"><pre><code>cryptsetup luksOpen /dev/pool/root-work crypto-work
cryptsetup luksOpen /dev/pool/root-private crypto-private
cryptsetup luksOpen /dev/pool/nix-store nix-store</code></pre></div>
<p>Please note we don’t encrypt the boot partition, which is the default
on most encrypted Linux setup. While this could be achieved, this adds
complexity that I don’t want to cover in this guide.</p>
<p>Note: the nix-store partition isn’t called <code>crypto-nix-store</code> because we
want the nix-store partition to be unlocked after the root partition to
reuse the password. The code generating the ramdisk takes the unlocked
partitions’ names in alphabetical order, by removing the prefix <code>crypto</code>
the partition will always be after the root partitions.</p>
<h3 id="formatting"><a href="#formatting" aria-label="formatting permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Formatting</h3>
<p>We format each partition using ext4, a performant file-system which
doesn’t require maintenance. You can use other filesystems, like xfs or btrfs,
if you need features specific to them.</p>
<div data-language="shell"><pre><code>mkfs.ext4 /dev/mapper/crypto-work
mkfs.ext4 /dev/mapper/crypto-private
mkfs.ext4 /dev/mapper/nix-store</code></pre></div>
<h3 id="the-boot-partition"><a href="#the-boot-partition" aria-label="the boot partition permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The boot partition</h3>
<p>The boot partition should be formatted using fat32 when using UEFI with
<code>mkfs.fat -F 32 /dev/sda1</code>. It can be formatted in ext4 if you are using
legacy boot (MBR).</p>
<h2 id="preparing-the-system"><a href="#preparing-the-system" aria-label="preparing the system permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preparing the system</h2>
<p>Mount the partitions onto <code>/mnt</code> and its subdirectories to prepare for
the installer.</p>
<div data-language="shell"><pre><code><span>mount</span> /dev/mapper/crypto-work /mnt
<span>mkdir</span> -p /mnt/etc/nixos /mnt/boot /mnt/nix
<span>mount</span> /dev/mapper/nix-store /mnt/nix
<span>mkdir</span> /mnt/nix/config
<span>mount</span> --bind /mnt/nix/config /mnt/etc/nixos
<span>mount</span> /dev/sda1 /mnt/boot</code></pre></div>
<p>We generate a configuration file:</p>
<div data-language="shell"><pre><code>nixos-generate-config --root /mnt</code></pre></div>
<p>Edit <code>/mnt/etc/nixos/hardware-configuration.nix</code> to change the following parts:</p>
<div data-language="nix"><pre><code>fileSystems<span>.</span><span>&#34;/&#34;</span> <span>=</span>
  <span>{</span> device <span>=</span> <span>&#34;/dev/disk/by-uuid/xxxxxxx-something&#34;</span><span>;</span>
    fsType <span>=</span> <span>&#34;ext4&#34;</span><span>;</span>
  <span>}</span><span>;</span>

boot<span>.</span>initrd<span>.</span>luks<span>.</span>devices<span>.</span><span>&#34;crypto-work&#34;</span> <span>=</span> <span>&#34;/dev/disk/by-uuid/xxxxxx-something&#34;</span><span>;</span></code></pre></div>
<p>by</p>
<div data-language="nix"><pre><code>fileSystems<span>.</span><span>&#34;/&#34;</span> <span>=</span>
  <span>{</span> device <span>=</span> <span>&#34;/dev/mapper/crypto-work&#34;</span><span>;</span>
    fsType <span>=</span> <span>&#34;ext4&#34;</span><span>;</span>
  <span>}</span><span>;</span>

boot<span>.</span>initrd<span>.</span>luks<span>.</span>devices<span>.</span><span>&#34;crypto-work&#34;</span> <span>=</span> <span>&#34;/dev/pool/root-work&#34;</span><span>;</span></code></pre></div>
<p>We need two configuration files to describe our two environments, we will
use <code>hardware-configuration.nix</code> as a template and apply changes to it.</p>
<div data-language="shell"><pre><code><span>sed</span> <span>&#39;/imports =/,+3d&#39;</span> /mnt/etc/nixos/hardware-configuration.nix <span>&gt;</span> /mnt/etc/nixos/work.nix
<span>sed</span> <span>&#39;/imports =/,+3d ; s/-work/-private/g&#39;</span> /mnt/etc/nixos/hardware-configuration.nix <span>&gt;</span> /mnt/etc/nixos/private.nix
<span>rm</span> /mnt/etc/nixos/hardware-configuration.nix</code></pre></div>
<p>Edit <code>/mnt/etc/nixos/configuration.nix</code> to make the <code>imports</code> code at
the top of the file look like this:</p>
<div data-language="nix"><pre><code>imports <span>=</span>
  <span>[</span>
    <span>./work.nix</span>
    <span>./private.nix</span>
  <span>]</span><span>;</span></code></pre></div>
<p>Remember we removed the file <code>/mnt/etc/nixos/hardware-configuration.nix</code>
so it shouldn’t be imported anymore.</p>
<p>Now we need to hook each configuration to become a different boot entry,
using the NixOS feature called <a href="https://www.tweag.io/blog/2022-08-18-nixos-specialisations/">specialisation</a>. We will make
the environment you want to be the default in the boot entry as a
non-specialised environment and non-inherited so it’s not picked up by
the other, and a specialisation for the other environment.</p>
<p>For the hardware configuration files, we need to wrap them with some
code to create a specialisation, and the “non-specialisation” case that
won’t propagate to the other specialisations.</p>
<p>Starting from a file looking like this, some code must be added at the
top and bottom of the files depending on if you want it to be the default
context or not.</p>
<p>Content of an example file:</p>
<div data-language="nix"><pre><code><span>{</span> config<span>,</span> pkgs<span>,</span> modulesPath<span>,</span> <span>.</span><span>.</span><span>.</span> <span>}</span><span>:</span>
<span>{</span>
  boot<span>.</span>initrd<span>.</span>availableKernelModules <span>=</span> <span>[</span><span>&#34;ata_generic&#34;</span> <span>&#34;uhci_hcd&#34;</span> <span>&#34;ehci_pci&#34;</span> <span>&#34;ahci&#34;</span> <span>&#34;usb_storage&#34;</span> <span>&#34;sd_mod&#34;</span><span>]</span><span>;</span>
  boot<span>.</span>initrd<span>.</span>kernelModules <span>=</span> <span>[</span><span>&#34;dm-snapshot&#34;</span><span>]</span><span>;</span>
  boot<span>.</span>kernelModules <span>=</span> <span>[</span><span>&#34;kvm-intel&#34;</span><span>]</span><span>;</span>
  boot<span>.</span>extraModulePackages <span>=</span> <span>[</span><span>]</span><span>;</span>

  fileSystems<span>.</span><span>&#34;/&#34;</span> <span>=</span> <span>{</span>
    device <span>=</span> <span>&#34;/dev/mapper/crypto-private&#34;</span><span>;</span>
    fsType <span>=</span> <span>&#34;ext4&#34;</span><span>;</span>
  <span>}</span><span>;</span>

  <span>-</span><span>-</span><span>-</span><span>8</span><span>&lt;</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>
  <span>[</span>more code here<span>]</span>
  <span>-</span><span>-</span><span>-</span><span>8</span><span>&lt;</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>

  swapDevices <span>=</span> <span>[</span><span>]</span><span>;</span>
  networking<span>.</span>useDHCP <span>=</span> lib<span>.</span>mkDefault <span>true</span><span>;</span>
  hardware<span>.</span>cpu<span>.</span>intel<span>.</span>updateMicrocode <span>=</span> lib<span>.</span>mkDefault config<span>.</span>hardware<span>.</span>enableRedistributableFirmware<span>;</span>
<span>}</span></code></pre></div>
<p>Example result of the default context (<a href="https://github.com/tweag/nixos-specialisation-dual-boot/blob/master/configuration/private.nix">See on GitHub</a>):</p>
<div data-language="nix"><pre><code><span>(</span><span>{</span> lib<span>,</span> config<span>,</span> pkgs<span>,</span> <span>.</span><span>.</span><span>.</span><span>}</span><span>:</span> <span>{</span>
  config <span>=</span> lib<span>.</span>mkIf <span>(</span>config<span>.</span>specialisation <span>!=</span> <span>{</span><span>}</span><span>)</span> <span>{</span>

    boot<span>.</span>initrd<span>.</span>availableKernelModules <span>=</span> <span>[</span><span>&#34;ata_generic&#34;</span> <span>&#34;uhci_hcd&#34;</span> <span>&#34;ehci_pci&#34;</span> <span>&#34;ahci&#34;</span> <span>&#34;usb_storage&#34;</span> <span>&#34;sd_mod&#34;</span><span>]</span><span>;</span>
    boot<span>.</span>initrd<span>.</span>kernelModules <span>=</span> <span>[</span><span>&#34;dm-snapshot&#34;</span><span>]</span><span>;</span>
    boot<span>.</span>kernelModules <span>=</span> <span>[</span><span>&#34;kvm-intel&#34;</span><span>]</span><span>;</span>
    boot<span>.</span>extraModulePackages <span>=</span> <span>[</span><span>]</span><span>;</span>

    fileSystems<span>.</span><span>&#34;/&#34;</span> <span>=</span> <span>{</span>
      device <span>=</span> <span>&#34;/dev/mapper/crypto-private&#34;</span><span>;</span>
      fsType <span>=</span> <span>&#34;ext4&#34;</span><span>;</span>
    <span>}</span><span>;</span>

    <span>-</span><span>-</span><span>-</span><span>8</span><span>&lt;</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>
    <span>[</span>more code here<span>]</span>
    <span>-</span><span>-</span><span>-</span><span>8</span><span>&lt;</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>

    swapDevices <span>=</span> <span>[</span><span>]</span><span>;</span>
    networking<span>.</span>useDHCP <span>=</span> lib<span>.</span>mkDefault <span>true</span><span>;</span>
    hardware<span>.</span>cpu<span>.</span>intel<span>.</span>updateMicrocode <span>=</span> lib<span>.</span>mkDefault config<span>.</span>hardware<span>.</span>enableRedistributableFirmware<span>;</span>

  <span>}</span><span>;</span>
<span>}</span><span>)</span></code></pre></div>
<p>Note the extra leading <code>(</code> character that must also be added at the
very beginning.</p>
<p>Example result for a specialisation named <code>work</code> (<a href="https://github.com/tweag/nixos-specialisation-dual-boot/blob/master/configuration/work.nix">See on GitHub</a>):</p>
<div data-language="nix"><pre><code><span>{</span> config<span>,</span> lib<span>,</span> pkgs<span>,</span> modulesPath<span>,</span> <span>.</span><span>.</span><span>.</span> <span>}</span><span>:</span>
<span>{</span>
  specialisation <span>=</span> <span>{</span>
  work<span>.</span>configuration <span>=</span> <span>{</span>
  system<span>.</span>nixos<span>.</span>tags <span>=</span> <span>[</span> <span>&#34;work&#34;</span> <span>]</span><span>;</span>

    boot<span>.</span>initrd<span>.</span>availableKernelModules <span>=</span> <span>[</span><span>&#34;ata_generic&#34;</span> <span>&#34;uhci_hcd&#34;</span> <span>&#34;ehci_pci&#34;</span> <span>&#34;ahci&#34;</span> <span>&#34;usb_storage&#34;</span> <span>&#34;sd_mod&#34;</span><span>]</span><span>;</span>
    boot<span>.</span>initrd<span>.</span>kernelModules <span>=</span> <span>[</span><span>&#34;dm-snapshot&#34;</span><span>]</span><span>;</span>
    boot<span>.</span>kernelModules <span>=</span> <span>[</span><span>&#34;kvm-intel&#34;</span><span>]</span><span>;</span>
    boot<span>.</span>extraModulePackages <span>=</span> <span>[</span><span>]</span><span>;</span>

    fileSystems<span>.</span><span>&#34;/&#34;</span> <span>=</span> <span>{</span>
      device <span>=</span> <span>&#34;/dev/mapper/crypto-work&#34;</span><span>;</span>
      fsType <span>=</span> <span>&#34;ext4&#34;</span><span>;</span>
    <span>}</span><span>;</span>

    <span>-</span><span>-</span><span>-</span><span>8</span><span>&lt;</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>
    <span>[</span>more code here<span>]</span>
    <span>-</span><span>-</span><span>-</span><span>8</span><span>&lt;</span><span>-</span><span>-</span><span>-</span><span>-</span><span>-</span>

    swapDevices <span>=</span> <span>[</span><span>]</span><span>;</span>
    networking<span>.</span>useDHCP <span>=</span> lib<span>.</span>mkDefault <span>true</span><span>;</span>
    hardware<span>.</span>cpu<span>.</span>intel<span>.</span>updateMicrocode <span>=</span> lib<span>.</span>mkDefault config<span>.</span>hardware<span>.</span>enableRedistributableFirmware<span>;</span>
  <span>}</span><span>;</span>
  <span>}</span><span>;</span>
<span>}</span></code></pre></div>
<h2 id="system-configuration"><a href="#system-configuration" aria-label="system configuration permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>System configuration</h2>
<p>It’s now the time to configure your system as you want. The file
<code>/mnt/etc/nixos/configuration.nix</code> contains shared configuration, this
is the right place to define your user, shared packages, network and services.</p>
<p>The files <code>/mnt/etc/nixos/private.nix</code> and <code>/mnt/etc/nixos/work.nix</code>
can be used to define context specific configuration.</p>
<h3 id="lvm-workaround"><a href="#lvm-workaround" aria-label="lvm workaround permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LVM Workaround</h3>
<p>During the numerous installation tests I’ve made to validate this guide,
on some hardware I noticed an issue with LVM detection, add this line
to your global configuration file to be sure your disks will be detected at boot.</p>
<div data-language="nix"><pre><code>    boot<span>.</span>initrd<span>.</span>preLVMCommands <span>=</span> <span>&#34;lvm vgchange -ay&#34;</span><span>;</span></code></pre></div>
<h2 id="installation"><a href="#installation" aria-label="installation permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation</h2>
<h3 id="first-installation"><a href="#first-installation" aria-label="first installation permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>First installation</h3>
<p>The partitions are mounted and you configured your system as you want it, we can run the NixOS installer.</p>

<p>Wait for the copy process to complete after which you will be prompted
for the root password of the current crypto-work environment (or the
one you mounted here), you also need to define the password for your
user now by chrooting into your NixOS system.</p>
<div data-language="shell"><pre><code>
New password:
Retape new password:
passwd: password updated successfully
</code></pre></div>
<p>From now, you have a password set for root and your user for the
crypto-work environment, but no password are defined in the crypto-private
environment.</p>
<h3 id="second-installation"><a href="#second-installation" aria-label="second installation permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Second installation</h3>
<p>We will rerun the installation process with the other environment mounted:</p>
<div data-language="shell"><pre><code><span>mount</span> /dev/mapper/crypto-private  /mnt
<span>mkdir</span> -p /mnt/etc/nixos /mnt/boot /mnt/nix

<span>mount</span> /dev/mapper/nix-store /mnt/nix
<span>mount</span> --bind /mnt/nix/config /mnt/etc/nixos
<span>mount</span> /dev/sda1 /mnt/boot</code></pre></div>
<p>As the NixOS configuration is already done and is shared between the two
environments, just run <code>nixos-install</code>, wait for the root password to
be prompted, apply the same chroot sequence to set a password to your
user in this environment.</p>
<p>You can reboot, you will have a default boot entry for the default chosen
environment, and the other environment boot entry, both requiring their
own passphrase to be used.</p>
<p>Now, you can apply changes to your NixOS system using <code>nixos-rebuild</code>
from both work and private environments.</p>
<h2 id="conclusion"><a href="#conclusion" aria-label="conclusion permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>Congratulations for going through this long installation process. You
can now log in to your two contexts and use them independently, and you can
configure them by applying changes to the corresponding files in <code>/etc/nixos/</code>.</p>
<h2 id="going-further"><a href="#going-further" aria-label="going further permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Going further</h2>
<h3 id="swap-and-hibernation"><a href="#swap-and-hibernation" aria-label="swap and hibernation permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swap and hibernation</h3>
<p>With this setup, I chose to not cover swap space because this would allow
to leak secrets between the contexts. If you need some swap, you will
have to create a file on the root partition of your current context,
and add the according code to the context filesystems.</p>
<p>If you want to use hibernation in which the system stops after dumping
its memory into the swap file, your swap size must be larger than the
memory available on the system.</p>
<p>It’s possible to have a single swap for both contexts by using a random
encryption at boot for the swap space, but this breaks hibernation
as you can’t unlock the swap to resume the system.</p>
<h3 id="declare-users-passwords"><a href="#declare-users-passwords" aria-label="declare users passwords permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Declare users’ passwords</h3>
<p>As you noticed, you had to run <code>passwd</code> in both contexts to define your
user password and root’s password. It is possible to define their password
declaratively in the configuration file, refers to the documentation
of<code>users.mutableUsers</code> and <code>users.extraUsers.&lt;name&gt;.initialHashedPassword</code>
for more information.</p>
<h3 id="rescue-the-installation"><a href="#rescue-the-installation" aria-label="rescue the installation permalink"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rescue the installation</h3>
<p>If something is wrong when you boot the first time, you can reuse the
installer to make changes to your installation: you can run again the
<code>cryptsetup luksOpen</code> and <code>mount</code> commands to get access to your
filesystems, then you can edit your configuration files and run
<code>nixos-install</code> again.</p></div></div></div>
  </body>
</html>
