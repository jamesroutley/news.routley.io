<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fbifemboy.substack.com/p/theoretical-advances-in-amm-understanding">Original</a>
    <h1>Theoretical Advances in AMM (Automated Market Maker) Understanding</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div><div dir="auto"><p>Since the launch of Uniswap V1 in November 2018, decentralized exchanges (DEXes) with liquidity pool-based automated market makers (AMMs) have become a dominant model in decentralized finance with total daily transaction volumes reaching well into the hundreds of millions of dollars. Although liquidity pool-based AMMs had been described prior to Uniswap, most notably in Hanson (2002), <a href="https://mason.gmu.edu/~rhanson/mktscore.pdf" rel="">Logarithmic Market Scoring Rules for Modular Combinatorial Information Aggregation</a>, traditional financial markets have typically relied on central limit order books. In the context of decentralized finance, however, where on-chain state storage and computation are relatively expensive and slow, passive provisioning of liquidity pools that automatically ‘update’ after each order offers significant advantages.</p><p>In conjunction with the rapid growth of decentralized finance, a number of researchers have begun to publish theoretical analyses of liquidity pool-based AMMs. These papers initially focused on basic analysis of constant product market makers (CPMMs) (such as Uniswap V1/V2) then subsequently expanded in a variety of novel directions, such as analysis of constant function market makers (CFMMs) or range-bound concentrated liquidity.</p><p>This research on AMMs has begun to lay a solid theoretical foundation for formal theories of decentralized finance as well as pave the way for the development of a number of innovative protocols. However, despite the significance of these results, they remain poorly appreciated by the public at large. In this article, I would like to present a high-level, accessible overview of the major results in AMM research, with the hope that readers will come to a deeper understanding of the DEXes they use every day.</p><p>I will aim to highlight papers which I found particularly interesting or significant; however, this should not be read as a comprehensive survey of the field, and readers are welcome to note any omissions in the comments. My understanding of the literature may also be flawed, in which case the reader is invited to suggest corrections.</p><p><em>(Please note that I am currently looking for employment; see the end of this post for further details.)</em></p><p>The basic operating model of Uniswap V1/V2 markets is typically referred to as a “constant product market” (CPM). Most forks of Uniswap also operate on the same model. To briefly review for the reader, these essentially follow the principle that performing token swaps should leave the product of the two reserves unchanged. For example, taking into example an ETH/USDC liquidity pool, one can denote with <em>x</em> the amount of ether in the pool and <em>y</em> the number of USDC tokens in the pool. Only swaps which preserve the product <em>xy = k</em> are permitted (setting aside fees).</p><p>In late 2019, Angeris <em>et al.</em> published a basic analysis of the Uniswap constant product market as <a href="https://arxiv.org/abs/1911.03380" rel="">An analysis of Uniswap markets</a>. Building on some previous work, <em>e.g.</em> that of Zhang <em>et al.</em> (2018), Angeris <em>et al.</em> (2019) presents formal definitions of constant product markets and produces a number of foundational results that formalize certain “intuitive” characteristics of their operation.</p><p>Suppose that we have a two-token market with reserves of size <em>R</em> and <em>Q</em> respectively. A trader who wants to trade in <em>r</em> tokens (of the same type as the reserves <em>R</em>) and receive <em>q</em> tokens in return must submit a trade which conforms to the following:</p><p><em>RQ</em> = (<em>R</em> + γ<em>r</em>)(<em>Q</em> - <em>q</em>) = <em>k</em></p><p>In this case, the parameter γ represents the fee charged. For example, if γ = 0.99, a surcharge of ~1% is applied to the input token quantity <em>r</em>. The above expression is quite intutive: a valid trade will increase the reserves of the input token <em>R</em> by quantity <em>γr</em> and decrease the reserves of the output token <em>Q</em> by quantity <em>q</em>, thereby increasing the marginal price of the output token. After the trade, the constant <em>k</em> is updated to (<em>R</em> + <em>r</em>)(<em>Q</em> - <em>q</em>); notice here that when γ &lt; 1, <em>i.e.</em> when a fee is charged, the constant has actually increased, representing the fact that trading fees progressively increase the total size of the liquidity reserves.</p><p>Angeris <em>et al.</em> analyze opportunities for arbitrage, which are considered to originate from pricing differences between the CPM and a ‘reference market’ with infinite liquidity. If an arbitrageur can execute a sequence of trades such that they end up with more tokens of a particular type than they had before the trade, that is considered a successful arbitrage. It intuitively follows that when trading fees are zero, continual arbitrage keeps the CPM’s prices equivalent to the reference market’s prices. However, Angeris <em>et al.</em> show that when trading fees are nonzero, the CPM’s price for a token may fluctuate between a lower bound of γ<em>m</em> and an upper bound of <em>m/</em>γ, where <em>m</em> is the reference market price of the token. When the trading fee is sufficiently small (1 - γ is close to 0), we have the approximation 1/(1 - γ) ~= 1 + γ, so the CPM price is bounded between (1 - γ)<em>m</em> and (1 + γ)<em>m</em>.</p><p>This paper also formally proves a number of intuitively “obvious” results:</p><ul><li><p>In the presence of trading fees, the product constant <em>k</em> is strictly increasing, <em>i.e.</em> the “total amount” of reserves gradually increases over time</p></li><li><p>In the presence of trading fees, it is always preferable to make one single trade rather than two consecutive trades (of equivalent total input token size)</p></li><li><p>It is not possible to deplete a constant product market of all tokens</p></li><li><p>As the amount of reserves increase, price impact of a trade decreases</p></li></ul><p>Although the above should be little surprise to any regular user of Uniswap V1/V2-based DEXes, it is nevertheless valuable for them to be formally demonstrated, as that provides the foundation for the development of further results.</p><p>One final result which may be of particular interest to readers is a characterization of the returns of liquidity providers. Suppose that you are providing liquidity for a pool containing a risky token with price <em>p</em> against a standard numéraire (<em>e.g.</em>, ETH or USDC). Angeris <em>et al.</em> show that your portfolio has a value proportional to sqrt(<em>p</em>). It’s <a href="https://www.wolframalpha.com/input/?i=plot+2*sqrt%28x%29+and+1%2Bx+for+x%3D0+to+x%3D5" rel="">easy to see</a> that in the absence of trading fees or liquidity rewards, this is always strictly worse than holding the two assets individually — a phenomenon we know as “impermanent loss.”</p><p>In the <em>xy</em> = <em>k</em> constant product market, notice that the two token reserves have equal market values at all given times. Providing liquidity is therefore similar to holding a 50:50 portfolio of the two tokens, with continual rebalancing due to external arbitrage.</p><p>What happens if we instead consider <em>x</em>²<em>y</em> = <em>k</em>? In this setting, it turns out that external arbitrage will always rebalance the liquidity pool so that the market value of the tokens denoted by <em>x</em> is exactly <em>twice</em> that of the market value of the tokens denoted by <em>y</em>. The intuition behind this result is that one can think of the invariant as <em>x</em>²<em>y</em> = <em>xxy</em> = <em>k</em>, where in analogy to the <em>xy</em> = <em>k</em> example there are “two pools” for token <em>x</em> and one pool for token <em>y</em>, each of equivalent size.</p><p>This suggests a more general method for forming such invariants from weighted products of arbitrarily many assets, <em>e.g.,</em> <em>x</em>²<em>y³z</em> = <em>k</em>. Indeed, this is precisely the strategy used by Balancer, as described in the whitepaper by Martinelli and Mushegian (2019), <a href="https://balancer.fi/whitepaper.pdf" rel="">Balancer: A non-custodial portfolio manager, liquidity provider, and price sensor</a>. It turns out that if you have <em>n</em> assets in a liquidity pool and require that trades preserve the constant product of the reserves <em>xᵢ</em> raised to the powers <em>wᵢ</em>, the resulting liquidity pool is effectively a continuously rebalanced portfolio of the <em>i</em> assets with constant weights <em>wᵢ</em>. Users can therefore provide liquidity to Balancer-like AMMs as one way of holding “index funds” of assets continually rebalanced to prespecified proportions. AMMs which use such invariant functions are sometimes referred to as geometric mean market makers (G3Ms).</p><p>Unsurprisingly, we see that some of the largest Balancer V2 pools by pool value correspond to certain “natural” portfolios that many users plausibly want to hold, such as 50/50 BTC/ETH portfolios or DAI/USDC/USDT for diversifying stablecoin risk:</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd257945e-eb19-4e56-beb4-62f7143abff9_1891x533.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd257945e-eb19-4e56-beb4-62f7143abff9_1891x533.png" width="728" height="410" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/d257945e-eb19-4e56-beb4-62f7143abff9_1891x533.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:410,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:111314,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>Taking this one step further, Beethoven X, a Balancer fork on Fantom, explicitly promotes a number of “index fund pools”:</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4b9a6c5c-5805-479c-913f-dda08c5b780c_1906x651.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F4b9a6c5c-5805-479c-913f-dda08c5b780c_1906x651.png" width="728" height="497" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/4b9a6c5c-5805-479c-913f-dda08c5b780c_1906x651.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:497,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:146726,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>For example, providing liquidity to the “Fantom Conservatory of Music” pool would give you weighted exposure to various components of the Fantom DeFi ecosystem:</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fca417afa-c8d5-4a98-a466-0969574f2c6a_651x657.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fca417afa-c8d5-4a98-a466-0969574f2c6a_651x657.png" width="651" height="657" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/ca417afa-c8d5-4a98-a466-0969574f2c6a_651x657.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:657,&#34;width&#34;:651,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:77830,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>Given the difficulty of maintaining a weighted portfolio by hand (owing to transaction fees and the 24/7, high-volatility nature of cryptocurrency prices), it is unsurprising that Balancer-like liquidity pools have attracted hundreds of millions of dollars of capital. At the same time, however, it is crucial to note that the “auto-rebalancing” nature of Balancer pools comes at a cost — by definition, arbitrageurs are extracting value from the liquidity pool. These losses can be mitigated by charging a swap fee, but the presence of a fee disincentivizes small rebalancing arbitrage swaps.</p><p>A recent article by Evans <em>et al.</em> (2021), <a href="https://arxiv.org/abs/2104.00446" rel="">Optimal Fees for Geometric Mean Market Makers</a>, analyzes these tradeoffs in greater detail. Noting that classical portfolio theory due to <em>e.g.</em> Merton suggests that rebalancing should not occur within a “no-trade” region around optimal portfolio weights as a function of transaction costs, they apply methods from stochastic control to model arbitrage costs as a function of swap fees and determine the end result on the liquidity provider’s portfolio value.</p><p>In general, one can model the LP-arbitrage dynamic as a two-player game. The liquidity provider seeks to minimize a penalty function which represents the “tracking error” of their liquidity shares relative to some desired set of portfolio weights, and the arbitrageur wishes to continually extract maximal value through trading against the liquidity provider’s assets. As seen with the simpler constant product market, G3Ms also have a “no-trade” region where the deviation of AMM prices from reference prices is sufficiently small that trading fees make it unprofitable for an arbitrageur to rebalance the liquidity pools, and the size of ths “no-trade” region increases with the trading fee.</p><p>In their primary analysis, Evans <em>et al.</em> assume that the liquidity provider measures their portfolio’s tracking error with a penalty function which corresponds to a standard mean-variance preference over rates of return with a fixed risk aversion parameter. This penalty function is quadratic in the difference between the actual portfolio weights and the desired set of portfolio weights. When the G3M’s liquidity pool contains just two assets, a numéraire and a risky asset with price following geometric Brownian motion with growth rate <em>μ</em> and volatility <em>σ</em>, the liquidity provider’s penalty function can be numerically calculated as a function of <em>μ</em> and <em>σ</em> as well as trading fees <em>γ</em>.</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb5f9d047-90ef-4342-974b-e1a3effb9a7a_686x341.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fb5f9d047-90ef-4342-974b-e1a3effb9a7a_686x341.png" width="686" height="341" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/b5f9d047-90ef-4342-974b-e1a3effb9a7a_686x341.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:341,&#34;width&#34;:686,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:29044,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>Figure 1 from Evans <em>et al.</em> illustrates this calculation for some representative sets of parameters. We can make the following observations:</p><ul><li><p>The liquidity provider’s tracking error approaches 0 as fees approach 0 (<em>γ</em> approaches 1)</p></li><li><p>When the trading fee is small, the tracking error is negligible for both low-growth, low-volatility and high-growth, high-volatility assets</p></li><li><p>When the trading fee is large, the tracking error is substantial for high-growth, high-volatility assets</p></li></ul><p>Importantly — the penalty function <em>J</em> is discontinuous at <em>γ</em> = 1, suggesting that fees should be as small as possible without being equal to zero, a result with direct practical implications for the design of Balancer-like AMMs as well as for liquidity providers to such AMMs.</p><p>The observation that liquidity pool-based AMMs continue to attract increasingly large amounts of capital provides a strong motivation for analysis of the setting where the majority of liquidity for an asset resides in on-chain AMMs, rather than with respect to an infinitely liquid “reference market” as in the previously described results. This is now the case for the vast majority of cryptocurrency assets, <em>e.g.</em> LUSD, FRAX, GNO, XMON, and so on.</p><p>In a 2020 publication, <a href="https://arxiv.org/abs/2012.08040" rel="">When does the tail wag the dog? Curvature and market making</a>, Angeris <em>et al.</em> begin to develop a general framework for analysis of the <em>curvature</em> of a constant function market maker (CFMM)’s trading function, <em>i.e.</em>, the invariant function of the liquidity reserveswhich is preserved across trades. By providing formal definitions of price sensitivity and liquidity depth, Angeris <em>et al.</em> successfully derive a number of heuristic results which explain <em>e.g. </em>the relative success of Curve for stablecoin swaps.</p><p>In general, Angeris <em>et al.</em> study the case of a two-asset AMM (pairing a risky traded asset with a numéraire) with a corresponding <em>price impact function</em> <em>g</em> which measures the change in the marginal price of the risky asset after trades of a given size. For a given trade of size <em>s</em>, the price impact function is considered <em>μ-stable</em> if the trade results in a change in marginal price of at most <em>μs</em>. Similarly, the price impact function is considered <em>κ-liquid</em> if the trade results in a change in marginal price of at least <em>κs</em>. It is often the case that these bounds may only hold for trades smaller than some size <em>L</em>.</p><p>In the simplified case of a Uniswap V1/V2 constant product market with two stablecoins, Angeris <em>et al.</em> show that <em>μ</em> and <em>κ</em> are both decreasing functions of the total size of reserves <em>R</em> as well as <em>L</em>. Intuitively, for a fixed price impact, the maximum possible trade size increases with the size of the reserves; correspondingly, the effective curvature of the AMM decreases as more liquidity is added. Although this result was previously demonstrated in <a href="https://arxiv.org/abs/1911.03380" rel="">An analysis of Uniswap markets</a>, the curvature-based framework here extends nicely to more general settings.</p><p>In contrast, Curve, an AMM designed for optimized stablecoin swaps, has a more complex trading function,</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F5f12673b-32d7-4c9d-907c-6c3d5e218731_660x58.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F5f12673b-32d7-4c9d-907c-6c3d5e218731_660x58.png" width="660" height="58" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/5f12673b-32d7-4c9d-907c-6c3d5e218731_660x58.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:58,&#34;width&#34;:660,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:9533,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>where ∆, ∆’ represent the amounts traded out and in respectively, <em>R</em>, <em>R’</em> represent their reserves, and <em>α</em>, <em>β</em> are fixed parameters. It can be seen that as <em>β</em> increases, the price impact for a trade of given size also increases:</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F6c021e37-6ef5-4831-9787-4e7011345228_764x438.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F6c021e37-6ef5-4831-9787-4e7011345228_764x438.png" width="728" height="438" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/6c021e37-6ef5-4831-9787-4e7011345228_764x438.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:438,&#34;width&#34;:764,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:25368,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>Notably, if the total value of the reserves is given by <em>P_V</em>, then it can be shown that</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F78882bca-eff5-4077-824c-db0733c7463b_221x98.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F78882bca-eff5-4077-824c-db0733c7463b_221x98.png" width="221" height="98" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/78882bca-eff5-4077-824c-db0733c7463b_221x98.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:98,&#34;width&#34;:221,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:5735,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>corresponding to the maximum slippage a trader can expect for a given trade size. Notice that unlike the Uniswap constant product market, here the <em>μ</em>-stability is not limited to trades smaller than some threshold ∆ &lt; <em>L</em>.</p><p>Looking again at the case of stablecoin swaps, where trading is typically “uninformed” (as users largely swap between different stablecoins mainly because specific protocols they want to interact with have specific requirements about which stablecoins they accept), we expect prices to exhibit mean-reverting tendencies, especially given the ease of redemption of stablecoins into the underlying backing assets or the presence of external peg-maintenance programs. Therefore, we should expect low-curvature AMMs to be preferable for stablecoin swaps, as they allow traders to make swaps with lower price impact.</p><p>In practice, as the following figure illustrates, Curve’s trading function has significantly lower curvature than either Uniswap or Balancer:</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8c4d7f-9fca-45dc-a50d-8727347e9d72_1172x303.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8c4d7f-9fca-45dc-a50d-8727347e9d72_1172x303.png" width="728" height="303" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/3b8c4d7f-9fca-45dc-a50d-8727347e9d72_1172x303.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:303,&#34;width&#34;:1172,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:52767,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>Beyond price impact alone, lower curvature is also beneficial to liquidity providers. For a given trading fee γ, Angeris <em>et al.</em> show that the liquidity provider is guaranteed to make a profit when the trade size ∆ is lower than a function which is linear in 1/<em>μ</em>. Therefore, as the curvature <em>μ</em> decreases, trades of increasingly large size become profitable to the liquidity provider. This drives more liquidity to the AMM, which in turn further reduces the price impact experienced by traders, and so on. Correspondingly, Curve is generally considered to be the dominant AMM for stablecoin liquidity.</p><p>A number of further analyses are described in the remainder of the paper, which I will briefly discuss. For example, Angeris <em>et al.</em> go on to consider the case of informed trading, where a trader has an informational edge which allows them to predict the next price update of an external market. In this case, it can be shown that the losses of the liquidity provider — or, conversely, the profits of the informed trader — are minimized with lower curvature. This is analogous to results in classic market microstructure, where market makers quoting prices on multiple markets adjust the shape and liquidity of the order book in response to adverse selection (the problem of trading with informed traders). When adverse selection is observed or predicted, market makers reduce the liquidity available to traders in a way that corresponds to increasing the curvature of a CFMM.</p><p>Further models are developed which describe price stability between multiple AMMs with different curvature, particularly in the context of yield farming, and dynamic hedging of liquidity provision through explicit computation of the first- and second-order Greeks for LP shares. These results supply a strong theoretical basis for future work and suggest a number of natural extensions. For example, although the analyses by Angeris <em>et al.</em> characterize the ‘desirability’ of different CFMMs depending on the nature of the underlying asset or the trading activity, a more general and heretofore unresolved question is how one might take a price process of some given theoretical form — which could be fit to empirical data — and design a trading function with optimal LP payoff characteristics.</p><p>Although the question of taking a particular price process and designing an optimized CFMM is not yet resolved, a number of intriguing results have been developed which characterize the correspondence between a desired portfolio value function and a CFMM’s trading function. For example, recall that for a Uniswap V1/V2 constant product market <em>xy</em> = <em>k</em>, the portfolio value is proportional to sqrt(<em>p</em>) (where <em>p</em> is the price of the risky asset denominated against the paired numéraire). Recent papers have attempted to solve the <em>inverse</em> of this problem, where the trading function of a CFMM is directly recovered from a given portfolio value function.</p><p>One such set of results was given in Angeris <em>et al.</em> (2021), <a href="https://arxiv.org/abs/2103.14769" rel="">Replicating Market Makers</a>. Suppose that you are given a target portfolio value function <em>V</em>(<em>c</em>) which takes as input a vector of asset prices <em>c</em> with respect to a reference market and returns the total value of a portfolio constructed from those assets. If <em>V</em> is of the appropriate form — a concave, nonnegative, nondecreasing, 1-homogeneous function — then one can explicitly recover a corresponding trading function,</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F90851000-e44c-4b34-aa74-7bf2085b647d_298x61.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F90851000-e44c-4b34-aa74-7bf2085b647d_298x61.png" width="298" height="61" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/90851000-e44c-4b34-aa74-7bf2085b647d_298x61.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:61,&#34;width&#34;:298,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:5828,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>where <em>R</em> represents the reserves in the liquidity pool. It is interesting to note that the portfolio value function <em>V</em> and the trading function <em>ψ</em> are related via Fenchel conjugacy.</p><p>Beyond recovering the trading functions of well-known CFMMs such as Uniswap and Balancer, one can apply this method to create options-like payoffs. For example, suppose that the liquidity provider has a risky asset and a riskless asset, and that they would like to provide liquidity with a payoff replicating that of a covered call on the risky asset with strike price <em>K</em>. It is straightforward to derive the corresponding trading function: the CFMM will only permit transitions between two specific ‘states’ of the reserves, namely, either one unit of the risky asset and zero units of the riskless asset or zero units of the risky asset and <em>K</em> units of the riskless asset. External arbitrage then ensures this is equivalent to the payoff of the desired covered call.</p><p>However, note that in the above example, providing liquidity to the covered call payoff essentially requires full collateralization, which is lacking in capital efficiency. Motivated by this, Angeris <em>et al.</em> derive the trading function required to replicate the <em>price</em> of a covered call as calculated via the Black-Scholes-Merton model. With strike price <em>K</em>, time to maturity <em>τ</em>, implied volatility <em>σ</em>, and reserves <em>R</em>, they find that the corresponding trading function is:</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F69983fff-bf53-4886-9e07-c81a27a7642b_640x102.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F69983fff-bf53-4886-9e07-c81a27a7642b_640x102.png" width="640" height="102" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/69983fff-bf53-4886-9e07-c81a27a7642b_640x102.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:102,&#34;width&#34;:640,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:14205,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>Examples of this trading function for certain parameter values are plotted below (the lines dictate the ‘level curves’ where the trading function is equal to 0):</p><div><figure><a target="_blank" rel="nofollow" href="https://cdn.substack.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F5cc90d44-ad54-45f1-b9cb-9f6baada4ef8_904x310.png"><img src="https://cdn.substack.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F5cc90d44-ad54-45f1-b9cb-9f6baada4ef8_904x310.png" width="728" height="310" data-attrs="{&#34;src&#34;:&#34;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/5cc90d44-ad54-45f1-b9cb-9f6baada4ef8_904x310.png&#34;,&#34;fullscreen&#34;:null,&#34;height&#34;:310,&#34;width&#34;:904,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:39079,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null}" alt=""/></a></figure></div><p>It is interesting to note that the permissible set of reserves changes based on the time to expiry <em>τ</em>, which can also be seen in the rightmost figure above. In particular, to reproduce the decay of the option’s time value as it approaches expiry, increasingly large capital reserves are required. In a no-fee setting, this is not possible via arbitrage alone; however, if fees are captured from arbitrageurs, that may allow the CFMM to more accurately represent the time evolution of the price of a covered call. This approach is currently being developed by <a href="https://primitive.finance/" rel="">Primitive</a>.</p><p>In general, a large number of papers, which cannot all be presented here in depth, have analyzed the problem of designing a CFMM with a given payoff function for liquidity providers:</p><ul><li><p>Evans (2020), <a href="https://arxiv.org/abs/2006.08806" rel="">Liquidity Provider Returns in Geometric Mean Markets</a> demonstrated that arbitrary unlevered payoff functions can be replicated if the trading function is allowed to dynamically evolve over time</p></li><li><p>Chitra <em>et al.</em> (2021), <a href="https://stanford.edu/~guillean/papers/cfmm-lending.pdf" rel="">A Note on Borrowing Constant Function Market Maker Shares</a> demonstrated that allowing liquidity providers to borrow against their shares is secure and capital-efficient and permits the replication of certain bounded <em>convex</em> payoffs (as opposed to the <em>concave</em> payoffs previously described)</p></li><li><p>Angeris <em>et al.</em> (2021), <a href="https://arxiv.org/abs/2111.13740" rel="">Replicating Monotonic Payoffs Without Oracles</a> demonstrates that <em>any</em> monotonic payoff can be replicated by allowing liquidity providers to sell off the right to withdraw certain components of their liquidity share, essentially allowing them to have payoff exposure to only one side of the liquidity position</p></li></ul><p>It is plausible that the rapid pace of advances in designing ‘custom’ liquidity provider payoffs will lead to the development of novel DeFi building blocks, greater capital efficiency, and improved availability of liquidity.</p><p>The final category of AMM innovations we will discuss is the development of ‘concentrated liquidity’ positions, for example in Uniswap V3 and CrocSwap. These allow liquidity providers to provide liquidity within a specified price range. When the marginal price of the traded assets moves outside of that price range, their liquidity is effectively deactivated, limiting the degree of impermanent loss suffered by the liquidity provider but also preventing them from receiving any trading fees or liquidity incentives.</p><p>A series of articles by <a href="https://lambert-guillaume.medium.com/" rel="">Guillaume Lambert</a> have analyzed the payoff characteristics of Uniswap V3 concentrated liquidity positions. Intuitively, it is clear that liquidity positions deployed over the smallest possible interval (a single “tick”) behaves similarly to a fully collateralized covered call or cash-secured put, as the liquidity position is either 1 unit of the underlying risky asset (if the market price is below the tick’s lower bound) or equal to the strike price in the riskless unit (if the market price is above the tick’s upper bound). In the limiting case where the tick size is infinitesimally small and converges to a single value, that value is analogous to the strike price of the corresponding option.</p><p>One interesting <a href="https://lambert-guillaume.medium.com/pricing-uniswap-v3-lp-positions-towards-a-new-options-paradigm-dce3e3b50125" rel="">result</a> from Lambert is as follows. We decomposing a concentrated liquidity position as the sum of a short put, priceable via Black-Scholes-Merton, and a ‘range component’ which approximates the option’s theta decay at certain times-to-expiry. The ‘range component’ can be put into closed form with the Feynman-Kac formula, and together the entire liquidity position can be priced as a single put option with a given time-to-expiry (calculated as a function of the range over which liquidity is provided). Is it preferable to hold the liquidity position to capture trading fees or to lend the position to an options buyer? Under certain assumptions, the latter is almost always preferred.</p><p>Another interesting perspective from which concentrated liquidity can be analyzed is that of <em>liveness</em>. To motivate this, one may recall that blockchains occasionally experience losses of liveness. On Solana, for example, an <a href="https://cryptoslate.com/latest-solana-outage-leave-users-liquidated/" rel="">outage</a> at the end of January 2021 created extreme price differences between on-chain AMMs and off-chain markets. For central limit order book (CLOB) AMMs such as Serum, price differences led to extreme confusion when liveness was restored — market makers rushed to cancel outdated orders at prices well above market and lending platforms rushed to liquidate positions which were deep in default. In total, the Serum order book experienced a 37% loss of liquidity when the Solana network was restored. In contrast, CFMM-based AMMs such as Saber experienced fewer disruptions, with a much lower 5% loss in liquidity.</p><p>To formally understand what AMMs perform better when liveness is lost, Chitra <em>et al.</em> (2021), <a href="https://stanford.edu/~guillean/papers/cfmm-ob.pdf" rel="">How Liveness Separates CFMMs and Order Books</a> demonstrate an equivalence between pro-rata limit order books and concentrated liquidity AMMs. They then show that for a sudden price shock of size Δ, traditional CFMMs require only <em>O</em>(1) transactions to readjust prices, whereas concentrated liquidity AMMs (equivalently, CLOBs) require <em>O</em>(Δ) transactions for the same readjustment. In situations where liveness is lost and regained, system throughput is typically reduced and a rush to unwind or liquidate positions leads to the development of race conditions, hence market mechanisms that update prices in <em>O</em>(1) transactions are strongly preferred.</p><p>Despite this disadvantage, concentrated liquidity AMMs improve capital efficiency and predictability of returns for liquidity providers. Conceivably, novel AMMs which blend both ‘ambient’ liquidity and concentrated liquidity positions such as <a href="https://www.crocswap.com/whitepaper" rel="">CrocSwap</a> may allow users to capture the benefits of both models.</p><p>Given the strikingly rapid pace of innovation in decentralized finance, it is sometimes easy to forget that Uniswap itself is only slightly over three years old! Even so, it is apparent that AMMs, both in theory and in practice, have made great strides in the intervening time. As decentralized finance matures, I believe that research advances in AMM design will be an invaluable cornerstone driving the development of capital-efficient, on-chain ‘building blocks.’</p><p>Unfortunately, for narrative clarity and concision, a number of interesting topics have been omitted from this piece, such as:</p><ul><li><p>Development of market making mechanisms for illiquid assets such as NFTs</p></li><li><p>Incorporation of differential privacy into AMM order execution</p></li><li><p>Optimal arbitrage within and across AMMs as well as prevention of MEV</p></li></ul><p>I hope to discuss these topics, and more, in future articles.</p><p>Please note that I am currently looking for employment and am happy to receive inquiries through Twitter DMs: <a href="https://twitter.com/0xfbifemboy" rel="">https://twitter.com/0xfbifemboy</a></p><p>I have a technical background with professional expertise in statistical methodology and machine learning. I am proficient in R, Julia, and Python, with moderate competency in C++, and am novice-level in Solidity and Rust (but hopefully learning fast). My ideal role is research-based with a theoretical or mathematical component but also with the opportunity to learn from more experienced DeFi developers.</p><p>I’m particularly interested in novel protocols which are pushing forward the cutting edge of on-chain finance from both theoretical and practical perspectives, but ultimately there isn’t much in crypto that I don’t find fascinating.</p></div></div></article></div></div></div>
  </body>
</html>
