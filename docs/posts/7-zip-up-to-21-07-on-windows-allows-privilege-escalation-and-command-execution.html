<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/kagancapar/CVE-2022-29072">Original</a>
    <h1>7-Zip up to 21.07 on Windows allows privilege escalation and command execution</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">7-Zip is free software with open source. The most of the code is under the GNU LGPL license. Some parts of the code are under the BSD 3-clause License. Also there is unRAR license restriction for some parts of the code. Read 7-Zip License information.</p>
<p dir="auto">You can use 7-Zip on any computer, including a computer in a commercial organization. You don&#39;t need to register or pay for 7-Zip.</p>

<p dir="auto">7-Zip through 21.07 on Windows allows privilege escalation and command execution when a file with the .7z extension is dragged to the Help&gt;Contents area.</p>
<p dir="auto">The zero-day included in 7-zip software is based on misconfiguration of 7z.dll and heap overflow. After the installation of 7-zip software, the help file in the HELP &gt; contents content works through the Windows HTML Helper file, but after the command injection, a child process appeared under the 7zFM.exe process,</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/33525376/163653664-a3659510-49af-4e61-aa4a-3ecb61dc4fc2.PNG"><img src="https://user-images.githubusercontent.com/33525376/163653664-a3659510-49af-4e61-aa4a-3ecb61dc4fc2.PNG" alt="childproces"/></a></p>
<p dir="auto">which is seen after the command injection, which is quite interesting, after this situation, 7-zip with WinAFL The fuzzing process was carried out. Thanks to the overflow vulnerability and wrong authorization based on the heap, it was noticed that when the process injection technique was applied (in memory) by using the powers of the 7z.dll file and the command prompt was called again, it was authorized on cmd.exe with the administrator mode. In the payload developed after this process, the psexec.exe file was used as raw;</p>
<p dir="auto">NT AUTHORITY\SYSTEM privilege has been accessed thanks to the command &#34;psexec -s cmd.exe -nobanner&#34;.</p>
<p dir="auto">At this stage, 7-zip stated that the vulnerability was caused by hh.exe, but they were told that if there was a command injection from hh.exe, a child process should be created under hh.exe, so especially the heap-overflow side of this vulnerability will not be shared with the community.</p>
<p dir="auto">To look at the discovery phase of the vulnerability;</p>
<p dir="auto">As it is known, Microsoft HELPER ie hh.exe file &#34;html help. full name microsoft html help executable. Program that opens help files with the chm extension.&#34; has been defined as. Many operations such as XXE, Command Execution are performed through the hh.exe file. It is possible to see vulnerabilities such as XXE or command execution in every program that uses the hh.exe interface. This issue came to my mind after the discovery of the XXE vulnerability detected by WinRAR. (<a href="https://www.exploit-db.com/exploits/47526" rel="nofollow">https://www.exploit-db.com/exploits/47526</a>) Although the developers of 7-zip say that Microsoft should fix the command execution authority obtained from hh.exe at this point, it has been observed that at the end of the day, thanks to the heap overflow in 7zFM.exe and the command execution feature in hh.exe, privilege elevation is provided in the administrator mode.</p>
<p dir="auto">poc video:</p>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M16 3.75a.75.75 0 00-1.136-.643L11 5.425V4.75A1.75 1.75 0 009.25 3h-7.5A1.75 1.75 0 000 4.75v6.5C0 12.216.784 13 1.75 13h7.5A1.75 1.75 0 0011 11.25v-.675l3.864 2.318A.75.75 0 0016 12.25v-8.5zm-5 5.075l3.5 2.1v-5.85l-3.5 2.1v1.65zM9.5 6.75v-2a.25.25 0 00-.25-.25h-7.5a.25.25 0 00-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-4.5z"></path>
</svg>
    <span aria-label="Video description priv1.mp4">priv1.mp4</span>
    <span></span>
  </summary>

  <video src="https://user-images.githubusercontent.com/33525376/163654035-d40ca72a-7dbc-425f-ade2-3820cfababb2.mp4" data-canonical-src="https://user-images.githubusercontent.com/33525376/163654035-d40ca72a-7dbc-425f-ade2-3820cfababb2.mp4" controls="controls" muted="muted">

  </video>
</details>


<p dir="auto">first method: If 7-zip does not update, deleting the 7-zip.chm file will be sufficient to close the vulnerability.</p>
<p dir="auto">second method: The 7-zip program should only have read and run permissions. (For all users)</p>
</article>
          </div></div>
  </body>
</html>
