<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lemire.me/blog/2022/03/28/converting-integers-to-decimal-strings-faster-with-avx-512/">Original</a>
    <h1>Converting integers to decimal strings faster with AVX-512</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>In most systems, integers are stored using a fixed binary representation. It is common to store integers using 32-bit or 64-bit words. You sometimes need to convert it to a string. For example, the integer 12345 might need to be converted to the five characters ‘12345’.</p>
<p>In an <a href="https://lemire.me/blog/2021/11/18/converting-integers-to-fix-digit-representations-quickly/">earlier blog post</a>, I presented the simpler problem of converting integers to fixed-digit strings, using exactly 16-characters with leading zeroes as needed. For example, the integer 12345 becomes the string ‘0000000000012345’.</p>
<p>For this problem, the most practical approach might be a tree-based version with a small table. The core idea is to start from the integer, compute an integer representing the 8 most significant decimal digits, and another integer representing the least significant 8 decimal digit. Then we repeat, dividing the two eight-digit integers into two four-digit integers, and so forth until we get to two-digit integers in which case we use a small table to convert them to a decimal representation. The code in C++ might look as follows:</p>
<pre><span>void</span> to_string_tree_table<span>(</span>uint64_t x<span>,</span> <span>char</span> <span>*</span>out<span>)</span> <span>{</span>
  <span>static</span> <span>const</span> <span>char</span> table<span>[</span><span>200</span><span>]</span> <span>=</span> <span>{</span>
      <span>0x30</span><span>,</span> <span>0x30</span><span>,</span> <span>0x30</span><span>,</span> <span>0x31</span><span>,</span> <span>0x30</span><span>,</span> <span>0x32</span><span>,</span> <span>0x30</span><span>,</span> <span>0x33</span><span>,</span> <span>0x30</span><span>,</span> <span>0x34</span><span>,</span> <span>0x30</span><span>,</span> <span>0x35</span><span>,</span>
      <span>0x30</span><span>,</span> <span>0x36</span><span>,</span> <span>0x30</span><span>,</span> <span>0x37</span><span>,</span> <span>0x30</span><span>,</span> <span>0x38</span><span>,</span> <span>0x30</span><span>,</span> <span>0x39</span><span>,</span> <span>0x31</span><span>,</span> <span>0x30</span><span>,</span> <span>0x31</span><span>,</span> <span>0x31</span><span>,</span>
      <span>0x31</span><span>,</span> <span>0x32</span><span>,</span> <span>0x31</span><span>,</span> <span>0x33</span><span>,</span> <span>0x31</span><span>,</span> <span>0x34</span><span>,</span> <span>0x31</span><span>,</span> <span>0x35</span><span>,</span> <span>0x31</span><span>,</span> <span>0x36</span><span>,</span> <span>0x31</span><span>,</span> <span>0x37</span><span>,</span>
      <span>0x31</span><span>,</span> <span>0x38</span><span>,</span> <span>0x31</span><span>,</span> <span>0x39</span><span>,</span> <span>0x32</span><span>,</span> <span>0x30</span><span>,</span> <span>0x32</span><span>,</span> <span>0x31</span><span>,</span> <span>0x32</span><span>,</span> <span>0x32</span><span>,</span> <span>0x32</span><span>,</span> <span>0x33</span><span>,</span>
      <span>0x32</span><span>,</span> <span>0x34</span><span>,</span> <span>0x32</span><span>,</span> <span>0x35</span><span>,</span> <span>0x32</span><span>,</span> <span>0x36</span><span>,</span> <span>0x32</span><span>,</span> <span>0x37</span><span>,</span> <span>0x32</span><span>,</span> <span>0x38</span><span>,</span> <span>0x32</span><span>,</span> <span>0x39</span><span>,</span>
      <span>0x33</span><span>,</span> <span>0x30</span><span>,</span> <span>0x33</span><span>,</span> <span>0x31</span><span>,</span> <span>0x33</span><span>,</span> <span>0x32</span><span>,</span> <span>0x33</span><span>,</span> <span>0x33</span><span>,</span> <span>0x33</span><span>,</span> <span>0x34</span><span>,</span> <span>0x33</span><span>,</span> <span>0x35</span><span>,</span>
      <span>0x33</span><span>,</span> <span>0x36</span><span>,</span> <span>0x33</span><span>,</span> <span>0x37</span><span>,</span> <span>0x33</span><span>,</span> <span>0x38</span><span>,</span> <span>0x33</span><span>,</span> <span>0x39</span><span>,</span> <span>0x34</span><span>,</span> <span>0x30</span><span>,</span> <span>0x34</span><span>,</span> <span>0x31</span><span>,</span>
      <span>0x34</span><span>,</span> <span>0x32</span><span>,</span> <span>0x34</span><span>,</span> <span>0x33</span><span>,</span> <span>0x34</span><span>,</span> <span>0x34</span><span>,</span> <span>0x34</span><span>,</span> <span>0x35</span><span>,</span> <span>0x34</span><span>,</span> <span>0x36</span><span>,</span> <span>0x34</span><span>,</span> <span>0x37</span><span>,</span>
      <span>0x34</span><span>,</span> <span>0x38</span><span>,</span> <span>0x34</span><span>,</span> <span>0x39</span><span>,</span> <span>0x35</span><span>,</span> <span>0x30</span><span>,</span> <span>0x35</span><span>,</span> <span>0x31</span><span>,</span> <span>0x35</span><span>,</span> <span>0x32</span><span>,</span> <span>0x35</span><span>,</span> <span>0x33</span><span>,</span>
      <span>0x35</span><span>,</span> <span>0x34</span><span>,</span> <span>0x35</span><span>,</span> <span>0x35</span><span>,</span> <span>0x35</span><span>,</span> <span>0x36</span><span>,</span> <span>0x35</span><span>,</span> <span>0x37</span><span>,</span> <span>0x35</span><span>,</span> <span>0x38</span><span>,</span> <span>0x35</span><span>,</span> <span>0x39</span><span>,</span>
      <span>0x36</span><span>,</span> <span>0x30</span><span>,</span> <span>0x36</span><span>,</span> <span>0x31</span><span>,</span> <span>0x36</span><span>,</span> <span>0x32</span><span>,</span> <span>0x36</span><span>,</span> <span>0x33</span><span>,</span> <span>0x36</span><span>,</span> <span>0x34</span><span>,</span> <span>0x36</span><span>,</span> <span>0x35</span><span>,</span>
      <span>0x36</span><span>,</span> <span>0x36</span><span>,</span> <span>0x36</span><span>,</span> <span>0x37</span><span>,</span> <span>0x36</span><span>,</span> <span>0x38</span><span>,</span> <span>0x36</span><span>,</span> <span>0x39</span><span>,</span> <span>0x37</span><span>,</span> <span>0x30</span><span>,</span> <span>0x37</span><span>,</span> <span>0x31</span><span>,</span>
      <span>0x37</span><span>,</span> <span>0x32</span><span>,</span> <span>0x37</span><span>,</span> <span>0x33</span><span>,</span> <span>0x37</span><span>,</span> <span>0x34</span><span>,</span> <span>0x37</span><span>,</span> <span>0x35</span><span>,</span> <span>0x37</span><span>,</span> <span>0x36</span><span>,</span> <span>0x37</span><span>,</span> <span>0x37</span><span>,</span>
      <span>0x37</span><span>,</span> <span>0x38</span><span>,</span> <span>0x37</span><span>,</span> <span>0x39</span><span>,</span> <span>0x38</span><span>,</span> <span>0x30</span><span>,</span> <span>0x38</span><span>,</span> <span>0x31</span><span>,</span> <span>0x38</span><span>,</span> <span>0x32</span><span>,</span> <span>0x38</span><span>,</span> <span>0x33</span><span>,</span>
      <span>0x38</span><span>,</span> <span>0x34</span><span>,</span> <span>0x38</span><span>,</span> <span>0x35</span><span>,</span> <span>0x38</span><span>,</span> <span>0x36</span><span>,</span> <span>0x38</span><span>,</span> <span>0x37</span><span>,</span> <span>0x38</span><span>,</span> <span>0x38</span><span>,</span> <span>0x38</span><span>,</span> <span>0x39</span><span>,</span>
      <span>0x39</span><span>,</span> <span>0x30</span><span>,</span> <span>0x39</span><span>,</span> <span>0x31</span><span>,</span> <span>0x39</span><span>,</span> <span>0x32</span><span>,</span> <span>0x39</span><span>,</span> <span>0x33</span><span>,</span> <span>0x39</span><span>,</span> <span>0x34</span><span>,</span> <span>0x39</span><span>,</span> <span>0x35</span><span>,</span>
      <span>0x39</span><span>,</span> <span>0x36</span><span>,</span> <span>0x39</span><span>,</span> <span>0x37</span><span>,</span> <span>0x39</span><span>,</span> <span>0x38</span><span>,</span> <span>0x39</span><span>,</span> <span>0x39</span><span>,</span>
  <span>}</span><span>;</span>
  uint64_t top <span>=</span> x <span>/</span> <span>100000000</span><span>;</span>
  uint64_t bottom <span>=</span> x <span>%</span> <span>100000000</span><span>;</span>
  uint64_t toptop <span>=</span> top <span>/</span> <span>10000</span><span>;</span>
  uint64_t topbottom <span>=</span> top <span>%</span> <span>10000</span><span>;</span>
  uint64_t bottomtop <span>=</span> bottom <span>/</span> <span>10000</span><span>;</span>
  uint64_t bottombottom <span>=</span> bottom <span>%</span> <span>10000</span><span>;</span>
  uint64_t toptoptop <span>=</span> toptop <span>/</span> <span>100</span><span>;</span>
  uint64_t toptopbottom <span>=</span> toptop <span>%</span> <span>100</span><span>;</span>
  uint64_t topbottomtop <span>=</span> topbottom <span>/</span> <span>100</span><span>;</span>
  uint64_t topbottombottom <span>=</span> topbottom <span>%</span> <span>100</span><span>;</span>
  uint64_t bottomtoptop <span>=</span> bottomtop <span>/</span> <span>100</span><span>;</span>
  uint64_t bottomtopbottom <span>=</span> bottomtop <span>%</span> <span>100</span><span>;</span>
  uint64_t bottombottomtop <span>=</span> bottombottom <span>/</span> <span>100</span><span>;</span>
  uint64_t bottombottombottom <span>=</span> bottombottom <span>%</span> <span>100</span><span>;</span>
  <span>//</span>
  <span>memcpy</span><span>(</span>out<span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> toptoptop<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>2</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> toptopbottom<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>4</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> topbottomtop<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>6</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> topbottombottom<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>8</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> bottomtoptop<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>10</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> bottomtopbottom<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>12</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> bottombottomtop<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
  <span>memcpy</span><span>(</span>out <span>+</span> <span>14</span><span>,</span> <span>&amp;</span>table<span>[</span><span>2</span> <span>*</span> bottombottombottom<span>]</span><span>,</span> <span>2</span><span>)</span><span>;</span>
<span>}</span>
</pre>
<p>It compiles down to dozens of instructions.</p>
<p>Could you do better without using a much larger table?</p>
<p>It turns out that you can do much better if you have a recent Intel processor with the appropriate AVX-512 instructions (IFMA, VBMI), as demonstrated by an Internet user called InstLatX64.</p>
<p>We rely on the observation that you can compute directly the quotient and the remainder of the division using a series of multiplications and shifts (<a href="https://arxiv.org/abs/1902.01961">Lemire et al. 2019</a>).</p>
<p>The code is a bit technical, but remarkably, it does not require a table. And it generates several times fewer instructions. For the sake of simplicity, I merely provide an implementation using Intel intrinsics. Importantly, you are not expected to follow through with the code, but you should notice that it is rather short.</p>
<pre><span>void</span> to_string_avx512ifma<span>(</span>uint64_t n<span>,</span> <span>char</span> <span>*</span>out<span>)</span> <span>{</span>
  uint64_t n_15_08  <span>=</span> n <span>/</span> <span>100000000</span><span>;</span>
  uint64_t n_07_00  <span>=</span> n <span>%</span> <span>100000000</span><span>;</span>
  __m512i bcstq_h   <span>=</span> _mm512_set1_epi64<span>(</span>n_15_08<span>)</span><span>;</span>
  __m512i bcstq_l   <span>=</span> _mm512_set1_epi64<span>(</span>n_07_00<span>)</span><span>;</span>
  __m512i zmmzero   <span>=</span> _mm512_castsi128_si512<span>(</span>_mm_cvtsi64_si128<span>(</span><span>0x1A1A400</span><span>)</span><span>)</span><span>;</span>
  __m512i zmmTen    <span>=</span> _mm512_set1_epi64<span>(</span><span>10</span><span>)</span><span>;</span>
  __m512i asciiZero <span>=</span> _mm512_set1_epi64<span>(</span><span>&#39;0&#39;</span><span>)</span><span>;</span>

  __m512i ifma_const	<span>=</span> _mm512_setr_epi64<span>(</span><span>0x00000000002af31dc</span><span>,</span> <span>0x0000000001ad7f29b</span><span>,</span> 
    <span>0x0000000010c6f7a0c</span><span>,</span> <span>0x00000000a7c5ac472</span><span>,</span> <span>0x000000068db8bac72</span><span>,</span> <span>0x0000004189374bc6b</span><span>,</span>
    <span>0x0000028f5c28f5c29</span><span>,</span> <span>0x0000199999999999a</span><span>)</span><span>;</span>
  __m512i permb_const	<span>=</span> _mm512_castsi128_si512<span>(</span>_mm_set_epi8<span>(</span><span>0x78</span><span>,</span> <span>0x70</span><span>,</span> <span>0x68</span><span>,</span> <span>0x60</span><span>,</span> <span>0x58</span><span>,</span>
    <span>0x50</span><span>,</span> <span>0x48</span><span>,</span> <span>0x40</span><span>,</span> <span>0x38</span><span>,</span> <span>0x30</span><span>,</span> <span>0x28</span><span>,</span> <span>0x20</span><span>,</span> <span>0x18</span><span>,</span> <span>0x10</span><span>,</span> <span>0x08</span><span>,</span> <span>0x00</span><span>)</span><span>)</span><span>;</span>
  __m512i lowbits_h	<span>=</span> _mm512_madd52lo_epu64<span>(</span>zmmzero<span>,</span> bcstq_h<span>,</span> ifma_const<span>)</span><span>;</span>
  __m512i lowbits_l	<span>=</span> _mm512_madd52lo_epu64<span>(</span>zmmzero<span>,</span> bcstq_l<span>,</span> ifma_const<span>)</span><span>;</span>
  __m512i highbits_h	<span>=</span> _mm512_madd52hi_epu64<span>(</span>asciiZero<span>,</span> zmmTen<span>,</span> lowbits_h<span>)</span><span>;</span>
  __m512i highbits_l	<span>=</span> _mm512_madd52hi_epu64<span>(</span>asciiZero<span>,</span> zmmTen<span>,</span> lowbits_l<span>)</span><span>;</span>
  __m512i perm          <span>=</span> _mm512_permutex2var_epi8<span>(</span>highbits_h<span>,</span> permb_const<span>,</span> highbits_l<span>)</span><span>;</span>
  __m128i digits_15_0	<span>=</span> _mm512_castsi512_si128<span>(</span>perm<span>)</span><span>;</span>
  _mm_storeu_si128<span>(</span><span>(</span>__m128i <span>*</span><span>)</span>out<span>,</span> digits_15_0<span>)</span><span>;</span>
<span>}</span>
</pre>
<p>Remarkably, the AVX-512 is 3.5 times faster than the table-based approach:</p>
<table>
<tbody>
<tr>
<th>function</th>
<th>time per conversion</th>
</tr>
<tr>
<td>table</td>
<td>8.8 ns</td>
</tr>
<tr>
<td>AVX-512</td>
<td>2.5 ns</td>
</tr>
</tbody>
</table>
<p>I use GCC 9 and an Intel <a href="https://en.wikipedia.org/wiki/Tiger_Lake">Tiger Lake</a> processor  (3.30GHz). <a href="https://github.com/lemire/Code-used-on-Daniel-Lemire-s-blog/tree/master/2022/03/24">My benchmarking code is available</a>.</p>
<p>A downside of this nifty approach is that it is (obviously) non-portable. There are still few Intel processors supporting these nifty extensions, and it is currently limited to Intel: no AMD or ARM processor can do the same right now. However, the gain might be sufficient that it is worth the effort deploying it in some instances.</p>

</div></div>
  </body>
</html>
