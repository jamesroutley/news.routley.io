<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/mnurzia/rv">Original</a>
    <h1>Show HN: RISC-V core written in 600 lines of C89</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">RISC-V CPU core written in ANSI C.</p>
<p dir="auto">Features:</p>
<ul dir="auto">
<li><code>RV32IMC</code> user-level implementation</li>
<li>Passes all supported tests in <a href="https://github.com/riscv/riscv-tests"><code>riscv-tests</code></a></li>
<li>~600 lines of code</li>
<li>Doesn&#39;t use any integer types larger than 32 bits, even for multiplication</li>
<li>Simple API (two functions, plus two memory callback functions that you provide)</li>
<li>No memory allocations</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-api" aria-hidden="true" href="#api"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>API</h2>
<div dir="auto" data-snippet-clipboard-copy-content="/* Memory access callbacks: data is input/output, return RV_BAD on fault, 0 otherwise */
typedef rv_res (*rv_store_cb)(void *user, rv_u32 addr, rv_u8 data);
typedef rv_res (*rv_load_cb)(void *user, rv_u32 addr, rv_u8 *data);

/* Initialize CPU. */
void rv_init(rv *cpu, void *user, rv_load_cb load_cb, rv_store_cb store_cb);

/* Single-step CPU. Returns 0 on success, one of RV_E* on exception. */
rv_u32 rv_step(rv *cpu);"><pre><span><span>/*</span> Memory access callbacks: data is input/output, return RV_BAD on fault, 0 otherwise <span>*/</span></span>
<span>typedef</span> <span>rv_res</span> (*rv_store_cb)(<span>void</span> *user, rv_u32 addr, rv_u8 data);
<span>typedef</span> <span>rv_res</span> (*rv_load_cb)(<span>void</span> *user, rv_u32 addr, rv_u8 *data);

<span><span>/*</span> Initialize CPU. <span>*/</span></span>
<span>void</span> <span>rv_init</span>(rv *cpu, <span>void</span> *user, rv_load_cb load_cb, rv_store_cb store_cb);

<span><span>/*</span> Single-step CPU. Returns 0 on success, one of RV_E* on exception. <span>*/</span></span>
rv_u32 <span>rv_step</span>(rv *cpu);</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Usage</h2>
<div dir="auto" data-snippet-clipboard-copy-content="#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

#include &#34;rv.h&#34;

rv_res load_cb(void *user, rv_u32 addr, rv_u8 *data) {
  if (addr - 0x80000000 &gt; 0x10000) /* Reset vector is 0x80000000 */
    return RV_BAD;
  *data = ((rv_u8 *)(user))[addr - 0x80000000];
  return RV_OK;
}

rv_res store_cb(void *user, rv_u32 addr, rv_u8 data) {
  if (addr - 0x80000000 &gt; 0x10000)
    return RV_BAD;
  ((rv_u8 *)(user))[addr - 0x80000000] = data;
  return RV_OK;
}

rv_u32 program[2] = {
    /* _start: */
    0x02A88893, /* add a7, a7, 42 */
    0x00000073  /* ecall */
};

int main(void) {
  rv_u8 mem[0x10000];
  rv cpu;
  rv_init(&amp;cpu, (void *)mem, &amp;load_cb, &amp;store_cb);
  memcpy((void *)mem, (void *)program, sizeof(program));
  while (rv_step(&amp;cpu) != RV_EECALL) {
  }
  printf(&#34;Environment call @ %08X: %u\n&#34;, cpu.pc, cpu.r[17]);
  return 0;
}"><pre>#<span>include</span> <span><span>&lt;</span>stdio.h<span>&gt;</span></span>
#<span>include</span> <span><span>&lt;</span>string.h<span>&gt;</span></span>

#<span>include</span> <span><span>&#34;</span>rv.h<span>&#34;</span></span>

rv_res <span>load_cb</span>(<span>void</span> *user, rv_u32 addr, rv_u8 *data) {
  <span>if</span> (addr - <span>0x80000000</span> &gt; <span>0x10000</span>) <span><span>/*</span> Reset vector is 0x80000000 <span>*/</span></span>
    <span>return</span> RV_BAD;
  *data = ((rv_u8 *)(user))[addr - <span>0x80000000</span>];
  <span>return</span> RV_OK;
}

rv_res <span>store_cb</span>(<span>void</span> *user, rv_u32 addr, rv_u8 data) {
  <span>if</span> (addr - <span>0x80000000</span> &gt; <span>0x10000</span>)
    <span>return</span> RV_BAD;
  ((rv_u8 *)(user))[addr - <span>0x80000000</span>] = data;
  <span>return</span> RV_OK;
}

rv_u32 program[<span>2</span>] = {
    <span><span>/*</span> _start: <span>*/</span></span>
    <span>0x02A88893</span>, <span><span>/*</span> add a7, a7, 42 <span>*/</span></span>
    <span>0x00000073</span>  <span><span>/*</span> ecall <span>*/</span></span>
};

<span>int</span> <span>main</span>(<span>void</span>) {
  rv_u8 mem[<span>0x10000</span>];
  rv cpu;
  <span>rv_init</span>(&amp;cpu, (<span>void</span> *)mem, &amp;load_cb, &amp;store_cb);
  <span>memcpy</span>((<span>void</span> *)mem, (<span>void</span> *)program, <span>sizeof</span>(program));
  <span>while</span> (<span>rv_step</span>(&amp;cpu) != RV_EECALL) {
  }
  <span>printf</span>(<span><span>&#34;</span>Environment call @ <span>%08X</span>: <span>%u</span><span>\n</span><span>&#34;</span></span>, cpu.<span>pc</span>, cpu.<span>r</span>[<span>17</span>]);
  <span>return</span> <span>0</span>;
}</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-targeting-rv" aria-hidden="true" href="#targeting-rv"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Targeting <code>rv</code></h2>
<p dir="auto">Use <a href="https://github.com/riscv-collab/riscv-gnu-toolchain">riscv-gnu-toolchain</a> with <a href="https://github.com/mnurzia/rv/blob/main/tools/link.ld">tools/link.ld</a>.</p>
<p dir="auto">Suggested GCC commandline:</p>
<p dir="auto"><code>riscv64-unknown-elf-gcc example.S -nostdlib -nostartfiles -Tlink.ld -march=rv32imc -mabi=ilp32 -o example.o -e _start -g -no-pie</code></p>
<p dir="auto">To dump a binary starting at <code>0x80000000</code> that can be directly loaded by <code>rv</code> as in the above example:</p>
<p dir="auto"><code>riscv64-unknown-elf-objcopy -g -O binary example.o example.bin</code></p>
<h2 tabindex="-1" dir="auto"><a id="user-content-instruction-list" aria-hidden="true" href="#instruction-list"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Instruction List</h2>
<p dir="auto">Click an instruction to see its implementation in <code>rv.c</code>.</p>
<ul dir="auto">
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L419"><code>add       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L419"><code>addi      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L433"><code>and       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L433"><code>andi      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L505"><code>auipc     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L375"><code>beq       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L378"><code>bge       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L380"><code>bgtu      </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L377"><code>blt       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L379"><code>bltu      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L376"><code>bne       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L296"><code>c.add     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L237"><code>c.addi    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L244"><code>c.addi16sp</code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L265"><code>c.and     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L256"><code>c.andi    </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L275"><code>c.beqz    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L277"><code>c.bnez    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L273"><code>c.j       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L239"><code>c.jal     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L293"><code>c.jalr    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L288"><code>c.jr      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L241"><code>c.li      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L246"><code>c.lui     </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L229"><code>c.lw      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L285"><code>c.lwsp    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L290"><code>c.mv      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L263"><code>c.or      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L283"><code>c.slli    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L254"><code>c.srai    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L252"><code>c.srli    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L259"><code>c.sub     </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L231"><code>c.sw      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L298"><code>c.swsp    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L261"><code>c.xor     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L481"><code>csrrc     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L481"><code>csrrci    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L475"><code>csrrs     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L475"><code>csrrsi    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L466"><code>csrrw     </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L466"><code>csrrwi    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L451"><code>div       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L453"><code>divu      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L494"><code>ebreak    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L491"><code>ecall     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L397"><code>fence     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L401"><code>fence.i   </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L405"><code>jal       </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L390"><code>jalr      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L330"><code>lb        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L338"><code>lbu       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L333"><code>lh        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L341"><code>lhu       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L507"><code>lui       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L336"><code>lw        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L489"><code>mret      </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L438"><code>mul       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L438"><code>mulh      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L438"><code>mulhsu    </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L438"><code>mulhu     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L431"><code>or        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L431"><code>ori       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L455"><code>rem       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L457"><code>remu      </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L359"><code>sb        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L361"><code>sh        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L421"><code>sll       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L421"><code>slli      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L423"><code>slt       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L423"><code>slti      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L425"><code>sltiu     </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L425"><code>sltu      </code></a></li>
<li><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L429"><code>sra       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L429"><code>srai      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L429"><code>srl       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L429"><code>srli      </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L419"><code>sub       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L363"><code>sw        </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L427"><code>xor       </code></a><a href="https://github.com/mnurzia/rv/blob/main/rv.c#L427"><code>xori      </code></a></li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-caveats" aria-hidden="true" href="#caveats"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Caveats</h2>
<ul dir="auto">
<li>Written in C89.</li>
<li>Not actually written in C89, since it uses external names longer than 6 characters.</li>
<li>Doesn&#39;t use any integer types larger than 32 bits, even for multiplication, because it&#39;s written in C89.</li>
<li>Assumes width of integer types in a way that&#39;s not completely compliant with C89/99. Fix for this is coming soon, I&#39;m working on a watertight <code>&lt;stdint.h&gt;</code> for C89.</li>
<li>Written in C89.</li>
</ul>
</article>
          </div></div>
  </body>
</html>
