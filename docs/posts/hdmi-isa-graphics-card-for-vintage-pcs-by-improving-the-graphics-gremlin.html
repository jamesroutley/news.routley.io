<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://yeokhengmeng.com/2023/09/hdmi-isa-graphics-card-for-vintage-pcs/">Original</a>
    <h1>HDMI ISA graphics card for vintage PCs by improving the Graphics Gremlin</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>HDMI is a relatively modern video connector we take for granted on modern PCs and monitors. Now vintage PCs can join in the fun too with a native connection to modern HDMI monitors without any additional adapter.</p>

<p>2 years ago, I learned of an open-source project called Graphics Gremlin (GG) by <a href="https://www.linkedin.com/in/eric-schlaepfer-5ab72315/">Eric Schlaepfer</a> who runs the website <a href="https://tubetime.us/">Tubetime.us</a>. It is an 8-bit ISA graphics card that supports display standards like <a href="https://en.wikipedia.org/wiki/Color_Graphics_Adapter">Color Graphics Adapter (CGA)</a> and <a href="https://en.wikipedia.org/wiki/IBM_Monochrome_Display_Adapter">Monochrome Display Adapter (MDA)</a>. CGA and MDA are display standards used by older IBM(-compatible) PCs in the 1980s.</p>
<p>The frequencies and connectors used by CGA and MDA are no longer supported by modern monitors hence it is difficult for older PCs of the 1980s era to have modern displays connected to them without external adapters. GG addresses this problem by using techniques like scan doubling (for CGA) and increasing the vertical refresh rate (for MDA) then outputing to a relatively newer but still old VGA port.</p>
<p>I fabricated and assembled the design then installed it into my <a href="https://github.com/yeokm1/retro-configs/tree/master/desktops/ibm-5155">IBM5155</a>.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-original.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-original.jpg" width="600"/></a></p><p>GG provides outputs in VGA, Composite and DB9 RGBI.</p>
<p>However 2 issues bugged me about this card:</p>
<ol>
<li>
<p>The Composite video and VGA port cannot be used at the same time due to pin sharing between both ports. Switching between them is possible by flipping physical switches on the card. However on my IBM5155, the internal CRT monitor runs on Composite hence if I want to use an external monitor, the internal CRT becomes unusable.</p>
</li>
<li>
<p>Modern monitors have long started to omit the analog VGA inputs in favour of modern digital ports like HDMI or Displayport. This requires a VGA-to-HDMI adapter. This analog-to-digital conversion will also lead to an inevitable loss in video quality. Such adapters also require an external power source such as USB. Vintage PCs usually don’t have USB outputs so supplying power with an additional USB power adapter leads to more setup hassles.</p>
</li>
</ol>
<p>I decided to modify the GG design so it can connect natively to an external HDMI monitor and service the internal Composite-based CRT at the same time.</p>

<p>The core of the GG is the Lattice iCE40HX4K FPGA. It is responsible for handling instructions from the ISA bus and generating the appropriate video signals.</p>
<p>512KiB video RAM is provided by ISSI IS61WV5128BLL. 3 bitstreams are stored in a 8Mbit Microchip SST26VF080A SPI flash. These bitstreams are:</p>
<ol>
<li>MDA output using a VGA compatible 70Hz refresh rate</li>
<li>MDA output to RGBI port at 50Hz refresh rate (incompatible with VGA monitors)</li>
<li>CGA output. RGBI connector will output at 320x200 60Hz while VGA will be scan doubled to 640x400 60Hz.</li>
</ol>
<p>RGBI output is driven directly from the FPGA since it is just a TTL signal. Analog VGA signal is generated using a DAC resistor ladder. Composite is driven from the green VGA pin hence why Composite and VGA cannot be used at the same time.</p>
<p>The code is written in Verilog HDL and uses the open source <a href="https://clifford.at/icestorm">Project Icestorm</a> toolchain.</p>
<p>One interesting thing that the GG design has is it will display a blinking test pattern if it is powered on but the host PC has yet to command it to display anything.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-test-pattern.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-test-pattern.jpg" width="800"/></a></p><p>The left is the test pattern for CGA and the right is MDA.</p>
<p>This test pattern proved very useful for me as it means I don’t need the card to be plugged into a PC while I’m testing any code changes.</p>

<h2 id="summary">Summary</h2>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-top-both.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-top-both.jpg" width="800"/></a></p><p>Left is the original GG, right is my modified design.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-board-ports.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-board-ports.jpg" width="800"/></a></p><p>View from the ports side.</p>

<p>
  <iframe src="https://www.youtube.com/embed/xLy6on_o4YM" allowfullscreen="" title="YouTube Video"></iframe>
</p>

<p>This is the demo video using the updated GG card in my IBM5155 outputing HDMI to my 5:4 Dell P1917S monitor and Composite to my small LCD screen.</p>
<p>This video shows the bootup process from a cold start to the DOS 6.22 command line. After that I run <a href="https://github.com/MobyGamer/CGACompatibilityTester">CGA Compatibility tester</a> to check the output.</p>
<p>The entire updated PCB design and Verilog code has been open-sourced here: <a href="https://github.com/yeokm1/graphics-gremlin-hdmi">https://github.com/yeokm1/graphics-gremlin-hdmi</a></p>
<p>Here is a summary of changes I made some which I will cover further down this post.</p>
<ul>
<li>Hardware changes
<ul>
<li>Added HDMI port by removing the RGBI DB9 port. Port positions adjusted to ease trace routing.</li>
<li>Added <a href="https://www.ti.com/product/TFP410">TI TFP410</a> DVI transmitter (HDMI is compatible with DVI). HDMI is independent of the VGA/Composite output.</li>
<li>Test points for inputs to DVI transmitter</li>
<li>Replaced the 3.3VDC 1A linear regulator with 3A as TFP410 is power hungry at up to 1A.</li>
<li>Added pin headers for power.</li>
<li>Added LED power indicators for 5V and 3.3V.</li>
</ul>
</li>
<li>HDL code changes
<ul>
<li>Selectable MDA colours</li>
<li>Removed normal MDA bitstream as there is no more RGBI port.</li>
<li>Added CGA 70Hz mode.</li>
<li>Modified Scandoubler code to support Display Enable signal as required by DVI chip but not VGA</li>
</ul>
</li>
</ul>

<h2 id="hdmi-support-through-dvi-transmitter-ic">HDMI support through DVI transmitter IC</h2>
<p>HDMI (and DVI) use Transition-Minimized Differential Signaling (TMDS) lines. The ICE40 FPGA however does not have that. Online searches garnered that some people have <a href="https://hackaday.io/page/5702-dvi-hdmi-pmod-for-an-ice40-fpga">used workarounds</a> to generate the differential signals however I’m not sure how compatible or spec-compliant those are.</p>
<p>I decided to go for more reliable option by using a dedicated DVI transmitter TI TFP410. I referred to an <a href="https://blackmesalabs.wordpress.com/2017/12/15/bml-hdmi-video-for-fpgas-over-pmod/">open-source PMOD schematic from Black Mesa Labs</a> to integrate this chip into the Graphics Gremlin.</p>
<p>The TFP410 accepts a 24-bit RGB colour data input. Ideally, we should connect all 24 pins to the FPGA directly but there are not many spare pins left in the ICE40HX. The only FPGA pins available are those meant for the external RGBI port which I dropped. These pins include the 4 colour signals, red, green, blue and intensity are thus repurposed to talk to the TFP410.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-tfp410-sch-snippet.png"><img src="https://erikarow.land/notes/images/gg-hdmi-tfp410-sch-snippet.png" width="250"/></a></p><p>To simulate an RGBI monitor, the 3 base colour signals are connected to the MSB of the colour input with the intensity bit shared among all as the second-most significant bit.</p>
<p>The TFP410 will also handle the appropriate 8b/10b encoding to ensure a proper TMDS data signal for DVI. Since a HDMI connector is electrically similar to DVI, the DVI transmitter output can be directly wired to the HDMI port.</p>
<h2 id="test-points">Test points</h2>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-board.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-board.jpg" width="800"/></a></p><p>Various test points were added to the board. The data inputs from the FPGA to the TFP410 are as follows:</p>
<ul>
<li>Red, Green, Blue, Intensity</li>
<li>Horizontal Sync (HS)</li>
<li>Vertical Sync (VS)</li>
<li>Display Enable (DE)</li>
<li>Clock (CLK)</li>
</ul>
<p>These inputs with 3.3V and GND are broken out as standard 2.54mm pin headers in the style of a PMOD.</p>
<p>I also added power LEDs and pin headers to the left of the board so I can monitor power state and power the board without having to connect to an actual vintage machine with ISA bus and displaying something.</p>

<h2 id="supporting-the-dvi-transmitter-chip">Supporting the DVI transmitter chip</h2>
<p>The Verilog code has to be modified to send data in an appropriate format to the DVI chip.</p>
<p>Most of the original RGBI lines meant for the DB9 monitor connector, RGBI, HS, VS lines are similar. However the CLK and DE lines are not used before and hence has to be provided. CLK was relatively easy to get and wire out to the DVI chip. However DE was slightly more problematic.</p>
<p>In the original IBM CGA/MDA graphics card, there exists a chip called a <a href="https://en.wikipedia.org/wiki/Motorola_6845">Motorola 6845</a> which generates the Cathode Ray Tube (CRT) control signals. It is also known as a CRTC6845 and the DE line is also generated here.</p>
<p>In the code, the behaviour of this chip is emulated in <a href="https://github.com/schlae/graphics-gremlin/blob/main/verilog/crtc6845.v">crtc6845.v</a>. The DE line output of this module has to be pulled out and wired to the DVI chip.</p>
<p>In CGA mode, the code contains a <a href="https://github.com/schlae/graphics-gremlin/blob/main/verilog/cga_scandoubler.v">cga_scandoubler.v</a> to double the number of horizontal lines and frequency to change the number of viewable vertical lines from 640x200 to 640x400 to make it more compatible for modern displays. It does this by doing double buffering with 2 arrays. One array is read out twice for each line using twice the usual pixel clock while the other array is being written to by the host PC then both arrays are swapped at the end of line.</p>
<p>I modified this Scandoubler to cache the DE bit as well.</p>
<h2 id="selectable-mda-colours">Selectable MDA colours</h2>
<p>In the original GG, the MDA output is a constant amber (see photo in an earlier section). I didn’t particularly like amber. I wanted to have a customisable colour option depending on my needs. Since 2 of the physical switches are unused in MDA mode, I programmed the ability to change the colours depending on what switch is selected.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-mda-display.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-mda-display.jpg" width="800"/></a></p><p>Depending on switch state, colours like green, yellow, white and red are selectable on-the-fly.</p>
<h2 id="additional-cga-70hz-mode">Additional CGA 70Hz mode</h2>
<p>According to page 18 of the <a href="https://www.cs.unc.edu/Research/stc/FAQs/Video/dvi_spec-V1_0.pdf">DVI 1.0 specification</a>, the minimum acceptable for DVI is a pixel clock of 25.175Mhz for 640x480 60Hz.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-dvi-lowest.png"><img src="https://erikarow.land/notes/images/gg-hdmi-dvi-lowest.png" width="600"/></a></p><p>Even after scandoubling, the current resolution of 640x400 60Hz is technically below the minimum acceptable. I have tested with the monitors I have up to a modern Dell S2721QS 4K monitor and Sony TV and all can accept 640x400 60Hz with no problems.</p>
<p>Nevertheless to adhere to the specification, I decided to provide another selectable CGA bitstream to drive the pixel clock higher so as to produce 640x400 at 70Hz in case some displays cannot accept a lower pixel clock.</p>
<p>At this mode though, the IBM5155 internal CRT and external composite display will no longer work.</p>

<p>During the design process, I used several tools to help me.</p>
<p>As I would find out, if one sends an improper display signal to the monitor, most monitors will tell you the signal is out of specification and not elaborate more otherwise nothing is shown at all.</p>
<p>This makes it extremely difficult to troubleshoot what went wrong.</p>
<h2 id="digilent-digital-discovery">Digilent Digital Discovery</h2>
<p>The Digilent Digital Discovery (DDD) is a relatively low-cost USB logic analyzer for the specifications/features.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-ddd.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-ddd.jpg" width="600"/></a></p><p>It can sample up to 800 MS/s depending on the number of channels active at one time. Compared to most osilloscopes, it has 2 GBit of RAM which allows me to store plenty of samples. This is especially required given the data samples I was working with and I need to capture at least several frames.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-waveforms.png"><img src="https://erikarow.land/notes/images/gg-hdmi-waveforms.png" width="800"/></a></p><p>This is a sample capture of the Clock, Display Enable, Vertical Sync and Horizontal Sync signals on the Digilent Waveforms software.</p>
<h2 id="testing-with-mimas-a7-xilinx-artix-7">Testing with Mimas A7 (Xilinx Artix 7)</h2>
<p>As part of my testing, I also made a small FPGA test project using another FPGA board Mimas A7 based on the Xilinx Artix 7.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-with-mimas-a7.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-with-mimas-a7.jpg" width="600"/></a></p><p>The FPGA test board reads the raw signals that are given to the DVI transmitter and displays the output using its own HDMI output. Visualising the signals makes it easier to literally see and troubleshoot what the problem could be instead of just looking at the raw logic levels from the logic analyser output.</p>
<p>The code is heavily based on the <a href="https://github.com/dominic-meads/HDMI_FPGA/">HDMI_FPGA</a> project by Dominic Meads and runs on Vivado 2023.</p>
<h2 id="486-pc">486 PC</h2>
<p>Instead of going to my precious IBM5155 directly, I used my <a href="https://erikarow.land/2021/05/setting-up-a-486-retro-pc/">486 PC</a> for intermediate testing.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-486-cga.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-486-cga.jpg" width="400"/></a></p><p>The BIOS of my 486 motherboard has the ability to change to the different CGA and MDA modes on top of its more period correct VGA mode. This helped me in my testing as I can more easily switch between the video modes compared to my <a href="https://www.minuszerodegrees.net/5160/misc/5160_motherboard_switch_settings.htm">IBM5155 which uses physical switch settings</a>.</p>
<h2 id="install-in-my-ibm5155">Install in my IBM5155</h2>
<p>After I was more confident on the card’s functionality, final tests were done in my IBM5155.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-ibm5155-top.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-ibm5155-top.jpg" width="400"/></a></p><p>The card installed in the slot closest to the CRT monitor with the internal composite cable connected.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-ibm5155-back.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-ibm5155-back.jpg" width="400"/></a></p><p>The rear of my IBM5155 shows the HDMI connector, probably the first to have one?</p>
<p>I didn’t design a new card bracket so I used a twist tie to secure the card to the enclosure.</p>

<p>This palette value “I:0 R:1 G:1 B:0” is not handled correctly by this card and is displayed as dark yellow instead of brown as per how the <a href="https://www.aceinnova.com/en/electronics/cga-and-the-brown-color-in-ibm-5153-color-display/">IBM5153 Colour Display Monitor does it</a>. When an IBM5153 monitor sees this signal “I:0 R:1 G:1 B:0”, the green component is halved producing a brown colour.</p>
<p>In order to emulate this behaviour for modern displays, the FPGA itself will have to halve the green colour component which means I will need more signal lines to the DVI transmitter. However I lack the pins on the FPGA to provide more than a 4-bit RGBI output.</p>
<p><a href="https://erikarow.land/notes/images/gg-hdmi-cga-test.jpg"><img src="https://erikarow.land/notes/images/gg-hdmi-cga-test.jpg" width="600"/></a></p><p>My IBM 5155 running the <a href="https://github.com/MobyGamer/CGACompatibilityTester">CGA Compatibility Tester</a> displaying the colour palatte. One can see the brown colour is displayed incorrectly as dark yellow.</p>
<p>The original GG does not suffer from this problem as the brown colour can be easily generated with the existing FPGA pins to the VGA resistor DAC.</p>

<p>This project was a long journey for me. If you look at the silkscreen date on the PCB, it shows 9 August 2021. At that time, I designed the PCB without the skills to code in Verilog. Even though the number of changes I made are small, it took me quite a bit of time on the side to finally pick up the skills to work on my first FPGA project with all development and testing work this project entails.</p>
<p>Not forgetting I’m actually standing on the shoulders of giants like Eric Schlaepfer who designed the original Graphics Gremlin. I’m just building on a small increment on top of his work.</p>
  </div></div>
  </body>
</html>
