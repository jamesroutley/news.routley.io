<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fasterthanli.me/series/dont-shell-out/part-1">Original</a>
    <h1>Truly Headless Draw.io Exports</h1>
    
    <div id="readability-page-1" class="page"><div>
  

  <p>I love diagrams. I love them so much! In fact, I have fairly poor visualization
skills, so making a diagram is extremely helpful to me: I&#39;ll have some vague
idea of how different things are connected, and then I&#39;ll make a diagram, and
suddenly there&#39;s a tangible thing I can look at and talk about.</p>
<p>Of course the diagram only represents a fraction of what I had in mind in the
first place, but that&#39;s okay: the point is to be able to talk about <em>some
aspect</em> of a concept, and so I have to make choices about what to include in the
diagram. And maybe make several diagrams.</p>
<p>So, over the past couple years, I&#39;ve made a lot of diagrams. Here&#39;s one diagram
I&#39;m particularly happy about: it describes the ELF file format, and it&#39;s from the
<a href="https://fasterthanli.me/series/making-our-own-executable-packer">Making our own executable packer series</a>.</p>
<p><img src="https://fasterthanli.me/content/series/making-our-own-executable-packer/part-1/assets/elf64-file-header.7ee277618b2ed27a.svg" alt="" loading="lazy"/></p><p>I&#39;ve made that diagram using the
<a href="https://github.com/jgraph/drawio-desktop">draw.io</a> desktop application, much
like all the other diagrams I&#39;ve made. It&#39;s an Electron app, which, <a href="https://www.youtube.com/watch?v=hnaGZHe8wws">don&#39;t
hate</a>, and also it runs everywhere
and works great.</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/drawio-desktop.af0c492e21d77ec4.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/drawio-desktop.2f5a1cba5952d915.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/drawio-desktop.1d5765c6ad3961e3.jpg"/>
            </picture>
            
<p>I&#39;ve made <a href="https://fasterthanli.me/articles/a-new-website-for-2020">a bunch of custom tooling for my
website</a>. For example, I save screenshots as
<code>.png</code> files, but then they get converted to <code>.jpg</code>, <code>.webp</code> and <code>.avif</code>, and
then the best of these is served to your browser. The .png is just the source of
truth.</p>
<p>Originally, I took screenshots of draw.io — my early articles showed the grid
and everything. They were also &#34;raster&#34; (or &#34;bitmaps&#34;), ie. a finite number of
pixels, which looked okay on the machine I used to write articles, but not on
some fancy HiDPI screen.</p>
<figure>
  
            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/lenovo-x200.69b90554948477ba.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/lenovo-x200.f7d61a365583e6f6.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/lenovo-x200.9c463b5ba3a22136.jpg"/>
            </picture>
            
  <figcaption>
<h4>A Lenovo X200, the laptop I started writing articles on.</h4>
</figcaption>
</figure>
<p>Those screenshots were also not dark mode friendly (whereas the diagrams I do
now are - well, they just color flip, but at least you don&#39;t get an unholy
dark/light mix), and they were fairly hard to maintain: I usually had one large
<code>.drawio</code> file and did separate &#34;rectangular selection&#34; screenshots. Updating
diagrams was <em>a lot of work</em>.</p>
<p>So, pretty soon I wanted the same workflow I had with screenshots: to be able to
just save a <code>.drawio</code> file somewhere, and have whatever needs to happen happen,
so that I could get best-of-class vector graphics in the browser.</p>
<p>I wasn&#39;t really prepared for what came next.</p>
<h2>What&#39;s in a <code>.drawio</code> file?</h2>
<p>When I complained about converting <code>.drawio</code> files to something else, someone
online said &#34;well buddy that&#39;s what you get for using proprietary formats&#34;.</p>
<p>First off.... hello. Second, is it actually proprietary?</p>
<p>Let&#39;s find out!</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/drawio-compressed.69cfde8598318731.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/drawio-compressed.533f1a64644d1fe1.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/drawio-compressed.a18774808e6c702f.jpg"/>
            </picture>
            
<p>Mhh. That looks like XML... but with some binary payload in there? What&#39;s up with that?</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/compressed-setting.84ab3575750032bf.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/compressed-setting.7e20768a3fc66977.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/compressed-setting.705e44b33481a7fa.jpg"/>
            </picture>
            
<p>Ah right, it&#39;s compressed. Let&#39;s uncheck that and look at the result:</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/drawio-uncompressed.a36f9429de02551a.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/drawio-uncompressed.5098d11f4161f6db.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/drawio-uncompressed.71e8c8c131107952.jpg"/>
            </picture>
            
<p>Alright! It is just XML. But it&#39;s not, say, SVG. Can we get draw.io to export as
SVG? Yes we can! There&#39;s an &#34;export as SVG&#34; option in there.</p>
<p>We can also do it from the comfort of the command line:</p>
<pre><p>Shell session</p><p><code>$ drawio elf64-file-header.drawio --crop --export --format svg --output /tmp/elf-file-header.svg
libva error: vaGetDriverNameByIndex() failed with unknown libva error, driver_name = (null)
elf64-file-header.drawio -&gt; /tmp/elf-file-header.svg
</code></p></pre><div>

<p>Ignore the libva error - just another day on the Linux desktop.</p>
</div>
<p>If we open that SVG in, say, Google Chrome, it looks fine:</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/svg-in-chrome.c72059a4a33afc77.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/svg-in-chrome.ac2ee1ab786caf5f.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/svg-in-chrome.5d24860e8674609e.jpg"/>
            </picture>
            
<p>But if we open it, in say, <a href="https://wiki.gnome.org/Apps/EyeOfGnome">GNOME&#39;s default image viewer</a>... it doesn&#39;t!</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/svg-in-eog.249697763264fcf5.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/svg-in-eog.343b7e47684e7a03.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/svg-in-eog.58b11ed6ac3df181.jpg"/>
            </picture>
            
<p>Mhh, I&#39;m sure draw.io has other export options... how about PDF?</p>
<pre><p>Shell session</p><p><code>$ drawio elf64-file-header.drawio --crop --export --format pdf --output /tmp/elf-file-header.pdf
libva error: vaGetDriverNameByIndex() failed with unknown libva error, driver_name = (null)
elf64-file-header.drawio -&gt; /tmp/elf-file-header.pdf
</code></p></pre>
<p>Looks fine in Chrome:</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/pdf-in-chrome.a16b9210d910bdb8.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/pdf-in-chrome.f045141716e4493c.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/pdf-in-chrome.fb8ddbedc11c3b53.jpg"/>
            </picture>
            
<p>And it looks fine in <a href="https://wiki.gnome.org/Apps/Evince">GNOME&#39;s default document viewer</a>!</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/pdf-in-evince.8748eecacbc74dc0.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/pdf-in-evince.4c42819355c7d319.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/pdf-in-evince.03097d2e74512225.jpg"/>
            </picture>
            
<p>Great!</p>
<div>

<p>But amos... you can&#39;t embed PDFs in web pages!</p>
</div>
<p>I know that! But a) the layout is right, and b) it&#39;s still vector graphics. I&#39;m
sure there&#39;s a way to from PDF back to SVG...</p>
<div>

<p>But you don&#39;t even know why draw.io&#39;s SVG export &#34;didn&#39;t work right&#34; in the
first place.</p>
</div>
<p>That&#39;s true. We don&#39;t even know that it&#39;s &#34;wrong&#34; per se, just that it looked
weird in Eye of Gnome. But here&#39;s something you may have not considered bear:
I&#39;d like my diagrams to look the same everywhere.</p>
<div>

<p>So? What would make them look different?</p>
</div>
<p>Well, tons of things! But most importantly, fonts. I use the wonderful
<a href="https://typeof.net/Iosevka/">Iosevka</a> font for all my diagrams. What do you
think would happen if people opened the SVG on a computer that didn&#39;t have that
font installed?</p>
<div>

<p>Well... I&#39;m fairly sure PDF has a way to embed fonts... as for SVG, it&#39;d probably
show the wrong font. Unless you have it set up as a <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Styling_text/Web_fonts">web font</a>?</p>
</div>
<p>Correct on all counts! Except I want people to be able to download diagrams and
share them, maybe print them.</p>
<div>

<p>Mhh... so the text can&#39;t be an SVG text element that says &#34;use this font&#34;? It has
to be actual paths?</p>
</div>
<p>That&#39;s right! Luckily, there&#39;s a tool that lets us do both &#34;go from PDF to SVG&#34;
and &#34;convert text to paths&#34;, and that tool is <a href="https://inkscape.org/">Inkscape</a>.</p>
<p>We can do that from the command line:</p>
<pre><p>Shell session</p><p><code>$ inkscape /tmp/elf-file-header.pdf --pdf-poppler --export-plain-svg --export-text-to-path --export-filename /tmp/elf-file-header.pdf.svg

$ ls -lhA /tmp/elf-fil*
-rw-r--r--. 1 amos amos 110K Nov 17 11:39 /tmp/elf-file-header.pdf
-rw-r--r--. 1 amos amos 538K Nov 17 11:47 /tmp/elf-file-header.pdf.svg
-rw-r--r--. 1 amos amos  65K Nov 17 11:35 /tmp/elf-file-header.svg
</code></p></pre><div>

<p>Whoa, that&#39;s <em>much</em> larger than draw.io&#39;s original svg output!</p>
</div>
<p>It is! But it looks great in Chrome...</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/pdfsvg-in-chrome.646720a8c7f6210e.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/pdfsvg-in-chrome.063c4061e25b4065.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/pdfsvg-in-chrome.9ede0d7fdad07e9e.jpg"/>
            </picture>
            
<p>And in Eye of Gnome:</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/pdfsvg-in-eog.9ec842f904ad99a9.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/pdfsvg-in-eog.255a979d3b6528c7.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/pdfsvg-in-eog.6e3422ad8b83bafa.jpg"/>
            </picture>
            
<p>And where the original SVG referred to the Iosevka font, that one doesn&#39;t:</p>
<pre><p>Shell session</p><p><code>$ xmllint --format /tmp/elf-file-header.svg | grep --color=always Iosevka | head
              &lt;div style=&#34;display: inline-block; font-size: 16px; font-family: Iosevka; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;&#34;&gt;
        &lt;text x=&#34;479&#34; y=&#34;129&#34; fill=&#34;rgba(0, 0, 0, 1)&#34; font-family=&#34;Iosevka&#34; font-size=&#34;16px&#34;&gt;Entry poin...&lt;/text&gt;
              &lt;div style=&#34;display: inline-block; font-size: 16px; font-family: Iosevka; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;&#34;&gt;
        &lt;text x=&#34;569&#34; y=&#34;129&#34; fill=&#34;rgba(0, 0, 0, 1)&#34; font-family=&#34;Iosevka&#34; font-size=&#34;16px&#34;&gt;Table offs...&lt;/text&gt;
              &lt;div style=&#34;display: inline-block; font-size: 16px; font-family: Iosevka; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;&#34;&gt;
        &lt;text x=&#34;659&#34; y=&#34;129&#34; fill=&#34;rgba(0, 0, 0, 1)&#34; font-family=&#34;Iosevka&#34; font-size=&#34;16px&#34;&gt;Table offs...&lt;/text&gt;
              &lt;div style=&#34;display: inline-block; font-size: 16px; font-family: Iosevka; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;&#34;&gt;
        &lt;text x=&#34;749&#34; y=&#34;129&#34; fill=&#34;rgba(0, 0, 0, 1)&#34; font-family=&#34;Iosevka&#34; font-size=&#34;16px&#34;&gt;Flags...&lt;/text&gt;
              &lt;div style=&#34;display: inline-block; font-size: 16px; font-family: Iosevka; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;&#34;&gt;
        &lt;text x=&#34;749&#34; y=&#34;369&#34; fill=&#34;rgba(0, 0, 0, 1)&#34; font-family=&#34;Iosevka&#34; font-size=&#34;16px&#34;&gt;Header size...&lt;/text&gt;

$ xmllint --format /tmp/elf-file-header.pdf.svg | grep --color=always Iosevka | head
</code></p></pre><div>

<p>If you find yourself transported to a time before JSON and YAML ruled them all
and in the darkness bound them, and you need to pretty-print XML, there&#39;s a <a href="https://stackoverflow.com/a/16090892">few
options</a> at your disposal.</p>
<p>Also, <code>grep --color=always</code> is handy if you need to pipe to another utility like
<code>less -R</code>, <code>head</code>, <code>tail</code>, etc. By default, <code>grep</code> will detect that <a href="https://fasterthanli.me/articles/a-terminal-case-of-linux">stdout is
not a tty</a> and disable color, but in that
case, we really wanted to see colors (which you can&#39;t see above because it was
just copied and pasted).</p>
</div>
<p>So! Now we have a pretty chunky SVG, what do we do with it? It&#39;s great: always
displays right, crisp at any scale, can be downloaded and printed anywhere. But
it&#39;s big. Like, bigger than a PNG of the same size at a very high resolution,
because as it turns out, converting a lot of text to paths isn&#39;t free.</p>
<p>Well, we can &#34;optimize&#34; that SVG, with a tool like <a href="https://github.com/svg/svgo">svgo</a>:</p>
<pre><p>Shell session</p><p><code>$ svgo --input /tmp/elf-file-header.pdf.svg --output /tmp/elf-file-header.pdf.smol.svg

elf-file-header.pdf.svg:
Done in 478 ms!
537.335 KiB - 51.7% = 259.625 KiB
</code></p></pre>
<p>And just like that, we made it 50% smaller, and it displays the same:</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/before-after-svgo.f61e3e205d03aa01.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/before-after-svgo.7f5ce1e5f1923cc1.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/before-after-svgo.58a070fe2263a593.jpg"/>
            </picture>
            
<p>Because all of these steps, from <code>.drawio</code> to <code>.pdf</code>, then <code>.pdf</code> to <code>.svg</code>,
then <code>.svg</code> to <code>smaller .svg</code>, can be done from the command line (by invoking
<code>drawio</code>, <code>inkscape</code>, and <code>svgo</code> respectively), all that can be automated with
a single tool. And so that&#39;s exactly what I did!</p>
<div>

<p>So that&#39;s it right? Story&#39;s over?</p>
</div>
<p>Well... not quite.</p>
<h2>Containing the disaster</h2>
<p>As I&#39;ve confessed on <a href="https://patreon.com/fasterthanlime">my Patreon intro</a>, I
can&#39;t stay in one place. That also means I move across different computers, and
different operating systems, all the time. And so I set up my local website copy
from scratch more times than I&#39;m comfortable admitting - every couple articles
or so.</p>
<p>This may <em>seem</em> nightmarish to you, but you&#39;re wrong. This is good, actually,
because it makes me care a lot about what that workflow looks like (and I also
get to find out pretty early when something breaks. And it&#39;s usually something
minor I can fix right away, instead of having a &#34;frozen&#34; setup work for 10 years,
and then a LOT of work to bring everything up-to-date).</p>
<div>

<p>Anyone who&#39;s had the displeasure of meeting head-on with an ArchLinux install
that hasn&#39;t been tended to in over a year will know that pain.</p>
</div>
<p>So for the &#34;PNG to JPEG/AVIF/WEBP&#34; pipeline, I need a couple tools installed:
<a href="https://imagemagick.org/index.php">ImageMagick</a>,
<a href="https://github.com/AOMediaCodec/libavif">avifenc</a>, and
<a href="https://developers.google.com/speed/webp/docs/cwebp">cwebp</a>.</p>
<p>And for the &#34;draw.io to SVG&#34; pipeline, I need the <a href="https://github.com/jgraph/drawio-desktop">draw.io desktop
app</a>,
<a href="https://inkscape.org/">Inkscape</a>, and <a href="https://github.com/svg/svgo">svgo</a>.</p>
<p>That&#39;s a <em>bunch</em> of things to install. It&#39;s fine on Fedora for example, from
which I am writing these lines and hoping they find you well, because it has
packages for all of these. But Ubuntu only started shipping a package for
<code>avifenc</code> in Ubuntu 21.04, whereas I find myself interacting with Ubuntu 20.04
(two versions back) quite a bit, because it&#39;s an LTS release (<a href="https://wiki.ubuntu.com/Releases">long-term
support</a>).</p>
<p>So on Ubuntu 20.04, I need to build <code>avifenc</code> myself. And while it&#39;s definitely
not the worst experience I&#39;ve had (it doesn&#39;t <a href="https://github.com/openssl/openssl/blob/master/INSTALL.md">involve
Perl</a>, for example, and
at least <a href="https://twitter.com/fasterthanlime/status/1248015109978374144">it&#39;s not python</a>),
it can take a while, if I don&#39;t happen to be a beefy machine.</p>
<p>But there&#39;s another argument to be made. For diagrams, the <code>.drawio</code> file is the
source of truth. For bitmaps, the <code>.png</code> file is the source of truth. But since
I&#39;m using my own tool (salvage) to process those files <em>as I&#39;m writing
articles</em>, and deploying my website is a simple git pull from the server (which
watches for file modifications, rebuilds changed assets and atomically switches
to a newer deploy: it&#39;s fancier than it seems at first glance), that means that:</p>
<ul>
<li>for every image, I&#39;m committing 4 files (png, jpeg, webp, avif)</li>
<li>for every diagram, I&#39;m committing 2 files (drawio, svg)</li>
</ul>
<p>And... it adds up.</p>
<pre><p>Shell session</p><p><code>$ z fast
$ du -h -d0
906M    .
</code></p></pre><div>

<p><a href="https://lib.rs/crates/zoxide">zoxide</a> (shown here as <code>z</code>) is a smarter cd
command for your terminal. It remembers which directories you <code>cd</code> to a lot, and
lets you jump to them using a shorter substring. In this instance, this was
equivalent to <code>cd ~/bearcove/fasterthanli.me</code>.</p>
<p><code>du</code> is shipped with most Linux systems. Its <code>-h</code> option uses &#34;human-readable&#34;
sizes, e.g. megabytes and gigabytes instead of bytes. One could also do <code>-c</code> to
get a &#34;total count&#34;, and pipe it to <code>tail -1</code>, but that&#39;s a waste! Setting the
depth to zero (<code>-d0</code>) is faster and better.</p>
</div>
<p>So ideally, I&#39;d only ever need to commit the source of truth to the repository:
the <code>.png</code> and <code>.drawio</code> files. And my custom not-really-static site generator
would magically know what to do with those and generate whichever assets are
needed.</p>
<p>And because that&#39;s a lot of processing, maybe the processed assets are cached
locally, or somewhere like an Amazon S3 bucket, since I&#39;m <a href="https://fasterthanli.me/articles/my-ideal-rust-workflow">already using AWS for
a bunch of things</a>.</p>
<p>But <del>here comes the airplane</del> here&#39;s the wrinkle: because of all the
command-line tools I&#39;m using, my server, which once was a rather self-contained
binary, to the point of bringing its own TLS implementation (the wonderful
<a href="https://lib.rs/crates/rustls">rustls</a>):</p>
<pre><p>Shell session</p><p><code>$ ldd $(which futile)
        linux-vdso.so.1 (0x00007ffd189f8000)
        libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fb0a1ad7000)
        libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fb0a19fb000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fb0a17f1000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fb0a3046000)
</code></p></pre>
<p>...would start depending on six different command-line tools. Some of whom are
not, uh, not exactly command-line tools.</p>
<p>Inkscape is okay! It exists in the GLib/GTK cinematic universe, so it&#39;s not the
lightest thing in the world, but by 2021 standards, it&#39;s okay. draw.io is
another matter entirely: it not only runs on the desktop, it also runs in
browsers, for example.</p>
<p>So it really does <em>need</em> Electron, short of maintaining a lot of different
codebases, and chasing subtle implementation differences till the end of time.</p>
<p>And, well, one problem there is that it really wants an <a href="https://en.wikipedia.org/wiki/X_Window_System">X
server</a> in order to function.
Even to just &#34;export as PDF&#34;.</p>
<div>

<p>That&#39;s because &#34;exporting to PDF&#34; is just printing to a virtual device. This makes
sense if you know the lineage: <a href="https://en.wikipedia.org/wiki/PDF">PDF</a> is based
on <a href="https://en.wikipedia.org/wiki/PostScript">PostScript</a>, which is what computers
tend to send to some printers (proprietary shenanigans aside).</p>
</div>
<p>So, when I got tired of setting up all those dependencies by hand, and thought
about &#34;simply shoving everything in a Docker container&#34; (a hammer fit for a
surprising amount of nails), things were somewhat fine until I added draw.io: the
package itself added 447MB to the image, then xvfb added another 142MB. That&#39;s over
half the total size of the image (the 125MB are node.js for svgo, the 147MB are for
inkscape):</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/dive.84a59dbc416f5c3e.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/dive.d5bc11c4e012dadc.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/dive.8740f614e9f8c313.jpg"/>
            </picture>
            <div>

<p>The tool shown above is <a href="https://github.com/wagoodman/dive">dive</a> and it&#39;s extremely useful
to explore &#34;why is my Docker image large&#34;.</p>
</div>
<p>The image size matters somewhat because I&#39;m storing it in the cloud and
downloading a gigabyte over the ocean, while not the worst thing ever, is
not the best either. Oh and of course you need a Docker daemon running, so
on Windows that means being locked into WSL2, and thus Hyper-V, which cripple
VMWare Workstation&#39;s performance for example.</p>
<div>

<p>Couldn&#39;t you have a Docker daemon running in some Linux VM and connect it from
Windows?</p>
</div>
<p>Yes, yes, anything is possible, but I&#39;m trying to /reduce/ the number of setup
setups. I&#39;ve done remote docker a bunch and it&#39;s all fun and games until you
remember you can&#39;t use bind mounts.</p>

<p>So, maybe we should look at an alternative solution.</p>
<div>

<p>Making diagrams with <a href="https://www.diagrams.net/">draw.io</a> is fun, but unless we
manually go through the &#34;Export&#34; flow every time, it&#39;s kinda hard to automate
exporting to PDF, which we need to get SVG files that can be viewed and printed
from any viewer without any fonts installed (and without requiring HTML
support).</p>
<p>&#34;Shoving everything inside a Docker container&#34; is an option, but not a great
one. In this case, <em>because we can</em> (nobody complain, you choose what you read!),
we&#39;re going to try to find another solution.</p>
</div>
<h2>Headless draw.io exports</h2>
<p>Here&#39;s a fun thought I&#39;ve had several time over the past year: &#34;oh that seems
like a lot of effort, I&#39;m not sure I want to do that...&#34; and immediately after
&#34;oh WAIT I&#39;ve basically made my website from scratch already, this isn&#39;t
significantly more involved than what I&#39;ve done so far&#34;, and then I do it.</p>
<p>This is one of these times.</p>
<p>So! The first thing we need is to turn a <code>.drawio</code> file, which is a compressed
version of an XML &#34;mxGraph&#34; tree of nodes, into an <code>.svg</code> file, which is... also
XML, but something like Chromium can understand and render.</p>
<div>

<p>Unfortunately, draw.io uses the
<a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/foreignObject">foreignObject</a>
tag in SVG to achieve line wrapping, so we really do need a browser to render
those SVGs, we can&#39;t use something like <a href="https://lib.rs/crates/lyon">lyon</a>.</p>
</div>
<p>But remember, we can&#39;t actually launch draw.io, because we don&#39;t want to depend
on having Electron/a whole X server around, even <a href="https://en.wikipedia.org/wiki/Xvfb">a virtual framebuffer
one</a>.</p>
<p>So, what do we do? Well!</p>
<p>At first I thought we could try to use the mxGraph library directly to convert
the <code>.drawio</code> to an <code>.svg</code>!</p>
<p>The <a href="https://github.com/jgraph/mxgraph">original repository for mxGraph</a> is archived, which
sounds to me like the author wanted to narrow scope to <em>just draw.io</em> (which is
more than fair, we&#39;re on our own past this point). Luckily, the <a href="https://github.com/jgraph/drawio">drawio
repository</a> contains a copy of <code>mxClient.js</code>.</p>
<p>Upon further inspection, mxGraph doesn&#39;t really run outside of a browser
environment, (in, say, Node, or vanilla V8 from Rust) - it really expects some
sort of navigator. That&#39;s not the dealbreaker it appears at first place.</p>
<p>We were always going to need Chrome, to render the resulting SVG, because of
the presence of <code>foreignObject</code>. So we might as well load part of draw.io&#39;s
JavaScript code in Chrome, right?</p>
<p>I created the following <code>index.html</code> file:</p>
<pre><p>HTML</p><p><code><i>&lt;!DOCTYPE html<i>&gt;</i></i>
<i>&lt;</i><i>html</i><i>&gt;</i>
<i>&lt;</i><i>head</i><i>&gt;</i>
  <i>&lt;</i><i>meta</i> <i>http-equiv</i>=&#34;<i>Content-Type</i>&#34; <i>content</i>=&#34;<i>text/html; charset=UTF-8</i>&#34;<i>&gt;</i>
  <i>&lt;</i><i>script</i> <i>src</i>=&#34;<i>js/export-init.js</i>&#34;<i>&gt;</i><i>&lt;/</i><i>script</i><i>&gt;</i>
  <i>&lt;!-- CSS for print output is needed for using current window --&gt;</i>
  <i>&lt;</i><i>style</i> <i>type</i>=&#34;<i>text/css</i>&#34;<i>&gt;</i>
      span.MathJax_SVG svg { shape-rendering: crispEdges; }
      table.mxPageSelector { display: none; }
      hr.mxPageBreak { display: none; }
  <i>&lt;/</i><i>style</i><i>&gt;</i>
  <i>&lt;</i><i>link</i> <i>rel</i>=&#34;<i>stylesheet</i>&#34; <i>href</i>=&#34;<i>mxgraph/css/common.css</i>&#34; <i>charset</i>=&#34;<i>UTF-8</i>&#34; <i>type</i>=&#34;<i>text/css</i>&#34;<i>&gt;</i>
  <i>&lt;</i><i>link</i> <i>rel</i>=&#34;<i>stylesheet</i>&#34; <i>href</i>=&#34;<i>export-fonts.css</i>&#34; <i>charset</i>=&#34;<i>UTF-8</i>&#34; <i>type</i>=&#34;<i>text/css</i>&#34;<i>&gt;</i>
  <i>&lt;</i><i>script</i> <i>src</i>=&#34;<i>js/app.min.js</i>&#34;<i>&gt;</i><i>&lt;/</i><i>script</i><i>&gt;</i>
  <i>&lt;</i><i>script</i> <i>src</i>=&#34;<i>js/export.js</i>&#34;<i>&gt;</i><i>&lt;/</i><i>script</i><i>&gt;</i>
  <i>&lt;</i><i>script</i> <i>src</i>=&#34;<i>js/test.js</i>&#34;<i>&gt;</i><i>&lt;/</i><i>script</i><i>&gt;</i>
<i>&lt;/</i><i>head</i><i>&gt;</i>
<i>&lt;</i><i>body</i> <i>style</i>=&#34;<i>margin:0px;overflow:hidden</i>&#34;<i>&gt;</i>
<i>&lt;/</i><i>body</i><i>&gt;</i>
<i>&lt;/</i><i>html</i><i>&gt;</i>
</code></p></pre>
<p>With <code>test.js</code> set to:</p>
<pre><p>JavaScript code</p><p><code><i>window</i><i>.</i><i>onload</i> <i>=</i> <i>async</i> <i>function</i> <i>main</i><i>(</i><i>)</i> <i>{</i>
  <i>let</i> <i>xml</i> <i>=</i> <i>await</i> <i>(</i><i>await</i> <i>fetch</i><i>(</i><i>&#34;/sample.drawio&#34;</i><i>)</i><i>)</i><i>.</i><i>text</i><i>(</i><i>)</i><i>;</i>
  <i>let</i> <i>data</i> <i>=</i> <i>{</i>
    xml<i>,</i>
  <i>}</i><i>;</i>
  <i>render</i><i>(</i><i>data</i><i>)</i><i>;</i>
<i>}</i><i>;</i>
</code></p></pre>
<p>And, using <a href="https://lib.rs/crates/sfz">sfz</a> as a quick HTTP server... voila!</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/drawio-in-browser.8a3401f81e8c4760.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/drawio-in-browser.7cd0df01dc97f9e0.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/drawio-in-browser.d8b92231e2a66eda.jpg"/>
            </picture>
            
<p>And now, if we bring <a href="https://lib.rs/crates/headless_chrome">headless_chrome</a>
in the mix...</p>
<pre><p>Rust code</p><p><code><i>// somewhere in salvage&#39;s source code</i>

<i>use</i> camino<i>::</i>Utf8PathBuf<i>;</i>
<i>use</i> headless_chrome<i>::</i>{protocol<i>::</i>page<i>::</i>PrintToPdfOptions, Browser, LaunchOptionsBuilder}<i>;</i>
<i>use</i> tracing<i>::</i>info<i>;</i>

<i>pub</i> <i>fn</i> <i>do_stuff</i><i>(</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>(</i><i>)</i>, <i>Box</i><i>&lt;</i><i>dyn</i> std<i>::</i>error<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i> {
    <i>let</i> browser = <i>Browser</i><i>::</i><i>new</i><i>(</i><i>LaunchOptionsBuilder</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>headless</i><i>(</i><i>true</i><i>)</i><i>.</i><i>build</i><i>(</i><i>)</i>?<i>)</i>?<i>;</i>

    <i>let</i> tab = browser<i>.</i><i>wait_for_initial_tab</i><i>(</i><i>)</i>?<i>;</i>

    <i>info</i><i>!</i><i>(</i><i>&#34;Navigating...&#34;</i><i>)</i><i>;</i>
    tab<i>.</i><i>navigate_to</i><i>(</i><i>&#34;http://localhost:5000/index.html&#34;</i><i>)</i>?<i>;</i>
    tab<i>.</i><i>wait_until_navigated</i><i>(</i><i>)</i>?<i>;</i>
    <i>info</i><i>!</i><i>(</i><i>&#34;Navigating... done!&#34;</i><i>)</i><i>;</i>

    <i>let</i> width = tab
        <i>.</i><i>evaluate</i><i>(</i><i>&#34;document.body.clientWidth&#34;</i>, <i>false</i><i>)</i>?
        <i>.</i><i>value</i>
        <i>.</i><i>unwrap</i><i>(</i><i>)</i>
        <i>.</i><i>as_u64</i><i>(</i><i>)</i>
        <i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>
    <i>let</i> height = tab
        <i>.</i><i>evaluate</i><i>(</i><i>&#34;document.body.clientHeight&#34;</i>, <i>false</i><i>)</i>?
        <i>.</i><i>value</i>
        <i>.</i><i>unwrap</i><i>(</i><i>)</i>
        <i>.</i><i>as_u64</i><i>(</i><i>)</i>
        <i>.</i><i>unwrap</i><i>(</i><i>)</i><i>;</i>
    <i>info</i><i>!</i><i>(</i>%width, %height, <i>&#34;Got dimensions&#34;</i><i>)</i><i>;</i>

    <i>let</i> pdf = tab<i>.</i><i>print_to_pdf</i><i>(</i>Some<i>(</i><i>PrintToPdfOptions</i> {
        <i>display_header_footer</i>: Some<i>(</i><i>false</i><i>)</i>,
        <i>prefer_css_page_size</i>: Some<i>(</i><i>false</i><i>)</i>,
        <i>landscape</i>: None,
        <i>print_background</i>: None,
        <i>scale</i>: None,
        <i>// Assuming 96 DPI (dots per inch)</i>
        <i>paper_width</i>: Some<i>(</i>width <i>as</i> <i>f32</i> / <i>96.0</i><i>)</i>,
        <i>paper_height</i>: Some<i>(</i>height <i>as</i> <i>f32</i> / <i>96.0</i><i>)</i>,
        <i>margin_top</i>: Some<i>(</i><i>0.0</i><i>)</i>,
        <i>margin_bottom</i>: Some<i>(</i><i>0.0</i><i>)</i>,
        <i>margin_left</i>: Some<i>(</i><i>0.0</i><i>)</i>,
        <i>margin_right</i>: Some<i>(</i><i>0.0</i><i>)</i>,
        <i>page_ranges</i>: None,
        <i>ignore_invalid_page_ranges</i>: None,
        <i>header_template</i>: None,
        <i>footer_template</i>: None,
    }<i>)</i><i>)</i>?<i>;</i>
    <i>let</i> pdf_path = <i>Utf8PathBuf</i><i>::</i><i>from</i><i>(</i><i>&#34;/tmp/export.pdf&#34;</i><i>)</i><i>;</i>
    <i>info</i><i>!</i><i>(</i>%pdf_path, <i>&#34;Writing pdf...&#34;</i><i>)</i><i>;</i>
    std<i>::</i>fs<i>::</i><i>write</i><i>(</i><i>&amp;</i>pdf_path, <i>&amp;</i>pdf<i>)</i>?<i>;</i>
    <i>info</i><i>!</i><i>(</i>%pdf_path, <i>&#34;Writing pdf... done!&#34;</i><i>)</i><i>;</i>

    Ok<i>(</i><i>(</i><i>)</i><i>)</i>
}
</code></p></pre>
<p>And just like that...</p>
<pre><p>Shell session</p><p><code>$ cargo run --release -- /tmp
    Finished release [optimized] target(s) in 0.03s
     Running `target/release/salvage /tmp`
2021-11-18T19:02:44.426009Z  INFO headless_chrome::browser::process: Launching Chrome binary at &#34;/usr/bin/google-chrome-stable&#34;    
2021-11-18T19:02:44.426390Z  INFO headless_chrome::browser::process: Started Chrome. PID: 39323    
2021-11-18T19:02:44.579968Z  INFO salvage::chrome_stuff: Navigating...
2021-11-18T19:02:44.585193Z  INFO headless_chrome::browser::tab: Navigating a tab to http://localhost:5000/index.html    
2021-11-18T19:02:45.489303Z  INFO salvage::chrome_stuff: Navigating... done!
2021-11-18T19:02:45.501346Z  INFO salvage::chrome_stuff: Got dimensions width=994 height=643
2021-11-18T19:02:45.556953Z  INFO salvage::chrome_stuff: Writing pdf... pdf_path=/tmp/export.pdf
2021-11-18T19:02:45.557023Z  INFO salvage::chrome_stuff: Writing pdf... done! pdf_path=/tmp/export.pdf
2021-11-18T19:02:45.557041Z  INFO headless_chrome::browser: Dropping browser    
2021-11-18T19:02:45.557077Z  INFO headless_chrome::browser::process: Killing Chrome. PID: 39323    
2021-11-18T19:02:45.557173Z  INFO headless_chrome::browser::transport::web_socket_connection: Sending shutdown message to message handling loop    
2021-11-18T19:02:45.557226Z  INFO headless_chrome::browser::transport: Received shutdown message    
2021-11-18T19:02:45.557248Z  INFO headless_chrome::browser::transport: Shutting down message handling loop    
2021-11-18T19:02:45.557353Z  INFO headless_chrome::browser::tab: finished tab&#39;s event handling loop    
2021-11-18T19:02:45.557408Z  INFO headless_chrome::browser: Finished browser&#39;s event handling loop    
2021-11-18T19:02:45.557414Z  INFO headless_chrome::browser::transport: cleared listeners, I think   
</code></p></pre>
<p>We got a PDF!</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/headless-chrome-pdf.087534f153e75bb1.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/headless-chrome-pdf.e1aa403cf19fd76e.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/headless-chrome-pdf.b4efb1f6ace51693.jpg"/>
            </picture>
            
<p>The resulting PDF is 107KB. That&#39;s pretty small... suspiciously small, even.
Sure, there&#39;s <a href="https://en.wikipedia.org/wiki/Deflate">Deflate</a> compression
involved (I checked, the file contains <code>/Filter /FlateDecode</code>).</p>
<p>I doubt the PDF has actually converted text to paths. My guess is that it&#39;s only
embedding the characters it needs from the Iosevka font. Let&#39;s check it out!</p>
<pre><p>Shell session</p><p><code>$ qpdf --qdf --object-streams=disable export.pdf export.uncompressed.pdf
$ ls -lhA export*.pdf
-rw-r--r--. 1 amos amos 107K Nov 18 20:02 export.pdf
-rw-r--r--. 1 amos amos 398K Nov 18 20:12 export.uncompressed.pdf
</code></p></pre>
<p>Near the end of <code>export.uncompressed.pdf</code>, we can find this:</p>
<pre><p><code>%% Original object ID: 11 0
14 0 obj
&lt;&lt;
  /Ascent 977
  /CapHeight 735
  /Descent -272
  /Flags 5
  /FontBBox [
    -776
    -505
    1276
    1188
  ]
  /FontFile2 15 0 R
  /FontName /IosevkaNerdFontCompleteM-
  /ItalicAngle 0
  /StemV 156
  /Type /FontDescriptor
&gt;&gt;
endobj
</code></p></pre>
<p>AhAH! A font descriptor! Then follows, with object ID <code>15 0</code>, the actual font
data. It&#39;s just, again, a deflate-compressed TTF file, which we can extract,
and then inspect:</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/fontdrop.651bed04b387d914.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/fontdrop.6fc5cce34c705b4f.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/fontdrop.8e064fa2cf8cdde9.jpg"/>
            </picture>
            
<p>And as expected, it&#39;s missing some glyphs! Our diagram contains numbers from 0
to 8, but not 9, so it&#39;s not included. Similarly, we never have the uppercase
letters G, J, K, Q, U, W, and Z, so they&#39;re left out. That&#39;s why the resulting
<code>.ttf</code> file is only 54KB, instead of the original 1239KB.</p>
<div>

<p>Okay, cool, but... is &#34;headless chrome&#34; truly headless? Does it work without
Wayland / X?</p>
</div>
<p>Well, let&#39;s find out!</p>
<p>We&#39;ll make a Docker container with only <code>salvage</code> (which is the codebase I chose
to mangle to try out <code>headless_chrome</code>) and see what happens.</p>
<p>But first, because I don&#39;t feel like forwarding ports or running sfz inside the
Docker container, let&#39;s make sure salvage itself can serve the static files as
HTTP, so that headless chrome can access them.</p>
<p>We&#39;ll use <a href="https://lib.rs/crates/hyper-staticfile">hyper-staticfile</a> for that:</p>
<pre><p>Rust code</p><p><code><i>use</i> std<i>::</i>{convert<i>::</i>Infallible, net<i>::</i>SocketAddr}<i>;</i>

<i>use</i> camino<i>::</i>Utf8PathBuf<i>;</i>
<i>use</i> headless_chrome<i>::</i>{protocol<i>::</i>page<i>::</i>PrintToPdfOptions, Browser, LaunchOptionsBuilder}<i>;</i>
<i>use</i> hyper<i>::</i>{service<i>::</i>make_service_fn, Server}<i>;</i>
<i>use</i> hyper_staticfile<i>::</i>Static<i>;</i>
<i>use</i> tokio<i>::</i>task<i>::</i>spawn_blocking<i>;</i>
<i>use</i> tracing<i>::</i>info<i>;</i>

<i>pub</i> async <i>fn</i> <i>export_to_pdf</i><i>(</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>(</i><i>)</i>, <i>Box</i><i>&lt;</i><i>dyn</i> std<i>::</i>error<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i> {
    <i>let</i> addr = <i>SocketAddr</i><i>::</i><i>from</i><i>(</i><i>(</i><i>[</i><i>127</i>, <i>0</i>, <i>0</i>, <i>1</i><i>]</i>, <i>5000</i><i>)</i><i>)</i><i>;</i>
    <i>let</i> make_svc =
        <i>make_service_fn</i><i>(</i>|_conn| async { Ok<i>::</i><i>&lt;</i><i>_</i>, <i>Infallible</i><i>&gt;</i><i>(</i><i>Static</i><i>::</i><i>new</i><i>(</i><i>&#34;mxgraph-tests&#34;</i><i>)</i><i>)</i> }<i>)</i><i>;</i>
    <i>let</i> server = <i>Server</i><i>::</i><i>bind</i><i>(</i><i>&amp;</i>addr<i>)</i><i>.</i><i>serve</i><i>(</i>make_svc<i>)</i><i>;</i>
    <i>let</i> server_task = tokio<i>::</i><i>spawn</i><i>(</i>server<i>)</i><i>;</i>

    <i>let</i> chrome_task = <i>spawn_blocking</i><i>(</i>|| <i>orchestrate_chrome</i><i>(</i><i>)</i><i>.</i><i>unwrap</i><i>(</i><i>)</i><i>)</i><i>;</i>

    chrome_task<i>.</i>await?<i>;</i>
    server_task<i>.</i><i>abort</i><i>(</i><i>)</i><i>;</i>

    Ok<i>(</i><i>(</i><i>)</i><i>)</i>
}

<i>pub</i> <i>fn</i> <i>orchestrate_chrome</i><i>(</i><i>)</i> -&gt; <i>Result</i><i>&lt;</i><i>(</i><i>)</i>, <i>Box</i><i>&lt;</i><i>dyn</i> std<i>::</i>error<i>::</i><i>Error</i><i>&gt;</i><i>&gt;</i> {
    <i>let</i> browser = <i>Browser</i><i>::</i><i>new</i><i>(</i><i>LaunchOptionsBuilder</i><i>::</i><i>default</i><i>(</i><i>)</i><i>.</i><i>headless</i><i>(</i><i>true</i><i>)</i><i>.</i><i>build</i><i>(</i><i>)</i>?<i>)</i>?<i>;</i>

    <i>let</i> tab = browser<i>.</i><i>wait_for_initial_tab</i><i>(</i><i>)</i>?<i>;</i>

    <i>info</i><i>!</i><i>(</i><i>&#34;Navigating...&#34;</i><i>)</i><i>;</i>
    tab<i>.</i><i>navigate_to</i><i>(</i><i>&#34;http://localhost:5000/index.html&#34;</i><i>)</i>?<i>;</i>
    tab<i>.</i><i>wait_until_navigated</i><i>(</i><i>)</i>?<i>;</i>
    <i>info</i><i>!</i><i>(</i><i>&#34;Navigating... done!&#34;</i><i>)</i><i>;</i>

    <i>// same as before    </i>
}
</code></p></pre>
<p>Then, build a release binary of <code>salvage</code> and start a Docker container of Fedora
35 (the Linux distribution I happen to be working from today), with
<code>chromium-browser</code> installed:</p>
<pre><p>Shell session</p><p><code>$ cargo build --release
(omitted)
$ docker run -v ${PWD}:/workspace -w /workspace -it fedora:35 /bin/bash
</code></p></pre>
<p>And... it works!</p>

            <picture>
                <source type="image/avif" srcset="/content/series/dont-shell-out/part-1/assets/docker.e2259827906e2108.avif"/>
                <source type="image/webp" srcset="/content/series/dont-shell-out/part-1/assets/docker.147a083c3dd1c856.webp"/>
                <img loading="lazy" src="https://fasterthanli.me/content/series/dont-shell-out/part-1/assets/docker.0a6313a84f9453f5.jpg"/>
            </picture>
            <pre><p>Shell session</p><p><code>$ docker cp 083c61919ead:/tmp/export.pdf /tmp/export.docker.pdf
$ xdg-open /tmp/export.docker.pdf
</code></p></pre><div>

<p>draw.io is built on top of web technologies: it runs in browsers. However, the
PDF export functionality in particular is kinda tied to Chromium. In the web
version, it uses a server to do the conversion.</p>
<p>However, using <code>headless_chrome</code>, we can control a local copy of Google Chrome
or Chromium, and reproduce the same export flow the desktop version of draw.io
has. But this time, we don&#39;t need to have a &#34;display server&#34; like X.org running.</p>
</div>
</div><div>
  
    
    
      <p>
    This article was made possible thanks to my patrons:
    Alexander Payne, Fredrik Østrem, David Barsky, Yufan Lou, Stephen Molyneaux,
Barret Rennie, Thomas Corbin, MW, Jacob Cheriathundam, Michael Watzko, Embark
Studios, Eugene Bulkin, Marcus Griep, Petar Radosevic, Tool Army, Tully,
Santiago Lema, Spencer Gilbert, Jörn Huxhorn, Garrett Ward, DEX, Christian
Oudard, Ronen Cohen, Thor Kamphefner, Kamran Khan, Cole Kurkowski, Arjen
Laarhoven, Vicente Bosch, Chirag Jain, Ville Mattila, Marie Janssen, Vladyslav
Batyrenko, Cameron Clausen, spike grobstein, Jon Gjengset, Paul Marques Mota,
Jakub Fijałkowski, Mitchell Hamilton, Brad Luyster, Max von Forell, Jake S,
Dimitri Merejkowsky, Chris Biscardi, René Ribaud, Alex Doroshenko, Vincent,
Steven McGuire, Chad Birch, Chris Emery, Bob Ippolito, John Van Enk, metabaron,
Isak Sunde Singh, Philipp Gniewosz, Mads Johansen, lukvol, Ives van Hoorne, Jan
De Landtsheer, Daniel Strittmatter, Evgeniy Dubovskoy, Alex Rudy, Shane Lillie,
Romet Tagobert, Douglas Creager, Corey Alexander, Molly Howell, knutwalker,
Zachary Dremann, Sebastian Ziebell, Julien Roncaglia, Amber Kowalski, T,
queenfartbutt, Paul Kline, Kristoffer Ström, Astrid Bek, Yoh Deadfall, Justin
Ossevoort, Tomáš Duda, Jeremy Banks, Rasmus Larsen, Torben Clasen, C J Silverio,
Walther, Pete Bevin, Shane Sveller, Clara Schultz, jer, Wonwoo Choi, Hawken
Rives, João Veiga, Richard Pringle, Adam Perry, Benjamin Röjder Delnavaz, Matt
Jadczak, Jonathan Knapp, Maximilian, Seth Stadick, brianloveswords, Sean Bryant,
Ember, Sebastian Zimmer, Makoto Nakashima, Geoff Cant, Geoffroy Couprie, Michael
Alyn Miller, o0Ignition0o, Zaki, Raphael Gaschignard, Romain Ruetschi, Ignacio
Vergara, Pascal, Jane Lusby, Nicolas Goy, Ted Mielczarek, Aurora.

</p>
    
  

  
    

  

  

  <div>
  
    <p>If you liked this article, please support my work on Patreon!</p>
    <p>
      <a href="https://www.patreon.com/bePatron?u=47556">
        <img src="https://fasterthanli.me/img/patreon/mark-white.png"/>
        <span>Become a Patron</span>
      </a>
    </p>
  
</div>


  

  
</div></div>
  </body>
</html>
