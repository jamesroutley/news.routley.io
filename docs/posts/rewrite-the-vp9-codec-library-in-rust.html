<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/">Original</a>
    <h1>Rewrite the VP9 codec library in Rust</h1>
    
    <div id="readability-page-1" class="page"><pre id="b">From: Daniel Almeida &lt;daniel.almeida@collabora.com&gt;
To: wedsonaf@gmail.com, ojeda@kernel.org, mchehab@kernel.org,
	hverkuil@xs4all.nl
Cc: Daniel Almeida &lt;daniel.almeida@collabora.com&gt;,
	rust-for-linux@vger.kernel.org, linux-kernel@vger.kernel.org,
	linux-media@vger.kernel.org, kernel@collabora.com
Subject: <a href="#r" id="t">[RFC PATCH 0/1] Rewrite the VP9 codec library in Rust</a>
Date: Tue, 27 Feb 2024 18:51:44 -0300	<a href="#r">[thread overview]</a>
Message-ID: &lt;20240227215146.46487-1-daniel.almeida@collabora.com&gt; (<a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/raw">raw</a>)


Hi everyone,

This patch ports the VP9 library written by Andrzej into Rust as a
proof-of-concept. This is so that we can evaluate the Rust in V4L2 initiative
with source code in hand.

It converts rkvdec and hantro to use the Rust version of the library. These two
were chosen merely because that&#39;s the hardware I currently own. Fluster scores
remain the same when using either the Rust or C version. Please test this.

Much has been spoken at various occasions about drivers and I feel that the
consensus is to wait for now. This is why I am proposing a different approach:
porting our codec libraries to Rust.

IMHO, these components can benefit greatly from Rust, as they implement
complicated algorithms that also happen to process data received from userspace
through V4L2 controls. These algorithms use the data received from userspace in
order to index into a lot of arrays and thus benefit from Rust&#39;s memory safety.

The first thing about the code is that it does not include any layer of
bindings. This was pointed out as a blocker several times due to the need of
keeping them in sync with the C code.

The Rust code here also offers a C API for C drivers.This C API is
automatically generated by cbindgen and I have provided instructions on how to
do so. We can even use functions from both the C and Rust libraries at the same
time since the ABI is the same.

The above can come in handy because it means that we can convert a given
codebase piece by piece if need be. C drivers will work as usual through the C
API and any new Rust driver will get to benefit from a native Rust interface.

Please take note that most of the code is *not* in the media tree, so I do not
see how this can further stress our subsystem. I take responsibility for
maintaining stuff in rust/kernel/media and honestly, this library will not need
any further updates for the same reason we have never touched its C
counterpart.

I hope to convince the community that this is a feasible way to slowly
experiment with Rust code without tying us up too much to it.

Lastly, please note that this code is just a proof of concept, we can settle on
a proper patch - with all that entails - if it is well received.

Those with hardware can follow the steps below to test this patch:

a) enable Rust (<a href="https://www.kernel.org/doc/html/latest/rust/quick-start.html">https://www.kernel.org/doc/html/latest/rust/quick-start.html</a>).
Make sure CONFIG_RUST=y.

b) enable one of the converted drivers (CONFIG_VIDEO_HANTRO or
CONFIG_VIDEO_ROCKCHIP_VDEC). This will select V4L2_VP9_RS.

c) download the Fluster tool (<a href="https://github.com/fluendo/fluster">https://github.com/fluendo/fluster</a>)

d) download the VP9 test suite from libvpx (fluster.py download VP9-TEST-VECTORS)

e) make sure you have a recent version of GStreamer (`gst-inspect-1.0
v4l2codecs` must not be empty) 

f) run the test suite (fluster.py run -d GStreamer-VP9-V4L2SL-Gst1.0 -ts VP9-TEST-VECTORS)

g) results should be the same both with and without this patch

-- Daniel


Applies on top of:

commit d9c1fae3e5b225f2e45e0bca519f9a2967cd1062
Author: Alice Ryhl &lt;aliceryhl@google.com&gt;
Date:   Fri Feb 9 11:18:22 2024 +0000

    rust: file: add abstraction for `poll_table`




For those looking for a branch instead:

<a href="https://gitlab.collabora.com/dwlsalmeida/for-upstream/-/tree/vp9-rs?ref_type=heads">https://gitlab.collabora.com/dwlsalmeida/for-upstream/-/tree/vp9-rs?ref_type=heads</a>


Daniel Almeida (1):
  v4l2-core: rewrite the VP9 library in Rust

 drivers/media/platform/verisilicon/Kconfig    |    2 +-
 .../platform/verisilicon/hantro_g2_vp9_dec.c  |   38 +-
 .../media/platform/verisilicon/hantro_hw.h    |    8 +-
 drivers/media/v4l2-core/Kconfig               |    4 +
 drivers/staging/media/rkvdec/Kconfig          |    2 +-
 drivers/staging/media/rkvdec/rkvdec-vp9.c     |   52 +-
 include/media/v4l2-vp9-rs.h                   |   97 +
 rust/bindings/bindings_helper.h               |    1 +
 rust/kernel/lib.rs                            |    2 +
 rust/kernel/media.rs                          |    5 +
 rust/kernel/media/v4l2_core.rs                |    6 +
 rust/kernel/media/v4l2_core/cbindgen.toml     |   26 +
 rust/kernel/media/v4l2_core/vp9.rs            | 1999 +++++++++++++++++
 13 files changed, 2192 insertions(+), 50 deletions(-)
 create mode 100644 include/media/v4l2-vp9-rs.h
 create mode 100644 rust/kernel/media.rs
 create mode 100644 rust/kernel/media/v4l2_core.rs
 create mode 100644 rust/kernel/media/v4l2_core/cbindgen.toml
 create mode 100644 rust/kernel/media/v4l2_core/vp9.rs

-- 
2.43.0

</pre><hr/><pre><a href="https://lore.kernel.org/lkml/20240227215146.46487-2-daniel.almeida@collabora.com/" rel="next">next</a>             <a href="#R">reply</a><a id="related">	</a>other threads:[<a href="https://lore.kernel.org/lkml/?t=20240227215530">~2024-02-27 21:55 UTC</a>|<a href="https://lore.kernel.org/lkml/">newest</a>]

<b>Thread overview: </b>4+ messages / expand[<a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/T/#u">flat</a>|<a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/t/#u">nested</a>]  <a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/t.mbox.gz">mbox.gz</a>  <a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/t.atom">Atom feed</a>  <a href="#b">top</a>
<b>2024-02-27 21:51 <a id="r" href="#t">Daniel Almeida [this message]</a></b>
2024-02-27 21:51 ` <a href="https://lore.kernel.org/lkml/20240227215146.46487-2-daniel.almeida@collabora.com/">[RFC PATCH 1/1] v4l2-core: rewrite the VP9 library in Rust</a> Daniel Almeida
2024-02-28 14:13   ` <a href="https://lore.kernel.org/lkml/CAH5fLgi_Y0a=XPtgdiA9KcsmMGxn=DjvLMmSq-UF8VQtZVTccg@mail.gmail.com/">Alice Ryhl</a>
2024-02-28 17:59     ` <a href="https://lore.kernel.org/lkml/28f4-65df7480-b-5f6f8180@243208659/">Daniel Almeida</a>
</pre><hr/><pre id="R"><b>Reply instructions:</b>

You may reply publicly to <a href="#t">this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a href="https://lore.kernel.org/lkml/20240227215146.46487-1-daniel.almeida@collabora.com/raw">mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20240227215146.46487-1-daniel.almeida@collabora.com \
    --to=daniel.almeida@collabora.com \
    --cc=hverkuil@xs4all.nl \
    --cc=kernel@collabora.com \
    --cc=linux-kernel@vger.kernel.org \
    --cc=linux-media@vger.kernel.org \
    --cc=mchehab@kernel.org \
    --cc=ojeda@kernel.org \
    --cc=rust-for-linux@vger.kernel.org \
    --cc=wedsonaf@gmail.com \
    /path/to/YOUR_REPLY

  <a href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a href="mailto:daniel.almeida@collabora.com?In-Reply-To=%3C20240227215146.46487-1-daniel.almeida@collabora.com%3E&amp;Cc=hverkuil%40xs4all.nl%2Ckernel%40collabora.com%2Clinux-kernel%40vger.kernel.org%2Clinux-media%40vger.kernel.org%2Cmchehab%40kernel.org%2Cojeda%40kernel.org%2Crust-for-linux%40vger.kernel.org%2Cwedsonaf%40gmail.com&amp;Subject=Re%3A%20%5BRFC%20PATCH%200%2F1%5D%20Rewrite%20the%20VP9%20codec%20library%20in%20Rust">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr/><pre>This is a public inbox, see <a href="https://lore.kernel.org/lkml/_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></div>
  </body>
</html>
