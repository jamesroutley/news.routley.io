<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kristun.dev/posts/my-foray-into-vlang/">Original</a>
    <h1>My Foray into Vlang</h1>
    
    <div id="readability-page-1" class="page"><article id="article"> 
<details><summary>Open Table of contents</summary>
<ul>
<li><a href="#a-little-bit-about-go">A little bit about Go</a></li>
<li><a href="#so-wtf-is-vlang">So, wtf is Vlang?</a>
<ul>
<li><a href="#maps">Maps</a></li>
<li><a href="#struct-licious">Struct-licious</a></li>
<li><a href="#withoption-pattern">WithOption pattern</a></li>
<li><a href="#enums-in-this-economy">Enums??? In this economy?</a></li>
<li><a href="#lambda-the-best-kind-of-lamb">Lambda; the best kind of lamb</a></li>
</ul>
</li>
<li><a href="#some-issues-ive-encountered">Some issues I‚Äôve encountered</a>
<ul>
<li><a href="#nethttp"><code>net.http</code></a></li>
<li><a href="#veb"><code>veb</code></a></li>
<li><a href="#more-complex-build-system">More complex build system</a></li>
<li><a href="#concurrency">Concurrency</a></li>
</ul>
</li>
<li><a href="#thoughts">&lt;/Thoughts&gt;</a></li>
<li><a href="#links">Links</a></li>
</ul>
</details>

<p>I like Go. I actually don‚Äôt mind writing <code>err != nil</code> <em>that</em> much. Just set up a snippet and you‚Äôre good to Go. Although, I never really felt like I had a honeymoon period with Go. I learned the language, learned about channels, wrote a bunch of CRUDs and parsers and CLIs. It always felt strictly business. I thought it was because of where I am in my career. But I was wrong.</p>
<p>Go is vanilla. It just werks. You build it, you ship it. The language is simple and you don‚Äôt need to try hard to make it performant.</p>
<p><em>But sometimes you just want a little <strong>spice</strong></em>üå∂Ô∏èü•µ</p>
<p>Do you ever wonder what else is out there? Hobby programming is a great meme. But I feel like we‚Äôre under too much pressure to produce the new unicorn SaaS with 10 million monthly active users.</p>

<p>You don‚Äôt have to pick a tool then find the right job for it. You can just grab a hammer and start smashing stuff. The same nails you‚Äôve smashed before might feel different if you smash it with another hammer. Pick a Rusty hammer and you might end up obsessed with how important health and safety is.</p>

<p>I might have shot myself in the foot with the hammer analogy there, so let‚Äôs talk about ice cream. Ok so here‚Äôs the gist: vanilla, drizzle some chocolate on top, peanuts? sure why not. You know this taste, you like it, it comes with more stuff on top. If you like vanilla then you might like vanilla++.</p>
<p>That how I see the current state of V. The syntax is similar to Go. It has extra features. The core of it is similar, you can cross compile, you have concurrency (which is also parallelism). Channels and message passing. Oh and <code>defer</code> as well. All my bros love using <code>defer</code>.</p>
<p>Anyway, let‚Äôs see some cool stuff.</p>
<p><a href="https://vlang.io/?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang</a></p>
<h2 id="maps">Maps</h2>
<pre tabindex="0" data-language="v"><code><span><span>// So simple!</span></span>
<span><span>simple_languages </span><span>:=</span><span> {</span><span>&#34;elixir&#34;</span><span>: </span><span>{</span><span>&#34;score&#34;</span><span>: </span><span>100</span><span>,</span><span> &#34;width&#34;</span><span>: </span><span>30</span><span>}}</span></span>
<span></span>
<span><span>// Alternatively</span></span>
<span><span>mut</span><span> languages </span><span>:=</span><span> map</span><span>[</span><span>string</span><span>]</span><span>map</span><span>[</span><span>string</span><span>]</span><span>int</span><span>{</span><span>&#34;elixir&#34;</span><span>: </span><span>{</span><span>&#34;score&#34;</span><span>: </span><span>100</span><span>,</span><span> &#34;width&#34;</span><span>: </span><span>30</span><span>}}</span></span>
<span><span>languages</span><span>[</span><span>&#34;elixir&#34;</span><span>]</span><span> =</span><span> {</span><span>&#34;score&#34;</span><span>: </span><span>100</span><span>}</span></span>
<span><span>languages</span><span>[</span><span>&#34;elixir&#34;</span><span>][</span><span>&#34;width&#34;</span><span>]</span><span> =</span><span> 30</span></span></code></pre>
<p>Pretty cool! Much like Go, the maps require a fixed type, dynamic objects like JSON or JavaScript requires either a DTO or a type switch.</p>
<p>Ok, but what about the error handling?</p>
<pre tabindex="0" data-language="v"><code><span><span>elixir_score </span><span>:=</span><span> languages</span><span>[</span><span>&#34;elixir&#34;</span><span>][</span><span>&#34;score&#34;</span><span>]</span><span> or</span><span> {</span><span> -</span><span>1</span><span> }</span></span>
<span></span>
<span><span>if</span><span> racket </span><span>:=</span><span> languages</span><span>[</span><span>&#39;racket&#39;</span><span>]</span><span> {</span></span>
<span><span>  println</span><span>(</span><span>&#39;racket score </span><span>${racket[&#39;score&#39;]}</span><span>&#39;</span><span>)</span></span>
<span><span>  racket_width </span><span>:=</span><span> racket</span><span>[</span><span>&#39;width&#39;</span><span>]</span><span> or</span><span> {</span><span> 0</span><span> }</span></span>
<span><span>  println</span><span>(</span><span>&#39;racket width </span><span>${racket_width}</span><span>&#39;</span><span>)</span></span>
<span><span>}</span></span>
<span></span>
<span><span>// Another way to skin the cat</span></span>
<span><span>if</span><span> &#39;haskell&#39;</span><span> in</span><span> languages </span><span>{</span></span>
<span><span>  if</span><span> &#39;score&#39;</span><span> !</span><span>in</span><span> languages</span><span>[</span><span>&#39;haskell&#39;</span><span>]</span><span> {</span></span>
<span><span>    println</span><span>(</span><span>&#39;where is my haskell score??&#39;</span><span>)</span></span>
<span><span>  }</span></span>
<span><span>}</span></span>
<span></span>
<span><span>// Zeroth value</span></span>
<span><span>languages</span><span>[</span><span>&#39;this_dont_exist&#39;</span><span>]</span><span> // {}</span></span>
<span><span>languages</span><span>[</span><span>&#39;this_dont_exist&#39;</span><span>][</span><span>&#39;score&#39;</span><span>]</span><span> // 0</span></span></code></pre>
<p>Don‚Äôt you miss destructuring?</p>
<pre tabindex="0" data-language="v"><code><span><span>languages_with_racket_ocaml </span><span>:=</span><span> {</span></span>
<span><span>  ...</span><span>languages</span></span>
<span><span>  &#39;racket&#39;</span><span>: </span><span>{</span><span>&#39;score&#39;</span><span>: </span><span>99</span><span>}</span></span>
<span><span>  &#39;ocaml&#39;</span><span>: </span><span>{</span><span>&#39;score&#39;</span><span>: </span><span>98</span><span>}</span></span>
<span><span>}</span></span></code></pre>
<p><a href="https://docs.vlang.io/v-types.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#maps" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/maps</a></p>
<h2 id="struct-licious">Struct-licious</h2>
<pre tabindex="0" data-language="v"><code><span><span>module</span><span> main</span></span>
<span></span>
<span><span>struct</span><span> Language</span><span> {</span></span>
<span><span>pub</span><span> mut</span><span>:</span></span>
<span><span>	score </span><span>int</span><span> =</span><span> -</span><span>1</span></span>
<span><span>	name  </span><span>string</span><span> @</span><span>[</span><span>required</span><span>]</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> (lr []Language) </span><span>total</span><span>()</span><span> int</span><span> {</span></span>
<span><span>	mut</span><span> total </span><span>:=</span><span> 0</span></span>
<span><span>	for</span><span> l </span><span>in</span><span> lr </span><span>{</span></span>
<span><span>      if</span><span> l</span><span>.</span><span>score </span><span>&gt;</span><span> 0</span><span> {</span></span>
<span><span>        total </span><span>+=</span><span> l</span><span>.</span><span>score</span></span>
<span><span>      }</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	return</span><span> total</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> (lr []Language) </span><span>average</span><span>()</span><span> int</span><span> {</span></span>
<span><span>	return</span><span> lr</span><span>.</span><span>total</span><span>()</span><span> /</span><span> lr</span><span>.</span><span>len</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> main</span><span>()</span><span> {</span></span>
<span><span>	racket </span><span>:=</span><span> Language</span><span>{</span><span>98</span><span>,</span><span> &#39;racket&#39;</span><span>}</span></span>
<span><span>    // Simple arrays too!</span></span>
<span><span>	langs_arr </span><span>:=</span><span> [</span><span>racket</span><span>,</span><span> Language</span><span>{</span><span>102</span><span>,</span><span> &#39;ocaml&#39;</span><span>}]</span></span>
<span><span>	println</span><span>(</span><span>langs_arr</span><span>)</span></span>
<span><span>	println</span><span>(</span><span>langs_arr</span><span>.</span><span>total</span><span>())</span></span>
<span><span>	println</span><span>(</span><span>langs_arr</span><span>.</span><span>average</span><span>())</span></span>
<span><span>}</span></span></code></pre>
<p>Isn‚Äôt that cool? We can have receiver methods on array types. Wait - did you see that? We had a required tag on the struct, that means the program won‚Äôt compile if you don‚Äôt initialise it. That‚Äôs another cool thing I wish Go has. Not to mention, the initialiser value, Go‚Äôs struct is quite predictable in how the value turns out. However, V‚Äôs struct allows you to be explicit. This came in very handy for my case!</p>
<pre tabindex="0" data-language="v"><code><span><span>@</span><span>[</span><span>xdoc: </span><span>&#39;Server for GitHub language statistics&#39;</span><span>]</span></span>
<span><span>@</span><span>[</span><span>name: </span><span>&#39;v-gh-stats&#39;</span><span>]</span></span>
<span><span>struct</span><span> Config</span><span> {</span></span>
<span><span>mut</span><span>:</span></span>
<span><span>	show_help </span><span>bool</span><span>   @</span><span>[</span><span>long: help; short: h; xdoc: </span><span>&#39;Show this help message&#39;</span><span>]</span></span>
<span><span>	user      </span><span>string</span><span> =</span><span> os</span><span>.</span><span>getenv</span><span>(</span><span>&#39;GH_USER&#39;</span><span>)</span><span>           @</span><span>[</span><span>long: user; short: u; xdoc: </span><span>&#39;GitHub username env </span><span>\$</span><span>GH_USER&#39;</span><span>]</span></span>
<span><span>	token     </span><span>string</span><span> =</span><span> os</span><span>.</span><span>getenv</span><span>(</span><span>&#39;GH_TOKEN&#39;</span><span>)</span><span>          @</span><span>[</span><span>long: token; short: t; xdoc: </span><span>&#39;GitHub personal access token env </span><span>\$</span><span>GH_TOKEN&#39;</span><span>]</span></span>
<span><span>	debug     </span><span>bool</span><span>   =</span><span> os</span><span>.</span><span>getenv</span><span>(</span><span>&#39;DEBUG&#39;</span><span>)</span><span> ==</span><span> &#39;true&#39;</span><span>   @</span><span>[</span><span>long: debug; short: d; xdoc: </span><span>&#39;Enable debug mode env </span><span>\$</span><span>DEBUG&#39;</span><span>]</span></span>
<span><span>	cache     </span><span>bool</span><span>   =</span><span> os</span><span>.</span><span>getenv</span><span>(</span><span>&#39;CACHE&#39;</span><span>)</span><span> ==</span><span> &#39;true&#39;</span><span>   @</span><span>[</span><span>long: cache; short: c; xdoc: </span><span>&#39;Enable caching env </span><span>\$</span><span>CACHE&#39;</span><span>]</span></span>
<span><span>}</span></span></code></pre>
<p>This example contains flags for running my SVG generation server, it allows you to define the flags yourself but if not, use the environmental value. Neato!</p>
<p><a href="https://docs.vlang.io/structs.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/structs</a></p>
<h2 id="withoption-pattern">WithOption pattern</h2>
<p>Ahh yes, another thing I had to put up with. TBH, I did end up liking the pattern quite a bit. In Go, no default variables are allowed, you have to use variadics. You end up with an Option struct with zeroth value passing around a few functions to finally one last giant private receiver function that creates the struct, fills the value then finally build and check. Imagine a SQL repository pattern where you want to perform a List operation but optionally join or ensure some field is present in a query. Let‚Äôs see how we can cook this.</p>
<pre tabindex="0" data-language="v"><code><span><span>module</span><span> main</span></span>
<span></span>
<span><span>import</span><span> time</span></span>
<span></span>
<span><span>@</span><span>[</span><span>params</span><span>]</span></span>
<span><span>struct</span><span> ListOption</span><span> {</span></span>
<span><span>pub</span><span> mut</span><span>:</span></span>
<span><span>	created_since time</span><span>.</span><span>Time</span></span>
<span><span>}</span></span>
<span></span>
<span><span>@</span><span>[</span><span>params</span><span>]</span></span>
<span><span>struct</span><span> HeroListOption</span><span> {</span></span>
<span><span>	ListOption</span></span>
<span><span>pub</span><span> mut</span><span>:</span></span>
<span><span>	universe </span><span>string</span></span>
<span><span>	name     </span><span>?</span><span>string</span></span>
<span><span>}</span></span>
<span></span>
<span><span>struct</span><span> Hero</span><span> {}</span></span>
<span></span>
<span><span>struct</span><span> Repo</span><span>[</span><span>T</span><span>]</span><span> {}</span></span>
<span></span>
<span><span>struct</span><span> Villain</span><span> {}</span></span>
<span></span>
<span><span>fn</span><span> (r Repo[T]) </span><span>list</span><span>(</span><span>o ListOption</span><span>)</span><span> !</span><span>[]</span><span>T </span><span>{</span></span>
<span><span>	$if</span><span> T </span><span>is</span><span> Villain</span><span> {</span></span>
<span><span>		return</span><span> error</span><span>(</span><span>&#39;whoops you found Villain some how but its not implemented yet&#39;</span><span>)</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	return</span><span> error</span><span>(</span><span>&#39;whoops not implemented for </span><span>${T.name}</span><span> use one of (Hero, ...)&#39;</span><span>)</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> (r Repo[Hero]) </span><span>list</span><span>(</span><span>o HeroListOption</span><span>)</span><span> !</span><span>[]</span><span>Hero </span><span>{</span></span>
<span><span>	mut</span><span> query </span><span>:=</span><span> orm</span><span>.</span><span>build_query</span><span>()</span></span>
<span></span>
<span><span>	if</span><span> o</span><span>.</span><span>universe </span><span>!=</span><span> &#39;&#39;</span><span> {</span></span>
<span><span>		query</span><span>.</span><span>eq</span><span>(</span><span>&#39;universe&#39;</span><span>,</span><span> o</span><span>.</span><span>universe</span><span>)</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	if</span><span> o</span><span>.</span><span>created_since</span><span>.</span><span>unix</span><span>()</span><span> &gt;</span><span> 0</span><span> {</span></span>
<span><span>		query</span><span>.</span><span>gt</span><span>(</span><span>&#39;created_since&#39;</span><span>,</span><span> o</span><span>.</span><span>created_since</span><span>)</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	if</span><span> name </span><span>:=</span><span> o</span><span>.</span><span>name </span><span>{</span></span>
<span><span>		query</span><span>.</span><span>eq</span><span>(</span><span>&#39;name&#39;</span><span>,</span><span> name</span><span>)</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	return</span><span> r</span><span>.</span><span>psql</span><span>(</span><span>query</span><span>.</span><span>do</span><span>()</span><span>!</span><span>)</span><span>!</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> main</span><span>()</span><span> {</span></span>
<span><span>	r </span><span>:=</span><span> Repo</span><span>[</span><span>Villain</span><span>]{}</span></span>
<span><span>	r</span><span>.</span><span>list</span><span>()</span><span> or</span><span> {</span><span> println</span><span>(</span><span>err</span><span>)</span><span> }</span></span>
<span></span>
<span><span>	hero_repo </span><span>:=</span><span> Repo</span><span>[</span><span>Hero</span><span>]{}</span></span>
<span><span>	hero_repo</span><span>.</span><span>list</span><span>()</span><span>!</span></span>
<span><span>	hero_repo</span><span>.</span><span>list</span><span>(</span><span>name: </span><span>&#39;bruce&#39;</span><span>)</span><span>!</span></span>
<span><span>	hero_repo</span><span>.</span><span>list</span><span>(</span><span>name: </span><span>&#39;bruce&#39;</span><span>,</span><span> universe: </span><span>&#39;dc&#39;</span><span>)</span><span>!</span></span>
<span><span>	hero_repo</span><span>.</span><span>list</span><span>(</span><span>name: </span><span>&#39;bruce&#39;</span><span>,</span><span> universe: </span><span>&#39;marvel&#39;</span><span>)</span><span>!</span></span>
<span><span>	hero_repo</span><span>.</span><span>list</span><span>(</span><span>created_since: time</span><span>.</span><span>Time</span><span>{</span><span>year: </span><span>1996</span><span>})</span><span>!</span></span>
<span><span>}</span></span></code></pre>
<p>There‚Äôs a lot to unpack here. Let‚Äôs start with <code>@[params]</code> which tells the V compiler that the struct as a whole can be omitted entirely so you can write the empty function and it will still works. Secondly, since generics are a compile time thing we can use reflection to check for the name of the type itself. See link below to see what is possible. You can reflect and check for field existence and field types as well as attributes (remember <code>@[required]</code>?).</p>
<p>Alright, we keep seeing this bang (<code>!</code>) everywhere. So what is it? Short answer: Result type. Medium answer: <code>(int, err) -&gt; !int</code>. You don‚Äôt need the long answer. The bang can propagate although you must remember to handle this somewhere or it will cause a panic eventually. Finally, the optional type. I purposedly only use it for one of the field to show that it can be done, you can decide how you want to write your optionals. But damn! It feels great!</p>
<p><a href="https://github.com/uber-go/guide/blob/master/style.md?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#functional-options" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>go-uber/functional-options</a>
<a href="https://docs.vlang.io/structs.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#trailing-struct-literal-arguments" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/trailing-struct-args</a>
<a href="https://docs.vlang.io/conditional-compilation.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#compile-time-reflection" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/compile-time-reflection</a>
<a href="https://docs.vlang.io/type-declarations.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#optionresult-types-and-error-handling" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/optional-and-result-type</a></p>
<h2 id="enums-in-this-economy">Enums??? In this economy?</h2>
<p>Enums are so back baby. We can totally replace the previous section‚Äôs <code>universe</code> field as such.</p>
<pre tabindex="0" data-language="v"><code><span><span>enum</span><span> Universe</span><span> {</span></span>
<span><span>  dc</span></span>
<span><span>  marvel</span></span>
<span><span>  nil</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> (u Universe) </span><span>str</span><span>()</span><span> ?</span><span>string</span><span> {</span></span>
<span><span>	return</span><span> match</span><span> u </span><span>{</span></span>
<span><span>      // V knows the enum there&#39;s no need to type Universe.dc</span></span>
<span><span>      .</span><span>dc </span><span>{</span><span> &#39;dc&#39;</span><span> }</span></span>
<span><span>      .</span><span>marvel </span><span>{</span><span> &#39;marvel&#39;</span><span> }</span></span>
<span><span>      else</span><span> {</span><span>&#39;&#39;</span><span>}</span></span>
<span><span>	}</span></span>
<span><span>}</span></span>
<span></span>
<span><span>@</span><span>[</span><span>params</span><span>]</span></span>
<span><span>struct</span><span> HeroListOption</span><span> {</span></span>
<span><span>	ListOption</span></span>
<span><span>pub</span><span> mut</span><span>:</span></span>
<span><span>	universe Universe </span><span>=</span><span> .</span><span>nil</span></span>
<span><span>	name     </span><span>?</span><span>string</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> (r Repo[Hero]) </span><span>list</span><span>(</span><span>o HeroListOption</span><span>)</span><span> !</span><span>[]</span><span>Hero </span><span>{</span></span>
<span><span>	...</span></span>
<span></span>
<span><span>	if</span><span> o</span><span>.</span><span>universe </span><span>!=</span><span> .</span><span>nil </span><span>{</span></span>
<span><span>		query</span><span>.</span><span>eq</span><span>(</span><span>&#39;universe&#39;</span><span>,</span><span> o</span><span>.</span><span>universe</span><span>.</span><span>str</span><span>())</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	...</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> main</span><span>()</span><span> {</span></span>
<span><span>	hero_repo </span><span>:=</span><span> Repo</span><span>[</span><span>Hero</span><span>]{}</span></span>
<span><span>	hero_repo</span><span>.</span><span>list</span><span>(</span><span>name: </span><span>&#39;bruce&#39;</span><span>,</span><span> universe: </span><span>.</span><span>dc</span><span>)</span><span>!</span></span>
<span></span>
<span><span>	// functions not expecting enum requires the full path</span></span>
<span><span>	// auto str() conversion here - see Go fmt.Stringer() or your __str__, __toString()</span></span>
<span><span>	println</span><span>(</span><span>&#39;</span><span>${Universe.dc}</span><span>&#39;</span><span>)</span></span>
<span><span>}</span></span></code></pre>
<p>Optional type might be better here. I‚Äôm okay with this though. There is backed enum as well but you can only have integer backed enums. Did you also notice? Receiver method on the backed enum baby.</p>
<p><a href="https://docs.vlang.io/type-declarations.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#enums" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/enums</a></p>
<h2 id="lambda-the-best-kind-of-lamb">Lambda; the best kind of lamb</h2>
<p>The array stucts have a set of methods you can use like the basic <code>filter</code>, <code>map</code> - there is a stdlib module called <code>arrays</code> as well that you need to import. It provides more complex methods like <code>fold</code> and the likes. I don‚Äôt know about you but I am chuffed this exists.</p>
<pre tabindex="0" data-language="v"><code><span><span>import</span><span> math</span></span>
<span></span>
<span><span>fn</span><span> example</span><span>()</span><span> {</span></span>
<span><span>	// type hinting here to skip typing Universe.*</span></span>
<span><span>	mut</span><span> universes </span><span>:=</span><span> []</span><span>Universe</span><span>{}</span></span>
<span><span>	universes </span><span>=</span><span> [</span><span>.</span><span>dc</span><span>,</span><span> .</span><span>marvel</span><span>,</span><span> .</span><span>nil</span><span>,</span><span> .</span><span>dc</span><span>]</span></span>
<span><span>	dcs_or_marvel </span><span>:=</span><span> universes</span><span>.</span><span>filter</span><span>(</span><span>it</span><span> !=</span><span> .</span><span>nil</span><span>)</span></span>
<span><span>	nils </span><span>:=</span><span> universes</span><span>.</span><span>filter</span><span>(</span><span>|</span><span>u</span><span>|</span><span> u </span><span>==</span><span> .</span><span>nil</span><span>)</span></span>
<span></span>
<span><span>	// sorting in place</span></span>
<span><span>	[</span><span>5</span><span>,</span><span> 2</span><span>,</span><span> 1</span><span>,</span><span> 3</span><span>,</span><span> 4</span><span>]</span><span>.</span><span>sort</span><span>(</span><span>a </span><span>&lt;</span><span> b</span><span>)</span></span>
<span><span>	sorted </span><span>:=</span><span> [</span><span>5</span><span>,</span><span> 2</span><span>,</span><span> 1</span><span>,</span><span> 3</span><span>,</span><span> 4</span><span>]</span><span>.</span><span>sorted</span><span>(</span><span>a </span><span>&lt;</span><span> b</span><span>)</span></span>
<span><span>}</span></span>
<span></span>
<span><span>struct</span><span> XY</span><span> {</span></span>
<span><span>	x </span><span>int</span></span>
<span><span>	y </span><span>int</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> (xy XY) </span><span>dist_from_origin</span><span>()</span><span> f64</span><span> {</span></span>
<span><span>	return</span><span> math</span><span>.</span><span>sqrt</span><span>((</span><span>xy</span><span>.</span><span>x </span><span>*</span><span> xy</span><span>.</span><span>x</span><span>)</span><span> +</span><span> (</span><span>xy</span><span>.</span><span>y </span><span>*</span><span> xy</span><span>.</span><span>y</span><span>))</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> example2</span><span>()</span><span> {</span></span>
<span><span>	xys </span><span>:=</span><span> [</span><span>XY</span><span>{</span><span>1</span><span>,</span><span> 2</span><span>},</span><span> XY</span><span>{</span><span>10</span><span>,</span><span> 20</span><span>},</span><span> XY</span><span>{</span><span>-</span><span>1</span><span>,</span><span> -</span><span>69</span><span>}]</span></span>
<span><span>	xys</span><span>.</span><span>sort</span><span>(</span><span>a</span><span>.</span><span>dist_from_origin</span><span>()</span><span> &lt;</span><span> b</span><span>.</span><span>dist_from_origin</span><span>())</span></span>
<span><span>	y_asc </span><span>:=</span><span> xys</span><span>.</span><span>sorted</span><span>(</span><span>a</span><span>.</span><span>y </span><span>&lt;</span><span> b</span><span>.</span><span>y</span><span>)</span></span>
<span><span>}</span></span></code></pre>
<p>There‚Äôs a few caveats here. You gotta make sure the function you‚Äôre using actually allow for <code>it</code> or <code>a &lt; b</code> expression, but lambda expression will work anywhere a function is accepted as an argument. However, you can‚Äôt use lambda as a variable like <code>x_asc := |a, b| a.x &lt; b.x</code>. Still, neat. Use the LSP to check what is accepted.</p>
<p><a href="https://docs.vlang.io/functions-2.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#lambda-expressions" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/lambdas</a>
<a href="https://modules.vlang.io/builtin.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#array" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/array</a>
<a href="https://modules.vlang.io/arrays.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/arrays</a></p>

<p>As fun as it has been learning the language and building an <a href="https://github.com/ktunprasert/v-github-stats?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>svg service</a> - it is not without problems. The language is on the immature side of things. It has had some time to cook since I last tried it in 2023 and I like it even more. Let‚Äôs discuss some of the problems I‚Äôve personally encountered.</p>
<h2 id="nethttp"><code>net.http</code></h2>
<p>When I was trying to call the GraphQL endpoint using the <code>net.http</code> module, I ran into issue where it would instantly timeout. This <a href="https://github.com/vlang/v/issues/23717?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>network issue</a> described what is happening in my case precisely, adding the flag <code>-d use_openssl</code> completely fixed my problem. This seems to be the case when building for Ubuntu 22.4 - when building the exe for my Windows 11 I did not need this flag.</p>
<p>If you are wondering what the <code>-d</code> flag is about, it is a flag for compile-time code branching. See <a href="https://docs.vlang.io/conditional-compilation.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#compile-time-code" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/compiletime-code</a> for more.</p>
<p><a href="https://modules.vlang.io/net.http.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/net.http</a></p>
<h2 id="veb"><code>veb</code></h2>
<p>Another weird quirk I‚Äôve had when working with the <code>veb</code> HTTP server is refusing to build when trying to use gzip. Take a look at this build error message.</p>
<pre tabindex="0" data-language="plaintext"><code><span><span>/root/.local/v/vlib/veb/middleware.v:129:11: error: field `Ctx.return_type` is not public</span></span>
<span><span>127 |         handler: fn [T](mut ctx T) bool {</span></span>
<span><span>128 |             // TODO: compress file in streaming manner, or precompress them?</span></span>
<span><span>129 |             if ctx.return_type == .file {</span></span>
<span><span>    |                    ~~~~~~~~~~~</span></span>
<span><span>130 |                 return true</span></span>
<span><span>131 |             }</span></span></code></pre>
<p>What do you think the issue could be? Maybe my version of the language is incorrect or my build was faulty? I purged the local V install and got a fresh version straight from master branch. Yet the issue still persists. Another <code>-d</code> flag perhaps?</p>
<p>Luckily for me somebody already posted about this issue in GitHub, unluckily for me, I didn‚Äôt search the error message first (whoops). Well, I can‚Äôt really tell you what the issue is since I haven‚Äôt delved into V‚Äôs codebase itself. But I can tell you the resolution.</p>
<p>In my <code>main.v</code>, since I was messing around with servers and running main with arguments I needed to import both modules. This was the <code>head -n5</code> of my errorneous file.</p>
<pre tabindex="0" data-language="v"><code><span><span>module</span><span> main</span></span>
<span></span>
<span><span>import</span><span> os</span></span>
<span><span>import</span><span> veb</span></span></code></pre>
<p>The suggested fix?</p>
<pre tabindex="0" data-language="v"><code><span><span>module</span><span> main</span></span>
<span></span>
<span><span>import</span><span> veb</span></span>
<span><span>import</span><span> os</span></span></code></pre>
<p>Wow! The code now compiles! From a fresher‚Äôs perspective I have no clue why the order of import would affect code in different modules. Namespace should be sacred and completely independent of each other. The order of import should not matter at all. Both packages seems to be unrelated so <em>wtf happened?</em></p>
<p><a href="https://modules.vlang.io/veb.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/veb</a>
<a href="https://github.com/vlang/v/issues/20865?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang#issuecomment-1955101657" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/gzip-issue</a></p>
<h2 id="more-complex-build-system">More complex build system</h2>
<p>I had alluded to this earlier, there is a cost to using V over Go. V‚Äôs main backend compiles to C and this comes with complexity. There are a bunch of performance optimisations you can do when building the binary itself. You can even build non-static binaries if you wish (in fact this is the default). This is a double-edged sword, with Go, you get what you got. With V, I got what I got but I wonder if what I got can be gotten differently.</p>
<p>This might also complicate cross-compilation, the Go team has done a lot of work to ensure things werk across different architectures and OSes. I‚Äôve only tried compiling to Windows and Linux using the static flag. Here‚Äôs my build command:</p>
<pre tabindex="0" data-language="fish"><code><span><span>v</span><span> -prod -compress -d use_openssl -cflags </span><span>&#39;-static -Os -flto&#39;</span><span> -o main .</span></span></code></pre>
<p>The <code>-d</code> flag would have to be optional here depending on where I am trying to target as well, I‚Äôd probably have to spend time learning what‚Äôs possible for Macs as well. I know those platforms are definitely supported since their GitHub actions page contains the CI pipelines for these, but I would personally need to check if my specific implemntation, order of imports as well as <code>-d</code> flags need to be there for those systems or not.</p>
<p>This is the one big point I have to give to Go. They really have the just werks philosophy down.</p>
<p><a href="https://github.com/vlang/v/actions?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/ci</a>
<a href="https://docs.vlang.io/performance-tuning.html?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>vlang/performance-optimisation</a></p>
<h2 id="concurrency">Concurrency</h2>
<p>I wondered how the performance of the concurrency is compared to Go. The model is almost identical (which is good) but surely the implementation details are different. Luckily, there is a programming benchmark that exists already that answers my questions.</p>
<p><img src="https://kristun.dev/_astro/v-go-benchmark.ir4eF8XV_LFbJ3.webp" srcset="/_astro/v-go-benchmark.ir4eF8XV_Z2hrDBq.webp 640w, /_astro/v-go-benchmark.ir4eF8XV_LFbJ3.webp 672w" alt="image of V vs Go coro-prime-sieve bnechmark" sizes="(min-width: 672px) 672px, 100vw" loading="lazy" decoding="async" fetchpriority="auto" data-astro-image="responsive" width="672" height="404"/></p>
<p><a href="https://programming-language-benchmarks.vercel.app/v-vs-go?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>benchmark/coro-sieve-v-vs-go</a></p>
<p>Since I brought up concurrency let‚Äôs take a look at the code to see the implementation.</p>
<pre tabindex="0" data-language="v"><code><span><span>module</span><span> main</span></span>
<span></span>
<span><span>import</span><span> os</span></span>
<span><span>import</span><span> strconv</span></span>
<span></span>
<span><span>fn</span><span> main</span><span>()</span><span> {</span></span>
<span><span>	mut</span><span> n </span><span>:=</span><span> 100</span></span>
<span><span>	if</span><span> os</span><span>.</span><span>args</span><span>.</span><span>len </span><span>&gt;</span><span> 1</span><span> {</span></span>
<span><span>		n </span><span>=</span><span> strconv</span><span>.</span><span>atoi</span><span>(</span><span>os</span><span>.</span><span>args</span><span>[</span><span>1</span><span>])</span><span> or</span><span> {</span><span> n </span><span>}</span></span>
<span><span>	}</span></span>
<span></span>
<span><span>	mut</span><span> ch </span><span>:=</span><span> chan </span><span>int</span><span>{</span><span>cap: </span><span>1</span><span>}</span></span>
<span><span>	spawn</span><span> generate</span><span>(</span><span>ch</span><span>)</span></span>
<span><span>	for</span><span> _ </span><span>in</span><span> 0</span><span> ..</span><span> n </span><span>{</span></span>
<span><span>		prime </span><span>:=</span><span> &lt;-</span><span>ch</span></span>
<span><span>		println</span><span>(</span><span>prime</span><span>)</span></span>
<span><span>		ch_next </span><span>:=</span><span> chan </span><span>int</span><span>{</span><span>cap: </span><span>1</span><span>}</span></span>
<span><span>		spawn</span><span> filter</span><span>(</span><span>ch</span><span>,</span><span> ch_next</span><span>,</span><span> prime</span><span>)</span></span>
<span><span>		ch </span><span>=</span><span> ch_next</span></span>
<span><span>	}</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> generate</span><span>(</span><span>ch chan </span><span>int</span><span>)</span><span> {</span></span>
<span><span>	mut</span><span> i </span><span>:=</span><span> 2</span></span>
<span><span>	for</span><span> {</span></span>
<span><span>		ch </span><span>&lt;-</span><span> i</span><span>++</span></span>
<span><span>	}</span></span>
<span><span>}</span></span>
<span></span>
<span><span>fn</span><span> filter</span><span>(</span><span>chin chan </span><span>int</span><span>,</span><span> chout chan </span><span>int</span><span>,</span><span> prime </span><span>int</span><span>)</span><span> {</span></span>
<span><span>	for</span><span> {</span></span>
<span><span>		i </span><span>:=</span><span> &lt;-</span><span>chin</span></span>
<span><span>		if</span><span> i </span><span>%</span><span> prime </span><span>!=</span><span> 0</span><span> {</span></span>
<span><span>			chout </span><span>&lt;-</span><span> i</span></span>
<span><span>		}</span></span>
<span><span>	}</span></span>
<span><span>}</span></span></code></pre>
<p><a href="https://github.com/hanabi1224/Programming-Language-Benchmarks/blob/main/bench/algorithm/coro-prime-sieve/1.go?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>benchmark/sieve.go</a>
<a href="https://github.com/hanabi1224/Programming-Language-Benchmarks/blob/main/bench/algorithm/coro-prime-sieve/1.v?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>benchmark/sieve.v</a></p>
<p>tldr; it‚Äôs finding prime numbers by computing a running channel of previous prime numbers to feed into <code>n</code> to check if <code>n</code> is divisible by any previous primes.</p>
<p>It seems weird to me that V‚Äôs version is timing out even though both implementation looks almost identical. So I ran the benchmark on my local machine. Here‚Äôs my <code>justfile</code> to run the benchmark using all I know so far about optimising V.</p>
<pre tabindex="0" data-language="makefile"><code><span><span>default</span><span>:</span></span>
<span><span>    v -prod -gc boehm_full_opt -cc clang -cflags &#34;-march=broadwell&#34; -stats -showcc -no-rsp -o main_v 1.v</span></span>
<span><span>    go build -o main_go ./main.go</span></span>
<span><span>    hyperfine &#39;./main_v 100&#39; &#39;./main_go 100&#39; -N</span></span></code></pre>
<p>And the result:</p>
<pre tabindex="0" data-language="bash"><code><span><span>Benchmark</span><span> 1:</span><span> ./main_v</span><span> 100</span></span>
<span><span>  Time</span><span> (mean </span><span>¬±</span><span> œÉ</span><span>):      32.1 ms ¬±   2.9 ms    </span><span>[</span><span>User: </span><span>42.6</span><span> ms, System: </span><span>166.4</span><span> ms</span><span>]</span></span>
<span><span>  Range</span><span> (min </span><span>‚Ä¶</span><span> max</span><span>):    22.1 ms ‚Ä¶  40.7 ms    99 runs</span></span>
<span></span>
<span><span>Benchmark</span><span> 2:</span><span> ./main_go</span><span> 100</span></span>
<span><span>  Time</span><span> (mean </span><span>¬±</span><span> œÉ</span><span>):       1.8 ms ¬±   0.2 ms    </span><span>[</span><span>User: </span><span>2.3</span><span> ms, System: </span><span>0.3</span><span> ms</span><span>]</span></span>
<span><span>  Range</span><span> (min </span><span>‚Ä¶</span><span> max</span><span>):     1.2 ms ‚Ä¶   3.1 ms    1471 runs</span></span>
<span></span>
<span><span>Summary</span></span>
<span><span>  &#39;./main_go 100&#39;</span><span> ran</span></span>
<span><span>   18.18</span><span> ¬±</span><span> 2.81</span><span> times</span><span> faster</span><span> than</span><span> &#39;./main_v 100&#39;</span></span></code></pre>
<p>This is exacerbated further when we run N=1000</p>
<pre tabindex="0" data-language="sh"><code><span><span>Benchmark</span><span> 1:</span><span> ./main_v</span><span> 1000</span></span>
<span><span>  Time</span><span> (mean </span><span>¬±</span><span> œÉ</span><span>):      1.189 s ¬±  0.340 s    </span><span>[</span><span>User: </span><span>4.410</span><span> s, System: </span><span>8.144</span><span> s</span><span>]</span></span>
<span><span>  Range</span><span> (min </span><span>‚Ä¶</span><span> max</span><span>):    0.806 s ‚Ä¶  1.830 s    10 runs</span></span>
<span></span>
<span><span>Benchmark</span><span> 2:</span><span> ./main_go</span><span> 1000</span></span>
<span><span>  Time</span><span> (mean </span><span>¬±</span><span> œÉ</span><span>):      13.4 ms ¬±   2.4 ms    </span><span>[</span><span>User: </span><span>132.5</span><span> ms, System: </span><span>12.3</span><span> ms</span><span>]</span></span>
<span><span>  Range</span><span> (min </span><span>‚Ä¶</span><span> max</span><span>):     8.6 ms ‚Ä¶  21.2 ms    182 runs</span></span>
<span></span>
<span><span>Summary</span></span>
<span><span>  &#39;./main_go 1000&#39;</span><span> ran</span></span>
<span><span>   88.54</span><span> ¬±</span><span> 29.90</span><span> times</span><span> faster</span><span> than</span><span> &#39;./main_v 1000&#39;</span></span></code></pre>
<p>Taking a look at the N=100 profiling we can see what happened exactly</p>
<pre tabindex="0" data-language="bash"><code><span><span>‚ûú</span><span> cat</span><span> prof.txt</span><span> |</span><span> sort</span><span> --key</span><span> 2n</span><span> -n</span><span> |</span><span> tail</span><span> -n</span><span> 10</span></span>
<span><span>           202</span><span>          0.256ms</span><span>         -1.819ms</span><span>           1267ns</span><span> sync__new_spin_lock</span></span>
<span><span>           404</span><span>          0.064ms</span><span>         -2.664ms</span><span>            158ns</span><span> sync__Semaphore_init</span></span>
<span><span>          4387</span><span>      10644.653ms</span><span>        540.655ms</span><span>        2426408ns</span><span> sync__Semaphore_wait</span></span>
<span><span>          8128</span><span>       5572.567ms</span><span>        739.231ms</span><span>         685601ns</span><span> sync__Channel_try_push_priv</span></span>
<span><span>          8172</span><span>       9062.871ms</span><span>        941.089ms</span><span>        1109015ns</span><span> sync__Channel_try_pop_priv</span></span>
<span><span>         15959</span><span>        406.167ms</span><span>         87.435ms</span><span>          25451ns</span><span> sync__Semaphore_post</span></span>
<span><span>         16160</span><span>          6.993ms</span><span>        -38.159ms</span><span>            433ns</span><span> sync__SpinLock_lock</span></span>
<span><span>         16174</span><span>          3.412ms</span><span>          0.754ms</span><span>            211ns</span><span> sync__SpinLock_unlock</span></span>
<span><span>       1766049</span><span>        380.257ms</span><span>       -434.470ms</span><span>            215ns</span><span> sync__Semaphore_try_wait</span></span></code></pre>
<p>There is a <em>ton</em> of calls going to <code>Semaphore_try_wait</code> with the actual <code>Sempahore_wait</code> execution itself taking over <code>10_000 ms</code> in total.</p>
<p>This suggests to me that while the concurrency is there, it exists and work similarly to the end user. Though in the current state, it‚Äôs no where near Go‚Äôs maturity and optimisation.</p>

<p>I like V a lot. The abstraction over the syntax is so nice that made me enjoy writing the syntax as a whole. It makes me wish that Go could do more with what they have, but you and I know that Go would never. V isn‚Äôt without it‚Äôs problems though, the ecosystem is still quite immature, compiler flags need grokking over even if you‚Äôre not a performance maximalist. IMO, the issue comes down to maturity, given enough time and contributor I believe the language will bloom beautifully. The syntax conveniences already had me sold. I know AI can write boilerplate but it feels good to not need it at all and write everything myself.</p>
<p>V has come a lot further than when I tried it in 2023. I‚Äôll be actively using it from now on since my main job in Go leaves me wishing for more from time to time. If you enjoy Go anyway it‚Äôs worth checking out. Life it too short to mainline one language. Oh and check out my SVG service <a href="https://github.com/ktunprasert/v-github-stats?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>ktunprasert/v-github-stats</a></p>
<p><img src="https://app.kristun.dev/stats/?num_languages=10&amp;num_repos=35" alt="language stats"/></p>

<p>vlang - <a href="https://vlang.io/?utm_source=kristun.dev&amp;utm_medium=referral&amp;utm_campaign=my-foray-into-vlang" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" role="img" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-label="External Link Globe Icon">
  <title>External Link Globe</title>
  <circle cx="12" cy="12" r="10"></circle>
  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"></path>
  <path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"></path>
  <path d="M2 12h20"></path>
</svg>https://vlang.io</a></p> </article></div>
  </body>
</html>
