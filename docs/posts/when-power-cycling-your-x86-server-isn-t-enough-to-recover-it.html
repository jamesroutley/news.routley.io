<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/tech/ServerWhenPowerCycleNotEnough">Original</a>
    <h1>When power cycling your (x86) server isn&#39;t enough to recover it</h1>
    
    <div id="readability-page-1" class="page"><div><h2>When power cycling your (x86) server isn&#39;t enough to recover it</h2>

	<p><small>December 21, 2024</small></p>
</div><div><p>We have various sorts of servers <a href="https://support.cs.toronto.edu/">here</a>,
and generally they run without problems unless they experience
obvious hardware failures. Rarely, we experience Linux kernel hangs
on them, and when this happens, we power cycle the machines, as one
does, and the server comes back. Well, almost always. We have two
servers (of the same model), where something different has happened
once.</p>

<p>Each of the servers either crashed in the kernel and started to
reboot or hung in the kernel and was power cycled (both were
essentially unused at the time). As each server was running through
the system firmware (<a href="https://utcc.utoronto.ca/~cks/space/blog/tech/UEFIAndBIOSAndOtherPCTerms">&#39;BIOS&#39;</a>), both
of them started printing an apparently endless series of error dumps
to their serial consoles (which had been configured in the BIOS as
well as in the Linux kernel). These were like the following:</p>

<pre>!!!! X64 Exception Type - 12(#MC - Machine-Check)  CPU Apic ID - 00000000 !!!!
RIP  - 000000006DABA5A5, CS  - 0000000000000038, RFLAGS - 0000000000010087
RAX  - 0000000000000008, RCX - 0000000000000000, RDX - 0000000000000001
RBX  - 000000007FB6A198, RSP - 000000005D29E940, RBP - 000000005DCCF520
RSI  - 0000000000000008, RDI - 000000006AB1B1B0
R8   - 000000005DCCF524, R9  - 000000005D29E850, R10 - 000000005D29E8E4
R11  - 000000005D29E980, R12 - 0000000000000008, R13 - 0000000000000001
R14  - 0000000000000028, R15 - 0000000000000000
DS   - 0000000000000030, ES  - 0000000000000030, FS  - 0000000000000030
GS   - 0000000000000030, SS  - 0000000000000030
CR0  - 0000000080010013, CR2 - 0000000000000000, CR3 - 000000005CE01000
CR4  - 0000000000000668, CR8 - 0000000000000000
DR0  - 0000000000000000, DR1 - 0000000000000000, DR2 - 0000000000000000
DR3  - 0000000000000000, DR6 - 00000000FFFF0FF0, DR7 - 0000000000000400
GDTR - 0000000076E46000 0000000000000047, LDTR - 0000000000000000
IDTR - 000000006AC3D018 0000000000000FFF,   TR - 0000000000000000
FXSAVE_STATE - 000000005D29E5A0
!!!! Can&#39;t find image information. !!!!
</pre>

<p>(The last line leaves me with questions about the firmware/BIOS but
I&#39;m unlikely to get answers to them. I&#39;m putting the full output
here for <a href="https://mastodon.social/@cks/113694391576915989">the usual reason</a>.)</p>

<p>Some of the register values varied between reports, others didn&#39;t
after the first one (for example, from the second onward the RIP
appears to have always been 6DAB14D1, which suggests maybe it&#39;s an
exception handler).</p>

<p>In both cases, we turned off power to the machines (well, to the
hosts; we were working through the <a href="https://utcc.utoronto.ca/~cks/space/blog/tech/IPMIAndBMCTerminology">BMC</a>,
which stayed powered on), let them sit for a few minutes, and then
powered them on again.  This returned them to regular, routine,
unexciting service, where neither of them have had problems since.</p>

<p>I knew in a theoretical way that there are parts of an x86 system
that aren&#39;t necessarily completely reset if the power is only
interrupted briefly (my understanding is that a certain amount of
power lingers until capacitors drain and so on, but this may be
wrong and there&#39;s a different mechanism in action). But I usually
don&#39;t have it demonstrated in front of me this way, where a simple
power cycle isn&#39;t good enough to restore a system but a cool down
period works.</p>

<p>(Since we weren&#39;t cutting external power to the entire system, this
also left <a href="https://utcc.utoronto.ca/~cks/space/blog/tech/ATXDesktopPowerControlHow">standby power</a> (<a href="https://utcc.utoronto.ca/~cks/space/blog/tech/ATXServerPowerControlHow">also</a>) available, which means some things never
completely lost power even with the power being &#39;off&#39; for a couple
of minutes.)</p>

<p>PS: Actually there&#39;s an alternate explanation, which is that the
first power cycle didn&#39;t do enough to reset things but a second one
would have worked if I&#39;d tried that instead of powering the servers
off for a few minutes. I&#39;m not certain I believe this and in any
case, powering the servers off for a cool down period was faster
than taking a chance on a second power cycle reset.</p>
</div></div>
  </body>
</html>
