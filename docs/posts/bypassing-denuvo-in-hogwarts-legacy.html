<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://momo5502.com/posts/2024-03-31-bypassing-denuvo-in-hogwarts-legacy/">Original</a>
    <h1>Bypassing Denuvo in Hogwarts Legacy</h1>
    
    <div id="readability-page-1" class="page"><div><p>When I announced my Black Ops 3 integrity bypass, someone commented that my research was not impressive and I should try analyzing Denuvo instead.</p>
<p>That kinda stuck with me, so I did what everyone would do and spent the last 5 months of my life reverse engineering and bypassing the Denuvo DRM in Hogwarts Legacy.</p>
<p>I am obviously not as skilled and experienced as EMPRESS, who managed to do it within days, but that‚Äôs ok üòÉ</p>

<p><img loading="lazy" src="https://momo5502.com/posts/2024-03-31-bypassing-denuvo-in-hogwarts-legacy/images/denuvo-token.jpg" alt=""/>
</p>
<p>The game collects hardware/software features into a fingerprint and generates a Steam Ticket (proof of game ownership).</p>
<p>Fingerprint and Ticket are then sent to Denuvo Servers.</p>
<p>From there the Steam Ticket is sent to Steam to make sure the user really owns the game (I obviously don‚Äôt know what‚Äôs going on in their servers, so this is only an assumption, but it should be accurate enough).</p>
<p>If the user really owns the game, a Denuvo Token is generated, that only works on a PC with the exact fingerprint.</p>
<p>Using that token, the player can now run the game.</p>
<p>The game can not run without the token, as it is used to e.g. decrypt certain values at runtime and similar things.</p>
<p>Ontop of using the token to decrypt values, Denuvo regularly verifies the hardware features for the fingerprint still match with the token, at runtime.</p>

<p>Cracking the game was not a goal I had. I like Hogwarts Legacy and thus causing any harm is not my intention. I wanted to do research purely for myself.</p>
<p>Therefore this post is going to be intentionally vague and not going to show how I analyzed and patched the game in detail, because I don‚Äôt need anymore legal trouble than I already have.</p>
<p>The actual goal I had in mind was to find all features the game uses to derive the fingerprint and to patch them.
Ontop of that, I want to patch most of the runtime checks.</p>
<p>For a real crack, it is obviously needed to patch all of the runtime checks.
Finding all of them is still an extremely time consuming task, so everyone who has achieved that deserves my utmost respect.</p>
<p>However, I do believe that once I have patched some/most of the runtime checks and discovered all hardware features, I would be capable to patch all of them with enough time and motivation.</p>
<p>The real challenge I saw for myself was to analyze the protection to discover all the bindings it uses for the fingerprint.</p>

<p>Using a Denuvo Token on a PC that has a mismatching fingerprint shows the following dialog:</p>
<p><img loading="lazy" src="https://momo5502.com/posts/2024-03-31-bypassing-denuvo-in-hogwarts-legacy/images/bad-token.png" alt=""/>
</p>
<p>Therefore the goal is to get past that dialog.</p>
<p>This is the part I wish I could talk more about, but I don‚Äôt think that‚Äôs a good idea. Instead I will roughly scratch the surface and at least outline the tools I used.</p>
<p>To figure out what features the game collects I used the <a href="https://qiling.io/">Qiling</a> reverse engineering framework.</p>
<p><img loading="lazy" src="https://momo5502.com/posts/2024-03-31-bypassing-denuvo-in-hogwarts-legacy/images/qiling.png" alt="Qiling"/>
</p>
<p>However, it requires a whole lot of scripting and adaption. It is by far not a tool that does all the work for you out-of-the-box.</p>
<p>In fact, it even has quite a lot of bugs (e.g. wrongly emulated Windows APIs) and lacks quite a few essential features: I had to implement so many basics that I expected the framework to handle, e.g. TLS support ü•≤.</p>
<p>It feels like it is mainly designed for Linux, so maybe one day I can either upstream my patches/fixes or write my own framework. Who knows.</p>
<p>But even with all these flaws, I can not stress enough how helpful of a tool it was.</p>
<p>Getting fully accomodated to Qiling and finding most of the fingerprint features took me about two months.
Discovering the last one took the remaining 3 months and I only discovered it on accident.</p>
<p>To verify that a certain feature really is part of the fingerprint, I patched/spoofed it and checked that my previously valid Denuvo Token is now invalid and shows the error dialog.</p>
<p>For most of my patches, I had to use quite a lot of runtime disassembling to dynamically build my hooks and stubs, which lead me to discover quite a few bugs in various disassemblers üòÇ.</p>
<p>However, as making a portable crack was not a goal, I made extensive use of my own <a href="https://github.com/momo5502/hypervisor">hypervisor</a>. I used it for example to install EPT hooks at a few locations that were otherwise too tedious to patch manually.</p>
<p>With all features at hand, I forced the game to generate a token on my PC, using a fingerprint for my PC.
Using all my patches and hooks (~2000 in total), I now wanted to run the game on my laptop using the token generated for my PC.</p>
<p>After some time, I managed to get it to run until the start screen:</p>
<p><img loading="lazy" src="https://momo5502.com/posts/2024-03-31-bypassing-denuvo-in-hogwarts-legacy/images/running.png" alt=""/>
</p>
<p>This is the point I wanted to reach.
The game can now launch with a token issued for a different machine and I am absolutely happy.</p>
<p>The game obviously still crashes here and there with the PC token. Sometimes I can launch into the game and play, sometimes it crashes. This is where one would need to patch all runtime checks.</p>

<p>Everyone knows the rumors that Denuvo kills performance, but is that actually true?</p>
<p>With all hooks to disable (most) runtime validations in place, it is now time to do some performance measurements:</p>
<p>Note that this analysis only applies to Hogwarts Legacy. I don‚Äôt know if any of that applies to other games protected by Denuvo!</p>
<p>
  <iframe src="https://www.youtube.com/embed/6JriEmiZ1t0" allowfullscreen="" title="YouTube Video"></iframe>
</p>

<!-- raw HTML omitted -->
<p>Every time the console prints <code>[MOMO] OVERHEAD</code> one of my hooks triggers. This essentially means Denuvo intervenes in the execution of the game (that I had to patch). This in turn means Denuvo causes at least ‚Äúsome‚Äù (non-zero) performance overhead during those times.</p>
<p>One can see that Denuvo does indeed intervene from time to time, but from what it seems, it doesn‚Äôt do that very often.</p>
<p>I was really surprised how few <code>OVERHEAD</code> lines were logged, as I expected the rumors to be true and tons of lines to be spamed, but this was not the case!</p>
<p>Of course that‚Äôs no absolute proof that Denuvo does not kill the performance. There might be interactions Denuvo does, which didn‚Äôt require a patch and thus won‚Äôt get logged.</p>
<p>It seems the protection is very well integrated into the game. Being a DRM developer myself, I know this is often a super tough challenge and definitely requires the protection to be manually integrated and adapted for the game.</p>

<p>This was the last thing I currently had on my bucket list and I‚Äôm so happy to cross that one off.
It is to note that Denuvo could have done things a bit differently that would have made my analysis a lot harder.</p>
<p>Developing DRMs is always a super challenging task. Whether the use of DRMs is good or not, whether it feeds capitalism or just protects the hard work done by developers is something I can‚Äôt decide.
After all though, I don‚Äôt think Denuvo deserves all the hate it gets.</p>


  </div></div>
  </body>
</html>
