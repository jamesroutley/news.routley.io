<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://supabase.com/blog/postgres-on-fly-by-supabase">Original</a>
    <h1>Fly Postgres, Managed by Supabase</h1>
    
    <div id="readability-page-1" class="page"><article><div><p><img alt="Fly Postgres, managed by Supabase" loading="lazy" decoding="async" data-nimg="fill" sizes="100vw" srcset="/_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=640&amp;q=75 640w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=750&amp;q=75 750w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=828&amp;q=75 828w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=3840&amp;q=75 3840w" src="https://supabase.com/_next/image?url=%2Fimages%2Fblog%2Flwx-supafly%2Ffly-postgres-thumb.png&amp;w=3840&amp;q=75"/></p>
<p>We&#39;re launching Fly Postgres, a managed Postgres offering by Supabase and <a href="http://Fly.io">Fly.io</a>.</p>
<p>Fly Postgres databases launch on Fly.io&#39;s edge computing platform from any of their 37+ locations. You get everything you expect from a Supabase managed database:</p>
<ul>
<li>a full-featured Postgres database with <a href="https://github.com/supabase/postgres">over 40+ extensions</a></li>
<li><a href="https://github.com/pgvector/pgvector/">pgvector</a> support for <a href="https://supabase.com/docs/guides/ai">Vector/AI workloads</a></li>
<li><a href="https://supabase.com/blog/supavisor-postgres-connection-pooler">Supavisor</a>, our Postgres connection pooler</li>
<li>Daily backups and point-in-time recovery</li>
<li><a href="https://supabase.com/docs/guides/platform/branching">Branching</a>, <a href="https://github.com/supabase/supabase-grafana">observability</a>, and migrations</li>
<li>A <a href="https://supabase.com/blog/studio-introducing-assistant">dashboard</a> for managing your database</li>
<li>Auto-generated Data APIs:<!-- -->
<ul>
<li><a href="https://supabase.com/docs/guides/api">REST</a> (using <a href="https://postgrest.org">PostgREST</a>)</li>
<li><a href="https://supabase.com/docs/guides/graphql">GraphQL</a> (using <a href="https://github.com/supabase/pg_graphql/">pg_graphql</a>)</li>
</ul>
</li>
</ul>
<p>This is deployed within the Fly infrastructure, making it the fastest Postgres database for your data intensive applications deployed on Fly.</p>
<h2 id="managing-expectations">Managing expectations</h2>
<p>Before you get too excited, this will be a progressive rollout. It turns out that building inter-company integrations is a lot of work when you factor in billing, support handoff, and educating Supabase staff on how to understand <a href="https://fly.io/blog/carving-the-scheduler-out-of-our-orchestrator/">sandwich analogies</a>.</p>
<p>We&#39;ve been working with a few early testers and we have some bugs to iron out. You can <a href="https://forms.supabase.com/fly-postgres">sign up for the waitlist</a> if you want to help with testing. We&#39;ll accept more testers next month, and we&#39;ll communicate more release timelines as soon as we&#39;re confident that your data is safe.</p>
<h2 id="supabase--fly--supafly">Supabase + Fly = SupaFly?</h2>
<p>We&#39;re excited about what this partnership means for 2024. Namely, distributing Postgres across the planet. The Firecracker VM gives us some neat ideas for Postgres. Integrating with Fly also puts a bunch of easy-to-spin-up compute resources right next to the database. That sounds like fun.</p>
<h2 id="managed-vs-unmanaged-postgres">Managed vs unmanaged Postgres</h2>
<p>Fly&#39;s current Postgres offering is <a href="https://fly.io/docs/postgres/getting-started/what-you-should-know">unmanaged</a>. This means that you&#39;re responsible for handling scaling, point-in-time backups, replication, major version upgrades, etc. We&#39;ll run Fly&#39;s <em>managed</em> Postgres, which means that we do all that for you, and you can concentrate on building.</p>
<p>The managed service is built with the <a href="https://fly.io/docs/reference/extensions_api/">Fly extension API</a> (also used by <a href="https://fly.io/docs/reference/redis/">Fly Redis</a>).</p>
<p>Testers can launch a Postgres database using the <code>fly extensions</code> command:</p>

<p>Once the service is stable, it will be swapped for the <code>postgres</code> namespace:</p>

<p>With Fly Postgres, the database is deployed within Fly infrastructure leading to a much lower latency for data heavy applications.</p>
<h2 id="under-the-hood">Under the hood</h2>
<p>Let&#39;s dig into the implementation.</p>
<h3 id="working-with-fly-machines"><strong>Working with Fly machines</strong></h3>
<p>Fly Postgres is built on top of <a href="https://fly.io/docs/machines/">Fly machines</a>. Machines are light-weight Firecracker VMs. The Machines API offers substantial control over an application&#39;s lifecycle. They can be suspended during inactivity and resumed within a couple of seconds whenever a new request arrives.</p>
<p>We built <a href="https://github.com/supabase/fly-admin">fly-admin</a>, a Typescript wrapper to simplify our interaction with the Fly API. Supabase bundles a few extra services into Postgres, so we prepared a single Docker image which we can pass to the Fly Machines API. Our current build process outputs an AMI for AWS using <a href="https://www.packer.io/">Packer</a>. We re-use parts of that pipeline to build an <a href="https://github.com/supabase/postgres/tree/develop/docker/all-in-one">All In One Image</a>. This image has all the services to run a Supabase project within a single Docker container.</p>
<h3 id="move-to-multi-cloud"><strong>Move to multi-cloud</strong></h3>
<p>With this launch, Supabase is officially multi-cloud. We deliberately avoided using AWS&#39;s managed services when building Supabase to simplify our multi-cloud transition. These transitions are never simple - even the base primitives offered between cloud providers can vary significantly.</p>
<p>For example, Fly Machines offer a simple method for suspending a VM when it&#39;s not in use, transparently resuming it within seconds. This simplifies the process of pausing inactive databases. There is no direct primitive on AWS to achieve this.</p>
<p>On the other hand, we had to work around a few AWS primitives that Fly doesn&#39;t provide. Fly machines don&#39;t have network-attached storage, so we treat any data in Fly volumes as ephemeral. We run physical backups for all projects running on Fly using WAL-G. Database changes are continuously streamed to S3. When there is a host or volume corruption, we restore the project to a new Fly host using the latest data in S3.</p>
<p>To capture host issues on AWS, we listen to <a href="https://docs.aws.amazon.com/health/latest/ug/aws-health-concepts-and-terms.html">AWS Health events</a>. For Fly, we send the Machine logs to <a href="https://logflare.com/">Logflare</a> using the <a href="https://github.com/superfly/fly-log-shipper">fly-log-shipper</a>.</p>
<p>In addition to publishing images in AWS&#39;s container registry, we publish the All In One image to Fly&#39;s Docker registry. This improved the reliability and performance of project launches on Fly.</p>
<h3 id="building-the-fly-extension"><strong>Building the Fly extension</strong></h3>
<p>Fly has an <a href="https://fly.io/docs/reference/extensions_api/">excellent approach</a> for extending their platform. We added a few routes to our API to provision users and projects and we were on our way.</p>
<p>Fly users can access the Supabase dashboard using their existing Fly credentials. The Supabase API initiates an OAuth flow with Fly to authenticate the user. Our Auth team created a <a href="https://github.com/supabase/gotrue/pull/1261">Fly OAuth provider</a> to make the integration with our API easier.</p>
<h2 id="challenges">Challenges</h2>
<p>We&#39;re still working through a few challenges with the Fly team.</p>
<h3 id="support-for-network-restrictions">Support for Network Restrictions</h3>
<p>The <a href="https://supabase.com/docs/guides/platform/network-restrictions">network restrictions</a> feature relies on the container receiving the correct IP of the client connecting to it. With our current setup, the container sees the Fly proxy IP instead. Connections run through the Fly proxy, which exposes the Proxy protocol. Postgres can&#39;t use this information directly, but we&#39;re looking at <a href="https://github.com/supabase/supavisor">making Supavisor proxy-protocol aware</a>.</p>
<h3 id="backups-within-fly">Backups within Fly</h3>
<p>Fly projects are backed up to AWS S3 as Fly doesn&#39;t provide managed Blob storage (yet). This incurs inter-cloud bandwidth fees. Luckily, Fly are working on <a href="https://fly.io/docs/flyctl/extensions-tigris-list/">Blob Storage</a>, watch this space.</p>
<h2 id="getting-started">Getting started</h2>
<p>Sign up for the preview <a href="https://forms.supabase.com/fly-postgres">here</a>, wait till we allowlist your org, and get started with the <a href="https://supabase.com/docs/guides/platform/fly-postgres#quickstart">Quickstart</a> in our docs.</p>
<p>Fly organizations will get one free project. We&#39;re still working through some of the finer details on billing, but the pricing will remain relatively unchanged from our current <a href="https://supabase.com/pricing">pricing</a>.</p></div></article></div>
  </body>
</html>
