<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ocaml-multicore/effects-examples/blob/master/algorithmic_differentiation.ml">Original</a>
    <h1>Reverse-mode algorithmic differentiation using effect handlers in OCaml 5</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="OCaml" data-tagsearch-path="algorithmic_differentiation.ml">
        <tbody><tr>
          <td id="L1" data-line-number="1"></td>
          <td id="LC1"><span><span>(*</span> Reverse-mode Algorithmic differentiation using effect handlers.</span></td>
        </tr>
        <tr>
          <td id="L2" data-line-number="2"></td>
          <td id="LC2"><span>   Adapted from https://twitter.com/tiarkrompf/status/963314799521222656.</span></td>
        </tr>
        <tr>
          <td id="L3" data-line-number="3"></td>
          <td id="LC3"><span>   See https://openreview.net/forum?id=SJxJtYkPG for more information. <span>*)</span></span></td>
        </tr>
        <tr>
          <td id="L4" data-line-number="4"></td>
          <td id="LC4"><span>open</span> <span>Effect</span></td>
        </tr>
        <tr>
          <td id="L5" data-line-number="5"></td>
          <td id="LC5"><span>open</span> <span>Effect.Deep</span></td>
        </tr>
        <tr>
          <td id="L6" data-line-number="6"></td>
          <td id="LC6">
</td>
        </tr>
        <tr>
          <td id="L7" data-line-number="7"></td>
          <td id="LC7"><span>module</span> <span>F</span> : <span>sig</span></td>
        </tr>
        <tr>
          <td id="L8" data-line-number="8"></td>
          <td id="LC8">  <span>type</span> <span>t</span></td>
        </tr>
        <tr>
          <td id="L9" data-line-number="9"></td>
          <td id="LC9">  <span>val</span> <span>mk</span> : <span>float</span> -&gt; <span>t</span></td>
        </tr>
        <tr>
          <td id="L10" data-line-number="10"></td>
          <td id="LC10">  val (<span>+.</span>) : t -&gt; t -&gt; t</td>
        </tr>
        <tr>
          <td id="L11" data-line-number="11"></td>
          <td id="LC11">  val ( <span>*.</span> ) : t -&gt; t -&gt; t</td>
        </tr>
        <tr>
          <td id="L12" data-line-number="12"></td>
          <td id="LC12">  <span>val</span> <span>grad</span>  : (<span>t</span> -&gt; <span>t</span>) -&gt; <span>float</span> -&gt; <span>float</span></td>
        </tr>
        <tr>
          <td id="L13" data-line-number="13"></td>
          <td id="LC13">  <span>val</span> <span>grad2</span> : (<span>t</span> <span>*</span> <span>t</span> -&gt; <span>t</span>) -&gt; <span>float</span> <span>*</span> <span>float</span> -&gt; <span>float</span> <span>*</span> <span>float</span></td>
        </tr>
        <tr>
          <td id="L14" data-line-number="14"></td>
          <td id="LC14"><span>end</span> <span>=</span> <span>struct</span></td>
        </tr>
        <tr>
          <td id="L15" data-line-number="15"></td>
          <td id="LC15">  <span>type</span> <span>t </span>= { <span>v</span> : <span>float</span><span>;</span> <span>mutable </span><span>d</span> : <span>float</span> }</td>
        </tr>
        <tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16">
</td>
        </tr>
        <tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17">  <span>let</span> <span>mk</span> <span>v</span> <span>=</span> {v; d <span>=</span> <span>0.0</span>}</td>
        </tr>
        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18">
</td>
        </tr>
        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19">  <span>type</span> <span>_ Effect.t +</span>= <span>Add</span> : <span>t</span> <span>*</span> <span>t</span> -&gt; <span>t</span> <span>Effect</span><span>.t</span></td>
        </tr>
        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20">  <span>type</span> <span>_ Effect.t +</span>= <span>Mult</span> : <span>t</span> <span>*</span> <span>t</span> -&gt; <span>t</span> <span>Effect</span><span>.t</span></td>
        </tr>
        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21">
</td>
        </tr>
        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22">  <span>let</span> <span>run</span> <span>f</span> <span>=</span></td>
        </tr>
        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23">    ignore (match_with f <span>()</span> {</td>
        </tr>
        <tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24">      retc <span>=</span> (<span>fun</span> <span>r</span> -&gt; r.d <span>&lt;</span><span>-</span> <span>1.0</span>; r);</td>
        </tr>
        <tr>
          <td id="L25" data-line-number="25"></td>
          <td id="LC25">      exnc <span>=</span> raise;</td>
        </tr>
        <tr>
          <td id="L26" data-line-number="26"></td>
          <td id="LC26">      effc <span>=</span> <span>fun</span> (<span>type</span> <span>a</span>) (<span>e</span> <span>: a Effect.t</span>) -&gt;</td>
        </tr>
        <tr>
          <td id="L27" data-line-number="27"></td>
          <td id="LC27">        <span>match</span> e <span>with</span><span></span></td>
        </tr>
        <tr>
          <td id="L28" data-line-number="28"></td>
          <td id="LC28">        <span>|</span> <span>Add</span> (<span>a</span>, <span>b</span>) -&gt; <span>Some</span> (<span>fun</span> (<span>k</span> <span>: (a, _) continuation</span>) -&gt;</td>
        </tr>
        <tr>
          <td id="L29" data-line-number="29"></td>
          <td id="LC29">            <span>let</span> x <span>=</span> {v <span>=</span> a.v <span>+.</span> b.v; d <span>=</span> <span>0.0</span>} <span>in</span></td>
        </tr>
        <tr>
          <td id="L30" data-line-number="30"></td>
          <td id="LC30">            ignore (continue k x);</td>
        </tr>
        <tr>
          <td id="L31" data-line-number="31"></td>
          <td id="LC31">            a.d <span>&lt;</span><span>-</span> a.d <span>+.</span> x.d;</td>
        </tr>
        <tr>
          <td id="L32" data-line-number="32"></td>
          <td id="LC32">            b.d <span>&lt;</span><span>-</span> b.d <span>+.</span> x.d;</td>
        </tr>
        <tr>
          <td id="L33" data-line-number="33"></td>
          <td id="LC33">            x)</td>
        </tr>
        <tr>
          <td id="L34" data-line-number="34"></td>
          <td id="LC34">        <span>|</span> <span>Mult</span>(<span>a</span>,<span>b</span>) -&gt; <span>Some</span> (<span>fun</span> <span>k</span> -&gt;</td>
        </tr>
        <tr>
          <td id="L35" data-line-number="35"></td>
          <td id="LC35">            <span>let</span> x <span>=</span> {v <span>=</span> a.v <span>*.</span> b.v; d <span>=</span> <span>0.0</span>} <span>in</span></td>
        </tr>
        <tr>
          <td id="L36" data-line-number="36"></td>
          <td id="LC36">            ignore (continue k x);</td>
        </tr>
        <tr>
          <td id="L37" data-line-number="37"></td>
          <td id="LC37">            a.d <span>&lt;</span><span>-</span> a.d <span>+.</span> (b.v <span>*.</span> x.d);</td>
        </tr>
        <tr>
          <td id="L38" data-line-number="38"></td>
          <td id="LC38">            b.d <span>&lt;</span><span>-</span> b.d <span>+.</span> (a.v <span>*.</span> x.d);</td>
        </tr>
        <tr>
          <td id="L39" data-line-number="39"></td>
          <td id="LC39">            x)</td>
        </tr>
        <tr>
          <td id="L40" data-line-number="40"></td>
          <td id="LC40">        <span>|</span> <span>_</span> -&gt; <span>None</span></td>
        </tr>
        <tr>
          <td id="L41" data-line-number="41"></td>
          <td id="LC41">      })</td>
        </tr>
        <tr>
          <td id="L42" data-line-number="42"></td>
          <td id="LC42">
</td>
        </tr>
        <tr>
          <td id="L43" data-line-number="43"></td>
          <td id="LC43">  <span>let</span> <span>grad</span> <span>f</span> <span>x</span> <span>=</span></td>
        </tr>
        <tr>
          <td id="L44" data-line-number="44"></td>
          <td id="LC44">    <span>let</span> x <span>=</span> mk x <span>in</span></td>
        </tr>
        <tr>
          <td id="L45" data-line-number="45"></td>
          <td id="LC45">    run (<span>fun</span> <span>()</span> -&gt; f x);</td>
        </tr>
        <tr>
          <td id="L46" data-line-number="46"></td>
          <td id="LC46">    x.d</td>
        </tr>
        <tr>
          <td id="L47" data-line-number="47"></td>
          <td id="LC47">
</td>
        </tr>
        <tr>
          <td id="L48" data-line-number="48"></td>
          <td id="LC48">  <span>let</span> <span>grad2</span> <span>f</span> (<span>x</span>, <span>y</span>) <span>=</span></td>
        </tr>
        <tr>
          <td id="L49" data-line-number="49"></td>
          <td id="LC49">    <span>let</span> x,y <span>=</span> mk x, mk y <span>in</span></td>
        </tr>
        <tr>
          <td id="L50" data-line-number="50"></td>
          <td id="LC50">    run (<span>fun</span> <span>()</span> -&gt; f (x,y));</td>
        </tr>
        <tr>
          <td id="L51" data-line-number="51"></td>
          <td id="LC51">    x.d, y.d</td>
        </tr>
        <tr>
          <td id="L52" data-line-number="52"></td>
          <td id="LC52">
</td>
        </tr>
        <tr>
          <td id="L53" data-line-number="53"></td>
          <td id="LC53">  <span>let</span> <span>(+.)</span> <span>a</span> <span>b</span> <span>=</span> perform (<span>Add</span>(a,b))</td>
        </tr>
        <tr>
          <td id="L54" data-line-number="54"></td>
          <td id="LC54">  <span>let</span> <span>( *. )</span> <span>a</span> <span>b</span> <span>=</span> perform (<span>Mult</span>(a,b))</td>
        </tr>
        <tr>
          <td id="L55" data-line-number="55"></td>
          <td id="LC55">end;;</td>
        </tr>
        <tr>
          <td id="L56" data-line-number="56"></td>
          <td id="LC56">
</td>
        </tr>
        <tr>
          <td id="L57" data-line-number="57"></td>
          <td id="LC57"><span><span>(*</span> f = x + x^3 =&gt;</span></td>
        </tr>
        <tr>
          <td id="L58" data-line-number="58"></td>
          <td id="LC58"><span>   df/dx = 1 + 3 * x^2 <span>*)</span></span></td>
        </tr>
        <tr>
          <td id="L59" data-line-number="59"></td>
          <td id="LC59"><span>for</span> x <span>=</span> <span>0</span> <span>to</span> <span>10</span> <span>do</span></td>
        </tr>
        <tr>
          <td id="L60" data-line-number="60"></td>
          <td id="LC60">  <span>let</span> x <span>=</span> float_of_int x <span>in</span></td>
        </tr>
        <tr>
          <td id="L61" data-line-number="61"></td>
          <td id="LC61">  <span>assert</span> (<span>F.</span>(grad (<span>fun</span> <span>x</span> -&gt; x <span>+.</span> x <span>*.</span> x <span>*.</span> x) x) <span>=</span></td>
        </tr>
        <tr>
          <td id="L62" data-line-number="62"></td>
          <td id="LC62">            <span>1.0</span> <span>+.</span> <span>3.0</span> <span>*.</span> x <span>*.</span> x)</td>
        </tr>
        <tr>
          <td id="L63" data-line-number="63"></td>
          <td id="LC63"><span>done</span>;;</td>
        </tr>
        <tr>
          <td id="L64" data-line-number="64"></td>
          <td id="LC64">
</td>
        </tr>
        <tr>
          <td id="L65" data-line-number="65"></td>
          <td id="LC65"><span><span>(*</span> f = x^2 + x^3 =&gt;</span></td>
        </tr>
        <tr>
          <td id="L66" data-line-number="66"></td>
          <td id="LC66"><span>   df/dx = 2*x + 3 * x^2 <span>*)</span></span></td>
        </tr>
        <tr>
          <td id="L67" data-line-number="67"></td>
          <td id="LC67"><span>for</span> x <span>=</span> <span>0</span> <span>to</span> <span>10</span> <span>do</span></td>
        </tr>
        <tr>
          <td id="L68" data-line-number="68"></td>
          <td id="LC68">  <span>let</span> x <span>=</span> float_of_int x <span>in</span></td>
        </tr>
        <tr>
          <td id="L69" data-line-number="69"></td>
          <td id="LC69">  <span>assert</span> (<span>F.</span>(grad (<span>fun</span> <span>x</span> -&gt; x <span>*.</span> x <span>+.</span> x <span>*.</span> x <span>*.</span> x) x) <span>=</span></td>
        </tr>
        <tr>
          <td id="L70" data-line-number="70"></td>
          <td id="LC70">            <span>2.0</span> <span>*.</span> x <span>+.</span> <span>3.0</span> <span>*.</span> x <span>*.</span> x)</td>
        </tr>
        <tr>
          <td id="L71" data-line-number="71"></td>
          <td id="LC71"><span>done</span>;;</td>
        </tr>
        <tr>
          <td id="L72" data-line-number="72"></td>
          <td id="LC72">
</td>
        </tr>
        <tr>
          <td id="L73" data-line-number="73"></td>
          <td id="LC73"><span><span>(*</span> f = x^2 * y^4 =&gt;</span></td>
        </tr>
        <tr>
          <td id="L74" data-line-number="74"></td>
          <td id="LC74"><span>   df/dx = 2 * x * y^4</span></td>
        </tr>
        <tr>
          <td id="L75" data-line-number="75"></td>
          <td id="LC75"><span>   df/dy = 4 * x^2 * y^3 <span>*)</span></span></td>
        </tr>
        <tr>
          <td id="L76" data-line-number="76"></td>
          <td id="LC76"><span>for</span> x <span>=</span> <span>0</span> <span>to</span> <span>10</span> <span>do</span></td>
        </tr>
        <tr>
          <td id="L77" data-line-number="77"></td>
          <td id="LC77">  <span>for</span> y <span>=</span> <span>0</span> <span>to</span> <span>10</span> <span>do</span></td>
        </tr>
        <tr>
          <td id="L78" data-line-number="78"></td>
          <td id="LC78">    <span>let</span> x <span>=</span> float_of_int x <span>in</span></td>
        </tr>
        <tr>
          <td id="L79" data-line-number="79"></td>
          <td id="LC79">    <span>let</span> y <span>=</span> float_of_int y <span>in</span></td>
        </tr>
        <tr>
          <td id="L80" data-line-number="80"></td>
          <td id="LC80">    <span>assert</span> (<span>F.</span>(grad2 (<span>fun</span> (<span>x</span>,<span>y</span>) -&gt; x <span>*.</span> x <span>*.</span> y <span>*.</span> y <span>*.</span> y <span>*.</span> y) (x,y)) <span>=</span></td>
        </tr>
        <tr>
          <td id="L81" data-line-number="81"></td>
          <td id="LC81">              (<span>2.0</span> <span>*.</span> x <span>*.</span> y <span>*.</span> y <span>*.</span> y <span>*.</span> y,</td>
        </tr>
        <tr>
          <td id="L82" data-line-number="82"></td>
          <td id="LC82">               <span>4.0</span> <span>*.</span> x <span>*.</span> x <span>*.</span> y <span>*.</span> y <span>*.</span> y))</td>
        </tr>
        <tr>
          <td id="L83" data-line-number="83"></td>
          <td id="LC83">  <span>done</span></td>
        </tr>
        <tr>
          <td id="L84" data-line-number="84"></td>
          <td id="LC84"><span>done</span>;;</td>
        </tr>
  </tbody></div></div>
  </body>
</html>
