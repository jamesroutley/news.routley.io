<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.persistent.info/2023/08/infinite-mac-cd-roms.html">Original</a>
    <h1>Infinite Mac: Disks, CD-ROMs and custom instances</h1>
    
    <div id="readability-page-1" class="page"><article>
<p>Here are a few highlights of what’s been happening with <a href="https://infinitemac.org/">Infinite Mac</a> since <a href="https://blog.persistent.info/2023/03/infinitemac-dot-org.html">my last update</a>.</p>

<h3>Improving Disk Abstractions</h3>

<p>My broad goal this time around was to <a href="https://blog.persistent.info/2023/03/infinitemac-dot-org.html#:~:text=Though%20making%20it%20even%20easier%20to%20load%20software%20(even%20if%20I%20don%E2%80%99t%20include%20it%20directly)%20would%20be%20even%20better%20%E2%80%94%20I%20recently%20came%20across%20Discmaster%20and%20something%20that%20lets%20you%20load%20anything%20from%20the%20Internet%20Archive%20with%20one%20click%20would%20be%20great.">make it easier to load external software</a>. To lay the groundwork for this, I first needed to improve some of the disk abstractions that the project used. One of the things that makes the emulated Macs relatively fast to boot is that they stream in their disk images, since much of it is not needed at startup (e.g. <a href="https://macos9.app/">Mac OS 9</a> only reads 75MB out of a 150MB install). I had implemented this streamed/chunk approach<a href="https://github.com/mihaip/infinite-mac/commit/2992609ac3e86f595796759fb8aec6c1c354b298"> pretty early in the project</a>, when I understood the emulator internals (and Emscripten) less well. It worked by monkey-patching the read/write operations in Emscripten’s <a href="https://emscripten.org/docs/api_reference/Filesystem-API.html#memfs">MEMFS filesystem</a> (the default when doing an Emscripten build).</p>

<p>Besides being somewhat hacky, this had the downside of requiring that all mounted disks be loaded into memory as <code>ArrayBuffer</code>s (hence the name MEMFS). While the system software disks are relatively small, the Infinite HD disk with pre-loaded software is 1 GB, thus this was leading to significant memory use. I had added some <a href="https://github.com/mihaip/infinite-mac/commit/89cb33397881391d5ca0f31552cdd19ae97d24f8">basic instrumentation of emulator errors</a>, and running out of memory was surprisingly common (6.5% of emulator starts), presumably due to low-memory iOS devices or 32-bit Chrome OS devices. If I was going to add the ability to load additional (CD-ROM-sized) disk images, the memory use would increase even more.</p>

<p>I briefly explored Emscripten’s <a href="https://emscripten.org/docs/api_reference/Filesystem-API.html">other file system options</a>, but they all didn’t seem like quite the right fit. Fundamentally the issue was that all disk access was going through too many layers of abstraction, and the intent was lost. The emulator was operating against the POSIX file system API (<code>open</code>, <code>read</code>, on a file descriptor etc.) and by the time Infinite Mac’s code ran, it required extra bookkeeping to know which file was being requested (it could be a non-disk file), and the choice for the backing store for that file (as an <code>ArrayBuffer</code>) had already been made by Emscripten.</p>

<table>
<tbody><tr>
<td>
<img src="https://persistent.info/images/infinite-mac-disk-abstractions-before.png" width="288" height="320" alt="5 layers of abstraction"/></td>
<td>
<img src="https://persistent.info/images/infinite-mac-disk-abstractions-after.png" width="288" height="192" alt="3 layers of abstraction"/></td>
</tr>
</tbody></table>

<p>While many problems in computer science can be <a href="https://en.wikipedia.org/wiki/Fundamental_theorem_of_software_engineering">solved with a layer of indirection</a>, in this case it was a matter of removing one or two. The emulators are cross-platform systems themselves, and they have a way of swapping out the POSIX file backing for disks with others for other platforms. By adding more direct “JS” disk implementations in both <a href="https://github.com/mihaip/macemu/commit/8561af3f38af97892878511a9ef39b947a1debd3">Basilisk II/SheepShaver</a> (hereafter “Basilisk”) and <a href="https://github.com/mihaip/minivmac/commit/e351655612ee4b3d697b213765396b91f0bd9c7c">Mini vMac</a> and then implementing the JS APIs <a href="https://github.com/mihaip/infinite-mac/commit/9e361b9679e63b5c30f9bd61d2da983b69638dc3">on the Infinite Mac side</a>, the entire POSIX and Emscripten layers could be bypassed. We now only need to use as much RAM as the number of 256K chunks that have been accessed (and there is enough flexibility in the system that a LRU system could also be implemented to keep the working set fixed in size). After this change the out-of-emory error rate went to 0.3%.</p>

<p>The next thing to tackle was avoiding the need to restart the emulators when mounting additional disks. This only affected the Basilisk version, since Mini vMac already had built-in support for <a href="https://github.com/mihaip/infinite-mac/commit/6cc34a97dc87a82ee2a0c39059f240530975f40c">mounting disks on demand</a>. I assumed that this was not a fundamental limitation, all the emulators supporting mounting (real) removal media on demand already. It turned out to be <a href="https://github.com/mihaip/macemu/commit/91f06fdea8d2cc2e921ba9c482a765c70da94e4d">a missing feature in Basilisk’s disk abstraction</a>, and once I added that it was possible to <a href="https://github.com/mihaip/infinite-mac/commit/401ec13fafe35372c674a38a2e16e873ba53c528">mount disks immediately</a> there too.</p>

<h3>CD-ROM Library</h3>

<p>With this in place, I was able to start working on the <a href="https://github.com/mihaip/infinite-mac/issues/166">CD-ROM “library” feature</a> I had envisioned. This was based on the observation that the <a href="https://archive.org/">Internet Archive</a> has a large collection of disk images in the <code>.iso</code> format, include <a href="https://archive.org/details/cdromsoftware?tab=collection&amp;query=mac">many</a> <a href="https://archive.org/details/cdromsoftware?tab=collection&amp;query=macintosh">for</a> <a href="https://archive.org/details/cdromimages?tab=collection&amp;query=mac">the</a> <a href="https://archive.org/details/cdromimages?tab=collection&amp;query=macintosh">Mac</a>. Furthermore, the files are <a href="https://blog.archive.org/developers/">accessible</a> without any kind of authentication, and support <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests">HTTP range requests</a>. This meant that it’s possible to take the same chunked/streaming approach I was using for my disk images and use it for these files without any kind of pre-processing.</p>

<p>I do these range requests in <a href="https://github.com/mihaip/infinite-mac/blob/main/workers-site/cd-rom.ts">simple handler</a> in a Cloudflare Worker, mostly so that they end up being same-origin requests. I later found that there is a <a href="https://git.archive.org/www/dweb-cors">CORS gateway</a> for the Internet Archive, but it appears to be a secondary service, and doing the fetching myself means that I can benefit from Cloudlare’s edge caching. However, switching to doing direct client-side loading is something to consider if the bandwidth costs become prohibitive (though for now <a href="https://github.com/sponsors/mihaip">donations</a> are more than covering the costs).</p>

<p>One gotcha that I ran into this that some disk images <a href="https://ia802305.us.archive.org/view_archive.php?archive=/13/items/the-manhole/Manhole%2C%20The%20%28USA%29.7z">are</a> <a href="https://ia801705.us.archive.org/view_archive.php?archive=/27/items/bungiemarathontrilogy/CD%20Images/Marathon%20Trilogy.zip">compressed</a>. While there ways to <a href="https://github.com/sozip/sozip-spec">make .zip files seekable</a>, they require re-compressing, which would defeat the purpose of making this be a minimal setup/low overhead feature. For now I’ve chosen to skip over compressed files (or support other disk image formats that support compression, such as .dmg).</p>

<p>Continuing with the project’s <a href="https://blog.persistent.info/2023/03/infinitemac-dot-org.html#:~:text=I%20used%20the,images)%20becomes%20overwhelming.">curation philosophy</a>, I wanted to have a nice browsable UI of CD-ROMs, ready to be mounted in the emulated Mac. I ended with a <a href="https://github.com/mihaip/infinite-mac/tree/main/CD-ROMs">collection of metadata files</a> that specify disk image URLs and cover art that is processed by <a href="https://github.com/mihaip/infinite-mac/blob/main/scripts/import-cd-roms.py">a simple importing script</a>. The generated catalog is rendered in a <a href="https://web.archive.org/web/20070406172644/http://arstechnica.com/paedia/f/finder/images/popup-folders.jpg">pop-up folder</a>-inspired UI:</p>

<p><img alt="Infinite Mac with CD-ROM library pop-up window open" height="843" src="https://persistent.info/images/infinite-mac-cdrom-library.png" width="1037"/></p>

<p>I added <a href="https://github.com/mihaip/infinite-mac/blob/main/CD-ROMs/Apple%20Developer%20CDs/1993-01%20-%20The%20Postman%20Always%20Clicks%20Twice.json">some</a> <a href="https://github.com/mihaip/infinite-mac/blob/main/CD-ROMs/Compilations/Power%20Computing%EF%B9%95%20The%20Disc.json">of</a> <a href="https://github.com/mihaip/infinite-mac/blob/main/CD-ROMs/Reference/Grolier%20Multimedia%20Encyclopedia%20(1995).json">my</a> <a href="https://github.com/mihaip/infinite-mac/blob/main/CD-ROMs/Games/Myth%EF%B9%95%20The%20Fallen%20Lords.json">favorites</a> and <a href="https://hachyderm.io/@mihaip/110529659997491091">got a few more suggestions</a> via Mastodon. Around this same time <a href="http://cdrom.ca/games/2023/06/29/first-cdrom-games.html">a pretty throughly researched article</a> on the first CD-ROMs appeared, and I hoped to include the ones referenced too. However, most of the early CD-ROMs were actually just taking advantage of <a href="http://cdrom.ca/games/2023/06/29/first-cdrom-games.html#:~:text=The%20Manhole%20was,floppy%20game%20first.">the ability to</a> <a href="http://cdrom.ca/games/2023/06/29/first-cdrom-games.html#:~:text=The%20Voyager%20Company,using%20Apple%27s%20Hypercard">include audio CD tracks,</a> which is something that I have not gotten to work yet, so I was not able to add them.</p>

<p>I did also add the ability to mount arbitrary CD-ROMs via a dialog, so if you come across something on the Internet Archive that catches your eye, you can give it a try (you can even <a href="https://github.com/mihaip/infinite-mac/commit/a372439a15914f55ed77504c27c00e59bcb8701c">drag-and-drop the link</a> from another tab). I also made the Infinite HD disk image 2GB (i.e. with 1GB of free space), so that it’s available as a destination for any software that requires installation to a local hard drive. This is another way in which the change to not require disk images to be loaded into RAM paid off.</p>

<h3>Custom Instances</h3>

<p>Around the time that I was wrapping up CD-ROM support, I came across the recently-launched <a href="https://classicmacdemos.com/">Classic Macintosh Game Demos</a> site. It’s a “kindred spirit”, in that it’s trying to make things easily accessible and has a curatorial bent. <a href="https://jcgraybill.github.io/">Jules Graybill</a> (the author) was sourcing the game demos from CD-ROMs that came with magazines, images of which were also uploaded to the Internet Archive. I added the ability to specify a CD-ROM URL <a href="https://github.com/mihaip/infinite-mac/commit/656d6825b34eab0b046d59ed36279d5744bd2ba3">via a query parameter</a> and <a href="https://hachyderm.io/@mihaip/110642977729716394">reached out to him</a> to see if he wanted to make use of it (to allow the games to be played in-browser). He quickly <a href="https://hachyderm.io/@jcgraybill@oldbytes.space/110674444983705093">implemented it</a>, which is a great example of the flexibility of web-based projects — they can be made to work together (some might even say <a href="https://en.wikipedia.org/wiki/Hyperlink">“linked”</a> or <a href="https://en.wikipedia.org/wiki/Mashup_(web_application_hybrid)">“mashed up”</a>) with minimal coordination.</p>

<p>Shortly after, Jules <a href="https://github.com/mihaip/infinite-mac/issues/193">filed an issue</a> asking about an additional system extension he needed included on the system disk. Extrapolating from the ability to load CD-ROMs from URLs, I wondered if the same could be done for the system disk, so that he could provide his own image with exactly the extensions that he needed. And while we’re at it, why not allow the type of machine to be chosen via a URL parameter too, and control over other Infinite Mac features (<a href="https://blog.persistent.info/2022/07/infinite-mac-networking.html">AppleTalk support</a> or the extra Infinite HD disk). Getting perhaps a bit carried away, I ended up building a <a href="https://www.folklore.org/StoryView.py?story=Calculator_Construction_Set.txt">Calculator Construction Set</a> equivalent for emulated Macs, available at <a href="https://infinitemac.org/run">infinitemac.org/run</a>.</p>

<p><img alt="Custom configuration dialog, matching a System 7 startup disk" height="350" src="https://persistent.info/images/infinite-mac-custom-classic.png" width="636"/></p>

<p><img alt="Custom configuration dialog, matching a Mac OS 8.1 startup disk" height="350" src="https://persistent.info/images/infinite-mac-custom-platinum.png" width="636"/></p>

<p>To reduce the cognitive dissonance (and to have a bit of fun), I made the UI resemble the look-and-feel of the OS that is being booted. I had already added some classic- and Platinum-style controls for other bits of configuration UI, but this dialog also required implementing popup menus and checkboxes (the Appearance Sample app from the <a href="https://macintoshgarden.org/apps/appearance-manager-mac-os-7x">Appearance SDK </a>was invaluable in getting a view of all “modern” Mac OS controls). There’s still a bit of a an <a href="https://en.wikipedia.org/wiki/Uncanny_valley">uncanny valley</a> feel, perhaps due to fonts not being the same and modern screens having higher logical DPI (thus everything feeling smaller than it used to), but hopefully it will get closer over time.</p>

<p>You can also use this customization mode to have “Frankenstein” instances. For example, you can load the <a href="https://infinitemac.org/run?disk=System+7.1&amp;disk=System+1.0&amp;infinite_hd=true&amp;machine=Quadra+650">System 1.0 image while booting with System 7</a>, allowing you to use a modern version of ResEdit to poke around the initial versions of the System and Finder. Or you can use this with any system disks that you may happen to come across (e.g. if you wanted to see what the <a href="https://infinitemac.org/run?machine=Quadra%20650&amp;cdrom=https%3A%2F%2Farchive.org%2Fdownload%2Fslo-75_202301%2FSLO75.img">Slovenian version of System 7.5</a> looked like).</p>

<h3>Odds and Ends</h3>

<p>While the goal of the site is to make as many versions of classic Mac OS available in the browser, I realized some time after launch that 40+ releases is a lot to scroll through, and that more notable ones might get lost among all of the point releases. I therefore <a href="https://github.com/mihaip/infinite-mac/commit/2af38be9e54c8e565d1d582cae47a389dcbcfd39">added a simple filter toggle</a> to make the list that’s initially shown more manageable.</p>

<p>A longstanding issue was that dissolve animations in HyperCard would <a href="https://github.com/mihaip/infinite-mac/issues/42">run very slowly</a>, something that <a href="https://github.com/kanjitalk755/macemu/issues/107">affected</a> the native build of Basilisk II too. It turned out to be due to a missing implementation of high-resolution timers, which was <a href="https://github.com/kanjitalk755/macemu/commit/1199f8115e3e8569a7551126f51182183cea5a75">recently fixed</a> on the native side. While simply updating <a href="https://github.com/mihaip/macemu">my Basilisk II fork</a> did not get the fix for free, I did now have enough clues to implement <a href="https://github.com/mihaip/macemu/commit/c9b422345112d01b2f221d452cef3cf46d676a45">my own version of it</a>.</p>

<p>There was the usual round of upgrades for the software stack: a new way to <a href="https://github.com/mihaip/infinite-mac/commit/dc4050150115cc7c6c8f65e20ae832ad18bf03a1">install Emscripten</a>, <a href="https://github.com/mihaip/infinite-mac/commit/b221259595d323d2c45cd2175fdc7ce9287c3097">transitioning</a> from create-react-app to Vite (that one was a <a href="https://github.com/mihaip/macemu/commit/49787f862b1941a32c0a80077e1ecededdce5b06">yak</a> <a href="https://github.com/mihaip/minivmac/commit/804e16bf3432579415537cd1bf1c05fa27d59b66">shave</a>), and switching to the latest version of <a href="https://github.com/mihaip/infinite-mac/commit/9f798a758b571ba6076acea2f1409302debde3ee">TypeScript</a>, <a href="https://github.com/mihaip/infinite-mac/commit/feb2371237913f02286bfab088cfd4277513a28e">React</a>, and other <a href="https://github.com/mihaip/infinite-mac/commit/8a5b3b9b841998e11215d8bbfa623de9acaa426f">dependencies</a>.  Though site performance hasn’t really been an issue, the switch to Vite made the initial bundle size more visible, so I spent a bit of time adding <a href="https://github.com/mihaip/infinite-mac/commit/9eb9fc6438332a73506563b76934fef413047afc">moving some things to dynamic imports</a> and some <a href="https://github.com/mihaip/infinite-mac/commit/a99e9cf618e7b5632117f59b1875be9f5519aea0">preloading</a> to pick up some easy wins.</p>

<p>I haven’t entirely decided what I’m going to focus on next, but I’m leaning towards improving the ability to persist changes to disks — it’s a shame to spend time installing software from CD-ROMs and then lose it all when closing the tab. The improved file system abstractions should make it easier to implement some of <a href="https://github.com/mihaip/infinite-mac/issues/152">my</a> <a href="https://github.com/mihaip/infinite-mac/issues/164">ideas</a> <a href="https://github.com/mihaip/infinite-mac/issues/182">here</a>.</p>
</article></div>
  </body>
</html>
