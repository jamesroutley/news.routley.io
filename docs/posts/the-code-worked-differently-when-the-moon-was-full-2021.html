<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.hanselman.com/blog/the-code-worked-differently-when-the-moon-was-full">Original</a>
    <h1>The code worked differently when the moon was full (2021)</h1>
    
    <div id="readability-page-1" class="page"><section>
        <section>
            
            <p><a href="https://unsplash.com/photos/H3Au9ZDS0d8"><img title="Full Moon" alt="Full Moon" src="https://hanselmanblogcontent.azureedge.net/Windows-Live-Writer/f7e2d145afc2_8BDC/fullmoon_3.jpg" width="200" height="316"/></a></p> <p>I love a good bug, especially ones that are initially hard to explain but then turn into forehead slapping moments - of course!</p> <p>There&#39;s <a href="https://github.com/dotnet/runtime/issues/51935">a bug over on Github called Hysteresis effect on threadpool hill-climbing</a> that is a super interesting read.</p> <p>Hill climbing is an algorithmic technique when you have a problem (a hill) and then you improve and improve (climb) until you have reached some maximum acceptable solution (reach the top). </p> <p>SÃ©bastien, the OP of the bug, says there&#39;s a &#34;Hysteresis effect&#34; on the threadpool. &#34;Hysteresis is the dependence of the state of a system on its history.&#34; Something weird is happening now because something happened before...but what was it?</p> <p>Sawtooth up and down graphs aren&#39;t THAT interesting...but look at the x-axis. This isn&#39;t showing minute by minute or even millisecond by millisecond ups and downs like you may have seen before. <strong>This x-axis uses months as its unit of measure. </strong>Read that again and drink it in.</p> <p><img title="A sawtooth graph going up and down month to month" alt="A sawtooth graph going up and down month to month" src="https://hanselmanblogcontent.azureedge.net/Windows-Live-Writer/f7e2d145afc2_8BDC/weirdgraph_25033fe3-5884-43c4-afd2-1e782d46c21b.jpg" width="400" height="261"/></p> <p>Things are cool in February until they are bad for weeks and then cool in March and it moves along a cycle. Not strictly the cycle of the moon but close.</p> <p>He&#39;s seeing the number of cores being used changing from month to month when using PortableThreadPool</p> <blockquote> <p>We have noticed a periodic pattern on the threadpool hill-climbing logic, which uses either <code>n-cores</code> or <code>n-cores + 20</code> with an hysteresis effect that switches every 3-4 weeks.</p></blockquote> <p>Did you know (I know because I&#39;m old) that Windows 95, for a time, was unable to run longer than 49.7 days of runtime? If you ran it that long it would eventually crash! That&#39;s because there&#39;s 86M ms in a day, i.e. 1000 * 60 * 60 * 24 = 86,400,000 and 32 bits is 4,294,967,296 so 4,294,967,296 / 86,400,000 = 49.7102696 days!</p> <p>Kevin in the Github issues notes this as well:</p> <blockquote> <p>The whole period of square wave sounds an awful lot like it is around 49.7 days. That is how long it takes <code>GetTickCount()</code> to wrap around. On POSIX platforms the platform abstraction layer implements this, and the value returned for that is based not on uptime but on wall clock time, which matches with all machines changing on the same day.</p></blockquote> <p>This 49.7 days number is well known as it&#39;s how long it take before GetTickCount() overflows/wraps. <a href="https://github.com/dotnet/runtime/issues/51935#issuecomment-832140430">Kevin goes on</a> to actually give the changeover dates which correspond to the graph!</p> <ul> <li>Thu Jan 14 2021  </li><li>Sun Feb 07 2021  </li><li>Thu Mar 04 2021  </li><li>Mon Mar 29 2021  </li><li>Fri Apr 23 2021</li></ul> <p>He then finds the code in PortableThreadPool.cs that explains the issue:</p><pre>private bool ShouldAdjustMaxWorkersActive(int currentTimeMs) </pre>
<p>He says, and this is all Kevin:</p>
<p>currentTimeMs is <code>Environment.TickCount</code>, which in this case happens to be negative. 
</p><p>The if clause controls if the hill climbing is even run. 
</p><p><code>_separated.priorCompletedWorkRequestsTime</code> and <code>_separated.nextCompletedWorkRequestsTime</code> start out as zero on process start, and only get updated if the hill climbing code is run. 
</p><p>Therefore, <code>requiredInterval = 0 - 0</code> and <code>elapsedInterval = negativeNumber - 0</code>. This causes the if statement to become</p><p>The easy fix here is probably to use unsigned arithmetic, but alternatively having the two fields get initialized to Environment.TickCount probably also work 
</p><p>Back to me. Fabulous. The <a href="https://github.com/dotnet/runtime/pull/52397/commits/7e8091bfe6c815fb9cdb6651c5c35a93f06a5836">fix</a> is to cast the results to unsigned ints via (uint). </p>
<p>Before:</p><pre>int requiredInterval = _separated.nextCompletedWorkRequestsTime - priorTime;</pre>
<p>After:</p><pre>uint requiredInterval = (uint)(_separated.nextCompletedWorkRequestsTime - priorTime);</pre>
<p>What an interesting and insidious bug! Bugs based on a time calculations can often show themselves later when view through a longer lens and scope of time...sometimes WAY longer than you&#39;d expect.</p>
<hr/>

<p><strong>Sponsor:</strong> YugabyteDB is a distributed SQL database designed for resilience and scale. It is 100% open source, PostgreSQL-compatible, enterprise-grade, and runs across all clouds. <a href="https://hnsl.mn/3ujMCdL">Sign up and get a free t-shirt.</a></p>



            <div>
                <div>
                    <h4>About Scott</h4>
                    <div>
                        <p>Scott Hanselman is a former professor, former Chief Architect in finance, now speaker, consultant, father, diabetic, and Microsoft employee. He is a failed stand-up comic, a cornrower, and a book author.</p>
                        <p><a href="https://facebook.com/shanselman"><img src="https://images.hanselman.com/main/icon-fb.png" alt="facebook"/></a>
                        <a href="https://twitter.com/shanselman"><img src="https://images.hanselman.com/main/icon-twitter.png" alt="twitter"/></a>
                        <a href="http://feeds.hanselman.com/ScottHanselman"><img src="https://images.hanselman.com/main/icon-rss.png" alt="subscribe"/></a></p></div>
                </div>

                
            </div>

            


            

            
        </section>
            











































            

    </section></div>
  </body>
</html>
