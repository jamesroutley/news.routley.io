<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://artemis.sh/2022/03/14/propolis-oxide-at-home-pt1.html">Original</a>
    <h1>Oxide at Home: Propolis Says Hello</h1>
    
    <div id="readability-page-1" class="page"><article>
            <header>
                
                <time datetime="2022-03-14 00:00:00 +0000">2022-03-14</time>
            </header>
            <p>So <a href="https://oxide.computer">Oxide</a> is making some cool stuff huh? Big metal boxes with lots of computer in them. Servers as they should be! Too bad I can’t afford to buy one for myself… but wait, <a href="https://github.com/oxidecomputer">they’re open-sourcing the software they’re writing to do it</a>. Mom said we can have Oxide at Home!</p>

<p>Oxide at Home:</p>

<p><img alt="absolutely awful arrangement of computer hardware in an ATX case" src="https://www.evalapply.org/assets/images/2022-03-14-propolis-oxide-at-home-pt1/oxide-at-home.jpg"/></p>

<h2 id="hardware-with-the-software-haphazardly-jammed-in">Hardware, with the software haphazardly jammed in</h2>

<p>Let’s be clear, I’m not aiming for elegance here. I’m not aiming for enterprise grade either. I want something dirty, something hacky, something that makes you go “what the fuck, why, no???????”.</p>

<p>To that end I’m choosing right at the start to make my life more interesting. Oxide’s software is mostly written for <a href="https://illumos.org/">illumos</a>, a direct descendant of OpenSolaris. There’s a handful of illumos distributions out there, but Oxide develops primarily for their distribution called Helios. Their <a href="https://github.com/oxidecomputer/omicron">Omicron README</a> (no relation) also mentions <a href="https://omnios.org/">OmniOS</a>. Naturally I’m going to use neither of those and make it work on <a href="https://www.openindiana.org/">OpenIndiana</a> instead.</p>

<p>You see, I can’t get a copy of Helios right now unless I commit corporate espionage, and OmniOS describes itself as “enterprise”. As I’ve already stated, I am not an enterprise, nor do I plan on becoming one unless Jean-Luc Picard starts taking estrogen and wants to be my captain. <a href="http://www.tribblix.org/">Tribblix</a> was also in the running but I couldn’t get the installer to work, so I landed on OpenIndiana.</p>

<p>Anyways, everything I do, I’ll do with the intention of getting it <em>working</em>, not making it <em>good</em>. Expect awful things along the way.</p>

<h2 id="but-first-we-need-to-summon-ferris">But first, we need to summon Ferris</h2>

<p>Oxide, as their name implies, likes to write software in rust. Some of that software wants to use a nightly rust too. Might help to have <code>rustup</code> huh? Well, there’s a couple problems. First, rustup’s install script is not actually as universal as they think it is:</p>

<div><div><pre><code>vi@box:~$ curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh
sh[455]: local: not found [No such file or directory]
sh[456]: local: not found [No such file or directory]
sh[457]: local: not found [No such file or directory]
sh[458]: local: not found [No such file or directory]
sh[202]: local: not found [No such file or directory]
sh[62]: local: not found [No such file or directory]
sh[65]: local: not found [No such file or directory]
sh: line 72: _ext: parameter not set
</code></pre></div></div>

<p>Fine, whatever, let’s pipe it to <code>bash</code> then,</p>

<div><div><pre><code>vi@box:~$ curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | bash
ld.so.1: rustup-init: fatal: libgcc_s.so.1: open failed: No such file or directory
</code></pre></div></div>

<p>Excuse me the fuck? I uh,</p>

<div><div><pre><code>vi@box:~$ find / -name &#39;libgcc_s.so.1&#39;
/usr/sfw/lib/libgcc_s.so.1
/usr/sfw/lib/amd64/libgcc_s.so.1
/usr/pkgsrc/lang/rust/work/rust-1.55.0-x86_64-unknown-illumos/lib/pkgsrc/libgcc_s.so.1
/usr/gcc/7/lib/libgcc_s.so.1
/usr/gcc/7/lib/amd64/libgcc_s.so.1
/usr/gcc/11/lib/amd64/libgcc_s.so.1
/usr/gcc/11/lib/libgcc_s.so.1
/usr/gcc/3.4/lib/libgcc_s.so.1
/usr/gcc/3.4/lib/amd64/libgcc_s.so.1
/usr/gcc/10/lib/libgcc_s.so.1
/usr/gcc/10/lib/amd64/libgcc_s.so.1
</code></pre></div></div>

<p>What do you want from me, rustup? Well you see, it’s very simple:</p>

<div><div><pre><code>vi@box:~$ pkg search file:basename:libgcc_s.so.1
INDEX      ACTION VALUE                                 PACKAGE
basename   file   usr/gcc/8/lib/amd64/libgcc_s.so.1     pkg:/system/library/gcc-8-runtime@8.4.0-2020.0.1.2
basename   file   usr/gcc/8/lib/libgcc_s.so.1           pkg:/system/library/gcc-8-runtime@8.4.0-2020.0.1.2
[... a bunch of other gcc versions skipped ...]
basename   file   usr/lib/amd64/libgcc_s.so.1           pkg:/system/library/gcc-4-runtime@4.9.4-2021.0.0.8
basename   file   usr/lib/libgcc_s.so.1                 pkg:/system/library/gcc-4-runtime@4.9.4-2021.0.0.8
</code></pre></div></div>

<p>We need <code>gcc-4-runtime</code>! Obviously (/s). Oh we also need <code>g++-4-runtime</code> or we get another missing shared library but I’ll spare you the details.</p>

<div><div><pre><code>vi@box:~$ sudo pkg install gcc-4-runtime g++-4-runtime
vi@box:~$ curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | bash
info: downloading installer

Welcome to Rust!
</code></pre></div></div>

<p>FINALLY. Ok.</p>

<p><img alt="i have the cargo" src="https://www.evalapply.org/assets/images/2022-03-14-propolis-oxide-at-home-pt1/ihavethecargo.jpg"/></p>

<h2 id="whats-a-propolis">What’s a Propolis?</h2>

<p>Oxide is making racks of lots of computer. My understanding is that they have a control plane that talks to all the sleds (the blades of computer). Each sled runs a sled agent, and one thing that sled agent can do is start virtual machines. This is where Propolis comes in, as a userspace frontend to the <a href="https://en.wikipedia.org/wiki/Bhyve">bhyve</a> hypervisor.</p>

<p>This is a great place for us to start because Propolis doesn’t depend on any other services to run. It just sits there and exposes an API to make VMs.</p>

<p>Let’s build it!</p>

<div><div><pre><code>vi@box:~/oxide-at-home$ git clone https://github.com/oxidecomputer/propolis
vi@box:~/oxide-at-home$ cd propolis
vi@box:~/oxide-at-home/propolis$ cargo build
</code></pre></div></div>

<p>This will make <code>target/debug/propolis-cli</code> and <code>target/debug/propolis-server</code>. I copied those over to <code>/usr/local/bin</code> and moved on with my life, just get them on your <code>PATH</code> somehow if you’re following along at home.</p>

<h2 id="configuring-propolis">Configuring Propolis</h2>

<p>Anyway, how do we use this? First we need a config file, and the README provides this helpful example:</p>

<div><div><pre><code>bootrom = &#34;/path/to/bootrom/OVMF_CODE.fd&#34;

[block_dev.alpine_iso]
type = &#34;file&#34;
path = &#34;/path/to/alpine-extended-3.12.0-x86_64.iso&#34;

[dev.block0]
driver = &#34;pci-virtio-block&#34;
block_dev = &#34;alpine_iso&#34;
pci-path = &#34;0.4.0&#34;

[dev.net0]
driver = &#34;pci-virtio-viona&#34;
vnic = &#34;vnic_name&#34;
pci-path = &#34;0.5.0&#34;
</code></pre></div></div>

<p>First question - what the hell is <code>OVMF_CODE.fd</code>? I did a <code>pkg search</code> for it and not a single package has it, but it’s the bootrom used when the VM starts up. Comes from a project called EDK2 I guess? I’m fuzzy on the details, but I followed a trail from <a href="https://archlinux.org/packages/extra/any/edk2-ovmf/">the arch linux edk2-ovmf package</a> to <a href="https://github.com/tianocore/tianocore.github.io/wiki/OVMF">this github wiki</a> and eventually <a href="https://www.kraxel.org/repos/jenkins/edk2/">this jenkins build artifact folder on the personal website of a qemu dev</a>.</p>

<p>I grabbed <a href="https://www.kraxel.org/repos/jenkins/edk2/edk2.git-ovmf-x64-0-20211216.137.g2b175eeb6a.noarch.rpm">the x64 rpm</a>, extracted it a few times with 7zip, and eventually got my hands on <code>OVMF_CODE-pure-efi.fd</code>. This ended up working out so, cool I guess.</p>

<p>Next, I downloaded a copy of the alpine-extended iso for 3.15 since that’s the latest right now.</p>

<p>Finally, you see that <code>vnic =</code> line? We need to give it a vnic-type network interface. The README actually explains the correct way to do this but I didn’t bother to read that. I just read the man page and threw stuff at the terminal until it did something useful.</p>

<div><div><pre><code>vi@box:~/oxide-at-home$ dladm show-link
LINK        CLASS     MTU    STATE    BRIDGE     OVER
e1000g1     phys      1500   down     --         --
e1000g0     phys      1500   up       --         --
vi@box:~/oxide-at-home/propolis$ sudo dladm create-vnic -l e1000g0 propolis
dladm: invalid link name &#39;propolis&#39;
vi@box:~/oxide-at-home/propolis$ sudo dladm create-vnic -l e1000g0 e1000g9
vi@box:~/oxide-at-home$ dladm show-link
LINK        CLASS     MTU    STATE    BRIDGE     OVER
e1000g1     phys      1500   down     --         --
e1000g0     phys      1500   up       --         --
e1000g9     vnic      1500   up       --         e1000g0
</code></pre></div></div>

<p>So this totally breaks naming conventions but I couldn’t figure out what constitutes a “valid link name” from the man page. If I had actually read the README more I would have seen the suggestion of <code>vnic_prop0</code>. You should use that instead! But my config will use my best effort shitpost name instead, since that’s what really happened.</p>

<p>With all that done, my final config file looks a bit like this:</p>

<div><div><pre><code>bootrom = &#34;/export/home/vi/oxide-at-home/edk2/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd&#34;

[block_dev.alpine_iso]
type = &#34;file&#34;
path = &#34;/export/home/vi/oxide-at-home/run/alpine-extended-3.15.0-x86_64.iso&#34;

[dev.block0]
driver = &#34;pci-virtio-block&#34;
block_dev = &#34;alpine_iso&#34;
pci-path = &#34;0.4.0&#34;

[dev.net0]
driver = &#34;pci-virtio-viona&#34;
vnic = &#34;e1000g9&#34;
pci-path = &#34;0.5.0&#34;
</code></pre></div></div>

<h2 id="using-propolis">Using Propolis</h2>

<p>With a config file that looked good and all the hubris of a university student on orientation day I started the propolis server.</p>

<div><div><pre><code>vi@box:~/oxide-at-home/run$ sudo propolis-server run propolis.toml 127.0.0.1:12400
</code></pre></div></div>

<p>In another terminal I told propolis to make a VM.</p>

<div><div><pre><code>propolis-cli -s 127.0.0.1 new cirno -m 1024 -c 1
</code></pre></div></div>

<p>Peeking over at the propolis logs, I saw this:</p>

<div><div><pre><code>Mar 13 22:36:20.531 INFO Starting server...
Mar 13 22:36:56.204 INFO accepted connection, remote_addr: 127.0.0.1:46363, local_addr: 127.0.0.1:12400
Mar 13 22:36:56.210 INFO request completed, error_message_external: Internal Server Error, error_message_internal: Cannot build instance: No such file or directory (os error 2), response_code: 500, uri: /instances/3915cdd5-3998-4f42-b728-0f8b594afae0, method: PUT, req_id: 0535a501-4467-4f4d-8da5-029e5ed26a20, remote_addr: 127.0.0.1:46363, local_addr: 127.0.0.1:12400
</code></pre></div></div>

<p>What do you MEAN “No such file or directory”?????</p>

<p><img alt="dtrace pony" src="https://www.evalapply.org/assets/images/2022-03-14-propolis-oxide-at-home-pt1/dtracepony-120.png"/></p>

<p>I tried poking at the code but that went nowhere fast. My usual debugging strategy here is to use <code>strace</code> but we’re in illumos land so we need to use <code>dtrace</code> instead, which is like if someone (Bryan Cantrill) decided <code>strace</code> needed <code>awk</code> built in. Now, I’m usually content to just pipe the whole firehose of <code>strace</code> into <code>awk</code> and filter from there but <code>dtrace</code> is actually pretty neat, if a bit confusing at first. And it’s got a pony. Does <code>strace</code> have a pony? I don’t think so.</p>

<p>I wanted to see all <code>openat</code> invocations, so I grabbed the probe id.</p>

<div><div><pre><code>vi@box:~/oxide-at-home/run$ sudo dtrace -l | grep openat
22431    fbt    genunix    openat entry
22432    fbt    genunix    openat return
</code></pre></div></div>

<p>Then I ran propolis-server with dtrace and tried to make another VM.</p>

<div><div><pre><code>vi@box:~/oxide-at-home/run$ sudo dtrace -i &#39;22431 { printf(&#34;%s&#34;, copyinstr(arg1)) }&#39; -c &#39;propolis-server run /export/home/vi/oxide-at-home/run/propolis.toml 127.0.0.1:12400&#39; 2&gt;&amp;1 | grep -v -e &#39;/proc&#39; -e &#39;/etc/ttysrch&#39; -e /var/adm/utmpx -e &#39;/dev/pts/3&#39;
dtrace: description &#39;22431 &#39; matched 1 probe
Mar 13 23:15:02.407 INFO Starting server...
Mar 13 23:15:04.980 INFO accepted connection, remote_addr: 127.0.0.1:40237, local_addr: 127.0.0.1:12400
Mar 13 23:15:04.983 INFO request completed, error_message_external: Internal Server Error, error_message_internal: Cannot build instance: No such file or directory (os error 2), response_code: 500, uri: /instances/b745d636-c8b6-46e5-bb08-839af892b702, method: PUT, req_id: 38dc08e3-e2d5-4561-a328-f48984011a8f, remote_addr: 127.0.0.1:40237, local_addr: 127.0.0.1:12400
 13  22431                     openat:entry /var/ld/64/ld.config
 13  22431                     openat:entry /usr/lib/64/libsqlite3.so.0
 [... snip bunch of random dlls ...]
 13  22431                     openat:entry /etc/certs/ca-certificates.crt
  4  22431                     openat:entry /dev/vmmctl
</code></pre></div></div>

<p>Hmm what’s <code>/dev/vmmctl</code>? Ha. haha. Remember how I said Propolis is a frontend for bhyve? That’s the bhyve control device. Does it exist?</p>

<div><div><pre><code>vi@box:~/oxide-at-home/run$ ls /dev/vmmctl
/dev/vmmctl: No such file or directory
</code></pre></div></div>

<p>No, no of course it doesn’t, because I forgot to install bhyve. Let’s do that shall we?</p>

<div><div><pre><code>vi@box:~/oxide-at-home/run$ sudo pkg install system/bhyve bhyve/firmware brand/bhyve system/library/bhyve
</code></pre></div></div>

<h2 id="using-propolis-for-real-this-time">Using Propolis, for real this time</h2>

<p>I restarted Propolis, and finally, FINALLY, we can create a VM.</p>

<div><div><pre><code>$ vi@box:~/oxide-at-home/run$ propolis-cli -s 127.0.0.1 new cirno -m 1024 -c 1
</code></pre></div></div>

<p>We have to explicitly turn on VMs after they’re created, and then we can interact with them over serial. <code>propolis-cli</code> can give us a serial connection to the VM, but here I ran into a little snag. The alpine image we’re using attaches the console to VGA by default, so I had to attach to serial first in one terminal, start the VM up in the other, then switch back to the serial connection to stop grub from autobooting.</p>

<div><div><pre><code>$ vi@box:~/oxide-at-home/run$ propolis-cli -s 127.0.0.1 serial cirno
$ vi@box:~/oxide-at-home/run$ propolis-cli -s 127.0.0.1 state cirno run

[ grub appears on the serial connection ]
</code></pre></div></div>

<p>Once grub came up I removed <code>quiet</code> from the linux arguments and added <code>console=ttyS0</code>. I hit the button to boot the system, and at long last, I had victory:</p>

<p><img alt="alpine welcome message, it worked" src="https://www.evalapply.org/assets/images/2022-03-14-propolis-oxide-at-home-pt1/alpine.png"/></p>

<p>This is where I stopped, to prevent my brain from melting.</p>

<h2 id="whats-next">What’s next?</h2>

<p>I’m not sure! I think <code>sled-agent</code> is the logical next step as we work our way from the ground up trying to build out a fully working deployment (for some definitions of “working” and “deployment”) but we’ll see.</p>

<p>Or maybe I’ll build a server rack out of cardboard. You never know.</p>

        </article></div>
  </body>
</html>
