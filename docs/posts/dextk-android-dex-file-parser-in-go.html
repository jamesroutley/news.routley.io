<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/csnewman/dextk">Original</a>
    <h1>Show HN: dextk - Android dex file parser in Go</h1>
    
    <div id="readability-page-1" class="page"><div dir="auto" data-snippet-clipboard-copy-content="package main

import (
	&#34;fmt&#34;
	&#34;log&#34;

	&#34;github.com/csnewman/dextk&#34;
	&#34;golang.org/x/exp/mmap&#34;
)

func main() {
	f, err := mmap.Open(&#34;classes.dex&#34;)
	if err != nil {
		log.Panicln(err)
	}

	defer f.Close()

	r, err := dextk.Read(f)
	if err != nil {
		log.Panicln(err)
	}

	ci := r.ClassIter()
	for ci.HasNext() {
		node, err := ci.Next()
		if err != nil {
			log.Panicln(err)
		}

		for _, method := range node.DirectMethods {
			fmt.Println(node.Name, &#34;: &#34;, method.Name)
			processMeth(r, method)
		}

		for _, method := range node.VirtualMethods {
			fmt.Println(node.Name, &#34;: &#34;, method.Name)
			processMeth(r, method)
		}
	}
}

func processMeth(r *dextk.Reader, m dextk.MethodNode) {
	if m.CodeOff == 0 {
		return
	}

	c, err := r.ReadCodeAndParse(m.CodeOff)
	if err != nil {
		log.Panic(err)
	}

	for _, o := range c.Ops {
		fmt.Println(&#34;  &#34;, o)
	}
}"><pre><span>package</span> main

<span>import</span> (
	<span>&#34;fmt&#34;</span>
	<span>&#34;log&#34;</span>

	<span>&#34;github.com/csnewman/dextk&#34;</span>
	<span>&#34;golang.org/x/exp/mmap&#34;</span>
)

<span>func</span> <span>main</span>() {
	<span>f</span>, <span>err</span> <span>:=</span> <span>mmap</span>.<span>Open</span>(<span>&#34;classes.dex&#34;</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Panicln</span>(<span>err</span>)
	}

	<span>defer</span> <span>f</span>.<span>Close</span>()

	<span>r</span>, <span>err</span> <span>:=</span> <span>dextk</span>.<span>Read</span>(<span>f</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Panicln</span>(<span>err</span>)
	}

	<span>ci</span> <span>:=</span> <span>r</span>.<span>ClassIter</span>()
	<span>for</span> <span>ci</span>.<span>HasNext</span>() {
		<span>node</span>, <span>err</span> <span>:=</span> <span>ci</span>.<span>Next</span>()
		<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
			<span>log</span>.<span>Panicln</span>(<span>err</span>)
		}

		<span>for</span> <span>_</span>, <span>method</span> <span>:=</span> <span>range</span> <span>node</span>.<span>DirectMethods</span> {
			<span>fmt</span>.<span>Println</span>(<span>node</span>.<span>Name</span>, <span>&#34;: &#34;</span>, <span>method</span>.<span>Name</span>)
			<span>processMeth</span>(<span>r</span>, <span>method</span>)
		}

		<span>for</span> <span>_</span>, <span>method</span> <span>:=</span> <span>range</span> <span>node</span>.<span>VirtualMethods</span> {
			<span>fmt</span>.<span>Println</span>(<span>node</span>.<span>Name</span>, <span>&#34;: &#34;</span>, <span>method</span>.<span>Name</span>)
			<span>processMeth</span>(<span>r</span>, <span>method</span>)
		}
	}
}

<span>func</span> <span>processMeth</span>(<span>r</span> <span>*</span>dextk.<span>Reader</span>, <span>m</span> dextk.<span>MethodNode</span>) {
	<span>if</span> <span>m</span>.<span>CodeOff</span> <span>==</span> <span>0</span> {
		<span>return</span>
	}

	<span>c</span>, <span>err</span> <span>:=</span> <span>r</span>.<span>ReadCodeAndParse</span>(<span>m</span>.<span>CodeOff</span>)
	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {
		<span>log</span>.<span>Panic</span>(<span>err</span>)
	}

	<span>for</span> <span>_</span>, <span>o</span> <span>:=</span> <span>range</span> <span>c</span>.<span>Ops</span> {
		<span>fmt</span>.<span>Println</span>(<span>&#34;  &#34;</span>, <span>o</span>)
	}
}</pre></div></div>
  </body>
</html>
