<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dataswamp.org/~solene/2025-05-31-linux-killswitch-on-power-disconnect.html">Original</a>
    <h1>How to trigger a command on Linux when power switches from AC to battery</h1>
    
    <div id="readability-page-1" class="page"><div>
<article id="20250531">
  <header>
  
    
    <p>Written by <em>Sol√®ne</em>, on 31 May 2025.</p>
    
    
  </header>
  
    
    

<p>After thinking about BusKill product that triggers a command once the USB cord disconnects, I have been thinking at a simple alternative.
</p>
<p><a href="https://www.buskill.in">BusKill official project website</a></p>
<p>When using a laptop connected to power most of the time, you may want it to power off once it gets disconnected, this can be really useful if you use it in a public area like a bar or a train.  The idea is to protect the laptop if it gets stolen while in use and unlocked.
</p>
<p>Here is how to proceed on Linux, using a trigger on an udev rule looking for a change in the power_supply subsystem.
</p>
<p>For OpenBSD users, it is possible to use apmd as I explained in this article:
</p>
<p><a href="https://dataswamp.org/~solene/2024-02-20-rarely-known-openbsd-features.html#_apmd_daemon_hooks">=&gt; Rarely known OpenBSD features: apmd daemon hooks</a></p>
<p>In the example, the script will just power off the machine, it is up to you to do whatever you want like destroy the LUKS master key or trigger the coffee machine :D
</p>

<p>Create a file <code>/etc/udev/rules.d/disconnect.rules</code>, you can name it how you want as long as it ends with <code>.rules</code>:
</p>
<pre><code>SUBSYSTEM==&#34;power_supply&#34;, ENV{POWER_SUPPLY_ONLINE}==&#34;0&#34;, ENV{POWER_SUPPLY_TYPE}==&#34;Mains&#34;, RUN+=&#34;/usr/local/bin/power_supply_off&#34;
</code></pre>
<p>Create a file <code>/usr/local/bin/power_supply_off</code> that will be executed when you unplug the laptop:
</p>
<pre><code>#!/bin/sh
echo &#34;Going off because power supply got disconnected&#34; | systemd-cat
systemctl poweroff
</code></pre>
<p>This simple script will add an entry in journald before triggering the system shutdown.
</p>
<p>Mark this script executable with:
</p>
<pre><code>chmod +x /usr/local/bin/power_supply_off
</code></pre>
<p>Reload udev rules using the following commands:
</p>
<pre><code>udevadm control --reload-rules
udevadm trigger
</code></pre>

<p>If you unplug your laptop power, it should power off, you should find an entry in the logs.
</p>
<p>If nothing happens, looks at systemd logs to see if something is wrong in udev, like a syntax error in the file you created or an incorrect path for the script.
</p>

<p>Depending on your needs, here is a list of actions the script could do, from gentle to hardcore:
</p>
<ul>

  <li>Lock user sessions</li>
  <li>Hibernate</li>
  <li>Proper shutdown</li>
  <li>Instant power off (through sysrq)</li>
  <li>Destroy LUKS master key to make LUKS volume unrecoverable + Instant power off</li>
</ul>


<p>While BusKill is an effective / unusual product that is certainly useful for a niche, protecting a running laptop against thieves is an extra layer when being outside.
</p>
<p>Obviously, this use case works only when the laptop is connected to power.
</p>

</article>
</div></div>
  </body>
</html>
