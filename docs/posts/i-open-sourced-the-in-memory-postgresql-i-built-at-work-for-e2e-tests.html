<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/stackframe-projects/pgmock">Original</a>
    <h1>Show HN: I open-sourced the in-memory PostgreSQL I built at work for E2E tests</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">

<p dir="auto"><code>pgmock</code> is an in-memory PostgreSQL mock server for unit and E2E tests. It requires no external dependencies and runs entirely within WebAssembly on both Node.js and the browser.</p>


<p dir="auto">If you&#39;d like to run <code>pgmock</code> in a browser, see the <a href="#browser-support">Browser support</a> section for detailed instructions.</p>

<p dir="auto">You can run an in-memory server like so:</p>
<div dir="auto" data-snippet-clipboard-copy-content="import { PostgresMock } from &#34;pgmock&#34;;

const mock = await PostgresMock.create();
const connectionString = await mock.listen(5432);"><pre><span>import</span> <span>{</span> <span>PostgresMock</span> <span>}</span> <span>from</span> <span>&#34;pgmock&#34;</span><span>;</span>

<span>const</span> <span>mock</span> <span>=</span> <span>await</span> <span>PostgresMock</span><span>.</span><span>create</span><span>(</span><span>)</span><span>;</span>
<span>const</span> <span>connectionString</span> <span>=</span> <span>await</span> <span>mock</span><span>.</span><span>listen</span><span>(</span><span>5432</span><span>)</span><span>;</span></pre></div>
<p dir="auto">Recommended: If you use <code>node-postgres</code> (<code>pg</code> on npm), <code>pgmock</code> provides you with a configuration object that doesn&#39;t require you to serve on a port (and also works in the browser):</p>
<div dir="auto" data-snippet-clipboard-copy-content="import * as pg from &#34;pg&#34;;

const mock = await PostgresMock.create();
const client = new pg.Client(mock.getNodePostgresConfig());

await client.connect();
console.log(await client.query(&#39;SELECT $1::text as message&#39;, [&#39;Hello world!&#39;]));"><pre><span>import</span> <span>*</span> <span>as</span> <span>pg</span> <span>from</span> <span>&#34;pg&#34;</span><span>;</span>

<span>const</span> <span>mock</span> <span>=</span> <span>await</span> <span>PostgresMock</span><span>.</span><span>create</span><span>(</span><span>)</span><span>;</span>
<span>const</span> <span>client</span> <span>=</span> <span>new</span> <span>pg</span><span>.</span><span>Client</span><span>(</span><span>mock</span><span>.</span><span>getNodePostgresConfig</span><span>(</span><span>)</span><span>)</span><span>;</span>

<span>await</span> <span>client</span><span>.</span><span>connect</span><span>(</span><span>)</span><span>;</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>await</span> <span>client</span><span>.</span><span>query</span><span>(</span><span>&#39;SELECT $1::text as message&#39;</span><span>,</span> <span>[</span><span>&#39;Hello world!&#39;</span><span>]</span><span>)</span><span>)</span><span>;</span></pre></div>
<p dir="auto">It is considered good practice to destroy the mock server after you are done with it to free up resources:</p>


<p dir="auto">Check the <a href="https://github.com/stackframe-projects/pgmock/blob/main/src/postgres-mock.ts">PostgresMock source file</a> for a list of all available methods and their documentation.</p>

<p dir="auto"><code>pgmock</code> fully supports browser environments. While webapps can&#39;t listen to TCP ports, you can still use <code>PostgresMock.createSocket</code> and the <code>node-postgres</code> configuration. However, if your bundler statically analyzes imports, the default configuration may show a warning because of missing (optional) Node.js modules. Check <code>examples/web-demo/next.config.mjs</code> for an example on how to configure Webpack for bundling.</p>
<p dir="auto">If you&#39;re only looking to run a database in the browser, you might want to consider <a href="https://github.com/electric-sql/pglite">pglite</a> instead. It is more performant and lightweight, but only has a limited feature set. <code>pgmock</code> is designed for feature parity with production PostgreSQL environments, as you would want in a testing environment.</p>

<p dir="auto">There are two approaches to run Postgres in WebAssembly; by <a href="https://github.com/electric-sql/postgres-wasm">forking it to support WASM natively</a> or by <a href="https://supabase.com/blog/postgres-wasm" rel="nofollow">emulating the Postgres server in an x86 emulator</a>. The former is more performant and uses considerably less memory, but only supports single-user mode (no connections), and no extensions.</p>
<p dir="auto">To prevent discrepancies between testing and production, and because performance is not usually a concern in tests, <code>pgmock</code> currently uses the latter approach. In the mid-term future, once native Postgres WASM forks mature, we plan to make both options available, and eventually, switch to native WASM as default. We don&#39;t expect there to be many breaking changes besides the APIs inside <code>PostgresMock.subtle</code>.</p>
<p dir="auto"><code>pgmock</code> differs from previous Postgres-in-the-browser projects by providing full feature-compatibility entirely inside the JavaScript runtime, without depending on a network proxy for communication. We did this by simulating a network stack in JavaScript that behaves like a real network, that can simulate TCP connections even on platforms that do not allow raw socket access.</p>

<p dir="auto">Great! We have a <a href="https://discord.gg/pD4nyYyKrb" rel="nofollow">Discord server</a> where you can talk to us.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Can this run other Docker images or databases?</h2><a id="user-content-can-this-run-other-docker-images-or-databases" aria-label="Permalink: Can this run other Docker images or databases?" href="#can-this-run-other-docker-images-or-databases"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In theory, yes. I just haven&#39;t tested them. Ping me on our <a href="https://discord.gg/pD4nyYyKrb" rel="nofollow">Discord server</a> if you&#39;re interested.</p>

<ul dir="auto">
<li><a href="https://github.com/copy/v86">v86</a>, the x86 emulator which makes this possible</li>
<li><a href="https://supabase.com/blog/postgres-wasm" rel="nofollow">Supabase &amp; Snaplet</a> for building their own approach of running Postgres inside WebAssembly, which this is based on</li>
<li><a href="https://stackframe.co" rel="nofollow">Stackframe</a> for keeping me on a payroll while I was building <code>pgmock</code></li>
</ul>
</article></div></div>
  </body>
</html>
