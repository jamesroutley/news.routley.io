<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/valine/NeuralFlow">Original</a>
    <h1>Show HN: NeuralFlow â€“ Visualize the intermediate output of Mistral 7B</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">This is a Python script for plotting the intermediate layer outputs of Mistral 7B. When you run the script, it produces a 512x256 image representing the output at every layer of the model.</p>
<p dir="auto">The concept is straightforward: collect the output tensors from each layer, normalize them between zero and one, and plot these values as a heatmap. The resulting image reveals a surprising amount of structure. I have found this enormously helpful for visually inspecting outputs when fine-tuning models.</p>
<h3 tabindex="-1" dir="auto"><a id="user-content-visualizing-the-model-during-training" aria-hidden="true" tabindex="-1" href="#visualizing-the-model-during-training"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Visualizing the model during training</h3>
<p dir="auto">Below is a visualization from an out-of-the-box, non-fine-tuned Mistral 7B.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/14074844/304937081-aef6a0fc-820c-4e6d-94df-a907df8a7018.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5MzcwODEtYWVmNmEwZmMtODIwYy00ZTZkLTk0ZGYtYTkwN2RmOGE3MDE4LmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTRkZjE0ZTVlNDRmNjQwYjVhZjY0M2E0YjU1MDFjOTQ3ZTMxNTljNTQ4MGExYmJjNWYwZGYzMWY5NWRkOTZkOWYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.a3kySzJt57RHzpKlEB1owTifgaLQTxo39rnGjDJAgDo"><img src="https://private-user-images.githubusercontent.com/14074844/304937081-aef6a0fc-820c-4e6d-94df-a907df8a7018.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5MzcwODEtYWVmNmEwZmMtODIwYy00ZTZkLTk0ZGYtYTkwN2RmOGE3MDE4LmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTRkZjE0ZTVlNDRmNjQwYjVhZjY0M2E0YjU1MDFjOTQ3ZTMxNTljNTQ4MGExYmJjNWYwZGYzMWY5NWRkOTZkOWYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.a3kySzJt57RHzpKlEB1owTifgaLQTxo39rnGjDJAgDo" alt="initial_output"/></a></p>
<p dir="auto">Intentionally overfitting a model on a small fine-tuning dataset yields the following output. A problem starts around layer 10, cascading through the subsequent layers.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/14074844/304934986-c6788265-5c8c-45ba-8092-98ec6d3caf09.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5MzQ5ODYtYzY3ODgyNjUtNWM4Yy00NWJhLTgwOTItOThlYzZkM2NhZjA5LmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTIwNDFmY2JhYWMyNzE2NmI4Y2I3MTU3ZWY3NmMzMWEzYjVjNTFmMTY4YzA3MDljMzE0YjY1ZTg3YjU5YjUxMWUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.F3qKhYvK87fY5fXHegfbd2DC4ACKsIT8njeVrEl_UT4"><img src="https://private-user-images.githubusercontent.com/14074844/304934986-c6788265-5c8c-45ba-8092-98ec6d3caf09.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5MzQ5ODYtYzY3ODgyNjUtNWM4Yy00NWJhLTgwOTItOThlYzZkM2NhZjA5LmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTIwNDFmY2JhYWMyNzE2NmI4Y2I3MTU3ZWY3NmMzMWEzYjVjNTFmMTY4YzA3MDljMzE0YjY1ZTg3YjU5YjUxMWUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.F3qKhYvK87fY5fXHegfbd2DC4ACKsIT8njeVrEl_UT4" alt="overfit_output"/></a></p>
<p dir="auto">The true value of this visualization lies in the patterns that emerge when comparing outputs before and after training. By periodically visualizing the model output, it&#39;s possible to animate the model&#39;s intermediate output over time. Failures within a single layer can cascade to higher layers. While it&#39;s challenging to ascribe meaning to the structures within the visualization, it&#39;s visually apparent when the distribution of output deviates from the initial state.</p>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span aria-label="Video description animation.mov">animation.mov</span>
    <span></span>
  </summary>

  <video src="https://private-user-images.githubusercontent.com/14074844/304936313-1f2e50ea-d64d-4f37-a991-f968399e29bd.mov?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5MzYzMTMtMWYyZTUwZWEtZDY0ZC00ZjM3LWE5OTEtZjk2ODM5OWUyOWJkLm1vdj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTY0ZWNmMDA4ODAyYjY0MjgxYTdhMTBkOTc4NTA1Y2M3NzA5ZjZkOTdjYmQzNDM3MjcwYzIzMzkyMGIxNDYxYTYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.HejLqDLyUtD3bloQ2RSYlHfCWuL5BmNXF59xLX5TRa8" data-canonical-src="https://private-user-images.githubusercontent.com/14074844/304936313-1f2e50ea-d64d-4f37-a991-f968399e29bd.mov?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5MzYzMTMtMWYyZTUwZWEtZDY0ZC00ZjM3LWE5OTEtZjk2ODM5OWUyOWJkLm1vdj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTY0ZWNmMDA4ODAyYjY0MjgxYTdhMTBkOTc4NTA1Y2M3NzA5ZjZkOTdjYmQzNDM3MjcwYzIzMzkyMGIxNDYxYTYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.HejLqDLyUtD3bloQ2RSYlHfCWuL5BmNXF59xLX5TRa8" controls="controls" muted="muted">

  </video>
</details>

<h3 tabindex="-1" dir="auto"><a id="user-content-how-the-image-is-structured" aria-hidden="true" tabindex="-1" href="#how-the-image-is-structured"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>How the image is structured</h3>
<p dir="auto">The resolution and structure of this visualization warrant additional explanation. The intermediate output of Mistral 7B for a single token is a 4096-dimension tensor for each of the 32 layers. A 4096x32 image is impractical for visualization purposes. To address this, I have segmented the image into chunks of 512 and arranged them vertically. The result is a 512x256 image that displays nicely on landscape screens.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/14074844/304938430-7cf5ad4a-98a7-4ec4-896c-fe4fb5068654.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5Mzg0MzAtN2NmNWFkNGEtOThhNy00ZWM0LTg5NmMtZmU0ZmI1MDY4NjU0LmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJlZjQyNzQ3MzIxMmYyM2JkMWMyYTMzY2E2ZTllY2NjMjNjM2Q3NjQxNGYyYzJiMjljNDQ1YWFlNDM0OGUwNDYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.IOCN9X-nlgcNXkC3aPyVas-kxcz87r8omhBOgbkEdAU"><img src="https://private-user-images.githubusercontent.com/14074844/304938430-7cf5ad4a-98a7-4ec4-896c-fe4fb5068654.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MDgwMDMxNjQsIm5iZiI6MTcwODAwMjg2NCwicGF0aCI6Ii8xNDA3NDg0NC8zMDQ5Mzg0MzAtN2NmNWFkNGEtOThhNy00ZWM0LTg5NmMtZmU0ZmI1MDY4NjU0LmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAyMTUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMjE1VDEzMTQyNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJlZjQyNzQ3MzIxMmYyM2JkMWMyYTMzY2E2ZTllY2NjMjNjM2Q3NjQxNGYyYzJiMjljNDQ1YWFlNDM0OGUwNDYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.IOCN9X-nlgcNXkC3aPyVas-kxcz87r8omhBOgbkEdAU" alt="guide"/></a></p>
<h3 tabindex="-1" dir="auto"><a id="user-content-additional-discusion-and-models" aria-hidden="true" tabindex="-1" href="#additional-discusion-and-models"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Additional discusion and models</h3>
<p dir="auto">This tool was developed as part of an independent research project. Per the request of a few users of r/locallama the code has been cleaned up and made avaiable in this repo. You can find that original discussion here:
<a href="https://www.reddit.com/r/LocalLLaMA/comments/1ap8mxh/comment/kq4mdk4/?context=3" rel="nofollow">thread on r/locallama</a></p>
<p dir="auto">As a final note, here are a few models I have trained using this visualization as a guide. In my opinion the behaviors these models were trained on generalized exceptionally well.</p>
<ul dir="auto">
<li><a href="https://huggingface.co/valine/OpenPirate" rel="nofollow">https://huggingface.co/valine/OpenPirate</a></li>
<li><a href="https://huggingface.co/valine/MoreHuman" rel="nofollow">https://huggingface.co/valine/MoreHuman</a></li>
<li><a href="https://huggingface.co/valine/OpenAusten" rel="nofollow">https://huggingface.co/valine/OpenAusten</a></li>
<li><a href="https://huggingface.co/valine/OpenSnark" rel="nofollow">https://huggingface.co/valine/OpenSnark</a></li>
<li><a href="https://huggingface.co/valine/OpenDracula" rel="nofollow">https://huggingface.co/valine/OpenDracula</a></li>
</ul>

<p dir="auto">There are two file paths you will want to change before running the script:</p>
<div data-snippet-clipboard-copy-content="model_folder = &#34;/models/OpenHermes-2.5-Mistral-7B&#34;
image_output_folder = &#34;/home/username/Desktop/&#34;"><pre><code>model_folder = &#34;/models/OpenHermes-2.5-Mistral-7B&#34;
image_output_folder = &#34;/home/username/Desktop/&#34;
</code></pre></div>
<p dir="auto">This is self explanitory, but set the model folder to the location of your Mistral 7B, and the image output folder to the path you&#39;d like to save your image.</p>
</article></div></div>
  </body>
</html>
