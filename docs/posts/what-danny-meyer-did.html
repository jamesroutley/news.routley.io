<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://commoncog.com/blog/what-danny-meyer-did/">Original</a>
    <h1>What Danny Meyer Did</h1>
    
    <div id="readability-page-1" class="page"><article><header><time datetime="2022-05-22 18:35:44 +0530">22 May 2022</time></header><p>MongoDB officially does not allow adding secondary only indexes in a replica set. However, there is one hacky way to achieve the same.</p><h2 id="why">Why</h2><p>Sometimes you might have requirements which may not be needed for the main application. An actual use case is when you want to run analytics (or use things like <a href="https://www.metabase.com/">Metabase</a>) but donâ€™t want to change the primary schema.</p><h2 id="how">How</h2><p>Earlier, <a href="https://avi.im/blag/2021/mongo-dupes-in-unique-index/">I discovered an odd behaviour with MongoDB</a> replica set and indexes. I thought one could use a similar approach to add secondary only indexes, which is what people have been doing.</p><p>The procedure is almost similar to how MongoDB adds <a href="https://www.mongodb.com/docs/manual/tutorial/build-indexes-on-replica-sets/#procedure">rolling indexes to replicas</a> but slightly different.</p><ol><li>Add a new member to the replica set (or pick an existing one)</li><li>Make this member a <a href="https://www.mongodb.com/docs/manual/tutorial/configure-a-non-voting-replica-set-member/">non-voting member</a>. This step is essential because we never want this member to become a primary, ever.</li><li>Remove the member from the replica set - <a href="https://www.mongodb.com/docs/manual/tutorial/remove-replica-set-member/">instructions</a></li><li>Add the indexes you need</li><li>Add the member back to the replica set</li><li>Now connect to only this instance for analytics or other purposes</li></ol><p>You might need to repeat steps 3-5 if you want to add new indexes.</p><h2 id="references">References</h2><ol><li>Bunch of Jira tickets - <a href="https://jira.mongodb.org/browse/SERVER-3664">1</a>, <a href="https://jira.mongodb.org/browse/SERVER-6587">2</a></li><li>Stackoverflow - <a href="https://stackoverflow.com/questions/22061008/in-mongodb-how-can-i-index-on-fields-in-collections-in-secondary-noderepli">1</a>, <a href="https://stackoverflow.com/questions/16472392/different-indexes-on-different-replica-set-members">2</a></li><li>My <a href="https://avi.im/blag/2021/mongo-dupes-in-unique-index/">previous blog post</a> where I discovered that you can add duplicate records on an unique index</li></ol></article></div>
  </body>
</html>
