<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://badgerbadgerbadgerbadger.dev/posts/misc/2024-04-08-is-it-dry-yet/">Original</a>
    <h1>Is It Dry Yet?</h1>
    
    <div id="readability-page-1" class="page"><div><blockquote><p><strong>Clarification</strong>: This is literally about my laundry. I am not being metaphorical. I am not talking about my feelings or my secrets. I am talking about my clothes.</p></blockquote><h2 id="intro">Intro</h2><p>Our washing machine is a Samsung something-something that sends me a notification on the <a href="https://www.samsung.com/be/smartthings/app/">SmartThings app</a> when it completes a wash cycle. This is useful since we almost always need to follow up a washing cycle with a drying one and maybe even another load of laundry. The machine isn’t a combined-washer-dryer so someone has to move the wet clothes from our smart washer to our dumb dryer.</p><p>The fact that our dryer is “dumb” is what led me to my automation journey. If it was Wifi-enabled and also sending out notifications as it completed a cycle, I wouldn’t be writing this post.</p><p>Having been spoiled by knowing exactly when my washing has completed (so I know when to go move things to the dryer) I decided to do something similar for the dryer. This is especially useful, for example, when the clothes need an extra drying cycle or when there are more wet clothes that are waiting in the washer. In these times it is useful to know if the dryer has finished a cycle.</p><p>And since it is not a smart device, I have to add the brains, somehow.</p><h2 id="plan-of-attack">Plan of Attack</h2><p>This is how I decided to approach the problem:</p><ul><li>I have a <a href="https://www.shelly.com/en-be/products/shop/shelly-plus-plug-s">Shelly smart plug</a> that I would put between Drew (the dryer is called Drew) and the wall.</li><li>The plug would transmit power readings to my <a href="https://www.home-assistant.io/">Home Assistant</a> setup.</li><li>I would do <em>something</em> to detect when the power reading goes down from some high number to some very low number (I’m assuming it never goes to 0 since the little LED panel needs power).</li><li>I will notify myself of this <em>somehow</em>.</li></ul><p>It’s the <em>something</em> and <em>somehow</em> parts I was unsure of. My Home Assistant setup is as basic as it gets. I only started my home automation journey a month or two ago and was unfamiliar with the possibilities. However, this felt like something that should be within the realm of HASS’s capabilities.</p><h2 id="discovering-automations">Discovering Automations</h2><p>The first thing I discovered as I dug further into Home Assistant was <a href="https://www.home-assistant.io/docs/automation/">Automation</a>s. In Home Assistant you create automations via the Automations system. You can turn on a light when a motion sensor senses someone in the room; you can turn on the vent when humidity reaches a certain level; you can make all the lights turn pink and romantic music play over the speakers when it is February 14th and your beloved comes home from work. The possibilities are <em>endless</em>.</p><h2 id="the-automation-setup">The Automation Setup</h2><p>Figuring out the Automation setup I wanted was straightforward. There are 3 key components to the Home Assistant Automation system.</p><ol><li><a href="https://www.home-assistant.io/docs/automation/trigger/">Triggers</a>: The thing that kicks off an Automation. These can be of many types ranging from a number on a sensor changing, to an incoming MQTT payload.</li><li><a href="https://www.home-assistant.io/docs/automation/condition/">Conditions</a>: An optional extra check to ensure that when the Automation triggers everything is in the state you want it to be. You can check the value of sensors, check the on/off status of devices, or even <a href="https://www.home-assistant.io/docs/scripts/conditions/#sun-condition">check if the sun is up</a>.</li><li><a href="https://www.home-assistant.io/docs/automation/action/">Actions</a>: This where we <em>do</em> something in our Automation. This is where you will want to set up that electric rooster crowing when the sun comes up (if you want to build your own weird alarm clock for some reason), or send a message on a webhook when the kids are using too much electricity.</li></ol><p>Thinking over my needs I decided on the following for my Trigger/Condition/Action setup:</p><ol><li><strong>Trigger</strong>: I want the Automation to start when Drew’s power draw falls below 10 W (as reported by Sheila, the smart plug), and has remained under 10 W for more than 5 minutes.</li><li><strong>Condition</strong>: I want to ensure this Automation only fires if we have consumed more than a 100 Watts of power sometime in the last 5 minutes.</li><li><strong>Action</strong>: Inform me somehow that this has happened.</li></ol><p>While the Trigger and Condition were straightforward, the Action was a bit more nebulous. At first, I wasn’t entirely sure how to notify myself. I looked into <a href="https://www.home-assistant.io/integrations/notify.rest/">Home Assistant’s Restful Notifications</a> but could not make it work for the life of me. Then I decided to check if I could send an email. I found <a href="https://www.home-assistant.io/integrations/smtp/">Home Assistant’s SMTP Notifications</a> and decided to give it a go. Again, I could not make it work. It asked me to enter my Gmail password in the Home Assistant configuration file, but I was not comfortable doing that. I decided to look for another way.</p><p>I finally stumbled upon the <a href="https://www.home-assistant.io/integrations/ios/">Home Assistant iOS App</a> which I installed on my phone and pointed to my Home Assistant server. This allowed me to send notifications to my phone (my phone became available as a target for notifications).</p><p>The full Automation setup looks like this:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>alias</span>: <span>Is it dry yet?</span>
</span></span><span><span><span>description</span>: <span>Notifies when Drew (the dryer) has finished a drying cycle.</span>
</span></span><span><span><span>trigger</span>:
</span></span><span><span>  - <span>id</span>: <span>Sheila Power Below 10 W</span>
</span></span><span><span>    <span>platform</span>: <span>numeric_state</span>
</span></span><span><span>    <span>entity_id</span>:
</span></span><span><span>      - <span>sensor.sheila_power</span>
</span></span><span><span>    <span>below</span>: <span>10</span>
</span></span><span><span>    <span>for</span>:
</span></span><span><span>      <span>minutes</span>: <span>5</span>
</span></span><span><span><span>condition</span>:
</span></span><span><span>  - <span>condition</span>: <span>numeric_state</span>
</span></span><span><span>    <span>entity_id</span>: <span>sensor.sheila_power_5_minutes_ago</span>
</span></span><span><span>    <span>above</span>: <span>100</span>
</span></span><span><span><span>action</span>:
</span></span><span><span>  - <span>service</span>: <span>notify.mobile_app_sharpie</span>
</span></span><span><span>    <span>data</span>:
</span></span><span><span>      <span>message</span>: <span>Drew has finished a cycle. You should unload him.</span>
</span></span><span><span>      <span>title</span>: <span>Dryer Cycle Finished</span>
</span></span><span><span>  - <span>service</span>: <span>notify.mobile_app_buttercups_android</span>
</span></span><span><span>    <span>data</span>:
</span></span><span><span>      <span>message</span>: <span>Drew has finished a cycle. You should unload him.</span>
</span></span><span><span>      <span>title</span>: <span>Dryer cycle finished.</span>
</span></span><span><span>  - <span>service</span>: <span>media_player.play_media</span>
</span></span><span><span>    <span>target</span>:
</span></span><span><span>      <span>entity_id</span>: <span>media_player.thuis</span>
</span></span><span><span>    <span>data</span>:
</span></span><span><span>      <span>announce</span>: <span>true</span>
</span></span><span><span>      <span>media_content_type</span>: <span>mp3</span>
</span></span><span><span>      <span>media_content_id</span>: <span>https://&lt;static-host&gt;/drew-finished-drying.mp3</span>
</span></span><span><span><span>mode</span>: <span>single</span>
</span></span></code></pre></div><p><code>notify.mobile_app_sharpie</code> and <code>notify.mobile_app_buttercups_android</code> are the entities exposed by the Home Assistant iOS and Android apps on my phone and my girlfriend’s phone respectively. <code>media_player.thuis</code> is the entity exposed by my Google Nest speaker group. Not being simply content to send a notification to my phone, I also wanted to play a sound on my Google Nest speaker group. The sound is a mp3 file that I host on a static host.</p><p><code>sensor.sheila_power</code> is the sensor entity exposed by my smart plug and what lets me monitor the power draw of the dryer. <code>sensor.sheila_power_5_minutes_ago</code> is a sensor that I created using the <a href="https://www.home-assistant.io/integrations/sql">SQL Integration</a>. I created a custom sensor to get the power draw 5 minutes ago.</p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>select</span> <span>*</span>
</span></span><span><span><span>from</span> states
</span></span><span><span><span>where</span> metadata_id <span>=</span> (<span>select</span> states_meta.metadata_id
</span></span><span><span>                     <span>from</span> states_meta
</span></span><span><span>                     <span>where</span> states_meta.entity_id <span>=</span> <span>&#39;sensor.sheila_power&#39;</span>)
</span></span><span><span>  <span>and</span> datetime(last_updated_ts, <span>&#39;unixepoch&#39;</span>) <span>&lt;</span> datetime(<span>&#39;now&#39;</span>, <span>&#39;-5 minutes&#39;</span>)
</span></span><span><span><span>order</span> <span>by</span> last_updated_ts <span>desc</span>
</span></span><span><span><span>limit</span> <span>1</span>
</span></span></code></pre></div><p>In combination this ensures that this Automation only triggers when our power draw falls below 10 W for at least 5 minutes, and we have consumed more than 100 W of power just before. This gives me a good indication that the dryer has finished a cycle and I should go unload it.</p><h2 id="exposing-to-the-world">Exposing to the World</h2><p>I should mention that my Home Assistant server was not available to the internet at that point. All integrations were over local Wi-Fi with firewall rules to prevent any external access. I did not have to expose my Home Assistant server to the internet to get notifications on my phone since they are both part of a <a href="https://tailscale.com/kb/1136/tailnet">Tailnet</a>. This meant that as long as I had the <a href="https://tailscale.com/download/ios">Tailscale App</a> on my phone and Tailscale VPN enabled, I could access my Home Assistant server from anywhere in the world.</p><p>And this would have been good enough for me, but my girlfriend also needs notifications on <em>her</em> phone and asking her to install Tailscale and turn it on/off before she could access the notifications was a bit much.</p><p>So I decided to expose my Home Assistant server to the internet.</p><p>My first attempt was using Let’s Encrypt and DuckDNS, following a guide (or three) similar to <a href="https://www.makeuseof.com/access-home-assistant-server-remotely-duckdns-letsencrypt/">this</a>. I won’t go into all the details, but I will say that it was a <em>pain</em>. Ultimately, after struggling for several days, I gave up. I gave up and decided to go back to my girlfriend, head bowed, and give her the bad news.</p><p>But then I stumbled upon <a href="https://tailscale.com/kb/1223/funnel">Tailscale Funnels</a>. Since I was using Tailscale anyway, with a single additional invocation, I could have a secure, encrypted, tunnel to my Home Assistant server.</p><div><pre tabindex="0"><code data-lang="sh"><span><span>➜  ~ tailscale funnel --https<span>=</span><span>8443</span> --bg <span>8123</span>
</span></span></code></pre></div><p>No extra DNS required since I can use my Tailnet’s name and no extra certificates required since Tailscale handles all of that for me.</p><p>The only caveat to this approach is that Tailscale does not yet support domain name handling. So I can’t assign a nice domain name to my Home Assistant server. Furthermore, I only have <a href="https://tailscale.com/kb/1223/funnel#limitations">3 ports available to me</a>. This means that if I were to have other services on that machine that I want to expose to the world, I can at most have 2 more, and they will have to be referenced by their port numbers.</p><p>This is something I will have to come back to later, but for now both me and my girlfriend have access to our Home Assistant server from anywhere in the world and are happy ducks.</p><p>Of course, I limited her account to only have access to the notifications and some views. I don’t want her messing with my automations and I don’t want a third party poking around my smart home setup.</p></div></div>
  </body>
</html>
