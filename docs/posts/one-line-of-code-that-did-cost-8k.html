<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pietrasiak.com/one-line-of-code-that-did-cost-dollar8000">Original</a>
    <h1>One line of code that did cost $8k</h1>
    
    <div id="readability-page-1" class="page"><div><p><h2 id="6229ad4c359d4dbf908c56b33a98c24c">TLDR</h2></p><p>Due to a bug, <a target="_blank" href="http://screen.studio">screen.studio</a> app kept downloading the auto-update file repeatedly, every 5 minutes for every single user. The update file is approximately 250MB. This resulted in <b>9 million file downloads and more than 2 petabytes (2,000,000 gigabytes)</b> of traffic on Google Cloud.</p><figure><p><img loading="lazy" decoding="async" alt="Image without caption" src="https://image-forwarder.notaku.so/aHR0cHM6Ly93d3cubm90aW9uLnNvL2ltYWdlL2h0dHBzJTNBJTJGJTJGczMtdXMtd2VzdC0yLmFtYXpvbmF3cy5jb20lMkZzZWN1cmUubm90aW9uLXN0YXRpYy5jb20lMkZlMjZiZThjNS05ZDcxLTRmYTgtODBlYS1iNDdiNmNmNTg3Y2ElMkZVbnRpdGxlZC5wbmc_dGFibGU9YmxvY2smc3BhY2VJZD1iYTMzYWM4NC1mN2VjLTQwZDMtODU0MS0wNDMyODI5YzBkNDgmaWQ9NzNkMzk3N2YtNjJhNy00MmQ1LTk2ZTQtNThiYmQwMDc5NzMyJmNhY2hlPXYyJndpZHRoPTI0MDA="/></p><div></div></figure><p>This screenshot might not look so scary at first, but take a look at the scale of it. For over a month, we generated at least 100Mib/s (a second!) and, at times, almost 1GiB/s (every single second!)</p><hr/><p>That bug was painfully simple and stupid.</p><p>Screen Studio is a desktop app. It means we need some auto-updater to allow users to install the latest app version easily.</p><p>The app checks for the update every 5 minutes or when the user activates the app.</p><p>Normally, when the app detected the update - it downloaded it and stopped the 5 minutes interval until the user installed it and restarted it.</p><p><h2 id="86e96dd5a9a64f7eb2a3408771948538">Tragic refactor</h2></p><p>The problem with the auto-updater we had was that it would prompt the user to update the app as soon as it became available. This resulted in a popup appearing while users were recording the screen, which obviously provided a bad experience as it interrupted the recording the user was making.</p><p>While refactoring it, <b>I forgot to add the code to stop the 5-minute interval after the new version file was available and downloaded.</b></p><p>It meant <b>the app was downloading the same 250MB file, over and over again, every 5 minutes.</b></p><p><h2 id="8bc5a4ebee2d4a2387cb4af3e66bda00">Tragic context - app running in the background for weeks</h2></p><p>It turns out thousands of our users had the app running in the background, even though they were not using it or checking it <b>for weeks</b> (!). It meant thousands of users had auto-updater constantly running and downloading the new version file (250MB) over and over again every 5 minutes</p><p><h2 id="0c7c00acd73e4f7ba7a05ffd8ee2f5bf">The math</h2></p><p>Letâ€™s do some quick math here.</p><ul><li>Doing something every 5 minutes means doing it approximately <b>288 times a day</b>.</li></ul><ul><li>The update file is about 250 MB, meaning <b>72 GB of downloads per user daily</b>.</li></ul><ul><li>We had this situation happening for <b>over a month before we noticed it</b>.</li></ul><ul><li>We had at least a <b>thousand such app instances running</b> in the background at any moment.</li></ul><ul><li><b>250 MB * 288 downloads per day * 30 days * 1000 users:</b></li></ul><figure><p><img loading="lazy" decoding="async" alt="Image without caption" src="https://image-forwarder.notaku.so/aHR0cHM6Ly93d3cubm90aW9uLnNvL2ltYWdlL2h0dHBzJTNBJTJGJTJGczMtdXMtd2VzdC0yLmFtYXpvbmF3cy5jb20lMkZzZWN1cmUubm90aW9uLXN0YXRpYy5jb20lMkY1Y2FlZmVkYS0wMDFjLTQ2NDktODM2Zi1lMTI0MzM0NDRjMGUlMkZVbnRpdGxlZC5wbmc_dGFibGU9YmxvY2smc3BhY2VJZD1iYTMzYWM4NC1mN2VjLTQwZDMtODU0MS0wNDMyODI5YzBkNDgmaWQ9M2FjZmFjNzAtOTc2ZC00ZmI4LTkwYTgtMzU5NmQzMTFkZGFlJmNhY2hlPXYyJndpZHRoPTI0MDA="/></p><div></div></figure><p>It means it was roughly:</p><ul><li><b>2 000 000 gigabytes, </b></li></ul><ul><li><b>or 2 000 terabytes </b></li></ul><ul><li><b>or 2 petabytes of traffic.</b></li></ul><p><h2 id="b0ab8050379441e89f1489895de53ae8">Series of bad mistakes</h2></p><p><b>We did not have cost alerts on Google Cloud</b>. Before this situation occurred, we were paying at most $300 a month.</p><p>We were also not regularly checking the situation as it just worked.</p><p>We noticed it because my credit card started to block the transaction due to limits I had set on it (lucky me!).</p><figure><p><img loading="lazy" decoding="async" alt="Image without caption" src="https://image-forwarder.notaku.so/aHR0cHM6Ly93d3cubm90aW9uLnNvL2ltYWdlL2h0dHBzJTNBJTJGJTJGczMtdXMtd2VzdC0yLmFtYXpvbmF3cy5jb20lMkZzZWN1cmUubm90aW9uLXN0YXRpYy5jb20lMkYxMWRhNDI1YS05YWU0LTRiZTgtOGIzNi1hMzc3MmQwOTdjMTElMkZVbnRpdGxlZC5wbmc_dGFibGU9YmxvY2smc3BhY2VJZD1iYTMzYWM4NC1mN2VjLTQwZDMtODU0MS0wNDMyODI5YzBkNDgmaWQ9NmE3M2JhYzgtZWMwYi00ZmJiLWJjOTctNzEyYjk4NDM3YmM4JmNhY2hlPXYyJndpZHRoPTI0MDA="/></p><div></div></figure><p><h2 id="1bf63d5f09bb48f9a25dc3820bb49e03">Consequences for the users</h2></p><p>It was not only bad for us but even worse for some of the users.</p><p>As mentioned, the app was generating so much traffic. <b>It means it was their machine generating network traffic on their home router and their internet provider.</b></p><p>One of our users, who lived in a house, had their internet provider cancel their contract due to enormous traffic generated during a month. It was extremely problematic as there was no other internet provider available around.</p><p>We decided to take responsibility and offer to cover all the costs related to this situation.</p><p>Luckily, it was not needed as the person could figure out the situation with the provider without bigger problems.</p><p>That was, however, quite a terrible experience for that person and me. As a designer, I value the experience product I create provides to the users. And this was not even a bad experience; it was actually harmful.</p><p><h2 id="cba99c00ddec4d4890f45cf68e515c40">Summarising</h2></p><ul><li><b>Set alerts</b> on your cloud at all times.</li></ul><ul><li>Write your auto-updater code very carefully.</li></ul><ul><li>Actually, <b>write any code that has the potential to generate costs carefully</b>.</li></ul><ul><li>Add special signals you can change on your server, which the app will understand, such as a <b>forced update</b> that will install without asking the user.</li></ul><ul><li>Regularly check your cloud.</li></ul></div></div>
  </body>
</html>
