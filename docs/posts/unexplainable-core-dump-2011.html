<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://stackoverflow.com/questions/4703844/unexplainable-core-dump">Original</a>
    <h1>“Unexplainable” core dump (2011)</h1>
    
    <div id="readability-page-1" class="page"><div>

        

            
            <div>
                    <p><span>Asked</span>
                        <time itemprop="dateCreated" datetime="2011-01-16T04:42:17">11 years, 11 months ago</time>
                    </p>
                    
                    <p><span>Viewed</span>
                        12k times
                    </p>
            </div>
            <div id="mainbar" role="main" aria-label="question and answers">

                
<div data-questionid="4703844" data-position-on-page="0" data-score="48" id="question">
    


    <div>
        

        

<div>
    
    <div itemprop="text">
                
<p>I&#39;ve seen many core dumps in my life, but this one has me stumped.</p>

<p>Context:</p>

<ul>
<li>multi-threaded Linux/x86_64 program running on a cluster of <a href="http://en.wikipedia.org/wiki/AMD_K10">AMD Barcelona</a> CPUs</li>
<li>the code that crashes is executed a <em>lot</em></li>
<li>running 1000 instances of the program (the exact same optimized binary) under load produces 1-2 crashes per hour</li>
<li>the crashes happen on different machines (but the machines themselves are pretty identical)</li>
<li>the crashes all look the same (same exact address, same call stack)</li>
</ul>

<p>Here are the details of the crash:</p>

<pre><code>Program terminated with signal 11, Segmentation fault.
#0  0x00000000017bd9fd in Foo()
(gdb) x/i $pc
=&gt; 0x17bd9fd &lt;_Z3Foov+349&gt;: rex.RB orb $0x8d,(%r15)

(gdb) x/6i $pc-12
0x17bd9f1 &lt;_Z3Foov+337&gt;:    mov    (%rbx),%eax
0x17bd9f3 &lt;_Z3Foov+339&gt;:    mov    %rbx,%rdi
0x17bd9f6 &lt;_Z3Foov+342&gt;:    callq  *0x70(%rax)
0x17bd9f9 &lt;_Z3Foov+345&gt;:    cmp    %eax,%r12d
0x17bd9fc &lt;_Z3Foov+348&gt;:    mov    %eax,-0x80(%rbp)
0x17bd9ff &lt;_Z3Foov+351&gt;:    jge    0x17bd97e &lt;_Z3Foov+222&gt;
</code></pre>

<p>You&#39;ll notice that the crash happened in the <em>middle</em> of instruction at <code>0x17bd9fc</code>, which is after return from a call at <code>0x17bd9f6</code> to a virtual function.</p>

<p>When I examine the virtual table, I see that it is not corrupted in any way:</p>

<pre><code>(gdb) x/a $rbx
0x2ab094951f80: 0x3f8c550 &lt;_ZTI4Foo1+16&gt;
(gdb) x/a 0x3f8c550+0x70
0x3f8c5c0 &lt;_ZTI4Foo1+128&gt;:  0x2d3d7b0 &lt;_ZN4Foo13GetEv&gt;
</code></pre>

<p>and that it points to this trivial function (as expected by looking at the source):</p>

<pre><code>(gdb) disas 0x2d3d7b0
Dump of assembler code for function _ZN4Foo13GetEv:
   0x0000000002d3d7b0 &lt;+0&gt;: push   %rbp
   0x0000000002d3d7b1 &lt;+1&gt;: mov    0x70(%rdi),%eax
   0x0000000002d3d7b4 &lt;+4&gt;: mov    %rsp,%rbp
   0x0000000002d3d7b7 &lt;+7&gt;: leaveq 
   0x0000000002d3d7b8 &lt;+8&gt;: retq   
End of assembler dump.
</code></pre>

<p>Further, when I look at the return address that <code>Foo1::Get()</code> should have returned to:</p>

<pre><code>(gdb) x/a $rsp-8
0x2afa55602048: 0x17bd9f9 &lt;_Z3Foov+345&gt;
</code></pre>

<p>I see that it points to the right instruction, so it&#39;s as if during the return from <code>Foo1::Get()</code>, some gremlin came along and incremented <code>%rip</code> by 4.</p>

<p>Plausible explanations?</p>
    </div>

        

    <div>
        <div>
            

            <div>
                <div>
    <p>
        asked <span title="2011-01-16 04:42:17Z">Jan 16, 2011 at 4:42</span>
    </p>
    <div>
        <a href="http://piratefsh.github.io/users/50617/employed-russian"><p><img src="https://i.stack.imgur.com/YFykQ.png?s=64&amp;g=1" alt="Employed Russian&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    <div itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <p><a href="http://piratefsh.github.io/users/50617/employed-russian">Employed Russian</a><span itemprop="name">Employed Russian</span></p><p><span title="reputation score 190,460" dir="ltr">190k</span><span title="31 gold badges" aria-hidden="true"><span></span><span>31</span></span><span>31 gold badges</span><span title="285 silver badges" aria-hidden="true"><span></span><span>285</span></span><span>285 silver badges</span><span title="348 bronze badges" aria-hidden="true"><span></span><span>348</span></span><span>348 bronze badges</span>
        </p>
    </div>
</div>


            </div>
        </div>
    </div>
    
</div>




            <p><span itemprop="commentCount">2</span></p>
    </div>

</div>




                <div id="answers">
                    


                                        
<div id="answer-15854827" data-answerid="15854827" data-parentid="4703844" data-score="60" data-position-on-page="1" data-highest-scored="1" data-question-has-accepted-highest-score="1" itemprop="acceptedAnswer" itemscope="" itemtype="https://schema.org/Answer">
    <div>
        

        

<div>
    
    <div itemprop="text">
<p>So, unlikely as it may seem, we appear to have hit an actual bona-fide CPU bug.</p>
<p><a href="https://web.archive.org/web/20130228081435/http://support.amd.com/us/Processor_TechDocs/41322_10h_Rev_Gd.pdf" rel="noreferrer">https://web.archive.org/web/20130228081435/http://support.amd.com/us/Processor_TechDocs/41322_10h_Rev_Gd.pdf</a> has erratum #721:</p>
<blockquote>
<h2>721 Processor May Incorrectly Update Stack Pointer</h2>
<h3>Description</h3>
<p>Under a highly specific and detailed set of internal timing conditions, the processor may incorrectly update the stack pointer after a long series of push and/or near-call instructions, or a long series of pop and/or near-return instructions. The processor must be in 64-bit mode for this erratum to occur.</p>
<h3>Potential Effect on System</h3>
<p>The stack pointer value jumps by a value of approximately 1024, either in the positive or negative direction. This incorrect stack pointer causes unpredictable program or system behavior, usually observed as a program exception or crash (for example, a #GP or #UD).</p>
<h3>Suggested Workaround</h3>
<p>System software may set MSRC001_1029[0] = 1b.</p>
</blockquote>
    </div>
    <div>
        <div>
            
            <div>
<div>
    
    <div>
        <a href="http://piratefsh.github.io/users/3840170/user3840170"><p><img src="https://i.stack.imgur.com/L9NB3.png?s=64&amp;g=1" alt="user3840170&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    <div>
        <p><a href="http://piratefsh.github.io/users/3840170/user3840170">user3840170</a></p><p><span title="reputation score 25,507" dir="ltr">25.5k</span><span title="3 gold badges" aria-hidden="true"><span></span><span>3</span></span><span>3 gold badges</span><span title="26 silver badges" aria-hidden="true"><span></span><span>26</span></span><span>26 silver badges</span><span title="58 bronze badges" aria-hidden="true"><span></span><span>58</span></span><span>58 bronze badges</span>
        </p>
    </div>
</div>
            </div>


            <div>
                <div>
    <p>
        answered <span title="2013-04-06 18:59:57Z">Apr 6, 2013 at 18:59</span>
    </p>
    <div>
        <a href="http://piratefsh.github.io/users/50617/employed-russian"><p><img src="https://i.stack.imgur.com/YFykQ.png?s=64&amp;g=1" alt="Employed Russian&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    <div itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <p><a href="http://piratefsh.github.io/users/50617/employed-russian">Employed Russian</a><span itemprop="name">Employed Russian</span></p><p><span title="reputation score 190,460" dir="ltr">190k</span><span title="31 gold badges" aria-hidden="true"><span></span><span>31</span></span><span>31 gold badges</span><span title="285 silver badges" aria-hidden="true"><span></span><span>285</span></span><span>285 silver badges</span><span title="348 bronze badges" aria-hidden="true"><span></span><span>348</span></span><span>348 bronze badges</span>
        </p>
    </div>
</div>


            </div>
        </div>
        
    
    </div>
    
</div>




            <p><span itemprop="commentCount">3</span></p>
    </div>
</div>


                                        
<div id="answer-4703887" data-answerid="4703887" data-parentid="4703844" data-score="7" data-position-on-page="2" data-highest-scored="0" data-question-has-accepted-highest-score="1" itemprop="suggestedAnswer" itemscope="" itemtype="https://schema.org/Answer">
    <div>
        

        

<div>
    
    <div itemprop="text">
<p>I&#39;ve once seen an &#34;illegal opcode&#34; crash right in the middle of an instruction. I was working on a Linux port. Long story short, Linux subtracts from the instruction pointer in order to restart a syscall, and in my case this was happening twice (if two signals arrived at the same time).</p>

<p>So that&#39;s one possible culprit: the kernel fiddling with your instruction pointer. There may be some other cause in your case.</p>

<p>Bear in mind that sometimes the processor will understand the data it&#39;s processing as an instruction, even when it&#39;s not supposed to be. So the processor may have executed the &#34;instruction&#34; at 0x17bd9fa and then moved on to 0x17bd9fd and then generated an illegal opcode exception. (I just made that number up, but experimenting with a disassembler can show you where the processor might have &#34;entered&#34; the instruction stream.)</p>

<p>Happy debugging!</p>
    </div>
    <div>
        <div>
            


            <div>
                <div>
    <p>
        answered <span title="2011-01-16 04:56:16Z">Jan 16, 2011 at 4:56</span>
    </p>
    <div>
        <a href="http://piratefsh.github.io/users/31945/artelius"><p><img src="https://www.gravatar.com/avatar/b53d0faa0590f1146851b2a3959d2e95?s=64&amp;d=identicon&amp;r=PG" alt="Artelius&#39;s user avatar" width="32" height="32"/></p></a>
    </div>
    
</div>


            </div>
        </div>
        
    
    </div>
    
</div>




            <p><span itemprop="commentCount">2</span></p>
    </div>
</div>


                        


                            <h2 data-loc="1">
                                
                            </h2>
                </div>
            </div>

                


    </div></div>
  </body>
</html>
