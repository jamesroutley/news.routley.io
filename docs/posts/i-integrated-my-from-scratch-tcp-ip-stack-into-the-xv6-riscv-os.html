<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/pandax381/xv6-riscv-net">Original</a>
    <h1>Show HN: I integrated my from-scratch TCP/IP stack into the xv6-riscv OS</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">This project integrates a TCP/IP protocol stack into the <a href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a> operating system, enabling network capabilities.</p>
<p dir="auto">Key Components:</p>
<ul dir="auto">
<li>
<p dir="auto"><strong>TCP/IP Stack</strong>: A kernel-space port of <a href="https://github.com/pandax381/microps">microps</a>, a user-mode TCP/IP stack that I am also developing.</p>
</li>
<li>
<p dir="auto"><strong>Network Driver</strong>: A virtio-net driver for network device emulation in QEMU.</p>
</li>
<li>
<p dir="auto"><strong>Socket API</strong>: A standard socket interface for network applications.</p>
</li>
<li>
<p dir="auto"><strong>Network Configuration</strong>: A simple <code>ifconfig</code> command for basic network settings.</p>
</li>
</ul>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/pandax381/xv6-riscv-net/blob/networking/doc/screenshot.png"><img src="https://github.com/pandax381/xv6-riscv-net/raw/networking/doc/screenshot.png" alt="screenshot"/></a></p>


<p dir="auto">Clone the repository and use the <code>make qemu</code> command.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ git clone https://github.com/pandax381/xv6-riscv-net
$ cd xv6-riscv-net
$ make qemu"><pre>$ git clone https://github.com/pandax381/xv6-riscv-net
$ <span>cd</span> xv6-riscv-net
$ make qemu</pre></div>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">This command will build the project and launch QEMU. On the first run, it will also create a TAP network device named <code>tap0</code> on your host machine and assign it the IP address <code>192.0.2.1/24</code>. This enables network communication between the xv6 guest and the host.</p>
</div>
<div dir="auto"><h3 tabindex="-1" dir="auto">2. Network Configuration in xv6</h3><a id="user-content-2-network-configuration-in-xv6" aria-label="Permalink: 2. Network Configuration in xv6" href="#2-network-configuration-in-xv6"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Once xv6 has booted, use the <code>ifconfig</code> command to configure the <code>net0</code> network interface. We&#39;ll assign it the IP address <code>192.0.2.2</code>, as the host is using <code>192.0.2.1</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ ifconfig net0 192.0.2.2 netmask 255.255.255.0"><pre>$ ifconfig net0 192.0.2.2 netmask 255.255.255.0</pre></div>
<p dir="auto">After setting the IP address, run the <code>ifconfig</code> command again to verify that the network settings have been applied.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ ifconfig
net0: flags=93&lt;UP|BROADCAST|RUNNING|NEEDARP&gt; mtu 1500
        ether 52:54:00:12:34:56
        inet 192.0.2.2 netmask 255.255.255.0 broadcast 192.0.2.255"><pre>$ ifconfig
net0: flags=<span>93&lt;</span>UP<span>|</span>BROADCAST<span>|</span>RUNNING<span>|</span>NEEDARP<span>&gt;</span> mtu 1500
        ether 52:54:00:12:34:56
        inet 192.0.2.2 netmask 255.255.255.0 broadcast 192.0.2.255</pre></div>
<p dir="auto">The setup is now complete. You can verify the communication by pinging the xv6 guest from a terminal on your host machine.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ ping 192.0.2.2
PING 192.0.2.2 (192.0.2.2) 56(84) bytes of data.
64 bytes from 192.0.2.2: icmp_seq=1 ttl=255 time=0.444 ms
..."><pre>$ ping 192.0.2.2
PING 192.0.2.2 (192.0.2.2) 56(84) bytes of data.
64 bytes from 192.0.2.2: icmp_seq=1 ttl=255 time=0.444 ms
...</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">3. Running the Sample Programs</h3><a id="user-content-3-running-the-sample-programs" aria-label="Permalink: 3. Running the Sample Programs" href="#3-running-the-sample-programs"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This project includes <code>tcpecho</code> and <code>udpecho</code> as sample user-level applications to demonstrate the network stack. Here is how to test the TCP echo server.</p>
<p dir="auto">In the xv6 shell, run the <code>tcpecho</code> command. It will start a server listening on port <code>7</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ tcpecho
Starting TCP Echo Server
socket: success, soc=3
bind: success, self=0.0.0.0:7
waiting for connection..."><pre>$ tcpecho
Starting TCP Echo Server
socket: success, soc=3
bind: success, self=0.0.0.0:7
waiting <span>for</span> connection...</pre></div>
<p dir="auto">Open a new terminal on your host machine and use <code>nc</code> (netcat) to connect to the tcpecho server running inside QEMU.</p>

<p dir="auto">Once the connection succeeds, type any message into the <code>nc</code> terminal and press Enter. The message will be sent to the xv6 <code>tcpecho</code> server, which will then echo it back to your terminal.</p>
<div data-snippet-clipboard-copy-content="Connection to 192.0.2.2 7 port [tcp/echo] succeeded!
hoge
hoge
fuga
fuga"><pre><code>Connection to 192.0.2.2 7 port [tcp/echo] succeeded!
hoge
hoge
fuga
fuga
</code></pre></div>
<p dir="auto">On the xv6 guest, <code>tcpecho</code> will output messages like the following after a connection is established and data is received:</p>
<div data-snippet-clipboard-copy-content="accept: success, peer=192.0.2.1:33680
recv: 5 bytes data received
&gt; hoge
recv: 5 bytes data received
&gt; fuga"><pre><code>accept: success, peer=192.0.2.1:33680
recv: 5 bytes data received
&gt; hoge
recv: 5 bytes data received
&gt; fuga
</code></pre></div>

<p dir="auto">xv6-riscv: Under the MIT License. See <a href="https://github.com/pandax381/xv6-riscv-net/blob/networking/LICENSE">LICENSE</a> file.</p>
<p dir="auto">Additional code: Under the MIT License.</p>
</article></div></div>
  </body>
</html>
