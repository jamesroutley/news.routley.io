<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.brixit.nl/dont-pick-weird-subnets-for-embedded-networks/">Original</a>
    <h1>Don&#39;t pick weird subnets for embedded networks, use VRFs</h1>
    
    <div id="readability-page-1" class="page"><section>
                <div>
                    <p>So what is an embedded network? I found it pretty hard to find a good name for this but I&#39;ve come across them many times and created some myself. A good example here is a portable video rack. You drag a rack case around with video and network equipment and you need to connect it to the network of the venue to stream to the internet. The devices in the rack need to communicate with each other but you don&#39;t want to reconfigure their addresses every time you move to another venue because it happens to use another subnet.</p>

<p>The solution to this is easy! Just add a small router in the rack so you have a consistent subnet inside the rack and the NAT isolates you from the changing IP addresses outside your small network. Your rack has <code>10.0.0.0/24</code> addresses because they are easy to remember and the router gets an IP from the venue using DHCP.</p>

<p>This works perfectly fine until the public network in the venue also is on a <code>10.0.0.0/24</code> network. The router suddenly has the same subnet on both interfaces and addresses in your rack start conflicting with other hardware in the venue.</p>

<p>This is the point where I see people often picking weird subnets for portable equipment. &#34;What are the chances the venue has <code>172.16.42.0/24</code>?, or <code>10.11.12.0/24</code>&#34;? And sure this works, until you get a conflict on those because humans are simply not that great at picking random numbers. It is not actually neccesary to have network seperation by random chance, you just need router features beyond common consumer routers.</p>

<h2>The IPv6 solution</h2>

<p>The most official solution for this is IPv6 of course. If your private network has IPv6 internally you can just address every device by  it&#39;s link local address. Due to having a router splitting the network segment between your rack and the public network you know that all the link local addresses are always your own devices.</p>

<p>You don&#39;t even need to have a DHCP server in your local net anymore. Every IPv6 device just gets it&#39;s own <code>fe80::</code> address and you&#39;d use network discovery protocols to find the address of the device to talk to. For example avahi can be used to have name resolution for these addresses.</p>

<p>In this case the router should send out route advertisements so the devices still get internet connectivity without configuring any addresses. This basically causes the devices in the rack to set the link local address of the router as the gateway address.</p>

<p>The massive problem with this solution is that support for IPv6 on devices that are not general-purpose computers is usually non-existent. I have a portable rack right here with a Behringer X-Air audio mixer in it and this is just modern enough to allow you to use DHCP to get an address, no IPv6 support in here whatsoever. If I grab a random video mixer here it will most likely also not support IPv6, some of them don&#39;t even do DHCP yet.</p>

<p>Technically the same solution is also possible on an IPv4 network. You&#39;ve probably encountered it before: Getting an <code>169.254.0.0/16</code> address on your computer when you selected DHCP but the network did not have DHCP server running. This is an <a href="https://wiki.wireshark.org/APIPA">APIPA</a> address and is the IPv4 equivalent of an <code>fe80::</code> IPv6 address. Sadly this doesn&#39;t work that well for this though since with APIPA networking there is no way to have a gateway so you&#39;ll never have internet connectivity. Also if your machine does get a valid IP address so you can connect to the internet the APIPA address will normally be dropped on that interface since it&#39;s no longer needed. And just like IPv6 support in embedded hardware, it&#39;s most likely not implemented.</p>

<p>A neat trick if you are dealing with an IPv6 network though for finding the addresses of the hosts in your segment:</p>

<div><pre><span></span><span>$ </span>ping<span> </span>-c<span> </span><span>2</span><span> </span>-I<span> </span>enp3s0<span> </span>ff02::1
<span>... responses from multiple devices here ...</span>
<span>$ </span>ip<span> </span>-6<span> </span>neigh<span> </span>show<span> </span>dev<span> </span>enp3s0
<span>fe80::cc55:13ff:fe9b:82a2 lladdr ce:55:13:9b:82:a2 REACHABLE </span>
<span>fe80::df8c:9c93:6850:7132 lladdr b0:35:9f:5a:b2:49 REACHABLE </span>
<span>fe80::ac2b:55ff:fe62:a34 lladdr ae:2b:55:63:0a:34 REACHABLE </span>
<span>fe80::a0b8:78ff:fe5c:8229 lladdr a2:b8:78:5a:82:29 REACHABLE </span>
<span>fe80::5660:9ff:fee1:cb4b lladdr 54:60:09:e1:cb:4b REACHABLE </span>
<span>fe80::f61e:57ff:fe61:9a58 lladdr f4:1e:57:91:9a:58 router REACHABLE</span>
</pre></div>


<p>This sends a broadcast ping to your local segment and then you can read out the list of neighbors known on that interface, which also conveniently tells you which device is advertising routes. The <code>ff02::1</code> is one of the &#34;notable ipv6 multicast addresses&#34; for which there&#39;s a <a href="https://en.wikipedia.org/wiki/Multicast_address#Notable_IPv6_multicast_addresses">convenient list</a> on Wikipedia.</p>

<h2>A more generic solution</h2>

<p>So instead of having more exotic addressing inside your embedded network there&#39;s also a solution that contains all the weirdness to only the router. It is possible to configure a router so that both networks it connects to have the same subnet by having separate routing tables for the interfaces.</p>

<p>This means your internal network can be <code>10.0.0.0/24</code> and the venue network can be <code>10.0.0.0/24</code> and it all just works. The video mixer in the rack can have the <code>10.0.0.4</code> address and there can be a <code>10.0.0.4</code> address in the venue network and nothing will conflict. This comes with a tradeoff of course and in this case is that you no longer can reach devices on the venue network, which shouldn&#39;t be a problem if you&#39;re only connected there for internet connectivity.</p>

<p>The magic solution here is <a href="https://en.wikipedia.org/wiki/Virtual_routing_and_forwarding">VRFs</a>. Normally the router has a single routing table that defines where traffic is supposed to go to based on the destination address. The routing table is the main issue in this situation because having the same subnets on the inside and outside would mean you just have two routes in the table saying <code>10.0.0.0/24</code> should go to the LAN interface and the WAN interface</p>

<pre><code>$ ip route
default via 10.0.0.1 dev enp1s0 proto dhcp src 10.0.0.33 metric 100
10.0.0.0/24 dev enp1s0 proto kernel scope link src 10.0.0.33 metric 100
10.0.0.0/24 dev enp2s0 proto kernel scope link src 10.0.0.254 metric 100</code></pre>

<p>This is basically  telling the router that the same <code>10.0.0.0/24</code> network is reachable over both interfaces. The only way to tell the kernel that these are actually seperate is by having a VRF here.</p>

<p>With a VRF you can have a completely isolated routing table which you can link to your network interfaces. Traffic from those interfaces are now matched to that table instead of the main one for the routing decisions.</p>

<p>For my test setup I&#39;ve used a Mikrotik device since it allows me to configure VRFs as I didn&#39;t have a Linux box with enough interfaces on it to make an easy test setup. But this also shows that this setup isn&#39;t so esoteric that you need to have a full PC doing the routing for it. I&#39;m using a Mikrotik hAP mini which is a $15 3-port router which is probably the cheapest device available that just has this feature available. For testing I have the WAN port (ether1) connected to my home network and the other two ports are connected to laptops which are supposed to communicate together but still be isolated from my home network.</p>

<p>The basic config is already set on this device making it do NAT between the two LAN ports and the WAN port so the only thing I need to do is break it by setting the internal subnet to the same one as my home network and then configuring the VRF related things to make it actually route properly. </p>

<div><pre><span></span><span># bridge-internal has the two ports for the internal devices</span>
<span>/</span><span>interface</span><span> </span><span>bridge</span>
<span>add</span><span> </span><span>name</span><span>=</span><span>bridge</span><span>-</span><span>internal</span>
<span>/</span><span>interface</span><span> </span><span>bridge</span><span> </span><span>port</span>
<span>add</span><span> </span><span>bridge</span><span>=</span><span>bridge</span><span>-</span><span>internal</span><span> </span><span>interface</span><span>=</span><span>ether</span><span>2</span>
<span>add</span><span> </span><span>bridge</span><span>=</span><span>bridge</span><span>-</span><span>internal</span><span> </span><span>interface</span><span>=</span><span>ether</span><span>3</span>

<span># Give the router an address on the internal network</span>
<span>/</span><span>ip</span><span> </span><span>address</span>
<span>add</span><span> </span><span>address</span><span>=</span><span>10</span><span>.</span><span>0</span><span>.</span><span>0</span><span>.</span><span>1</span><span>/</span><span>24</span><span> </span><span>interface</span><span>=</span><span>bridge</span><span>-</span><span>internal</span>

<span># Get an address for the WAN interface by DHCP</span>
<span>/</span><span>ip</span><span> </span><span>dhcp</span><span>-</span><span>client</span>
<span>add</span><span> </span><span>interface</span><span>=</span><span>ether</span><span>1</span>

<span># Create the rack vrf for the bridge</span>
<span>/</span><span>ip</span><span> </span><span>vrf</span>
<span>add</span><span> </span><span>interfaces</span><span>=</span><span>bridge</span><span>-</span><span>internal</span><span> </span><span>name</span><span>=</span><span>rack</span>

<span># In the rack VRF tell it the default gateway is on the main VRF at the</span>
<span># 10.0.0.254 address. The gateway IP _can_ be the same as the 10.0.0.1 one</span>
<span># used for this router but kept seperate here to make the config easier to</span>
<span># understand</span>
<span>/</span><span>ip</span><span> </span><span>route</span>
<span>add</span><span> </span><span>gateway</span><span>=</span><span>10</span><span>.</span><span>0</span><span>.</span><span>0</span><span>.</span><span>254</span><span>@</span><span>main</span><span> </span><span>routing</span><span>-</span><span>table</span><span>=</span><span>rack</span>

<span># The iptables rule for regular &#39;ol NAT for all traffic going out the WAN port</span>
<span>/</span><span>ip</span><span> </span><span>firewall</span><span> </span><span>nat</span>
<span>add</span><span> </span><span>action</span><span>=</span><span>masquerade</span><span> </span><span>chain</span><span>=</span><span>srcnat</span><span> </span><span>out</span><span>-</span><span>interface</span><span>=</span><span>ether</span><span>1</span>

<span># Use connection tracking to mark traffic from the internal VRF so the return</span>
<span># traffic can be delivered in the same VRF. The first rule gives the</span>
<span># connection the &#34;rack&#34; mark in the connection tracking table. The second</span>
<span># rule matches traffic from the WAN port that match a connection that has the</span>
<span># &#34;rack&#34; mark and then set the routing table to use to &#34;rack&#34; which is</span>
<span># the VRF. This is in the prerouting chain so these rules are executed</span>
<span># before anything with the routing tables are done.</span>
<span>/</span><span>ip</span><span> </span><span>firewall</span><span> </span><span>mangle</span>
<span>add</span><span> </span><span>action</span><span>=</span><span>mark</span><span>-</span><span>connection</span><span> </span><span>chain</span><span>=</span><span>prerouting</span><span> </span><span>connection</span><span>-</span><span>state</span><span>=</span><span>new</span><span> </span><span>in</span><span>-</span><span>interface</span><span>=</span><span>bridge</span><span>-</span><span>internal</span><span> </span><span>new</span><span>-</span><span>connection</span><span>-</span><span>mark</span><span>=</span><span>rack</span>
<span>add</span><span> </span><span>action</span><span>=</span><span>mark</span><span>-</span><span>routing</span><span> </span><span>chain</span><span>=</span><span>prerouting</span><span> </span><span>connection</span><span>-</span><span>mark</span><span>=</span><span>rack</span><span> </span><span>in</span><span>-</span><span>interface</span><span>=</span><span>ether</span><span>1</span><span> </span><span>new</span><span>-</span><span>routing</span><span>-</span><span>mark</span><span>=</span><span>rack</span>
</pre></div>


<p>And that&#39;s all that&#39;s needed. Traffic that&#39;s handled by the rack VRF get&#39;s delivered on the interfaces linked to that VRF. The traffic for the main routing table goes out the WAN port.</p>

<p>To make traffic destined for the internet cross the barrier between routing tables a route is added in the rack VRF that sends traffic destined to the internet to the default gateway address in the main routing table. Which will run it through the firewall rules and apply the standard NAT rule that rewrites the source address to the one of the router. There is also a connection mark added in the connection tracker that tells iptables that this connection was originated from the rack VRF.</p>

<p>When a packet returns from the internet the iptables connection tracker will match it up to the connection that has the connection-mark set on it. This will trigger the other mangle rule that will make sure that this packed is proccessed by the rack VRF so it gets sent back to the device in the rack that started the connection.</p>

<p>This all together allows the devices in the rack to have internet connectivity just like it&#39;s a regular NATted connection. It is impossible  to reach other devices in my home network through it though because the routing table for the rack will just send traffic destined for <code>10.0.0.0/24</code> back out the same interface instead of the WAN port. The same thing happens when a device on my home network tries to use the router as a gateway to reach a device in the rack.</p>

<p>These few rules configured on the router will allow you to use your favorite subnet inside the rack without any worry about conflicts. I&#39;ve seen the regular NAT setups in this situation for portable live production gear, for industrial monitoring gear and have once set this up for an ancient CNC machine that did not allow changing the subnet address.</p>

<p>With a few translations this should also apply to apply to the VRF commands in Linux routers and I assume VRFs are also exposed on other major router brands</p>


                </div>
            </section></div>
  </body>
</html>
