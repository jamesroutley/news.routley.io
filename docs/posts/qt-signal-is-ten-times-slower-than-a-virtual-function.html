<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://developernote.com/2022/08/qt-signal-is-ten-times-slower-than-a-virtual-function/">Original</a>
    <h1>Qt signal is ten times slower than a virtual function</h1>
    
    <div id="readability-page-1" class="page"><div id="wrapper">
	<!-- #header -->
	<div id="main">
			<!-- #menu -->
		<div id="container">
			<div id="content" role="main">
							
					<div id="post-8788">
						
						
						<!-- .entry-meta -->
				<div>
				
<p>I defined a QT Object that contains an integer value and uses QT signal along with <code>awl::Observable</code> based on virtual functions to notify the subscribers when the value changes:</p>


<div><pre title="">#include &#34;Awl/Observable.h&#34;

#include &lt;QObject&gt;

namespace test
{
    class NotifyValueChanged
    {
    public:

        virtual void onValueChanged() = 0;
    };
    
    class ValueObject : 
        public QObject,
        public awl::Observable&lt;NotifyValueChanged&gt;
    {
        Q_OBJECT

    public:

        Q_PROPERTY(int value READ value WRITE setValue NOTIFY valueChanged)

        void notifyValueChanged()
        {
            Notify(&amp;NotifyValueChanged::onValueChanged);
        }

    signals:

        void valueChanged();

</pre></div>


<div><pre title="">    private:

        int value() const
        {
            return m_val;
        }

        void setValue(int val)
        {
            if (m_val != val)
            {
                m_val = val;

                emit valueChanged();
            }
        }

        int m_val = 0;
    };
}
</pre></div>


<p>Then I defined the subscriber (or observer) object:</p>


<div><pre title="">namespace test
{
    class ObserverObject : 
        public QObject,
        public awl::Observer&lt;NotifyValueChanged&gt;
    {
        Q_OBJECT

    public:

        void onValueChanged() override
        {
            ++m_count;
        }

        void onValueChangedSignal()
        {
            ++m_count;
        }

        std::size_t count() const
        {
            return m_count;
        }

    private:

        std::size_t m_count = 0;
    };
}
</pre></div>


<p>Then I created 1000 observers and notified them 100000 times with both mechanisms:</p>


<div><pre title="">using namespace test;

QTIL_UNIT_TEST(SignalTest)
{
    QTIL_ATTRIBUTE(size_t, observer_count, 1000);
    QTIL_ATTRIBUTE(size_t, emit_count, 100000);

    {
        ValueObject object;

        std::vector&lt;ObserverObject&gt; observers(observer_count);
        
        for (ObserverObject&amp; observer : observers)
        {
            QObject::connect(&amp;object, &amp;ValueObject::valueChanged, &amp;observer, &amp;ObserverObject::onValueChangedSignal, Qt::DirectConnection);
        }

        {
            awl::StopWatch sw;

            for (size_t i = 0; i &lt; emit_count; ++i)
            {
                emit object.valueChanged();
            }

            context.logger.debug(qtil::Format() &lt;&lt; &#34;QT signal: &#34; &lt;&lt; sw);
        }

        for (ObserverObject&amp; observer : observers)
        {
            AWT_ASSERT(observer.count() == emit_count);
        }
    }

    {
        ValueObject object;

        std::vector&lt;ObserverObject&gt; observers(observer_count);

        for (ObserverObject&amp; observer : observers)
        {
            object.Subscribe(&amp;observer);
        }

        {
            awl::StopWatch sw;

            for (size_t i = 0; i &lt; emit_count; ++i)
            {
                emit object.notifyValueChanged();
            }

            context.logger.debug(qtil::Format() &lt;&lt; &#34;Virtual function: &#34; &lt;&lt; sw);
        }
        for (ObserverObject&amp; observer : observers)
        {
            AWT_ASSERT(observer.count() == emit_count);
        }
    }
}
</pre></div>


<p>If I compile this code with MSVC2022 Compiler Version 19.32.31332 for Windows 64bit and repeat the test ten times I get the following output:</p>


<div><pre title="">QT signal: 00:00:01.841
Virtual function: 00:00:00.179

QT signal: 00:00:01.782
Virtual function: 00:00:00.185

QT signal: 00:00:01.761
Virtual function: 00:00:00.181

QT signal: 00:00:01.739
Virtual function: 00:00:00.187

QT signal: 00:00:01.752
Virtual function: 00:00:00.183

QT signal: 00:00:01.714
Virtual function: 00:00:00.179

QT signal: 00:00:01.715
Virtual function: 00:00:00.174

QT signal: 00:00:01.721
Virtual function: 00:00:00.173

QT signal: 00:00:01.726
Virtual function: 00:00:00.179

QT signal: 00:00:01.690
Virtual function: 00:00:00.175
</pre></div>


<p>MSVC Performance profiler displays this:</p>



<figure><a href="https://developernote.com/wp-content/uploads/2022/08/image-6.png"><img width="846" height="350" src="https://developernote.com/wp-content/uploads/2022/08/image-6.png" alt=""/></a></figure>



<figure><a href="https://developernote.com/wp-content/uploads/2022/08/image-5.png"><img loading="lazy" width="1005" height="814" src="https://developernote.com/wp-content/uploads/2022/08/image-5.png" alt=""/></a></figure>



<p>If I access the <a href="https://developernote.com/2022/07/qobjectsender-is-a-slow-function/">sender</a> from <code>ObserverObject</code> as follows:</p>


<div><pre title="">        void onValueChangedSignal()
        {
            sender();

            ++m_count;
        }
</pre></div>


<p>QT signal becomes 16 time slower than the virtual function:</p>


<div><pre title="">QT signal: 00:00:03.060
Virtual function: 00:00:00.215

QT signal: 00:00:02.916
Virtual function: 00:00:00.181

QT signal: 00:00:02.945
Virtual function: 00:00:00.181

QT signal: 00:00:02.996
Virtual function: 00:00:00.187

QT signal: 00:00:03.031
Virtual function: 00:00:00.183

QT signal: 00:00:03.034
Virtual function: 00:00:00.185

QT signal: 00:00:03.011
Virtual function: 00:00:00.178

QT signal: 00:00:03.047
Virtual function: 00:00:00.187

QT signal: 00:00:03.071
Virtual function: 00:00:00.185

QT signal: 00:00:03.111
Virtual function: 00:00:00.186
</pre></div>


<p>Profiler displays this:</p>



<figure><a href="https://developernote.com/wp-content/uploads/2022/08/image-7.png"><img loading="lazy" width="792" height="387" src="https://developernote.com/wp-content/uploads/2022/08/image-7.png" alt=""/></a></figure>



<figure><a href="https://developernote.com/wp-content/uploads/2022/08/image-8.png"><img loading="lazy" width="722" height="312" src="https://developernote.com/wp-content/uploads/2022/08/image-8.png" alt=""/></a></figure>



<p>So per second I can call 558,659,217 virtual function, 59,171,597 signals without sender and 32,562,683 signals with sender (the formula for virtual functions is 1000 * 100000 * (1 / 0.179)). Assume I receive 100,000 trades per second from some crypo exchange and if one trade triggers 100 signals than I have 10.000.000 signals per second that is something comparable with the maximum.</p>
						</div><!-- .entry-content -->
								</div><!-- #post-## -->
				<!-- #comments -->
			</div><!-- #content -->
					</div><!-- #container -->
</div><!-- #main -->
<!-- #footer -->
</div></div>
  </body>
</html>
