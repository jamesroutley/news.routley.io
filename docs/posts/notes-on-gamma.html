<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://poniesandlight.co.uk/reflect/gamma/">Original</a>
    <h1>Notes on Gamma</h1>
    
    <div id="readability-page-1" class="page"><div>
    
  	<div><p>Gamma is a blight, a curse, and utterly annoying. Ever since somebody told me that RGB colours need to be Gamma corrected, RGB colours were spoilt for me. Gamma does to digital colour what <a href="https://xkcd.com/1015/">kerning</a> does to typography.</p>
<!--![xkcd 1015](https://imgs.xkcd.com/comics/kerning.png "You asked for it. (https://xkcd.com/1015/)")-->
<p>This post is an attempt to get even with Gamma.</p>
<h2 id="lost-innocence">Lost Innocence <a href="#lost-innocence"></a></h2>
<p>Because, you see, only once I became fully aware of Gamma, things really started to fall apart. In my pre-gamma-aware innocence, I must have done some things right.</p>
<p>Let me show what I mean:</p>
<p>Here, I generate a linear gradient using a GLSL fragment shader. Say, drawing a full-screen quad using this shader code snippet:</p>
<div><div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span>1
</span><span>2
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="glsl"><span><span><span>vec3</span> <span>color</span> <span>=</span> <span>vec3</span><span>(</span><span>uv</span><span>.</span><span>x</span><span>);</span>       <span>// increase brightness linearly with x-axis</span>
</span></span><span><span><span>outFragColor</span> <span>=</span> <span>vec4</span><span>(</span><span>color</span><span>,</span> <span>1</span><span>);</span> <span>// output to RGB swapchain image </span></span></span></code></pre></td></tr></tbody></table>
</div>
</div><p><span>glsl</span>
</p></div><p>And voila - a perceptually linear gradient.</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/gradient_linear_linear_swapchain.png" alt=" A perceptually linear gradient" title=" A perceptually linear gradient"/>
<figcaption>
    A perceptually linear gradient, innocently created
</figcaption>
</figure>
<p>But now, let’s get clever about this: We notice that we’re <em>actually</em> drawing to an sRGB monitor (most desktop monitors are, nowadays), so we should probably use an sRGB image for the swapchain (these are the most common <span>8bpc</span><span> (read: “bits per channel”) </span> swapchain image formats in Vulkan). Thus we somehow need to convert our RGB colours to sRGB. The most elegant way to do this is to use an image attachment with an sRGB format, which (at least in Vulkan) does the conversion automatically and precisely on texel save.</p>
<p>If we draw the same shader as before, but now into an sRGB swapchain the swapchain image’s non-linear rRGB encoding should correct the sRGB monitor gamma. The gradient’s brightness values (as measured by a brigthness meter) should now increase linearly on-screen. They do. That should look like a linear gradient, right?</p>
<p>Wrong.</p>
<p>Instead, we get this:</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/gradient_linear_srgb_swapchain.png" alt=" A linear gradient" title=" A linear gradient"/>
<figcaption>
    A perfectly ’linear’ gradient
</figcaption>
</figure>
<p>This doesn’t <em>look</em> linear: shades don’t seem to claim equal space. Instead, it looks as if dark shades are too bright, while bright shades wash out. Here’s what I’d expected to see:</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/gradient_non_linear_srgb_swapchain.png" alt=" A perceptually linear gradient" title=" A perceptually linear gradient"/>
<figcaption>
    A perceptually linear gradient
</figcaption>
</figure>
<p>The difference is subtle, but look at both gradients and ask yourself: which seems to have more detail? Which is more balanced?</p>
<p>Even though the first gradient <em>is</em> more linear in terms of physical brightness, the second one <em>looks</em> more linear.</p>
<p>I find this counter-intuitive. But where intuition fails, ratio may help; and there is indeed a rational explanation: Visual perception is non-linear.</p>
<h2 id="and-you-see-the-ones-in-darknessthose-in-brightness-drop-from-sight">And You See The Ones In Darkness/Those In Brightness Drop From Sight <a href="#and-you-see-the-ones-in-darknessthose-in-brightness-drop-from-sight"></a></h2>

</div>
<div>
  
<p>The human eye can distinguish more contrast detail in darker shades.</p>
<p>You don’t have to take my word for it; instead take those of Dr. Charles Poynton – the person <a href="https://poynton.ca/notes/misc/Poynton-square-pixels.html">who gave HDTV square pixels and the number 1080</a>. Here is a diagram of how our perception tends to respond to changes in lightness, which I found in his <a href="http://poynton.ca/PDFs/Poynton-2018-PhD.pdf">dissertation</a>:

</p><figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/poynton_2018_pg_17.png" alt="brightness perception" title="brightness perception"/>
<figcaption>
    CIE Lightness (<a href="http://poynton.ca/PDFs/Poynton-2018-PhD.pdf">Poynton 2018</a>, pg. 17). Note how perception biases up around darker shades. </figcaption>
</figure>
<p>This is fine. Nature. It probably helped our <a href="https://phys.org/news/2021-04-scientists-species-ancient-burrowing-mammal.html">ancestors</a> to survive or something. And it does explain why our physically linear gradient looked too bright in dark areas. Let’s draw a diagram:</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/srgb_uncorrected.svg" alt="A perceptually linear gradient" title="A perceptually linear gradient"/>
<figcaption>
    A linear gradient getting biased</figcaption>
</figure>
<h2 id="check-the-bias">Check the Bias <a href="#check-the-bias"></a></h2>
<p>Whenever we want to draw a perceptually linear gradient, we must remember to pay our dues to evolution, and factor in this perceptual bias.</p>
<p>If you want the <strong>appearance</strong> of a linear gradient, you must <strong>display a non-linear gradient</strong>, one that tunes down darker parts. Effectively, you want to apply the inverse of the non-linearity that is introduced by perception. Confusingly, this may be done automatically for you if you forget to do any gamma correction:</p>
<h2 id="two-penny-gamma-correction">Two-Penny Gamma Correction <a href="#two-penny-gamma-correction"></a></h2>
<p>If you have an sRGB monitor and you innocently <strong>don’t</strong> do any sRGB correction (by rendering into a linear RGB framebuffer such as <code>FORMAT_R8G8B8A8_UNORM</code> for example), linear gradient values will get <strong>biased by the monitor’s gamma response alone</strong> – the result will be a gradient that looks “about linear”.</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/rgb_uncorrected.svg" alt="A perceptually linear gradient" title="A perceptually linear gradient"/>
<figcaption>
    Our perceptually linear gradient, innocently created
</figcaption>
</figure>
<p>It looks “about linear” because what happens is that while the monitor will “gamma” the gradient, your eye will “de-gamma” the gradient again – and since these two non-linear effects on the signal (monitor, eye) are almost inverses of each other, we get a linear perceived signal at the end.</p>
<p>And here’s a cool thing: This was by design!</p>
</div>
<div>
	
<blockquote>
	<p><span>&#34;The nonlinearity of a CRT is very nearly the inverse of the lightness sensitivity of human vision. The nonlinearity causes a CRT’s response to be roughly perceptually uniform. Far from being a defect, this feature is highly desirable.&#34;</span>
	</p>
</blockquote>
<h2 id="why-is-this-desirable">Why is this desirable? <a href="#why-is-this-desirable"></a></h2>
<p>A big reason for encoding images in sRGB is that, because of sRGB’s perceptual nature, we get much better perceptual luminance contrast resolution out of 8bits per channel. Instead of wasting bits on high brightnesses where our eye has trouble noticing change, we spend most of the bit-budget where it counts: on darker shades.</p>

</div>
<div>
  
<p>sRGB is an elegant form of perceptual compression: images at 8-bits-per-channel and below (for reasons of encoding efficiency) <em>really want</em> to be encoded as sRGB.</p>
<p>And if the monitor can display these sRGB images directly and natively (because the hardware applies the inverse of the sRGB gamma transform) – that’s just a perfect match…</p>
<h2 id="practical-applications-for-rendering-using-vulkan">Practical applications for rendering using Vulkan <a href="#practical-applications-for-rendering-using-vulkan"></a></h2>
<p>In Vulkan, if you can use an sRGB format for your swapchain image, then you don’t have to manually correct for sRGB gamma. your pixels will be automatically stored in non-linear sRGB, and displayed linearly on-screen. this is great for encoding the highest amount of perceptual colour contrast detail using limited amount of bits (sRGB formats are usually about 8 bit per channel).</p>
<p>When image format names contain the suffix <code>*_SRGB</code> the sRGB gamma transform is applied <span>transparently </span><span>(automatically, without you having to do anything)</span> on every <span>texel read </span><span>(transform from non-linear-space into linear-space)</span> and <span>texel write </span><span>(transform from linear space into non-linear-space)</span>. This is useful, because we can only meaningfully blend color in linear space, blending in non-linear space would not be (physically) correct. The <a href="https://registry.khronos.org/DataFormat/specs/1.3/dataformat.1.3.html#TRANSFER_CONVERSION">specs on Khronos Data Formats</a> have some great documentation on this topic.</p>
<p>But this means that you need to undo the effect of the implicit sRGB gamma transform on texel write if you want to render a <em>perceptually linear</em> gradient while using an sRGB image backing. The function that the vulkan driver applies for you on texel write is called the <code>srgb_oetf</code>, short for “sRGB optical-electrical transfer function”.</p>
<p>To neutralise this function, you must apply the <code>inverse_srgb_oetf</code>, that’s the <code>srgb_eotf</code> “sRGB electo-optical transfer function”, just before you store the texel.</p>
<p>Here is how this would look like using our schematic from before:</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/srgb_corrected.svg" alt="A perceptually linear gradient using srgb" title="A perceptually linear gradient using srgb"/>
<figcaption>
    A perceptually linear gradient, corrected, and encoded using sRGB
</figcaption>
</figure>
<h2 id="draw-a-perceptually-linear-gradient-into-an-srgb-swapchain-image">Draw a perceptually linear gradient into an sRGB swapchain image <a href="#draw-a-perceptually-linear-gradient-into-an-srgb-swapchain-image"></a></h2>

</div>
<div>
    
<div><div><div>
<table><tbody><tr><td>
<pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span></code></pre></td>
<td>
<pre tabindex="0"><code data-lang="glsl"><span><span><span>vec3</span> <span>srgb_eotf</span><span>(</span><span>in</span> <span>const</span> <span>vec3</span> <span>c</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>bvec3</span> <span>cutoff</span> <span>=</span> <span>lessThan</span><span>(</span><span>c</span><span>,</span> <span>vec3</span><span>(</span><span>0.04045</span><span>));</span>
</span></span><span><span>    <span>vec3</span> <span>lower</span> <span>=</span> <span>c</span><span>/</span><span>vec3</span><span>(</span><span>12.92</span><span>);</span>
</span></span><span><span>    <span>vec3</span> <span>higher</span> <span>=</span> <span>pow</span><span>((</span><span>c</span> <span>+</span> <span>vec3</span><span>(</span><span>0.055</span><span>))</span><span>/</span><span>vec3</span><span>(</span><span>1.055</span><span>),</span> <span>vec3</span><span>(</span><span>2.4</span><span>));</span>
</span></span><span><span>    <span>return</span> <span>mix</span><span>(</span><span>higher</span><span>,</span> <span>lower</span><span>,</span> <span>cutoff</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>void</span> <span>main</span> <span>()</span> <span>{</span>
</span></span><span><span>    <span>vec3</span> <span>color</span> <span>=</span> <span>vec3</span><span>(</span><span>uv</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>    <span>outFragColor</span> <span>=</span> <span>vec4</span><span>(</span><span>srgb_eotf</span><span>(</span><span>color</span><span>),</span><span>1</span><span>);</span>
</span></span><span><span><span>}</span></span></span></code></pre></td></tr></tbody></table>
</div>
</div><p><span>glsl</span>
</p></div><p>And voila:</p>
<figure>
<img loading="lazy" src="https://status.claude.com/img/reflect/gamma/gradient_non_linear_srgb_swapchain.png" alt=" A perceptually linear gradient" title=" A perceptually linear gradient"/>
<figcaption>
    A perceptually linear gradient
</figcaption>
</figure>
<h2 id="further-reading">Further reading: <a href="#further-reading"></a></h2>
<ul>
<li>Charles Poynton: <a href="https://poynton.ca/GammaFAQ.html">Gamma FAQ</a></li>
<li>Riccardo Scalco: <a href="https://riccardoscalco.it/blog/gamma-correction-on-fragment-shaders/">Gamma Correction on Fragment Shaders</a></li>
<li>Clément Bœsch: <a href="https://blog.pkh.me/p/43-the-current-technology-is-not-ready-for-proper-blending.html">Blog: The current technology is not ready for proper blending</a></li>
<li>Bartosz Ciechanowski: <a href="https://ciechanow.ski/color-spaces/">color spaces</a></li>
</ul>
<h2 id="bonus">Bonus <a href="#bonus"></a></h2>
<p>Thank you sticking around past the end credits. Here’s an extra bit of information that might come in handy at a cgi pub quiz one day:</p>
<p>Did you ever wonder what the “s” in RGB stands for? Me neither – until now; I assumed it stood for <em>super</em>. The sad reality is more humble: Apparently <a href="https://en.wikipedia.org/wiki/SRGB">it stands for <em>Standard</em></a>. “Standard RGB”. What a standard.</p>


	</div>
	
	
	
		<div>
			<h3>RSS:</h3>
			<p>Find out first about new posts by subscribing to the <a href="https://poniesandlight.co.uk//reflect/feed.xml">RSS Feed</a> <a href="https://poniesandlight.co.uk//reflect/feed.xml" type="application/rss+xml"><svg style="width: 1em; position:relative; bottom:-0.25em;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm64 120c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32z"></path></svg></a></p>
		</div>
	
		<p>
			<h3>Further Posts:</h3>
		</p>
		
        </div></div>
  </body>
</html>
