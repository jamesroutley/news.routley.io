<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://serokell.io/blog/haskell-in-production-channable">Original</a>
    <h1>Haskell in Production: Channable</h1>
    
    <div id="readability-page-1" class="page"><div><p>In our <a href="https://serokell.io/blog/haskell-in-production">Haskell in Production</a> series, we interview developers from companies that use Haskell for real-world tasks. We cover benefits, downsides, common pitfalls, and tips for new Haskellers.</p>
<p>Our today’s guest is Fabian Thorand, who is a team lead at <a href="https://www.channable.com/">Channable</a>. Read further to learn where Channable uses Haskell, why they chose it, and what they like and don’t like about it.</p>
<h2 id="interview-with-fabian-thorand"><p>Interview with Fabian Thorand</p></h2>
<h3 id="could-you-tell-us-a-little-bit-about-channable-and-your-role-there%3F"><p>Could you tell us a little bit about Channable and your role there?</p></h3>
<p>Channable offers a channel management platform through which webshops can publish their products (or other offers like job postings or vacation deals) to a wide variety of marketplaces, ad platforms, or price comparison sites. The product information can be tweaked through user-defined rules following a simple “IF … THEN … (ELSE …)” structure (e.g. reducing prices during a sales period or removing products with missing information before sending them to a third-party platform).</p>
<p>I joined Channable about 4,5 years ago as a backend developer in the infrastructure team, where we work on the core applications powering the Channable tool. About a year ago, the team was split into two subteams due to our continuous growth, and I became the team lead of one of them.</p>
<h3 id="where-in-your-stack-do-you-use-haskell%3F"><p>Where in your stack do you use Haskell?</p></h3>
<p>We use Haskell for a variety of backend services. The biggest one by far is our data processing system, which powers the import from our customers, manages the data storage, and applies the user-defined rules to the data before streaming it to other components in our backend which handle the actual connections to the third-party platforms.</p>
<p>Another big project is our job-scheduling system for running a set of jobs with dependencies between them in the right order on a cluster of worker machines (think of “downloading data from the client system” or “exporting products to a third-party system”).</p>
<p>The third major part of our infrastructure using Haskell is an API gateway that handles routing (to our various backend services) and provides a common implementation for authentication, authorization, rate-limiting, etc. so that the backend services don’t have to concern themselves with that.</p>
<p>Last but not least, there are a few smaller utilities that we have open-sourced, such as <code><a href="https://github.com/channable/vaultenv/">vaultenv</a></code> (fetching secrets from Hashicorp Vault and providing them via environment variables to a program) and <code><a href="https://github.com/channable/icepeak/">icepeak</a></code> (a JSON document store with support for push notifications via websockets).</p>
<h3 id="why-did-you-decide-to-choose-haskell%3F"><p>Why did you decide to choose Haskell?</p></h3>
<p>Haskell was first introduced as an experiment rewriting a component that was hitting the limits of what was possible in Python and the existing architecture (the full story is on our <a href="https://www.channable.com/tech/how-we-secretly-introduced-haskell-and-got-away-with-it">tech blog</a>).</p>
<p>We needed a language that would complement Python well. A language that would compile to fast code while providing safety rails through its strong type system and still being high productivity. Given that we also already had several people enthusiastic about functional programming, Haskell was the natural choice.</p>
<p>Since that project turned out to be very successful (and is still in use today – being continually developed since then), Haskell was also chosen for another greenfield project that was started shortly after, our API gateway.</p>
<p>When I joined Channable, Haskell was thus already in use for these two projects. At the time, we were also running into scaling and operational troubles with our existing feed processing application (written in Scala using Apache Spark), and so Haskell was chosen once more for its replacement. More details about that rewrite can be found <a href="https://www.channable.com/tech/why-we-decided-to-go-for-the-big-rewrite">here</a>.</p>
<h3 id="are-there-any-specific-qualities-of-haskell-that-made-you-decide-in-its-favor%3F"><p>Are there any specific qualities of Haskell that made you decide in its favor?</p></h3>
<p>The main selling point is Haskell’s strong type system. It eliminates many types of runtime errors that we regularly see crop up in our Python code base (though it has gotten better since we use types in Python as well – via <code>mypy</code>). Additionally, it makes refactoring existing code a breeze: one can be sure that almost all required changes are caught by the compiler.</p>
<p>Another advantage is the focus on immutable (and persistent) data structures, allowing for cleaner designs and better testability and concurrency.</p>
<p>An underappreciated advantage of Haskell is also its great runtime system. It makes it very easy to add both concurrency and parallelism to your programs using lightweight threads. Something that is usually a lot harder to do in other programming languages if you didn’t design for it from the start.</p>
<h3 id="are-there-any-libraries-that-you-found-very-useful-in-the-development-process-and-would-like-to-feature%3F"><p>Are there any libraries that you found very useful in the development process and would like to feature?</p></h3>
<p>First of all, there is <code><a href="https://hackage.haskell.org/package/conduit">conduit</a></code> which we use for stream processing. In our experience it has been both fast and easy to use. The only downside is that code using it is quite prone to space leaks. Well-typed has a very informative <a href="https://www.well-typed.com/blog/2016/09/sharing-conduit/">blog post</a> on that topic.</p>
<p>Besides that, we use the excellent <code><a href="https://hackage.haskell.org/package/warp">warp</a></code> server for both internal and external HTTP-based interfaces. In some projects, we used it directly, in others through an additional layer like <code>scotty</code> or <code>servant</code>.</p>
<p>And last but not least, there is <code><a href="https://hackage.haskell.org/package/ghc-compact">ghc-compact</a></code>, which has helped us tremendously to get good performance even when working with large datasets. Though it might not really qualify as a library since it’s shipped with GHC and just wraps a feature of the GHC runtime system.</p>
<h3 id="what-kind-of-effect-system-do-you-use%3A-rio%2C-mtl%2C-fused-effects%2C-polysemy%2C-or-something-else%3F"><p>What kind of effect system do you use: RIO, mtl, fused-effects, Polysemy, or something else?</p></h3>
<p>Some of the older projects use mtl-style MonadXYZ classes and corresponding deep monad transformer stacks. Those turned out to be quite unwieldy to work with for various reasons.</p>
<p>Firstly, for M monad (transformer) types in your stack and N classes, you need about N * M instance declarations, which adds a lot of noise to the codebase. Additionally, deep monad stacks hurt performance quite a bit, so whenever we have performance critical code, we just use plain IO.</p>
<p>A secondary issue is that some monad transformer combinations look tempting at first glance, but turn out to be a bad idea in practice, like the (in)famous “ExceptT over IO”: not only is it incurring a performance penalty due to the repeated packing and unpacking of the inner Either, but it also makes the code more complex instead of simpler, as there are now two failure paths to consider (with different handling functions), since IO can always potentially throw an exception.</p>
<p>For those reasons, our newer projects usually use some form of <code>ReaderT IO</code> (or just IO-functions with explicit function arguments for dependencies). Occasionally, we also use free monads in places where there is a well-defined “language” of operations that we might want to mock in tests.</p>
<h3 id="did-you-run-into-any-downsides-of-haskell-while-developing-the-project%3F-if-so%2C-could-you-describe-those%3F"><p>Did you run into any downsides of Haskell while developing the project? If so, could you describe those?</p></h3>
<p>One big downside of Haskell that is noticeable in the daily development workflow is the lack of tooling. Fortunately, at least the “IDE” side of it improved quite a bit with the <code>haskell-language-server</code> project, which was a game-changer in terms of development convenience.</p>
<p>The remaining areas that are still lacking compared to other languages are debugging (<code>Debug.Trace</code>-debugging is often the only viable approach) and profiling. The latter probably deserves some explanation as GHC does come with built-in profiling capabilities. Unfortunately, those are very intrusive and sometimes drastically change the performance and allocation behavior of the generated code. External profilers that don’t require special builds (except for debugging info) like <code>perf</code> don’t work with Haskell code. On the upside, we did have good experiences with the eventlog-based profiling, which has a lower overhead than a full-blown profiling build.</p>
<p>In terms of the language itself, by far our biggest issue was its GC which is performing really badly when having large heaps (upwards of several gigabytes) without taking precautions like using compact regions (see <a href="https://www.channable.com/tech/lessons-in-managing-haskell-memory">our blog</a> for more details). With heaps growing even to the 100+GB region, we also encountered some quadratic runtime algorithms in the memory allocator of the RTS – and even compact regions didn’t help then. We <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19897">documented that particular bug</a> and have since provided a fix for it as well.</p>
<p>While there are a few tuning parameters, there is nothing that would alleviate these particular problems without requiring invasive code changes.</p>
<h3 id="how-easy-is-it-to-hire-haskell-engineers-for-the-team%3F-do-you-do-any-in-house-training-programs-to-get-non-haskell-engineers-up-to-speed-with-haskell%3F"><p>How easy is it to hire Haskell engineers for the team? Do you do any in-house training programs to get non-Haskell engineers up to speed with Haskell?</p></h3>
<p>So far we didn’t have trouble finding Haskell engineers to fill our vacancies. That can probably partially be attributed to the fact that our headquarter is located in Utrecht – since Utrecht University has a strong Haskell-focused track in the Computing Science Master’s programme.</p>
<p>We have no explicit in-house training program, but we have hired and successfully onboarded people of varying Haskell skill levels – and an important part of the culture at Channable is to grow and learn.</p>
<h3 id="as-an-aside%2C-you-also-use-nix%2C-which-seems-like-a-popular-choice-for-haskell-projects-nowadays.-how-did-you-decide-to-use-it%2C-and-how-was-your-experience-using-these-two-technologies-together%3F"><p>As an aside, you also use Nix, which seems like a popular choice for Haskell projects nowadays. How did you decide to use it, and how was your experience using these two technologies together?</p></h3>
<p>Some colleagues were using Nix for their side projects or running NixOS on their personal machines. At the time, we also had some trouble with our existing build and deployment infrastructure and were searching for solutions, and it turned out that Nix fit the bill perfectly.</p>
<p>We started by using Nix just as a convenient manner to bring various development tools into scope (such as <code>stack</code>), but not yet using it for building our code (so <code>stack</code> – while installed via <code>nix</code> – was not run in Nix-mode yet at that time). That way, we already prevented some of the issues, like having incompatible stack versions installed across developer machines.</p>
<p>The next step was then to port some of our build pipelines, starting with the Haskell projects. The main advantages were the pre-built Nix cache for Haskell packages (no more rebuilding the entire stackage snapshot with every minor upgrade) and the reproducibility of the builds.</p>
<p>The full story can be found on our <a href="https://www.channable.com/tech/nix-is-the-ultimate-devops-toolkit">tech blog</a></p>
<h3 id="your-tech-blog-posts-mention-languages-like-the-aforementioned-nix-and-idris%2C-working-with-which-is-definitely-on-some-people%E2%80%99s-bucket-lists.-is-experimenting-with-technologies-common-in-channable%3F-if-so%2C-what-benefits-do-you-see-in-this%3F"><p>Your <a href="https://www.channable.com/tech">tech blog</a> posts mention languages like the aforementioned Nix and Idris, working with which is definitely on some people’s bucket lists. Is experimenting with technologies common in Channable? If so, what benefits do you see in this?</p></h3>
<p>We have a regular Hackathon day in the development department where people can just try out ideas they have, or investigate new technologies that look interesting. The tool written in Idris is <code><a href="https://github.com/channable/dbcritic/">dbcritic</a></code> and was the product of one of those days.</p>
<p>Having this room for experimentation is definitely an important part of the engineering culture at Channable. There are a few things that people came up with during those Hackathons that are now regularly used – either in our production software, as a productivity tool, or as part of the CI pipeline.</p>
<p>We probably wouldn’t use Idris for any larger project, but since this particular program solves a concrete problem we had and was easy enough to package as it was, we decided to adopt it in our CI workflow.</p>
<h3 id="what-tips-would-you-give-for-a-new-haskell-team-starting-a-project-in-an-area-similar-to-yours%3F"><p>What tips would you give for a new Haskell team starting a project in an area similar to yours?</p></h3>
<p>My first recommendation would be to keep things simple. Haskell provides a lot of language-level complexity at your fingertips (just enable a few language extensions), but one needs to carefully consider if that complexity is worth the cost. Both in terms of syntactic overhead, but also in terms of increasing the burden for onboarding future colleagues</p>
<p>The other is more specific, but if you plan to work with large amounts of data (that isn’t just plain bytes), be sure to take into account Haskell’s GC from the start. When working with a large heap, there <em>will</em> be GC troubles. The only mitigation (while still being able to work with regular Haskell data structures) are compact regions. As using those has an impact on the overall architectural and algorithmic design, rewriting an existing program to use them might not be straightforward.</p>
<h3 id="where-can-people-learn-more-about-channable%3F"><p>Where can people learn more about Channable?</p></h3>
<ul>
<li>About what we do on the technical side: <a href="https://www.channable.com/tech/">https://www.channable.com/tech/</a></li>
<li>About the company in general: <a href="https://www.channable.com/">https://www.channable.com/</a></li>
<li>About our open-source projects: <a href="https://github.com/channable/">https://github.com/channable/</a></li>
</ul>
<hr/>
<p>Hope you enjoyed our interview with Fabian!</p>
<p>To read more interviews with companies that use Haskell to solve real-world problems, head to our <a href="https://serokell.io/blog/interviews">interview</a> section. Also, be sure to follow us on <a href="https://twitter.com/serokell">Twitter</a> or subscribe to our mailing list (via form below) to get updates whenever we release new articles.</p></div></div>
  </body>
</html>
