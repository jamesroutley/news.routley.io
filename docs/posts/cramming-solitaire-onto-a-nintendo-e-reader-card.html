<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mattgreer.dev/blog/cramming-solitaire-onto-a-nintendo-ereader-card/">Original</a>
    <h1>Cramming Solitaire onto a Nintendo E-Reader card</h1>
    
    <div id="readability-page-1" class="page"><div><p>I recently finished making Solitaire for the Nintendo E-Reader. I managed to fit it onto a single card, and it&#39;s a pretty full featured version of the game. I&#39;m really happy with how it turned out. I figured I&#39;d talk a bit about how I made it in what turned out to be a long blog post :)</p><iframe width="560" height="315" src="https://www.youtube.com/embed/yrCnlQbR8Qw" frameborder="0" allowfullscreen=""></iframe><h2 id="what-is-the-e-reader">What is the E-Reader?<a aria-hidden="true" href="#what-is-the-e-reader"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>The E-Reader is a Game Boy Advance peripheral that Nintendo released in 2002. By scanning cards that have a dot code strip on them, you can load mini games, extra levels, animations and more.</p><figure><img src="https://mattgreer.dev/_next/static/media/ereaderWithCard.ab34b110.jpg" alt="The E-Reader and one of its cards"/><figcaption>The E-Reader and one of its cards</figcaption></figure><p>I&#39;ve always really liked the E-Reader and was sad it didn&#39;t do too well in America. So I thought maybe I&#39;d take a stab at making games for it myself.</p><figure><img src="https://mattgreer.dev/_next/static/media/marge.40e3ded1.jpg" alt="Marge Simpson holding up an E-Reader card"/><figcaption>Me too, Marge</figcaption></figure><p>And here is the result</p><figure><img src="https://mattgreer.dev/_next/static/media/solitaireCard.14494276.svg" alt="Solitaire as an E-Reader card"/><figcaption>Solitaire in its card from</figcaption></figure><p>If you would like to try it, you can get a card at <a tabindex="0" href="https://retrodotcards.com">retrodotcards.com</a>.</p><h2 id="tools-and-docs-starting-way-back-in-the-past">Tools and docs, starting way back in the past...<a aria-hidden="true" href="#tools-and-docs-starting-way-back-in-the-past"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>Where to begin? I remembered there were some old tools and websites about making E-Reader cards from back around when it first came out <!-- -->—<!-- --> twenty years ago! I managed to find <a tabindex="0" href="https://www.schuerewegen.tk/">Tim Schuerewegen&#39;s</a> original site in the Wayback Machine. It had some examples, source code and tools. I also refound <a tabindex="0" href="https://caitsith2.com/ereader/">CaitSith2&#39;s E-Reader site</a>, which thankfully is still up. It also has some tools and information.</p><div><p>These tools are the backbone of E-Reader dev. Thanks to Tim and CaitSith2 for making them! They were originally made for Windows, but they were also made</p><!-- --> <p><a tabindex="0" href="https://github.com/breadbored/nedclib">multi-platform here</a>.</p></div><p>These initial findings were a great start and got me headed down learning how E-Reader applications are programmed. GBATEK also has <a tabindex="0" href="https://problemkaputt.de/gbatek.htm#gbacartereader">a section on the E-Reader</a> which also contains lots of useful information.</p><p>More recently I found <a tabindex="0" href="https://github.com/AkBKukU/e-reader-dev">AkBKukU&#39;s e-reader-dev repo</a> which has also been very helpful.</p><h2 id="pick-your-poison-gba-nes-or--z80">Pick your poison: GBA, NES or ... z80?<a aria-hidden="true" href="#pick-your-poison-gba-nes-or--z80"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>What kind of E-Reader card should I make? E-Reader cards can come in four broad formats</p><h3 id="game-boy-advance-applications">Game Boy Advance applications<a aria-hidden="true" href="#game-boy-advance-applications"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>These are GBA programs written much like if you were making a normal GBA game. The E-Reader simply loads them in then lets them execute on their own for the most part.</p><h3 id="nes-games">NES games<a aria-hidden="true" href="#nes-games"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>The E-Reader contains a simple NES emulator, so it is possible to directly put simple NES games onto E-Reader cards. The keyword here is &#34;simple&#34;, it does not support more advanced NES features. Also the E-Reader has a limit on how many card swipes one application can have. The NES games Nintendo released require 10 card swipes to load! So in the end it is only possible to run early/small NES games. Nintendo used this to release games like Excitebike and Donkey Kong for the E-Reader</p><figure><img src="https://mattgreer.dev/_next/static/media/excitebike.b25f14d4.jpg" alt="Excitebike in E-Reader card format"/><figcaption>Excitebike in E-Reader card format</figcaption></figure><h3 id="raw-binaries">Raw binaries<a aria-hidden="true" href="#raw-binaries"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>Raw E-Reader cards just contain binary data of some kind. Specific games made use of these to add levels, characters, etc. Kind of like a primitive form of DLC. It is up to the specific game to interpret the data as it sees fit.</p><p>Super Mario Advance 4 released cards like this, adding additional levels, power ups and more for the game</p><figure><img src="https://mattgreer.dev/_next/static/media/sma4LevelCards.2f1b78cf.jpg" alt="Super Mario Advance 4 E-Reader level cards"/><figcaption>Super Mario Advance 4 E-Reader level cards</figcaption></figure><h3 id="z80-applications">z80 Applications<a aria-hidden="true" href="#z80-applications"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>And finally the E-Reader also contains a simple z80 emulator. The z80 is an 8-bit processor that first came out in 1976! It was very successful and found its way into many different computers.</p><p>I don&#39;t believe Nintendo ever used a z80 processor in any of their game consoles. So this choice is an interesting one. I&#39;m sure the z80&#39;s simplicity was a big factor here, it&#39;s pretty easy to emulate.</p><p>I have since been informed that the Game Boy and Game Boy Color have CPUs that are similar to the z80. So that might have influenced Nintendo&#39;s decision here. I didn&#39;t know that, so thanks to those who informed me.</p><figure><img src="https://mattgreer.dev/_next/static/media/manhole.c4c7c2b1.jpg" alt="Manhole: a simple z80 E-Reader game"/><figcaption>Manhole: a simple z80 E-Reader game</figcaption></figure><p>That means E-Reader apps can be written in z80 assembly. The primary advantage here is z80 apps tend to be quite small. In my experimenting, I found an E-Reader z80 app to be about 30-50% smaller than an equivalent E-Reader GBA app. Nintendo almost entirely went this route with their own cards, I&#39;m guessing to keep the number of swipes needed for an application to a minimum.</p><h2 id="z80-e-reader-apps">z80 E-Reader apps<a aria-hidden="true" href="#z80-e-reader-apps"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>I made Solitaire as a z80 application and have become pretty entrenched in this approach. I really like how much smaller the resulting binaries are. But make no doubt about it, z80 assembly is pretty rough. Especially considering you can <a tabindex="0" href="https://github.com/AkBKukU/e-reader-dev">write a GBA E-Reader card in C</a>.</p><h3 id="the-erapi-api">The ERAPI API<a aria-hidden="true" href="#the-erapi-api"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>For z80 games, Nintendo embedded a simple but effective <a tabindex="0" href="https://problemkaputt.de/gbatek.htm#gbacartereaderapifunctions">API</a> into the E-Reader that they can take advantage of. Things like creating sprites, playing music, even multiplying and dividing, can all be done through this API. This helps keep card sizes small, as common functionality doesn&#39;t need to be packed into the cards, the E-Reader itself will provide it.</p><p>GBA E-Reader games also can access ERAPI. It&#39;s a bit different here and there, but overall it&#39;s the same API.</p><p>As a simple example, here is how to create a sprite using the API</p><p><code><p><span> <wbr/> <wbr/> <wbr/> <wbr/>; <wbr/>ERAPI_SpriteCreate()</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>; <wbr/>e <wbr/> <wbr/>= <wbr/>pal#</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>; <wbr/>hl <wbr/>= <wbr/>sprite <wbr/>data</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>ld <wbr/> <wbr/>e, <wbr/>#2</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>ld <wbr/> <wbr/>hl, <wbr/>#my_sprite_data_struct</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rst <wbr/>0</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>.db <wbr/>ERAPI_SpriteCreate</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>ld <wbr/> <wbr/>(my_sprite_handle), <wbr/>hl</span></p></code></p><p>If you&#39;re not familiar with z80 assembly this probably looks bizarre. It is basically the equivalent of</p><p><code><p><span>int</span><span> <wbr/>palette_index <wbr/></span><span>=</span><span> <wbr/></span><span>2</span><span>;</span><span></span></p><p><span></span><span>int</span><span> <wbr/>my_sprite_handle <wbr/></span><span>=</span><span> <wbr/></span><span>SpriteCreate</span><span>(</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>palette_index</span><span>,</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>my_sprite_data_struct</span></p><p><span></span><span>)</span><span>;</span><span></span></p></code></p><p>The <code>ld</code> calls are &#34;load&#34;, and here we are loading the <code>e</code> register with which palette index we want the sprite to use. The <code>hl</code> register is loaded with a pointer to the information about the sprite (its tiles, colors, frames of animation, etc). The <code>rst 0</code> and <code>.db ERAPI_SpriteCreate</code> lines are where we actually make the API call. Without getting too deep on how the z80 works, this is a simple function call. When it is done, it will leave the handle to the sprite in the hl register, so we <code>ld (my_sprite_handle), hl</code> to copy that value off into memory for safe keeping. That handle is later used whenever we want to interact with the sprite, such as changing its position.</p><h3 id="a-crippled-z80">A crippled z80<a aria-hidden="true" href="#a-crippled-z80"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>The E-Reader&#39;s z80 emulator is not 100% accurate. Nintendo decided to not support some opcodes and some of the registers. I have also found that some opcodes don&#39;t seem to work correctly. Hopefully I&#39;m just using them wrong, but some opcodes just cause the GBA to show a black screen and lock up.</p><p>The z80 is already a very limited processor, and this makes it even more so. Sometimes E-Reader z80 development is absolutely painful. But hey, the challenge is part of the fun (right?)</p><p>I often felt like this when trying to implement something</p><figure><img src="https://mattgreer.dev/_next/static/media/austinPowers.5363a338.jpg" alt="Austin Powers trying to turn around in a tunnel"/></figure><p>Simple things that I usually take for granted like copying one array to another is just so much harder to do in E-Reader z80 assembly. Thankfully I&#39;m starting to get the hang of it.</p><h3 id="debugging">Debugging<a aria-hidden="true" href="#debugging"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>Another huge challenge was debugging the game. There&#39;s no way to log anything, running the game on a Game Boy Advance is a total black box. GBA emulators like <a tabindex="0" href="https://mgba.io/">mGBA</a> have good debugging features. But this is a z80 emulator running on the GBA&#39;s ARM processor. I figured stepping through ARM instructions trying to figure out how z80 instructions worked would be a herculean task, so much so I never even tried. Thankfully I don&#39;t think I&#39;ll ever need to, more on that below.</p><p>For my first attempt at creating a debugger, I took <a tabindex="0" href="https://github.com/5inf/z80js">z80js</a>, a z80 emulator core created by Molly Howell, and built a small application that would run my binary and log out what the cpu was doing. The output looked like this</p><p><code><p><span>...</span><span></span></p><p><span>0B52</span><span>:</span><span> <wbr/>call <wbr/>_deck_gfx_render_column <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>03</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>0003</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/>085c</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/></span><span>0017</span><span></span></p><p><span>0B5B</span><span>:</span><span> <wbr/>ld <wbr/> <wbr/> <wbr/>b</span><span>,</span><span>#</span><span>0x13</span><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>03</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>0003</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/>085c</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/></span><span>0017</span><span></span></p><p><span>0B5D</span><span>:</span><span> <wbr/>ld <wbr/> <wbr/> <wbr/>c</span><span>,</span><span>#</span><span>0x00</span><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>13</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>03</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>1303</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/>085c</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/></span><span>0017</span><span></span></p><p><span>0B5F</span><span>:</span><span> <wbr/>ld <wbr/> <wbr/> <wbr/>hl</span><span>,</span><span>(</span><span>_deck_gfx_cur_column_addr</span><span>)</span><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>13</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>1300</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/>085c</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/></span><span>0017</span><span></span></p><p><span>0B62</span><span>:</span><span> <wbr/>ld <wbr/> <wbr/> <wbr/>d</span><span>,</span><span>#</span><span>0x00</span><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>13</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>1300</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/>085c</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/>085c</span></p><p><span>0B64</span><span>:</span><span> <wbr/>ld <wbr/> <wbr/> <wbr/>e</span><span>,</span><span>c <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>13</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>1300</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/>005c</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/>085c</span></p><p><span>0B65</span><span>:</span><span> <wbr/>add <wbr/> <wbr/>hl</span><span>,</span><span>de <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span> <wbr/> <wbr/></span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span> <wbr/> <wbr/></span><span>13</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span> <wbr/> <wbr/></span><span>00</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span> <wbr/> <wbr/></span><span>08</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span> <wbr/> <wbr/>5c</span><span>,</span><span> <wbr/></span><span>bc</span><span>:</span><span> <wbr/></span><span>1300</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span> <wbr/></span><span>0000</span><span>,</span><span> <wbr/></span><span>hl</span><span>:</span><span> <wbr/>085c</span></p><p><span></span><span>...</span><span></span></p></code></p><p>That looks like pure gibberish here in the blog because the lines are too long to fit. Each line contains the opcode the cpu executed, and the state of all the registers at that time.</p><p>Here is a single line, cleaned up a bit</p><p><code><p><span>0B5B</span><span>:</span><span> <wbr/>ld <wbr/>b</span><span>,</span><span>#</span><span>0x13</span><span> <wbr/></span><span>|</span><span> <wbr/>a</span><span>:</span><span>17</span><span>,</span><span> <wbr/></span><span>b</span><span>:</span><span>00</span><span>,</span><span> <wbr/></span><span>c</span><span>:</span><span>03</span><span>,</span><span> <wbr/></span><span>d</span><span>:</span><span>08</span><span>,</span><span> <wbr/></span><span>e</span><span>:</span><span>5c</span><span>,</span><span> <wbr/></span><span>h</span><span>:</span><span>00</span><span>,</span><span> <wbr/></span><span>l</span><span>:</span><span>17</span><span>,</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>bc</span><span>:</span><span>0003</span><span>,</span><span> <wbr/></span><span>de</span><span>:</span><span>085c</span><span>,</span><span>hl</span><span>:</span><span> <wbr/></span><span>0017</span><span></span></p></code></p><p>This ... worked ... I mean it got the job done and I was able to fix bugs by examining this output. But it wasn&#39;t very fun. A huge downside to this approach is it wasn&#39;t interactive. It just blindly ran the game without allowing any button presses or anything like that. Because of this, I often had to get very creative to get this emulator to run the part of the game I was having troubles with.</p><h3 id="a-proper-debugger">A proper debugger<a aria-hidden="true" href="#a-proper-debugger"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>I used this tracing approach to write most of the game. But towards the end there were two mysterious bugs I just could not figure out. I knew I needed a better solution.</p><p>I stumbled across the <a tabindex="0" href="https://github.com/maziac/DeZog">DeZog</a> project, which is a general purpose z80 debugging extension for VS Code. This looked really promising, but then I found <a tabindex="0" href="https://github.com/andrivet/ZX81-Debugger">ZX81-Debugger</a>. Sebastien Andrivet took DeZog as a basis and made a VS Code extension specifically for writing and debugging <a tabindex="0" href="https://en.wikipedia.org/wiki/ZX81">ZX81</a> applications.</p><p>I really liked ZX81-Debugger right away, what a great tool! Just install it and <em>boom</em> you&#39;ve got a full fledged ZX81 development environment. I forked its code and started adapting it to work with E-Reader apps. Since both platforms have the z80 processor in common, this turned out to not be as difficult as I thought it would be.</p><p>After a long weekend of hacking, I surprisingly had an E-Reader debugger running in VS Code! In the end, I was positively floored how quickly I got this working. I am truly standing on the shoulders of giants ... so thank you to everyone who made all of this possible.</p><figure><img src="https://mattgreer.dev/_next/static/media/ereaderDebugger.7724d380.png" alt="The E-Reader debugger running in VS Code"/><figcaption>The E-Reader debugger running in VS Code</figcaption></figure><p><a tabindex="0" href="https://mattgreer.dev/ereaderDebugger.png">Here is that image</a> in full size.</p><p>To get this working I removed most of the ZX81 specific things and then wrote a simple ERAPI emulator. As ERAPI calls come in, the debugger sends them over to my little emulator, which then translates them into a visual GBA screen.</p><figure><img src="https://mattgreer.dev/_next/static/media/erapiScreen.74512747.png" alt="A close up of the ERAPI emulator screen output"/><figcaption>A close up of the ERAPI emulator screen output</figcaption></figure><p>The background is green because I&#39;ve not added most of the background related API functions to the emulator yet. And below the screen I am dumping out the current state of all the sprites that were created through ERAPI.</p><p>You can even take a commercial E-Reader game and run it in the debugger. It will disassemble the binary and provide a nice debugging experience. This will be helpful to further figure out more about how E-Reader cards and ERAPI works.</p><figure><img src="https://mattgreer.dev/_next/static/media/kirbyInDebugger.6b6e5d80.png" alt="An official Nintendo E-Reader card, running in the debugger"/><figcaption>An official Nintendo E-Reader card, running in the debugger</figcaption></figure><p>The colors in that Kirby card are all weird because my ERAPI emulator is super raw and does many things incorrectly. It&#39;s drawing the image using the wrong palettes. A lot more work needs to be done.</p><p>This is just amazing! I never imagined I&#39;d get a developer experience this powerful on a forgotten, 20 year old, Nintendo peripheral. We really live in exciting times sometimes.</p><p>Ultimately I will open source the E-Reader-Debugger. But as it stands, it&#39;s not even alpha quality. I mean it is <i>rough</i>. After I&#39;ve worked out more kinks, I will throw it up on GitHub.</p><h2 id="challenges-with-the-erapi-api">Challenges with the ERAPI API<a aria-hidden="true" href="#challenges-with-the-erapi-api"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>Overall the E-Reader&#39;s ERAPI is very useful, and has lots of great stuff to make development easier. But I did find some of the stuff didn&#39;t work out. Either because this stuff is buggy, or maybe I just don&#39;t yet understand how to use it properly. Hopefully the latter.</p><p>I really struggled with this when rendering the playfield for Solitaire. Being an old game system, the GBA has limitations when drawing sprites to the screen. You can&#39;t put too many on the screen at once or else things like this can happen</p><iframe width="560" height="315" src="https://www.youtube.com/embed/WE4CgMpjD88" frameborder="0" allowfullscreen=""></iframe><p>This video shows Solitaire when I first started working on it. I wanted to see if I could use sprites to draw all the cards. I concluded I couldn&#39;t and instead would need to draw the cards into a background. Using backgrounds for graphics like this is a very common tactic on older game systems. And luckily, ERAPI has the function <code>SpriteDrawOnBackground</code>, it seems to be exactly meant for this use case.</p><p>Using this function, I was able to easily draw my sprites into the background and avoid all graphical glitching ... the first time the playfield was drawn. As it was drawn repeatedly, it seemed like the tiles in video RAM were getting corrupted</p><iframe width="560" height="315" src="https://www.youtube.com/embed/jz8RZF68B58" frameborder="0" allowfullscreen=""></iframe><p>In this video I was reshuffling and redealing the deck repeatedly. And each time I dealt it out again, graphical glitches would appear.</p><p>I tried and tried, but I just could not get this to work. I&#39;m not completely sure I wasn&#39;t doing something wrong. But ERAPI and the way z80 apps work with the emulator seem pretty straightforward? So I <em>think</em> this function was not meant for rapid use like this.</p><p>ERAPI has another function, <code>LoadCustomBackground</code>, and it was this one that was a winner for my game. It&#39;s a lower level and harder to use function than <code>SpriteDrawOnBackground</code>, but it has never caused graphical glitches on me even once.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/4-uaNX9LGN4" frameborder="0" allowfullscreen=""></iframe><p>With this function, it is up to me to figure out which tiles go where to form a background. You need to understand how backgrounds work on the GBA to pull this off. Then once I&#39;ve figured it all out, I just send it to the GBA in one function call and it appears on the screen.</p><h2 id="z80-e-reader-apps-are-kinda-script-like">z80 E-Reader apps are kinda script-like<a aria-hidden="true" href="#z80-e-reader-apps-are-kinda-script-like"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>I have found the way E-Reader z80 apps work to be pretty interesting. The emulator uses the <code>halt</code> opcode to mean &#34;draw a frame to the screen&#34;. You can load the <code>a</code> register with how many frames it should draw, accomplishing a very simple way to add waits to your game.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/k5GrjMe4Ef0" frameborder="0" allowfullscreen=""></iframe><p>Take this little intro animation. I built it like this</p><p><code><p><span> <wbr/> <wbr/> <wbr/> <wbr/>logoHandle <wbr/></span><span>=</span><span> <wbr/></span><span>createSprite</span><span>(</span><span>logo</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>setSpritePosition</span><span>(</span><span>logoHandle</span><span>,</span><span> <wbr/></span><span>120</span><span>,</span><span> <wbr/></span><span>20</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>footerHandle <wbr/></span><span>=</span><span> <wbr/></span><span>createSprite</span><span>(</span><span>footer</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>setSpritePosition</span><span>(</span><span>footerHandle</span><span>,</span><span> <wbr/></span><span>120</span><span>,</span><span> <wbr/></span><span>60</span><span>)</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>playSystemSound</span><span>(</span><span>DRUM_ROLL</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>for</span><span> <wbr/></span><span>(</span><span>let</span><span> <wbr/>i <wbr/></span><span>=</span><span> <wbr/></span><span>0</span><span>;</span><span> <wbr/>i <wbr/></span><span>&lt;</span><span> <wbr/></span><span>NUM_CARDS_TO_DEAL</span><span>)</span><span> <wbr/></span><span>{</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>dealOneCard</span><span>(</span><span>i</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/> <wbr/></span><span>halt</span><span>(</span><span>1</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>}</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>playSystemSound</span><span>(</span><span>CYMBOL</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>halt</span><span>(</span><span>30</span><span>)</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>freeSprite</span><span>(</span><span>logoHandle</span><span>)</span><span>;</span><span></span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/></span><span>freeSprite</span><span>(</span><span>footerHandle</span><span>)</span><span>;</span><span></span></p></code></p><p>In the actual game this was done in assembly, I turned it into pseudo-code here to make it easier to read.</p><p>What I find interesting is I just whipped up a typical game engine loop on the spot, just to deal out the cards. I didn&#39;t need to hook all this into a main game loop like you often do with most game development. The entire rest of the game doesn&#39;t know or even care that this happens.</p><h2 id="e-reader-assets">E-Reader assets<a aria-hidden="true" href="#e-reader-assets"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>You might have noticed my game has music, sound effects, and a Mars-like rocky background. The E-Reader itself has many assets a game can use. This helps keep the dotcode data small. You can do custom graphics (such as the deck of cards in my game) and sounds, but they tend to be quite large and take up precious space.</p><figure><img src="https://mattgreer.dev/_next/static/media/ereaderSystemBackgrounds.65d3800e.png" alt="Some of the backgrounds found on the E-Reader"/><figcaption>Some of the backgrounds found on the E-Reader</figcaption></figure><p>Altogether there are over 100 backgrounds, over 800 sounds (both sound effects and music) and over 200 Pokémon sprites stored in the E-Reader&#39;s 8MB ROM. If you&#39;re an E-Reader fan, you might have noticed Nintendo&#39;s mini games tend to reuse the same sound effects, music and often the same backgrounds. This is why.</p><p>Using them is usually just a simple API call. For example here is how I play the drum roll sound effect</p><p><code><p><span> <wbr/> <wbr/> <wbr/> <wbr/>ld <wbr/>hl, <wbr/>755</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>rst <wbr/>8</span></p><p><span> <wbr/> <wbr/> <wbr/> <wbr/>.db <wbr/>ERAPI_PlaySystemSound</span></p></code></p><p>Crazy assembly syntax aside, this is pretty much just <code>PlaySystemSound(755)</code>, where <code>755</code> is the drum roll&#39;s id.</p><h2 id="how-big-can-e-reader-apps-be">How big can E-Reader apps be?<a aria-hidden="true" href="#how-big-can-e-reader-apps-be"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>A single E-Reader dotstrip can store 2,192 bytes of data, which is just over 2kb. But there is some overhead with the headers, and error correction, making the actual amount of data I&#39;ve been able to store on a single strip a bit less than 2kb. This data on the dotstrip is compressed though, which helps a lot.</p><figure><img src="https://mattgreer.dev/_next/static/media/helloWorld.dotcode.bmp.43c2b440.png" alt="An example dotcode strip"/><figcaption>An example dotcode strip</figcaption></figure><figure><img src="https://mattgreer.dev/_next/static/media/helloWorld.dotcode.snippet.bmp.cf8b38ee.png" alt="A closer view at part of the dotstip"/><figcaption>A closer view at part of the dotstrip</figcaption></figure><p>The compression makes the total storage size kind of fuzzy. It really depends on how well your data compresses. For example, here are the tiles for my cards</p><figure><img src="https://mattgreer.dev/_next/static/media/deck_strips.e6d0f428.png" alt="The card graphic tiles for Solitaire"/><figcaption>The card graphic tiles for Solitaire</figcaption></figure><p>I could have saved space by not repeating the same tile over and over again. But this data compressed <em>very</em> well. So well, I just went with it. Deduping these tiles would have made the drawing routines much more complicated, maybe so much so it would have killed any space savings I had achieved.</p><p>In the end I didn&#39;t need to do <em>too</em> much space optimization to keep Solitaire down to two dotstrips (which can be printed onto a single card). I did use up all the space that those two strips alloted me, so any more features would have likely required the game be expanded to three dotstrips, something I really wanted to avoid.</p><p>Honestly I&#39;m a bit surprised how many strips are needed for some of Nintendo&#39;s cards. Based on the game contained inside and my experience writing Solitaire, it seems like some of their games could have been done in fewer dotstrips. But that&#39;s just a total guess, I don&#39;t really know.</p><h3 id="the-e-reader-and-gba-limitations-on-space">The E-Reader and GBA limitations on space<a aria-hidden="true" href="#the-e-reader-and-gba-limitations-on-space"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3><p>The E-Reader itself allows a maximum of 12 strips to be scanned for a single application. Although I&#39;ve yet to find any application that requires that many. The NES games need 10</p><figure><img src="https://mattgreer.dev/_next/static/media/tenStripsNeeded.612549fa.png" alt="The E-Reader waiting for 9 more strips to load Excitebike"/><figcaption>The E-Reader waiting for 9 more strips to load Excitebike</figcaption></figure><p>As for the Game Boy Advance itself, it has 256kb of RAM which is more than enough to store any E-Reader application. The E-Reader will decompress the data into RAM, then execute it. I suppose technically your data could exceed 256kb when decompressed, but realistically I just can&#39;t see that happening.</p><h2 id="more-e-reader-cards-to-come">More E-Reader cards to come<a aria-hidden="true" href="#more-e-reader-cards-to-come"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2><p>My goal is to make many more E-Reader apps. I&#39;m already deep into development of the next game. I am hoping to build at least 10 apps and have the cards professionally manufactured. Hopefully packaged up in a booster pack, which would be so cool. Why? Why not. I think the E-Reader is really cool and this is a lot of fun.</p><p>If new E-Reader cards interests you, check out <a tabindex="0" href="https://retrodotcards.com">https://retrodotcards.com</a> If you want to try Solitaire out for yourself, you can order a card there. They are free.</p><p>I will also be posting to <a tabindex="0" href="https://bsky.app/profile/retrodotcards.com">Bluesky</a> as I progress, and have also started a <a tabindex="0" href="https://www.reddit.com/r/retrodotcards/">subreddit</a> for this, stop on by!</p></div></div>
  </body>
</html>
