<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://daniel.haxx.se/blog/2025/05/16/leeks-and-leaks/">Original</a>
    <h1>Leeks and Leaks – Daniel.haxx.se</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>On the completely impossible situation of blocking the Tor <code>.onion</code> TLD to avoid leaks, but at the same time not block it to make users able to do what they want.</p>



<h2>dot-onion leaks</h2>



<p>The onion TLD is a Tor specific domain that does not mean much to the world outside of Tor. If you try to resolve one of the domains in there with a <em>normal </em>resolver, you will get told that the domain does not exist.</p>



<p>If you ask your ISP’s resolver for such a hostname, you also advertise your intentions to speak with that domain to a sizeable portion of the Internet. DNS is inherently commonly insecure and has a habit of getting almost broadcast to lots of different actors. <em>A user on this IP address intends to interact with this .onion site.</em></p>



<p>It is thus of utter importance for Tor users to never use the <em>normal</em> DNS system for resolving .onion names.</p>



<h2>Remedy: refuse them</h2>



<p>To help preventing DNS leaks as mentioned above, Tor people engaged with the IETF and the cooperation ultimately ended up with the publication of <a href="https://datatracker.ietf.org/doc/html/rfc7686">RFC 7686</a>: <em>The “.onion” Special-Use Domain Name</em>. Published in 2015.</p>



<p>This document details how libraries and software should approach handling of this special domain. It basically says that software should to a large degree <em>refuse</em> to resolve such hostnames.</p>



<h2>curl</h2>



<p>In <a href="https://github.com/curl/curl/issues/543">November 2015 we were made aware</a> of the onion RFC and how it says we should filter these domains. At the time nobody seemed keen to work on this, and the problem was added to the <a href="https://curl.se/docs/knownbugs.html">known bugs document</a>.</p>



<p>Eight years later the issue was still lingering in that document and curl had still not done anything about it, when Matt Jolly emerged from the shadows and brought <a href="https://github.com/curl/curl/pull/10705">a PR that finally implemented the filtering</a> the RFC says we should do. Merged into curl on March 30, 2023. Shipped in the curl 8.1.0 release that shipped in May 17, 2023. Two years ago.</p>



<p>Since that release, curl users would not accidentally leak their .onion use.</p>



<p>A curl user that uses Tor would <em>obviously</em> use a SOCKS proxy to access the Tor network like they always have and then curl would let the Tor server do the name resolving as that is the entity here that knows about Tor and the dot onion domain etc.</p>



<p>That’s the thing with using a proxy like this. A network client like curl can hand the full host name to the proxy server and let that do the resolving magic instead of it being done by the client. It avoids leaking names to local name resolvers.</p>



<h2>Controversy</h2>



<p>It did not take long after curl started support the RFC that Tor themselves had pushed for, when Tor users with <em>creative</em> network setups realized and had opinions.</p>



<p>A <a href="https://github.com/curl/curl/pull/11236">proposal appeared</a> to provide an override of the filter based on an environment variable for users who have a setup where the normal name resolver is already protected somehow and is known to be okay. Environment variables make for horrible APIs and the discussion did not end up in any particular consensus for other solutions so this suggestion did not make it through into code.</p>



<p>This issue has subsequently popped up a few more times when users have had some issues, but no fix or solution has been merged. curl remains blocking this domain. Usually people realize that when using the SOCKS proxy correctly, the domain name works as expected and that has then been the end of the discussions.</p>



<h2>oniux</h2>



<p>This week the Tor project announced a new product of their: <a href="https://blog.torproject.org/introducing-oniux-tor-isolation-using-linux-namespaces/">oniux</a>: <em>a command-line utility providing Tor network isolation for third-party applications using Linux namespaces</em>.</p>



<p>On their introductory web page explaining this new tool they even show it off using a curl command line:</p>



<pre>$ oniux curl http://2gzyxa5ihm7wid.onion/index.html</pre>



<p>(I decided to shorten the hostname here for illustration purposes.)</p>



<p>Wait a second, isn’t that a .onion hostname in that URL? Now what does curl do with .onion host names since that release two years ago?</p>



<p>Correct: that illustrated command line only works with old curl versions from before we implemented support for RFC 7686. From before we tried to do in curl what Tor indirectly suggested we should do. So now, when we try to do the right thing, curl does not work with this new tool Tor themselves launched!</p>



<p>At least we can’t say we get do live a dull life.</p>



<h2>Hey this doesn’t work!</h2>



<p>No really? Tell us all about it. Of course there was immediately <a href="https://github.com/curl/curl/issues/17363">an issue submitted</a> against curl for this, quite rightfully. That tool was quite clearly made for a use case like this.</p>



<p>So how do we fix this?</p>
	</div></div>
  </body>
</html>
