<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.nikolasgoebel.com/2024/05/28/duckdb-doesnt-need-data.html">Original</a>
    <h1>DuckDB Doesn&#39;t Need Data to Be a Database</h1>
    
    <div id="readability-page-1" class="page"><article>
          

<p>One of the many enjoyable things about databases is that they generally try to separate how
data is represented internally (say on disk) from how it is used. To the point that it has
<a href="https://en.wikipedia.org/wiki/Disaggregated_storage">become the norm</a> to not even store the
data on the same hardware that is running the queries.</p>

<p>Data<em>bases</em> have gotten so good at this, that the term is almost misleading now. “Base”
suggests something rigid, without which the data would slip away. But the data is always
there, just bits on a nameless hard disk. The structure and the accessibility that a modern
database provides exist completely independently from that hard disk. That’s right – most
databases no longer have any data in them.</p>

<p><a href="https://duckdb.org/">DuckDB</a> is a database built for this age, and a particularly lovely
one at that.</p>

<p>Say you run a robotaxi service. And you’re maintaining a growing dataset of interesting ride
patterns in blob storage, that you’d like to understand better. The data is split into a
separate Parquet file for each day. How do you share that dataset with an analyst?</p>

<p>You could just mail them everything, but the dataset is getting way too big for that. Plus
it’d be out of date instantly. If this was a blogpost you would just send a link, but there
isn’t really a single thing to link to here. And sending someone a hundred links to raw
blobs in S3 can sour any working relationship.</p>

<p>Instead you whip up a little database, just for them:</p>

<div><div><pre><code><span># Send
</span><span>import</span> <span>duckdb</span>
<span>db</span> <span>=</span> <span>duckdb</span><span>.</span><span>connect</span><span>(</span><span>&#34;weird_rides.db&#34;</span><span>)</span>
<span>db</span><span>.</span><span>sql</span><span>(</span><span>&#34;&#34;&#34;
    CREATE VIEW weird_rides
    AS SELECT pickup_at, dropoff_at, trip_distance, total_amount
    FROM &#39;s3://robotaxi-inc/daily-ride-data/*.parquet&#39;
    WHERE fare_amount &gt; 100 AND trip_distance &lt; 10.0
&#34;&#34;&#34;</span><span>)</span>
<span>db</span><span>.</span><span>close</span><span>()</span>
</code></pre></div></div>

<p>This produces a tiny file called <code>weird_rides.db</code>. It contains none of the actual data. What
it does contain are the above instructions for how to work with this pile of blobs, as if it
were a single table of relevant data points.</p>

<p>You publish this database file to blob storage as well, right next to your data. Now you
have a single thing to link to: <code>s3://robotaxi-inc/virtual-datasets/weird_rides.db</code>.</p>

<p>Instead of opening a web browser, the receipient of the link starts their own local DuckDB
session, and
<a href="https://duckdb.org/docs/guides/network_cloud_storage/duckdb_over_https_or_s3">attaches</a> to
the referenced database.</p>

<div><div><pre><code><span># Receive
</span><span>import</span> <span>duckdb</span>
<span>conn</span> <span>=</span> <span>duckdb</span><span>.</span><span>connect</span><span>()</span>
<span>conn</span><span>.</span><span>sql</span><span>(</span><span>&#34;&#34;&#34;
ATTACH &#39;s3://robotaxi-inc/virtual-datasets/weird_rides.db&#39;
AS rides_db (READ_ONLY)
&#34;&#34;&#34;</span><span>)</span>
</code></pre></div></div>

<div><div><pre><code><span>conn</span><span>.</span><span>sql</span><span>(</span><span>&#34;SELECT * FROM rides_db.weird_rides LIMIT 5&#34;</span><span>)</span>
<span># ┌─────────────────────┬─────────────────────┬───────────────┬──────────────┐
# │      pickup_at      │     dropoff_at      │ trip_distance │ total_amount │
# │      timestamp      │      timestamp      │     float     │    float     │
# ├─────────────────────┼─────────────────────┼───────────────┼──────────────┤
# │ 2019-04-01 00:03:20 │ 2019-04-01 00:03:54 │           0.0 │       240.35 │
# │ 2019-04-01 00:16:16 │ 2019-04-01 00:16:21 │           0.0 │       138.36 │
# │ 2019-04-01 02:01:22 │ 2019-04-01 02:01:28 │           0.0 │       192.96 │
# │ 2019-04-01 06:26:44 │ 2019-04-01 06:27:14 │           0.0 │        115.3 │
# │ 2019-04-01 07:28:12 │ 2019-04-01 07:28:12 │           0.0 │        127.2 │
# └─────────────────────┴─────────────────────┴───────────────┴──────────────┘
</span></code></pre></div></div>

<p>This query is the first time that any data has to be downloaded from S3. DuckDB supports
<a href="https://duckdb.org/docs/data/parquet/overview.html#partial-reading">partial reading</a>, which
means that only the columns used in the definition of the <code>weird_rides</code> view have to be
fetched, and that filters like <code>fare_amount &gt; 100</code> can be used to discard even more
irrelevant data during the download.</p>

<p>From the perspective of the receiver, this way of accessing the data will remain working
unchanged, almost no matter what happens to the underlying data. Changes in
<a href="https://duckdb.org/docs/data/json/overview">format</a>, different <a href="https://duckdb.org/docs/data/multiple_files/overview#parquet">partitioning
strategies</a>, schema changes
– through all of it the receiver’s view remains the same.</p>

<p>With DuckDB as a browser for the data cloud, relational datasets are always just a hyperlink
away.</p>

        </article></div>
  </body>
</html>
