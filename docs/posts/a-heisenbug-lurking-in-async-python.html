<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://textual.textualize.io/blog/2023/02/11/the-heisenbug-lurking-in-your-async-code/">Original</a>
    <h1>A Heisenbug lurking in async Python</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="container">
      
      
        
      
      <main data-md-component="main">
        <div>
          
            
              
                
              
              
            
            
              
                
              
              
            
          
          
  <div data-md-component="content">
    
    <article>
      
        

  
  




<p>I&#39;m taking a brief break from blogging about <a href="https://github.com/Textualize/textual">Textual</a> to bring you this brief PSA for Python developers who work with async code. I wanted to expand a little on this <a href="https://twitter.com/willmcgugan/status/1624419352211603461">tweet</a>.</p>
<!-- more -->

<p>If you have ever used <code>asyncio.create_task</code> you may have created a bug for yourself that is challenging (read <em>almost impossible</em>) to reproduce. If it occurs, your code will likely fail in unpredictable ways.</p>
<p>The root cause of this <a href="https://en.wikipedia.org/wiki/Heisenbug">Heisenbug</a> is that if you don&#39;t hold a reference to the task object returned by <code>create_task</code> then the task may disappear without warning when Python runs garbage collection. In other words the code in your task will stop running with no obvious indication why.</p>
<p>This behavior is <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task">well documented</a>, as you can see from this excerpt (emphasis mine):</p>
<p><img alt="create task" src="https://textual.textualize.io/blog/images/async-create-task.jpeg"/></p>
<p>But who reads all the docs? And who has perfect recall if they do? A search on GitHub indicates that there are a <a href="https://github.com/search?q=%22asyncio.create_task%28%22&amp;type=code">lot of projects</a> where this bug is waiting for just the right moment to ruin somebody&#39;s day.</p>
<p>I suspect the reason this mistake is so common is that tasks are a lot like threads (conceptually at least). With threads you can just launch them and forget. Unless you mark them as &#34;daemon&#34; threads they will exist for the lifetime of your app. Not so with Tasks.</p>
<p>The solution recommended in the docs is to keep a reference to the task for as long as you need it to live. On modern Python you could use <a href="https://docs.python.org/3/library/asyncio-task.html#task-groups">TaskGroups</a> which will keep references to your tasks. As long as all the tasks you spin up are in TaskGroups, you should be fine.</p>

  
  




  



      
    </article>
  </div>

          

        </div>
        
      </main>
      
        
      
    </div></div>
  </body>
</html>
