<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/roscopeco/jasm">Original</a>
    <h1>Show HN: I spent my vacation writing a modern JVM assembler</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 dir="auto"><a id="user-content-jasm---a-jvm-assembler-for-the-modern-age" aria-hidden="true" href="#jasm---a-jvm-assembler-for-the-modern-age"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>JASM - A JVM Assembler for the modern age</h2>
<h3 dir="auto"><a id="user-content-what" aria-hidden="true" href="#what"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What?</h3>
<p dir="auto">JASM is an assembler for JVM bytecode. Because how many times have you needed
<em>that</em> already today?</p>
<p dir="auto">JASM has a <a href="https://github.com/roscopeco/jasm-gradle-plugin">Gradle plugin</a> and
a (WIP) <a href="https://github.com/roscopeco/jasm-intellij-plugin">Plugin for IntelliJ</a>.</p>
<p dir="auto">See the <a href="https://github.com/roscopeco/jasm-example">Example Gradle project</a> for
an example of how JASM might fit in to your project.</p>
<p dir="auto">Let&#39;s just get this out of the way, shall we?</p>
<div data-snippet-clipboard-copy-content="public class com/example/HelloWorld {
    public static main([java/lang/String)V {
        getstatic java/lang/System.out
        ldc &#34;Hello, World&#34;
        invokevirtual java/io/PrintStream.println(java/lang/String)V
        return
    }
}"><pre><span>public</span> <span>class</span> <span>com</span>/<span>example</span>/<span>HelloWorld</span> {
    <span>public</span> <span>static</span> <span>main</span>([<span>java</span>/<span>lang</span>/<span>String</span>)<span>V</span> {
        <span>getstatic</span> <span>java</span>/<span>lang</span>/<span>System</span>.<span>out</span>
        <span>ldc</span> <span>&#34;Hello, World&#34;</span>
        <span>invokevirtual</span> <span>java</span>/<span>io</span>/<span>PrintStream</span>.<span>println</span>(<span>java</span>/<span>lang</span>/<span>String</span>)<span>V</span>
        <span>return</span>
    }
}</pre></div>
<p dir="auto">All your favourite instructions (in fact, <em>all</em> the JVM instructions) are supported:</p>
<div data-snippet-clipboard-copy-content="public class com/example/MyClass
extends com/example/Superclass
implements com/example/SomeInterface {
    public &lt;init&gt;()V {
        aload 0
        invokespecial com/example/Superclass.&lt;init&gt;()V
        return
    }

    public dontAddCanary(java/util/List)V {
        goto skipAdd

        aload 1
        ldc &#34;CANARY&#34;
        invokeinterface java/util/List.add(java/lang/Object)Z 
        
    skipAdd:
        return
    }
}"><pre><span>public</span> <span>class</span> <span>com</span>/<span>example</span>/<span>MyClass</span>
<span>extends</span> <span>com</span>/<span>example</span>/<span>Superclass</span>
<span>implements</span> <span>com</span>/<span>example</span>/<span>SomeInterface</span> {
    <span>public</span> &lt;<span>init</span>&gt;()<span>V</span> {
        <span>aload</span> <span>0</span>
        <span>invokespecial</span> <span>com</span>/<span>example</span>/<span>Superclass</span>.&lt;<span>init</span>&gt;()<span>V</span>
        <span>return</span>
    }

    <span>public</span> <span>dontAddCanary</span>(<span>java</span>/<span>util</span>/<span>List</span>)<span>V</span> {
        <span>goto</span> <span>skipAdd</span>

        <span>aload</span> <span>1</span>
        <span>ldc</span> <span>&#34;CANARY&#34;</span>
        <span>invokeinterface</span> <span>java</span>/<span>util</span>/<span>List</span>.<span>add</span>(<span>java</span>/<span>lang</span>/<span>Object</span>)<span>Z</span> 
        
    <span>skipAdd</span>:
        <span>return</span>
    }
}</pre></div>
<p dir="auto">And you can use advanced JVM features like <code>invokedynamic</code> and dynamic constants that aren&#39;t
directly available in the Java language:</p>
<div data-snippet-clipboard-copy-content="public doBasicInvokeDynamicTest()java/lang/String {
    invokedynamic get()java/util/function/Supplier {
        invokestatic java/lang/invoke/LambdaMetafactory.metafactory(
            java/lang/invoke/MethodHandles$Lookup,
            java/lang/String,
            java/lang/invoke/MethodType,
            java/lang/invoke/MethodType,
            java/lang/invoke/MethodHandle,
            java/lang/invoke/MethodType,
        )java/lang/invoke/CallSite
        [
            ()java/lang/Object,
            invokestatic com/roscopeco/jasm/model/TestBootstrap.lambdaGetImpl()java/lang/String,
            ()java/lang/String
        ]
    }
    
    invokeinterface java/util/function/Supplier.get()java/lang/Object
    checkcast java/lang/String
    areturn
}"><pre><span>public</span> <span>doBasicInvokeDynamicTest</span>()<span>java</span>/<span>lang</span>/<span>String</span> {
    <span>invokedynamic</span> <span>get</span>()<span>java</span>/<span>util</span>/<span>function</span>/<span>Supplier</span> {
        <span>invokestatic</span> <span>java</span>/<span>lang</span>/<span>invoke</span>/<span>LambdaMetafactory</span>.<span>metafactory</span>(
            <span>java</span>/<span>lang</span>/<span>invoke</span>/<span>MethodHandles$Lookup</span>,
            <span>java</span>/<span>lang</span>/<span>String</span>,
            <span>java</span>/<span>lang</span>/<span>invoke</span>/<span>MethodType</span>,
            <span>java</span>/<span>lang</span>/<span>invoke</span>/<span>MethodType</span>,
            <span>java</span>/<span>lang</span>/<span>invoke</span>/<span>MethodHandle</span>,
            <span>java</span>/<span>lang</span>/<span>invoke</span>/<span>MethodType</span>,
        )<span>java</span>/<span>lang</span>/<span>invoke</span>/<span>CallSite</span>
        [
            ()<span>java</span>/<span>lang</span>/<span>Object</span>,
            <span>invokestatic</span> <span>com</span>/<span>roscopeco</span>/<span>jasm</span>/<span>model</span>/<span>TestBootstrap</span>.<span>lambdaGetImpl</span>()<span>java</span>/<span>lang</span>/<span>String</span>,
            ()<span>java</span>/<span>lang</span>/<span>String</span>
        ]
    }
    
    <span>invokeinterface</span> <span>java</span>/<span>util</span>/<span>function</span>/<span>Supplier</span>.<span>get</span>()<span>java</span>/<span>lang</span>/<span>Object</span>
    <span>checkcast</span> <span>java</span>/<span>lang</span>/<span>String</span>
    <span>areturn</span>
}</pre></div>
<p dir="auto">There&#39;s a smidge of syntactic sugar around types in case you just can&#39;t
get used to the JVM internal names (for primitives), so you can do e.g. :</p>
<div data-snippet-clipboard-copy-content="public myGreatMethod(int, long, java/util/List) java/util/List {
    
    // cool assembly stuff...
        
}"><pre><span>public</span> <span>myGreatMethod</span>(int, long, <span>java</span>/<span>util</span>/<span>List</span>) <span>java</span>/<span>util</span>/<span>List</span> {
    
    <span>// cool assembly stuff...</span>
        
}</pre></div>
<p dir="auto">There are lots of examples in <a href="https://github.com/roscopeco/jasm/blob/develop/src/test/resources/jasm">the tests</a> showing the syntax for
the different instructions and with examples of how they&#39;re used.</p>
<h3 dir="auto"><a id="user-content-how" aria-hidden="true" href="#how"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How?</h3>
<h4 dir="auto"><a id="user-content-requirements" aria-hidden="true" href="#requirements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Requirements</h4>
<ul dir="auto">
<li>Java 11 or higher is required to run the tool and/or gradle plugin
<ul dir="auto">
<li>(However, JASM can assemble classes targeted at any JVM version!)</li>
</ul>
</li>
</ul>
<h4 dir="auto"><a id="user-content-using-the-gradle-plugin" aria-hidden="true" href="#using-the-gradle-plugin"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Using the Gradle plugin</h4>
<p dir="auto">If you just want to use some JASM code in your own Gradle project, the easiest way to get started is
via the <a href="https://plugins.gradle.org/plugin/com.roscopeco.jasm" rel="nofollow">Gradle plugin</a>.</p>
<p dir="auto">For more information and some documentation about the plugin, see the
<a href="https://github.com/roscopeco/jasm-gradle-plugin">Github repo</a></p>
<h4 dir="auto"><a id="user-content-using-the-command-line-tool" aria-hidden="true" href="#using-the-command-line-tool"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Using the command-line tool</h4>
<p dir="auto">If you <a href="https://github.com/roscopeco/jasm/releases">downloaded a binary distribution</a> then
you should be all set. Inside the archive you&#39;ll find a `bin/jasm&#39; script that will take
care of running the command-line tool for you.</p>
<p dir="auto">To see usage details:</p>
<p dir="auto"><code>bin/jasm --help</code></p>
<p dir="auto">To simply assemble a file <code>src/com/example/MyClass.jasm</code> to the <code>classes</code> directory:</p>
<p dir="auto"><code>bin/jasm -i src -o classes com/example/MyClass.jasm</code></p>
<p dir="auto">Notice that you set the source and destination directories, and just pass the relative
path to the files within them - this is how the assembler creates the class files in the
appropriate place the JVM expects to find them.</p>
<h4 dir="auto"><a id="user-content-building-the-tool-with-gradle" aria-hidden="true" href="#building-the-tool-with-gradle"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Building the tool with Gradle</h4>
<p dir="auto">If you grabbed the source from <a href="https://github.com/roscopeco/jasm">Github</a> you can
easily build a binary distribution with <code>./gradlew clean assemble</code> (pun not intended).</p>
<h4 dir="auto"><a id="user-content-using-jasm-as-a-library" aria-hidden="true" href="#using-jasm-as-a-library"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Using JASM as a library</h4>
<p dir="auto">If you want to use this as a library (with Maven or Gradle), you&#39;ll want to
pull in the dependency from Maven central.</p>
<p dir="auto">E.g. (for Gradle):</p>
<div data-snippet-clipboard-copy-content="dependencies {
  implementation(&#34;com.roscopeco.jasm:jasm:0.4.0&#34;)
}"><pre>dependencies {
  implementation(<span><span>&#34;</span>com.roscopeco.jasm:jasm:0.4.0<span>&#34;</span></span>)
}</pre></div>
<h3 dir="auto"><a id="user-content-why" aria-hidden="true" href="#why"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Why??</h3>
<p dir="auto">Well, <strong>why not</strong>?</p>
<p dir="auto">I wrote this for fun, which I had both in writing it and playing with it.</p>
<p dir="auto">I release it without any real expectation that it will be <em>useful</em>, but with
the sincere hope that you too might find it fun.</p>
<p dir="auto">If you really need some use-cases to justify the electrons squandered in
pursuit of this project, how about these (some lifted from Jasmin&#39;s README):</p>
<ul dir="auto">
<li>
<p dir="auto">Curious People - Want to understand more about the way JVM bytecode works
or the things that are possible at the bytecode level? Always wondered what
<code>invokedynamic</code> is for? Curious as to how <code>@SneakyThrows</code> can possibly work?
This might help!</p>
</li>
<li>
<p dir="auto">System Implementors - If you&#39;re writing a JVM or runtime this could be useful
for generating test classes...</p>
</li>
<li>
<p dir="auto">Advanced Programmers - You could hand-generate critical classes or methods
if you think Javac isn&#39;t doing the right thing (but spoiler alert: by this
point, it almost certainly is).</p>
</li>
<li>
<p dir="auto">Language Implementors - You could use this as an IL if you liked, rather
than getting involved in the nuts and bolts of the binary <code>.class</code> format.</p>
</li>
<li>
<p dir="auto">Security Researchers - Create hostile classes and see if you can sneak them
past the class verifier.</p>
</li>
<li>
<p dir="auto">Teachers - Perhaps you&#39;re teaching a compiler course, maybe you could use this
to introduce students to JVM bytecode, or even as an IL for the compilers.</p>
</li>
</ul>
<h3 dir="auto"><a id="user-content-who" aria-hidden="true" href="#who"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Who?</h3>
<p dir="auto">JASM is copyright 2022 Ross Bamford (roscopeco AT gmail DOT com).</p>
<p dir="auto">See LICENSE.md for the gory legal stuff (spoiler: MIT).</p>
</article>
          </div></div>
  </body>
</html>
