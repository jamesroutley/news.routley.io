<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.paradedb.com/pages/iceberg_lakehouse">Original</a>
    <h1>Putting DuckDB in Postgres to Query Iceberg</h1>
    
    <div id="readability-page-1" class="page"><div><p>Written by Ming Ying on June 26, 2024</p>
<p><img src="https://mintlify.s3-us-west-1.amazonaws.com/paradedb-blog/images/iceberg_lakehouse_splash.png"/></p><p>Today, a growing number of organizations are offloading large volumes of historical data from Postgres to S3
due to its scalability and cost effectiveness. Many of these organizations are also adopting
<a href="https://iceberg.apache.org/" target="_blank" rel="noreferrer">Apache Iceberg</a>, a <a href="https://blog.paradedb.com/_sites/blog.paradedb.com/pages/iceberg_lakehouse#what-is-apache-iceberg">table format</a> that enables S3 data to be
queried like SQL tables.</p>
<p>While query engines like Trino, Spark, or Flink integrate with Iceberg, Postgres does not. Since we launched <code>pg_lakehouse</code>,
Iceberg integration has been our most widely requested feature.</p>
<p>We’re excited to announce that Iceberg tables are now supported for S3 and Google Cloud Storage.
As part of this release, we’ve replaced <code>pg_lakehouse</code>’s DataFusion query engine with DuckDB. We initially experimented with DuckDB for its Iceberg support and have been pleasantly
surprised by the ways that DuckDB has accelerated our engineering efforts. In the latter half of this blog post, we’ll share some of the benefits and tradeoffs we’ve seen between
DataFusion and DuckDB.</p>
<h2 id="what-is-apache-iceberg"><span>What is Apache Iceberg?</span></h2>
<p>Built for analytics over large datasets, Iceberg is an open source specification for organizing metadata around files like Parquet. Iceberg metadata allows these files can be treated as
SQL tables with features like ACID transactions, schema evolution, time travel, and partitioning. For this reason, Iceberg is commonly referred to as a table format.</p>
<h2 id="supporting-iceberg-in-postgres"><span>Supporting Iceberg in Postgres</span></h2>
<p><img src="https://mintlify.s3-us-west-1.amazonaws.com/paradedb-blog/images/duckdb_lakehouse_architecture.png"/></p><p>Today, interoperability with Iceberg is missing from the Postgres ecosystem. Instead, Postgres users who adopt Iceberg may operate a system like Trino, Spark, or Flink to query Iceberg tables.</p>
<p><code>pg_lakehouse</code> adds support for Iceberg to Postgres with the foreign data wrapper API. The following code block demonstrates how to query Iceberg tables from Postgres.</p>
<div><div><pre><code><span>CREATE</span> EXTENSION pg_lakehouse<span>;</span>

<span>CREATE</span> <span>FOREIGN</span> <span>DATA</span> WRAPPER iceberg_wrapper
<span>HANDLER</span> iceberg_fdw_handler
VALIDATOR iceberg_fdw_validator<span>;</span>

<span>CREATE</span> SERVER iceberg_server
<span>FOREIGN</span> <span>DATA</span> WRAPPER iceberg_wrapper<span>;</span>


<span>CREATE</span> <span>FOREIGN</span> <span>TABLE</span> iceberg_table <span>(</span>x <span>INT</span><span>)</span>
SERVER iceberg_server
OPTIONS <span>(</span>files <span>&#39;s3://bucket/iceberg_folder&#39;</span><span>)</span><span>;</span>


<span>SELECT</span> <span>COUNT</span><span>(</span><span>*</span><span>)</span> <span>FROM</span> iceberg_table<span>;</span>
</code></pre></div></div>
<p>Unlike the typical foreign data wrapper, <code>pg_lakehouse</code> can push most queries entirely down to DuckDB. This means that <code>pg_lakehouse</code> delivers the analytical performance of DuckDB inside Postgres.
You can read more about how we achieved this in our <a href="https://blog.paradedb.com/pages/introducing_lakehouse#how-its-built">earlier blog post</a>.</p>
<h2 id="why-we-initially-picked-datafusion"><span>Why We Initially Picked DataFusion</span></h2>
<p>In January 2024, we evaluated both DuckDB and DataFusion as candidates for ParadeDB’s analytical query engine and chose <a href="https://github.com/apache/datafusion" target="_blank" rel="noreferrer">DataFusion</a>.
At the time, several aspects of DataFusion appealed to us:</p>
<h3 id="extensibility"><span>Extensibility</span></h3>
<p>DuckDB and DataFusion are both in-process query systems. However, DataFusion targets database developers while DuckDB targets end users. This means that DataFusion’s API has many more
extension points than DuckDB’s, which we hoped would simplify the integration path with Postgres.</p>
<h3 id="growing-adoption"><span>Growing Adoption</span></h3>
<p>DataFusion is quickly becoming the de facto query engine of modern analytical databases. InfluxDB, a popular time series database, relies on DataFusion and has contributed heavily to its
development. Comet, a Spark accelerator built on DataFusion, was open sourced by Apple in February 2024. And in June 2024, DataFusion became a top-level Apache project.</p>
<h3 id="written-in-rust"><span>Written in Rust</span></h3>
<p>Whereas DuckDB is written in C/C++, DataFusion is written in Rust. We felt more comfortable reading and modifying DataFusion’s code.</p>
<h2 id="why-we-switched-to-duckdb"><span>Why We Switched to DuckDB</span></h2>
<p>After months of using DataFusion, we decided to go all in on <a href="https://github.com/duckdb/duckdb" target="_blank" rel="noreferrer">DuckDB</a>. This was not because we were dissatisfied with DataFusion — in fact, we found
DataFusion to be an incredibly robust and ergonomic library — but because our use case changed.</p>
<p>Last month, we quietly paused development on our original analytics extension, <code>pg_analytics</code> (we’ll share why in a future blog post). <code>pg_analytics</code> used the Postgres table access method, which
meant that it was our responsibility to implement many of the complex features of Postgres like write-ahead logs, multi-version concurrency control, support for various transaction levels,
buffer caching, etc. DataFusion’s extensibility was very useful here.</p>
<p><code>pg_lakehouse</code> , on the other hand, uses the foreign data wrapper API, which is more straightforward to implement and does not require the query engine to be very extensible. As a result, we
began to appreciate the benefits of DuckDB:</p>
<h3 id="out-of-the-box-integrations"><span>Out-of-the-Box Integrations</span></h3>
<p>DuckDB’s Iceberg extension has existed for over a year. On the other hand, Iceberg support for DataFusion is in a nascent stage as part of the <a href="https://github.com/apache/iceberg-rust" target="_blank" rel="noreferrer">iceberg-rust</a> project.
DuckDB also integrates with <a href="https://delta.io/" target="_blank" rel="noreferrer">Delta Lake</a> — Iceberg’s rival table format — and object stores like Azure ADLS. When we built these integrations with DataFusion, we had to glue several libraries
together. We were happy to offload the responsibility of testing and maintaining those integrations to DuckDB.</p>
<h3 id="more-familiar-to-end-users"><span>More Familiar to End Users</span></h3>
<p>When we launched the first version of <code>pg_lakehouse</code>, we received several bug reports from users who attempted to query files using the
<a href="https://duckdb.org/docs/data/parquet/overview.html#examples" target="_blank" rel="noreferrer">DuckDB glob pattern</a>, which DataFusion did not recognize. We realized that, while DataFusion is well regarded among database
developers, DuckDB is more familiar to the general developer community. Users who were told that <code>pg_lakehouse</code> was “DuckDB in Postgres” seemed to gain an immediate understanding of the use
case and value proposition of the extension.</p>
<h3 id="better-performance"><span>Better Performance</span></h3>
<p>In many <a href="https://benchmark.clickhouse.com/" target="_blank" rel="noreferrer">benchmarks</a>, DuckDB’s performance surpasses DataFusion’s. Although <a href="https://motherduck.com/blog/perf-is-not-enough/" target="_blank" rel="noreferrer">performance is not enough</a> and
DataFusion’s performance is catching up, the performance boost resonates with users with sub-second query latency requirements.</p>
<h2 id="next-steps"><span>Next Steps</span></h2>
<p>The next big feature we’re working on for<code>pg_lakehouse</code> is write support, which will enable Postgres tables to be copied into external object stores as Parquet or CSV files.</p>
<p>Iceberg is supported on <code>pg_lakehouse</code> version <code>0.8.0</code> or later. You can either install the extension or run the Docker image. If you have any questions, the best place to start is our
<a href="https://join.slack.com/t/paradedbcommunity/shared_invite/zt-2lkzdsetw-OiIgbyFeiibd1DG~6wFgTQ" target="_blank" rel="noreferrer">Slack community</a>. And please don’t hesitate to show your support by
<a href="https://github.com/paradedb/paradedb" target="_blank" rel="noreferrer">giving us a star</a>!</p></div></div>
  </body>
</html>
