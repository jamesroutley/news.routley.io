<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.saeloun.com/2022/02/23/rails-fiber-safe-connection-pools.html">Original</a>
    <h1>Rails adds support for Fiber-safe ActiveRecord ConnectionPools</h1>
    
    <div id="readability-page-1" class="page"><div>
    


    <div role="main">
      <div>
        






<article>
  <p>One of the major focuses for Ruby 3 was parallelism 
and concurrency.
A trailblazer in this space is the use of Ruby Fibers.
Fibers are a concurrency mechanism that allows us to pause, loop, 
and resume execution while consuming far fewer context switches.
It consumes less memory than threads 
while giving the developer control over code segment execution.</p>

<p>Fibers are the best solution for scalable non-blocking clients 
and servers.
However, it has taken Rails a while to make use of it.</p>

<h3 id="before">Before</h3>

<p>As Rails continues to replace the usage of threads with fibers, 
the performance will only get better.
One area of development is ActiveRecord 
which until now still depended on threads, 
despite configuring ActiveSupport’s isolation level.
An isolation level determines how database tractions 
are propagated to other users 
and systems.</p>

<p>Why is that important?
Well for that we need to understand 
what ActiveRecord’s ConnectionPool is.
A connection pool manages multiple ActiveRecord connections. 
A connection essentially performs a transaction on a database.
To perform this transaction, 
Rails offloads the I/O operation to a thread 
where every thread maintains a separate DB connection (in the case of Puma). 
Otherwise individual conversations with the database could mix up.
Now that there is a more performant alternative to threads, 
ActiveRecord should switch over!
Sadly, it does not.</p>

<p>Let’s configure <code>config.active_support.isolation_level</code> to <code>fiber</code>,</p>

<figure><pre><code data-lang="ruby"><span>module</span> <span>Myapp</span>
  <span>class</span> <span>Application</span> <span>&lt;</span> <span>Rails</span><span>::</span><span>Application</span>
    <span>config</span><span>.</span><span>active_support</span><span>.</span><span>isolation_level</span> <span>=</span> <span>:fiber</span>
  <span>end</span>
<span>end</span></code></pre></figure>

<p>Now let’s check how a ConnectionPool converses with the database.</p>

<figure><pre><code data-lang="ruby"><span>&gt;</span> <span>Rails</span><span>.</span><span>application</span><span>.</span><span>config</span><span>.</span><span>active_support</span><span>.</span><span>isolation_level</span>
<span>=&gt;</span> <span>:fiber</span>
<span>&gt;</span> <span>ActiveRecord</span><span>::</span><span>Base</span><span>.</span><span>connection_pool</span><span>.</span><span>send</span><span>(</span><span>:current_thread</span><span>)</span>
<span>=&gt;</span> <span>#&lt;Thread:0x00007f9ba485fa88 run&gt;</span></code></pre></figure>

<p>ActiveRecord’s ConnectionPool does not honor ActiveSupport’s isolation level!</p>

<h3 id="after">After</h3>

<p>Fortunately, 
<a href="https://github.com/rails/rails/pull/44219/files">this PR</a> 
migrated overall 
ConnectionPool’s conversations 
to either use Threads or Fibers.</p>

<p>Now let’s have a look!</p>

<figure><pre><code data-lang="ruby"><span>&gt;</span> <span>Rails</span><span>.</span><span>application</span><span>.</span><span>config</span><span>.</span><span>active_support</span><span>.</span><span>isolation_level</span>
<span>=&gt;</span> <span>:fiber</span>
<span>&gt;</span> <span>ActiveRecord</span><span>::</span><span>Base</span><span>.</span><span>connection_pool</span><span>.</span><span>send</span><span>(</span><span>:current_thread</span><span>)</span>
<span>=&gt;</span> <span>#&lt;Fiber:0x00007fb5515d5238 (resumed)&gt;</span></code></pre></figure>

<p>Great! But, what does this mean?
Ideally, 
in the foreseeable future, 
we can expect good performance improvements to Rails I/O operations.
Currently, 
Rails abstracts execution using <code>IsolatedExecutionState</code>, 
at least that’s what it is supposed to do. 
However, 
as one looks around the Rails codebase, 
there seems to be a lot of code 
that is hard-wired to a thread-centric implementation.
So there’s a lot of work for the Rails core team, 
jump in 
and contribute today!</p>

</article>


  










  


      </div>
    </div>
  </div></div>
  </body>
</html>
