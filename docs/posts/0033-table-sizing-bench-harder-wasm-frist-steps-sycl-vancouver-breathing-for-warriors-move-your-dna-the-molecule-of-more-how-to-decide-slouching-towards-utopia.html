<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://scattered-thoughts.net/log/0033/">Original</a>
    <h1>0033: table sizing, bench harder, wasm frist steps, sycl vancouver, breathing for warriors, move your dna, the molecule of more, how to decide, slouching towards utopia</h1>
    
    <div id="readability-page-1" class="page"><article>
  <p>February was really broken up by <a href="https://systemsdistributed.com/">Systems Distributed</a> so not as much coding or papers to talk about as I&#39;d like. The talks were all recorded but I don&#39;t know when they&#39;ll be published yet.</p>
<ul>
<li>tigerbeetle
<ul>
<li>table sizing</li>
<li>bench harder</li>
</ul>
</li>
<li>wasm first steps</li>
<li>sycl vancouver</li>
<li>reading
<ul>
<li>breathing for warriors</li>
<li>move your dna</li>
<li>the molecule of more</li>
<li>how to decide</li>
<li>slouching towards utopia</li>
</ul>
</li>
</ul>
<h2 id="table-sizing">table sizing</h2>
<p>LSM trees have in-memory buffers that get periodically compacted into on-disk tables. In tigerbeetle, the on-disk tables are 64mb and the buffers vary in size depending on the tree but the largest was 4kb. </p>
<p><a href="https://github.com/tigerbeetledb/tigerbeetle/pull/244">Way back in November</a> I was worrying about the relative sizes. The size of the buffer dictates how often we need to do compaction. The size of the tables dictates how expensive compaction can be. For every 4kb of incoming data, we might have to write up to 8 * 64mb of data to disk during compaction. That&#39;s a terrible amount of write amplification. </p>
<p>I finally got around to fixing this, making the <a href="https://github.com/tigerbeetledb/tigerbeetle/pull/485">table size match the buffer size</a> and <a href="https://github.com/tigerbeetledb/tigerbeetle/pull/492">then increasing the buffer size</a> to match what we expect to eventually use in production. </p>
<p>This had no effect on the performance in our benchmark, which was puzzling. DJ realized that the way that data is generated in the benchmark makes every index append-only, and so it&#39;s not actually stressing compaction at all. I tweaked the data generation a little to force just one index to have to compact. Throughput dropped from 129k transfers per second to 14k, and then applying the table size patch brought it back up to 83k. So the table sizing was a big problem but we actually weren&#39;t measuring it before. </p>
<h2 id="bench-harder">bench harder</h2>
<p>With that in mind I spent some time <a href="https://github.com/tigerbeetledb/tigerbeetle/pull/495">fleshing out the benchmarks</a> to try to avoid having similar blind spots in future. I also extended them to <a href="https://github.com/tigerbeetledb/tigerbeetle/pull/461">measure end-to-end latency</a> per transfer in addition to the processing latency per batch, and to allow varying the offered load so that we can draw throughput-latency curves rather than just getting a single point.</p>
<p>The new workload stresses compaction and caching a lot more so the overall throughput is lower, but King has been working through the <a href="https://github.com/tigerbeetledb/tigerbeetle/issues/274">compaction todo list</a> this month and clawing some of the throughput back. At present I&#39;m seeing 88k transfers per second with the default benchmark settings, with a p90 batch latency of 47ms and a p100 batch latency of &gt;4s (the latter being from checkpointing the superblock and client tables, which is not yet incremental).</p>
<p>I also tried running a much longer benchmark - ingesting a billion transfers as fast as possible. At some point there was a very sharp phase-change in performance, with throughput dropping to 8k t/s and p100 batch latency though the roof. It also bounces between short periods of high write bandwidth (presumably compaction) and long periods of high read bandwidth. I haven&#39;t had a chance to explore this properly yet, but I speculate that what is happening is that once the database is large enough the bloom filters alone don&#39;t fit into the cache, and then the transfer id uniqueness checks end up needing to hit the disk <strong>per transfer</strong> instead of mostly being negative bloom filter lookups. I know that this can a problem for rocksdb and they offer <a href="https://rocksdb.org/blog/2017/05/12/partitioned-index-filter.html">partitioned bloom filters</a> to address this, but that seems like a lot of complexity to add to tigerbeetle. Hopefully we just need to better tune cache sizes based on the maximium database size.</p>
<h2 id="wasm-first-steps">wasm first steps</h2>
<p>I&#39;ve meaning to learn more about webassembly for a while. For all the standard reasons - targetting the web with sane languages, portability across many platforms, language-agnostic sandboxing - but also because it&#39;s becoming an interesting middleware target. It&#39;s much easier to analyze and transform than x86, and much more stable than llvm ir. Projects like <a href="https://github.com/kettle11/tangle">tangle</a> and <a href="https://kripken.github.io/blog/wasm/2019/07/16/asyncify.html">asyncify</a> are just the start.</p>
<p>I hand-ported zig&#39;s <a href="https://github.com/ziglang/zig/blob/2641feb9b98e794608917231c2fa775ea4daea06/stage1/wasm2c.c">wasm2c</a> to zig (hand-ported because I thought I&#39;d understand the code after translating it line by line) and hooked it up the <a href="https://github.com/WebAssembly/testsuite">wasm spec testsuite</a>. For a codebase that was stripped down and specialized to <a href="https://github.com/ziglang/zig/blob/2641feb9b98e794608917231c2fa775ea4daea06/stage1/zig1.wasm">a single input</a> it does pretty well on the tests, passing the tests for 796/1125 modules (ignoring the simd tests, which are definitely not supported). </p>
<p>More to come on this front when I have time.</p>
<h2 id="sycl-vancouver">sycl vancouver</h2>
<p>Matt Knight is running a Vancouver version of the <a href="https://softwareyoucanlove.ca/">software you can love</a> conference. </p>
<p>I&#39;ll probably be there, since it&#39;s a short walk from my apartment. Just waiting on other plans to shape up before committing to a ticket.</p>
<p>I recommend attending, because if people come here then I don&#39;t have to go to them :)</p>
<h2 id="breathing-for-warriors"><a href="https://www.goodreads.com/book/show/48587287-breathing-for-warriors">breathing for warriors</a></h2>
<p>Possibly the worst book I&#39;ve ever read. Incredibly repetitive, barely coherent, often self-contradictory. </p>
<p>I&#39;m looking for recommendations on a book about breathing techniques that is not awful.</p>
<h2 id="move-your-dna"><a href="https://www.goodreads.com/book/show/35006788-move-your-dna">move your dna</a></h2>
<p>Not terribly well supported by its own citations, but has a couple of interesting suggestions. </p>
<h2 id="the-molecule-of-more"><a href="https://www.goodreads.com/book/show/41066898-the-molecule-of-more">the molecule of more</a></h2>
<p>Did you know that everything is dopamine? Pop trash, avoid.</p>
<h2 id="there-are-places-in-the-world-where-rules-are-less-important-than-kindness"><a href="https://www.goodreads.com/book/show/53993435-there-are-places-in-the-world-where-rules-are-less-important-than-kindne">there are places in the world where rules are less important than kindness</a></h2>
<p>A collection of newspaper columns written by a famous physicist. Fun easy reading. Was welcome on the flight to cape town where my brain was too foggy for anything serious.</p>
<h2 id="how-to-decide"><a href="https://www.goodreads.com/book/show/51066664-how-to-decide">how to decide</a></h2>
<p>The second book by Annie Duke after <a href="https://www.goodreads.com/book/show/35957157-thinking-in-bets">thinking in bets</a>. </p>
<p>It&#39;s well written. Doesn&#39;t contain anything surprising if you&#39;ve had any prior exposure to the subject but would make a good introduction if you haven&#39;t.</p>
<h2 id="slouching-towards-utopia"><a href="https://www.goodreads.com/book/show/9283648-slouching-towards-utopia">slouching towards utopia</a></h2>
<p>I nearly dropped it because the intro was so meandering, but it shapes up once it gets into the meat of the subject. It doesn&#39;t seem to have a central message or theme but each chapter was interesting in its own right.</p>
<p>I&#39;m not sure how much of the non-economic history to put weight in. Eg after Japan invaded China, the US was under pressure to limit their expansion. They froze all Japanese assets in the US, which was supposed to be a moderate slap on the wrist. But all the other oil-producing countries would only accept payment in US dollars so the asset freeze amounted to a total oil embargo. That&#39;s how the author presents it. But when I looked this up I found that the US also stopped exporting oil to Japan and denied them access to the Dutch East Indies, which sounds like a very deliberate oil embargo. </p>
<p>The economic parts are presumably more accurate. Probaby most interesting was the authors explanation for the rise of neoliberalism, which he lived through and was somewhat mystified by at the time.</p>

</article></div>
  </body>
</html>
