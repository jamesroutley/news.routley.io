<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erisa.dev/exposing-a-web-service-with-cloudflare-tunnel/">Original</a>
    <h1>Exposing a web service with Cloudflare Tunnel (2022)</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
    <div>

        <article>

            

            <figure>
                <img srcset="/content/images/size/w300/2022/02/jakob-soby-RjPG-_LVmiQ-unsplash.jpg 300w,
                            /content/images/size/w600/2022/02/jakob-soby-RjPG-_LVmiQ-unsplash.jpg 600w,
                            /content/images/size/w1000/2022/02/jakob-soby-RjPG-_LVmiQ-unsplash.jpg 1000w,
                            /content/images/size/w2000/2022/02/jakob-soby-RjPG-_LVmiQ-unsplash.jpg 2000w" sizes="(max-width: 800px) 400px,
                        (max-width: 1170px) 1170px,
                            2000px" src="https://erisa.dev/content/images/size/w2000/2022/02/jakob-soby-RjPG-_LVmiQ-unsplash.jpg" alt="Exposing a web service with Cloudflare Tunnel"/>
            </figure>

            <section>
                <div>
                    <p>There are lots of ways to host a web service.</p><p>But sometimes you might not have it all figured out. You might want to run your service in your home on that one old laptop you have lying around, or you might be worried about forwarding your IP and connections to the world without properly securing them. Setting it all up sounds like a hassle, right?</p><p>This is where I believe a hidden gem of Cloudflare comes out to shine.</p><blockquote>Ensure your server is safe, no matter where it’s running: public cloud, private cloud, Kubernetes cluster, or even a Mac mini under your TV.</blockquote><p>Even with the best firewall in the world, you still have machines exposed to the public Internet.</p><p>But what if you could host a web service with no ports exposed? Well, you can! Cloudflare Tunnel makes a persistent outbound connection (a tunnel!) between your server and Cloudflare&#39;s nearest datacenter. All the traffic to your domain flows through this outgoing tunnel and connects to your server through the protection of Cloudflare. This also has the benefit of being seamlessly encrypted, so you don&#39;t have to worry about a thing when it comes to the security of your web service.</p><p>If you, like me, think that sounds amazing, read on to get started creating your own tunnel.</p><h3 id="getting-started">Getting started</h3><blockquote>Note: There is now an easier way to create and manage tunnels through the Cloudflare Zero Trust dashboard.</blockquote><p>For this walkthrough I will assume you are on a Linux-based operating system. For testing I used Ubuntu 20.04. Some things may vary if you have a different system, though on Debian at least it should be the same.</p><p>This walkthrough also assumes that you have a Cloudflare account with a domain on it already, if you don&#39;t have one then you should add one and return here!</p><p>I also asssume a small level of technical and command-line ability, but it isn&#39;t anything overlay daunting so feel free to give it a go regardless! I&#39;m in the comments if you get stuck!</p><p>First things first, you&#39;ll need to download <code>cloudflared</code>, the command-line client for interacting with Cloudflare Tunnels. The <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide?ref=erisa.dev">official documentation</a> is a bit better at explaining this than I am, but for a x86_64 Ubuntu machine you would do the following:</p><p><code>$ wget -q </code><a href="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb?ref=erisa.dev"><code>https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb</code></a></p><figure><img src="https://erisa.dev/content/images/2022/02/image.png" alt="The wget, dpkg and &#34;cloudflared version&#34; command described above being executed. The dpkg command returns the installation output for cloudflared while &#34;cloudflared version&#34; returns &#34;cloudflared version 2022.2.0 (built 2022-02-04-114 UTC)&#34;" loading="lazy" width="1095" height="311" srcset="https://erisa.dev/content/images/size/w600/2022/02/image.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image.png 1000w, https://erisa.dev/content/images/2022/02/image.png 1095w" sizes="(min-width: 720px) 720px"/><figcaption><span>The wget, dpkg and &#34;cloudflared version&#34; command described above being executed. The dpkg command returns the installation output for cloudflared while &#34;cloudflared version&#34; returns &#34;cloudflared version 2022.2.0 (built 2022-02-04-114 UTC)&#34;</span></figcaption></figure><p>Now that you have the client running, you need to authorize with your Cloudflare account:</p><p>This will give out a URL that you can visit to authorise yourself. While it isn&#39;t 100% vital that you select the right domain at this stage, I would recommend choosing one that you would like to try out a tunnel on. You can run the tunnel on any subdomain or domain later down the road.</p><p>For this example I picked <code>erisa.dev</code> and I am now logged in!</p><figure><img src="https://erisa.dev/content/images/2022/02/image-5.png" alt="The prompt shown after a successful Cloudfolared authorisation. It reads &#34;Cloudflared has installed a certificate allowing your origin to create a Tunnel on this zone. You may now close this window and start your Cloudflare Tunnel!" loading="lazy" width="1083" height="259" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-5.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-5.png 1000w, https://erisa.dev/content/images/2022/02/image-5.png 1083w" sizes="(min-width: 720px) 720px"/></figure><figure><img src="https://erisa.dev/content/images/2022/02/image-10.png" alt="The command &#34;cloudflared tunnel login&#34; being ran. The output is a dash.cloudflare.com URL and afterwards &#34;You have successfully logged in.&#34;" loading="lazy" width="1092" height="327" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-10.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-10.png 1000w, https://erisa.dev/content/images/2022/02/image-10.png 1092w" sizes="(min-width: 720px) 720px"/><figcaption><span>The command &#34;cloudflared tunnel login&#34; being ran. The output is a dash.cloudflare.com URL and afterwards &#34;You have successfully logged in.&#34;</span></figcaption></figure><p>After logging yourself in, you can now get started creating tunnels!</p><p><code>$ cloudflared tunnel create mytunnel</code></p><p>You can name it whatever you want, in this case I chose <code>mytunnel</code> as my tunnel&#39;s name.</p><figure><img src="https://erisa.dev/content/images/2022/02/image-11.png" alt="The command &#34;cloudflared tunnel create mytunnel&#34; being ran. The output describes the actions that were taken and gives a unique ID for the tunnel as well as a file path to the tunnel credentials. It says &#34;Keep this file secret. To revoke these credentials, delete the tunnel.&#34;" loading="lazy" width="1097" height="196" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-11.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-11.png 1000w, https://erisa.dev/content/images/2022/02/image-11.png 1097w" sizes="(min-width: 720px) 720px"/></figure><p>After issuing this command you&#39;re going to get two important pieces of information: the file path to a .json file containing the tunnels credentials, and an ID for tunnel. In this case I have a tunnel with an ID of <code>ed5bfe16-cb5f-449c-b2e9-7c300b749c79</code> and the credentials are stored at <code>/home/ubuntu/.cloudflared/ed5bfe16-cb5f-449c-b2e9-7c300b749c79.json</code>.</p><p>Keep this information to hand, because you will need it in a minute!</p><p>At this point, you could happily go ahead and configure a tunnel with your own user account and run it with <code>$ cloudflared tunnel run mytunnel</code> however the best practise would be in setting up a <code>systemd</code>service for your tunnel from the beginning. So this is what I will be instructing!</p><p>First, we need a directory to store the config:</p><p><code>$ sudo mkdir -p /etc/cloudflared</code></p><p>Then, we can get started creating a configuration file!</p><p><code>$ sudo nano /etc/cloudflared/config.yml</code></p><p>Once in the file, we need to put the basic pieces together.</p><p>The first thing you will want to specify is the tunnel ID and the location of the credentials file. These are the same things we noted earlier!</p><p>Using mine as an example, it should be formatted like this:</p><pre><code>tunnel: ed5bfe16-cb5f-449c-b2e9-7c300b749c79
credentials-file: /home/ubuntu/.cloudflared/ed5bfe16-cb5f-449c-b2e9-7c300b749c79.json
</code></pre><p>And with that out of the way, we can now configure what the tunnel will serve, hurray!</p><hr/><p>To continue following through with this tutorial you will need something to host.</p><p>If you don&#39;t have any web services running already, you can run a test webserver in a few ways:</p><blockquote>
<p>You can serve the contents of a directory with Python:</p>
</blockquote>
<blockquote>Or you can instead install a full webserver like <a href="https://www.nginx.com/?ref=erisa.dev">Nginx</a>:</blockquote><hr/><p>There are two main ways to approach the <code>ingress:</code> part of the config.yml.</p><p>If you have only one service or want to route everything through your own existing webserver, you can do a single-service setup:</p><figure><pre><code>ingress:
  - service: http://localhost:80</code></pre><figcaption><p><span>You can change localhost to any IP and :80 to any port.</span></p></figcaption></figure><p>Or if you want to serve specific things on specific domains, you can do that as well:</p><pre><code>ingress:
  - hostname: myapp1.examples.com
    service: http://localhost:8080
  - hostname: myapp2.example.com
    service: http://localhost:8081
  - service: http_status:404</code></pre><p>You may have noticed I snuck in something new there. The bottom service (the one without a hostname) is serving <code>http_status:404</code> which is a special instruction to make the tunnel serve a blank page if the domain given is not one that the config knows how to route. You could also put some kind of fallback application here, or whatever your heart desires!</p><p>However you like your ingress configured, hopefully you should have a complete file by now. For mine, I kept it simple:</p><pre><code>tunnel: ed5bfe16-cb5f-449c-b2e9-7c300b749c79
credentials-file: /home/ubuntu/.cloudflared/ed5bfe16-cb5f-449c-b2e9-7c300b749c79.json

ingress:
  - service: http://localhost
</code></pre><p>With any luck, my tunnel should now serve my <code>nginx</code> running on the default port 80!</p><p>Since this is the first time doing this, I need to setup the systemd service.</p><p>The two green <code>INF</code> lines are what you want to see after this:</p><figure><img src="https://erisa.dev/content/images/2022/02/image-12.png" alt="The command &#34;sudo cloudflared service install&#34; being ran and two lines, &#34;INF Using Systemd&#34; and &#34;INF systemctl daemon-reload&#34; being displayed." loading="lazy" width="657" height="115" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-12.png 600w, https://erisa.dev/content/images/2022/02/image-12.png 657w"/><figcaption><span>The command &#34;sudo cloudflared service install&#34; being ran and two lines, &#34;INF Using Systemd&#34; and &#34;INF systemctl daemon-reload&#34; being displayed.</span></figcaption></figure><p>And now you can control the service:</p><p>Start it: <code>$ sudo systemctl start cloudflared</code></p><p>To check the logs of the service once it&#39;s running, issue <code>$ sudo journalctl -u cloudflared</code>! To see the logs stream in realtime, add a <code>-f</code> to the command. You can <code>Ctrl+C</code> to stop the log streaming.</p><figure><img src="https://erisa.dev/content/images/2022/02/image-13.png" alt="The command &#34;sudo systemctl start cloudflared&#34; being ran with no output, and the command &#34;sudo journalctl -u cloudflared -f&#34; being ran with the output being a log of a successful tunnel run, most notably &#34;Started Cloudflare Tunnel&#34; and &#34;Connection registerred&#34;" loading="lazy" width="1043" height="607" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-13.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-13.png 1000w, https://erisa.dev/content/images/2022/02/image-13.png 1043w" sizes="(min-width: 720px) 720px"/><figcaption><span>The command &#34;sudo systemctl start cloudflared&#34; being ran with no output, and the command &#34;sudo journalctl -u cloudflared -f&#34; being ran with the output being a log of a successful tunnel run, most notably &#34;Started Cloudflare Tunnel&#34; and &#34;Connection registerred&#34;</span></figcaption></figure><p>If it worked correctly, your tunnel should now be connected!</p><figure><img src="https://erisa.dev/content/images/2022/02/image-14.png" alt="The output of the command &#34;cloudflared tunnel info mytunnel&#34;, which shows the name, ID, creation date and a list of connections. There should be one connection visible." loading="lazy" width="1323" height="176" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-14.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-14.png 1000w, https://erisa.dev/content/images/2022/02/image-14.png 1323w" sizes="(min-width: 720px) 720px"/><figcaption><span>The output of the command &#34;cloudflared tunnel info mytunnel&#34;, which shows the name, ID, creation date and a list of connections. There should be one connection visible.</span></figcaption></figure><p>Now that your tunnel is connected, it&#39;s time to get it routing!</p><p>There are two main ways to create the required DNS records for a tunnel.</p><ol><li>You can make <code>cloudflared</code> do for it for you. As long as the domain you want to route is a subdomain of the one you selected right at the beginning, you can issue <code>$ cloudflared tunnel route dns mytunnel test.example.com</code> and it will make the record for you!</li><li>If you find yourself needing to do this yourself, on the Cloudflare dashboard you can create a <code>CNAME</code> record pointing to <code>myuuid.cfargotunnel.com</code> where <code>myuuid</code> is the ID of your tunnel!</li></ol><figure><img src="https://erisa.dev/content/images/2022/02/image-15.png" alt="The command &#34;cloudflared tunnel route dns mytunne test.erisa.dev&#34; being ran, with the output stating &#34;INF Added CNAME test.erisa.dev. which will route to this tunnel&#34;" loading="lazy" width="1129" height="117" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-15.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-15.png 1000w, https://erisa.dev/content/images/2022/02/image-15.png 1129w" sizes="(min-width: 720px) 720px"/><figcaption><span>The command &#34;cloudflared tunnel route dns mytunne test.erisa.dev&#34; being ran, with the output stating &#34;INF Added CNAME test.erisa.dev. which will route to this tunnel&#34;</span></figcaption></figure><p>Give the DNS a few seconds to update, and with any luck...</p><figure><img src="https://erisa.dev/content/images/2022/02/image-16.png" alt="The page https://erisa.dev showing &#34;Welcome to nginx!&#34;, indicating a successful tunnel setup." loading="lazy" width="1121" height="429" srcset="https://erisa.dev/content/images/size/w600/2022/02/image-16.png 600w, https://erisa.dev/content/images/size/w1000/2022/02/image-16.png 1000w, https://erisa.dev/content/images/2022/02/image-16.png 1121w" sizes="(min-width: 720px) 720px"/><figcaption><span>The page https://erisa.dev showing &#34;Welcome to nginx!&#34;, indicating a successful tunnel setup.</span></figcaption></figure><p>It works! My Nginx process running on my local machine is now publicly accessible through the tunnel. No port forward headache, no complex configuration. Just a short config.yml and the Cloudflare network!</p><h3 id="wrapping-up">Wrapping up</h3><p>At this point you can iterate as much as you like. Add ingress rules, experiment with more tunnels on different machines, even the same tunnel on different machines!</p><p>For this, I recommend checking out the <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps?ref=erisa.dev">official documentation</a>.</p><p>Hopefully my little guide helped at least one person. If you have any comments or suggestions feel free to drop them below. ❤️</p>


               </div>
            </section>

                <section>
    <h3>Subscribe to Erisa&#39;s Corner of the Internet</h3>
    <p>Get the latest posts delivered right to your inbox</p>
    <form data-members-form="subscribe">
        
        <p><strong>Great!</strong> Check your inbox and click the link to confirm your subscription.
        </p>
        <p>
            Please enter a valid email address!
        </p>
    </form>
</section>
            

        </article>

    </div>
</div></div>
  </body>
</html>
