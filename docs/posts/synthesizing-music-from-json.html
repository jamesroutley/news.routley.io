<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://phoboslab.org/log/2025/01/synth">Original</a>
    <h1>Synthesizing Music from JSON</h1>
    
    <div id="readability-page-1" class="page"><div>	
	<div>
		
		<p>— Monday, January 6th 2025</p>
	</div>
	

	<p>tl;dr: <a href="https://github.com/phoboslab/pl_synth">pl_synth</a> is a tiny music synthesizer for C &amp; JS and an editor (“tracker”) to create instruments and arrangements.</p>
<p>You can try it out at <a href="https://phoboslab.org/synth/#eJytk9mNwCAMRBuaD8xhoBaU/tvYGSCH9pKyWpDBNiaYZzJaboYxRgWbRYNhqt2Q6AhBzohSLMEocFjnkkIdHKAtsR8YnHAKTo3+YanBcsGcS8B72287t7e2Ukvl4an4m5227W/t4xCGhbgLixPwqUcdwyPYYG6FahbT3iJaF+TCoVYhTXCRvujScfWLNGUfHDC/dbUJhrIJreUTD2Xn/XXbt8vSKNpPVIrL+9aaywxTKlkH0r0jPgcmkdBAM0puWoLDDQ91vkgkT8KSCaDQloZY5xNcHbC7LzDPK6wjC/7Xu/JuK1mlOQseTWWLFpjqdHvTT+UBmTUPs/p0IvEu8Pk/ZXj47TILYbjK85N6qH0A4LHEdA==">phoboslab.org/synth/</a></p>

<p><em>The song Microscope by Ferris / Youth Uprising playing in pl_synth</em>
</p>
<p><a href="https://www.pouet.net/prod.php?which=53615">Sonant</a> is a brilliant piece of software. It gives you 8 tracks, where each track has its own “instrument” (just a bunch of parameters) and a number of patterns. You fill the patterns with notes and lay out the sequence of patterns. Out comes the music. </p>
<p>Sonant was made for the demo scene and is therefore very concerned about size: both the code size of the synthesizer as well as the data size needed to define the music. And even with its tiny size it still offers a lot of flexibility for the artist.</p>
<p>In 2011 Sonant was ported to JavaScript by <a href="https://www.bitsnbites.eu/">Marcus Geelnard</a> as <a href="https://sonantlive.bitsnbites.eu/">Sonant Live</a> and later forked as <a href="https://github.com/nicolas-van/sonant-x-live">Sonant-X Live</a> by <a href="https://x.com/nicolasvanhoren">Nicolas Vanhoren</a> to support the newer WebAudio APIs in Browsers. I have used Sonant-X in <a href="https://brian.abelson.live/log/2018/09/underrun-making-of">Underrun</a>, <a href="https://brian.abelson.live/log/2019/09/voidcall-making-of">Voidcall</a> and <a href="https://brian.abelson.live/log/2021/09/q1k3-making-of">Q1k3</a> – each time condensing and refining it a bit more.</p>
<p>A few weeks ago I thought it would be nice to use it in C with <a href="https://brian.abelson.live/log/2024/08/high_impact">high_impact</a> too. Massaging the original C++ synthesizer was straight forward. The original tracker however only works on Windows and doesn&#39;t come with the source code; likewise the newer JS Sonant-X Live has aged quite a bit and isn&#39;t as good as it could be for modern Browsers. So I set out to write a new tracker from scratch.</p>
<h2>Arranging Instruments</h2>
<p>There are many different ways to lay out instruments and notes to define a <em>song</em>. In the simplest case you&#39;d have a single list where each element defines an instrument, a note and the exact time that it&#39;s being played at. E.g.:</p>
<pre><code><span>[</span>
    <span>{</span><span>&#34;instrument&#34;</span><span>:</span> <span>&#34;piano&#34;</span><span>,</span> <span>&#34;note&#34;</span><span>:</span> <span>&#34;c-4&#34;</span><span>,</span> <span>&#34;time&#34;</span><span>:</span> <span>0</span><span>.</span><span>123</span><span>},</span>
    <span>{</span><span>&#34;instrument&#34;</span><span>:</span> <span>&#34;piano&#34;</span><span>,</span> <span>&#34;note&#34;</span><span>:</span> <span>&#34;d-4&#34;</span><span>,</span> <span>&#34;time&#34;</span><span>:</span> <span>0</span><span>.</span><span>456</span><span>},</span>
    <span>{</span><span>&#34;instrument&#34;</span><span>:</span> <span>&#34;piano&#34;</span><span>,</span> <span>&#34;note&#34;</span><span>:</span> <span>&#34;e-4&#34;</span><span>,</span> <span>&#34;time&#34;</span><span>:</span> <span>0</span><span>.</span><span>789</span><span>},</span>
    <span>]</span></code></pre>
<p>This format would be quite tedious to edit and is not very space efficient. Typically, music has a lot of repeating patterns. So a layer of <em>abstraction</em> would be helpful to lay out patterns of notes, instead of notes directly.</p>
<p>In <a href="https://keithclark.github.io/ZzFXM/">ZzFXM</a> for example, each <em>pattern</em> has a number of <em>tracks</em>, where each track has a number of <em>notes</em>. A single overall list of patterns defines a song. This, in my opinion, is the wrong way around.</p>
<p>Instead, in Sonant (and thus pl_synth) a <em>song</em> consists of one or more <em>tracks</em>. Each track has a specific <em>instrument</em> and one or more <em>patterns</em>. Each pattern has exactly 32 rows, where each row may contain one <em>note</em>. A list of pattern indices for each track defines the overall sequence.</p>
<p>This, in general, matches the layout of a lot of music better. E.g. it allows you to have repeating drum beat track that is independent of the melody. It&#39;s also very compact as a file format and works nicely as a C struct.</p>
<pre><code>pl_synth_song_t song <span>=</span> <span>{</span>
    <span>.</span>row_len <span>=</span> <span>8481</span><span>,</span>
    <span>.</span>num_tracks <span>=</span> <span>4</span><span>,</span>
    <span>.</span>tracks <span>=</span> <span>(</span>pl_synth_track_t<span>[]){</span>
        <span>{</span>
            <span>.</span>synth <span>=</span> <span>{</span><span>7</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>121</span><span>,</span><span>1</span><span>,</span><span>7</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>91</span><span>,</span><span>3</span><span>,</span><span>0</span><span>,</span><span>100</span><span>,</span><span>1212</span><span>,</span><span>5513</span><span>,</span><span>100</span><span>,</span><span>0</span><span>,</span><span>6</span><span>,</span><span>19</span><span>,</span><span>3</span><span>,</span><span>121</span><span>,</span><span>6</span><span>,</span><span>21</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>29</span><span>},</span>
            <span>.</span>sequence_len <span>=</span> <span>12</span><span>,</span>
            <span>.</span>sequence <span>=</span> <span>(</span>uint8_t<span>[]){</span><span>1</span><span>,</span><span>2</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>1</span><span>,</span><span>2</span><span>},</span>
            <span>.</span>patterns <span>=</span> <span>(</span>pl_synth_pattern_t<span>[]){</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>138</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>150</span><span>,</span><span>138</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>150</span><span>,</span><span>138</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>150</span><span>,</span><span>138</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>150</span><span>,</span><span>136</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>148</span><span>,</span><span>136</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>148</span><span>,</span><span>136</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>148</span><span>,</span><span>136</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>148</span><span>}},</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>135</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>147</span><span>,</span><span>135</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>147</span><span>,</span><span>135</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>147</span><span>,</span><span>135</span><span>,</span><span>145</span><span>,</span><span>138</span><span>,</span><span>147</span><span>,</span><span>135</span><span>,</span><span>143</span><span>,</span><span>138</span><span>,</span><span>146</span><span>,</span><span>135</span><span>,</span><span>143</span><span>,</span><span>138</span><span>,</span><span>146</span><span>,</span><span>135</span><span>,</span><span>143</span><span>,</span><span>138</span><span>,</span><span>146</span><span>,</span><span>135</span><span>,</span><span>143</span><span>,</span><span>138</span><span>,</span><span>146</span><span>}}</span>
            <span>}</span>
        <span>},</span>
        <span>{</span>
            <span>.</span>synth <span>=</span> <span>{</span><span>7</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>192</span><span>,</span><span>1</span><span>,</span><span>6</span><span>,</span><span>0</span><span>,</span><span>9</span><span>,</span><span>0</span><span>,</span><span>192</span><span>,</span><span>1</span><span>,</span><span>25</span><span>,</span><span>137</span><span>,</span><span>1111</span><span>,</span><span>16157</span><span>,</span><span>124</span><span>,</span><span>1</span><span>,</span><span>982</span><span>,</span><span>89</span><span>,</span><span>6</span><span>,</span><span>25</span><span>,</span><span>6</span><span>,</span><span>77</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>3</span><span>,</span><span>69</span><span>},</span>
            <span>.</span>sequence_len <span>=</span> <span>12</span><span>,</span>
            <span>.</span>sequence <span>=</span> <span>(</span>uint8_t<span>[]){</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>3</span><span>,</span><span>3</span><span>,</span><span>3</span><span>,</span><span>3</span><span>,</span><span>3</span><span>},</span>
            <span>.</span>patterns <span>=</span> <span>(</span>pl_synth_pattern_t<span>[]){</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>138</span><span>,</span><span>138</span><span>,</span><span>0</span><span>,</span><span>138</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>141</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>136</span><span>,</span><span>136</span><span>,</span><span>0</span><span>,</span><span>136</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>141</span><span>}},</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>141</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>141</span><span>,</span><span>0</span><span>,</span><span>140</span><span>,</span><span>140</span><span>}},</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>145</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>145</span><span>,</span><span>143</span><span>,</span><span>145</span><span>,</span><span>150</span><span>,</span><span>0</span><span>,</span><span>148</span><span>,</span><span>0</span><span>,</span><span>146</span><span>,</span><span>0</span><span>,</span><span>143</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>145</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>145</span><span>,</span><span>143</span><span>,</span><span>145</span><span>,</span><span>139</span><span>,</span><span>0</span><span>,</span><span>139</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>142</span><span>,</span><span>142</span><span>}}</span>
            <span>}</span>
        <span>},</span>
        <span>{</span>
            <span>.</span>synth <span>=</span> <span>{</span><span>7</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>255</span><span>,</span><span>0</span><span>,</span><span>7</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>255</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>100</span><span>,</span><span>0</span><span>,</span><span>3636</span><span>,</span><span>174</span><span>,</span><span>2</span><span>,</span><span>500</span><span>,</span><span>254</span><span>,</span><span>0</span><span>,</span><span>27</span><span>},</span>
            <span>.</span>sequence_len <span>=</span> <span>12</span><span>,</span>
            <span>.</span>sequence <span>=</span> <span>(</span>uint8_t<span>[]){</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>},</span>
            <span>.</span>patterns <span>=</span> <span>(</span>pl_synth_pattern_t<span>[]){</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>139</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>139</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>139</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>139</span><span>,</span><span>0</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>135</span><span>,</span><span>0</span><span>,</span><span>135</span><span>}}</span>
            <span>}</span>
        <span>},</span>
        <span>{</span>
            <span>.</span>synth <span>=</span> <span>{</span><span>8</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>200</span><span>,</span><span>0</span><span>,</span><span>7</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>211</span><span>,</span><span>3</span><span>,</span><span>210</span><span>,</span><span>50</span><span>,</span><span>200</span><span>,</span><span>6800</span><span>,</span><span>153</span><span>,</span><span>4</span><span>,</span><span>11025</span><span>,</span><span>254</span><span>,</span><span>6</span><span>,</span><span>32</span><span>,</span><span>5</span><span>,</span><span>61</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>4</span><span>,</span><span>60</span><span>},</span>
            <span>.</span>sequence_len <span>=</span> <span>12</span><span>,</span>
            <span>.</span>sequence <span>=</span> <span>(</span>uint8_t<span>[]){</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>1</span><span>},</span>
            <span>.</span>patterns <span>=</span> <span>(</span>pl_synth_pattern_t<span>[]){</span>
                <span>{.</span>notes <span>=</span> <span>{</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>140</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>140</span><span>}}</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
<span>};</span></code></pre>
<h2>Creating Sounds from Thin Air</h2>
<p>The heart of pl_synth is a loop that creates the raw PCM samples for a single <em>note</em> of an <em>instrument</em>. The instrument is defined by a bunch of parameters, most importantly the waveform (Sine, Square, Sawtooth or Triangle) and the frequency of two independent oscillators. The volume of those are defined by the <em>envelope</em> as three values: <em>attack</em>, <em>sustain</em> and <em>release</em> (how quickly that tone gets from 0% to 100% volume, how long it stays at 100% and how quickly it goes back to 0%). This all is directly adopted from the original Sonant C++ version.</p>
<p><img src="https://brian.abelson.live/content/assets/pl_synth_sawtooth.png" alt="A Sawtooth Wave"/>
<em>A short sawtooth wave; the envelope is visualized by the grey area around it.</em></p>
<p>On its own, this is not terribly exciting. Pure sine waves sound like telephone dial tones; a square wave sounds just like what a Gameboy might produce (which of course is <a href="https://youtu.be/BKm45Az02YE?t=736">no coincidence</a>). But if you put a delay effect on it, modulate the oscillator frequency with a LFO (low frequency oscillator) and apply a band pass filter you can produce a surprising range of different sounds.</p>
<p><img src="https://brian.abelson.live/content/assets/pl_synth_instrument.png" alt="Synthesizer instrument definition"/></p>
<p>The whole loop that does all this is so short that I can reproduce it here in full (modified a bit for clarity). <code>PL_SYNTH_TAB(waveform, pos)</code> returns the value for a particular waveform at a particular position. E.g. for a sine wave it&#39;s just <code>sin(pos)</code>. Each iteration of this loop produces one sample.</p>
<pre><code><span>for</span> <span>(</span><span>int</span> i <span>=</span> num_samples<span>;</span> i <span>&gt;=</span> <span>0</span><span>;</span> i    <span>float</span> filter_f <span>=</span> fx_freq<span>;</span>
    <span>float</span> envelope <span>=</span> <span>1</span><span>;</span>
    <span>float</span> sample <span>=</span> <span>0</span><span>;</span>

        <span>float</span> lfor <span>=</span> <span>PL_SYNTH_TAB</span><span>(</span>lfo_waveform<span>,</span> i <span>*</span> lfo_freq<span>)</span> <span>*</span> lfo_amt <span>+</span> <span>0</span><span>.</span>5f<span>;</span>


        <span>if</span> <span>(</span>i <span>&lt;</span> env_attack<span>)</span> <span>{</span>
        envelope <span>=</span> i <span>/</span> env_attack<span>;</span>
    <span>}</span>
    <span>else</span> <span>if</span> <span>(</span>i <span>&gt;=</span> env_attack <span>+</span> env_sustain<span>)</span> <span>{</span>
        envelope <span>-=</span> <span>(</span>i <span>-</span> env_attack <span>-</span> env_sustain<span>)</span> <span>/</span> env_release<span>;</span>
    <span>}</span>

        <span>float</span> cur_osc0_freq <span>=</span> osc0_freq<span>;</span>
    <span>if</span> <span>(</span>lfo_osc_freq<span>)</span> <span>{</span>
        cur_osc0_freq <span>*=</span> lfor<span>;</span>
    <span>}</span>
    <span>if</span> <span>(</span>osc0_xenv<span>)</span> <span>{</span>
        cur_osc0_freq <span>*=</span> envelope <span>*</span> envelope<span>;</span>
    <span>}</span>
    osc0_pos <span>+=</span> cur_osc0_freq<span>;</span>
    sample <span>+=</span> <span>PL_SYNTH_TAB</span><span>(</span>osc0_waveform<span>,</span> osc0_pos<span>)</span> <span>*</span> osc0_vol<span>;</span>

        <span>float</span> cur_osc1_freq <span>=</span> osc1_freq<span>;</span>
    <span>if</span> <span>(</span>osc1_xenv<span>)</span> <span>{</span>
        cur_osc1_freq <span>*=</span> envelope <span>*</span> envelope<span>;</span>
    <span>}</span>
    osc1_pos <span>+=</span> cur_osc1_freq<span>;</span>
    sample <span>+=</span> <span>PL_SYNTH_TAB</span><span>(</span>osc1_waveform<span>,</span> osc1_pos<span>)</span> <span>*</span> osc1_vol<span>;</span>

        <span>if</span> <span>(</span>noise_vol<span>)</span> <span>{</span>
        sample <span>+=</span> rand_float<span>()</span> <span>*</span> noise_vol <span>*</span> envelope<span>;</span>
    <span>}</span>

    sample <span>*=</span> envelope <span>*</span> <span>(</span><span>1</span><span>.</span>0f <span>/</span> <span>255</span><span>.</span>0f<span>);</span>

        <span>if</span> <span>(</span>fx_filter<span>)</span> <span>{</span>
        <span>if</span> <span>(</span>lfo_fx_freq<span>)</span> <span>{</span>
            filter_f <span>*=</span> lfor<span>;</span>
        <span>}</span>

        filter_f <span>=</span> <span>PL_SYNTH_TAB</span><span>(</span><span>0</span><span>,</span> filter_f <span>*</span> <span>(</span><span>0</span><span>.</span>5f <span>/</span> <span>PL_SYNTH_SAMPLERATE</span><span>))</span> <span>*</span> <span>1</span><span>.</span>5f<span>;</span>
        low <span>+=</span> filter_f <span>*</span> band<span>;</span>
        high <span>=</span> fx_resonance <span>*</span> <span>(</span>sample <span>-</span> band<span>)</span> <span>-</span> low<span>;</span>
        band <span>+=</span> filter_f <span>*</span> high<span>;</span>
        sample <span>=</span> <span>(</span><span>float</span><span>[</span><span>5</span><span>]){</span>sample<span>,</span> high<span>,</span> low<span>,</span> band<span>,</span> low <span>+</span> high<span>}[</span>fx_filter<span>];</span>
    <span>}</span>

        <span>float</span> pan <span>=</span> <span>PL_SYNTH_TAB</span><span>(</span><span>0</span><span>,</span> i <span>*</span> fx_pan_freq<span>)</span> <span>*</span> pan_amt <span>+</span> <span>0</span><span>.</span>5f<span>;</span>
    sample <span>*=</span> <span>78</span> <span>*</span> env_master<span>;</span>

        samples<span>[</span>i <span>*</span> <span>2</span> <span>+</span> <span>0</span><span>]</span> <span>+=</span> sample <span>*</span> <span>(</span><span>1</span><span>-</span>pan<span>);</span>
    samples<span>[</span>i <span>*</span> <span>2</span> <span>+</span> <span>1</span><span>]</span> <span>+=</span> sample <span>*</span> pan<span>;</span>
<span>}</span></code></pre>
<h2>JS Performance</h2>
<p>Of course producing each sample for each track, some with overlapping instruments, means a whole lot of iterations of this loop. Each operation in this loop has an impact on performance.</p>
<h3>5000ms</h3>
<p>Sonant-X Live, the JS port I first used in my game Underrun, was painfully slow. Generating all samples for a song typically took 5 seconds or more. Most of the time was spent in the oscillator functions. Turns out, calling <code>Math.sin()</code> ten million times for 60 seconds of music is not the best idea.</p>
<h3>1000ms</h3>
<p>For my next game, Voidcall, I got the time to generate music down to 1 second. How did I make <code>Math.sin()</code> so much faster? By not calling it at all, of course. Instead, I pre-generated a lookup table for each oscillator.</p>
<pre><code><span>let</span> len <span>=</span> <span>4096</span><span>;</span>
<span>let</span> tab <span>=</span> <span>new</span> Float32Array<span>(</span>len <span>*</span> <span>4</span><span>);</span>
<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> len<span>;</span> i<span>++)</span> <span>{</span>
    tab<span>[</span>i          <span>]</span> <span>=</span> Math<span>.</span>sin<span>(</span>i<span>*</span><span>6</span><span>.</span><span>283184</span><span>/</span>len<span>);</span>                          tab<span>[</span>i <span>+</span> len    <span>]</span> <span>=</span> tab<span>[</span>i<span>]</span> <span>&lt;</span> <span>0</span> <span>?</span> <span>-</span><span>1</span> <span>:</span> <span>1</span><span>;</span>                               tab<span>[</span>i <span>+</span> len <span>*</span> <span>2</span><span>]</span> <span>=</span> i <span>/</span> len <span>-</span> <span>0</span><span>.</span><span>5</span><span>;</span>                                     tab<span>[</span>i <span>+</span> len <span>*</span> <span>3</span><span>]</span> <span>=</span> i <span>&lt;</span> len<span>/</span><span>2</span> <span>?</span> <span>(</span>i<span>/(</span>len<span>/</span><span>4</span><span>))</span> <span>-</span> <span>1</span> <span>:</span> <span>3</span> <span>-</span> <span>(</span>i<span>/(</span>len<span>/</span><span>4</span><span>));</span> <span>}</span></code></pre>
<p>All 4 oscillators are stored in one table. The lookup is then computed with an offset for the specific oscilator, e.g. offset <code>8192</code> for the sawtooth oscillator.</p>
<pre><code>sample <span>=</span> tab<span>[</span>offset <span>+</span> <span>((</span>pos <span>*</span> len<span>)</span> <span>&amp;</span> <span>4095</span><span>)];</span></code></pre>
<p>The bit and <code>&amp; 4095</code> is equivalent to modulo <code>% 4096</code> but much faster. Hence the power of two table length.</p>
<p>4096 elements provide enough resolution even for very low frequency oscillators. E.g. a barely audible 20hz sound at 44100hz playback rate is just 2205 samples long.</p>
<h3>500ms</h3>
<p>I squeezed out quite a bit more performance by restructuring some of the if statements, merging multiplications and just making sure that there&#39;s no division or function calls in the inner loop. E.g.:</p>
<pre><code><span>for</span> <span>(</span><span>let</span> j <span>=</span> num_samples<span>;</span> j <span>&gt;=</span> <span>0</span><span>;</span> j    
    <span>if</span> <span>(</span>noise_fader<span>)</span> <span>{</span>
        sample <span>+=</span> <span>(</span><span>2</span><span>*</span>Math<span>.</span>random<span>()-</span><span>1</span><span>)</span> <span>*</span> noise_fader <span>*</span> envelope<span>;</span>
    <span>}</span>

    sample <span>*=</span> envelope <span>/</span> <span>255</span><span>.</span><span>0</span><span>;</span>
<span>}</span></code></pre>
<p>became </p>
<pre><code><span>let</span> uint8_norm <span>=</span> <span>1</span> <span>/</span> <span>255</span><span>;</span>
<span>let</span> rand_state <span>=</span> <span>0xd8f554a5</span><span>;</span>
<span>let</span> noise_vol <span>=</span> noise_fader <span>*</span> <span>4</span><span>.</span>6566e<span>-</span><span>010</span><span>;</span> 

<span>for</span> <span>(</span><span>let</span> j <span>=</span> num_samples<span>;</span> j <span>&gt;=</span> <span>0</span><span>;</span> j    
    <span>if</span> <span>(</span>noise_fader<span>)</span> <span>{</span>
        rand_state <span>^=</span> rand_state <span>&lt;&lt;</span> <span>13</span><span>;</span>
        rand_state <span>^=</span> rand_state <span>&gt;&gt;</span> <span>17</span><span>;</span>
        rand_state <span>^=</span> rand_state <span>&lt;&lt;</span> <span>5</span><span>;</span>
        sample <span>+=</span> rand_state <span>*</span> noise_vol <span>*</span> envelope<span>;</span>
    <span>}</span>

    sample <span>*=</span> envelope <span>*</span> uint8_norm<span>;</span>
<span>}</span></code></pre>
<h3>250ms</h3>
<p>The way to speed up the JS version even more is not using JS. I wrote a C version specially tailored to be compiled as a WASM module. Most of the song generation, JSON reading etc. is still handled by JS, but the performance critical part – the sound generation – is done in C.</p>
<p>The <a href="https://github.com/phoboslab/pl_synth/blob/master/wasm/pl_synth_wasm_module.c">C source for the WASM module</a> is just 200 lines of code and compiles to 2kb of WASM. The resulting <code>synth.wasm</code> is embedded into the JS source as a base64 string. This of course inflates the size again, but when delivered via gzip it doesn&#39;t matter.</p>
<p>The WASM version is about twice the size of vanilla JS version, but also twice as fast.</p>
<p>Fun fact: this WASM module also contains a function to clear a Float32Array.</p>
<pre><code><span>void</span> clear<span>(</span><span>float</span> <span>*</span>samples<span>,</span> <span>int</span> len<span>)</span> <span>{</span>
    <span>for</span> <span>(</span><span>int</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> len<span>;</span> i<span>++)</span> <span>{</span>
        samples<span>[</span>i<span>]</span> <span>=</span> <span>0</span><span>;</span>
    <span>}</span>
<span>}</span></code></pre>
<p>In Firefox (as of v133) this is 10x faster than <code>Float32Array.fill(0)</code> in JS.</p>
<p>The WASM version compiles down to <code>memory.fill</code> – basically a <code>memset</code>. In contrast, Firefox/Spidermonkey implements <code>TypedArray.fill()</code> as a “self-hosted builtin” – that is: a JavaScript function, not native code. This is somewhat surprising to see, considering that TypeArrays were introduced <em>specifically</em>  for performance reasons.</p>
<p>For what it&#39;s worth, there&#39;s no performance difference between <code>TypedArray.fill()</code> and the WASM version in Chrome.</p>
<h3><del>25ms</del></h3>
<p>I experimented with a version that would do everything through WebAudio nodes instead of generating raw samples. This turned out to be massive pain in the ass. Working with WebAudio is cumbersome and the code size exploded tenfold. This <em>design by consortium node graph</em> is just not my idea of fun.</p>
<p>Another approach would be generating samples <em>on the fly</em> using <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletProcessor">AudioWorklets</a>. This is probably worth exploring in the future.</p>
<h2>Native C Version</h2>
<p><a href="https://github.com/phoboslab/pl_synth/blob/master/c/pl_synth.h">The native C version of pl_synth</a> comes as a single header library. I took some care to make it allocator agnostic (i.e. all memory has to be provided by the caller), but other than that, there&#39;s not much to report. </p>
<p>Here&#39;s a short <a href="https://github.com/phoboslab/pl_synth/blob/master/c/example.c">example</a> of the C version that generates a song and stores it as .wav file.</p>
<h2>The Tracker</h2>
<p>The Tracker, the editor where you compose your songs, is where I spent most of my time with this project. It&#39;s written in plain old JS and comes as a single HTML file. There&#39;s no build step, no bundler, no <code>npm install</code> and no server needed. You just launch it with a doubleclick from your local file system (or course online at <a href="https://phoboslab.org/synth/">/synth</a>).</p>
<p>All HTML is generated in JS through a simple <code>h(type, props, ...children)</code> function that returns a DOM element. <code>children</code> can either be undefined, a DOM element, an instance of a special <code>HTMLComponent</code> class or an array of those. <code>HTMLComponent</code> is simply a class that has a <code>.element</code> property for a DOM element. The whole UI is built with this simple setup.</p>
<p>E.g. the <code>Track</code> class – the UI element that holds all patterns and the instrument for a single track – looks like this:</p>
<pre><code><span>class</span> Track <span>extends</span> HTMLComponent <span>{</span>
    app <span>=</span> <span>null</span><span>;</span>
    instrument <span>=</span> <span>null</span><span>;</span>
    index <span>=</span> <span>0</span><span>;</span>
    patterns <span>=</span> <span>[];</span>
    numDefaultPatterns <span>=</span> <span>4</span><span>;</span>

    constructor<span>(</span>app<span>,</span> index<span>)</span> <span>{</span>
        super<span>();</span>
        <span>this</span><span>.</span>app <span>=</span> app<span>;</span>
        <span>this</span><span>.</span>instrument <span>=</span> <span>new</span> Instrument<span>(</span><span>this</span><span>);</span>
        <span>this</span><span>.</span>index <span>=</span> index<span>;</span>

        <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>this</span><span>.</span>numDefaultPatterns<span>;</span> i<span>++)</span> <span>{</span>
            <span>this</span><span>.</span>patterns<span>.</span>push<span>(</span><span>new</span> Pattern<span>(</span><span>this</span><span>,</span> i<span>));</span>
        <span>}</span>

        <span>this</span><span>.</span>element <span>=</span> h<span>(</span><span>&#39;div&#39;</span><span>,</span> <span>{</span><span>class</span><span>:</span> <span>&#39;row track&#39;</span><span>},</span>
            h<span>(</span><span>&#39;div&#39;</span><span>,</span> <span>{</span><span>class</span><span>:</span> <span>&#39;head&#39;</span><span>,</span> text<span>:</span> <span>&#39;Track &#39;</span> <span>+</span> <span>(</span>index<span>+</span><span>1</span><span>)},</span>
                h<span>(</span><span>&#39;span&#39;</span><span>,</span> <span>{},</span> 
                    h<span>(</span><span>&#39;button&#39;</span><span>,</span> <span>{</span><span>class</span><span>:</span> <span>&#39;small&#39;</span><span>,</span> text<span>:</span> <span>&#39;rem&#39;</span><span>,</span> title<span>:</span> <span>&#39;remove pattern&#39;</span><span>,</span> onclick<span>:</span> ev <span>=&gt;</span> <span>this</span><span>.</span>onRemovePattern<span>()}),</span>
                    h<span>(</span><span>&#39;button&#39;</span><span>,</span> <span>{</span><span>class</span><span>:</span> <span>&#39;small&#39;</span><span>,</span> text<span>:</span> <span>&#39;add&#39;</span><span>,</span> title<span>:</span> <span>&#39;add pattern&#39;</span><span>,</span> onclick<span>:</span> ev <span>=&gt;</span> <span>this</span><span>.</span>onAddPattern<span>()})</span>
                <span>)</span>
            <span>),</span>
            h<span>(</span><span>&#39;div&#39;</span><span>,</span> <span>{</span><span>class</span><span>:</span> <span>&#39;patterns&#39;</span><span>},</span> 
                <span>this</span><span>.</span>patterns
            <span>),</span>
            <span>this</span><span>.</span>instrument
        <span>);</span>
    <span>}</span>

    <span>}</span></code></pre>
<p>Now, you&#39;re probably wondering how I re-render elements when something changes. The answer is of course using the DOM directly. Setting <code>.textContent = &#39;foo&#39;</code> or calling <code>.classList.add(&#39;zomg&#39;)</code> is really no big deal. In fact, being so selective about these updates makes the whole thing feel quite snappy.</p>
<h2>Undo / Redo</h2>
<p>I spent a lot of time to make the tracker <em>feel</em> right. Adding a lot of keyboard shortcuts for playback, selections, copy, paste and of course undo &amp; redo.</p>
<p>Implementing undo can be quite challenging, especially for more complex apps. But here, it simply stores the <strong>whole song</strong> for each step in the history. Each time a new entry in the history is created, the app is queried for the JSON string of the current song. On restore, the app simply loads the JSON string from history again.</p>
<p>Similar actions that occur within a short time span are grouped together as one entry in the history. This is done by: </p>
<ol>
<li>giving each action a description</li>
<li>setting a timeout (500ms) before committing the action </li>
<li>reset the timeout if another action with the same description is added</li>
</ol>
<p>This all is managed in the History class, instantiated with a <code>stateCallback</code> that returns the current song JSON and <code>restoreCallback</code> that loads JSON data. The class looks like this:</p>
<pre><code><span>class</span> History <span>{</span>
    levels <span>=</span> <span>100</span><span>;</span>
    timeout <span>=</span> <span>500</span><span>;</span>
    stack <span>=</span> <span>[];</span>
    pos <span>=</span> <span>0</span><span>;</span>
    stateCallback <span>=</span> <span>null</span><span>;</span>
    restoreCallback <span>=</span> <span>null</span><span>;</span>
    timeoutId <span>=</span> <span>0</span><span>;</span>
    currentAction <span>=</span> <span>null</span><span>;</span>

    constructor<span>(</span>levels<span>,</span> timeout<span>,</span> stateCallback<span>,</span> restoreCallback<span>)</span> <span>{</span>
        <span>this</span><span>.</span>levels <span>=</span> levels<span>;</span>
        <span>this</span><span>.</span>timeout <span>=</span> timeout<span>;</span>
        <span>this</span><span>.</span>stateCallback <span>=</span> stateCallback<span>;</span>
        <span>this</span><span>.</span>restoreCallback <span>=</span> restoreCallback<span>;</span>
    <span>}</span>

    add<span>(</span>action<span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span>currentAction <span>!==</span> action<span>)</span> <span>{</span>
            <span>this</span><span>.</span>commit<span>();</span>
        <span>}</span>
        <span>this</span><span>.</span>currentAction <span>=</span> action<span>;</span>
        clearTimeout<span>(</span><span>this</span><span>.</span>timeoutId<span>);</span>
        <span>this</span><span>.</span>timeoutId <span>=</span> setTimeout<span>(</span><span>this</span><span>.</span>commit<span>.</span>bind<span>(</span><span>this</span><span>),</span> <span>this</span><span>.</span>timeout<span>);</span>
    <span>}</span>

    commit<span>()</span> <span>{</span>
        <span>if</span> <span>(!</span><span>this</span><span>.</span>currentAction<span>)</span> <span>{</span>
            <span>return</span><span>;</span>
        <span>}</span>

        <span>if</span> <span>(</span><span>this</span><span>.</span>pos<span>)</span> <span>{</span>
            <span>this</span><span>.</span>stack<span>.</span>splice<span>(</span><span>this</span><span>.</span>stack<span>.</span>length <span>-</span> <span>this</span><span>.</span>pos<span>,</span> <span>this</span><span>.</span>pos<span>);</span>
            <span>this</span><span>.</span>pos <span>=</span> <span>0</span><span>;</span>
        <span>}</span>

        <span>this</span><span>.</span>stack<span>.</span>push<span>({</span>data<span>:</span> <span>this</span><span>.</span>stateCallback<span>(),</span> action<span>:</span> <span>this</span><span>.</span>currentAction<span>});</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span>stack<span>.</span>length <span>&gt;</span> <span>this</span><span>.</span>levels<span>)</span> <span>{</span>
            <span>this</span><span>.</span>stack<span>.</span>unshift<span>();</span>
        <span>}</span>
        <span>this</span><span>.</span>currentAction <span>=</span> <span>null</span><span>;</span>
    <span>}</span>

    undo<span>()</span> <span>{</span>
        <span>let</span> prev <span>=</span> <span>this</span><span>.</span>stack<span>[</span><span>this</span><span>.</span>stack<span>.</span>length <span>-</span> <span>this</span><span>.</span>pos <span>-</span> <span>1</span><span>];</span>
        <span>let</span> action <span>=</span> <span>this</span><span>.</span>stack<span>[</span><span>this</span><span>.</span>stack<span>.</span>length <span>-</span> <span>this</span><span>.</span>pos <span>-</span> <span>2</span><span>];</span>
        <span>if</span> <span>(!</span>action<span>)</span> <span>{</span>
            <span>return</span> <span>null</span><span>;</span>
        <span>}</span>
        <span>this</span><span>.</span>pos<span>++;</span>
        <span>this</span><span>.</span>restoreCallback<span>(</span>action<span>.</span>data<span>);</span>
        <span>return</span> prev<span>.</span>action<span>;</span>
    <span>}</span>

    <span>}</span></code></pre>
<p>The app then calls <code>history.add()</code> each time something is changed. For instance if you set a note in a pattern: <code>history.add(&#39;set note&#39;)</code>. If you don&#39;t change another pattern within 500ms, the action is committed to the history stack.</p>
<p>An important detail here is that you don&#39;t call <code>history.add()</code> with the state of the app. Instead, the History class specifically asks for the state (through the <code>stateCallback()</code>) only when it is truly needed. This ensures that we don&#39;t query the state of the app (potentially an expensive operation) more than necessary.</p>
<p>As an example, when you click and drag the volume slider for an instrument, each time you move the slider even just 1px the app calls <code>history.add()</code>. But this is not a problem: as long as you keep moving within 500ms nothing is committed yet; no state is queried.</p>
<h2>Songs as URLs</h2>
<p>The tracker can load songs in the “legacy” JSON format used by Sonant Live and Sonant-X Live e.g.:</p>
<pre><code><span>{</span>
    <span>&#34;rowLen&#34;</span><span>:</span> <span>5513</span><span>,</span>
    <span>&#34;songData&#34;</span><span>:</span> <span>[</span>
        <span>{</span>
            <span>&#34;osc1_oct&#34;</span><span>:</span> <span>7</span><span>,</span> <span>&#34;osc1_det&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;osc1_detune&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;osc1_xenv&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;osc1_vol&#34;</span><span>:</span> <span>192</span><span>,</span> <span>&#34;osc1_waveform&#34;</span><span>:</span> <span>3</span><span>,</span> 
            <span>&#34;osc2_oct&#34;</span><span>:</span> <span>7</span><span>,</span> <span>&#34;osc2_det&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;osc2_detune&#34;</span><span>:</span> <span>7</span><span>,</span> <span>&#34;osc2_xenv&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;osc2_vol&#34;</span><span>:</span> <span>201</span><span>,</span> <span>&#34;osc2_waveform&#34;</span><span>:</span> <span>3</span><span>,</span> 
            <span>&#34;noise_fader&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;env_attack&#34;</span><span>:</span> <span>789</span><span>,</span> <span>&#34;env_sustain&#34;</span><span>:</span> <span>1234</span><span>,</span> <span>&#34;env_release&#34;</span><span>:</span> <span>13636</span><span>,</span> <span>&#34;env_master&#34;</span><span>:</span> <span>191</span><span>,</span> 
            <span>&#34;fx_filter&#34;</span><span>:</span> <span>2</span><span>,</span> <span>&#34;fx_freq&#34;</span><span>:</span> <span>5839</span><span>,</span> <span>&#34;fx_resonance&#34;</span><span>:</span> <span>254</span><span>,</span> <span>&#34;fx_delay_time&#34;</span><span>:</span> <span>6</span><span>,</span> <span>&#34;fx_delay_amt&#34;</span><span>:</span> <span>121</span><span>,</span> 
            <span>&#34;fx_pan_freq&#34;</span><span>:</span> <span>6</span><span>,</span> <span>&#34;fx_pan_amt&#34;</span><span>:</span> <span>147</span><span>,</span> <span>&#34;lfo_osc1_freq&#34;</span><span>:</span> <span>0</span><span>,</span> <span>&#34;lfo_fx_freq&#34;</span><span>:</span> <span>1</span><span>,</span> <span>&#34;lfo_freq&#34;</span><span>:</span> <span>6</span><span>,</span> 
            <span>&#34;lfo_amt&#34;</span><span>:</span> <span>195</span><span>,</span> <span>&#34;lfo_waveform&#34;</span><span>:</span> <span>0</span><span>,</span> 
            <span>&#34;p&#34;</span><span>:</span> <span>[</span><span>1</span><span>,</span><span>2</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>1</span><span>,</span><span>2</span><span>],</span>
            <span>&#34;c&#34;</span><span>:</span> <span>[</span>
                <span>{</span>
                    <span>&#34;n&#34;</span><span>:</span> <span>[</span><span>154</span><span>,</span><span>0</span><span>,</span><span>154</span><span>,</span><span>0</span><span>,</span><span>152</span><span>,</span><span>0</span><span>,</span><span>147</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>154</span><span>,</span><span>0</span><span>,</span><span>154</span><span>,</span><span>0</span><span>,</span><span>152</span><span>,</span><span>0</span><span>,</span><span>157</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>156</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>]</span>
                <span>},</span>
                <span>{</span>
                    <span>&#34;n&#34;</span><span>:</span> <span>[</span><span>154</span><span>,</span><span>0</span><span>,</span><span>154</span><span>,</span><span>0</span><span>,</span><span>152</span><span>,</span><span>0</span><span>,</span><span>147</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>154</span><span>,</span><span>0</span><span>,</span><span>154</span><span>,</span><span>0</span><span>,</span><span>152</span><span>,</span><span>0</span><span>,</span><span>157</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>159</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>]</span>
                <span>}</span>
            <span>]</span>
        <span>},</span>
        <span>{</span>
            <span>&#34;osc1_oct&#34;</span><span>:</span> <span>7</span><span>,</span> <span>&#34;osc1_det&#34;</span><span>:</span> <span>0</span><span>,</span> 
            …
        <span>},</span>
        …
    <span>]</span>
<span>}</span></code></pre>
<p>as well as in a new compact array representation or from a native C-struct source. The new array format is mostly equivalent to the legacy JSON format – just without property names and optionally with implicit <code>0</code> values. The latter makes this invalid as JSON, but still valid JS:</p>
<pre><code><span>const</span> song <span>=</span> <span>[</span><span>5513</span><span>,</span> <span>[</span>
    <span>[</span>
        <span>[</span><span>7</span><span>,,,,</span><span>192</span><span>,</span><span>3</span><span>,</span><span>7</span><span>,,</span><span>7</span><span>,,</span><span>21</span><span>,</span><span>3</span><span>,,</span><span>789</span><span>,</span><span>1234</span><span>,</span><span>13636</span><span>,</span><span>191</span><span>,</span><span>2</span><span>,</span><span>5839</span><span>,</span><span>254</span><span>,</span><span>6</span><span>,</span><span>121</span><span>,</span><span>6</span><span>,</span><span>147</span><span>,,</span><span>1</span><span>,</span><span>6</span><span>,</span><span>195</span><span>],</span>
        <span>[</span><span>1</span><span>,</span><span>2</span><span>,,,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>1</span><span>,</span><span>2</span><span>],</span>
        <span>[</span>
            <span>[</span><span>154</span><span>,,</span><span>154</span><span>,,</span><span>152</span><span>,,</span><span>147</span><span>,,,,,,,,,,</span><span>154</span><span>,,</span><span>154</span><span>,,</span><span>152</span><span>,,</span><span>157</span><span>,,,,</span><span>156</span><span>],</span>
            <span>[</span><span>154</span><span>,,</span><span>154</span><span>,,</span><span>152</span><span>,,</span><span>147</span><span>,,,,,,,,,,</span><span>154</span><span>,,</span><span>154</span><span>,,</span><span>152</span><span>,,</span><span>157</span><span>,,,,</span><span>159</span><span>]</span>
        <span>]</span>
    <span>],</span>
    <span>[</span>
        …
    <span>]</span>
<span>]];</span></code></pre>
<p>Compressing the JS array format with <a href="https://developer.mozilla.org/en-US/docs/Web/API/CompressionStream">CompressionStream</a> and base64 encoding the result typically yields a string that is 300-1200 characters long (depending on the length and complexity of the song itself) –  short enough to fit into a URL</p>
<p>So here&#39;s the soundtrack for <a href="https://brian.abelson.live/log/2021/09/q1k3-making-of">Q1k3</a>, all stored in the URL alone:</p>
<p><a href="https://phoboslab.org/synth/#eJxtkVuWxCAIRDdUHzwEdS2e7H8bA5g40+nBIwI+uKksJ25Ya3UADDED/oRgIkBdPfIGAfOcFTZ0vrAY3wN1/4w4tVgcOXH7Yx8b15Vnaz+7CyLk8STJEgYLGn2SwoFElFAD0uIJZAmKdq/2zrNNwquUV7yMZeSGWHnaXCkLRo8XRp3xeCnh4k2eWpCBxS6w+OpAG9mNJ5UahOmF9lLnKNQmcmL74z5rm6T6+y1QEDSNziVCN7IMUg/Kn+Q8CIMj4lnX4gorH5KHJmW516JRObtbHta+Ffuq0/91sV817Ur7AYzBfQA=">/synth/#eJxtkVuWxCAIRDdUHzwEdS2e7H8bA5g40+nBIwI+uKksJ25Ya3UADDED/oRgIkBdPfIGAfOcFTZ0vrAY3wN1/4w4tVgcOXH7Yx8b15Vnaz+7CyLk8STJEgYLGn2SwoFElFAD0uIJZAmKdq/2zrNNwquUV7yMZeSGWHnaXCkLRo8XRp3xeCnh4k2eWpCBxS6w+OpAG9mNJ5UahOmF9lLnKNQmcmL74z5rm6T6+y1QEDSNziVCN7IMUg/Kn+Q8CIMj4lnX4gorH5KHJmW516JRObtbHta+Ffuq0/91sV817Ur7AYzBfQA=</a></p>
<p>I have no doubt that this could be compressed further by using a binary format instead of JSON. Of course this would come at the expense of more code needed for the compression/decompression. For a <a href="https://js13kgames.com/">JS13k</a> entry your best option is probably the JS Array format, as your whole submission will be zipped up anyway.</p>
<h2>pl_synth in high_impact</h2>
<p>As stated in the beginning of this post, the initial reason for all of this was to provide an alternative for sound and music in <a href="https://brian.abelson.live/log/2024/08/high_impact">high_impact</a>. pl_synth is now bundled with high_impact and one of the demo games (<a href="https://github.com/phoboslab/high_drop">Drop</a>) uses it exclusively for sound and music.</p>
<p>Where the game previously loaded a sound file:</p>
<pre><code>sound_source_t <span>*</span>coin <span>=</span> sound_source<span>(</span><span>&#34;assets/coin.qoa&#34;</span><span>);</span></code></pre>
<p>it now generates a sound effect on startup:</p>
<pre><code>sound_source_t <span>*</span>coin <span>=</span> sound_source_synth_sound<span>(&amp;(</span>pl_synth_sound_t<span>){</span>
    <span>.</span>synth <span>=</span> <span>{</span><span>10</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>189</span><span>,</span><span>1</span><span>,</span><span>12</span><span>,</span><span>0</span><span>,</span><span>9</span><span>,</span><span>1</span><span>,</span><span>172</span><span>,</span><span>2</span><span>,</span><span>0</span><span>,</span><span>2750</span><span>,</span><span>689</span><span>,</span><span>95</span><span>,</span><span>129</span><span>,</span><span>0</span><span>,</span><span>1086</span><span>,</span><span>219</span><span>,</span><span>1</span><span>,</span><span>117</span><span>},</span> 
    <span>.</span>row_len <span>=</span> <span>5513</span><span>,</span> 
    <span>.</span>note <span>=</span> <span>135</span>
<span>});</span></code></pre>
<p>No external sounds files needed anymore!</p>
<p>Check out <a href="https://github.com/phoboslab/pl_synth">pl_synth</a> and <a href="https://github.com/phoboslab/high_impact">high_impact</a> on github. I hope to see this pop up in some future games!</p></div></div>
  </body>
</html>
