<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/harbaum/galagino">Original</a>
    <h1>Galaga, Pac-Man, Donkey Kong Emulator for ESP32</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<h2 dir="auto"><a id="user-content-galaga-arcade-emulator-for-esp32" aria-hidden="true" href="#galaga-arcade-emulator-for-esp32"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Galaga arcade emulator for ESP32</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/harbaum/galagino/blob/main/images/galagino.gif"><img src="https://github.com/harbaum/galagino/raw/main/images/galagino.gif" alt="Galagino screencast" data-animated-image=""/></a></p>
<p dir="auto"><a href="https://de.wikipedia.org/wiki/Galaga" rel="nofollow">Galaga</a> is one of the most iconic arcade machines of all times. It has
been remade and emulated many times. So far the cheapest and smallest
system able to do a faithful emulation of the original arcade machine
was the raspberry pi. But even the much cheaper ESP32 should be able
to easily emulate a machine from the early 80&#39;s, shouldn&#39;t it?</p>
<p dir="auto">Well, things are not that easy. The galaga arcade was driven by three
Z80 CPUs, each running at 3Mhz. Additionally the arcade machine
included two more CPUs for button and coin handling and for audio
support. And finally the hardware itself had dedicated support
for simple wavetable audio, tilemap graphics and up to 64 sprites.
The video resultion was 224 by 288 pixels. The ESP32 on the other hand
comes with two cores running at 240MHz. But it lacks dedicated video
hardware. Emulating the various CPUs as well as the handling of
audio and graphics turned out to be challenging for the ESP32.</p>
<p dir="auto">Cheap TFT screens with a resolution of 320 by 240 pixels are avaialable
in various sizes from 2.0 inch to 3.2 inch allowing for a very small
and cheap <em>galagino</em> setup.</p>
<p dir="auto">These small displays usually allow for SPI clock rates of up to 40MHz
allowing for a max screen refresh rate of ~30Hz. This is exactly half
the refresh rate of the original arcade machine. 30Hz is sufficient
for a very fluid gameplay.</p>
<h2 dir="auto"><a id="user-content-youtube-videos" aria-hidden="true" href="#youtube-videos"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Youtube videos</h2>
<ul dir="auto">
<li><a href="https://www.youtube.com/shorts/LZRI6izM8XM" rel="nofollow">First test</a></li>
<li><a href="https://www.youtube.com/shorts/8uNSv0aRtgY" rel="nofollow">Sound and Starfield working</a></li>
<li><a href="https://www.youtube.com/shorts/wqnJzOAAths" rel="nofollow">Finally playable</a></li>
<li><a href="https://www.youtube.com/shorts/F4-XiiPwG1c" rel="nofollow">Pac-Man on Galagino</a></li>
</ul>
<h2 dir="auto"><a id="user-content-hardware" aria-hidden="true" href="#hardware"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Hardware</h2>
<p dir="auto">The hardware is built around one of those cheap ESP32 development
boards like the ESP32 Devkit V4 depicted in the images below. The
components needed are:</p>
<ul dir="auto">
<li>ESP32 development board (e.g. <a href="https://www.espressif.com/en/products/devkits/esp32-devkitc" rel="nofollow">Devkit V4</a>)</li>
<li>A 320x240 SPI TFT screen (no touch needed)
<ul dir="auto">
<li>Either a ILI9341 based screen as depicted, or</li>
<li>a ST7789 based screen with 320x240 pixels</li>
</ul>
</li>
<li>An audio amplifier and speaker
<ul dir="auto">
<li>e.g. a <a href="https://www.adafruit.com/product/2130" rel="nofollow">PAM8302A</a> and a 3W speaker (as seen in the photos), or</li>
<li>a <a href="https://www.keyestudio.com/products/keyestudio-sc8002b-audio-power-amplifier-speaker-module-for-arduino-player" rel="nofollow">Keyestudio SC8002B</a>, or similar</li>
</ul>
</li>
<li>five push buttons</li>
<li>breadboard and wires</li>
</ul>
<p dir="auto">The entire setup should be connected as depiced below. The Devkit is
too wide for the breadboard leaving no space above it to connect
wires. Thus the wires going to the top pin row of the Devkit are
placed underneath the DevKit with the connections done as shown in the
image below.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/harbaum/galagino/blob/main/images/galagino_bb.png"><img src="https://github.com/harbaum/galagino/raw/main/images/galagino_bb.png" alt="Breadboard scheme"/></a></p>
<p dir="auto">Download as <a href="https://github.com/harbaum/galagino/blob/main/images/galagino_bb.fzz">Fritzing</a> or <a href="https://github.com/harbaum/galagino/blob/main/images/galagino_bb.pdf">PDF</a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/harbaum/galagino/blob/main/images/galagino_breadboard.jpeg"><img src="https://github.com/harbaum/galagino/raw/main/images/galagino_breadboard.jpeg" alt="Breadboard photo"/></a></p>
<h2 dir="auto"><a id="user-content-software" aria-hidden="true" href="#software"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Software</h2>
<p dir="auto">The software consists of three parts:</p>
<ul dir="auto">
<li>The <a href="https://github.com/harbaum/galagino/blob/main/galagino">Galagino specific code</a> contained in this repository</li>
<li>The <a href="https://www.bing.com/search?q=galaga+namco+b+rom" rel="nofollow">original Galaga Namco Rev. B ROM files</a></li>
<li>A <a href="https://fms.komkon.org/EMUL8/Z80-081707.zip" rel="nofollow">Z80 software emulation</a></li>
</ul>
<p dir="auto">The ROM files have to be placed in the <a href="https://github.com/harbaum/galagino/blob/main/roms">roms directory</a>, together with
the ZIP file containing the Z80 emulator. A set of <a href="https://github.com/harbaum/galagino/blob/main/romconv">python scripts</a>
is then being used to convert and patch the ROM data and emulator code and
to include the resulting code into the galagino sketch directory. These
scripts need to be run like so (this has yet only been tested under Linux,
feedback for Windows is welcome):</p>
<div data-snippet-clipboard-copy-content="$ cd romconv
$ ./audioconv.py &gt; ../galagino/wavetables.h
$ ./cmapconv.py &gt; ../galagino/colormaps.h
$ ./romconv.py &gt; ../galagino/rom.h
$ ./spriteconv.py &gt; ../galagino/spritemap.h
$ ./tileconv.py &gt; ../galagino/tilemap.h
$ ./tileaddr.py &gt; ../galagino/tileaddr.h
$ ./starsets.py &gt; ../galagino/starseed.h
$ ./z80patch.py 
Copying CodesCB.h
Copying Codes.h
Copying CodesXX.h
Copying CodesED.h
Copying CodesXCB.h
Copying Tables.h
Patching Z80.h
Patching Z80.c
$"><pre><code>$ cd romconv
$ ./audioconv.py &gt; ../galagino/wavetables.h
$ ./cmapconv.py &gt; ../galagino/colormaps.h
$ ./romconv.py &gt; ../galagino/rom.h
$ ./spriteconv.py &gt; ../galagino/spritemap.h
$ ./tileconv.py &gt; ../galagino/tilemap.h
$ ./tileaddr.py &gt; ../galagino/tileaddr.h
$ ./starsets.py &gt; ../galagino/starseed.h
$ ./z80patch.py 
Copying CodesCB.h
Copying Codes.h
Copying CodesXX.h
Copying CodesED.h
Copying CodesXCB.h
Copying Tables.h
Patching Z80.h
Patching Z80.c
$
</code></pre></div>
<p dir="auto">Afterwards the <a href="https://github.com/harbaum/galagino/blob/main/galagino">galagino directory</a> should contain the following files:</p>
<div data-snippet-clipboard-copy-content="CodesCB.h    Codes.h      CodesXX.h    config.h     emulation.h
rom.h        starseed.h   tileaddr.h   video.cpp    wavetables.h
Z80.h        CodesED.h    CodesXCB.h   colormaps.h  emulation.c
galagino.ino spritemap.h  Tables.h     tilemap.h    video.h
Z80.c"><pre><code>CodesCB.h    Codes.h      CodesXX.h    config.h     emulation.h
rom.h        starseed.h   tileaddr.h   video.cpp    wavetables.h
Z80.h        CodesED.h    CodesXCB.h   colormaps.h  emulation.c
galagino.ino spritemap.h  Tables.h     tilemap.h    video.h
Z80.c
</code></pre></div>
<p dir="auto">With all these files in place, the galagino.ino sketch can be loaded
into the <a href="https://docs.arduino.cc/software/ide-v2" rel="nofollow">Arduino IDE</a>. The
Arduino IDE must have the <a href="https://github.com/espressif/arduino-esp32">ESP32 board support</a>
installed and the appropriate board like e.g. the
<em>ESP32 Dev Module</em> should be selected. Finally the default core used
by Arduino should be 1 (this is the default) as Galagino will use core 0
for audio and video emulation.</p>
<h2 dir="auto"><a id="user-content-configuration" aria-hidden="true" href="#configuration"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuration</h2>
<p dir="auto">The Galagino code can be configured through the <a href="https://github.com/harbaum/galagino/blob/main/galagino/config.h">galagino/config.h</a>
file. This is also the place where it&#39;s possible to choose between the ILI9143
controller (default) and the ST7789.</p>
<p dir="auto">Also the pin assigmnent can be adjusted or the TFT SPI clock.</p>
<h2 dir="auto"><a id="user-content-improvements" aria-hidden="true" href="#improvements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Improvements</h2>
<p dir="auto">Galagino runs fluid and plays perfectly. Still a few things could be optimized.</p>
<ul dir="auto">
<li>Displays allowing for 80MHz SPI clock could run the video at full 60Hz</li>
<li>The SPI display update could be done using DMA which would significantly reduce the load on ESP32 core 0</li>
<li>VGA output could be used to drive a VGA screen</li>
<li>The ESP32&#39;s bluetooth could be used to connect to a wireless gamepad</li>
<li>Galagino could be ported to the <a href="https://picockpit.com/raspberry-pi/raspberry-pi-pico-video-output/" rel="nofollow">Raspberry Pi Pico and the DVI sock</a></li>
</ul>
</article>
          </div></div>
  </body>
</html>
