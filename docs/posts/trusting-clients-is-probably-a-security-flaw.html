<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://liberda.nl/weblog/trust-no-client/">Original</a>
    <h1>Trusting clients is probably a security flaw</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody"><p>I looked at a discussion on blink-dev Google Group and saw <a href="https://groups.google.com/a/chromium.org/g/blink-dev/c/Ux5h_kGO22g/m/0BJlM-HpAAAJ">the message</a>:</p><blockquote><p>Perhaps it is a good thing for user choice to have a browser that is fully open to any use and allows anonymous user actions.</p><p>The result of such open-ness is that an entire series of services that need to trust the client (used in the oauth sense of the word) are not available to web apps. […]</p><p>I have recently worked on a fork of Chromium that is designed to have this functionality and on Native Wallet apps to get it. The lack of this functionality in Chrome will drive developers away from Chrome and fragment the user experience. We already have the problem of directing users away from Chrome to a secure wallet and being unable to bring the original user session back to Chrome. Of course Google and Apple get to solve this problem with their own wallets, but that will not fly in Europe and now the US DHS is asking for solutions that are more open as well.</p></blockquote><p>My understanding of security started an internal screaming.</p><h2 id="meet-the-mcdonald-s-app">Meet the McDonald&#39;s app</h2><p>Hold on, I&#39;m not at all joking. The McDonald&#39;s app developers put a lot of effort into policing the clients allowed to even dream about running the app. The app was checking for:</p><ul><li>whether you have a directory called <code>TWRP</code> in your internal storage. TWRP is a custom recovery, and by default, stores device backups you generate from recovery in there. You have a device backup? Then no deals for you, nerd.</li><li>whether you have the <code>com.topjohnwu.magisk</code> app installed. <em>You like modifying your devices, don&#39;t you?</em> Pay full price, nerd.</li><li>whether you have installed the app from <code>com.android.vending</code>, more widely known as Google Play. What, you don&#39;t have it? That&#39;ll be €14,50, nerd.</li><li>check your device with RootBeer, a library that tries to check whether you have root access. Not passing? Card or cash, nerd?</li><li>and finally, using the SafetyNet API (now being rebranded into Play Integrity, specifically the Device Integrity and App Integrity parts, with some minor changes). Not passing? Pay. Nerd.</li></ul><p>This is more annoying than any financial app I&#39;ve had, and I have 5 of them on my phone. mBank.pl uses Play Integrity API, but that&#39;s to use contactless payments via BLIK, and the rest of the app works. IKO, the app of PKO BP, seeing that I have root access, disabled logging in with biometry, requiring me to log in with a PIN code. bunq told me that maybe my device should not be rooted. The worst one seems to be Revolut, which blocked my access, clearly stating the reason to be root access.</p><p>The McDonald&#39;s app only displays a generic error message, and an error code that tells you nothing.</p><h2 id="and-what-are-guarding-so-much">And what are guarding so much?</h2><p>What are the <em>Deals</em> inside the app? Currently, I can get a free burger for 650 points, that is, if I spend 65 Euro in McDonald&#39;s first. What a deal. But that&#39;s not what brings me here.</p><p>There once was a <a href="https://www.pepper.pl/promocje/mcdonald-i-coca-cola-50-lat-528907">promotion</a> in collaboration between Coca-Cola and McDonald&#39;s, specifically available in Poland. It boiled down to this:</p><ol><li>Buy 3 bottles of Coca-Cola.</li><li>Enter 3 codes (from each bottle) into the Coca-Cola app.</li><li>Enter the code you got from the Coca-Cola app into the McDonald&#39;s app.</li><li>In return, you get a free meal with a Big Mac.</li></ol><p>Ignore this unnecessary duplication with copying the code between 2 apps. Actually, ignore the Coca-Cola part as a whole. So, what happens in the McDonald&#39;s app? As with many things in that app, this deal was operated by a page opened in a WebView. The config for the country was set to point to the deal&#39;s page from the main screen. On the page, there was a pretty simple form:</p><figure data-portrait="1"><picture><source srcset="https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/3RqSrIQrZ9gfB1NuwoX8B.webp 140w, https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/_n47tO8nFfonJDd8bfd0R.webp 240w, https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/rLNpcJb2W3zzJoMkfb85K.webp 360w, https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/p89BUFFh3gfd2bfU7wTV3.webp 413w" type="image/webp"/><img alt="Screenshot of application interface, in Polish, with a text input and a confirm button, asking to enter a voucher code from Coca-Cola." srcset="https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/fUYB4psNrQQ6ZyiojYSR_.jpeg 140w, https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/xow_z0kC9Qm543bTOADRk.jpeg 240w, https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/fiycr2ZqUwowQxEtVeLcc.jpeg 360w, https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/HPRZNnpg05BbFaexX4VyI.jpeg 413w" title="Screenshot of application interface, in Polish, with a text input and a confirm button, asking to enter a voucher code from Coca-Cola." src="https://cdn-swa.lnl.gay/pio/OmG22yyBIuD5uuVa3jHTE/HPRZNnpg05BbFaexX4VyI.jpeg" type="image/jpeg"/></picture></figure><h2 id="obscurity-is-not-security">Obscurity is not security</h2><p>From now on, this is basically a post mortem, except it&#39;s not McDonald&#39;s writing it.</p><p>The page opened in the WebView was sending the entered code in a request to a McDonald&#39;s server. But here&#39;s the flaw: the request checking and invalidating the code, was doing just that. It just returned whether the code is valid. The page was requesting a check whether the code was valid, and <strong><em>the client</em> was assigning the coupon to the user.</strong></p><p><em>It turns out that the company&#39;s servers do not verify this and take the app &#34;for its word&#34;</em>, <a href="https://android.com.pl/news/484772-darmowe-big-mac-w-mcdonalds-haker/">reported android.com.pl</a>.</p><p>When you say you need to check whether the request is coming from a &#34;trustworthy client&#34;, I say <strong>trust no client, use a rubber.</strong></p><h3 id="an-untouched-device-can-exploit-your-service-too">An untouched device can exploit your service, too</h3><p>Oh, right, I said earlier about some measures? This whole exploit could (at least at that time) be <strong>executed from an unmodified device</strong>. Open the app, go to privacy policy (opens in a WebView), find an external link. Be creative. Find a link to Google&#39;s privacy policy, and tap their logo to go to Google Search. Find a link to YouTube, and search for a video with a link somewhere else. Whatever gets you to a <strong>page that can execute a little bit of JavaScript for you</strong>.</p><pre data-lang="js"><code data-lang="js"><span>COLA</span><span>.</span><span>offerActivation</span><span>.</span><span>send</span><span>({
</span><span>  loyaltyId</span><span>: </span><span>2424</span><span>,
</span><span>  rewardId</span><span>: </span><span>95275</span><span>,
</span><span>})
</span></code></pre><p>This was the thing.</p><p>But don&#39;t worry. If this is fixed, nothing is lost. You remember the measures I talked about? They indeed check signs that might indicate you&#39;re not trustworthy. But really, passing these checks might just mean you know how these checks work. What can and does go wrong?</p><h3 id="you-can-just-comply-with-the-checks">You can just comply with the checks.</h3><p>TWRP backups? Change the directory name.</p><p>Magisk Manager app? Change the package name in the settings.</p><p>Not installed from Google Play? Open terminal and run <code>pm set-installer com.mcdonalds.mobileapp com.android.vending</code>. Or install with <code>pm install -i com.android.vending [file]</code>. Or the same with <code>adb</code>.</p><p>Root checks? Add McDonald&#39;s to Zygisk Denylist.</p><h3 id="you-can-just-not-run-the-checks">You can just not run the checks.</h3><p>Oh, that was just the way where we obediently fulfil these checks. But <strong>if this runs on your device, you are the one in control of it.</strong> You can inject into the process with tools like Zygisk or LSPosed, and remove these checks. <em>I have injected into 2137 processes on my phone today. Nobody controls this.</em></p><h3 id="you-can-just-tell-the-checks-what-they-want-to-hear">You can just tell the checks what they want to hear.</h3><p>And the last check. SafetyNet/Play Integrity. Check whether you pass with <a href="https://play.google.com/store/apps/details?id=com.henrikherzig.playintegritychecker">SPIC</a>. If you don&#39;t pass basic SafetyNet, install <a href="https://github.com/Magisk-Modules-Repo/MagiskHidePropsConf">MagiskHide Props Config</a>, run <code>props</code> in console, change signature to something from the available list. Now, if you don&#39;t pass CTS SafetyNet, install <a href="https://github.com/kdrag0n/safetynet-fix">Universal SafetyNet Fix</a>. Yes, my phone really just passes SafetyNet and Play Integrity like this (Integrity up to <code>MEETS_DEVICE_INTEGRITY</code>, without <code>MEETS_STRONG_INTEGRITY</code>).</p><blockquote><p>No labels (a blank value): The app is running on a device that has signs of attack (such as API hooking) or system compromise (such as being rooted), or the app is not running on a physical device (such as an emulator that does not pass Google Play integrity checks).</p></blockquote><p>This is a fragment of <a href="https://developer.android.com/google/play/integrity/verdict#device-integrity-field">the Play Integrity documentation</a>. But the problem with checking if the user is a god, is that the user is a god. They can just tell you what you want to hear.</p><p>(On a side note, if you speak Polish, I recommend reading <a href="https://informatykzakladowy.pl/aplikacja-mobilna-nie-wie-czy-telefon-jest-zhackowany/">&#34;Aplikacja mobilna nie wie, czy telefon jest zhackowany&#34; from Informatyk Zakładowy</a>)</p><h3 id="but-typical-users-will-not-study-your-app-if-it-doesn-t-work">But typical users will not study your app if it doesn&#39;t work</h3><p>Mass exploitation was, in the end, stopped by ending the deal, because of how out of control it was. So who <em>was</em> stopped?</p><ul><li><p>Unaware users. Every time you introduce a stupid check, there is a user with a false positive result. For example, <a href="https://github.com/scottyab/rootbeer/issues/147">some of the RootBeer checks will trigger</a> on some unmodified Xiaomi, Asus, or Fairphone, or random cheap phones that happened to be in someone&#39;s nearest Tesco. The biggest irony is that some of these users will <em>root their phones</em> to bypass these checks instead.</p> <p>If your app starts looking for the <code>MEETS_STRONG_INTEGRITY</code> label from Play Integrity, even more users will be affected like this.</p> <p>Literally look at the Google Play reviews of the McDonald&#39;s app. This app has a 2,8/5 rating and you have to keep scrolling them to find positive ones, from the very few users who managed to get the app running.</p></li><li><p>Users with root access to their own phones. First of all, why? What&#39;s bad about having administrator access to <em>your own phone</em>?</p> <p>Second, this is ineffective if they know how to workaround. They can inject into your process and tell you <em>it&#39;s a good phone ma&#39;am</em>.</p></li><li><p>Huawei users. Or Amazon Fire users. Or any Android device made for China market users. Or users of a mobile Linux distribution, trying to run an app over Waydroid. Their devices by default do not have Google Play Services that can be tricked like this, and will require more work than I described to pass these checks.</p></li></ul><h3 id="but-will-it-at-least-stop-fraud">But will it at least stop fraud?</h3><p>Hell no.</p><figure><picture><source srcset="https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/xwVLyn2y8PvioLjcD4gl-.webp 140w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/9WfXXwSEK5CNVWDJj67aQ.webp 240w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/6mNz7r7vKlVuhih2LgAO8.webp 360w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/GXl5mX9JzGEvTanOx6aYs.webp 480w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/fpLk-kbtYjOcR7WGGl9e6.webp 720w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/gpJvZADE5oY4VtHa4jlCA.webp 1080w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/na1gd-txrqQTeDzrUwrc5.webp 1230w" type="image/webp"/><img alt="A photo from a bot farm with lots of phones pinned to a wall, with USB cables connected to them." srcset="https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/qcPBmZJtDUlnTbGLSm9el.jpeg 140w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/WQoxPmlWvLpyixF5Va6mq.jpeg 240w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/2WavYG5WrH55VzeD8Xkf9.jpeg 360w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/um2yV5dvbd4CjUjS0ZkQz.jpeg 480w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/ezoBGTj_uTnxd8cY0c-p0.jpeg 720w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/YzZJxswi73wwNEZIcVJd-.jpeg 1080w, https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/z32i06c_tsgoulDK3ZPpe.jpeg 1230w" title="A photo from a bot farm with lots of phones pinned to a wall, with USB cables connected to them." src="https://cdn-swa.lnl.gay/pio/iaymp2BM1Og5yrcNJaRO8/z32i06c_tsgoulDK3ZPpe.jpeg" type="image/jpeg"/></picture></figure></div></div>
  </body>
</html>
