<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/programming/Go121ToolchainDownloads">Original</a>
    <h1>Go 1.21 will (probably) download newer toolchains on demand by default</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Go 1.21 will (probably) download newer toolchains on demand by default</h2>

	<p><small>June 23, 2023</small></p>
</div><div><p>For some time, <a href="https://go.dev/ref/mod">Go modules</a> have supported
specifying the minimum version of Go required by the module in
<a href="https://go.dev/doc/modules/gomod-ref">go.mod</a>, through the <a href="https://go.dev/ref/mod#go-mod-file-go"><code>go</code>
directive</a>. Once you can
have modules that specify a minimum Go version, you have a design
question of what should happen when an older version of Go tries
to do something with a module that says it requires a newer version
of Go. Up through Go 1.20 (more or less), Go&#39;s answer was to go
ahead and try anyway. Starting in Go 1.21, Go will refuse to be
this optimistic, and thus Go guarantees from 1.21 onward that a
module will always be processed with at least its minimum version
of Go. If this isn&#39;t possible, Go will stop with a clear error about
the situation.</p>

<p>(This behavior is backported to 1.19.11 and 1.20.6, in that starting
from each of those Go will refuse to touch a module or workspace
that specifies Go 1.21 or later.)</p>

<p>By itself this might be frustrating and awkward, so Go offers two
ways out. First, Go can search through your $PATH (or non-Unix
equivalent) to try to find the necessary minimum toolchain version,
and then automatically switch over to executing that version.
Second, if you don&#39;t have the necessary toolchain on your $PATH
already, Go can download an official release for you (or what should
be an official release) and then switch over to it. As of the current
Go 1.21 release candidate, the &#39;<code>go</code>&#39; command will do both of these
by default, first searching your $PATH and then trying to reach out
to the Internet to download a pre-built toolchain (if one exists).
How this works and is controlled is covered in the pre-release
documentation for <a href="https://tip.golang.org/doc/toolchain">Go Toolchains</a>
and <a href="https://tip.golang.org/doc/go1.21">the Go 1.21 draft release notes</a>.</p>

<p>(How Go decides on the (potential) authenticity of this downloaded
toolchain is beyond the scope of this entry.)</p>

<p>Not everyone is going to be happy with the idea of the &#39;<code>go</code>&#39; command
downloading and running binaries from the Internet. If this is the
case for you, you need to set <code>GOTOOLCHAIN</code> to either &#39;<code>path</code>&#39;, if
you&#39;re happy to search $PATH for the right toolchain, or &#39;<code>local</code>&#39;,
if you want to turn off this behavior entirely and have &#39;<code>go</code>&#39; just
fail. Unfortunately, Go before Go 1.21rc1 can&#39;t set this through
&#39;<code>go env -w</code>&#39;, so if you want to set this globally you&#39;ll need to
manually create or edit your Go configuration file (you can find
its location with &#39;<code>go env GOENV</code>&#39;) so that it contains:</p>

<blockquote><pre>GOTOOLCHAIN=path
</pre>
</blockquote>

<p>(Or &#39;<code>local</code>&#39;, if you prefer.)</p>

<p>Or you can set a &#39;<code>$GOTOOLCHAIN</code>&#39; environment variable. In various
automated build and testing environments, you may have no choice
but to inject this as an environment variable.</p>

<p>(It&#39;s also possible to change the default behavior of a Go installation,
and I wouldn&#39;t be surprised if some Linux distributions did.)</p>

<p>Right now this behavior of downloading newer toolchains is either
difficult or impossible to trigger, since there are no newer
toolchains than Go 1.21rc1. Even after later versions are released,
it may be hard to trigger and rare; realistically, I suspect we&#39;re
not going to see much of this before Go 1.22 comes out, although
we&#39;ll have to see.</p>

<p>My personal opinion is that the $PATH searching is perfectly sensible
as default behavior, but downloading newer toolchain binaries over
the Internet is not. I believe that there are a lot of situations
where people don&#39;t want this, and the current default will force
everyone to start injecting settings changes into all sorts of
places to turn it off. It&#39;s possible that the Go developers will
change their minds about the default before the release of Go 1.21,
and I hope they do. I understand the convenience of their current
default, but there&#39;s a balance between convenience and other factors.</p>

<p>(This elaborates on <a href="https://mastodon.social/@cks/110588963871656555">a Fediverse post</a> that was triggered
by the Go 1.21 draft release notes becoming available and providing
clear documentation for this new feature.)</p>
</div></div>
  </body>
</html>
