<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.granola.ai/blog/dont-animate-height">Original</a>
    <h1>Don&#39;t animate height</h1>
    
    <div id="readability-page-1" class="page"><div><p>Our app was mysteriously using 60% CPU and 25% GPU on my M2 MacBook.
It turned out this was due to a tiny CSS animation!
In this post,
I show how to find expensive animations,
why some are so expensive,
and how to make many animations much cheaper.
Along the way,
we&#39;ll learn how the browser renders CSS animations
and how to use Chrome&#39;s dev tools for performance profiling.</p>
<h2 id="the-problem"><a href="#the-problem"></a>The problem</h2>
<p>While building <a target="_blank" rel="noopener noreferrer" href="https://granola.ai">Granola</a>, a note-taking app,
I noticed it was using 60% CPU and 25% GPU on my M2 MacBook:</p>
<figure><img src="https://www.granola.ai/blogImages/animation/1_activity_monitor.png" alt="Activity Monitor"/><figcaption><i>Activity Monitor showing high CPU and GPU usage</i></figcaption></figure>
<p>What is Granola spending those cycles on?
It&#39;s an Electron app, so let&#39;s use the Chrome dev tools to find out!</p>
<p>First, in the &#34;Performance&#34; tab, we see that
<strong>most of the time is spent not in JavaScript, but in &#34;rendering&#34; and &#34;painting&#34;:</strong></p>
<figure><img src="https://www.granola.ai/blogImages/animation/2_performance_tab_summary.png" alt="Performance summary"/></figure>
<p>But <em>what</em> is it rendering and painting?
To see this, open the &#34;Layers&#34; tab, which shows:</p>
<figure><img src="https://www.granola.ai/blogImages/animation/layers_before.png" alt="Layers tab"/></figure>
<p>Our window has two layers:
one for the &#34;action bar&#34; at the bottom,
and another for the rest of the document content.
Each layer has a &#34;paint count&#34;, and <strong>the action bar&#39;s layer is painting every single frame!</strong></p>
<figure><video autoplay="" loop="" muted="" playsinline=""><source src="/blogImages/animation/paint_flashing_2.mp4" type="video/mp4"/></video><figcaption><i><p>Paint flashing (green) and layout shift regions (blue). Dev tools warns
that these animations &#34;may not be suitable for people prone to
photosensitive epilepsy.&#34;</p></i></figcaption></figure>
<p>Why is the action bar painting so much?
For a clue, jump to the &#34;Rendering&#34; tab,
and turn on &#34;paint flashing&#34; and &#34;layout shift regions&#34;.
We quickly see <strong>the browser hates our audio volume visualizer!</strong>
Those three green &#34;dancing bars&#34; at the bottom of the Granola window
constantly flash with layout shift and repainting.</p>
<p>But why are the dancing bars causing so much layout calculation?
My first suspicion was DOM updates:
the bars&#39; styles update 10 times per second,
and DOM updates are expensive, right?
But <strong>reducing DOM updates made little difference.</strong></p>
<p>Back to the Performance tab,
and we see this pattern dominating the profile:</p>
<figure><img src="https://www.granola.ai/blogImages/animation/profile_per_frame_2.png" alt="Chrome profiler per-frame details"/></figure>
<p>That stuff happens once for every frame, 60 times per second.
<strong>No JavaScript here â€” this is pure CSS work!</strong></p>
<p>Why is it doing work every frame?
The answer is in the image.
Look at those three purple &#34;Animation&#34; jobs.
There&#39;s one animation job for each dancing bar.
We&#39;ve found our culprit,
and it&#39;s this line of CSS:</p>
<pre><code><span><span>transition</span><span>:</span><span> </span><span>height</span><span> </span><span>300ms</span><span> </span><span>ease</span><span>-</span><span>in</span><span>-</span><span>out</span><span>;</span><span></span></span></code></pre>
<p>Why is this <code><span><span>height</span></span></code> transition so expensive?
What is the browser doing when we animate the <code><span><span>height</span></span></code> property?
We first need to understand <a target="_blank" rel="noopener noreferrer" href="https://webperf.tips/tip/browser-rendering-pipeline/">the browser&#39;s rendering pipeline.</a>
There are three relevant steps:
<strong>Layout</strong> (deciding where elements go on the page), then
<strong>Painting</strong> (drawing those elements onto layers like in Photoshop), and finally
<strong>Compositing</strong> (merging those layers into a single image).</p>
<p>Here&#39;s the browser rendering one frame of Granola:</p>
<figure><img src="https://www.granola.ai/blogImages/animation/pipeline.png" alt="Rendering pipeline"/></figure>
<p>What happens when we change the <code><span><span>height</span></span></code> property?
It triggers a layout recalculation, followed by re-painting, and re-compositing.
This makes <code><span><span>height</span></span></code> a <strong>layout property</strong>,
and these are the most expensive CSS properties to animate.</p>
<figure><figcaption><i>The W3C spec is full of these!</i></figcaption></figure>
<p>Less expensive are <strong>paint properties</strong>.
A paint property does trigger layout,
but it does repaint a layer, and then re-composites.
For example, the <code><span><span>fill</span></span></code> and <code><span><span>stroke</span></span></code> colors on an SVG are paint properties:
they repaint the layer with new colors, then re-composite them.
A funny example is this tiny &#34;bikeshed&#34; SVG
which you can find on <a target="_blank" rel="noopener noreferrer" href="https://drafts.fxtf.org/filter-effects-2/#BackdropFilterProperty">lots of W3C spec pages</a>.
It costs ~30% CPU!</p>
<p>The cheapest properties are <strong>composite properties</strong>.
They don&#39;t trigger layout or paint;
they only trigger a compositing update.
<a target="_blank" rel="noopener noreferrer" href="https://web.dev/articles/rendering-performance"><strong>The two classic composite properties are <code><span><span>transform</span></span></code> and <code><span><span>opacity</span></span></code></strong>.</a>
Can we replace our expensive <code><span><span>height</span></span></code> animations with cheaper <code><span><span>transform</span></span></code> animations?</p>
<h2 id="a-solution"><a href="#a-solution"></a>A solution</h2>
<figure><div><div></div></div><figcaption><i>Naive solution, with warped rounded corners.</i></figcaption></figure>
<p>A naive solution would be to replace <code><span><span>height</span></span></code> animations with <code><span><span>transform</span><span>:</span><span> </span><span>scaleY</span><span>(</span><span>)</span></span></code>.
And hey presto, this fixes our performance problem!
The &#34;Layout&#34; and &#34;Paint&#34; jobs are nowhere to be seen in the Performance tab.</p>
<p>... Unfortunately, this <code><span><span>scaleY</span></span></code> transform is <em>ugly</em>.
Look how those rounded corners get warped as the rectangle stretches!</p>
<p>Instead,
we can create the illusion of a changing height by using <em>two</em> rectangles, applying <code><span><span>translate</span></span></code> to each.
There&#39;s one rectangle for each end:</p>
<figure><div><div><div><div></div><div></div></div><div><div></div><div></div></div></div></div></figure>
<p>The bars are actually pairs of rounded rectangles that move in opposite directions,
creating the illusion of a single stretching bar.
Since we&#39;re only using <code><span><span>transform</span></span></code>,
the browser can skip the layout and paint phases.</p>
<p>Here&#39;s the optimized version of the visualizer:</p>
<figure><div><div><div></div><div></div></div></div><figcaption><i>Granola audio visualizer, after optimization.</i></figcaption></figure>
<p>On my M2 MacBook,
the renderer process is now using 6% CPU (down from 15%),
and the GPU process is now using 6% CPU and less than 1% GPU (down from 25% and 20%).
This optimization demonstrates
how understanding the browser&#39;s rendering pipeline
and choosing the right CSS properties for animations
can dramatically improve performance.
In the next post,
I&#39;ll show how to find hidden performance costs using Chrome&#39;s <code><span><span>about</span><span>:</span></span></code> tool,
which is like the performance profiler on steroids.
See you there!</p>
<p>You can see the optimized visualizer in action by <a target="_blank" rel="noopener noreferrer" href="https://granola.ai">trying Granola</a>.
If you&#39;re interested in working on performance optimizations like these,
<a target="_blank" rel="noopener noreferrer" href="https://www.granola.ai/jobs">we&#39;re hiring</a>!</p></div></div>
  </body>
</html>
