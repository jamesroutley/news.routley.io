<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://conner.bond/Slow_Druid">Original</a>
    <h1>The Case of The Curiously Slow Druid</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>2023-01-12</p>
<h2>The Setup</h2>
<p>I&#39;ve had this really curious and frustrating problem for a while now, my iteration loop while working on my <a href="https://github.com/linebender/druid">Druid</a> based fantasy map tool <a href="https://sr.ht/~cbondurant/Lipuma/">Lipuma</a> has been horribly hampered by means of occasional <strong><em>massive</em></strong> startup times. In the order of tens of seconds.</p>
<p>When these account for around a third of the whole build time for the application, it can get extremely frustrating.</p>
<h2>Early Troubleshooting</h2>
<p>I had tried looking into this issue before to little avail. Perf/hotshot would get lost in the indirect calls made by GTK, but it was clear at least that it was a GTK issue. It was getting hung up somewhere in what looked like <code>gtk_icon_theme_get_for_screen</code>. However all avenues down that route seemed to be without much in the way of solutions.</p>
<p>After I identified that function as being the longest running one in the application that I could find at the time I was left frustrated. It says that it can be expensive to recalculate those symbols, so why is it doing so without me saying I need any of them!? However with no solution I left it be for the time, and let the sand it put in the gears just slow my motivation to work on Lipuma down.</p>
<p>According to old messages I left in the <a href="https://www.recurse.com/">Recurse</a> group chat, I apperently thought that <a href="https://mail.gnome.org/archives/gtk-app-devel-list/2008-October/msg00000.html">This conversation</a> had something to do with it, and tried changing my GTK theme. It didn&#39;t help.</p>
<h2>New Discoveries</h2>
<p>Today I took another crack at it. I&#39;ve been trying to keep up with the recent development of Raph Levien&#39;s other Rust GUI projects and that had motivated me to start working on mine again. Immediately I was frustrated by the slow startup times even just for simple poking around.</p>
<p>I found <a href="https://forum.endeavouros.com/t/gtk-applications-lagging-and-have-a-long-startup-time/29770">this conversation</a> which pointed me in the direction of <code>journalctl</code>. I would like to think I could be forgiven for not thinking to look in the system journal logs for a user desktop application issue. It seems crazy to me that the system logs would be the right place to put information like this, and not say, the terminal that the program opened in.</p>
<p>Looking into journalctl however I did notice multiple interesting things. A misbehaving usb device, (My cheap little webcam I found out), a user service that was looking for a program that no longer existed (A fail-restart count of over 20000!) and when opening my program and triggering the bug? A massive wall of text. <code>goa-daemon</code> letting me know that <code>secret_password_lookup_sync()</code> returned <code>NULL</code>, a bunch of GTK daemons being activated and <code>/run/user</code> directories failing to mount by fusermount, multiple portal services attempting to open, all until theres a timeout on <code>org.freedesktop.secrets</code> that has failed, with a timeout of 12 seconds... That sounds like some smoking guns.</p>
<p>I started googling around by copying some of these error messages until I found &#34;<a href="https://bbs.archlinux.org/viewtopic.php?id=260222">[Solved] Slow launch of GTK3 apps with dbus-run-session</a>&#34;!!!!</p>
<p>Solved? Slow launch of GTK? That <em>HAS</em> to have what I need!</p>
<p>So I read down through it.</p>
<blockquote><p>Uninstalling flatpack and probably xdg-desktop-portal will probably accelerate things.</p>
</blockquote>
<p>No. No it cant be. How could it be flatpack? I dont use flatpack I hate flatpack. Its an answer in search of a problem. Its caused issues with incorrect versions of dependancies more times than its solved them.</p>
<blockquote><p><code>sudo apt uninstall flatpack xdg-desktop-portal</code></p>
</blockquote>
<p>Check the bug again.</p>
<p>Its solved.</p>
<p>wut?</p>
</div></div>
  </body>
</html>
