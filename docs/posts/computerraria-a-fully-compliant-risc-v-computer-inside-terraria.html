<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/misprit7/computerraria">Original</a>
    <h1>Computerraria: A fully compliant RISC-V computer inside Terraria</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<h2 tabindex="-1" dir="auto"><a id="user-content---a-fully-compliant-risc-v-computer-inside-terraria" aria-hidden="true" href="#--a-fully-compliant-risc-v-computer-inside-terraria"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>
  A fully compliant RISC-V computer inside Terraria
</h2>
<p><a href="https://github.com/misprit7/computerraria/actions/workflows/in-game-tests.yml">
    <img src="https://github.com/misprit7/computerraria/actions/workflows/in-game-tests.yml/badge.svg/"/>
  </a>
  <a href="https://github.com/misprit7/computerraria/actions/workflows/rust-tests.yml">
    <img src="https://github.com/misprit7/computerraria/actions/workflows/rust-tests.yml/badge.svg/"/>
  </a>
</p>

<p dir="auto">There are two fundamentally competing forces when it comes to computer speed. The first, and most famous, is Moore&#39;s law, where physical transistor densities scale exponentially. The second is the inevitable growth of software bloat that runs on top of increasingly modern processors. There&#39;s a kind of equilibrium between these two competing beasts, ensuring that a user always manages to get at least a split second of mindfulness while staring at a frozen screen whenever attempting to open the latest app.</p>
<p dir="auto">This project is an attempt to score a decisive rout in this ongoing battle in favor of the <em>programmer</em>. By emulating a complete rv32i instruction set inside the wiring system of <a href="https://www.terraria.org/" rel="nofollow">Terraria</a>, we push back speeds to the early 70s era, tossing the ball firmly back into the court of silicon engineer without losing any software functionality.</p>


<p dir="auto">Despite what the pitch may lead one to believe the goal of this project is to maximize the compliance and processing ability of the in game cpu. This is only possible with the help of an accelerator mod, which maintains full compatibility with the vanilla wiring system but reimplements it in a much more efficient manner:</p>
<p dir="auto"><a href="https://github.com/misprit7/WireHead">WireHead</a> - A wiring accelerator and headless control mod</p>
<p dir="auto">With this installed, the current specs of the computer are as follows:</p>
<ul dir="auto">
<li>Clock speed: ~5kHz</li>
<li>Ram: 96kb</li>
<li>Instruction set: rv32i</li>
</ul>
<p dir="auto">As an example of what it can do, here is Pong, running purely on the in-game cpu (see <a href="https://rgoswami.me/misprit7/computerraria/blob/main/app/pong/src/main.rs">app/pong/src/main.rs</a> for implementation):</p>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span aria-label="Video description pong-v2.mp4">pong-v2.mp4</span>
    <span></span>
  </summary>

  <video src="https://user-images.githubusercontent.com/33139843/229342342-de4708e1-7467-4f99-834b-3d0fb28d0858.mp4" data-canonical-src="https://user-images.githubusercontent.com/33139843/229342342-de4708e1-7467-4f99-834b-3d0fb28d0858.mp4" controls="controls" muted="muted">

  </video>
</details>


<p dir="auto">Note that currently only Linux is fully supported, and only parts of this have been tested on Windows. However I&#39;ve left some steps for anyone who wants to try getting Windows working, in theory using wsl it should be fairly straightforward and things should be identical.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-prerequisites" aria-hidden="true" href="#prerequisites"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Prerequisites</h2>
<p dir="auto">For a comprehensive list of everything that is needed to run all aspects of this project, see the <a href="https://rgoswami.me/misprit7/computerraria/blob/main/docker/Dockerfile">Dockerfile</a>. However, to develop and run applications for the computer all you really need is a working Cargo/rustc installation, install it <a href="https://www.rust-lang.org/tools/install" rel="nofollow">here</a> or through your package manager.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-setup-process" aria-hidden="true" href="#setup-process"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Setup Process</h2>
<p dir="auto">Navigate to where you want to keep this project and clone it. Copy computer.wld to your tModLoader world path. Depending on your platform, this is:</p>
<div data-snippet-clipboard-copy-content="Windows: Documents\My Games\Terraria\ModLoader\Worlds
Linux: ~/.local/share/Terraria/tModLoader/Worlds"><pre><code>Windows: Documents\My Games\Terraria\ModLoader\Worlds
Linux: ~/.local/share/Terraria/tModLoader/Worlds
</code></pre></div>
<p dir="auto">On Linux you can automate copying back and forth like this with the <code>copy-world.sh</code> script with either the <code>--to</code> (copy to world folder) or <code>--from</code> (copy from world folder) flags.</p>
<p dir="auto">Next, navigate to the mod sources folder and clone <a href="https://github.com/misprit7/WireHead">WireHead</a>:</p>
<div data-snippet-clipboard-copy-content="#Windows
cd &#34;%userprofile%\Documents\My Games\Terraria\ModLoader\ModSources&#34; &amp;&amp; git clone https://github.com/misprit7/WireHead.git

#Linux
cd &#34;~/.local/share/Terraria/tModLoader/ModSources&#34; &amp;&amp; git clone https://github.com/misprit7/WireHead.git"><pre><code>#Windows
cd &#34;%userprofile%\Documents\My Games\Terraria\ModLoader\ModSources&#34; &amp;&amp; git clone https://github.com/misprit7/WireHead.git

#Linux
cd &#34;~/.local/share/Terraria/tModLoader/ModSources&#34; &amp;&amp; git clone https://github.com/misprit7/WireHead.git
</code></pre></div>
<p dir="auto">Prepare the binary you wish to run. For example for pong compile the rust app and copy the binary to a more convenient path:</p>
<div data-snippet-clipboard-copy-content="cd &lt;path to computerraria&gt;/app/pong
cargo rb
./copy-bin.sh /tmp/pong.txt"><pre><code>cd &lt;path to computerraria&gt;/app/pong
cargo rb
./copy-bin.sh /tmp/pong.txt
</code></pre></div>
<p dir="auto">Start <a href="https://store.steampowered.com/app/1281930/tModLoader/" rel="nofollow">tModLoader</a>, and from the main menu go to Workshop-&gt;Develop and click on the Build button next to WireHead. For convenience I&#39;d also recommend installing Cheat Sheet and HERO&#39;s Mod from the Download Mods section of the workshop if you haven&#39;t already. Then open the new world you copied earlier in game. In game type:</p>

<p dir="auto">Currently the NPCs that run the CPU clock are too far away to spawn immediately, this is a bug and should be fixed soon. As a workaround, go through the blue teleporter shown below, fly upwards a bit, come back down and go back through the same teleporter.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://rgoswami.me/misprit7/computerraria/blob/main/doc/img/control-panel.png"><img src="https://rgoswami.me/misprit7/computerraria/raw/main/doc/img/control-panel.png" alt="Control Panel"/></a></p>
<p dir="auto">After this workaround is done, press the first two of the three levers on the far right to start the program. Go through the orange teleporter to arrive at the screen area. Pong should be running and is controllable by the controller beneath the screen (use HERO&#39;s Mod&#39;s camera lock to see the screen and controls at the same time).</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://rgoswami.me/misprit7/computerraria/blob/main/doc/img/pong-still.png"><img src="https://rgoswami.me/misprit7/computerraria/raw/main/doc/img/pong-still.png" alt="Pong"/></a></p>
<h2 tabindex="-1" dir="auto"><a id="user-content-docker" aria-hidden="true" href="#docker"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Docker</h2>
<p dir="auto">For advanced CI/headless usage you can use the docker image:</p>
<p dir="auto"><a href="https://hub.docker.com/r/misprit7/computerraria" rel="nofollow">Docker Image</a></p>
<p dir="auto">If you already have docker installed this can be pulled with</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker pull misprit7/computerraria"><pre>docker pull misprit7/computerraria</pre></div>
<p dir="auto">You can then start the container with</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run -it misprit7/computerraria"><pre>docker run -it misprit7/computerraria</pre></div>
<p dir="auto">This image already has all tooling installed so you should be able to build everything.</p>

<p dir="auto">The major relevant parts of the project are as follows:</p>
<div data-snippet-clipboard-copy-content=".
├── app/
│   ├── tdriver/
│   └── template/
├── computer.wld
├── doc/
├── docker/
├── test/
└── tinterface/
    ├── bin/
    └── tinterface/"><pre><code>.
├── app/
│   ├── tdriver/
│   └── template/
├── computer.wld
├── doc/
├── docker/
├── test/
└── tinterface/
    ├── bin/
    └── tinterface/
</code></pre></div>
<p dir="auto"><code>app/</code></p>
<p dir="auto">Higher level applications to be run on the computer, not including compliance tests. Currently all in rust but could also easily be in C.</p>
<p dir="auto"><code>app/tdriver/</code></p>
<p dir="auto">Driver API for interacting cpu from rust, mostly extremely low level startup code and graphics drivers.</p>
<p dir="auto"><code>app/template/</code></p>
<p dir="auto">Template for new rust projects that implements minimal tdriver</p>
<p dir="auto"><code>computer.wld</code></p>
<p dir="auto">The actual world file. This is technically a binary file, but given the context of the project it acts much more like source code given that it is edited manually and compresses extremely well. This generally isn&#39;t edited in place, it&#39;s copied back and forth to the user installation with <a href="https://rgoswami.me/misprit7/computerraria/blob/main/copy_world.sh">copy-world.sh</a>.</p>
<p dir="auto"><code>doc/</code></p>
<p dir="auto">Documentation/notes for the project</p>
<p dir="auto"><code>docker/</code></p>
<p dir="auto">Files required to build docker image for CI.</p>
<p dir="auto"><code>test/</code></p>
<p dir="auto">All automated tests written for the CPU. These are mostly handled through <a href="https://github.com/riscv-software-src/riscof">riscof</a>. This consists of both the computerraria plugin as well as a reference plugin (<a href="https://rgoswami.me/misprit7/computerraria/blob/main/test/sail_cSim">sail_cSim</a>) to compare the results to.</p>
<p dir="auto"><code>tinterface/</code></p>
<p dir="auto">Interfaces programmatically with running Terraria instance. This consists of both a python module as well as a command line wrapper to upload binaries, start execution and manipulate other fine grain controls without needing a GUI.</p>
</article>
          </div></div>
  </body>
</html>
