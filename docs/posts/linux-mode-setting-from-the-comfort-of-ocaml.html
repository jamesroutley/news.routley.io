<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://roscidus.com/blog/blog/2025/11/16/libdrm-ocaml/">Original</a>
    <h1>Linux mode setting, from the comfort of OCaml</h1>
    
    <div id="readability-page-1" class="page"><div>
              <p>Linux provides the KMS (Kernel Mode Setting) API to let applications query and configure display settings.
It&#39;s used by Wayland compositors and other programs that need to configure the hardware directly.
I found the C API a little verbose and hard to follow so I made <a href="https://github.com/talex5/libdrm-ocaml">libdrm-ocaml</a>,
which lets us run commands interactively in a REPL.</p>
<!-- more -->
<p>We&#39;ll start by discovering what hardware is available and how it&#39;s currently configured,
then configure a monitor to display a simple bitmap, and then finally render a 3D animation.
The post should be a useful introduction to KMS even if you don&#39;t know OCaml.</p>
<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=45947822">Hacker News</a> )</p>
<p><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
<li><a href="#running-it-yourself">Running it yourself</a>
</li>
<li><a href="#querying-the-current-state">Querying the current state</a>
<ul>
<li><a href="#finding-devices">Finding devices</a>
</li>
<li><a href="#listing-resources">Listing resources</a>
</li>
<li><a href="#connectors">Connectors</a>
</li>
<li><a href="#modes">Modes</a>
</li>
<li><a href="#properties">Properties</a>
</li>
<li><a href="#encoders">Encoders</a>
</li>
<li><a href="#crt-controllers">CRT Controllers</a>
</li>
<li><a href="#framebuffers">Framebuffers</a>
</li>
<li><a href="#crtc-planes">CRTC planes</a>
</li>
<li><a href="#expanded-resources-diagram">Expanded resources diagram</a>
</li>
</ul>
</li>
<li><a href="#making-changes">Making changes</a>
<ul>
<li><a href="#non-atomic-mode-setting">Non-atomic mode setting</a>
</li>
<li><a href="#dumb-buffers">Dumb buffers</a>
</li>
<li><a href="#atomic-mode-setting">Atomic mode setting</a>
</li>
</ul>
</li>
<li><a href="#d-rendering">3D rendering</a>
</li>
<li><a href="#linux-vts">Linux VTs</a>
</li>
<li><a href="#debugging">Debugging</a>
</li>
<li><a href="#conclusions">Conclusions</a>
</li>
</ul>
<h2 id="running-it-yourself">Running it yourself</h2>
<p>If you want to follow along, you&#39;ll need to install <a href="https://github.com/talex5/libdrm-ocaml">libdrm-ocaml</a> and an interactive REPL like <a href="https://github.com/ocaml-community/utop">utop</a>.
With Nix, you can set everything up like this:</p>
<pre><code>git clone https://github.com/talex5/libdrm-ocaml
cd libdrm-ocaml
nix develop
dune utop
</code></pre>
<p>You should see a <code>utop #</code> prompt, where you can enter OCaml expressions.
Use <code>;;</code> to tell the REPL you&#39;ve finished typing and it&#39;s time to evaluate, e.g.</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>1</span><span>+</span><span>1</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>int</span> <span>=</span> <span>2</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Alternatively, you can install things using <a href="https://opam.ocaml.org/">opam</a> (OCaml&#39;s package manager):</p>
<pre><code>opam install libdrm utop
utop
</code></pre>
<p>Then, at the utop prompt enter <code>#require &#34;libdrm&#34;;;</code> (including the leading <code>#</code>).</p>
<h2 id="querying-the-current-state">Querying the current state</h2>
<p>Before changing anything, we&#39;ll start by discovering what hardware is available.</p>
<p>I&#39;ll introduce the API as we go along, but you can check the <a href="https://talex5.github.io/libdrm-ocaml/libdrm/Drm/index.html">API reference docs</a>
if you want more information.</p>
<h3 id="finding-devices">Finding devices</h3>
<p>To list available graphics devices:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>Drm</span><span>.</span><span>Device</span><span>.</span><span>list</span> <span>()</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>Drm</span><span>.</span><span>Device</span><span>.</span><span>Info</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span><span>[{</span><span>primary_node</span> <span>=</span> <span>Some</span> <span>&#34;/dev/dri/card0&#34;</span><span>;</span>
</span><span>  <span>render_node</span> <span>=</span> <span>Some</span> <span>&#34;/dev/dri/renderD128&#34;</span><span>;</span>
</span><span>  <span>info</span> <span>=</span> <span>PCI</span> <span>{</span><span>bus</span> <span>=</span> <span>{</span><span>domain</span> <span>=</span> <span>0</span><span>;</span> <span>bus</span> <span>=</span> <span>1</span><span>;</span> <span>dev</span> <span>=</span> <span>0</span><span>;</span> <span>func</span> <span>=</span> <span>0</span><span>};</span>
</span><span>              <span>dev</span> <span>=</span> <span>{</span><span>vendor_id</span> <span>=</span> <span>0x1002</span><span>;</span>
</span><span>                     <span>device_id</span> <span>=</span> <span>0x67ff</span><span>;</span>
</span><span>                     <span>subvendor_id</span> <span>=</span> <span>0x1458</span><span>;</span>
</span><span>                     <span>subdevice_id</span> <span>=</span> <span>0x230b</span><span>;</span>
</span><span>                     <span>revision_id</span> <span>=</span> <span>0xff</span><span>}}}]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>libdrm scans the <code>/dev/dri/</code> directory looking for devices.
It uses <code>stat</code> to find the device major and minor numbers and uses the virtual <code>/sys</code> filesystem to get information about each one.
This is a PCI device, and the information corresponds to the values from <code>lspci</code>, e.g.</p>
<pre><code>$ lspci -nns 0:1:0.0
01:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI]
  Baffin [Radeon RX 550 640SP / RX 560/560X] [1002:67ff] (rev ff)
</code></pre>
<p>Each graphics device can have a <em>primary</em> and a <em>render</em> node.
The primary node gives full access to the device, including configuring monitors,
while the render node just allows applications to render scenes to memory.
In the <a href="https://roscidus.com/blog/blog/2025/09/20/ocaml-vulkan/">last post</a> I was using the render to node to create a 3D image,
and then sending it to the Wayland compositor for display.
This time we&#39;ll be doing the display ourselves, so we need to open the primary node:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>dev</span> <span>=</span> <span>Unix</span><span>.</span><span>openfile</span> <span>&#34;/dev/dri/card0&#34;</span> <span>[</span><span>O_CLOEXEC</span><span>;</span> <span>O_RDWR</span><span>]</span> <span>0</span><span>;;</span>
</span><span><span>val</span> <span>dev</span> <span>:</span> <span>Unix</span><span>.</span><span>file_descr</span> <span>=</span> <span>&lt;</span><span>abstr</span><span>&gt;</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>To check the driver version:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>Drm</span><span>.</span><span>Device</span><span>.</span><span>Version</span><span>.</span><span>get</span> <span>dev</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>Drm</span><span>.</span><span>Device</span><span>.</span><span>Version</span><span>.</span><span>t</span> <span>=</span>
</span><span><span>{</span><span>version</span> <span>=</span> <span>3</span><span>.</span><span>61</span><span>.</span><span>0</span><span>;</span> <span>name</span> <span>=</span> <span>&#34;amdgpu&#34;</span><span>;</span> <span>date</span> <span>=</span> <span>&#34;0&#34;</span><span>;</span> <span>desc</span> <span>=</span> <span>&#34;AMD GPU&#34;</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>If you&#39;re familiar with the C API, this corresponds to the <code>drmGetVersion</code> function,
and <code>Drm.Device.list</code> corresponds to <code>drmGetDevices2</code>;
I reorganised things a bit to make better use of OCaml&#39;s modules.</p>
<h3 id="listing-resources">Listing resources</h3>
<p>Let&#39;s see what resources we&#39;ve got to play with:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>resources</span> <span>=</span> <span>Drm</span><span>.</span><span>Kms</span><span>.</span><span>Resources</span><span>.</span><span>get</span> <span>dev</span><span>;;</span>
</span><span><span>val</span> <span>resources</span> <span>:</span> <span>K</span><span>.</span><span>Resources</span><span>.</span><span>t</span> <span>=</span>
</span><span>  <span>{</span><span>fbs</span> <span>=</span> <span>[]</span><span>;</span>
</span><span>   <span>crtcs</span> <span>=</span> <span>[</span><span>57</span><span>;</span> <span>60</span><span>;</span> <span>63</span><span>;</span> <span>66</span><span>;</span> <span>69</span><span>];</span>
</span><span>   <span>connectors</span> <span>=</span> <span>[</span><span>71</span><span>;</span> <span>78</span><span>;</span> <span>84</span><span>];</span>
</span><span>   <span>encoders</span> <span>=</span> <span>[</span><span>70</span><span>;</span> <span>76</span><span>;</span> <span>83</span><span>;</span> <span>86</span><span>;</span> <span>87</span><span>;</span> <span>88</span><span>;</span> <span>89</span><span>;</span> <span>90</span><span>];</span>
</span><span>   <span>min_width</span><span>,</span><span>max_width</span> <span>=</span> <span>0</span><span>,</span><span>16384</span><span>;</span>
</span><span>   <span>min_height</span><span>,</span><span>max_height</span> <span>=</span> <span>0</span><span>,</span><span>16384</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Note: The Kernel Mode Setting functions are in the <a href="https://talex5.github.io/libdrm-ocaml/libdrm/Drm/Kms/index.html">Drm.Kms</a> module.
The C API calls these functions <code>drmMode*</code>, but I found that confusing as
e.g. <code>drmModeGetResources</code> sounds like you&#39;re asking for the resources of a mode.</p>
<p>A <em>CRTC</em> is a CRT Controller, and typically controls a single monitor
(known as a <a href="https://en.wikipedia.org/wiki/Cathode_ray_tube">Cathode Ray Tube</a> for historical reasons).
<em>Framebuffers</em> provide image data to a CRTC (we create framebuffers as needed).
<em>Connectors</em> correspond to physical connectors (e.g. where you plug in a monitor cable).
An <em>Encoder</em> encodes data from the CRTC for a particular connector.</p>
<p><a href="https://www.scd31.com/blog/images/libdrm/arch-simple.svg"><span><img src="https://www.scd31.com/blog/images/libdrm/arch-simple.svg" title="Resources diagram (simplified)"/><span>Resources diagram (simplified)</span></span></a></p>
<h3 id="connectors">Connectors</h3>
<p>To save a bit of typing, I&#39;ll create an alias for the <code>Drm.Kms</code> module:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>module</span> <span>K</span> <span>=</span> <span>Drm</span><span>.</span><span>Kms</span><span>;;</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>You could also <code>open Drm.Kms</code> to avoid needing any prefix, but I&#39;ll keep using <code>K</code> for clarity.</p>
<p>To get details for the first connector (the head of the list):</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>get</span> <span>dev</span> <span>(</span><span>List</span><span>.</span><span>hd</span> <span>resources</span><span>.</span><span>connectors</span><span>);;</span>
</span><span><span>-</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span> <span>=</span>
</span><span><span>{</span><span>connector_id</span> <span>=</span> <span>71</span><span>;</span> <span>(* DP-1 *)</span>
</span><span> <span>connector_type</span> <span>=</span> <span>DisplayPort</span><span>;</span>
</span><span> <span>connector_type_id</span> <span>=</span> <span>1</span><span>;</span>
</span><span> <span>connection</span> <span>=</span> <span>Connected</span><span>;</span>
</span><span> <span>mm_width</span><span>,</span><span>mm_height</span> <span>=</span> <span>700</span><span>,</span><span>390</span><span>;</span>
</span><span> <span>subpixel</span> <span>=</span> <span>Unknown</span><span>;</span>
</span><span> <span>modes</span> <span>=</span> <span>[</span><span>3840</span><span>x2160</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span>
</span><span>          <span>3840</span><span>x2160</span> <span>30</span><span>.</span><span>00</span><span>Hz</span><span>;</span>
</span><span>          <span>3840</span><span>x2160</span> <span>29</span><span>.</span><span>97</span><span>Hz</span><span>;</span>
</span><span>          <span>2560</span><span>x1440</span> <span>59</span><span>.</span><span>95</span><span>Hz</span><span>;</span>
</span><span>          <span>...];</span>
</span><span> <span>props</span> <span>=</span> <span>[</span><span>1</span><span>:</span><span>77</span><span>;</span> <span>2</span><span>:</span><span>0</span><span>;</span> <span>5</span><span>:</span><span>0</span><span>;</span> <span>6</span><span>:</span><span>0</span><span>;</span> <span>4</span><span>:</span><span>0</span><span>;</span> <span>34</span><span>:</span><span>0</span><span>;</span> <span>35</span><span>:</span><span>0</span><span>;</span> <span>36</span><span>:</span><span>0</span><span>;</span> <span>37</span><span>:</span><span>0</span><span>;</span> <span>72</span><span>:</span><span>8</span><span>;</span> <span>73</span><span>:</span><span>0</span><span>;</span> 
</span><span>          <span>7</span><span>:</span><span>0</span><span>;</span> <span>74</span><span>:</span><span>0</span><span>;</span> <span>75</span><span>:</span><span>15</span><span>];</span>
</span><span> <span>encoder_id</span> <span>=</span> <span>Some</span> <span>70</span><span>;</span>
</span><span> <span>encoders</span> <span>=</span> <span>[</span><span>70</span><span>]}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>This is DisplayPort connector 1 (usually called <code>DP-1</code>) and it&#39;s currently <code>Connected</code>.
The connector also says which modes are available on the connected monitor.</p>
<p>I was lucky in that the first connector was the one I&#39;m using,
but really we should get all the connectors and filter them to find the connected ones.
<code>List.map</code> can be used to run <code>get</code> on each of them:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>connectors</span> <span>=</span> <span>List</span><span>.</span><span>map</span> <span>(</span><span>K</span><span>.</span><span>Connector</span><span>.</span><span>get</span> <span>dev</span><span>)</span> <span>resources</span><span>.</span><span>connectors</span><span>;;</span>
</span><span><span>val</span> <span>connectors</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span>  <span>[{</span><span>connector_id</span> <span>=</span> <span>71</span><span>;</span> <span>(* DP-1 *)</span> <span>...};</span>
</span><span>   <span>{</span><span>connector_id</span> <span>=</span> <span>78</span><span>;</span> <span>(* HDMI-A-1 *)</span> <span>...};</span>
</span><span>   <span>{</span><span>connector_id</span> <span>=</span> <span>84</span><span>;</span> <span>(* DVI-D-1 *)</span> <span>...}]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Then to filter:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>is_connected</span> <span>(</span><span>c</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span><span>)</span> <span>=</span> <span>(</span><span>c</span><span>.</span><span>connection</span> <span>=</span> <span>Connected</span><span>);;</span>
</span><span><span>val</span> <span>is_connected</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span> <span>-&gt;</span> <span>bool</span> <span>=</span> <span>&lt;</span><span>fun</span><span>&gt;</span>
</span><span>
</span><span><span>utop</span> <span>#</span> <span>let</span> <span>connected</span> <span>=</span> <span>List</span><span>.</span><span>filter</span> <span>is_connected</span> <span>connectors</span><span>;;</span>
</span><span><span>val</span> <span>connected</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span>  <span>[{</span><span>connector_id</span> <span>=</span> <span>71</span><span>;</span> <span>(* DP-1 *)</span> <span>...}]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>We&#39;ll investigate <code>c</code>, the first connected one:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>c</span> <span>=</span> <span>List</span><span>.</span><span>hd</span> <span>connected</span><span>;;</span>
</span><span><span>val</span> <span>c</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span> <span>=</span>
</span><span>  <span>{</span><span>connector_id</span> <span>=</span> <span>71</span><span>;</span> <span>(* DP-1 *)</span> <span>...}</span>
</span></code></pre></td></tr></tbody></table></div></figure><h4 id="a-note-on-ids">A note on IDs</h4>
<p>In the libdrm C API, IDs are just integers.
To avoid mix-ups, I made them distinct types in the OCaml API.
For example, if you try to use an encoder ID as a connector ID:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>get</span> <span>dev</span> <span>(</span><span>List</span><span>.</span><span>hd</span> <span>resources</span><span>.</span><span>encoders</span><span>);;</span>
</span><span>                           <span>^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span><span>Error</span><span>:</span> <span>This</span> <span>expression</span> <span>has</span> <span>type</span> <span>Drm</span><span>.</span><span>Kms</span><span>.</span><span>Encoder</span><span>.</span><span>id</span> <span>=</span> <span>[</span> <span>`</span><span>Encoder</span> <span>]</span> <span>Drm</span><span>.</span><span>Id</span><span>.</span><span>t</span>
</span><span>       <span>but</span> <span>an</span> <span>expression</span> <span>was</span> <span>expected</span> <span>of</span> <span>type</span>
</span><span>         <span>K</span><span>.</span><span>Connector</span><span>.</span><span>id</span> <span>=</span> <span>[</span> <span>`</span><span>Connector</span> <span>]</span> <span>Drm</span><span>.</span><span>Id</span><span>.</span><span>t</span>
</span><span>       <span>These</span> <span>two</span> <span>variant</span> <span>types</span> <span>have</span> <span>no</span> <span>intersection</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Normally this is what you want, but for interactive use it&#39;s annoying that you can&#39;t just pass a plain integer.
e.g.</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>get</span> <span>dev</span> <span>71</span><span>;;</span>
</span><span>                           <span>^^</span>
</span><span><span>Error</span><span>:</span> <span>The</span> <span>constant</span> <span>71</span> <span>has</span> <span>type</span> <span>int</span> <span>but</span> <span>an</span> <span>expression</span> <span>was</span> <span>expected</span> <span>of</span> <span>type</span>
</span><span>         <span>K</span><span>.</span><span>Connector</span><span>.</span><span>id</span> <span>=</span> <span>[</span> <span>`</span><span>Connector</span> <span>]</span> <span>Drm</span><span>.</span><span>Id</span><span>.</span><span>t</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>You can get any kind of ID with <code>Drm.Id.of_int</code> (e.g. <code>K.Connector.get dev (Drm.Id.of_int 71)</code>),
but that&#39;s still a bit verbose, so you might prefer to (re)define a prefix operator for it, e.g.</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>(</span> <span>!</span> <span>)</span> <span>=</span> <span>Drm</span><span>.</span><span>Id</span><span>.</span><span>of_int</span><span>;;</span>
</span><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>get</span> <span>dev</span> <span>!</span><span>71</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span> <span>=</span> <span>{</span><span>connector_id</span> <span>=</span> <span>71</span><span>;</span> <span>...}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>(note: <code>!</code> is the only single-character prefix operator available in OCaml)</p>
<h3 id="modes">Modes</h3>
<p>Modes are shown in abbreviated form in the connector output.
To see the full list:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>c</span><span>.</span><span>modes</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>K</span><span>.</span><span>Mode_info</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span><span>[</span><span>3840</span><span>x2160</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>3840</span><span>x2160</span> <span>30</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>3840</span><span>x2160</span> <span>29</span><span>.</span><span>97</span><span>Hz</span><span>;</span> <span>2560</span><span>x1440</span> <span>59</span><span>.</span><span>95</span><span>Hz</span><span>;</span>
</span><span> <span>1920</span><span>x1200</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>1920</span><span>x1080</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>1920</span><span>x1080</span> <span>59</span><span>.</span><span>94</span><span>Hz</span><span>;</span> <span>1600</span><span>x1200</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span>
</span><span> <span>1680</span><span>x1050</span> <span>59</span><span>.</span><span>95</span><span>Hz</span><span>;</span> <span>1600</span><span>x900</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>1280</span><span>x1024</span> <span>75</span><span>.</span><span>02</span><span>Hz</span><span>;</span> <span>1280</span><span>x1024</span> <span>60</span><span>.</span><span>02</span><span>Hz</span><span>;</span>
</span><span> <span>1440</span><span>x900</span> <span>59</span><span>.</span><span>89</span><span>Hz</span><span>;</span> <span>1280</span><span>x800</span> <span>59</span><span>.</span><span>81</span><span>Hz</span><span>;</span> <span>1152</span><span>x864</span> <span>75</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>1280</span><span>x720</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span>
</span><span> <span>1280</span><span>x720</span> <span>59</span><span>.</span><span>94</span><span>Hz</span><span>;</span> <span>1024</span><span>x768</span> <span>75</span><span>.</span><span>03</span><span>Hz</span><span>;</span> <span>1024</span><span>x768</span> <span>70</span><span>.</span><span>07</span><span>Hz</span><span>;</span> <span>1024</span><span>x768</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span>
</span><span> <span>832</span><span>x624</span> <span>74</span><span>.</span><span>55</span><span>Hz</span><span>;</span> <span>800</span><span>x600</span> <span>75</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>800</span><span>x600</span> <span>72</span><span>.</span><span>19</span><span>Hz</span><span>;</span> <span>800</span><span>x600</span> <span>60</span><span>.</span><span>32</span><span>Hz</span><span>;</span>
</span><span> <span>800</span><span>x600</span> <span>56</span><span>.</span><span>25</span><span>Hz</span><span>;</span> <span>640</span><span>x480</span> <span>75</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>640</span><span>x480</span> <span>72</span><span>.</span><span>81</span><span>Hz</span><span>;</span> <span>640</span><span>x480</span> <span>66</span><span>.</span><span>67</span><span>Hz</span><span>;</span>
</span><span> <span>640</span><span>x480</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>;</span> <span>640</span><span>x480</span> <span>59</span><span>.</span><span>94</span><span>Hz</span><span>;</span> <span>720</span><span>x400</span> <span>70</span><span>.</span><span>08</span><span>Hz</span><span>]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Note: I annotated various pretty-printer functions with <code>[@@ocaml.toplevel_printer]</code>,
which causes utop to use them by default to display values of the corresponding type.
For example, showing a list of modes uses this short summary form.
Displaying an individual mode shows all the information.
Here&#39;s the first mode:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
</pre></td><td><pre><code><span><span>#</span> <span>List</span><span>.</span><span>hd</span> <span>c</span><span>.</span><span>modes</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>K</span><span>.</span><span>Mode_info</span><span>.</span><span>t</span> <span>=</span>
</span><span><span>{</span><span>name</span> <span>=</span> <span>&#34;3840x2160&#34;</span><span>;</span>
</span><span> <span>typ</span> <span>=</span> <span>preferred</span><span>+</span><span>driver</span><span>;</span>
</span><span> <span>flags</span> <span>=</span> <span>phsync</span><span>+</span><span>nvsync</span><span>;</span>
</span><span> <span>stereo_mode</span> <span>=</span> <span>None</span><span>;</span>
</span><span> <span>aspect_ratio</span> <span>=</span> <span>None</span><span>;</span>
</span><span> <span>clock</span> <span>=</span> <span>533250</span><span>;</span>
</span><span> <span>hdisplay</span><span>,</span><span>vdisplay</span> <span>=</span> <span>3840</span><span>,</span><span>2160</span><span>;</span>
</span><span> <span>hsync_start</span> <span>=</span> <span>3888</span><span>;</span>
</span><span> <span>hsync_end</span> <span>=</span> <span>3920</span><span>;</span>
</span><span> <span>htotal</span> <span>=</span> <span>4000</span><span>;</span>
</span><span> <span>hskew</span> <span>=</span> <span>0</span><span>;</span>
</span><span> <span>vsync_start</span> <span>=</span> <span>2163</span><span>;</span>
</span><span> <span>vsync_end</span> <span>=</span> <span>2168</span><span>;</span>
</span><span> <span>vtotal</span> <span>=</span> <span>2222</span><span>;</span>
</span><span> <span>vscan</span> <span>=</span> <span>0</span><span>;</span>
</span><span> <span>vrefresh</span> <span>=</span> <span>60</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><h3 id="properties">Properties</h3>
<p>Some resources can also have extra <a href="https://drmdb.emersion.fr/properties">properties</a>.
Use <code>get_properties</code> to fetch them:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>get_properties</span> <span>dev</span> <span>c</span><span>.</span><span>connector_id</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>[</span> <span>`</span><span>Connector</span> <span>]</span> <span>K</span><span>.</span><span>Properties</span><span>.</span><span>t</span> <span>=</span>
</span><span><span>{</span><span>EDID</span> <span>=</span> <span>92</span><span>;</span> <span>DPMS</span> <span>=</span> <span>On</span><span>;</span> <span>TILE</span> <span>=</span> <span>None</span><span>;</span> <span>link</span><span>-</span><span>status</span> <span>=</span> <span>Good</span><span>;</span> <span>non</span><span>-</span><span>desktop</span> <span>=</span> <span>0</span><span>;</span>
</span><span> <span>HDR_OUTPUT_METADATA</span> <span>=</span> <span>None</span><span>;</span> <span>scaling</span> <span>mode</span> <span>=</span> <span>None</span><span>;</span> <span>underscan</span> <span>=</span> <span>off</span><span>;</span>
</span><span> <span>underscan</span> <span>hborder</span> <span>=</span> <span>0</span><span>;</span> <span>underscan</span> <span>vborder</span> <span>=</span> <span>0</span><span>;</span> <span>max</span> <span>bpc</span> <span>=</span> <span>8</span><span>;</span>
</span><span> <span>Colorspace</span> <span>=</span> <span>Default</span><span>;</span> <span>vrr_capable</span> <span>=</span> <span>0</span><span>;</span> <span>subconnector</span> <span>=</span> <span>Native</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Linux only returns a subset of the properties until you enable the <a href="https://talex5.github.io/libdrm-ocaml/libdrm/Drm/Client_cap/index.html#val-atomic">atomic</a> feature.
Let&#39;s turn that on now:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>Drm</span><span>.</span><span>Client_cap</span><span>.</span><span>(</span><span>set</span> <span>atomic</span><span>)</span> <span>dev</span> <span>true</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>(</span><span>unit</span><span>,</span> <span>Unix</span><span>.</span><span>error</span><span>)</span> <span>result</span> <span>=</span> <span>Ok</span> <span>()</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>(<code>Module.(expr)</code> is a short-hand that brings all of <code>Module</code>&#39;s symbols into scope for <code>expr</code>,
so we don&#39;t have to repeat the module name for both <code>set</code> and <code>atomic</code>)</p>
<p>And getting the properties again, we now have an extra <code>CRTC_ID</code>,
telling us which controller this connector is currently using:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>c_props</span> <span>=</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>get_properties</span> <span>dev</span> <span>c</span><span>.</span><span>connector_id</span><span>;;</span>
</span><span><span>val</span> <span>c_props</span> <span>:</span> <span>[</span> <span>`</span><span>Connector</span> <span>]</span> <span>K</span><span>.</span><span>Properties</span><span>.</span><span>t</span> <span>=</span>
</span><span><span>{</span><span>EDID</span> <span>=</span> <span>92</span><span>;</span> <span>DPMS</span> <span>=</span> <span>On</span><span>;</span> <span>TILE</span> <span>=</span> <span>None</span><span>;</span> <span>link</span><span>-</span><span>status</span> <span>=</span> <span>Good</span><span>;</span> <span>non</span><span>-</span><span>desktop</span> <span>=</span> <span>0</span><span>;</span>
</span><span> <span>HDR_OUTPUT_METADATA</span> <span>=</span> <span>None</span><span>;</span> <span>CRTC_ID</span> <span>=</span> <span>57</span><span>;</span> <span>scaling</span> <span>mode</span> <span>=</span> <span>None</span><span>;</span>
</span><span> <span>underscan</span> <span>=</span> <span>off</span><span>;</span> <span>underscan</span> <span>hborder</span> <span>=</span> <span>0</span><span>;</span> <span>underscan</span> <span>vborder</span> <span>=</span> <span>0</span><span>;</span> <span>max</span> <span>bpc</span> <span>=</span> <span>8</span><span>;</span>
</span><span> <span>Colorspace</span> <span>=</span> <span>Default</span><span>;</span> <span>vrr_capable</span> <span>=</span> <span>0</span><span>;</span> <span>subconnector</span> <span>=</span> <span>Native</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><h3 id="encoders">Encoders</h3>
<p><a href="https://www.kernel.org/doc/html/latest/gpu/drm-kms.html">The Linux documentation</a> says:</p>
<blockquote>
<p>Those are really just internal artifacts of the helper libraries used to
implement KMS drivers. Besides that they make it unnecessarily more
complicated for userspace to figure out which connections between a CRTC and
a connector are possible, and what kind of cloning is supported, they serve
no purpose in the userspace API. Unfortunately encoders have been exposed to
userspace, hence canâ€™t remove them at this point. Furthermore the exposed
restrictions are often wrongly set by drivers, and in many cases not powerful
enough to express the real restrictions.</p>
</blockquote>
<p>OK. Well, let&#39;s take a look anyway:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>e</span> <span>=</span> <span>K</span><span>.</span><span>Encoder</span><span>.</span><span>get</span> <span>dev</span> <span>(</span><span>Option</span><span>.</span><span>get</span> <span>c</span><span>.</span><span>encoder_id</span><span>);;</span>
</span><span><span>val</span> <span>e</span> <span>:</span> <span>K</span><span>.</span><span>Encoder</span><span>.</span><span>t</span> <span>=</span>
</span><span>  <span>{</span><span>encoder_id</span> <span>=</span> <span>70</span><span>;</span>
</span><span>   <span>encoder_type</span> <span>=</span> <span>TMDS</span><span>;</span>
</span><span>   <span>crtc_id</span> <span>=</span> <span>Some</span> <span>57</span><span>;</span>
</span><span>   <span>possible_crtcs</span> <span>=</span> <span>0x1f</span><span>;</span>
</span><span>   <span>possible_clones</span> <span>=</span> <span>0x1</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Note: We need <code>Option.get</code> here because a connector might not have an encoder set yet.
Where the C API uses 0 to indicate no resource,
the OCaml API uses <code>None</code> to force us to think about that case.</p>
<p>As the documentation says, the encoder is mainly useful to get the CRTC ID:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>crtc_id</span> <span>=</span> <span>Option</span><span>.</span><span>get</span> <span>e</span><span>.</span><span>crtc_id</span><span>;;</span>
</span><span><span>val</span> <span>crtc_id</span> <span>:</span> <span>Drm</span><span>.</span><span>Kms</span><span>.</span><span>Crtc</span><span>.</span><span>id</span> <span>=</span> <span>57</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>We could instead have got that directly from the connector using its properties:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Properties</span><span>.</span><span>Values</span><span>.</span><span>get_value_exn</span> <span>c_props</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>crtc_id</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>[</span> <span>`</span><span>Crtc</span> <span>]</span> <span>Drm</span><span>.</span><span>Id</span><span>.</span><span>t</span> <span>option</span> <span>=</span> <span>Some</span> <span>57</span>
</span></code></pre></td></tr></tbody></table></div></figure><h3 id="crt-controllers">CRT Controllers</h3>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>crtc</span> <span>=</span> <span>K</span><span>.</span><span>Crtc</span><span>.</span><span>get</span> <span>dev</span> <span>crtc_id</span><span>;;</span>
</span><span><span>val</span> <span>crtc</span> <span>:</span> <span>K</span><span>.</span><span>Crtc</span><span>.</span><span>t</span> <span>=</span>
</span><span>  <span>{</span><span>crtc_id</span> <span>=</span> <span>57</span><span>;</span>
</span><span>   <span>fb_id</span> <span>=</span> <span>Some</span> <span>93</span><span>;</span>
</span><span>   <span>x</span><span>,</span><span>y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>   <span>width</span><span>,</span><span>height</span> <span>=</span> <span>3840</span><span>,</span><span>2160</span><span>;</span>
</span><span>   <span>mode</span> <span>=</span> <span>Some</span> <span>3840</span><span>x2160</span> <span>60</span><span>.</span><span>00</span><span>Hz</span><span>}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>An active CRTC has a mode set (presumably from the connector&#39;s list of supported modes),
and a framebuffer with the image to be displayed.</p>
<p>If I keep calling <code>Crtc.get</code>, I see that it is sometimes showing framebuffer 93 and sometimes 94.
My Wayland compositor (Sway) updates one framebuffer while the other is being shown, then switches which one is displayed.</p>
<h3 id="framebuffers">Framebuffers</h3>
<p>My CRTC is currently displaying the contents of framebuffer 93:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>fb_id</span> <span>=</span> <span>Option</span><span>.</span><span>get</span> <span>crtc</span><span>.</span><span>fb_id</span><span>;;</span>
</span><span><span>val</span> <span>fb_id</span> <span>:</span> <span>Drm</span><span>.</span><span>Kms</span><span>.</span><span>Fb</span><span>.</span><span>id</span> <span>=</span> <span>93</span>
</span></code></pre></td></tr></tbody></table></div></figure><figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>fb</span> <span>=</span> <span>K</span><span>.</span><span>Fb</span><span>.</span><span>get</span> <span>dev</span> <span>fb_id</span><span>;;</span>
</span><span><span>val</span> <span>fb</span> <span>:</span> <span>K</span><span>.</span><span>Fb</span><span>.</span><span>t</span> <span>=</span>
</span><span>  <span>{</span><span>fb_id</span> <span>=</span> <span>93</span><span>;</span>
</span><span>   <span>width</span><span>,</span><span>height</span> <span>=</span> <span>3840</span><span>,</span><span>2160</span><span>;</span>
</span><span>   <span>pixel_format</span><span>,</span> <span>modifier</span> <span>=</span> <span>XR24</span><span>,</span> <span>None</span><span>;</span>
</span><span>   <span>interlaced</span> <span>=</span> <span>false</span><span>;</span>
</span><span>   <span>planes</span> <span>=</span> <span>[{</span><span>handle</span> <span>=</span> <span>None</span><span>;</span> <span>pitch</span> <span>=</span> <span>15360</span><span>;</span> <span>offset</span> <span>=</span> <span>0</span><span>}]}</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>A framebuffer has up to 4 framebuffer planes (not to be confused with CRTC planes; see later),
each of which references a <em>buffer object</em> (also known as a <em>BO</em> and referenced with a <em>GEM handle</em>).</p>
<p>This framebuffer is using the <code>XR24</code> format, where there is a single BO with 32 bits for each pixel
(8 for red, 8 green, 8 blue and 8 unused).
Some formats use e.g. a separate buffer for each component
(or a different part of the same buffer, using <code>offset</code>).</p>
<p>Modern graphics cards also support format <em>modifiers</em>, but my card is too old so I just get <code>None</code>.
Linux&#39;s <a href="https://github.com/torvalds/linux/blob/master/include/uapi/drm/drm_fourcc.h">fourcc.h</a> header file describes the various formats and modifiers.
Modifiers seem to be mainly used to specify the <a href="https://docs.mesa3d.org/isl/tiling.html">tiling</a>.</p>
<p>I don&#39;t have permission to see the buffer object, so it appears as (<code>handle = None</code>).
The <code>pitch</code> is the number of bytes from one row to the next (also known as the <em>stride</em>).
Here, the 15360 is simply the width (3840) multiplied by the 4 bytes per pixel.</p>
<h3 id="crtc-planes">CRTC planes</h3>
<p>In fact, <code>Crtc.get</code> is an old API that only covers the basic case of a single framebuffer.
In reality, a CRTC can combine multiple <em>CRTC planes</em>, which for some reason aren&#39;t returned with the other resources
and must be requested separately:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>plane_ids</span> <span>=</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>list</span> <span>dev</span><span>;;</span>
</span><span><span>val</span> <span>plane_ids</span> <span>:</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>id</span> <span>list</span> <span>=</span> <span>[</span><span>40</span><span>;</span> <span>43</span><span>;</span> <span>46</span><span>;</span> <span>49</span><span>;</span> <span>52</span><span>;</span> <span>55</span><span>;</span> <span>58</span><span>;</span> <span>61</span><span>;</span> <span>64</span><span>;</span> <span>67</span><span>]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>(note: you need to enable &#34;atomic&#34; mode before requesting planes; we already did that above)</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>planes</span> <span>=</span> <span>List</span><span>.</span><span>map</span> <span>(</span><span>K</span><span>.</span><span>Plane</span><span>.</span><span>get</span> <span>dev</span><span>)</span> <span>plane_ids</span><span>;;</span>
</span><span><span>val</span> <span>planes</span> <span>:</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span>  <span>[{</span><span>formats</span> <span>=</span> <span>[</span><span>XR24</span><span>;</span> <span>AR24</span><span>;</span> <span>RA24</span><span>;</span> <span>XR30</span><span>;</span> <span>XB30</span><span>;</span> <span>AR30</span><span>;</span> <span>AB30</span><span>;</span> <span>XR48</span><span>;</span> <span>XB48</span><span>;</span> 
</span><span>               <span>AR48</span><span>;</span> <span>AB48</span><span>;</span> <span>XB24</span><span>;</span> <span>AB24</span><span>;</span> <span>RG16</span><span>;</span> <span>XR4H</span><span>;</span> <span>AR4H</span><span>;</span> <span>XB4H</span><span>;</span> <span>AB4H</span><span>];</span>
</span><span>    <span>plane_id</span> <span>=</span> <span>40</span><span>;</span>
</span><span>    <span>crtc_id</span> <span>=</span> <span>None</span><span>;</span>
</span><span>    <span>fb_id</span> <span>=</span> <span>None</span><span>;</span>
</span><span>    <span>crtc_x</span><span>,</span><span>crtc_y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>    <span>x</span><span>,</span><span>y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>    <span>possible_crtcs</span> <span>=</span> <span>0x10</span><span>};</span>
</span><span>   <span>...</span>
</span><span>  <span>]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>A lot of these planes aren&#39;t being used (don&#39;t have a CRTC),
which we can check for with a helper function:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>has_crtc</span> <span>(</span><span>x</span> <span>:</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>t</span><span>)</span> <span>=</span> <span>(</span><span>x</span><span>.</span><span>crtc_id</span> <span>&lt;&gt;</span> <span>None</span><span>);;</span>
</span><span><span>val</span> <span>has_crtc</span> <span>:</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>t</span> <span>-&gt;</span> <span>bool</span> <span>=</span> <span>&lt;</span><span>fun</span><span>&gt;</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>Looks like Sway is using two planes at the moment:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>active_planes</span> <span>=</span> <span>List</span><span>.</span><span>filter</span> <span>has_crtc</span> <span>planes</span><span>;;</span>
</span><span><span>val</span> <span>active_planes</span> <span>:</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span>  <span>[{</span><span>formats</span> <span>=</span> <span>[</span><span>XR24</span><span>;</span> <span>AR24</span><span>;</span> <span>RA24</span><span>;</span> <span>XR30</span><span>;</span> <span>XB30</span><span>;</span> <span>AR30</span><span>;</span> <span>AB30</span><span>;</span> <span>XR48</span><span>;</span> <span>XB48</span><span>;</span> 
</span><span>               <span>AR48</span><span>;</span> <span>AB48</span><span>;</span> <span>XB24</span><span>;</span> <span>AB24</span><span>;</span> <span>RG16</span><span>;</span> <span>XR4H</span><span>;</span> <span>AR4H</span><span>;</span> <span>XB4H</span><span>;</span> <span>AB4H</span><span>];</span>
</span><span>    <span>plane_id</span> <span>=</span> <span>52</span><span>;</span>
</span><span>    <span>crtc_id</span> <span>=</span> <span>Some</span> <span>57</span><span>;</span>
</span><span>    <span>fb_id</span> <span>=</span> <span>Some</span> <span>94</span><span>;</span>
</span><span>    <span>crtc_x</span><span>,</span><span>crtc_y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>    <span>x</span><span>,</span><span>y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>    <span>possible_crtcs</span> <span>=</span> <span>0x1</span><span>};</span>
</span><span>   <span>{</span><span>formats</span> <span>=</span> <span>[</span><span>AR24</span><span>];</span>
</span><span>    <span>plane_id</span> <span>=</span> <span>55</span><span>;</span>
</span><span>    <span>crtc_id</span> <span>=</span> <span>Some</span> <span>57</span><span>;</span>
</span><span>    <span>fb_id</span> <span>=</span> <span>Some</span> <span>98</span><span>;</span>
</span><span>    <span>crtc_x</span><span>,</span><span>crtc_y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>    <span>x</span><span>,</span><span>y</span> <span>=</span> <span>0</span><span>,</span><span>0</span><span>;</span>
</span><span>    <span>possible_crtcs</span> <span>=</span> <span>0x1</span><span>}]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>More information is available as properties:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>let</span> <span>active_plane_ids</span> <span>=</span> <span>List</span><span>.</span><span>map</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>id</span> <span>active_planes</span><span>;;</span>
</span><span><span>val</span> <span>active_plane_ids</span> <span>:</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>id</span> <span>list</span> <span>=</span> <span>[</span><span>52</span><span>;</span> <span>55</span><span>]</span>
</span><span>
</span><span><span>utop</span> <span>#</span> <span>List</span><span>.</span><span>map</span> <span>(</span><span>K</span><span>.</span><span>Plane</span><span>.</span><span>get_properties</span> <span>dev</span><span>)</span> <span>active_plane_ids</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>[</span> <span>`</span><span>Plane</span> <span>]</span> <span>K</span><span>.</span><span>Properties</span><span>.</span><span>t</span> <span>list</span> <span>=</span>
</span><span><span>[{</span><span>CRTC_H</span> <span>=</span> <span>2160</span><span>;</span> <span>CRTC_ID</span> <span>=</span> <span>57</span><span>;</span> <span>CRTC_W</span> <span>=</span> <span>3840</span><span>;</span> <span>CRTC_X</span> <span>=</span> <span>0</span><span>;</span> <span>CRTC_Y</span> <span>=</span> <span>0</span><span>;</span>
</span><span>  <span>FB_ID</span> <span>=</span> <span>93</span><span>;</span> <span>IN_FENCE_FD</span> <span>=</span> <span>-</span><span>1</span><span>;</span> <span>SRC_H</span> <span>=</span> <span>141557760</span><span>;</span> <span>SRC_W</span> <span>=</span> <span>251658240</span><span>;</span>
</span><span>  <span>SRC_X</span> <span>=</span> <span>0</span><span>;</span> <span>SRC_Y</span> <span>=</span> <span>0</span><span>;</span> <span>rotation</span> <span>=</span> <span>[</span><span>rotate</span><span>-</span><span>0</span><span>];</span> <span>type</span> <span>=</span> <span>Primary</span><span>;</span> <span>zpos</span> <span>=</span> <span>0</span><span>};</span>
</span><span> <span>{</span><span>CRTC_H</span> <span>=</span> <span>128</span><span>;</span> <span>CRTC_ID</span> <span>=</span> <span>57</span><span>;</span> <span>CRTC_W</span> <span>=</span> <span>128</span><span>;</span> <span>CRTC_X</span> <span>=</span> <span>3105</span><span>;</span> <span>CRTC_Y</span> <span>=</span> <span>1518</span><span>;</span>
</span><span>  <span>FB_ID</span> <span>=</span> <span>98</span><span>;</span> <span>IN_FENCE_FD</span> <span>=</span> <span>-</span><span>1</span><span>;</span> <span>SRC_H</span> <span>=</span> <span>8388608</span><span>;</span> <span>SRC_W</span> <span>=</span> <span>8388608</span><span>;</span> <span>SRC_X</span> <span>=</span> <span>0</span><span>;</span>
</span><span>  <span>SRC_Y</span> <span>=</span> <span>0</span><span>;</span> <span>type</span> <span>=</span> <span>Cursor</span><span>;</span> <span>zpos</span> <span>=</span> <span>255</span><span>}]</span>
</span></code></pre></td></tr></tbody></table></div></figure><ul>
<li>Plane 52 is a <code>Primary</code> plane and is using framebuffer 93 (as we saw before).
</li>
<li>Plane 55 is a <code>Cursor</code> plane, using framebuffer 98 (and the <code>AR24</code> format, with alpha/transparency).
</li>
</ul>
<p>A plane chooses which part of the frame buffer to show (<code>SRC_X</code>, <code>SRC_Y</code>, <code>SRC_W</code> and <code>SRC_H</code>)
and where it should appear on the screen (<code>CRTC_X</code>, <code>CRTC_Y</code>, <code>CRTC_W</code> and <code>CRTC_H</code>).
The source values are in 16.16 format (i.e. shifted left 16 bits).</p>
<p>Oddly, <code>Plane.get</code> returned <code>crtc_x,crtc_y = 0,0</code> for both planes, but
the properties show the correct cursor location (<code>CRTC_X = 3105; CRTC_Y = 1518;</code>).</p>
<p>Having the cursor on a separate plane avoids having to modify the main screen image
whenever the mouse pointer moves, which is good for low latency
(especially if the GPU is busy rendering something else at the time),
power consumption (the GPU can stay powered down),
and allows showing an application&#39;s buffer full screen without the compositor
needing to modify the application&#39;s buffer.</p>
<p>You might also have some <code>Overlay</code> planes,
which can be <a href="https://zamundaaa.github.io/wayland/2025/10/23/more-kms-offloading.html">useful for displaying video</a>.
My graphics card seems to be too old for that.</p>
<h3 id="expanded-resources-diagram">Expanded resources diagram</h3>
<p>Here&#39;s an expanded diagram showing some more possibilities:</p>
<p><a href="https://www.scd31.com/blog/images/libdrm/arch.svg"><span><img src="https://www.scd31.com/blog/images/libdrm/arch.svg" title="Expanded resources diagram"/><span>Expanded resources diagram</span></span></a></p>
<ul>
<li>Some framebuffer formats take the input data from multiple buffers.
</li>
<li>A framebuffer can be shared by multiple CRTCs (perhaps with each plane showing a different part of it).
</li>
<li>A CRTC can have multiple planes (e.g. primary and cursor).
</li>
<li>A single CRTC can show the same image on multiple monitors.
</li>
</ul>
<h2 id="making-changes">Making changes</h2>
<p>If I try turning off the CRTC (by setting the mode to <code>None</code>) from my desktop environment it fails:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>K</span><span>.</span><span>Crtc</span><span>.</span><span>set</span> <span>dev</span> <span>crtc_id</span> <span>~</span><span>pos</span><span>:(</span><span>0</span><span>,</span><span>0</span><span>)</span> <span>~</span><span>connectors</span><span>:</span><span>[]</span> <span>None</span><span>;;</span>
</span><span><span>Exception</span><span>:</span> <span>Unix</span><span>.</span><span>Unix_error</span><span>(</span><span>Unix</span><span>.</span><span>EACCES</span><span>,</span> <span>&#34;drmModeSetCrtc&#34;</span><span>,</span> <span>&#34;&#34;</span><span>)</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>The reason is that I&#39;m currently running a graphical desktop and Sway owns the device
(so my <code>dev</code> is not the DRM &#34;master&#34;):</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
</pre></td><td><pre><code><span><span>utop</span> <span>#</span> <span>Drm</span><span>.</span><span>Device</span><span>.</span><span>is_master</span> <span>dev</span><span>;;</span>
</span><span><span>-</span> <span>:</span> <span>bool</span> <span>=</span> <span>false</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>That can be fixed by switching to a different <a href="https://en.wikipedia.org/wiki/Virtual_console">VT</a> (e.g. with Ctrl-Alt-F2) and running it there.
However, this will result in a second problem: I won&#39;t be able to see what I&#39;m doing!</p>
<p>If you have a second computer then you can SSH in and test things out from there, but
for simplicity we&#39;ll leave the utop REPL at this point and write some programs instead.</p>
<p>For example, <a href="https://github.com/talex5/libdrm-ocaml/blob/main/examples/query.ml">query.ml</a> shows the information we discovered above:</p>
<pre><code>dune exec -- ./examples/query.exe
</code></pre>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
</pre></td><td><pre><code><span><span>devices</span><span>:</span>                              
</span><span>  <span>[{</span><span>primary_node</span> <span>=</span> <span>Some</span> <span>&#34;/dev/dri/card0&#34;</span><span>;</span>
</span><span>    <span>render_node</span> <span>=</span> <span>Some</span> <span>&#34;/dev/dri/renderD128&#34;</span><span>;</span>
</span><span><span>...</span>
</span></code></pre></td></tr></tbody></table></div></figure><h3 id="non-atomic-mode-setting">Non-atomic mode setting</h3>
<p>Linux provides two ways to configure modes: the old <em>non-atomic</em> API and the newer <em>atomic</em> one.</p>
<p><a href="https://github.com/talex5/libdrm-ocaml/blob/main/examples/nonatomic.ml">examples/nonatomic.ml</a> contains a simple example of the older (but simpler) API.
It starts by finding a device (the first one with a primary node supporting KMS), then
finds all connected connectors (as we did above), and calls <code>show_test_page</code> on each one:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
</pre></td><td><pre><code><span><span>let</span> <span>()</span> <span>=</span>
</span><span>  <span>Utils</span><span>.</span><span>with_device</span> <span>@@</span> <span>fun</span> <span>t</span> <span>-&gt;</span>
</span><span>  <span>let</span> <span>connected</span> <span>=</span> <span>List</span><span>.</span><span>filter</span> <span>Utils</span><span>.</span><span>is_connected</span> <span>t</span><span>.</span><span>connectors</span> <span>in</span>
</span><span>  <span>Utils</span><span>.</span><span>restoring_afterwards</span> <span>t</span> <span>@@</span> <span>fun</span> <span>()</span> <span>-&gt;</span>
</span><span>  <span>List</span><span>.</span><span>iter</span> <span>(</span><span>show_test_page</span> <span>t</span><span>)</span> <span>connected</span><span>;</span>
</span><span>  <span>Unix</span><span>.</span><span>sleep</span> <span>2</span>
</span></code></pre></td></tr></tbody></table></div></figure><p><code>restoring_afterwards</code> stores the current configuration, runs the callback,
and then puts things back to normal when that finishes (or you press Ctrl-C).</p>
<p>The program waits for 2 seconds after showing the test page before exiting.</p>
<p><code>show_test_page</code> finds the CRTC (as we did above),
takes the first supported mode, creates a test framebuffer of that size,
and configures the CRTC to display it:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
</pre></td><td><pre><code><span><span>let</span> <span>show_test_page</span> <span>(</span><span>t</span> <span>:</span> <span>Resources</span><span>.</span><span>t</span><span>)</span> <span>(</span><span>c</span> <span>:</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>t</span><span>)</span> <span>=</span>
</span><span>  <span>match</span> <span>c</span><span>.</span><span>encoder_id</span> <span>with</span>
</span><span>  <span>|</span> <span>None</span> <span>-&gt;</span> <span>println</span> <span>&#34;%a has no encoder (skipping)&#34;</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>pp_name</span> <span>c</span>
</span><span>  <span>|</span> <span>Some</span> <span>encoder_id</span> <span>-&gt;</span>
</span><span>    <span>match</span> <span>K</span><span>.</span><span>Encoder</span><span>.</span><span>get</span> <span>t</span><span>.</span><span>dev</span> <span>encoder_id</span> <span>with</span>
</span><span>    <span>|</span> <span>{</span> <span>crtc_id</span> <span>=</span> <span>None</span><span>;</span> <span>_</span> <span>}</span> <span>-&gt;</span>
</span><span>      <span>println</span> <span>&#34;%a&#39;s encoder has no CRTC (skipping)&#34;</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>pp_name</span> <span>c</span>
</span><span>    <span>|</span> <span>{</span> <span>crtc_id</span> <span>=</span> <span>Some</span> <span>crtc_id</span><span>;</span> <span>_</span> <span>}</span> <span>-&gt;</span>
</span><span>      <span>println</span> <span>&#34;Showing test page on %a&#34;</span> <span>K</span><span>.</span><span>Connector</span><span>.</span><span>pp_name</span> <span>c</span><span>;</span>
</span><span>      <span>let</span> <span>mode</span> <span>=</span> <span>List</span><span>.</span><span>hd</span> <span>c</span><span>.</span><span>modes</span> <span>in</span>
</span><span>      <span>let</span> <span>size</span> <span>=</span> <span>(</span><span>mode</span><span>.</span><span>hdisplay</span><span>,</span> <span>mode</span><span>.</span><span>vdisplay</span><span>)</span> <span>in</span>
</span><span>      <span>let</span> <span>fb</span> <span>=</span> <span>Test_image</span><span>.</span><span>create</span> <span>t</span><span>.</span><span>dev</span> <span>size</span> <span>in</span>
</span><span>      <span>K</span><span>.</span><span>Crtc</span><span>.</span><span>set</span> <span>t</span><span>.</span><span>dev</span> <span>crtc_id</span> <span>(</span><span>Some</span> <span>mode</span><span>)</span> <span>~</span><span>fb</span> <span>~</span><span>pos</span><span>:(</span><span>0</span><span>,</span><span>0</span><span>)</span>
</span><span>        <span>~</span><span>connectors</span><span>:[</span><span>c</span><span>.</span><span>connector_id</span><span>]</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>If the connector doesn&#39;t have a CRTC, we could find a suitable one and use that,
but for simplicity the example just skips such connectors.</p>
<p>To run the example (switch away from any graphical desktop first or it won&#39;t work):</p>
<pre><code>dune exec -- ./examples/nonatomic.exe
</code></pre>
<h3 id="dumb-buffers">Dumb buffers</h3>
<p>Typically the pixel data to be displayed comes from some complex rendering pipeline,
but Linux also provides <em>dumb buffers</em> for simple cases such as testing.
The <code>Test_image.create</code> function used above creates a dumb buffer with a test pattern:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
</pre></td><td><pre><code><span><span>let</span> <span>create_dumb</span> <span>dev</span> <span>size</span> <span>=</span>
</span><span>  <span>let</span> <span>dumb_buffer</span> <span>=</span> <span>Drm</span><span>.</span><span>Buffer</span><span>.</span><span>Dumb</span><span>.</span><span>create</span> <span>dev</span> <span>~</span><span>bpp</span><span>:</span><span>32</span> <span>size</span> <span>in</span>
</span><span>  <span>let</span> <span>arr</span> <span>=</span> <span>Drm</span><span>.</span><span>Buffer</span><span>.</span><span>Dumb</span><span>.</span><span>map</span> <span>dev</span> <span>dumb_buffer</span> <span>Int32</span> <span>in</span>
</span><span>  <span>for</span> <span>row</span> <span>=</span> <span>0</span> <span>to</span> <span>snd</span> <span>size</span> <span>-</span> <span>1</span> <span>do</span>
</span><span>    <span>for</span> <span>col</span> <span>=</span> <span>0</span> <span>to</span> <span>fst</span> <span>size</span> <span>-</span> <span>1</span> <span>do</span>
</span><span>      <span>let</span> <span>c</span> <span>=</span>
</span><span>        <span>(</span><span>row</span> <span>land</span> <span>0xff</span><span>)</span> <span>lor</span>
</span><span>        <span>((</span><span>col</span> <span>land</span> <span>0xff</span><span>)</span> <span>lsl</span> <span>8</span><span>)</span> <span>lor</span>
</span><span>        <span>(((</span><span>row</span> <span>lsr</span> <span>8</span><span>)</span> <span>lor</span> <span>(</span><span>col</span> <span>lsr</span> <span>8</span><span>))</span> <span>lsl</span> <span>18</span><span>)</span>
</span><span>      <span>in</span>
</span><span>      <span>arr</span><span>.{</span><span>row</span><span>,</span> <span>col</span><span>}</span> <span>&lt;-</span> <span>Int32</span><span>.</span><span>of_int</span> <span>c</span>
</span><span>    <span>done</span><span>;</span>
</span><span>  <span>done</span><span>;</span>
</span><span>  <span>dumb_buffer</span>
</span></code></pre></td></tr></tbody></table></div></figure><p><code>Dumb.create</code> allocates memory for the image data.
<code>Dumb.map</code> makes it appear in host-memory as an OCaml bigarray.
The loop sets each 32-bit int in the image to some colour <code>c</code>.</p>
<p>Then we wrap this data up as an XR24-format framebuffer with a single plane:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
</pre></td><td><pre><code><span><span>let</span> <span>create</span> <span>dev</span> <span>size</span> <span>=</span>
</span><span>  <span>let</span> <span>buffer</span> <span>=</span> <span>create_dumb</span> <span>dev</span> <span>size</span> <span>in</span>
</span><span>  <span>let</span> <span>planes</span> <span>=</span> <span>[</span><span>K</span><span>.</span><span>Fb</span><span>.</span><span>Plane</span><span>.</span><span>v</span> <span>buffer</span><span>.</span><span>handle</span> <span>~</span><span>pitch</span><span>:</span><span>buffer</span><span>.</span><span>pitch</span><span>]</span> <span>in</span>
</span><span>  <span>K</span><span>.</span><span>Fb</span><span>.</span><span>add</span> <span>dev</span> <span>~</span><span>size</span> <span>~</span><span>planes</span> <span>~</span><span>pixel_format</span><span>:</span><span>Drm</span><span>.</span><span>Fourcc</span><span>.</span><span>xr24</span>
</span></code></pre></td></tr></tbody></table></div></figure><h3 id="atomic-mode-setting">Atomic mode setting</h3>
<p><a href="https://github.com/talex5/libdrm-ocaml/blob/main/examples/atomic.ml">examples/atomic.ml</a> demonstrates the newer atomic API:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
</pre></td><td><pre><code><span><span>let</span> <span>()</span> <span>=</span>
</span><span>  <span>Utils</span><span>.</span><span>with_device</span> <span>@@</span> <span>fun</span> <span>t</span> <span>-&gt;</span>
</span><span>  <span>Drm</span><span>.</span><span>Client_cap</span><span>.</span><span>(</span><span>set_exn</span> <span>atomic</span><span>)</span> <span>t</span><span>.</span><span>dev</span> <span>true</span><span>;</span>
</span><span>  <span>let</span> <span>connected</span> <span>=</span> <span>List</span><span>.</span><span>filter</span> <span>Utils</span><span>.</span><span>is_connected</span> <span>t</span><span>.</span><span>connectors</span> <span>in</span>
</span><span>  <span>println</span> <span>&#34;Found %d connected connectors&#34;</span> <span>(</span><span>List</span><span>.</span><span>length</span> <span>connected</span><span>);</span>
</span><span>  <span>let</span> <span>free_planes</span> <span>=</span> <span>ref</span> <span>(</span><span>K</span><span>.</span><span>Plane</span><span>.</span><span>list</span> <span>t</span><span>.</span><span>dev</span><span>)</span> <span>in</span>
</span><span>  <span>let</span> <span>rq</span> <span>=</span> <span>K</span><span>.</span><span>Atomic_req</span><span>.</span><span>create</span> <span>()</span> <span>in</span>
</span><span>  <span>List</span><span>.</span><span>iter</span> <span>(</span><span>show_test_page</span> <span>~</span><span>free_planes</span> <span>t</span> <span>rq</span><span>)</span> <span>connected</span><span>;</span>
</span><span>  <span>println</span> <span>&#34;Checking that commit will work...&#34;</span><span>;</span>
</span><span>  <span>match</span> <span>K</span><span>.</span><span>Atomic_req</span><span>.</span><span>commit</span> <span>~</span><span>test_only</span><span>:</span><span>true</span> <span>t</span><span>.</span><span>dev</span> <span>rq</span> <span>with</span>
</span><span>  <span>|</span> <span>exception</span> <span>Unix</span><span>.</span><span>Unix_error</span> <span>(</span><span>code</span><span>,</span> <span>_,</span> <span>_)</span> <span>-&gt;</span>
</span><span>    <span>println</span> <span>&#34;Mode-setting would fail with error: %s&#34;</span> <span>(</span><span>Unix</span><span>.</span><span>error_message</span> <span>code</span><span>)</span>
</span><span>  <span>|</span> <span>()</span> <span>-&gt;</span>
</span><span>    <span>println</span> <span>&#34;Pre-commit test passed.&#34;</span><span>;</span>
</span><span>    <span>Utils</span><span>.</span><span>restoring_afterwards</span> <span>t</span> <span>@@</span> <span>fun</span> <span>()</span> <span>-&gt;</span>
</span><span>    <span>K</span><span>.</span><span>Atomic_req</span><span>.</span><span>commit</span> <span>t</span><span>.</span><span>dev</span> <span>rq</span><span>;</span>
</span><span>    <span>Unix</span><span>.</span><span>sleep</span> <span>2</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>The steps are:</p>
<ol>
<li>Use <code>set_exn atomic</code> to enable atomic mode.
</li>
<li>Create an <em>atomic request</em> (<code>rq</code>).
</li>
<li>Use <code>show_test_page</code> to populate it with the desired property changes.
</li>
<li>(optional) Check that it will work (<code>~test_only:true</code>).
</li>
<li>Commit the changes (<code>Atomic_req.commit</code>).
</li>
</ol>
<p>The advantage here is that either all changes are successfully applied at once or nothing changes.
This avoids various problems with flickering or trying to roll back partial changes.</p>
<p><code>show_test_page</code> needs a couple of modifications.
First, we have to find a plane (rather than using the old <code>Crtc.set</code> which assumes a single plane),
and then we set the plane&#39;s <code>FB_ID</code> property to the new framebuffer in the request:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
</pre></td><td><pre><code><span><span>K</span><span>.</span><span>Atomic_req</span><span>.</span><span>add_property</span> <span>rq</span> <span>plane</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>fb_id</span> <span>(</span><span>Some</span> <span>fb</span><span>)</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>For the example, I actually set more properties and defined an operator to make the code a bit neater:</p>
<figure><div><table><tbody><tr><td><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
</pre></td><td><pre><code><span><span>let</span> <span>(</span> <span>.%{}&lt;-</span> <span>)</span> <span>obj</span> <span>prop</span> <span>value</span> <span>=</span>
</span><span>  <span>K</span><span>.</span><span>Atomic_req</span><span>.</span><span>add_property</span> <span>rq</span> <span>obj</span> <span>prop</span> <span>value</span>
</span><span><span>in</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>fb_id</span> <span>}</span> <span>&lt;-</span> <span>Some</span> <span>fb</span><span>;</span>
</span><span><span>(* Source region on frame-buffer: *)</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>src_x</span> <span>}</span> <span>&lt;-</span> <span>Drm</span><span>.</span><span>Ufixed</span><span>.</span><span>of_int</span> <span>0</span><span>;</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>src_y</span> <span>}</span> <span>&lt;-</span> <span>Drm</span><span>.</span><span>Ufixed</span><span>.</span><span>of_int</span> <span>0</span><span>;</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>src_w</span> <span>}</span> <span>&lt;-</span> <span>Drm</span><span>.</span><span>Ufixed</span><span>.</span><span>of_int</span> <span>(</span><span>fst</span> <span>size</span><span>);</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>src_h</span> <span>}</span> <span>&lt;-</span> <span>Drm</span><span>.</span><span>Ufixed</span><span>.</span><span>of_int</span> <span>(</span><span>snd</span> <span>size</span><span>);</span>
</span><span><span>(* Destination region on CRTC: *)</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>crtc_x</span> <span>}</span> <span>&lt;-</span> <span>0</span><span>;</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>crtc_y</span> <span>}</span> <span>&lt;-</span> <span>0</span><span>;</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>crtc_w</span> <span>}</span> <span>&lt;-</span> <span>fst</span> <span>size</span><span>;</span>
</span><span><span>plane</span><span>.%{</span> <span>K</span><span>.</span><span>Plane</span><span>.</span><span>crtc_h</span> <span>}</span> <span>&lt;-</span> <span>snd</span> <span>size</span><span>;</span>
</span></code></pre></td></tr></tbody></table></div></figure><p>In libdrm-ocaml, properties are typed, so you can&#39;t forget to convert the source values to fixed point format.</p>
<h2 id="d-rendering">3D rendering</h2>
<p>The examples above use a dumb-buffer, but it&#39;s fairly simple to replace that with a Vulkan buffer.
The code in the last post <a href="https://github.com/talex5/vulkan-test/blob/5a93c76eb4e0205c63e0d0c5f7b4785cd15c208a/vulkan/swap_chain.ml#L42">exported the image memory from Vulkan</a> as a dmabuf FD and sent it to the Wayland compositor.
Now, instead of sending it we just need to import it into our device (with <code>Drm.Dmabuf.to_handle</code>)
and use that handle instead of the dumb-buffer one.</p>
<p>I added a simple <a href="https://github.com/talex5/vulkan-test/commit/731e90d1d61d78b4ac557f9861839dbcc233e06b">surface abstraction</a> to the test code, wrapping the <code>Window</code> module&#39;s API
so that the rendering code doesn&#39;t need to care whether it&#39;s rendering to a Wayland window or directly to the screen.
Then I made a <a href="https://github.com/talex5/vulkan-test/blob/3f767e64f38b75e216a530b6b9747020d958f11b/src/vt.ml">Vt module</a> implementing the new <code>Surface.t</code> type for rendering directly to a Linux VT.</p>
<p>To get the animation working, I used <code>K.Crtc.page_flip</code> to update the framebuffer (I could also have used the atomic API).
The kernel waits until the encoder has finishing sending the current frame before switching to the new one,
which avoids tearing.
We also need to ask the kernel to tell us when this happens, which is done by setting the optional <code>~event</code> argument to some number.
You can read events from the device file and parse them with <a href="https://talex5.github.io/libdrm-ocaml/libdrm/Drm/Event/index.html#val-parse">Drm.Event.parse</a>.</p>
<p>If you want to try it, this should produce an animated room:</p>
<pre><code>git clone https://github.com/talex5/vulkan-test -b kms-3d
cd vulkan-test
nix develop
make download-example
dune exec -- ./src/main.exe 10000 viking_room.obj viking_room.png
</code></pre>
<p>If run with <code>$WAYLAND_DISPLAY</code> set, it will open a Wayland window (as before),
but if run from a text console then it should render the animation directly using KMS.</p>
<h2 id="linux-vts">Linux VTs</h2>
<p>When the user switches to another virtual terminal (e.g. with Ctrl-Alt-F3),
we should call <code>Drm.Device.drop_master</code> to give up being the master,
allowing the application running on the new terminal to take over.</p>
<p>We should also switch the VT to <code>KD_GRAPHICS</code> mode while using it,
to stop the kernel trying to manage it.</p>
<p>I didn&#39;t implement either of these features, but see <a href="https://dvdhrm.wordpress.com/2013/08/24/how-vt-switching-works/">How VT-switching works</a> for details.</p>
<h2 id="debugging">Debugging</h2>
<p>If you get an unhelpful error code from the kernel (e.g. <code>EINVAL</code>), enabling debug messages is often helpful.
Writing <code>4</code> to <code>/sys/module/drm/parameters/debug</code> enables KMS debug messages, which can be seen in the <code>dmesg</code> output.
Write <code>0</code> to the file afterwards to turn the messages off again.
<code>modinfo -p drm</code> lists the various options.</p>
<h2 id="conclusions">Conclusions</h2>
<p>I hope you found being able to explore the libdrm API interactively from the OCaml top-level
made it easier to learn about how Linux manages displays.
As when doing <a href="https://roscidus.com/blog/blog/2025/09/20/ocaml-vulkan/">Vulkan in OCaml</a>,
a lot of the noise from C is removed and I think that the essentials of what is going on are easier to see.</p>
<p>I used <a href="https://github.com/yallop/ocaml-ctypes">ocaml-ctypes</a> for the C bindings, and this was my first time using it in &#34;stubs&#34; mode
(where it pre-generates C bindings from OCaml definitions).
This has the advantage that the C type checker checks that the definitions are correct,
and it worked well.
Dune&#39;s <a href="https://dune.readthedocs.io/en/latest/foreign-code.html#stub-generation-with-dune-ctypes">Stub Generation</a> feature generates the build rules for this semi-automatically.</p>
<p>Deciding what OCaml types to use for the C types was quite difficult.
For example, C has many different integer types (<code>int</code>, <code>long</code>, <code>uint32_t</code>, etc),
but using lots of types is more painful in OCaml where e.g. <code>+</code> only works on <code>int</code>.
I used OCaml&#39;s int type when possible, and other types only when the value might not fit
(e.g. an image size on a 32-bit platform might not fit into an OCaml int, which is one bit shorter).</p>
<p>The C API is somewhat inconsistent about types.
e.g. <code>drmModePageFlipTarget</code> takes a <code>uint32_t target_vblank</code> argument for the sequence number,
while <code>page_flip_handler</code> confirms the event by giving it as <code>unsigned int sequence</code>.
Meanwhile, the <code>sequence_handler</code> event gives it as <code>uint64_t sequence</code>.
I&#39;m not sure what happens if the sequence number gets too large to fit in a 32-bit integer.</p>
<p>Anyway, I think I understand mode setting a lot better now,
and I&#39;m getting faster at debugging graphics problems on Linux
(e.g. when <a href="https://github.com/NixOS/nixpkgs/issues/458132">element-desktop failed to start</a> recently after I updated it).</p>
<p>Thanks to the OCaml Software Foundation for sponsoring this work.</p>

            </div></div>
  </body>
</html>
