<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://msreekan.com/2014/01/15/sdcard/">Original</a>
    <h1>SDcard wear leveling and translation layers (2014)</h1>
    
    <div id="readability-page-1" class="page"><article id="post-522">
	<!-- .entry-header -->

	
		<div>
			<p>SD CARD protocol itself provides a rough blueprint of the internal design, but sometimes you can implement particular use cases hinging on the hints provided by the spec to expose certain limitations and strengths of the card machinery.  It’s well-known that an SD CARD runs on flash, usually a NAND MLC or an SLC but superficially it behaves nothing like a flash and the user need not fret about block erases, bit flips or wear leveling. All the complexities of a flash seemingly abstracted inside a black box, but we could still attempt to unearth certain aspects of this chaos.</p>
<p><strong>Boot Code</strong></p>
<p>Once we supply the voltage, card internally figures out whether it’s being used with SPI or SD bus by sampling the card detect pin (pin 1), which is pulled high only for SD mode. Protocol implemented for these interfaces differ significantly, so their software stacks also differ and of course there also exist a small micro-controller driving this SD firmware.</p>
<p>The boot code checks pin 1, identifies the interface and jumps to the corresponding software interface stack, now lets consider that the card is connected over SD bus. The boot code ensures that the voltage supplied by the host is appropriate by using CMD8 &amp; ACMD41, this boot process is driven by the host and we can imagine that the card start-up is completed only when the software enters what the spec defines as the <strong><em>transfer state</em></strong>.</p>
<p>The hardware pins are shared across both the modes, so there has to be an internal <strong>multiplexer</strong> which will configure the controller to drive the pins either with <strong>SD</strong> or with the <strong>SPI</strong> physical layer protocol. We can imagine that the chip set used will include the corresponding hardware IPs or at least some form of software implementation of the SD, SPI &amp; multiplexer logic.</p>
<p><strong>Transfer Mode</strong></p>
<p>Boot up is completed once we enter the transfer mode, here the SD state machine is primarily meant to service I/O requests like sector reads, writes and erases. A DMA engine is most probably utilized for ensuring that the internal flash transfers happen in parallel with the SD I/Os, in other words the card might be transferring NAND pages to the flash while its receiving more data from the host via the SD interface. The read and write operations are pipe-lined and buffered to ensure the maximum throughput, especially for higher grade class 10 cards.</p>
<p><a href="https://msreekan.com/wp-content/uploads/2014/01/sdcard.png"><img width="650" height="487" id="i-563" src="https://msreekan.com/wp-content/uploads/2014/01/sdcard.png?w=650" alt="Image" srcset="https://msreekan.com/wp-content/uploads/2014/01/sdcard.png?w=650 650w, https://msreekan.com/wp-content/uploads/2014/01/sdcard.png?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/sdcard.png?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/sdcard.png?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/sdcard.png 960w" sizes="(max-width: 650px) 100vw, 650px"/></a></p>
<p><strong>Translation Layer</strong></p>
<p>Flash contents cannot be over-written without intermediate erases. So, for any SDCARD I/O operation there exist a ‘translation’ from virtual to physical address. For example, lets consider that we wrote to the sector 1024 on the SDCARD, and this address got initially mapped to physical sector 1024 itself on flash. Later we overwrite the contents, but this time write cannot go to the same physical address because it needs to be erased before programmed again. Now the translation layer will have to remap the virtual address 1024 to another erased and clean physical address, say 2048. So, now the virtual sector 1024 translates to a different physical address. Similarly, every write to virtual address gets mapped to a physical address and every subsequent read of the location is translated to the very same address. These mappings are stored separately by the firmware and this way a translation layer will abstract the flash complexities from the card user who remains oblivious to the actual physical address locations. Obviously, the erase of dirty pages need to happen before they can be reused.</p>
<p>Every translation layer also requires a size for its maps, spec confirms that a card complying with speed class specification (class 2, 4, 6 &amp; 10) will implement internal map size equal to its ‘Allocation Unit” (AU)  size, this can be read from one of the card registers. This means that the virtual to physical maps will be of AU size, which is typically 4MB.</p>
<figure><a href="https://msreekan.com/wp-content/uploads/2014/01/maps.png" target="_blank" rel="noopener"><img id="i-646" title="Translation Layer Mapping" src="https://msreekan.com/wp-content/uploads/2014/01/maps.png?w=650&amp;h=488" alt="Translation Layer Mapping" width="650" height="488" srcset="https://msreekan.com/wp-content/uploads/2014/01/maps.png?w=650 650w, https://msreekan.com/wp-content/uploads/2014/01/maps.png?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/maps.png?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/maps.png?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/maps.png 960w" sizes="(max-width: 650px) 100vw, 650px"/></a><figcaption>Translation Layer Mapping</figcaption></figure>

<p>Reads are straightforward, all SDCARD needs to do is access its mapping information and read the corresponding physical AU. Writes can be tricky depending on the use case, lets consider two types.</p>
<p><strong><em>a. Contiguous writes</em></strong></p>
<p>Consider virtual AU 10 was mapped to physical AU 30 (PAU 30) before write, and when the IO starts the map algorithm selects (Physical) AU40 as the new physical map for virtual AU10 (VAU 10).</p>
<figure data-shortcode="caption" id="attachment_988" aria-describedby="caption-attachment-988"><a href="https://msreekan.com/wp-content/uploads/2014/01/c11.jpg" target="_blank" rel="noopener"><img data-attachment-id="988" data-permalink="https://msreekan.com/2014/01/15/sdcard/c1-2/" data-orig-file="https://msreekan.com/wp-content/uploads/2014/01/c11.jpg" data-orig-size="1209,808" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="C1" data-image-description="" data-image-caption="&lt;p&gt;Sequential Write — Initial State&lt;/p&gt;
" data-medium-file="https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=300" data-large-file="https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=636" tabindex="0" role="button" src="https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=636&amp;h=425" alt="Sequential Write -- Initial State" width="636" height="425" srcset="https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=636 636w, https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/c11.jpg?w=1024 1024w, https://msreekan.com/wp-content/uploads/2014/01/c11.jpg 1209w" sizes="(max-width: 636px) 100vw, 636px"/></a><figcaption id="caption-attachment-988">Sequential Write — Initial State</figcaption></figure>
<p>Write starts at PAU40. After 4MB write ends, the VAU 10 presently mapped to PAU 30 gets remapped to PAU 40.</p>
<figure data-shortcode="caption" id="attachment_989" aria-describedby="caption-attachment-989"><a href="https://msreekan.com/wp-content/uploads/2014/01/c2.jpg" target="_blank" rel="noopener"><img data-attachment-id="989" data-permalink="https://msreekan.com/2014/01/15/sdcard/c2/" data-orig-file="https://msreekan.com/wp-content/uploads/2014/01/c2.jpg" data-orig-size="1209,808" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="C2" data-image-description="" data-image-caption="&lt;p&gt;Sequential Write Done&lt;/p&gt;
" data-medium-file="https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=300" data-large-file="https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=636" tabindex="0" role="button" loading="lazy" src="https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=636&amp;h=425" alt="Sequential Write Done" width="636" height="425" srcset="https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=636 636w, https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/c2.jpg?w=1024 1024w, https://msreekan.com/wp-content/uploads/2014/01/c2.jpg 1209w" sizes="(max-width: 636px) 100vw, 636px"/></a><figcaption id="caption-attachment-989">Sequential Write Done</figcaption></figure>
<p>PAU 30 is marked as dirty and added to the erase queue.</p>
<p>Quite easily the most simple and the fastest use case.</p>
<p><em><strong>b. Random writes across AUs</strong><br/>
</em>Here we write at block addressed which are located at different AUs, quite similar to the use case where the FAT table and directory entry contents need to be updated in between a file write. Consider the following illustration:</p>
<p><em>Step one:</em> 1MB write of file contents to VAU 10.</p>
<p>The first step will write 1 MB at VAU10 and then the file system moves on to write the FAT table located on VAU1, consider that before being written the VAU10 was previously fully used and contained 3MB of valid and 1MB of dirty data (3 + 1 = 4MB).</p>
<p>The steps executed inside the FTL with regards to the above file system operations are illustrated below.</p>
<p>File clusters inside VAU10 was initially mapped to PAU20, when the write started a fully erased PAU 35 was selected as the new map (writes cannot happen on dirty flash blocks!).</p>
<figure data-shortcode="caption" id="attachment_990" aria-describedby="caption-attachment-990"><a href="https://msreekan.com/wp-content/uploads/2014/01/r1.jpg" target="_blank" rel="noopener"><img data-attachment-id="990" data-permalink="https://msreekan.com/2014/01/15/sdcard/r1/" data-orig-file="https://msreekan.com/wp-content/uploads/2014/01/r1.jpg" data-orig-size="1209,808" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="R1" data-image-description="" data-image-caption="&lt;p&gt;Random Write — Initial State&lt;/p&gt;
" data-medium-file="https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=300" data-large-file="https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=636" tabindex="0" role="button" loading="lazy" src="https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=636&amp;h=425" alt="Random Write -- Initial State" width="636" height="425" srcset="https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=636 636w, https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/r1.jpg?w=1024 1024w, https://msreekan.com/wp-content/uploads/2014/01/r1.jpg 1209w" sizes="(max-width: 636px) 100vw, 636px"/></a><figcaption id="caption-attachment-990">Random Write — Initial State</figcaption></figure>
<p>1MB of file contents were written to PAU35. Now 3MB of VAU 10 contents reside in PAU 20 and rest of the newly written 1MB is in PAU35.</p>
<figure data-shortcode="caption" id="attachment_991" aria-describedby="caption-attachment-991"><a href="https://msreekan.com/wp-content/uploads/2014/01/r2.jpg" target="_blank" rel="noopener"><img data-attachment-id="991" data-permalink="https://msreekan.com/2014/01/15/sdcard/r2/" data-orig-file="https://msreekan.com/wp-content/uploads/2014/01/r2.jpg" data-orig-size="1209,808" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="R2" data-image-description="" data-image-caption="&lt;p&gt;Random Write — Intermediate State&lt;/p&gt;
" data-medium-file="https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=300" data-large-file="https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=636" tabindex="0" role="button" loading="lazy" src="https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=636&amp;h=425" alt="Random Write -- Intermediate State" width="636" height="425" srcset="https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=636 636w, https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/r2.jpg?w=1024 1024w, https://msreekan.com/wp-content/uploads/2014/01/r2.jpg 1209w" sizes="(max-width: 636px) 100vw, 636px"/></a><figcaption id="caption-attachment-991">Random Write — Intermediate State</figcaption></figure>
<p>One VAU cannot be mapped to two physical AUs, so we have two options:</p>
<figure data-shortcode="caption" id="attachment_992" aria-describedby="caption-attachment-992"><a href="https://msreekan.com/wp-content/uploads/2014/01/r3.jpg" target="_blank" rel="noopener"><img data-attachment-id="992" data-permalink="https://msreekan.com/2014/01/15/sdcard/r3/" data-orig-file="https://msreekan.com/wp-content/uploads/2014/01/r3.jpg" data-orig-size="1209,808" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="R3" data-image-description="" data-image-caption="&lt;p&gt;Random Write Final State&lt;/p&gt;
" data-medium-file="https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=300" data-large-file="https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=636" tabindex="0" role="button" loading="lazy" src="https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=636&amp;h=425" alt="Random Write Final State" width="636" height="425" srcset="https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=636 636w, https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/r3.jpg?w=1024 1024w, https://msreekan.com/wp-content/uploads/2014/01/r3.jpg 1209w" sizes="(max-width: 636px) 100vw, 636px"/></a><figcaption id="caption-attachment-992">Random Write Final State</figcaption></figure>
<p>or</p>
<figure data-shortcode="caption" id="attachment_993" aria-describedby="caption-attachment-993"><a href="https://msreekan.com/wp-content/uploads/2014/01/r4.jpg" target="_blank" rel="noopener"><img data-attachment-id="993" data-permalink="https://msreekan.com/2014/01/15/sdcard/r4/" data-orig-file="https://msreekan.com/wp-content/uploads/2014/01/r4.jpg" data-orig-size="1209,808" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="R4" data-image-description="" data-image-caption="&lt;p&gt;Random Write — Final State&lt;/p&gt;
" data-medium-file="https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=300" data-large-file="https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=636" tabindex="0" role="button" loading="lazy" src="https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=636&amp;h=425" alt="Random Write -- Final State" width="636" height="425" srcset="https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=636 636w, https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/r4.jpg?w=1024 1024w, https://msreekan.com/wp-content/uploads/2014/01/r4.jpg 1209w" sizes="(max-width: 636px) 100vw, 636px"/></a><figcaption id="caption-attachment-993">Random Write — Final State</figcaption></figure>
<p>SDCARDs might be using either one of the above two options, in the first case map information will be updated (VAU10-&gt;PAU20 modified to VAU10-&gt;PAU35) while the second case maintains the same map (VAU10 -&gt; PAU20). Both the cases incur an overhead and this weighs heavily on the SDCARD write performance.</p>
<p><span>The above details alludes to the fact that an SDCARD tends to select an AU to which we write as the “active one”, so any writes to this ‘Active AU’ will have minimal overhead but as soon as we switch the write location outside of this ‘Active AU’ the map maintenance kicks in — essentially the garbage collection. Some of the class 10 cards can accommodate two active AUs and hence the overhead happens only during the above <em>Step Three </em>of the FAT file system write illustration given above, while the switch to the <em>Step Two</em> happens without a glitch.</span></p>
<figure><a href="https://msreekan.com/wp-content/uploads/2014/01/choicee.png" target="_blank" rel="noopener"><img loading="lazy" id="i-726" title="Y-Axis: Time in uSecs, X-Axis : Write Count" src="https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=650&amp;h=280" alt="Y-Axis: Time in uSecs, X-Axis : Write Count" width="650" height="280" srcset="https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=650 650w, https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=1300 1300w, https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=150 150w, https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=300 300w, https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=768 768w, https://msreekan.com/wp-content/uploads/2014/01/choicee.png?w=1024 1024w" sizes="(max-width: 650px) 100vw, 650px"/></a><figcaption>Y-Axis: Time in uSecs, X-Axis : Write Count</figcaption></figure>
<p>Above graph illustrates the write times for the following three use cases:</p>
<p>1. <strong><em>Interleaved</em></strong> writes switch across VAUs continuously, first 4K bytes are written to an address on VAU1, second 4K to an address on VAU2 and so on.</p>
<p><strong>Block Associative Sector Translation</strong></p>
<p>Locality of reference is integral for achieving optimal write throughput. Quite visible from the graph that writes are faster when its contiguous, while its far from optimal when they are done across AU boundaries. Most probably SD CARDs should be employing a variant of <a title="SDCARD FTLs" href="http://www.sersc.org/journals/IJCA/vol7_no6/17.pdf" target="_blank" rel="noopener">block associative sector translation</a>.</p>
<p>More on this topic – <a title="SDCARD Speed Class" href="http://tekrants.me/2014/02/15/sdcard-speed-classes/" target="_blank" rel="noopener">SDCARD Speed Class</a></p>

			
								</div><!-- .entry-content -->

	
	<!-- .entry-footer -->
</article></div>
  </body>
</html>
