<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.alexmolas.com/2024/07/15/fantasy-knapsack.html">Original</a>
    <h1>Win your fantasy league using operations research</h1>
    
    <div id="readability-page-1" class="page"><div>
    


<i><p>July 15, 2024 · <span title="Estimated read time">
  
  
    22 mins · 3963 words
  
</span>
 </p></i> 

<p>I’ve never been good at playing football <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>. I started playing again last year and I have scored more own goals than goals for my team. Also, I support the RCD Espanyol <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" rel="footnote">2</a></sup>, which has spent last season in the second division and has miraculously ascended to the first division last week. And to be honest, I only watch games to spend time with my friends and family. So it’s not a secret that I’m not a football expert, and I have no shame in admitting it. But I’m very competitive. So when my friends invited me to a football fantasy league <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" rel="footnote">3</a></sup> some years ago I said “yes, and I’m going to wipe the floor with you, losers!”.</p>



<p>Since I’m not a football expert, and I only know the names of a couple of players, I needed another strategy to win my friends. In our league <sup id="fnref:4" role="doc-noteref"><a href="#fn:4" rel="footnote">4</a></sup> we have a fixed budget and we have to select 11 players that will compete during the next set of games. Usually, better players -ie: players that score more points- are more expensive than worse players. But there are always exceptions. For example, Bellingham (one of the Ballon d’Or candidates) costs 64M, but Carvajal (one of the few players with 6 Champions League) only costs 10M. The strategy is then to select cheap players that score a lot of points.</p>

<p>After thinking about the problem for a while it started to ring a bell. We have a maximum budget per team. Each player has a cost. Each player has a value. We want to maximize the value of the team. Isn’t this just the <a href="https://en.wikipedia.org/wiki/Knapsack_problem">knapsack problem</a>?</p>

<figure>
 <img src="https://www.alexmolas.com/docs/knapsack-fantasy/meme.png" alt="Drake Meme" width="500"/>
 <figcaption>Knapsack problem and fantasy sports are basically the same</figcaption>
</figure>

<p>For those unfamiliar with the knapsack problem here’s an example that may help you. Imagine you’re Indiana Jones, standing at the entrance of a treasure-filled temple. You’ve got a backpack with limited space, and you need to decide which artifacts to grab. Each artifact has its weight and value. Your objective is to maximize the value of the packed objects while fulfilling the space constraint. This scenario perfectly captures the essence of the knapsack problem. <sup id="fnref:indy" role="doc-noteref"><a href="#fn:indy" rel="footnote">5</a></sup></p>

<p>In our fantasy league, we face a similar challenge. Instead of relics, we deal with players. And our goal is to build the most valuable team possible without exceeding our budget. It’s like trying to maximize the worth of Indy’s loot while staying within his backpack’s weight limit. So what’s better, to field Mbappe -which is expensive but usually plays very well- or to field Kante -which is cheaper but doesn’t get that many points?</p>



<p>Getting more serious, the knapsack problem can be formulated as: given a set of $n$ items numbered from 1 up to $n$, each with a weight $w_i$ and a value $v_i$, along with a maximum weight capacity $W$, and $x_i$ being the number of copies of $i$,</p>

\[\textrm{maximize} \sum v_i x_i\]

\[\textrm{subject to} \sum w_i x_i &lt; W\]

<p>Here we restrict the problem to $x_i \in \{0, 1\}$, ie we can only select one copy of each element $i$. This simple problem is known to be NP-complete, which means no algorithm solves it fast (where fast means in polynomial time, whatever it means).</p>

<p>In our case, we have to choose $n=11$ players, each with a price $w_i$ and a score $v_i$ and the maximum budget of the team is $W=250$M. Easy peasy! We need to get the data and solve the corresponding knapsack problem and we’ll beat our friends. But…</p>



<p>The knapsack problem we just formulated is a simple one, but in our case, we have to deal with more complexity. In particular</p>

<ul>
  <li>
    <p><strong>We don’t have the data</strong>. The discussion until now has been purely theoretical, but if I want to beat my friends I need data from players (costs, positions, past performance, etc.).</p>
  </li>
  <li>
    <p><strong>Not all the lineups are valid</strong>. You can’t field 11 forwards and no goalkeeper so when solving the problem we need to take into account these constraints.</p>
  </li>
  <li>
    <p>We don’t know the <strong>value of a player before the game</strong>. We only know the scores of the player in past games, but we can’t know how the player will perform in the next game <sup id="fnref:5" role="doc-noteref"><a href="#fn:5" rel="footnote">6</a></sup>.</p>
  </li>
  <li>
    <p>Finally, once we have all the above problems fixed we need to <strong>solve the knapsack problem</strong>.</p>
  </li>
</ul>

<p>Let’s see how to solve these problems one by one.</p>

<h2 id="data">Data</h2>

<p>I’ve never been a front-end developer nor a scrapping expert, so my knowledge of how to get this data was very limited. But after playing a little bit with the developer console I realized that the web was calling always the same endpoint:</p>

<div><div><pre><code>https://cf.biwenger.com/api/v2/competitions/&lt;COMPETITION&gt;/data?score=&lt;SCORE&gt;
</code></pre></div></div>

<p>where <code>&lt;COMPETITION&gt;</code> was the identifier of the competition (Biwenger hosts multiple competitions at the same time) and in our case was <code>euro</code>. And <code>&lt;SCORE&gt;</code> was the identifier of the scoring method used to evaluate players (Biwenger allows you to use multiple scoring options).</p>

<p>With this information, I managed to download all the player’s data, and it looked like</p>

<div><div><pre><code><span>{</span><span>
  </span><span>&#34;32142&#34;</span><span>:</span><span> </span><span>{</span><span>&#34;id&#34;</span><span>:</span><span> </span><span>32142</span><span>,</span><span> </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;Bardakcı&#34;</span><span>,</span><span> </span><span>&#34;slug&#34;</span><span>:</span><span> </span><span>&#34;a-bardakci&#34;</span><span>,</span><span> </span><span>&#34;teamID&#34;</span><span>:</span><span> </span><span>12</span><span>,</span><span> </span><span>&#34;position&#34;</span><span>:</span><span> </span><span>2</span><span>,</span><span> </span><span>&#34;price&#34;</span><span>:</span><span> </span><span>940000</span><span>,</span><span> </span><span>&#34;fantasyPrice&#34;</span><span>:</span><span> </span><span>7000000</span><span>,</span><span> </span><span>&#34;status&#34;</span><span>:</span><span> </span><span>&#34;ok&#34;</span><span>,</span><span> </span><span>&#34;priceIncrement&#34;</span><span>:</span><span> </span><span>190000</span><span>,</span><span> </span><span>&#34;playedHome&#34;</span><span>:</span><span> </span><span>2</span><span>,</span><span> </span><span>&#34;playedAway&#34;</span><span>:</span><span> </span><span>1</span><span>,</span><span> </span><span>&#34;fitness&#34;</span><span>:</span><span> </span><span>[</span><span>4</span><span>,</span><span> </span><span>&#34;sanctioned&#34;</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>5</span><span>],</span><span> </span><span>&#34;points&#34;</span><span>:</span><span> </span><span>10</span><span>,</span><span> </span><span>&#34;pointsHome&#34;</span><span>:</span><span> </span><span>6</span><span>,</span><span> </span><span>&#34;pointsAway&#34;</span><span>:</span><span> </span><span>4</span><span>,</span><span> </span><span>&#34;pointsLastSeason&#34;</span><span>:</span><span> </span><span>null</span><span>},</span><span>
  </span><span>&#34;7470&#34;</span><span>:</span><span> </span><span>{</span><span>&#34;id&#34;</span><span>:</span><span> </span><span>7470</span><span>,</span><span> </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;Bastoni&#34;</span><span>,</span><span> </span><span>&#34;slug&#34;</span><span>:</span><span> </span><span>&#34;a-bastoni&#34;</span><span>,</span><span> </span><span>&#34;teamID&#34;</span><span>:</span><span> </span><span>null</span><span>,</span><span> </span><span>&#34;position&#34;</span><span>:</span><span> </span><span>2</span><span>,</span><span> </span><span>&#34;price&#34;</span><span>:</span><span> </span><span>7480000</span><span>,</span><span> </span><span>&#34;fantasyPrice&#34;</span><span>:</span><span> </span><span>28000000</span><span>,</span><span> </span><span>&#34;status&#34;</span><span>:</span><span> </span><span>&#34;ok&#34;</span><span>,</span><span> </span><span>&#34;priceIncrement&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;playedHome&#34;</span><span>:</span><span> </span><span>1</span><span>,</span><span> </span><span>&#34;playedAway&#34;</span><span>:</span><span> </span><span>3</span><span>,</span><span> </span><span>&#34;fitness&#34;</span><span>:</span><span> </span><span>[</span><span>4</span><span>,</span><span> </span><span>4</span><span>,</span><span> </span><span>6</span><span>,</span><span> </span><span>14</span><span>],</span><span> </span><span>&#34;points&#34;</span><span>:</span><span> </span><span>28</span><span>,</span><span> </span><span>&#34;pointsHome&#34;</span><span>:</span><span> </span><span>14</span><span>,</span><span> </span><span>&#34;pointsAway&#34;</span><span>:</span><span> </span><span>14</span><span>,</span><span> </span><span>&#34;pointsLastSeason&#34;</span><span>:</span><span> </span><span>7</span><span>},</span><span>
  </span><span>&#34;32763&#34;</span><span>:</span><span> </span><span>{</span><span>&#34;id&#34;</span><span>:</span><span> </span><span>32763</span><span>,</span><span> </span><span>&#34;name&#34;</span><span>:</span><span> </span><span>&#34;Buongiorno&#34;</span><span>,</span><span> </span><span>&#34;slug&#34;</span><span>:</span><span> </span><span>&#34;a-buongiorno&#34;</span><span>,</span><span> </span><span>&#34;teamID&#34;</span><span>:</span><span> </span><span>null</span><span>,</span><span> </span><span>&#34;position&#34;</span><span>:</span><span> </span><span>2</span><span>,</span><span> </span><span>&#34;price&#34;</span><span>:</span><span> </span><span>1870000</span><span>,</span><span> </span><span>&#34;fantasyPrice&#34;</span><span>:</span><span> </span><span>17000000</span><span>,</span><span> </span><span>&#34;status&#34;</span><span>:</span><span> </span><span>&#34;ok&#34;</span><span>,</span><span> </span><span>&#34;priceIncrement&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;playedHome&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;playedAway&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;fitness&#34;</span><span>:</span><span> </span><span>[</span><span>null</span><span>,</span><span> </span><span>null</span><span>,</span><span> </span><span>null</span><span>,</span><span> </span><span>null</span><span>],</span><span> </span><span>&#34;points&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;pointsHome&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;pointsAway&#34;</span><span>:</span><span> </span><span>0</span><span>,</span><span> </span><span>&#34;pointsLastSeason&#34;</span><span>:</span><span> </span><span>null</span><span>}</span><span>
</span><span>}</span><span>
</span></code></pre></div></div>

<p>And then I parsed this information into a list of dataclasses</p>

<div><div><pre><code><span>@</span><span>dataclass</span><span>(</span><span>frozen</span><span>=</span><span>True</span><span>)</span>
<span>class</span> <span>Player</span><span>:</span>
 <span>player_id</span><span>:</span> <span>int</span>
 <span>name</span><span>:</span> <span>str</span>
 <span>position</span><span>:</span> <span>int</span>
 <span>price</span><span>:</span> <span>int</span>
 <span>status</span><span>:</span> <span>str</span>
 <span>played_home</span><span>:</span> <span>int</span>
 <span>played_away</span><span>:</span> <span>int</span>
 <span>fitness</span><span>:</span> <span>Tuple</span><span>[</span><span>int</span><span>]</span>
 <span>points</span><span>:</span> <span>int</span>
 <span>points_home</span><span>:</span> <span>int</span>
 <span>points_away</span><span>:</span> <span>int</span>
 <span>team_id</span><span>:</span> <span>int</span>
</code></pre></div></div>

<h2 id="player-value">Player value</h2>

<p>The next problem to solve was to predict player performance in the next game. The obvious solution for a data scientist like me was to use machine learning. But I didn’t. I just took the average score by the player during the last 5 games.</p>

<div><div><pre><code><span>def</span> <span>player_value</span><span>(</span><span>player</span><span>:</span> <span>Player</span><span>):</span>
 <span>fitness</span> <span>=</span> <span>[</span><span>value</span> <span>for</span> <span>value</span> <span>in</span> <span>player</span><span>.</span><span>fitness</span> <span>if</span> <span>isinstance</span><span>(</span><span>value</span><span>,</span> <span>int</span><span>)]</span>
  <span>if</span> <span>player</span><span>.</span><span>team_id</span> <span>is</span> <span>not</span> <span>None</span><span>:</span>
      <span>return</span> <span>np</span><span>.</span><span>mean</span><span>(</span><span>fitness</span><span>)</span>
  <span>else</span><span>:</span>
      <span>return</span> <span>0</span>
</code></pre></div></div>

<h2 id="team-constraints">Team constraints</h2>

<p>The last thing we need to define are the constraints our team has to fulfill. We can implement these constraints using another dataclass</p>

<div><div><pre><code><span>@</span><span>dataclass</span><span>(</span><span>frozen</span><span>=</span><span>True</span><span>)</span>
<span>class</span> <span>TeamConstraints</span><span>:</span>
 <span>max_salary</span><span>:</span> <span>int</span>
 <span>number_of_gk</span><span>:</span> <span>Tuple</span><span>[</span><span>int</span><span>,</span> <span>int</span><span>]</span> <span>=</span> <span>(</span><span>1</span><span>,</span> <span>1</span><span>)</span>
 <span>number_of_df</span><span>:</span> <span>Tuple</span><span>[</span><span>int</span><span>,</span> <span>int</span><span>]</span> <span>=</span> <span>(</span><span>2</span><span>,</span> <span>5</span><span>)</span>
 <span>number_of_mc</span><span>:</span> <span>Tuple</span><span>[</span><span>int</span><span>,</span> <span>int</span><span>]</span> <span>=</span> <span>(</span><span>2</span><span>,</span> <span>5</span><span>)</span>
 <span>number_of_fw</span><span>:</span> <span>Tuple</span><span>[</span><span>int</span><span>,</span> <span>int</span><span>]</span> <span>=</span> <span>(</span><span>1</span><span>,</span> <span>5</span><span>)</span>
 <span>max_n_players</span><span>:</span> <span>int</span> <span>=</span> <span>11</span>
</code></pre></div></div>

<h2 id="solver">Solver</h2>

<p>Now we have all the information we need, but how do we find the best team? How do we solve the knapsack fantasy problem?</p>

<p>To solve the problem we’ll use Google’s <a href="https://developers.google.com/optimization">OR-tools</a>, an open-source library for operations research. How does it work? Let’s see it step by step.</p>

<h3 id="define-the-solver">Define the solver</h3>

<p>We’ll wrap everything in a custom class called <code>Solver</code> (yes, I know, I’m very creative), which looks like</p>

<div><div><pre><code><span>class</span> <span>Solver</span><span>:</span>
    <span>def</span> <span>__init__</span><span>(</span>
 <span>self</span><span>,</span>
 <span>player_value</span><span>:</span> <span>Callable</span><span>[[</span><span>Player</span><span>],</span> <span>float</span><span>],</span>
 <span>player_cost</span><span>:</span> <span>Callable</span><span>[[</span><span>Player</span><span>],</span> <span>float</span><span>],</span>
 <span>constraints</span><span>:</span> <span>TeamConstraints</span><span>,</span>
 <span>players</span><span>:</span> <span>Dict</span><span>[</span><span>str</span><span>,</span> <span>Player</span><span>],</span>
 <span>):</span>
        <span>self</span><span>.</span><span>player_value</span> <span>=</span> <span>player_value</span>
        <span>self</span><span>.</span><span>player_cost</span> <span>=</span> <span>player_cost</span>
        <span>self</span><span>.</span><span>players</span> <span>=</span> <span>players</span>
        <span>self</span><span>.</span><span>constraints</span> <span>=</span> <span>constraints</span>

    <span>def</span> <span>solve</span><span>(</span><span>self</span><span>)</span> <span>-&gt;</span> <span>Team</span><span>:</span>
      <span>...</span> 
</code></pre></div></div>

<p>First of all, we need to initialize an OR-tools solver.</p>

<div><div><pre><code><span>def</span> <span>solve</span><span>(</span><span>self</span><span>)</span> <span>-&gt;</span> <span>Team</span><span>:</span>
 <span>solver</span> <span>=</span> <span>pywraplp</span><span>.</span><span>Solver</span><span>(</span><span>name</span><span>=</span><span>&#34;FantasyKnapsack&#34;</span><span>,</span> <span>problem_type</span><span>=</span><span>pywraplp</span><span>.</span><span>Solver</span><span>.</span><span>CBC_MIXED_INTEGER_PROGRAMMING</span><span>)</span>
  <span>...</span>
</code></pre></div></div>

<p>Now, with this solver, we can add constraints (budget, number of players, etc) and values to maximize (team score). But first, we need to define a couple of variables.</p>

<h3 id="selecting-players-and-defining-value">Selecting players and defining value</h3>

<p>Let’s define now a list called <code>take</code> which will be <code>0</code> in position <code>i</code> if player <code>i</code> is not selected and <code>1</code> otherwise.</p>

<div><div><pre><code><span>...</span>
<span>take</span> <span>=</span> <span>[</span><span>solver</span><span>.</span><span>IntVar</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>f</span><span>&#34;take_</span><span>{</span><span>p</span><span>}</span><span>&#34;</span><span>)</span> <span>for</span> <span>p</span> <span>in</span> <span>self</span><span>.</span><span>players</span><span>]</span>
<span>...</span>
</code></pre></div></div>

<p>And now we define the value we want to maximize</p>

<div><div><pre><code><span>...</span>
<span>value</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>[</span><span>self</span><span>.</span><span>player_value</span><span>(</span><span>p</span><span>)</span> <span>*</span> <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())]</span>
 <span>)</span>
<span>solver</span><span>.</span><span>Maximize</span><span>(</span><span>value</span><span>)</span>
<span>...</span>
</code></pre></div></div>

<p>This means, we check for each player if it’s chosen or not (<code>taken[i]</code>) and we sum their values. Then we tell the solver we want to maximize this value, and the solver will build <code>taken</code> such that this value is maximized while fulfilling the constraints.</p>

<h3 id="constraints">Constraints</h3>

<p>Adding constraints to the solver is very easy. For example, to add the budget constraint we just need to do this:</p>

<div><div><pre><code><span>...</span>
<span>budget</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>[</span><span>self</span><span>.</span><span>player_cost</span><span>(</span><span>p</span><span>)</span> <span>*</span> <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())]</span>
 <span>)</span>
<span>solver</span><span>.</span><span>Add</span><span>(</span><span>budget</span> <span>&lt;=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>max_salary</span><span>)</span>
<span>...</span>
</code></pre></div></div>

<p>As you can see the logic is very simple: sum the cost of each selected player and then add it as a constraint to the solver. We also need to define the number of players’ constraints, which is also very easy. In the following snippet, we can see how to add the constraint for the minimum and maximum number of goalkeepers</p>

<div><div><pre><code><span>...</span>
<span>min_gk</span><span>,</span> <span>max_gk</span> <span>=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>number_of_gk</span>
<span>number_of_gk</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>[</span><span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span> <span>if</span> <span>p</span><span>.</span><span>position</span> <span>==</span> <span>1</span><span>]</span>
 <span>)</span>
<span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_gk</span> <span>&gt;=</span> <span>min_gk</span><span>)</span>
<span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_gk</span> <span>&lt;=</span> <span>max_gk</span><span>)</span>
<span>...</span>
</code></pre></div></div>

<p>And the logic is the same for defense, midfielders, and forwards.</p>

<h3 id="putting-everything-together">Putting everything together</h3>

<p>After defining the value to maximize and adding all the constraints we just need to ask the solver to find the optimal solution. You can check the full code below.</p>

<details>
<summary>Full solver class</summary>

<figure><pre><code data-lang="python"><span>class</span> <span>Solver</span><span>(</span><span>BaseSolver</span><span>):</span>
 <span>def</span> <span>__init__</span><span>(</span>
 <span>self</span><span>,</span>
 <span>player_value</span><span>:</span> <span>Callable</span><span>[[</span><span>Player</span><span>],</span> <span>float</span><span>],</span>
 <span>player_cost</span><span>:</span> <span>Callable</span><span>[[</span><span>Player</span><span>],</span> <span>float</span><span>],</span>
 <span>constraints</span><span>:</span> <span>TeamConstraints</span><span>,</span>
 <span>players</span><span>:</span> <span>Dict</span><span>[</span><span>str</span><span>,</span> <span>Player</span><span>],</span>
 <span>):</span>
 <span>self</span><span>.</span><span>player_value</span> <span>=</span> <span>player_value</span>
 <span>self</span><span>.</span><span>player_cost</span> <span>=</span> <span>player_cost</span>
 <span>self</span><span>.</span><span>players</span> <span>=</span> <span>players</span>
 <span>self</span><span>.</span><span>constraints</span> <span>=</span> <span>constraints</span>

 <span>def</span> <span>solve</span><span>(</span><span>self</span><span>)</span> <span>-&gt;</span> <span>Team</span><span>:</span>
 <span>solver</span> <span>=</span> <span>pywraplp</span><span>.</span><span>Solver</span><span>(</span>
 <span>&#34;FantasyKnapsack&#34;</span><span>,</span> <span>pywraplp</span><span>.</span><span>Solver</span><span>.</span><span>CBC_MIXED_INTEGER_PROGRAMMING</span>
 <span>)</span>
 <span>take</span> <span>=</span> <span>[</span><span>solver</span><span>.</span><span>IntVar</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>f</span><span>&#34;take_</span><span>{</span><span>p</span><span>}</span><span>&#34;</span><span>)</span> <span>for</span> <span>p</span> <span>in</span> <span>self</span><span>.</span><span>players</span><span>]</span>
 <span>value</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>[</span>
 <span>self</span><span>.</span><span>player_value</span><span>(</span><span>p</span><span>)</span> <span>*</span> <span>take</span><span>[</span><span>i</span><span>]</span>
 <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span>
 <span>]</span>
 <span>)</span>
 <span>solver</span><span>.</span><span>Maximize</span><span>(</span><span>value</span><span>)</span>

 <span>salary</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>[</span><span>self</span><span>.</span><span>player_cost</span><span>(</span><span>p</span><span>)</span> <span>*</span> <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())]</span>
 <span>)</span>

 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>salary</span> <span>&lt;=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>max_salary</span><span>)</span>

 <span># number of players constraints
</span> <span>min_pt</span><span>,</span> <span>max_pt</span> <span>=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>range_pt</span>
 <span>number_of_gk</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span> <span>if</span> <span>p</span><span>.</span><span>position</span> <span>==</span> <span>1</span>
 <span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_gk</span> <span>&gt;=</span> <span>min_pt</span><span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_gk</span> <span>&lt;=</span> <span>max_pt</span><span>)</span>

 <span>min_df</span><span>,</span> <span>max_df</span> <span>=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>range_df</span>
 <span>number_of_df</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span> <span>if</span> <span>p</span><span>.</span><span>position</span> <span>==</span> <span>2</span>
 <span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_df</span> <span>&gt;=</span> <span>min_df</span><span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_df</span> <span>&lt;=</span> <span>max_df</span><span>)</span>

 <span>min_mc</span><span>,</span> <span>max_mc</span> <span>=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>range_mc</span>
 <span>number_of_mc</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span> <span>if</span> <span>p</span><span>.</span><span>position</span> <span>==</span> <span>3</span>
 <span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_mc</span> <span>&gt;=</span> <span>min_mc</span><span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_mc</span> <span>&lt;=</span> <span>max_mc</span><span>)</span>
 <span>min_dl</span><span>,</span> <span>max_dl</span> <span>=</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>range_dl</span>

 <span>number_of_dl</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span> <span>if</span> <span>p</span><span>.</span><span>position</span> <span>==</span> <span>4</span>
 <span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_dl</span> <span>&gt;=</span> <span>min_dl</span><span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_dl</span> <span>&lt;=</span> <span>max_dl</span><span>)</span>

 <span>number_of_players</span> <span>=</span> <span>solver</span><span>.</span><span>Sum</span><span>(</span>
 <span>take</span><span>[</span><span>i</span><span>]</span> <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>())</span>
 <span>)</span>
 <span>solver</span><span>.</span><span>Add</span><span>(</span><span>number_of_players</span> <span>==</span> <span>self</span><span>.</span><span>constraints</span><span>.</span><span>max_n_players</span><span>)</span>

 <span># solving
</span> <span>solver</span><span>.</span><span>Solve</span><span>()</span>
 <span>assert</span> <span>solver</span><span>.</span><span>VerifySolution</span><span>(</span><span>1e-7</span><span>,</span> <span>True</span><span>)</span>

 <span>team</span> <span>=</span> <span>Team</span><span>(</span>
 <span>player_value</span><span>=</span><span>self</span><span>.</span><span>player_value</span><span>,</span>
 <span>player_cost</span><span>=</span><span>self</span><span>.</span><span>player_cost</span><span>,</span>
 <span>players</span><span>=</span><span>[],</span>
 <span>constraints</span><span>=</span><span>self</span><span>.</span><span>constraints</span><span>,</span>
 <span>)</span>
 <span>for</span> <span>i</span><span>,</span> <span>p</span> <span>in</span> <span>enumerate</span><span>(</span><span>self</span><span>.</span><span>players</span><span>.</span><span>values</span><span>()):</span>
 <span>if</span> <span>take</span><span>[</span><span>i</span><span>].</span><span>SolutionValue</span><span>():</span>
 <span>team</span><span>.</span><span>add_player</span><span>(</span><span>p</span><span>)</span>

 <span>team</span><span>.</span><span>check_constraints</span><span>()</span>
 <span>return</span> <span>team</span></code></pre></figure>

</details>



<p>Cool! We have a way to design fantasy teams, but how good is it? Is it better than a human player? Or have we just lost a lot of time implementing a solution that doesn’t work? To answer these questions I’ve participated in a couple of fantasy leagues from the Quarterfinals to the Final. I participated in two open leagues and one with my friends. Here are the results.</p>

<ul>
  <li><strong>Friends results</strong></li>
</ul>

<div><div><pre><code>| Stage         | Position  | Points | 1st Position Points  | Average Points |
|---------------|-----------|--------|----------------------|----------------|
| Quarterfinals | 6/9       | 73     | 86                   | 76             |
| Semifinal     | 3/9       | 55     | 66                   | 52             |
| Finals        | 6/9       | 55     | 73                   | 55             |
|---------------|-----------|--------|----------------------|----------------|
| Overall       | 4/9       | 191    | 214                  | 183            |
</code></pre></div></div>

<ul>
  <li><strong>Open league results (Carrusel Deportivo)</strong></li>
</ul>

<div><div><pre><code>| Stage         | Position  | Points | 1st Position Points  |
|---------------|-----------|--------|----------------------|
| Quarterfinals | 3038/6345 | 74     | 109                  |
| Semifinal     | 2299/6345 | 82     | 106                  |
| Final         | 1706/6345 | 91     | 102                  |
</code></pre></div></div>

<ul>
  <li><strong>Open league results (Tomas Roncero)</strong></li>
</ul>

<div><div><pre><code>| Stage         | Position  | Points  | 1st Position Points  |
|---------------|---------- |-------- |----------------------|
| Quarterfinals | 188/5837  | 62      | 84                   |
| Semifinal     | 200/5837  | 85      | 104                  |
| Final         | 570/5837  | 91      | 101                  |
</code></pre></div></div>



<p>From the above tables, it’s obvious that my approach hasn’t been enough to win and humiliate my friends. My teams scored the same as the average, which is not enough to win this type of league. Overall, after summing up all the points obtained, I finished the league 4th, which isn’t bad but it’s also not great.</p>

<p>On the other hand, I’m impressed by the results in the open leagues. In one of them, I did poorly (top 30-50%), but in the other one, the performance was very strong (top 3-9%). I don’t have the overall results since these leagues started at the beginning of the Euro while I only played for the last 3 stages.</p>

<p>One key takeaway is that while the algorithm didn’t dominate, it did manage to outperform a significant portion of human players in the larger leagues. This is encouraging, considering that many of these players likely have years of experience and intuition about fantasy football -or at least have watched more football than me.</p>

<p>Why did this solution do so poorly? Here are some things that can be fixed for future iterations</p>

<ul>
  <li><strong>Score prediction was too naive</strong>. Using just the average of the last 5 games doesn’t capture form, injuries, or matchup difficulty. Using ML here would have helped a lot.</li>
  <li>The algorithm tried to maximize the expected total score but <strong>didn’t take into account volatility</strong>. When doing this kind of portfolio optimization you want to maximize returns while keeping risk under a certain level.</li>
  <li>It didn’t consider the schedule of matches, potentially <strong>selecting players who weren’t playing in a given round</strong>. In fact, for some games, I aligned players who weren’t playing for that stage, and sometimes this information is available before starting the game.</li>
  <li>There was no consideration of player popularity or ownership percentages, which can be strategic in <strong>differentiating your team</strong>. I mean, for two players with the same expected score you might want to select the less popular one, to differentiate from other players.</li>
</ul>

<hr/>





  </div></div>
  </body>
</html>
