<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://laurentrdc.xyz/posts/typed-dimensions.html">Original</a>
    <h1>Scientific computing with confidence using typed dimensions</h1>
    
    <div id="readability-page-1" class="page"><div>
            <div>
                <div>
                    <p>I have performed non-trivial scientific calculations, in <a href="https://laurentrdc.xyz/about.html">university and beyond</a>, for almost 15 years.</p>
<p>Until the end of undergraduate school, this was mostly done by hand. Optimizing the <a href="https://en.wikipedia.org/wiki/Brachistochrone_curve">trajectory of a heavy ball</a> or solving the <a href="https://en.wikipedia.org/wiki/Heat_equation">heat equation</a> are problems with analytical solutions, and thus can be solved with pen(cil) and paper.</p>
<p>However, there were instances when numerical tools had to be used, rather than analytical ones. This occurred, for example, when replacing models of the physical world with measurements from the physical world in experimental physics classes. By the end of my B.Sc., <a href="https://laurentrdc.xyz/files/ugrad_project.pdf">the need to take measurements, transform them, and report results was made much simpler by using a computer</a>.</p>
<p>Fast forward to graduate school, and the amount of measurements (and their complexity) require the use of some of the most powerful computers I have ever used, even to this day. When implementing numerical routines, I had to pore over the equations (translated to computer expression) countless times, to ensure that they were correctly applied. Most importantly, <strong>all units needed to be carefully checked by hand</strong>. Small mistakes went unnoticed and wasted valuable resources.
Take a look at <a href="https://github.com/LaurentRDC/dissertation/blob/7fb658306b6c7dd1b4c8b983ad5f6d8fb91bcdb1/figures/graphite/eph-coupling.py#L56">one of the computations</a> from my Ph. D. dissertation (<a href="https://laurentrdc.xyz/files/dissertation.pdf">PDF</a>, <a href="https://github.com/LaurentRDC/dissertation">Git repository</a>):</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>from</span> scipy.constants <span>import</span> physical_constants</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span>def</span> population(temperature: <span>float</span>, frequency: <span>float</span>) <span>-&gt;</span> <span>float</span>:</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span>&#34;&#34;&#34;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span>    Determine average phonon population at `temperature`.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span>    Parameters</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span>    ----------</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span>    temperature : float</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span>        Temperature in Kelvin</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span>    frequency : float</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span>        Phonon frequency in Hertz</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span>    &#34;&#34;&#34;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    h, <span>*</span>_ <span>=</span> physical_constants[<span>&#34;Planck constant over 2 pi in eV s&#34;</span>]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    kb, <span>*</span>_ <span>=</span> physical_constants[<span>&#34;Boltzmann constant in eV/K&#34;</span>]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span>return</span> <span>0.5</span> <span>*</span> coth(h <span>*</span> frequency <span>/</span> (<span>2</span> <span>*</span> kb <span>*</span> temperature)) <span>-</span> <span>0.5</span></span></code></pre></div>
<p>This isn’t a complex equation, but it showcases the problem perfectly. <code>temperature</code>, <code>frequency</code>, <code>h</code>, and <code>kb</code> are all floating-point numbers, with their units attached <em>as documentation</em>. This is not robust.</p>
<p>These days, instead of meticulously going over the details of calculations ahead of time, I now defer to my computer to check the validity of my calculations <em>as much as possible</em>. That’s why computers exist: to free people from repetitive and error-prone work. In this post, I will describe a mechanism, typed dimensions, by which we can eliminate entire classes of bugs, and how the <a href="https://github.com/bjornbm/dimensional/"><code>dimensional</code></a> Haskell package makes this easy.</p>
<h2 id="dimensions-units-and-quantities">Dimensions, units, and quantities</h2>
<p>In the international system of units (also called SI units), there are 7 basic <em>dimensions</em> a physical value can have:</p>
<ul>
<li>time duration <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>;</li>
<li>length <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>;</li>
<li>mass <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>;</li>
<li>electric current <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>;</li>
<li>thermodynamic temperature <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Θ</mi><annotation encoding="application/x-tex">\Theta</annotation></semantics></math>;</li>
<li>amount of substance <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>;</li>
<li>luminous intensity <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>.</li>
</ul>
<p>Using the symbols associated with these base dimensions, we can express any dimension using exponents. For example, velocity (length over time duration) has dimensions <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>/</mi><mi>T</mi><mo>=</mo><mi>L</mi><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">L/T = L \cdot T^{-1}</annotation></semantics></math>, while force (mass-length over time squared) has dimensions <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>⋅</mo><mi>L</mi><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>2</mn></mrow></msup></mrow><annotation encoding="application/x-tex">M \cdot L \cdot T^{-2}</annotation></semantics></math>. Dimensionless quantities have all exponents being 0.</p>
<p>Why are dimensions important? <a href="https://en.wikipedia.org/w/index.php?title=Dimensional_analysis&amp;oldid=1254137729#Mathematical_properties">There are mathematical rules associated with combining numbers with dimensions</a>:</p>
<ul>
<li><p>Two quantities with dimensions <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>1</mn></msub><annotation encoding="application/x-tex">D_1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>2</mn></msub><annotation encoding="application/x-tex">D_2</annotation></semantics></math> can only be added or subtracted if (and only if) <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mn>1</mn></msub><mo>≡</mo><msub><mi>D</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D_1 \equiv D_2</annotation></semantics></math>. For example, it does not make sense to add a length to a mass.</p></li>
<li><p>Any two quantities with dimensions <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>1</mn></msub><annotation encoding="application/x-tex">D_1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>2</mn></msub><annotation encoding="application/x-tex">D_2</annotation></semantics></math> can be multiplied or divided, in which case the resulting dimension follows the usual rules of arithmetic. For example:</p></li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo>⋅</mo><mi>Θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mo>⋅</mo><msup><mi>Θ</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right"></mtd><mtd columnalign="left"><mo>=</mo><msup><mi>L</mi><mrow><mn>1</mn><mo>−</mo><mn>1</mn></mrow></msup><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mo>⋅</mo><msup><mi>Θ</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup></mtd></mtr><mtr><mtd columnalign="right"></mtd><mtd columnalign="left"><mo>=</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mo>⋅</mo><msup><mi>Θ</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\left( L \cdot T^{-1} \right) / \left( L \cdot \Theta\right) 
    &amp;= \left( L \cdot T^{-1} \right) \cdot \left( L^{-1} \cdot \Theta^{-1}\right) \\
    &amp;= L^{1 - 1} \cdot T^{-1} \cdot \Theta^{-1} \\
    &amp;= T^{-1} \cdot \Theta^{-1}
\end{align}
</annotation></semantics></math></p>
<p>From these two facts, we can derive some surprising conclusions. For example, the argument to many functions (such as sine, cosine, exponential, etc.) must be dimensionless! Consider the Taylor series expansion of the sine function:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>sin</mo><mi>x</mi><mo>=</mo><mi>x</mi><mo>−</mo><mfrac><msup><mi>x</mi><mn>3</mn></msup><mrow><mn>3</mn><mi>!</mi></mrow></mfrac><mo>+</mo><mfrac><msup><mi>x</mi><mn>5</mn></msup><mrow><mn>5</mn><mi>!</mi></mrow></mfrac><mo>−</mo><mi>.</mi><mi>.</mi><mi>.</mi></mrow><annotation encoding="application/x-tex">
    \sin{x} = x - \frac{x^3}{3!} + \frac{x^5}{5!} - ...
</annotation></semantics></math></p>
<p>The argument <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> must have the same dimensions as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>x</mi><mn>3</mn></msup><annotation encoding="application/x-tex">x^3</annotation></semantics></math>, <em>which is only possible if and only if <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> is a dimensionless quantity</em>.</p>
<p>Units of measure are physical manifestations of dimensions. Dimensions are abstract, while units of measure are concrete. For example, the length dimension <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math> can be measured in units of meters. Each basic dimension has its own canonical unit of measure, the <em>base unit</em>:</p>
<ul>
<li>The second (s) for time duration <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>;</li>
<li>The meter (m) for length <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>;</li>
<li>The kilogram (kg) for mass <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>;</li>
<li>The ampere (A) for electric current <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>;</li>
<li>The kelvin (K) for thermodynamic temperature <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Θ</mi><annotation encoding="application/x-tex">\Theta</annotation></semantics></math>;</li>
<li>The mole (mol) for amount of substance <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>;</li>
<li>The candela (cd) for luminous intensity <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>J</mi><annotation encoding="application/x-tex">J</annotation></semantics></math>.</li>
</ul>
<p>Units for non-basic dimensions, so-called <em>derived units</em>, are combinations of base units using the usual multiplication (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>⋅</mi><annotation encoding="application/x-tex">\cdot</annotation></semantics></math>) and division (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>/</mi><annotation encoding="application/x-tex">/</annotation></semantics></math>) operators. For example, velocity has dimensions of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">L \cdot T^{-1}</annotation></semantics></math>, and can be measured in units of meters per second (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mi>m</mi><mi>s</mi></mfrac><annotation encoding="application/x-tex">\frac{m}{s}</annotation></semantics></math>). Some derived units have names; for example, the Newton (N) is a derived unit corresponding to <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mtext mathvariant="normal">kg</mtext><mo>⋅</mo><mtext mathvariant="normal">m</mtext></mrow><msup><mtext mathvariant="normal">s</mtext><mn>2</mn></msup></mfrac><annotation encoding="application/x-tex">\frac{\text{kg} \cdot \text{m}}{\text{s}^2}</annotation></semantics></math>.</p>
<p>Based on their dimensions, units can only be combined in certain ways. You can only add/subtract units of the same dimensions, while the multiplication/division of units modifies the dimensions.</p>
<p>Units can be converted to any other units of the same dimensions by conversion <em>base unit</em>. For example, converting from units of imperial feet (ft) to kilometers (km) involves conversion from imperial feet to the base unit of length, the meter, and then conversion from the meter to the kilometer.</p>
<p>Finally, a <em>quantity</em> is a number attached to units. 3.15 meter/second is a quantity with magnitude 3.15, units of meters/second, and dimensions of length over time duration (or <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">L \cdot T^{-1}</annotation></semantics></math>).</p>
<p>Scientists take measurements of quantities, and run scientific computations to get answers in the form of other quantities. We can ensure correctness of these computations by realizing that <strong>dimensions are known ahead of time</strong>. This means that for statically- and strongly-typed languages (e.g. Haskell, Rust), we should enforce correctness using the type system.</p>
<h2 id="type-safe-dimensions">Type-safe dimensions</h2>
<p>People’s first contact with computational unit systems may come from <a href="https://github.com/hgrecco/pint"><code>pint</code></a>, a Python library to manipulate quantities. While <code>pint</code> is better than nothing, it does not guarantee correctness at runtime due to Python’s dynamic nature.</p>
<p>Instead, I prefer the <a href="https://github.com/bjornbm/dimensional/"><code>dimensional</code></a> package, a Haskell library that guarantees correctness by ensuring type-safe dimensions at compile-time. Other tools exist for other languages – for example, <a href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/units-of-measure">F# famously includes units of measure</a> as a first-party feature.</p>
<p>We will work by example to compute the <a href="https://en.wikipedia.org/w/index.php?title=Maxwell%E2%80%93Boltzmann_distribution&amp;oldid=1255523817">Maxwell-Boltzmann distribution</a>. This is the distribution of velocities of identical particles of mass <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>, given some thermodynamic temperature <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mi>m</mi><mrow><mn>2</mn><mi>π</mi><msub><mi>k</mi><mi>B</mi></msub><mi>T</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>3</mn><mn>2</mn></mfrac></msup><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><mfrac><mrow><mi>m</mi><msup><mi>v</mi><mn>2</mn></msup></mrow><mrow><mn>2</mn><msub><mi>k</mi><mi>B</mi></msub><mi>T</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
    f(v) = \left( \frac{m}{2 \pi k_B T}\right)^{\frac{3}{2}} \exp{ \left( -\frac{m v^2 }{2 k_B T}\right) }
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>v</mi><annotation encoding="application/x-tex">v</annotation></semantics></math> is the <em>magnitude</em> of particle velocity in a three-dimensional space, and <a href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/units-of-measure"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>k</mi><mi>B</mi></msub><annotation encoding="application/x-tex">k_B</annotation></semantics></math> is the Boltzmann constant</a>.</p>
<p>Without typed dimensions, the computation of this distribution can be done as follows:</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>-- Boltzmann constant in Joules/Kelvin</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>boltzmannConstant_JpK ::</span> <span>Double</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>boltzmannConstant_JpK <span>=</span> <span>1.380649e-23</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span>untypedMaxwellBoltzmannDist ::</span> <span>Double</span> <span>-- ^ Particle mass in kilogram</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                            <span>-&gt;</span> <span>Double</span> <span>-- ^ Thermodynamic temperature in Kelvin</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                            <span>-&gt;</span> <span>Double</span> <span>-- ^ Particle velocity in meters/second</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                            <span>-&gt;</span> <span>Double</span> <span>-- ^ Probability density (dimensionless)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>untypedMaxwellBoltzmannDist mass_kg temp_K velocity_mps </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span>=</span> ( mass_kg <span>/</span> (<span>2</span> <span>*</span> <span>pi</span> <span>*</span> boltzmannConstant_JpK <span>*</span> temp_K) ) <span>**</span> (<span>3</span><span>/</span><span>2</span>) </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span>*</span> <span>exp</span> ( <span>-</span> (mass_kg <span>*</span> velocity_mps <span>**</span><span>2</span>) <span>/</span> (<span>2</span> <span>*</span> <span>pi</span> <span>*</span> boltzmannConstant_JpK <span>*</span> temp_K) )</span></code></pre></div>
<p>It’s not too hard to check units by hand – but it is tedious and error-prone.</p>
<p>Now let’s do this again, using <a href="https://github.com/bjornbm/dimensional/"><code>dimensional</code></a>.</p>
<div>
<p>
Dear reader, be forewarned: <b>the rest of this post is not for the faint-of-heart</b>.
</p>
<p>
Yes, this is overkill for simple calculations. And yet, the technique you are about to see has saved me numerous times. There’s quite a bit more ceremony; in exchange, you get a lot more certainty about correctness. Software design is about trade-off, and this level of safety is required for some real-world applications.
</p>
</div>
<p>Setup: I am using the <a href="https://downloads.haskell.org/ghc/9.10.1/docs/users_guide/exts/control.html?highlight=language%20edition#extension-GHC2024">GHC2024 language edition</a>. We will also replace the (implicitly imported) <code>Prelude</code> module to use <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html"><code>Numeric.Units.Dimensional.Prelude</code></a>, which replaces the usual arithmetic operators to use dimension-aware ones, as well as importing the <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#t:Unit"><code>Unit</code></a>, <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#t:Dimension"><code>Dimension</code></a>, and <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#t:Quantity"><code>Quantity</code></a> types.</p>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>{-# LANGUAGE NoImplicitPrelude #-}</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span>import</span> <span>Numeric.Units.Dimensional.Prelude</span></span></code></pre></div>
<p>To get acquainted, let’s convert the definition of the Boltzmann constant. The dimensions of the Boltzmann constant are called <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Quantities.html#t:DHeatCapacity"><code>DHeatCapacity</code></a> in <code>dimensional</code>. Therefore, we can write:</p>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>boltzmannConstant ::</span> <span>Quantity</span> <span>DHeatCapacity</span> <span>Double</span></span></code></pre></div>
<p>which means that <code>boltzmannConstant</code> is a <code>Quantity</code> of dimension <code>DHeatCapacity</code>, whose magnitude is represented by a <code>Double</code>. We use the <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#v:-42--126-"><code>(*~)</code></a> operator to combine a number (<code>1.380649e-23</code>) with a compound unit, <code>joule / kelvin</code>, to get:</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>boltzmannConstant ::</span> <span>Quantity</span> <span>DHeatCapacity</span> <span>Double</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>boltzmannConstant <span>=</span> <span>1.380649e-23</span> <span>*~</span> (joule <span>/</span> kelvin)</span></code></pre></div>
<p>We are not yet ready to implement the Maxwell-Boltzmann distribution function. One particular wrinkle is that exponents (such as the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">3/2</annotation></semantics></math> exponent of the first term) change the dimensions (i.e. the type) of the input. Therefore, some type arithmetic is required. To this end, <code>dimensional</code> provides <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#v:-94-"><code>(^)</code></a> to raise to an integer power, and <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#v:sqrt"><code>sqrt</code></a> to take the square root, while appropriately changing the dimensions at compile time. The type signatures are non-trivial to say the least, as it involves compile-time manipulation of types. The operation of “raising to the three-halfs power” becomes:</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>raiseToThreeHalfsPower ::</span> <span>Floating</span> a </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                       <span>=&gt;</span> <span>Quantity</span> d a </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                       <span>-&gt;</span> <span>Quantity</span> (<span>NRoot</span> d <span>Pos2</span> <span>^</span> <span>Pos3</span>) a</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>raiseToThreeHalfsPower x <span>=</span> (<span>sqrt</span> x) <span>^</span> pos3</span></code></pre></div>
<p>where <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#v:pos3"><code>pos3</code></a> is a type-level integer. The dimension <code>(NRoot d Pos2 ^ Pos3)</code> will resolve to the appropriate dimension at compile-time via <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#t:NRoot">type families</a> once <code>d</code> is known.</p>
<p>Finally, we can implement the (dimensionally-typed) Maxwell-Boltzmann function:</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span>maxwellBoltzmannDist ::</span> <span>Mass</span> <span>Double</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                     <span>-&gt;</span> <span>ThermodynamicTemperature</span> <span>Double</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                     <span>-&gt;</span> <span>Velocity</span> <span>Double</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                     <span>-&gt;</span> <span>Dimensionless</span> <span>Double</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>maxwellBoltzmannDist mass temp velocity </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span>=</span> raiseToThreeHalfsPower ( mass <span>/</span> (_2 <span>*</span> <span>pi</span> <span>*</span> boltzmannConstant <span>*</span> temp) )</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span>*</span> <span>exp</span> ( <span>negate</span> (mass <span>*</span> velocity <span>^</span> pos2) <span>/</span> (_2 <span>*</span> <span>pi</span> <span>*</span> boltzmannConstant <span>*</span> temp) )</span></code></pre></div>
<p>where <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#v:_2"><code>_2</code></a> is the dimensionless integer <code>2</code>, and <code>(*)</code>, <code>(/)</code>, <code>exp</code>, <code>negate</code>, and <code>^</code> are all dimensionally-aware operators from <code>dimensional</code> (rather than the <code>Prelude</code> module).</p>
<p>If you compile the program above, you’ll get an error message ಠ_ಠ:</p>
<pre><code>Couldn&#39;t match type ‘Neg3’ with ‘Zero’
  Expected: Dimensionless Double
    Actual: Quantity 
                (NRoot 
                    (DMass 
                        / ((Dim Zero Zero Zero Zero Zero Zero Zero * DHeatCapacity) * DThermodynamicTemperature)) 
                    Pos2 ^ Pos3
                ) 
                Double
(...snip...)</code></pre>
<p>This is because I’m a sloppy physicist – sorry! The Maxwell-Boltzmann distribution <strong>is not a dimensionless quantity</strong>: it actually returns a velocity density with dimensions of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>L</mi><mn>3</mn></msup><mo>⋅</mo><msup><mi>T</mi><mrow><mi>−</mi><mn>3</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">1 / (L^3 \cdot T^{-3})</annotation></semantics></math>, or <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>3</mn></mrow></msup><mo>⋅</mo><msup><mi>T</mi><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">L^{-3} \cdot T^{3}</annotation></semantics></math>.</p>
<p>Let’s fix this. There is no type synonym for velocity density in <code>dimensional</code>, but we can create one ourselves.</p>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span>type</span> <span>DVelocityCube</span> <span>=</span> <span>DVelocity</span> <span>^</span> <span>Pos3</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span>type</span> <span>DVelocityDensity</span> <span>=</span> <span>Recip</span> <span>DVelocityCube</span> <span>-- dimension</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span>type</span> <span>VelocityDensity</span> <span>=</span> <span>Quantity</span> <span>DVelocityDensity</span> <span>-- quantity</span></span></code></pre></div>
<p>Our final version of <code>maxwellBoltzmannDist</code> becomes:</p>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span>maxwellBoltzmannDist ::</span> <span>Mass</span> <span>Double</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                     <span>-&gt;</span> <span>ThermodynamicTemperature</span> <span>Double</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                     <span>-&gt;</span> <span>Velocity</span> <span>Double</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                     <span>-&gt;</span> <span>VelocityDensity</span> <span>Double</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>maxwellBoltzmannDist mass temp velocity </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span>=</span> raiseToThreeHalfsPower ( mass <span>/</span> (_2 <span>*</span> <span>pi</span> <span>*</span> boltzmannConstant <span>*</span> temp) )</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span>*</span> <span>exp</span> ( <span>negate</span> (mass <span>*</span> velocity <span>^</span> pos2) <span>/</span> (_2 <span>*</span> <span>pi</span> <span>*</span> boltzmannConstant <span>*</span> temp) )</span></code></pre></div>
<p>We can compute the result of <code>maxwellBoltzmannDist</code> in any compatible unit. We will do this for a gas of diatomic nitrogen. In an interactive Haskell session:</p>
<div id="cb11"><pre><code><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>import</span> <span>Numeric.Units.Dimensional.NonSI</span> ( unifiedAtomicMassUnit ) <span>-- unifiedAtomicMassUnit = amu</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>let</span> n2_mass          <span>=</span> <span>2</span>     <span>*~</span> unifiedAtomicMassUnit</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>let</span> room_temperature <span>=</span> <span>300.0</span> <span>*~</span> kelvin</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>let</span> velocity         <span>=</span> <span>400</span>   <span>*~</span> (meter <span>/</span> second)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> maxwellBoltzmannDist n2_mass room_temperature velocity </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span>4.466578950309018e-11</span> m<span>^-</span><span>3</span> s<span>^</span><span>3</span></span></code></pre></div>
<p>We can easily request specific output units using the <a href="https://hackage.haskell.org/package/dimensional-1.6.1/docs/Numeric-Units-Dimensional-Prelude.html#v:-47--126-"><code>(/~)</code></a> operator. In this case, we convert result to (hour / nautical mile)<sup>3</sup>:</p>
<div id="cb12"><pre><code><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>import</span> <span>Numeric.Units.Dimensional.NonSI</span> ( nauticalMile, degreeRankine, knot )</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>let</span> n2_mass          <span>=</span> <span>2.6605E-27</span> <span>*~</span> kilo gram</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>let</span> room_temperature <span>=</span> <span>491.0</span>      <span>*~</span> degreeRankine</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> <span>let</span> velocity         <span>=</span> <span>777</span>        <span>*~</span> knot</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>ghci<span>&gt;</span> (maxwellBoltzmannDist n2_mass room_temperature velocity) <span>/~</span> ((hour <span>/</span> nauticalMile) <span>^</span> pos3)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span>5.041390507268275e-12</span></span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>This was a whirlwind tour of <code>dimensional</code> with a practical example. If this was your first introduction to typed dimensions in Haskell, do not be alarmed – I bounced off of it the first time.</p>
<p>As mentioned, software design is about trade-off. Using <code>dimensional</code> is complex, but it isn’t complicated<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a>; it makes you address the complexity of dimensions and units up-front, rather than hoping for the best. Sometimes this doesn’t make sense, but for critical calculations, there is nothing like typed dimensions.</p>
<p>I am now a <a href="https://github.com/bjornbm/dimensional/">maintainer of <code>dimensional</code> on GitHub</a>, and <strong>I want nothing more than to help people use typed dimensions</strong> (when it makes sense). If you have any feedback, for example missing features or lacking documentation, <a href="https://github.com/bjornbm/dimensional/issues">feel free to raise an issue</a>!</p>
<p><em>Code available in <a href="https://laurentrdc.xyz/files/typed-dimensions/TypedDimensions/Typed.hs">Haskell module</a>.</em></p>

                </div>
            </div>
        </div></div>
  </body>
</html>
