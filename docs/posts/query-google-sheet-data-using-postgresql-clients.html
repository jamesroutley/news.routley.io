<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://roapi.github.io/docs/config/dataset-formats/gsheet.html#example">Original</a>
    <h1>Show HN: Query Google Sheet data using PostgreSQL clients</h1>
    
    <div id="readability-page-1" class="page">
        <!-- Provide site root to javascript -->
        

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        

        <!-- Set the theme before any content is loaded, prevents flash -->
        

        <!-- Hide / unhide sidebar before it is displayed -->
        

        <nav id="sidebar" aria-label="Table of contents">
            
            
        </nav>

        <div id="page-wrapper">

            <div class="page">
                
                
                

                
                
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                

                <div id="content">
                    <main>
                        
<p>To serve a Google spreadsheet as API, you need to gather the following config values:</p>
<ul>
<li>Google spreadsheet URL, usually in the form of <code>https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}#gid={SHEET_ID}</code>.</li>
<li>(Optional) Google spreadsheet sheet title (bottom of the spreadsheet UI).
This is required if <code>SHEET_ID</code> is not specified in URL through <code>#gid</code>.</li>
<li>Google spreadsheet service account secret key.</li>
</ul>
<p>Here are the steps to configure the service account:</p>
<ol>
<li><a href="https://console.developers.google.com/apis/library/sheets.googleapis.com">Activate Google Sheets API</a> in the Google API Console.</li>
<li>Create a service account: <a href="https://console.developers.google.com/apis/api/sheets.googleapis.com/credentials">https://console.developers.google.com/apis/api/sheets.googleapis.com/credentials</a>.</li>
<li>Go into service account setting, click <code>ADD KEY</code> -&gt; <code>Create new key</code>. Then select JSON format
and save it somewhere safe as a file. <img src="https://roapi.github.io/docs/images/gsheet-add-key.png" alt="gsheet-add-key"/></li>
<li>Copy email address for your newly created service account, usually in the format of <code>{ACCOUNT_NAME}@{PROJECT_ID}.iam.gserviceaccount.com</code>. <img src="https://roapi.github.io/docs/images/gsheet-service-account-email.png" alt="gsheet-service-account-email"/></li>
<li>Open the Google spreadsheet that you want to serve, then share it with the newly created service
account using the service account email. <img src="https://roapi.github.io/docs/images/gsheet-share-service-account.png" alt="gsheet-share-service-account"/></li>
</ol>
<p>Now you can configure ROAPI to load the google spreadsheet into a table using:</p>
<pre><code>tables:
  - name: &#34;table_name&#34;
    uri: &#34;https://docs.google.com/spreadsheets/d/1-lc4oij04aXzFSRMwVBLjU76s-K0-s6UPc2biOvtuuU#gid=0&#34;
    option:
      format: &#34;google_spreadsheet&#34;
      application_secret_path: &#34;path/to/service_account_key.json&#34;
      # sheet_title is optional if `#gid` is specified in uri
      sheet_title: &#34;sheet_name_within_google_spreadsheet&#34;
</code></pre>
<p>ROAPI only invokes Google Sheets API during the initial data load, subsequent
query requests are served using in memory data.</p>
<h2 id="example"><a href="#example">Example</a></h2>
<p>Here is what it looks like to serve <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vRodiBkE77d8Y7FLe2BwwNNqy0jc3oSrtsGRrWMXXyAgdl68LxKm_LS0qfMVXa-ioPDP-5jurzKUJ0N/pubhtml">this public google
spreadsheet</a>
with ROAPI.</p>
<p>Start server:</p>
<pre><code>$ roapi -c local.yaml
[2022-05-31T01:07:55Z INFO  roapi::context] loading `uri(https://docs.google.com/spreadsheets/d/1-lc4oij04aXzFSRMwVBLjU76s-K0-s6UPc2biOvtuuU#gid=0)` as table `properties`
[2022-05-31T01:07:56Z INFO  roapi::context] registered `uri(https://docs.google.com/spreadsheets/d/1-lc4oij04aXzFSRMwVBLjU76s-K0-s6UPc2biOvtuuU#gid=0)` as table `properties`
[2022-05-31T01:07:56Z INFO  roapi::startup] ðŸš€ Listening on 127.0.0.1:5432 for Postgres traffic...
[2022-05-31T01:07:56Z INFO  roapi::startup] ðŸš€ Listening on 127.0.0.1:8080 for HTTP traffic...
</code></pre>
<p>Query through <a href="https://roapi.github.io/docs/postgres.html">Postgres wire protocol</a>:</p>
<pre><code>$ psql -h 127.0.0.1
psql (12.10 (Ubuntu 12.10-0ubuntu0.20.04.1), server 13)
WARNING: psql major version 12, server major version 13.
         Some psql features might not work.
Type &#34;help&#34; for help.

houqp=&gt; select &#34;Address&#34;, &#34;Bed&#34;, &#34;Bath&#34;, &#34;Occupied&#34; from properties;
     Address      | Bed | Bath | Occupied
------------------+-----+------+----------
 Bothell, WA      |   3 |    2 | f
 Lynnwood, WA     |   2 |    1 | f
 Kirkland, WA     |   4 |    2 | f
 Kent, WA         |   3 |    2 | f
 Mount Vernon, WA |   2 |    1 | f
 Seattle, WA      |   3 |    1 | f
 Seattle, WA      |   2 |    1 | f
 Shoreline, WA    |   1 |    1 | f
 Bellevue, WA     |   3 |    1 | f
 Renton, WA       |   4 |    2 | f
 Woodinville, WA  |   3 |    3 | f
 Kenmore, WA      |   4 |    3 | f
 Fremont, WA      |   5 |    3 | f
 Redmond, WA      |   2 |    2 | f
 Mill Creek, WA   |   3 |    3 | f
(15 rows)
</code></pre>
<p>Query with aggregation using <a href="https://roapi.github.io/docs/api/query/sql.html">HTTP SQL frontend</a>:</p>
<pre><code>$ curl -s -X POST localhost:8080/api/sql --data-binary @- &lt;&lt;EOF | jq
SELECT DISTINCT(&#34;Landlord&#34;), COUNT(&#34;Address&#34;)
FROM properties
GROUP BY &#34;Landlord&#34;
EOF

[
  {
    &#34;Landlord&#34;: &#34;Carl&#34;,
    &#34;COUNT(properties.Address)&#34;: 3
  },
  {
    &#34;Landlord&#34;: &#34;Roger&#34;,
    &#34;COUNT(properties.Address)&#34;: 3
  },
  {
    &#34;Landlord&#34;: &#34;Mike&#34;,
    &#34;COUNT(properties.Address)&#34;: 4
  },
  {
    &#34;Landlord&#34;: &#34;Sam&#34;,
    &#34;COUNT(properties.Address)&#34;: 2
  },
  {
    &#34;Landlord&#34;: &#34;Daniel&#34;,
    &#34;COUNT(properties.Address)&#34;: 3
  }
]
</code></pre>
<p>Query with filter using <a href="https://roapi.github.io/docs/api/query/graphql.html">HTTP GraphQL frontend</a>:</p>
<pre><code>$ curl -s -X POST localhost:8080/api/graphql --data-binary @- &lt;&lt;EOF | jq
query {
  properties(
    filter: {
      Bed: { gt: 3 }
      Bath: { gte: 3 }
    }
    sort: [
      { field: &#34;Bed&#34;, order: &#34;desc&#34; }
    ]
  ) {
    Address
    Bed
    Bath
    Monthly_Rent
  }
}
EOF
[
  {
    &#34;Address&#34;: &#34;Fremont, WA&#34;,
    &#34;Bed&#34;: 5,
    &#34;Bath&#34;: 3,
    &#34;Monthly_Rent&#34;: &#34;$4,500&#34;
  },
  {
    &#34;Address&#34;: &#34;Kenmore, WA&#34;,
    &#34;Bed&#34;: 4,
    &#34;Bath&#34;: 3,
    &#34;Monthly_Rent&#34;: &#34;$4,000&#34;
  }
]
</code></pre>
<p>Note: when inferring table schema from Google spreadsheets, ROAPI automatically
replaces spaces in column names with <code>_</code>(underscore).</p>

                    </main>

                    <nav aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="https://roapi.github.io/docs/config/dataset-formats/csv.html" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i></i>
                            </a>
                        

                        
                            <a rel="next" href="https://roapi.github.io/docs/config/dataset-formats/ndjson.html" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i></i>
                            </a>
                        

                        
                    </nav>
                </div>
            </div>

            <nav aria-label="Page navigation">
                
                    <a rel="prev" href="https://roapi.github.io/docs/config/dataset-formats/csv.html" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i></i>
                    </a>
                

                
                    <a rel="next" href="https://roapi.github.io/docs/config/dataset-formats/ndjson.html" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        
        

        

        
        
        
        
        

        
        
        

        <!-- Custom JS scripts -->
        

        

    

</div>
  </body>
</html>
