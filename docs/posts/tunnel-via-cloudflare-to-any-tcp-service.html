<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://iq.thc.org/tunnel-via-cloudflare-to-any-tcp-service">Original</a>
    <h1>Tunnel via Cloudflare to any TCP service</h1>
    
    <div id="readability-page-1" class="page"><div><section><div><div id="post-content-parent"><div id="post-content-wrapper"><p>Cloudflare&#39;s cloudflared tunnels are commonly used to &#39;publish&#39; a web server that runs behind a firewall (e.g. making the webserver accessible from the Internet). Cloudflare restricts the traffic to HTTP-style traffic: It won&#39;t allow the publishing of SSHD for example.</p>
<p>This article explains how to &#39;publish&#39; any other service (like SSHD) and make it accessible via the cloudflared tunnel. It does so by adding a <em>WebSocket Proxy</em> on either side of the tunnel.</p>
<p>You need <a target="_blank" href="https://github.com/vi/websocat">websocat</a>, <a target="_blank" href="https://github.com/cloudflare/cloudflared/releases">cloudflared</a> and <a target="_blank" href="https://v2.gost.run/en/">gost</a>.</p>
<h2 id="heading-example-1">Example 1:</h2>
<p>Configure a tunnel to access SSHD on a server that is behind the firewall (via Cloudflare&#39;s cloudflared tunnel).</p>
<p>On the server behind the firewall:</p>
<pre><code>
websocat -E -b ws-l:127.0.0.1:40008 tcp:127.0.0.1:22 &amp;

cloudflared tunnel --url http://localhost:40008 --no-autoupdate
</code></pre>
<p>The CF tunnel will show you an URL similar to this one:</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1682078309773/de6ec474-dfc5-4584-a886-2f749ae29306.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p>On your workstation:</p>
<pre><code>
websocat -E -b tcp-l:127.0.0.1:2222 ws://&lt;YourUrlFromAbove&gt;.trycloudflare.com &amp;

ssh -p 2222 root@127.0.0.1
</code></pre>
<hr/>
<h2 id="heading-example-2">Example 2:</h2>
<p>A more advanced method is to add a Socks5 Proxy to the chain of tunnels. This will allow us to access <strong><em>ANYTHING</em></strong> from our workstation: That&#39;s any host within the LAN and any host on the Internet.</p>
<p>The <a target="_blank" href="https://github.com/ginuerzh/gost/blob/master/README_en.md">Gost</a> tool supports WS and Socks5 and is used instead of <code>websocat</code> and <code>microsocks</code>.</p>
<p>On the server behind the firewall:</p>
<pre><code>gost -L mws://:40009 &amp;
cloudflared tunnel --url http://localhost:40009 --no-autoupdate
</code></pre>
<p>On your workstation:</p>
<pre><code>gost -L :1080 -F <span>&#39;mwss://&lt;YourUrlFromAbove&gt;.trycloudflare.com:443&#39;</span>
</code></pre>
<p>Use some tools via the Socks Tunnel (via Cloudflare/Websocket):</p>
<pre><code>
curl -x socks5h://0 ipinfo.io


<span>echo</span> -e <span>&#34;[ProxyList]\nsocks5 127.0.0.1 1080&#34;</span> &gt;pc.conf

proxychains -f pc.conf -q ssh root@192.168.1.1

proxychains -f pc.conf -q nmap -nF -Pn -sT --open scanme.nmap.org
</code></pre>
<p>Notes:</p>
<ol>
<li><p>Cloudflare&#39;s Free Service <a target="_blank" href="https://developers.cloudflare.com/support/network/using-cloudflare-with-websockets/">limits the number of connections</a>. Consider upgrading.</p>
</li>
<li><p>We use <code>mwss</code> and <code>mws</code> to enable TCP multiplexing (channelling) via a single TCP connection in Gost. All TCP connections will go via a single CF tunnel (and a single Websocket-request).</p>
</li>
<li><p>We use wss (with TLS) on the workstation but just ws (without TLS) on the server. This is because Cloudflare is the Edge-Server and the TLS connection stops there. Cloudflare then re-encrypts the data to send it via Cloudflared to our server. A Cloudflare tunnel is never (!) End-2-End encrypted: Use SSH or other encrypted tools if you do not trust CloudFlare (as they can read your data).</p>
</li>
</ol>
<p>All examples from this article were tested on <a target="_blank" href="https://www.thc.org/segfault">Segfault&#39;s Disposable Root Servers</a>.</p>
<p><em>Thank you to</em> <a target="_blank" href="https://www.qsocket.io"><em>EMX</em></a> <em>for proofreading.</em></p>
<blockquote>
<p>Like to publish an article? Send us what you got. We will review and help you improve your article and then publish it here.</p>
<p>Join us on Telegram: <a target="_blank" href="https://t.me/thcorg">https://t.me/thcorg</a></p>
</blockquote>
</div></div></div></section></div></div>
  </body>
</html>
