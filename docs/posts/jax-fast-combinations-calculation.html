<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/phoenicyan/combinadics">Original</a>
    <h1>Jax: Fast Combinations Calculation</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A fast combinations calculation in jax.</p>
<p dir="auto">Idea of combinadic implementation is from
<a href="https://jamesmccaffrey.wordpress.com/2022/06/28/generating-the-mth-lexicographical-element-of-a-combination-using-the-combinadic" rel="nofollow">https://jamesmccaffrey.wordpress.com/2022/06/28/generating-the-mth-lexicographical-element-of-a-combination-using-the-combinadic</a>
and some useful information can be found here: <a href="https://en.wikipedia.org/wiki/Combinatorial_number_system" rel="nofollow">https://en.wikipedia.org/wiki/Combinatorial_number_system</a>. Below I copied and aggregated some of the details.</p>

<p dir="auto">The following code demostrates the combinations calculation in numpy and via combinadics:</p>
<div dir="auto" data-snippet-clipboard-copy-content="    # setup
    n = 4
    k = 3
    totalcount = math.comb(n, k)

    # numpy
    print(f&#34;Calculate combinations \&#34;{n} choose {k}\&#34; in numpy:&#34;)
    for comb in itertools.combinations(np.arange(start=0, stop=n, dtype=jnp.int32), k):
        print(comb)

    # combinadics
    print(&#34;Calculate via combinadics:&#34;)
    actual = n-1 - calculateMth(n, k, totalcount-1 - jnp.arange(start=0, stop=n, dtype=jnp.int32),)
    for comb in actual:
        print(comb)"><pre>    <span># setup</span>
    <span>n</span> <span>=</span> <span>4</span>
    <span>k</span> <span>=</span> <span>3</span>
    <span>totalcount</span> <span>=</span> <span>math</span>.<span>comb</span>(<span>n</span>, <span>k</span>)

    <span># numpy</span>
    <span>print</span>(<span>f&#34;Calculate combinations <span>\&#34;</span><span><span>{</span><span>n</span><span>}</span></span> choose <span><span>{</span><span>k</span><span>}</span></span><span>\&#34;</span> in numpy:&#34;</span>)
    <span>for</span> <span>comb</span> <span>in</span> <span>itertools</span>.<span>combinations</span>(<span>np</span>.<span>arange</span>(<span>start</span><span>=</span><span>0</span>, <span>stop</span><span>=</span><span>n</span>, <span>dtype</span><span>=</span><span>jnp</span>.<span>int32</span>), <span>k</span>):
        <span>print</span>(<span>comb</span>)

    <span># combinadics</span>
    <span>print</span>(<span>&#34;Calculate via combinadics:&#34;</span>)
    <span>actual</span> <span>=</span> <span>n</span><span>-</span><span>1</span> <span>-</span> <span>calculateMth</span>(<span>n</span>, <span>k</span>, <span>totalcount</span><span>-</span><span>1</span> <span>-</span> <span>jnp</span>.<span>arange</span>(<span>start</span><span>=</span><span>0</span>, <span>stop</span><span>=</span><span>n</span>, <span>dtype</span><span>=</span><span>jnp</span>.<span>int32</span>),)
    <span>for</span> <span>comb</span> <span>in</span> <span>actual</span>:
        <span>print</span>(<span>comb</span>)</pre></div>
<p dir="auto">And the output from execution of the code is:</p>
<div data-snippet-clipboard-copy-content="Calculate combinations &#34;4 choose 3&#34; in numpy:
(0, 1, 2)
(0, 1, 3)
(0, 2, 3)
(1, 2, 3)
Calculate via combinadics:
[0 1 2]
[0 1 3]
[0 2 3]
[1 2 3]"><pre><code>Calculate combinations &#34;4 choose 3&#34; in numpy:
(0, 1, 2)
(0, 1, 3)
(0, 2, 3)
(1, 2, 3)
Calculate via combinadics:
[0 1 2]
[0 1 3]
[0 2 3]
[1 2 3]
</code></pre></div>

<p dir="auto">You can think of a combinadic as an alternate representation of an integer. Consider the integer <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$859$</math-renderer>. It can be represented as the sum of powers of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$10$</math-renderer> as</p>
<p dir="auto"><math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$$
859 = 8 \times 10^2 + 5 \times 10^1 + 9 \times 10^0
$$</math-renderer></p>



<p dir="auto">The combinadic of an integer is its representation based on a variable base corresponding to the values of the binomial coefficient <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{n}{k}$</math-renderer>. For example if (<math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n=7, k=4$</math-renderer>) then the integer <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$27$</math-renderer> can be represented as</p>
<p dir="auto"><math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$$
27 = \dbinom{{6}}{4} + \dbinom{5}{3} + \dbinom{2}{2} + \dbinom{1}{1} = 15 + 10 + 1 + 1
$$</math-renderer></p>



<p dir="auto">With (<math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n=7, k=4$</math-renderer>), any number <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m$</math-renderer> between <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$0$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$34$</math-renderer> (the total number of combination elements for <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$k$</math-renderer>) can be uniquely represented as</p>
<p dir="auto"><math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$$
m = \dbinom{c_1}{4} + \dbinom{c_2}{3}+\dbinom{c_3}{2} + \dbinom{c_4}{1}
$$</math-renderer></p>



<p dir="auto">where <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n &amp;gt; c_1 &amp;gt; c_2 &amp;gt; c_3 &amp;gt; c_4$</math-renderer>. Notice that <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n$</math-renderer> is analogous to the base because all combinadic digits are between <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$0$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n-1$</math-renderer> (just like all digits in ordinary base <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$10$</math-renderer> are between <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$0$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$9$</math-renderer>). The value of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$k$</math-renderer> determines the number of terms in the combinadic.</p>
<hr/>
<p dir="auto">Here’s an example of how a combinadic is calculated. Suppose you are working with (<math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n=7, k=4$</math-renderer>) combinations, and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m = 8$</math-renderer>. You want the combinadic of 8 because, as it turns out, the combinadic can be converted to combination element [8].</p>
<p dir="auto">The combinadic of 8 will have the form:</p>
<p dir="auto"><math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$$
8 = \dbinom{c_1}{4} + \dbinom{c_2}{3}+\dbinom{c_3}{2} + \dbinom{c_4}{1}
$$</math-renderer></p>
<p dir="auto">The first step is to determine the value of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_1$</math-renderer>. We try <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_1$</math-renderer> = <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$6$</math-renderer> (the largest number less than <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n = 7$</math-renderer>) and get <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{6}{4} = 15$</math-renderer>, which is too large because we’re over <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$8$</math-renderer>. Next, we try <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_1 = 5$</math-renderer> and get <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{5}{4} = 5$</math-renderer>, which is less than <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$8$</math-renderer>, so bingo, <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_1 = 5$</math-renderer>.</p>
<p dir="auto">At this point we have used up <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$5$</math-renderer> of the original number <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m=8$</math-renderer> so we have <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$3$</math-renderer> left to account for. To determine the value of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_2$</math-renderer>, we try <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$4$</math-renderer> (the largest number less than the <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$5$</math-renderer> we got for <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_1$</math-renderer>), but get <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{4}{3} = 4$</math-renderer>, which is barely too large. Working down we get to <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_2 = 3$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{3}{3} = 1$</math-renderer>, so <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_2 = 3$</math-renderer>.</p>
<p dir="auto">We used up <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$1$</math-renderer> of the remaining <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$3$</math-renderer> we had to account for, so we have <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$2$</math-renderer> left to consume. Using the same ideas we’ll get <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_3 = 2$</math-renderer> with <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{2}{2} = 1$</math-renderer>, so we have <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$1$</math-renderer> left to account for. And then we’ll find that <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c_4 = 1$</math-renderer> because <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{1}{1} = 1$</math-renderer>. Putting our four <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$c$</math-renderer> values together we conclude that the combinadic of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m=8$</math-renderer> for <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$(n=7, k=4)$</math-renderer> combinations is ( <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$5$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$3$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$2$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$1$</math-renderer> ).</p>
<hr/>
<p dir="auto">Suppose <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$(n=7, k=4)$</math-renderer>. There are <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$\dbinom{7}{4} = 35$</math-renderer> combination elements, indexed from <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$0$</math-renderer> to <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$34$</math-renderer>. The <strong>dual</strong> lexicographic indexes are the ones on opposite ends so to speak: indexes <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$0$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$34$</math-renderer> are duals, indexes <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$1$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$33$</math-renderer> are duals, indexes <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$2$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$32$</math-renderer> are duals, and so forth. Notice that each pair of dual indexes sum to <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$34$</math-renderer>, so if you know any index it is easy to find its dual.</p>
<p dir="auto">Now, continuing the first example above for the number <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m=27$</math-renderer> with <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$(n=7, k=4)$</math-renderer> suppose you are able to find the combinadic of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$27$</math-renderer> and get ( <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$6$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$5$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$2$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$1$</math-renderer> ). Now suppose you subtract each digit in the combinadic from <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n-1 = 6$</math-renderer> and get ( <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$0$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$1$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$4$</math-renderer> <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$5$</math-renderer> ). Amazingly, this gives you the combination element <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$[7]$</math-renderer>, the dual index of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$27$</math-renderer>. Putting these ideas together you have an elegant algorithm to determine an arbitrarily specified combination element for given <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n$</math-renderer> and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$k$</math-renderer> values. To find the combination element for index <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m$</math-renderer>, first find its dual and call it <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$x$</math-renderer>. Next, find the combinadic of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$x$</math-renderer>. Then subtract each digit of the combinadic of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$x$</math-renderer> from <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$n-1$</math-renderer> and the result is the mth lexicographic combination element.</p>
<p dir="auto">The table below shows the relationships among <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m$</math-renderer>, the dual of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m$</math-renderer>, combination element <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$[m]$</math-renderer>, the combinadic of <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$m$</math-renderer>, and <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$(n-1) – c_i$</math-renderer> for <math-renderer data-run-id="76bc7382273ca11319e3ca8924d54147">$(n=5, k=3)$</math-renderer>.</p>
<div data-snippet-clipboard-copy-content="m dual(m) Element(m) combinadic(m) (n-1) - ci
==============================================
[0]  9    { 0 1 2 }   ( 2 1 0 )     ( 2 3 4 )
[1]  8    { 0 1 3 }   ( 3 1 0 )     ( 1 3 4 )
[2]  7    { 0 1 4 }   ( 3 2 0 )     ( 1 2 4 )
[3]  6    { 0 2 3 }   ( 3 2 1 )     ( 1 2 3 )
[4]  5    { 0 2 4 }   ( 4 1 0 )     ( 0 3 4 )
[5]  4    { 0 3 4 }   ( 4 2 0 )     ( 0 2 4 )
[6]  3    { 1 2 3 }   ( 4 2 1 )     ( 0 2 3 )
[7]  2    { 1 2 4 }   ( 4 3 0 )     ( 0 1 4 )
[8]  1    { 1 3 4 }   ( 4 3 1 )     ( 0 1 3 )
[9]  0    { 2 3 4 }   ( 4 3 2 )     ( 0 1 2 )"><pre><code>m dual(m) Element(m) combinadic(m) (n-1) - ci
==============================================
[0]  9    { 0 1 2 }   ( 2 1 0 )     ( 2 3 4 )
[1]  8    { 0 1 3 }   ( 3 1 0 )     ( 1 3 4 )
[2]  7    { 0 1 4 }   ( 3 2 0 )     ( 1 2 4 )
[3]  6    { 0 2 3 }   ( 3 2 1 )     ( 1 2 3 )
[4]  5    { 0 2 4 }   ( 4 1 0 )     ( 0 3 4 )
[5]  4    { 0 3 4 }   ( 4 2 0 )     ( 0 2 4 )
[6]  3    { 1 2 3 }   ( 4 2 1 )     ( 0 2 3 )
[7]  2    { 1 2 4 }   ( 4 3 0 )     ( 0 1 4 )
[8]  1    { 1 3 4 }   ( 4 3 1 )     ( 0 1 3 )
[9]  0    { 2 3 4 }   ( 4 3 2 )     ( 0 1 2 )
</code></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Limitations of current implementation</h2><a id="user-content-limitations-of-current-implementation" aria-label="Permalink: Limitations of current implementation" href="#limitations-of-current-implementation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">64-bit numbers</p>
</article></div></div>
  </body>
</html>
