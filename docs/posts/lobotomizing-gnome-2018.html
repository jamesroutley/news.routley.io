<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eklitzke.org/lobotomizing-gnome">Original</a>
    <h1>Lobotomizing Gnome (2018)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
<p>I have pretty basic needs from my desktop. I do 99% of my work using just three
programs: a terminal emulator, Emacs, and Firefox. I don&#39;t want a lot of bells
and whistles in my desktop, and I really just want it to get out of the way so I
can do my work.</p>
<p>But just because my needs are basic doesn&#39;t mean that I want a 1990&#39;s window
manager experience. I want good text rendering and windows and buttons with
rounded corners. I want my laptop to work correctly when connecting it to
external displays or projectors without a lot of futzing around. I want vsync to
work with my monitor out of the box, I want to be able to watch video without
tearing, and I want a desktop that has first class support for high-DPI
displays. I also want to have some basic integration with the other system
features provided by my distro, which increasingly means high-quality
integration with NetworkManager and different systemd components. I want to get
integrated notifications when a program segfaults on my computer or in case
there&#39;s an SELinux AVC denial.</p>
<p>In my opinion, in these areas GNOME is far ahead of everything else. The stock
GNOME configuration is beautiful but minimal---I get a discreet black bar across
the top of my screen that shows the time and date, and lets me control the
fundamentals like network access. I think that GNOME Shell is the most
attractive and useful window manager for any operating system out there. And
GNOME has <em>really good</em> integration with the other parts of my system, which
makes sense because it&#39;s the default desktop environment on my distro (Fedora)
and most others, including Debian and Ubuntu. GNOME is also light-years ahead of
everything else in terms of Wayland support. Fedora has been shipping Wayland as
the default GNOME display backend since Fedora 25 (2016), and it works
incredibly well. The most compelling user-visible feature that has come out of
this is GNOME&#39;s &#34;fractional scaling&#34; feature, which is a quantum leap in terms
of how content is scaled on high-DPI screens.</p>
<p>But I&#39;ll be honest: GNOME is huge and kind of bloated, and it&#39;s hard to disable
various unwanted components. GNOME Shell is amazing, but a lot of the other
components of GNOME are simply unwanted. This is what turns a lot of power users
away from GNOME, which I think is a shame given all of the other amazing things
about GNOME. While you won&#39;t find these instructions in the GNOME manuals, if
you know what you&#39;re doing modern GNOME releases make it very easy to lobotomize
a lot of the unneeded and unwanted features.</p>
<h2>Configuration With <code>dconf</code></h2>
<p>The first step in improving the GNOME user experience is toggling basic features
on or off. You can do this either by clicking around in the GUI, or using the
<code>dconf</code> command line tool. One of the interesting things about GNOME is that it
has a lot of hidden options that either not at all exposed in the GUI, or only
accessible through a tool like <code>gnome-tweaks</code>. But if you know what you&#39;re doing
you can change a lot of GNOME behavior.</p>
<p>Most people are already in the habit of keeping their dot files in a git repo
somewhere. I recently took this up a notch, and I now maintain my whole desktop
configuration (including my dot files) using
<a href="https://www.ansible.com/">Ansible</a>. To illustrate my GNOME configuration I&#39;ll
be posting snippets from current Ansible configuration. If you&#39;re not familiar
with Ansible don&#39;t worry: it&#39;s just YAML, and can easily be translated into
command line invocations.</p>
<p>Here&#39;s what my GNOME <code>dconf</code> settings look like in Ansible:</p>
<pre><code>- name: update gnome dconf settings
  dconf:
    key: &#34;{{item.key}}&#34;
    value: &#34;{{item.value}}&#34;
  loop:
    - {key: &#39;/org/gnome/desktop/input-sources/xkb-options&#39;, value: &#34;[&#39;caps:ctrl_modifier&#39;]&#34;}
    - {key: &#39;/org/gnome/desktop/interface/clock-show-date&#39;, value: &#39;true&#39;}
    - {key: &#39;/org/gnome/desktop/interface/cursor-blink&#39;, value: &#39;false&#39;}
    - {key: &#39;/org/gnome/desktop/interface/gtk-theme&#39;, value: &#34;&#39;Adwaita-dark&#39;&#34;}
    - {key: &#39;/org/gnome/desktop/privacy/old-files-age&#39;, value: &#39;uint32 7&#39;}
    - {key: &#39;/org/gnome/desktop/privacy/remove-old-trash-files&#39;, value: &#39;true&#39;}
    - {key: &#39;/org/gnome/desktop/privacy/report-technical-problems&#39;, value: &#39;false&#39;}
    - {key: &#39;/org/gnome/desktop/search-providers/disable-external&#39;, value: &#39;true&#39;}
    - {key: &#39;/org/gnome/desktop/wm/preferences/audible-bell&#39;, value: &#39;false&#39;}
    - {key: &#39;/org/gnome/desktop/wm/preferences/focus-mode&#39;, value: &#34;&#39;sloppy&#39;&#34;}
    - {key: &#39;/org/gnome/settings-daemon/plugins/color/night-light-enabled&#39;, value: &#39;true&#39;}
    - {key: &#39;/org/gnome/settings-daemon/plugins/xsettings/antialiasing&#39;, value: &#34;&#39;rgba&#39;&#34;}
    - {key: &#39;/org/gnome/shell/disable-user-extensions&#39;, value: &#39;true&#39;}
    - {key: &#39;/org/gnome/software/allow-updates&#39;, value: &#39;false&#39;}
    - {key: &#39;/org/gnome/software/download-updates&#39;, value: &#39;false&#39;}
    - {key: &#39;/org/gnome/terminal/legacy/default-show-menubar&#39;, value: &#39;false&#39;}
</code></pre>
<p>You can probably guess what most of these options do based on the key name. A
lot of them turn off various options, or change basic features of the window
manager (such as setting &#34;sloppy&#34; focus, a must-have for me).</p>
<p>There&#39;s one I want to call out in particular though: I set
<code>/org/gnome/shell/disable-user-extensions</code> to <code>false</code>, which completely disables
the user extensions feature of GNOME. User extensions are a mechanism that allow
users to write GNOME extensions in Javascript, similar to how Chrome and Firefox
extensions work. In my opinion this idea has dubious merit, and my personal
feeling is the less Javascript in my life the better. I felt somewhat vindicated
about this decision during recent
<a href="https://phoronix.com/scan.php?page=news_item&amp;px=GNOME-Shell-Memory-Leak-Fix">coverage</a>
of a memory leak in GNOME Shell. The underlying issue was related to the
Javascript garbage collector in GNOME Shell not collecting object references in
a timely manner. I&#39;m not sure that disabling user extensions actually disables
the Javascript engine completely, but it definitely minimizes it to the least
possible scope.</p>
<p>You might wonder how you&#39;re actually supposed to find these options in the first
place---how are you supposed to know what keys are available, and what values
they take? In practice I found most of these in a kind of hacky way. The <code>dconf</code>
command lets you dump the entire database using <code>dconf dump /</code>. So what I did to
find most of these options was some process kind of like the following:</p>
<pre><code># Get the initial dconf state.
$ dconf dump / &gt;a

# Click around in the GUI, change things in gnome-tweaks, etc.

# Dump the final dconf state.
$ dconf dump / &gt;b

# Manually look at the diff of the two states.
$ diff -u a b
</code></pre>
<p>This is simple and effective, and just takes a minute or so of work. The more
robust (but much more labor intensive) way to do this is to look at the GNOME
settings schemas. GNOME packages install files ending in a <code>.gschema.xml</code>
extension, which are XML descriptions of all of the possible options supported
by the application, a description of what the options do, and their default
values. In principle you could discover all of these options by digging around
in <code>/usr/share/glib-2.0/schemas</code> and reading a bunch of XML schema descriptions.
In practice I do this very rarely, really only when if I need to read the
complete documentation for an option.</p>
<h2>Removing Unneeded Components</h2>
<p>GNOME bundles a lot of components that I find to be really annoying and
unwelcome. These are the biggest offenders:</p>
<ul>
<li><p><a href="https://wiki.gnome.org/Projects/Tracker/">Tracker</a> is a file daemon that is
supposed to work like Spotlight on macOS. I don&#39;t want this. Between <code>find</code>
and <code>locate</code> I can find all of my files quickly. I don&#39;t need yet another
thing trying to index my files.</p>
</li>
<li><p><a href="https://wiki.gnome.org/Apps/Evolution">Evolution</a> is the standard GNOME
email application, which I don&#39;t want to use. If Evolution was just an email
program I could ignore that would be fine. Unfortunately, Evolution evolved
into a weird half-baked clone of Microsoft Exchange complete with contact
integration, calendar capabilities, and a host of other office productivity
features that are not useful to me. Evolution provides a component called
<code>evolution-data-server</code> that is a daemon that ties these things together.</p>
</li>
<li><p><a href="https://wiki.gnome.org/Projects/GnomeOnlineAccounts">GNOME Online Accounts</a>
is a feature that lets you connect your GNOME account to things like your
Google or Facebook login. The idea is supposed to be that you can connect
things like your Google calendar and email to the GNOME calendar and
Evolution. It&#39;s a cool idea, but I&#39;m not comfortable with the idea of giving
my online credentials to a bundle of tens or hundreds of thousands of lines
of hand-written C code with manual memory management.</p>
</li>
<li><p><a href="https://wiki.gnome.org/Apps/Software">GNOME Software</a> is this weird app
store that I don&#39;t care to use. It always gives me notifications about GNOME
updates that don&#39;t actually correlate with updates in my distro package
manager. The <code>dconf</code> configuration I showed above will actually tell GNOME
Software not to do this, but I don&#39;t really want GNOME Software running at
all.</p>
</li>
</ul>
<p>It turns out that you can remove a <em>lot</em> of these components without breaking
anything. I remove as much of these as possible, as well as a number of programs
that I know I don&#39;t plan on using. The following list is specific to Fedora 28,
but shows what I remove:</p>
<pre><code># remove unwanted gnome packages
- name: dnf remove gnome bloat
  dnf:
    name:
      - cheese
      - evolution
      - evolution-ews
      - evolution-help
      - gfbgraph
      - gnome-boxes
      - gnome-calendar
      - gnome-contacts
      - gnome-dictionary
      - gnome-documents
      - gnome-getting-started-docs
      - gnome-initial-setup
      - gnome-maps
      - gnome-online-miners
      - gnome-photos
      - gnome-software
      - gnome-user-docs
      - gnome-user-share
      - gnome-video-effects
      - gnome-weather
      - simple-scan
      - totem
      - tracker-miners
      - yelp
    state: absent
</code></pre>
<p>Some of these are harmless programs that don&#39;t actually install session daemons,
but are also programs I don&#39;t plan on using. In other cases (e.g.
<code>gnome-software</code>) uninstalling the program actually removes daemons that are run
by default in the session, so removing those components actually causes less
programs to run and waste memory.</p>
<p>They key thing here is to make sure you don&#39;t remove dependencies of any of the
core components, which includes <code>gnome-shell</code> but also some other programs like
<code>nautilus</code>. To double check that I didn&#39;t actually break anything, I also have
the following stanza in my config. This is just a sanity check to make sure that
nothing critical was accidentally removed.</p>
<pre><code># double-check that we still have the basics
- name: ensure core gnome packages are installed
  dnf:
    name:
      - eog
      - evince
      - evolution-data-server
      - flatpak
      - gdm
      - gnome-keyring
      - gnome-menus
      - gnome-screenshot
      - gnome-shell
      - gnome-terminal
      - gnome-tweaks
      - nautilus
      - redhat-menus
    state: present
</code></pre>
<p>I&#39;m removing a lot of stuff here, including some things you might want to keep.
So look at the list for yourself and apply caution before removing anything.
After removing these packages there are still a few annoying components like
<code>evolution-data-server</code> and <code>tracker</code> that still remain because they can&#39;t be
completely uninstalled without breaking critical components. But they can still
be disabled in user sessions, as I&#39;ll explain below.</p>
<h2>Disabling <code>evolution-data-server</code>, Tracker, and other bloat</h2>
<p>GNOME used to have a horribly complicated system that was used to manage start
user session services, and in the past it was very difficult or impossible to
disable certain components. As part of the Wayland effort, GNOME moved to
managing user services using systemd. This is <em>really awesome</em> because it means
you can control GNOME startup services using <code>systemctl</code> just like regular
system services.</p>
<p>On Wayland GNOME services run as part of your systemd user session. To see these
services, use one of the following commands:</p>
<pre><code># Show running user services.
$ systemctl --user status

# Show all user units and their status.
$ systemctl --user list-unit-files
</code></pre>
<p>From these commands I identified various services I want to disable. The trick
to disabling these is to use the <code>systemctl --user mask</code> command, which inhibits
the system installed service units from running. In theory masking services
could cause problems, but at least for the set presented here I haven&#39;t observed
any issues.</p>
<p>Here&#39;s my Ansible code:</p>
<pre><code>- name: mask unwanted gnome services
  systemd:
    name: &#34;{{item}}&#34;
    user: yes
    masked: yes
    state: stopped
  loop:
    - evolution-addressbook-factory.service
    - evolution-calendar-factory.service
    - evolution-source-registry.service
    - gvfs-goa-volume-monitor.service
    - tracker-store.service
</code></pre>
<p>This list lobotomizes <code>evolution-data-server</code>, GNOME Online Accounts, and
Tracker. I also have an Ansible command to ensure that the tracker database is
completely removed from my system:</p>
<pre><code>- name: remove tracker databases
  file:
    name: ~/.cache/tracker
    state: absent
</code></pre>
<p>I&#39;ll note that even after removing these services there are still a lot of GNOME
user services running in my session. If you wanted to you could mask a lot more
services. In general the approach I take is to only mask services whose behavior
I understand. Most of the remaining services in my GNOME session are daemons
that use very little memory and zero CPU, so I don&#39;t mind keeping them around.</p>
<h2>Firefox/GNOME Integration</h2>
<p>I version control my Firefox preferences using Firefox&#39;s obscure
<a href="http://kb.mozillazine.org/User.js_file">user.js</a> feature, which essentially
lets you put <code>about:config</code> preferences in a Javascript file. I have a fairly
extensive user.js file that is a relaxed version of options suggested by
<a href="https://github.com/pyllyukko/user.js">pyllyukko/user.js</a>, which I might write
about in more detail another time. Two of the options I set in this file are
specific to GNOME, so I&#39;ll cover them here.</p>
<p>The <a href="https://extensions.gnome.org/">GNOME Extensions</a> site lets you install
GNOME extensions from Firefox. This is done using a native plugin, meaning that
unlike normal extensions it runs in a privileged context that allows it to
interact with GNOME. Since I have user extensions disabled anyway this serves no
purpose, and could possibly do nasty things if a security flaw is found in it
later. Therefore I disable this plugin:</p>
<pre><code>// Disable GNOME browser plugin.
user_pref(&#34;plugin.state.libgnome-shell-browser-plugin&#34;, 0);
</code></pre>
<p>The second option is related to a Firefox bug (present as of Firefox 60.0)
related to GNOME 3.28 when using the Adwaita dark theme. When using this theme
Firefox will render certain widgets/text areas with inverted colors. This is
more than just strange looking: in some cases it can cause things to be
completely unreadable (e.g. a white text color can get applied to text in a
white text area). This can be fixed by forcing Firefox to render widgets use the
Adwaita light theme:</p>
<pre><code>// Force Adwaita light theme.
user_pref(&#34;widget.content.gtk-theme-override&#34;, &#34;Adwaita:light&#34;);
</code></pre>
<h2>Parting Thoughts</h2>
<p>The configuration listed above is the accumulation of a few years of efforts for
me. Things change from release to release, and therefore I revisit things from
time to time. Generally though I&#39;m very happy with the direction GNOME has been
doing, and it&#39;s a much more pleasant experience dealing with certain aspects of
it today than it was a few years ago. I hope the information presented here is
useful, and I hope to see more great things from the GNOME project in the
future.</p>
</div></div>
  </body>
</html>
