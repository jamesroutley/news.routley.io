<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://spritely.institute/news/scheme-wireworld-in-browser.html">Original</a>
    <h1>Scheme in the Browser: A Hoot of a Tale</h1>
    
    <div id="readability-page-1" class="page"><div><p><img src="https://spritely.institute/static/images/blog/scheme-wireworld.gif" alt="XOR gate in Scheme Wireworld"/></p><p>Hey there, it’s been awhile!  We’re back to share some more exciting
news about <a href="https://gitlab.com/spritely/guile-hoot">Guile Hoot</a>, a
WebAssembly toolchain and Scheme→WASM compiler.  In <a href="https://spritely.institute/news/hoot-wireworld-live-in-browser.html">our last
post</a> we demonstrated that
the Guile Hoot toolchain can be used to assemble programs written in
WebAssembly Text (WAT) format, which allowed us to develop for the
WASM-4 fantasy console.  That was pretty cool, of course, but our goal
is to compile Scheme programs (of the
<a href="https://small.r7rs.org/attachment/r7rs.pdf">R7RS-small</a> dialect, for
now) to WASM.  We are getting ready for our first release, and we’re
happy to report that we’ve made excellent progress!  We can now
demonstrate the Hoot compiler working end-to-end.</p><p>Before we get to the demo, let’s go over what makes Hoot special.
Hoot differs from most WASM compiler projects in some notable ways:</p><ul><li><strong>Self-contained toolchain</strong>: No emscripten, binaryen, wabt, etc.</li><li><strong>GC reference type usage</strong>: The host provides the garbage
collector.</li><li><strong>Small programs produce small binaries</strong>: Kilobytes, not megabytes.</li><li><strong>Full development environment</strong>: Compile and run WASM binaries
without leaving Guile.</li></ul><h3>Self-contained toolchain</h3><p>The Hoot toolchain has been written from the ground up to be
self-contained with no external dependencies required (aside from
Guile, of course.)  This gives us a lot of flexibility and control
over the entire compilation process.  The toolchain includes:</p><ul><li><strong>WAT parser</strong>: Converts WAT to WASM.  Both folded and unfolded
forms are supported.</li><li><strong>Assembler</strong>: Generates WASM binaries.</li><li><strong>Binary parser</strong>: Converts WASM binaries to an internal WASM data
structure.</li><li><strong>Disassembler</strong>: Converts WASM to WAT.</li><li><strong>Linker</strong>: Composes WASM modules with a standard libary (for
example), adding in only what is actually used.</li><li><strong>Interpreter</strong>: Validates and evaluates WASM without having to jump
into the web browser.</li></ul><p>All of these tools are available as a Scheme library that could be
used to automate other WASM targeted build workflows.</p><h3>GC reference types</h3><p>In WASM 1.0, if a language implementation needed a garbage collector
then it had to bring its own built on top of linear memory.  There are
many drawbacks to this approach:</p><ul><li><strong>Large binaries</strong>: A whole GC needs to be shipped along with the
program.</li><li><strong>Stop the world</strong>: Parallelism and concurrency are limited in WASM
right now, so GC performance suffers.</li><li><strong>Collectable confusion</strong>: How do you know when references to your
heap objects are collectable if they’ve been passed to JavaScript or
other WASM modules?  It’s a heap of trouble.</li></ul><p>In other words, you had to ship a <em>bad</em> garbage collector when there
is a battle tested, high performance, production garbage collector
sitting right there in the browser.  Check out Andy Wingo’s excellent
BOB 2023 talk (in
<a href="https://wingolog.org/archives/2023/03/20/a-world-to-win-webassembly-for-the-rest-of-us">text</a>
or <a href="https://www.youtube.com/watch?v=lUCegCa7A08">video</a> form) for more
detailed information about the problems with GC in WASM 1.0.  (Andy is
the <a href="https://spritely.institute/news/andy-wingo-leads-g2W.html">lead engineer</a> for the Hoot
project.)</p><p>Thankfully, WASM GC has added the ability to allocate heap values that
are managed by the host.  Hoot is currently one of the few dynamic
language implementations that makes use of GC reference types.  We
hope that by sharing our work and our experience we can help other
dynamic languages find their way into web browsers, too.</p><p>Hoot is also taking advantage of another recent addition to WASM: tail
calls.  Loops are expressed as recursive function calls in Scheme, so
having a tail call feature available simplifies our implementation
effort.  We don’t have to wait long to use these features, either.
Production versions of WASM GC and tail calls are already shipping in
bleeding edge versions of browsers and will become available to all
users of the web soon.</p><h3>Small programs produce small binaries</h3><p>We made the choice when starting this project <em>not to</em> compile Guile’s
C runtime to WASM using emscripten.  While it would have been
feasible, the resulting binaries would have been quite large, among
other things.  We did not want the end result of this project to be a
multiple megabyte binary for “Hello, world.”  Instead, we’ve taken the
approach of writing a dedicated compiler backend for Guile with some
handwritten WASM providing primitive functionality and calling out to
imported host functions when necessary.  Programs compiled with Hoot
include only the parts of the standard library that they rely upon.
As mentioned earlier, WASM GC obviates the need to link in an entire
garbage collector.  For these reasons, Hoot binaries tend to be much
smaller than the output of most other compilers.  Small programs
produce binaries measured in kilobytes, not megabytes.</p><h3>Full development environment</h3><p>Hoot includes an embedded WASM interpreter that makes it possible to
run WASM directly within the Guile process being used for development.
Since the toolchain is also readily available as a set of Scheme
modules, you can compile and test out programs (either Scheme programs
or hand-crafted WAT) from the comfort of the Guile REPL.  There is
also a set of REPL tools to make inspecting and debugging WASM easier.
Keep reading for a practical demonstration of the development
workflow.</p><p>OK, onto Wireworld!</p><h3>Wireworld part 1: Scheme</h3><p>To show off the compiler, we decided to revisit our favorite cellular
automaton: Wireworld. Check out <a href="https://spritely.institute/news/hoot-wireworld-live-in-browser.html">our last
post</a> to learn more about
what Wireworld is and how we used Hoot to build a pure WASM version of
it.  This time, instead of writing several hundred lines of WAT, we
wrote about 70 lines of Scheme:</p><pre><code><span>(</span><span>let</span> <span>(</span><span>(</span><span>grid-size</span> <span>40</span><span>)</span>
      <span>(</span><span>empty</span> <span>0</span><span>)</span>
      <span>(</span><span>cu</span> <span>1</span><span>)</span>           <span>(</span><span>ehead</span> <span>2</span><span>)</span>        <span>(</span><span>etail</span> <span>3</span><span>)</span><span>)</span>   <span>(</span><span>define</span> <span>(</span><span>make-grid</span><span>)</span>
    <span>(</span><span>make-bytevector</span> <span>(</span><span>*</span> <span>grid-size</span> <span>grid-size</span><span>)</span> <span>0</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>grid-ref</span> <span>grid</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>bytevector-u8-ref</span> <span>grid</span> <span>(</span><span>+</span> <span>(</span><span>*</span> <span>y</span> <span>grid-size</span><span>)</span> <span>x</span><span>)</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>grid-ref/wrap</span> <span>grid</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>bytevector-u8-ref</span> <span>grid</span> <span>(</span><span>+</span> <span>(</span><span>*</span> <span>(</span><span>modulo</span> <span>y</span> <span>grid-size</span><span>)</span> <span>grid-size</span><span>)</span>
                               <span>(</span><span>modulo</span> <span>x</span> <span>grid-size</span><span>)</span><span>)</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>grid-set!</span> <span>grid</span> <span>x</span> <span>y</span> <span>t</span><span>)</span>
    <span>(</span><span>bytevector-u8-set!</span> <span>grid</span> <span>(</span><span>+</span> <span>(</span><span>*</span> <span>y</span> <span>grid-size</span><span>)</span> <span>x</span><span>)</span> <span>t</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>neighbors</span> <span>grid</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>define</span> <span>(</span><span>check</span> <span>x</span> <span>y</span><span>)</span>
      <span>(</span><span>if</span> <span>(</span><span>=</span> <span>(</span><span>grid-ref/wrap</span> <span>grid</span> <span>x</span> <span>y</span><span>)</span> <span>ehead</span><span>)</span> <span>1</span> <span>0</span><span>)</span><span>)</span>
    <span>(</span><span>+</span> <span>(</span><span>check</span> <span>(</span><span>-</span> <span>x</span> <span>1</span><span>)</span> <span>(</span><span>-</span> <span>y</span> <span>1</span><span>)</span><span>)</span>
       <span>(</span><span>check</span> <span>x</span> <span>(</span><span>-</span> <span>y</span> <span>1</span><span>)</span><span>)</span>
       <span>(</span><span>check</span> <span>(</span><span>+</span> <span>x</span> <span>1</span><span>)</span> <span>(</span><span>-</span> <span>y</span> <span>1</span><span>)</span><span>)</span>
       <span>(</span><span>check</span> <span>(</span><span>+</span> <span>x</span> <span>1</span><span>)</span> <span>y</span><span>)</span>
       <span>(</span><span>check</span> <span>(</span><span>+</span> <span>x</span> <span>1</span><span>)</span> <span>(</span><span>+</span> <span>y</span> <span>1</span><span>)</span><span>)</span>
       <span>(</span><span>check</span> <span>x</span> <span>(</span><span>+</span> <span>y</span> <span>1</span><span>)</span><span>)</span>
       <span>(</span><span>check</span> <span>(</span><span>-</span> <span>x</span> <span>1</span><span>)</span> <span>(</span><span>+</span> <span>y</span> <span>1</span><span>)</span><span>)</span>
       <span>(</span><span>check</span> <span>(</span><span>-</span> <span>x</span> <span>1</span><span>)</span> <span>y</span><span>)</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>update</span> <span>from</span> <span>to</span><span>)</span>
    <span>(</span><span>do</span> <span>(</span><span>(</span><span>y</span> <span>0</span> <span>(</span><span>+</span> <span>y</span> <span>1</span><span>)</span><span>)</span><span>)</span>
        <span>(</span><span>(</span><span>=</span> <span>y</span> <span>grid-size</span><span>)</span><span>)</span>
      <span>(</span><span>do</span> <span>(</span><span>(</span><span>x</span> <span>0</span> <span>(</span><span>+</span> <span>x</span> <span>1</span><span>)</span><span>)</span><span>)</span>
          <span>(</span><span>(</span><span>=</span> <span>x</span> <span>grid-size</span><span>)</span><span>)</span>
        <span>(</span><span>let*</span> <span>(</span><span>(</span><span>t</span> <span>(</span><span>grid-ref</span> <span>from</span> <span>x</span> <span>y</span><span>)</span><span>)</span>
               <span>(</span><span>t*</span> <span>(</span><span>cond</span>
                    <span>(</span><span>(</span><span>=</span> <span>t</span> <span>empty</span><span>)</span> <span>empty</span><span>)</span>
                    <span>(</span><span>(</span><span>=</span> <span>t</span> <span>cu</span><span>)</span>
                     <span>(</span><span>if</span> <span>(</span><span>&lt;=</span> <span>1</span> <span>(</span><span>neighbors</span> <span>from</span> <span>x</span> <span>y</span><span>)</span> <span>2</span><span>)</span> <span>ehead</span> <span>cu</span><span>)</span><span>)</span>
                    <span>(</span><span>(</span><span>=</span> <span>t</span> <span>ehead</span><span>)</span> <span>etail</span><span>)</span>
                    <span>(</span><span>(</span><span>=</span> <span>t</span> <span>etail</span><span>)</span> <span>cu</span><span>)</span><span>)</span><span>)</span><span>)</span>
          <span>(</span><span>grid-set!</span> <span>to</span> <span>x</span> <span>y</span> <span>t*</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>copy</span> <span>from</span> <span>to</span><span>)</span>
    <span>(</span><span>let</span> <span>(</span><span>(</span><span>k</span> <span>(</span><span>bytevector-length</span> <span>from</span><span>)</span><span>)</span><span>)</span>
      <span>(</span><span>do</span> <span>(</span><span>(</span><span>i</span> <span>0</span> <span>(</span><span>+</span> <span>i</span> <span>1</span><span>)</span><span>)</span><span>)</span>
          <span>(</span><span>(</span><span>=</span> <span>i</span> <span>k</span><span>)</span><span>)</span>
        <span>(</span><span>bytevector-u8-set!</span> <span>to</span> <span>i</span> <span>(</span><span>bytevector-u8-ref</span> <span>from</span> <span>i</span><span>)</span><span>)</span><span>)</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>grid-a</span> <span>(</span><span>make-grid</span><span>)</span><span>)</span>
  <span>(</span><span>define</span> <span>grid-b</span> <span>(</span><span>make-grid</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>update-and-swap</span><span>)</span>
    <span>(</span><span>update</span> <span>grid-a</span> <span>grid-b</span><span>)</span>
    <span>(</span><span>copy</span> <span>grid-b</span> <span>grid-a</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>ref</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>grid-ref</span> <span>grid-a</span> <span>x</span> <span>y</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>set</span> <span>x</span> <span>y</span> <span>t</span><span>)</span>
    <span>(</span><span>grid-set!</span> <span>grid-a</span> <span>x</span> <span>y</span> <span>t</span><span>)</span><span>)</span>

  <span>(</span><span>define</span> <span>(</span><span>cycle</span> <span>x</span> <span>y</span><span>)</span>
    <span>(</span><span>set</span> <span>x</span> <span>y</span> <span>(</span><span>modulo</span> <span>(</span><span>+</span> <span>(</span><span>ref</span> <span>x</span> <span>y</span><span>)</span> <span>1</span><span>)</span> <span>4</span><span>)</span><span>)</span><span>)</span>

  <span>(</span><span>values</span> <span>grid-size</span> <span>ref</span> <span>set</span> <span>cycle</span> <span>update-and-swap</span><span>)</span><span>)</span><span>)</span></code></pre><p>After compiling and gzipping the resulting binary, we’re looking at a
28KiB download.  Not too shabby!  (And we’re anticipating adding a
size optimization pass resembling binaryen’s <code>wasm-opt -Oz</code> in the
future to reduce binary size even further.)</p><p>Before we get to the browser, let’s take a quick detour and talk about
development workflow.  It took several iterations to arrive at the
code above.  In true Scheme fashion, the program was developed
incrementally in an interactive REPL session.  By using Hoot’s WASM
interpreter, we repeatedly compiled and tested the program without
having to load it into a web browser or shell out to V8’s <code>d8</code> tool.
We think it’s pretty neat!  Below is an annotated excerpt of a REPL
session that shows the values of 3 cells before and after an update.</p><pre><code><span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>,use</span> <span>(</span><span>hoot</span> <span>reflect</span><span>)</span> <span>(</span><span>wasm</span> <span>parse</span><span>)</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>define</span> <span>reflect-wasm</span>
                       <span>(</span><span>call-with-input-file</span> <span>&#34;js-runtime/reflect.wasm&#34;</span>
                                             <span>parse-wasm</span><span>)</span><span>)</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>define-values</span> <span>(</span><span>grid-size</span> <span>grid-ref</span> <span>grid-set</span>
                                     <span>grid-cycle</span> <span>grid-update</span><span>)</span>
                       <span>(</span><span>compile-value</span> <span>reflect-wasm</span> <span>wireworld-src</span><span>)</span><span>)</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-ref</span> <span>0</span> <span>0</span><span>)</span>  <span>$10</span> <span>=</span> <span>3</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-ref</span> <span>1</span> <span>0</span><span>)</span>  <span>$11</span> <span>=</span> <span>2</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-ref</span> <span>2</span> <span>0</span><span>)</span>  <span>$12</span> <span>=</span> <span>1</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-update</span><span>)</span>   <span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-ref</span> <span>0</span> <span>0</span><span>)</span>  <span>$13</span> <span>=</span> <span>1</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-ref</span> <span>1</span> <span>0</span><span>)</span>  <span>$14</span> <span>=</span> <span>3</span>
<span>scheme@</span><span>(</span><span>guile-user</span><span>)</span><span>&gt;</span> <span>(</span><span>grid-ref</span> <span>2</span> <span>0</span><span>)</span>  <span>$15</span> <span>=</span> <span>2</span></code></pre><p>The electron has moved to the right one cell, exactly as it should.
With some amount of confidence that the program is working, we proceed
to the web browser.</p><h3>Wireworld part 2: JavaScript</h3><p>To get this version of Wireworld running in the browser, an additional
~100 lines of JavaScript were used to glue the Scheme program to
various browser APIs.  Since we aren’t targeting WASM-4 this time, we
needed a new rendering method.  We chose HTML5 canvas to keep things
simple.  The code below updates the simulation at some regular
interval, renders to the canvas, and handles keyboard/mouse input.
Hoot’s <code>reflect.js</code> library allows us to call Scheme procedures from
JS.</p><pre><code><span>async</span> <span>function</span> <span>init</span><span>(</span><span>)</span> <span>{</span>
  <span>const</span> <span>canvas</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>&#34;canvas&#34;</span><span>)</span><span>;</span>
  <span>const</span> <span>ctx</span> <span>=</span> <span>canvas</span><span>.</span><span>getContext</span><span>(</span><span>&#34;2d&#34;</span><span>)</span><span>;</span>
  <span>const</span> <span>[</span><span>_gridSize</span><span>,</span> <span>gridRef</span><span>,</span> <span>gridSet</span><span>,</span> <span>gridCycle</span><span>,</span> <span>gridUpdate</span><span>]</span> <span>=</span>
        <span>await</span> <span>Scheme</span><span>.</span><span>load_main</span><span>(</span><span>&#34;scheme-wireworld.wasm&#34;</span><span>,</span> <span>{</span><span>}</span><span>)</span><span>;</span>
  <span>const</span> <span>gridSize</span> <span>=</span> <span>Number</span><span>(</span><span>_gridSize</span><span>)</span><span>,</span> <span>tileSize</span> <span>=</span> <span>16</span><span>;</span>
  <span>const</span> <span>canvasSize</span> <span>=</span> <span>gridSize</span> <span>*</span> <span>tileSize</span><span>;</span>
  <span>const</span> <span>empty</span> <span>=</span> <span>0</span><span>,</span> <span>cu</span> <span>=</span> <span>1</span><span>,</span> <span>ehead</span> <span>=</span> <span>2</span><span>,</span> <span>etail</span> <span>=</span> <span>3</span><span>;</span>
  <span>let</span> <span>paused</span> <span>=</span> <span>true</span><span>,</span> <span>mouseX</span> <span>=</span> <span>0</span><span>,</span> <span>mouseY</span> <span>=</span> <span>0</span><span>;</span>

  <span>function</span> <span>render</span><span>(</span><span>)</span> <span>{</span>
    <span>requestAnimationFrame</span><span>(</span><span>(</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
      <span>for</span> <span>(</span><span>var</span> <span>y</span> <span>=</span> <span>0</span><span>;</span> <span>y</span> <span>&lt;</span> <span>gridSize</span><span>;</span> <span>y</span><span>++</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>var</span> <span>x</span> <span>=</span> <span>0</span><span>;</span> <span>x</span> <span>&lt;</span> <span>gridSize</span><span>;</span> <span>x</span><span>++</span><span>)</span> <span>{</span>
          <span>const</span> <span>t</span> <span>=</span> <span>Number</span><span>(</span><span>gridRef</span><span>.</span><span>call</span><span>(</span><span>BigInt</span><span>(</span><span>x</span><span>)</span><span>,</span> <span>BigInt</span><span>(</span><span>y</span><span>)</span><span>)</span><span>)</span><span>;</span>
          <span>switch</span><span>(</span><span>t</span><span>)</span> <span>{</span>
          <span>case</span> <span>empty</span><span>:</span>
            <span>ctx</span><span>.</span><span>fillStyle</span> <span>=</span> <span>&#34;#fff6d3&#34;</span><span>;</span>
            <span>break</span><span>;</span>
          <span>case</span> <span>cu</span><span>:</span>
            <span>ctx</span><span>.</span><span>fillStyle</span> <span>=</span> <span>&#34;#f9a875&#34;</span><span>;</span>
            <span>break</span><span>;</span>
          <span>case</span> <span>ehead</span><span>:</span>
            <span>ctx</span><span>.</span><span>fillStyle</span> <span>=</span> <span>&#34;#7c3f58&#34;</span><span>;</span>
            <span>break</span><span>;</span>
          <span>case</span> <span>etail</span><span>:</span>
            <span>ctx</span><span>.</span><span>fillStyle</span> <span>=</span> <span>&#34;#eb6b6f&#34;</span><span>;</span>
            <span>break</span><span>;</span>
          <span>}</span>
          <span>ctx</span><span>.</span><span>fillRect</span><span>(</span><span>x</span> <span>*</span> <span>tileSize</span><span>,</span> <span>y</span> <span>*</span> <span>tileSize</span><span>,</span> <span>tileSize</span><span>,</span> <span>tileSize</span><span>)</span><span>;</span>
          <span>if</span><span>(</span><span>x</span> <span>=</span><span>=</span> <span>mouseX</span> <span>&amp;&amp;</span> <span>y</span> <span>=</span><span>=</span> <span>mouseY</span><span>)</span> <span>{</span>
            <span>ctx</span><span>.</span><span>fillStyle</span> <span>=</span> <span>&#34;#00000020&#34;</span><span>;</span>
            <span>ctx</span><span>.</span><span>fillRect</span><span>(</span><span>x</span> <span>*</span> <span>tileSize</span><span>,</span> <span>y</span> <span>*</span> <span>tileSize</span><span>,</span> <span>tileSize</span><span>,</span> <span>tileSize</span><span>)</span><span>;</span>
          <span>}</span>
        <span>}</span>
      <span>}</span>
    <span>}</span><span>)</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>update</span><span>(</span><span>)</span> <span>{</span>
    <span>if</span><span>(</span><span>!</span><span>paused</span><span>)</span> <span>{</span>
      <span>gridUpdate</span><span>.</span><span>call</span><span>(</span><span>)</span><span>;</span>
      <span>render</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>setTimeout</span><span>(</span><span>update</span><span>,</span> <span>100</span><span>)</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>pixelToTile</span><span>(</span><span>p</span><span>)</span> <span>{</span>
    <span>return</span> <span>Math</span><span>.</span><span>min</span><span>(</span><span>Math</span><span>.</span><span>max</span><span>(</span><span>Math</span><span>.</span><span>floor</span><span>(</span><span>p</span> <span>/</span> <span>tileSize</span><span>)</span><span>,</span> <span>0</span><span>)</span><span>,</span> <span>gridSize</span> <span>-</span> <span>1</span><span>)</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>cycleTile</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span> <span>{</span>
    <span>gridCycle</span><span>.</span><span>call</span><span>(</span><span>BigInt</span><span>(</span><span>x</span><span>)</span><span>,</span> <span>BigInt</span><span>(</span><span>y</span><span>)</span><span>)</span><span>;</span>
    <span>render</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>setTile</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>t</span><span>)</span> <span>{</span>
    <span>gridSet</span><span>.</span><span>call</span><span>(</span><span>BigInt</span><span>(</span><span>x</span><span>)</span><span>,</span> <span>BigInt</span><span>(</span><span>y</span><span>)</span><span>,</span> <span>BigInt</span><span>(</span><span>t</span><span>)</span><span>)</span><span>;</span>
    <span>render</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>clearTile</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span> <span>{</span>
    <span>setTile</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>empty</span><span>)</span><span>;</span>
  <span>}</span>

  <span>function</span> <span>togglePause</span><span>(</span><span>)</span> <span>{</span>
    <span>paused</span> <span>=</span> <span>!</span><span>paused</span><span>;</span>
  <span>}</span>

  <span>canvas</span><span>.</span><span>width</span> <span>=</span> <span>canvasSize</span><span>;</span>
  <span>canvas</span><span>.</span><span>height</span> <span>=</span> <span>canvasSize</span><span>;</span>
  <span>canvas</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;mousemove&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
    <span>mouseX</span> <span>=</span> <span>pixelToTile</span><span>(</span><span>event</span><span>.</span><span>offsetX</span><span>)</span><span>;</span>
    <span>mouseY</span> <span>=</span> <span>pixelToTile</span><span>(</span><span>event</span><span>.</span><span>offsetY</span><span>)</span><span>;</span>
    <span>if</span><span>(</span><span>event</span><span>.</span><span>buttons</span> <span>=</span><span>=</span> <span>1</span><span>)</span> <span>{</span>       <span>setTile</span><span>(</span><span>mouseX</span><span>,</span> <span>mouseY</span><span>,</span> <span>cu</span><span>)</span><span>;</span>
    <span>}</span> <span>else</span> <span>if</span><span>(</span><span>event</span><span>.</span><span>buttons</span> <span>=</span><span>=</span> <span>2</span><span>)</span> <span>{</span>       <span>clearTile</span><span>(</span><span>mouseX</span><span>,</span> <span>mouseY</span><span>)</span><span>;</span>
    <span>}</span>
    <span>render</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
  <span>canvas</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;mousedown&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
    <span>const</span> <span>x</span> <span>=</span> <span>pixelToTile</span><span>(</span><span>event</span><span>.</span><span>offsetX</span><span>)</span><span>;</span>
    <span>const</span> <span>y</span> <span>=</span> <span>pixelToTile</span><span>(</span><span>event</span><span>.</span><span>offsetY</span><span>)</span><span>;</span>
    <span>if</span><span>(</span><span>event</span><span>.</span><span>button</span> <span>=</span><span>=</span> <span>0</span><span>)</span> <span>{</span>       <span>cycleTile</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span><span>;</span>
    <span>}</span> <span>else</span> <span>if</span><span>(</span><span>event</span><span>.</span><span>button</span> <span>=</span><span>=</span> <span>2</span><span>)</span> <span>{</span>       <span>clearTile</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>)</span><span>;</span>
    <span>}</span>
  <span>}</span><span>)</span><span>;</span>
  <span>canvas</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;contextmenu&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=</span><span>&gt;</span> <span>event</span><span>.</span><span>preventDefault</span><span>(</span><span>)</span><span>)</span><span>;</span>
  <span>document</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;keydown&#34;</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=</span><span>&gt;</span> <span>{</span>
    <span>if</span><span>(</span><span>event</span><span>.</span><span>code</span> <span>=</span><span>=</span> <span>&#34;Space&#34;</span><span>)</span> <span>togglePause</span><span>(</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
  <span>update</span><span>(</span><span>)</span><span>;</span>
  <span>render</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
<span>window</span><span>.</span><span>addEventListener</span><span>(</span><span>&#34;load&#34;</span><span>,</span> <span>init</span><span>)</span><span>;</span></code></pre><p>Note the use of <code>BigInt</code> in several places.  This is a consequence of
how JavaScript’s <code>Number</code> type works.  JS numbers are floating point
values, but Scheme has a much richer set of numeric types including
exact integers.  So, values of type <code>Number</code> are treated as Scheme
floats, and the <code>BigInt</code> type is used to box all integer values that
traverse the JS⇄Scheme bridge.</p><p>As Hoot matures and we implement a foreign function interface (FFI)
for calling into JS (or other hosts) from Scheme, we expect to see the
amount of glue code shrink considerably.</p><h3>Live demo</h3><p>OK, now it’s time to see Scheme Wireworld in action!  But first, a
disclaimer: As of publishing, major web browsers are just beginning to
ship WASM GC support.  Starting with Firefox 120 and Chrome 119, GC is
enabled by default.  Neither version is stable yet, so use either
<a href="https://www.mozilla.org/en-US/firefox/channel/desktop/">Firefox
Nightly</a> or
<a href="https://www.google.com/chrome/dev/">Chrome Dev</a> if you’d like to run
the demo.  If you’re reading this further into the future then
congratulations!  The browser you are using should have everything you
need.</p><p>How to use:</p><ul><li>Press the left mouse button and move the cursor to draw copper.</li><li>Press the right mouse button and move the cursor to erase.</li><li>Left click on a cell to cycle its type (copper becomes electron
head, etc.)</li><li>Right click on a cell to clear it.</li><li>Press the space bar to pause or resume the simulation.</li></ul><h3>Now you try!</h3><p>If you’d like to compile and run this yourself, check out our <a href="https://gitlab.com/spritely/scheme-wireworld">GitLab
repo</a> for this demo.
Like most of our projects, it uses <a href="https://guix.gnu.org">Guix</a> to
setup the development environment.</p><pre><code>git clone https://gitlab.com/spritely/scheme-wireworld.git
cd scheme-wireworld
guix shell
# The following commands are evaluated *within* the Guix shell
guile wireworld.scm
guile web-server.scm</code></pre><p>Once the web server is up and running, visit
<a href="http://localhost:8080">http://localhost:8080</a> in your web browser.
Feel free to modify the code and have some fun!</p><p>We look forward to sharing more when we release Hoot 0.1.0!</p></div></div>
  </body>
</html>
