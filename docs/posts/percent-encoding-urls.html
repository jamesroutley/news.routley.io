<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erikarow.land/notes/percent-encoding">Original</a>
    <h1>Percent Encoding URLs</h1>
    
    <div id="readability-page-1" class="page"><section id="Percent-Encoding-URLs">

<p>I use <a href="https://gizmodo.com/notes/djot">djot</a> for the markup on my static site generator.
In djot, the link syntax looks like this:</p>
<pre><code>[link text](http://example.com)
</code></pre>
<p>This works fine for most links, but certain links that include parenthesis, it breaks. This is mostly a problem for Wikipedia, which uses parenthesis for disambiguation of topics. For example:</p>
<pre><code>[Variety](https://en.wikipedia.org/wiki/Variety_(cybernetics)#Law_of_requisite_variety)
</code></pre>
<p>As written, this will break the link, since <code>djot</code> will parse the first closing <code>)</code> as the end of the URL, which is not the complete link. This is because, <a href="https://github.com/jgm/djot#rationale">by design</a>, <code>djot</code> parses markup in linear time without backtracking.</p>
<section id="Percent-Encoding-Parenthesis">
<h2>Percent Encoding Parenthesis</h2>
<p>This is where <a href="https://en.wikipedia.org/wiki/Percent-encoding">Percent Encoding</a> comes in. Percent encoding is a method specified in the URI specification that allows for the encoding of arbitrary data in a URI.<label for="fn1"></label><span></span></p>
<p>Specifically, I needed to encode <code>)</code> as <code>%29</code>.<label for="fn2"></label><span></span></p>
<p>Using my link from before, that looks like this:</p>
<pre><code>[Variety](https://en.wikipedia.org/wiki/Variety_(cybernetics%29#Law_of_requisite_variety)
</code></pre>
<p>If I use this markup: <a href="https://en.wikipedia.org/wiki/Variety_(cybernetics%29#Law_of_requisite_variety">Variety</a>, I correctly get the link to the Wikipedia article.</p>
</section>
<section id="Elixir-URI-encoding">
<h2>Elixir URI encoding</h2>
<p>When I first learned about Percent Encoding, I quickly found the <code>URI.encode/1</code> function in Elixir. To my dismay, it didn’t correctly escape parenthesis:</p>
<pre><code>iex()&gt; URI.encode(&#34;(hello)&#34;)
&#34;(hello)&#34;
</code></pre>
<p>Frustrated, I continued escaping my links for <code>djot</code> by hand.</p>
<p>Today, I re-read the documentation of <code>URI.encode</code> and found a line that I previously missed<label for="fn3"></label><span></span>:</p>
<blockquote>
<p>This function also accepts a predicate function as an optional argument. If
passed, this function will be called with each byte in string as its argument
and should return a truthy value (anything other than false or nil) if the
given byte should be left as is, or return a falsy value (false or nil) if the
character should be escaped. Defaults to URI.char_unescaped?/1.</p>
</blockquote>
<p>The documentation for <code>URI.char_unescaped?/1</code> explains that it is deliberately escaping the minimum required and purposely leaving reserved characters unescaped:</p>
<blockquote>
<p>Checks if character is allowed unescaped in a URI.</p>
<p>This is the default used by URI.encode/2 where both reserved (char_reserved?/1)
and unreserved characters (char_unreserved?/1) are kept unescaped.</p>
</blockquote>
<p>It also hints at a better predicate function for <code>URI.encode</code>, <code>URI.char_unreserved?/1</code>, which escapes the parenthesis like I need:</p>
<pre><code>iex()&gt; URI.encode(&#34;(hello)&#34;, &amp;URI.char_unreserved?/1)
&#34;%28hello%29&#34;
</code></pre>
</section>
<section id="Takeaways">
<h2>Takeaways</h2>
<p><code>djot</code>’s linear parsing forces it to assume that the first <code>)</code> it encounters is the end of a URL.</p>
<p>Using percent encoding, I can encode <code>)</code> as <code>%29</code>, which solves the <code>djot</code> issue while allowing the browser to route the URL correctly.</p>
<p>Elixir’s <code>URI.encode</code> doesn’t escape parenthesis by default, but does allow an alternate predicate function that does.<label for="fn4"></label><span></span></p>
</section>
</section></div>
  </body>
</html>
