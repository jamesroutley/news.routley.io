<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rgoswami.me/posts/fortran-oop-python/">Original</a>
    <h1>Fortran OOP and Python</h1>
    
    <div id="readability-page-1" class="page"><div><blockquote><p>Explorations of object oriented Fortran with <code>bind(c)</code> derived types
for representations generated by F2PY</p></blockquote><h2 id="background">Background</h2><p>Derived types are easily one of the most visible of the modern Fortran
(post-F90) features and are central to object oriented programming
paradigms in Fortarn.</p><p>For those new to the language, a rough guide to some terminology:</p><table><thead><tr><th><strong>Fortran</strong></th><th><strong>Closest C/C++ equivalent</strong></th></tr></thead><tbody><tr><td>derived type</td><td>struct</td></tr><tr><td>extends type</td><td>inherited class</td></tr><tr><td>final</td><td>destructor</td></tr><tr><td>not standard conforming</td><td>undefined behaviour</td></tr></tbody></table><p>Only the first of these are actually covered in terms of
interoperability with <code>C</code> as of the <a href="https://gitlab.com/lfortran/lfortran/uploads/973db2bfcc64cd2a397f823c32718b39/18-007r1.pdf">F2018 draft
standard</a>.</p><p>For F2PY within <code>numpy</code>, however, although there are no direct
equivalents in <code>C</code> for the more OOP specific derived types, there are
plenty of equivalent structures in <code>Python</code>. This post will bridge
Fortran derived types to their logically equivalent Python class
definitions.</p><h3 id="series">Series</h3><p>Thoughts relating to interoperability of Fortran with things can be
vaguely collated into the following series.</p><ol><li><a href="https://markdoc.io/posts/numpy-meson-f2py/">NumPy Meson Fortran</a></li><li><a href="https://markdoc.io/posts/cython-derivedtype-f2py/">Simple Fortran Derived Types and Python</a></li><li><a href="https://markdoc.io/posts/iso-c-type-bound-fortran/">Exploring <code>ISO_C_BINDING</code> and type-bound procedures</a></li><li><strong>Fortran OOP and Python</strong> &lt;– You are here!</li></ol><h2 id="premise">Premise</h2><p>As in <a href="https://markdoc.io/posts/cython-derivedtype-f2py/">the previous posts</a>, we will be interested in a <code>bind(c)</code> derived type.</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>type</span> <span>::</span> <span>cartesian</span>
</span></span><span><span>2</span><span>  <span>real</span><span>(</span><span>c_double</span><span>)</span> <span>::</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>z</span>
</span></span><span><span>3</span><span><span>end type </span><span>cartesian</span>
</span></span></code></pre></div><p>Along with a simple function which uses an instance of such a derived
type.</p><div><pre tabindex="0"><code data-lang="fortran"><span><span>1</span><span><span>subroutine </span><span>unit_step</span><span>(</span><span>arg</span><span>)</span> <span>bind</span><span>(</span><span>c</span><span>)</span>
</span></span><span><span>2</span><span>  <span>type</span><span>(</span><span>cartesian</span><span>),</span> <span>intent</span><span>(</span><span>inout</span><span>)</span> <span>::</span> <span>arg</span>
</span></span><span><span>3</span><span>  <span>arg</span><span>%</span><span>x</span> <span>=</span> <span>arg</span><span>%</span><span>x</span> <span>+</span> <span>1</span>
</span></span><span><span>4</span><span>  <span>arg</span><span>%</span><span>y</span> <span>=</span> <span>arg</span><span>%</span><span>y</span> <span>+</span> <span>1</span>
</span></span><span><span>5</span><span>  <span>arg</span><span>%</span><span>z</span> <span>=</span> <span>arg</span><span>%</span><span>z</span> <span>+</span> <span>1</span>
</span></span><span><span>6</span><span><span>end subroutine </span><span>unit_step</span>
</span></span></code></pre></div><p>To make the discussion and conversion into Python more concrete, we will
start with an overview of possible representations.</p><h2 id="representations">Representations</h2><p>The elements of the Python programming language which can be best used
to emulate a derived type are (in order of relative complexity):</p><dl><dt><strong>Lists</strong></dt><dd>In theory, a record type can be represented and constructed from a
list, with the members of the type specified in order of appearance
or lexicographically. However, this is a lossy, incomplete
representation as it would remove the ability to refer to and
operate on the member variables by name.</dd><dt><strong>Dictionaries</strong></dt><dd>These have the benefit of being relatively simple to implement, and
retain member addressable semantics.</dd><dt><strong>Named Tuples</strong></dt><dd>As immutable data structures with labels, these make good return
types, however, they are poor representations for objects which may
be modified in place (e.g. in a Fortran <code>subroutine</code>).</dd><dt><strong>Dataclasses</strong></dt><dd>These make sense from a logical perspective, however, they are hard
to programmatically generate and use in C-extensions, limiting their
utility for inter-operability with Fortran.</dd><dt><strong>Classes</strong></dt><dd>The most general and arguably the most flexible construct is to
generate code for a <code>PyTypeObject</code>, which can be fleshed out to
contain both attributes, as well as memory allocation rules.</dd></dl><p>Of the representations described, the first approximation covered in [a
previous post](/posts/cython-derivedtype-f2py/) was the
<code>dictionary</code>. A major concern <sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> is that of lineage and
extensibility; <code>python</code> users would expect that a dictionary can be
extended with keys, which would not make much sense if the dictionary is
meant to represent a derived type. Additionally, it is difficult to
programmatically ascertain which dictionaries are meant to be
interoperable with Fortran functions or subroutines. Note that the
dictionary representation code is also <a href="https://github.com/HaoZeke/f2py_derived_nep/tree/main/examples/bindc/pydict">present
here</a>
with usage examples.</p><p>The rest of this post will enumerate the construction and usage of a
<code>bind(c)</code> derived type represented as a Python class.</p><h2 id="pythonic-equivalent">Pythonic Equivalent</h2><p>For a more pedagogical understanding, the derived type will be emulated
(from within a Python-C exention) by the following class definition:</p><div><pre tabindex="0"><code data-lang="python"><span><span> 1</span><span><span>class</span> <span>fakecart</span><span>:</span>
</span></span><span><span> 2</span><span>  <span>def</span> <span>__new__</span><span>(</span><span>cls</span><span>,</span> <span>*</span><span>args</span><span>,</span> <span>**</span><span>kwargs</span><span>):</span>
</span></span><span><span> 3</span><span>    <span>obj</span> <span>=</span> <span>object</span><span>.</span><span>__new__</span><span>(</span><span>cls</span><span>)</span>
</span></span><span><span> 4</span><span>    <span>obj</span><span>.</span><span>x</span> <span>=</span> <span>0</span>
</span></span><span><span> 5</span><span>    <span>obj</span><span>.</span><span>y</span> <span>=</span> <span>0</span>
</span></span><span><span> 6</span><span>    <span>obj</span><span>.</span><span>z</span> <span>=</span> <span>0</span>
</span></span><span><span> 7</span><span>    <span>return</span> <span>obj</span>
</span></span><span><span> 8</span><span>
</span></span><span><span> 9</span><span>  <span>def</span> <span>__init__</span><span>(</span><span>self</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>z</span><span>):</span>
</span></span><span><span>10</span><span>    <span>self</span><span>.</span><span>x</span> <span>=</span> <span>x</span>
</span></span><span><span>11</span><span>    <span>self</span><span>.</span><span>y</span> <span>=</span> <span>y</span>
</span></span><span><span>12</span><span>    <span>self</span><span>.</span><span>z</span> <span>=</span> <span>z</span>
</span></span><span><span>13</span><span>
</span></span><span><span>14</span><span>  <span>def</span> <span>__repr__</span><span>(</span><span>self</span><span>):</span>
</span></span><span><span>15</span><span>    <span>return</span> <span>f</span><span>&#34;fakecart(x: </span><span>{</span><span>self</span><span>.</span><span>x</span><span>}</span><span>, y: </span><span>{</span><span>self</span><span>.</span><span>y</span><span>}</span><span>, z: </span><span>{</span><span>self</span><span>.</span><span>z</span><span>}</span><span>)&#34;</span>
</span></span><span><span>16</span><span>
</span></span><span><span>17</span><span>  <span>def</span> <span>unitstep</span><span>(</span><span>self</span><span>):</span>
</span></span><span><span>18</span><span>    <span>self</span><span>.</span><span>x</span> <span>=</span> <span>self</span><span>.</span><span>x</span> <span>+</span> <span>1</span>
</span></span><span><span>19</span><span>    <span>self</span><span>.</span><span>y</span> <span>=</span> <span>self</span><span>.</span><span>y</span> <span>+</span> <span>1</span>
</span></span><span><span>20</span><span>    <span>self</span><span>.</span><span>z</span> <span>=</span> <span>self</span><span>.</span><span>z</span> <span>+</span><span>1</span>
</span></span></code></pre></div><p>Note that apart from the members which mimic the those in the derived
type, for illustration’s sake we will implement the <code>unit_step</code> free
function as a member function.</p><h2 id="c-python-fortran-implementation">C-Python-Fortran Implementation</h2><p>For <code>bind(c)</code> types, we will focus on implementing the member data in
terms of <code>C</code> structs, and rely on <code>bind(c)</code> to ensure that symbols are
mangled in a compatible manner, i.e. we will not need to hardcode any
compiler specific name mangling conventions for the functions we call
from Fortran. The complete Fortran code of interest is:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span> 1</span><span><span>! vec.f90
</span></span></span><span><span> 2</span><span><span></span>  <span>module </span><span>vec</span>
</span></span><span><span> 3</span><span>    <span>use</span><span>,</span> <span>intrinsic</span> <span>::</span> <span>iso_c_binding
</span></span></span><span><span> 4</span><span><span>    </span><span>implicit none
</span></span></span><span><span> 5</span><span><span>
</span></span></span><span><span> 6</span><span><span>    type</span> <span>::</span> <span>cartesian</span>
</span></span><span><span> 7</span><span>       <span>real</span><span>(</span><span>c_double</span><span>)</span> <span>::</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>z</span>
</span></span><span><span> 8</span><span>    <span>end type </span><span>cartesian</span>
</span></span><span><span> 9</span><span>
</span></span><span><span>10</span><span>    <span>contains
</span></span></span><span><span>11</span><span><span>      subroutine </span><span>unit_step</span><span>(</span><span>arg</span><span>)</span> <span>bind</span><span>(</span><span>c</span><span>)</span>
</span></span><span><span>12</span><span>        <span>type</span><span>(</span><span>cartesian</span><span>),</span> <span>intent</span><span>(</span><span>inout</span><span>)</span> <span>::</span> <span>arg</span>
</span></span><span><span>13</span><span>         <span>arg</span><span>%</span><span>x</span> <span>=</span> <span>arg</span><span>%</span><span>x</span> <span>+</span> <span>1</span>
</span></span><span><span>14</span><span>         <span>arg</span><span>%</span><span>y</span> <span>=</span> <span>arg</span><span>%</span><span>y</span> <span>+</span> <span>1</span>
</span></span><span><span>15</span><span>         <span>arg</span><span>%</span><span>z</span> <span>=</span> <span>arg</span><span>%</span><span>z</span> <span>+</span> <span>1</span>
</span></span><span><span>16</span><span>      <span>end subroutine </span><span>unit_step</span>
</span></span><span><span>17</span><span><span>end module </span><span>vec</span>
</span></span></code></pre></div><p>For a source to source translation from the <code>Python</code> code, we will start
with a header file containing the basic C-Fortran structures and
function declarations:</p><div><pre tabindex="0"><code data-lang="c"><span><span> 1</span><span><span>// vecf.h
</span></span></span><span><span> 2</span><span><span></span><span>#ifndef VECF_H_
</span></span></span><span><span> 3</span><span><span>#define VECF_H_
</span></span></span><span><span> 4</span><span><span></span>
</span></span><span><span> 5</span><span><span>#include</span><span>&lt;stdio.h&gt;</span><span>
</span></span></span><span><span> 6</span><span><span>#include</span><span>&lt;stdlib.h&gt;</span><span>
</span></span></span><span><span> 7</span><span><span></span>
</span></span><span><span> 8</span><span><span>// bind(c) compatible struct declaration
</span></span></span><span><span> 9</span><span><span></span><span>typedef</span> <span>struct</span> <span>{</span>
</span></span><span><span>10</span><span>    <span>double</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>z</span><span>;</span>
</span></span><span><span>11</span><span><span>}</span> <span>cartesian</span><span>;</span>
</span></span><span><span>12</span><span>
</span></span><span><span>13</span><span><span>// In Fortran
</span></span></span><span><span>14</span><span><span></span><span>void</span> <span>unit_step</span><span>(</span><span>cartesian</span> <span>*</span><span>arg</span><span>);</span>
</span></span><span><span>15</span><span>
</span></span><span><span>16</span><span><span>#endif </span><span>// VECF_H_
</span></span></span></code></pre></div><p>Now for the class declaration itself.</p><h3 id="instance-variables-and-initialization">Instance Variables and Initialization</h3><p>Rather than declaring <code>double</code> variables in the Python class, we will
opt to use the <code>struct</code> defined earlier.</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>// CPython compatible declaration
</span></span></span><span><span>2</span><span><span></span><span>typedef</span> <span>struct</span> <span>{</span>
</span></span><span><span>3</span><span>  <span>PyObject_HEAD</span>        <span>/* Do not move */</span>
</span></span><span><span>4</span><span>  <span>cartesian</span> <span>ccart</span><span>;</span> <span>/* totally interoperable */</span>
</span></span><span><span>5</span><span><span>}</span> <span>pycart</span><span>;</span>
</span></span></code></pre></div><p>This means we can initialize an object of this class by writing the
equivalent of the <code>__init__()</code> as:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>static</span> <span>int</span> <span>pycart_init</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span> <span>PyObject</span> <span>*</span><span>kwds</span><span>)</span> <span>{</span>
</span></span><span><span>2</span><span>  <span>static</span> <span>char</span> <span>*</span><span>kwlist</span><span>[]</span> <span>=</span> <span>{</span><span>&#34;x&#34;</span><span>,</span> <span>&#34;y&#34;</span><span>,</span> <span>&#34;x&#34;</span><span>,</span> <span>NULL</span><span>};</span>
</span></span><span><span>3</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyArg_ParseTupleAndKeywords</span><span>(</span><span>args</span><span>,</span> <span>kwds</span><span>,</span> <span>&#34;|ddd&#34;</span><span>,</span> <span>kwlist</span><span>,</span> <span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>x</span><span>,</span>
</span></span><span><span>4</span><span>                                   <span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>y</span><span>,</span> <span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>z</span><span>))</span>
</span></span><span><span>5</span><span>    <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span>6</span><span>  <span>return</span> <span>0</span><span>;</span>
</span></span><span><span>7</span><span><span>}</span>
</span></span></code></pre></div><p>Finally we have to declare the instance variables to be exposed from the
class.</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>static</span> <span>PyMemberDef</span> <span>pycart_members</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span>2</span><span>    <span>{</span><span>&#34;x&#34;</span><span>,</span> <span>T_DOUBLE</span><span>,</span> <span>offsetof</span><span>(</span><span>pycart</span><span>,</span> <span>ccart</span><span>.</span><span>x</span><span>),</span> <span>0</span><span>,</span> <span>&#34;x coordinate&#34;</span><span>},</span>
</span></span><span><span>3</span><span>    <span>{</span><span>&#34;y&#34;</span><span>,</span> <span>T_DOUBLE</span><span>,</span> <span>offsetof</span><span>(</span><span>pycart</span><span>,</span> <span>ccart</span><span>.</span><span>y</span><span>),</span> <span>0</span><span>,</span> <span>&#34;y coordinate&#34;</span><span>},</span>
</span></span><span><span>4</span><span>    <span>{</span><span>&#34;z&#34;</span><span>,</span> <span>T_DOUBLE</span><span>,</span> <span>offsetof</span><span>(</span><span>pycart</span><span>,</span> <span>ccart</span><span>.</span><span>z</span><span>),</span> <span>0</span><span>,</span> <span>&#34;z coordinate&#34;</span><span>},</span>
</span></span><span><span>5</span><span>    <span>{</span><span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span>6</span><span><span>};</span>
</span></span></code></pre></div><p>Note that in each of the snippets above, we leverage the <code>cartesian</code>
structure.</p><h3 id="class-methods">Class Methods</h3><p>The heavy lifting of the function itself is in Fortran, while the <code>C</code>
struct can be used inter-operably with a derived type, leaving us with
an extremely light definition:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>pycart_unitstep</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span>2</span><span>  <span>// Call Fortran on the internal representation
</span></span></span><span><span>3</span><span><span></span>  <span>unit_step</span><span>(</span><span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>);</span>
</span></span><span><span>4</span><span>  <span>Py_RETURN_NONE</span><span>;</span>
</span></span><span><span>5</span><span><span>}</span>
</span></span></code></pre></div><p>We will also define a <code>__repr()__</code> function for ease of interactive use:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>pycart_repr</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span>2</span><span>  <span>char</span> <span>x</span><span>[</span><span>50</span><span>],</span> <span>y</span><span>[</span><span>50</span><span>],</span> <span>z</span><span>[</span><span>50</span><span>];</span>
</span></span><span><span>3</span><span>  <span>sprintf</span><span>(</span><span>x</span><span>,</span> <span>&#34;%f&#34;</span><span>,</span> <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span>4</span><span>  <span>sprintf</span><span>(</span><span>y</span><span>,</span> <span>&#34;%f&#34;</span><span>,</span> <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span>5</span><span>  <span>sprintf</span><span>(</span><span>z</span><span>,</span> <span>&#34;%f&#34;</span><span>,</span> <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>z</span><span>);</span>
</span></span><span><span>6</span><span>  <span>PyObject</span> <span>*</span><span>repr</span> <span>=</span> <span>PyUnicode_FromFormat</span><span>(</span><span>&#34;pycart(x: %s, y: %s, z: %s)&#34;</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>z</span><span>);</span>
</span></span><span><span>7</span><span>  <span>return</span> <span>repr</span><span>;</span>
</span></span><span><span>8</span><span><span>}</span>
</span></span></code></pre></div><p>Finally we can register the methods.</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>static</span> <span>PyMethodDef</span> <span>pycart_methods</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span>2</span><span>    <span>{</span><span>&#34;unitstep&#34;</span><span>,</span> <span>(</span><span>PyCFunction</span><span>)</span><span>pycart_unitstep</span><span>,</span> <span>METH_NOARGS</span><span>,</span>
</span></span><span><span>3</span><span>     <span>&#34;Modify the class members with the Fortran unit_step function&#34;</span><span>},</span>
</span></span><span><span>4</span><span>    <span>{</span><span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span>5</span><span><span>};</span>
</span></span></code></pre></div><p>Before rounding out our definition:</p><div><pre tabindex="0"><code data-lang="c"><span><span> 1</span><span><span>// Definition of type
</span></span></span><span><span> 2</span><span><span></span><span>static</span> <span>PyTypeObject</span> <span>t_pycart</span> <span>=</span> <span>{</span>
</span></span><span><span> 3</span><span>    <span>PyVarObject_HEAD_INIT</span><span>(</span><span>NULL</span><span>,</span> <span>0</span><span>)</span> <span>/* tp_head */</span>
</span></span><span><span> 4</span><span>        <span>.</span><span>tp_name</span> <span>=</span> <span>&#34;pycart.pycart&#34;</span><span>,</span>
</span></span><span><span> 5</span><span>    <span>.</span><span>tp_doc</span> <span>=</span> <span>PyDoc_STR</span><span>(</span><span>&#34;One coordinate (x, y, z)&#34;</span><span>),</span>
</span></span><span><span> 6</span><span>    <span>.</span><span>tp_basicsize</span> <span>=</span> <span>sizeof</span><span>(</span><span>pycart</span><span>),</span>
</span></span><span><span> 7</span><span>    <span>.</span><span>tp_itemsize</span> <span>=</span> <span>0</span><span>,</span>
</span></span><span><span> 8</span><span>    <span>.</span><span>tp_dealloc</span> <span>=</span> <span>pycart_dealloc</span><span>,</span>
</span></span><span><span> 9</span><span>    <span>.</span><span>tp_repr</span> <span>=</span> <span>pycart_repr</span><span>,</span>
</span></span><span><span>10</span><span>    <span>.</span><span>tp_getattro</span> <span>=</span> <span>PyObject_GenericGetAttr</span><span>,</span>
</span></span><span><span>11</span><span>    <span>.</span><span>tp_setattro</span> <span>=</span> <span>PyObject_GenericSetAttr</span><span>,</span>
</span></span><span><span>12</span><span>    <span>.</span><span>tp_flags</span> <span>=</span> <span>Py_TPFLAGS_DEFAULT</span> <span>|</span> <span>Py_TPFLAGS_BASETYPE</span><span>,</span>
</span></span><span><span>13</span><span>    <span>.</span><span>tp_members</span> <span>=</span> <span>pycart_members</span><span>,</span>
</span></span><span><span>14</span><span>    <span>.</span><span>tp_methods</span> <span>=</span> <span>pycart_methods</span><span>,</span>
</span></span><span><span>15</span><span>    <span>.</span><span>tp_init</span> <span>=</span> <span>pycart_init</span><span>,</span>
</span></span><span><span>16</span><span>    <span>.</span><span>tp_alloc</span> <span>=</span> <span>PyType_GenericAlloc</span><span>,</span>
</span></span><span><span>17</span><span>    <span>.</span><span>tp_new</span> <span>=</span> <span>PyType_GenericNew</span><span>,</span>
</span></span><span><span>18</span><span>    <span>.</span><span>tp_free</span> <span>=</span> <span>PyObject_Del</span><span>,</span>
</span></span><span><span>19</span><span><span>};</span>
</span></span></code></pre></div><p>Where we have additionally defined and bound machinery to declare
<code>__new__()</code>.</p><div><pre tabindex="0"><code data-lang="c"><span><span> 1</span><span><span>static</span> <span>void</span> <span>pycart_dealloc</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span> 2</span><span>  <span>// Also free the pointer here
</span></span></span><span><span> 3</span><span><span></span>  <span>Py_TYPE</span><span>(</span><span>self</span><span>)</span><span>-&gt;</span><span>tp_free</span><span>((</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>);</span>
</span></span><span><span> 4</span><span><span>}</span>
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>pycart_new</span><span>(</span><span>PyTypeObject</span> <span>*</span><span>type</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span>
</span></span><span><span> 7</span><span>                            <span>PyObject</span> <span>*</span><span>kwds</span><span>)</span> <span>{</span>
</span></span><span><span> 8</span><span>  <span>// Allocate and create the cartesian object here
</span></span></span><span><span> 9</span><span><span></span>  <span>pycart</span> <span>*</span><span>self</span><span>;</span>
</span></span><span><span>10</span><span>  <span>self</span> <span>=</span> <span>(</span><span>pycart</span> <span>*</span><span>)</span><span>type</span><span>-&gt;</span><span>tp_alloc</span><span>(</span><span>type</span><span>,</span> <span>0</span><span>);</span>
</span></span><span><span>11</span><span>  <span>if</span> <span>(</span><span>self</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>12</span><span>    <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>x</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>13</span><span>    <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>y</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>14</span><span>    <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>z</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>15</span><span>  <span>}</span>
</span></span><span><span>16</span><span>  <span>return</span> <span>(</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>;</span>
</span></span><span><span>17</span><span><span>}</span>
</span></span></code></pre></div><h3 id="boilerplate-and-builds">Boilerplate and Builds</h3><p>We round off the extension by adding some doc-strings and also setting
up the module itself. The code for the module itself is then:</p><div><pre tabindex="0"><code data-lang="c"><span><span>  1</span><span><span>#ifndef PY_SSIZE_T_CLEAN
</span></span></span><span><span>  2</span><span><span>#define PY_SSIZE_T_CLEAN
</span></span></span><span><span>  3</span><span><span>#include</span> <span>&lt;stdio.h&gt;</span><span>
</span></span></span><span><span>  4</span><span><span>#endif </span><span>/* PY_SSIZE_T_CLEAN */</span><span>
</span></span></span><span><span>  5</span><span><span></span>
</span></span><span><span>  6</span><span><span>#include</span> <span>&#34;Python.h&#34;</span><span>
</span></span></span><span><span>  7</span><span><span>#include</span> <span>&#34;structmember.h&#34;</span><span>
</span></span></span><span><span>  8</span><span><span></span>
</span></span><span><span>  9</span><span><span>// Fortran-C stuff
</span></span></span><span><span> 10</span><span><span></span><span>#include</span> <span>&#34;vecf.h&#34;</span><span>
</span></span></span><span><span> 11</span><span><span></span>
</span></span><span><span> 12</span><span><span>// Python-C stuff
</span></span></span><span><span> 13</span><span><span></span>
</span></span><span><span> 14</span><span><span>// CPython compatible declaration
</span></span></span><span><span> 15</span><span><span></span><span>typedef</span> <span>struct</span> <span>{</span>
</span></span><span><span> 16</span><span>  <span>PyObject_HEAD</span>        <span>/* Do not move */</span>
</span></span><span><span> 17</span><span>  <span>cartesian</span> <span>ccart</span><span>;</span> <span>/* totally interoperable */</span>
</span></span><span><span> 18</span><span><span>}</span> <span>pycart</span><span>;</span>
</span></span><span><span> 19</span><span>
</span></span><span><span> 20</span><span><span>// Almost everything in the class must be static
</span></span></span><span><span> 21</span><span><span></span><span>static</span> <span>void</span> <span>pycart_dealloc</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span> 22</span><span>  <span>Py_TYPE</span><span>(</span><span>self</span><span>)</span><span>-&gt;</span><span>tp_free</span><span>((</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>);</span>
</span></span><span><span> 23</span><span><span>}</span>
</span></span><span><span> 24</span><span>
</span></span><span><span> 25</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>pycart_new</span><span>(</span><span>PyTypeObject</span> <span>*</span><span>type</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span>
</span></span><span><span> 26</span><span>                            <span>PyObject</span> <span>*</span><span>kwds</span><span>)</span> <span>{</span>
</span></span><span><span> 27</span><span>  <span>pycart</span> <span>*</span><span>self</span><span>;</span>
</span></span><span><span> 28</span><span>  <span>self</span> <span>=</span> <span>(</span><span>pycart</span> <span>*</span><span>)</span><span>type</span><span>-&gt;</span><span>tp_alloc</span><span>(</span><span>type</span><span>,</span> <span>0</span><span>);</span>
</span></span><span><span> 29</span><span>  <span>if</span> <span>(</span><span>self</span> <span>!=</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span> 30</span><span>    <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>x</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span> 31</span><span>    <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>y</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span> 32</span><span>    <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>z</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span> 33</span><span>  <span>}</span>
</span></span><span><span> 34</span><span>  <span>return</span> <span>(</span><span>PyObject</span> <span>*</span><span>)</span><span>self</span><span>;</span>
</span></span><span><span> 35</span><span><span>}</span>
</span></span><span><span> 36</span><span>
</span></span><span><span> 37</span><span><span>static</span> <span>int</span> <span>pycart_init</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>,</span> <span>PyObject</span> <span>*</span><span>args</span><span>,</span> <span>PyObject</span> <span>*</span><span>kwds</span><span>)</span> <span>{</span>
</span></span><span><span> 38</span><span>  <span>static</span> <span>char</span> <span>*</span><span>kwlist</span><span>[]</span> <span>=</span> <span>{</span><span>&#34;x&#34;</span><span>,</span> <span>&#34;y&#34;</span><span>,</span> <span>&#34;x&#34;</span><span>,</span> <span>NULL</span><span>};</span>
</span></span><span><span> 39</span><span>  <span>if</span> <span>(</span><span>!</span><span>PyArg_ParseTupleAndKeywords</span><span>(</span><span>args</span><span>,</span> <span>kwds</span><span>,</span> <span>&#34;|ddd&#34;</span><span>,</span> <span>kwlist</span><span>,</span> <span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>x</span><span>,</span>
</span></span><span><span> 40</span><span>                                   <span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>y</span><span>,</span> <span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>z</span><span>))</span>
</span></span><span><span> 41</span><span>    <span>return</span> <span>-</span><span>1</span><span>;</span>
</span></span><span><span> 42</span><span>  <span>return</span> <span>0</span><span>;</span>
</span></span><span><span> 43</span><span><span>}</span>
</span></span><span><span> 44</span><span>
</span></span><span><span> 45</span><span><span>static</span> <span>PyMemberDef</span> <span>pycart_members</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span> 46</span><span>    <span>{</span><span>&#34;x&#34;</span><span>,</span> <span>T_DOUBLE</span><span>,</span> <span>offsetof</span><span>(</span><span>pycart</span><span>,</span> <span>ccart</span><span>.</span><span>x</span><span>),</span> <span>0</span><span>,</span> <span>&#34;x coordinate&#34;</span><span>},</span>
</span></span><span><span> 47</span><span>    <span>{</span><span>&#34;y&#34;</span><span>,</span> <span>T_DOUBLE</span><span>,</span> <span>offsetof</span><span>(</span><span>pycart</span><span>,</span> <span>ccart</span><span>.</span><span>y</span><span>),</span> <span>0</span><span>,</span> <span>&#34;y coordinate&#34;</span><span>},</span>
</span></span><span><span> 48</span><span>    <span>{</span><span>&#34;z&#34;</span><span>,</span> <span>T_DOUBLE</span><span>,</span> <span>offsetof</span><span>(</span><span>pycart</span><span>,</span> <span>ccart</span><span>.</span><span>z</span><span>),</span> <span>0</span><span>,</span> <span>&#34;z coordinate&#34;</span><span>},</span>
</span></span><span><span> 49</span><span>    <span>{</span><span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span> 50</span><span><span>};</span>
</span></span><span><span> 51</span><span>
</span></span><span><span> 52</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>pycart_repr</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span> 53</span><span>  <span>char</span> <span>x</span><span>[</span><span>50</span><span>],</span> <span>y</span><span>[</span><span>50</span><span>],</span> <span>z</span><span>[</span><span>50</span><span>];</span>
</span></span><span><span> 54</span><span>  <span>sprintf</span><span>(</span><span>x</span><span>,</span> <span>&#34;%f&#34;</span><span>,</span> <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>x</span><span>);</span>
</span></span><span><span> 55</span><span>  <span>sprintf</span><span>(</span><span>y</span><span>,</span> <span>&#34;%f&#34;</span><span>,</span> <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>y</span><span>);</span>
</span></span><span><span> 56</span><span>  <span>sprintf</span><span>(</span><span>z</span><span>,</span> <span>&#34;%f&#34;</span><span>,</span> <span>self</span><span>-&gt;</span><span>ccart</span><span>.</span><span>z</span><span>);</span>
</span></span><span><span> 57</span><span>  <span>PyObject</span> <span>*</span><span>repr</span> <span>=</span> <span>PyUnicode_FromFormat</span><span>(</span><span>&#34;pycart(x: %s, y: %s, z: %s)&#34;</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>,</span> <span>z</span><span>);</span>
</span></span><span><span> 58</span><span>  <span>return</span> <span>repr</span><span>;</span>
</span></span><span><span> 59</span><span><span>}</span>
</span></span><span><span> 60</span><span>
</span></span><span><span> 61</span><span><span>static</span> <span>PyObject</span> <span>*</span><span>pycart_unitstep</span><span>(</span><span>pycart</span> <span>*</span><span>self</span><span>)</span> <span>{</span>
</span></span><span><span> 62</span><span>  <span>// Call Fortran on the internal representation
</span></span></span><span><span> 63</span><span><span></span>  <span>unit_step</span><span>(</span><span>&amp;</span><span>self</span><span>-&gt;</span><span>ccart</span><span>);</span>
</span></span><span><span> 64</span><span>  <span>Py_RETURN_NONE</span><span>;</span>
</span></span><span><span> 65</span><span><span>}</span>
</span></span><span><span> 66</span><span>
</span></span><span><span> 67</span><span><span>static</span> <span>PyMethodDef</span> <span>pycart_methods</span><span>[]</span> <span>=</span> <span>{</span>
</span></span><span><span> 68</span><span>    <span>{</span><span>&#34;unitstep&#34;</span><span>,</span> <span>(</span><span>PyCFunction</span><span>)</span><span>pycart_unitstep</span><span>,</span> <span>METH_NOARGS</span><span>,</span>
</span></span><span><span> 69</span><span>     <span>&#34;Modify the class members with the Fortran unit_step function&#34;</span><span>},</span>
</span></span><span><span> 70</span><span>    <span>{</span><span>NULL</span><span>}</span> <span>/* Sentinel */</span>
</span></span><span><span> 71</span><span><span>};</span>
</span></span><span><span> 72</span><span>
</span></span><span><span> 73</span><span><span>// Definition of type
</span></span></span><span><span> 74</span><span><span></span><span>static</span> <span>PyTypeObject</span> <span>t_pycart</span> <span>=</span> <span>{</span>
</span></span><span><span> 75</span><span>    <span>PyVarObject_HEAD_INIT</span><span>(</span><span>NULL</span><span>,</span> <span>0</span><span>)</span> <span>/* tp_head */</span>
</span></span><span><span> 76</span><span>        <span>.</span><span>tp_name</span> <span>=</span> <span>&#34;pycart.pycart&#34;</span><span>,</span>
</span></span><span><span> 77</span><span>    <span>.</span><span>tp_doc</span> <span>=</span> <span>PyDoc_STR</span><span>(</span><span>&#34;One coordinate (x, y, z)&#34;</span><span>),</span>
</span></span><span><span> 78</span><span>    <span>.</span><span>tp_basicsize</span> <span>=</span> <span>sizeof</span><span>(</span><span>pycart</span><span>),</span>
</span></span><span><span> 79</span><span>    <span>.</span><span>tp_itemsize</span> <span>=</span> <span>0</span><span>,</span>
</span></span><span><span> 80</span><span>    <span>.</span><span>tp_dealloc</span> <span>=</span> <span>pycart_dealloc</span><span>,</span>
</span></span><span><span> 81</span><span>    <span>.</span><span>tp_repr</span> <span>=</span> <span>pycart_repr</span><span>,</span>
</span></span><span><span> 82</span><span>    <span>.</span><span>tp_getattro</span> <span>=</span> <span>PyObject_GenericGetAttr</span><span>,</span>
</span></span><span><span> 83</span><span>    <span>.</span><span>tp_setattro</span> <span>=</span> <span>PyObject_GenericSetAttr</span><span>,</span>
</span></span><span><span> 84</span><span>    <span>.</span><span>tp_flags</span> <span>=</span> <span>Py_TPFLAGS_DEFAULT</span> <span>|</span> <span>Py_TPFLAGS_BASETYPE</span><span>,</span>
</span></span><span><span> 85</span><span>    <span>.</span><span>tp_members</span> <span>=</span> <span>pycart_members</span><span>,</span>
</span></span><span><span> 86</span><span>    <span>.</span><span>tp_methods</span> <span>=</span> <span>pycart_methods</span><span>,</span>
</span></span><span><span> 87</span><span>    <span>.</span><span>tp_init</span> <span>=</span> <span>pycart_init</span><span>,</span>          <span>/* tp_init */</span>
</span></span><span><span> 88</span><span>    <span>.</span><span>tp_alloc</span> <span>=</span> <span>PyType_GenericAlloc</span><span>,</span> <span>/* tp_alloc */</span>
</span></span><span><span> 89</span><span>    <span>.</span><span>tp_new</span> <span>=</span> <span>PyType_GenericNew</span><span>,</span>     <span>/* tp_new */</span>
</span></span><span><span> 90</span><span>    <span>.</span><span>tp_free</span> <span>=</span> <span>PyObject_Del</span><span>,</span>         <span>/* tp_free */</span>
</span></span><span><span> 91</span><span>    <span>// Add an attribute to show this is from Fortran
</span></span></span><span><span> 92</span><span><span></span><span>};</span>
</span></span><span><span> 93</span><span>
</span></span><span><span> 94</span><span><span>static</span> <span>char</span> <span>pycart_docs</span><span>[]</span> <span>=</span> <span>&#34;pycart: data type with x,y,z elements</span><span>\n</span><span>&#34;</span><span>;</span>
</span></span><span><span> 95</span><span>
</span></span><span><span> 96</span><span><span>static</span> <span>PyModuleDef</span> <span>pycartmodule</span> <span>=</span> <span>{</span><span>PyModuleDef_HEAD_INIT</span><span>,</span> <span>.</span><span>m_name</span> <span>=</span> <span>&#34;pycart&#34;</span><span>,</span>
</span></span><span><span> 97</span><span>                                   <span>.</span><span>m_doc</span> <span>=</span> <span>pycart_docs</span><span>,</span> <span>.</span><span>m_size</span> <span>=</span> <span>-</span><span>1</span><span>};</span>
</span></span><span><span> 98</span><span>
</span></span><span><span> 99</span><span><span>PyMODINIT_FUNC</span> <span>PyInit_pycart</span><span>(</span><span>void</span><span>)</span> <span>{</span>
</span></span><span><span>100</span><span>  <span>PyObject</span> <span>*</span><span>this_module</span><span>;</span>
</span></span><span><span>101</span><span>  <span>if</span> <span>(</span><span>PyType_Ready</span><span>(</span><span>&amp;</span><span>t_pycart</span><span>))</span>
</span></span><span><span>102</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>103</span><span>  <span>this_module</span> <span>=</span> <span>PyModule_Create</span><span>(</span><span>&amp;</span><span>pycartmodule</span><span>);</span>
</span></span><span><span>104</span><span>  <span>if</span> <span>(</span><span>this_module</span> <span>==</span> <span>NULL</span><span>)</span> <span>{</span>
</span></span><span><span>105</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>106</span><span>  <span>}</span>
</span></span><span><span>107</span><span>  <span>Py_INCREF</span><span>(</span><span>&amp;</span><span>t_pycart</span><span>);</span>
</span></span><span><span>108</span><span>  <span>if</span> <span>(</span><span>PyModule_AddObject</span><span>(</span><span>this_module</span><span>,</span> <span>&#34;pycart&#34;</span><span>,</span> <span>(</span><span>PyObject</span> <span>*</span><span>)</span><span>&amp;</span><span>t_pycart</span><span>)</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
</span></span><span><span>109</span><span>    <span>Py_DECREF</span><span>(</span><span>&amp;</span><span>t_pycart</span><span>);</span>
</span></span><span><span>110</span><span>    <span>Py_DECREF</span><span>(</span><span>this_module</span><span>);</span>
</span></span><span><span>111</span><span>    <span>return</span> <span>NULL</span><span>;</span>
</span></span><span><span>112</span><span>  <span>}</span>
</span></span><span><span>113</span><span>  <span>return</span> <span>this_module</span><span>;</span>
</span></span><span><span>114</span><span><span>}</span>
</span></span></code></pre></div><p>Which is coupled with a <code>meson.build</code> file:</p><div><pre tabindex="0"><code data-lang="meson"><span><span> 1</span><span><span>project</span><span>(</span><span>&#39;pyclass_bindc&#39;</span><span>,</span><span> </span><span>&#39;c&#39;</span><span>,</span><span> </span><span>&#39;fortran&#39;</span><span>,</span><span>
</span></span></span><span><span> 2</span><span><span>        </span><span>version</span><span> </span><span>:</span><span> </span><span>&#39;0.1&#39;</span><span>,</span><span>
</span></span></span><span><span> 3</span><span><span>        </span><span>default_options</span><span> </span><span>:</span><span> </span><span>[</span><span>&#39;warning_level=2&#39;</span><span>,</span><span>
</span></span></span><span><span> 4</span><span><span>                           </span><span>&#39;buildtype=debug&#39;</span><span>,</span><span>
</span></span></span><span><span> 5</span><span><span>                           </span><span>&#39;debug=true&#39;</span><span>,</span><span>
</span></span></span><span><span> 6</span><span><span>                          </span><span>])</span><span>
</span></span></span><span><span> 7</span><span><span>
</span></span></span><span><span> 8</span><span><span></span><span>py_mod</span><span> </span><span>=</span><span> </span><span>import</span><span>(</span><span>&#39;python&#39;</span><span>)</span><span>
</span></span></span><span><span> 9</span><span><span></span><span>py3</span><span> </span><span>=</span><span> </span><span>py_mod</span><span>.</span><span>find_installation</span><span>(</span><span>&#39;python3&#39;</span><span>)</span><span>
</span></span></span><span><span>10</span><span><span></span><span>py3_dep</span><span> </span><span>=</span><span> </span><span>py3</span><span>.</span><span>dependency</span><span>()</span><span>
</span></span></span><span><span>11</span><span><span></span><span>message</span><span>(</span><span>py3</span><span>.</span><span>path</span><span>())</span><span>
</span></span></span><span><span>12</span><span><span></span><span>message</span><span>(</span><span>py3</span><span>.</span><span>get_install_dir</span><span>())</span><span>
</span></span></span><span><span>13</span><span><span>
</span></span></span><span><span>14</span><span><span></span><span># Python Class Representation</span><span>
</span></span></span><span><span>15</span><span><span></span><span>py3</span><span>.</span><span>extension_module</span><span>(</span><span>&#39;pycart&#39;</span><span>,</span><span>
</span></span></span><span><span>16</span><span><span>           </span><span>&#39;vec.f90&#39;</span><span>,</span><span>
</span></span></span><span><span>17</span><span><span>           </span><span>&#39;pyclassderived.c&#39;</span><span>,</span><span>
</span></span></span><span><span>18</span><span><span>           </span><span>dependencies</span><span> </span><span>:</span><span> </span><span>py3_dep</span><span>,</span><span>
</span></span></span><span><span>19</span><span><span>           </span><span>install</span><span> </span><span>:</span><span> </span><span>true</span><span>)</span><span>
</span></span></span></code></pre></div><h3 id="usage">Usage</h3><p>This can built and used as:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>meson setup bbdir
</span></span><span><span>2</span><span>meson compile -C bbdir
</span></span><span><span>3</span><span>python -c <span>&#34;import bbdir.pycart as pycart; aak = pycart.pycart(1,10,2); print(aak); aak.unitstep(); print(aak)&#34;</span>
</span></span><span><span>4</span><span>pycart<span>(</span>x: 1.000000, y: 10.000000, z: 2.000000<span>)</span>
</span></span><span><span>5</span><span>pycart<span>(</span>x: 2.000000, y: 11.000000, z: 3.000000<span>)</span>
</span></span></code></pre></div><h2 id="conclusions">Conclusions</h2><p>One of the best aspects of this approach is that the language pairs and
representations line up nicely to prevent any extraneous copy
operations. Representing the module subroutine as a class member
function is a design choice unlikely to be made when generating bindings
from <code>f2py</code>, but this was more for exploratory purposes.</p><p>To end on a rather provocative note <sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>, consider the timings for
the wrapped derived type <code>pycart</code> and its equivalent pure-Python
<code>fakecart</code> in Fig. 1 below:</p><figure><img src="https://d33wubrfki0l68.cloudfront.net/f0368ec63ffb6876a284d382f88311703346d9fe/4f7ea/ox-hugo/fdtclasstimings.png" alt="Figure 1: Results of comparing the pure-python class (fakecart) to the C-extension class backed by a Fortran derived type (pycart)"/><figcaption><p><span>Figure 1: </span>Results of comparing the pure-python class (<code>fakecart</code>) to the C-extension class backed by a Fortran derived type (<code>pycart</code>)</p></figcaption></figure><p>All the code for this post, along with other Fortran derived type
representations is present <a href="https://github.com/HaoZeke/f2py_derived_nep/tree/main/">in this
repository</a>
under the examples folder.</p><h3 id="addendum-and-future-directions">Addendum and Future Directions</h3><p>I had the pleasure of demonstrating part of this logic to fellow NumPy
maintainers Dr. Pearu Peterson and Dr. Melissa Weber Mendonça and we
were in agreement that the class strategy is the most flexible <sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>.
Pearu suggested leveraging pointers passed between Fortran and C in an
attempt to cover more than <code>bind(c)</code> compatible code, by generating
simpler Fortran wrapper functions as well, and those will likely be
among the next steps forward. The work of Pletzer et al.
(<a href="#ref-pletzerExposingFortranDerived2008">2008</a>) is also of interest,
although their focus was on exposing a series of <code>C</code> functions which
call <code>Fortran</code> methods.</p><h2 id="references">References</h2><div id="refs"><p>Pletzer, Alexander, Douglas McCune, Stefan Muszala, Srinath Vadlamani,
and Scott Kruger. 2008. “Exposing Fortran Derived Types to C and Other
Languages.” <em>Computing in Science Engineering</em> 10 (4): 86–92.
<a href="https://doi.org/10.1109/MCSE.2008.94">https://doi.org/10.1109/MCSE.2008.94</a>.</p></div></div></div>
  </body>
</html>
