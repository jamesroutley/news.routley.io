<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.fb.com/2024/06/24/data-infrastructure/leveraging-ai-for-efficient-incident-response/">Original</a>
    <h1>Leveraging AI for efficient incident response</h1>
    
    <div id="readability-page-1" class="page"><div>

		<ul>
<li aria-level="1"><span>We’re sharing how we streamline system reliability investigations using a new AI-assisted root cause analysis system.</span></li>
<li aria-level="1"><span>The system uses a combination of heuristic-based retrieval and large language model-based ranking to speed up root cause identification during investigations.</span></li>
<li aria-level="1"><span>Our testing has shown this new system achieves </span><span>42%</span><span> accuracy in identifying root causes for investigations at their creation time related to our web monorepo.</span></li>
</ul>
<p><span>Investigation is a critical part of ensuring system reliability, and a prerequisite to mitigating issues quickly. This is why Meta is investing in advancing our suite of investigation tooling with tools like</span><a href="https://engineering.fb.com/2023/12/19/data-infrastructure/hawkeye-ai-debugging-meta/"> <span>Hawkeye</span></a><span>, which we use internally for debugging end-to-end machine learning workflows.</span></p>
<p><span>Now, we’re leveraging AI to advance our investigation tools even further. We’ve streamlined our investigations through a combination of heuristic-based retrieval and large language model (LLM)-based ranking to provide AI-assisted root cause analysis. During backtesting, this system has achieved promising results: 42% accuracy in identifying root causes for investigations at their creation time related to our web monorepo.</span></p>
<p><iframe title="YouTube video player" src="https://www.youtube.com/embed/rpe7eAR90Ko?si=psc3nyqMqI9lsu2P" width="640" height="360" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p>
<h2><span>Investigations at Meta</span></h2>
<p><span>Every investigation is unique. But identifying the root cause of an issue is necessary to mitigate it properly.  Investigating issues in systems dependent on </span><a href="https://en.wikipedia.org/wiki/Monorepo"><span>monolithic repositories</span></a><span> can present scalability challenges due to the accumulating number of changes involved across many teams. In addition, responders need to build context on the investigation to start working on it, e.g., what is broken, which systems are involved, and who might be impacted. </span></p>
<p><span>These challenges can make investigating anomalies a complex and time consuming process. AI offers an opportunity to streamline the process, reducing the time needed and helping responders make better decisions. We focused on building a system capable of identifying potential code changes that might be the root cause for a given investigation.</span></p>
<figure id="attachment_21395" aria-describedby="caption-attachment-21395"><img decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-1.png?w=672" alt="" width="672" height="255" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-1.png 672w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-1.png?resize=96,36 96w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-1.png?resize=192,73 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21395">Figure 1: A responder’s view of an investigation journey.</figcaption></figure>
<h2><span>Our approach to root cause isolation</span></h2>
<p><span>The system incorporates a novel heuristics-based retriever that is capable of reducing the search space from thousands of changes to a few hundred without significant reduction in accuracy using, for example., code and directory ownership or exploring the runtime code graph of impacted systems. Once we have reduced the search space to a few hundred changes relevant to the ongoing investigation, we rely on a LLM-based ranker system to identify the root cause across these changes.</span></p>
<figure id="attachment_21396" aria-describedby="caption-attachment-21396"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?w=1024" alt="" width="1024" height="455" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png 1910w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?resize=916,407 916w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?resize=768,341 768w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?resize=1024,455 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?resize=1536,682 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?resize=96,43 96w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-2.png?resize=192,85 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21396">Figure 2: The system flow for our AI-assisted root cause analysis system.</figcaption></figure>
<p><span>The ranker system uses a </span><a href="https://llama.meta.com/"><span>Llama</span></a><span> model to further reduce the search space from hundreds of potential code changes to a list of the top five. We explored different ranking algorithms and prompting scenarios and found that ranking through election was most effective to accommodate context window limitations and enable the model to reason across different changes. To rank the changes, we structure prompts to contain a maximum of 20 changes at a time, asking the LLM to identify the top five changes. The output across the LLM requests are aggregated and the process is repeated until we have only five candidates left. Based on exhaustive backtesting, with historical investigations and the information available at their start, 42% of these investigations had the root cause in the top five suggested code changes.</span></p>
<figure id="attachment_21397" aria-describedby="caption-attachment-21397"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?w=1024" alt="" width="1024" height="621" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png 1999w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?resize=916,555 916w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?resize=768,466 768w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?resize=1024,621 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?resize=1536,931 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?resize=96,58 96w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-3.png?resize=192,116 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21397">Figure 3: Ranking possible code changes through election.</figcaption></figure>
<h2><span>Training</span></h2>
<p><span>The biggest lever to achieving </span><span>42%</span><span> accuracy was fine-tuning a Llama 2 (7B) model using historical investigations for which we knew the underlying root cause. We started by running continued pre-training (CPT) using limited and approved internal wikis, Q&amp;As, and code to expose the model to Meta artifacts. Later, we ran a supervised fine-tuning (SFT) phase where we mixed </span><span>Llama</span><span> 2’s original SFT data with more internal context and a dedicated investigation root cause analysis (RCA) SFT dataset to teach the model to follow RCA instructions.</span></p>
<figure id="attachment_21398" aria-describedby="caption-attachment-21398"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-4.png?w=896" alt="" width="896" height="407" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-4.png 896w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-4.png?resize=768,349 768w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-4.png?resize=96,44 96w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-4.png?resize=192,87 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21398">Figure 4: The Llama 2 (7B) root cause analysis training process.</figcaption></figure>
<p><span>Our RCA SFT dataset consists of ~5,000 instruction-tuning examples with details of 2-20 changes from our retriever, including the known root cause, and information known about the investigation at its start, e.g., its title and observed impact. Naturally, the available information density is low at this point, however this allows us to perform better in similar real-world scenarios when we have limited information at the beginning of the investigation. </span></p>
<p><span>Using the same fine-tuning data format for each possible culprit then allows us to gather the model’s llog probabilities(logprobs) and rank our search space based on relevancy to a given investigation. We then curated a set of similar fine-tuning examples where we expect the model to yield a list of potential code changes likely responsible for the issue ordered by their logprobs-ranked relevance, with the expected root cause at the start. Appending this new dataset to the original RCA SFT dataset and re-running SFT gives the model the ability to respond appropriately to prompts asking for ranked lists of changes relevant to the investigation.</span></p>
<figure id="attachment_21399" aria-describedby="caption-attachment-21399"><img loading="lazy" decoding="async" src="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?w=1024" alt="" width="1024" height="467" srcset="https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png 1999w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?resize=916,417 916w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?resize=768,350 768w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?resize=1024,467 1024w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?resize=1536,700 1536w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?resize=96,44 96w, https://engineering.fb.com/wp-content/uploads/2024/06/AI-investigations_image-5.png?resize=192,87 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-21399">Figure 5: The process for generating fine-tuning prompts to enable the LLM to produce ranked lists.</figcaption></figure>
<h2><span>The future of AI-assisted Investigations</span></h2>
<p><span>The application of AI in this context presents both opportunities and risks. For instance, it can reduce effort and time needed to root cause an investigation significantly, but it can potentially suggest wrong root causes and mislead engineers. To mitigate this, we ensure that all employee-facing features prioritize closed feedback loops and explainability of results. This strategy ensures that responders can independently reproduce the results generated by our systems to validate their results. We also rely on confidence measurement methodologies to detect low confidence answers and avoid recommending them to the users – sacrificing reach in favor of precision.</span></p>
<p><span>By integrating AI-based systems into our internal tools we’ve successfully leveraged them for tasks like onboarding engineers to investigations and root cause isolation. Looking ahead, we envision expanding the capabilities of these systems to autonomously execute full workflows and validate their results. Additionally, we anticipate that we can further streamline the development process by utilizing AI to detect potential incidents prior to code push, thereby proactively mitigating risks before they arise.</span></p>
<h2>Acknowledgements</h2>
<p><i><span>We wish to thank contributors to this effort across many teams throughout Meta, particularly Alexandra Antiochou, Beliz Gokkaya, Julian Smida, Keito Uchiyama, Shubham Somani; and our leadership: Alexey Subach, Ahmad Mamdouh Abdou, Shahin Sefati, Shah Rahman, Sharon Zeng, and Zach Rait. </span></i></p>

		
	</div></div>
  </body>
</html>
