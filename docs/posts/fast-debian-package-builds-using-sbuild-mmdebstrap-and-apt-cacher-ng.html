<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://stephan.lachnit.xyz/posts/2023-02-08-debian-sbuild-mmdebstrap-apt-cacher-ng/">Original</a>
    <h1>Fast Debian package builds using sbuild, mmdebstrap and apt-cacher-ng</h1>
    
    <div id="readability-page-1" class="page"><div>
      
      <main>
        
  <div>
    
    <div>
      
      <p>In this post I will give a quick tutorial on how to set up fast Debian package builds using <code>sbuild</code> with <code>mmdebstrap</code> and <code>apt-cacher-ng</code>.</p>
<p>The usual tool for building Debian packages is <code>dpkg-buildpackage</code>, or a user-friendly wrapper like <code>debuild</code>, and while these are geat tools, if you want to upload something to the Debian archive they lack the required separation from the system they are run on to ensure that your packaging also works on a different system. The usual candidate here is <code>sbuild</code>. But setting up a <code>schroot</code> is tedious and performance tuning can be annoying. There is an alternative backend for <code>sbuild</code> that promises to make everything simpler: <code>unshare</code>. In this tutorial I will show you how to set up <code>sbuild</code> with this backend.</p>
<p>Additionally to the normal performance tweaking, caching downloaded packages can be a huge performance increase when rebuilding packages. I do rebuilds quite often, mostly when a new dependency got introduced I didn’t specify in <code>debian/control</code> yet or <code>lintian</code> notices a something I can easily fix. So let’s begin with setting up this caching.</p>

<p>Install <code>apt-cacher-ng</code>:</p>
<pre tabindex="0"><code>sudo apt install apt-cacher-ng
</code></pre><p>A pop-up will appear, if you are unsure how to answer it select no, we don’t need it for this use-case.</p>
<p>To enable <code>apt-cacher-ng</code> on your system, create <code>/etc/apt/apt.conf.d/02proxy</code> and insert:</p>
<pre tabindex="0"><code>Acquire::http::proxy &#34;http://127.0.0.1:3142&#34;;
Acquire::https::proxy &#34;DIRECT&#34;;
</code></pre><p>In <code>/etc/apt-cacher-ng/acng.conf</code> you can increase the value of <code>ExThreshold</code> to hold packages for a shorter or longer duration.
The length depends on your specific use case and resources. A longer threshold takes more disk space, a short threshold like one day effecitvely only reduces the build time for rebuilds.</p>
<p>If you encounter weird issues on <code>apt update</code> at some point the future, you can try to clean the cache from <code>apt-cacher-ng</code>.
You can use this script:
</p>

<p>Install <code>mmdebstrap</code>:</p>
<pre tabindex="0"><code>sudo apt install mmdebstrap
</code></pre><p>We will create a small helper script to ease creating a chroot. Open <code>~/.local/bin/mmupdate</code> and insert:</p>
<pre tabindex="0"><code>#!/bin/sh
mmdebstrap \
  --variant=buildd \
  --aptopt=&#39;Acquire::http::proxy &#34;http://127.0.0.1:3142&#34;;&#39; \
  --arch=amd64 \
  --components=main,contrib,non-free \
  unstable \
  ~/.cache/sbuild/unstable-amd64.tar.xz \
  http://deb.debian.org/debian
</code></pre><p>Notes:</p>
<ul>
<li><code>aptopt</code> enables <code>apt-cacher-ng</code> inside the chroot.</li>
<li><code>--arch</code> sets the CPU architecture (see <a href="https://wiki.debian.org/SupportedArchitectures">Debian Wiki</a>).</li>
<li><code>--components</code> sets the archive components, if you don’t want non-free pacakges you might want to remove some entries here.</li>
<li><code>unstable</code> sets the Debian release, you can also set for example <code>bookworm-backports</code> here.</li>
<li><code>unstable-amd64.tar.xz</code> is the output tarball containing the chroot, change accordingly to your pick of the CPU architecture and Debian release.</li>
<li><code>http://deb.debian.org/debian</code> is the Debian mirror, you should set this to the same one you use in your <code>/etc.apt/sources.list</code>.</li>
</ul>
<p>Make <code>mmupdate</code> executable and run it once:</p>
<pre tabindex="0"><code>chmod +x ~/.local/bin/mmupdate
mkdir -p ~/.cache/sbuild
~/.local/bin/mmupdate
</code></pre><p>If you execute <code>mmupdate</code> again you can see that the downloading stage is much faster thanks to <code>apt-cacher-ng</code>. For me the difference is from about 115s to about 95s. Your results may vary, this depends on the speed of your internet, Debian mirror and disk.</p>
<p>If you have used the <code>schroot</code> backend and <code>sbuild-update</code> before, you probably notice that creating a new chroot with <code>mmdebstrap</code> is slower. It would be a bit annoying to do this manually before we start a new Debian packaging session, so let’s create a systemd service that does this for us.</p>
<p>First create a folder for user services:</p>
<pre tabindex="0"><code>mkdir -p ~/.config/systemd/user
</code></pre><p>Create <code>~/.config/systemd/user/mmupdate.service</code> and add:</p>
<pre tabindex="0"><code>[Unit]
Description=Run mmupdate
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=%h/.local/bin/mmupdate
</code></pre><p>Start the service and test that it works:</p>
<pre tabindex="0"><code>systemctl --user daemon-reload
systemctl --user start mmupdate
systemctl --user status mmupdate
</code></pre><p>Create <code>~/.config/systemd/user/mmupdate.timer</code>:</p>
<pre tabindex="0"><code>[Unit]
Description=Run mmupdate daily

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
</code></pre><p>Enable the timer:</p>
<pre tabindex="0"><code>systemctl --user enable mmupdate.timer
</code></pre><p>Now every day <code>mmupdte</code> will be run automatically. You can adjust the period if you think daily rebuilds are a bit excessive.</p>
<p>A neat advantage of period rebuilds is that they the base files in your <code>apt-cacher-ng</code> cache warm every time they run.</p>

<p>Install <code>sbuild</code> and (optionally) <code>autopkgtest</code>:</p>
<pre tabindex="0"><code>sudo apt install --no-install-recommends sbuild autopkgtest
</code></pre><p>Create <code>~/.sbuildrc</code> and insert:</p>
<pre tabindex="0"><code># backend for using mmdebstrap chroots
$chroot_mode = &#39;unshare&#39;;

# build in tmpfs
$unshare_tmpdir_template = &#39;/dev/shm/tmp.sbuild.XXXXXXXXXX&#39;;

# upgrade before starting build
$apt_update = 1;
$apt_upgrade = 1;

# build everything including source for source-only uploads
$build_arch_all = 1;
$build_arch_any = 1;
$build_source = 1;
$source_only_changes = 1;

# go to shell on failure instead of exiting
$external_commands = { &#34;build-failed-commands&#34; =&gt; [ [ &#39;%SBUILD_SHELL&#39; ] ] };

# always clean build dir, even on failure
$purge_build_directory = &#34;always&#34;;

# run lintian
$run_lintian = 1;
$lintian_opts = [ &#39;-i&#39;, &#39;-I&#39;, &#39;-E&#39;, &#39;--pedantic&#39; ];

# do not run piuparts
$run_piuparts = 0;

# run autopkgtest
$run_autopkgtest = 1;
$autopkgtest_root_args = &#39;&#39;;
$autopkgtest_opts = [ &#39;--apt-upgrade&#39;, &#39;--&#39;, &#39;unshare&#39;, &#39;--release&#39;, &#39;%r&#39;, &#39;--arch&#39;, &#39;%a&#39; ];

# set uploader for correct signing
$uploader_name = &#39;Stephan Lachnit &lt;stephanlachnit@debian.org&gt;&#39;;
</code></pre><p>You should adjust <code>uploader_name</code>. If you don’t want to run <code>autopkgtest</code> or <code>lintian</code> by default you can also disable it here. Note that for packages that need a lot of space for building, you might want to comment the <code>unshare_tmpdir_template</code> line to prevent a OOM build failure.</p>
<p>You can now build your Debian packages with the <code>sbuild</code> command :)</p>

<p>You can add these variables to your <code>~/.bashrc</code> as bonus (with adjusted name / email):</p>
<pre tabindex="0"><code>export DEBFULLNAME=&#34;&lt;your_name&gt;&#34;
export DEBEMAIL=&#34;&lt;your_email&gt;&#34;
export DEB_BUILD_OPTIONS=&#34;parallel=&lt;threads&gt;&#34;
</code></pre><p>In particular adjust the value of <code>parallel</code> to ensure parallel builds.</p>
<p>If you are new to signing / uploading your package, first install the required tools:</p>
<pre tabindex="0"><code>sudo apt install devscripts dput-ng
</code></pre><p>Create <code>~/.devscripts</code> and insert:</p>
<pre tabindex="0"><code>DEBSIGN_KEYID=&lt;your_gpg_fingerpring&gt;
USCAN_SYMLINK=rename
</code></pre><p>You can now sign the <code>.changes</code> file with:</p>
<pre tabindex="0"><code>debsign ../&lt;pkgname_version_arch&gt;.changes
</code></pre><p>And for source-only uploads with:</p>
<pre tabindex="0"><code>debsign -S ../&lt;pkgname_version_arch&gt;_source.changes
</code></pre><p>If you don’t introduce a new binary package, you always want to go with source-only changes.</p>
<p>You can now upload the package to Debian with</p>
<pre tabindex="0"><code>dput ../&lt;filename&gt;.changes
</code></pre>
<p><a href="https://wiki.debian.org/sbuild">https://wiki.debian.org/sbuild</a> </p>
</div>
    

    
  </div>

      </main>
    </div></div>
  </body>
</html>
