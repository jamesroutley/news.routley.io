<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.bofh.it/debian/id_465">Original</a>
    <h1>I replaced grub with systemd-boot</h1>
    
    <div id="readability-page-1" class="page"><div id="content">

  
  <div>
  
    <p><span>Wed, 15 Feb 2023</span></p><h3><a name="465">I replaced grub with systemd-boot</a></h3>
  <p>To be able to investigate and work on the the measured boot features I have switched from grub to systemd-boot (sd-boot).</p>

<p>This initial step is optional, but it is useful because this way <code>/etc/kernel/cmdline</code> will become the new place where the kernel command line can be configured:</p>
<pre>. /etc/default/grub
echo &#34;root=/dev/mapper/root $GRUB_CMDLINE_LINUX $GRUB_CMDLINE_LINUX_DEFAULT&#34; &gt; /etc/kernel/cmdline
</pre>

<p>Do not forget to set the correct root file system there, because initramfs-tools does not support discovering it at boot time using the <a href="https://uapi-group.org/specifications/specs/discoverable_partitions_specification/">Discoverable Partitions Specification</a>.</p>

<p>The installation has not been automated yet out of an abundance of caution (but we will work on it soon), so after installing the package I had to run <code>bootctl</code> to install sd-boot in the <abbr title="EFI system partition">ESP</abbr> and enable it in the UEFI boot sequence and then I created boot loader entries for the kernels already installed on the system:</p>
<pre>apt install systemd-boot

bootctl install
for kernel in /boot/vmlinuz-*; do
  kernel-install add &#34;${kernel#*/vmlinuz-}&#34; &#34;$kernel&#34;
done
</pre>

<p>I like to show the boot menu by default, at least until I will be more familiar with sd-boot:</p>
<pre>bootctl set-timeout 4
</pre>

<p>Since other UEFI binaries can be easily chainloaded, I am also going to keep around grub for a while, just to be sure:</p>
<pre>cat &lt;&lt;END &gt; /boot/efi/loader/entries/grub.conf
title Grub
linux /EFI/debian/grubx64.efi
END
</pre>

<p>At this point sd-boot works, but I still had to enable secure boot. So far sd-boot has not been signed with a Debian key known to the <a href="https://github.com/rhboot/shim/">shim bootloader</a>, so I needed to create a Machine Owner Key (MOK), enroll it in UEFI and then use it to sign everything.</p><p>I dislike the complexity of mokutil and the other related programs, so after removing it and the boot shim I have decided to use <a href="https://github.com/Foxboron/sbctl/">sbctl</a> instead. With it I easily created new keys, enrolled them in the EFI key store and then signed everything:

</p><pre>sbctl create-keys
sbctl enroll-keys
for file in /boot/efi/*/*/linux /boot/efi/EFI/*/*.efi; do
  ./sbctl sign -s $file
done
</pre>

<p>Since <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1030845">there is no sbctl package yet</a> I need to make sure that also the kernels installed in the future will be automatically signed, so I have created a trivial script in <code>/etc/kernel/install.d/</code> which automatically runs <code>sbctl sign -s</code> or <code>sbctl remove-file</code>.

</p><p>The <a href="https://wiki.debian.org/SecureBoot">Debian wiki SecureBoot page</a> documents how do do this with <a href="https://packages.debian.org/sid/mokutil">mokutil</a> and <a href="https://packages.debian.org/sid/sbsigntool">sbsigntool</a>, but I think that sbctl is much friendlier.</p>

<p>As a bonus, I have also added to the boot menu the excellent Debian-based <a href="https://www.grml.org/">GRML</a> live distribution. Since sd-boot is not capable of loopback-mounting CD-ROM images like grub, I first had to extract the kernel and initramfs and copied them to the ESP:</p><pre>mount -o loop /boot/grml/grml64-full_2022.11.iso /mnt/
mkdir /boot/efi/grml/
cp /mnt/boot/grml64full/* /boot/efi/grml/
umount /mnt/

cat &lt;&lt;END &gt; /boot/efi/loader/entries/grml.conf
title GRML
linux /grml/vmlinuz
initrd /grml/initrd.img
options boot=live bootid=grml64full202211 findiso=/grml/grml64-full_2022.11.iso live-media-path=/live/grml64-full net.ifnames=0 
END
</pre>

<p>As expected, after a reboot <tt>bootctl</tt> reports the new security features:</p>
<pre><b>System:</b>
      Firmware: <b>UEFI 2.70 (Lenovo 0.4496)</b>
 Firmware Arch: x64
   Secure Boot: enabled (user)
  TPM2 Support: <b>yes</b>
  Boot into FW: supported

<b>Current Boot Loader:</b>
      Product: <b>systemd-boot 252.5-2</b>
     Features: <b>✓</b> Boot counting
               <b>✓</b> Menu timeout control
               <b>✓</b> One-shot menu timeout control
               <b>✓</b> Default entry control
               <b>✓</b> One-shot entry control
               <b>✓</b> Support for XBOOTLDR partition
               <b>✓</b> Support for passing random seed to OS
               <b>✓</b> Load drop-in drivers
               <b>✓</b> Support Type #1 sort-key field
               <b>✓</b> Support @saved pseudo-entry
               <b>✓</b> Support Type #1 devicetree field
               <b>✓</b> Boot loader sets ESP information
          ESP: /dev/disk/by-partuuid/1b767f8e-70fa-5a48-b444-cfe5c272d66e
         File: └─/EFI/systemd/systemd-bootx64.efi

<i>...</i>
</pre>

<p>Relevant documentation:</p><ul>
<li><a href="https://manpages.debian.org/unstable/systemd-boot/systemd-boot.7.html">systemd-boot(7)</a></li>
<li><a href="https://manpages.debian.org/unstable/systemd-boot/systemd-cryptenroll.1.html">systemd-cryptenroll(1)</a></li>
<li><a href="https://github.com/Foxboron/sbctl/">sbctl</a></li>
<li><a href="https://uapi-group.org/specifications/specs/boot_loader_specification/">Boot Loader Specification</a></li>
<li><a href="https://uapi-group.org/specifications/specs/unified_kernel_image/">Unified Kernel Image (UKI)</a></li>
</ul>

  
  </div>


</div></div>
  </body>
</html>
