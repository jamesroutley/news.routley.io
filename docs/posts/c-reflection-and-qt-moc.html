<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wiki.qt.io/C%2B%2B_reflection_%28P2996%29_and_moc">Original</a>
    <h1>C&#43;&#43; Reflection and Qt MOC</h1>
    
    <div id="readability-page-1" class="page"><div id="mw-content-text" lang="en" dir="ltr"><div><p>This is a WORK IN PROGRESS page to understand the implications of &#34;Reflection for C++&#34; for the future of Qt and moc. 
</p>


<h2><span id="TL.3BDR"></span><span id="TL;DR">TL;DR</span></h2>
<ul><li>Reflection in C++26 might be insufficient for replacing moc.</li>
<li>We may require token injection, function definition, string-based lookup; at least the first is C++29 material, don&#39;t know about the others.</li>
<li>Extra fancy features like outputting extra JSON files (or embedding JSON in plugins) may be out of scope for this work.</li></ul>
<h2><span id="Why.3F"></span><span id="Why?">Why?</span></h2>
<p>moc extracts interesting metadata from QObject subclasses / gadgets / namespaces. This metadata is then used at runtime to implement many different QMetaObject facilities.
</p><p>C++26 will (likely) ship with compile-time reflection. This means that the work that moc does today (as an external tool, with its custom lexer and parser etc.) could be done by the compiler itself. In the future, this may unlock lots of interesting possibilities (e.g. templated QObjects) and reduce technical debt (no need to maintain our own C++ parser for moc).
</p><p>However, we&#39;re not sure how to get there just yet. Some questions that this work aims to answer:
</p>
<ul><li>Can we replace moc with a pure C++ solution?
<ul><li>Is there something missing from standard C++ that we need for moc?</li></ul></li>
<li>How many source code (API) breaks are to be expected?
<ul><li>If there&#39;s breakage, can porting tools automate the transition?</li></ul></li>
<li>Are there going to be issues with buildsystems?</li></ul>
<h2><span id="Reflection_for_Standard_C.2B.2B:_references"></span><span id="Reflection_for_Standard_C++:_references">Reflection for Standard C++: references</span></h2>
<p>Papers that are interesting for Qt:
</p>
<ul><li>P2996 &#34;Reflection for C++26&#34; <a rel="nofollow" href="https://wg21.link/P2996">https://wg21.link/P2996</a></li>
<li>P3394 &#34;Annotations for Reflection&#34; <a rel="nofollow" href="https://wg21.link/P3394">https://wg21.link/P3394</a></li>
<li>P3096 &#34;Function Parameter Reflection in Reflection for C++26&#34; <a rel="nofollow" href="https://wg21.link/P3096">https://wg21.link/P3096</a></li>
<li>P3491 &#34;define_static_{string,object,array}&#34; <a rel="nofollow" href="https://wg21.link/P3491">https://wg21.link/P3491</a></li>
<li>P3294 &#34;Code Injection with Token Sequences&#34; <a rel="nofollow" href="https://wg21.link/P3294">https://wg21.link/P3294</a></li>
<li>P1306 &#34;Expansion Statements&#34; <a rel="nofollow" href="https://wg21.link/P1306">https://wg21.link/P1306</a></li></ul>
<h2></h2>
<p>moc extracts:
</p>
<ul><li>the class name</li>
<li>the parent class name (following QObject&#39;s inheritance chain)</li>
<li>properties (Q_PROPERTY)</li>
<li>invokables (methods marked with Q_INVOKABLE, Q_SIGNAL, Q_SLOT; may include constructors)
<ul><li>for each invokable, also the parameter lists, i.e. types+names of the arguments; and whether they&#39;re defaulted (Qt considers these as separate overloads)</li>
<li>the revision number  (Q_REVISION)</li></ul></li>
<li>Q_CLASSINFO metadata</li>
<li>Q_ENUM and Q_FLAGS</li>
<li>Q_INTERFACES</li></ul>
<h3></h3>
<h4><span id="Class_name">Class name</span></h4>
<p>Should there be no problems, `display_string_of` and friends give us this info.
</p>
<h4><span id="Parent_class">Parent class</span></h4>
<p>Again, no problems. Can use `bases_of` and extract the first (or even identify the one that gives us access to QObject). This can be spliced to access that class&#39; metaobject and chain the metaobject to the parent&#39;s.
</p>
<h5><span id="Invokables">Invokables</span></h5>
<p>Marking them with `signals:` or `public slots:` is not going to work.
</p><p>Instead, we have to use per-invokable markers. We already have Q_SIGNAL, Q_SLOT, Q_INVOKABLE, which are a bit verbose, get the job done. One can even concoct a porting tool...?
</p><p>We&#39;ll need to have those macros expand to some annotation (see P3394, for instance `[[=Qt::signal{}]]` or similar); when reflecting we&#39;ll then be able to query for these annotations and extract the relevant function(s).
</p><p>We also have to extract the (meta)types and the parameter names (needed e.g. for QML). This should be perfectly possible using P3096. The &#34;limitation&#34; of having matching parameter names across all declarations isn&#39;t so stringent (in theory at least).
</p>
<h5><span id="Properties">Properties</span></h5><p>
At the moment declaring a property looks like this: </p><div dir="ltr"><pre><span></span><span>Q_PROPERTY</span><span>(</span><span>Type</span><span> </span><span>propName</span><span> </span><span>READ</span><span> </span><span>getProp</span><span> </span><span>WRITE</span><span> </span><span>setProp</span><span> </span><span>NOTIFY</span><span> </span><span>propChanged</span><span> </span><span>RESET</span><span> </span><span>resetProp</span><span> </span><span>[...])</span><span></span>
</pre></div><p>This is basically a &#34;bag of data&#34; that moc tokenizes (the sequence is pretty much &#34;free form&#34;). The individual &#34;attributes&#34; of a property are extracted and set in the metaobject. Q_PROPERTY itself expands to nothing.
There&#39;s a bunch of related problems here: in a reflection world we need Q_PROPERTY to expand to <i>something</i> that describes the property. It could be as simple as a tagged string_view:</p><div dir="ltr"><pre><span></span><span>[[</span><span>=</span><span>Qt</span><span>::</span><span>property</span><span>{}]]</span><span> </span>
<span>static</span><span> </span><span>constexpr</span><span> </span><span>std</span><span>::</span><span>string_view</span><span> </span><span>qt_property_COUNTER</span><span> </span><span>=</span><span></span>
<span>    </span><span>&#34;Type propName READ getProp WRITE setProp NOTIFY propChanged RESET resetProp [...]&#34;</span><span>;</span><span></span>
</pre></div><p>We can certainly tokenize the string (i.e. Q_PROPERTY&#39;s argument) at compile time, all it&#39;s needed is a consteval function (after all that&#39;s what std::format does for the format string).
</p><p><b>However P2996&#39;s reflection (AFAICT) does not give us string-based reflection.</b> In other words, given &#34;getProp&#34; as a string, we would need to &#34;look it up&#34; in the class context and get  something like a PMF out of it. That does not seem possible at the moment. :-(
</p><p>
We could engineer an alternative, more structured way to declare properties, for instance something like:</p><div dir="ltr"><pre><span></span><span>constexpr</span><span> </span><span>static</span><span> </span><span>QProperty</span><span>&lt;</span><span>Class</span><span>,</span><span> </span><span>int</span><span>&gt;</span><span> </span><span>prop</span><span> </span><span>=</span><span> </span><span>{</span><span></span>
<span>  </span><span>.</span><span>name</span><span> </span><span>=</span><span> </span><span>&#34;prop&#34;</span><span>,</span><span></span>
<span>  </span><span>.</span><span>getter</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Class</span><span>::</span><span>getProp</span><span>,</span><span></span>
<span>  </span><span>.</span><span>setter</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Class</span><span>::</span><span>setProp</span><span>,</span><span></span>
<span>  </span><span>.</span><span>notify</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Class</span><span>::</span><span>propChanged</span><span>,</span><span></span>
<span>  </span><span>.</span><span>stored</span><span> </span><span>=</span><span> </span><span>true</span><span>,</span><span></span>
<span>};</span><span></span>
</pre></div><p>It&#39;s very heavy on the eyes compared to the current solution, but it might <i>just</i> work. </p><blockquote><p>There&#39;s a lot of subtle details here that make the exercise scary, for instance what is exactly &#34;getter&#34;? A pointer a to non-static member function which returns `int` and it&#39;s `const`? What if it has extra defaulted arguments, or it&#39;s not const? And what about `notify`, it could have arbitrary arguments and return values... There&#39;s lots of engineering here.  Of course, if we get string-based lookup in C++29 the exercise becomes quite moot. :-(</p></blockquote>
<h5><span id="Q_CLASSINFO">Q_CLASSINFO</span></h5>
<p>These are simple (?) key/value pairs. 
</p>
<h5><span id="Q_ENUM_.2F_Q_FLAG"></span><span id="Q_ENUM_/_Q_FLAG">Q_ENUM / Q_FLAG</span></h5>
<p>moc extracts the enumerators (string/value) pairs, this is perfectly possible with P2996.
</p>
<h5><span id="Q_INTERFACES">Q_INTERFACES</span></h5>
<p>WIP; not sure at the moment. Is it just used for qt_metacast?
</p>
<h2><span id="Triggers_for_moc_.2F_buildsystem_integration"></span><span id="Triggers_for_moc_/_buildsystem_integration">Triggers for moc / buildsystem integration</span></h2>
<p>moc needs to be run on source files that define classes or namespaces and in which a &#34;trigger keyword&#34; is found: Q_OBJECT, Q_GADGET, Q_NAMESPACE, etc.
</p><p>Usually, the buildsystem identifies these files, and prepares build rules so that moc is run on them.
</p><p>The output of moc is some additional .cpp code, this code can either get compiled standalone (and linked into the final target) via additional build rules, or directly included by a .cpp file (e.g. #include &#34;moc_foo.cpp&#34;) in which case no additional rules are needed.
</p>
<h3><span id="How_to_.22trigger_reflection.22.3F"></span><span id="How_to_&#34;trigger_reflection&#34;?">How to &#34;trigger reflection&#34;?</span></h3>
<p>The main idea on the table is that we&#39;re going to need a macro of some sorts to be placed in a .cpp file. That macro will expand to everything necessary -- defining all the Q_OBJECT-declared stuff by calling consteval functions that apply reflection, extract the necessary data, build tables and the like.
</p><p>Something like this:
</p>
<pre>Q_GENERATE_METAOBJECT(Class)
</pre>
<p>Having to do add this <i>manually</i> to every marked class is certainly annoying.
</p>
<h2><span id="What_needs_to_be_generated.3F"></span><span id="What_needs_to_be_generated?">What needs to be generated?</span></h2>
<p>In a nutshell: some static data, the implementation of various things declared by the Q_OBJECT macro, the implementation of the class&#39; metaObject() function, the implementation of signals, ...
</p><p>
For instance, for QWidget (in Qt 6.10):</p><div dir="ltr"><pre><span></span><span data-line="1"></span><span>namespace</span><span> </span><span>{</span><span></span>
<span data-line="2"></span><span>struct</span><span> </span><span>qt_meta_tag_ZN7QWidgetE_t</span><span> </span><span>{};</span><span></span>
<span data-line="3"></span><span>}</span><span> </span><span>// unnamed namespace</span>
<span data-line="4"></span>
<span data-line="5"></span><span>template</span><span> </span><span>&lt;&gt;</span><span> </span><span>constexpr</span><span> </span><span>inline</span><span> </span><span>auto</span><span> </span><span>QWidget</span><span>::</span><span>qt_create_metaobjectdata</span><span>&lt;</span><span>qt_meta_tag_ZN7QWidgetE_t</span><span>&gt;</span><span>()</span><span></span>
<span data-line="6"></span><span>{</span><span> </span><span>...</span><span> </span><span>}</span><span></span>
<span data-line="7"></span>
<span data-line="8"></span><span>Q_CONSTINIT</span><span> </span><span>const</span><span> </span><span>QMetaObject</span><span> </span><span>QWidget</span><span>::</span><span>staticMetaObject</span><span> </span><span>=</span><span> </span><span>{</span><span> </span><span>...</span><span> </span><span>}</span><span></span>
<span data-line="9"></span>
<span data-line="10"></span><span>void</span><span> </span><span>QWidget</span><span>::</span><span>qt_static_metacall</span><span>(</span><span>QObject</span><span> </span><span>*</span><span>_o</span><span>,</span><span> </span><span>QMetaObject</span><span>::</span><span>Call</span><span> </span><span>_c</span><span>,</span><span> </span><span>int</span><span> </span><span>_id</span><span>,</span><span> </span><span>void</span><span> </span><span>**</span><span>_a</span><span>)</span><span> </span><span>{</span><span> </span><span>...</span><span> </span><span>}</span><span></span>
<span data-line="11"></span>
<span data-line="12"></span><span>const</span><span> </span><span>QMetaObject</span><span> </span><span>*</span><span>QWidget</span><span>::</span><span>metaObject</span><span>()</span><span> </span><span>const</span><span> </span><span>{</span><span> </span><span>...</span><span> </span><span>}</span><span></span>
<span data-line="13"></span>
<span data-line="14"></span><span>void</span><span> </span><span>*</span><span>QWidget</span><span>::</span><span>qt_metacast</span><span>(</span><span>const</span><span> </span><span>char</span><span> </span><span>*</span><span>_clname</span><span>)</span><span> </span><span>{</span><span> </span><span>...</span><span> </span><span>}</span><span></span>
<span data-line="15"></span>
<span data-line="16"></span><span>int</span><span> </span><span>QWidget</span><span>::</span><span>qt_metacall</span><span>(</span><span>QMetaObject</span><span>::</span><span>Call</span><span> </span><span>_c</span><span>,</span><span> </span><span>int</span><span> </span><span>_id</span><span>,</span><span> </span><span>void</span><span> </span><span>**</span><span>_a</span><span>)</span><span> </span><span>{</span><span> </span><span>...</span><span> </span><span>}</span><span></span>
<span data-line="17"></span>
<span data-line="18"></span><span>// SIGNAL 0</span>
<span data-line="19"></span><span>void</span><span> </span><span>QWidget</span><span>::</span><span>windowTitleChanged</span><span>(</span><span>const</span><span> </span><span>QString</span><span> </span><span>&amp;</span><span> </span><span>_t1</span><span>)</span><span></span>
<span data-line="20"></span><span>{</span><span></span>
<span data-line="21"></span><span>    </span><span>QMetaObject</span><span>::</span><span>activate</span><span>&lt;</span><span>void</span><span>&gt;</span><span>(</span><span>this</span><span>,</span><span> </span><span>&amp;</span><span>staticMetaObject</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>nullptr</span><span>,</span><span> </span><span>_t1</span><span>);</span><span></span>
<span data-line="22"></span><span>}</span><span></span>
<span data-line="23"></span>
<span data-line="24"></span><span>// SIGNAL 1</span>
<span data-line="25"></span><span>void</span><span> </span><span>QWidget</span><span>::</span><span>windowIconChanged</span><span>(</span><span>const</span><span> </span><span>QIcon</span><span> </span><span>&amp;</span><span> </span><span>_t1</span><span>)</span><span></span>
<span data-line="26"></span><span>{</span><span></span>
<span data-line="27"></span><span>    </span><span>QMetaObject</span><span>::</span><span>activate</span><span>&lt;</span><span>void</span><span>&gt;</span><span>(</span><span>this</span><span>,</span><span> </span><span>&amp;</span><span>staticMetaObject</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>nullptr</span><span>,</span><span> </span><span>_t1</span><span>);</span><span></span>
<span data-line="28"></span><span>}</span><span></span>
<span data-line="29"></span>
<span data-line="30"></span><span>// SIGNAL 2</span>
<span data-line="31"></span><span>void</span><span> </span><span>QWidget</span><span>::</span><span>windowIconTextChanged</span><span>(</span><span>const</span><span> </span><span>QString</span><span> </span><span>&amp;</span><span> </span><span>_t1</span><span>)</span><span></span>
<span data-line="32"></span><span>{</span><span></span>
<span data-line="33"></span><span>    </span><span>QMetaObject</span><span>::</span><span>activate</span><span>&lt;</span><span>void</span><span>&gt;</span><span>(</span><span>this</span><span>,</span><span> </span><span>&amp;</span><span>staticMetaObject</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>nullptr</span><span>,</span><span> </span><span>_t1</span><span>);</span><span></span>
<span data-line="34"></span><span>}</span><span></span>
<span data-line="35"></span>
<span data-line="36"></span><span>// SIGNAL 3</span>
<span data-line="37"></span><span>void</span><span> </span><span>QWidget</span><span>::</span><span>customContextMenuRequested</span><span>(</span><span>const</span><span> </span><span>QPoint</span><span> </span><span>&amp;</span><span> </span><span>_t1</span><span>)</span><span></span>
<span data-line="38"></span><span>{</span><span></span>
<span data-line="39"></span><span>    </span><span>QMetaObject</span><span>::</span><span>activate</span><span>&lt;</span><span>void</span><span>&gt;</span><span>(</span><span>this</span><span>,</span><span> </span><span>&amp;</span><span>staticMetaObject</span><span>,</span><span> </span><span>3</span><span>,</span><span> </span><span>nullptr</span><span>,</span><span> </span><span>_t1</span><span>);</span><span></span>
<span data-line="40"></span><span>}</span><span></span>
</pre></div>
<h3><span id="Unique_tag">Unique tag</span></h3>
<p>I&#39;m not sure what this is for.
</p>
<h3><span id="qt_create_metaobjectdata.28.29"></span><span id="qt_create_metaobjectdata()">qt_create_metaobjectdata()</span></h3><p>
This is the basically the storage for the extracted data:</p><div dir="ltr"><pre><span></span><span data-line="1"></span><span>    </span><span>namespace</span><span> </span><span>QMC</span><span> </span><span>=</span><span> </span><span>QtMocConstants</span><span>;</span><span></span>
<span data-line="2"></span><span>    </span><span>QtMocHelpers</span><span>::</span><span>StringRefStorage</span><span> </span><span>qt_stringData</span><span> </span><span>{</span><span></span>
<span data-line="3"></span><span>        </span><span>&#34;QWidget&#34;</span><span>,</span><span></span>
<span data-line="4"></span><span>        </span><span>&#34;windowTitleChanged&#34;</span><span>,</span><span></span>
<span data-line="5"></span><span>...</span><span></span>
<span data-line="6"></span><span>    </span><span>};</span><span></span>
<span data-line="7"></span>
<span data-line="8"></span><span>    </span><span>QtMocHelpers</span><span>::</span><span>UintData</span><span> </span><span>qt_methods</span><span> </span><span>{</span><span></span>
<span data-line="9"></span><span>        </span><span>// Signal &#39;windowTitleChanged&#39;</span>
<span data-line="10"></span><span>        </span><span>QtMocHelpers</span><span>::</span><span>SignalData</span><span>&lt;</span><span>void</span><span>(</span><span>const</span><span> </span><span>QString</span><span> </span><span>&amp;</span><span>)</span><span>&gt;</span><span>(</span><span>1</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>QMC</span><span>::</span><span>AccessPublic</span><span>,</span><span> </span><span>QMetaType</span><span>::</span><span>Void</span><span>,</span><span> </span><span>{{</span><span></span>
<span data-line="11"></span><span>            </span><span>{</span><span> </span><span>QMetaType</span><span>::</span><span>QString</span><span>,</span><span> </span><span>3</span><span> </span><span>},</span><span></span>
<span data-line="12"></span><span>        </span><span>}}),</span><span></span>
<span data-line="13"></span><span>        </span><span>// Signal &#39;windowIconChanged&#39;</span>
<span data-line="14"></span><span>        </span><span>QtMocHelpers</span><span>::</span><span>SignalData</span><span>&lt;</span><span>void</span><span>(</span><span>const</span><span> </span><span>QIcon</span><span> </span><span>&amp;</span><span>)</span><span>&gt;</span><span>(</span><span>4</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>QMC</span><span>::</span><span>AccessPublic</span><span>,</span><span> </span><span>QMetaType</span><span>::</span><span>Void</span><span>,</span><span> </span><span>{{</span><span></span>
<span data-line="15"></span><span>            </span><span>{</span><span> </span><span>QMetaType</span><span>::</span><span>QIcon</span><span>,</span><span> </span><span>5</span><span> </span><span>},</span><span></span>
<span data-line="16"></span><span>        </span><span>}}),...</span><span></span>
<span data-line="17"></span><span>    </span><span>};</span><span></span>
<span data-line="18"></span><span>    </span><span>QtMocHelpers</span><span>::</span><span>UintData</span><span> </span><span>qt_enums</span><span> </span><span>{</span><span></span>
<span data-line="19"></span><span>    </span><span>};</span><span></span>
<span data-line="20"></span><span>    </span><span>return</span><span> </span><span>QtMocHelpers</span><span>::</span><span>metaObjectData</span><span>&lt;</span><span>QWidget</span><span>,</span><span> </span><span>qt_meta_tag_ZN7QWidgetE_t</span><span>&gt;</span><span>(</span><span>QMC</span><span>::</span><span>MetaObjectFlag</span><span>{},</span><span> </span><span>qt_stringData</span><span>,</span><span></span>
<span data-line="21"></span><span>            </span><span>qt_methods</span><span>,</span><span> </span><span>qt_properties</span><span>,</span><span> </span><span>qt_enums</span><span>);</span><span></span>
</pre></div>
<h3><span id="staticMetaObject">staticMetaObject</span></h3>
<p>This is basically initializing an object with a bunch of fields defined around. qt_staticMetaObjectStaticContent etc. are just parts of the data returned by qt_create_metaobjectdata.
</p><p>
Maybe it could be generated as part of the reflection-triggering macro? Not sure how to deal with the unique metatag. Otherwise could be generated via token injections, I wager.</p><div dir="ltr"><pre><span></span><span>Q_CONSTINIT</span><span> </span><span>const</span><span> </span><span>QMetaObject</span><span> </span><span>QWidget</span><span>::</span><span>staticMetaObject</span><span> </span><span>=</span><span> </span><span>{</span><span> </span><span>{</span><span></span>
<span>    </span><span>QMetaObject</span><span>::</span><span>SuperData</span><span>::</span><span>link</span><span>&lt;</span><span>QObject</span><span>::</span><span>staticMetaObject</span><span>&gt;</span><span>(),</span><span></span>
<span>    </span><span>qt_staticMetaObjectStaticContent</span><span>&lt;</span><span>qt_meta_tag_ZN7QWidgetE_t</span><span>&gt;</span><span>.</span><span>stringdata</span><span>,</span><span></span>
<span>    </span><span>qt_staticMetaObjectStaticContent</span><span>&lt;</span><span>qt_meta_tag_ZN7QWidgetE_t</span><span>&gt;</span><span>.</span><span>data</span><span>,</span><span></span>
<span>    </span><span>qt_static_metacall</span><span>,</span><span></span>
<span>    </span><span>nullptr</span><span>,</span><span></span>
<span>    </span><span>qt_staticMetaObjectRelocatingContent</span><span>&lt;</span><span>qt_meta_tag_ZN7QWidgetE_t</span><span>&gt;</span><span>.</span><span>metaTypes</span><span>,</span><span></span>
<span>    </span><span>nullptr</span><span></span>
<span>}</span><span> </span><span>};</span><span></span>
</pre></div>
<h3><span id="qt_static_metacall.28.29"></span><span id="qt_static_metacall()">qt_static_metacall()</span></h3>
<p>This implements the various metaobject-related operations: invoke a method, read a property&#39;s value, write a property&#39;s value, etc.
</p><p>
This may be doable using P2996&#39;s reflection. We can provide a skeleton implementation that gets &#34;filled in&#34; via reflection / expansion statements.</p><div dir="ltr"><pre><span></span><span>void</span><span> </span><span>QWidget::qt_static_metacall</span><span>(</span><span>QObject</span><span> </span><span>*</span><span>_o</span><span>,</span><span> </span><span>QMetaObject</span><span>::</span><span>Call</span><span> </span><span>_c</span><span>,</span><span> </span><span>int</span><span> </span><span>_id</span><span>,</span><span> </span><span>void</span><span> </span><span>**</span><span>_a</span><span>)</span><span></span>
<span>{</span><span></span>
<span>    </span><span>auto</span><span> </span><span>*</span><span>_t</span><span> </span><span>=</span><span> </span><span>static_cast</span><span>&lt;</span><span>QWidget</span><span> </span><span>*&gt;</span><span>(</span><span>_o</span><span>);</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>InvokeMetaMethod</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>switch</span><span> </span><span>(</span><span>_id</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>case</span><span> </span><span>0</span><span>:</span><span> </span><span>_t</span><span>-&gt;</span><span>windowTitleChanged</span><span>((</span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span> </span><span>std</span><span>::</span><span>add_pointer_t</span><span>&lt;</span><span>QString</span><span>&gt;&gt;</span><span>(</span><span>_a</span><span>[</span><span>1</span><span>])));</span><span> </span><span>break</span><span>;</span><span></span>
<span>        </span><span>case</span><span> </span><span>1</span><span>:</span><span> </span><span>_t</span><span>-&gt;</span><span>windowIconChanged</span><span>((</span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span> </span><span>std</span><span>::</span><span>add_pointer_t</span><span>&lt;</span><span>QIcon</span><span>&gt;&gt;</span><span>(</span><span>_a</span><span>[</span><span>1</span><span>])));</span><span> </span><span>break</span><span>;</span><span></span>
<span>...</span><span></span>
<span>        </span><span>default</span><span>:</span><span> </span><span>;</span><span></span>
<span>        </span><span>}</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>IndexOfMethod</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>if</span><span> </span><span>(</span><span>QtMocHelpers</span><span>::</span><span>indexOfMethod</span><span>&lt;</span><span>void</span><span> </span><span>(</span><span>QWidget</span><span>::*</span><span>)(</span><span>const</span><span> </span><span>QString</span><span> </span><span>&amp;</span><span> </span><span>)</span><span>&gt;</span><span>(</span><span>_a</span><span>,</span><span> </span><span>&amp;</span><span>QWidget</span><span>::</span><span>windowTitleChanged</span><span>,</span><span> </span><span>0</span><span>))</span><span></span>
<span>            </span><span>return</span><span>;</span><span></span>
<span>        </span><span>...</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>ReadProperty</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>void</span><span> </span><span>*</span><span>_v</span><span> </span><span>=</span><span> </span><span>_a</span><span>[</span><span>0</span><span>];</span><span></span>
<span>        </span><span>switch</span><span> </span><span>(</span><span>_id</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>case</span><span> </span><span>0</span><span>:</span><span> </span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span>bool</span><span>*&gt;</span><span>(</span><span>_v</span><span>)</span><span> </span><span>=</span><span> </span><span>_t</span><span>-&gt;</span><span>isModal</span><span>();</span><span> </span><span>break</span><span>;</span><span></span>
<span>        </span><span>case</span><span> </span><span>1</span><span>:</span><span> </span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span>Qt</span><span>::</span><span>WindowModality</span><span>*&gt;</span><span>(</span><span>_v</span><span>)</span><span> </span><span>=</span><span> </span><span>_t</span><span>-&gt;</span><span>windowModality</span><span>();</span><span> </span><span>break</span><span>;</span><span></span>
<span>        </span><span>...</span><span></span>
<span>        </span><span>}</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>WriteProperty</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>void</span><span> </span><span>*</span><span>_v</span><span> </span><span>=</span><span> </span><span>_a</span><span>[</span><span>0</span><span>];</span><span></span>
<span>        </span><span>switch</span><span> </span><span>(</span><span>_id</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>case</span><span> </span><span>1</span><span>:</span><span> </span><span>_t</span><span>-&gt;</span><span>setWindowModality</span><span>(</span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span>Qt</span><span>::</span><span>WindowModality</span><span>*&gt;</span><span>(</span><span>_v</span><span>));</span><span> </span><span>break</span><span>;</span><span></span>
<span>        </span><span>case</span><span> </span><span>2</span><span>:</span><span> </span><span>_t</span><span>-&gt;</span><span>setEnabled</span><span>(</span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span>bool</span><span>*&gt;</span><span>(</span><span>_v</span><span>));</span><span> </span><span>break</span><span>;</span><span></span>
<span>        </span><span>...</span><span></span>
<span>        </span><span>}</span><span></span>
<span>    </span><span>}</span><span></span>
<span>   </span><span>...</span><span></span>
<span>}</span><span></span>
</pre></div>
<h3><span id="metaObject.28.29"></span><span id="metaObject()">metaObject()</span></h3>
<div dir="ltr"><pre><span></span><span>const</span><span> </span><span>QMetaObject</span><span> </span><span>*</span><span>QWidget::metaObject</span><span>()</span><span> </span><span>const</span><span></span>
<span>{</span><span></span>
<span>    </span><span>return</span><span> </span><span>QObject</span><span>::</span><span>d_ptr</span><span>-&gt;</span><span>metaObject</span><span> </span><span>?</span><span> </span><span>QObject</span><span>::</span><span>d_ptr</span><span>-&gt;</span><span>dynamicMetaObject</span><span>()</span><span> </span><span>:</span><span> </span><span>&amp;</span><span>staticMetaObject</span><span>;</span><span></span>
<span>}</span><span></span>
</pre></div><p>This can be hardcoded; it doesn&#39;t need reflection at all. This is moc&#39;s code that emits the above:</p><div dir="ltr"><pre><span></span><span>    </span><span>fprintf</span><span>(</span><span>out</span><span>,</span><span> </span><span>&#34;</span><span>\n</span><span>const QMetaObject *%s::metaObject() const</span><span>\n</span><span>{</span><span>\n</span><span>&#34;</span><span></span>
<span>                 </span><span>&#34;    return QObject::d_ptr-&gt;metaObject ? QObject::d_ptr-&gt;dynamicMetaObject() : &amp;staticMetaObject;</span><span>\n</span><span>&#34;</span><span></span>
<span>                 </span><span>&#34;}</span><span>\n</span><span>&#34;</span><span>,</span><span></span>
<span>            </span><span>cdef</span><span>-&gt;</span><span>qualified</span><span>.</span><span>constData</span><span>());</span><span></span>
</pre></div>
<h3><span id="qt_metacast.28.29"></span><span id="qt_metacast()">qt_metacast()</span></h3>
<div dir="ltr"><pre><span></span><span>void</span><span> </span><span>*</span><span>QWidget::qt_metacast</span><span>(</span><span>const</span><span> </span><span>char</span><span> </span><span>*</span><span>_clname</span><span>)</span><span></span>
<span>{</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>!</span><span>_clname</span><span>)</span><span> </span><span>return</span><span> </span><span>nullptr</span><span>;</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>!</span><span>strcmp</span><span>(</span><span>_clname</span><span>,</span><span> </span><span>qt_staticMetaObjectStaticContent</span><span>&lt;</span><span>qt_meta_tag_ZN7QWidgetE_t</span><span>&gt;</span><span>.</span><span>strings</span><span>))</span><span></span>
<span>        </span><span>return</span><span> </span><span>static_cast</span><span>&lt;</span><span>void</span><span>*&gt;</span><span>(</span><span>this</span><span>);</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>!</span><span>strcmp</span><span>(</span><span>_clname</span><span>,</span><span> </span><span>&#34;QPaintDevice&#34;</span><span>))</span><span></span>
<span>        </span><span>return</span><span> </span><span>static_cast</span><span>&lt;</span><span> </span><span>QPaintDevice</span><span>*&gt;</span><span>(</span><span>this</span><span>);</span><span></span>
<span>    </span><span>return</span><span> </span><span>QObject</span><span>::</span><span>qt_metacast</span><span>(</span><span>_clname</span><span>);</span><span></span>
<span>}</span><span></span>
</pre></div><p>This is a &#34;cast by name&#34;. It compares the input to each base&#39;s name and performs a static_cast if successful. It also handles interfaces (Q_INTERFACES).
</p><p>Should be doable with P2996.
</p><p>However Q_INTERFACES poses the same problem as Q_PROPERTY -- it&#39;s just a raw bag of data. Luckily, it&#39;s just a list of type names (interfaces that the class implements).
</p>
<h3><span id="qt_metacall.28.29"></span><span id="qt_metacall()">qt_metacall()</span></h3><p>
This can also be possibly generated using P2996. </p><div dir="ltr"><pre><span></span><span>int</span><span> </span><span>QWidget::qt_metacall</span><span>(</span><span>QMetaObject</span><span>::</span><span>Call</span><span> </span><span>_c</span><span>,</span><span> </span><span>int</span><span> </span><span>_id</span><span>,</span><span> </span><span>void</span><span> </span><span>**</span><span>_a</span><span>)</span><span></span>
<span>{</span><span></span>
<span>    </span><span>_id</span><span> </span><span>=</span><span> </span><span>QObject</span><span>::</span><span>qt_metacall</span><span>(</span><span>_c</span><span>,</span><span> </span><span>_id</span><span>,</span><span> </span><span>_a</span><span>);</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_id</span><span> </span><span>&lt;</span><span> </span><span>0</span><span>)</span><span></span>
<span>        </span><span>return</span><span> </span><span>_id</span><span>;</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>InvokeMetaMethod</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>if</span><span> </span><span>(</span><span>_id</span><span> </span><span>&lt;</span><span> </span><span>29</span><span>)</span><span></span>
<span>            </span><span>qt_static_metacall</span><span>(</span><span>this</span><span>,</span><span> </span><span>_c</span><span>,</span><span> </span><span>_id</span><span>,</span><span> </span><span>_a</span><span>);</span><span></span>
<span>        </span><span>_id</span><span> </span><span>-=</span><span> </span><span>29</span><span>;</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>RegisterMethodArgumentMetaType</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>if</span><span> </span><span>(</span><span>_id</span><span> </span><span>&lt;</span><span> </span><span>29</span><span>)</span><span></span>
<span>            </span><span>*</span><span>reinterpret_cast</span><span>&lt;</span><span>QMetaType</span><span> </span><span>*&gt;</span><span>(</span><span>_a</span><span>[</span><span>0</span><span>])</span><span> </span><span>=</span><span> </span><span>QMetaType</span><span>();</span><span></span>
<span>        </span><span>_id</span><span> </span><span>-=</span><span> </span><span>29</span><span>;</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>if</span><span> </span><span>(</span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>ReadProperty</span><span> </span><span>||</span><span> </span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>WriteProperty</span><span></span>
<span>            </span><span>||</span><span> </span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>ResetProperty</span><span> </span><span>||</span><span> </span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>BindableProperty</span><span></span>
<span>            </span><span>||</span><span> </span><span>_c</span><span> </span><span>==</span><span> </span><span>QMetaObject</span><span>::</span><span>RegisterPropertyMetaType</span><span>)</span><span> </span><span>{</span><span></span>
<span>        </span><span>qt_static_metacall</span><span>(</span><span>this</span><span>,</span><span> </span><span>_c</span><span>,</span><span> </span><span>_id</span><span>,</span><span> </span><span>_a</span><span>);</span><span></span>
<span>        </span><span>_id</span><span> </span><span>-=</span><span> </span><span>60</span><span>;</span><span></span>
<span>    </span><span>}</span><span></span>
<span>    </span><span>return</span><span> </span><span>_id</span><span>;</span><span></span>
<span>}</span><span></span>
</pre></div>
<h3><span id="Signals">Signals</span></h3>
<p>moc needs to generate the implementation of each signal, which is just a call to QMetaObject::activate.
</p><p><u>This is something that isn&#39;t possible in P2996.</u> Since signals are &#34;ordinary&#34; member functions, we can&#39;t inject a definition for them. We would need something like injection of token sequences (P3294, which is C++29 material at this point) in order to synthesize each definition (assuming that we get a &#34;define_function&#34; or similar APIs from reflection).
</p><p>Of course we could concoct a brand new design for declaring signals. For instance, instead of them being member functions (needing a definition), they could be some other declaration (an inner typedef? a static data member?), and needing some other facility to activate them (rather than just &#34;calling&#34; them like we do today). That&#39;s brand new territory to explore and widely incompatible with our 30y of Qt history, so possibly not worth it...?
</p>
<h2><span id="JSON_output">JSON output</span></h2>
<p>moc also generates a JSON file with interesting metaobject information for the class. This sounds impossible to achieve with reflection.
</p>
<!-- 
NewPP limit report
Cached time: 20251012194604
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc]
CPU time usage: 0.043 seconds
Real time usage: 0.067 seconds
Preprocessor visited node count: 128/1000000
Post‐expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 45630/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 -total
-->

<!-- Saved in parser cache with key heroku_app_db:pcache:idhash:11033-0!canonical and timestamp 20251012194604 and revision id 44427.
 -->
</div>
</div></div>
  </body>
</html>
