<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://desfontain.es/privacy/latex-to-html.html">Original</a>
    <h1>Converting my PhD thesis into HTML (2021)</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>Finishing a PhD is a weird emotional experience. All the hard work, the joys,
the pains, the pulled hairs, everything gets condensed into a <a href="https://desfontain.es/thesis.pdf">scary-looking
PDF</a> and then you&#39;re just… done? What? This makes no sense
whatsoever. Or rather, this makes sense on paper, but then you feel this weird
sense of grief somehow. And you&#39;re not quite at the acceptance stage yet. So
instead, you decide to deal with those feelings in a perfectly normal and
healthy way, and you embark on a journey to compile said thesis <a href="https://desfontain.es/thesis/">into a series
of HTML pages</a>.</p>
<p>HTML, by the way, is a much better way of disseminating information than PDF.
Pretty much all of recent scientific research is recorded in PDF files, for
historical reasons that are largely irrelevant today. PDFs are difficult to
browse, impossible to read on a phone, uncomfortable to read on a tablet,
hostile to screen readers, impractical to search engines, and the list goes on.
It&#39;s just a terrible format, unless you&#39;re trying to print things on paper.
Printing things is a perfectly reasonable thing to do, but that&#39;s really not the
main use case we should be optimizing for.</p>
<p>Anyway. I <a href="https://desfontain.es/thesis/">converted my thesis to HTML</a> and this is my story. A story
of false hopes, perseverance, pain, and futility. I hope this can be useful to
other people, as a guide on how to do this for your own thesis or large &amp;
complex LaTeX documents, or as an encouragement to do something better with your
time instead.</p>

<p>&#34;Convert LaTeX to HTML&#34;, I type in my search engine of choice. Ooooh, I have
options! There&#39;s <a href="https://pandoc.org/">pandoc</a>,
<a href="https://ctan.org/pkg/lwarp">lwarp</a>, <a href="https://dlmf.nist.gov/LaTeXML/">LaTeXML</a>,
<a href="https://tug.org/tex4ht/">TeX4ht</a>, and probably others. This looks excellent.
Converting LaTeX to HTML is clearly a problem that other people have already
solved for me before. I will just have to run an existing tool, and iron out the
kinks.</p>
<p>I download the tools in question, run them on my thesis, and look at the initial
results. <a href="https://tug.org/tex4ht/">TeX4ht</a> fires off a bunch of compilation
errors and warnings, but it outputs something that kinda looks reasonable from a
distance. All others fail completely. So I go, &#34;OK, let&#39;s try to fix the TeX4ht
problems, to get a feeling for how difficult this is&#34;. It turns out not to be
too difficult to fix most common issues, <a href="https://tex.stackexchange.com/questions/tagged/tex4ht">LaTeX Stack
Exchange</a> answers most of
my questions, so I make progress. I also notice that there is a nice-looking
build system for TeX4ht called <a href="https://github.com/michal-h21/make4ht">make4ht</a>,
which looks really nifty, I imagine it&#39;s going to be similar to
<a href="https://mg.readthedocs.io/latexmk.html">latexmk</a>, which I love.</p>
<p>So, things are going alright. I make progress. Here are some of the problems I
found at first and how I fixed them.</p>
<ul>
<li>A bunch of packages or commands don&#39;t make much sense in an HTML context: page
  breaks, PDF anchors, page numbers, floats, landscape layouts, margins or other
  types of spacing… Some of them (like <code>floatrow</code>) throw compilation errors,
  most are simply ignored. I made a pass at all the packages I used and removed
  the ones that were obviously irrelevant for HTML.</li>
<li>One special case is <code>longtable</code>: since a regular table can be as long as you
  need it to be in HTML, you also don&#39;t need it. Replacing it by a regular
  <code>tabular</code>, and <code>ThreePartTable</code> (from <code>threeparttablex</code>) by the regular
  <code>threeparttable</code> fixed the problem.</li>
<li>Importing an image originally stored in a PDF rendered it into a tiny
  unreadable vignette. Adding a &#34;config file&#34; with some <a href="https://tex.stackexchange.com/a/46210">dark magic in
  it</a> did the trick. </li>
<li>SVGs generated with <code>tikzpicture</code> by were very wrong (missing text, blank
  graphs…). Apparently the &#34;driver&#34; included in htlatex is not good, but for
  some reason it&#39;s <a href="https://tex.stackexchange.com/a/488741">still in use</a>.
  Including the line that calls a different driver wasn&#39;t enough, even though
  the file was already present in my system, I still got some bugs (text not at
  the right place). Importing the file <a href="https://github.com/michal-h21/dvisvgm4ht/blob/master/pgfsys-dvisvgm4ht.def">directly from
  GitHub</a>
  worked.</li>
<li>Some commands don&#39;t work for reasons I didn&#39;t really understand, but are
  easily fixable: for example, <code>\notin</code> works fine with <code>pdflatex</code>, but <code>tex4ht</code>
  complains about it. Replacing it by <code>\not{\in}</code> everywhere fixes it.</li>
<li>Each footnote is, by default, put in its own separate HTML file. It gets fixed
  by creating a <code>.make4ht</code> file that contains something like:
  <code>settings_add {
    tex4ht_sty_par = &#34;,fn-in&#34;
  }</code>
  This tells <code>make4ht</code> to pass additional arguments (here, <code>fn-in</code>) to <code>tex4ht</code>,
  which change its behavior. There are <a href="https://www.kodymirus.cz/tex4ht-doc/texfourhtOptions.html">many available
  options</a>.</li>
</ul>
<p>I should probably have noticed the early warning signs. One is that the default
behavior often makes zero sense: for example, this footnote problem… who would
want footnotes in a separate HTML files when all the rest is in a single HTML
file? Why is that a reasonable thing to do?</p>
<p>Also, compilation errors don&#39;t give you a clear picture of what actually goes
wrong. LaTeX is bad at this in general, but TeX4ht is definitely worse. The
error messages are often classical LaTeX errors like <code>! Extra }, or forgotten
\endgroup</code>, but that&#39;s almost never the <em>actual</em> error, since the same file
compiles fine into PDF. So looking it up error messages online doesn&#39;t help.
Instead, I fixed those early problems by bisecting the error, or by asking the
internet how to do a certain thing.</p>
<p>Still, I&#39;m making quick progress. I wonder things like &#34;can I put the different
sections on different HTML pages rather than having one monolithic document&#34; and
find out that all I need to do is pass an option to TeX4ht and it works. The
option is unbelievably badly named: to tell it &#34;make one page per subsection&#34;,
you tell it &#34;3&#34;, because that&#39;s three subdivision levels (chapter / section /
subsection). Yes, I really mean &#34;3&#34;. The option has no other name. You just pass
a single number to the command line.</p>
<p>But whatever. It works. I make progress. I invest time fixing things. Surely, if
I just spend a few more hours of fixing things, I&#39;ll be done. The sunk cost
fallacy starts taking its hold on me. I don&#39;t notice a thing. </p>

<p>I start stumbling into some issues that are more difficult to fix. The first big
one is how equations display. By default, TeX4ht converts each equation into an
image, and includes the image in the HTML file. I imagine it&#39;s pretty awful for
accessibility, and it&#39;s also really ugly. The images are low-quality, stand out
in the middle of text, zooming in or out is a visual nightmare. After some
testing, I decide that the best solution is to pass the <code>mathml</code> option to
<code>tex4ht</code>, and pass the <code>html5+mathjaxnode</code> option to <code>make4ht</code> to tell it to
post-process all of the pages with <code>mathjax-node-page</code>, which converts the
MathML equations into… prettier-looking equations I think. I don&#39;t exactly
understand how it works, but MathML alone is ugly, and this is pretty. Ship it.
This requires me to install Node.js, which, urgh, but whatever.</p>
<p>I realize only afterwards that this package is deprecated, and that TeX4ht&#39;s
<a href="https://github.com/michal-h21/make4ht">GitHub repository</a> recommends using the
<code>mjcli</code> option instead. That option isn&#39;t recognized on my machine, probably
because I don&#39;t have a recent enough version. What I have works, so I don&#39;t look
further.</p>
<p>I also start cleaning up my build process. And this is where I start noticing
some behaviors of these tools that are kind of really wrong and frustrating for
no reason.</p>
<ul>
<li>One example is the <code>-d</code> option of <code>make4ht</code>, which is supposed to tell it &#34;put
  all output files in this specific subdirectory&#34;. This option is lying to you.
  The files are <em>copied</em> over to this directory, and only <em>some</em> of them. So
  your working directory is still cluttered with intermediary files,
  logs, and HTML files.</li>
<li>I initially thought that it would be kind of like <code>latexmk</code>, running the
  compilation commands multiple times until it gets the bibliography references
  right. It does not do that. You have to do it manually.</li>
<li>When you realize you didn&#39;t compile what you wanted to, pressing <code>ctrl-c</code>
  doesn&#39;t seem to stop the process. It does, however, make the command-line
  output hang. So you have to close the terminal and open a new one again.</li>
</ul>
<p>None of these things is a huge deal-breaker. I am still making progress. I also
fix a bunch of other problems that start looking more like real weird bugs than
understandable annoyances.</p>
<ul>
<li><code>\autoref</code> did not work. I tried pretty hard to fix it, and finally gave up
  and changed all the <code>\autoref</code>s into regular <code>\ref</code>s using <code>sed</code>.</li>
<li>LaTeX expressions that are perfectly fine according to <code>pdflatex</code>, like
  <code>a_\text{b}</code> or <code>a^\mycommand{b}</code> (where <code>\mycommand</code> is a custom command),
  failed to compile. This could be fixed by adding brackets: <code>a_{\text{b}}</code>
  works, as does <code>$^{\mycommand{b}}</code>. Alas, fixing all compilation problems
  isn&#39;t enough: simple expressions like <code>e^\eps</code>, where <code>\eps</code> is defined as
  simply an alias of <code>\varepsilon</code>, <em>compile</em> fine, but <em>display</em> incorrectly,
  so they must also be detected and changed to e.g. <code>e^{\eps}</code>.</li>
<li>But wait, this gets even worse: expressions like <code>e^{\eps}</code> are fine in text,
  but if they are put in <em>macros</em>, then they no longer work. Sometimes. To solve
  that final problem, I replaced all <code>_</code> and <code>^</code> in my macros by <code>\sb</code> and
  <code>\sp</code>. Gross.</li>
<li>The itemized list of <code>tablenotes</code> in <code>threeparttable</code> environments did not
  correctly put line breaks between items. You have to add line breaks manually.</li>
<li>Speaking of tables, <code>multirow</code> doesn&#39;t work. A workaround is to use <code>\newline</code>
  within cells. There is probably a better option.</li>
<li>Having multiple <code>\tikzpicture</code> commands in a single figure resulted in really
  weird visual bugs, without a compilation error: only a single picture being
  shown, random text in absurd places. Putting each <code>\tikzpicture</code> in its own
  cell in a <code>tabular</code> environment is a quick workaround. There is probably a
  better option (<code>subfigure</code> with the right arguments maybe?).</li>
<li><code>\hat{D}</code> looked reasonable, <code>\hat{O}</code> displayed like the french Ô in
  equations. Whyyyy. I fixed it by using <code>\hat{{O}}</code>. No clue why it works nor
  why it happened in the first place.</li>
<li>Regular parentheses in equations are automatically sized to the biggest thing
  on the same line. So if you have an equation like
  <span>\(f(x)=\frac{tallthing}{alsotallthing}\)</span>, the parenthesis around the <span>\(x\)</span> are
  comically large. You need to replace all these by <code>\left(x\right)</code> to get the
  correct behavior.</li>
<li>Having a <code>cases*</code> environment nested inside of an <code>align*</code> environment failed
  to compile. Replacing the <code>align*</code> environment by <code>\[ … \]</code> compiles, but the
  line breaks within the <code>cases*</code> environment are ignored. I solved it by using
  a <code>matrix*</code> environment instead (with the <code>[l]</code> option for correct alignment),
  surrounded by <code>\left\{...\right.</code> to emulate the big left bracket.</li>
</ul>
<p>This is where I started doing some really ugly things to get around such bugs.
Using <code>grep</code> and <code>sed</code> to do large-scale changes, or doing gross things like
replacing horizontal spaces by non-breaking spaces, became routine. At that
point though, I was in too deep to reconsider my choices. So I kept going, even
as the bugs got progressively more arcane.</p>

<p>The serious problems happened as I was trying to figure out how to get the table
of contents working as expected. It seemed to be truncated for no reason, with
very weird errors on the command-line, referencing some intermediary files. I
bisected it to a <code>%</code> symbol in the caption of a table. You read that right: I had
a correctly-escaped <code>%</code> in the legend of one of my figures, it compiled and
displayed perfectly fine, but it broke the regular table of contents. Not the
&#34;list of figures&#34;, mind you! I didn&#39;t even have a list of figures!</p>
<p>Another problem was with chapter- or section-specific tables of content, which
are a good thing to have when everything is separated across many HTML pages.
Sadly, they sometimes had the wrong sections or subsections in them; Section 4.2
would have a few subsections from Section 4.3 in its table of contents. I tried
for a while to make an minimal working example to figure out where the problem
came from, the behavior didn&#39;t look very deterministic, so I gave up and simply
removed these altogether.</p>
<p>Captions also have their share of bizarre, non-deterministic bugs. For example,
using a formula like <code>\left[a\middle|b\right]</code> inside of a caption made
compilation fail. Removing the <code>\middle</code> part, which does not cause any issue
anywhere else, fixes it. Except that macros also sometimes fail to display the
desired formula inside captions, with e.g. a subscript being ignored. But the
exact same code without a macro would work fine, or the same macro outside a
<code>\caption{}</code> would also work fine. Bizarre stuff.</p>
<p>Eventually, I stopped trying to fix the bugs, and simply learned to work around
them, by either removing the thing entirely, or post-processing the output. This
happened, uh, a number of times.</p>
<ul>
<li>Using <code>\intertext</code> between lines of an <code>align*</code> equation, a trick to keep
  equations aligned even when you put a paragraph of text between them, resulted
  in the entire thing being ridiculously shifted to the right. I solved it by
  changing the <code>\intertext</code> into a normal paragraph.</li>
<li>Algorithms from the <code>algorithm2e</code> package display really strangely. Removing
  line numbers kind of helps, but it&#39;s not great, and the <a href="https://tex.stackexchange.com/a/292712">official
  advice</a> seems to be &#34;convert it as an
  image&#34;, which, ew. I only used this environment once, so I simply converted it
  into a listing.</li>
<li>The TeX4ht config file did not work as expected. Internet tells me adding
  lines starting with <code>\Configure{@HEAD}</code> is supposed to add corresponding lines
  in the <code>&lt;head&gt;</code> element of the generated HTML files, and you add multiple such
  lines to add multiple elements. There are plenty of examples online of this
  pattern being used. Somehow, on my machine, only the first such command was
  added to <code>&lt;head&gt;</code>, the others appeared in the <code>&lt;body&gt;</code> instead (which, of
  course, does not have the expected semantics). After a few hours trying to
  debug this, I trashed that whole idea and, instead, made a Python script that
  replaced the beginning and the end of each HTML page entirely instead.</li>
<li>A series of underscores got added after some of the citations at the beginning
  of each chapter. I added a few lines to my Python script to get rid of them
  without even trying to understand where that particular weirdness came from.</li>
</ul>
<p>The CSS part of this whole build process is also broken in interesting ways.
Two style files are generated: a main one that I think is part of TeX4ht, and
another one added by <code>mathjax-page-node</code>.</p>
<ul>
<li>The main CSS has the same commands repeated many times for no reason. It also
  has styles that are &#34;obviously wrong&#34;: <code>class=&#34;indent&#34;</code> ends up <em>disabling</em>
  the text indentation, while there are elements with the &#34;noindent&#34; class,
  which aren&#39;t defined anywhere on CSS, so inherit the global behavior (which is
  &#34;add an indentation&#34; on my website).</li>
<li>The mathjax CSS is fine, but the build process copies it over to the output
  directory <em>every time a file is generated</em>. But when the file doesn&#39;t contain
  any equation, that CSS is empty instead! So if that&#39;s the case for the <em>last</em>
  file generated by the build process, its empty CSS file overwrites the correct
  CSS file and all of a sudden, the equations looks terrible. I fixed it by
  manually adding the &#34;right&#34; CSS in a fixed place.</li>
</ul>

<p>So, it&#39;s <a href="https://desfontain.es/thesis">done</a>. I&#39;m pretty happy about how it looks. The entire
exercise was entirely futile, of course: it&#39;s not like anyone will, y&#39;know,
actually <em>read</em> the damn thing. But I&#39;m weirdly glad it exists.</p>
<p>Obviously though, I&#39;m not at all impressed by the road that was needed to get to
this point. It&#39;s infuriating that doing something like this was so hard. LaTeX
is the main way scientific research gets written up. HTML might be the main
format used by pretty much everyone on the planet to consume written content.
Why is converting one to to the other not a solved problem?</p>
<p>Of course, we know why. Incentives in academia are irremediably broken, so we&#39;re
stuck with old practices, bad formats, a lack of funds for projects that would
make everyone&#39;s life better, and a structural impossibility to do much about it.
My friend a3nm <a href="https://a3nm.net/work/research/wrong/">lays out all of these root
causes</a> much better than I possibly
could, and this LaTeX-to-HTML story is a good illustration. Imagine that we
lived in a world where it was <em>trivial</em> to make beautiful web pages out of
scientific papers. Wouldn&#39;t that encourage more researchers to share their work
more widely? Wouldn&#39;t that create whole new categories of readership, given that
most people consume content on their phone? If HTML was the default format for
research, would more people realize how <em>ridiculous</em> it is that paywalled
research papers are still a thing in 2021?</p>
<p>Anyway. I&#39;m complaining, but I still want to finish off on a positive note: the
people who are actually doing the work of building and maintaining this tooling
are <em>heroes</em>. The many bugs and annoyances I complained about should in no way
be interpreted as a criticism of the authors of the software. Converting LaTeX
to HTML is absurdly hard because LaTeX was never designed for such a thing,
because the input language is forever stuck in the 80&#39;s, and because the
complexity of the package ecosystem is out of control. The more you dive into
how these converters work, the more you realize that the fact that they work at
all is actually pretty impressive! Massive respect to folks like <a href="https://tex.stackexchange.com/users/2891/michal-h21">Michal
Hoftich</a>, who are creating
software that solves a fundamentally difficult problem <em>and</em> spending massive
amounts of time and energy answering people&#39;s questions. Genuinely inspiring. </p>
<p>I hope that some day, that kind of work can be properly funded and rewarded. I
don&#39;t really know how we get there.</p>
<hr/>
<p><small> If you&#39;re interested in understanding more about the technical
complexity of this kind of work, and getting a better overview of the different
tools that are out there (something I wish I&#39;d done at the <em>beginning</em> of this
project rather than at the end), there are some good discussions available
online. <a href="https://tug.org/pipermail/texhax/2016-March/022231.html">Here</a>&#39;s one,
<a href="https://tug.org/pipermail/tex4ht/2016q1/001399.html">here</a> another.</small></p>

  </div></div>
  </body>
</html>
