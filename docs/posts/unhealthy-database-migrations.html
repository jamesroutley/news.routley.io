<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://theleo.zone/posts/unhealthy-db-migrations/">Original</a>
    <h1>unhealthy database migrations</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Feb 20, 2024</p><div><p>Often, integration tests follow this pattern:</p><ol><li>Stand up a docker database container</li><li>Run migrations against this database container</li><li>Run the integration tests against this migrated container</li></ol><p>This can be done with docker compose as follows, using Postgres and <a href="https://github.com/pressly/goose">goose</a> as an
example:</p><p><code>./docker-compose.yaml</code></p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>services</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>postgres</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>image</span><span>:</span><span> </span><span>postgres:latest</span><span>
</span></span></span><span><span><span>    </span><span>environment</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>POSTGRES_USER</span><span>:</span><span> </span><span>leo</span><span>
</span></span></span><span><span><span>      </span><span>POSTGRES_PASSWORD</span><span>:</span><span> </span><span>123</span><span>
</span></span></span><span><span><span>      </span><span>POSTGRES_DB</span><span>:</span><span> </span><span>db</span><span>
</span></span></span><span><span><span>    </span><span>ports</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>&#34;5432:5432&#34;</span><span>
</span></span></span><span><span><span>    </span><span>healthcheck</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>test</span><span>:</span><span> </span><span>[</span><span>&#34;CMD-SHELL&#34;</span><span>,</span><span> </span><span>&#34;pg_isready&#34;</span><span>]</span><span>
</span></span></span><span><span><span>      </span><span>interval</span><span>:</span><span> </span><span>1s</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>  </span><span>postgres-migrations</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>build</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>context</span><span>:</span><span> </span><span>.</span><span>
</span></span></span><span><span><span>      </span><span>dockerfile</span><span>:</span><span> </span><span>Dockerfile-goose</span><span>
</span></span></span><span><span><span>    </span><span>volumes</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>./migrations:/migrations</span><span>
</span></span></span><span><span><span>    </span><span>depends_on</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>postgres</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>condition</span><span>:</span><span> </span><span>service_healthy</span><span>
</span></span></span><span><span><span>    </span><span>command</span><span>:</span><span> </span><span>&gt;</span><span>
</span></span></span><span><span><span>      sh -c &#34; goose -dir /migrations postgres &#39;host=postgres user=leo password=123 dbname=db&#39; up&#34;</span><span>      
</span></span></span><span><span><span>    </span><span>healthcheck</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>test</span><span>:</span><span> </span><span>[</span><span>&#34;CMD-SHELL&#34;</span><span>,</span><span> </span><span>&#34;exit 1&#34;</span><span>]</span><span>
</span></span></span></code></pre></div><p>A database container with a readiness healthcheck. A migrations container that waits until the database is ready, then
runs the migrations against it.</p><p>The odd thing here is the never-successful migrations container healthcheck.</p><p>Two things need to be true before you can run integration tests:</p><ul><li>the database container must be ready</li><li>the database migrations must be complete</li></ul><p>If these containers are instantiated with <code>docker compose up -d</code> and then tests immediately run, the database container
may not be healthy, and even more likely, the migrations may not have completed.</p><p>An arbitrary sleep time could be added before tests start, but that’s either unreliable or overkill.</p><p>An alternative is to run <code>docker compose up</code> with the <code>--wait</code> flag:</p><div><pre tabindex="0"><code data-lang="sh"><span><span><span># --wait  Wait for services to be running|healthy. Implies detached mode.</span>
</span></span><span><span>docker compose up --wait
</span></span></code></pre></div><p>This will block until all containers are running or healthy. Without the failing healthcheck, the migrations container
reports healthy before migrations complete and the <code>up --wait</code> doesn’t block long enough. Because the migrations
container reports unhealthy until it exits, that means the <code>up</code> command will block right until the migrations complete
and the container exits – no shorter or longer.</p><p>So this test file works:</p><p><code>./test.sh</code></p><div><pre tabindex="0"><code data-lang="shell"><span><span><span>#!/usr/bin/env sh
</span></span></span><span><span><span></span>
</span></span><span><span>docker compose up --wait
</span></span><span><span><span>echo</span> <span>&#34;docker compose up complete&#34;</span>
</span></span><span><span>
</span></span><span><span><span># the &#34;integration tests&#34;</span>
</span></span><span><span><span>PGPASSWORD</span><span>=</span><span>123</span> psql -h localhost -p <span>5432</span> -U leo -d db -c <span>&#34;SELECT * FROM movies&#34;</span> <span>||</span> <span>echo</span> <span>&#34;failed&#34;</span>
</span></span><span><span>
</span></span><span><span><span># clean up</span>
</span></span><span><span>docker compose down
</span></span></code></pre></div><p><strong>But</strong>, if the <code>set -e</code> option is added to the test script such that it exits on any non-zero status, this test script
will fail. The <code>--wait</code> command exits with status 1 even though <code>docker-postgres-migrations-1</code> exits with status 0.</p><p>Instead, <code>docker compose wait</code> can be used to wait for migrations to complete:</p><p><code>./test.sh</code></p><div><pre tabindex="0"><code data-lang="shell"><span><span><span>#!/usr/bin/env sh
</span></span></span><span><span><span></span>
</span></span><span><span><span>set</span> -e
</span></span><span><span>
</span></span><span><span>docker compose up -d
</span></span><span><span>docker compose <span>wait</span> postgres-migrations
</span></span><span><span><span>echo</span> <span>&#34;docker compose up complete&#34;</span>
</span></span><span><span>
</span></span><span><span><span># the &#34;integration tests&#34;</span>
</span></span><span><span><span>PGPASSWORD</span><span>=</span><span>123</span> psql -h localhost -p <span>5432</span> -U leo -d db -c <span>&#34;SELECT * FROM movies&#34;</span> <span>||</span> <span>echo</span> <span>&#34;failed&#34;</span>
</span></span><span><span>
</span></span><span><span><span># clean up</span>
</span></span><span><span>docker compose down
</span></span></code></pre></div><p>Unfortunately, now the script needs to know the service name <code>postgres-migrations</code>. Another option is to keep the
migrations container running just long enough after the migrations have completed that the <code>up --wait</code> exits with status
0:</p><p><code>./test.sh</code></p><div><pre tabindex="0"><code data-lang="shell"><span><span><span>#!/usr/bin/env sh
</span></span></span><span><span><span></span>
</span></span><span><span><span>set</span> -e
</span></span><span><span>
</span></span><span><span>docker compose up --wait
</span></span><span><span><span>echo</span> <span>&#34;docker compose up complete&#34;</span>
</span></span><span><span>
</span></span><span><span><span># the &#34;integration tests&#34;</span>
</span></span><span><span><span>PGPASSWORD</span><span>=</span><span>123</span> psql -h localhost -p <span>5432</span> -U leo -d db -c <span>&#34;SELECT * FROM movies&#34;</span> <span>||</span> <span>echo</span> <span>&#34;failed&#34;</span>
</span></span><span><span>
</span></span><span><span><span># clean up</span>
</span></span><span><span>docker compose down
</span></span></code></pre></div><p><code>./docker-compose.yaml</code></p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>services</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>postgres</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>image</span><span>:</span><span> </span><span>postgres:latest</span><span>
</span></span></span><span><span><span>    </span><span>environment</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>POSTGRES_USER</span><span>:</span><span> </span><span>leo</span><span>
</span></span></span><span><span><span>      </span><span>POSTGRES_PASSWORD</span><span>:</span><span> </span><span>123</span><span>
</span></span></span><span><span><span>      </span><span>POSTGRES_DB</span><span>:</span><span> </span><span>db</span><span>
</span></span></span><span><span><span>    </span><span>ports</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>&#34;5432:5432&#34;</span><span>
</span></span></span><span><span><span>    </span><span>healthcheck</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>test</span><span>:</span><span> </span><span>[</span><span>&#34;CMD-SHELL&#34;</span><span>,</span><span> </span><span>&#34;pg_isready&#34;</span><span>]</span><span>
</span></span></span><span><span><span>      </span><span>interval</span><span>:</span><span> </span><span>1s</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>  </span><span>postgres-migrations</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>build</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>context</span><span>:</span><span> </span><span>.</span><span>
</span></span></span><span><span><span>      </span><span>dockerfile</span><span>:</span><span> </span><span>Dockerfile-goose</span><span>
</span></span></span><span><span><span>    </span><span>volumes</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>./migrations:/migrations</span><span>
</span></span></span><span><span><span>    </span><span>depends_on</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>postgres</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>condition</span><span>:</span><span> </span><span>service_healthy</span><span>
</span></span></span><span><span><span>    </span><span>command</span><span>:</span><span> </span><span>&gt;</span><span>
</span></span></span><span><span><span>      sh -c &#34; goose -dir /migrations postgres &#39;host=postgres user=leo password=123 dbname=db&#39; up &amp;&amp; touch /tmp/done &amp;&amp;
</span></span></span><span><span><span>      sleep 2&#34;</span><span>      
</span></span></span><span><span><span>    </span><span>healthcheck</span><span>:</span><span>
</span></span></span><span><span><span>      </span><span>test</span><span>:</span><span> </span><span>[</span><span>&#34;CMD&#34;</span><span>,</span><span> </span><span>&#34;test&#34;</span><span>,</span><span> </span><span>&#34;-f&#34;</span><span>,</span><span> </span><span>&#34;/tmp/done&#34;</span><span>]</span><span>
</span></span></span><span><span><span>      </span><span>interval</span><span>:</span><span> </span><span>1s</span><span>
</span></span></span></code></pre></div><p>A tmp file is created flagging migrations are complete, then the <code>sleep 2</code> gives just enough time for the healthcheck to
pass at <code>interval: 1s</code>.</p><p>Here are the other files I made to experiment with this:</p><p><code>./Dockerfile-goose</code></p><div><pre tabindex="0"><code data-lang="docker"><span><span><span>FROM</span><span> golang:alpine as builder</span><span>
</span></span></span><span><span><span></span><span>RUN</span> apk add --no-cache git<span>
</span></span></span><span><span><span></span><span>RUN</span> go install github.com/pressly/goose/v3/cmd/goose@latest<span>
</span></span></span></code></pre></div><p><code>./migrations/20240221040043_run.sql</code></p><div><pre tabindex="0"><code data-lang="sql"><span><span><span>-- +goose Up
</span></span></span><span><span><span>-- +goose StatementBegin
</span></span></span><span><span><span></span><span>SELECT</span><span> </span><span>pg_sleep</span><span>(</span><span>2</span><span>);</span><span>  </span><span>-- simulate migrations taking longer than they do
</span></span></span><span><span><span></span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>movies</span><span> </span><span>(</span><span>
</span></span></span><span><span><span>    </span><span>id</span><span> </span><span>SERIAL</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span>,</span><span>
</span></span></span><span><span><span>    </span><span>title</span><span> </span><span>VARCHAR</span><span>(</span><span>255</span><span>)</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>
</span></span></span><span><span><span></span><span>);</span><span>
</span></span></span><span><span><span></span><span>INSERT</span><span> </span><span>INTO</span><span> </span><span>movies</span><span> </span><span>(</span><span>title</span><span>)</span><span> </span><span>VALUES</span><span> </span><span>(</span><span>&#39;Woohoo&#39;</span><span>);</span><span>
</span></span></span><span><span><span></span><span>-- +goose StatementEnd
</span></span></span><span><span><span></span><span>
</span></span></span><span><span><span></span><span>-- +goose Down
</span></span></span><span><span><span>-- +goose StatementBegin
</span></span></span><span><span><span></span><span>DROP</span><span> </span><span>TABLE</span><span> </span><span>IF</span><span> </span><span>EXISTS</span><span> </span><span>movies</span><span>;</span><span>
</span></span></span><span><span><span></span><span>-- +goose StatementEnd
</span></span></span></code></pre></div><p>I honestly don’t love any of these solutions. There are probably better ways to do this, and if you have any, please let
me know by email at {leo at theleo.zone}.</p></div></div></div></div>
  </body>
</html>
