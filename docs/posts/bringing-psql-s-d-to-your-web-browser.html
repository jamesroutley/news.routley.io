<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://neon.tech/blog/bringing-psqls-d-to-your-web-browser">Original</a>
    <h1>Bringing psql’s \d to your web browser</h1>
    
    <div id="readability-page-1" class="page"><div><p>Neon’s SQL Editor now supports Postgres’s introspection commands</p></div><div>
<p><img alt="Post image" fetchpriority="high" width="1024" height="576" decoding="async" data-nimg="1" sizes="(max-width: 767px) 100vw" srcset="/_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=640&amp;q=85 640w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=750&amp;q=85 750w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=828&amp;q=85 828w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=1080&amp;q=85 1080w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=1200&amp;q=85 1200w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=1920&amp;q=85 1920w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=2048&amp;q=85 2048w, /_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=3840&amp;q=85 3840w" src="https://neon.tech/_next/image?url=https%3A%2F%2Fneondatabase.wpengine.com%2Fwp-content%2Fuploads%2F2024%2F04%2Fimage-34.png&amp;w=3840&amp;q=85"/></p><p>Different database systems provide different ways to list or describe the things they hold. For instance, to find a particular table and column in MySQL, you run <code>SHOW TABLES</code> followed by <code>SHOW COLUMNS FROM my_table</code>. In SQLite, you do <code>.tables</code> and then <code>.schema my_table</code>. And in Postgres, the commands are<code>\d</code> (for describe) followed by <code>\d mytable</code>.</p>







<p>When I got access to my first Neon Postgres database, almost the first thing I did was go to the web-based SQL Editor and type <code>\d</code>. I was a little sad when the response I got back was: <code>ERROR: syntax error at or near &#34;\&#34; (SQLSTATE 42601)</code>.</p>



<p>It turns out that <code>\d</code>, <code>\l</code>, and their relatives are a psql feature. That is, these introspection commands are found in <a href="https://github.com/postgres/postgres/blob/master/src/bin/psql/describe.c">the C code that implements the psql client</a>, not the C code that implements the Postgres server. Each time you issue one of these commands in psql, you’re running a little local routine that constructs one or more SQL queries, sends them to execute on the server one by one, and stitches the results together into a nice little table.</p>



<blockquote>
<p>You may already know that you can see those underlying SQL queries by running psql with the <a href="https://www.postgresql.org/docs/devel/app-psql.html#APP-PSQL-OPTION-ECHO-HIDDEN"><code>-E</code> or <code>--echo-hidden</code> option</a>. <code>\d</code> issues only one query, but try <code>\d pg_a*</code> and you’ll see dozens. This is a useful way to explore some of Postgres’ internals. It was helpful, for example, in putting together the queries <a href="https://jawj.github.io/zapatos/">Zapatos</a> uses to fetch type information from your database.</p>
</blockquote>



<p>Of course, it’s not just <code>\d</code> and <code>\l</code>: there are lots of other useful backslash commands. You can get a brief cheat-sheet with <code>\?</code>, or look up <a href="https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-META-COMMANDS">more details in the Postgres docs</a>. Some personal favourites are <code>\dconfig</code>, which lists configuration parameter values; <code>\du</code> and <code>\dx</code>, which list users and installed extensions; <code>\sf</code> and <code>\sv</code>, which display the source of functions and views; and  <code>\h</code>, which provides a syntax reference for SQL commands.</p>







<p>Fast-forward a year or two. Having put together Neon’s <a href="https://neon.tech/docs/serverless/serverless-driver">serverless driver</a> — which runs in environments that don’t offer raw TCP connections, such as web browsers — I was tasked to upgrade our web-based SQL Editor to make use of it. This enables interactive sessions and transactions in the SQL Editor, and reduces memory usage on our back-end, amongst other things.</p>



<blockquote>
<p>Easter egg alert! As a as result of this work, if you open your browser’s dev tools in the SQL Editor, you can also run queries there using the currently-connected serverless driver client. The client is a property of the window, named <code>rawClient</code>. It’s so named because all parsing has been turned off: it returns the raw Postgres text format for each data type. Try pasting in <code>rawClient.query(&#39;SELECT now()&#39;).then(console.log)</code>, for instance.</p>
</blockquote>



<p>While moving the SQL Editor to the serverless driver, I took the opportunity to make a few other tweaks along the way. Probably the one I was most excited to get to work on was supporting the psql backslash commands.</p>



<p>As I mentioned above, these commands are implemented in C. An obvious place to start might thus have been to use <a href="https://emscripten.org/">emscripten</a> to compile that C to WASM, and I did begin by looking at that approach. But I also noticed that much of the code was pretty repetitive: lots of basic string manipulation to assemble SQL queries, and some simple logic to interpret what came back. So I wondered if we needed to actually compile the C, or whether we couldn’t instead directly translate the C to JavaScript.</p>



<p>That second approach — translating C to JavaScript — was the approach I ended up taking:</p>



<ul>
<li>I turned C syntax into JS syntax using a bunch of RegExp search-and-replace. For example, I replaced <code>int x</code> with <code>let x</code>; concatenated consecutive strings (<code>&#34;a&#34; &#34;b&#34;</code> becomes <code>&#34;ab”</code>); turned the <code>-&gt;</code> arrow operator into <code>.</code>; and so on. (I felt a little bit dirty doing this with RegExps, and I did briefly look at using a C parser and transforming the AST instead … but RegExps were <strong>so</strong> much quicker).</li>



<li>I reimplemented some C and Postgres functions. That includes dead simple ones like <code>function atoi(str) { return parseInt(str, 10); }</code> or <code>function pg_tolower(ch) { return ch.toLowerCase(); }</code>, and also some slightly more complex ones, like a minimal <code>sprintf</code> function, or the psql code to pretty-print a table.</li>



<li>Last, I wrote down <a href="https://github.com/neondatabase/psql-describe/blob/main/test/tests.txt">examples of all the different psql introspection commands</a>, and a test script that compares their results in psql to the results generated by my code. I then went through these, one by one, until every last one matched. Almost all the required fixes were in places the original C code was doing something with pointers — pointer arithmetic, pointer dereferencing, and so on — without any direct JavaScript equivalent. It didn’t take too long this way to get a JavaScript implementation up and running. You can use it right now in the SQL Editor in the Neon console. You can also <a href="https://github.com/neondatabase/psql-describe">see the code on GitHub</a>, and do whatever you like with it (within the Postgres license terms) from there.</li>
</ul>



<blockquote>
<p>Easter egg alert! When running backslash-commands in the SQL Editor on a machine with a keyboard, hold the Shift key as you click ‘Run’ to see the underlying SQL commands interleaved with the output, just like you’d get when running psql with the <code>-E</code> or <code>--echo-hidden</code> option.</p>
</blockquote>



<p>I can’t promise that this is the only or necessarily even the best approach to the problem, and it would of course be nice in the long run to have an automated process to bring updates across from the psql C code. But it works, and I think it’s a good start.</p>







<p>Once I had the introspection commands working from JavaScript, the other challenge in bringing them to the SQL Editor was to pick them out of a line-up of SQL queries.</p>



<p>Neon’s SQL Editor can run several queries at a time, and shows one result tab for each. Previously, we could just send one big opaque SQL string to a server API, and let the server handle splitting it into individual queries. But now, instead, we need to do that splitting client-side, because the introspection commands have to be handled separately.</p>



<p>It’s hopefully obvious why a simple <code>sql.split(&#39;;&#39;)</code> doesn’t work here. It will fail on the following string, for example, which is a single query followed by a comment:</p>


<figure><pre tabindex="0" data-language="sql"><code><span data-line="1"><span>SELECT</span><span> &#39;;&#39;</span><span> /* select a &#39;;&#39; literal */</span></span></code></pre></figure>


<p>There’s <a href="https://github.com/pganalyze/pg-query-emscripten">an emscipten build of the Postgres query parser</a>. But it currently only supports up to Postgres version 10. And it would kind of be using a sledgehammer to crack a nut, since we don’t need to fully parse each query: we only need to figure out which semicolons we care about and which ones we don’t.</p>



<p>To figure out which semicolons are the significant ones, there are three syntax elements we need to understand: <a href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html">identifiers, comments, and string literals</a>.</p>



<ul>
<li>Identifiers are the simplest: they’re always double-quoted, and any (unlikely) double-quotes within them are doubled up.</li>



<li>Comments are only a little trickier. Single-line comments extend from a double-dash to the end of a line. C-style <code>/* … */</code> block comments also exist, and can be nested.</li>



<li>Strings are the most complex. They can be plain single-quoted, in which case the character-escape behaviour inside them depends on the Postgres server’s <code>standard_conforming_strings</code> configuration parameter. Or they can be ‘escape strings’, which have an <code>e</code> or <code>E</code> before the opening quote. Both these sorts of strings can combine across whitespace (but only if it includes a newline). Or, of course, they can be dollar-quoted strings.</li>
</ul>



<p>In any case, the upshot is that I wrote <a href="https://github.com/neondatabase/semicolons">another little open-source package</a> to do only this much parsing. It makes heavy use of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/sticky">sticky RegExps</a> — a JS parser-writer’s best friend, <a href="https://neon.tech/blog/parsing-json-from-postgres-in-js">as I’ve mentioned elsewhere</a> — to efficiently locate both comments and statement-terminating semicolons in SQL string.</p>



<p>We also allow backslash commands to be newline-terminated, which is just a small extra step on top of the work done by the package.</p>



<p>This enables us to quickly split your SQL Editor selection into an array of SQL queries and backslash commands. As you may have already noticed, that means we can also now tell you ahead of time how many separate result tabs are going to be presented when you hit the Run button.</p>



<p>If you have any feedback on any of these new features, please <a href="https://discord.com/invite/92vNTzKDGp">let us know on Discord</a>.</p>
</div></div>
  </body>
</html>
