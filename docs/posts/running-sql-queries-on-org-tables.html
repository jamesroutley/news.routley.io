<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://yummymelon.com/devnull/running-sql-queries-on-org-tables.html">Original</a>
    <h1>Running SQL Queries on Org Tables</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>One of the best things in Org Mode are tables and if you know SQL, you have at your disposal the ability to process your tables like a SQL database. Even better, you can run a SQL query on your table <em>without</em> the overhead of manually creating the database. This post shows you how.</p>

<p>To implement an SQL query on an Org table we do the following:</p>
<ol>
<li>Convert the Org table to a SQLite table via the <a href="https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-sqlite.html">Org Babel SQLite integration</a>.<ul>
<li>Inspect the Org table columns to determine its SQL type.</li>
<li>Auto-generate the SQL <code>CREATE TABLE</code> statement using the above column types.</li>
<li>Store the table in an <a href="https://www.sqlite.org/inmemorydb.html">in-memory database</a>.</li>
</ul>
</li>
<li>Run a SQL query on the above created SQLite table via Org Babel and render its result as an Org table.</li>
</ol>

<p>All code here has been tested on Emacs 29.1 and Org 9.6.11.</p>
<ul>
<li>Have Org Babel SQLite support installed. Instructions for doing this are provided on the <a href="https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-sqlite.html">Org website</a>.</li>
</ul>

<p>Given the following named table <code>example_table</code>, find the aggregate total units per city.</p>
<div><pre><span></span><code><span>#</span>+NAME: example_table
| site | city          | units |
|------+---------------+-------|
|    1 | San Francisco |   182 |
|    2 | San Francisco |    82 |
|    3 | San Francisco |   124 |
|    4 | Berlin        |   105 |
|    5 | Berlin        |    92 |
|    6 | Seoul         |   104 |
|    7 | Seoul         |    84 |
|    8 | Seoul         |    97 |
|    9 | New York      |   103 |
|   10 | New York      |   140 |
</code></pre></div>

<p>To convert the above Org table to a SQLite table, we will call the named code block <code>cc/org-table-to-sqlite</code> with two arguments as shown below:</p>
<ul>
<li><code>table</code> which is a reference to the named table, and</li>
<li><code>table-name</code> which is the string representation of <code>table</code> above.</li>
</ul>
<p>The table name must be SQL-legal.</p>
<div><pre><span></span><code><span>#</span>+CALL: cc/org-table-to-sqlite(table=example_table, table-name=&#34;example_table&#34;)
</code></pre></div>

<p>Invoking <code>C-c C-c</code> (<code>org-ctrl-c-ctrl-c</code>) on the above will output the following generated Org SQLite code block.</p>
<div><pre><span></span><code><span>#+RESULTS:</span>
<span>#+begin_src sqlite :db &#34;:memory:&#34; :var orgtable=example_table :colnames yes</span>
<span>drop</span> <span>table</span> <span>if</span> <span>exists</span> <span>example_table</span><span>;</span>
<span>create</span> <span>table</span> <span>example_table</span><span>(</span><span>site</span> <span>INT</span><span>,</span> <span>city</span> <span>TEXT</span><span>,</span> <span>units</span> <span>INT</span><span>);</span>
<span>.</span><span>import</span> <span>$</span><span>orgtable</span> <span>example_table</span>

<span>--</span> <span>Edit</span> <span>SQL</span> <span>Query</span> <span>Below</span>
<span>select</span> <span>site</span><span>,</span> <span>city</span><span>,</span> <span>units</span> <span>from</span> <span>example_table</span><span>;</span>
<span>#+end_src</span>
</code></pre></div>

<p>A couple of observations of the above generated code:</p>
<ol>
<li>The database is <a href="https://www.sqlite.org/inmemorydb.html">in-memory</a> allowing for flexibility in changing the Org table.</li>
<li>Every time the code block is executed, the SQL table is dropped if it already exists.</li>
<li>The SQLite column types are determined by examining each column element. (Note: implementation is <em>O(n)</em>)</li>
<li>An example SQL <code>SELECT</code> statement is generated using the Org table header.</li>
</ol>
<p>As we want to determine the aggregate total units per city, let’s modify the above <code>SELECT</code> statement as follows:</p>
<div><pre><span></span><code>select site, city, sum(units) as totals from example_table group by city order by totals;
</code></pre></div>

<p>Invoking <code>C-c C-c</code> on the generated and edited code block yields the following result:</p>
<div><pre><span></span><code>#+RESULTS:
| site | city          | totals |
|------+---------------+--------|
|    4 | Berlin        |    197 |
|    9 | New York      |    243 |
|    6 | Seoul         |    285 |
|    1 | San Francisco |    388 |
</code></pre></div>


<p>The Org Elisp code block <code>cc/org-table-to-sqlite</code> is stored in the file <code>cc-org-table-to-sql.org</code> and is posted as a <a href="https://gist.github.com/kickingvegas/00312e090acb57ed5f2e9a8e13f0d696">GitHub gist</a> (note click on “Raw” to see all Org markup).</p>
<p>It can be loaded via the <code>org-babel-lob-ingest</code> command as follows:</p>
<div><pre><span></span><code>(org-babel-lob-ingest &#34;cc-org-table-to-sql.org&#34;)
</code></pre></div>

<p>Remembering how to invoke the code block <code>cc/org-table-to-sqlite</code> can be bit much. Thankfully we can use <a href="https://www.emacswiki.org/emacs/Yasnippet">YASnippet</a> to help. Shown below is a snippet for creating a named table and call to the code block <code>cc/org-table-to-sqlite</code> referencing said named table.</p>
<div><pre><span></span><code>#<span> </span>name:<span> </span>org-table-to-sqlite
#<span> </span>key:<span> </span>otsql_
#<span> </span>--
#+NAME:<span> </span><span>${</span><span>1</span><span>:</span><span>example_table</span><span>}</span>
|<span> </span><span>${</span><span>2</span><span>:</span><span>a</span><span>}</span><span> </span>|<span> </span><span>${</span><span>3</span><span>:</span><span>b</span><span>}</span><span> </span>|
|---|---|
|<span>  </span>1|<span> </span>10|
$0
#+CALL:<span> </span>cc/org-table-to-sqlite(table=$1,<span> </span>table-name=&#34;$1&#34;)
</code></pre></div>


<p>Turning an Org table into an ad-hoc SQL database opens a world of possibilities for data journaling and analysis. This post merely scratches the surface of what can be done.</p>

<ul>
<li><a href="https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-sqlite.html">SQLite Source Code Blocks in Org Mode</a></li>
<li><a href="https://orgmode.org/worg/library-of-babel.html">The Library of Babel</a></li>
<li><a href="https://www.sqlite.org/inmemorydb.html">SQLite In-Memory Databases</a></li>
<li><a href="https://orgmode.org/manual/Evaluating-Code-Blocks.html">Evaluating Code Blocks (The Org Manual)</a></li>
</ul>
<p>
 <a href="http://yummymelon.com/devnull/tag/emacs.html">emacs</a>
  <a href="http://yummymelon.com/devnull/tag/org-mode.html">org mode</a>
</p>
 
</div></div>
  </body>
</html>
