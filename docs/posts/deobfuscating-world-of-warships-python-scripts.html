<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://landaire.net/world-of-warships-deobfuscation/">Original</a>
    <h1>Deobfuscating World of Warships&#39; Python Scripts</h1>
    
    <div id="readability-page-1" class="page"><div>
  <p>An in-depth analysis of how World of Warships obfuscates its game scripts and how to mostly deobfuscate them. The <code>wowsdeob</code> project can be found on GitHub: <a href="https://github.com/landaire/wowsdeob">https://github.com/landaire/wowsdeob</a></p>
<h2 id="background">Background</h2>
<p>This blog post is something I&#39;m writing 3 years after my initial research/development, and about 2 years after I stopped actively working on the tool. Some of the details in this blog may not be fully accurate from time slippage and a lot of the initial research notes I made were lost or scattered in Discord conversations.</p>
<p>I am only now writing this as the game is somewhat dead and the development team chooses to continually release content that makes gameplay worse. Submarines, hybrid battleships, aircraft carriers, and HE-spamming battleships with cruiser concealment that overmatch everything have led to a less enjoyable gameplay experience.</p>
<p>The tool and techniques have been kept to a very tight circle so that data mining could continue without a potential cat-and-mouse game with the developer. I apologize to that community if that does occur.</p>
<p>Two years ago I open-sourced a tool I called <a href="https://github.com/landaire/unfuck"><code>unfuck</code></a> which I described as a &#34;Python 2.7 bytecode <del>deobfuscator</del> unfucker&#34;. That tool was the result of the work I had done for World of Warships, but isn&#39;t capable of completely deobfuscating World of Warships files out-of-the-box. <code>unfuck</code> <a href="https://news.ycombinator.com/item?id=28163546">made the rounds on HN</a> where I got supportive responses such as:</p>
<blockquote>
<p>Look, I get that edgy names are fun, but I&#39;m happy that I will never have to use this tool for work, and I pity the fool who has to explain why &#34;unfuck&#34; was needed to solve a real problem.</p>
</blockquote>
<p>And:</p>
<blockquote>
<p>Ooof, really bad name. Makes me think the project or maintainer are immature...</p>
</blockquote>
<p>And someone respecting my licensing choices:</p>
<blockquote>
<p>Interesting dual licensing</p>
</blockquote>
<blockquote>
<blockquote>
<p>This project is dual-licensed under MIT and the ABSE (&#34;Anyone But Stefan Esser&#34;) license. Note that an additional exception to the license is added, forbidding use/redistribution of said content to his trainees as well, but only when in a 5 mile radius from &#34;Stefan Esser&#34; or while holding any sort of (video)conference/chat with him.</p>
</blockquote>
<blockquote>
<p>Note that this license will only be used as long as what would capstone decode / that one other arm64 ida plugin thing by i0n1c (&#34;Stefan Esser&#34;) are not under the MIT license. afterwards, all exceptions are cleared and basically MIT license applies</p>
</blockquote>
</blockquote>
<h2 id="what-is-world-of-warships">What is World of Warships?</h2>
<p>World of Warships (WoWs) is a free-to-play naval warfare multiplayer game released in 2015 by Wargaming and their Lesta Studio. It supports <a href="https://web.archive.org/web/20230728140319/https://forum.worldofwarships.com/topic/174161-modapi-documentation/">multiple forms of modifications</a> via Adobe Flash for UI mods, XML/audio files for audio mods, custom ship textures, and Python for basically everything else. The Python APIs are somewhat limited, but can observe some in-game events that allow mod developers to surface information that the game doesn&#39;t show you by default.</p>
<p>Unlike a lot of multiplayer games, WoWs uses an authoritative server model where each client is only receiving events that the server believes they <em>should</em> receive. For example, enemy ship locations and related information is only pushed down to clients when they are intended to be painted to your screen. There are no wall hacks and things like auto-aim are somewhat negated by player skill. That doesn&#39;t mean there aren&#39;t <a href="https://v.youku.com/v_show/id_XNTgxNzIzNjAwNA==.html">illegal mods/cheats</a> that show you where to aim, where incoming artillery shells will land, etc.</p>
<p>With all of that said, there is very little incentive to cheat in this game. A top-tier player in World of Warships will have the game sense and skill that comes within a close margin to someone playing with cheats. Therefore deobfuscation of scripts doesn&#39;t necessarily help with cheat development apart from illegal mods, but may help modders create better mods in general.</p>
<h2 id="game-scripts">Game Scripts</h2>
<p>Although the World of Warships developers are mostly transparent about how game mechanics work, there have still been some mysteries. For example, the <a href="https://www.reddit.com/r/WorldOfWarships/comments/l1dpzt/reverse_engineered_dispersion_ellipse_including/">algorithm for how the dispersion ellipse of your shells is calculated</a> and the <a href="https://www.reddit.com/r/WorldOfWarships/comments/mesoun/reverse_engineered_how_sigma_works_with_dispersion/">dispersion of the shells themselves</a>.</p>
<p>The format of match replay files is also <a href="https://github.com/Monstrofil/replays_unpack">mostly documented</a> through reverse engineering work of a few researchers and from reviewing publicly available engine source code, but there are still unknown elements to the serialized format. For these reasons it&#39;s highly desirable to review the implementation code to unmask these mysteries.</p>
<p>There has been at least one other individual who managed to deobfuscate and decompile the game scripts as far back as 2016. A World of Warships EU forum member by the name of <a href="https://web.archive.org/web/20230802004250/https://forum.worldofwarships.eu/topic/55613-understanding-wgs-armor-penetration-curves/?page=3">&#34;TehRick&#34; / &#34;ThiSpawn&#34; made multiple posts</a> showing they had reverse engineered some of the C++ and Python logic. In fact, they explicitly called out the &#34;Lesta anti-noob protection&#34; obfuscated Python module name in one of their forum posts:</p>
<p><img src="https://landaire.net/img/wows-obfuscation/tehrick_1.png" alt="TehRick forum post"/></p>
<p>In <a href="https://www.reddit.com/user/ThiSpawn">a Reddit post</a> by the same username they also linked to a decompiled Python source file: <a href="https://pastebin.com/y3Yk43Nd">https://pastebin.com/y3Yk43Nd</a>.</p>
<p>Although TehRick seems to have disappeared soon after these posts, their code was still being referenced 4 years later!</p>
<p><em>If you are TehRick / ThiSpawn feel free to reach out to me -- I would love to talk about your deobfuscator!</em></p>
<h2 id="python-vm-primer">Python VM Primer</h2>
<p>When Python source code is executed, you may notice that a <code>.pyc</code> file is created. The Python interpreter doesn&#39;t interpret raw source code -- it first compiles that source code to an intermediate representation that can be fed to the VM as instructions.</p>
<p>The VM is stack-based with some &#34;registers&#34; which are used for runtime storage of variables in pre-defined variable (or unnamed) slots. Almost every VM operation with the exception of loads/stores will directly modify values on the stack in some way. Variable registers cannot be modified in-place, and must first be put directly on the stack.</p>
<p>Each object on the stack or in a variable slot is a deserialized Python object representing one of the following types:</p>
<ul>
<li>None</li>
<li>StopIteration</li>
<li>Ellipsis</li>
<li>Bool</li>
<li>Long</li>
<li>Float</li>
<li>Complex</li>
<li>Bytes</li>
<li>String</li>
<li>Tuple</li>
<li>List</li>
<li>Dict</li>
<li>Set</li>
<li>FrozenSet</li>
<li>Code</li>
</ul>
<p>Basically the raw primitive types you&#39;re probably used to when writing Python. All module definitions, functions, etc. are defined as <code>Code</code> objects that live in the <code>co_consts</code> section of their parent code object. Ditto with any lists, tuples, etc. that are hard coded in source code.</p>
<h3 id="instructions">Instructions</h3>
<p>World of Warships uses Python 2.7 which has helpful documentation covering all instructions here: <a href="https://docs.python.org/2/library/dis.html">https://docs.python.org/2/library/dis.html</a>.</p>
<p>All instructions are at least 1 byte for the opcode and up to 3 bytes for instructions which have a 16-bit argument. For example, a <code>JUMP_ABSOLUTE 300</code> may be encoded as <code>0x71_012c</code> and a <code>POP_TOP</code> may be encoded as <code>0x01</code>.</p>
<p>The WoWs developers did not do any opcode remapping, which is a fairly common obfuscation trick when an application has the flexibility of embedding the Python VM.</p>
<h2 id="prior-work-on-deobfuscation">Prior Work on Deobfuscation</h2>
<h3 id="lpcvoid-s-findings">lpcvoid&#39;s Findings</h3>
<p>World of Warships&#39; core game logic is contained within a <code>scripts.zip</code> file that is handled by a special loader. The loader reads compiled Python (files ending in <code>.pyc</code>) out of this zip archive and even uses a special technique of handling the serialized Python code object.</p>
<p>This logic and deobfuscating the <em>first stage</em> of the matryoshka doll has already been described by <a href="https://lpcvoid.com/blog/0007_wows_python_reversing/index.html">lpcvoid on his blog</a> and he even has a <a href="https://lpcvoid.com/blog/0008_python_bytecode_dejunking/index.html">part 2</a> going into some of the junk instructions. I highly recommend reading his blog posts before continuing, as I will not rehash his hard work.</p>
<p>To summarize his findings: the module loader deserializes the bytecode object and uses the bytecode as an encryption key for some ciphertext stored in const data. After decrypting the ciphertext, the plaintext is decompressed (zlib) and is executed as a code object.</p>
<h3 id="rapid-analysis-of-bytecode-using-pyasm">Rapid Analysis of Bytecode Using pyasm</h3>
<p>I wanted to take a quick moment to call out that my friend @gabe_k wrote a tool for a CTF challenge he put together many years ago called <code>pyasm</code> that is specifically designed for this type of scenario. It can gracefully handle disassembling of bad instructions, and even supports recompiling a <code>.pyasm</code> file back to a serialized code object. I&#39;ve forked the project and made some quality of life improvements/bug fixes here: <a href="https://github.com/landaire/pyasm">https://github.com/landaire/pyasm</a>.</p>
<p>Here is an example of what one of these <code>.pyc</code> files look like when converted to a <code>.pyasm</code> file (redacted since it&#39;s very long):</p>
<pre data-lang="python"><code data-lang="python"><span>code
</span><span>	stack_size </span><span>3
</span><span>	flags </span><span>66
</span><span>	consts </span><span>4
</span><span>		none
</span><span>		string &#34;</span><span>Wargaming.net | Lesta Studio</span><span>&#34;
</span><span>		string &#34;</span><span>an error occurred while loading module</span><span>&#34;
</span><span>		string &#34;</span><span>\x9a\xb6\x85</span><span>A.^lPGO0Z/</span><span>\xee</span><span>Y3o</span><span>\x11</span><span>$,FCPCi&amp;:U</span><span>\x04\t\x02</span><span>IS</span><span>\x15</span><span>5EJ</span><span>\x1a</span><span>3</span><span>\x96\x1f</span><span>=*</span><span>\xe2</span><span>?</span><span>\xa9</span><span>5</span><span>\xa5\t</span><span>f</span><span>\x13</span><span>hl</span><span>\x92</span><span>,</span><span>\x12\x14</span><span>T</span><span>\x06\xc8</span><span>o:</span><span>\x08\x16\xd4\xfd\xd0\x8c\xc1</span><span>T</span><span>\xa0\x9b\xe5</span><span>b</span><span>\xc3</span><span>%</span><span>\x0e</span><span>D</span><span>\x8e\x85\xfb</span><span>%</span><span>\x83\x9b\xff</span><span>L</span><span>\r</span><span>H</span><span>\r</span><span>uk</span><span>\x14\xf2</span><span>=</span><span>\xd7\x86\t\x13\x0b</span><span>k</span><span>\x83</span><span>HL</span><span>\t</span><span>H</span><span>\xbf\x07</span><span>6IM</span><span>\xa1\x0b</span><span>TP</span><span>\xdc\xc7</span><span>&lt;</span><span>\n\x08\x8c\xdd\x05\&#39;\x19\xf0\xa2</span><span>FL</span><span>\t\xbb\xd7\x15</span><span>=</span><span>\xd8\xc3\xba</span><span>3</span><span>\x19\x0f</span><span>k</span><span>\xd9\xe4\xf0\xbf\x9c</span><span>?</span><span>\n</span><span>TJP</span><span>\xc1\xcc\x17\xce\x04\x18\xfe</span><span>98</span><span>\x0e\x1d\x86\xdc\xab\x19\xe6</span><span>)M,</span><span>\x0e\xd4\xd8\xd4\x02\xb1\x0b</span><span>(&amp;;(o_</span><span>\x1c\x1b\x16\xd8\xe1</span><span>!-</span><span>\xad</span><span>w</span><span>\xda</span><span>%</span><span>\xd0</span><span>/</span><span>\xa2\x1a\x08</span><span>*7</span><span>\xc7\x9d\x10</span><span>7</span><span>\x0f\xe4\xcc\x1c\x0c</span><span>)...</span><span>
</span><span>	end
</span><span>	names </span><span>1
</span><span>		string &#34;</span><span>locals</span><span>&#34;
</span><span>	end
</span><span>	instructions
</span><span>		&lt;</span><span>255</span><span>&gt; </span><span>65532
</span><span>		</span><span>UNARY_INVERT 
</span><span>		</span><span>SETUP_EXCEPT </span><span>15
</span><span>		</span><span>LOAD_CONST </span><span>1 </span><span># Wargaming.net | Lesta Studio
</span><span>		</span><span>LOAD_NAME </span><span>0 </span><span># locals
</span><span>		</span><span>CALL_FUNCTION </span><span>0
</span><span>		</span><span>DUP_TOP 
</span><span>		</span><span>EXEC_STMT
</span><span>		</span><span>POP_BLOCK 
</span><span>		</span><span>JUMP_FORWARD </span><span>12
</span><span>		</span><span>3 </span><span>* </span><span>POP_TOP
</span><span>		</span><span>LOAD_CONST </span><span>2 </span><span># an error occurred while loading module
</span><span>		</span><span>PRINT_ITEM 
</span><span>		</span><span>PRINT_NEWLINE 
</span><span>		</span><span>JUMP_FORWARD </span><span>1
</span><span>		</span><span>END_FINALLY 
</span><span>		</span><span>LOAD_CONST </span><span>0 </span><span># None
</span><span>		</span><span>RETURN_VALUE 
</span><span>		</span><span>DELETE_NAME </span><span>23519
</span><span>		</span><span>UNARY_NOT
</span><span>		</span><span>DELETE_NAME </span><span>23438
</span><span>		&lt;</span><span>216</span><span>&gt; </span><span>64603
</span><span>		</span><span>INPLACE_OR
</span><span>		</span><span>UNARY_NOT
</span><span>		</span><span>DELETE_NAME </span><span>23308
</span><span>...
</span><span>end
</span></code></pre>
<p>Throughout my analysis of the obfuscation tricks I frequently leaned on pyasm for manually reordering/deleting instructions in order to figure out which sections were causing hiccups for the decompiler.</p>
<h2 id="wows-generic-obfuscation-tricks">WoWs - Generic Obfuscation Tricks</h2>
<h3 id="1-bogus-instructions">1: Bogus Instructions</h3>
<p>After decrypting and decompressing the 2nd stage code object, you&#39;ll find that tools like <a href="https://pypi.org/project/uncompyle6/">uncompyle6</a> fail to decompile the bytecode to source with an error. In his 2nd blog post lpcvoid covered one of Lesta&#39;s tricks of inserting bogus instructions that contain completely invalid opcodes which confuse these types of tools. One thing not mentioned is that these instructions can also be valid but really mess up the VM&#39;s stack and cause static analysis to enter a bad state.</p>
<p>Unfortunately, tools like uncompyle are mostly intended to run on Python bytecode generated cleanly by a Python VM. Invalid opcodes are definitely not supported, and neither are invalid instruction operands. This trick is the most straightforward for causing a decompiler to choke.</p>
<h3 id="2-stack-reordering">2: Stack Reordering</h3>
<p>Different Python code patterns -- even if semantically the same -- have very slight nuance in the emitted instructions. Tools like uncompyle in some cases rely on fragile instruction patterns for mapping to source code and will easily encounter errors when a wonky pattern is encountered.</p>
<p>The following is a completely made-up example, but consider the following instruction sequence:</p>
<pre><code><span>              224  LOAD_CONST            0
</span><span>              227  MAKE_FUNCTION_0       0  None
</span><span>
</span><span> L. 351       230  STORE_FAST            6  &#39;f333&#39;
</span></code></pre>
<p>This loads some code object from the const section, makes a function, and stores that function in <code>co_varnames[6]</code>. This would typically result in something like the following Python code:</p>
<pre data-lang="python"><code data-lang="python"><span>def </span><span>f333</span><span>():
</span><span>    </span><span>pass
</span></code></pre>
<p>Now imagine that the instructions were rewritten to push and immediately pop a value to the stack randomly in the middle of creating the function:</p>
<pre><code><span>              224  LOAD_CONST            0
</span><span>              227  MAKE_FUNCTION_0       0  None
</span><span>              ...  LOAD_CONST            None
</span><span>              ...  POP_TOP
</span><span>
</span><span> L. 351       230  STORE_FAST            6  &#39;f333&#39;
</span></code></pre>
<p>The <code>LOAD_CONST</code>/<code>MAKE_FUNCTION</code>/<code>STORE_FAST</code> pattern is broken by instructions that are effectively a no-op, and the signatures used by the decompilers are now broken.</p>
<h3 id="3-const-predicates">3: Const Predicates</h3>
<p>Related to trick #2, instruction patterns may be broken by inserting conditions that evaluate to a constant value. One side of the branch may bring you to some garbage instructions (trick #1) and on the other side of the branch will be the next set of valid code to be executed.</p>
<p>Consider the following pseudocode:</p>
<pre data-lang="python"><code data-lang="python"><span>              </span><span>224  </span><span>LOAD_CONST            </span><span>0
</span><span>              </span><span>227  </span><span>MAKE_FUNCTION_0       </span><span>0  None
</span><span>              </span><span>if </span><span>len</span><span>({</span><span>1</span><span>, </span><span>2</span><span>, </span><span>3</span><span>} &amp; {</span><span>2</span><span>}) &gt; </span><span>0</span><span>:
</span><span> L. </span><span>351       230  </span><span>STORE_FAST            </span><span>6  </span><span>&#39;</span><span>f333</span><span>&#39;
</span><span>              </span><span>else</span><span>:
</span><span>              </span><span>...  </span><span>POP_TOP
</span><span>              </span><span>...  </span><span>POP_TOP
</span><span>              </span><span>...  </span><span>POP_TOP
</span><span>              </span><span>...  </span><span>RETURN_VALUE
</span><span>
</span></code></pre>
<p>In the middle of defining a function we&#39;ve inserted a check to see if two sets overlap, and if so  we store the function in variable slot #6 (<code>STORE_FAST 6</code>). If the sets do not overlap, we go down the bogus code path that screws up stack state.</p>
<h3 id="4-variable-renaming">4: Variable Renaming</h3>
<p>This one really doesn&#39;t impact tools but definitely impacts any end user who manages to partially decompile anything: local variables and function names (in the serialized function object) are renamed to things that are illegal in Python source code such as keywords, operators, and a combination of these things with spaces. Function objects are typically renamed to be very large unique numbers. Here is a real example from when I first set on this project:</p>
<pre data-lang="python"><code data-lang="python"><span>
</span><span>            </span><span>def </span><span>f333</span><span>(</span><span>impf</span><span>, </span><span>f222</span><span>):
</span><span>                </span><span>continue </span><span>r ; = </span><span>66
</span><span>                h &gt;&gt; </span><span>]</span><span> = </span><span>87
</span><span>                </span><span>assert </span><span>}</span><span> </span><span>break </span><span>= </span><span>538
</span><span>                l </span><span>else try </span><span>6 </span><span>= </span><span>199
</span><span>                </span><span>continue </span><span>r ; += </span><span>66
</span><span>                h &gt;&gt; </span><span>]</span><span> -= </span><span>538
</span><span>                </span><span>assert </span><span>}</span><span> </span><span>break </span><span>*= </span><span>199
</span><span>                </span><span>if </span><span>not </span><span>continue</span><span> r ; + h &gt;&gt; </span><span>]</span><span> &gt;= </span><span>assert </span><span>}</span><span> </span><span>break </span><span>- h &gt;&gt; </span><span>]</span><span> + l </span><span>else try </span><span>6</span><span>:
</span><span>                    * k </span><span>try </span><span>4 </span><span>= </span><span>113
</span><span>                * k </span><span>try </span><span>4 </span><span>= </span><span>None
</span><span>                </span><span>2 </span><span>c = </span><span>22
</span><span>                v </span><span>as</span><span> </span><span>lambda </span><span>n </span><span>= </span><span>433
</span><span>                </span><span>6 </span><span>p = </span><span>147
</span><span>                * k </span><span>try</span><span> </span><span>4</span><span> </span><span>+=</span><span> </span><span>113</span><span>
</span><span>                </span><span>2 </span><span>c -= </span><span>433
</span><span>                v </span><span>as</span><span> </span><span>lambda </span><span>n </span><span>*=</span><span> </span><span>147</span><span>
</span><span>                </span><span>if </span><span>not * k </span><span>try</span><span> </span><span>4 </span><span>+ </span><span>2 </span><span>c &gt;= v </span><span>as</span><span> </span><span>lambda </span><span>n </span><span>-</span><span> </span><span>2</span><span> </span><span>c </span><span>+</span><span> </span><span>6</span><span> </span><span>p</span><span>:
</span><span>                    </span><span>pass
</span><span>                (j in, % /= p, </span><span>6 </span><span>{ +, y [, += </span><span>import</span><span> r) = ()
</span></code></pre>
<h3 id="5-implicit-returns">5: Implicit Returns</h3>
<p>The <code>RETURN_VALUE</code> instruction in Python returns the value located at the top of the VM&#39;s stack. Python will, as far as I&#39;m aware, always emit a <code>RETURN_VALUE</code> with the immediately preceding instruction setting up the value to be returned. For example:</p>
<pre><code><span>LOAD_FAST 0
</span><span>RETURN_VALUE
</span></code></pre>
<p>This loads the value stored at <code>co_varnames[0]</code> to the top of stack and returns it. Splitting up these instructions will break the pattern decompilers use to transform this into <code>return varname</code>. Imagine if the in the following code <code>tos</code> literally represented the top of the stack (and not a variable slot):</p>
<pre data-lang="python"><code data-lang="python"><span>if </span><span>condition:
</span><span>    tos = </span><span>get_return_value</span><span>()
</span><span>else</span><span>:
</span><span>    tos = </span><span>other_return_value</span><span>()
</span><span>
</span><span>return
</span></code></pre>
<p>This would create the following control flow:</p>
<p><img src="https://landaire.net/img/wows-obfuscation/implicit_return.svg" alt="Implicit return control flow"/></p>
<p>In this scenario the instruction immediately preceding the <code>RETURN_VALUE</code> isn&#39;t the instruction setting up the value -- it&#39;s likely some type of <code>JUMP</code> instruction or quite possibly anything else!</p>
<p>It&#39;s not clear to me if this is more of a code optimization trick, or an obfuscation trick, but really what&#39;s the difference?</p>
<h3 id="6-weird-jumps">6: Weird Jumps</h3>
<p>Something else I noticed was that some jumps were just... weird? There were randomish-looking <code>JUMP_FORWARD N</code> instructions that didn&#39;t make sense (but usually were just jumping over garbage instructions), and were hard to disambiguate from those legitimately generated by the Python compiler. For example, the following Python code may insert a <code>JUMP_FORWARD 0</code> (jump to the next instruction):</p>
<pre><code><span>if !foo: # POP_JUMP_IF_FALSE
</span><span>    # EMIT THIS CODE FIRST
</span><span>    if foo:
</span><span>        print &#34;target&#34;
</span><span>    else:
</span><span>        print &#34;else&#34;
</span><span># AFTER THE ABOVE BLOCK IS EMITTED, INSERT JUMP_FORWARD 0
</span><span>else:
</span><span>    # EMIT BLOCK
</span><span>    print &#34;main target&#34;
</span></code></pre>
<p>This probably doesn&#39;t make much sense, so let me show a real example of the control flow at an instruction level:</p>

<a href="https://landaire.net/img/wows-obfuscation/unnecessary_jump.png"><img src="https://landaire.net/processed_images/unnecessary_jump.718929423a8900b5.png"/></a>
<p>Do you notice the <code>JUMP_FORWARD 0</code> in the left-center node? It&#39;s completely unnecessary! The layout of these instructions when serialized is: <code>POP_TOP</code>, <code>POP_TOP</code>, <code>POP_TOP</code>, <code>JUMP_FORWARD 0</code>, <code>LOAD_FAST 2</code>. The execution sequence of these instructions is exactly the same as well. You could remove the <code>JUMP_FORWARD 0</code> and nothing of value would be lost. So why is it there?</p>
<p>It&#39;s just a side effect of how the Python compiler does codegen:</p>
<pre data-lang="python"><code data-lang="python"><span>def </span><span>visitIf</span><span>(</span><span>self</span><span>, </span><span>node</span><span>):
</span><span>    end = </span><span>self</span><span>.</span><span>newBlock</span><span>()
</span><span>    numtests = </span><span>len</span><span>(node.tests)
</span><span>    </span><span>for </span><span>i </span><span>in </span><span>range</span><span>(numtests):
</span><span>        test, suite = node.tests[i]
</span><span>        </span><span>if </span><span>is_constant_false</span><span>(test):
</span><span>            </span><span># XXX will need to check generator stuff here
</span><span>            </span><span>continue
</span><span>        </span><span>self</span><span>.</span><span>set_lineno</span><span>(test)
</span><span>        </span><span>self</span><span>.</span><span>visit</span><span>(test)
</span><span>        nextTest = </span><span>self</span><span>.</span><span>newBlock</span><span>()
</span><span>        </span><span>self</span><span>.</span><span>emit</span><span>(&#39;</span><span>POP_JUMP_IF_FALSE</span><span>&#39;, nextTest)
</span><span>        </span><span>self</span><span>.</span><span>nextBlock</span><span>()
</span><span>        </span><span>self</span><span>.</span><span>visit</span><span>(suite)
</span><span>        </span><span>self</span><span>.</span><span>emit</span><span>(&#39;</span><span>JUMP_FORWARD</span><span>&#39;, end) </span><span># &lt;--- UNCONDITIONALLY ADD `JUMP_FORWARD`
</span><span>        </span><span>self</span><span>.</span><span>startBlock</span><span>(nextTest)
</span><span>    </span><span>if </span><span>node.else_:
</span><span>        </span><span>self</span><span>.</span><span>visit</span><span>(node.else_)
</span><span>    </span><span>self</span><span>.</span><span>nextBlock</span><span>(end)
</span></code></pre>
<p>Sometimes that <code>JUMP_FORWARD</code> isn&#39;t jumping 0 bytes and may be some value that jumps over garbage instructions (and was inserted by the obfuscator). Other times this <code>JUMP_FORWARD</code> comes immediately after some other unconditional control flow instruction and will never be executed by a Python VM (or picked up by my instruction decoder).</p>
<p>So why can&#39;t it be removed if it&#39;s usually unnecessary? Unfortunately uncompyle relies on the presence of the <code>JUMP_FORWARD</code> to determine what type of condition has occurred.</p>
<h3 id="7-generally-weird-control-flow">7: Generally Weird Control Flow</h3>
<p>This one is hard to express without sounding psychotic, but let me just say: <strong>fuck loops, fuck exception handlers</strong>. If you combine the weird jumps and false predicates in loops, you may be able to generate some code that looks like a loop but is only ever executed for one iteration before just jumping to some other part of the code because of a const predicate.</p>
<p>And what about exception handlers that intentionally raise an exception that&#39;s supposed to be caught to trigger the &#34;good&#34; code path?</p>
<p>And what about nesting exceptions inside of loops with const predicates?</p>
<p>After encountering such a scenario I was starting to feel like this:</p>
<p><img src="https://landaire.net/img/wows-obfuscation/charlie.jpg" alt="Meme of Charlie&#39;s conspiracy theory board from It&#39;s Always Sunny in Philadelphia"/></p>
<h2 id="deobfuscation">Deobfuscation</h2>
<p>Deobfuscating everything together requires a solid framework that can achieve:</p>
<ol>
<li>Parsing all instructions in a manner that doesn&#39;t break on bogus opcodes</li>
<li>Evaluating conditions to determine used/unused code</li>
<li>Restoring instruction ordering</li>
<li>Restoring variable names</li>
<li>Deoptimizing code (implicit returns)</li>
<li>Normalize weird control flow</li>
</ol>
<p>...so yeah the natural path I took here was to rebuild the Python VM in Rust in 2 months and write somewhat spaghetti code that revisiting two years later has me thinking &#34;wtf was I smoking?&#34;.</p>
<h3 id="avoiding-bad-instructions">Avoiding Bad Instructions</h3>
<p>Parsing instructions is fairly straightforward: an instruction with no arguments is 1 byte (opcode), and an instruction with an argument is 3 bytes (opcode + uint16). You start parsing instructions by reading from offset 0 in the <code>co_code</code> section of the code object and just continue this in a loop.</p>
<p>Decompilers and disassemblers tend to read instructions <strong>linearly</strong> -- i.e. if the first instruction is <code>JUMP_ABSOLUTE 200</code> it&#39;s going to disassemble <code>JUMP_ABSOLUTE 200</code> from offset 0, then disassemble the next instruction from offset 3. This isn&#39;t great because you will run into a bunch of bogus instructions that can be avoided by simply creating a decoder that understands control flow.</p>
<p>To mitigate this in my deobfuscator I instead add instruction offsets to a queue. A <code>JUMP_ABSOLUTE 200</code> will add offset 200 as next in the queue, and a <code>JUMP_IF_{TRUE,FALSE} &lt;TARGET&gt;</code> will add the offset for the target <strong>and</strong> the next instruction to the queue.</p>
<p>Along the way I also compile an instruction graph where each node represents a basic block with edges to other basic blocks:</p>
<a href="https://landaire.net/img/wows-obfuscation/stage2_obfuscated.svg"><img src="https://landaire.net/img/wows-obfuscation/stage2_obfuscated.svg" width="500" height="500"/></a><h3 id="removing-const-predicates">Removing const predicates</h3>
<p>Remember how I said I rebuilt the Python VM in Rust? <a href="https://github.com/landaire/unfuck/blob/de4c631aa725ff8da5aed8e718117b607c009c3d/src/smallvm.rs#L130">I was serious, and it was <em>just</em> to solve this problem.</a> I do what I&#39;ve called &#34;partial execution&#34;. Certain builtin functions are handled, and an individual code object&#39;s opcodes are executed to obtain a snapshot of the VM&#39;s stack and perform taint tracking. The main function signature is:</p>
<pre data-lang="rust"><code data-lang="rust"><span>/// Executes an instruction, altering the input state and returning an error
</span><span>/// when the instruction cannot be correctly emulated. For example, some complex
</span><span>/// instructions are not currently supported at this time.
</span><span>pub fn </span><span>execute_instruction</span><span>&lt;O: Opcode&lt;Mnemonic = py27::Mnemonic&gt;, F, T&gt;(
</span><span>    </span><span>instr</span><span>: &amp;Instruction&lt;O&gt;,
</span><span>    </span><span>code</span><span>: Arc&lt;Code&gt;,
</span><span>    </span><span>stack</span><span>: &amp;</span><span>mut </span><span>VmStack&lt;T&gt;,
</span><span>    </span><span>vars</span><span>: &amp;</span><span>mut </span><span>VmVars&lt;T&gt;,
</span><span>    </span><span>names</span><span>: &amp;</span><span>mut </span><span>VmNames&lt;T&gt;,
</span><span>    </span><span>globals</span><span>: &amp;</span><span>mut </span><span>VmNames&lt;T&gt;,
</span><span>    </span><span>names_loaded</span><span>: LoadedNames,
</span><span>    </span><span>mut </span><span>function_callback</span><span>: F,
</span><span>    </span><span>access_tracking</span><span>: T,
</span><span>) -&gt; Result&lt;(), Error&lt;O&gt;&gt;;
</span></code></pre>
<p>Brief rundown of all inputs:</p>
<ul>
<li><code>instr</code>: the instruction to be executed</li>
<li><code>code</code>: the deserialized Python code object for which the instruction belongs to</li>
<li><code>stack</code>: current snapshot of the VM stack</li>
<li><code>vars</code>: all variable slots and their current values</li>
<li><code>names</code>: map to a <code>vars</code> slot</li>
<li><code>globals</code>: similar to <code>vars</code> but on a global level</li>
<li><code>names_loaded</code>: modules imported</li>
<li><code>function_callback</code>: callback for <code>CALL_FUNCTION</code> instruction and can be used for handling builtins or calling other code objects if desired</li>
<li><code>access_tracking</code>: data to associate with a VM stack value</li>
</ul>
<p>When an instruction is executed and the stack is modified, the modified stack value will represent a tuple of <code>(Option&lt;value&gt;, [access_tracking])</code>. The first value in the tuple is the value that resulted from executing an instruction if it could be determined, otherwise <code>None</code>. The second value will represent some metadata for looking up instructions which contributed to generating/modifying that stack value (a basic block index + instruction index).</p>
<p>The execution loop for a basic block looks something like this:</p>
<pre data-lang="python"><code data-lang="python"><span>for </span><span>instruction </span><span>in </span><span>basic_block:
</span><span>    </span><span>if </span><span>instruction.</span><span>is_conditional_jump</span><span>():
</span><span>        </span><span>if </span><span>tos[</span><span>0</span><span>].</span><span>is_some</span><span>():
</span><span>            </span><span># Determine the truthiness of top-of-stack.
</span><span>            </span><span>#
</span><span>            </span><span># Based off of the opcode (JUMP_IF_{TRUE,FALSE}), determine which
</span><span>            </span><span># branch is never taken and remove the edge from this BB to the BB
</span><span>            </span><span># we will never branch to.
</span><span>            </span><span>#
</span><span>            </span><span># We also iterate tos[1] and remove all of the instructions which
</span><span>            </span><span># contributed to tos[0].
</span><span>    </span><span>else</span><span>:
</span><span>        </span><span>execute_instruction</span><span>(instruction, </span><span>...</span><span>)
</span></code></pre>
<p>This will effectively <strong>remove</strong> instructions related to const conditions and (usually) the basic block not taken from the graph. These inserted, fake basic blocks are implicitly removed since they become orphaned from the main code graph.</p>
<p>There are some issues with this approach:</p>
<ol>
<li>I need to correctly implement almost all VM instructions</li>
<li>Large traces will balloon in computation complexity and memory</li>
<li>Complex arithmetic or unsupported instructions will immediately stop the VM, which leaves code only partially deobfuscated</li>
</ol>
<h3 id="restoring-variable-names">Restoring Variable Names</h3>
<p>Variable names are unfortunately always lost. Instead of &#34;restoring&#34;, I simply iterate and replace odd var names with the following script:</p>
<pre data-lang="python"><code data-lang="python"><span>def </span><span>fix_varnames</span><span>(</span><span>varnames</span><span>):
</span><span>    </span><span>global </span><span>unknowns
</span><span>    newvars = []
</span><span>    </span><span>for </span><span>var </span><span>in </span><span>varnames:
</span><span>        var = var.</span><span>strip</span><span>()
</span><span>        unallowed_chars = &#39;</span><span>=!@#$%^&amp;*()&#34;</span><span>\&#39;</span><span>/, </span><span>&#39;
</span><span>        banned_char = </span><span>False
</span><span>        banned_words = [&#39;</span><span>assert</span><span>&#39;, &#39;</span><span>in</span><span>&#39;, &#39;</span><span>continue</span><span>&#39;, &#39;</span><span>break</span><span>&#39;, &#39;</span><span>for</span><span>&#39;, &#39;</span><span>def</span><span>&#39;, &#39;</span><span>as</span><span>&#39;, &#39;</span><span>elif</span><span>&#39;, &#39;</span><span>else</span><span>&#39;, &#39;</span><span>for</span><span>&#39;, &#39;</span><span>from</span><span>&#39;, &#39;</span><span>global</span><span>&#39;, &#39;</span><span>if</span><span>&#39;, &#39;</span><span>import</span><span>&#39;, &#39;</span><span>is</span><span>&#39;, &#39;</span><span>lambda</span><span>&#39;, &#39;</span><span>not</span><span>&#39;, &#39;</span><span>or</span><span>&#39;, &#39;</span><span>pass</span><span>&#39;, &#39;</span><span>print</span><span>&#39;, &#39;</span><span>return</span><span>&#39;, &#39;</span><span>while</span><span>&#39;, &#39;</span><span>with</span><span>&#39;]
</span><span>        </span><span>for </span><span>c </span><span>in </span><span>unallowed_chars:
</span><span>            </span><span>if </span><span>c in var:
</span><span>                banned_char = </span><span>True
</span><span>
</span><span>        </span><span>if </span><span>not banned_char:
</span><span>            </span><span>if </span><span>var in banned_words:
</span><span>                banned_char = </span><span>True
</span><span>
</span><span>        </span><span>if </span><span>banned_char:
</span><span>            newvars.</span><span>append</span><span>(&#39;</span><span>unknown_</span><span>{0}</span><span>&#39;.</span><span>format</span><span>(unknowns))
</span><span>            unknowns += </span><span>1
</span><span>        </span><span>else</span><span>:
</span><span>            newvars.</span><span>append</span><span>(var)
</span><span>    
</span><span>    </span><span>return </span><span>tuple</span><span>(newvars)
</span></code></pre>
<p>Pretty simple replacement of illegal-looking variable name with <code>unknown_N</code>.</p>
<h3 id="restoring-function-names">Restoring Function Names</h3>
<p>Unlike var names, function names generally <em>can</em> be restored due to an oversight in the obfuscator. When a function is defined in a module, the bytecode for setting it up looks like the following:</p>
<pre><code><span>LOAD_CONST &lt;CONST_INDEX&gt; # Load the code object
</span><span>MAKE_FUNCTION # Take the loaded code object and tell the interpreter to turn it into a function
</span><span>STORE_NAME &lt;NAME_INDEX&gt; # Store the created function at the specified named index
</span></code></pre>
<p><code>NAME_INDEX</code> corresponds to a <code>name</code> string value located in the <code>co_names</code> array in the code object. The code object for the function also contains its name, which is generally what&#39;s used by decompilers to label a function. I leveraged this in my instruction handler loop by checking:</p>
<pre data-lang="python"><code data-lang="python"><span>for </span><span>instruction </span><span>in </span><span>basic_block:
</span><span>    </span><span>if </span><span>instruction.</span><span>is_store_name</span><span>():
</span><span>        accessed_instructions = tos[</span><span>1</span><span>]
</span><span>        </span><span>if </span><span>accessed_instructions[-</span><span>1</span><span>].</span><span>is_make_function</span><span>():
</span><span>            </span><span># change the function name on the code object to match what this
</span><span>            </span><span># scope sees as the function name
</span><span>            </span><span>fix_function_name</span><span>(tos[</span><span>0</span><span>], co.co_names[instruction.argument])
</span><span>
</span><span>    </span><span>execute_instruction</span><span>(instruction, </span><span>...</span><span>)
</span></code></pre>
<p>Strictly speaking these names aren&#39;t even necessary for the VM to run the code since they&#39;re really only present for debugging purposes. I suspect that this is either an oversight by Lesta or they deliberately left these in for debugging crashes on clients (although I&#39;m not certain if they send back Python crash reports). Maybe there&#39;s something I don&#39;t know though.</p>
<h3 id="deoptimizing-code">Deoptimizing Code</h3>
<p>I <em>think</em> that <code>RETURN_VALUE</code> is really the only case I had to correct, and it was a fairly simple fix.</p>
<ol>
<li>Look for basic blocks that contain only a <code>RETURN_VALUE</code> instruction</li>
<li>For each incoming edge, replace the final instruction in the basic block to be <code>RETURN_VALUE</code></li>
<li>Remove the basic block from step 1</li>
</ol>
<p>The example control flow for return values then provided <a href="https://landaire.net/world-of-warships-deobfuscation/#5-implicit-returns">in the section about implicit returns</a> will now look like this:</p>
<p><img src="https://landaire.net/img/wows-obfuscation/implicit_return_fix.svg" alt="Implicit return fixups"/></p>
<h3 id="fixing-bad-instructions">Fixing Bad Instructions</h3>
<p>There are some scenarios where code paths containing bad instructions can&#39;t be outright removed. Usually it&#39;s because a condition couldn&#39;t be proven to be a const predicate, or there was some other factor involved that led to it not being removed. Even though I <em>know</em> they&#39;re bad, I&#39;m hesitant to outright outright remove the nodes and conditions as gaps in the VM and data mixing may lead to incorrect instruction removal.</p>
<p>To correct these basic blocks I calculate the depth of the stack at the location of the bad instruction, insert enough <code>POP_TOP</code> instructions to clear out the stack, and finally put a <code>LOAD_CONST None</code> and <code>RETURN_VALUE</code> at the end of the basic block to force a <code>return None</code>.</p>
<h2 id="the-rest-of-the-matryoshka-doll">The Rest of The Matryoshka Doll</h2>
<p>There are four distinct &#34;stages&#34; to loading the Python module, two of which we&#39;ve already loosely discussed from lpcvoid&#39;s blog (encrypted code, and the compressed code).</p>
<h3 id="stage-2-decompressed-code">Stage 2 - Decompressed Code</h3>
<p>The following is an example stage 3 payload:</p>
<pre data-lang="python"><code data-lang="python"><span>import </span><span>sys, marshal, copy_reg
</span><span>if </span><span>id</span><span>(marshal.loads) != copy_reg.mmId:
</span><span>    </span><span>return
</span><span>code = sys.</span><span>_getframe</span><span>().f_back.f_code.co_code
</span><span>impf = (</span><span>isinstance</span><span>(__builtins__, dict) or __builtins__).__import__ </span><span>if </span><span>1 </span><span>else </span><span>__builtins__[&#39;</span><span>__import__</span><span>&#39;]
</span><span>if </span><span>not </span><span>hasattr</span><span>(impf, &#39;</span><span>func_code</span><span>&#39;) or </span><span>hash</span><span>(impf.func_code.co_code) != </span><span>1236377808</span><span>:
</span><span>    </span><span>if </span><span>hasattr</span><span>(impf, &#39;</span><span>func_code</span><span>&#39;) and </span><span>type</span><span>(impf.func_globals[&#39;</span><span>common</span><span>&#39;]) != </span><span>type</span><span>(marshal.loads):
</span><span>        </span><span>return
</span><span>
</span><span>    </span><span>def </span><span>f123</span><span>--- </span><span>This code section failed</span><span>: ---
</span><span>                </span><span>0  </span><span>LOAD_GLOBAL           </span><span>0  </span><span>&#39;</span><span>common</span><span>&#39;
</span><span>                </span><span>3  </span><span>LOAD_FAST             </span><span>0  </span><span>&#39;</span><span>arg</span><span>&#39;
</span><span>                </span><span>6  </span><span>LOAD_FAST             </span><span>1  </span><span>&#39;</span><span>kw</span><span>&#39;
</span><span>                </span><span>9  </span><span>CALL_FUNCTION_VAR_KW_0     </span><span>0  None
</span><span>               </span><span>12  </span><span>STORE_FAST            </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>               </span><span>15  </span><span>LOAD_GLOBAL           </span><span>1  </span><span>&#39;</span><span>type</span><span>&#39;
</span><span>               </span><span>18  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>               </span><span>21  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>               </span><span>24  </span><span>LOAD_ATTR             </span><span>2  </span><span>&#39;</span><span>__name__</span><span>&#39;
</span><span>               </span><span>27  </span><span>LOAD_CONST               </span><span>&#39;</span><span>module</span><span>&#39;
</span><span>               </span><span>30  </span><span>COMPARE_OP            </span><span>2  </span><span>==
</span><span>               </span><span>33  </span><span>POP_JUMP_IF_FALSE   </span><span>155  </span><span>&#39;</span><span>to 155</span><span>&#39;
</span><span>               </span><span>36  </span><span>LOAD_GLOBAL           </span><span>3  </span><span>&#39;</span><span>hasattr</span><span>&#39;
</span><span>               </span><span>39  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>               </span><span>42  </span><span>LOAD_CONST               </span><span>&#39;</span><span>__file__</span><span>&#39;
</span><span>               </span><span>45  </span><span>CALL_FUNCTION_2       </span><span>2  None
</span><span>               </span><span>48  </span><span>POP_JUMP_IF_FALSE   </span><span>155  </span><span>&#39;</span><span>to 155</span><span>&#39;
</span><span>               </span><span>51  </span><span>LOAD_GLOBAL           </span><span>3  </span><span>&#39;</span><span>hasattr</span><span>&#39;
</span><span>               </span><span>54  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>               </span><span>57  </span><span>LOAD_CONST               </span><span>&#39;</span><span>gCPLBx86</span><span>&#39;
</span><span>               </span><span>60  </span><span>CALL_FUNCTION_2       </span><span>2  None
</span><span>               </span><span>63  </span><span>UNARY_NOT
</span><span>               </span><span>64  </span><span>POP_JUMP_IF_TRUE     </span><span>82  </span><span>&#39;</span><span>to 82</span><span>&#39;
</span><span>               </span><span>67  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>               </span><span>70  </span><span>LOAD_ATTR             </span><span>4  </span><span>&#39;</span><span>gCPLBx86</span><span>&#39;
</span><span>               </span><span>73  </span><span>LOAD_CONST               </span><span>&#39;</span><span>1663084375</span><span>&#39;
</span><span>               </span><span>76  </span><span>COMPARE_OP            </span><span>3  </span><span>!=
</span><span>             </span><span>79_0  </span><span>COME_FROM            </span><span>64  </span><span>&#39;</span><span>64</span><span>&#39;
</span><span>               </span><span>79  </span><span>POP_JUMP_IF_FALSE   </span><span>155  </span><span>&#39;</span><span>to 155</span><span>&#39;
</span><span>               </span><span>82  </span><span>LOAD_FAST             </span><span>0  </span><span>&#39;</span><span>arg</span><span>&#39;
</span><span>               </span><span>85  </span><span>LOAD_CONST               </span><span>0
</span><span>               </span><span>88  </span><span>BINARY_SUBSCR
</span><span>               </span><span>89  </span><span>LOAD_CONST               </span><span>(&#39;</span><span>collections</span><span>&#39;, &#39;</span><span>utf8_test</span><span>&#39;, &#39;</span><span>copy_reg</span><span>&#39;)
</span><span>               </span><span>92  </span><span>COMPARE_OP            </span><span>7  </span><span>not-in
</span><span>             </span><span>95_0  </span><span>COME_FROM            </span><span>79  </span><span>&#39;</span><span>79</span><span>&#39;
</span><span>             </span><span>95_1  </span><span>COME_FROM            </span><span>48  </span><span>&#39;</span><span>48</span><span>&#39;
</span><span>             </span><span>95_2  </span><span>COME_FROM            </span><span>33  </span><span>&#39;</span><span>33</span><span>&#39;
</span><span>               </span><span>95  </span><span>POP_JUMP_IF_FALSE   </span><span>155  </span><span>&#39;</span><span>to 155</span><span>&#39;
</span><span>               </span><span>98  </span><span>SETUP_EXCEPT         </span><span>48  </span><span>&#39;</span><span>to 149</span><span>&#39;
</span><span>              </span><span>101  </span><span>LOAD_GLOBAL           </span><span>5  </span><span>&#39;</span><span>loaded</span><span>&#39;
</span><span>              </span><span>104  </span><span>LOAD_ATTR             </span><span>6  </span><span>&#39;</span><span>add</span><span>&#39;
</span><span>              </span><span>107  </span><span>LOAD_GLOBAL           </span><span>7  </span><span>&#39;</span><span>id</span><span>&#39;
</span><span>              </span><span>110  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>              </span><span>113  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>              </span><span>116  </span><span>LOAD_FAST             </span><span>0  </span><span>&#39;</span><span>arg</span><span>&#39;
</span><span>              </span><span>119  </span><span>LOAD_CONST               </span><span>0
</span><span>              </span><span>122  </span><span>BINARY_SUBSCR
</span><span>              </span><span>123  </span><span>BUILD_TUPLE_2         </span><span>2
</span><span>              </span><span>126  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>              </span><span>129  </span><span>POP_TOP
</span><span>              </span><span>130  </span><span>LOAD_GLOBAL           </span><span>8  </span><span>&#39;</span><span>sys</span><span>&#39;
</span><span>              </span><span>133  </span><span>DUP_TOP
</span><span>              </span><span>134  </span><span>LOAD_ATTR             </span><span>9  </span><span>&#39;</span><span>errCnt</span><span>&#39;
</span><span>              </span><span>137  </span><span>LOAD_CONST               </span><span>1
</span><span>              </span><span>140  </span><span>INPLACE_ADD
</span><span>              </span><span>141  </span><span>ROT_TWO
</span><span>              </span><span>142  </span><span>STORE_ATTR            </span><span>9  </span><span>&#39;</span><span>errCnt</span><span>&#39;
</span><span>              </span><span>145  </span><span>POP_BLOCK
</span><span>              </span><span>146  </span><span>JUMP_FORWARD          </span><span>6  </span><span>&#39;</span><span>to 155</span><span>&#39;
</span><span>            </span><span>149_0  </span><span>COME_FROM            </span><span>98  </span><span>&#39;</span><span>98</span><span>&#39;
</span><span>              </span><span>149  </span><span>POP_TOP
</span><span>              </span><span>150  </span><span>POP_TOP
</span><span>              </span><span>151  </span><span>POP_TOP
</span><span>              </span><span>152  </span><span>JUMP_FORWARD          </span><span>0  </span><span>&#39;</span><span>to 155</span><span>&#39;
</span><span>            </span><span>155_0  </span><span>COME_FROM           </span><span>152  </span><span>&#39;</span><span>152</span><span>&#39;
</span><span>            </span><span>155_1  </span><span>COME_FROM           </span><span>146  </span><span>&#39;</span><span>146</span><span>&#39;
</span><span>              </span><span>155  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>res</span><span>&#39;
</span><span>              </span><span>158  </span><span>RETURN_VALUE
</span><span>               -</span><span>1  </span><span>RETURN_LAST
</span><span>
</span><span>Parse error at or near `</span><span>None</span><span>&#39;</span><span> instruction at offset -1</span><span>
</span><span>
</span><span>
</span><span>    </span><span>def </span><span>f123</span><span>(</span><span>impf</span><span>, </span><span>f222</span><span>):
</span><span>        </span><span>import </span><span>sys
</span><span>        f222.func_globals[&#39;</span><span>loaded</span><span>&#39;] = </span><span>set</span><span>()
</span><span>        </span><span>if </span><span>not </span><span>isinstance</span><span>(__builtins__, dict):
</span><span>            f222.func_globals[&#39;</span><span>common</span><span>&#39;] = __builtins__.__import__ </span><span>if </span><span>1 </span><span>else </span><span>__builtins__[&#39;</span><span>__import__</span><span>&#39;]
</span><span>            f222.func_globals[&#39;</span><span>sys</span><span>&#39;] = sys
</span><span>            sys.errCnt = </span><span>0
</span><span>            __builtins__.__import__ = </span><span>isinstance</span><span>(__builtins__, dict) or f222
</span><span>        </span><span>else</span><span>:
</span><span>            __builtins__[&#39;</span><span>__import__</span><span>&#39;] = f222
</span><span>        sys.</span><span>settrace</span><span>(</span><span>None</span><span>)
</span><span>        sys.settrace = sys.getrefcount
</span><span>        sys.</span><span>setprofile</span><span>(</span><span>None</span><span>)
</span><span>        sys.setprofile = sys.getrefcount
</span><span>        sys.gettrace = sys.exit
</span><span>        sys.getprofile = sys.exit
</span><span>        </span><span>return
</span><span>
</span><span>
</span><span>    </span><span>f333</span><span>(impf, f222)
</span><span>    impf = f222
</span><span>
</span><span>def </span><span>f123</span><span>(</span><span>marshaled</span><span>):
</span><span>    swapMap = {</span><span>0</span><span>: </span><span>151</span><span>, </span><span>1</span><span>: </span><span>235</span><span>, </span><span>2</span><span>: </span><span>9</span><span>, </span><span>3</span><span>: </span><span>249</span><span>, </span><span>4</span><span>: </span><span>100</span><span>, </span><span>5</span><span>: </span><span>10</span><span>, </span><span>6</span><span>: </span><span>188</span><span>, </span><span>7</span><span>: </span><span>106</span><span>, </span><span>8</span><span>: </span><span>128</span><span>, </span><span>9</span><span>: </span><span>122</span><span>, </span><span>10</span><span>: </span><span>220</span><span>, </span><span>11</span><span>: </span><span>189</span><span>, </span><span>12</span><span>: </span><span>242</span><span>, </span><span>13</span><span>: </span><span>253</span><span>, </span><span>14</span><span>: </span><span>210</span><span>, </span><span>15</span><span>: </span><span>243</span><span>, </span><span>16</span><span>: </span><span>5</span><span>, </span><span>17</span><span>: </span><span>27</span><span>, </span><span>18</span><span>: </span><span>222</span><span>, </span><span>19</span><span>: </span><span>90</span><span>, </span><span>20</span><span>: </span><span>139</span><span>, </span><span>21</span><span>: </span><span>18</span><span>, </span><span>22</span><span>: </span><span>79</span><span>, </span><span>23</span><span>: </span><span>255</span><span>, </span><span>24</span><span>: </span><span>230</span><span>, </span><span>25</span><span>: </span><span>83</span><span>, </span><span>26</span><span>: </span><span>20</span><span>, </span><span>27</span><span>: </span><span>74</span><span>, </span><span>28</span><span>: </span><span>89</span><span>, </span><span>29</span><span>: </span><span>141</span><span>, </span><span>30</span><span>: </span><span>219</span><span>, </span><span>31</span><span>: </span><span>123</span><span>, </span><span>32</span><span>: </span><span>203</span><span>, </span><span>33</span><span>: </span><span>51</span><span>, </span><span>34</span><span>: </span><span>98</span><span>, </span><span>35</span><span>: </span><span>53</span><span>, </span><span>36</span><span>: </span><span>103</span><span>, </span><span>37</span><span>: </span><span>204</span><span>, </span><span>38</span><span>: </span><span>190</span><span>, </span><span>39</span><span>: </span><span>118</span><span>, </span><span>40</span><span>: </span><span>62</span><span>, </span><span>41</span><span>: </span><span>161</span><span>, </span><span>42</span><span>: </span><span>41</span><span>, </span><span>43</span><span>: </span><span>241</span><span>, </span><span>44</span><span>: </span><span>247</span><span>, </span><span>45</span><span>: </span><span>101</span><span>, </span><span>46</span><span>: </span><span>196</span><span>, </span><span>47</span><span>: </span><span>153</span><span>, </span><span>48</span><span>: </span><span>181</span><span>, </span><span>49</span><span>: </span><span>40</span><span>, </span><span>50</span><span>: </span><span>152</span><span>, </span><span>51</span><span>: </span><span>174</span><span>, </span><span>52</span><span>: </span><span>140</span><span>, </span><span>53</span><span>: </span><span>171</span><span>, </span><span>54</span><span>: </span><span>44</span><span>, </span><span>55</span><span>: </span><span>134</span><span>, </span><span>56</span><span>: </span><span>158</span><span>, </span><span>57</span><span>: </span><span>88</span><span>, </span><span>58</span><span>: </span><span>70</span><span>, </span><span>59</span><span>: </span><span>132</span><span>, </span><span>60</span><span>: </span><span>173</span><span>, </span><span>61</span><span>: </span><span>2</span><span>, </span><span>62</span><span>: </span><span>129</span><span>, </span><span>63</span><span>: </span><span>8</span><span>, </span><span>64</span><span>: </span><span>86</span><span>, </span><span>65</span><span>: </span><span>21</span><span>, </span><span>66</span><span>: </span><span>148</span><span>, </span><span>67</span><span>: </span><span>145</span><span>, </span><span>68</span><span>: </span><span>211</span><span>, </span><span>69</span><span>: </span><span>127</span><span>, </span><span>70</span><span>: </span><span>224</span><span>, </span><span>71</span><span>: </span><span>167</span><span>, </span><span>72</span><span>: </span><span>185</span><span>, </span><span>73</span><span>: </span><span>237</span><span>, </span><span>74</span><span>: </span><span>147</span><span>, </span><span>75</span><span>: </span><span>233</span><span>, </span><span>76</span><span>: </span><span>58</span><span>, </span><span>77</span><span>: </span><span>175</span><span>, </span><span>78</span><span>: </span><span>14</span><span>, </span><span>79</span><span>: </span><span>252</span><span>, </span><span>80</span><span>: </span><span>209</span><span>, </span><span>81</span><span>: </span><span>155</span><span>, </span><span>82</span><span>: </span><span>37</span><span>, </span><span>83</span><span>: </span><span>162</span><span>, </span><span>84</span><span>: </span><span>42</span><span>, </span><span>85</span><span>: </span><span>227</span><span>, </span><span>86</span><span>: </span><span>78</span><span>, </span><span>87</span><span>: </span><span>136</span><span>, </span><span>88</span><span>: </span><span>12</span><span>, </span><span>89</span><span>: </span><span>246</span><span>, </span><span>90</span><span>: </span><span>81</span><span>, </span><span>91</span><span>: </span><span>126</span><span>, </span><span>92</span><span>: </span><span>186</span><span>, </span><span>93</span><span>: </span><span>6</span><span>, </span><span>94</span><span>: </span><span>87</span><span>, </span><span>95</span><span>: </span><span>150</span><span>, </span><span>96</span><span>: </span><span>96</span><span>, </span><span>97</span><span>: </span><span>39</span><span>, </span><span>98</span><span>: </span><span>193</span><span>, </span><span>99</span><span>: </span><span>28</span><span>, </span><span>100</span><span>: </span><span>55</span><span>, </span><span>101</span><span>: </span><span>59</span><span>, </span><span>102</span><span>: </span><span>200</span><span>, </span><span>103</span><span>: </span><span>30</span><span>, </span><span>104</span><span>: </span><span>225</span><span>, </span><span>105</span><span>: </span><span>197</span><span>, </span><span>106</span><span>: </span><span>212</span><span>, </span><span>107</span><span>: </span><span>213</span><span>, </span><span>108</span><span>: </span><span>245</span><span>, </span><span>109</span><span>: </span><span>179</span><span>, </span><span>110</span><span>: </span><span>105</span><span>, </span><span>111</span><span>: </span><span>111</span><span>, </span><span>112</span><span>: </span><span>112</span><span>, </span><span>113</span><span>: </span><span>32</span><span>, </span><span>114</span><span>: </span><span>156</span><span>, </span><span>115</span><span>: </span><span>91</span><span>, </span><span>116</span><span>: </span><span>68</span><span>, </span><span>117</span><span>: </span><span>50</span><span>, </span><span>118</span><span>: </span><span>13</span><span>, </span><span>119</span><span>: </span><span>66</span><span>, </span><span>120</span><span>: </span><span>84</span><span>, </span><span>121</span><span>: </span><span>159</span><span>, </span><span>122</span><span>: </span><span>182</span><span>, </span><span>123</span><span>: </span><span>102</span><span>, </span><span>124</span><span>: </span><span>221</span><span>, </span><span>125</span><span>: </span><span>154</span><span>, </span><span>126</span><span>: </span><span>57</span><span>, </span><span>127</span><span>: </span><span>254</span><span>, </span><span>128</span><span>: </span><span>130</span><span>, </span><span>129</span><span>: </span><span>17</span><span>, </span><span>130</span><span>: </span><span>82</span><span>, </span><span>131</span><span>: </span><span>77</span><span>, </span><span>132</span><span>: </span><span>104</span><span>, </span><span>133</span><span>: </span><span>95</span><span>, </span><span>134</span><span>: </span><span>146</span><span>, </span><span>135</span><span>: </span><span>48</span><span>, </span><span>136</span><span>: </span><span>169</span><span>, </span><span>137</span><span>: </span><span>164</span><span>, </span><span>138</span><span>: </span><span>121</span><span>, </span><span>139</span><span>: </span><span>223</span><span>, </span><span>140</span><span>: </span><span>11</span><span>, </span><span>141</span><span>: </span><span>232</span><span>, </span><span>142</span><span>: </span><span>244</span><span>, </span><span>143</span><span>: </span><span>218</span><span>, </span><span>144</span><span>: </span><span>85</span><span>, </span><span>145</span><span>: </span><span>113</span><span>, </span><span>146</span><span>: </span><span>177</span><span>, </span><span>147</span><span>: </span><span>166</span><span>, </span><span>148</span><span>: </span><span>52</span><span>, </span><span>149</span><span>: </span><span>24</span><span>, </span><span>150</span><span>: </span><span>170</span><span>, </span><span>151</span><span>: </span><span>4</span><span>, </span><span>152</span><span>: </span><span>73</span><span>, </span><span>153</span><span>: </span><span>144</span><span>, </span><span>154</span><span>: </span><span>236</span><span>, </span><span>155</span><span>: </span><span>34</span><span>, </span><span>156</span><span>: </span><span>205</span><span>, </span><span>157</span><span>: </span><span>115</span><span>, </span><span>158</span><span>: </span><span>114</span><span>, </span><span>159</span><span>: </span><span>226</span><span>, </span><span>160</span><span>: </span><span>45</span><span>, </span><span>161</span><span>: </span><span>234</span><span>, </span><span>162</span><span>: </span><span>19</span><span>, </span><span>163</span><span>: </span><span>133</span><span>, </span><span>164</span><span>: </span><span>168</span><span>, </span><span>165</span><span>: </span><span>135</span><span>, </span><span>166</span><span>: </span><span>194</span><span>, </span><span>167</span><span>: </span><span>99</span><span>, </span><span>168</span><span>: </span><span>138</span><span>, </span><span>169</span><span>: </span><span>251</span><span>, </span><span>170</span><span>: </span><span>46</span><span>, </span><span>171</span><span>: </span><span>72</span><span>, </span><span>172</span><span>: </span><span>60</span><span>, </span><span>173</span><span>: </span><span>94</span><span>, </span><span>174</span><span>: </span><span>31</span><span>, </span><span>175</span><span>: </span><span>75</span><span>, </span><span>176</span><span>: </span><span>3</span><span>, </span><span>177</span><span>: </span><span>178</span><span>, </span><span>178</span><span>: </span><span>116</span><span>, </span><span>179</span><span>: </span><span>238</span><span>, </span><span>180</span><span>: </span><span>7</span><span>, </span><span>181</span><span>: </span><span>143</span><span>, </span><span>182</span><span>: </span><span>92</span><span>, </span><span>183</span><span>: </span><span>142</span><span>, </span><span>184</span><span>: </span><span>176</span><span>, </span><span>185</span><span>: </span><span>25</span><span>, </span><span>186</span><span>: </span><span>108</span><span>, </span><span>187</span><span>: </span><span>250</span><span>, </span><span>188</span><span>: </span><span>16</span><span>, </span><span>189</span><span>: </span><span>160</span><span>, </span><span>190</span><span>: </span><span>107</span><span>, </span><span>191</span><span>: </span><span>240</span><span>, </span><span>192</span><span>: </span><span>208</span><span>, </span><span>193</span><span>: </span><span>0</span><span>, </span><span>194</span><span>: </span><span>187</span><span>, </span><span>195</span><span>: </span><span>49</span><span>, </span><span>196</span><span>: </span><span>15</span><span>, </span><span>197</span><span>: </span><span>184</span><span>, </span><span>198</span><span>: </span><span>199</span><span>, </span><span>199</span><span>: </span><span>43</span><span>, </span><span>200</span><span>: </span><span>165</span><span>, </span><span>201</span><span>: </span><span>38</span><span>, </span><span>202</span><span>: </span><span>125</span><span>, </span><span>203</span><span>: </span><span>76</span><span>, </span><span>204</span><span>: </span><span>110</span><span>, </span><span>205</span><span>: </span><span>71</span><span>, </span><span>206</span><span>: </span><span>33</span><span>, </span><span>207</span><span>: </span><span>217</span><span>, </span><span>208</span><span>: </span><span>1</span><span>, </span><span>209</span><span>: </span><span>229</span><span>, </span><span>210</span><span>: </span><span>120</span><span>, </span><span>211</span><span>: </span><span>131</span><span>, </span><span>212</span><span>: </span><span>195</span><span>, </span><span>213</span><span>: </span><span>69</span><span>, </span><span>214</span><span>: </span><span>231</span><span>, </span><span>215</span><span>: </span><span>97</span><span>, </span><span>216</span><span>: </span><span>248</span><span>, </span><span>217</span><span>: </span><span>201</span><span>, </span><span>218</span><span>: </span><span>206</span><span>, </span><span>219</span><span>: </span><span>22</span><span>, </span><span>220</span><span>: </span><span>23</span><span>, </span><span>221</span><span>: </span><span>35</span><span>, </span><span>222</span><span>: </span><span>207</span><span>, </span><span>223</span><span>: </span><span>124</span><span>, </span><span>224</span><span>: </span><span>137</span><span>, </span><span>225</span><span>: </span><span>65</span><span>, </span><span>226</span><span>: </span><span>157</span><span>, </span><span>227</span><span>: </span><span>93</span><span>, </span><span>228</span><span>: </span><span>180</span><span>, </span><span>229</span><span>: </span><span>56</span><span>, </span><span>230</span><span>: </span><span>117</span><span>, </span><span>231</span><span>: </span><span>63</span><span>, </span><span>232</span><span>: </span><span>191</span><span>, </span><span>233</span><span>: </span><span>109</span><span>, </span><span>234</span><span>: </span><span>239</span><span>, </span><span>235</span><span>: </span><span>36</span><span>, </span><span>236</span><span>: </span><span>202</span><span>, </span><span>237</span><span>: </span><span>163</span><span>, </span><span>238</span><span>: </span><span>119</span><span>, </span><span>239</span><span>: </span><span>214</span><span>, </span><span>240</span><span>: </span><span>183</span><span>, </span><span>241</span><span>: </span><span>54</span><span>, </span><span>242</span><span>: </span><span>172</span><span>, </span><span>243</span><span>: </span><span>29</span><span>, </span><span>244</span><span>: </span><span>47</span><span>, </span><span>245</span><span>: </span><span>228</span><span>, </span><span>246</span><span>: </span><span>198</span><span>, </span><span>247</span><span>: </span><span>61</span><span>, </span><span>248</span><span>: </span><span>26</span><span>, </span><span>249</span><span>: </span><span>149</span><span>, </span><span>250</span><span>: </span><span>67</span><span>, </span><span>251</span><span>: </span><span>216</span><span>, </span><span>252</span><span>: </span><span>192</span><span>, </span><span>253</span><span>: </span><span>80</span><span>, </span><span>254</span><span>: </span><span>64</span><span>, </span><span>255</span><span>: </span><span>215</span><span>}
</span><span>    marshaled = (&#39;&#39;).</span><span>join</span><span>(</span><span>map</span><span>(</span><span>chr</span><span>, [ swapMap[</span><span>ord</span><span>(n)] </span><span>for </span><span>n </span><span>in </span><span>marshaled ]))
</span><span>    </span><span>return </span><span>marshaled
</span><span>
</span><span>
</span><span>co_code = [ </span><span>chr</span><span>(((byte ^ </span><span>38</span><span>) &amp; </span><span>126 </span><span>| (byte ^ </span><span>38</span><span>) &gt;&gt; </span><span>7 </span><span>&amp; </span><span>1 </span><span>| ((byte ^ </span><span>38</span><span>) &amp; </span><span>1</span><span>) &lt;&lt; </span><span>7</span><span>) ^ </span><span>89</span><span>) </span><span>for </span><span>byte </span><span>in </span><span>[ </span><span>ord</span><span>(byte) </span><span>for </span><span>byte </span><span>in </span><span>f123</span><span>(code) ] ]
</span><span>locDict = {}
</span><span>locDict[&#39;</span><span>globs</span><span>&#39;] = sys.</span><span>_getframe</span><span>().f_back.f_globals
</span><span>locDict[&#39;</span><span>code</span><span>&#39;] = marshal.</span><span>loads</span><span>((&#39;&#39;).</span><span>join</span><span>(co_code[::-</span><span>1</span><span>]))
</span><span>locDict[&#39;</span><span>marshal</span><span>&#39;] = marshal
</span><span>exec </span><span>locDict[&#39;</span><span>code</span><span>&#39;] in locDict
</span><span>
</span><span>def </span><span>f111</span><span>():
</span><span>    </span><span>pass
</span><span>
</span><span>
</span><span>f111</span><span>()
</span><span>del </span><span>f111
</span></code></pre>
<p>There are some checks to ensure that certain state is set up, but in general this will:</p>
<ol>
<li>Load the <code>co_code</code> from the original stage 1 file</li>
<li>Apply a substitution cipher over each byte</li>
<li>Do some bit arithmetic on each byte of the result from step 2</li>
<li>Execute the code that was just decoded</li>
</ol>
<p>In my deobfuscator I was able to leverage the custom Python VM to apply the swapmap for me by creating a state machine. Essentially I scan for certain instructions that look like they&#39;re applying the swapmap, then execute that function with some fake VM stack set up. That code can be found here: <a href="https://github.com/landaire/wowsdeob/blob/ffeeedaea9390c1d1e9ba785360e75aaa1aa10d0/src/smallvm.rs">https://github.com/landaire/wowsdeob/blob/ffeeedaea9390c1d1e9ba785360e75aaa1aa10d0/src/smallvm.rs</a></p>
<h3 id="stage-3">Stage 3</h3>
<p>This stage is pretty boring all things considered. The Stage 3 code object is just another compressed code object that&#39;s been base64 encoded and had the result reversed.</p>
<p><img src="https://landaire.net/img/wows-obfuscation/stage3_base64.png" alt="Sample showing the base64-encoded data"/></p>
<p>No big tricks here. The deobfuscator logic can be found here: <a href="https://github.com/landaire/wowsdeob/blob/ffeeedaea9390c1d1e9ba785360e75aaa1aa10d0/src/main.rs#L290-L297">https://github.com/landaire/wowsdeob/blob/ffeeedaea9390c1d1e9ba785360e75aaa1aa10d0/src/main.rs#L290-L297</a>.</p>
<p>Worth noting that this is the stage which references the Lestas &#34;Anti noobs protection&#34;!</p>
<p><img src="https://landaire.net/img/wows-obfuscation/stage3_anti_noobs_protection.png" alt="Anti noobs protection"/></p>
<h3 id="stage-4">Stage 4</h3>
<p>We have the final module! This module now needs to have all generic deobfuscation tricks applied to get decompilation.</p>
<h2 id="end-result">End Result</h2>
<p>The end result of this effort is going from a file that fails to decompile:</p>
<pre data-lang="bash"><code data-lang="bash"><span>❯</span><span> uncompyle6 ./output/AirplaneUtils_stage4.pyc
</span><span># uncompyle6 version 3.8.0
</span><span># Python bytecode 2.7 (62211)
</span><span># Decompiled from: Python 2.7.18 (default, Sep 28 2022, 20:52:16)
</span><span># [GCC Apple LLVM 14.0.0 (clang-1400.0.29.102)]
</span><span># Warning: this version of Python has problems handling the Python 3 byte type in constants properly.
</span><span>
</span><span># Embedded file name: 26977129990194521
</span><span># Compiled at: 2020-12-14 08:10:48
</span><span>Traceback</span><span> (most recent call last)</span><span>:
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/bin/uncompyle6</span><span>&#34;, line 10, in &lt;module&gt;
</span><span>    </span><span>sys.exit</span><span>(main_bin())
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/lib/python2.7/site-packages/uncompyle6/bin/uncompile.py</span><span>&#34;, line 194, in main_bin
</span><span>    </span><span>**options</span><span>)
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/lib/python2.7/site-packages/uncompyle6/main.py</span><span>&#34;, line 328, in main
</span><span>    </span><span>do_fragments,
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/lib/python2.7/site-packages/uncompyle6/main.py</span><span>&#34;, line 230, in decompile_file
</span><span>    </span><span>do_fragments</span><span>=</span><span>do_fragments,
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/lib/python2.7/site-packages/uncompyle6/main.py</span><span>&#34;, line 149, in decompile
</span><span>    </span><span>co,</span><span> out, bytecode_version, debug_opts=debug_opts, is_pypy=is_pypy
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/lib/python2.7/site-packages/uncompyle6/semantics/pysource.py</span><span>&#34;, line 2578, in code_deparse
</span><span>    </span><span>co,</span><span> code_objects=code_objects, show_asm=debug_opts</span><span>[</span><span>&#34;</span><span>asm</span><span>&#34;</span><span>]
</span><span>  </span><span>File </span><span>&#34;</span><span>/Users/lander/.pyenv/versions/2.7.18/lib/python2.7/site-packages/uncompyle6/scanners/scanner2.py</span><span>&#34;, line 350, in ingest
</span><span>    </span><span>pattr</span><span> = names</span><span>[</span><span>oparg</span><span>]
</span><span>IndexError:</span><span> tuple index out of range
</span><span>zsh:</span><span> exit 1     uncompyle6 ./output/AirplaneUtils_stage4.pyc
</span></code></pre>
<p>To:</p>
<pre data-lang="python"><code data-lang="python"><span># uncompyle6 version 3.8.0
</span><span># Python bytecode 2.7 (62211)
</span><span># Decompiled from: Python 2.7.18 (default, Sep 28 2022, 20:52:16) 
</span><span># [GCC Apple LLVM 14.0.0 (clang-1400.0.29.102)]
</span><span># Warning: this version of Python has problems handling the Python 3 byte type in constants properly.
</span><span>
</span><span># Embedded file name: 123823449462
</span><span># Compiled at: 2020-12-14 08:10:48
</span><span>import </span><span>math, random
</span><span>from </span><span>ConstantsUtils </span><span>import </span><span>idGenerator
</span><span>import </span><span>GameParams, Junk, Lesta
</span><span>from </span><span>Math </span><span>import </span><span>Vector3
</span><span>from </span><span>AirPlanes.AirplaneConstants </span><span>import </span><span>DeathReason, SquadronStateEnum, Throttle, TurnDirection, PlaneTypeNames
</span><span>from </span><span>AirplaneConstants </span><span>import </span><span>SQUADRON_DEPARTURE_BIT</span><span>, </span><span>SQUADRON_PURPOSE_BIT</span><span>, </span><span>SQUADRON_INDEX_BIT</span><span>, </span><span>PLANETYPE_2_PARAMSNAME</span><span>, </span><span>PLANE_TORPEDO_CONE_HALF_WIDTH</span><span>, PlaneTypes, </span><span>PLANE_PROJECTILE_GRAVITY
</span><span>from </span><span>mc0f1198d </span><span>import </span><span>devMode
</span><span>from </span><span>md0ce06f9 </span><span>import </span><span>LOG_ERROR
</span><span>from </span><span>m79622f13 </span><span>import </span><span>normaliseAngle, getDirectionFromYaw, lerp, lerpAngles, getDirectionFromYawPitch, </span><span>EPSILON
</span><span>from </span><span>PlanesDEFConverter </span><span>import </span><span>PlanesDictConverter
</span><span>from </span><span>PyMagic </span><span>import </span><span>pTuple
</span><span>from </span><span>mc062022a </span><span>import </span><span>ShipTypes
</span><span>from </span><span>shared_constants.m22c5a818 </span><span>import </span><span>PLANE_AMMO_TYPES
</span><span>
</span><span>class </span><span>WayPoint</span><span>:
</span><span>    enum = </span><span>idGenerator</span><span>(</span><span>0</span><span>)
</span><span>    </span><span>GENERATED </span><span>= </span><span>next</span><span>(enum)
</span><span>    </span><span>RESET </span><span>= </span><span>next</span><span>(enum)
</span><span>    </span><span>LAUNCHING_START_NODE </span><span>= </span><span>next</span><span>(enum)
</span><span>    </span><span>LAUNCHING_END_NODE </span><span>= </span><span>next</span><span>(enum)
</span><span>    </span><span>LANDING_START_NODE </span><span>= </span><span>next</span><span>(enum)
</span><span>    </span><span>LANDING_END_NODE </span><span>= </span><span>next</span><span>(enum)
</span><span>    </span><span>del </span><span>enum
</span><span>
</span><span>    </span><span>def </span><span>__init__</span><span>(</span><span>self</span><span>, </span><span>pos</span><span>, </span><span>yaw</span><span>, </span><span>pitch</span><span>, </span><span>time</span><span>, </span><span>waypointType</span><span>=</span><span>GENERATED</span><span>):
</span><span>        </span><span>self</span><span>.pos = pos
</span><span>        </span><span>self</span><span>.yaw = yaw
</span><span>        </span><span>self</span><span>.pitch = pitch
</span><span>        </span><span>self</span><span>.time = time
</span><span>        </span><span>self</span><span>.sent = </span><span>False
</span><span>        </span><span>self</span><span>.type = waypointType
</span><span>
</span><span>    </span><span>def </span><span>__repr__</span><span>(</span><span>self</span><span>):
</span><span>        </span><span>return </span><span>(&#39;</span><span>&lt;&lt; Waypoint pos:</span><span>{0}</span><span>, time:</span><span>{1}</span><span>, type:</span><span>{2}</span><span>, yaw:</span><span>{3}</span><span>, pitch: </span><span>{4}</span><span>&gt;&gt;</span><span>&#39;).</span><span>format</span><span>(</span><span>self</span><span>.pos, </span><span>self</span><span>.time, </span><span>self</span><span>.type, </span><span>self</span><span>.yaw, </span><span>self</span><span>.pitch)
</span><span>
</span><span>    </span><span>def </span><span>toDict</span><span>(</span><span>self</span><span>):
</span><span>        </span><span>return </span><span>{&#39;</span><span>position</span><span>&#39;: </span><span>Vector3</span><span>(</span><span>self</span><span>.pos), &#39;</span><span>yaw</span><span>&#39;: </span><span>self</span><span>.yaw, &#39;</span><span>pitch</span><span>&#39;: </span><span>int</span><span>(</span><span>normaliseAngle</span><span>(</span><span>self</span><span>.pitch, </span><span>False</span><span>) * </span><span>127 </span><span>/ math.pi), &#39;</span><span>time</span><span>&#39;: </span><span>int</span><span>(</span><span>self</span><span>.time * </span><span>1000</span><span>), &#39;</span><span>type</span><span>&#39;: </span><span>self</span><span>.type}
</span><span>
</span><span>    @</span><span>staticmethod
</span><span>    </span><span>def </span><span>fromDict</span><span>(</span><span>dict</span><span>):
</span><span>        </span><span>return </span><span>WayPoint</span><span>(</span><span>Vector3</span><span>(dict[&#39;</span><span>position</span><span>&#39;]), dict[&#39;</span><span>yaw</span><span>&#39;], dict[&#39;</span><span>pitch</span><span>&#39;] * math.pi / </span><span>127.0</span><span>, dict[&#39;</span><span>time</span><span>&#39;] / </span><span>1000.0</span><span>, dict[&#39;</span><span>type</span><span>&#39;])
</span><span>
</span><span>    @</span><span>staticmethod
</span><span>    </span><span>def </span><span>_splineReference</span><span>(</span><span>point1</span><span>, </span><span>point2</span><span>, </span><span>t</span><span>):
</span><span>        unknown_0 = point1.pos.</span><span>flatDistTo</span><span>(point2.pos)
</span><span>        </span><span>if </span><span>unknown_0 &gt; </span><span>0</span><span>:
</span><span>            unknown_1 = </span><span>1.0 </span><span>- t
</span><span>            unknown_2 = unknown_0 * </span><span>getDirectionFromYaw</span><span>(point1.yaw)
</span><span>            </span><span>1 </span><span>= unknown_0 * </span><span>getDirectionFromYaw</span><span>(point2.yaw)
</span><span>            unknown_3 = unknown_1 * unknown_1 * (</span><span>1.0 </span><span>+ </span><span>2.0 </span><span>* t) * point1.pos + t * t * (</span><span>1.0 </span><span>+ </span><span>2.0 </span><span>* unknown_1) * point2.pos + unknown_1 * unknown_1 * t * unknown_2 - unknown_1 * t * t * </span><span>1
</span><span>            unknown_4 = point1.pos.</span><span>flatDistTo</span><span>(unknown_3) / unknown_0
</span><span>            unknown_3.y = </span><span>lerp</span><span>(point1.pos.y, point2.pos.y, unknown_4)
</span><span>            unknown_5 = </span><span>lerpAngles</span><span>(point1.yaw, point2.yaw, t)
</span><span>            unknown_6 = </span><span>0.0
</span><span>        </span><span>else</span><span>:
</span><span>            unknown_3 = </span><span>lerp</span><span>(point1.pos, point2.pos, t)
</span><span>            unknown_5 = </span><span>lerpAngles</span><span>(point1.yaw, point2.yaw, t)
</span><span>            unknown_6 = </span><span>0.0
</span><span>        </span><span>return </span><span>(unknown_3, unknown_5, unknown_6)
</span><span>
</span><span>    </span><span>def </span><span>spline</span><span>(</span><span>point1</span><span>, </span><span>point2</span><span>, </span><span>t</span><span>):
</span><span>        </span><span>return </span><span>Lesta.</span><span>splineWayPoints</span><span>(point1.pos, point1.yaw, point1.pitch, point2.pos, point2.yaw, point2.pitch, t)
</span><span>
</span><span>    spline = _splineOptimised
</span><span>
</span><span>
</span><span>def </span><span>generateSquadronId</span><span>(</span><span>shipId</span><span>, </span><span>index</span><span>, </span><span>purpose</span><span>, </span><span>departureId</span><span>):
</span><span>    </span><span>&#34;&#34;&#34;
</span><span>        Generates id of the squadron based on the given arguments.
</span><span>        :param shipId: id of the owner
</span><span>        :type shipId: int
</span><span>        :param index: index of the squadron within the owner
</span><span>        :type index: int
</span><span>        :param purpose: the function that squadron is performing
</span><span>        :type purpose: int (AirplaneConstants.SquadronPurpose)
</span><span>        :param departureId: unique departure id of the squadron incremented with every subsequent id generation
</span><span>        :type departureId: int
</span><span>        :return id of the squadron
</span><span>        :rtype: int
</span><span>        &#34;&#34;&#34;
</span><span>    unknown_7 = departureId &lt;&lt; </span><span>SQUADRON_DEPARTURE_BIT </span><span>| purpose &lt;&lt; </span><span>SQUADRON_PURPOSE_BIT </span><span>| index + </span><span>1 </span><span>&lt;&lt; </span><span>SQUADRON_INDEX_BIT </span><span>| shipId
</span><span>    </span><span>assert </span><span>retrieveOwnerID</span><span>(unknown_7) == shipId
</span><span>    </span><span>assert </span><span>retrieveSquadronIndex</span><span>(unknown_7) == index
</span><span>    </span><span>assert </span><span>retrieveSquadronPurpose</span><span>(unknown_7) == purpose
</span><span>    </span><span>return </span><span>unknown_7
</span><span>
</span><span>
</span><span>def </span><span>retrieveSquadronIndex</span><span>(</span><span>squadronId</span><span>):
</span><span>    unknown_8 = </span><span>7
</span><span>    </span><span>return </span><span>(squadronId &gt;&gt; </span><span>SQUADRON_INDEX_BIT </span><span>&amp; unknown_8) - </span><span>1
</span><span>
</span><span>
</span><span>def </span><span>retrieveSquadronPurpose</span><span>(</span><span>squadronId</span><span>):
</span><span>    unknown_9 = </span><span>7
</span><span>    </span><span>return </span><span>squadronId &gt;&gt; </span><span>SQUADRON_PURPOSE_BIT </span><span>&amp; unknown_9
</span><span>
</span><span>
</span><span>def </span><span>retrieveSquadronDeparture</span><span>(</span><span>squadronId</span><span>):
</span><span>    unknown_10 = </span><span>7
</span><span>    </span><span>return </span><span>squadronId &gt;&gt; </span><span>SQUADRON_DEPARTURE_BIT </span><span>&amp; unknown_10
</span><span>
</span><span>
</span><span>def </span><span>parseSquadronId</span><span>(</span><span>squadronId</span><span>):
</span><span>    </span><span>return </span><span>(</span><span>retrieveSquadronIndex</span><span>(squadronId), </span><span>retrieveSquadronPurpose</span><span>(squadronId), </span><span>retrieveSquadronDeparture</span><span>(squadronId))
</span><span>
</span><span>
</span><span>def </span><span>retrieveOwnerID</span><span>(</span><span>id</span><span>):
</span><span>    </span><span>return </span><span>id </span><span>&amp; </span><span>4294967295</span><span>L
</span><span>
</span><span>
</span><span>def </span><span>getPlaneName</span><span>(</span><span>params</span><span>, </span><span>planeType</span><span>):
</span><span>    unknown_11 = PLANETYPE_2_PARAMSNAME.</span><span>get</span><span>(planeType)
</span><span>    </span><span>if </span><span>planeType:
</span><span>        </span><span>return </span><span>params.__dict__[unknown_11].planeType
</span><span>    </span><span>return </span><span>planeType
</span><span>
</span><span>
</span><span>def </span><span>getTorpedoingArea</span><span>--- </span><span>This code section failed</span><span>: ---
</span><span>                </span><span>0  </span><span>LOAD_GLOBAL           </span><span>0  </span><span>&#39;</span><span>getDirectionFromYaw</span><span>&#39;
</span><span>                </span><span>3  </span><span>LOAD_FAST             </span><span>1  </span><span>&#39;</span><span>attackDir</span><span>&#39;
</span><span>                </span><span>6  </span><span>LOAD_ATTR             </span><span>1  </span><span>&#39;</span><span>yaw</span><span>&#39;
</span><span>                </span><span>9  </span><span>LOAD_GLOBAL           </span><span>2  </span><span>&#39;</span><span>math</span><span>&#39;
</span><span>               </span><span>12  </span><span>LOAD_ATTR             </span><span>3  </span><span>&#39;</span><span>pi</span><span>&#39;
</span><span>               </span><span>15  </span><span>LOAD_CONST               </span><span>2
</span><span>               </span><span>18  </span><span>BINARY_DIVIDE    
</span><span>               </span><span>19  </span><span>BINARY_ADD
</span><span>               </span><span>20  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>               </span><span>23  </span><span>STORE_FAST            </span><span>6  </span><span>&#39;</span><span>unknown_14</span><span>&#39;
</span><span>               </span><span>26  </span><span>LOAD_GLOBAL           </span><span>4  </span><span>&#39;</span><span>min</span><span>&#39;
</span><span>               </span><span>29  </span><span>LOAD_CODE                </span><span>&lt;code_object </span><span>369464740902</span><span>&gt;
</span><span>               </span><span>32  </span><span>MAKE_FUNCTION_0       </span><span>0  None
</span><span>               </span><span>35  </span><span>LOAD_FAST             </span><span>4  </span><span>&#39;</span><span>formation</span><span>&#39;
</span><span>               </span><span>38  </span><span>LOAD_ATTR             </span><span>5  </span><span>&#39;</span><span>positions</span><span>&#39;
</span><span>               </span><span>41  </span><span>GET_ITER         
</span><span>               </span><span>42  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>               </span><span>45  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>               </span><span>48  </span><span>STORE_FAST            </span><span>7  </span><span>&#39;</span><span>unknown_15</span><span>&#39;
</span><span>               </span><span>51  </span><span>LOAD_GLOBAL           </span><span>6  </span><span>&#39;</span><span>max</span><span>&#39;
</span><span>               </span><span>54  </span><span>LOAD_CODE                </span><span>&lt;code_object </span><span>369537115186</span><span>&gt;
</span><span>               </span><span>57  </span><span>MAKE_FUNCTION_0       </span><span>0  None
</span><span>               </span><span>60  </span><span>LOAD_FAST             </span><span>4  </span><span>&#39;</span><span>formation</span><span>&#39;
</span><span>               </span><span>63  </span><span>LOAD_ATTR             </span><span>5  </span><span>&#39;</span><span>positions</span><span>&#39;
</span><span>               </span><span>66  </span><span>GET_ITER         
</span><span>               </span><span>67  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>               </span><span>70  </span><span>CALL_FUNCTION_1       </span><span>1  None
</span><span>               </span><span>73  </span><span>STORE_FAST            </span><span>8  </span><span>&#39;</span><span>unknown_16</span><span>&#39;
</span><span>               </span><span>76  </span><span>LOAD_FAST             </span><span>8  </span><span>&#39;</span><span>unknown_16</span><span>&#39;
</span><span>               </span><span>79  </span><span>LOAD_FAST             </span><span>7  </span><span>&#39;</span><span>unknown_15</span><span>&#39;
</span><span>               </span><span>82  </span><span>BINARY_SUBTRACT  
</span><span>               </span><span>83  </span><span>STORE_FAST            </span><span>9  </span><span>&#39;</span><span>unknown_17</span><span>&#39;
</span><span>               </span><span>86  </span><span>LOAD_FAST             </span><span>9  </span><span>&#39;</span><span>unknown_17</span><span>&#39;
</span><span>               </span><span>89  </span><span>LOAD_FAST             </span><span>5  </span><span>&#39;</span><span>currentPlaneCount</span><span>&#39;
</span><span>               </span><span>92  </span><span>BINARY_MULTIPLY  
</span><span>               </span><span>93  </span><span>LOAD_FAST             </span><span>4  </span><span>&#39;</span><span>formation</span><span>&#39;
</span><span>               </span><span>96  </span><span>LOAD_ATTR             </span><span>7  </span><span>&#39;</span><span>npositions</span><span>&#39;
</span><span>               </span><span>99  </span><span>BINARY_DIVIDE    
</span><span>              </span><span>100  </span><span>STORE_FAST           </span><span>10  </span><span>&#39;</span><span>unknown_18</span><span>&#39;
</span><span>              </span><span>103  </span><span>LOAD_FAST             </span><span>0  </span><span>&#39;</span><span>attackPoint</span><span>&#39;
</span><span>              </span><span>106  </span><span>LOAD_FAST            </span><span>10  </span><span>&#39;</span><span>unknown_18</span><span>&#39;
</span><span>              </span><span>109  </span><span>LOAD_CONST               </span><span>2
</span><span>              </span><span>112  </span><span>BINARY_DIVIDE    
</span><span>              </span><span>113  </span><span>LOAD_GLOBAL           </span><span>8  </span><span>&#39;</span><span>PLANE_TORPEDO_CONE_HALF_WIDTH</span><span>&#39;
</span><span>              </span><span>116  </span><span>BINARY_SUBTRACT  
</span><span>              </span><span>117  </span><span>LOAD_FAST             </span><span>6  </span><span>&#39;</span><span>unknown_14</span><span>&#39;
</span><span>              </span><span>120  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>121  </span><span>BINARY_SUBTRACT  
</span><span>              </span><span>122  </span><span>STORE_FAST           </span><span>11  </span><span>&#39;</span><span>unknown_19</span><span>&#39;
</span><span>              </span><span>125  </span><span>LOAD_FAST             </span><span>0  </span><span>&#39;</span><span>attackPoint</span><span>&#39;
</span><span>              </span><span>128  </span><span>LOAD_FAST            </span><span>10  </span><span>&#39;</span><span>unknown_18</span><span>&#39;
</span><span>              </span><span>131  </span><span>LOAD_CONST               </span><span>2
</span><span>              </span><span>134  </span><span>BINARY_DIVIDE    
</span><span>              </span><span>135  </span><span>LOAD_GLOBAL           </span><span>8  </span><span>&#39;</span><span>PLANE_TORPEDO_CONE_HALF_WIDTH</span><span>&#39;
</span><span>              </span><span>138  </span><span>BINARY_ADD       
</span><span>              </span><span>139  </span><span>LOAD_FAST             </span><span>6  </span><span>&#39;</span><span>unknown_14</span><span>&#39;
</span><span>              </span><span>142  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>143  </span><span>BINARY_ADD       
</span><span>              </span><span>144  </span><span>STORE_FAST           </span><span>12  </span><span>&#39;</span><span>unknown_20</span><span>&#39;
</span><span>              </span><span>147  </span><span>LOAD_FAST            </span><span>11  </span><span>&#39;</span><span>unknown_19</span><span>&#39;
</span><span>              </span><span>150  </span><span>LOAD_FAST            </span><span>12  </span><span>&#39;</span><span>unknown_20</span><span>&#39;
</span><span>              </span><span>153  </span><span>COMPARE_OP            </span><span>2  </span><span>==
</span><span>              </span><span>156  </span><span>POP_JUMP_IF_FALSE   </span><span>176  </span><span>&#39;</span><span>to 176</span><span>&#39;
</span><span>              </span><span>159  </span><span>LOAD_FAST            </span><span>12  </span><span>&#39;</span><span>unknown_20</span><span>&#39;
</span><span>              </span><span>162  </span><span>LOAD_FAST             </span><span>6  </span><span>&#39;</span><span>unknown_14</span><span>&#39;
</span><span>              </span><span>165  </span><span>LOAD_CONST               </span><span>0.001
</span><span>              </span><span>168  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>169  </span><span>INPLACE_ADD      
</span><span>              </span><span>170  </span><span>STORE_FAST           </span><span>12  </span><span>&#39;</span><span>unknown_20</span><span>&#39;
</span><span>              </span><span>173  </span><span>JUMP_FORWARD          </span><span>0  </span><span>&#39;</span><span>to 176</span><span>&#39;
</span><span>            </span><span>176_0  </span><span>COME_FROM           </span><span>173  </span><span>&#39;</span><span>173</span><span>&#39;
</span><span>              </span><span>176  </span><span>LOAD_FAST             </span><span>0  </span><span>&#39;</span><span>attackPoint</span><span>&#39;
</span><span>              </span><span>179  </span><span>LOAD_FAST             </span><span>1  </span><span>&#39;</span><span>attackDir</span><span>&#39;
</span><span>              </span><span>182  </span><span>LOAD_FAST             </span><span>2  </span><span>&#39;</span><span>planeParams</span><span>&#39;
</span><span>              </span><span>185  </span><span>LOAD_ATTR             </span><span>9  </span><span>&#39;</span><span>torpedoAimDist</span><span>&#39;
</span><span>              </span><span>188  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>189  </span><span>BINARY_ADD       
</span><span>              </span><span>190  </span><span>STORE_FAST           </span><span>13  </span><span>&#39;</span><span>unknown_21</span><span>&#39;
</span><span>              </span><span>193  </span><span>LOAD_FAST            </span><span>13  </span><span>&#39;</span><span>unknown_21</span><span>&#39;
</span><span>              </span><span>196  </span><span>LOAD_FAST             </span><span>6  </span><span>&#39;</span><span>unknown_14</span><span>&#39;
</span><span>              </span><span>199  </span><span>LOAD_FAST             </span><span>3  </span><span>&#39;</span><span>spreading</span><span>&#39;
</span><span>              </span><span>202  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>203  </span><span>LOAD_CONST               </span><span>0.5
</span><span>              </span><span>206  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>207  </span><span>BINARY_SUBTRACT  
</span><span>              </span><span>208  </span><span>STORE_FAST           </span><span>14  </span><span>&#39;</span><span>unknown_22</span><span>&#39;
</span><span>              </span><span>211  </span><span>LOAD_FAST            </span><span>13  </span><span>&#39;</span><span>unknown_21</span><span>&#39;
</span><span>              </span><span>214  </span><span>LOAD_FAST             </span><span>6  </span><span>&#39;</span><span>unknown_14</span><span>&#39;
</span><span>              </span><span>217  </span><span>LOAD_FAST             </span><span>3  </span><span>&#39;</span><span>spreading</span><span>&#39;
</span><span>              </span><span>220  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>221  </span><span>LOAD_CONST               </span><span>0.5
</span><span>              </span><span>224  </span><span>BINARY_MULTIPLY  
</span><span>              </span><span>225  </span><span>BINARY_ADD       
</span><span>              </span><span>226  </span><span>STORE_FAST           </span><span>15  </span><span>&#39;</span><span>unknown_23</span><span>&#39;
</span><span>              </span><span>229  </span><span>LOAD_FAST            </span><span>11  </span><span>&#39;</span><span>unknown_19</span><span>&#39;
</span><span>              </span><span>232  </span><span>LOAD_FAST            </span><span>12  </span><span>&#39;</span><span>unknown_20</span><span>&#39;
</span><span>              </span><span>235  </span><span>LOAD_FAST            </span><span>14  </span><span>&#39;</span><span>unknown_22</span><span>&#39;
</span><span>              </span><span>238  </span><span>LOAD_FAST            </span><span>15  </span><span>&#39;</span><span>unknown_23</span><span>&#39;
</span><span>              </span><span>241  </span><span>BUILD_TUPLE_4         </span><span>4 
</span><span>              </span><span>244  </span><span>RETURN_VALUE     
</span><span>               -</span><span>1  </span><span>RETURN_LAST      
</span><span>
</span><span>Parse error at or near `</span><span>None</span><span>&#39;</span><span> instruction at offset -1</span><span>
</span><span>
</span><span>
</span><span>def </span><span>getBombingZone</span><span>(</span><span>planeParams</span><span>, </span><span>modifierParams</span><span>, </span><span>aimAccuracy</span><span>, </span><span>attackerStrength</span><span>=</span><span>1.0</span><span>):
</span><span>    unknown_24 = planeParams.maxSpread
</span><span>    unknown_25 = planeParams.minSpread
</span><span>    unknown_26 = </span><span>lerp</span><span>(unknown_24[</span><span>0</span><span>], unknown_25[</span><span>0</span><span>], aimAccuracy) * modifierParams.planeSpreadMultiplier
</span><span>    unknown_27 = </span><span>lerp</span><span>(unknown_24[</span><span>1</span><span>], unknown_25[</span><span>1</span><span>], aimAccuracy) * modifierParams.planeSpreadMultiplier
</span><span>    </span><span>0 </span><span>= planeParams.outerSalvoSize[</span><span>0</span><span>] * unknown_26 * attackerStrength
</span><span>    unknown_28 = planeParams.outerSalvoSize[</span><span>1</span><span>] * unknown_27
</span><span>    unknown_29 = planeParams.innerSalvoSize[</span><span>0</span><span>] * unknown_26 * attackerStrength
</span><span>    unknown_30 = planeParams.innerSalvoSize[</span><span>1</span><span>] * unknown_27
</span><span>    </span><span>return </span><span>(</span><span>0</span><span>, unknown_28, unknown_29, unknown_30)
</span><span>
</span><span>
</span><span># snip
</span></code></pre>
<p>Clearly some functions still fail to decompile, but it may be enough to just read the instructions at this point to understand the intent.</p>
<p>And code objects that go from this:</p>
<a href="https://landaire.net/img/wows-obfuscation/simple_obfuscation_example.svg"><img src="https://landaire.net/img/wows-obfuscation/simple_obfuscation_example.svg" width="500" height="500"/></a>
<p>To this:</p>
<a href="https://landaire.net/img/wows-obfuscation/simple_deobfuscation_example.svg"><img src="https://landaire.net/img/wows-obfuscation/simple_deobfuscation_example.svg" width="500" height="500"/></a><h2 id="closing-thoughts">Closing Thoughts</h2>
<p>There&#39;s one common theme in this post that I hope some readers picked up on: we are constantly battling the <em>decompiler&#39;s</em> ability to unravel code based off of heuristics instead of battling the obfuscator injecting garbage. The const predicates for example aren&#39;t even that big of a deal -- they just insert false control flow that at a <em>source</em> level is fairly straightforward to see is garbage.</p>
<p>However, this false control flow is enough to throw off the decompiler&#39;s ability to figure out a <em>single</em> source code pattern that results in the entire code object failing to decompile. This isn&#39;t a jab at <code>uncompyle</code> either -- it&#39;s a great tool that works fairly well considering there&#39;s zero competition in this space. However, I think that if I were to solve this problem from scratch in 2023 I&#39;d solve it very differently by working on a better decompiler that erodes away mapping of 1:1 source code to bytecode, and instead focuses on rebuilding source with the same functional semantics.</p>
<p>As reverse engineers we don&#39;t really care about how the code was originally written, we just want to understand its intent at a higher level.</p>
<h2 id="thanks">Thanks</h2>
<p>Thank you, reader, for making it this far. I&#39;d like to extend thanks to the following people for their support in this research/providing deobfuscator feedback:</p>
<ul>
<li>lpcvoid (without his initial blog post I wouldn&#39;t have been nearly as motivated to go down this endeavour)</li>
<li>Track</li>
<li>TTaro</li>
<li>901234</li>
<li>notyourfather</li>
<li>gabe_k</li>
<li>Scout1Treia</li>
<li>EdibleBug</li>
</ul>

</div></div>
  </body>
</html>
