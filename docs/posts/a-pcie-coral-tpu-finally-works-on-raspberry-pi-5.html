<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jeffgeerling.com/blog/2023/pcie-coral-tpu-finally-works-on-raspberry-pi-5">Original</a>
    <h1>A PCIe Coral TPU Finally Works on Raspberry Pi 5</h1>
    
    <div id="readability-page-1" class="page"><div><p><a href="https://coral.ai/products/">Coral.ai TPUs</a> are AI accelerators used for tasks like machine vision and audio processing. Raspberry Pis are often integrated into small robotics and IoT products—or used to analyze live video feeds with <a href="https://frigate.video">Frigate</a>.</p>

<p>Until today, nobody I know of has been able to get a PCI Express Coral TPU working on the Raspberry Pi. The Compute Module 4, unfortunately, had some quirks in its PCIe implementation, preventing the use of the Coral over PCIe.</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/google-coral-tpu-pcie-raspberry-pi-5.jpg" width="700" height="auto" alt="Google Coral TPU running over PCIe on Raspberry Pi 5"/></p>

<p>The Raspberry Pi 5 has a much improved PCIe bus—capable of reaching Gen 3 speeds even!—and I&#39;ve already tested the <a href="https://www.youtube.com/watch?v=EXWu4SUsaY8">first PCIe NVMe HATs for Pi 5</a>.</p>

<p>So can the Pi 5 handle the Coral TPU natively over PCIe?</p>

<p><em>Yes</em>. Though currently, you need to tweak a few things to get it working.</p>

<h2>PCIe bringup for Coral TPU on Pi 5</h2>

<p>Buckle up, to get the TPU working, we are going to need to overcome some hurdles:</p>

<ul>
<li>Coral&#39;s drivers only work on 4K page size, so we need to switch from the default Pi kernel</li>
<li>The Coral is a bit picky with PCIe timings, so (for now at least) we need to disable <a href="https://wiki.archlinux.org/title/Power_management#Active_State_Power_Management">PCIe ASPM</a></li>
<li>The Pi&#39;s default device tree sets up the PCIe bus to not have enough MSI-X interrupts, so we need to change it</li>
<li>Pi OS 12 &#39;Bookworm&#39; ships with Python 3.11, but Coral&#39;s PyCoral library only runs on 3.9, so we need to run inside Docker (or install an alternate system-wide Python version)</li>
<li>There&#39;s no A+E key adapter/HAT for the Raspberry Pi (yet), so we need a hardware interface to plug the Coral TPU into the Pi 5&#39;s PCIe header</li>
</ul>

<h3>Pi Config Changes</h3>

<p>Some of the changes required to get the Coral working are pretty easy—changing some configuration and rebooting.</p>

<p>First, to switch from the default 16k page size to 4k pages (confirm which kernel you&#39;re running with <code>uname -a</code>), you can add the line <code>kernel=kernel8.img</code> to the bottom of your <code>/boot/config.txt</code> file.</p>

<p>Then, to enable the external PCI Express connector, add the following two lines to the same file (again, at the bottom):</p>

<pre><code>dtparam=pciex1
dtparam=pciex1_gen=2
</code></pre>

<p>Note that I tested with Gen 1, 2, and 3—the TPU was functional at all three speeds, but I had a few link errors (that did not cause any noticeable problems) at Gen 3 with my own setup.</p>

<p>The final configuration change is disabling ASPM for PCI Express devices—this might not be <em>absolutely</em> necessary, but it does clear up some noisy link error correction messages in the system logs.</p>

<p>Edit <code>/boot/cmdline.txt</code> and in the configuration line, add in <code>pcie_aspm=off</code> somewhere (I added it prior to <code>rootwait</code>.</p>

<p>Save that file and the config.txt changes and reboot, and you can confirm the kernel was switched by running <code>uname -a</code>:</p>

<pre><code>pi@pi5:~ $ uname -a
Linux pi5 6.1.0-rpi4-rpi-v8 #1 SMP PREEMPT Debian 1:6.1.54-1+rpt2 (2023-10-05) aarch64 GNU/Linux
</code></pre>

<p>Yours will look a little different, but the key there is to see the <code>-v8</code> at the end of the kernel version string.</p>

<h3>Device Tree Change</h3>

<p>This next bit is slightly more complicated, as most Raspberry Pi owners don&#39;t mess around with Device Trees (the little files that describe the hardware to Linux), but it&#39;s not so bad.</p>

<p>In fact, I have a guide for the process on this very blog: <a href="https://www.jeffgeerling.com/blog/2023/how-customize-dtb-device-tree-overlay-on-raspberry-pi">How to customize the dtb (device tree overlay) on the Raspberry Pi</a>.</p>

<p>In fact, the exact steps for modifying the PCIe bus to use the correct <code>msi-parent</code> value is shown in that blog post—so follow it to make the correct change.</p>

<p>Why switch the value? See <a href="https://forums.raspberrypi.com/viewtopic.php?p=2157674#p2157674">this post from jdb on the Pi forums</a>.</p>

<h3>Python 3.9 inside Docker</h3>

<p>The last step—assuming you have the hardware to connect up a PCIe Coral TPU to the Pi 5&#39;s PCIe connector (more on that later)—is to install Docker and run the PyCoral library inside a Debian 10 Docker container, which is much quicker and easier than trying to get PyCoral installed on the system Python on Debian 12.</p>

<p>And wouldn&#39;t you know? I have a guide for how to do <em>exactly that</em> elsewhere on this blog: <a href="https://www.jeffgeerling.com/blog/2023/testing-coral-tpu-accelerator-m2-or-pcie-docker">Testing the Coral TPU Accelerator (M.2 or PCIe) in Docker</a></p>

<p>Follow the <a href="https://github.com/google-coral/pycoral/issues/85">Python 3.10 and 3.11 support</a> issue on the PyCoral GitHub for any updates about getting it installed on the version of Python that ships with the latest Pi OS.</p>

<h3>Physically Plugging in a Coral TPU to the Raspberry Pi 5</h3>

<p>Right now, unfortunately, there are no commercially-available Pi 5 HATs or adapter boards that go from the proprietary PCIe FFC connector on the Raspberry Pi 5 to either a standard PCIe slot, or to an A+E key M.2 connector.</p>

<p>I am certain both of those will exist at some point (hopefully soon!), but for now, your best bet is to order a <a href="https://pineberrypi.com/products/hat-top-2230-2240-for-rpi5">HatDrive! Top or Bottom</a> from Pineberry Pi and then order a PCIe M.2 M-key to A+E key adapter. Or use the Coral B+M key module with the &#39;Bottom&#39; version (since it&#39;s 2280-size, and won&#39;t fit in the &#39;Top&#39; HAT).</p>

<p>For my own testing, I&#39;ve been using a prototype board that Mirkotronics / Pineberry Pi sent called &#39;uPCity&#39;. I am hoping they can sell a version of that board at some point, because it is extremely fun to mess around with <a href="https://pipci.jeffgeerling.com">so many different PCI Express devices</a> on the Raspberry Pi 5!</p>

<h2>Conclusion</h2>

<p>Once everything is wired up, and you <a href="https://coral.ai/docs/m2/get-started">install the <code>apex</code> PCIe driver</a>—and can see <code>/dev/apex_0</code>—you could run an image classification example inside the edgetpu examples repo. Give it an image of this bird:</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/edgetpu-bird.jpg" width="512" height="auto" alt="Coral Edge TPU Example Bird image"/></p>

<p>And then it should spit out:</p>

<pre><code>root@7bb44c28f378:~# python3 /usr/share/edgetpu/examples/classify_image.py --model /usr/share/edgetpu/examples/models/mobilenet_v2_1.0_224_inat_bird_quant_edgetpu.tflite --label /usr/share/edgetpu/examples/models/inat_bird_labels.txt --image /usr/share/edgetpu/examples/images/bird.bmp
---------------------------
Poecile atricapillus (Black-capped Chickadee)
Score :  0.44140625
---------------------------
Poecile carolinensis (Carolina Chickadee)
Score :  0.29296875
</code></pre></div></div>
  </body>
</html>
