<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.silentsignal.eu/2022/09/28/another-tale-of-ibm-i-as-400-hacking/">Original</a>
    <h1>Another Tale of IBM I (AS/400) Hacking (2022)</h1>
    
    <div id="readability-page-1" class="page"><div>
      
<p>Our next journey takes us into the infrastructure of a bank. One element of the infrastructure was an IBM i (AS/400) server, and the only piece of information we got to conduct the penetration test was its IP address. We had been collecting a list of common application and service users during previous pentests, so we could check their existence on this host using 5250 and POP3 protocols. By the way, the server exposed 63 remote services – are all of them really necessary? Our first step may seem ridiculous, but it works most of the time in IBM i Land: “does the username equal the password?”. We had discovered one account with Hydra, let’s call it <strong>AKELA</strong>. The user’s initial menu was *SIGNOFF, meaning that in theory, the only action the user could perform after login was to log out. Setting initial program or menu on the signon screen was not possible because of limitations we will discuss later.</p>



<p>The previous blog <a href="https://blog.silentsignal.eu/2022/09/05/simple-ibm-i-as-400-hacking/">post</a> described the ATTN key technique to get command line, which worked in this case too, because setting the initial menu to *SIGNOFF doesn’t <em>really</em> perform a logout, just displays a screen with no functionality to use, but ATTN still works as usual. A minor change had to be made to the previously described procedure: we had to select the menu number 2 (“Work with jobs”) as getting a command line with F9 was not allowed, because of the restrictions on the user profile we will discuss shortly:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1.png"><img loading="lazy" width="1024" height="632" src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1-1024x632.png" alt="" srcset="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1-1024x632.png 1024w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1-300x185.png 300w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1-768x474.png 768w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1-1536x947.png 1536w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep1-2048x1263.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Menu displayed on ATTN</figcaption></figure></div>



<p>The next screen shows that the upcoming “Work with user jobs” display allows providing additional parameters to selected options. For example, if we wanted to end a job <a rel="noreferrer noopener" href="https://www.ibm.com/support/pages/difference-between-endsbs-pwrdwnsys-option-immed-versus-cntrld" target="_blank">immediately</a>, we could type OPTION(*IMMED) as a parameter after typing 4 next to the target job. Conveniently, the same input allows issuing arbitrary commands too. At this point we had command line access, but immediately realized the user is “limited” and we could not run CL commands with 5250:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2.png"><img loading="lazy" width="1024" height="641" src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2-1024x641.png" alt="" srcset="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2-1024x641.png 1024w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2-300x188.png 300w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2-768x481.png 768w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2-1536x961.png 1536w, https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep2-2048x1281.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></a><figcaption>Restricted command execution</figcaption></figure></div>



<p>The above error is a typical symptom of the Limited capabilities (LMTCPB) setting being enabled in the current user profile. According to the <a rel="noopener" href="https://www.ibm.com/support/pages/restricting-users-using-command-line" target="_blank">documentation</a>, with Limited capabilities, only programs with the parameter “Allow Limited User” set to *YES can be executed. This configuration is common in IBM i environments: users who work with 5250 are set up with a single predefined application and can use only the menu-based functions of this application. This restriction is the reason initial program or menu couldn’t be specified, and F9 did not provide a command line.</p>



<p>Setting the user profile “to limited” is the recommended way to <a rel="noreferrer noopener" href="https://www.ibm.com/support/pages/restricting-users-using-command-line" target="_blank">restrict users from using the command line</a>, so this must be secure, right? WRONG. The limited user profile setting only applies to some protocols, like 5250 and FTP:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep3-1024x179.png"><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep3-1024x179.png" alt="asdf"/></a><figcaption>Limited users can’t execute commands over FTP</figcaption></figure></div>



<p>This is when the high number of exposed ports came handy. IBM i exposes the <a rel="noreferrer noopener" href="https://www.ibm.com/docs/en/i/7.1?topic=iawca-i-access-windows-remote-commanddistributed-program-call-apis" target="_blank">Remote Command API</a> over port 8475 to allow <a rel="noreferrer noopener" href="https://www.ibm.com/docs/en/i/7.1?topic=iawrcpca-example-using-remote-i-access-windows-commanddistributed-program-call-apis" target="_blank">programmatic access</a> (not requiring terminal emulation) to system commands from regular PCs over the network. We can use this protocol to run CL commands to overcome the limitations of the 5250. A drawback of this protocol is that the API implementation only informs you of the success/fail result, but you can’t access the command output. We wanted interactive command execution, and taking the VPN connection we used to access the system into account (no connect back allowed by the firewall), we decided to use a bind shell. Every IBM i has Java installed that we can use to create a simple app to attach a shell to port 4444.</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep4-1024x1010.png"><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep4-1024x1010.png" alt=""/></a><figcaption>Bind shell on PASE</figcaption></figure></div>



<p>This shell provides access to the UNIX subsystem of IBM i called <a rel="noreferrer noopener" href="https://www.ibm.com/docs/en/i/7.3?topic=programming-pase-i" target="_blank">PASE</a>. At this point we have at least two options to inspect the security of the system in more detail: first, the “<strong>system</strong>” shell command can be used to run CL commands from PASE:</p>



<div><figure><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep5-1024x940.png" alt=""/><figcaption>CL command execution from PASE</figcaption></figure></div>



<p>The second option, the SQL interface allows accessing system configuration in bulk, and with complex filtering, ideal for hunting for misconfigurations. The usual “<strong>db2</strong>” shell command can be used to execute arbitrary SQL queries. The database service (port 8471) that can be used to run arbitrary SQL queries was protected by an exit program, therefore we used this technique. The following SQL query could be used to enumerate the system users with <strong>*ALLOBJ</strong> special authorities:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep6-1024x544.png"><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep6-1024x544.png" alt=""/></a><figcaption>Accessing the IBM i database from PASE and listing privileged user profiles</figcaption></figure></div>



<p>We can also check, whether we can *USE other profiles – the following screenshot summarizes the result:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep7-1024x238.png"><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep7-1024x238.png" alt=""/></a><figcaption>Accessing the IBM i database from PASE and listing user profiles that can be impersonated</figcaption></figure></div>



<p>If there is a match between the two SQL results we win. In our case, the current <strong>AKELA</strong> user was able to switch to an *ALLOBJ profile that we shall call <strong>ROB</strong>. Due to the customer request, we had to demonstrate that we had unlimited access to the system, without adding new users to the system. We decided to modify the Limited capabilities profile setting of our <strong>AKELA</strong> profile from *YES to *NO, took a screenshot for the report and switched back. We used our IBM i pentest tool to perform the profile switching described in the previous blog post:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep8-1024x72.png"><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep8-1024x72.png" alt=""/></a><figcaption>Executing privileged commands</figcaption></figure></div>



<p>This worked as expected, we reached our goal:</p>



<div><figure><a href="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep9-1024x994.png"><img src="https://blog.silentsignal.eu/wp-content/uploads/2022/09/kep9-1024x994.png" alt=""/></a><figcaption>Modified user profile as evidence of high privileges</figcaption></figure></div>



<h2>Summary</h2>



<p>The restrictions bypassed in this blog post are mostly part of “menu security”. This concept is based on the old assumption that restrictions on the presentation layer (the menu-based UI displayed on a 5250 terminal) is sufficient for access control. This may have been true for some time, but as functionality grew, and network services came into play, the significance of this control diminished. Of course, IBM recognized this too, but the relevant documentation is either <a rel="noreferrer noopener" href="https://www.ibm.com/support/pages/restricting-users-using-command-line" target="_blank">vague</a>, or just <a rel="noreferrer noopener" href="https://www.ibm.com/docs/en/i/7.2?topic=security-limitations-menu-access-control" target="_blank">casually mentions</a> the known gaps of security controls that are commonly used as primary defenses. </p>



<p>We also saw another example of misconfigured user profiles that can be exploited for privilege escalation through profile swapping. It’s worth noting that this system was operated by a different team than the one discussed in our previous post, demonstrating the prevalence of such configurations. </p>



<p>We must work hard to get these problems that are carried over from legacy environments out of the way, so we can see what IBM i really has to offer when it comes to security.</p>








<!-- Simple Share Buttons Adder (7.5.19) simplesharebuttons.com -->    </div></div>
  </body>
</html>
