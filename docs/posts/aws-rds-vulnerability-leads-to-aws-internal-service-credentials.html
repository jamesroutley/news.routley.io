<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.lightspin.io/aws-rds-critical-security-vulnerability">Original</a>
    <h1>AWS RDS Vulnerability Leads to AWS Internal Service Credentials</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>
<div data-widget-type="custom_widget" data-x="0" data-w="12">
<div id="hs_cos_wrapper_module_1612622305188490" data-hs-cos-general-type="widget" data-hs-cos-type="module">


<div id="m-0fff5bca378dd0d69f7599cd48aaeabd">
  <section>
    
    <header>
      
      
      

      
    </header>
    
    <p><span id="hs_cos_wrapper_post_body" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><h2>TL; DR</h2>
<p><span>Lightspin&#39;s Research Team obtained credentials to an internal AWS service by exploiting a local file read vulnerability on the RDS EC2 instance using the log_fdw extension. The internal AWS service was connected to AWS internal account, related to the RDS service.</span></p>
<p><span>The vulnerability was reported to AWS Security team, who right after applied an initial patch limited only to the recent RDS and Aurora PostgreSQL engines, excluding older versions. </span></p>
<p><span>Following the patch, the RDS team has personally reached out to every customer that used a vulnerable version in the last months and guided them through the upgrade process to ensure mitigation. Recently, the AWS team has confirmed that the vulnerability has been fixed and that no customers were affected.</span></p>
<p><span>You are probably already familiar with what Amazon RDS is. But just in a few words, Amazon Relational Database Service (RDS) is a managed database service that supports several different database engines such as MariaDB, MySQL, and the subject of this post: PostgreSQL. AWS also maintains their own database engine, Amazon Aurora, which has compatibility with PostgreSQL and MySQL.</span></p>
<!--more-->
<h2>Exploration</h2>
<p><span>I created an Amazon RDS database instance using the Amazon Aurora PostgreSQL engine and connected to the database using psql. I began with some basic exploration of the databases and pre-loaded roles.</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=626&amp;name=rds1.png" alt="rds1" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=313&amp;name=rds1.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=626&amp;name=rds1.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=939&amp;name=rds1.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=1252&amp;name=rds1.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=1565&amp;name=rds1.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds1.png?width=1878&amp;name=rds1.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=626&amp;name=rds2.png" alt="rds2" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=313&amp;name=rds2.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=626&amp;name=rds2.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=939&amp;name=rds2.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=1252&amp;name=rds2.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=1565&amp;name=rds2.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds2.png?width=1878&amp;name=rds2.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><span>Note that the ‚Äúpostgres‚Äù user is not a real superuser, it is a <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.html#Appendix.PostgreSQL.CommonDBATasks.Roles">rds_superuser</a>.</span></p>
<p><span>AWS documentation describes the role as ‚ÄúThe¬†<em>rds_superuser</em>¬†role is a predefined Amazon RDS role similar to the PostgreSQL superuser role (customarily named¬†postgres¬†in local instances), but with some restrictions.‚Äù</span></p>
<p><span>Obviously this <em>rds_superuser</em> cannot run system commands, read local files or do any action related to the underline machine. Otherwise, it was too easy </span>üòâ</p>
<p><span>Below is a screenshot detailing failed actions taken while attempting to use the <em>rds_superuser</em> role.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=626&amp;name=rds3.png" alt="rds3" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=313&amp;name=rds3.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=626&amp;name=rds3.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=939&amp;name=rds3.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=1252&amp;name=rds3.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=1565&amp;name=rds3.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds3.png?width=1878&amp;name=rds3.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span>So, I thought about using an untrusted language to create a function that can execute system commands, but I couldn‚Äôt load untrusted languages such as <a href="https://www.postgresql.org/docs/8.1/plperl-trusted.html"><em>plperlu</em></a> or <a href="https://www.postgresql.org/docs/9.1/plpython.html"><em>plpythonu</em></a>.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=626&amp;name=rds4.png" alt="rds4" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=313&amp;name=rds4.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=626&amp;name=rds4.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=939&amp;name=rds4.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=1252&amp;name=rds4.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=1565&amp;name=rds4.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds4.png?width=1878&amp;name=rds4.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=626&amp;name=img23.png" alt="img23" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=313&amp;name=img23.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=626&amp;name=img23.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=939&amp;name=img23.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=1252&amp;name=img23.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=1565&amp;name=img23.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/img23.png?width=1878&amp;name=img23.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span>The returned error suggested having a look at the <em>rds.extensions</em> configuration parameter.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=626&amp;name=rds5.png" alt="rds5" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=313&amp;name=rds5.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=626&amp;name=rds5.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=939&amp;name=rds5.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=1252&amp;name=rds5.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=1565&amp;name=rds5.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds5.png?width=1878&amp;name=rds5.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span>While many language extensions are supported by Amazon RDS for PostgreSQL engines, none of them were an untrusted language. Therefore, I decided to do some further analysis and research on the extensions hoping to find a lead.</span></p>
<h2><span>The log_fdw Extension</span></h2>
<p><span>The <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#CHAP_PostgreSQL.Extensions.log_fdw">log_fdw</a> extension is supported by Amazon RDS for PostgreSQL engines of versions 9.6.2 and higher. This extension enables the user to access the database engine log using a SQL interface and build foreign tables with the logs data neatly split into several columns.</span></p>
<p><span>I followed the documentation and created the foreign server and table.</span></p>
<p><span>1. Get the log_fdw extension and create the log server as a foreign data wrapper.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=626&amp;name=rds6.png" alt="rds6" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=313&amp;name=rds6.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=626&amp;name=rds6.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=939&amp;name=rds6.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=1252&amp;name=rds6.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=1565&amp;name=rds6.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds6.png?width=1878&amp;name=rds6.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p>2. Select a log file, create a table and read its content.</p>
<p><span>SELECT create_foreign_table_for_log_file(‚Äòmy_postgres_error_log‚Äô, ‚Äòlog_server‚Äô, ‚Äòpostgresql.log‚Äô);</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=626&amp;name=rds7.png" alt="rds7" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=313&amp;name=rds7.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=626&amp;name=rds7.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=939&amp;name=rds7.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=1252&amp;name=rds7.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=1565&amp;name=rds7.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds7.png?width=1878&amp;name=rds7.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><span>The first thing that comes to mind is to attempt a path traversal. The screenshots below show the attempt at it.</span><span>SELECT create_foreign_table_for_log_file(‚Äòmy_postgres_error_log‚Äô, ‚Äòlog_server‚Äô, ‚Äò../../../../../etc/passwd‚Äô);</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=1436&amp;name=rds8.png" alt="rds8" width="1436" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=718&amp;name=rds8.png 718w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=1436&amp;name=rds8.png 1436w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=2154&amp;name=rds8.png 2154w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=2872&amp;name=rds8.png 2872w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=3590&amp;name=rds8.png 3590w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds8.png?width=4308&amp;name=rds8.png 4308w" sizes="(max-width: 1436px) 100vw, 1436px"/></p>
<p><span>Upon executing the command, I received the following exception: ‚ÄúError: The log file path specified was invalid.‚Äù</span></p>
<p><span>SELECT create_foreign_table_for_log_file(‚Äòmy_postgres_error_log‚Äô, ‚Äòlog_server‚Äô, ‚Äò./postgresql.log‚Äô);</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=626&amp;name=rds9.png" alt="rds9" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=313&amp;name=rds9.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=626&amp;name=rds9.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=939&amp;name=rds9.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=1252&amp;name=rds9.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=1565&amp;name=rds9.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds9.png?width=1878&amp;name=rds9.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=1436&amp;name=rds10.png" alt="rds10" width="1436" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=718&amp;name=rds10.png 718w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=1436&amp;name=rds10.png 1436w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=2154&amp;name=rds10.png 2154w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=2872&amp;name=rds10.png 2872w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=3590&amp;name=rds10.png 3590w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds10.png?width=4308&amp;name=rds10.png 4308w" sizes="(max-width: 1436px) 100vw, 1436px"/></p>
<p><span>It is clearly a validation function.</span></p>
<h2><span>Understanding PostgreSQL Foreign Data</span></h2>
<p><span>PostgreSQL allows access to data that resides outside of PostgreSQL using regular SQL queries. Such data is referred to as <em>foreign data</em> and is accessed with help from a <em>foreign data wrapper</em>. A foreign data wrapper is a library (usually written in C) that can communicate with an external data source, such as a file, and can obtain data from it.</span></p>
<p><span>The author of a foreign data wrapper needs to implement 2 functions:</span></p>
<ol>
<li><strong><span>handler function</span></strong><span> ‚Äì triggers the action of fetching the external data</span></li>
<li><strong><span>validator function</span></strong><span> (optional) ‚Äì responsible for validating options given to the foreign data wrapper, as well as options for the foreign server and foreign tables</span></li>
</ol>
<p><span>Once the functions are created, the user can create a foreign data wrapper.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=435&amp;name=rds11.png" alt="rds11" width="435" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=218&amp;name=rds11.png 218w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=435&amp;name=rds11.png 435w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=653&amp;name=rds11.png 653w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=870&amp;name=rds11.png 870w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=1088&amp;name=rds11.png 1088w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds11.png?width=1305&amp;name=rds11.png 1305w" sizes="(max-width: 435px) 100vw, 435px"/></span></p>
<p><span>The user also needs to create a <em>foreign server</em>, which defines how to connect to a particular external data source.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=626&amp;name=rds12.png" alt="rds12" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=313&amp;name=rds12.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=626&amp;name=rds12.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=939&amp;name=rds12.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=1252&amp;name=rds12.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=1565&amp;name=rds12.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds12.png?width=1878&amp;name=rds12.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span>Then, the user needs to create a <em>foreign table</em>, which defines the structure of the external data.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=626&amp;name=rds13.png" alt="rds13" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=313&amp;name=rds13.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=626&amp;name=rds13.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=939&amp;name=rds13.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=1252&amp;name=rds13.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=1565&amp;name=rds13.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds13.png?width=1878&amp;name=rds13.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span>All operations on a <em>foreign data table</em> are handled through its associated foreign data wrapper.</span></p>
<p><span>AWS created a custom foreign data wrapper for log_fwd with both a <em>handler function</em> and a <em>validator function</em>.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=626&amp;name=rds14.png" alt="rds14" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=313&amp;name=rds14.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=626&amp;name=rds14.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=939&amp;name=rds14.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=1252&amp;name=rds14.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=1565&amp;name=rds14.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds14.png?width=1878&amp;name=rds14.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<h2><span>Bypassing the log_fdw Extension Validation</span></h2>
<p><span>Back to the path traversal... The validation can happen in the <em>validator function</em>, the <em>handler function,</em> or both. Since the <em>validator function </em>is optional, you can drop it without damaging the functionality.</span></p>
<p><span>ALTER FOREIGN DATA WRAPPER log_fdw NO VALIDATOR;</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=626&amp;name=rds15.png" alt="rds15" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=313&amp;name=rds15.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=626&amp;name=rds15.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=939&amp;name=rds15.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=1252&amp;name=rds15.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=1565&amp;name=rds15.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds15.png?width=1878&amp;name=rds15.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><span>Now we check to see if the traversal will work ‚Ä¶</span><span>SELECT create_foreign_table_for_log_file(‚Äòmy_postgres_error_log‚Äô, ‚Äòlog_server‚Äô, ‚Äò../../../../../etc/passwd‚Äô);</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=626&amp;name=rds16.png" alt="rds16" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=313&amp;name=rds16.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=626&amp;name=rds16.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=939&amp;name=rds16.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=1252&amp;name=rds16.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=1565&amp;name=rds16.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds16.png?width=1878&amp;name=rds16.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><strong><span>It did!!!</span></strong><span> There is no validation in the <em>handler function</em>.</span></p>
<p><span>As the traversal is not really needed anymore, the table can be created directly:</span><span>CREATE FOREIGN TABLE demo (t text) SERVER log_server OPTIONS (filename ‚Äò/etc/passwd‚Äô);</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=626&amp;name=rds17.png" alt="rds17" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=313&amp;name=rds17.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=626&amp;name=rds17.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=939&amp;name=rds17.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=1252&amp;name=rds17.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=1565&amp;name=rds17.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds17.png?width=1878&amp;name=rds17.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<h2><span>Discovering AWS Internal Service Access Token</span></h2>
<p><span><span>I<span> spent some time going over system files until I found an interesting argument in the PostgreSQL config file that wasn‚Äôt shown through using psql. </span></span><span>CREATE FOREIGN TABLE demo (t text) SERVER log_server OPTIONS (filename ‚Äò/rdsdbdata/config/postgresql.conf‚Äô); SELECT * FROM demo;</span></span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=626&amp;name=rds18.png" alt="rds18" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=313&amp;name=rds18.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=626&amp;name=rds18.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=939&amp;name=rds18.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=1252&amp;name=rds18.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=1565&amp;name=rds18.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds18.png?width=1878&amp;name=rds18.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span>The screenshot below highlights the interesting argument of ‚Äúapg_storage_conf_file‚Äù which points to another configuration file with the name &#34;grover_volume.conf&#34;.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=626&amp;name=rds19.png" alt="rds19" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=313&amp;name=rds19.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=626&amp;name=rds19.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=939&amp;name=rds19.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=1252&amp;name=rds19.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=1565&amp;name=rds19.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds19.png?width=1878&amp;name=rds19.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></span></p>
<p><span><span>I don‚Äôt know what ‚Äùgrover‚Äù means, but let‚Äôs have a look on the file‚Äôs content.</span><br/></span></p>
<p><span>Here is the output from reading the content of <em>‚Äú/rdsdbdata/config/grover_volume.conf ‚Äú.</em></span><span>CREATE FOREIGN TABLE demo (t text) SERVER log_server OPTIONS (filename ‚Äò/rdsdbdata/config/grover_volume.conf‚Äô); SELECT * FROM demo;</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=1436&amp;name=rds20.png" alt="rds20" width="1436" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=718&amp;name=rds20.png 718w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=1436&amp;name=rds20.png 1436w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=2154&amp;name=rds20.png 2154w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=2872&amp;name=rds20.png 2872w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=3590&amp;name=rds20.png 3590w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds20.png?width=4308&amp;name=rds20.png 4308w" sizes="(max-width: 1436px) 100vw, 1436px"/></p>
<p><span>The file content points to another file at <em>‚Äú/tmp/csd-grover-credentials.json‚Äù</em>. Let‚Äôs have a look at the file‚Äôs content (hoping not to be redirected to another file again </span>üòÖ<span>). </span><span>CREATE FOREIGN TABLE demo (t text) SERVER log_server OPTIONS (filename ‚Äò/tmp/csd-grover-credentials.json‚Äô); SELECT * FROM demo;</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=626&amp;name=rds21.png" alt="rds21" width="626" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=313&amp;name=rds21.png 313w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=626&amp;name=rds21.png 626w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=939&amp;name=rds21.png 939w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=1252&amp;name=rds21.png 1252w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=1565&amp;name=rds21.png 1565w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds21.png?width=1878&amp;name=rds21.png 1878w" sizes="(max-width: 626px) 100vw, 626px"/></p>
<p><span>The file includes a temporary credentials of type <em>‚ÄúCSD_GROVER_API_CREDENTIALS‚Äù</em>. The ‚ÄúpublicKey‚Äù and the ‚ÄúprivateKey‚Äù values looks like STS ‚ÄúAccessKeyId‚Äù and ‚ÄúSecretAccessKey‚Äù respectively. </span>The signs that suggest this are <span>the ‚ÄúpublicKey‚Äù prefix of ‚ÄúASIA‚Äù (as specified in the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-unique-ids">Unique Identifiers</a> section of the AWS IAM User Guide) and the additional ‚Äútoken‚Äù parameter.<br/></span></p>
<p><span>This was validated by exporting the Access Key, Secret Access Key, and Session Token to my environment and using the AWS Security Token Service‚Äôs (STS) GetCallerIdentity API which returns the User ID, Account ID, and Amazon Resource Name (ARN) of the currently used IAM credentials. From the ARN, we can see the assumed role name is ‚Äúcsd-grover-role‚Äù in AWS‚Äô internal account.</span></p>
<p><span><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=624&amp;name=rds22.png" alt="rds22" width="624" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=312&amp;name=rds22.png 312w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=624&amp;name=rds22.png 624w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=936&amp;name=rds22.png 936w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=1248&amp;name=rds22.png 1248w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=1560&amp;name=rds22.png 1560w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/rds22.png?width=1872&amp;name=rds22.png 1872w" sizes="(max-width: 624px) 100vw, 624px"/></span></p>
<p><span>Within transiting three different files I was able to discover an internal AWS service and gain access to it. This is where my analysis and research ended, I did not attempt to enumerate any IAM permissions or move further laterally into AWS‚Äô internal environment.</span></p>
<p><img src="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=1639&amp;name=Untitled.png" alt="Untitled" width="1639" loading="lazy" srcset="https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=820&amp;name=Untitled.png 820w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=1639&amp;name=Untitled.png 1639w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=2459&amp;name=Untitled.png 2459w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=3278&amp;name=Untitled.png 3278w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=4098&amp;name=Untitled.png 4098w, https://7903508.fs1.hubspotusercontent-na1.net/hub/7903508/hubfs/Untitled.png?width=4917&amp;name=Untitled.png 4917w" sizes="(max-width: 1639px) 100vw, 1639px"/></p>

<h2><span>AWS Mitigation and Investigation</span></h2>
<p><span>We reported about this vulnerability to AWS security team, and they released a fix for the latest engine version within few days. AWS security team did an investigation to validate that this vulnerability was not exploited previously by someone else and confirmed that.</span></p>
<p><span>As for Grover, AWS are not able to disclose details about the internal service.</span></p>
<p><strong><span>Timeline</span></strong></p>
<p><span>Dec 09, 2021: Vulnerability was reported to AWS security.</span></p>
<p><span>Dec 09, 2021: AWS confirming the vulnerability and began with remediation and investigation.</span></p>
<p><span>Dec 14, 2021: AWS deployed the Initial patch, updating that they are working on a full fix.</span></p>
<p><span>Mar 22, 2022: AWS confirmed that they reached out to all affected customers and fixed all current supported versions.<br/></span></p>
<h2><span>Conclusion</span></h2>
<p><span>The AWS Cloud is a blessing for many developers, architects, and security professionals around the world due to its pay-as-you-go model and diversity of service offerings. However, like any service provider, wrapping third-party services such as PostgreSQL and trying to provide users with advanced features is sometimes a double-edged sword.</span></p></span>
    </p>
    
  </section>
</div>
</div>

</div><!--end widget-span -->
</div><!--end row-->
</div></div>
  </body>
</html>
