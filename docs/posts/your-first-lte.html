<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://open5gs.org/open5gs/docs/tutorial/01-your-first-lte/">Original</a>
    <h1>Your First LTE</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody" id="content"> <p>This post is the perfect starting point for learning to build your own LTE network. View this lession as a guided introduction – including the installation, configuration, and best practices that will ease your learning.</p> <h3 id="prerequisites">Prerequisites</h3> <hr/> <p>First, you have to prepare USRP B200/B210 to run srsRAN. However, please keep in mind that you would still need a fairly high-end PC (at least dual-core i5, better quad-core i7) with USB 3.0 to attach the USRP B200/B210.</p> <p>For USRP B200/B210, you can use a GPS antenna for clock synchronization. Of course, it can work without a GPS antenna, but if you have that antenna, it’s a good to have a window near your desk where you can put the small GPS patch antenna. In my case, a 1 to 2 meters antenna cable is used between desk/computer and the window.</p> <p>This document will be described with the following equipment.</p> <ul> <li>i5-8500 PC with Ubuntu 22.04(jammy)</li> <li>USRP B200/B210 with USB 3.0</li> <li>iPhone XS</li> <li>sysmoUSIM-SJS1</li> <li>10Mhz GPS-DO(Optional)</li> </ul> <h3 id="overall-physical-setup">Overall Physical Setup</h3> <hr/> <p>If you want to use GPS antenna, setup your devices in the following order:</p> <ol> <li>GPS antenna near window</li> <li>GPS antenna connected to “GPS ANT” connector of GPS-DO (SMA)</li> <li>10MHz output (BNC) of GPS-DO connected to 10MHz input of USRP (SMA)</li> <li>GPS input of USRP open/unused!</li> <li>1PPS input of USRP open/unused!</li> <li>GPS-DO powered via power supply</li> </ol> <p><strong>Note:</strong> When the GPS-DO acquires a lock on the GPS signal, a <strong>GREEN</strong> LED is displayed. GPS takes time to function normally. You also need to wait for the <strong>RED</strong> LED(ALARM) to turn off.</p> <p>Then, setup the USRP B200/B210 as below:</p> <ol> <li><strong>Small Antennas</strong> should be connected to USRP Rx/Tx ports (RF-A/RF-B)</li> <li>USRP powered via power supply or over <strong>USB 3.0</strong></li> <li>USRP <strong>USB 3.0</strong> port connected to your PC</li> </ol> <h3 id="usim-setup">USIM Setup</h3> <hr/> <p>Bascially, you can learn how to use it in the <a href="https://www.sysmocom.de/manuals/sysmousim-manual.pdf">sysmoUSIM manual</a> or on the <a href="http://osmocom.org/projects/pysim/wiki">official homepage of pysim project</a>. Let’s take a quickstart guide for this experiment.</p> <h6 id="install-dependencies">Install dependencies:</h6> <div><div><pre><code>$ sudo apt-get install pcscd pcsc-tools libccid libpcsclite-dev python3-pyscard
</code></pre></div></div> <ul> <li>Connect SIM card reader to your computer and insert programmable SIM card to the reader.</li> </ul> <h6 id="check-the-status-of-connection-by-entering-the-following-command">Check the status of connection by entering the following command:</h6> <div><div><pre><code>$ pcsc_scan
PC/SC device scanner
V 1.5.2 (c) 2001-2017, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
Using reader plug&#39;n play mechanism
Scanning present readers...
0: HID Global OMNIKEY 3x21 Smart Card Reader [OMNIKEY 3x21 Smart Card Reader] 00

Sun May 26 14:26:12 2019
 Reader 0: HID Global OMNIKEY 3x21 Smart Card Reader [OMNIKEY 3x21 Smart Card Re
  Card state: Card inserted,
  ATR: 3B 9F 96 80 1F C7 80 31 A0 73 BE 21 13 67 43 20 07 18 00 00 01 A5
...
</code></pre></div></div> <ul> <li>If SIM card reader is recognized then we can expect to print “Card inserted”.</li> </ul> <h6 id="get-the-code-of-pysim-with-installing-dependency">Get the code of PySIM with installing dependency:</h6> <div><div><pre><code>$ sudo apt-get install --no-install-recommends \
	pcscd libpcsclite-dev \
	python3 \
	python3-setuptools \
	python3-pyscard \
	python3-pip
 pip3 install --user -r requirements.txt
$ git clone git://git.osmocom.org/pysim
</code></pre></div></div> <h6 id="read-your-sim-card">Read your SIM card:</h6> <div><div><pre><code>$ ./pySim-read.py -p0 or ./pySim-read.py -p1
Using PC/SC reader (dev=0) interface
Reading ...
ICCID: 8988211000000213010
IMSI: 310789012345301
SMSP: ffffffffffffffffffffffffffffffffffffffffffffffffe1ffffffffffffffffffffffff
...
</code></pre></div></div> <h6 id="program-your-sim-card-like-the-followings">Program your SIM card like the followings:</h6> <div><div><pre><code>./pySim-prog.py -p 0 -n Open5GS -a 62416296 -s 8988211000000213010 -i 310789012345301 -x 310 -y 789 -k 82E9053A1882085FF2C020359938DAE9 -o BFD5771AAF4F6728E9BC6EF2C2533BDB
Using PC/SC reader (dev=0) interface
Insert card now (or CTRL-C to cancel)
Autodetected card type: sysmoUSIM-SJS1
Generated card parameters :
 &gt; Name    : Open5GS
 &gt; SMSP    : e1ffffffffffffffffffffffff0581005155f5ffffffffffff000000
 &gt; ICCID   : 8988211000000213010
 &gt; MCC/MNC : 310/789
 &gt; IMSI    : 310789012345301
 &gt; Ki      : 82E9053A1882085FF2C020359938DAE9
 &gt; OPC     : BFD5771AAF4F6728E9BC6EF2C2533BDB
 &gt; ACC     : None

Programming ...
Done !
</code></pre></div></div> <p><strong>Note:</strong> You should use your ADM value to program USIM card, not my ADM(-a 62416296).</p> <h3 id="installation">Installation</h3> <hr/> <p>We will use <em>Ubuntu 20.04(focal)</em> installed PC.</p> <h4 id="1-usrp-hardware-driver">1. USRP Hardware Driver</h4> <p>Most Linux distributions provide UHD as part of their package management. On <em>Debian and Ubuntu</em> systems, this will install the base UHD library, all headers and build-specific files, as well as utilities:</p> <div><div><pre><code><span>$ </span><span>sudo </span>add-apt-repository ppa:ettusresearch/uhd
<span>$ </span><span>sudo </span>apt update
<span>$ </span><span>sudo </span>apt <span>install </span>libuhd-dev uhd-host
</code></pre></div></div> <p>After installing, you need to download the FPGA images packages by running <em>uhd images downloader</em> on the command line (the actual path may differ based on your installation):</p> <div><div><pre><code><span>$ </span><span>sudo</span> /usr/lib/uhd/utils/uhd_images_downloader.py
</code></pre></div></div> <h4 id="2-srsran">2. srsRAN</h4> <p>On <em>Ubuntu 22.04(jammy)</em>, one can install the required libraries with:</p> <div><div><pre><code><span>$ </span><span>sudo </span>apt <span>install </span>cmake libfftw3-dev libmbedtls-dev libboost-program-options-dev libconfig++-dev libsctp-dev
</code></pre></div></div> <p>Download and build srsLTE:</p> <div><div><pre><code><span>$ </span>git clone https://github.com/srsRAN/srsRAN.git
<span>$ </span><span>cd </span>srsRAN
<span>$ </span>git checkout release_22_10
<span>$ </span>git rev-parse HEAD
254cc719a9a31f64ce0262f4ca6ab72b1803477d
<span>$ </span><span>mkdir </span>build
<span>$ </span><span>cd </span>build
<span>$ </span>cmake ../
<span>$ </span>make
<span>$ </span>make <span>test</span>
</code></pre></div></div> <h4 id="3-open5gs">3. Open5GS</h4> <p>The Open5GS package is available on the recent versions of <em>Ubuntu</em>.</p> <div><div><pre><code><span># Install the MongoDB Packages</span>
<span>$ </span>wget <span>-qO</span> - https://pgp.mongodb.com/server-6.0.asc | <span>sudo </span>apt-key add -
<span>$ </span><span>echo</span> <span>&#34;deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse&#34;</span> | <span>sudo tee</span> /etc/apt/sources.list.d/mongodb-org-6.0.list
<span>$ </span><span>sudo </span>apt update
<span>$ </span><span>sudo </span>apt <span>install </span>mongodb-org

<span># Installing Open5GS</span>
<span>$ </span><span>sudo </span>add-apt-repository ppa:open5gs/latest
<span>$ </span><span>sudo </span>apt update
<span>$ </span><span>sudo </span>apt <span>install </span>open5gs
</code></pre></div></div> <p>The following shows how to install the Web UI of Open5GS.</p> <div><div><pre><code><span>$ </span>curl <span>-fsSL</span> https://deb.nodesource.com/setup_18.x | <span>sudo</span> <span>-E</span> bash -
<span>$ </span><span>sudo </span>apt <span>install </span>nodejs
<span>$ </span>curl <span>-fsSL</span> https://open5gs.org/open5gs/assets/webui/install | <span>sudo</span> <span>-E</span> bash -
</code></pre></div></div> <h3 id="configuration--running">Configuration &amp; Running</h3> <hr/> <h4 id="1-open5gs">1. Open5GS</h4> <p>When you purchase the sysmoUSIM, you will receive the following information via e-mail.</p> <div><div><pre><code>Title : sysmocom SIM Card Details / AM93\PICK\00859

IMSI    ICCID   ACC PIN1    PUK1    PIN2    PUK2    Ki  OPC ADM1    KIC1    KID1    KIK1
...
999700000017408    8988211000000174089    0100    3623    84724035    8774    57473966    B1233463AB9BC2AD2DB1830EB6417E7B    625150E2A943E3353DD23554101CAFD4    47190711    C865CAA0A54542333929B29B116F4375    7D7F65DCD99003C0A0D5D31CA3E5253E    5B27983AF628FC3FCB36B89300012944
</code></pre></div></div> <p>Here’s my subscriber information from above.</p> <div><div><pre><code>MCC/MNC : 999/70
IMSI : 999700000017408
K : B1233463AB9BC2AD2DB1830EB6417E7B
OPc : 625150E2A943E3353DD23554101CAFD4  
</code></pre></div></div> <p>If you programmed USIM using a card reader like me, you should use your SIM information.</p> <div><div><pre><code>MCC/MNC : 310/789
IMSI : 310789012345301
K : 82E9053A1882085FF2C020359938DAE9
OPc : BFD5771AAF4F6728E9BC6EF2C2533BDB  
</code></pre></div></div> <p>Connect to <code>http://localhost:3000</code> and login with <strong>admin</strong> account.</p> <blockquote> <p>Username : admin</p> </blockquote> <p>Then proceed as follows:</p> <ol> <li>Go to <code>Subscriber</code> Menu.</li> <li>Click <code>+</code> Button to add a new subscriber.</li> <li>Fill the IMSI, security context(K, OPc, AMF), and APN of the subscriber.</li> <li>Click <code>SAVE</code> Button</li> </ol> <p><strong>Note:</strong> Subscribers added with this tool immediately register in the Open5GS HSS/UDR without the need to restart any daemon. However, if you use the WebUI to change subscriber profile, you must restart the Open5GS AMF/MME daemon for the changes to take effect.</p> <p>Modify <a href="https://github.com/open5gs/open5gs/blob/main/configs/open5gs/mme.yaml.in">install/etc/open5gs/mme.yaml</a> to set the S1AP IP address, PLMN ID, and TAC.</p> <div><div><pre><code><span>$</span> diff --git a/configs/open5gs/mme.yaml.in b/configs/open5gs/mme.yaml.in
<span>index 722648dd6..c998a1e47 100644
</span><span>--- a/configs/open5gs/mme.yaml.in
</span><span>+++ b/configs/open5gs/mme.yaml.in
</span><span>@@ -251,7 +251,7 @@</span> logger:
 mme:
     freeDiameter: @sysconfdir@/freeDiameter/mme.conf
     s1ap:
<span>-      - addr: 127.0.0.2
</span><span>+      - addr: 127.0.1.2
</span>     gtpc:
       - addr: 127.0.0.2
     metrics:
<span>@@ -259,15 +259,15 @@</span> mme:
         port: 9090
     gummei:
       plmn_id:
<span>-        mcc: 999
-        mnc: 70
</span><span>+        mcc: 310
+        mnc: 789
</span>       mme_gid: 2
       mme_code: 1
     tai:
       plmn_id:
<span>-        mcc: 999
-        mnc: 70
-      tac: 1
</span><span>+        mcc: 310
+        mnc: 789
+      tac: 5
</span>     security:
         integrity_order : [ EIA2, EIA1, EIA0 ]
         ciphering_order : [ EEA0, EEA1, EEA2 ]
</code></pre></div></div> <p>After changing conf files, please restart Open5GS daemons.</p> <div><div><pre><code><span>$ </span><span>sudo </span>systemctl restart open5gs-mmed.service
</code></pre></div></div> <p>In order to bridge between the PGWU/UPF and WAN (Internet), you must enable IP forwarding and add a NAT rule to your IP Tables.</p> <p>To enable forwarding and add the NAT rule, enter</p> <div><div><pre><code><span>### Enable IPv4/IPv6 Forwarding</span>
<span>$ </span><span>sudo </span>sysctl <span>-w</span> net.ipv4.ip_forward<span>=</span>1
<span>$ </span><span>sudo </span>sysctl <span>-w</span> net.ipv6.conf.all.forwarding<span>=</span>1

<span>### Add NAT Rule</span>
<span>$ </span><span>sudo </span>iptables <span>-t</span> nat <span>-A</span> POSTROUTING <span>-s</span> 10.45.0.0/16 <span>!</span> <span>-o</span> ogstun <span>-j</span> MASQUERADE
<span>$ </span><span>sudo </span>ip6tables <span>-t</span> nat <span>-A</span> POSTROUTING <span>-s</span> 2001:db8:cafe::/48 <span>!</span> <span>-o</span> ogstun <span>-j</span> MASQUERADE
</code></pre></div></div> <p>Configure the firewall correctly. Some operating systems (Ubuntu) by default enable firewall rules to block traffic.</p> <div><div><pre><code><span>$ </span><span>sudo </span>ufw status
Status: active
<span>$ </span><span>sudo </span>ufw disable
Firewall stopped and disabled on system startup
<span>$ </span><span>sudo </span>ufw status
Status: inactive
</code></pre></div></div> <p>Optionally, you may consider the settings below for security purposes.</p> <div><div><pre><code><span>### Ensure that the packets in the `INPUT` chain to the `ogstun` interface are accepted</span>
<span>$ </span><span>sudo </span>iptables <span>-I</span> INPUT <span>-i</span> ogstun <span>-j</span> ACCEPT

<span>### Prevent UE&#39;s from connecting to the host on which UPF is running</span>
<span>$ </span><span>sudo </span>iptables <span>-I</span> INPUT <span>-s</span> 10.45.0.0/16 <span>-j</span> DROP
<span>$ </span><span>sudo </span>ip6tables <span>-I</span> INPUT <span>-s</span> 2001:db8:cafe::/48 <span>-j</span> DROP

<span>### If your core network runs over multiple hosts, you probably want to block</span>
<span>### UE originating traffic from accessing other network functions.</span>
<span>### Replace x.x.x.x/y with the VNFs IP/subnet</span>
<span>$ </span><span>sudo </span>iptables <span>-I</span> FORWARD <span>-s</span> 10.45.0.0/16 <span>-d</span> x.x.x.x/y <span>-j</span> DROP
</code></pre></div></div> <h4 id="2-srsran-1">2. srsRAN</h4> <p>Change back to the srsRAN source directory and copy the main config example as well as all additional config files for RR, SIB and DRB.</p> <div><div><pre><code><span>$ </span><span>cp </span>srsenb/enb.conf.example srsenb/enb.conf
<span>$ </span><span>cp </span>srsenb/rr.conf.example srsenb/rr.conf
<span>$ </span><span>cp </span>srsenb/drb.conf.example srsenb/drb.conf
<span>$ </span><span>cp </span>srsenb/sib.conf.example srsenb/sib.conf
</code></pre></div></div> <p>You should check your phone frequency. If your phone does not support Band-3, you should use a different DL EARFCN value.</p> <div><div><pre><code><span>$</span> diff -u enb.conf.example enb.conf
<span>--- enb.conf.example	2022-12-11 10:04:37.519188021 +0900
</span><span>+++ enb.conf	2022-12-11 10:45:13.746995146 +0900
</span><span>@@ -20,9 +20,9 @@</span>
 #####################################################################
 [enb]
 enb_id = 0x19B
<span>-mcc = 001
-mnc = 01
-mme_addr = 127.0.1.100
</span><span>+mcc = 310
+mnc = 789
+mme_addr = 127.0.1.2
</span> gtp_bind_addr = 127.0.1.1
 s1c_bind_addr = 127.0.1.1
 s1c_bind_port = 0
</code></pre></div></div> <div><div><pre><code><span>$</span> diff -u rr.conf.example rr.conf
<span>--- rr.conf.example	2022-12-11 10:04:37.523187831 +0900
</span><span>+++ rr.conf	2022-12-11 10:42:23.590401941 +0900
</span><span>@@ -55,10 +55,10 @@</span>
   {
     // rf_port = 0;
     cell_id = 0x01;
<span>-    tac = 0x0007;
</span><span>+    tac = 0x0005;
</span>     pci = 1;
     // root_seq_idx = 204;
<span>-    dl_earfcn = 3350;
</span><span>+    dl_earfcn = 1600;
</span>     //ul_earfcn = 21400;
     ho_active = false;
     //meas_gap_period = 0; // 0 (inactive), 40 or 80
<span>@@ -114,4 +114,4 @@</span>
 nr_cell_list =
 (
   // no NR cells
<span>-);
</span><span>\</span> No newline at end of file
<span>+);
</span></code></pre></div></div> <p>MME Address, TAC, PLMN ID, DL EARFCN, and Device Argument are updated as belows.</p> <div><div><pre><code>MME Address : 127.0.1.2
TAC : 5
PLMN ID : MNC(310), MCC(789) programmed USIM with a card reader
DL EARFCN : Band-3 - from your Phone
Device Argument : Clock source from external GPS-DO
</code></pre></div></div> <p>If you are using GPS-DO, you need to add <code>device_args</code> as shown below.</p> <div><div><pre><code><span>$</span> diff -u enb.conf.example enb.conf
<span>--- enb.conf.example	2022-12-11 10:04:37.519188021 +0900
</span><span>+++ enb.conf	2022-12-11 10:44:25.565094551 +0900
</span><span>@@ -20,9 +20,9 @@</span>
 #####################################################################
 [enb]
 enb_id = 0x19B
<span>-mcc = 001
-mnc = 01
-mme_addr = 127.0.1.100
</span><span>+mcc = 310
+mnc = 789
+mme_addr = 127.0.1.2
</span> gtp_bind_addr = 127.0.1.1
 s1c_bind_addr = 127.0.1.1
 s1c_bind_port = 0
<span>@@ -82,6 +82,7 @@</span>
 # Example for ZMQ-based operation with TCP transport for I/Q samples
 #device_name = zmq
 #device_args = fail_on_disconnect=true,tx_port=tcp://*:2000,rx_port=tcp://localhost:2001,id=enb,base_srate=23.04e6
<span>+device_args = clock=external
</span>
 #####################################################################
 # Packet capture configuration
</code></pre></div></div> <p>Now, run the srsRAN as follows:</p> <div><div><pre><code><span>$ </span><span>cd </span>srsenb/
<span>$ </span><span>sudo</span> ../build/srsenb/src/srsenb ./enb.conf
<span>[</span><span>sudo</span><span>]</span> password <span>for </span>acetcom:
Active RF plugins: libsrsran_rf_uhd.so
Inactive RF plugins:
<span>---</span>  Software Radio Systems LTE eNodeB  <span>---</span>

Reading configuration file ./enb.conf...
WARNING: cpu0 scaling governor is not <span>set </span>to performance mode. Realtime processing could be compromised. Consider setting it to performance mode before running the application.

Built <span>in </span>Release mode using commit 254cc719a on branch HEAD.

Opening 1 channels <span>in </span>RF <span>device</span><span>=</span>default with <span>args</span><span>=</span>default
Supported RF device list: UHD file
Trying to open RF device <span>&#39;UHD&#39;</span>
<span>[</span>INFO] <span>[</span>UHD] linux<span>;</span> GNU C++ version 11.2.0<span>;</span> Boost_107400<span>;</span> UHD_4.3.0.0-0ubuntu1~jammy1
<span>[</span>INFO] <span>[</span>LOGGING] Fastpath logging disabled at runtime.
<span>[</span>INFO] <span>[</span>B200] Loading firmware image: /usr/share/uhd/images/usrp_b200_fw.hex...
Opening USRP <span>channels</span><span>=</span>1, args: <span>type</span><span>=</span>b200,master_clock_rate<span>=</span>23.04e6
<span>[</span>INFO] <span>[</span>UHD RF] RF UHD Generic instance constructed
<span>[</span>INFO] <span>[</span>B200] Detected Device: B200
<span>[</span>INFO] <span>[</span>B200] Loading FPGA image: /usr/share/uhd/images/usrp_b200_fpga.bin...
<span>[</span>INFO] <span>[</span>B200] Operating over USB 3.
<span>[</span>INFO] <span>[</span>B200] Detecting internal GPSDO....
<span>[</span>INFO] <span>[</span>GPS] No GPSDO found
<span>[</span>INFO] <span>[</span>B200] Initialize CODEC control...
<span>[</span>INFO] <span>[</span>B200] Initialize Radio control...
<span>[</span>INFO] <span>[</span>B200] Performing register loopback test...
<span>[</span>INFO] <span>[</span>B200] Register loopback <span>test </span>passed
<span>[</span>INFO] <span>[</span>B200] Asking <span>for </span>clock rate 23.040000 MHz...
<span>[</span>INFO] <span>[</span>B200] Actually got clock rate 23.040000 MHz.
RF device <span>&#39;UHD&#39;</span> successfully opened

<span>====</span> eNodeB started <span>===</span>
Type &lt;t&gt; to view trace
Setting frequency: <span>DL</span><span>=</span>1845.0 Mhz, <span>UL</span><span>=</span>1750.0 MHz <span>for </span><span>cc_idx</span><span>=</span>0 <span>nof_prb</span><span>=</span>50
</code></pre></div></div> <h3 id="turn-on-your-enodeb-and-phone">Turn on your eNodeB and Phone</h3> <hr/> <ul> <li>You can see actual traffic through wireshark – <a href="https://open5gs.org/open5gs/assets/pcapng/srsenb.pcapng">[srsenb.pcapng]</a>.</li> <li>You can view the log at <code>/var/log/open5gs/*.log</code>.</li> </ul> </div></div>
  </body>
</html>
