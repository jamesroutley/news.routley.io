<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://factorio.com/blog/post/fff-408">Original</a>
    <h1>Factorio â€“ Statistics improvements, Linux adventures</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>
  Hello,</p>

<hr/>
<h3>Statistics<author>Klonan</author></h3>

<p>
  Do you love watching your production graphs grow as much as we do?
</p>

<h4>Accumulator graph</h4>

<p>
  It is a little bit tricky when you transition from Steam power to Solar panels and Accumulators, to know if you have enough capacity in the system to survive the cold dark nights. Generally you might just wait until nighttime and see if your factory blacksout, if so, build more solar and accumulators.
</p>

<p>
  It would be helpful and convenient to see the statistics of accumulator charge levels, so we added such information:
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-accumulator-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-accumulator-graph.png" alt="Accumulator graph"/>
  </a>
</p>

<p>
  The main reason it was more critical, was that on Fulgora the production from lightning at nighttime is much less predictable, so it is much more important to see the timeline of the accumulator charge.
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-fulgora-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-fulgora-graph.png" alt="Fulgora graph"/>
  </a>
</p>

<h4>Science graph</h4>

<p>
  You can track science pack consumption in the production GUI, but that does not account for things like productivity modules and the new research productivity technologies.
</p>

<p>
  So we added a new special item in the production statistics, that shows the total final &#39;Science&#39; that is produced.
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-science-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-science-graph.png" alt="Science graph"/>
  </a>
</p>

<h4>Per surface production</h4>

<p>
  It was tolerable in the first days of playtesting with planets and platforms that all the production statistics were global. However when you want to get more and more precise with your gameplay and trying optimize each part, it becomes quite necessary.
</p>

<p>
  For instance on platforms, we need to know if we are producing enough fuel and ammo to keep the ride going:
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-platform-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-platform-graph.png" alt="Platform graph"/>
  </a>
</p>

<p>
  And its super helpful when checking if a specific planet producing enough when some items are crafted in many places.
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-vulcanus-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-vulcanus-graph.png" alt="Vulcanus graph"/>
  </a>
</p>

<p>
  We also added a checkbox to switch to a &#39;Global statistics&#39; view, so all the possibilities are available for the player.
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-global-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-global-graph.png" alt="Global graph"/>
  </a>
</p>

<h4>Quality graph</h4>

<p>
  Going deeper still, we want to dissect our production by what quality the produced items are.
</p>

<p>
  <a href="https://cdn.factorio.com/assets/blog-sync/fff-408-quality-graph.png" target="_blank">
    <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-quality-graph.png" alt="Quality graph"/>
  </a>
</p>

<p>
  So what do you think? Are there any other statistics improvements you can think about for 2.0?
</p>

<hr/>
<h3>Linux adventures<author>raiguard</author></h3>
<p>
  I have appeared in a few FFFs by now but I have never formally introduced myself. My name is raiguard. I have been playing Factorio since June 2017, making mods for the game since the 0.17 release in March 2019, and I finally joined Wube in March 2023.
  My primary roles at the company are expansion programming and Linux support, as well as being an advocate for the modding community.
  I have been daily-driving Linux for multiple years and have fallen ever deeper into the black hole of customization and minimalism.
</p>
<p>
  &#34;Why don&#39;t most games support macOS and Linux?&#34; is a sentiment I often see echoed across the internet.
  Supporting a new platform is a lot more than just changing some flags and hitting compile.
  Windows, macOS, Linux, and the Nintendo Switch all use different compilers, different implementations of the C++ standard library, and have different implementation quirks, bugs, and features.
  You need to set up CI for the new platform, expand your build system to support the new compiler(s) and architecture(s), and have at least one person on the team that cares enough about the platform to actively maintain it.
  If you are a video game, you will likely need to add support for another graphics backend (Vulkan or OpenGL) as well, since DirectX is Windows-exclusive.
</p>
<p>
  Many developers will take one look at the <a href="https://gs.statcounter.com/os-market-share/desktop/worldwide">Windows market share</a> and decide that it is not worth the trouble to support other platforms.
  Also, with the meteoric rise of the Steam Deck and Proton, it is easier than ever for game developers to ignore Linux support because Valve does some black magic that lets their game run anyway.
</p>
<p>
  Factorio supports macOS and Linux so well because there has always been someone at Wube who actively uses these platforms and is willing to take on the burden of supporting it.
  Our native <a href="https://factorio.com/blog/post/fff-371">Apple Silicon</a> support is a great example of this.
  Today, I will take you through some of the adventures I&#39;ve had with maintaining Factorio&#39;s Linux support.
</p>

<h4>Wayland</h4>
<p>
  My first self-appointed task after joining the team was to add <a href="https://wayland.freedesktop.org/">Wayland</a> support to the game.
  Wayland is a new display protocol that has been in development to replace the antiquated and insecure <a href="https://en.wikipedia.org/wiki/X_Window_System">X11</a> system.
  Modern Linux distributions are beginning to switch to Wayland as default, so supporting it in Factorio is paramount.
</p>
<p>
  We utilize the <a href="https://www.libsdl.org/">SDL</a> library which neatly handles most low-level system interactions and abstracts them into a common interface.
  SDL has support for Wayland, so all that I theoretically needed to do was build SDL with Wayland enabled and it would &#34;just work.&#34;
  However, it&#39;s not quite a simple plug-and-play. Wayland provides &#34;protocols&#34; in the form of XML files that you then use the <code>wayland-scanner</code> binary to convert into C program and header files.
</p>
<p>
  Being relatively new to C++ at the time, my initial solution was convoluted and involved checking the generated Wayland protocols into our source tree, to be manually regenerated every time we updated SDL.
  A few months ago, armed with a years&#39; worth of experience, I improved this workflow to automatically generate the files as a part of the build process, so they are always up-to-date with the protocol XML files that SDL ships with.
</p>
<p>
  Factorio has supported Wayland since 1.1.77, but it needs to be explicitly enabled by setting <code>SDL_VIDEODRIVER=wayland</code> in your environment.
  For Factorio 2.0 I added a dropdown to select your preference in the GUI:
</p>

<div>
  <p><img alt="X11" title="X11" src="https://cdn.factorio.com/assets/blog-sync/fff-408-x11.png"/>
    <img alt="Wayland" title="Wayland" src="https://cdn.factorio.com/assets/blog-sync/fff-408-wayland.png"/>
  </p>
</div>

<p>
  <i>
    X11 (left) vs. Wayland (right) with the desktop display scale set to 125%.
    </i>
</p>

<h4>Client-side window decorations</h4>
<p>
  Once Wayland support was implemented, I received a <a href="https://forums.factorio.com/105512">bug report</a> that the window was missing a titlebar and close buttons (called &#34;window decorations&#34;) when running on <a href="https://www.gnome.org/">GNOME</a>.
  Most desktop environments will allow windows to supply their own decorations if they wish but will provide a default implementation on the server side as an alternative.
  GNOME, in their infinite wisdom, have decided that all clients <i>must</i> provide their own decorations, and if a client does not, they will simply be missing.
  I disagree with this decision; Factorio does not need to provide decorations on any other platform, nay, on any other desktop environment, but GNOME can (ab)use its popularity to force programs to conform to its idiosyncrasies or be left behind.
</p>
<p>
  To fix this, I had to bring in another dependency, <a href="https://gitlab.freedesktop.org/libdecor/libdecor">libdecor</a>.
  It functions, and SDL even has support for it, but a video game shouldn&#39;t have to supply window decorations in the first place.
</p>

<p>
  <img src="https://cdn.factorio.com/assets/blog-sync/fff-408-decorations.png"/>
  </p>

<h4>Window resizing seizures</h4>
<p>
  A video is worth more than a thousand words:
</p>

<p>
  <video controls="" muted="" playsinline="">
    <source src="https://cdn.factorio.com/assets/blog-sync/fff-408-seizure.mp4" type="video/mp4"/>
    Mp4 playback not supported on your device.
  </video>
  <b>PHOTOSENSITIVITY WARNING:</b> Rapid flashing images.
</p>

<p>
  I use the <a href="https://swaywm.org/">Sway</a> window manager, and a particularity of this window manager is that it will automatically resize floating windows to the size of their last submitted frame.
  This has unveiled an issue with our graphics stack: it takes the game three frames to properly respond to a window resize.
  The result is a rapid tug-of-war, with Sway sending a ton of resize events and Factorio responding with outdated framebuffer sizes, causing the chaos captured above.
</p>

<p>
  I spent two full days staring at our graphics code but could not come up with an explanation as to why this is happening, so this work is still ongoing.
  Since this issue only happens when running the game on Wayland under Sway, it&#39;s not a large priority, but it was too entertaining not to share.
</p>

<h4>Dynamically linked libraries</h4>
<p>
  In a C++ program there are three ways to load/include a library:
  </p><ul>
    <li>By including it in your source binary (static linking).</li>
    <li>Having the system load it when your program starts (dynamic linking).</li>
    <li>Your program loads it explicitly after startup (&#34;dynamic loading&#34; or what I call &#34;runtime linking&#34;).</li>
  </ul><p>
  We have many libraries, such as SDL, FontStash, and Lua, that are statically linked, but Factorio 1.1 also has <i>many</i> dynamically linked libraries:
</p>

<pre>rai@tantal ~/games/factorio
$ ldd bin/x64/factorio
        linux-vdso.so.1 (0x00007ffc123b1000)
        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fc182f70000)
        librt.so.1 =&gt; /lib64/librt.so.1 (0x00007fc182f6b000)
        libresolv.so.2 =&gt; /lib64/libresolv.so.2 (0x00007fc182f5a000)
        libX11.so.6 =&gt; /lib64/libX11.so.6 (0x00007fc182e13000)
        libXext.so.6 =&gt; /lib64/libXext.so.6 (0x00007fc182dff000)
        libGL.so.1 =&gt; /lib64/libGL.so.1 (0x00007fc182d78000)
        libXinerama.so.1 =&gt; /lib64/libXinerama.so.1 (0x00007fc182d71000)
        libXrandr.so.2 =&gt; /lib64/libXrandr.so.2 (0x00007fc182d64000)
        libXcursor.so.1 =&gt; /lib64/libXcursor.so.1 (0x00007fc182d57000)
        libasound.so.2 =&gt; /lib64/libasound.so.2 (0x00007fc182c43000)
        libpulse.so.0 =&gt; /lib64/libpulse.so.0 (0x00007fc182bf1000)
        libpulse-simple.so.0 =&gt; /lib64/libpulse-simple.so.0 (0x00007fc182bea000)
        libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fc182b07000)
        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fc182b02000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fc182920000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc182f91000)
        libxcb.so.1 =&gt; /lib64/libxcb.so.1 (0x00007fc1828f5000)
        libGLX.so.0 =&gt; /lib64/libGLX.so.0 (0x00007fc1828c2000)
        libGLdispatch.so.0 =&gt; /lib64/libGLdispatch.so.0 (0x00007fc18280a000)
        libXrender.so.1 =&gt; /lib64/libXrender.so.1 (0x00007fc1827fc000)
        libXfixes.so.3 =&gt; /lib64/libXfixes.so.3 (0x00007fc1827f4000)
        libpulsecommon-16.1.so =&gt; /usr/lib64/pulseaudio/libpulsecommon-16.1.so (0x00007fc18276f000)
        libdbus-1.so.3 =&gt; /lib64/libdbus-1.so.3 (0x00007fc18271a000)
        libXau.so.6 =&gt; /lib64/libXau.so.6 (0x00007fc182714000)
        libsndfile.so.1 =&gt; /lib64/libsndfile.so.1 (0x00007fc182694000)
        libsystemd.so.0 =&gt; /lib64/libsystemd.so.0 (0x00007fc1825a1000)
        libasyncns.so.0 =&gt; /lib64/libasyncns.so.0 (0x00007fc182599000)
        libgsm.so.1 =&gt; /lib64/libgsm.so.1 (0x00007fc18258a000)
        libFLAC.so.12 =&gt; /lib64/libFLAC.so.12 (0x00007fc182524000)
        libvorbis.so.0 =&gt; /lib64/libvorbis.so.0 (0x00007fc1824f5000)
        libvorbisenc.so.2 =&gt; /lib64/libvorbisenc.so.2 (0x00007fc182448000)
        libopus.so.0 =&gt; /lib64/libopus.so.0 (0x00007fc1823ec000)
        libogg.so.0 =&gt; /lib64/libogg.so.0 (0x00007fc1823e2000)
        libmpg123.so.0 =&gt; /lib64/libmpg123.so.0 (0x00007fc182385000)
        libmp3lame.so.0 =&gt; /lib64/libmp3lame.so.0 (0x00007fc18230d000)
        libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007fc182303000)
        liblz4.so.1 =&gt; /lib64/liblz4.so.1 (0x00007fc1822df000)
        liblzma.so.5 =&gt; /lib64/liblzma.so.5 (0x00007fc1822ac000)
        libzstd.so.1 =&gt; /lib64/libzstd.so.1 (0x00007fc1821f0000)
        libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fc1821cc000)
</pre>
<p>
  Among these libraries are X11 and PulseAudio, which are being deprecated in favor of Wayland and PipeWire respectively.
  This causes a compatibility nightmare because if any dynamic dependencies are missing, the game will not launch.
  This obviously will not do!
</p>
<p>
  The presence of these dependencies confused me because we utilize SDL for most of the low-level syscalls, audio, and video, and SDL relies entirely on runtime linking.
  An investigation revealed the source of most of these dependencies to be <a href="https://liballeg.org/">Allegro</a>, the low-level library that we utilized for most of Factorio&#39;s alpha phase but we have since replaced with SDL.
  The only remaining use of Allegro in 2.0 was as a secondary audio backend in case a user experienced issues with the SDL audio backend, but the SDL backend has been stable for a very long time, so the time was ripe for its removal.
  This eliminated 123,024 lines of code from the game and drastically reduced the number of dynamic dependencies:
</p>
<pre>rai@tantal ~/dev/wube/factorio (master)
$ ldd bin/FinalReleasex64Clang/factorio
        linux-vdso.so.1 (0x00007fff96ff2000)
        libresolv.so.2 =&gt; /lib64/libresolv.so.2 (0x00007fd2df8a9000)
        libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fd2df7c8000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fd2df5e6000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fd2df8d6000)
</pre>

<h4>Clipboard woes</h4>
<p>
  It turns out that Allegro was not the only thing requiring us to link against X11.
  Back in 2017, we received a <a href="https://forums.factorio.com/46802">bug report</a> that a user could not paste large blueprint strings into the game, and Oxyd fixed this by adding support for <a href="https://tronche.com/gui/x/icccm/sec-2.html#s-2.5">X11 incremental clipboard transfers</a> to our GUI backend&#39;s clipboard handler.
</p>
<p>
  I was hoping to utilize SDL&#39;s built-in clipboard functionality, but unfortunately SDL does not support incremental transfers.
  This means there are three options:
</p>
<ul>
  <li>Continue linking against X11, requiring users to install X11 on their system to be able to run the game (I don&#39;t want to mess with static linking).</li>
  <li>Figure out how to do runtime linking and implement that.</li>
  <li>Upstream our incremental transfers code into SDL so we can leverage SDL&#39;s clipboard functions and other SDL-based games can benefit from our work.</li>
</ul>
<p>
  As you might guess, I chose the third option.
  The work to upstream our code is ongoing but should be done in time for Factorio 2.0&#39;s release.
</p>

<h4>Asynchronous saving</h4>
<p>
  Many of you might not be aware that Factorio has support for saving your game in the background, without freezing while it does so.
  This feature is tucked away in the hidden settings and only works on macOS and Linux.
  This is one great example of taking advantage of a platform&#39;s features to benefit the game, which would not be available to us if we simply went through Proton.
</p>
<p>
  Asynchronous saving works by using the <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork syscall</a> to essentially duplicate the game.
  The primary instance - the one you interact with - continues playing, but the newly forked child runs the saving process then exits on completion.
  I have used it for many years and have never had issues, but the setting remains hidden because there are a few unsolved problems with it and it requires a significant amount of RAM to work.
</p>
<p>
  I would love to promote this feature away from its hidden status in 2.0.
  If you are playing on Linux or macOS, please enable asynchronous saving (ctrl+alt+click Settings -&gt; &#34;The rest&#34; -&gt; <code>non-blocking-saving</code>) and report any issues you find.
  I am particularly interested in reproducing a <a href="https://forums.factorio.com/108738">seemingly random freeze</a> that occurs at the end of the process.
  Thank you in advance!
</p>

<h4>Continuing development</h4>
<p>
  This has been but a glimpse of the work I have been doing to ensure Factorio on Linux is the best that it can be.
  There are still many open bug reports and other issues but I am generally happy with the state of things and can confidently say that Factorio has <i>great</i> Linux support.
</p>

<hr/>
<p>
  As always, submit a text buffer with your feedback to the usual places.
</p>

<!-- juxtapose.js -->



        

        
    </div></div>
  </body>
</html>
