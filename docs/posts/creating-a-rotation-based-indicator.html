<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.winstoncooke.com/blog/creating-a-rotation-based-indicator">Original</a>
    <h1>Creating a Rotation-based Indicator</h1>
    
    <div id="readability-page-1" class="page"><article><div><p><time datetime="2024-07-30">2024-07-30</time></p><p data-svelte-h="svelte-qpi4bo">After <a href="https://www.winstoncooke.com/blog/making-a-game-for-the-playdate" rel="nofollow">making an arena shooter for the Playdate</a> titled <em>Plight of the Wizard</em>, there were a few areas I knew I needed to polish.
One of those areas was how I handle my character’s rotation.
Here was my previous implementation:</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/da397623-fb28-4296-5ee4-1edc5169d400/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/da397623-fb28-4296-5ee4-1edc5169d400/public" alt="An older build of Plight of the Wizard that has awkward rotations when playing the game." title="Plight of the Wizard - Old rotation system"/></a></p> <p data-svelte-h="svelte-1652ug3">There were two issues with my approach:</p> <ol data-svelte-h="svelte-116zmmg"><li>Rotating a sprite in code is not very performant. According the the <a href="https://sdk.play.date/inside-playdate/#m-graphics.sprite.setRotation" rel="nofollow">Playdate SDK</a>:</li></ol> <blockquote data-svelte-h="svelte-mcm61m"><p>This function should be used with discretion, as it’s likely to be slow on the hardware. Consider pre-rendering rotated images for your sprites instead.</p></blockquote> <ol start="2" data-svelte-h="svelte-1o0u897"><li>It looked plain goofy</li></ol> <p data-svelte-h="svelte-18nlr0g">So, I decided fix both problems with one solution: an indicator that displays where the player’s spells are aimed.
In order to make this work, I had to create a new sprite that maps to the player’s <em>x</em> and <em>y</em> coordinates with a slight offset so that the indicator doesn’t appear on top of the player.
I chose to make the offset equal to the distance the spell will travel.
I implemented this in the Player class in the following manner:</p> <pre><!-- HTML_TAG_START --><code>
<span>function</span> Player<span>:</span><span>init</span><span>(</span>x<span>,</span> y<span>)</span>
    <span>...</span>
    self<span>.</span>spellIndicator <span>=</span> <span>SpellIndicator</span><span>(</span>self<span>.</span>x<span>,</span> self<span>.</span>y<span>,</span> self<span>.</span>equippedSpellDistance<span>)</span>
    self<span>.</span>spellIndicator<span>:</span><span>setPlayerInstance</span><span>(</span>self<span>)</span>
<span>end</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-1nl140s">In the new SpellIndicator class, I initialize its coordinates with the offset like so:</p> <pre><!-- HTML_TAG_START --><code>
<span>function</span> SpellIndicator<span>:</span><span>init</span><span>(</span>x<span>,</span> y<span>,</span> distance<span>)</span>
    self<span>.</span>indicatorDistance <span>=</span> distance
    self<span>.</span>angle <span>=</span> <span>0</span>
    <span>...</span>
    self<span>:</span><span>moveTo</span><span>(</span>x <span>+</span> self<span>.</span>indicatorDistance<span>,</span> y<span>)</span>
<span>end</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-toblle">After initializing the indicator, I initially tried to make it follow the player by spawning a new instance, which resulted in a fun bug.</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/4ba8edfb-b05e-4a34-3982-bd4198430300/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/4ba8edfb-b05e-4a34-3982-bd4198430300/public" alt="A bug with the indicator that makes a fun drawing on the screen." title="Plight of the Wizard - Indicator drawing bug"/></a></p> <p data-svelte-h="svelte-2jtmlc">That looks awesome but doesn’t lend itself very well to gameplay.</p> <p data-svelte-h="svelte-12tp546">Instead, I updated the indicator’s coordinates in its update loop to both follow the player as they move around as well as map it to the rotational value of the crank, which can be rotated 360°.</p> <pre><!-- HTML_TAG_START --><code>
<span>function</span> SpellIndicator<span>:</span><span>update</span><span>(</span><span>)</span>
    <span>if</span> playerInstance <span>then</span>
        
        self<span>.</span>angle <span>=</span> self<span>.</span>angle <span>+</span> pd<span>.</span><span>getCrankChange</span><span>(</span><span>)</span>
        <span>local</span> newX <span>=</span> playerInstance<span>.</span>x <span>+</span> self<span>.</span>indicatorDistance <span>*</span> math<span>.</span><span>cos</span><span>(</span>math<span>.</span><span>rad</span><span>(</span>self<span>.</span>angle<span>)</span><span>)</span>
        <span>local</span> newY <span>=</span> playerInstance<span>.</span>y <span>+</span> self<span>.</span>indicatorDistance <span>*</span> math<span>.</span><span>sin</span><span>(</span>math<span>.</span><span>rad</span><span>(</span>self<span>.</span>angle<span>)</span><span>)</span>
        self<span>:</span><span>moveTo</span><span>(</span>newX<span>,</span> newY<span>)</span>
    <span>end</span>
<span>end</span></code><!-- HTML_TAG_END --></pre> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/4f621c2b-6ed2-4c20-709f-2bafe82b3200/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/4f621c2b-6ed2-4c20-709f-2bafe82b3200/public" alt="A bug where the spell fired does not follow the spell indicator." title="Plight of the Wizard - Indicator rotation without spell"/></a></p> <p data-svelte-h="svelte-1kth5i5">Now I have an indicator that rotates smoothly around the player that maps to the clockwise and counterclockwise rotations of the Playdate’s crank.</p> <p data-svelte-h="svelte-qqw0we">But wait!
The fireball spell is shooting to the default position to the right rather where the spell indicator is aimed.
Well that’s because it’s still set up to follow the player’s sprite’s rotation, which is now no longer being rotated.
The fix is simple.
When the player casts a fireball, I just need to pass the <code>SpellIndicator</code>’s angle rather than the player’s.</p> <pre><!-- HTML_TAG_START --><code>
<span>castFireballSpell</span><span>(</span>self<span>,</span> self<span>.</span>spellIndicator<span>.</span>angle<span>)</span></code><!-- HTML_TAG_END --></pre> <pre><!-- HTML_TAG_START --><code>
spellSpawnOffset <span>=</span> <span>48</span>

<span>function</span> <span>castFireballSpell</span><span>(</span>player<span>,</span> angle<span>)</span>
    <span>local</span> spawnOffsetX <span>=</span> spellSpawnOffset <span>*</span> math<span>.</span><span>cos</span><span>(</span>math<span>.</span><span>rad</span><span>(</span>angle<span>)</span><span>)</span>
    <span>local</span> spawnOffsetY <span>=</span> spellSpawnOffset <span>*</span> math<span>.</span><span>sin</span><span>(</span>math<span>.</span><span>rad</span><span>(</span>angle<span>)</span><span>)</span>
    <span>FireballSpell</span><span>(</span>player<span>.</span>x <span>+</span> spawnOffsetX<span>,</span> player<span>.</span>y <span>+</span> spawnOffsetY<span>,</span> angle<span>)</span>
<span>end</span></code><!-- HTML_TAG_END --></pre> <p data-svelte-h="svelte-malbzw">So, what does this new fancy indicator look like?</p> <p><a href="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/dec78770-6bc5-4f40-8e20-2e7983f0b900/gallery"><img loading="lazy" src="https://imagedelivery.net/ga2MLDZ3d0ln9C7Qw_eDwg/dec78770-6bc5-4f40-8e20-2e7983f0b900/public" alt="The new spell indicator, which rotates around the player and spells are fired towards." title="Plight of the Wizard - Spell attack indicator"/></a></p> <p data-svelte-h="svelte-194p9kf">It’s not much, but it gets the job done for now.</p></div></article></div>
  </body>
</html>
