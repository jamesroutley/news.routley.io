<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gms.tf/on-the-costs-of-syscalls.html">Original</a>
    <h1>On the Costs of Syscalls (2021)</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <div>
<!-- content -->
<p>It&#39;s well known that <a href="https://en.wikipedia.org/wiki/System_call">syscalls</a> are expensive. And that
software mitigations against <a href="https://en.wikipedia.org/wiki/Transient_execution_CPU_vulnerability">CPU bugs</a> (such as Meltdown) even
have made them more expensive. But how expensive are they really?
To begin to answer this question I wrote a small
<a href="https://github.com/gsauthof/osjitter/blob/master/bench_syscalls.cc">micro-benchmark</a> in order to measure the minimal costs of a
syscall. Meaning the cost of syscalls one always has to pay
whether a context-switch happens or not, even when the work in
the kernel is minuscule,  i.e. the costs of switching from
<a href="https://en.wikipedia.org/wiki/Context_switch#User_and_kernel_mode_switching">user-mode to kernel-mode</a> and back.</p>
<h2 id="methods">Methods<a href="#methods" title="Permanent link">¶</a></h2>
<p>The user-kernel mode-switch <a href="https://en.wikipedia.org/wiki/Benchmark_(computing)#Types_of_benchmark">micro-benchmark</a> uses Google&#39;s
<a href="https://github.com/google/benchmark">benchmark library</a> for the measurements and is <a href="https://github.com/gsauthof/osjitter/blob/master/bench_syscalls.cc">available in
a git repository</a>. The repository also contains some helper
scripts, e.g. a <a href="https://github.com/gsauthof/osjitter/blob/master/helper/bench_playbook.py">playbook</a> for distributing it to and executing
it on a bunch of hosts. The benchmark library repeats each case
until the result is considered stable and the playbook allows for
repeated executions of the test cases. In the following sections
the median value of 100 repetitions is reported (real time in
nanoseconds).</p>
<p>For the benchmark a bunch of syscalls is called that are expected
to be very cheap, such as getting the user id (UID), the program id
(PID), closing an invalid file descriptor, calling an
non-existent syscall etc. Thus, a measurement should really
just include two mode switches. As controls, a few cases don&#39;t call
a syscall but do other cheap stuff.</p>
<p>I ran the benchmark on a heterogeneous set of hosts, i.e.
different kernels, operating systems and configurations. For more
details see also the Hosts Section.</p>
<h2 id="results-and-discussion">Results and Discussion<a href="#results-and-discussion" title="Permanent link">¶</a></h2>
<p>The following table shows the real time (ns) for the different
cases:</p>


<table id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072"><thead>    <tr>        <th>host</th>        <th>5i4250u</th>        <th>7i6600u</th>        <th>ac3758</th>        <th>x2643</th>        <th>x2667h</th>        <th>x2667s</th>        <th>x2687w</th>        <th>x2689</th>        <th>x2690</th>        <th>xg6144</th>        <th>xg6148</th>        <th>xg6246</th>        <th>xg6256</th>        <th>xg6256b</th>        <th>xs4110</th>    </tr>    <tr>        <th>name</th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>    </tr></thead><tbody>
                <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row0">assign</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col0">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col1">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col2">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col3">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col4">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col5">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col6">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col7">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col8">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col9">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col10">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col11">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col12">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col13">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row0_col14">0</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row1">clock_gettime</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col0">23</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col1">21</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col2">31</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col3">19</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col4">16</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col5">16</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col6">17</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col7">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col8">21</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col9">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col10">24</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col11">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col12">13</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col13">13</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row1_col14">24</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row2">clock_gettime_mono</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col0">23</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col1">22</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col2">32</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col3">16</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col4">16</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col5">16</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col6">17</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col7">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col8">21</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col9">15</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col10">24</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col11">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col12">13</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col13">13</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row2_col14">24</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row3">clock_gettime_mono_raw</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col0">23</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col1">22</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col2">33</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col3">542</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col4">544</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col5">350</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col6">582</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col7">332</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col8">762</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col9">660</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col10">427</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col11">274</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col12">122</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col13">290</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row3_col14">218</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row4">clock_gettime_tai</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col0">23</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col1">21</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col2">32</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col3">542</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col4">546</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col5">352</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col6">587</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col7">333</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col8">762</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col9">660</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col10">427</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col11">274</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col12">122</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col13">292</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row4_col14">218</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row5">close</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col0">568</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col1">262</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col2">275</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col3">484</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col4">495</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col5">283</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col6">514</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col7">277</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col8">668</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col9">610</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col10">356</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col11">243</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col12">93</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col13">257</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row5_col14">145</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row6">getpid</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col0">558</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col1">257</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col2">255</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col3">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col4">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col5">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col6">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col7">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col8">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col9">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col10">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col11">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col12">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col13">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row6_col14">2</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row7">getuid</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col0">560</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col1">231</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col2">259</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col3">464</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col4">473</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col5">276</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col6">505</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col7">259</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col8">649</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col9">592</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col10">347</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col11">224</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col12">78</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col13">239</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row7_col14">137</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row8">nothing</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col0">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col1">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col2">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col3">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col4">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col5">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col6">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col7">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col8">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col9">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col10">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col11">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col12">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col13">0</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row8_col14">0</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row9">pthread_cond_signal</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col0">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col1">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col2">6</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col3">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col4">13</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col5">12</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col6">14</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col7">11</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col8">15</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col9">10</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col10">17</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col11">10</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col12">10</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col13">10</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row9_col14">17</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row10">sched_yield</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col0">706</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col1">374</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col2">430</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col3">569</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col4">560</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col5">414</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col6">634</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col7">346</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col8">773</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col9">694</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col10">454</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col11">280</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col12">126</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col13">300</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row10_col14">232</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row11">sqrt</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col0">6</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col1">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col2">15</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col3">4</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col4">4</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col5">4</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col6">4</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col7">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col8">7</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col9">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col10">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col11">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col12">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col13">1</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row11_col14">3</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row12">sqrtrec</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col0">4</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col1">4</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col2">15</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col3">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col4">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col5">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col6">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col7">2</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col8">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col9">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col10">5</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col11">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col12">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col13">3</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row12_col14">5</td>
            </tr>
            <tr>
                        <th id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072level0_row13">syscall</th>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col0">560</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col1">252</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col2">265</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col3">440</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col4">460</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col5">269</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col6">497</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col7">243</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col8">620</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col9">579</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col10">345</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col11">221</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col12">76</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col13">233</td>
                        <td id="T_dde6e7fa_0989_11ec_9e32_f8cab850d072row13_col14">136</td>
            </tr>
    </tbody></table>

<h3 id="controls">Controls<a href="#controls" title="Permanent link">¶</a></h3>
<p>The cases used as controls are &#39;nothing&#39; which literally does
nothing, &#39;assign&#39; which just assigns to a variable, <code>sqrt</code> which
computes the square root of a small constant and <code>sqrtrec</code> which
stacks a bunch of sqrt calls. The results for these are
plausible, i.e. doing nothing is really measured as <code>10**-7</code> ns or
so, the assignment costs 0.5 ns or so and computing the square
root takes only a few ns. Perhaps the most remarkable result is,
that computing the square root on a Atom CPU (ac3758) is pretty
constant over the 2 cases, whereas on the other hosts its runtime
depends on its argument.</p>
<h3 id="clock-gettime">Clock Gettime<a href="#clock-gettime" title="Permanent link">¶</a></h3>
<p>Looking at the syscalls, one relation that holds true on all
hosts is that the <code>clock_gettime(CLOCK_REALTIME)</code> syscall is much
faster than <code>getuid()</code> or <code>close()</code>. This can be explained by the
fact that on Linux, <code>clock_gettime(CLOCK_REALTIME)</code> and a <a href="https://manpath.be/f34/7/vdso#L334">few
other syscalls</a> are implemented via the efficient <a href="https://en.wikipedia.org/wiki/VDSO">vDSO</a> mechanism.
Meaning when they are called no mode switch happens!</p>
<p><code>clock_gettime()</code> supports different clocks and not all of them
are vDSO optimized on all kernels. The table shows that on RHEL 7 querying
<code>CLOCK_MONOTIC_RAW</code> and <code>CLOCK_TAI</code> invokes a real syscall while
on Fedora 33 kernels (5.12/5.13) these clock readings are also
implemented as vDSO.</p>
<h3 id="dummy-signaling">Dummy Signaling<a href="#dummy-signaling" title="Permanent link">¶</a></h3>
<p>Similarly, the dummy <code>pthread_cond_signal()</code> case, which signals
without anybody listening, is much cheaper than a real syscall - 
since the C library doesn&#39;t have to call a real syscall but can
just invoke some relatively cheap atomic operation.</p>
<h3 id="getpid">Getpid<a href="#getpid" title="Permanent link">¶</a></h3>
<p>The <code>getpid()</code> syscall is surprisingly fast on RHEL 7. It turns
out that RHEL 7 ships an <a href="https://manpath.be/f34/2/getpid#L43">older glibc version which caches the ID
of a process</a>! Which arguably is a curious optimization, since,
what&#39;s the point? I mean how often to you have to call
<code>getpid()</code> in a program, really? At some point (around Fedora 26)
this <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1469670">feature was removed</a> since it apparently caused more
<a href="https://yarchive.net/comp/linux/getpid_caching.html">trouble</a> than it&#39;s worth. Perhaps unsurprisingly, that
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1469670">removal</a> even <a href="https://xkcd.com/1172/">broke somebodies workflow</a>.</p>
<h3 id="real-syscalls">Real Syscalls<a href="#real-syscalls" title="Permanent link">¶</a></h3>
<p>So looking at the real syscalls, the user-kernel mode switches
cost in the order of a few hundred nanoseconds, on all hosts. The
higher costs on some hosts can be explained by CPU bug
mitigations being enabled (they are enabled by default) and/or
kind of older/lower-end hardware. See also the Hosts Section for
some details.</p>
<p>The fastest host is <code>xg6256</code> which manages to switch modes in
less than 100 ns. It has a fast CPU with good
single core performance (Xeon Gold 6256), has frequency scaling
disabled and runs at a constant 4.1 GHz frequency above it&#39;s base
frequency (i.e. a frequency between the base and turbo
frequency).</p>
<h3 id="sched-yield">Sched Yield<a href="#sched-yield" title="Permanent link">¶</a></h3>
<p>The <code>sched_yield()</code> syscall could be considered as a minimal work
syscall, e.g. when there is nothing to yield to. Also, the
benchmark process is running under the standard scheduling policy
and on Linux <a href="https://manpath.be/f34/2/sched_yield#L43"><code>sched_yield()</code> is described as</a>:</p>
<blockquote>
<p><code>sched_yield()</code> is  intended for use with real-time scheduling policies (i.e., <code>SCHED_FIFO</code> or <code>SCHED_RR</code>).
Use of <code>sched_yield()</code> with nondeterministic scheduling policies such as <code>SCHED_OTHER</code> is unspecified  and
very likely means your application design is broken.</p>
</blockquote>
<p>So unspecified could mean that the syscall just bails out after
the process&#39; scheduling policy compares equal to <code>SCHED_OTHER</code>.</p>
<p>On most hosts sched_yield 150 ns or so more expensive than a
really minimal syscall such as <code>getuid()</code> - which indicates some
more overhead, but not necessarily a context switch.</p>
<h3 id="nanosleep">Nanosleep<a href="#nanosleep" title="Permanent link">¶</a></h3>
<p>A bit out of the competition is the <code>nanosleep()</code> syscall:</p>


<table id="T_07822f0e_0988_11ec_9e32_f8cab850d072"><thead>    <tr>        <th>host</th>        <th>5i4250u</th>        <th>7i6600u</th>        <th>ac3758</th>        <th>x2643</th>        <th>x2667h</th>        <th>x2667s</th>        <th>x2687w</th>        <th>x2689</th>        <th>x2690</th>        <th>xg6144</th>        <th>xg6148</th>        <th>xg6246</th>        <th>xg6256</th>        <th>xg6256b</th>        <th>xs4110</th>    </tr>    <tr>        <th>name</th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>        <th></th>    </tr></thead><tbody>
                <tr>
                        <th id="T_07822f0e_0988_11ec_9e32_f8cab850d072level0_row0">nanosleep0</th>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col0">52632</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col1">50474</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col2">52620</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col3">50588</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col4">50003</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col5">50011</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col6">50000</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col7">50014</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col8">50312</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col9">50018</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col10">50000</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col11">50014</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col12">50000</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col13">50000</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row0_col14">54866</td>
            </tr>
            <tr>
                        <th id="T_07822f0e_0988_11ec_9e32_f8cab850d072level0_row1">nanosleep0_slack1</th>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col0">4355</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col1">2836</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col2">7076</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col3">3247</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col4">2736</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col5">2483</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col6">2835</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col7">3908</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col8">3401</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col9">2762</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col10">2870</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col11">2446</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col12">1974</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col13">2248</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row1_col14">3837</td>
            </tr>
            <tr>
                        <th id="T_07822f0e_0988_11ec_9e32_f8cab850d072level0_row2">nanosleep1_slack1</th>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col0">4348</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col1">2840</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col2">7102</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col3">3252</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col4">2736</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col5">2486</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col6">2834</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col7">3908</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col8">3410</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col9">2767</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col10">2871</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col11">2446</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col12">1975</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col13">2246</td>
                        <td id="T_07822f0e_0988_11ec_9e32_f8cab850d072row2_col14">3836</td>
            </tr>
    </tbody></table>

<p>Calling <code>nanosleep()</code> to sleep for 0 ns or 1 ns seemingly also is
a very cheap syscall or even a null operation.</p>
<p>However, in the first case it takes 50 µs an all hosts.
Incidentally, 50 µs is also the <a href="https://manpath.be/f34/2/prctl#L1052">default timer slack value</a>
for a normally scheduled process on Linux. The <a href="https://lwn.net/Articles/588086/">timer slack
mechanism</a> extends timer expirations up to the slack value in
order to group multiple timers since this reduces wake ups and
thus saves energy. And since <code>nanosleep()</code> creates a timer, it&#39;s
also affected by this mechanism.</p>
<p>Thus, the other nanosleep cases <a href="https://github.com/gsauthof/osjitter/blob/f1a4ca9cbf7516efc61c3bab2fe06ffe83cfb43c/bench_syscalls.cc#L117">set a minimal timer slack</a> of 1
ns which reduces the runtime, as expected. However, it&#39;s still
much more expensive than the other syscalls. Of course, a timer
expiration has a limited accuracy. However, with 0 ns or 1 ns no
timer has to be expired, really. It turns out that calling
<code>nanosleep()</code> unconditionally yields a (voluntary) <a href="https://en.wikipedia.org/wiki/Context_switch">context
switch</a>.  Even on isolated cores, where the scheduler happily
switches to the swapper kernel thread. Thus, the last two
nanonsleep cases really measure the context switch costs which
are more expensive than a simple mode switch.</p>
<p>The costs of a context switch match what <a href="https://eli.thegreenplace.net/2018/measuring-context-switching-and-memory-overheads-for-linux-threads/#how-expensive-are-context-switches">others are
measuring</a> (modulo division by two).</p>
<h2 id="hosts">Hosts<a href="#hosts" title="Permanent link">¶</a></h2>
<p>The following table shows the hosts under benchmark:</p>
<table>
  <thead>
    <tr>
      <th></th>
      <th>host</th>
      <th>CPU</th>
      <th>mitigations</th>
      <th>poll</th>
      <th>os</th>
      <th>kernel</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5i4250u</td>
      <td>Core i5-4250U</td>
      <td>yes</td>
      <td>yes</td>
      <td>Fedora 33</td>
      <td>5.12</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7i6600u</td>
      <td>Core i7-6600U</td>
      <td>yes</td>
      <td>yes</td>
      <td>Fedora 33</td>
      <td>5.13</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ac3758</td>
      <td>Atom C3758</td>
      <td>no</td>
      <td>yes</td>
      <td>Fedora 33</td>
      <td>5.13</td>
    </tr>
    <tr>
      <th>3</th>
      <td>x2643</td>
      <td>Xeon E5-2643 v2</td>
      <td>yes</td>
      <td>no</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>4</th>
      <td>x2667h</td>
      <td>Xeon E5-2667 v3</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>5</th>
      <td>x2667s</td>
      <td>Xeon E5-2667 v3</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>6</th>
      <td>x2687w</td>
      <td>Xeon E5-2687W v3</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>7</th>
      <td>x2689</td>
      <td>Xeon E5-2689 v4</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>8</th>
      <td>x2690</td>
      <td>Xeon E5-2690 0</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>xg6144</td>
      <td>Xeon Gold 6144</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>10</th>
      <td>xg6148</td>
      <td>Xeon Gold 6148</td>
      <td>no</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>11</th>
      <td>xg6246</td>
      <td>Xeon Gold 6246</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>12</th>
      <td>xg6256</td>
      <td>Xeon Gold 6256</td>
      <td>no</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>13</th>
      <td>xg6256b</td>
      <td>Xeon Gold 6256</td>
      <td>yes</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
    <tr>
      <th>14</th>
      <td>xs4110</td>
      <td>Xeon Silver 4110</td>
      <td>no</td>
      <td>yes</td>
      <td>RHEL 7</td>
      <td>3.10</td>
    </tr>
  </tbody>
</table>

<p>Notes:</p>
<ul>
<li>the kernels are the ones packaged by the distributions</li>
<li>most RHEL hosts are on RHEL 7.9</li>
<li>CPU mitigations are disabled via the <code>mitigations=off</code> kernel
  parameter or similar parameters</li>
<li>polling means that CPU frequency scaling and power saving is
  disabled via kernel parameters and tuned PM QoS settings</li>
<li>so the host&#39;s CPU runs on a fixed frequency; where possible this
  frequency is set slightly above the base frequency, e.g. on the
  Xeon Gold 6256 CPU it&#39;s set to 4.1 GHz</li>
<li>the Atom CPU doesn&#39;t support Hyperthreading and Hyperthreading
  is disabled on all Xeon hosts</li>
<li>all hosts have SELinux and/or Auditing enabled (on Fedora/RHEL these features are enabled by default) which adds some syscall overhead to some degree</li>
</ul>
<h2 id="terminology">Terminology<a href="#terminology" title="Permanent link">¶</a></h2>
<p>There are basically two important separate terms to distinguish
in the above discussion:</p>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Context_switch#User_and_kernel_mode_switching">Mode Switch</a> (or Mode Transition)</li>
<li><a href="https://en.wikipedia.org/wiki/Context_switch">Context Switch</a></li>
</ol>
<p>The definitions of these terms might vary in different literature
and different operating systems. Also, in other contexts (no pun
intended!) one might describe different modes as different
contexts. However, the definitions given in the linked Wikipedia
articles are widely used and apply to Linux.</p>
<p>Basically, a mode transition denotes the switch between user mode and
kernel mode (or between user space and kernel space) whereas a context switch
denotes a switch between different tasks, which is facilitated by
the kernel. A context switch requires more work than a mode
switch and thus is more expensive.</p>
<!-- /content -->
        </div>
      </div>
    </div></div>
  </body>
</html>
