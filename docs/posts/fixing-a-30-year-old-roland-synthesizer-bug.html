<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.vogons.org/viewtopic.php?t=86257">Original</a>
    <h1>Fixing a 30 year-old Roland synthesizer Bug</h1>
    
    <div id="readability-page-1" class="page"><div><p>In 2005, MT-32 music enthusiasts made known a discrepancy in the LFO rate of Roland&#39;s third-generation Linear Arithmetic synthesis implementation affecting both the CM-500 and CM-32LN modules, as well as the LAPC-N C-Bus boards.  This errant behavior noticeably manifests as a faster vibrato rate than that produced by the first and second-generation LA products.</p>

<p><u>Comparison #1:</u></p><ul>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/LFO_test-8098.flac"><u>CM-32L (MUNT)</u> - 356KB FLAC</a></li>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/LFO_test_CM500.flac"><u>CM-500</u> - 570KB FLAC</a></li></ul>

<p><u>Comparison #2:</u></p><ul>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/imm_32l.flac"><u>CM-32L</u> - 821KB FLAC</a></li>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/imm_500.flac"><u>CM-500</u> - 795KB FLAC</a></li></ul>

<p><u>Comparison #3:</u></p><ul>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/sq3_32l.flac"><u>CM-32L</u> - 1.35MB FLAC</a></li>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/sq3_500.flac"><u>CM-500</u> - 1.33MB FLAC</a></li></ul>


<p>These findings were brought to the attention of Roland Japan, who acknowledged the behavior as being unintentional, but who were unwilling/unable to investigate it further, as the ten-year support lifecycles of the affected products had elapsed.</p>

<p>Regrettably, but deservedly, the resulting improper playback of the CM-500 and CM-32LN modules has made them somewhat undesirable among enthusiasts, despite the allure of the former in combining both the CM-32L and SC-55 sound sources in a single device, and the battery-powered functionality of the latter.</p>

<p><span>15+ years later, there is now a solution.</span></p>

<p>In 2020, the LFO discussion was revived through the efforts and advice of Sergey Mikayev, or &#34;sergm,&#34; of <a href="https://github.com/munt/munt"><u>MUNT</u></a> renown.  While an initial analysis was inconclusive, Sergey later focused on the notable MCU change introduced in the third-generation LA architecture - from the 8098 to the 80C198 - and quickly discovered probable cause in an Intel publication describing MCU upgrade considerations [1].</p>

<p>Of pertinence is the following passage (where 8096/80C196 = 8098/80C198):</p>

<blockquote role="blockquote group" aria-label="Quote"><cite data-icon="quote"><span aria-hidden="true" data-icon-slot=""></span> wrote:</cite><p>First, some background on the 80C196 is needed. The opcode set is a true superset of the 8096, but some enhancements have been made to the peripherals and timings. The crystal is divided by 2 on the 80C196, instead of 3, as on the 8096. This means that the 80C196 running at 8 MHz will have a 250 ns state time, just like an 8096 running at 12 MHz.</p></blockquote>

<p>Sergey explained that several operations of Linear Arithmetic synthesis, including the software timers used to implement the LFO rate, are state time dependent.  Since the use of a 12 MHz crystal oscillator was maintained in the third-generation LA architecture, Roland&#39;s engineers may have simply failed to account for the reduction in state time (if it was even known) when they adapted the 8098 code for use with the 80C198. The consequence, of course, is the undesirable, &#34;faster&#34; behaviors.</p>

<p>In theory, this should be fixable in software, but where there are yet unknowns concerning some of the timer dependencies, the easiest solution seemed to be Intel&#39;s suggestion of simply running the MCU at 8 MHz to achieve the expected 250 ns state time.</p>

<p>The 12 MHz -&gt; 8 MHz crystal change was initially tested on a CM-32LN unit in mid 2021, where it became quickly apparent that MIDI communication was subsequently broken.  As further explained by the Intel documentation, the MCU clock change also requires modification of the serial baud rate divisor, which, in this application, is used for MIDI I/O.  Sergey identified this byte location[2], as well as two additional software timer values requiring modification, and a customized ROM binary was then written and swapped into the CM-32LN.  This proved successful and behaviorally correct, and a CM-500 unit was similarly modified thereafter.</p>

<p>Specific changes to the v1.00 CM-32LN control ROM  (as also used by the CM-500 and LAPC-N) are as follows:</p>

<div role="group" aria-label="Code" data-clipboard-source=""><pre><span><span aria-hidden="true">1</span><code role="code"><span role="text presentation">0x1A8D: 1D5Fh -&gt; 1388h<br/></span></code></span><span><span aria-hidden="true">2</span><code role="code"><span role="text presentation">0x215C: 17h -&gt; 0Fh<br/></span></code></span><span><span aria-hidden="true">3</span><code role="code"><span role="text presentation">0x216D: 1D5Fh -&gt; 1388h<br/></span></code></span></pre></div>

<p>The attached CM32LN_MOD.IPS file can be used to patch a dump of the <b>CM32LNv1.00</b> control ROM binary that has a CRC-32 value of <b>4A3BB4EF</b>.  Following application of the IPS patch, the ROM binary should reflect a CRC-32 value of <b>6E4CFF4A</b>.  (Note that control ROMs pertaining to the MT-32, CM-32L/64, LAPC-I, et al., cannot be adapted or used for this purpose.)</p>

<p>The result...?</p> 

<p><span>Playback that is arguably indistinguishable from that of a CM-32L.</span></p>

<p><u>Comparison #1:</u></p><ul>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/LFO_test-8098.flac"><u>CM-32L (MUNT)</u> - 356KB FLAC</a></li>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/LFO_test_CMmod.flac"><u>Modified CM-500</u> - 519KB FLAC</a></li></ul>

<p><u>Comparison #2:</u></p><ul>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/imm_32l.flac"><u>CM-32L</u> - 821KB FLAC</a></li>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/imm_mod.flac"><u>Modified CM-500</u> - 818KB FLAC</a></li></ul>

<p><u>Comparison #3:</u></p><ul>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/sq3_32l.flac"><u>CM-32L</u> - 1.35MB FLAC</a></li>
<li><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/audio/sq3_mod.flac"><u>Modified CM-500</u> - 1.35MB FLAC</a></li></ul>


<p>The physical modification itself is fairly straightforward, but with a noteworthy caveat concerning the CM-500.  Unlike the CM-32LN and LAPC-N, the LA mask ROM in the CM-500 is not socketed, and is instead soldered directly to the mainboard.  This chip will need to be removed, and should generally be replaced with a 28-pin socket.  If you&#39;ve never desoldered a ROM chip, or lack the appropriate tools to do so, you may want to enlist the aid of someone with that experience, as the vias and traces are easily damaged.</p>

<p>Socketing aside, only two hardware components are required:</p>


<p>Reference the following photos for the exact replacement locations:</p>

<p><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/images/cm-500_l.jpg"><img src="https://www.symphoniae.com/synth/Roland/CM-MOD/images/cm-500_s.jpg" referrerpolicy="no-referrer" alt="cm-500_s.jpg"/></a></p>

<hr/>

<p><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/images/cm-32ln_l.jpg"><img src="https://www.symphoniae.com/synth/Roland/CM-MOD/images/cm-32ln_s.jpg" referrerpolicy="no-referrer" alt="cm-32ln_s.jpg"/></a></p>

<hr/>

<p><a href="https://www.symphoniae.com/synth/Roland/CM-MOD/images/lapc-n_l.jpg"><img src="https://www.symphoniae.com/synth/Roland/CM-MOD/images/lapc-n_s.jpg" referrerpolicy="no-referrer" alt="lapc-n_s.jpg"/></a></p>

<hr/>

<p>Feedback is welcome and encouraged.</p>

<p><span><u>Technical References:</u></span></p></div><p><small>Last edited by <span><span role="text presentation">Cloudschatze</span></span> on 2022-02-10, 03:28. Edited 1 time in total.</small>
															</p></div>
  </body>
</html>
