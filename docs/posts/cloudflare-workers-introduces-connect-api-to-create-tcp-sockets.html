<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.infoq.com/news/2023/05/cloudflare-workers-connect-api/">Original</a>
    <h1>Cloudflare Workers Introduces Connect() API to Create TCP Sockets</h1>
    
    <div id="readability-page-1" class="page"><div>
								<p>During the recent <a href="https://www.cloudflare.com/developer-week/">developer week</a>, Cloudflare announced a Worker API to create outbound TCP sockets. The new socket API allows developers to connect back to TCP-based infra directly from a Worker, including databases.</p>

<p>Available as a Runtime API, the <a href="https://developers.cloudflare.com/workers/runtime-apis/tcp-sockets">connect()</a> function returns a TCP socket that allows developers to read and write data until the connection remains open. Workers could already interact with HTTP endpoints and other Cloudflare services, but the vast majority of databases require clients to connect by opening a direct TCP socket. <a href="https://www.linkedin.com/in/brendanirvinebroque/">Brendan Irvine-Broque</a>, product manager at Cloudflare, and <a href="https://www.linkedin.com/in/mattsilverlock/">Matt Silverlock</a>, director of product at Cloudflare, explain:</p>

<blockquote>
<p>With Workers, we aim to support standard APIs that are supported across browsers and non-browser environments wherever possible, (...) but for TCP sockets, we faced a challenge — there was no clear shared standard across runtimes. We’ve tried to incorporate the best elements of existing APIs and proposals, and intend to contribute back to future standards.</p>
</blockquote>

<p>Last autumn Cloudflare, together with Vercel and Shopify, <a href="https://blog.cloudflare.com/introducing-the-wintercg/">started WinterCG</a>, a new community group, focused on the interoperable implementation of standardized web APIs in non-web browser, javaScript-based development environments.</p>

<p>The new API is accessed by importing the connect function from <em>cloudflare:sockets</em>. One of the common use cases is to create a connection to a database, for example:</p>

<pre><code>import { Client } from &#34;pg&#34;;

export interface Env {
  DB: string;
}

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise&lt;Response&gt; {
    const client = new Client(env.DB);
    await client.connect();
    const result = await client.query({
      text: &#34;SELECT * from customers&#34;,
    });
    console.log(JSON.stringify(result.rows));
    const resp = Response.json(result.rows);
    // Close the database connection, but don&#39;t block returning the response
    ctx.waitUntil(client.end());
    return resp;
  },
};</code></pre>

<p><em>Source: https://blog.cloudflare.com/workers-tcp-socket-api-connect-databases/</em></p>

<p>While <em><a href="https://www.npmjs.com/package/pg">pg</a></em>, the JavaScript database driver for PostgreSQL, is already supported, the MySQL drivers <em>mysql</em> and <em>mysql2</em> are not supported yet. Irvine-Broque and Matt Silverlock warn:</p>

<blockquote>
<p>A new connection is created for every request. This is one of the biggest current challenges of connecting to databases from serverless functions, across all platforms (...) we’re already working on simpler approaches to connection pooling for the most popular databases.</p>
</blockquote>

<p>The content delivery network expects to add more features in the future, including support for inbound TCP and UDP connections, as <a href="https://twitter.com/BensTechLab/status/1658940529013563394">asked</a> by some developers, as well as application protocols based on QUIC.</p>

<p>The connect() API was not the only new feature announced during the Developer Week 2023: Cloudflare introduced <a href="https://blog.cloudflare.com/secrets-store/">Secrets Store</a>, a solution for managing application secrets securely, <a href="https://blog.cloudflare.com/d1-turning-it-up-to-11/">improvements to D1</a>, Cloudflare’s serverless database, and <a href="https://blog.cloudflare.com/messages-at-your-speed-with-concurrency-and-explicit-acknowledgement/">consumer concurrency</a> for the messaging service Queues. Furthermore, Cloudflare announced <a href="https://blog.cloudflare.com/announcing-database-integrations/">database integrations</a> for Neon, PlanetScale, and Supabase on Workers. Karl Horky, founder at UpLeveled, <a href="https://twitter.com/karlhorky/status/1658491685620559872">tweets</a>:</p>

<blockquote>
<p>No proxy like Neon or other serverless/edge providers, you just connect normally over TCP. This sounds great, potentially way bigger than the other recent edge database announcements.</p>
</blockquote>

<p>Each open TCP socket counts towards the maximum number of open connections that can be simultaneously open in Workers and TCP connections cannot be created on port 25 to send email to SMTP mail servers.</p>

								









  
    

							</div></div>
  </body>
</html>
