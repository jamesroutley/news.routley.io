<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jhftss.github.io/CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/">Original</a>
    <h1>Critical SIP Bypass Vulnerabilities in macOS PackageKit.framework</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>I found some <strong>new attack surfaces</strong> in the macOS <strong>PackageKit.framework</strong>, and successfully disclosed <strong>15+ critical SIP-Bypass</strong> vulnerabilities. Apple has addressed 12 of them <a href="https://jhftss.github.io/cvelist/">with CVE assigned</a> so far. There are still some reports in the Apple’s processing queue. All of them are interesting logic issues, and of course each has a successful exploit demonstration.</p>

<p>Here, <strong>CVE-2022-26712</strong> is a very simple one, which was patched in macOS 12.4. However, I found another way to exploit it again, finally Apple addressed it as <strong>CVE-2022-32826</strong> in macOS 12.5.</p>



<div><div><pre><code><span>sudo</span> /System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/shove <span>-X</span> /tmp/crafted.db /Library/Application<span>\ </span>Support/com.apple.TCC/TCC.db
</code></pre></div></div>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220517202824588.png" alt="image-20220517202824588"/></p>



<p><a href="https://en.wikipedia.org/wiki/System_Integrity_Protection">System Integrity Protection (SIP)</a>, aka rootless, is the last line to protect the entire system from malware. There are already some good write-ups about the security feature, so I don’t want to duplicate here. If you are not familiar with it, it is recommended to read the references part at the end of this blog.</p>

<p>Note: <strong>SIP Bypass</strong> always means the <strong>Full TCC Bypass</strong>. With the primitive of SIP Bypass, an attacker could replace the system config database <code>TCC.db</code> with a crafted one, to get full control of macOS <a href="http://i.blackhat.com/USA21/Wednesday-Handouts/US-21-Regula-20-Plus-Ways-to-Bypass-Your-macOS-Privacy-Mechanisms.pdf"><strong>TCC (Transparency, Consent, and Control)</strong></a>.</p>

<p>Moreover, an attacker could get <strong>arbitrary kernel code execution</strong> with the SIP-Bypass primitive. I did find a new way to do this on the <strong>macOS Monterey</strong>, but I couldn’t share the exploit here right now, because it is related to another unpatched 0-day.</p>



<p>The system XPC service <code>/System/Library/PrivateFrameworks/ShoveService.framework/Versions/A/XPCServices/SystemShoveService.xpc</code> has the entitlement <strong>com.apple.rootless.install</strong>, which grants the process permission to bypass SIP restrictions.</p>

<p>The service provides only one method to shove files from one place to another place :</p>

<div><div><pre><code><span>@interface</span> <span>PKShoveOptions</span> <span>:</span> <span>NSObject</span>
<span>-</span> <span>(</span><span>void</span><span>)</span> <span>setSourcePath</span><span>:(</span><span>NSURL</span> <span>*</span><span>)</span> <span>src</span><span>;</span>
<span>-</span> <span>(</span><span>void</span><span>)</span> <span>setDestPath</span><span>:(</span><span>NSURL</span> <span>*</span><span>)</span> <span>dst</span><span>;</span>
<span>-</span> <span>(</span><span>void</span><span>)</span> <span>setOptionFlags</span><span>:(</span><span>uint64_t</span><span>)</span> <span>flags</span><span>;</span>
<span>@end</span>

<span>@protocol</span> <span>SVShoveServiceProtocol</span>
<span>-</span> <span>(</span><span>void</span><span>)</span><span>shoveWithOptions</span><span>:(</span><span>PKShoveOptions</span> <span>*</span><span>)</span><span>options</span> <span>completionHandler</span><span>:(</span><span>id</span><span>)</span> <span>reply</span><span>;</span>
<span>@end</span>
</code></pre></div></div>

<p>However, there is no check for the incoming clients, and any process can fire the XPC request to the service:
<img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220225200252617.png" alt="image-20220225200252617"/></p>

<p>Therefore, we can abuse the service to bypass the <strong>SIP</strong> restriction.</p>

<p>After I implemented my own XPC client to exploit the issue, I found there was already an XPC client in the system:</p>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220414150345928.png" alt="image-20220414150345928"/></p>

<p>The option <strong>-X</strong> is used to communicate with the system XPC service.</p>

<p>And the option <strong>-x</strong> is used for the standard XPC service: <code>/System/Library/PrivateFrameworks/ShoveService.framework/Versions/A/XPCServices/StandardShoveService.xpc</code>, which has no entitlements.</p>

<p>The system XPC service isn’t running by default, and it will be launched by clients if required.</p>

<p><strong><em>If the client is running as root, then the service will also be launched as root. Otherwise the service will run as common user.</em></strong> Therefore, root privilege is required to exploit the issue.</p>



<ol>
  <li>Remove the framework <code>/System/Library/PrivateFrameworks/ShoveService.framework</code>, and of course the XPC service.</li>
  <li>For the system command <code>/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/Resources/shove</code>, remove the options <code>[-X|x]</code>.</li>
</ol>



<p>The patch above seems perfect, but is it enough ?</p>

<p>The old vulnerable XPC service is still signed with the special entitlement <strong>com.apple.rootless.install</strong>. If I can launch the old XPC service from the new OS, then it will be exploitable again, I think.</p>

<p>To prove my concept, I developed a new application from the Xcode template, with an XPC servcie inside the application bundle. Open the built application bundle directory, and replace the built XPC servcie bundle with the old vulnerable <strong>SystemShoveService.xpc</strong>. Finally, my application can launch the old XPC servcie and send malicious XPC requests to it to bypass SIP.</p>



<p>Now, it stops the old vulnerable XPC service from launching in the latest OS.</p>

<p>First, let’s look for some hints from Console log:</p>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726175745928.png" alt="image-20220726175745928"/></p>

<p>Then we will find it in the function <code>postValidation</code> from <strong>AppleMobileFileIntegrity.kext</strong> :</p>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726194456503.png" alt="image-20220726194456503"/></p>

<p>It adds a validation item for the specific identifier “com.apple.installandsetup.ShoveService.System” from its signature.</p>



<p>Note that there are many other application identifiers in the function <code>postValidation</code>! Especially the one at line 201: “com.apple.configd”.</p>

<p>After reading the blog post for <strong>CVE-2021-30970</strong> : <a href="https://www.microsoft.com/security/blog/2022/01/10/new-macos-vulnerability-powerdir-could-lead-to-unauthorized-user-data-access/">New macOS vulnerability, “powerdir,” could lead to unauthorized user data access</a>, I didn’t know how Apple fix it, but I could <strong>reproduce the issue on the patched macOS!</strong></p>

<p>In short, the system command <strong>/usr/libexec/configd</strong> has a special TCC entitlement: <strong>kTCCServiceSystemPolicySysAdminFiles</strong>, which grants the command permission to change a user’s home directory and forge the user’s database file <code>TCC.db</code>. An attacker could inject a malicious dylib into the process to enjoy the special TCC permission.</p>

<p>However, I found the command was still not signed with <a href="https://developer.apple.com/documentation/security/hardened_runtime?language=objc">hardened runtime</a> on the patched OS.</p>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726203441452.png" alt="image-20220726203441452"/></p>

<p>It means the system command was still injectable. <strong>The keypoint is moving the system command to another location and launching it.</strong></p>

<p>Fail to load the bundle:</p>

<p><code>sudo /usr/libexec/configd -d -v -t /tmp/test.bundle</code></p>

<p>Load the bundle successfully:</p>

<div><div><pre><code>cp /usr/libexec/configd /tmp
sudo /tmp/configd -d -v -t /tmp/test.bundle
</code></pre></div></div>

<p>If you are curious about the reason, I will write another blog post to uncover what happens under the hood.</p>

<p>Now in macOS 12.5, Apple patched the <strong>CVE-2021-30970</strong> again with two additional recognitions (No CVE assigned yet) :</p>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726204158434.png" alt="image-20220726204158434"/></p>

<p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726204223555.png" alt="image-20220726204223555"/></p>

<ol>
  <li>
    <p>Signed with <a href="https://developer.apple.com/documentation/security/hardened_runtime?language=objc">hardened runtime</a>:</p>

    <p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726203333656.png" alt="image-20220726203333656"/></p>
  </li>
  <li>
    <p>Stop the old vulnerable <strong>configd</strong> command from launching in the same function of AMFI.kext:</p>

    <p><img src="https://jhftss.github.io/res/2022-7-26-CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/image-20220726203713828.png" alt="image-20220726203713828"/></p>
  </li>
</ol>

<p><strong>Last but not the least, in the latest macOS Ventura Beta version, <a href="https://theevilbit.github.io/posts/amfi_launch_constraints/">Launch Constraints</a> defeats this kind of exploitation effectively.</strong></p>



<p>https://www.microsoft.com/security/blog/2021/10/28/microsoft-finds-new-macos-vulnerability-shrootless-that-could-bypass-system-integrity-protection/</p>

<p>https://perception-point.io/technical-analysis-of-cve-2022-22583-bypassing-macos-system-integrity-protection/</p>

<p>https://theevilbit.github.io/posts/amfi_launch_constraints/</p>


  </div></div>
  </body>
</html>
