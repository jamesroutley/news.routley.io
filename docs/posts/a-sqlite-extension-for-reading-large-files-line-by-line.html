<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/asg017/sqlite-lines">Original</a>
    <h1>A SQLite extension for reading large files line-by-line</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><code>sqlite-lines</code> is a SQLite extension for reading lines from a file or blob.</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://miccah.io/asg017/sqlite-lines/blob/main/benchmarks/calc.png"><img src="https://miccah.io/asg017/sqlite-lines/raw/main/benchmarks/calc.png" alt="Benchmark between sqlite-lines and various other data processing tools" width="600"/></a></p>
<p dir="auto">See <a href="https://miccah.io/asg017/sqlite-lines/blob/main/benchmarks">Benchmarks</a> for more info.</p>
<h2 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h2>
<div data-snippet-clipboard-copy-content=".load ./lines0
select line from lines_read(&#39;logs.txt&#39;);"><pre>.load .<span>/</span>lines0
<span>select</span> <span>line</span> <span>from</span> lines_read(<span><span>&#39;</span>logs.txt<span>&#39;</span></span>);</pre></div>
<p dir="auto"><code>sqlite-lines</code> is great for line-oriented datasets, like <a href="https://ndjson.org/" rel="nofollow">ndjson</a> or <a href="https://jsonlines.org/" rel="nofollow">JSON Lines</a>, when paired with SQLite&#39;s <a href="https://www.sqlite.org/json1.html" rel="nofollow">JSON support</a>. Here, we calculate the top 5 country participants in Google&#39;s <a href="https://quickdraw.withgoogle.com/data" rel="nofollow">Quick, Draw!</a> dataset for <a href="https://storage.googleapis.com/quickdraw_dataset/full/simplified/calendar.ndjson" rel="nofollow"><code>calendars.ndjson</code></a>:</p>
<div data-snippet-clipboard-copy-content="select
  line -&gt;&gt; &#39;$.countrycode&#39; as countrycode,
  count(*)
from lines_read(&#39;./calendar.ndjson&#39;)
group by 1
order by 2 desc
limit 5;
/*
┌─────────────┬──────────┐
│ countrycode │ count(*) │
├─────────────┼──────────┤
│ US          │ 141001   │
│ GB          │ 22560    │
│ CA          │ 11759    │
│ RU          │ 9250     │
│ DE          │ 8748     │
└─────────────┴──────────┘
*/"><pre><span>select</span>
  <span>line</span> <span>-</span><span>&gt;&gt;</span> <span><span>&#39;</span>$.countrycode<span>&#39;</span></span> <span>as</span> countrycode,
  <span>count</span>(<span>*</span>)
<span>from</span> lines_read(<span><span>&#39;</span>./calendar.ndjson<span>&#39;</span></span>)
<span>group by</span> <span>1</span>
<span>order by</span> <span>2</span> <span>desc</span>
<span>limit</span> <span>5</span>;
<span><span>/*</span></span>
<span>┌─────────────┬──────────┐</span>
<span>│ countrycode │ count(*) │</span>
<span>├─────────────┼──────────┤</span>
<span>│ US          │ 141001   │</span>
<span>│ GB          │ 22560    │</span>
<span>│ CA          │ 11759    │</span>
<span>│ RU          │ 9250     │</span>
<span>│ DE          │ 8748     │</span>
<span>└─────────────┴──────────┘</span>
<span><span>*/</span></span></pre></div>
<p dir="auto">Use the SQLite CLI&#39;s <a href="https://sqlite.org/cli.html#file_i_o_functions" rel="nofollow"><code>fsdir()</code></a> table functions with <code>lines_read()</code> to read lines from every file in a directory.</p>
<div data-snippet-clipboard-copy-content="select
  name as file,
  lines.rowid as line_number,
  line
from fsdir(&#39;logs&#39;)
join lines_read(name) as lines
where name like &#39;%.txt&#39;;
/*
┌─────────────────────┬──────┐
│ file  │ line_number | line │
├───────┼─────────────┤──────┤
| a.txt | 1           | x    |
| a.txt | 2           | y    |
| a.txt | 3           | z    |
| b.txt | 1           | xx   |
| b.txt | 2           | yy   |
| c.txt | 1           | xxx  |
└───────┴─────────────┴──────┘
*/"><pre><span>select</span>
  name <span>as</span> file,
  <span>lines</span>.<span>rowid</span> <span>as</span> line_number,
  <span>line</span>
<span>from</span> fsdir(<span><span>&#39;</span>logs<span>&#39;</span></span>)
<span>join</span> lines_read(name) <span>as</span> lines
<span>where</span> name <span>like</span> <span><span>&#39;</span>%.txt<span>&#39;</span></span>;
<span><span>/*</span></span>
<span>┌─────────────────────┬──────┐</span>
<span>│ file  │ line_number | line │</span>
<span>├───────┼─────────────┤──────┤</span>
<span>| a.txt | 1           | x    |</span>
<span>| a.txt | 2           | y    |</span>
<span>| a.txt | 3           | z    |</span>
<span>| b.txt | 1           | xx   |</span>
<span>| b.txt | 2           | yy   |</span>
<span>| c.txt | 1           | xxx  |</span>
<span>└───────┴─────────────┴──────┘</span>
<span><span>*/</span></span></pre></div>
<h2 dir="auto"><a id="user-content-documentation" aria-hidden="true" href="#documentation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Documentation</h2>
<p dir="auto">See <a href="https://miccah.io/asg017/sqlite-lines/blob/main/docs.md"><code>docs.md</code></a> for a full API Reference and detailed documentation.</p>
<h2 dir="auto"><a id="user-content-installing" aria-hidden="true" href="#installing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installing</h2>
<p dir="auto">The <a href="https://github.com/asg017/sqlite-lines/releases">Releases page</a> contains pre-built binaries for Linux amd64 and MacOS (amd64, no arm).</p>
<h3 dir="auto"><a id="user-content-as-a-loadable-extension" aria-hidden="true" href="#as-a-loadable-extension"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>As a loadable extension</h3>
<p dir="auto">If you want to use <code>sqlite-lines</code> as a <a href="https://www.sqlite.org/loadext.html" rel="nofollow">Runtime-loadable extension</a>, Download the <code>lines0.dylib</code> (for MacOS) or <code>lines0.so</code> file from a release and load it into your SQLite environment.</p>
<blockquote>
<p dir="auto"><strong>Note:</strong>
The <code>0</code> in the filename (<code>lines0.dylib</code> or <code>lines0.so</code>) denotes the major version of <code>sqlite-lines</code>. Currently <code>sqlite-lines</code> is pre v1, so expect breaking changes in future versions.</p>
</blockquote>
<p dir="auto">For example, if you are using the <a href="https://www.sqlite.org/cli.html" rel="nofollow">SQLite CLI</a>, you can load the library like so:</p>
<div data-snippet-clipboard-copy-content=".load ./lines0
select lines_version();
-- v0.0.1"><pre>.load .<span>/</span>lines0
<span>select</span> lines_version();
<span><span>--</span> v0.0.1</span></pre></div>
<p dir="auto">Or in Python, using the builtin <a href="https://docs.python.org/3/library/sqlite3.html" rel="nofollow">sqlite3 module</a>:</p>
<div data-snippet-clipboard-copy-content="import sqlite3

con = sqlite3.connect(&#34;:memory:&#34;)

con.enable_load_extension(True)
con.load_extension(&#34;./lines0&#34;)

print(con.execute(&#34;select lines_version()&#34;).fetchone())
# (&#39;v0.0.1&#39;,)"><pre><span>import</span> <span>sqlite3</span>

<span>con</span> <span>=</span> <span>sqlite3</span>.<span>connect</span>(<span>&#34;:memory:&#34;</span>)

<span>con</span>.<span>enable_load_extension</span>(<span>True</span>)
<span>con</span>.<span>load_extension</span>(<span>&#34;./lines0&#34;</span>)

<span>print</span>(<span>con</span>.<span>execute</span>(<span>&#34;select lines_version()&#34;</span>).<span>fetchone</span>())
<span># (&#39;v0.0.1&#39;,)</span></pre></div>
<p dir="auto">Or in Node.js using <a href="https://github.com/WiseLibs/better-sqlite3">better-sqlite3</a>:</p>
<div data-snippet-clipboard-copy-content="const Database = require(&#34;better-sqlite3&#34;);
const db = new Database(&#34;:memory:&#34;);

db.loadExtension(&#34;./lines0&#34;);

console.log(db.prepare(&#34;select lines_version()&#34;).get());
// { &#39;lines_version()&#39;: &#39;v0.0.1&#39; }"><pre><span>const</span> <span>Database</span> <span>=</span> <span>require</span><span>(</span><span>&#34;better-sqlite3&#34;</span><span>)</span><span>;</span>
<span>const</span> <span>db</span> <span>=</span> <span>new</span> <span>Database</span><span>(</span><span>&#34;:memory:&#34;</span><span>)</span><span>;</span>

<span>db</span><span>.</span><span>loadExtension</span><span>(</span><span>&#34;./lines0&#34;</span><span>)</span><span>;</span>

<span>console</span><span>.</span><span>log</span><span>(</span><span>db</span><span>.</span><span>prepare</span><span>(</span><span>&#34;select lines_version()&#34;</span><span>)</span><span>.</span><span>get</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>// { &#39;lines_version()&#39;: &#39;v0.0.1&#39; }</span></pre></div>
<p dir="auto">Or with <a href="https://datasette.io/" rel="nofollow">Datasette</a> (using the &#34;no filesystem&#34; version to limit security vulnerabilities):</p>
<div data-snippet-clipboard-copy-content="datasette data.db --load-extension ./lines_nofs0"><pre><code>datasette data.db --load-extension ./lines_nofs0
</code></pre></div>
<p dir="auto">Windows is not supported - <a href="https://github.com/asg017/sqlite-lines/issues/4" data-hovercard-type="issue" data-hovercard-url="/asg017/sqlite-lines/issues/4/hovercard">yet</a>!</p>
<h3 dir="auto"><a id="user-content-from-the-browser-with-wasmjavascript" aria-hidden="true" href="#from-the-browser-with-wasmjavascript"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>From the browser with WASM/JavaScript</h3>
<p dir="auto"><code>sqlite-lines</code> is also distributed as a standalone <a href="https://github.com/sql-js/sql.js">SQL.js</a> library. It&#39;s essentially a fork of the original SQL.js library, with the addition of <code>sqlite-lines</code> functions like <code>lines_version()</code> and <code>lines()</code>.</p>
<p dir="auto">Check out <a href="https://observablehq.com/@asg017/sqlite-lines-wasm" rel="nofollow">this Observable notebook</a> for the full demonstration. The <a href="https://github.com/asg017/sqlite-lines/releases">Releases page</a> contains the JavaScript and WASM files.</p>
<h3 dir="auto"><a id="user-content-the-sqlite-lines-cli" aria-hidden="true" href="#the-sqlite-lines-cli"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The sqlite-lines CLI</h3>
<p dir="auto"><code>sqlite-lines</code> comes with an example CLI modeled after <a href="https://github.com/mbostock/ndjson-cli">ndjson-cli</a> that demos the speed and versatility of <code>sqlite-lines</code>. Download a pre-compiled version from the <a href="https://github.com/asg017/sqlite-lines/releases">Releases page</a>, or build yourself with:</p>
<div data-snippet-clipboard-copy-content="make cli
./dist/sqlite-lines"><pre><code>make cli
./dist/sqlite-lines
</code></pre></div>
<p dir="auto">The <code>sqlite-lines</code> CLI reads data from stdin and applies transformations with SQL code through its arguments.</p>
<p dir="auto">The first argument should be a SQL expression that is used transform a single line from stdlin. The available columns are <code>rowid</code>, which is the &#34;line number&#34; that is being processed, and <code>d</code>, an alias for <code>line</code>, which is the text content of the current line (inspired by ndjson-cli). For example, to uppercase every line from a file with <a href="https://www.sqlite.org/lang_corefunc.html#upper" rel="nofollow"><code>upper()</code></a>:</p>
<div data-snippet-clipboard-copy-content="$ cat names.txt | sqlite-lines &#39;rowid || upper(d)&#39;
1ALEX
2BRIAN
3CRAIG"><pre>$ cat names.txt <span>|</span> sqlite-lines <span><span>&#39;</span>rowid || upper(d)<span>&#39;</span></span>
1ALEX
2BRIAN
3CRAIG</pre></div>
<p dir="auto">This includes SQLite&#39;s new JSON <code>-&gt;</code> and <code>-&gt;&gt;</code> operators for NDJSON/JSONL files:</p>
<div data-snippet-clipboard-copy-content="$ cat data.ndjson | sqlite-lines &#39;d -&gt;&gt; &#34;$.id&#34;&#39;
$ cat data.ndjson | sqlite-lines &#39;json_object(&#34;name&#34;, d -&gt;&gt; &#34;$.name&#34;, &#34;age&#34;: d -&gt;&gt; &#34;$.stats.age&#34;)&#39;"><pre>$ cat data.ndjson <span>|</span> sqlite-lines <span><span>&#39;</span>d -&gt;&gt; &#34;$.id&#34;<span>&#39;</span></span>
$ cat data.ndjson <span>|</span> sqlite-lines <span><span>&#39;</span>json_object(&#34;name&#34;, d -&gt;&gt; &#34;$.name&#34;, &#34;age&#34;: d -&gt;&gt; &#34;$.stats.age&#34;)<span>&#39;</span></span></pre></div>
<p dir="auto">The second argument is another SQL expression that&#39;s used in the WHERE statement of the underlying SQL query to filter out lines.</p>
<div data-snippet-clipboard-copy-content="# get the names of all people older than 40
cat data.ndjson | sqlite-lines &#39;d -&gt;&gt; &#34;$.name&#34;&#39; &#39;d -&gt;&gt; &#34;$.age&#34; &gt; 40&#39;"><pre><span><span>#</span> get the names of all people older than 40</span>
cat data.ndjson <span>|</span> sqlite-lines <span><span>&#39;</span>d -&gt;&gt; &#34;$.name&#34;<span>&#39;</span></span> <span><span>&#39;</span>d -&gt;&gt; &#34;$.age&#34; &gt; 40<span>&#39;</span></span></pre></div>
<p dir="auto">The third argument is another SQL expression that&#39;s used in the GROUP BY statement of the underlying SQL query to aggregate lines.</p>
<h3 dir="auto"><a id="user-content-a-note-on-csv-parsing" aria-hidden="true" href="#a-note-on-csv-parsing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>A Note on CSV Parsing</h3>
<p dir="auto"><code>sqlite-lines</code> isn&#39;t a great option for CSVs. Technically you can, but the moment your data has a <code>\n</code> character in a field or header, then you&#39;ll get corrupted results.</p>
<p dir="auto">Instead, you should use the &#34;official&#34; <a href="https://www.sqlite.org/csv.html" rel="nofollow">CSV Virtual Table</a>, or use the <a href="https://www.sqlite.org/cli.html#csv" rel="nofollow"><code>.import</code></a> command in the SQLite CLI.</p>
</article>
          </div></div>
  </body>
</html>
