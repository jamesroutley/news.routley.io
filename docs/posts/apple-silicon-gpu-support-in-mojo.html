<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://forum.modular.com/t/apple-silicon-gpu-support-in-mojo/2295">Original</a>
    <h1>Apple Silicon GPU Support in Mojo</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="text">
              <p>The latest nightly releases of Mojo (and our next stable release) include initial support for a new accelerator architecture: Apple Silicon GPUs!</p>
<p>We know that one of the biggest barriers to programming GPUs is access to hardware. It’s our hope that by making it possible to use Mojo to develop for a GPU present in every modern Mac, we can further democratize developing GPU-accelerated algorithms and AI models. This should also enable new paths of local-to-cloud development for AI models and more.</p>
<p>To get started, you need to have an Apple Silicon Mac (we support all M1 - M4 series chips) running macOS 15 or newer, with Xcode 16 or newer installed. The version of the Metal Shading Language we use (3.2, AIR bitcode version 2.7.0) needs the macOS 15 SDK, and you’ll get an error about incompatible bitcode versions if you run on an older macOS or use an older version of Xcode that doesn’t have the macOS 15 SDK.</p>
<p>You can clone our <a href="https://github.com/modular/modular"><code>modular</code></a> repository and try out one of our GPU function examples in the <code>examples/mojo/gpu-functions</code> directory. All but the <code>reduction.mojo</code> example should work on Apple Silicon GPUs today in the latest nightlies. Additionally, puzzles 1-15 of the <a href="https://puzzles.modular.com/introduction.html">Mojo GPU puzzles</a> should now work on Apple Silicon GPUs with the latest nightly. We haven’t yet updated the Pixi environment for the GPU puzzles to add Apple Silicon support, so for now you may need to run the Mojo code manually from another environment.</p>

<p>This is just the beginning of our support for Apple Silicon GPUs, and many pieces of functionality still need to be built out. Known features that don’t work today include:</p>
<ul>
<li>Intrinsics for many hardware capabilities
<ul>
<li>Not all Mojo GPU examples work, such as <code>reduction.mojo</code> and the more complex matrix multiplication examples</li>
<li>GPU puzzles 16 and above need more advanced hardware features</li>
</ul>
</li>
<li>Basic MAX graphs</li>
<li>MAX custom ops</li>
<li>PyTorch interoperability</li>
<li>Running AI models</li>
<li>Serving AI models</li>
</ul>
<p>I’ll emphasize that even simple MAX graphs, and by extension AI models, don’t yet run on Apple Silicon GPUs. In our Python APIs, <code>accelerator_count()</code> will still return 0 until we have basic MAX graph support enabled. Hopefully, that won’t be long.</p>

<p>We’ve identified many of the technical blockers to progressively enable the above. The current list of what we plan to work on includes:</p>
<ul>
<li>Handle <code>MAX_THREADS_PER_BLOCK_METADATA</code> and similar aliases</li>
<li>Support <code>GridDim</code>, <code>lane_id</code></li>
<li>Enable <code>async_copy_*</code></li>
<li>Convert arguments of an array type to a pointer type</li>
<li>Support <code>bfloat16</code> on ARM devices</li>
<li>Support <code>SubBuffer</code></li>
<li>Enable atomic operations</li>
<li>Complete implementation of <code>MetalDeviceContext::synchronize</code></li>
<li>Enable captured arguments</li>
<li>Support <code>print</code> and <code>debug_assert</code></li>
</ul>
<p>I apologize for some of the cryptic error messages you may get when hitting a piece of missing functionality, or encountering a system configuration we aren’t yet compatible with. We hope to improve the messaging over time, and to provide better guides for debugging failures.</p>

<p>To learn more about how Mojo code is compiled to target Apple Silicon GPUs, check out <a href="https://youtu.be/t2hAfgDYHoc?si=5X7E70xAi_eMjCMN&amp;t=1557">Amir Nassereldine’s detailed technical presentation from our recent Modular Community Meeting</a>. He did amazing work in establishing the fundamentals during his summer internship, and we are now building on that to advance Mojo on this new architecture.</p>
<p>In brief, a multi-step process is used to compile and run Mojo code on an Apple Silicon GPU. First, we compile Mojo GPU functions to Apple Intermediate Representation (AIR) bitcode. This is done through lowering to LLVM IR, and then specifically converting to Metal-compatible AIR.</p>
<p>Mojo handles interactions with an accelerator through the <code>DeviceContext</code> type. In the case of Apple Silicon GPUs, we’ve specialized this into a<code>MetalDeviceContext</code> that handles the next stages in compilation and execution.</p>
<p>The <code>MetalDeviceContext</code> uses the <a href="https://developer.apple.com/metal/cpp/">Metal-cpp API</a> to compile the AIR representation into a <code>.metallib</code> for execution on device. Once the <code>.metallib</code> is ready, the <code>MetalDeviceContext</code> manages a Metal <code>CommandQueue</code>, and buffers operations for moving data, running a GPU function, and more. All of this happens behind-the-scenes and a Mojo developer doesn’t need to worry about any of it.</p>
<p>Code that you’ve written to run on an NVIDIA or AMD GPUs should mostly just work on an Apple Silicon GPU, assuming no device-specific features were being used. Obviously, different patterns will be required to get the most performance out of each GPU, and we’re excited to explore this new optimization space on Apple Silicon GPUs with you.</p>

<p>While we’d love help in bringing up Apple Silicon GPU support, some of the infrastructure for introducing support for new AIR intrinsics and compiling them to a <code>.metallib</code> currently requires Modular developers for implementation. We’ll get more of the basics in place before work moves primarily to the open-source standard library and kernels, at which point community members will be able to do a lot more to advance compatibility. Contributions are always welcome, but we don’t want you to hit missing non-public components and get frustrated by being unable to move forward.</p>
<p>We’ll share much more documentation and content on how to work with and optimize for this new hardware family, but we’re extremely excited about even these first few steps onto Apple Silicon GPUs. I’ll to try to keep this post up to date as we expand functionality.</p>
            </div></div>
  </body>
</html>
