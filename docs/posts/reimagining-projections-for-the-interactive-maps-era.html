<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mapbox.com/blog/adaptive-projections">Original</a>
    <h1>Reimagining projections for the interactive maps era</h1>
    
    <div id="readability-page-1" class="page"><div><p>Last month, we <a href="https://www.mapbox.com/blog/mapbox-gl-js-v2-6">released Mapbox GL JS v2.6</a> with <strong>Adaptive Projections</strong> — a novel way to make interactive maps more accurate on a global scale, without any compromises to user experience, rendering quality or street-level precision.<br/></p><p>We have put a lot of thought into making this feature feel seamless and natural, so that our customers could adopt it on all kinds of map apps by adding one line of code. Let’s take a deep dive into why we did it, and how it works under the hood.</p><div>
<p><iframe src="https://player.vimeo.com/video/644024976?h=96bbb09cbc&amp;background=1&amp;autoplay=1&amp;loop=1&amp;title=0&amp;byline=0&amp;portrait=0" frameborder="0" allow="autoplay; fullscreen" allowfullscreen=""></iframe></p></div><h2>Introduction to map projections</h2><p>Any maps we see on either screen or paper use a certain <em>map projection</em> — a way to represent the globe on a flat surface. This has been a topic of research for at least several thousand years, ever since the ancient Greeks established that the Earth is a sphere. However, one thing is certain — there’s no perfect projection, and any way to map a sphere onto a plane inevitably leads to distortion (with a notable <a href="http://eulerarchive.maa.org/docs/translations/E490en.pdf">mathematical proof</a> by Euler from 1777).<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b23af486ac4d516c504049_projection-heads-dark.jpeg" loading="lazy" alt=""/></p><figcaption>Andy Woodruff’s projected heads, inspired by Charles Deetz’ 1921 book about map projections</figcaption></figure><p>All projections distort shapes, sizes or distances, so choosing one is a matter of trade-offs:<br/></p><ul role="list"><li>Some maps need to preserve relative sizes, so that nothing looks bigger than it actually is (e.g. using the <em>Albers projection</em> for country maps or <em>Equal Earth</em> for world maps), but achieving this also requires distorting shapes.</li><li>Some maps need to preserve shapes, which is especially important for navigation (<em>Mercator</em>) and aeronautical maps (<em>Lambert Conformal Conic</em>), but this distorts sizes.</li><li>Compromise projections try to balance both kinds of distortion — not too much shape distortion and not too much size distortion. They aim for something that “looks right”, and are often used for visualizations on world maps (<em>Winkel tripel</em>, <em>Natural Earth</em>).<br/></li></ul><p>The most famous such trade-off, one we all experience in our daily lives, happened at the dawn of web cartography, which adopted <em>Web Mercator</em> as the projection of choice. At the time, interactive maps were invented for street-level navigation, and Mercator is perfect for this — it preserves angles between lines, avoids stretching of shapes, and makes it so that north is up at any point. <br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b23cb6a1ad585f77408c14_nav.jpeg" loading="lazy" alt=""/></p><figcaption>Web Mercator is the best projection for street-level navigation</figcaption></figure><p>At the same time, Mercator heavily distorts sizes on a global scale, inflating shapes the farther away they are from the equator. This is why so many people living in the Internet era think that Greenland is as big as Africa, even though it&#39;s <em>14</em> <em>times</em> smaller:<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b23d4cc444613bf38da6e9_mercator-size.jpeg" loading="lazy" alt=""/></p><figcaption>The world in Web Mercator projection (Greenland is 14 times smaller than it appears)</figcaption></figure><h2>Projections on interactive maps</h2><p>Even though map projections are one of the fundamental concepts of cartography, adopting non-Mercator projections in interactive mapping has proven incredibly difficult. Despite many passionate campaigns by cartographers and mapping enthusiasts, Web Mercator remains dominant.<br/></p><p>One reason for this is that along with the projection, the maps industry adopted a corresponding tiling scheme, which starts with a Mercator-projected square tile on zoom 0, and splits each tile into four on every subsequent level. This simple and efficient format for distributing map data became ubiquitous.<br/></p><p>Consequently, to use another projection,all the data would have to be reprocessed into differently projected tiles, but this is enormously expensive — for example, Mapbox generates tiles for its base map styles up to zoom 16, which is 5.7+ billion tiles. Generating separate tile sets for each possible projection for every dataset would be impractical.<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b1fcc83d73bfac60f0e5b9_tile-scheme.jpg" loading="lazy" alt=""/></p><figcaption>Web Mercator tiling scheme, with 4^zoom tiles on each level</figcaption></figure><p>Reprojection of raster map tiles is often not an option because text labels would get distorted, and sharp lines and icons would become blurry.<br/></p><p>Another fundamental problem when applying map projections to an interactive map is that projections were designed for paper, and don’t work well when users can zoom between a world map and a street-level map. Projections that work well on a global scale are heavily distorted when zoomed in (as seen on this example of the Bay Area in Mollweide), and vice versa (Mercator).<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b23e1a5d0487a3a1c493c0_osm.jpeg" loading="lazy" alt=""/></p><figcaption>OpenStreetMap raster tiles in Mollweide projection on zoom 11</figcaption></figure><p>There was a <a href="http://berniejenny.info/pdf/2012_Jenny_AdaptiveCompositeMapProjections.pdf">remarkable attempt</a> at adapting map projections for interactive maps by Bernhard Jenny of Oregon State University in 2012. However, it unfortunately remained a proof of concept. The approach required reprojecting geometry on every rendering frame, which would be difficult to scale to modern vector rendering standards that often require rendering millions of points on the screen at once, while keeping compatibility with existing Mercator tiles. Additionally, interacting with a map that has abrupt projection changes may feel disorienting.<br/></p><div><p><iframe src="https://player.vimeo.com/video/47482303?h=c0512525ed" frameborder="0" allow="autoplay; fullscreen" allowfullscreen=""></iframe></p>
<figcaption>
Oregon State University’s Adaptive Composite Map Projections demo
</figcaption></div><p>Due to all these limitations, non-Mercator projections are a rare sight on regular web maps, instead being mostly confined to purpose-built <a href="https://observablehq.com/collection/@d3/d3-geo">D3-based visualizations</a>. Advancing vector rendering technology seemed like the only viable path towards wider adoption.</p><h2>Projections in Mapbox GL JS</h2><p>Ever since Mapbox changed the maps industry with the introduction of GL JS and its vector rendering technology, we were uniquely positioned to tackle this problem — perhaps <a href="https://github.com/mapbox/mapbox-gl-js/issues/3184">the most requested feature</a> in the project’s 8-year history.<br/></p><p>When we finally got to work on this, we wanted to do it <em>right</em>. This was our chance to make alternative projections so compelling that there would be no barriers to widespread adoption. And once you commit to a particular design of such a big and complex feature, it’s difficult to change afterwards, so this one shot had to count. We settled on the following guiding principles:<br/></p><ul role="list"><li>Compatibility with existing sources and styles, so that anyone can start using alternative projections right away on their Mapbox maps. This required loading Web Mercator tiles and reprojecting the data on the client.</li><li>Vector rather than raster reprojection to keep vector features rendering sharp and precise.</li><li>Dynamically adjusting the projection while zooming in to eliminate distortion.</li><li>Redefining what zoom and bearing mean to make switching to a different projection feel intuitive and seamless.</li><li>Zero overhead for rendering performance, so that maps with alternative projections feel as fast as our usual maps.</li></ul><h3>Projections and zoom level</h3><p>One of the first questions we asked when designing projections seems trivial: what does <em>zoom level</em> mean? Historically, for Mercator maps, zoom was defined as 0 for a map with a single tile containing the whole world, with each increment by 1 doubling the size.<br/></p><p>With a non-Mercator projection, both the tiles and the world are no longer axis-aligned squares, so we can’t rely on the same definition. But intuitively, we want the zoom value to reflect the scale of features on the map — so that regardless of the projection chosen, a certain map zoom and center configuration would make the map cover approximately the same area, with sizes of shapes relatively the same. We can do that we these steps:<br/></p><ol role="list"><li>Take an arbitrary area on the map as a reference point (e.g. a red square below).</li><li>Calculate its size in reprojected coordinates.</li><li>Calculate its size in Mercator coordinates.</li><li>Adjust the projected map scale so that these sizes match.</li></ol><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b1fb5924361cf3201ee2b3_size-two.png" loading="lazy" alt=""/></p><figcaption>Adjusting map scale so that the red square size is approximately the same for the same zoom</figcaption></figure><p>There’s just one catch — which point do we take as a reference? If we use the center of the map view, then the map will visibly zoom as you pan, which feels weird. And if we use a fixed point on the map (e.g. the center of the world), the size discrepancy will grow as the user moves away from that point.<br/></p><p>The solution we landed on combines these approaches:<br/></p><ul role="list"><li>On <strong>low</strong> zoom levels, use a fixed point (projection center). This way, the shape of the world remains the same &amp; doesn’t scale during panning.</li><li>On <strong>high</strong> zoom levels, use the center of the screen. Since panning is limited to a relatively small distance, any scale change will be unnoticeable.</li><li>On <strong>middle</strong> zoom levels, use both, smoothly transitioning between the two as the user moves from low to high zooms or back.<br/></li></ul><p>This makes designing maps for different projections and picking the right one a joy:<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b1eedf824fa00ebdf81932_DEBhNngtX81_qudkvwNKQ6lITypgMQFcTuFond-gBzqvs40cA0zy5Vd1SqbN9OfAdJUL-Cu1_IY4IGDms22DpqGFkjljAjw_0fpBRX8mh7-ePVtDQcv93lMaZtsuGgg4L6U2qY2B.gif" alt=""/></p><figcaption>Seamlessly switching between Mercator and US Albers in Mapbox Studio</figcaption></figure><h3>Projections and rotation</h3><p>Similarly to zoom, when using interactive maps, we have certain preconceived notions about how a map should be oriented. Conditioned by Mercator, we intuitively expect it to align to the north unless we rotate it. And we expect any given map view configuration (center, zoom and bearing) to have the same orientation regardless of projection.<br/></p><p>So we rotate the map automatically to match this intuition in a similar way to zoom:<br/></p><ul role="list"><li>On <strong>low</strong> zoom levels, orient the map so the north is straight up from the <em>projection center</em>. This way the map won’t rotate when panned.</li><li>On <strong>high</strong> zoom levels, orient the map so the north is straight up from the <em>screen center</em>. This way north is up like in Mercator regardless of which point on Earth is shown, and rotation during panning is unnoticeable.</li><li>On <strong>middle</strong> zoom levels, smoothly transition between the two approaches.<br/></li></ul><div><p><iframe src="https://player.vimeo.com/video/644028135?h=1e24466686&amp;background=1&amp;autoplay=1&amp;loop=1&amp;title=0&amp;byline=0&amp;portrait=0" frameborder="0" allow="autoplay; fullscreen" allowfullscreen=""></iframe></p>
<figcaption>
An extreme case of rotation correction: zooming to Alaska on an Albers polar projection
</figcaption></div><h3>Correcting distortion when zooming in</h3><p>After we apply the zoom and bearing adjustments above, one problem remains: when we zoom in, the map is noticeably skewed:<br/></p><div><p><iframe src="https://player.vimeo.com/video/654905758?h=4564158244&amp;background=1&amp;autoplay=1&amp;loop=1&amp;title=0&amp;byline=0&amp;portrait=0" frameborder="0" allow="autoplay; fullscreen" allowfullscreen=""></iframe></p>
<figcaption>Zooming to San Francisco on Winkel tripel projection without skew correction</figcaption></div><p>This is a natural property of non-conformal projections like Winkel tripel — it preserves relative sizes of shapes, but meridians and parallels are not perpendicular to each other, so shapes look distorted when zoomed in. How do we correct this?</p><p>When you&#39;re zoomed in enough, the view represents a nearly flat portion of the Earth. Consequently, alternative projections are no longer necessary, since you don&#39;t have to compromise between distorting shape or size. Notice how as the map zooms in, the curves representing meridians and parallels straighten out, approximating straight lines on higher zoom levels. We want to skew the map back so that these lines are perpendicular, and stretch it so that vertical and horizontal distances are equal. This will make the map conformal, matching it nearly perfectly with the Mercator projection. <br/></p><p>This skewing/stretching is called an <a href="https://en.wikipedia.org/wiki/Affine_transformation">affine transformation</a>, and it can be applied in real time on the GPU by correcting the WebGL view matrix. This way, we can apply the coordinate reprojection once when a tile loads, and then adjust the view of those coordinates as the user zooms without any performance overhead. It also feels much more natural when interacting with a map than more advanced transformations that twist and distort the view non-uniformly.<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b1eee01a52bef7faf589f6_O8ScNr0BeE99-eL14jpQBgLg1CYoK34HKP8jkV6JBLzNSpGTyXH9Gy6mJ1WAoqeMOqepvpCWUCGjxBFi6Oz3y0PMssQpyC4EZZRRK3DsqTA0VPXUoSuM-13FzTYoWYq0c5URdlt4.png" alt=""/></p><figcaption>Inverse shear (from green to blue), a special case of affine transformation (<a href="https://en.wikipedia.org/wiki/Shear_mapping">source</a>)</figcaption></figure><p>We do this the same way as with previous corrections — no adjustment on low zoom levels, then smoothly transitioning to full correction as the user zooms in, giving the best of both worlds:<em>‍</em></p><div><p><iframe src="https://player.vimeo.com/video/654905725?h=8bd15eabaf&amp;background=1&amp;autoplay=1&amp;loop=1&amp;title=0&amp;byline=0&amp;portrait=0" frameborder="0" allow="autoplay; fullscreen" allowfullscreen=""></iframe></p>
<figcaption>Zooming to San Francisco on Winkel tripel projection with skew correction</figcaption></div><h3>Tile loading changes</h3><p>Due to rotation, pitch, and more recently 3D terrain features, the code responsible for deciding which tiles to load is quite convoluted. With projections, it gets even more complex: tiles are no longer perfect squares, instead taking various shapes depending on the projection used.<br/></p><p>Moreover, since some tiles of the same zoom level can become large, and others small when reprojected, we adapted the tile loading logic, fetching tiles of different zoom levels on the same view depending on their size.<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b23f83a493545890e58e0c_imgonline-com-ua-Resize-LYVoaD0NgShky2p.jpeg" loading="lazy" alt=""/></p><figcaption>Tiles loaded on a map in the Albers USA projection</figcaption></figure><h3>Resampling vector geometry</h3><p>When we reproject vector tile data from Mercator to another projection, it’s not enough to calculate new coordinate values — line and polygon segments that were previously straight might become curved, so we need to add more points in between to follow the curve. Add too many, and rendering performance would be impacted. Add too few, and the lines wouldn&#39;t match the projection.<br/></p><p>We find a balance with an adaptive algorithm — adding a point in the middle of a line segment, then in the middle of the newly created two segments, and continuing recursively until each segment approximates the curve with sufficient precision. It is very similar to the popular <a href="https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm">Douglas-Peucker polyline simplification algorithm</a>, but in reverse. This approach allows us to render reprojected geometry accurately with only 2–3% additional points on a typical map.</p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b1fbe0cd293b5658d09604_curve.png" loading="lazy" alt=""/></p><figcaption>A straight line that became curved after reprojection, resampled with additional points</figcaption></figure><h3>Reprojecting raster tiles</h3><p>To render raster tiles such as the satellite layer in alternative projections, we need to load Mercator images and then map them to the distorted tile shapes. To do that in WebGL, we need to split the tiles into many little triangles, with each triangle responsible for representing a tiny part of the image. Generally, the less triangles there are, the faster the rendering.<br/></p><p>2 years ago, <a href="https://observablehq.com/@mourner/martin-real-time-rtin-terrain-mesh">we introduced MARTINI</a> — an open source library for real-time generation of 3D terrain meshes from raster heightmaps, with an accompanying interactive article describing how it works in detail. As it turned out, we can use exactly the same approach to generate triangular meshes for reprojecting <em>raster tiles</em>. Only instead of measuring how well individual triangle edges approximate terrain (to decide whether to split them further), we measure how curved an edge becomes with reprojection.<br/></p><p>This results in a triangular mesh in which less distorted regions have less triangles, and more distorted regions have more:<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b23fed5c3b18f1e0e5414a_martini-reprojection.png" loading="lazy" alt=""/></p><figcaption>A MARTINI reprojection mesh for the 0/0/0 tile of the Equal Earth projection</figcaption></figure><h3>Get started with Adaptive Projections</h3><p>As a result, your fast, beautiful and detailed interactive Mapbox maps can now be effortlessly used in alternative projections. Thank you for reading!<br/></p><p>Play with the new feature on <a href="https://docs.mapbox.com/mapbox-gl-js/example/projections/">this demo</a>, check out the <a href="https://docs.mapbox.com/mapbox-gl-js/example/map-projection/">minimal example</a> and <a href="https://docs.mapbox.com/mapbox-gl-js/guides/projections/">documentation</a>, try it out on your maps (either with code or <a href="https://studio.mapbox.com/">Mapbox Studio</a>), and let us know if you run into any issues. And look out for another awesome upcoming feature the Mapbox community has been longing for years:<br/></p><figure><p><img src="https://assets-global.website-files.com/5f2a93fe880654a977c51043/61b1febaa66c7e54740fa5e5_globe.png" loading="lazy" alt=""/></p></figure><h3>Bonus: bloopers</h3><p>Development of such complex features never goes smoothly, but on the upside, there’s a lot of accidental art to enjoy (our team has a separate <strong>#lol-gl</strong> Slack channel for sharing these):<br/></p></div><p><em>Maps feature data from </em><a href="https://www.mapbox.com/about/maps" target="_blank"><em>Mapbox</em></a><em> © Mapbox, </em><a href="https://www.openstreetmap.org/copyright" target="_blank"><em>OpenStreetMap</em></a><em> © OpenStreetMap and their data partners, including </em><a href="https://www.maxar.com/" target="_blank"><em>Maxar</em></a><em> (if applicable, © Maxar).</em></p></div>
  </body>
</html>
