<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://deno.com/blog/deploy-streams">Original</a>
    <h1>Web Streams at the Edge</h1>
    
    <div id="readability-page-1" class="page"><div><p><a href="https://deno.com/blog/deno-on-mdn" rel="noopener noreferrer">At Deno we take web standards very seriously</a>. A consequence
of this is that Deno Deploy has excellent support for <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API" rel="noopener noreferrer">Web Streams</a>
(also called &#34;Standard Streams&#34;). With Deno Deploy it&#39;s possible to build a
streaming, event-driven server in a few lines of JavaScript (or TypeScript) and
deploy it to
<a href="https://deno.com/deploy/docs/regions" rel="noopener noreferrer">data centers in 28 world-wide regions</a>
instantly.</p>
<p>Let&#39;s take a look at how far browser standards have come server-side...</p>
<h3 id="basic-http-proxy"><a aria-hidden="true" tabindex="-1" href="#basic-http-proxy"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Basic HTTP Proxy</h3><p>When building an HTTP proxy, it&#39;s important to not buffer the body. That would
induce both more memory usage and slower response times. Instead you want to
stream the HTTP message&#39;s body through the server back to the client.</p>
<p><a href="https://deno.com/deploy/docs/examples#proxy-requests" rel="noopener noreferrer">This is a straightforward example</a>:</p>
<div><pre><span>import</span> <span>{</span> serve <span>}</span> <span>from</span> <span>&#34;https://deno.land/std@0.114.0/http/server.ts&#34;</span><span>;</span>

<span>async</span> <span>function</span> <span>handler</span><span>(</span>req<span>:</span> Request<span>)</span><span>:</span> <span>Promise</span><span>&lt;</span>Response<span>&gt;</span> <span>{</span>
  <span>const</span> url <span>=</span> <span>new</span> <span><span>URL</span></span><span>(</span>req<span>.</span>url<span>)</span><span>;</span>
  url<span>.</span>protocol <span>=</span> <span>&#34;https:&#34;</span><span>;</span>
  url<span>.</span>hostname <span>=</span> <span>&#34;example.com&#34;</span><span>;</span>
  url<span>.</span>port <span>=</span> <span>&#34;443&#34;</span><span>;</span>
  <span>return</span> <span>await</span> <span>fetch</span><span>(</span>url<span>.</span>href<span>,</span> <span>{</span>
    headers<span>:</span> req<span>.</span>headers<span>,</span>
    method<span>:</span> req<span>.</span>method<span>,</span>
    body<span>:</span> req<span>.</span>body<span>,</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>

<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Listening on http://localhost:8000&#34;</span><span>)</span><span>;</span>
<span>serve</span><span>(</span>handler<span>)</span><span>;</span></pre></div><p>You can access this proxy server at <a href="https://example-proxy-requests.deno.dev/" rel="noopener noreferrer">https://example-proxy-requests.deno.dev/</a> or
fork the code at <a href="https://dash.deno.com/playground/example-proxy-requests" rel="noopener noreferrer">https://dash.deno.com/playground/example-proxy-requests</a></p>
<h3 id="http-proxy-with-transform"><a aria-hidden="true" tabindex="-1" href="#http-proxy-with-transform"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>HTTP Proxy with Transform</h3><p>What if we wanted to modify the data passing through the proxy? In the following
example we process the body, packet by packet, making text upper case with the
aid of <a href="https://developer.mozilla.org/en-US/docs/Web/API/TransformStream" rel="noopener noreferrer"><code>TransformStream</code></a>,
<a href="https://developer.mozilla.org/en-US/docs/Web/API/TextDecoderStream" rel="noopener noreferrer"><code>TextDecoderStream</code></a>, and
<a href="https://developer.mozilla.org/en-US/docs/Web/API/TextEncoderStream" rel="noopener noreferrer"><code>TextEncoderStream</code></a>.</p>
<div><pre><span>import</span> <span>{</span> serve <span>}</span> <span>from</span> <span>&#34;https://deno.land/std@0.116.0/http/server.ts&#34;</span><span>;</span>

<span>serve</span><span>(</span><span>async</span> <span>(</span>req<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> url <span>=</span> <span>new</span> <span><span>URL</span></span><span>(</span>req<span>.</span>url<span>)</span><span>;</span>
  url<span>.</span>protocol <span>=</span> <span>&#34;https:&#34;</span><span>;</span>
  url<span>.</span>hostname <span>=</span> <span>&#34;example.com&#34;</span><span>;</span>
  url<span>.</span>port <span>=</span> <span>&#34;443&#34;</span><span>;</span>
  <span>const</span> resp <span>=</span> <span>await</span> <span>fetch</span><span>(</span>url<span>.</span>href<span>)</span><span>;</span>

  <span>const</span> bodyUpperCase <span>=</span> resp<span>.</span>body
    <span>.</span><span>pipeThrough</span><span>(</span><span>new</span> <span>TextDecoderStream</span><span>(</span><span>)</span><span>)</span>
    <span>.</span><span>pipeThrough</span><span>(</span>
      <span>new</span> <span>TransformStream</span><span>(</span><span>{</span>
        <span>transform</span><span>:</span> <span>(</span>chunk<span>,</span> controller<span>)</span> <span>=&gt;</span> <span>{</span>
          controller<span>.</span><span>enqueue</span><span>(</span>chunk<span>.</span><span>toUpperCase</span><span>(</span><span>)</span><span>)</span><span>;</span>
        <span>}</span><span>,</span>
      <span>}</span><span>)</span><span>,</span>
    <span>)</span>
    <span>.</span><span>pipeThrough</span><span>(</span><span>new</span> <span>TextEncoderStream</span><span>(</span><span>)</span><span>)</span><span>;</span>

  <span>return</span> <span>new</span> <span>Response</span><span>(</span>bodyUpperCase<span>,</span> <span>{</span>
    status<span>:</span> resp<span>.</span>status<span>,</span>
    headers<span>:</span> resp<span>.</span>headers<span>,</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>

<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Listening on http://localhost:8000&#34;</span><span>)</span><span>;</span></pre></div><p>You can access this server at <a href="https://example-proxy-upper-case.deno.dev/" rel="noopener noreferrer">https://example-proxy-upper-case.deno.dev/</a> or fork
the code at <a href="https://dash.deno.com/playground/example-proxy-upper-case" rel="noopener noreferrer">https://dash.deno.com/playground/example-proxy-upper-case</a></p>
<h3 id="server-sent-events"><a aria-hidden="true" tabindex="-1" href="#server-sent-events"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Server-Sent Events</h3><p>Of course, you don&#39;t need a proxy to make use of streams. What if one wanted to
build a server which responded with a message every second? This can be achieved
by combining <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream" rel="noopener noreferrer"><code>ReadableStream</code></a> with
<a href="https://developer.mozilla.org/en-US/docs/Web/API/setInterval" rel="noopener noreferrer"><code>setInterval</code></a>.</p>
<p>Additionally, by setting the content-type to <code>text/event-stream</code> and prefixing
each message with <code>&#34;data: &#34;</code>, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events" rel="noopener noreferrer">Server-Sent Events</a> make for easy processing
using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource" rel="noopener noreferrer"><code>EventSource</code></a> API.</p>
<p>Access this live at <a href="https://server-sent-events.deno.dev/" rel="noopener noreferrer">https://server-sent-events.deno.dev/</a> or fork the code at
<a href="https://dash.deno.com/playground/server-sent-events" rel="noopener noreferrer">https://dash.deno.com/playground/server-sent-events</a></p>
<div><pre><span>import</span> <span>{</span> serve <span>}</span> <span>from</span> <span>&#34;https://deno.land/std@0.116.0/http/server.ts&#34;</span><span>;</span>

<span>const</span> msg <span>=</span> <span>new</span> <span>TextEncoder</span><span>(</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>&#34;data: hello\r\n&#34;</span><span>)</span><span>;</span>

<span>serve</span><span>(</span><span>async</span> <span>(</span>_<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>let</span> timerId<span>:</span> <span>number</span> <span>|</span> <span>undefined</span><span>;</span>
  <span>const</span> body <span>=</span> <span>new</span> <span>ReadableStream</span><span>(</span><span>{</span>
    <span>start</span><span>(</span>controller<span>)</span> <span>{</span>
      timerId <span>=</span> <span>setInterval</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
        controller<span>.</span><span>enqueue</span><span>(</span>msg<span>)</span><span>;</span>
      <span>}</span><span>,</span> <span>1000</span><span>)</span><span>;</span>
    <span>}</span><span>,</span>
    <span>cancel</span><span>(</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>typeof</span> timerId <span>===</span> <span>&#34;number&#34;</span><span>)</span> <span>{</span>
        <span>clearInterval</span><span>(</span>timerId<span>)</span><span>;</span>
      <span>}</span>
    <span>}</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
  <span>return</span> <span>new</span> <span>Response</span><span>(</span>body<span>,</span> <span>{</span>
    headers<span>:</span> <span>{</span>
      <span>&#34;Content-Type&#34;</span><span>:</span> <span>&#34;text/event-stream&#34;</span><span>,</span>
    <span>}</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>

<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Listening on http://localhost:8000&#34;</span><span>)</span><span>;</span></pre></div><p>Note that because Deno Deploy uses HTTP/2, SSE does not suffer from the browsers
maximum open connections (6) limit that makes SSE over HTTP/1.1 unwise.</p>
<h3 id="websockets"><a aria-hidden="true" tabindex="-1" href="#websockets"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WebSockets</h3><p>Deno Deploy also has support for WebSocket connections. WebSockets are not part
of the Stream API, but the use-cases have a large overlap.</p>
<p>There is not yet a standard API for server-side websockets, so for this you must
reach inside the <code>Deno</code> namespace for
<a href="https://doc.deno.land/builtin/stable#Deno.upgradeWebSocket" rel="noopener noreferrer">Deno.upgradeWebSocket</a>:</p>
<div><pre><span>import</span> <span>{</span> serve <span>}</span> <span>from</span> <span>&#34;https://deno.land/std@0.114.0/http/server.ts&#34;</span><span>;</span>

<span>serve</span><span>(</span><span>(</span>req<span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> upgrade <span>=</span> req<span>.</span>headers<span>.</span><span>get</span><span>(</span><span>&#34;upgrade&#34;</span><span>)</span> <span>||</span> <span>&#34;&#34;</span><span>;</span>
  <span>if</span> <span>(</span>upgrade<span>.</span><span>toLowerCase</span><span>(</span><span>)</span> <span>!=</span> <span>&#34;websocket&#34;</span><span>)</span> <span>{</span>
    <span>return</span> <span>new</span> <span>Response</span><span>(</span><span>&#34;request isn&#39;t trying to upgrade to websocket.&#34;</span><span>)</span><span>;</span>
  <span>}</span>
  <span>const</span> <span>{</span> socket<span>,</span> response <span>}</span> <span>=</span> Deno<span>.</span><span>upgradeWebSocket</span><span>(</span>req<span>)</span><span>;</span>
  socket<span>.</span><span>onopen</span> <span>=</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;socket opened&#34;</span><span>)</span><span>;</span>
  socket<span>.</span><span>onmessage</span> <span>=</span> <span>(</span>e<span>)</span> <span>=&gt;</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;socket message:&#34;</span><span>,</span> e<span>.</span>data<span>)</span><span>;</span>
    socket<span>.</span><span>send</span><span>(</span><span>new</span> <span>Date</span><span>(</span><span>)</span><span>.</span><span>toString</span><span>(</span><span>)</span><span>)</span><span>;</span>
  <span>}</span><span>;</span>
  socket<span>.</span><span>onerror</span> <span>=</span> <span>(</span>e<span>)</span> <span>=&gt;</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;socket errored:&#34;</span><span>,</span> e<span>.</span>message<span>)</span><span>;</span>
  socket<span>.</span><span>onclose</span> <span>=</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;socket closed&#34;</span><span>)</span><span>;</span>
  <span>return</span> response<span>;</span>
<span>}</span><span>)</span><span>;</span>

<span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;Listening on http://localhost:8000&#34;</span><span>)</span><span>;</span></pre></div><p>Access this live at <a href="https://websocket.deno.dev/" rel="noopener noreferrer">https://websocket.deno.dev/</a> or fork the code at
<a href="https://dash.deno.com/playground/websocket" rel="noopener noreferrer">https://dash.deno.com/playground/websocket</a></p>
<h2 id="whats-next"><a aria-hidden="true" tabindex="-1" href="#whats-next"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What&#39;s next?</h2><p>Check out the <a href="https://deno.com/deploy/docs/examples" rel="noopener noreferrer">examples gallery</a> and
<a href="https://deno.com/deploy/docs" rel="noopener noreferrer">documentation</a> for more.</p>
<p>Deno Deploy is currently in beta and free to all. If you do try it out, please
help by <a href="https://github.com/denoland/deploy_feedback" rel="noopener noreferrer">sending us some feedback</a>.</p>
</div></div>
  </body>
</html>
