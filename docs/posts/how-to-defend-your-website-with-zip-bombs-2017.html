<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.haschek.at/2017/how-to-defend-your-website-with-zip-bombs.html">Original</a>
    <h1>How to defend your website with ZIP bombs (2017)</h1>
    
    <div id="readability-page-1" class="page"><article>
                    <div>
                        <div>
                            <div id="post-wrapper">
                            <p>[update] I&#39;m on some list now that I have written an article about some kind of &#34;bomb&#34;, ain&#39;t I?</p>
<hr/>
<p>If you have ever hosted a website or even administrated a server you&#39;ll be very well aware of bad people <em>trying</em> bad things with your stuff.</p>
<p>When I first hosted my own little linux box with SSH access at age 13 I read through the logs daily and report the IPs (mostly from China and Russia) who tried to connect to my sweet little box (which was actually an old ThinkPad T21 with a broken display running under my bed) to their ISPs.</p>
<p>Actually if you have a linux server with SSH exposed you can see how many connection attempts are made every day:</p>
<pre><code>grep &#39;authentication failures&#39; /var/log/auth.log</code></pre>
<figure><img loading="lazy" src="https://www.pictshare.net/u1ath9io4n.jpg"/><figcaption>Hundreds of failed login attempts even though this server has disabled password authentication and runs on a non-standard port</figcaption></figure>

<p>Ok to be honest, web vulnerability scanners have existed before Wordpress but since WP is so widely deployed most web vuln scanners include scans for some misconfigured wp-admin folders or unpatched plugins.</p>
<p>So if a small, new hacking group wants to gain some hot cred they&#39;ll download <a href="https://wpscan.org/">one</a> of <a href="https://github.com/sullo/nikto">these</a> scanner <a href="http://rgaucher.info/beta/grabber/">things</a> and start testing against many websites in hopes of gaining access to a site and <a href="https://en.wikipedia.org/wiki/Website_defacement">defacing</a> it.</p>
<figure><img loading="lazy" src="https://www.pictshare.net/8c7cbrxql5.jpg"/><figcaption>Sample of a log file during a scan using the tool Nikto</figcaption></figure>
<p>This is why all server or website admins have to deal with gigabytes of logs full with scanning attempts. So I was wondering..</p>

<p>After going through some potential implementations with <a href="https://en.wikipedia.org/wiki/Intrusion_detection_system">IDS</a> or <a href="https://en.wikipedia.org/wiki/Fail2ban">Fail2ban</a> I remembered the old <a href="https://en.wikipedia.org/wiki/Zip_bomb">ZIP bombs</a> from the old days.</p>
<h2>WTH is a ZIP bomb?</h2>
<p>So it turns out ZIP compression is really good with repetitive data so if you have a really huge text file which consists of repetitive data like all zeroes, it will compress it really good. Like REALLY good.</p>
<p>As <a href="http://www.unforgettable.dk/">42.zip</a> shows us it can compress a 4.5 peta byte (4.500.000  giga bytes) file down to 42 kilo bytes. When you try to actually look at the content (extract or decompress it) then you&#39;ll most likely run out of disk space or RAM.</p>
<h2>How can I ZIP bomb a vuln scanner?</h2>
<p>Sadly, web browsers don&#39;t understand ZIP, but they do understand GZIP.</p>
<p>So firstly we&#39;ll have to create the 10 giga byte GZIP file filled with zeroes. We could make multiple compressions but let&#39;s keep it simple for now.</p>
<pre><code>dd if=/dev/zero bs=1M count=10240 | gzip &gt; 10G.gzip</code></pre>
<figure><img loading="lazy" src="https://www.pictshare.net/es8b6god0j.jpg"/><figcaption>Creating the bomb and checking its size</figcaption></figure>
<p>As you can see it&#39;s 10 MB large. We could do better but good enough for now.</p>
<p>Now that we have created this thing, let&#39;s set up a PHP script that will deliver it to a client.</p>
<pre><code>&lt;?php
//prepare the client to recieve GZIP data. This will not be suspicious
//since most web servers use GZIP by default
header(&#34;Content-Encoding: gzip&#34;);
header(&#34;Content-Length: &#34;.filesize(&#39;10G.gzip&#39;));
//Turn off output buffering
if (ob_get_level()) ob_end_clean();
//send the gzipped file to the client
readfile(&#39;10G.gzip&#39;);</code></pre>
<p>That&#39;s it!</p>
<p>So we could use this as a simple defense like this:</p>
<pre><code>&lt;?php
$agent = filter_input(INPUT_SERVER, &#39;HTTP_USER_AGENT&#39;);

//check for nikto, sql map or &#34;bad&#34; subfolders which only exist on wordpress
if (strpos($agent, &#39;nikto&#39;) !== false || strpos($agent, &#39;sqlmap&#39;) !== false || startswith($url,&#39;wp-&#39;) || startswith($url,&#39;wordpress&#39;) || startswith($url,&#39;wp/&#39;))
{
      sendBomb();
      exit();
}

function sendBomb(){
        //prepare the client to recieve GZIP data. This will not be suspicious
        //since most web servers use GZIP by default
        header(&#34;Content-Encoding: gzip&#34;);
        header(&#34;Content-Length: &#34;.filesize(&#39;10G.gzip&#39;));
        //Turn off output buffering
        if (ob_get_level()) ob_end_clean();
        //send the gzipped file to the client
        readfile(&#39;10G.gzip&#39;);
}

function startsWith($a, $b) { 
    return strpos($a, $b) === 0;
}</code></pre>
<p>This script obviously is not - as we say in Austria - the yellow of the egg, but it can defend from script kiddies I mentioned earlier who have no idea that all these tools have parameters to change the user agent.</p>
<h3>Sooo. What happens when the script is called?</h3>
<table>
<thead>
<tr>
<th>Client</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>IE 11</td>
<td>Memory rises, IE crashes</td>
</tr>
<tr>
<td>Chrome</td>
<td>Memory rises, error shown</td>
</tr>
<tr>
<td>Edge</td>
<td>Memory rises, then dripps and loads forever</td>
</tr>
<tr>
<td>Nikto</td>
<td>Seems to scan fine but no output is reported</td>
</tr>
<tr>
<td>SQLmap</td>
<td>High memory usage until crash</td>
</tr>
<tr>
<td>Safari</td>
<td>Hight memory usage, then crashes and reloads, then memory rises again, etc..</td>
</tr>
<tr>
<td>Chrome (Android)</td>
<td>Memory rises, error shown</td>
</tr>
</tbody>
</table>
<p>(if you have tested it with other devices/browsers/scripts, please <a href="https://twitter.com/geek_at">let me know</a> and I&#39;ll add it here)</p>
<figure><img loading="lazy" src="https://www.pictshare.net/w9jqmocigm.jpg"/><figcaption>Reaction of the script called in Chrome</figcaption></figure>
<p>If you&#39;re a risk taker: <a href="https://blog-backend.haschek.at/tools/bomb.php"><strong>Try it yourself</strong></a></p>
                            </div>
                        </div>
                    </div></article></div>
  </body>
</html>
