<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/pijng/prep">Original</a>
    <h1>Prep: Golang Comptime</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><code>prep</code> is a small Go tool that enables compile-time function evaluation. By using <code>prep.Comptime</code>, you can evaluate functions at build time, replacing them with their computed results. Just like <code>comptime</code> from Zig. Except it&#39;s not.</p>

<ul dir="auto">
<li><strong>Compile-Time Evaluation</strong>: Replace function calls with their computed results at build time.</li>
<li><strong>Simple Integration</strong>: Use <code>prep</code> as both a Go library and a standalone executable.</li>
<li><strong>Tooling Support</strong>: Easily integrate <code>prep</code> with your Go build process using <code>-toolexec</code>.</li>
</ul>

<div dir="auto"><h3 tabindex="-1" dir="auto">1. Install the <code>prep</code> executable</h3><a id="user-content-1-install-the-prep-executable" aria-label="Permalink: 1. Install the prep executable" href="#1-install-the-prep-executable"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To use <code>prep</code> in your build process, install it as a binary executable:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go install github.com/pijng/prep/cmd/prep@latest"><pre>go install github.com/pijng/prep/cmd/prep@latest</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">2. Add <code>prep</code> as a dependency</h3><a id="user-content-2-add-prep-as-a-dependency" aria-label="Permalink: 2. Add prep as a dependency" href="#2-add-prep-as-a-dependency"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To use the <code>prep</code> library in your Go project, add it via Go modules:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go get github.com/pijng/prep
go mod tidy"><pre>go get github.com/pijng/prep
go mod tidy</pre></div>

<div dir="auto"><h3 tabindex="-1" dir="auto">Wrapping Functions with <code>prep.Comptime</code></h3><a id="user-content-wrapping-functions-with-prepcomptime" aria-label="Permalink: Wrapping Functions with prep.Comptime" href="#wrapping-functions-with-prepcomptime"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To mark a function for compile-time evaluation, wrap it with <code>prep.Comptime</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="package main

import (
  &#34;fmt&#34;
  &#34;github.com/pijng/prep&#34;
)

func main() {
  // This will be evaluated at compile-time
  result := prep.Comptime(fibonacci(300))

  fmt.Println(&#34;Result:&#34;, result)
}

func fibonacci(n int) int {
  fmt.Printf(&#34;calculating fibonacci for %d\n&#34;, n)

  if n &lt;= 1 {
    return n
  }
  a, b := 0, 1
  for i := 2; i &lt;= n; i++ {
    a, b = b, a+b
  }
  return b
}"><pre><span>package</span> main

<span>import</span> (
  <span>&#34;fmt&#34;</span>
  <span>&#34;github.com/pijng/prep&#34;</span>
)

<span>func</span> <span>main</span>() {
  <span>// This will be evaluated at compile-time</span>
  <span>result</span> <span>:=</span> <span>prep</span>.<span>Comptime</span>(<span>fibonacci</span>(<span>300</span>))

  <span>fmt</span>.<span>Println</span>(<span>&#34;Result:&#34;</span>, <span>result</span>)
}

<span>func</span> <span>fibonacci</span>(<span>n</span> <span>int</span>) <span>int</span> {
  <span>fmt</span>.<span>Printf</span>(<span>&#34;calculating fibonacci for %d<span>\n</span>&#34;</span>, <span>n</span>)

  <span>if</span> <span>n</span> <span>&lt;=</span> <span>1</span> {
    <span>return</span> <span>n</span>
  }
  <span>a</span>, <span>b</span> <span>:=</span> <span>0</span>, <span>1</span>
  <span>for</span> <span>i</span> <span>:=</span> <span>2</span>; <span>i</span> <span>&lt;=</span> <span>n</span>; <span>i</span><span>++</span> {
    <span>a</span>, <span>b</span> <span>=</span> <span>b</span>, <span>a</span><span>+</span><span>b</span>
  }
  <span>return</span> <span>b</span>
}</pre></div>

<p dir="auto">After wrapping your functions with <code>prep.Comptime</code>, you need to use <code>prep</code> during the build process. This is done by using the <code>-toolexec</code> flag:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go build -a -toolexec=&#34;prep &lt;absolute/path/to/project&gt;&#34; main.go"><pre>go build -a -toolexec=<span><span>&#34;</span>prep &lt;absolute/path/to/project&gt;<span>&#34;</span></span> main.go</pre></div>
<p dir="auto">This command will evaluate all functions wrapped with <code>prep.Comptime</code> and replace them with their computed results during the build.</p>
<p dir="auto"><strong>Important:</strong></p>
<ul dir="auto">
<li><code>-a</code> flag is required to recompile all your project, otherwise go compiler might do nothing and use cached build</li>
<li><code>&lt;absolute/path/to/project&gt;</code> is and absolute path to the root of your project. If you run <code>go build</code> from the root of the project â€“ simply specify <code>$PWD</code> as an argument.</li>
</ul>


<p dir="auto">Note the speed and absence of <code>calculating fibonacci for %d</code> message.</p>

<p dir="auto"><strong>Basic Literals Only</strong></p>
<p dir="auto">Currently, <code>prep.Comptime</code> only supports basic literals as arguments. Which means you can either:</p>
<ol dir="auto">
<li>Pass a basic literal directly like this:</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="func job() {
  prep.Comptime(myFunc(1))
}"><pre><span>func</span> <span>job</span>() {
  <span>prep</span>.<span>Comptime</span>(<span>myFunc</span>(<span>1</span>))
}</pre></div>
<ol start="2" dir="auto">
<li>Use a variable with the value of basic literal from the same scope as wrapped function:</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="func job() {
  x := 1
  y := 2
  prep.Comptime(myFunc(x, y))
}"><pre><span>func</span> <span>job</span>() {
  <span>x</span> <span>:=</span> <span>1</span>
  <span>y</span> <span>:=</span> <span>2</span>
  <span>prep</span>.<span>Comptime</span>(<span>myFunc</span>(<span>x</span>, <span>y</span>))
}</pre></div>
<p dir="auto"><strong>Compile-Time Evaluation</strong></p>
<p dir="auto">Only functions that can be fully resolved with the provided literal arguments can be evaluated at compile-time, therefore it is impossible to use any values from IO operations.</p>

<p dir="auto">Because reasons.</p>
</article></div></div>
  </body>
</html>
