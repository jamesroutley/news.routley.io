<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/wey-gu/py-pglite">Original</a>
    <h1>Test Postgres in Python Like SQLite</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/1651790/451981298-3c6ef886-5075-4d82-a180-a6b1dafe792b.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NDkxOTE2NDMsIm5iZiI6MTc0OTE5MTM0MywicGF0aCI6Ii8xNjUxNzkwLzQ1MTk4MTI5OC0zYzZlZjg4Ni01MDc1LTRkODItYTE4MC1hNmIxZGFmZTc5MmIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDYwNiUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTA2MDZUMDYyOTAzWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NzQ3MmY5YzEzOGQ5NDFkMDg1NjI3NDI1NjRlMzQ4OTllMjJmZjE3MmIzMDc5ZjRmMWQyMzUwOTgzZWJlZDk1MCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.9bvWffkikM1YiCPzVTp3nlL9-gJpki8509QqMllT5kQ"><img src="https://private-user-images.githubusercontent.com/1651790/451981298-3c6ef886-5075-4d82-a180-a6b1dafe792b.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NDkxOTE2NDMsIm5iZiI6MTc0OTE5MTM0MywicGF0aCI6Ii8xNjUxNzkwLzQ1MTk4MTI5OC0zYzZlZjg4Ni01MDc1LTRkODItYTE4MC1hNmIxZGFmZTc5MmIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDYwNiUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTA2MDZUMDYyOTAzWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NzQ3MmY5YzEzOGQ5NDFkMDg1NjI3NDI1NjRlMzQ4OTllMjJmZjE3MmIzMDc5ZjRmMWQyMzUwOTgzZWJlZDk1MCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.9bvWffkikM1YiCPzVTp3nlL9-gJpki8509QqMllT5kQ" alt="image"/></a></p>
<p dir="auto"><a href="https://github.com/wey-gu/py-pglite/actions/workflows/ci.yml"><img src="https://github.com/wey-gu/py-pglite/actions/workflows/ci.yml/badge.svg" alt="CI"/></a>
<a href="https://codecov.io/gh/wey-gu/py-pglite" rel="nofollow"><img src="https://camo.githubusercontent.com/137353bbd51cf4cb94d56c7f9288a47c40c9564dd00c5901064fba896672b855/68747470733a2f2f636f6465636f762e696f2f67682f7765792d67752f70792d70676c6974652f6272616e63682f6d61696e2f67726170682f62616467652e7376673f746f6b656e3d594f55525f434f4445434f565f544f4b454e" alt="codecov" data-canonical-src="https://codecov.io/gh/wey-gu/py-pglite/branch/main/graph/badge.svg?token=YOUR_CODECOV_TOKEN"/></a>
<a href="https://github.com/astral-sh/ruff"><img src="https://camo.githubusercontent.com/e9e401f08622ada6a3147f8bb1ba4ee849b38c7f123199ce3886ef05658299e6/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f7374796c652d727566662d626c75653f6c6f676f3d72756666266c6f676f436f6c6f723d7768697465" alt="Ruff" data-canonical-src="https://img.shields.io/badge/style-ruff-blue?logo=ruff&amp;logoColor=white"/></a>
<a href="https://badge.fury.io/py/py-pglite" rel="nofollow"><img src="https://camo.githubusercontent.com/6d08914750fc8f1671c104bb431d8bd17d8b46cb54d00364ca0e7b7365267ef7/68747470733a2f2f62616467652e667572792e696f2f70792f70792d70676c6974652e737667" alt="PyPI version" data-canonical-src="https://badge.fury.io/py/py-pglite.svg"/></a>
<a href="https://pypi.org/project/py-pglite/" rel="nofollow"><img src="https://camo.githubusercontent.com/337ddbbe5fa88fd4643f6421c27687d2d1c74a97536f3b0b12a872bdcbca29d2/68747470733a2f2f696d672e736869656c64732e696f2f707970692f707976657273696f6e732f70792d70676c6974652e737667" alt="Python" data-canonical-src="https://img.shields.io/pypi/pyversions/py-pglite.svg"/></a>
<a href="https://github.com/wey-gu/py-pglite/blob/main/LICENSE"><img src="https://camo.githubusercontent.com/d3171074e95a4a5adb658c6465e6162b2c23a96a3a1408a73b0a5fb93d1db34d/68747470733a2f2f696d672e736869656c64732e696f2f707970692f6c2f70792d70676c6974652e737667" alt="License" data-canonical-src="https://img.shields.io/pypi/l/py-pglite.svg"/></a></p>
<p dir="auto">A Python testing library that provides seamless integration between <a href="https://github.com/electric-sql/pglite">PGlite</a> and Python test suites. Get the full power of PostgreSQL in your tests without the overhead of a full PostgreSQL installation.</p>

<ul dir="auto">
<li><strong>‚ö° Blazing Fast</strong>: In-memory PostgreSQL for ultra-quick test runs</li>
<li><strong>üõ†Ô∏è Effortless Setup</strong>: No PostgreSQL install needed‚Äîjust Node.js(I know)!</li>
<li><strong>üêç Pythonic</strong>: Native support for SQLAlchemy &amp; SQLModel in your tests</li>
<li><strong>üßä Fully Isolated</strong>: Every test module gets its own fresh database</li>
<li><strong>ü¶æ 100% Compatible</strong>: True PostgreSQL features via <a href="https://pglite.dev/" rel="nofollow">PGlite</a></li>
<li><strong>üß© Pytest Plug-and-Play</strong>: Ready-to-use fixtures for instant productivity</li>
</ul>



<div dir="auto"><h3 tabindex="-1" dir="auto">With Optional Dependencies</h3><a id="user-content-with-optional-dependencies" aria-label="Permalink: With Optional Dependencies" href="#with-optional-dependencies"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="# For SQLModel support
pip install &#34;py-pglite[sqlmodel]&#34;

# For FastAPI integration
pip install &#34;py-pglite[fastapi]&#34;

# For development
pip install &#34;py-pglite[dev]&#34;"><pre><span><span>#</span> For SQLModel support</span>
pip install <span><span>&#34;</span>py-pglite[sqlmodel]<span>&#34;</span></span>

<span><span>#</span> For FastAPI integration</span>
pip install <span><span>&#34;</span>py-pglite[fastapi]<span>&#34;</span></span>

<span><span>#</span> For development</span>
pip install <span><span>&#34;</span>py-pglite[dev]<span>&#34;</span></span></pre></div>

<ul dir="auto">
<li><strong>Python</strong>: 3.10+</li>
<li><strong>Node.js</strong>: 18+ (for PGlite)</li>
<li><strong>SQLAlchemy</strong>: 2.0+</li>
</ul>
<p dir="auto">The library automatically manages PGlite npm dependencies.</p>


<div dir="auto" data-snippet-clipboard-copy-content="import pytest
from sqlmodel import Session, SQLModel, Field, select
from py_pglite import pglite_session

# Your models
class User(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str
    email: str

# Test with automatic PGlite management
def test_user_creation(pglite_session: Session):
    user = User(name=&#34;Alice&#34;, email=&#34;alice@example.com&#34;)
    pglite_session.add(user)
    pglite_session.commit()
    
    # Query back
    users = pglite_session.exec(select(User)).all()
    assert len(users) == 1
    assert users[0].name == &#34;Alice&#34;"><pre><span>import</span> <span>pytest</span>
<span>from</span> <span>sqlmodel</span> <span>import</span> <span>Session</span>, <span>SQLModel</span>, <span>Field</span>, <span>select</span>
<span>from</span> <span>py_pglite</span> <span>import</span> <span>pglite_session</span>

<span># Your models</span>
<span>class</span> <span>User</span>(<span>SQLModel</span>, <span>table</span><span>=</span><span>True</span>):
    <span>id</span>: <span>int</span> <span>|</span> <span>None</span> <span>=</span> <span>Field</span>(<span>default</span><span>=</span><span>None</span>, <span>primary_key</span><span>=</span><span>True</span>)
    <span>name</span>: <span>str</span>
    <span>email</span>: <span>str</span>

<span># Test with automatic PGlite management</span>
<span>def</span> <span>test_user_creation</span>(<span>pglite_session</span>: <span>Session</span>):
    <span>user</span> <span>=</span> <span>User</span>(<span>name</span><span>=</span><span>&#34;Alice&#34;</span>, <span>email</span><span>=</span><span>&#34;alice@example.com&#34;</span>)
    <span>pglite_session</span>.<span>add</span>(<span>user</span>)
    <span>pglite_session</span>.<span>commit</span>()
    
    <span># Query back</span>
    <span>users</span> <span>=</span> <span>pglite_session</span>.<span>exec</span>(<span>select</span>(<span>User</span>)).<span>all</span>()
    <span>assert</span> <span>len</span>(<span>users</span>) <span>==</span> <span>1</span>
    <span>assert</span> <span>users</span>[<span>0</span>].<span>name</span> <span>==</span> <span>&#34;Alice&#34;</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="from py_pglite import PGliteManager, PGliteConfig

# Custom configuration
config = PGliteConfig(
    timeout=30,
    cleanup_on_exit=True,
    log_level=&#34;DEBUG&#34;
)

# Manual management
with PGliteManager(config) as manager:
    engine = manager.get_engine()
    SQLModel.metadata.create_all(engine)
    
    with Session(engine) as session:
        # Your database operations here
        pass"><pre><span>from</span> <span>py_pglite</span> <span>import</span> <span>PGliteManager</span>, <span>PGliteConfig</span>

<span># Custom configuration</span>
<span>config</span> <span>=</span> <span>PGliteConfig</span>(
    <span>timeout</span><span>=</span><span>30</span>,
    <span>cleanup_on_exit</span><span>=</span><span>True</span>,
    <span>log_level</span><span>=</span><span>&#34;DEBUG&#34;</span>
)

<span># Manual management</span>
<span>with</span> <span>PGliteManager</span>(<span>config</span>) <span>as</span> <span>manager</span>:
    <span>engine</span> <span>=</span> <span>manager</span>.<span>get_engine</span>()
    <span>SQLModel</span>.<span>metadata</span>.<span>create_all</span>(<span>engine</span>)
    
    <span>with</span> <span>Session</span>(<span>engine</span>) <span>as</span> <span>session</span>:
        <span># Your database operations here</span>
        <span>pass</span></pre></div>


<ul dir="auto">
<li><strong><code>pglite_engine</code></strong>: SQLAlchemy engine connected to PGlite</li>
<li><strong><code>pglite_session</code></strong>: Database session with automatic cleanup</li>
<li><strong><code>pglite_manager</code></strong>: Direct access to PGlite process management</li>
</ul>

<ul dir="auto">
<li>‚úÖ Process lifecycle management</li>
<li>‚úÖ Socket cleanup and health checks</li>
<li>‚úÖ Graceful shutdown and error handling</li>
<li>‚úÖ Per-test isolation with automatic cleanup</li>
<li>‚úÖ Node.js dependency management</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="from py_pglite import PGliteConfig

config = PGliteConfig(
    timeout=30,               # Startup timeout in seconds
    cleanup_on_exit=True,     # Auto cleanup on exit
    log_level=&#34;INFO&#34;,         # Logging level (DEBUG/INFO/WARNING/ERROR)
    socket_path=&#34;/tmp/.s.PGSQL.5432&#34;,  # Custom socket path
    work_dir=None,            # Working directory (None = temp dir)
    node_modules_check=True,  # Verify node_modules exists
    auto_install_deps=True,   # Auto-install npm dependencies
)"><pre><span>from</span> <span>py_pglite</span> <span>import</span> <span>PGliteConfig</span>

<span>config</span> <span>=</span> <span>PGliteConfig</span>(
    <span>timeout</span><span>=</span><span>30</span>,               <span># Startup timeout in seconds</span>
    <span>cleanup_on_exit</span><span>=</span><span>True</span>,     <span># Auto cleanup on exit</span>
    <span>log_level</span><span>=</span><span>&#34;INFO&#34;</span>,         <span># Logging level (DEBUG/INFO/WARNING/ERROR)</span>
    <span>socket_path</span><span>=</span><span>&#34;/tmp/.s.PGSQL.5432&#34;</span>,  <span># Custom socket path</span>
    <span>work_dir</span><span>=</span><span>None</span>,            <span># Working directory (None = temp dir)</span>
    <span>node_modules_check</span><span>=</span><span>True</span>,  <span># Verify node_modules exists</span>
    <span>auto_install_deps</span><span>=</span><span>True</span>,   <span># Auto-install npm dependencies</span>
)</pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="from py_pglite import utils

# Database cleanup utilities
utils.clean_database_data(engine)                    # Clean all data
utils.clean_database_data(engine, exclude_tables=[&#34;users&#34;])  # Exclude tables
utils.reset_sequences(engine)                        # Reset auto-increment sequences
utils.verify_database_empty(engine)                  # Check if database is empty

# Schema operations
utils.create_test_schema(engine, &#34;test_schema&#34;)      # Create test schema
utils.drop_test_schema(engine, &#34;test_schema&#34;)        # Drop test schema

# Get table statistics
row_counts = utils.get_table_row_counts(engine)      # Dict of table row counts"><pre><span>from</span> <span>py_pglite</span> <span>import</span> <span>utils</span>

<span># Database cleanup utilities</span>
<span>utils</span>.<span>clean_database_data</span>(<span>engine</span>)                    <span># Clean all data</span>
<span>utils</span>.<span>clean_database_data</span>(<span>engine</span>, <span>exclude_tables</span><span>=</span>[<span>&#34;users&#34;</span>])  <span># Exclude tables</span>
<span>utils</span>.<span>reset_sequences</span>(<span>engine</span>)                        <span># Reset auto-increment sequences</span>
<span>utils</span>.<span>verify_database_empty</span>(<span>engine</span>)                  <span># Check if database is empty</span>

<span># Schema operations</span>
<span>utils</span>.<span>create_test_schema</span>(<span>engine</span>, <span>&#34;test_schema&#34;</span>)      <span># Create test schema</span>
<span>utils</span>.<span>drop_test_schema</span>(<span>engine</span>, <span>&#34;test_schema&#34;</span>)        <span># Drop test schema</span>

<span># Get table statistics</span>
<span>row_counts</span> <span>=</span> <span>utils</span>.<span>get_table_row_counts</span>(<span>engine</span>)      <span># Dict of table row counts</span></pre></div>


<div dir="auto" data-snippet-clipboard-copy-content="from fastapi import Depends, FastAPI
from fastapi.testclient import TestClient
from sqlmodel import Session
from py_pglite import pglite_engine

app = FastAPI()

def get_db():
    # Production database dependency
    pass

@app.post(&#34;/users/&#34;)
def create_user(user_data: dict, db: Session = Depends(get_db)):
    # Your endpoint logic
    pass

# Test with PGlite
def test_create_user_endpoint(pglite_engine):
    # Override database dependency
    def override_get_db():
        with Session(pglite_engine) as session:
            yield session
    
    app.dependency_overrides[get_db] = override_get_db
    
    with TestClient(app) as client:
        response = client.post(&#34;/users/&#34;, json={&#34;name&#34;: &#34;Bob&#34;})
        assert response.status_code == 200"><pre><span>from</span> <span>fastapi</span> <span>import</span> <span>Depends</span>, <span>FastAPI</span>
<span>from</span> <span>fastapi</span>.<span>testclient</span> <span>import</span> <span>TestClient</span>
<span>from</span> <span>sqlmodel</span> <span>import</span> <span>Session</span>
<span>from</span> <span>py_pglite</span> <span>import</span> <span>pglite_engine</span>

<span>app</span> <span>=</span> <span>FastAPI</span>()

<span>def</span> <span>get_db</span>():
    <span># Production database dependency</span>
    <span>pass</span>

<span>@<span>app</span>.<span>post</span>(<span>&#34;/users/&#34;</span>)</span>
<span>def</span> <span>create_user</span>(<span>user_data</span>: <span>dict</span>, <span>db</span>: <span>Session</span> <span>=</span> <span>Depends</span>(<span>get_db</span>)):
    <span># Your endpoint logic</span>
    <span>pass</span>

<span># Test with PGlite</span>
<span>def</span> <span>test_create_user_endpoint</span>(<span>pglite_engine</span>):
    <span># Override database dependency</span>
    <span>def</span> <span>override_get_db</span>():
        <span>with</span> <span>Session</span>(<span>pglite_engine</span>) <span>as</span> <span>session</span>:
            <span>yield</span> <span>session</span>
    
    <span>app</span>.<span>dependency_overrides</span>[<span>get_db</span>] <span>=</span> <span>override_get_db</span>
    
    <span>with</span> <span>TestClient</span>(<span>app</span>) <span>as</span> <span>client</span>:
        <span>response</span> <span>=</span> <span>client</span>.<span>post</span>(<span>&#34;/users/&#34;</span>, <span>json</span><span>=</span>{<span>&#34;name&#34;</span>: <span>&#34;Bob&#34;</span>})
        <span>assert</span> <span>response</span>.<span>status_code</span> <span>==</span> <span>200</span></pre></div>
<p dir="auto">See also <a href="https://github.com/wey-gu/py-pglite/blob/main/examples/test_fastapi_auth_example.py">examples/test_fastapi_auth_example.py</a> for an example of how to use py-pglite with FastAPI e2e test that includes authentication.</p>

<div dir="auto" data-snippet-clipboard-copy-content="def test_complex_operations(pglite_session: Session):
    # Create related data
    user = User(name=&#34;Alice&#34;, email=&#34;alice@example.com&#34;)
    pglite_session.add(user)
    pglite_session.commit()
    pglite_session.refresh(user)
    
    # Create dependent records
    orders = [
        Order(user_id=user.id, amount=100.0),
        Order(user_id=user.id, amount=250.0),
    ]
    pglite_session.add_all(orders)
    pglite_session.commit()
    
    # Complex query with joins
    result = pglite_session.exec(
        select(User.name, func.sum(Order.amount))
        .join(Order)
        .group_by(User.name)
    ).first()
    
    assert result[0] == &#34;Alice&#34;
    assert result[1] == 350.0"><pre><span>def</span> <span>test_complex_operations</span>(<span>pglite_session</span>: <span>Session</span>):
    <span># Create related data</span>
    <span>user</span> <span>=</span> <span>User</span>(<span>name</span><span>=</span><span>&#34;Alice&#34;</span>, <span>email</span><span>=</span><span>&#34;alice@example.com&#34;</span>)
    <span>pglite_session</span>.<span>add</span>(<span>user</span>)
    <span>pglite_session</span>.<span>commit</span>()
    <span>pglite_session</span>.<span>refresh</span>(<span>user</span>)
    
    <span># Create dependent records</span>
    <span>orders</span> <span>=</span> [
        <span>Order</span>(<span>user_id</span><span>=</span><span>user</span>.<span>id</span>, <span>amount</span><span>=</span><span>100.0</span>),
        <span>Order</span>(<span>user_id</span><span>=</span><span>user</span>.<span>id</span>, <span>amount</span><span>=</span><span>250.0</span>),
    ]
    <span>pglite_session</span>.<span>add_all</span>(<span>orders</span>)
    <span>pglite_session</span>.<span>commit</span>()
    
    <span># Complex query with joins</span>
    <span>result</span> <span>=</span> <span>pglite_session</span>.<span>exec</span>(
        <span>select</span>(<span>User</span>.<span>name</span>, <span>func</span>.<span>sum</span>(<span>Order</span>.<span>amount</span>))
        .<span>join</span>(<span>Order</span>)
        .<span>group_by</span>(<span>User</span>.<span>name</span>)
    ).<span>first</span>()
    
    <span>assert</span> <span>result</span>[<span>0</span>] <span>==</span> <span>&#34;Alice&#34;</span>
    <span>assert</span> <span>result</span>[<span>1</span>] <span>==</span> <span>350.0</span></pre></div>

<p dir="auto">Contributions welcome! Please read our <a href="https://github.com/wey-gu/py-pglite/blob/main/CONTRIBUTING.md">Contributing Guide</a>.</p>
<ol dir="auto">
<li>Fork the repository</li>
<li>Create a feature branch</li>
<li>Make your changes</li>
<li>Add tests for new functionality</li>
<li>Run the development workflow: <code>python hacking.py</code></li>
<li>Submit a pull request</li>
</ol>

<p dir="auto">Apache 2.0 License - see <a href="https://github.com/wey-gu/py-pglite/blob/main/LICENSE">LICENSE</a> file.</p>

<ul dir="auto">
<li><a href="https://github.com/electric-sql/pglite">PGlite</a> - The amazing in-memory PostgreSQL</li>
<li><a href="https://www.sqlalchemy.org/" rel="nofollow">SQLAlchemy</a> - Python SQL toolkit</li>
<li><a href="https://sqlmodel.tiangolo.com/" rel="nofollow">SQLModel</a> - Modern Python SQL toolkit</li>
<li><a href="https://pytest.org/" rel="nofollow">Pytest</a> - Testing framework</li>
</ul>

<div dir="auto"><h3 tabindex="-1" dir="auto">Multiple Database Sessions</h3><a id="user-content-multiple-database-sessions" aria-label="Permalink: Multiple Database Sessions" href="#multiple-database-sessions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">For multiple database connections, use <strong>multiple sessions with the same engine</strong> rather than multiple engines:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# ‚úÖ Recommended: Multiple sessions with same engine
with PGliteManager() as manager:
    engine = manager.get_engine()
    
    # Multiple sessions work perfectly
    session1 = Session(engine)
    session2 = Session(engine)
    session3 = Session(engine)

# ‚ùå Not recommended: Multiple engines from same manager
with PGliteManager() as manager:
    engine1 = manager.get_engine()  # Can cause connection conflicts
    engine2 = manager.get_engine()  # when used simultaneously"><pre><span># ‚úÖ Recommended: Multiple sessions with same engine</span>
<span>with</span> <span>PGliteManager</span>() <span>as</span> <span>manager</span>:
    <span>engine</span> <span>=</span> <span>manager</span>.<span>get_engine</span>()
    
    <span># Multiple sessions work perfectly</span>
    <span>session1</span> <span>=</span> <span>Session</span>(<span>engine</span>)
    <span>session2</span> <span>=</span> <span>Session</span>(<span>engine</span>)
    <span>session3</span> <span>=</span> <span>Session</span>(<span>engine</span>)

<span># ‚ùå Not recommended: Multiple engines from same manager</span>
<span>with</span> <span>PGliteManager</span>() <span>as</span> <span>manager</span>:
    <span>engine1</span> <span>=</span> <span>manager</span>.<span>get_engine</span>()  <span># Can cause connection conflicts</span>
    <span>engine2</span> <span>=</span> <span>manager</span>.<span>get_engine</span>()  <span># when used simultaneously</span></pre></div>
<p dir="auto"><strong>Why?</strong> Creating multiple SQLAlchemy engines from the same PGlite manager can cause connection pool conflicts since they all connect to the same Unix socket.</p>

<ul dir="auto">
<li>Use <code>pglite_session</code> fixture for automatic cleanup between tests</li>
<li>Use <code>pglite_engine</code> fixture when you need direct engine access</li>
<li>Use utility functions for efficient database operations</li>
<li>Consider custom configurations for specific test requirements</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="# Pattern 1: Simple CRUD testing
def test_user_crud(pglite_session):
    # Create
    user = User(name=&#34;Test&#34;, email=&#34;test@example.com&#34;)
    pglite_session.add(user)
    pglite_session.commit()
    
    # Read
    found_user = pglite_session.get(User, user.id)
    assert found_user.name == &#34;Test&#34;
    
    # Update
    found_user.name = &#34;Updated&#34;
    pglite_session.commit()
    
    # Delete
    pglite_session.delete(found_user)
    pglite_session.commit()

# Pattern 2: Custom cleanup
def test_with_custom_cleanup(pglite_engine):
    SQLModel.metadata.create_all(pglite_engine)
    
    with Session(pglite_engine) as session:
        # Your test logic
        pass
    
    # Custom cleanup if needed
    utils.clean_database_data(pglite_engine)"><pre><span># Pattern 1: Simple CRUD testing</span>
<span>def</span> <span>test_user_crud</span>(<span>pglite_session</span>):
    <span># Create</span>
    <span>user</span> <span>=</span> <span>User</span>(<span>name</span><span>=</span><span>&#34;Test&#34;</span>, <span>email</span><span>=</span><span>&#34;test@example.com&#34;</span>)
    <span>pglite_session</span>.<span>add</span>(<span>user</span>)
    <span>pglite_session</span>.<span>commit</span>()
    
    <span># Read</span>
    <span>found_user</span> <span>=</span> <span>pglite_session</span>.<span>get</span>(<span>User</span>, <span>user</span>.<span>id</span>)
    <span>assert</span> <span>found_user</span>.<span>name</span> <span>==</span> <span>&#34;Test&#34;</span>
    
    <span># Update</span>
    <span>found_user</span>.<span>name</span> <span>=</span> <span>&#34;Updated&#34;</span>
    <span>pglite_session</span>.<span>commit</span>()
    
    <span># Delete</span>
    <span>pglite_session</span>.<span>delete</span>(<span>found_user</span>)
    <span>pglite_session</span>.<span>commit</span>()

<span># Pattern 2: Custom cleanup</span>
<span>def</span> <span>test_with_custom_cleanup</span>(<span>pglite_engine</span>):
    <span>SQLModel</span>.<span>metadata</span>.<span>create_all</span>(<span>pglite_engine</span>)
    
    <span>with</span> <span>Session</span>(<span>pglite_engine</span>) <span>as</span> <span>session</span>:
        <span># Your test logic</span>
        <span>pass</span>
    
    <span># Custom cleanup if needed</span>
    <span>utils</span>.<span>clean_database_data</span>(<span>pglite_engine</span>)</pre></div>
</article></div></div>
  </body>
</html>
