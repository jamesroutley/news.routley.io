<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://magic.dev/blog/100m-token-context-windows">Original</a>
    <h1>100M Token Context Windows</h1>
    
    <div id="readability-page-1" class="page"><p>Research update on ultra-long context models, our partnership with Google Cloud, and new funding.</p><div><p>There are currently two ways for AI models to learn things: training, and in-context during inference. Until now, training has dominated, because contexts are relatively short. But ultra-long context could change that.</p>
<p>Instead of relying on fuzzy memorization, our LTM (Long-Term Memory) models are trained to reason on up to 100M tokens of context given to them during inference.</p>
<p>While the commercial applications of these ultra-long context models are plenty, at Magic we are focused on the domain of software development.</p>
<p>It’s easy to imagine how much better code synthesis would be if models had all of your code, documentation, and libraries in context, including those not on the public internet.</p>
<h2>Evaluating Context Windows</h2>
<p>Current long context evals aren’t great. The popular <strong>Needle In A Haystack</strong> eval places a random fact (&#39;the needle&#39;) in the middle of the long context window (&#39;haystack&#39;), and asks the model to retrieve the fact.</p>
<figure><p><img alt="Needle In A Haystack" loading="lazy" sizes="100vw" src="https://magic.dev/blog/100m-token-context-windows/needle-in-a-haystack.png" srcset="/blog/100m-token-context-windows/needle-in-a-haystack.png 1x"/></p><figcaption>Needle In A Haystack</figcaption></figure>
<p>However, “Arun and Max having coffee at Blue Bottle” stands out in a fiction novel about whales. By learning to recognize the unusual nature of the “needle”, the model can ignore otherwise relevant information in the “haystack”, reducing the required storage capacity to less than it would be on real tasks. It also only requires attending to a tiny, semantically recognizable part of the context, allowing even methods like RAG to appear successful.</p>
<p><a href="https://arxiv.org/abs/2312.00752">Mamba</a>’s (Section 4.1.2) and <a href="https://arxiv.org/abs/2212.14052">H3</a>&#39;s (Appendix E.1) <a href="https://arxiv.org/abs/2209.11895">induction head</a> benchmark makes this even easier. They use (and train with) a special token to explicitly signal the start of the needle, weakening the storage and retrieval difficulty of the eval to O(1). This is like knowing which question will come up in an exam before you start studying.</p>
<p>These subtle flaws weaken current long context evals in ways that allow traditional Recurrent Neural Networks (RNNs) and State Space Models (SSMs) to score well despite their fundamentally limiting, small O(1)-sized state vector.</p>
<p>To eliminate these implicit and explicit semantic hints, we’ve designed <strong>HashHop</strong>.</p>
<p>Hashes are random and thus incompressible, requiring the model to be able to store and retrieve from the maximum possible <a href="https://en.wikipedia.org/wiki/Information_content">information content</a> for a given context size at all times.</p>
<p>Concretely, we prompt a model trained on hashes with hash pairs:</p>
<pre><span>...</span>
<span>jJWlupoT → KmsFrnRa</span>
<span>vRLWdcwV → sVLdzfJu</span>
YOJVrdjK → WKPUyWON
<span>OepweRIW → JeIrWpvs</span>
<span>JeqPlFgA → YirRppTA</span>
<span>...</span></pre>
<p>Then, we ask it to complete the value of a randomly selected hash pair:</p>
<pre><span>Completion</span> YOJVrdjK → <span>WKPUyWON</span></pre>
<p>This measures the emergence of single-step <a href="https://arxiv.org/abs/2209.11895">induction heads</a>, but practical applications often require multiple hops. Picture variable assignments or library imports in your codebase.</p>
<p>To incorporate this, we ask the model to complete a chain of hashes instead (as recently proposed by <a href="https://arxiv.org/abs/2404.06654">RULER</a>):</p>
<pre>Hash 1 → Hash 2
Hash 2 → Hash 3
Hash 3 → Hash 4
Hash 4 → Hash 5
Hash 5 → Hash 6
<span> </span>
<span>Completion</span> Hash 1 → <span>Hash 2 Hash 3 Hash 4 Hash 5 Hash 6</span></pre>
<p>For order- and <a href="https://arxiv.org/abs/2307.03172">position-invariance</a>, we shuffle the hash pairs in the prompt:</p>
<pre><span>...</span>
<span>Hash 72 → Hash 81</span>
Hash 4 → Hash 5
Hash 1 → Hash 2
<span>Hash 17 → Hash 62</span>
Hash 2 → Hash 3
<span>Hash 52 → Hash 99</span>
<span>Hash 34 → Hash 12</span>
Hash 3 → Hash 4
<span>Hash 71 → Hash 19</span>
Hash 5 → Hash 6
<span>...</span>
<span> </span>
<span>Completion</span> Hash 1 → <span>Hash 2 Hash 3 Hash 4 Hash 5 Hash 6</span></pre>
<p>Writing out all intermediate hashes is similar to how <a href="https://arxiv.org/abs/2201.11903">chain of thought</a> allows models to spread out reasoning over time. We also propose a more challenging variant where the model skips steps, e.g. going directly from Hash 1 to Hash 6:</p>
<pre><span>Completion</span> Hash 1 → <span>Hash 6</span></pre>
<p>This requires the model architecture to be able to attend and jump across multiple points of the entire context in latent space in one go.</p>
<p>In addition to evaluating models on code and language, we found training small models on hashes and measuring performance on these toy tasks to be a useful tool for our architecture research.</p>
<p>If you would like to use HashHop, you can <a href="https://github.com/magicproduct/hash-hop">find it on GitHub</a>.</p>
<h2>Magic&#39;s progress on ultra long context</h2>
<p>We have recently trained our first 100M token context model: LTM-2-mini. 100M tokens equals ~10 million lines of code or ~750 novels.</p>
<p>For each decoded token, LTM-2-mini’s sequence-dimension algorithm is roughly 1000x cheaper than the attention mechanism in Llama 3.1 405B<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup> for a 100M token context window.</p>
<p>The contrast in memory requirements is even larger – running Llama 3.1 405B with a 100M token context requires <em>638 H100s per user</em> just to store a single 100M token KV cache.<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup> In contrast, LTM requires a small fraction of a single H100’s HBM per user for the same context.</p>
<p>Trained on hashes with chain of thought, the LTM architecture gets the following results:</p>

<p>With our choice of hyperparameters for this particular model, we see worsening performance when trying 3 or more hops without chain of thought, but for 2 hops at once (Hash 1 → Hash 3), without chain of thought, we see strong results, indicating the model is able to build more complex circuits than single induction heads:</p>

<p>We also trained a prototype model on text-to-diff data with our ultra-long context mechanism. It’s several orders of magnitude smaller than frontier models, so we would be the first to admit that its code synthesis abilities were not good enough yet, but it produced the occasional reasonable output:</p>
<h3>In-context GUI framework</h3>
<p>Our model successfully created a calculator using a custom in-context GUI framework, showcasing its capability for real-time learning. Although generating a calculator is a simple task for state-of-the-art models when using well-known frameworks like React, the use of a custom in-context framework is more challenging. The model is prompted with just the codebase and the chat (no open files, edit history, or other indicators).</p>
<p><iframe src="https://player.vimeo.com/video/1004126268?badge=0&amp;amp;autopause=0&amp;amp;player_id=0&amp;amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write" title="In Context Learning (3x speed)"></iframe></p>
<h3>Simple UI change</h3>
<p>Our model was able to implement a password strength meter for the open source repo <a href="https://github.com/documenso/documenso">Documenso</a> without human intervention. The issue description is more specific than we would expect it to be in a real-world scenario and the feature is common among many web applications. Still, a model several orders of magnitude smaller than today’s frontier models was able to edit a complex codebase unassisted.</p>
<p><iframe src="https://player.vimeo.com/video/1004125053?badge=0&amp;amp;autopause=0&amp;amp;player_id=0&amp;amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write" title="Simple UI Change (2x speed)"></iframe></p>
<p>We are now training a large LTM-2 model on our new supercomputer.</p>
<h2>Partnership with Google Cloud to build NVIDIA GB200 NVL72 cluster</h2>
<figure><p><img alt="Magic partners with Google Cloud" loading="lazy" sizes="100vw" src="https://magic.dev/blog/100m-token-context-windows/google-partnership.png" srcset="/blog/100m-token-context-windows/google-partnership.png 1x"/></p><figcaption>Magic partners with Google Cloud</figcaption></figure>
<p>We are building our next two supercomputers on Google Cloud: Magic-G4, powered by NVIDIA H100 Tensor Core GPUs, and Magic-G5, powered by NVIDIA GB200 NVL72, with the ability to scale to tens of thousands of Blackwell GPUs over time.</p>
<blockquote>
<p>“We are excited to partner with Google and NVIDIA to build our next-gen AI supercomputer on Google Cloud. NVIDIA’s GB200 NLV72 system will greatly improve inference and training efficiency for our models, and Google Cloud offers us the fastest timeline to scale, and a rich ecosystem of cloud services.” <span>– Eric Steinberger, CEO &amp; Co-founder at Magic</span></p>
</blockquote>
<blockquote>
<p>“Google Cloud’s end-to-end AI platform provides high-growth, fast-moving companies like Magic with complete hardware and software capabilities for building AI models and applications at scale. Through this partnership, Magic will utilize Google Cloud’s AI Platform services including a variety of leading NVIDIA chips and AI tooling from Vertex AI to build and train its next generation of models and to bring products to market more quickly.” <span>– Amin Vahdat, VP and GM of ML, Services, and Cloud AI at Google Cloud</span></p>
</blockquote>
<blockquote>
<p>“The current and future impact of AI is fueled to a great extent by the development of increasingly capable large language models. Powered by one of the largest installations of the NVIDIA GB200 NVL72 rack-scale design to date, the Magic-G5 supercomputer on Google Cloud will provide Magic with the compute resources needed to train, deploy and scale large language models – and push the boundaries of what AI can achieve.” <span>– Ian Buck, Vice President of Hyperscale and HPC at NVIDIA</span></p>
</blockquote>
<h2>New funding</h2>
<p>We’ve raised a total of $465M, including a recent investment of $320 million from new investors Eric Schmidt, Jane Street, Sequoia, Atlassian, among others, and existing investors Nat Friedman &amp; Daniel Gross, Elad Gil, and CapitalG.</p>
<h2>Join us</h2>
<p>Pre-training only goes so far; we believe inference-time compute is the next frontier in AI. Imagine if you could spend $100 and 10 minutes on an issue and reliably get a great pull request for an entire feature. That’s our goal.</p>
<p>To train and serve 100M token context models, we needed to write an entire training and inference stack from scratch (no torch autograd, lots of custom CUDA, no open-source foundations) and run experiment after experiment on how to stably train our models. Inference-time compute is an equally challenging project.</p>
<p>We are 23 people (+ 8000 H100s) and are <a href="https://magic.dev/careers/bcc8d988-47ea-4089-9619-80260abb71b5">hiring more Engineers and Researchers</a> to accelerate our work and deploy upcoming models.</p>
<p>Over time, we will scale up to tens of thousands of GB200s. We are hiring <a href="https://magic.dev/careers/45d25f90-3be6-417d-810f-0d95f7704961">Supercomputing</a> and <a href="https://magic.dev/careers/72ee24f8-d6a2-4446-9fe4-ac8f838bc987">Systems Engineers</a> to work alongside Ben Chess (former OpenAI Supercomputing Lead).</p>
<p>Sufficiently advanced AI should be treated with the same sensitivity as the nuclear industry. In addition to our commitments to <a href="https://magic.dev/agi-readiness-policy">standard safety testing</a>, we want Magic to be great at cybersecurity and push for higher regulatory standards. We are hiring for a <a href="https://magic.dev/careers/167a953e-1d41-48c6-af4f-0d80fbe9c2af">Head of Security</a> to lead this effort.</p>

</div></div>
  </body>
</html>
