<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bugwhisperer.dev/blog/bluetooth-hearingaids-linux/">Original</a>
    <h1>Connecting Hearing Aids to Linux via Bluetooth</h1>
    
    <div id="readability-page-1" class="page"><div id="main-content"><p><a href="https://bugwhisperer.dev/tags/os">üè∑ os</a></p><hr/><blockquote><span>&#34;</span>Debugging becomes significantly easier if you first admit that you are the problem,&#34;</blockquote><hr/><p>I recently wanted to connect my hearing aids to my laptop to watch a movie. Based on everything I could find online and from the Hearing Aid manufacturer directly, I had to purchase a second device that would act as an intermediary to the laptop, TV, etc. That seemed odd, as I‚Äôd always used them directly with my mobile phone, with an app from the manufacturer. After some digging, I discovered, aside from the sheer complexity of the Bluetooth protocol, that there were two separately developed protocols for devices like hearing aids. First, I‚Äôll briefly cover how Bluetooth works and how I worked on connecting my hearing aids to the laptop.</p><blockquote><p>Spoiler Alert: I‚Äôm not an expert on Bluetooth by any stretch of the imagination. I‚Äôm just a person who wanted to listen to music and hacked around until it worked. What I will try to do is to distill some of the mystery surrounding it.</p></blockquote><p>If you don‚Äôt care about the what or why behind Bluetooth and just want to connect, you can <a href="https://bugwhisperer.dev/blog/bluetooth-hearingaids-linux/#connecting-hearing-aids-to-a-linux-laptop">skip ahead to the instructions</a>.</p><h2 id="bluetooth-setup-specifically-on-linux">Bluetooth setup (specifically on Linux)</h2><p>At the end of the day, if you take nothing else away, just remember that Bluetooth is very similar to network programming in its setup. There are no DNS servers involved here though, which is where the differences start to show. From a Linux user‚Äôs standpoint, they turn on their Bluetooth-capable device(like earbuds), search for it (from a GUI or CLI manager), ‚Äúconnect‚Äù or ‚Äúpair‚Äù with it, and then output sound to it.</p><p>The pieces involved under the hood look something like this:</p><h3 id="user-applications">User Applications</h3><ul><li>Connects To: Sound Servers</li><li>Interaction: Applications send audio streams to sound servers</li><li>Examples: Media players (e.g., VLC), VoIP apps (e.g., Zoom), system settings</li><li>Protocols Used: PulseAudio API, PipeWire API, JACK API</li></ul><h3 id="sound-servers">Sound Servers</h3><ul><li>Connects To: ALSA (Kernel-Level Sound System) &amp; Bluez (BLuetooth stack)</li><li>Interaction: Sound servers mix and route audio before sending it to ALSA or BlueZ</li><li>Examples: PulseAudio, PipeWire, JACK</li><li>Protocols Used: ALSA API, JACK audio connection kit</li></ul><h3 id="alsa-advanced-linux-sound-architecture"><a href="https://www.alsa-project.org/wiki/Main_Page" rel="noopener" target="_blank">ALSA</a>(Advanced Linux Sound Architecture)</h3><ul><li>Connects To: Hardware Drivers</li><li>Interaction: ALSA sends audio data to hardware drivers (internal speakers, microphones, sound cards)</li><li>Protocols Used: Kernel system calls, device-specific drivers</li></ul><h3 id="bluetooth-deamon-bluez">Bluetooth Deamon (BlueZ)</h3><ul><li>Connects To: Bluetooth device drivers</li><li>Interaction: Manages Bluetooth devices and sends audio streams</li><li>Protocols Used: A2DP (Advanced Audio Distribution Profile), HSP/HFP (Headset Profile), HCI (Host Controller Interface)</li></ul><h3 id="bluetooth-device-drivers">Bluetooth Device Drivers</h3><ul><li>Connects To: Headphones/Speakers/Microphone hardware</li><li>Interaction: Sends processed audio from BlueZ to Bluetooth devices</li><li>Protocols Used: Same as with BlueZ daemon. Bluetooth HCI, A2DP, HSP</li></ul><h3 id="d-bus-communication">D-Bus Communication</h3><p>D-Bus is an Interprocess Communication Layer that is used for communication between various system components. It‚Äôs like { ANNALOGY GOES HERE }‚Ä¶</p><h2 id="connecting-hearing-aids-to-a-linux-laptop">Connecting Hearing Aids to a Linux Laptop</h2><p>I found a GitHub repo that had a C-based ASHA Sink &lt;‚Äì&gt; Pipewire utility and used that to connect. The steps and flow are as follows:</p><h3 id="requirements-installation">Requirements / Installation</h3><p>You will need a copy of the ASHA-Pipewire Sink repo:</p><p><code>git clone https://github.com/thewierdnut/asha_pipewire_sink.git</code></p><p>Ensure you have all of the required packages to build the executable(for Fedora):</p><p><code>sudo dnf install cmake pipewire pipewire-alsa pipewire-devel bluez-libs-devel bluez-libs</code></p><p><em>A/N #1:</em> If you have Debian, refer to the repo‚Äôs <a href="https://github.com/thewierdnut/asha_pipewire_sink?tab=readme-ov-file#building" rel="noopener" target="_blank">README prerequisites</a>. <em>A/N #2:</em> If you have neither, you‚Äôll need to examine each package and try to find the equivalent for your OS (if it exists). Good luck!</p><h4 id="enable-le-credit-based-flow-control">Enable LE credit based flow control</h4><ol><li><code>sudo touch /etc/modprobe.d/bluetooth_asha.conf</code></li><li>Add following line to ‚Äú/etc/modprobe.d/bluetooth_asha.conf‚Äù: <code>options bluetooth enable_ecred=1</code></li></ol><h4 id="change-the-default-connection-interval">Change the default connection interval</h4><p>Update (ie. sudoedit) <code>/etc/bluetooth/main.conf</code> to contain the following settings:</p><pre><code><span>[LE]
</span><span># LE default connection parameters. These values are superceeded by any
</span><span># specific values provided via the Load Connection Parameters interface
</span><span>MinConnectionInterval=16
</span><span>MaxConnectionInterval=16
</span><span>ConnectionLatency=10
</span><span>ConnectionSupervisionTimeout=100
</span></code></pre><h4 id="restart-bluetooth-service-for-changes-to-take-effect">Restart Bluetooth service for changes to take effect</h4><pre data-lang="sh"><code data-lang="sh"><span>sudo</span><span> systemctl restart bluetooth
</span></code></pre><h4 id="build-the-asha-pipewire-sink-executable-move-it-into-your-path">Build the ASHA-Pipewire Sink executable &amp; move it into your PATH</h4><ol><li><code>mkdir build</code></li><li><code>cd build</code></li><li><code>cmake ..</code></li><li><code>make</code></li><li><code>cp ./asha_pipewire_sink $HOME/.local/bin/</code></li></ol><h4 id="connecting-everything-up">Connecting everything up:</h4><ol><li>Run the ASHA Pipewire Sink - <code>asha_pipewire_sink &amp;</code></li><li>Connect to the HA via Bluetooth - <code>bluetoothctl connect 00:42:8E:42:EC:42</code></li><li>Ensure that your HA is set as the target output device</li><li>Play audio and enjoy!</li></ol><p>‚ú® üé∂ Hapy streaming! üé∂ ‚ú®</p></div></div>
  </body>
</html>
