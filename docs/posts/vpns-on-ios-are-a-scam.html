<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.michaelhorowitz.com/VPNs.on.iOS.are.scam.php">Original</a>
    <h1>VPNs on iOS are a scam</h1>
    
    <div id="readability-page-1" class="page"><div> 
<p>UPDATE HISTORY
</p>  
  
<h3>TL;DR</h3>

<p>VPNs on iOS are broken. At first, they appear to work fine. The iOS device gets a new public IP address and new DNS servers. Data is sent to the VPN server. But, over time, a detailed inspection of data leaving the iOS device shows that the VPN tunnel leaks. Data leaves the iOS device outside of the VPN tunnel. This is not a classic/legacy DNS leak, it is a data leak. I confirmed this using multiple types of VPN and software from multiple VPN providers. The latest version of iOS that I tested with is 15.6. This data leak was <a href="https://protonvpn.com/blog/apple-ios-vulnerability-disclosure/">first publicized</a> by ProtonVPN in March 2020 and iOS v13.  
<span>(Added this section on Aug. 5, 2022)</span></p> 

<h3>Introduction</h3>
<p>The <a href="https://defensivecomputingchecklist.com/vpn.php">VPN page</a>  of my <a href="https://defensivecomputingchecklist.com">DefensiveComputingChecklist.com</a>  site has a section with assorted tires that can be kicked to verify that a VPN is working. Some things are obvious, like checking for a new public IP address, new DNS servers and checking that WebRTC is disabled. This blog is about a less than obvious VPN test, one that requires a professional class router.  </p>

<p>The basis for this is quite simple. Once a VPN connection (the official term is a &#34;tunnel&#34;) is established, all data coming and going from the VPN-connected device is supposed to go through the VPN. Does it? That&#39;s what I set out to verify. Certainly <i>most</i> data passes through the VPN tunnel, but I was curious about <i>all</i> data.</p>

<p>Granted, some VPN software supports an option called split tunneling which breaks this simple rule, but that does not interest me. I just want to verify that the VPN tunnel is the all-consuming thing it&#39;s supposed to be. That resistance to it is futile. That the tunnel assimilates all the bits and bytes coming and going between the device in question and the Internet.  </p>

<p>I don&#39;t come to the topic at random. In researching <a href="https://defensivecomputingchecklist.com/vpn.php">my VPN writeup</a>,  I ran across a March 2020 blog by ProtonVPN, <a href="https://protonvpn.com/blog/apple-ios-vulnerability-disclosure/">VPN bypass vulnerability in Apple iOS</a>, that describes a bug in iOS 13 and 14. The nature of the bug is that the VPN tunnel does not assimilate all the bits. Some escape. The Borg would not be happy. </p>

<p>What ProtonVPN wrote about is a VPN leak, rather than a DNS leak. Connections that exist at the time the VPN tunnel is created,  should be terminated and re-started so that they travel through the VPN tunnel. In iOS 13 and 14, this does not happen, at least not by default.</p>
<p>Interestingly, the Windscribe desktop VPN client software has an option for this, called &#34;Kill TCP sockets after connection&#34; (see <a href="https://windscribe.com/support/article/20/tcp-socket-termination">TCP Socket Termination</a>). However, the option does not exist in their iOS software. I checked a handful of  iOS VPN clients for other VPN providers and found none with an option about terminating existing connections/sockets when establishing the VPN tunnel.</p> 
 
<p>I am following up on the ProtonVPN blog for a couple reasons. For one, it was last updated in October 2020 when iOS 14 was first released. iOS is now at version 15. And, the last update said that a new iOS feature would soon be included in their app to fix the problem. But, ProtonVPN never followed up on this. Did they add this new feature? Does it fix the problem? They left the issue hanging. </p>

<h3>METHODOLOGY</h3>

<p>My methodology is simple, I will log every new outbound request from my iPad (in other contexts a &#34;request&#34; might be called a socket, a session, a connection or a thread). I will start the logging, establish a VPN connection and use the iPad normally. If all goes well, I should see the outbound request(s) that establish the VPN tunnel and nothing else afterwards. If all data travels through the VPN connection/tunnel, the router will see no new outbound requests from the iPad, after the VPN tunnel has been established.
<!-- In Star Trek terms, the Borg will be assimilating everything into the VPN hive :-)  --> </p> 

<p>Although the testing is simple, it is not something that most people can do. Consumer routers, and those provided by an ISP, are not going to have the ability to log outbound requests. This may well have  contributed to the bug in iOS going undetected for a long time.</p>

<p>The outbound firewall rule that logged requests from the iPad is shown below. It keys off the LAN side IP address of my iPad and logs any new outbound request that it makes. (the LAN side address of my iPad was not actually 10.1.2.3). I tested with a Peplink Balance 20x router running firmware 8.2.0. </p>
<!-- centered image -->  
<div>
     <p><img src="https://donnywinston.com/posts/fers-identifier-services/pix/ios.vpn.testing.fw.logging.rule.jpg" alt="Outbound Firewall rule in Peplink router" title="Outbound Firewall rule in Peplink router"/></p></div> 

<h3>FIRST TEST</h3>

<p>During the first test, the iPad was running  iOS version 15.4.1. I tested using version 3.1.3 (2205050847)  of the ProtonVPN app. The app made an IKEv2 connection to a VPN server in Spain at IP address  37.19.214.3. Both the app (<a href="https://donnywinston.com/posts/fers-identifier-services/pix/ios.vpn.testing.proton.status.webp">screen shot)</a> and a couple web sites confirmed that the public IP address was 37.19.214.3.
 
</p><p>In simplified form, this is what the router log showed just after I started the VPN connection: 
 
</p><table>
<tbody><tr><td>
11:57:52  SRC=10.1.2.3 DST=37.19.214.1    LEN=408  PROTO=UDP SPT=4500  DPT=4500  </td></tr><tr>
<td> Establishing the IKEv2 VPN tunnel </td></tr></tbody></table> 

<p>The most important take-away from this is that the VPN tunnel was established at 11:57:52. </p>
<p>As for the data items in the log: SRC is the source IP address, DST is the destination IP address, LEN is the length of the outgoing data, PROTO is the protocol (TCP or UDP), SPT is source port, and DPT is the destination port. Not sure what SYN is.</p>

<p>It is interesting to note that while the public IP address is 37.19.214.3, the two UDP outbound connections were made to 37.19.214.1. I have seen this before with assorted VPNs (not just IKEv2 but also with OpenVPN) and I can&#39;t explain it. Also, establishing the IKEv2 connection was done with two outbound UDP requests, first to port 4500 (from port 4500) and then to port 500 (from port 500). I am no expert on the IKEv2 protocol and can not explain why it does this.</p><p>We also see that there were two other outbound requests made the same second that the VPN tunnel was established. For my purposes, neither was important. One was a TCP request to 23.200.168.178 on port 443 (HTTPS). <a href="https://www.shodan.io/host/23.200.168.178">According to Shodan</a>, this IP address is mesu.apple.com. The other was a TCP request to 137.220.51.178 also on port 443. This is dns.nextdns.io and not a surprise to see since the router is using NextDNS with DoH.</p> 
 
<p>Curious about the difference between the reported public IP address and the one that the router log showed it connecting to, I checked what Peplink calls the Active Sessions for the iPad. As shown below, this was the first indication of trouble.</p>    
 <!-- centered image -->  
<div>
     <p><img src="https://donnywinston.com/posts/fers-identifier-services/pix/ios.vpn.testing.sessions.jpg" alt="Active Sessions for iPad after VPN established" title="Active Sessions for iPad after VPN established"/></p></div> 

<p>While this confirms that the iPad is actually connected to the IP address ending in 1 rather than 3, it also shows a connection/session that is not the VPN tunnel. 	Although the tunnel was established when I made this screen shot, the iPad was still communicating with port 5223 at IP address 17.57.144.12. Peplink identified this as Apple Push. </p> 

<p>The bug that ProtonVPN first wrote about in March 2020, <b>still exists</b>. iOS 15.4.1 still does not terminate existing connections/sessions when it creates a VPN tunnel. This presents assorted dangers. Connections outside the VPN communicate your real public IP address and there is no guarantee that they are encrypted. They are also vulnerable to ISP spying. And, a VPN provides what should be a trustworthy DNS service. Outside the VPN, anything goes.</p> 

<p>Next, I used assorted apps on the iPad and watched the router log. </p>
<p>Twenty eight minutes after the VPN connection was established, this showed up in the log. </p>

 <table>
<tbody><tr><td> 
12:26:33 SRC=10.1.2.3 DST=137.220.51.178 LEN=589  PROTO=TCP SPT=57026 DPT=443  SYN  <br/> 
</td></tr><tr>
<td> A request to NextDNS outside the VPN tunnel </td></tr></tbody></table> 
  
<p>Another request to dns.nextdns.io. Not good. </p>

<h3>A FLOOD</h3> 

<p>Twelve minutes later, a flood. </p> 

 <table>
<tbody><tr><td> 
 12:41:21	  SRC=10.1.2.3  DST=99.99.99.99 LEN=44   PROTO=UDP SPT=57740 DPT=57740</td></tr><tr>
<td> The flood gates are open!</td></tr></tbody></table> 
  
<p>At this point I stopped the activity logging to avoid flooding the router log.</p> 
<p>My first thought was that the VPN connection had failed. But no, ProtonVPN <a href="https://donnywinston.com/posts/fers-identifier-services/pix/ios.vpn.testing.proton.status.webp">reported</a> that the connection to Madrid had been active for 49 minutes. The  flood started at roughly 12:39 PM and VPN connection was first made at 11:58 AM. To borrow a phrase from Apollo 13: Cupertino, we have a problem. </p>

<p>Speaking of the VPN, the iPad made the same two IKEv2 connections at 12:38:58 - a UDP request to port 4500 and a UDP request to port 500, both to the currently in-use VPN server (37.19.214.1). Maybe there are keys that need to re-established? I don&#39;t know.</p> 
<p>There is so much else to look at in the 2.5 minutes of activity shown above. </p>
<p>Perhaps the biggest mystery is the 28 requests to IP address 99.99.99.99. That was not the actual IP address; I changed it because the actual address was my public IP. This makes no sense at all, at least not to me. All the requests were UDP and the same length  (44). Looking at just those 28 requests a pattern emerges, as shown below. There were three different target ports and the source port number was always the same as the destination port number. Stranger still.</p> 

 <table>
<tbody><tr><td> 
 12:41:21	    SPT=57740 DPT=57740 </td></tr><tr>
<td>  iPad requests to my public IP address  </td></tr></tbody></table> 
  
<p>Adding to the mystery is the port numbers the iPad tried to contact.  To say the least, they are off the beaten path. Since the activity log is from 
the router, we can not tell if the outbound requests were from iOS itself or a third party app. Apple documents the  <a href="https://support.apple.com/en-us/HT202944">TCP and UDP ports used by Apple software products</a> and the only port documented to be used by iOS is 16403 which is used by the Game Center. I have never installed or played a game on the iPad in question. The two other ports, 57740 and 65009, have <a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">no standard usage</a>. </p>

<p>The 20 outbound requests that were not to my public IP address and not the in-use VPN server are shown below.</p>

 <table>
<tbody><tr><td> 
 12:41:00	  DST=17.178.104.183 LEN=44   PROTO=UDP SPT=65009 DPT=16386 </td></tr><tr>
<td> The parts of the flood that were not to my public IP address </td></tr></tbody></table> 
  
 <p>The first request (12:38:58) mimics one we have seen before, the target is NextDNS on the expected port (443). Interestingly, this was the only TCP request, all the rest were UDP.</p> 
 
 <p>The next three requests were to UDP port 123, which is the Time of Day port. The target IP addresses all start with 17.253 and are clearly NTP time servers owned by Apple. Here again, the 99 is a placeholder for a number, I am not publishing the exact IP addresses for reasons that are off topic. These requests occurred in the same second as the call out to NextDNS. 
 <!-- The only open port that Shodan reports on these IP addresses is 123 so they seem dedicated to their task. --> 

</p><p>The remaining 16 requests were to only two IP addresses:  17.178.104.182 and  17.178.104.183. Both belong to Apple. Certainly it is fair to say, at this point, that the flood of outbound requests that bypassed the VPN tunnel came from iOS itself. </p> 
<!-- What had the iPad been doing? Updating some apps in the app store.   -->

<p>The destination ports at the two Apple IP addresses were 16384, 16385 and 16386 so they clearly have a common purpose. According 
  <a href="https://support.apple.com/en-us/HT202944">to Apple</a> these UDP ports are used for either the Real-Time Transport Protocol or Real-Time Control Protocol by either FaceTime or Game Center. I was not using FaceTime or playing a game on the iPad. Also, the source port numbers look awfully familiar. </p>  
  

<h3>SECOND TEST</h3> 

<p>To verify that the bug is in iOS itself, I ran a second test under different conditions. </p> 
<p>The first thing I changed was the OS; the iPad was updated to version 15.5, which, as I write this, is the latest version. I also changed VPN providers, software and protocols. This test used an iOS app from OVPN that only supports WireGuard.</p>
<p>The OVPN app was version 0.5.0 from Feb. 19, 2022. The VPN server that I connected to was 139.28.219.36 in France. My test procedure was the same: I configured the Peplink Balance 20x router to  log all outbound connections made by the iPad, I connected to the VPN, used the iPad and watched the router log. </p>

<p>This time, the establishing of the VPN tunnel seemed to be done with a single outbound UDP connection (shown below) to port 9929 at 139.28.219.35. 

 </p><table>
<tbody><tr><td>
16:08:59	SRC=10.1.2.3 DST=139.28.219.35 LEN=176  PROTO=UDP SPT=50700 DPT=9929</td></tr><tr>
<td> Establishing the WireGuard VPN tunnel </td></tr></tbody></table> 

<p>As with the first test, which used IKEv2, the IP address that the world sees is one off from the IP address that the router connected to. I made a <a href="https://donnywinston.com/posts/fers-identifier-services/pix/ios.vpn.testing.ovpn.status.webp">screen shot</a> of the OVPN app which shows a public IP address of 139.28.219.36, one higher than the IP the router connected to. Other web sites confirmed this as the public IP.  Some day, I have learn why this happens. </p>

<p>After the VPN was established, I checked the Active Sessions for the iPad. The only connection the router showed was the VPN tunnel. No Apple Push this time.</p>
<p>I used the iPad and watched the log...</p>
<p>Seven minutes later <b>another flood</b> of requests are seen traveling outside the VPN tunnel. I stopped the router logging after the flood shown below. I am simply interested in whether there is a problem, yes or no. I am not interested in fully defining/debugging the problem. That&#39;s for Apple.</p>
 
 
<p>As before, there were many requests to my public IP address. Quite the puzzlement. They were all UDP and the Source Port number (SPT) was always the same as the Destination Port number (DPT). The table below shows these connections. It is sorted by destination/target port, rather than time of day, to better show the three destination ports: 16403,  51941 and 52666. Just for fun, a Google search for &#34;Apple iOS UDP port 52666&#34; turned up nothing. </p> 
   
<table>
<tbody><tr><td>
16:16:46	 SRC=10.1.2.3   ID=59313 PROTO=UDP SPT=16403 DPT=16403  </td></tr><tr>
<td> Outbound iPad requests to my Public IP address (WireGuard) </td></tr></tbody></table> 

 
 <p>The outbound requests to the actual Internet, shown below, fall into two categories. The last/top two requests were to IP addresses belonging to Amazon Web Services in Europe. 
 They were TCP requests to the normal, ordinary, commonplace HTTPS port (443). </p>
 <p>The rest were to Apple owned IP addresses on UDP ports 16384, 16385 and 16386. Same as the first test. Again, I am not publishing the exact Apple IP addresses (99.99 is a stand-in) for reasons that are off topic. </p>
 
 <table>
<tbody><tr><td>
16:22:34	 SRC=10.1.2.3 DST=15.160.79.209 ID=0  PROTO=TCP SPT=49173 DPT=443</td></tr><tr>
<td> Outbound iPad requests to the Internet (WireGuard) </td></tr></tbody></table> 


<h3>WRAPPING UP</h3> 

<p>Comedian <a href="https://en.wikipedia.org/wiki/Steven_Wright">Steven Wright</a> used to joke that he had to get a new shadow because the old one wasn&#39;t doing what he was doing. That&#39;s what we have here. A VPN that is not doing what it is supposed to do. Data is leaving my iPad and not traveling through the VPN tunnel.</p>

<p>It is surprising to find this problem has persisted for so long. My testing took very little hardware, software or expertise. With the billions of iOS users, it is hard to imagine that no one else bothered testing this. Then again, the world was a bit distracted in March of 2020. </p>

<p>It also seems that Apple has a level of trust that they do not deserve. Back in March 2020, Steve Gibson <a href="https://www.grc.com/sn/sn-760.htm">said</a> &#34;... Apple&#39;s going to fix this. I&#39;m sure it&#39;s already been fixed in-house. They&#39;re probably moments away from pushing out a fix to this because it&#39;s gotten a lot of attention in the industry ...  I imagine within a few days this&#39;ll be fixed.&#34; A slightly more skeptical John Dunn of Sophos <a href="https://nakedsecurity.sophos.com/2020/03/30/apples-ios-13-4-hit-by-vpn-bypass-vulnerability/">wrote</a> at the time that &#34;A patch might not appear for weeks&#34;. It has been over two years. </p>
 
<p>I emailed Apple at their special email address for reporting security issues on May 19, 2022 and, for a week, there was no response. On May 26th, I emailed again and, this time, Apple responded the next day. More on this below in the section on Where This Stands.  </p>

<p>If you are thinking about <a href="https://www.torproject.org">Tor</a>, don&#39;t. For one thing, there is no official Tor software for iOS. More importantly, Tor does not work at the operating system level. The software given out by the Tor project is a web browser. </p>


<h3 id="workarounds">WORK-AROUNDS</h3> 

<p>[This section was totally re-written May 28, 2022]</p> 

<p>One suggested solution was an <b>always-on VPN</b>. Quoting ProtonVPN: <i>&#34;Apple recommends using <a href="https://support.apple.com/guide/deployment/vpn-overview-depae3d361d0/1/web/1.0">Always-on VPN</a> to mitigate this issue. This method requires using device management, so unfortunately it doesn’t mitigate the issue for third-party applications such as Proton VPN.&#34;</i> So, not a solution for us consumers. But, ProtonVPN had two other suggested work-arounds. </p> 

<p>The last update to the ProtonVPN blog (dated Oct. 19, 2020) said <i>&#34;Although Apple has not fixed the VPN bypass problem directly on iOS 14, they have provided the Kill Switch capability to app developers. By enabling Kill Switch, existing connections will be blocked whenever VPN is enabled. We will be adding this capability in an upcoming release of Proton VPN.&#34;</i> This is a puzzling statement as the purpose of a VPN <b>Kill Switch</b>  is to disconnect the Internet should the VPN tunnel fail. It is not normally involved in existing connections at the time the VPN is enabled. </p>

<p>Since the blog was written, ProtonVPN has indeed added a kill switch option to their iOS app (see <a href="https://donnywinston.com/posts/fers-identifier-services/pix/protonvpn.ios.app.settings.webp">screen shot</a>). The description of the feature in the app is <i>&#34;blocks all network traffic when VPN tunnel is lost&#34;</i>, which is par for the course as Kill Switches go. It also has 
<i>nothing</i> to do with leaks outside the VPN tunnel while the tunnel is alive and well. Apples and Oranges. </p>

<p>Still, I tested for VPN leaks with the Kill Switch enabled (it is disabled by default). It made no difference, the VPN still leaked. You can see this below.</p> 

<p>The VPN tunnel is the UDP connection from port 4500 to port 4500 at IP address 188.241.83.106, which is ProtonVPN in Paris. We 
also see the iPad has  two TCP connections labeled &#34;Secure IMAP/Gmail&#34;.
  Both connections are to port 993 at IP address 172.253.62.108. Shodan reports that this IP address is indeed <a href="https://www.shodan.io/host/172.253.62.108">used for Gmail</a>.  And Google does use port 993 for <a href="https://support.google.com/mail/answer/7126229">IMAP access to Gmail</a>. 
 
</p><div>
     <p><img src="https://donnywinston.com/posts/fers-identifier-services/pix/gmail.outside.tunnel.webp" alt="Activxxxxxxblished" title="Acxxxxxxablished"/></p></div> 

<p>The last suggested work-around involved using <b>Airplane Mode</b> to disconnect the VPN. Funny thing about Airplane Mode on my Wi-Fi only iPad running iOS 15.5. <i>It does not seem to do anything</i>.</p>

<p> With the Wi-Fi on, I enabled Airplane Mode and the Wi-fi did not go off (see <a href="https://donnywinston.com/posts/fers-identifier-services/pix/airplane.mode.and.wifi.webp">screen shot</a>). I also found that Airplane Mode did not interrupt an active VPN connection. I made a WireGuard connection using OVPN, then turned on Airplane Mode and the VPN connection remained alive and well.</p>

 <!--  Here you can see TuneIn radio playing a radio station. If zoom in on the top right corner, you will see that both Airplane Mode is on and that there is a VPN connection (this time OVPN with WireGuard). 
see me playing a French radio station with Airplane Mode on.  airplane.mode.and.vpn.webp    zoom in airplane.mode.vpn.zoomedin.webp to more easily see   --> 
 
<p>With that as background, here is exactly what ProtonVPN said regarding this last work-around:</p> 

<p>Internet connections established after you connect to VPN are not affected. But connections that are already running when you connect to VPN may continue outside the VPN tunnel indefinitely. There is no way to guarantee that those connections will be closed at the moment you start a VPN connection. However, we&#39;ve discovered the following technique to be almost as effective:</p>
	
<p>First thing to notice is that this is something ProtonVPN discovered, it is not advice from Apple. Then, there are the hedging phrases: <i>&#34;almost as effective&#34;</i> and <i>&#34;we cannot guarantee&#34;</i>.  
</p><p>Still, how can it be that in their testing, Airplane Mode killed all Internet connections and in my testing it did not? Perhaps another bug in iOS? Or, maybe because blog was written for iOS 13 and I tested with iOS 15.5? I dug out an old iPod running iOS 12.5.5 and, sure enough, Airplane Mode turned off the Wi-Fi. </p>

<p>A bit of Googling turned up this Apple support item:  <a href="https://support.apple.com/en-us/HT204234">Use Airplane Mode on your iPhone, iPad, iPod touch, and Apple Watch</a> from September 2021. At first, the article says <i>&#34;When you turn on Airplane Mode, it turns off all radios except for Bluetooth&#34;</i>.  But later it says 
<i>&#34;you can use Wi-Fi and Bluetooth while in Airplane Mode. You just need to turn them on separately&#34;</i> and <i>&#34;If you turn on Wi-Fi or Bluetooth while you&#39;re in Airplane Mode, they&#39;ll be on the next time you use Airplane Mode, unless you turn them off while in Airplane Mode.&#34;</i> So, Airplane Mode is like a box of chocolates, you never know what you&#39;re gonna get. </p>
<!--The explanation is miserable.  https://discussions.apple.com/thread/253914499 Why does my air plane mode on my iPad not turn off my Wi-Fi -->
 
<p>All told, this a poor look for the tech support team at ProtonVPN. Even if Airplane Mode is a work-around, they failed to explain all the issues with it. And, the suggestion that the Kill Switch is applicable at all, was off-base. Worse than their blog, when I contacted them recently about this, they said I should use the Kill Switch. Ugh.</p>


<h3 id="testingairplane">TESTING AIRPLANE MODE</h3> 
<p>Added this section on May 30, 2022</p>  

<p>I fought through the poorly written Apple support article about Airplane Mode, such that enabling it on my iPad would disable the Wi-Fi. And, then things got ugly.</p> 
 
<p>With Airplane Mode OFF, the Settings app shows that Wi-Fi is connected, displaying the SSID of my network. But, there is no Wi-Fi icon in the top right corner of the iPad display (the half circles next to the battery percentage). So, is it on or not? No web pages would load, in multiple browsers, so it seems not. That the Settings app tells me it is connected to Wi-Fi seems like a bug. </p>
<p>Interestingly, my router also reported a half-connected state. While it showed the iPad in the list of connected devices, there were no active connections from the iPad to anywhere on the Internet. I did not bother with firewall logging. </p> 
<p>The Wi-Fi connection was defined to use a Private Wi-Fi Address (really a MAC address). I turned this off, in the hope it was part of the problem. This reset the Wi-Fi connection. The router showed the iPad as a connected device with the new MAC/WiFi address, however, web pages would still not load and there was still no Wi-Fi indicator in the top right corner.</p> 
<p>Airplane Mode broke my iPad.</p>

<p>At this point I turned the iPad off, waited a minute and turned it back on. When it booted, the Wi-Fi indicator in the top right corner was on, then went off, then it came back on  along with the VPN indicator. VPN? I wasn&#39;t doing anything with a VPN. I wasn&#39;t but ProtonVPN was. Their app (version 3.1.3) has an Always-on VPN option that is, sadly, not an option. It is always on. </p>
<p>I turned off the ProtonVPN connection and all was well with the Wi-Fi.  My guess is that something went wrong between Airplane Mode and the Always-on option. You&#39;re on. You&#39;re off. You&#39;re on. You&#39;re off. </p> 

<p>I seem to be accumulating bugs, not only on the iPad but also in my Peplink Balance 20x router. While testing Airplane Mode, I was checking all the active sessions/connections from all the devices connected to the router (there were very few). I saw an active session for a device that I did not realize was connected. So, I turned off the Wi-Fi on the device. Surprisingly,  the active session remained for what seemed quite a while. The router reported that the device went off-line, but a session remained active. I reported it as a bug to Peplink.  Any comments above, about Active Sessions shown by the router, are now suspect. Ugh.  </p>  


<h3>YET ANOTHER TEST</h3> 
<p>Added this section on June 16, 2022</p>  

<p>I have been in contact with Apple about this and they requested a dump of the system, after the problem happens, so I did another test. I was able to re-create the problem, this time using VPN software from Windscribe that made an OpenVPN connection. Using VPN software from three different VPN companies clearly points at iOS itself as the source of the problem.</p>
<p>After the VPN connection was made, I tried a number of apps and none generate traffic outside the VPN tunnel. It was not until I went into the iOS app store, to update some apps, that the flood of traffic outside the tunnel started. As before, there were requests to both Apple IP addresses and my public IP address. </p>
 
<h3 id="mysuggestion">MY SUGGESTION</h3> 

<p>At this point, I see no reason to trust any VPN on iOS. My suggestion would be to make the VPN connection using VPN client software in a router, rather than on an iOS device.</p>

<p>I am not a fan of making a VPN connection on your <i>only</i> router, but suggest having a second router dedicated to VPN connections. When you need a VPN, connect to the second router (Wi-Fi or Ethernet), when you don&#39;t need a VPN, connect to your main router. </p>

<p>I recommend <a href="https://www.pcwrt.com/">pcWRT</a> as a second router dedicated to VPN usage. I recently wrote up my  <a href="https://www.routersecurity.org/pcwrt.php">experiences with it</a>. There is only one model and it sells for $129 US. It offers three VPN clients, for WireGuard, OpenVPN and IKEv2. I ran the same evaluation on pcWRT that I did here for iOS. In fact, I ran it for days on end and found no data that ever traveled outside the VPN tunnels created by the pcWRT router. Here on iOS, it took only a few minutes to find a VPN leak. </p>

 <h3 id="wherestands">WHERE THIS STANDS</h3> 

 <p>July 3, 2022:  I first contacted Apple about this at the end of May 2022. Since then, there have been a number of emails between myself and the company (yes, plain old un-encrypted email - no security at all). To date, roughly five weeks later, Apple has said virtually nothing to me. They have not said whether they tried to re-create the problem. They have not said whether they agree on this being a bug. They have not said anything about a fix. </p>

<p>It takes so little time and effort to re-create this, and the problem is so consistent, that if they tried at all, they should have been able to re-create it. None of my business. Maybe they are hoping, that like ProtonVPN, I will just move on and drop it. Dunno.</p>

<p>July 31, 2022: iOS 15.6 was released a couple days ago. My tests with this new version are below. Also, I recently learned that Apple owns all IP addresses that start with 17.</p> 
<p>August 10, 2022: I emailed <a href="https://www.cisa.gov/">CISA</a> about this six times. No response. </p>
<p>August 15, 2022: I finally ran a different trace. This time, I used a pcWRT router which has Parental Controls. Part of the parental controls is a feature that shows the domains accessed by each device connected to the router. I set that up, then connected my iOS 15.6 iPad to the pcWRT router and made  a WireGuard connection using ProtonVPN. As I used the iPad, the pcWRT router showed increasing requests to apple.com well after the VPN had been established. If I get a chance, I will add screen shots here.</p>  


<h3 id="test156">TESTING iOS 15.6</h3> 
<p>Added this section on August 8, 2022</p>  

<p>The VPN still leaks on iOS version 15.6.</p>
<p> I powered off my iPad and powered it back on to start with a clean slate. Using the ProtonVPN app version 4.0.0, I made a WireGuard connection to a server in London at <span>37.120.198.179</span>. 

</p><p>As always, with the VPN connected, my router (Peplink Balance 20X firmware 8.2.0) showed multiple sockets/sessions. A VPN that does not leak, should have only one. But, there seems to be a Peplink bug in this regard, they report active sockets/sessions even after a device has gone off-line. I reported this to Peplink and have heard nothing back for quite a while. So, this counts for nothing, just an FYI. Still, after a few minutes the other sessions seem to have timed out and the router showed just one socket/session to the VPN server. </p>
 
<p>Then, after I started the Gmail app on the iPad, I saw these two new sockets/sessions. </p>
   <!-- centered image -->  
<div>
     <p><img src="https://donnywinston.com/posts/fers-identifier-services/pix/ios.vpn.leaking.version15.6.webp" alt="Two VPN data leaks" title="Two VPN data leaks"/></p></div> 
	 
<p>Apple owns all IP addresses that start with 17, and the outbound request to TCP port 5223 at <span>17.57.147.5</span> is identified by the router as Apple Push. Google owns all IP addresses that start with 172.253 and the outbound request to TCP port 993 at  <span>172.253.63.109</span> is clearly Gmail.</p>

<p>For whatever reason these outbound requests did not show up in the router&#39;s firewall log. However, the log did show outbound TCP requests to 
 <span>104.70.71.223</span> on ports 59922, 59924, 59925, 59926, 59927, 59928 and 59929. There was also an outbound request to the missing TCP port in this sequence, 59923, but that went to  <span>23.62.24.145</span>. Both of these destination IP addresses belong to Akamai. </p>

 <p> - - - - - - - - - - - -</p>
<p>Then, I tested with a different router, a Pepwave Surf SOHO running firmware 8.2.1. I also used an app from a different VPN provider (Windscribe with app version 3.3.0) 
and used OpenVPN rather than WireGuard. OpenVPN connected via UDP to port 123 (this non-standard port is a configuration option offered by the Windscribe app).  The app 
said that I was connected to a VPN server in Vancouver Canada  <span>104.218.61.20</span> and this was confirmed by a site that displays the public IP address. 
As we have seen before in other tests, the router disagreed, it said there was a connection to <span>104.218.61.1</span>. </p>

<p>I watched the router display of current sockets/sessions until it showed the single connection to the VPN server. Shortly thereafter, it showed a new socket, to TCP port 5223 at IP 
address  <span>17.57.147.5</span> which belongs to Apple. The interesting thing was that I had not touched the iPad at all. </p>

<p>Then, I turned on logging and it quickly showed a bunch of outbound requests to two IP addresses that start with 185 (see below). These requests were blocked due to other firewall rules in the router, but had these requests traveled through the VPN tunnel, the router would not have objected. So, more leaking. Interestingly, it appears that these two IP addresses might belong to Windscribe. I will follow up with them. If so, then their app is leaking data. </p>

<table>
<tbody><tr><td>
16:38:49	    DST=185.245.85.99  LEN=48 PROTO=TCP SPT=49394 DPT=443</td></tr><tr>
<td> VPN Leaks to IPs starting with 185 </td></tr></tbody></table> 
 
<p>Soon thereafter, the log showed more outbound requests outside the VPN tunnel (see below).  These were all to Apple, targeting UDP ports 16384, 16385 and 16386. </p>
  
<table>
<tbody><tr><td>
16:49:29 DST=17.133.234.32 ID=4183  PROTO=UDP SPT=50904 DPT=16385</td></tr><tr>
<td> More VPN Leaks - to Apple using UDP </td></tr></tbody></table> 
 
<p>And finally, still more leaks, before I gave up and shut down logging:</p>

<table>
<tbody><tr><td> 
16:51:13	 DST=96.6.22.62     PROTO=TCP SPT=64498 DPT=443</td></tr><tr>
<td> Still more VPN Leaks to assorted destinations </td></tr></tbody></table> 
 
<p>A couple of these IP address belong to Akamai, and they serve many different Apple domains and sub-domains, according to an IP address search at Shodan. 
 One of the Akamai IP addresses (<span>23.54.68.44</span>) seems dedicated to mesu.apple.com. IP address <span>104.20.93.59</span> seems to belong to Windscribe.   The final IP address, <span>137.220.51.178</span>, is NextDNS. 
  
</p><p>Leak, leak, leak.</p> 
  
</div></div>
  </body>
</html>
