<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/supabase/pg_netstat">Original</a>
    <h1>Show HN: pg_netstat, a Postgres extension to monitor database network traffic</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<hr/>
<p dir="auto"><strong>Source Code</strong>: <a href="https://github.com/supabase/pg_netstat"></a><a href="https://github.com/supabase/pg_netstat">https://github.com/supabase/pg_netstat</a></p>
<hr/>
<h3 dir="auto"><a id="user-content-overview" aria-hidden="true" href="#overview"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Overview</h3>
<p dir="auto"><code>pg_netstat</code> monitors your PostgreSQL database network traffic.</p>
<p dir="auto">This extension runs a background worker to capture network packets on the Postgres port, and provides realtime network stats data by a view <code>pg_netstat</code>. It uses <a href="https://www.tcpdump.org/manpages/pcap.3pcap.html" rel="nofollow">libpcap</a> to capture packets and aggregates at user-specified interval.</p>
<p dir="auto">The <code>pg_netstat</code> view can contain at most <strong>60</strong> history rows and discards the oldest rows when it is full, so choose your interval wisely.</p>
<h3 dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h3>
<p dir="auto">You can query realtime network stats through the <code>pg_netstat</code> view.</p>
<div dir="auto" data-snippet-clipboard-copy-content="select * from pg_netstat;"><pre><span>select</span> <span>*</span> <span>from</span> pg_netstat;</pre></div>
<p dir="auto">Query result is like below:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://user-images.githubusercontent.com/19306324/185877241-2fe2f1cd-193b-4334-bf22-d0fd6f95dfa3.png"><img width="1224" alt="image" src="https://user-images.githubusercontent.com/19306324/185877241-2fe2f1cd-193b-4334-bf22-d0fd6f95dfa3.png"/></a></p>
<h3 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h3>
<p dir="auto"><strong>Prerequisites</strong></p>
<ul dir="auto">
<li>
<p dir="auto">Before install this extension, you need to give network packet capture permission to Postgres binary. For example,</p>
<div data-snippet-clipboard-copy-content="sudo setcap cap_net_raw,cap_net_admin=eip /usr/local/pgsql/bin/postgres"><pre><code>sudo setcap cap_net_raw,cap_net_admin=eip /usr/local/pgsql/bin/postgres
</code></pre></div>
</li>
<li>
<p dir="auto"><code>libpcap</code> library should be installed too, for example,</p>
<div data-snippet-clipboard-copy-content="sudo apt-get install libpcap-dev"><pre><code>sudo apt-get install libpcap-dev
</code></pre></div>
</li>
</ul>
<p dir="auto">After that, we can then start the installation. Download this repo and set up <a href="https://github.com/tcdi/pgx"><code>pgx</code></a>:</p>

<p dir="auto">After pgx is set up, use below command to build the extension package:</p>
<div data-snippet-clipboard-copy-content="cargo pgx package --pg-config ~/.pgx/14.5/pgx-install/bin/pg_config"><pre><code>cargo pgx package --pg-config ~/.pgx/14.5/pgx-install/bin/pg_config
</code></pre></div>
<p dir="auto">The extension is located at path <code>./target/release/pg_netstat-pg14</code>. For more information, please visit <a href="https://github.com/tcdi/pgx">pgx site</a>.</p>
<p dir="auto">Change <code>postgresql.conf</code> to enable below line:</p>
<div data-snippet-clipboard-copy-content="shared_preload_libraries = &#39;pg_netstat&#39; # (change requires restart)"><pre><code>shared_preload_libraries = &#39;pg_netstat&#39; # (change requires restart)
</code></pre></div>
<p dir="auto">Restart the server and install extension in database:</p>
<div dir="auto" data-snippet-clipboard-copy-content="create extension pg_netstat;

-- check everything is working
select * from pg_netstat;"><pre>create extension pg_netstat;

<span><span>--</span> check everything is working</span>
<span>select</span> <span>*</span> <span>from</span> pg_netstat;</pre></div>
<h3 dir="auto"><a id="user-content-configuration" aria-hidden="true" href="#configuration"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuration</h3>
<p dir="auto">Below are the configurations you can put in <code>postgresql.conf</code> file:</p>
<ol dir="auto">
<li><code>pg_netstat.device</code> - Network device name to capture packets from, default is auto detect</li>
<li><code>pg_netstat.interval</code> - How often network packets to be collected (in seconds), default is <code>10</code></li>
<li><code>pg_netstat.packet_wait_time</code> - How long to wait for network packets to be deliverd to collector (in seconds), default is <code>5</code></li>
<li><code>pg_netstat.pcap_buffer_size</code> - pcap setting for buffer size (in bytes), default is <code>1000000</code></li>
<li><code>pg_netstat.pcap_snaplen</code> - pcap setting for snapshot length (in bytes), default is <code>96</code></li>
<li><code>pg_netstat.pcap_timeout</code> - pcap setting for packet buffer timeout (in milliseconds), default is <code>1000</code></li>
</ol>
<p dir="auto">You can list network device name by running <code>ifconfig</code> command. For example, device name for &#39;localhost&#39; is <code>lo</code>. By default, it uses the first device that is not a <code>loopback</code> network interface.</p>
<p dir="auto">The most useful config is <code>pg_netstat.interval</code>, which defines the stats collection frequency. Its change can be reloaded from config file by using <code>pg_ctl</code> command:</p>
<div data-snippet-clipboard-copy-content="pg_ctl reload -D /path/to/pg-data"><pre><code>pg_ctl reload -D /path/to/pg-data
</code></pre></div>
<p dir="auto">All the others settings are at low level and you probably don&#39;t want to change them. For all the <code>pcap_*</code> settings, see details at <a href="https://www.tcpdump.org/manpages/pcap.3pcap.html" rel="nofollow">https://www.tcpdump.org/manpages/pcap.3pcap.html</a>.</p>
<h3 dir="auto"><a id="user-content-caveats--limitations" aria-hidden="true" href="#caveats--limitations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Caveats &amp; Limitations</h3>
<ul dir="auto">
<li>Windows is not supported, that limitation inherits from <code>pgx</code>.</li>
<li>Currently only supports PostgreSQL v14, if you need other versions supported please <a href="https://github.com/supabase/pg_netstat/issues">raise an issue</a>.</li>
<li>Only one network device can be specified to capture packets from.</li>
<li>Replication haven&#39;t tested yet, use at your own risk.</li>
</ul>
<h3 dir="auto"><a id="user-content-contribution" aria-hidden="true" href="#contribution"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Contribution</h3>
<p dir="auto">All contributions, feature requests, bug report or ideas are welcomed.</p>
<h3 dir="auto"><a id="user-content-license" aria-hidden="true" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>License</h3>
<p dir="auto"><a href="https://github.com/supabase/pg_netstat/blob/main/LICENSE">Apache License Version 2.0</a></p>
</article>
          </div></div>
  </body>
</html>
