<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/facebookexperimental/hermit">Original</a>
    <h1>Hermit is a hermetic and reproducible sandbox for running programs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Hermit forces deterministic execution of arbitrary programs and acts like a
reproducible container. That is, it <em>hermetically</em> isolates the program from
sources of non-determinism such as time, thread interleavings, random number
generation, etc. Guaranteed determinism is a powerful tool and it serves as a
basis for a number of applications, including concurrency stress testing,
record/replay, reproducible builds, and automatic diagnosis of concurrency bugs,
and more.</p>
<p dir="auto">Hermit cannot isolate the guest program from sources of non-determinism such as
file system changes or external network responses. Instead, in order to provide
complete determinism, the user should provide a fixed file system base image
(e.g., with Docker) and disable external networking.</p>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p dir="auto">Hermit is no longer under active development within Meta and is in maintenance
mode. There is a long tail of unsupported system calls that may cause your
program to fail while running under Hermit. Unfortunately, we (the team behind
this project) don&#39;t have the resources to triage issues, fix major bugs, or
add features at this point in time.</p>
<p dir="auto">If you are interested in this project and want to make contributions, please
submit a pull request. We will prioritize merging these over anything else.</p>
</div>

<p dir="auto">Hermit sits between the guest process and the OS intercepting system calls made
by the guest (using <a href="https://github.com/facebookexperimental/reverie">Reverie</a>). In some cases, it can completely replace the
functionality of the kernel and suppress the original system call. In other
cases, it forwards the system call to the kernel and sanitizes the response such
that it is made deterministic.</p>
<p dir="auto">As a concrete example, lets say we have a program that reads random bytes from
<code>/dev/urandom</code>. Hermit will see that the guest opened this file (a known source
of non-determinism) and intercept subsequent reads to this file. Instead of
letting the OS fill a buffer with random bytes, Hermit uses a deterministic
pseudorandom number generator with a fixed seed to fill in the buffer. The
contents of the buffer are then guaranteed to be the same upon every execution
of the program.</p>
<p dir="auto">The most complex source of non-determinism is in the thread scheduler. The way
threads are scheduled by the kernel depends on many external factors, including
the number of physical CPUs or other threads running on the system that require
CPU time. To ensure that the threads of the guest process (and all of its child
processes) are scheduled in a repeatable way, we first make sure that all thread
executions are serialized so that there is effectively only one CPU. Then, we
deterministically pick which thread is allowed to run next. In order to only
allow a thread to run for a fixed number of instructions, we use the CPU&#39;s
Performance Monitoring Unit (PMU) to stop execution after a fixed number of
retired conditional branches (RCBs).</p>
<p dir="auto">Read below about how to build Hermit, and you can get an idea of what it does
from running examples in the <a href="https://blog.paulbiggar.com/facebookexperimental/hermit/blob/main/examples">./examples</a> folder.</p>

<p dir="auto">Hermit is built with the standard Rust cargo tool.</p>

<p dir="auto">This builds the whole cargo workspace. The actual binary is located in target
directory (<code>target/debug/hermit</code>).</p>
<p dir="auto">Then, once you&#39;ve built Hermit, all you need to run your program
deterministically is:</p>

<p dir="auto">After that you can try running it in a concurrency stress testing (chaos) mode,
or varying other parameters of the configuration such as the speed at which
virtual time passes inside the container, or the random number generation seed:</p>
<div dir="auto" data-snippet-clipboard-copy-content="hermit run --chaos --sched-seed=3 &lt;prog&gt;"><pre>hermit run --chaos --sched-seed=3 <span>&lt;</span>prog<span>&gt;</span></pre></div>
<p dir="auto">You can use hermit as a replay-debugger as well, either recording a
non-deterministic execution (real time, real randomness, etc), or repeatedly
running a controlled, deterministic one (virtual time, pseudo-randomness, etc).</p>
<div dir="auto" data-snippet-clipboard-copy-content="hermit record start &lt;prog&gt;
hermit replay"><pre>hermit record start <span>&lt;</span>prog<span>&gt;</span>
hermit replay</pre></div>

<p dir="auto">See the <a href="https://blog.paulbiggar.com/facebookexperimental/hermit/blob/main/examples/README.md">the examples folder</a> for example programs and
instructions on how to run them. These showcase different sources of
nondeterminism, and how hermit eliminates or controls them.</p>
<p dir="auto">In order to explore more advanced examples, you can look at some of the
integration tests built from <a href="https://blog.paulbiggar.com/facebookexperimental/hermit/blob/main/tests">./tests/</a> or
<a href="https://blog.paulbiggar.com/facebookexperimental/hermit/blob/main/flaky-tests">./flaky-tests/</a>. For example, using the commands below you can
run a racey example multiple times to see its nondeterminism. Then run it under
hermit to watch that nondeterminism disappear. Then run it under hermit
<code>--chaos</code> to bring that nondeterminism back, but in a controlled way that can be
reproduced based on the input seed.</p>
<div dir="auto" data-snippet-clipboard-copy-content="cargo build
for ((i=0; i&lt;20; i++)); do ./target/debug/hello_race; done

for ((i=0; i&lt;20; i++)); do hermit run ./target/debug/hello_race; done

for ((i=0; i&lt;20; i++)); do
  hermit run --chaos --seed-from=SystemRandom ./target/debug/hello_race;
done"><pre>cargo build
<span>for</span> <span><span>((</span>i<span>=</span><span>0</span>; i<span>&lt;</span><span>20</span>; i<span>++</span><span>))</span></span><span>;</span> <span>do</span> ./target/debug/hello_race<span>;</span> <span>done</span>

<span>for</span> <span><span>((</span>i<span>=</span><span>0</span>; i<span>&lt;</span><span>20</span>; i<span>++</span><span>))</span></span><span>;</span> <span>do</span> hermit run ./target/debug/hello_race<span>;</span> <span>done</span>

<span>for</span> <span><span>((</span>i<span>=</span><span>0</span>; i<span>&lt;</span><span>20</span>; i<span>++</span><span>))</span></span><span>;</span> <span>do</span>
  hermit run --chaos --seed-from=SystemRandom ./target/debug/hello_race<span>;</span>
<span>done</span></pre></div>

<p dir="auto">At Meta, this repository is built using buck. We have over 700 integration tests
that run under this setup. But as of this initial release (2022-11-21), we have
not ported these tests to an external build system yet.</p>
<p dir="auto">A few unit tests run under <code>cargo test</code>, but the integration tests are more
complicated because they combine various run modes with each of the test
binaries (which are built from <code>tests/</code>, <code>flaky-tests/</code>, and the rr test suite
too).</p>
<p dir="auto">We plan to get the internal Buck configuration files building externally with
buck or bazel.</p>

<p dir="auto">Hermit translates normal, non-deterministic Linux behavior, into deterministic,
repeatable behavior. This can be used for various applications, including:
record/replay debugging, simple reproducibility, &#34;chaos mode&#34; to expose
concurrency bugs in a controlled and repeatable way. Generally, Hermit makes
implicit inputs into explicit ones, and so enables searching over possible
executions by explicitly varying these inputs and study the changes in outcomes.
This can be used for either searching for bugs or trying to narrow down their
causes.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Diagnosing concurrency bugs</h2><a id="user-content-diagnosing-concurrency-bugs" aria-label="Permalink: Diagnosing concurrency bugs" href="#diagnosing-concurrency-bugs"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">One experimental application that Hermit has built-in support for is diagnosing
concurrency bugs, in terms of identifying the stack traces of racing critical
operations which, if their order is flipped in the schedule, cause the program
to crash (also called an &#34;order violation&#34; bug). Hermit can detect these even if
the racing instructions are in different processes and written in different
programming languages.</p>
<p dir="auto">You can kick off analyze with any program invocation, and tell it to search for
failing (and passing) executions, and then diagnose the difference between them.</p>
<div data-snippet-clipboard-copy-content="hermit analyze --search -- &lt;run_args&gt; &lt;prog&gt;"><pre><code>hermit analyze --search -- &lt;run_args&gt; &lt;prog&gt;
</code></pre></div>

<p dir="auto">Hermit is licensed under a BSD-3 clause license, included in the <code>LICENSE</code> file
in this directory.</p>

<p dir="auto">Hermit currently supports x86_64 Linux. Aarch64 support is a work in progress.</p>
</article></div></div>
  </body>
</html>
