<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dxuuu.xyz/bpfilter.html">Original</a>
    <h1>Bpfilter is forever</h1>
    
    <div id="readability-page-1" class="page">

<p>This week it was brought to my attention that <code>bpfilter</code>
might be delaying our kernel boot sequence. The initial thought was that
bpfilter’s usermode upcalls were stalling for some reason and caused
boot time stalls.</p>
<p>While it is true that module initialization for built-in modules (ie.
<code>CONFIG_FOO=y</code>) is serialized and that in theory it is
possible for the boot to be stalled if a module was slow, it turned out
not to be the case for bpfilter, as we had
<code>CONFIG_BPFILTER_UMH=m</code> which actually causes
<code>bpfilter.ko</code> to be built and loaded separately.</p>
<p>So end of story, at least for the important side of the
investigation.</p>
<h3 id="mystery-reloads">Mystery reloads</h3>
<p>While debugging the above, I unloaded and loaded
<code>bpfilter.ko</code> a lot. After one <code>modprobe -r</code>, I
noticed that bpfilter was reloaded without my involvement. It looked
like this:</p>
<pre><code>$ sudo modprobe -r bpfilter
$ lsmod | grep bpf
$ lsmod | grep bpf
$ lsmod | grep bpf
$ lsmod | grep bpf
$ lsmod | grep bpf
$ lsmod | grep bpf
$ lsmod | grep bpf
lsmod | grep bpf
bpfilter               24576  0</code></pre>
<p>No good investigation is without a rabbit hole, so naturally I
fixated on this.</p>
<p>The first thing I checked was <a href="https://www.freedesktop.org/software/systemd/man/modules-load.d.html"><code>modules-load.d</code></a>
and <a href="https://man7.org/linux/man-pages/man5/modprobe.d.5.html"><code>modprobe.d</code></a>.
A thorough <code>grep</code> of the relevant directories for choice
keywords like “bpf” or “bpfilter” turned up nothing. That was all I had
for top-down approaches so I moved to bottom-up.</p>
<h3 id="luckily-we-have-bpftrace">Luckily we have bpftrace</h3>
<p>I had poked around the kernel module subsystem a few weeks back for
an unrelated task so I knew about the entry and exit points:
<code>init_module(2)</code>, <code>finit_module(2)</code>, and
<code>delete_module(2)</code>.</p>
<p>Knowing that, it’s a simple matter of writing a one-liner to monitor
those system calls:</p>
<pre><code>$ sudo bpftrace -e &#39;t:syscalls:sys_enter_*module { printf(&#34;%s: comm=%s\n&#34;, probe, comm) }&#39; &amp;
$ sudo modprobe -r bpfilter
tracepoint:syscalls:sys_enter_delete_module: comm=modprobe
tracepoint:syscalls:sys_enter_finit_module: comm=modprobe</code></pre>
<p>So something is calling <code>modprobe</code>. I was halfway through
writing a wrapper script to stash the parent’s <code>comm</code> in a
file when I remembered that bpfilter will call
<code>request_module()</code> in certain cases.</p>
<p>For the uninitiated, <code>request_module()</code> is a kernel
function that requests userspace load a particular kernel module.
Internally, it performs an upcall to userspace’s
<code>modprobe(8)</code> – exactly the sort of thing we might have seen
above.</p>
<p>Indeed, <code>net/ipv4/bpfilter/sockopt.c</code> confirms this:</p>
<div id="function" data-startfrom="15"><pre><code><span id="function-15"><a href="#function-15"></a><span>static</span> <span>int</span> bpfilter_mbox_request<span>(</span><span>struct</span> sock <span>*</span>sk<span>,</span> <span>int</span> optname<span>,</span> sockptr_t optval<span>,</span></span>
<span id="function-16"><a href="#function-16"></a>                                 <span>unsigned</span> <span>int</span> optlen<span>,</span> <span>bool</span> is_set<span>)</span></span>
<span id="function-17"><a href="#function-17"></a><span>{</span></span>
<span id="function-18"><a href="#function-18"></a>        <span>int</span> err<span>;</span></span>
<span id="function-19"><a href="#function-19"></a>        mutex_lock<span>(&amp;</span>bpfilter_ops<span>.</span>lock<span>);</span></span>
<span id="function-20"><a href="#function-20"></a>        <span>if</span> <span>(!</span>bpfilter_ops<span>.</span>sockopt<span>)</span> <span>{</span></span>
<span id="function-21"><a href="#function-21"></a>                mutex_unlock<span>(&amp;</span>bpfilter_ops<span>.</span>lock<span>);</span></span>
<span id="function-22"><a href="#function-22"></a>                request_module<span>(</span><span>&#34;bpfilter&#34;</span><span>);</span></span>
<span id="function-23"><a href="#function-23"></a>                mutex_lock<span>(&amp;</span>bpfilter_ops<span>.</span>lock<span>);</span></span>
<span id="function-24"><a href="#function-24"></a></span>
<span id="function-25"><a href="#function-25"></a>                <span>if</span> <span>(!</span>bpfilter_ops<span>.</span>sockopt<span>)</span> <span>{</span></span>
<span id="function-26"><a href="#function-26"></a>                        err <span>=</span> <span>-</span>ENOPROTOOPT<span>;</span></span>
<span id="function-27"><a href="#function-27"></a>                        <span>goto</span> out<span>;</span></span>
<span id="function-28"><a href="#function-28"></a>                <span>}</span></span>
<span id="function-29"><a href="#function-29"></a>        <span>}</span></span>
<span id="function-30"><a href="#function-30"></a></span>
<span id="function-31"><a href="#function-31"></a>        <span>[...]</span></span>
<span id="function-32"><a href="#function-32"></a><span>}</span></span></code></pre></div>
<p><code>bpfilter_mbox_request()</code> is called from both the
<code>getsockopt(2)</code> and <code>setsockopt(2)</code> codepaths.
Since <code>getsockopt()</code> seemed like a more common codepath, I
further traced there:</p>
<pre><code>$ sudo bpftrace -e &#39;k:bpfilter_ip_get_sockopt { printf(&#34;comm=%s\n kstack=\n%s\n&#34;, comm, kstack) }&#39;
Attaching 1 probe...
comm=iptables
kstack=

        bpfilter_ip_get_sockopt+1
        raw_getsockopt+52
        sock_common_getsockopt+26
        __sys_getsockopt+181
        __x64_sys_getsockopt+36
        do_syscall_64+87
        entry_SYSCALL_64_after_hwframe+6
</code></pre>
<p>In this case, I didn’t even have to unload the module! It turns out
<code>iptables</code> was regularly calling
<code>getsockopt(2)</code>.</p>
<p>Now the question is why iptables is talking to bpfilter. bpfilter
literally has no functionality, so it does not make sense for iptables
to use it. To answer this, we must look further up the call stack to
where <code>getsockopt()</code> is dispatched to
<code>bpfilter_ip_get_sockopt()</code> – in
<code>net/ipv4/ip_sockglue.c</code>:</p>
<div id="function" data-startfrom="1803"><pre><code><span id="function-1803"><a href="#function-1803"></a><span>int</span> ip_getsockopt<span>(</span><span>struct</span> sock <span>*</span>sk<span>,</span> <span>int</span> level<span>,</span></span>
<span id="function-1804"><a href="#function-1804"></a>                  <span>int</span> optname<span>,</span> <span>char</span> __user <span>*</span>optval<span>,</span> <span>int</span> __user <span>*</span>optlen<span>)</span></span>
<span id="function-1805"><a href="#function-1805"></a><span>{</span></span>
<span id="function-1806"><a href="#function-1806"></a>        <span>int</span> err<span>;</span></span>
<span id="function-1807"><a href="#function-1807"></a></span>
<span id="function-1808"><a href="#function-1808"></a>        err <span>=</span> do_ip_getsockopt<span>(</span>sk<span>,</span> level<span>,</span> optname<span>,</span></span>
<span id="function-1809"><a href="#function-1809"></a>                               USER_SOCKPTR<span>(</span>optval<span>),</span> USER_SOCKPTR<span>(</span>optlen<span>));</span></span>
<span id="function-1810"><a href="#function-1810"></a></span>
<span id="function-1811"><a href="#function-1811"></a><span>#if IS_ENABLED(CONFIG_BPFILTER_UMH)</span></span>
<span id="function-1812"><a href="#function-1812"></a>        <span>if</span> <span>(</span>optname <span>&gt;=</span> BPFILTER_IPT_SO_GET_INFO <span>&amp;&amp;</span></span>
<span id="function-1813"><a href="#function-1813"></a>            optname <span>&lt;</span> BPFILTER_IPT_GET_MAX<span>)</span></span>
<span id="function-1814"><a href="#function-1814"></a>                err <span>=</span> bpfilter_ip_get_sockopt<span>(</span>sk<span>,</span> optname<span>,</span> optval<span>,</span> optlen<span>);</span></span>
<span id="function-1815"><a href="#function-1815"></a><span>#endif</span></span>
<span id="function-1816"><a href="#function-1816"></a><span>#ifdef CONFIG_NETFILTER</span></span>
<span id="function-1817"><a href="#function-1817"></a>        <span>/* we need to exclude all possible ENOPROTOOPTs except default case */</span></span>
<span id="function-1818"><a href="#function-1818"></a>        <span>if</span> <span>(</span>err <span>==</span> <span>-</span>ENOPROTOOPT <span>&amp;&amp;</span> optname <span>!=</span> IP_PKTOPTIONS <span>&amp;&amp;</span></span>
<span id="function-1819"><a href="#function-1819"></a>                        <span>!</span>ip_mroute_opt<span>(</span>optname<span>))</span> <span>{</span></span>
<span id="function-1820"><a href="#function-1820"></a>                <span>int</span> len<span>;</span></span>
<span id="function-1821"><a href="#function-1821"></a></span>
<span id="function-1822"><a href="#function-1822"></a>                <span>if</span> <span>(</span>get_user<span>(</span>len<span>,</span> optlen<span>))</span></span>
<span id="function-1823"><a href="#function-1823"></a>                        <span>return</span> <span>-</span>EFAULT<span>;</span></span>
<span id="function-1824"><a href="#function-1824"></a></span>
<span id="function-1825"><a href="#function-1825"></a>                err <span>=</span> nf_getsockopt<span>(</span>sk<span>,</span> PF_INET<span>,</span> optname<span>,</span> optval<span>,</span> <span>&amp;</span>len<span>);</span></span>
<span id="function-1826"><a href="#function-1826"></a>                <span>if</span> <span>(</span>err <span>&gt;=</span> <span>0</span><span>)</span></span>
<span id="function-1827"><a href="#function-1827"></a>                        err <span>=</span> put_user<span>(</span>len<span>,</span> optlen<span>);</span></span>
<span id="function-1828"><a href="#function-1828"></a>                <span>return</span> err<span>;</span></span>
<span id="function-1829"><a href="#function-1829"></a>        <span>}</span></span>
<span id="function-1830"><a href="#function-1830"></a><span>#endif</span></span>
<span id="function-1831"><a href="#function-1831"></a>        <span>return</span> err<span>;</span></span>
<span id="function-1832"><a href="#function-1832"></a><span>}</span></span></code></pre></div>
<p>Fortunately the code here is pretty simple: <code>optname</code> must
be in the range
<code>[BPFFILTER_IPT_SO_GET_INFO, BPFILTER_IPT_GET_MAX)</code> for our
fateful function to be called. Another quick trace gives us there raw
values:</p>
<pre><code>$ sudo bpftrace -e &#39;k:bpfilter_ip_get_sockopt { printf(&#34;comm=%s\n optname=%d\n ustack=%s\n kstack=%s\n&#34;, comm, arg1, ustack, kstack) }&#39;
Attaching 1 probe...
comm=iptables
 optname=64
 ustack=
        0x7fa0acd7783a

 kstack=
        bpfilter_ip_get_sockopt+1
        raw_getsockopt+52
        sock_common_getsockopt+26
        __sys_getsockopt+181
        __x64_sys_getsockopt+36
        do_syscall_64+87
        entry_SYSCALL_64_after_hwframe+68</code></pre>
<p>From here, it was basic due dilligence to check the values of
<code>BPFFILTER_IPT_SO_GET_INFO</code> and
<code>BPFILTER_IPT_GET_MAX</code> to see if:</p>
<ol type="1">
<li>The range contains 64</li>
<li>If the range is shared with any iptables sockopts</li>
</ol>
<p>Some quick grepping gives us the (abbreviated) definitions:</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>#define IPT_BASE_CTL            </span><span>64</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span>#define IPT_SO_GET_INFO         </span><span>(</span><span>IPT_BASE_CTL</span><span>)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span>enum</span> <span>{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        BPFILTER_IPT_SO_GET_INFO <span>=</span> <span>64</span><span>,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span>[...]</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        BPFILTER_IPT_GET_MAX<span>,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span>};</span></span></code></pre></div>
<p>So there you have it. bpfilter deliberately overlaps the iptables
sockopt optname ranges. Probably so <code>iptables(8)</code> (the CLI)
can be transparently used with the bpfilter backend. Unfortunately as a
result of this design, if <code>CONFIG_BPFILTER=y</code>, then
<code>bpfilter_ip_get_sockopt()</code> is unconditionally called when
iptables <code>getsockopt(2)</code>/<code>setsockopt(2)</code> is used.
And this triggers our module reloads. Unfortunate, understandable, and
relatively harmless.</p>
<h3 id="the-obvious-question">The obvious question</h3>
<p>Astute readers will have already wondered: why do you build kernels
with <code>CONFIG_BPFILTER=y</code> if bpfilter does not currently
contain any functionality?</p>
<p>Well, that’s a question for Ubuntu:</p>
<pre><code>$ vagrant init ubuntu/jammy64
$ vagrant up
[...]
$ vagrant ssh
<a href="https://dxuuu.xyz/cdn-cgi/l/email-protection" data-cfemail="bbcddadcc9dad5cffbced9ced5cfce96d1dad6d6c2">[email protected]</a>:~$ uname -r
5.15.0-76-generic
<a href="https://dxuuu.xyz/cdn-cgi/l/email-protection" data-cfemail="196f787e6b78776d596c7b6c776d6c347378747460">[email protected]</a>:~$ grep CONFIG_BPFILTER /boot/config-$(uname -r)
CONFIG_BPFILTER=y
CONFIG_BPFILTER_UMH=m</code></pre>


</div>
  </body>
</html>
