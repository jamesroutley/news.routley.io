<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.codedge.de/posts/modern-messaging-running-your-own-xmpp-server">Original</a>
    <h1>Modern messaging: Running your own XMPP server</h1>
    
    <div id="readability-page-1" class="page"><div><div><article><div><p><img src="https://www.codedge.de/posts/modern-messaging-running-your-own-xmpp-server/cover_hu_ab4f7c06a6fe697c.webp" width="768" height="400" alt="Modern messaging: Running your own XMPP server"/></p></div><p>Since a years we know, or might suspect, our chats are listend on,
our uploaded files are sold for advertising or what purpose ever and the chance our social messengers leak our private data is
incredibly high. It is about time to work against this.</p><p>Since 3 years the European Commission works on a plan to automatically monitor all chat,
email and messenger conversations.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup><sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> If this is going to pass, and I strongly hope it will not, the European Union
is moving into a direction we know from states suppressing freedom of speech.</p><p>I went for setting up my own XMPP server, as this does not have any big resource requirements
and still support clustering (for high-availabilty purposes), encryption via OMEMO, file sharing
and has support for platforms and operating systems. Also the ecosystem with clients and multiple use cases evolved
over the years to provide rock-solid software and solutions for multi-user chats or event audio and video calls.</p><p>All code snippets written below work in either Debian os Raspberry Pi OS.</p><h2 id="setting-up-your-own-xmpp-server">Setting up your own XMPP server<a href="#setting-up-your-own-xmpp-server"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h2><p>The connection from your client to the XMPP server is encrypted and we need certificates for our server.
First thing to do is setting up our domains and point it to the IP - both IPv4 and IPv6 is supported and we can specify
both later in our configuration.</p><p>I assume the server is going to be run under <code>xmpp.example.com</code> and you all the following domains have been set up.</p><table><thead><tr><th>Type</th><th>Name</th><th>Notes</th></tr></thead><tbody><tr><td>A</td><td>xmpp.example.com</td><td>your main xmpp server address</td></tr><tr><td>A</td><td>conference.xmpp.example.com</td><td>needed for MUC (Multi User Chat)</td></tr><tr><td>A</td><td>proxy.xmpp.example.com</td><td>needed for SOCKS5 proxy support</td></tr><tr><td>A</td><td>pubsub.xmpp.example.com</td><td>needed for publish/subscribe support</td></tr><tr><td>A</td><td>upload.xmpp.example.com</td><td>needed for file uploads</td></tr><tr><td>A</td><td>stun.xmpp.example.com</td><td>needed for audio&amp;video calling</td></tr><tr><td>A</td><td>turn.xmpp.example.com</td><td>needed for audio&amp;video calling</td></tr></tbody></table><p>Fill in the IPv6 addresses accordingly.</p><p><a href="https://www.ejabberd.im/">ejabberd</a> is a robust server software, that is included in most Linux distributions.</p><p><strong>Install from Process One repository</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>curl -o /etc/apt/sources.list.d/ejabberd.list https://repo.process-one.net/ejabberd.list
</span></span><span><span>curl -o /etc/apt/trusted.gpg.d/ejabberd.gpg https://repo.process-one.net/ejabberd.gpg
</span></span><span><span>apt update
</span></span><span><span>apt install ejabberd
</span></span></code></pre></td></tr></tbody></table></div></div><p><strong>Install from Github</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>curl -L <span>\
</span></span></span><span><span><span></span>  -o /tmp/ejabberd_2507.deb <span>\
</span></span></span><span><span><span></span>  https://github.com/processone/ejabberd/releases/download/25.07/ejabberd_25.07-1_amd64.deb
</span></span><span><span>apt install /tmp/ejabberd_2507.deb
</span></span></code></pre></td></tr></tbody></table></div></div><p>Make sure the fowolling ports are opened in your firewall, taken from <a href="https://docs.ejabberd.im/admin/guide/security/">ejabberd firewall settings</a>.</p><ul><li><strong>5222</strong>: Jabber/XMPP client connections, plain or STARTTLS</li><li><strong>5223</strong>: Jabber client connections, using the old SSL method</li><li><strong>5269</strong>: Jabber/XMPP incoming server connections</li><li><strong>5280/5443</strong>: HTTP/HTTPS for Web Admin and many more</li><li><strong>7777</strong>: SOCKS5 file transfer proxy</li><li><strong>3478/5349</strong>: STUN+TURN/STUNS+TURNS service</li></ul><p>Port <code>1883</code>, used for MQTT, is also mentioned in the ejabberd docs, but we do not use this in our setup. So this port stays closed.</p><p>Depending how you installed ejabberd the config file is either at <code>/etc/ejabberd/conf/ejabberd.yml</code>
or <code>/opt/ejabberd/conf/ejabberd.yml</code>.</p><h3 id="general-configuration">General configuration<a href="#general-configuration"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h3><p>The configuration is a balance of 70:30 between having a privacy-focused setup for your users and meeting most of the suggestions
of the <a href="https://compliance.conversations.im/?ref=process-one.net">XMPP complicance test</a>. That means, settings that
protect the provacy of the users are higher rated despite not passing the test.</p><p>Therefore notable privacy and security settings are:</p><ul><li>XMPP over HTTP is disabled (<a href="https://docs.ejabberd.im/admin/configuration/modules/#mod_bosh">mod_bosh</a>)</li><li>Discover then a user last accessed a server is disabled (<a href="https://docs.ejabberd.im/admin/configuration/modules/#mod_last">mod_last</a>)</li><li>Delete uploaded files on a regular base (see <a href="#enable-file-uploads">upload config</a>)</li><li>Register account via a web page is disabled (<a href="https://docs.ejabberd.im/admin/configuration/modules/#mod_register_web">mod_register_web</a>)</li><li>In-band registration can be enabled, default off, captcha secured (<a href="https://docs.ejabberd.im/admin/configuration/modules/#mod_register">mod_register</a>, <a href="#registration">see registration config</a>)</li></ul><div><p><span><svg viewBox="92 59.5 300 300"><path d="M292 303.25V272c0-3.516-2.734-6.25-6.25-6.25H267v-1e2c0-3.516-2.734-6.25-6.25-6.25h-62.5c-3.516.0-6.25 2.734-6.25 6.25V197c0 3.516 2.734 6.25 6.25 6.25H217v62.5h-18.75c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h87.5c3.516.0 6.25-2.734 6.25-6.25zm-25-175V97c0-3.516-2.734-6.25-6.25-6.25h-37.5c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h37.5c3.516.0 6.25-2.734 6.25-6.25zm125 81.25c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"></path></svg>
</span>Info</p><p>The configuration file is in YAML format. Keep an eye for indentation.</p></div><p>Let’s start digging into the configuration.</p><p><strong>Set the domain of your server</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span>hosts</span>:
</span></span><span><span>  - xmpp.example.com
</span></span></code></pre></td></tr></tbody></table></div></div><p><strong>Set the database type</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span>default_db</span>: sql
</span></span><span><span>
</span></span><span><span><span>host_config</span>:
</span></span><span><span>  <span>xmpp.example.com</span>:
</span></span><span><span>    <span>auth_method</span>: sql
</span></span><span><span>    <span>sql_type</span>: sqlite
</span></span></code></pre></td></tr></tbody></table></div></div><p><strong>Generate DH params</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>sudo mkdir -p /opt/ejabberd <span>&amp;&amp;</span> <span>\
</span></span></span><span><span><span></span>  openssl dhparam -out /opt/ejabberd/dhparams.pem <span>4096</span> 
</span></span></code></pre></td></tr></tbody></table></div></div><p>and link the new file in the ejabberd configuration.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span><span>7
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span>define_marco</span>:
</span></span><span><span>  <span># Other config</span>
</span></span><span><span>  <span>&#39;DH_fiLE&#39;</span>: <span>&#34;/opt/ejabberd/dhparams.pem&#34;</span>
</span></span><span><span>
</span></span><span><span><span># ...</span>
</span></span><span><span><span>c2s_dhfile</span>: <span>&#39;DH_FILE&#39;</span>
</span></span><span><span><span>s2s_dhfile</span>: <span>&#39;DH_FILE&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p><strong>Ensure TLS for server-to-server connections</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>s2s_use_starttls: required
</span></span></code></pre></td></tr></tbody></table></div></div><p><strong>The listners</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span><span>38
</span><span>39
</span><span>40
</span><span>41
</span><span>42
</span><span>43
</span><span>44
</span><span>45
</span><span>46
</span><span>47
</span><span>48
</span><span>49
</span><span>50
</span><span>51
</span><span>52
</span><span>53
</span><span>54
</span><span>55
</span><span>56
</span><span>57
</span><span>58
</span><span>59
</span><span>60
</span><span>61
</span><span>62
</span><span>63
</span><span>64
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span>listen</span>:
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>5222</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>module</span>: ejabberd_c2s
</span></span><span><span>    <span>max_stanza_size</span>: <span>262144</span>
</span></span><span><span>    <span>shaper</span>: c2s_shaper
</span></span><span><span>    <span>access</span>: c2s
</span></span><span><span>    <span>starttls_required</span>: <span>true</span>
</span></span><span><span>    <span>protocol_options</span>: <span>&#39;TLS_OPTIONS&#39;</span>
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>5223</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>module</span>: ejabberd_c2s
</span></span><span><span>    <span>max_stanza_size</span>: <span>262144</span>
</span></span><span><span>    <span>shaper</span>: c2s_shaper
</span></span><span><span>    <span>access</span>: c2s
</span></span><span><span>    <span>tls</span>: <span>true</span>
</span></span><span><span>    <span>protocol_options</span>: <span>&#39;TLS_OPTIONS&#39;</span>
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>5269</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>module</span>: ejabberd_s2s_in
</span></span><span><span>    <span>max_stanza_size</span>: <span>524288</span>
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>5270</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>module</span>: ejabberd_s2s_in
</span></span><span><span>    <span>tls</span>: <span>true</span>
</span></span><span><span>    <span>max_stanza_size</span>: <span>524288</span>
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>5443</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>module</span>: ejabberd_http
</span></span><span><span>    <span>tls</span>: <span>true</span>
</span></span><span><span>    <span>protocol_options</span>: <span>&#39;TLS_OPTIONS&#39;</span>
</span></span><span><span>    <span>ciphers</span>: <span>&#39;TLS_CIPHERS&#39;</span>
</span></span><span><span>    <span>request_handlers</span>:
</span></span><span><span>      <span>/admin</span>: ejabberd_web_admin
</span></span><span><span>      <span>/captcha</span>: ejabberd_captcha
</span></span><span><span>      <span>/upload</span>: mod_http_upload
</span></span><span><span>      <span>/ws</span>: ejabberd_http_ws
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>5280</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>module</span>: ejabberd_http
</span></span><span><span>    <span>tls</span>: <span>false</span>
</span></span><span><span>    <span>request_handlers</span>:
</span></span><span><span>      <span>/.well-known/acme-challenge</span>: ejabberd_acme
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>3478</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::&#34;</span>
</span></span><span><span>    <span>transport</span>: udp
</span></span><span><span>    <span>module</span>: ejabberd_stun
</span></span><span><span>    <span>use_turn</span>: <span>true</span>
</span></span><span><span>    <span>## The server&#39;s public IPv4 address:</span>
</span></span><span><span>    <span>turn_ipv4_address</span>: <span>&#34;{{ ipv4 }}&#34;</span>
</span></span><span><span>    <span>## The server&#39;s public IPv6 address:</span>
</span></span><span><span>    <span>turn_ipv6_address</span>: <span>&#34;{{ ipv6 }}&#34;</span>
</span></span><span><span>  -
</span></span><span><span>    <span>port</span>: <span>1883</span>
</span></span><span><span>    <span>ip</span>: <span>&#34;::1&#34;</span>
</span></span><span><span>    <span>module</span>: mod_mqtt
</span></span><span><span>    <span>backlog</span>: <span>1000</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="acls--access-rules">ACLs &amp; Access rules<a href="#acls--access-rules"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h3><p>For adminstration of ejabberd we need a user with admin rights and properly set up ACLs and access rules.
There is a separat section for ACLs inside the config in which we set up an admin user name <code>root</code>. The name of the user
is important for later, when we actually create this user.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>acl:
</span></span><span><span>  admin:
</span></span><span><span>    user: root
</span></span><span><span>  <span># ... </span>
</span></span><span><span>  proxy_users:
</span></span><span><span>    server: xmpp.example.com
</span></span></code></pre></td></tr></tbody></table></div></div><p>The <code>access_rules</code> should already be set up, just to confirm that you have a correct entry for the <code>configure</code> action.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>access_rules:
</span></span><span><span>  <span>#...</span>
</span></span><span><span>  configure:
</span></span><span><span>    allow: admin
</span></span></code></pre></td></tr></tbody></table></div></div><p>Now the new <code>root</code> user needs to be create by running this command on the console.
Watch out to put in the correct domain.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>ejabberdctl register root xmpp.example.com <span>&#39;my_password_here&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Another user can be registered with the same command.</p><h3 id="enable-file-uploads">Enable file uploads<a href="#enable-file-uploads"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h3><p>Enabling file uploads is done with <a href="https://docs.ejabberd.im/admin/configuration/modules/#mod_http_upload"><code>mod_http_upload</code></a>.
First, create a folder where the uploads should be stored.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span>mkdir -p /var/www/ejabberd/upload
</span></span></code></pre></td></tr></tbody></table></div></div><p>Now update the ejabberd configuration like this:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span>modules</span>:
</span></span><span><span>  <span>#...</span>
</span></span><span><span>  <span>mod_http_upload</span>:
</span></span><span><span>    <span>put_url</span>: https://@HOST@:5443/upload
</span></span><span><span>    <span>docroot</span>: /var/www/ejabberd/upload
</span></span><span><span>    <span>max_size</span>: <span>10000000</span> <span>## 10 MB</span>
</span></span><span><span>    <span>thumbnail</span>: <span>false</span>
</span></span><span><span>    <span>custom_headers</span>:
</span></span><span><span>       <span>&#34;Access-Control-Allow-Origin&#34;: </span><span>&#34;https://@HOST@&#34;</span>
</span></span><span><span>       <span>&#34;Access-Control-Allow-Methods&#34;: </span><span>&#34;GET,HEAD,PUT,OPTIONS&#34;</span>
</span></span><span><span>       <span>&#34;Access-Control-Allow-Headers&#34;: </span><span>&#34;Content-Type&#34;</span>
</span></span><span><span>  <span>#...</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>The allowed file upload size is defined in the <code>max_size</code> param and is set to 10MB.</p><p>Make sure, to delete uploaded files in a reasonable amount of time via cronjob. This is an example of a cronjob,
that deletes files that are older than 1 week.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="shell"><span><span><span>0</span> * * * * find /var/www/ejabberd/upload/upload -type f -cmin +10080 -exec rm -rf <span>{}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="registration">Registration<a href="#registration"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h3><p>Registration in ejabberd is done via <a href="https://docs.ejabberd.im/admin/configuration/modules/#mod_register"><code>mod_register</code></a>
and can be enabled with these entries in the config file:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span><span>access_rules</span>:
</span></span><span><span>  <span>#...</span>
</span></span><span><span>  <span>register</span>:
</span></span><span><span>    <span>allow</span>: all
</span></span><span><span>  <span>#...</span>
</span></span><span><span>
</span></span><span><span><span>modules</span>:
</span></span><span><span>  <span>#...</span>
</span></span><span><span>  <span>mod_register</span>:
</span></span><span><span>    <span>access</span>: register
</span></span><span><span>    <span>ip_access</span>: all
</span></span><span><span>    <span>captcha_protected</span>: <span>true</span>
</span></span><span><span>    <span>password_strength</span>: <span>64</span>
</span></span><span><span>  <span>#...</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>If you want to enable registration for your server make sure you enable a captcha for it.
Otherwise you will get a lot of spam and fake registrations.</p><p>ejabberd provides a working <a href="https://github.com/processone/ejabberd/blob/master/tools/captcha.sh">captcha script</a>,
that you can copy to your server and link in your configuration. You will need <code>imaggemagick</code> and <code>gstools</code> installed
on you system. In the <code>ejabberd.yml</code> config file</p><h2 id="add-tls">Add TLS<a href="#add-tls"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h2><p>ejabberd can provision TLS certificates on its own. No need to install <em>certbot</em>. To not expose ejabberd directly to
the internet, <code>nginx</code> is put in front of the XMPP server. Instead of using <em>nginx</em>, every other web server (caddy, …)
or proxy can be used as well.</p><p>Here is a sample config for <em>nginx</em>:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span></code></pre></td><td><pre tabindex="0"><code data-lang="yaml"><span><span>server {
</span></span><span><span>    listen 80;
</span></span><span><span>    listen [::]:80;
</span></span><span><span>
</span></span><span><span>    server_name xmpp.example.com proxy.xmpp.example.com pubsub.xmpp.example.com conference.xmpp.example.com;
</span></span><span><span>
</span></span><span><span>    access_log  /var/log/nginx/20-xmpp.access.log;
</span></span><span><span>    error_log  /var/log/nginx/20-xmpp.error.log;
</span></span><span><span>
</span></span><span><span>    location = /.well-known/host-meta {
</span></span><span><span>      default_type &#39;application/xrd+xml&#39;;
</span></span><span><span>      add_header Access-Control-Allow-Origin &#39;*&#39; always;
</span></span><span><span>
</span></span><span><span>      root /var/www/ejabberd;
</span></span><span><span>    }
</span></span><span><span>    location = /.well-known/host-meta.json {
</span></span><span><span>      default_type &#39;application/jrd+json&#39;;
</span></span><span><span>      add_header Access-Control-Allow-Origin &#39;*&#39; always;
</span></span><span><span>
</span></span><span><span>      root /var/www/ejabberd;
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    location / {
</span></span><span><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span><span>        proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span><span>
</span></span><span><span>        proxy_pass http://127.0.0.1:5280;
</span></span><span><span>    }
</span></span><span><span>}
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="alternative-connection-methods">Alternative connection methods<a href="#alternative-connection-methods"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h3><p>The nginx vhosts offers files, <code>host-meta</code> and <code>host-meta.json</code>, for indicating which other connection methods (BOSH, WS) your server offers. The details can be read in <a href="https://xmpp.org/extensions/xep-0156.html">XEP-0156</a> extension.
Opposite to the examples in the XEP, there is no BOSH, but only a websocket connection our server offers. The BOSH part is removed from the config file.</p><p><strong>host-meta</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span></code></pre></td><td><pre tabindex="0"><code data-lang="xml"><span><span><span>&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;</span>
</span></span><span><span><span>&lt;XRD</span> <span>xmlns=</span><span>&#39;http://docs.oasis-open.org/ns/xri/xrd-1.0&#39;</span><span>&gt;</span>
</span></span><span><span>  <span>&lt;Link</span> <span>rel=</span><span>&#34;urn:xmpp:alt-connections:websocket&#34;</span>
</span></span><span><span>        <span>href=</span><span>&#34;wss://xmpp.example.com:5443/ws&#34;</span> <span>/&gt;</span>
</span></span><span><span><span>&lt;/XRD&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p><strong>host-meta.json</strong></p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span><span>5
</span><span>6
</span><span>7
</span><span>8
</span></code></pre></td><td><pre tabindex="0"><code data-lang="json"><span><span>{
</span></span><span><span>  <span>&#34;links&#34;</span>: [
</span></span><span><span>    {
</span></span><span><span>      <span>&#34;rel&#34;</span>: <span>&#34;urn:xmpp:alt-connections:websocket&#34;</span>,
</span></span><span><span>      <span>&#34;href&#34;</span>: <span>&#34;wss://xmpp.example.com:5443/ws&#34;</span>
</span></span><span><span>    }
</span></span><span><span>  ]
</span></span><span><span>}
</span></span></code></pre></td></tr></tbody></table></div></div><p>Put that file in a folder your nginx serves. Have a look at the path and URL it is expected to be, see <code>.well-known</code>.</p><h2 id="choose-your-client">Choose your client<a href="#choose-your-client"><svg width=".8em" height=".8em" viewBox="0 0 2048 2048"><path fill="currentColor" d="M1536 768v128q76 0 145 17t123 56 84 99 32 148q0 66-25 124t-69 101-102 69-124 26h-512q-66 0-124-25t-101-69-69-102-26-124q0-87 31-147t85-99 122-56 146-18V768h-64q-93 0-174 35t-142 96-96 142-36 175q0 93 35 174t96 142 142 96 175 36h512q93 0 174-35t142-96 96-142 36-175q0-93-35-174t-96-142-142-96-175-36zm-640 512v-128q76 0 145-17t123-56 84-99 32-148q0-66-25-124t-69-101-102-69-124-26H448q-66 0-124 25t-101 69-69 102-26 124q0 87 31 147t85 99 122 56 146 18v128h-64q-93 0-174-35t-142-96-96-142T0 832q0-93 35-174t96-142 142-96 175-36h512q93 0 174 35t142 96 96 142 36 175q0 93-35 174t-96 142-142 96-175 36z"></path></svg></a></h2><p>Clients I can recommend are <a href="https://profanity-im.github.io">Profanity</a>, an easy to use command-line client,
and <a href="https://monal-im.org">Monal</a> for MacOS and iOS. A good overview of client can be found on the offical <a href="https://xmpp.org/software/">XMPP website</a>.</p><p>This post was created on
<time datetime="2025-09-16T00:00:00+02:00">16 Sep 2025</time>
and updated on
<time datetime="2025-10-06T14:09:01+02:00">06 Oct 2025</time>
.</p></article></div></div></div>
  </body>
</html>
