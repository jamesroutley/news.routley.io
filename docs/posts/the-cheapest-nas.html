<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sigwait.org/~alex/blog/2024/07/01/the-cheapest-nas.html">Original</a>
    <h1>The Cheapest NAS</h1>
    
    <div id="readability-page-1" class="page"><div>

<section>
<article data-file="2024/07/01/the-cheapest-nas.md">

  <nav>
    <span id="nbe_post--next"></span>
    <span id="nbe_post--prev"></span>
  </nav>

  <h2>The cheapest NAS</h2>

  <p>Latest update: <time datetime="2024-07-03T16:09:11.072Z">2024-07-03 19:09:11</time></p>

  

  <p>I wanted to replace my old trusty &#39;router&#39; (with an attached
HDD)--that was not working as a router, but as a network drive after
flashing OpenWRT onto it--I wanter to replace it with an SBC+HDD
combo.</p>
<p>This new device should not only preserve all the services the old one
provided (samba, git, rsyncd, a dnf repo), but also perform faster,
for having a potato instead of a CPU, the ex-router struggled with
rsync over ssh &amp;, being gravely RAM limited, choked when I did &#39;git
push&#39; commits containing binaries &gt; 15MB.</p>
<p>Searching for a suitable SBC led me to libre.computer, a company I had
never heard of before. At first glance, they had the el cheapo
<a href="https://libre.computer/products/aml-s805x-ac/">AML-S805X-AC</a> board I needed:</p>
<ul>
<li>LAN port (but 100 Mb only);</li>
<li>2 USB-A (but 2.0 only);</li>
<li>4-core ARM Cortex-A53;</li>
<li>1 GB RAM;</li>
<li>booting from an USB;</li>
<li>up-to-date Debian;</li>
<li>easy to buy without hunting it down.</li>
</ul>
<p>100Mb may seem like a joke nowadays, but the main purpose of such a
toy NAS for me is to keep a copy of a directory with ~200K small
files. Having 1Gb would only marginally improve the syncing speed even
if the SBC supported USB 3.0.</p>
<p>But this is just a board. I also needed an hdd enclosure with an
external power supply (for the device provides up to 900mA for
each USB-A), at least 3A power supply &amp; a micro-USB cable that can
handle 3A.</p>
<table id="tcnagcb-1">
<thead>
<tr><th>Item</th><th>Price, â‚¬</th><th>Comment</th></tr>
</thead>
<tbody>
<tr><td>SBC</td><td>20</td><td></td></tr>
<tr><td>HDD enclosure</td><td>12</td><td></td></tr>
<tr><td>3A Power Supply</td><td>5</td><td></td></tr>
<tr><td>Micro-USB cable</td><td>3</td><td></td></tr>
<tr><td>4 bolts, 12 nuts</td><td>0</td><td>I think the ones I found are older than me</td></tr>
<tr><td>TTL to USB dongle</td><td>3</td><td>Optional, the board has an HDMI output</td></tr>
<tr><th>Total</th><td>43</td><td></td></tr>
</tbody>
</table>



<p>(I didn&#39;t include an HDD in the table, for I presume everyone has a
couple of them lying around.)</p>
<p>When I bought the HDD enclosure, I didn&#39;t read the description
carefully &amp; thought it was going to be a small plastic container for
2.5-inch drives, but when the package arrived, it turned out to be a
box for 3.5-inch ones. Hence, I decided to shove the SBC into it too.</p>
<img alt="" src="https://sigwait.org/~alex/blog/2024/07/01/innards.avif"/>
<img alt="" src="https://sigwait.org/~alex/blog/2024/07/01/rear.avif"/>

<p>After connecting the TTL-to-USB dongle to the board&#39;s GPIO</p>
<img alt="" src="https://sigwait.org/~alex/blog/2024/07/01/gpio.avif"/>

<p>&amp; typing</p>
<pre><code>$ sudo screen /dev/ttyUSB0 115200
</code></pre>
<p>one of the 1st readouts appeared as:</p>
<pre><code>U-Boot 2023.07+ (Nov 03 2023 - 15:10:36 -0400) Libre Computer AML-S805X-AC

Model: Libre Computer AML-S805X-AC
SoC:   Amlogic Meson GXL (S805X) Revision 21:d (34:2)
DRAM:  512 MiB (effective 1 GiB)
</code></pre>
<p>What does the last line mean exactly? After I dd&#39;ed Debian-12 onto a
flash drive, free(1) said it saw 1GB. Anyway, libre.computer has an
official OS image, based on stock Debian:</p>
<pre><code>$ fdisk debian-12-base-arm64+arm64.img -l
Disk debian-12-base-arm64+arm64.img: 2.25 GiB, 2415919104 bytes, 4718592 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x71f3f7cf

Device                          Boot  Start     End Sectors  Size Id Type
debian-12-base-arm64+arm64.img1 *      2048  524287  522240  255M ef EFI (FAT-12/16/32)
debian-12-base-arm64+arm64.img2      524288 4718591 4194304    2G 83 Linux
</code></pre>
<p>Yes, it has an EFI partition with the MBR layout! The 2nd partition is
btrfs (supposedly it&#39;s faster &amp; more gentle to flash storage than
ext4; no idea if both claims are true). You can examine its contents via:</p>
<pre><code>$ sudo mount -o loop,offset=$((524288*512)) debian-12-base-arm64+arm64.img ~/mnt/misc
</code></pre>
<p>This partition gets auto-resized on the 1st boot to fill the rest of
the free space available on the drive. Doing this on USB dongles
proved to be a miserable experience: of the 3 I had available, one
permanently got stuck on resizing, and another, despite finishing the
operation, became so sluggish afterwards that a 20-year-old PC would&#39;ve
felt snappier.</p>
<p>This is I didn&#39;t like at all. There is no repo with from which the OS
image gets generated. The explanation is <a href="https://hub.libre.computer/t/source-code-git-repository-for-bootloaders-and-firmwares/2743/6">bizarre</a>:</p>
<blockquote>
<p>&#34;The distribution builder is a proprietary commercial offering as it
involves a lot of customer IP and integrations so it cannot be
public.&#34;</p>
</blockquote>
<p>but with an consolation advice:</p>
<blockquote>
<p>&#34;If you want to study them [images], bootstrap and do a diff. We
don&#39;t make any changes to the standard distros outside of setting a
few configs since we&#39;re not distro maintainers.&#34;</p>
</blockquote>
<p>Make of it what you will.</p>
<p>Then I connected the HDD enclosure to the board. This time, the
process went much, much faster (though there were still some
unexpected delays in random places). Right after logging in, I started
getting <code>uas_eh_abort_handler</code> errors from the kernel. It turns out I
got one of the worst HDD enclosure innards possible, if you believe
reviews from the interwebs:</p>
<pre><code>$ lsusb
Bus 001 Device 002: ID 152d:0578 JMicron Technology Corp. / JMicron USA Technology Corp. JMS578 SATA 6Gb/s
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</code></pre>
<p>The remedy is to turn UAS off via adding
<code>usb-storage.quirks=152d:0578:u</code> to the kernel cmdline. It did help,
the delays went away, although &#39;benchmarks&#39; became hardly thrilling:</p>
<pre><code>$ lsusb -t
/:  Bus 01.Port 1: Dev 1, Class=root_hub, Driver=xhci-hcd/2p, 480M
    |__ Port 2: Dev 2, If 0, Class=Mass Storage, Driver=usb-storage, 480M
$ sync; time sh -c &#34;dd if=/dev/urandom of=1 bs=500k count=1k &amp;&amp; sync&#34;; rm 1
1024+0 records in
1024+0 records out
524288000 bytes (524 MB, 500 MiB) copied, 15.1014 s, 34.7 MB/s

real    0m21.876s
user    0m0.001s
sys     0m7.976s
</code></pre>
<p>which means <math alttext="524/21.876 = 23.95">
<mfrac><mn>524</mn><mn>21.876</mn></mfrac><mo>=</mo><mn>23.95</mn>
</math> MB/s on an ext4 partition.</p>
<p>Would I recommend this setup? I wouldn&#39;t. One of the reasons I&#39;ve
chosen the path with an SBC instead of a common micro-ITX route is to
save on <a href="https://sigwait.org/~alex/blog/2024/07/01/imf.html">power consumption</a>. If you don&#39;t have similar
problems, I see 0 reasons to struggle with such a finicky Chinese
device.</p>


  </article>
</section>

  <nav>
    

    
  </nav>

</div></div>
  </body>
</html>
