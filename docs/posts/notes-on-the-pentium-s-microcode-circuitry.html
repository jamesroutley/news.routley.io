<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.righto.com/2025/03/pentium-microcde-rom-circuitry.html">Original</a>
    <h1>Notes on the Pentium&#39;s microcode circuitry</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-3129002752159663932" itemprop="description articleBody">
<p>Most people think of machine instructions as the fundamental steps that a computer performs.
However, many processors have another layer of software underneath: microcode.
With microcode, instead of building the processor&#39;s control circuitry from complex logic gates, the control logic is
implemented with code known as microcode, stored in the microcode ROM.
To execute a machine instruction, the computer internally executes several simpler micro-instructions, specified by the microcode.
In this post, I examine the microcode ROM in the original Pentium, looking at the low-level circuitry.</p>
<p>The photo below shows the Pentium&#39;s thumbnail-sized silicon die under a microscope.
I&#39;ve labeled the main functional blocks.
The microcode ROM is highlighted at the right.
If you look closely, you can see that the microcode ROM consists of two rectangular banks, one above the other.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/pentium-labeled.jpg"><img alt="This die photo of the Pentium shows the location of the microcode ROM. Click this image (or any other) for a larger version." height="524" src="https://static.righto.com/images/pentium-microcode1/pentium-labeled-w500.jpg" title="This die photo of the Pentium shows the location of the microcode ROM. Click this image (or any other) for a larger version." width="500"/></a></p><p>This die photo of the Pentium shows the location of the microcode ROM. Click this image (or any other) for a larger version.</p>
<p>The image below shows a closeup of the two microcode ROM banks.
Each bank provides 45 bits of output; together they implement a micro-instruction that is 90 bits long.
Each bank consists of a grid of transistors arranged into 288 rows and 720 columns.
The microcode ROM holds 4608 micro-instructions,
414,720 bits in total.
At this magnification, the ROM appears featureless, but it is covered with horizontal wires, each just 1.5 µm
thick.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/rom-output-lines.jpg"><img alt="The 90 output lines from the ROM, with a closeup of six lines exiting the ROM." height="470" src="https://static.righto.com/images/pentium-microcode1/rom-output-lines-w500.jpg" title="The 90 output lines from the ROM, with a closeup of six lines exiting the ROM." width="500"/></a></p><p>The 90 output lines from the ROM, with a closeup of six lines exiting the ROM.</p>
<p>The ROM&#39;s 90 output lines are collected into a bundle of wires between the banks, as shown above.
The detail shows how six of the bits exit from the banks and join the bundle.
This bundle exits the ROM to the left, travels to various parts of the chip, and controls the chip&#39;s circuitry.
The output lines are in the chip&#39;s top metal layer (M3):
the Pentium has three layers of metal wiring with M1 on the bottom, M2 in the middle, and M3 on top.</p>
<p>The Pentium has a large number of bits in its micro-instruction, 90 bits compared to 21 bits in the <a href="https://www.righto.com/2022/11/how-8086-processors-microcode-engine.html">8086</a>.
Presumably, the Pentium has a &#34;horizontal&#34; microcode architecture, where the microcode bits correspond to low-level control signals,
as opposed to &#34;vertical&#34; microcode, where the bits are encoded into denser micro-instructions.
I don&#39;t have any information on the Pentium&#39;s encoding of microcode; unlike the 8086, the Pentium&#39;s patents don&#39;t provide any clues.
The 8086&#39;s microcode ROM holds 512 micro-instructions, much less than the Pentium&#39;s 4608 micro-instructions.
This makes sense, given the much greater complexity of the Pentium&#39;s instruction set, including the floating-point unit on the chip.</p>
<!-- 40.8 pixels (blue) for metal lines + gap. 15625 pixels/mm. 2.6 µm total so 1.3 µm for metal line alone. -->

<p>The image below shows a closeup of the Pentium&#39;s microcode ROM.
For this image, I removed the three layers of metal and the polysilicon layer
to expose the chip&#39;s underlying silicon.
The pattern of silicon doping is visible, showing the transistors and thus the data stored in the ROM.
If you have enough time, you can extract the bits from the ROM by examining the silicon and seeing where transistors are present.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/rom-closeup.jpg"><img alt="A closeup of the ROM showing how bits are encoded in the layout of transistors." height="469" src="https://static.righto.com/images/pentium-microcode1/rom-closeup-w500.jpg" title="A closeup of the ROM showing how bits are encoded in the layout of transistors." width="500"/></a></p><p>A closeup of the ROM showing how bits are encoded in the layout of transistors.</p>
<p>Before explaining the ROM&#39;s circuitry, I&#39;ll review how an NMOS transistor is constructed.
A transistor can be considered a switch between the source and drain, controlled by the gate.
The source and drain regions (green) consist of silicon doped with impurities to change its semiconductor properties, forming N+ silicon.
(These regions are visible in the photo above.)
The gate consists of a layer of polysilicon (red), separated from the silicon by a very thin insulating oxide layer. Whenever polysilicon crosses active silicon, a transistor is formed. </p>
<p><a href="https://static.righto.com/images/pentium-microcode1/mosfet-n.jpg"><img alt="Diagram showing the structure of an NMOS transistor." height="231" src="https://static.righto.com/images/pentium-microcode1/mosfet-n-w400.jpg" title="Diagram showing the structure of an NMOS transistor." width="400"/></a></p><p>Diagram showing the structure of an NMOS transistor.</p>
<p>Bits are stored in the ROM through the pattern of transistors in the grid.
The presence or absence of a transistor stores a 0 or 1 bit.<span id="fnref:ambiguity"><a href="#fn:ambiguity">1</a></span>
The closeup below shows eight bits of the microcode ROM. There are four transistors present and four gaps where transistors are
missing.
Thus, this part of the ROM holds four 0 bits and four 1 bits.
For the diagram below, I removed the three metal layers and the polysilicon to show the underlying silicon.
I colored doped (active) silicon regions green, and drew in the horizontal polysilicon lines in red.
As explained above, a transistor is created if polysilicon crosses doped silicon.
Thus, the contents of the ROM are defined by the pattern of silicon regions, which creates the transistors.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/rom-transistors.jpg"><img alt="Eight bits of the microcode ROM, with four transistors present." height="211" src="https://static.righto.com/images/pentium-microcode1/rom-transistors-w500.jpg" title="Eight bits of the microcode ROM, with four transistors present." width="500"/></a></p><p>Eight bits of the microcode ROM, with four transistors present.</p>
<p>The horizontal silicon lines are used as wiring to provide ground to the transistors, while the horizontal polysilicon lines select one of the
rows in the ROM.
The transistors in that row will turn on, pulling the associated output lines low.
That is, the presence of a transistor in a row causes the output to be pulled low, while the absence of a transistor causes
the output line to remain high.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/rom-schematic.jpg"><img alt="A schematic corresponding to the eight bits above." height="225" src="https://static.righto.com/images/pentium-microcode1/rom-schematic-w300.jpg" title="A schematic corresponding to the eight bits above." width="300"/></a></p><p>A schematic corresponding to the eight bits above.</p>
<p>The diagram below shows the silicon, polysilicon, and bottom metal (M1) layers. I removed the metal from the left to reveal the silicon and polysilicon underneath, but the pattern of vertical metal lines continues there.
As shown earlier, the silicon pattern forms transistors. Each horizontal metal line has a connection
to ground through a metal line (not shown).
The horizontal polysilicon lines select a row.
When polysilicon lines cross doped silicon, the gate of a transistor is formed.
Two transistors may share the drain, as in the transistor pair on the left.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/m1-diagram.jpg"><img alt="Diagram showing the silicon, polysilicon, and M1 layers." height="330" src="https://static.righto.com/images/pentium-microcode1/m1-diagram-w500.jpg" title="Diagram showing the silicon, polysilicon, and M1 layers." width="500"/></a></p><p>Diagram showing the silicon, polysilicon, and M1 layers.</p>
<p>The vertical metal wires form the outputs. The circles are contacts between the metal wire and the silicon of a transistor.<span id="fnref:contacts"><a href="#fn:contacts">2</a></span>
Short metal jumpers connect the polysilicon lines to the metal layer above, which will be described next.</p>
<p>The image below shows the upper left corner of the ROM. The yellowish metal lines are the top metal layer (M3), while the
reddish metal lines are the middle metal layer (M2).
The thick yellowish M3 lines distribute ground to the ROM. Underneath the horizontal M3 line, a horizontal M2 line also
distributes ground.
The grids of black dots are numerous contacts between the M3 line and the M2 line, providing a low-resistance connection.
The M2 line, in turn, connects to vertical M1 ground lines underneath—these wide vertical lines are faintly visible.
These M1 lines connect to the silicon, as shown earlier, providing ground to each transistor.
This illustrates the complexity of power distribution in the Pentium: the thick top metal (M3) is the primary distribution of
+5 volts and ground through the chip, but power must be passed down through M2 and M1 to reach the transistors.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/rom-m3.jpg"><img alt="The upper left corner of the ROM." height="419" src="https://static.righto.com/images/pentium-microcode1/rom-m3-w600.jpg" title="The upper left corner of the ROM." width="600"/></a></p><p>The upper left corner of the ROM.</p>
<p>The other important feature above is the horizontal metal lines, which help distribute the row-select signals.
As shown earlier, horizontal polysilicon lines provide the row-select signals to the transistors.
However, polysilicon is not as good a conductor as metal, so long polysilicon lines have too much resistance.
The solution is to run metal lines in parallel, periodically connected to the underlying polysilicon lines and
reducing the overall resistance.
Since the vertical metal output lines are in the M1 layer, the horizontal row-select lines run in the M2 layer so they don&#39;t collide.
Short &#34;jumpers&#34; in the M1 layer connect the M2 lines to the polysilicon lines.</p>
<p>To summarize, each ROM bank contains a grid of transistors and transistor vacancies to define the bits of the ROM.
The ROM is carefully designed so the different layers—silicon, polysilicon, M1, and M2—work together to maximize the
ROM&#39;s performance and density.</p>
<h2>Microcode Address Register</h2>
<p>As the Pentium executes an instruction, it provides the address of each micro-instruction to the microcode ROM.
The Pentium holds this address—the micro-address—in the Microcode Address Register (MAR).
The MAR is a 13-bit register located above the microcode ROM. </p>
<p>The diagram below shows the Microcode Address Register above the upper ROM bank.
It consists of 13 bits; each bit has multiple latches to hold the value as well as any pushed subroutine micro-addresses.
Between bits 7 and 8, some buffer circuitry amplifies the control signals that go to each bit&#39;s circuitry.
At the right, drivers amplify the outputs from the MAR, sending the signals to the row drivers and column-select circuitry that
I will discuss below.
To the left of the MAR is a 32-bit register that is apparently unrelated to the microcode ROM, although I haven&#39;t determined its function.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/MAR.jpg"><img alt="The Microcode Address Register is located above the upper ROM bank." height="226" src="https://static.righto.com/images/pentium-microcode1/MAR-w600.jpg" title="The Microcode Address Register is located above the upper ROM bank." width="600"/></a></p><p>The Microcode Address Register is located above the upper ROM bank.</p>
<p>The outputs from the Microcode Address Register select rows and columns in the microcode ROM, as I&#39;ll explain
below.
Bits 12 through 7 of the MAR select a block of 8 rows, while bits 6 through 4 select a row in this block.
Bits 3 through 0 select one column out of each group of 16 columns to select an output bit.
Thus, the microcode address controls what word is provided by the ROM.</p>
<p>Several different operations can be performed on the Microcode Address Register.
When executing a machine instruction, the MAR must be loaded with the address of the corresponding
microcode routine.
(I haven&#39;t determined how this address is generated.)
As microcode is executed, the MAR is usually incremented to move to the next micro-instruction.
However, the MAR can branch to a new micro-address as required.
The MAR also supports microcode subroutine calls; it will push the current micro-address and jump to the new micro-address.
At the end of the micro-subroutine, the micro-address is popped so execution returns to the previous location.
The MAR supports three levels of subroutine calls, as it contains three registers to hold the stack of pushed micro-addresses.</p>
<p>The MAR receives control signals and addresses from <a href="https://www.righto.com/2024/07/pentium-standard-cells.html">standard-cell logic</a>
located above the MAR.
Strangely, in Intel&#39;s published <a href="https://doi.org/10.1109/40.216745">floorplans</a> for the Pentium, this standard-cell logic is
labeled as part of the branch prediction logic, which is above it.
However, carefully tracing the signals from the standard-cell logic shows that is connected to the Microcode Address Register, not
the branch predictor.</p>
<h2>Row-select drivers</h2>
<p>As explained above, each ROM bank has 288 rows of transistors, with polysilicon lines to select one of the rows.
To the right of the ROM is circuitry that activates one of these row-select lines, based on the micro-address.
Each row matches a different 9-bit address. A straightforward implementation would use a 9-input AND gate for each
row, matching a particular pattern of 9 address bits or their complements.</p>
<p>However, this implementation would require 576 very large AND gates, so it is impractical.
Instead, the Pentium uses an optimized implementation with one 6-input AND gate for each group of 8 rows.
The remaining three address bits are decoded once at the top of the ROM.
As a result, each row only needs one gate, detecting if its group of eight rows is selected and if the particular one of eight
is selected.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/row-driver-schematic.jpg"><img alt="Simplified schematic of the row driver circuitry." height="453" src="https://static.righto.com/images/pentium-microcode1/row-driver-schematic-w500.jpg" title="Simplified schematic of the row driver circuitry." width="500"/></a></p><p>Simplified schematic of the row driver circuitry.</p>
<p>The schematic above shows the circuitry for a group of eight rows, slightly simplified.<span id="fnref:simplified-rows"><a href="#fn:simplified-rows">3</a></span>
At the top, three address bits are decoded, generating eight output lines with one active at a time.
The remaining six address bits are inverted, providing the bit and its complement to the decoding circuitry.
Thus, the 9 bits are converted into 20 signals that flow through the decoders, a large number of wires, but not unmanageable.
Each group of eight rows has a 6-input AND gate that matches a particular 6-bit address, determined by which inputs are
complemented and which are not.<span id="fnref:binary"><a href="#fn:binary">4</a></span>
The NAND gate and inverter at the left combine the 3-bit decoding and the 6-bit decoding, activating the appropriate row.</p>
<p>Since there are up to 720 transistors in each row, the row-select lines need to be driven with high current.
Thus, the row-select drivers use large transistors, roughly 25 times the size of a regular transistor.
To fit these transistors into the same vertical spacing as the rest of the decoding circuitry, a tricky packing is used.
The drivers for each group of 8 rows are packed into a 3×3 grid, except the first column has two drivers (since there
are 8 drivers in the group, not 9).
To avoid a gap, the drivers in the first column are larger vertically and squashed horizontally.</p>
<h2>Output circuitry</h2>
<p>The schematic below shows the multiplexer circuit that selects one of 16 columns for a microcode output bit.
The first stage has four 4-to-1 multiplexers. Next, another 4-to-1 multiplexer selects one of the outputs.
Finally, a BiCMOS driver amplifies the output for transmission to the rest of the processor.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/output-mux.jpg"><img alt="The 16-to-1 multiplexer/output driver." height="272" src="https://static.righto.com/images/pentium-microcode1/output-mux-w700.jpg" title="The 16-to-1 multiplexer/output driver." width="700"/></a></p><p>The 16-to-1 multiplexer/output driver.</p>
<p>In more detail, the ROM and the first multiplexer are essentially NMOS circuits, rather than CMOS. Specifically, the ROM&#39;s
grid of transistors is constructed from NMOS transistors that can pull a column line low, but there are no PMOS transistors in
the grid to pull the line high (since that would double the size of the ROM).
Instead, the multiplexer includes precharge transistors to pull the lines high, presumably in the clock phase before the
ROM is read.
The capacitance of the lines will keep the line high unless it is pulled low by a transistor in the grid.
One of the four transistors in the multiplexer is activated (by control signal <code>a</code>, <code>b</code>, <code>c</code>, or <code>d</code>) to select the desired line.
The output goes to a &#34;keeper&#34; circuit, which keeps the output high unless it is pulled low.
The keeper uses an inverter with a weak PMOS transistor that can only provide a small pull-up current.
A stronger low input will overpower this transistor, switching the state of the keeper. </p>
<p>The output of this multiplexer, along with the outputs of three other multiplexers, goes to the second-stage multiplexer,<span id="fnref:mux"><a href="#fn:mux">5</a></span>
which selects one of its four inputs, based on control signals <code>e</code>, <code>f</code>, <code>g</code>, and <code>h</code>.
The output of this multiplexer is held in a latch built from two inverters. The second latch has weak transistors so the latch
can be easily forced into the desired state.
The output from the first latch goes through a CMOS switch into a second latch, creating a flip-flop.</p>
<p>The output from the second latch goes to a BiCMOS driver, which drives one of the 90 microcode output lines.
Most processors are built from CMOS circuitry (i.e. NMOS and PMOS transistors), but the Pentium is built from BiCMOS circuitry:
bipolar transistors as well as CMOS.
At the time, bipolar transistors improved performance for high-current drivers; see my
article on
<a href="https://www.righto.com/2025/01/pentium-reverse-engineering-bicmos.html">the Pentium&#39;s BiCMOS circuitry</a>.</p>
<p>The diagram below shows three bits of the microcode output. This circuitry is for the upper ROM bank; the circuitry is
mirrored for the lower bank.
The circuitry matches the schematic above. Each of the three blocks has 16 input lines from the ROM grid.
Four 4-to-1 multiplexers reduce this to 4 lines, and the second multiplexer selects a single line. The result is latched
and amplified by the output driver.
(Note the large square shape of the bipolar transistors.)
Next is the shift register that processes the microcode ROM outputs for testing.
The shift register uses XOR logic for its feedback; unlike the rest of the circuitry, the XOR logic is irregular since
only some bits are fed into XOR gates.</p>
<p><a href="https://static.righto.com/images/pentium-microcode1/output-die.jpg"><img alt="Three bits of output from the microcode, I removed the three metal layers to show the polysilicon and silicon." height="523" src="https://static.righto.com/images/pentium-microcode1/output-die-w500.jpg" title="Three bits of output from the microcode, I removed the three metal layers to show the polysilicon and silicon." width="500"/></a></p><p>Three bits of output from the microcode, I removed the three metal layers to show the polysilicon and silicon.</p>
<h3>Circuitry for testing</h3>
<p>Why does the microcode ROM have shift registers and XOR gates?
The reason is that a chip such as the Pentium is very difficult to test: if one out of 3.1 million transistors goes bad, how do you detect it? For a simple processor like the 8086, you can run through the instruction set and be fairly confident that any problem would turn up.
But with a complex chip, it is almost impossible to design an instruction sequence that would test every bit of the microcode ROM, every bit of the cache, and so forth.
Starting with the 386, Intel added circuitry to the processor solely to make testing easier; about 2.7% of the transistors in the 386 were for testing.</p>
<p>The Pentium has this testing circuitry for many ROMs and PLAs, including the division PLA that caused the infamous <a href="https://www.righto.com/2024/12/this-die-photo-of-pentium-shows.html">FDIV bug</a>.
To test a ROM inside the processor, Intel added circuitry to scan the entire ROM and checksum its contents.
Specifically, a pseudo-random number generator runs through each address, while another circuit computes a checksum of the ROM output, forming a &#34;signature&#34; word.
At the end, if the signature word has the right value, the ROM is almost certainly correct.
But if there is even a single bit error, the checksum will be wrong and the chip will be rejected.</p>
<p>The pseudo-random numbers and the checksum are both implemented with linear feedback shift registers (LFSR), a shift register along with a few XOR gates to feed the output back to the input.
For more information on testing circuitry in the 386, see <a href="https://doi.org/10.1109/MDT.1987.295165">Design and Test of the 80386</a>, written by Pat Gelsinger, who became Intel&#39;s CEO years later.</p>
<h2>Conclusions</h2>
<p>You&#39;d think that implementing a ROM would be straightforward, but the Pentium&#39;s microcode ROM is surprisingly complex due to
its optimized structure and its circuitry for testing.
I haven&#39;t been able to determine much about how the microcode works, except that the micro-instruction is 90 bits wide and
the ROM holds 4608 micro-instructions in total.
But hopefully you&#39;ve found this look at the circuitry interesting.</p>
<p>Disclaimer: this should all be viewed as slightly speculative and there are probably some errors.
I didn&#39;t want to prefix every statement with &#34;I think that...&#34; but you should pretend it is there.
I plan to write more about the implementation of the Pentium, so
follow me on Bluesky (<a href="https://bsky.app/profile/righto.com">@righto.com</a>) or <a href="https://www.righto.com/feeds/posts/default">RSS</a> for updates.
Peter Bosch has done some reverse engineering of the Pentium II microcode; his information is <a href="https://pbx.sh/pentiumii-part1/">here</a>.</p>
<h2>Footnotes and references</h2>


</div></div>
  </body>
</html>
