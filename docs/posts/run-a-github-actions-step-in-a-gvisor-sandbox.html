<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/geomys/sandboxed-step">Original</a>
    <h1>Show HN: Run a GitHub Actions step in a gVisor sandbox</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A GitHub Action that runs commands in a gVisor sandbox.</p>

<p dir="auto">Surprisingly enough, GitHub Actions with read-only permissions still receive a
cache write token, allowing <a href="https://adnanthekhan.com/2024/05/06/the-monsters-in-your-build-cache-github-actions-cache-poisoning/" rel="nofollow">cache poisoning</a>,
so they are not safe to run untrusted code.</p>
<p dir="auto">Moreover, there is no isolation between steps in a workflow, since they all run
on the same VM with root access. The only alternative is separating workflows
with <code>workflow_run</code>, but that has its own limitations and overhead.</p>
<p dir="auto">This can lead to a false sense of security when running untrusted code in a
workflow or step with read-only permissions, despite defaulting workflows to
read-only permissions being a top-level feature.</p>
<a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/1225294/505277440-810c1e72-f6cf-4aa8-9de3-73cefd93a342.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE5MDI3MzYsIm5iZiI6MTc2MTkwMjQzNiwicGF0aCI6Ii8xMjI1Mjk0LzUwNTI3NzQ0MC04MTBjMWU3Mi1mNmNmLTRhYTgtOWRlMy03M2NlZmQ5M2EzNDIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAzMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMzFUMDkyMDM2WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NTg0NzFhYjNkMmFiZjEzMGJiN2ExMTY4ZWE4NzA2YmEwNzE5OTFjODI5YzU2MDdjZWU5Zjk2MjI1OWM5ZjI2MiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.ZcMkzI0wBskfWc7uWFmq9FXG9Nj6rDRpOi379ugMO9k"><img width="779" height="289" src="https://private-user-images.githubusercontent.com/1225294/505277440-810c1e72-f6cf-4aa8-9de3-73cefd93a342.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjE5MDI3MzYsIm5iZiI6MTc2MTkwMjQzNiwicGF0aCI6Ii8xMjI1Mjk0LzUwNTI3NzQ0MC04MTBjMWU3Mi1mNmNmLTRhYTgtOWRlMy03M2NlZmQ5M2EzNDIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MTAzMSUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTEwMzFUMDkyMDM2WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NTg0NzFhYjNkMmFiZjEzMGJiN2ExMTY4ZWE4NzA2YmEwNzE5OTFjODI5YzU2MDdjZWU5Zjk2MjI1OWM5ZjI2MiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.ZcMkzI0wBskfWc7uWFmq9FXG9Nj6rDRpOi379ugMO9k"/></a>
<p dir="auto">This Action runs commands in an isolated gVisor sandbox, allowing e.g. running
CI against the latest versions of dependencies without risking being affected by
supply chain attacks.</p>

<div dir="auto" data-snippet-clipboard-copy-content="- uses: geomys/sandboxed-step@v1.1.1
  with:
    run: |
      go get -u &amp;&amp; go mod tidy
      go test ./..."><pre>- <span>uses</span>: <span>geomys/sandboxed-step@v1.1.1</span>
  <span>with</span>:
    <span>run</span>: <span>|</span>
<span>      go get -u &amp;&amp; go mod tidy</span>
<span>      go test ./...</span></pre></div>
<p dir="auto">The commands run in a gVisor sandbox with</p>
<ul dir="auto">
<li>a root filesystem similar to ubuntu-24.04 (<a href="https://github.com/catthehacker/docker_images"><code>ghcr.io/catthehacker/ubuntu:runner-24.04</code></a>)</li>
<li>overlayed access to GITHUB_WORKSPACE (changes do not persist by default)</li>
<li>GITHUB_WORKSPACE working directory</li>
<li>host network access</li>
<li>allow-listed environment variables</li>
<li>same user as the GitHub Actions runner, with sudo access</li>
<li>read-only access to tools installed by setup-* actions (via RUNNER_TOOL_CACHE)</li>
</ul>
<p dir="auto">Changes to the workspace inside the sandbox can be made to persist on the host
by setting <code>persist-workspace-changes: &#39;true&#39;</code>. This is unlikely to be safe, as
following steps will need to treat the workspace as untrusted.</p>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p dir="auto">This action will detect and fail if the <code>actions/checkout</code> Action has
persisted authentication tokens in GITHUB_WORKSPACE (the default behavior).</p>
<p dir="auto">To use this action, you must disable credential persistence in your checkout
step:</p>
<div dir="auto" data-snippet-clipboard-copy-content="- uses: actions/checkout@v4
  with:
    persist-credentials: false"><pre>- <span>uses</span>: <span>actions/checkout@v4</span>
  <span>with</span>:
    <span>persist-credentials</span>: <span>false</span></pre></div>
<p dir="auto">Alternatively, you can set <code>allow-checkout-credentials: true</code> to bypass this
check, but this is <strong>NOT RECOMMENDED</strong> as it will expose the GitHub token to
the sandbox.</p>
</div>
<p dir="auto">All tags use GitHub&#39;s Immutable Releases, so they can&#39;t be changed even if this
repository is compromised.</p>

<ul dir="auto">
<li><code>run</code> (required): Commands to run in the sandbox</li>
<li><code>env</code> (optional): Additional environment variables to set in the sandbox (one per line, KEY=VALUE format)</li>
<li><code>persist-workspace-changes</code> (optional, default: <code>false</code>): Allow changes to persist on the host</li>
<li><code>disable-network</code> (optional, default: <code>false</code>): Disable network access in the sandbox</li>
<li><code>allow-checkout-credentials</code> (optional, default: <code>false</code>): Allow persisted checkout credentials</li>
<li><code>rootfs-image</code> (optional): Docker image to use as the root filesystem</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto">Example for sandboxed Go tests with latest dependencies</h3><a id="user-content-example-for-sandboxed-go-tests-with-latest-dependencies" aria-label="Permalink: Example for sandboxed Go tests with latest dependencies" href="#example-for-sandboxed-go-tests-with-latest-dependencies"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="name: Go tests
on:
  push:
  pull_request:
  schedule: # daily at 09:42 UTC
    - cron: &#39;42 9 * * *&#39;
  workflow_dispatch:
permissions:
  contents: read
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go:
          - { go-version: stable }
          - { go-version: oldstable }
          - { go-version-file: go.mod }
        deps:
          - locked
          - latest
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go.go-version }}
          go-version-file: ${{ matrix.go.go-version-file }}
      - uses: geomys/sandboxed-step@v1.1.1
        with:
          run: |
            if [ &#34;${{ matrix.deps }}&#34; = &#34;latest&#34; ]; then
              go get -u &amp;&amp; go mod tidy
            fi
            go test ./...
  staticcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - uses: actions/setup-go@v6
        with:
          go-version: stable
      - uses: geomys/sandboxed-step@v1.1.1
        with:
          run: go run honnef.co/go/tools/cmd/staticcheck@latest ./...
  govulncheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - uses: actions/setup-go@v6
        with:
          go-version: stable
      - uses: geomys/sandboxed-step@v1.1.1
        with:
          run: go run golang.org/x/vuln/cmd/govulncheck@latest ./..."><pre><span>name</span>: <span>Go tests</span>
<span>on</span>:
  <span>push</span>:
  <span>pull_request</span>:
  <span>schedule</span>: <span><span>#</span> daily at 09:42 UTC</span>
    - <span>cron</span>: <span><span>&#39;</span>42 9 * * *<span>&#39;</span></span>
  <span>workflow_dispatch</span>:
<span>permissions</span>:
  <span>contents</span>: <span>read</span>
<span>jobs</span>:
  <span>test</span>:
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>strategy</span>:
      <span>fail-fast</span>: <span>false</span>
      <span>matrix</span>:
        <span>go</span>:
          - <span>{ go-version: stable }</span>
          - <span>{ go-version: oldstable }</span>
          - <span>{ go-version-file: go.mod }</span>
        <span>deps</span>:
          - <span>locked</span>
          - <span>latest</span>
    <span>steps</span>:
      - <span>uses</span>: <span>actions/checkout@v5</span>
        <span>with</span>:
          <span>persist-credentials</span>: <span>false</span>
      - <span>uses</span>: <span>actions/setup-go@v6</span>
        <span>with</span>:
          <span>go-version</span>: <span>${{ matrix.go.go-version }}</span>
          <span>go-version-file</span>: <span>${{ matrix.go.go-version-file }}</span>
      - <span>uses</span>: <span>geomys/sandboxed-step@v1.1.1</span>
        <span>with</span>:
          <span>run</span>: <span>|</span>
<span>            if [ &#34;${{ matrix.deps }}&#34; = &#34;latest&#34; ]; then</span>
<span>              go get -u &amp;&amp; go mod tidy</span>
<span>            fi</span>
<span>            go test ./...</span>
<span></span>  <span>staticcheck</span>:
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>steps</span>:
      - <span>uses</span>: <span>actions/checkout@v5</span>
        <span>with</span>:
          <span>persist-credentials</span>: <span>false</span>
      - <span>uses</span>: <span>actions/setup-go@v6</span>
        <span>with</span>:
          <span>go-version</span>: <span>stable</span>
      - <span>uses</span>: <span>geomys/sandboxed-step@v1.1.1</span>
        <span>with</span>:
          <span>run</span>: <span>go run honnef.co/go/tools/cmd/staticcheck@latest ./...</span>
  <span>govulncheck</span>:
    <span>runs-on</span>: <span>ubuntu-latest</span>
    <span>steps</span>:
      - <span>uses</span>: <span>actions/checkout@v5</span>
        <span>with</span>:
          <span>persist-credentials</span>: <span>false</span>
      - <span>uses</span>: <span>actions/setup-go@v6</span>
        <span>with</span>:
          <span>go-version</span>: <span>stable</span>
      - <span>uses</span>: <span>geomys/sandboxed-step@v1.1.1</span>
        <span>with</span>:
          <span>run</span>: <span>go run golang.org/x/vuln/cmd/govulncheck@latest ./...</span></pre></div>
</article></div></div>
  </body>
</html>
