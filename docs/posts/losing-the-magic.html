<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/915163/ba83480903b82cb8/">Original</a>
    <h1>Losing the Magic</h1>
    
    <div id="readability-page-1" class="page"><p>

<h2>[LWN subscriber-only content]</h2>
</p><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://lwn.net/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>
<p>
The kernel project is now more than three decades old; over that time, a
number of development practices have come and gone.  Once upon a time, the
use of &#34;magic numbers&#34; to identify kernel data structures was seen as a
good way to help detect and debug problems.  Over the years, though, the
use of magic numbers has gone into decline; <a href="https://lwn.net/ml/linux-kernel/cover.1668128257.git.nabijaczleweli@nabijaczleweli.xyz/">this
patch set</a> from Ahelenia Ziemiańska may be an indication that the reign
of magic numbers may be reaching its end.
</p><p>
A magic number is simply a specific constant value that is placed within a
structure, typically as the first member, to identify the type of that
structure.  When structures are labeled in this way, in-kernel
debugging code can check the magic number and raise the alarm if the
expected value is not found, thus detecting problems related to type
confusion or data
corruption.  These numbers can also be located in hexadecimal data dumps
(stack contents, for example) to identify known data structures.
</p><p>
The use of magic numbers in the kernel appears to have had its origin in
the filesystem code, where it was initially used to identify (and verify)
the superblock in the disk image.  Even the 0.10 kernel release included <a href="https://elixir.bootlin.com/linux/0.10/source/fs/super.c#L131">a test
against <tt>SUPER_MAGIC</tt></a> (<tt>0x137f</tt>) to verify that the boot
disk was, indeed, a Minix filesystem.  Other filesystems came later,
starting with the &#34;first extended&#34; (ext), which used <tt>0x137d</tt> for
its <tt>EXT_SUPER_MAGIC</tt> value in the 0.96c release in July 1992.
</p><p>
In the 0.99 release (December 1992), the <a href="https://elixir.bootlin.com/linux/0.99/source/net/tcp/sock.h#L155"><tt>sk_buff</tt>
structure</a> that is still used in the networking
subsystem to hold packets was rather 
smaller than <a href="https://elixir.bootlin.com/linux/v6.1-rc5/source/include/linux/skbuff.h#L728">it
is now</a>, but it did gain a <tt>magic</tt> field to identify 
the queue a packet was expected to be in.  Toward the middle of 1993, the
0.99.11 release acquired an updated <a href="https://elixir.bootlin.com/linux/0.99.11/source/lib/malloc.c"><tt>kmalloc()</tt>
implementation</a> that sprinkled magic numbers around as a debugging aid.
That release, incidentally, is also the one where an attempt was made to
use C++ to build the kernel; that only lasted until 0.99.13, a couple of
months later.
</p><p>
The use of magic numbers in the kernel grew slowly after that.  The 1.1.13
release, in May 1994, added <a href="https://elixir.bootlin.com/linux/1.1.13/source/MAGIC">a file called
<tt>MAGIC</tt></a> in the top-level directory to keep track of the various
numbers in use; it listed eight such numbers.  This file was, incidentally,
nearly the first documentation file in the kernel beyond the basic
installation information; the kernel would not gain a directory for
documentation until 1.3.22 in 1995.  In this new file, Ted Ts&#39;o wrote:
</p><blockquote>
	It is a *very* good idea to protect kernel data structures with
	magic numbers.  This allows you to check at run time whether (a) a
	structure has been clobbered, or (b) you&#39;ve passed the wrong
	structure to a routine.  This last is especially useful ---
	particlarly when you are passing pointers to structures via a
	void * pointer.  The tty code, for example, does this
	frequently to pass
	driver-specific and line discipline-specific structures back and
	forth.
</blockquote>
<p>
The file went on to ask developers to follow this practice for future
additions to the kernel.  (For the curious: the typo of &#34;particularly&#34;
lasted until 1.1.42 in August 1994; otherwise that text persists to this
day). 
</p><p>
The 1.3.99 release saw the movement of <tt>MAGIC</tt> to <a href="https://elixir.bootlin.com/linux/1.3.99/source/Documentation/magic-number.txt"><tt>Documentation/magic-number.txt</tt></a>,
perhaps as part of a general cleaning-up prior to the imminent 2.0 release.
Some developers, at least, had clearly taken Ts&#39;o&#39;s advice; there were, at
this point, 21 entries in that file.  The <a href="https://elixir.bootlin.com/linux/2.2.0/source/Documentation/magic-number.txt">2.2.0
version</a> (January 1999) held 51 entries.  Magic numbers appeared to
be an established kernel-development practice.
</p><p>
The 2.4.0 release came almost exactly two years later.  <a href="https://elixir.bootlin.com/linux/2.4.0/source/Documentation/magic-number.txt">The
2.4 version of <tt>magic-number.txt</tt></a> was, except for one small
change, identical to the 2.2 version; no new magic numbers had been added.
That doesn&#39;t necessarily reflect a change in development practices so much
as the eternal habit of letting documentation go out of date.  Some effort
went into updating the file during the 2.5 development series, and the <a href="https://elixir.bootlin.com/linux/v2.6.0/source/Documentation/magic-number.txt">2.6.0
version</a> contained an even 100 magic numbers.  For the rest of the 2.6.x
series, though, the only changes were small tweaks and the removal of a
couple of obsolete entries; <tt>Documentation/magic-number.txt</tt> began
to shrink.
</p><p>
In fact, no additions to that file have been made in the entire Git
history.  In 2016 the file was converted to the RST format and moved into
the nascent development-process manual.  It mostly sat idle and unnoticed
until earlier this year, when the file began to shrink; the <a href="https://elixir.bootlin.com/linux/v6.1-rc5/source/Documentation/process/magic-number.rst">6.1 version of
<tt>Documentation/process/magic-number.rst</tt></a> is down to
14 entries.  Where has the magic gone?
</p><p>
This change is the result of Ziemiańska&#39;s work, which is aimed at removing
this file entirely; the current patch set describes it as &#34;<q>a low-value
historical relic at best and misleading cruft at worst</q>&#34;.  In that
series, Ziemiańska systematically deletes the final entries, often removing
the associated structure fields and magic-number checks in the code, until
the file is empty; the <a href="https://lwn.net/ml/linux-kernel/93e66d80680c52e8d04763fb2d86f841c69e32c9.1668128257.git.nabijaczleweli@nabijaczleweli.xyz/">final
patch</a> in the series simply deletes it.  Chances are that it will not be
missed.
</p><p>
There is no clear point where the development community made a collective
decision to move away from the magic-number practice; it just sort of faded
away.  The are probably a few reasons behind this change.  The kernel
community has, for many years now, tried to use type-safe interfaces rather
than passing <tt>void</tt> pointers around, making it less likely that the
wrong structure type will be passed into a function.  Developers spend less
time staring at hex dumps of data, preferring more structured output,
tracepoints, and interactive debuggers as ways of tracking down problems.
Debugging features in the kernel&#39;s memory allocators mean that many sorts
of memory-corruption issues will be caught directly.  Magic numbers 
are just not as helpful as they once were.
</p><p>
Magic numbers will still have their place; they still, for example, can
help filesystem code be confident that it is dealing with the correct type
of filesystem image.  Even there, though, the use of checksums for on-disk
data structures should provide better protection against many types of
problems. But, for the most part, kernel development has lost some of the
magic it once had; as often happens, it slipped away when nobody was paying
attention.<br clear="all"/></p><table>
           <tbody><tr><th colspan="2">Index entries for this article</th></tr>
           <tr><td><a href="https://lwn.net/Kernel/Index">Kernel</a></td><td><a href="https://lwn.net/Kernel/Index#Development_model-Patterns">Development model/Patterns</a></td></tr>
            </tbody></table></div></div>
  </body>
</html>
