<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.lunasec.io/docs/blog/log4j-zero-day-update-on-cve-2021-45046/">Original</a>
    <h1>Analysis of the 2nd Log4j CVE published earlier (CVE-2021-45046 / Log4Shell2)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody"><p><img src="https://www.lunasec.io/docs/img/log4shell-logo.png" alt="Log4Shell Logo"/></p><p><strong>Just trying to fix this? Please read our dedicated
<a href="https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide" target="_blank" rel="noopener noreferrer">Mitigation Guide</a>.</strong></p><p>After the log4j maintainers released version <code>2.15.0</code> to address the
<a href="https://www.lunasec.io/docs/blog/log4j-zero-day/" target="_blank" rel="noopener noreferrer">Log4Shell vulnerability</a>, an additional attack vector
was identified and reported in <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046" target="_blank" rel="noopener noreferrer">CVE-2021-45046</a>.</p><p>Our research into this shows that this new CVE invalidates previous mitigations used to protect versions
<code>2.7.0 &lt;= Apache log4j &lt;= 2.14.1</code> from Log4Shell in some cases.</p><h2 id="conditions-for-the-vulnerability">Conditions for the vulnerability<a aria-hidden="true" href="#conditions-for-the-vulnerability" title="Direct link to heading">​</a></h2><p>You may still be vulnerable to Log4Shell (RCE) if you only enabled the <code>noMsgFormatLookups</code> flag or set
<code>%m{nolookups}</code> when you also set data in the <code>ThreadContext</code> with attacker controlled data. In this case, you must
upgrade to <code>2.16.0</code> or else you will still be vulnerable to RCE.</p><div><p><h5><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>For version <code>2.15.0</code></h5></p><div><p>We found that the DOS outlined in the CVE was not actually impactful because it did not consume resources
during our testing (see <a href="#notes-on-the-denial-of-service-in-2.15.0">below</a>).</p><p>We could still be wrong through, so we continue to recommend that you upgrade to <code>2.16.0</code> in the event that a better
exploit is found to abuse this attack vector.</p></div></div><h2 id="the-new-cve-is-difficult-to-understand">The new CVE is difficult to understand<a aria-hidden="true" href="#the-new-cve-is-difficult-to-understand" title="Direct link to heading">​</a></h2><p>The mention of possible RCE is unfortunately missing from the published CVE. In the CVE
it only mentions a possible &#34;Denial-of-Service&#34; attack for versions prior to <code>2.15.0</code>.</p><p>Because of these findings, we recommend that everybody using log4j immediately upgrades to <code>2.16.0</code> or later, or manually
patches their log4j classes (for details, see our
<a href="https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide" target="_blank" rel="noopener noreferrer">Mitigation Guide</a>). Please read the rest of this post for context about
our research.</p><h2 id="context-on-cve-2021-45046">Context on CVE-2021-45046<a aria-hidden="true" href="#context-on-cve-2021-45046" title="Direct link to heading">​</a></h2><p>The new CVE states:</p><blockquote><p>It was found that the fix to address CVE-2021-44228 in Apache Log4j 2.15.0 was incomplete in certain non-default configurations.</p></blockquote><p>We found this report concerning as it states that one of the recommended temporary mitigations for versions
<code>2.7.0 &lt;= Apache log4j &lt;= 2.14.1</code>
might not protect against this CVE. Further:</p><blockquote><p>Note that previous mitigations involving configuration such as to set the system property <code>log4j2.noFormatMsgLookup</code> to <code>true</code> do NOT mitigate this specific vulnerability.</p></blockquote><p>It was not readily apparently from reading this CVE what specifically was affected, or how this vulnerability is actually
triggered. That&#39;s why we actually tested this ourselves to figure out what the impact was.</p><h2 id="testing-previous-mitigations">Testing previous mitigations<a aria-hidden="true" href="#testing-previous-mitigations" title="Direct link to heading">​</a></h2><p>Fortunately the community has been hard at work reacting to these updates. A fork of
<a href="https://github.com/christophetd/log4shell-vulnerable-app" target="_blank" rel="noopener noreferrer">christophetd/log4shell-vulnerable-app</a>
<a href="https://github.com/kmindi/log4shell-vulnerable-app/commit/e539f7e9a0c81e2c580d63caff5f4eae14033f19" target="_blank" rel="noopener noreferrer">added some changes</a>
to demonstrate the specific scenario in which this newly found CVE could affect an application.</p><p>In these changes, the previously discovered mitigation was included:</p><div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span>ENV LOG4J_FORMAT_MSG_NO_LOOKUPS </span><span>true</span><br/></span></code></pre></div></div><p>And the Log4j2 properties config includes a custom layout pattern:</p><div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span></span><span></span><br/></span><span><span>appender.console.layout.pattern </span><span>=</span><span> </span><span>${ctx</span><span>:</span><span>apiversion}</span><span> - %d</span><span>{</span><span>yyyy-MM-dd HH:mm:ss</span><span>}</span><span> %-5p %c</span><span>{</span><span>1</span><span>}</span><span>:%L - %m%n</span><br/></span><span><span></span><br/></span></code></pre></div></div><p>Now, instead of directly logging the attacker controlled input as with the previous vulnerability like this:</p><div><div><pre tabindex="0"><code><span><span>@</span><span>GetMapping</span><span>(</span><span>&#34;/&#34;</span><span>)</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>String</span><span> </span><span>index</span><span>(</span><span>@</span><span>RequestHeader</span><span>(</span><span>&#34;X-Api-Version&#34;</span><span>)</span><span> </span><span>String</span><span> apiVersion</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span>    logger</span><span>.</span><span>info</span><span>(</span><span>&#34;Received a request for API version &#34;</span><span> </span><span>+</span><span> apiVersion</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> </span><span>&#34;Hello, world!&#34;</span><span>;</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><p>In the layout pattern above, the <code>${ctx:apiversion}</code> format string refers to a <code>ThreadContext</code> value named <code>apiversion</code>.
In order to trigger the vulnerability, there needs to be code which lets the attacker influence the <code>apiversion</code> value.
The below handler demonstrates what this might look like in code:</p><div><div><pre tabindex="0"><code><span><span>@</span><span>GetMapping</span><span>(</span><span>&#34;/&#34;</span><span>)</span><span></span><br/></span><span><span></span><span>public</span><span> </span><span>String</span><span> </span><span>index</span><span>(</span><span>@</span><span>RequestHeader</span><span>(</span><span>&#34;X-Api-Version&#34;</span><span>)</span><span> </span><span>String</span><span> apiVersion</span><span>)</span><span> </span><span>{</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    </span><span>ThreadContext</span><span>.</span><span>put</span><span>(</span><span>&#34;apiversion&#34;</span><span>,</span><span> apiVersion</span><span>)</span><span>;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span></span><br/></span><span><span>    logger</span><span>.</span><span>info</span><span>(</span><span>&#34;Received a request for API version&#34;</span><span>)</span><span>;</span><span></span><br/></span><span><span>    </span><span>return</span><span> </span><span>&#34;Hello, world!&#34;</span><span>;</span><span></span><br/></span><span><span></span><span>}</span><br/></span></code></pre></div></div><div><p><h5><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Vulnerable App Log4j version</h5></p><p>This vulnerable application was running with Log4j version <code>2.14.1</code> which is still vulnerable to the RCE even
<em>before</em> the <code>LOG4J_FORMAT_MSG_NO_LOOKUPS</code> mitigation.</p></div><h2 id="our-findings">Our Findings<a aria-hidden="true" href="#our-findings" title="Direct link to heading">​</a></h2><h3 id="issues-when-using-log4j2noformatmsglookup-2100">Issues when using <code>log4j2.noFormatMsgLookup</code> (&gt;=2.10.0)<a aria-hidden="true" href="#issues-when-using-log4j2noformatmsglookup-2100" title="Direct link to heading">​</a></h3><p>Running this vulnerable server and exploiting the vulnerability with our <a href="https://github.com/lunasec-io/lunasec/tree/master/tools/log4shell" target="_blank" rel="noopener noreferrer">log4shell CLI tool</a>
we observed that RCE was still possible in versions <code>2.10.0 &lt;= Apache log4j &lt; 2.14.1</code>:</p><p><a target="_blank" href="https://www.lunasec.io/docs/assets/files/log4shell-CVE-2021-45046-exploitation-with-mitigation-0620b1d6f02e259077c10771c1cd41cc.png/"><img alt="Log4j RCE on log4j 2.14.1 with mitigation" src="https://www.lunasec.io/docs/assets/images/log4shell-CVE-2021-45046-exploitation-with-mitigation-0620b1d6f02e259077c10771c1cd41cc.png"/></a></p><p>The server is still vulnerable even with <code>log4j2.noFormatMsgLookup</code> enabled because the Pattern Layout has been modified
to include a reference to a Thread Context value. It appears that referencing Thread Context values in this way bypasses
the logic for disabling JNDI lookups when formatting a message. The <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046" target="_blank" rel="noopener noreferrer">CVE report</a>
outlines this as well as the other types of affected format strings:</p><blockquote><p>This could allow attackers with control over Thread Context Map (MDC) input data when the logging configuration uses
a non-default Pattern Layout with either a Context Lookup (for example, $${ctx:loginId}) or a Thread Context Map pattern
(%X, %mdc, or %MDC) to craft malicious input data using a JNDI Lookup pattern.</p></blockquote><p>We were not able to achieve RCE when using <code>%X, %mdc, or %MDC</code>, however we still do not consider these as safe to include
when running a Log4j version <code>&lt; 2.16.0</code>. To understand more about the Log4j Thread Context map, please refer to the <a href="https://logging.apache.org/log4j/2.x/manual/thread-context.html" target="_blank" rel="noopener noreferrer">docs</a>.</p><p>If you have previously used <code>LOG4J_FORMAT_MSG_NO_LOOKUPS</code> to mitigate the log4shell vulnerability, in certain conditions
this will not be sufficient to protect your code from RCE. Refer to our <a href="https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide" target="_blank" rel="noopener noreferrer">mitigation guide</a>
for additional steps you can take to remediate the impact of Log4Shell.</p><h3 id="setting-mnolookups-is-still-vulnerable-270">Setting <code>%m{nolookups}</code> is still vulnerable (&gt;=2.7.0)<a aria-hidden="true" href="#setting-mnolookups-is-still-vulnerable-270" title="Direct link to heading">​</a></h3><p>We continue to recommend <em>not</em> using <code>%m{nolookups}</code>, which we outline in our <a href="https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide" target="_blank" rel="noopener noreferrer">mitigation guide</a>, as we have also
proved the vulnerability is still exploitable with a Pattern Layout such as:</p><div><div><pre tabindex="0"><code><span><span>appender.console.layout.pattern = ${ctx:apiversion} - %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m{nolookups}%n</span><br/></span></code></pre></div></div><p><code>%m{nolookups</code> will only apply to the content being logged in the call to <code>logger.info()</code> and will not apply to the
resolving of <code>${ctx:apiversion}</code> which will contain our payload.</p><h3 id="notes-on-the-denial-of-service-in-2150">Notes on the Denial-of-Service in 2.15.0<a aria-hidden="true" href="#notes-on-the-denial-of-service-in-2150" title="Direct link to heading">​</a></h3><p>The less impactful part of this CVE, if you have updated your Log4j version to <code>2.15.0</code>, is that there is a limited
denial of service (DOS) possible under certain circumstances. See the below screenshot:</p><p><a target="_blank" href="https://www.lunasec.io/docs/assets/files/log4shell-CVE-2021-45046-dos-with-mitigation-60c41181aa2c91c1d14bf587e5f89b47.png/"><img alt="Log4j DOS on log4j 2.15.0 with mitigation" src="https://www.lunasec.io/docs/assets/images/log4shell-CVE-2021-45046-dos-with-mitigation-60c41181aa2c91c1d14bf587e5f89b47.png"/></a></p><p>However, in our testing we did not find this DOS to be resource consuming as it seemed that the infinite loop created by recursively
resolving <code>${ctx:apiversion}</code> was identified by the program and errored out.</p><p>Log4j <code>2.16.0</code> completely mitigates this issue by <code>removing support for message lookup patterns and disabling JNDI functionality by default</code>.</p><h2 id="stay-updated">Stay Updated<a aria-hidden="true" href="#stay-updated" title="Direct link to heading">​</a></h2><p>Please follow us on <a href="https://twitter.com/LunaSecIO" target="_blank" rel="noopener noreferrer">Twitter</a> or add yourself to our mailing list below, and we&#39;ll
update you when we publish new findings.</p><p>And if this post helped you, please share it with others to help them too.</p><h2 id="limited-offer-free-security-assistance">Limited Offer: Free Security Assistance<a aria-hidden="true" href="#limited-offer-free-security-assistance" title="Direct link to heading">​</a></h2><p>We&#39;re also currently offering a free 30-minute consultation with one of our Security Engineers. If you&#39;re interested,
please <a href="https://lunasec.youcanbook.me/" target="_blank" rel="noopener noreferrer">book some time with us here</a>.</p><h2 id="updates">Updates<a aria-hidden="true" href="#updates" title="Direct link to heading">​</a></h2><div><p><h5><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></p><div><p>We&#39;re continuously keeping this post up-to-date as new information comes out. If you have any questions, or you&#39;re
confused about our advice, please <a href="https://github.com/lunasec-io/lunasec/issues" target="_blank" rel="noopener noreferrer">file an Issue</a> on GitHub.</p><p>If you would like to contribute, or notice any errors, this post is an Open Source Markdown file on
<a href="https://github.com/lunasec-io/lunasec/blob/master/docs/blog/2021-12-14-log4j-zero-day-update-on-CVE-2021-45046.mdx" target="_blank" rel="noopener noreferrer">GitHub</a>.</p></div></div></div></div>
  </body>
</html>
