<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rachelbythebay.com/w/2024/01/24/wpa3/">Original</a>
    <h1>WPA3 on Raspberry Pi 3B&#43;, 4B and 5B with iwd (or not...)</h1>
    
    
<p>
Okay, it&#39;s been several months since I
<a href="https://rachelbythebay.com/w/2023/11/07/wpa3/">last</a>
wrote about WPA3 on Raspberry Pi hardware.  Now, I have some good news: 
it now mostly works, assuming you&#39;re willing to do a little tinkering.  
You no longer have to wrangle custom firmwares and binary blobs into 
place.  That&#39;s been done for you.
</p>
<p>
One important thing here: I&#39;m only talking about Raspbian/Raspberry Pi 
OS here, and then only bookworm (12).  If you&#39;re running something else, 
none of this may apply.  For all I know, it might have been working all 
along if your distribution figured it out sooner.
</p>
<p>
So then, if you have a 3B+, 4B or 5B on bookworm, get ready to rock.
</p>
<p>
Every so often I look at the list of package updates coming down the 
pipe through apt for my systems, and usually groan at the usual round of 
CVE patches.  But, this time I saw something rather different.  It&#39;s a 
change to &#34;firmware-brcm80211&#34;, and what&#39;s this?  Something specific 
to the CYW43455 that the 3B+ and later use?  Oh, that&#39;s interesting, 
right?
</p>
<pre class="terminal">  * brcm80211: cypress: Use a generic CYW43455 firmware
    - Version: 7.45.234 (4ca95bb CY) CRC: 212e223d Date: Thu 2021-04-15 03:06:00 PDT Ucode Ver: 1043.2161 FWID 01-996384e2
</pre>
<p>
I wondered if this would stop the madness, and so applied it and 
rebooted.  &#34;iw phy&#34; showed the good news - at the very bottom, it now 
supports both SAE_OFFLOAD and SAE_OFFLOAD_AP.  This means it can 
actually do SAE... but you&#39;re going to have to say goodbye to 
wpa_supplicant in favor of iwd.
</p>
<p>
If you switched over to NetworkManager for consistency with the rest of 
the bookworm changes, this is not a big deal.  If you&#39;re running your 
network some other way, you get to figure this out yourself.
</p>
<p>
The steps work out like this: apt update, then apt upgrade so you get 
the firmware-brcm80211 from January 17th (or later, once this post gets 
old, I guess).  Then apt install iwd.
</p>
<p>
Assuming you&#39;ve been running your Pi in a crappy non-WPA3 network, go 
into nmtui or equivalent and disable that network.  In a minute or two, 
you&#39;re not going to need it any more.
</p>
<p>
Then disable wpa_supplicant and drop a bit of config into
/etc/NetworkManager/conf.d/iwd.conf:
</p>
<pre class="terminal">[device]
wifi.backend=iwd
</pre>
<p>
Reboot ... or do equivalent wrangling of drivers and binary crap to get 
it to unload and reload the fresh stuff.  Then run &#34;iw phy&#34; again.  If 
it says SAE_OFFLOAD and SAE_OFFLOAD_AP, you&#39;re ready to proceed.  If 
not, well, something&#39;s wrong, and you should turn on the crappy old 
non-WPA3 network again.
</p>
<p>
Assuming it worked, then go into nmtui or whatever and tell it to 
activate the actual WPA3-only network.  Paste in your PSK and let it go, 
and a few seconds later you should be in business.
</p>
<p>
That&#39;s it.  That&#39;s all it takes.
</p>
<p>
Now then, what about the 3B, you might ask.  It&#39;s on a different chip 
that doesn&#39;t even do 5 GHz, so changing the 43455 firmware wouldn&#39;t help 
any.  It seems to be a 43430 instead, and I have no idea if there&#39;s any 
chance of getting a similar firmware change for it.  Obviously, if this 
changes, I&#39;ll post something about it, too.
</p>
<p>
I can&#39;t comment on the other models, like the Zeroes and the other weird 
little boards they have.  I only have access to these relatively normal 
models, and that&#39;s what I was able to work on.
</p>
<p>
Go forth and have better networks!
</p>
<hr/>
<p>January 24, 2024: This post has an <a href="https://rachelbythebay.com/w/2024/01/24/fail/">update</a>.</p>

  </body>
</html>
