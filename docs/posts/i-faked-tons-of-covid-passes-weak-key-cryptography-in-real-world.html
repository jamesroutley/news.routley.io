<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ctrsec.io/index.php/2021/09/29/weak-key-cryptography-in-real-world-english/">Original</a>
    
    <div id="readability-page-1" class="page"><div>

				<h3>I. SUMMARY</h3>
<p>Hanoi Police Department was using a QR generation system to provide COVID passes for its citizens to go out. The system was vulnerable to a weak key cryptography attack which may allow COVID patients to self-generate passes.</p>
<h3>II. ANALYSIS</h3>
<p><b>1.</b> <b>QR DATA</b></p>
<p>1 – Vehicle type</p>
<p>2 – License plate</p>
<p>3 – Seat #</p>
<p>4 – Vehicle operator</p>
<p>5 – Citizen ID</p>
<p>6 – Authorized zone</p>
<p>7 – Valid from/to (date)</p>
<p>8 – Valid from/to (time)</p>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/1.jpg" alt="" width="954" height="682" srcset="https://ctrsec.io/wp-content/uploads/2021/09/1.jpg 954w, https://ctrsec.io/wp-content/uploads/2021/09/1-300x214.jpg 300w, https://ctrsec.io/wp-content/uploads/2021/09/1-768x549.jpg 768w" sizes="(max-width: 954px) 100vw, 954px"/></p>
<p>As the QR code was not hidden, we were able to decode its information:</p>
<pre><b>D9LOgcTFAS1MeC3kD4J+5PmAW5C4mOrPcbwbynsY6GEuGNkpe/dwIM5cr0MS/a+LT1y9z+8sKJA9UaPZTmYJwQ==|</b>10505|3|06/09;07/09;08/09;09/09;10/09;11/09;12/09;13/09;14/09;15/09;16/09;17/09;18/09;19/09;20/09|4_PHÒNG CẢNH SÁT GIAO THÔNG|02439424451|29G1–391.89| |Vùng 1|Nguyễn Ánh Ngọc||09:00–20:00</pre>
<p>The decoded string above contains information about the requester, zone ID/passes provider (i.e. <strong>10505</strong>). Additionally, there is a signature string at the beginning of this decoded QR – signed by RSA – SHA 256.</p>
<p><b>2.</b> <b>VALIDATION METHOD</b></p>
<p>It was not hard for us to find out the application on Google Play Store (now removed). However, due to countries restriction, we had to use VPN to download the application named “<b>Kiểm soát đi đường</b>” a.k.a “<strong>Vehicle Operating Control</strong>” (Translated as best as I can)</p>
<blockquote><p><b><i>Download link (now removed)</i></b>: <a href="https://play.google.com/store/apps/details?id=com.qrca">https://play.google.com/store/apps/details?id=com.qrca</a></p></blockquote>
<p>Let’s go through the application workflow:</p>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/12.png" alt="" width="640" height="201" srcset="https://ctrsec.io/wp-content/uploads/2021/09/12.png 640w, https://ctrsec.io/wp-content/uploads/2021/09/12-300x94.png 300w" sizes="(max-width: 640px) 100vw, 640px"/></p>

<p>The above workflow is server-less, meaning it does not need any servers during the application process. Hence, there would be an obvious pros: the system would never be overloaded. However, the huge cons here is: the application trusts its clients 100% which is not ideal.</p>
<p>Not validating the data on server side means one thing: If the Private Key from one (1) zone was leaked, anyone would be able to generate valid passes.</p>
<p><b>3.</b> <b>DEEPER DIVE INTO THE WORKFLOW</b></p>
<pre><b>D9LOgcTFAS1MeC3kD4J+5PmAW5C4mOrPcbwbynsY6GEuGNkpe/dwIM5cr0MS/a+LT1y9z+8sKJA9UaPZTmYJwQ==|</b>10505|3|06/09;07/09;08/09;09/09;10/09;11/09;12/09;13/09;14/09;15/09;16/09;17/09;18/09;19/09;20/09|4_PHÒNG CẢNH SÁT GIAO THÔNG|02439424451|29G1–391.89| |Vùng 1|Nguyễn Ánh Ngọc||09:00–20:00</pre>
<p>This contains: “<b>10505</b>” – zone ID/passes provider, named “<strong>Police Department</strong>“.</p>
<p>Once the application received the QR data, it would take the data string from zone ID to the end, then do the following steps:</p>
<ul>
<li>Removing <strong>“|”,</strong></li>
<li>Removing special characters</li>
<li>English Alphabetized Vietnamese chars (i.e.: ê -&gt; e)</li>
<li>Lowercase transformation</li>
</ul>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/3.jpg" alt="" width="1186" height="196" srcset="https://ctrsec.io/wp-content/uploads/2021/09/3.jpg 1186w, https://ctrsec.io/wp-content/uploads/2021/09/3-300x50.jpg 300w, https://ctrsec.io/wp-content/uploads/2021/09/3-1024x169.jpg 1024w, https://ctrsec.io/wp-content/uploads/2021/09/3-768x127.jpg 768w" sizes="(max-width: 1186px) 100vw, 1186px"/></p>
<p>Input string process</p>
<p>The data became:</p>
<pre><b>10505</b>3060907090809090910091109120913091409150916091709180919092009<b>4_phongcanhsatgiaothong</b>02439424451<b>29g139189</b>vung1<b>nguyenanhngoc</b>09002000</pre>
<p>Next, the data was hashed using a custom hashing algorithm developed by <b>lachongtech. </b>The algorithm pseudocode is below:</p>
<pre><b>Hashcode</b> = 0
Count = 0
For char in String:
Count += 1
<b>Hashcode</b> += char * Count
<b>Hashcode</b> = (1988 * <b>Hashcode</b> — 1910) / 2</pre>
<p>Once the data went through above hashing process, it then became a new format: “<b>682673275</b>”</p>
<ul>
<li>This is the first cons in the application workflow. The fact that the above hashcode was quite easy to reproduce led to possible Collision attacks, meaning there could be other strings having the same hashcode.</li>
</ul>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/4.jpg" alt="" width="1185" height="479" srcset="https://ctrsec.io/wp-content/uploads/2021/09/4.jpg 1185w, https://ctrsec.io/wp-content/uploads/2021/09/4-300x121.jpg 300w, https://ctrsec.io/wp-content/uploads/2021/09/4-1024x414.jpg 1024w, https://ctrsec.io/wp-content/uploads/2021/09/4-768x310.jpg 768w" sizes="(max-width: 1185px) 100vw, 1185px"/></p>
<p>The data, after getting through hashcode process, will then be validated using hard-coded Public key in the application. However, we found all hard-coded Public keys were using RSA 512. Obviously, RSA 512-bits key was proven breakable years ago.</p>
<p>After spending few hours doing research, we found an interesting research paper: <strong>Factoring as a Service</strong></p>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/5.jpg" alt="" width="432" height="187" srcset="https://ctrsec.io/wp-content/uploads/2021/09/5.jpg 432w, https://ctrsec.io/wp-content/uploads/2021/09/5-300x130.jpg 300w" sizes="(max-width: 432px) 100vw, 432px"/></p>
<blockquote>
<p>Reference: <a href="https://seclab.upenn.edu/projects/faas/faas.pdf">https://seclab.upenn.edu/projects/faas/faas.pdf</a></p>
</blockquote>
<p>The authors utilized the “cloud power” to crack one (1) RSA 512-bit key within a few hours instead of using a single machine. And looks like it’s doable. Luckily, the authors also published their research as well as code repo.</p>
<blockquote><p>Link: <a href="https://github.com/eniac/faas">https://github.com/eniac/faas</a></p></blockquote>
<p>Although the code was provided, we took around 2 days to get this running since the code was written back in 2015. Some libraries are not currently supported forced us to make several changes on the code. The project was then running smoothly.</p>
<h3>III. STATE OF THE ART</h3>
<p>The most interesting thing, I believe, not about the bug, but about setting up cracking environment.</p>
<h3>1. Setting up the environment</h3>
<ul>
<li>As I mentioned above, the code was written back in 2015 by a group of Professors and Researchers from the University of Pennsylvania. A 7 years old tool, in fact, is no longer compatible with current libraries and software versions. Hence, it took time to setup and dry-run. Most of the time we spent on debugging, finding compatible libraries versions.</li>
<li>The result came back great as we were able to crack a sample 100 chars length RSA.</li>
</ul>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/6.jpg" alt="" width="697" height="1169" srcset="https://ctrsec.io/wp-content/uploads/2021/09/6.jpg 697w, https://ctrsec.io/wp-content/uploads/2021/09/6-179x300.jpg 179w, https://ctrsec.io/wp-content/uploads/2021/09/6-611x1024.jpg 611w" sizes="(max-width: 697px) 100vw, 697px"/></p>
<h3>2. Cracking the real key</h3>
<p>Jumping back to the application, hard-coded public keys have 155 chars in length (RSA 512-bits). This means, cracking them would need more than 1 cloud instance and super time consuming.</p>
<p>We used a total of 16 EC2 instances x 36 CPUs x 60 GiB Memory for each key. Once the script is run, the only thing we would do is waiting and hoping it will not return any FATAL errors.</p>
<p>Surprisingly, roughly 9 hours later, we were able to get the result</p>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/7.jpg" alt="" width="1581" height="878" srcset="https://ctrsec.io/wp-content/uploads/2021/09/7.jpg 1581w, https://ctrsec.io/wp-content/uploads/2021/09/7-300x167.jpg 300w, https://ctrsec.io/wp-content/uploads/2021/09/7-1024x569.jpg 1024w, https://ctrsec.io/wp-content/uploads/2021/09/7-768x427.jpg 768w, https://ctrsec.io/wp-content/uploads/2021/09/7-1536x853.jpg 1536w" sizes="(max-width: 1581px) 100vw, 1581px"/></p>
<h3>3. Cost</h3>
<p>We spent ~$250 USD to crack 2 RSA 512-bits keys in 9 hours (+ sample key – 100 chars)</p>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/8-scaled.jpg" alt="" width="2560" height="503" srcset="https://ctrsec.io/wp-content/uploads/2021/09/8-scaled.jpg 2560w, https://ctrsec.io/wp-content/uploads/2021/09/8-300x59.jpg 300w, https://ctrsec.io/wp-content/uploads/2021/09/8-1024x201.jpg 1024w, https://ctrsec.io/wp-content/uploads/2021/09/8-768x151.jpg 768w, https://ctrsec.io/wp-content/uploads/2021/09/8-1536x302.jpg 1536w, https://ctrsec.io/wp-content/uploads/2021/09/8-2048x402.jpg 2048w" sizes="(max-width: 2560px) 100vw, 2560px"/>We then tried to optimize the entire process by re-using generated sieves for other keys but unsuccessful. I also reached out to one of the authors and was told to store these sieves in a database. However, due to several reasons, we did not try further.</p>
<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/9.jpg" alt="" width="1430" height="387" srcset="https://ctrsec.io/wp-content/uploads/2021/09/9.jpg 1430w, https://ctrsec.io/wp-content/uploads/2021/09/9-300x81.jpg 300w, https://ctrsec.io/wp-content/uploads/2021/09/9-1024x277.jpg 1024w, https://ctrsec.io/wp-content/uploads/2021/09/9-768x208.jpg 768w" sizes="(max-width: 1430px) 100vw, 1430px"/></p>
<h3>4. Generating QR code using found Private Key</h3>
<p>Once we got the key factors, we were able to calculate the original Private Key and generate several valid COVID passes.</p>
<h3>IV. DEMO</h3>
<h3><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/10.png" alt="" width="974" height="261" srcset="https://ctrsec.io/wp-content/uploads/2021/09/10.png 974w, https://ctrsec.io/wp-content/uploads/2021/09/10-300x80.png 300w, https://ctrsec.io/wp-content/uploads/2021/09/10-768x206.png 768w" sizes="(max-width: 974px) 100vw, 974px"/></h3>
<p>Generating QR Code</p>

<p><img loading="lazy" src="https://ctrsec.io/wp-content/uploads/2021/09/11.png" alt="" width="1080" height="2160" srcset="https://ctrsec.io/wp-content/uploads/2021/09/11.png 1080w, https://ctrsec.io/wp-content/uploads/2021/09/11-150x300.png 150w, https://ctrsec.io/wp-content/uploads/2021/09/11-512x1024.png 512w, https://ctrsec.io/wp-content/uploads/2021/09/11-768x1536.png 768w, https://ctrsec.io/wp-content/uploads/2021/09/11-1024x2048.png 1024w" sizes="(max-width: 1080px) 100vw, 1080px"/></p>
<p>Valid COVID pass</p>


<p>======================================================================</p>

</div></div>
  </body>
</html>
