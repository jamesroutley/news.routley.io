<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ecb.torontomu.ca/~elf/hack/recovery.html">Original</a>
    <h1>Unix Recovery Legend (1986)</h1>
    
    <div id="readability-page-1" class="page">

<h4>This classic article from Mario Wolczko first
appeared on Usenet in 1986.  </h4>

Have you ever left your terminal logged in, only to find when you
came back to it that a (supposed) friend had typed &#34;<kbd>rm -rf
~/*</kbd>&#34; and was hovering over the keyboard with threats along the
lines of &#34;<em>lend me a fiver &#39;til Thursday, or I hit return</em>&#34;?
Undoubtedly the person in question would not have had the nerve to
inflict such a trauma upon you, and was doing it in jest.  So you&#39;ve
probably never experienced the worst of such disasters....<p>


It was a quiet Wednesday afternoon.  Wednesday, 1st October, 15:15
BST, to be precise, when Peter, an office-mate of mine, leaned away
from his terminal and said to me, &#34;<em>Mario, I&#39;m having a little
trouble sending mail.</em>&#34; Knowing that msg was capable of confusing
even the most capable of people, I sauntered over to his terminal to
see what was wrong.  A strange error message of the form (I forget
the exact details) &#34;<kbd>cannot access /foo/bar for userid 147</kbd>&#34;
had been issued by msg.  My first thought was &#34;<em>Who&#39;s userid 147?;
the sender of the message, the destination, or what?</em>&#34; So I leant
over to another terminal, already logged in, and typed</p><blockquote>        <kbd>grep 147 /etc/passwd</kbd></blockquote>

<p>only to receive the response</p><blockquote>        <kbd>/etc/passwd: No such file or directory.</kbd></blockquote>

Instantly, I guessed that something was amiss.  This was confirmed
when in response to<blockquote>        <kbd>ls /etc</kbd></blockquote>

<p>I got</p><blockquote>        <kbd>ls: not found.</kbd></blockquote>

I suggested to Peter that it would be a good idea not to try anything
for a while, and went off to find our system manager.<p>

When I arrived at his office, his door was ajar, and within ten
seconds I realised what the problem was.  James, our manager, was
sat down, head in hands, hands between knees, as one whose world has
just come to an end.  Our newly-appointed system programmer, Neil, was
beside him, gazing listlessly at the screen of his terminal.  And at
the top of the screen I spied the following lines:</p><blockquote>
        <kbd># cd </kbd>
</blockquote>

<p>Oh, shit, I thought.  That would just about explain it.</p><p>


I can&#39;t remember what happened in the succeeding minutes; my memory
is just a blur.  I do remember trying <kbd>ls</kbd> (again),
<kbd>ps</kbd>, <kbd>who</kbd> and maybe a few other commands beside,
all to no avail.  The next thing I remember was being at my terminal
again (a multi-window graphics terminal), and typing</p><blockquote>
        <kbd>cd /</kbd>
</blockquote>
<p>I owe a debt of thanks to David Korn for making <kbd>echo</kbd> a
built-in of his shell; needless to say, <kbd>/bin</kbd>, together
with <kbd>/bin/echo</kbd>, had been deleted.  What transpired in the
next few minutes was that <kbd>/dev</kbd>, <kbd>/etc</kbd> and
<kbd>/lib</kbd> had also gone in their entirety; fortunately Neil had
interrupted <kbd>rm</kbd> while it was somewhere down below
<kbd>/news</kbd>, and <kbd>/tmp</kbd>, <kbd>/usr</kbd> and
<kbd>/users</kbd> were all untouched.</p><p>


Meanwhile James had made for our tape cupboard and had retrieved what
claimed to be a dump tape of the root filesystem, taken four weeks
earlier.  The pressing question was, &#34;<em>How do we recover the
contents of the tape?</em>&#34;.  Not only had we lost
<kbd>/etc/restore</kbd>, but all of the device entries for the tape
deck had vanished.  And where does <kbd>mknod</kbd> live?  You
guessed it, <kbd>/etc</kbd>.  How about recovery across Ethernet of
any of this from another VAX?  Well, <kbd>/bin/tar</kbd> had gone,
and thoughtfully the Berkeley people had put <kbd>rcp</kbd> in
<kbd>/bin</kbd> in the 4.3 distribution.  What&#39;s more, none of the
Ether stuff wanted to know without <kbd>/etc/hosts</kbd> at least.
We found a version of <kbd>cpio</kbd> in <kbd>/usr/local</kbd>, but
that was unlikely to do us any good without a tape deck.</p><p>


Alternatively, we could get the boot tape out and rebuild the root
filesystem, but neither James nor Neil had done that before, and we
weren&#39;t sure that the first thing to happen would be that the whole
disk would be re-formatted, losing all our user files.  (We take dumps
of the user files every Thursday; by Murphy&#39;s Law this had to happen
on a Wednesday).  Another solution might be to borrow a disk from
another VAX, boot off that, and tidy up later, but that would have
entailed calling the DEC engineer out, at the very least.  We had a
number of users in the final throes of writing up PhD theses and the
loss of a maybe a weeks&#39; work (not to mention the machine down time)
was unthinkable.</p><p>


So, what to do?  The next idea was to write a program to make a
device descriptor for the tape deck, but we all know where
<kbd>cc</kbd>, <kbd>as</kbd> and <kbd>ld</kbd> live.  Or maybe make
skeletal entries for <kbd>/etc/passwd</kbd>, <kbd>/etc/hosts</kbd>
and so on, so that <kbd>/usr/bin/ftp</kbd> would work.  By sheer
luck, I had a <kbd>gnuemacs</kbd> still running in one of my windows,
which we could use to create <kbd>passwd</kbd>, etc., but the first
step was to create a directory to put them in.  Of course
<kbd>/bin/mkdir</kbd> had gone, and so had <kbd>/bin/mv</kbd>, so we
couldn&#39;t rename <kbd>/tmp</kbd> to <kbd>/etc</kbd>.  However, this
looked like a reasonable line of attack.</p><p>


By now we had been joined by Alasdair, our resident UNIX guru, and as
luck would have it, someone who knows VAX assembler.  So our plan
became this: write a program in assembler which would either rename
<kbd>/tmp</kbd> to <kbd>/etc</kbd>, or make <kbd>/etc</kbd>, assemble
it on another VAX, <kbd>uuencode</kbd> it, type in the uuencoded file
using my gnu, <kbd>uudecode</kbd> it (some bright spark had thought
to put <kbd>uudecode</kbd> in <kbd>/usr/bin</kbd>), run it, and hey
presto, it would all be plain sailing from there.  By yet another
miracle of good fortune, the terminal from which the damage had been
done was still <kbd>su</kbd>&#39;d to root (<kbd>su</kbd> is in
<kbd>/bin</kbd>, remember?), so at least we stood a chance of all
this working.</p><p>


Off we set on our merry way, and within only an hour we had managed
to concoct the dozen or so lines of assembler to create
<kbd>/etc</kbd>.  The stripped binary was only 76 bytes long, so we
converted it to hex (slightly more readable than the output of
<kbd>uuencode</kbd>), and typed it in using my editor.  If any of you
ever have the same problem, here&#39;s the hex for future reference:</p><blockquote>
   <kbd>070100002c000000000000000000000000000000000000000000000000000000</kbd>
</blockquote>

<p>

I had a handy program around (doesn&#39;t everybody?) for converting
ASCII hex to binary, and the output of <kbd>/usr/bin/sum</kbd>
tallied with our original binary.  But hang on---how do you set
execute permission without <kbd>/bin/chmod</kbd>?  A few seconds
thought (which as usual, lasted a couple of minutes) suggested that
we write the binary on top of an already existing binary, owned by
me...problem solved.

So along we trotted to the terminal with the root login, carefully
remembered to set the umask to 0 (so that I could create files in it
using my gnu), and ran the binary.  So now we had a <kbd>/etc</kbd>,
writable by all.  From there it was but a few easy steps to creating
<kbd>passwd</kbd>, <kbd>hosts</kbd>, <kbd>services</kbd>,
<kbd>protocols</kbd>, (etc), and then <kbd>ftp</kbd> was willing to
play ball.  Then we recovered the contents of <kbd>/bin</kbd> across
the ether (it&#39;s amazing how much you come to miss <kbd>ls</kbd> after
just a few, short hours), and selected files from <kbd>/etc</kbd>.
The key file was <kbd>/etc/rrestore</kbd>, with which we recovered
<kbd>/dev</kbd> from the dump tape, and the rest is history.</p><p>


Now, you&#39;re asking yourself (as I am), what&#39;s the moral of this
story?  Well, for one thing, you must always remember the immortal
words, <strong>DON&#39;T PANIC</strong>.  Our initial reaction was to
reboot the machine and try everything as single user, but it&#39;s
unlikely it would have come up without <kbd>/etc/init</kbd> and
<kbd>/bin/sh</kbd>.  Rational thought saved us from this one.</p><p>


The next thing to remember is that UNIX tools really can be put to
unusual purposes.  Even without my <kbd>gnuemacs</kbd>, we could have
survived by using, say, <kbd>/usr/bin/grep</kbd> as a substitute for
<kbd>/bin/cat</kbd>.</p><p>


And the final thing is, it&#39;s amazing how much of the system you can
delete without it falling apart completely.  Apart from the fact that
nobody could login (<kbd>/bin/login</kbd>?), and most of the useful
commands had gone, everything else seemed normal.  Of course, some
things can&#39;t stand life without say <kbd>/etc/termcap</kbd>, or
<kbd>/dev/kmem</kbd>, or <kbd>/etc/utmp</kbd>, but by and large it
all hangs together.</p><p>


I shall leave you with this question: if you were placed in the same
situation, and had the presence of mind that always comes with
hindsight, could you have got out of it in a simpler or easier way?
Answers on a postage stamp to:</p><pre>Mario Wolczko
------------------------------------------------------------------------
Dept. of Computer Science       ARPA:   miw%uk.ac.man.cs.ux@cs.ucl.ac.uk
The University                  USENET: mcvax!ukc!man.cs.ux!miw
Manchester M13 9PL              JANET:  miw@uk.ac.man.cs.ux
U.K.                            061-273 7121 x 5699
------------------------------------------------------------------------
</pre>

<hr/>

<address><a href="https://www.ecb.torontomu.ca/~elf/hack/index.html%20">Hacker&#39;s Wisdom</a>: Unix Recovery
Legend</address>

<!-- hhmts start -->
Last modified: Thu Mar  7 13:47:40 EST 1996
<!-- hhmts end --></div>
  </body>
</html>
