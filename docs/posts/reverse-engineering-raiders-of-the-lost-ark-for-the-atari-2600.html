<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/joshuanwalker/Raiders2600">Original</a>
    <h1>Reverse Engineering Raiders of the Lost Ark for the Atari 2600</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><strong>Original Game (1982) by Atari, Inc.</strong></p>
<hr/>

<p dir="auto">This repository contains the fully reverse-engineered and commented source code for the Atari 2600 classic, <em>Raiders of the Lost Ark</em>.</p>

<p dir="auto">The project has been reorganized for a clean development workflow:</p>
<ul dir="auto">
<li><strong><code>src/</code></strong>: Contains the main assembly source (<code>raiders.asm</code>) and header files (<code>tia_constants.h</code>).</li>
<li><strong><code>bin/</code></strong>: Contains build tools (DASM) and emulator executable (Stella).</li>
<li><strong><code>out/</code></strong>: Destination for compiled binaries (<code>.bin</code>), symbol files (<code>.sym</code>), and listing files (<code>.lst</code>). (auto generated at compile time)</li>
<li><strong><code>make.bat</code></strong>: Windows batch script to compile the project.</li>
<li><strong><code>run.bat</code></strong>: Windows batch script to launch the compiled game.</li>
</ul>


<ul dir="auto">
<li>Windows OS</li>
<li><strong>DASM</strong>: <code>dasm.exe</code> must be in the <code>bin/</code> folder.</li>
<li><strong>Stella</strong>: <code>Stella.exe</code> and <code>SDL2.dll</code> must be in the <code>bin/</code> folder (optional, for running).</li>
</ul>

<p dir="auto">Run the build script from the root directory:</p>


<p dir="auto">Launch the compiled ROM in Stella:</p>

<hr/>


<p dir="auto">The game uses a <strong>2-bank ROM</strong> (8KB total) with bank-switching via strobes at <code>BANK0STROBE</code> (<code>$FFF8</code>) and <code>BANK1STROBE</code> (<code>$FFF9</code>). Bank switching is done through a self-modifying code technique whare opcodes are written into zero-page RAM variables and executed in-place.</p>
<ul dir="auto">
<li><strong>Bank 0</strong> (<code>BANK0TOP</code> = <code>$D000</code>): Contains game logic — collision handling, inventory management, room event handlers, scoring, movement, input processing, and sound.</li>
<li><strong>Bank 1</strong> (<code>BANK1TOP</code> = <code>$F000</code>): Contains the display kernels, sprite data, playfield graphics, room handler dispatch, and music frequency tables.</li>
</ul>

<p dir="auto">Like all Atari 2600 games, the program is structured around the NTSC television signal — one complete pass through the loop produces one frame of video (~60 fps). The frame is divided into four phases: <strong>VSYNC</strong>, <strong>VBLANK</strong>, <strong>Kernel</strong> (visible picture), and <strong>Overscan</strong>. Game logic is split across VBLANK and Overscan to stay within the CPU time budgets of each phase, and the two ROM banks are switched in and out at specific points every frame.</p>

<div data-snippet-clipboard-copy-content="newFrame ──spin on INTIM──►
startNewFrame
  ├── VSYNC (3 scanlines)
  │     Timers, weapon clamp, RESET check
  │
  ├── VBLANK (~37 scanlines of CPU time)
  │   ├── [Bank 0] Main game logic
  │   │     Ark Room / title ── Snake AI ──
  │   │     Event checks ── Input &amp; movement ──
  │   │     Inventory ── Item use ──
  │   │     Sprite animation ── Mesa scroll
  │   │
  │   ├── [Bank 1] Room-specific handler
  │   │     Per-room AI, physics, spawning
  │   │
  │   └── [Bank 0] Pre-kernel setup
  │         Colors, NUSIZ, CTRLPF from tables
  │         setObjPosX: position all 5 TIA objects
  │         Spin on INTIM until VBLANK expires
  │
  ├── VISIBLE KERNEL (~192 scanlines)
  │   ├── [Bank 1] drawScreen preamble (5 lines)
  │   │     Clear collisions, set initial PF, enable TIA
  │   │
  │   ├── [Bank 1] Room kernel dispatch (160 lines)
  │   │     staticSpriteKernel ──── rooms 0–5
  │   │     scrollingPlayfieldKernel ── rooms 6–10
  │   │     multiplexedSpriteKernel ── rooms 11–12
  │   │     arkPedestalKernel ──── room 13
  │   │
  │   └── [Bank 1] drawInventoryKernel (~27 lines)
  │         6-item inventory strip, selection cursor
  │
  └── OVERSCAN (~30 scanlines of CPU time)
      ├── [Bank 1] Post-kernel logic
      │     Sound/music ── Timepiece sprite ──
      │     Event animation ── Death sequence ──
      │     Inventory cycling ── Grapple state
      │
      └── [Bank 0] Collision handling
            Weapon hits ── Indy vs objects ──
            Room-specific pickups ── Idle handlers
            ──► newFrame (loop closes)"><pre><code>newFrame ──spin on INTIM──►
startNewFrame
  ├── VSYNC (3 scanlines)
  │     Timers, weapon clamp, RESET check
  │
  ├── VBLANK (~37 scanlines of CPU time)
  │   ├── [Bank 0] Main game logic
  │   │     Ark Room / title ── Snake AI ──
  │   │     Event checks ── Input &amp; movement ──
  │   │     Inventory ── Item use ──
  │   │     Sprite animation ── Mesa scroll
  │   │
  │   ├── [Bank 1] Room-specific handler
  │   │     Per-room AI, physics, spawning
  │   │
  │   └── [Bank 0] Pre-kernel setup
  │         Colors, NUSIZ, CTRLPF from tables
  │         setObjPosX: position all 5 TIA objects
  │         Spin on INTIM until VBLANK expires
  │
  ├── VISIBLE KERNEL (~192 scanlines)
  │   ├── [Bank 1] drawScreen preamble (5 lines)
  │   │     Clear collisions, set initial PF, enable TIA
  │   │
  │   ├── [Bank 1] Room kernel dispatch (160 lines)
  │   │     staticSpriteKernel ──── rooms 0–5
  │   │     scrollingPlayfieldKernel ── rooms 6–10
  │   │     multiplexedSpriteKernel ── rooms 11–12
  │   │     arkPedestalKernel ──── room 13
  │   │
  │   └── [Bank 1] drawInventoryKernel (~27 lines)
  │         6-item inventory strip, selection cursor
  │
  └── OVERSCAN (~30 scanlines of CPU time)
      ├── [Bank 1] Post-kernel logic
      │     Sound/music ── Timepiece sprite ──
      │     Event animation ── Death sequence ──
      │     Inventory cycling ── Grapple state
      │
      └── [Bank 0] Collision handling
            Weapon hits ── Indy vs objects ──
            Room-specific pickups ── Idle handlers
            ──► newFrame (loop closes)
</code></pre></div>
<div dir="auto"><h4 tabindex="-1" dir="auto">Phase 1: VSYNC (3 Scanlines)</h4><a id="user-content-phase-1-vsync-3-scanlines" aria-label="Permalink: Phase 1: VSYNC (3 Scanlines)" href="#phase-1-vsync-3-scanlines"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>Entry point</strong>: <code>startNewFrame</code></p>
<p dir="auto">The CPU asserts the VSYNC signal for exactly 3 scanlines, during which it performs lightweight housekeeping:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Scanline</th>
<th>Work</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Assert VSYNC. Clamp weapon position — if <code>weaponPosY</code> ≤ <code>$50</code>, center <code>weaponPosX</code>. Increment <code>frameCount</code>; every 64th frame (<code>and #$3f</code>) increments <code>timeOfDay</code>. If <code>eventTimer</code> is negative, decrement it (paralysis/cutscene countdown).</td>
</tr>
<tr>
<td>2</td>
<td>Check for game restart — if <code>arkRoomStateFlag</code> bit 7 is set (endgame state) AND the RESET switch is pressed, jump to <code>startGame</code>.</td>
</tr>
<tr>
<td>3</td>
<td>De-assert VSYNC. Arm the VBLANK timer: <code>TIM64T = VBLANK_TIME</code> (44). This gives 44 × 64 = 2,816 cycles ≈ 37 scanlines of CPU time for game logic.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h4 tabindex="-1" dir="auto">Phase 2: VBLANK (~37 Scanlines of CPU Time)</h4><a id="user-content-phase-2-vblank-37-scanlines-of-cpu-time" aria-label="Permalink: Phase 2: VBLANK (~37 Scanlines of CPU Time)" href="#phase-2-vblank-37-scanlines-of-cpu-time"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">All game logic runs while the TIA outputs a blank screen. Work is spread across both ROM banks with two bank switches during this phase.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Bank 0 — Main Game Logic</h5><a id="user-content-bank-0--main-game-logic" aria-label="Permalink: Bank 0 — Main Game Logic" href="#bank-0--main-game-logic"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This is the largest block of game code, executing in order every frame:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Step</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>frameFirstLine</code></td>
<td><strong>Game-over check</strong>: if <code>gameEventFlag</code> overflows to 0, call <code>getFinalScore</code> and transition to the Ark Room.</td>
</tr>
<tr>
<td>2</td>
<td><code>checkShowDevInitials</code></td>
<td><strong>Ark Room / title screen</strong>: if in the Ark Room, play Raiders March, check Yar bonus for HSW initials easter egg. Otherwise skip.</td>
</tr>
<tr>
<td>3</td>
<td><em>(Ark Room only)</em></td>
<td><strong>Pedestal elevator</strong>: slowly lower Indy to his score height. Check fire button for restart. Set <code>arkRoomStateFlag</code> to enable RESET.</td>
</tr>
<tr>
<td>4</td>
<td><code>HandleEasterEgg</code></td>
<td><strong>Cutscene check</strong>: if <code>screenEventState</code> bit 6 is set, advance the Arkbreveal sequence.</td>
</tr>
<tr>
<td>5</td>
<td><code>advanceArkSeq</code></td>
<td><strong>Snake AI</strong>: every 4th frame, grow snake sprite, steer toward Indy using <code>snakePosXOffsetTable</code>, update <code>ballPosX</code>/<code>ballPosY</code> and <code>kernelRenderState</code>.</td>
</tr>
<tr>
<td>6</td>
<td><code>configSnake</code></td>
<td><strong>Snake kernel setup</strong>: load <code>kernelDataPtrLo/Hi</code> and <code>kernelDataIndex</code> from <code>snakeMotionTable</code> for the wiggling ball sprite.</td>
</tr>
<tr>
<td>7</td>
<td><code>checkMajorEventDone</code></td>
<td>If <code>gameEventFlag</code> bit 7 is set (death in progress), skip to <code>finishedScrollUpdate</code> — bypass normal input.</td>
</tr>
<tr>
<td>8</td>
<td><code>checkGameScriptTimer</code></td>
<td>If <code>eventTimer</code> is negative (Indy paralyzed/frozen), force standing sprite and skip input.</td>
</tr>
<tr>
<td>9</td>
<td><code>branchOnFrameParity</code></td>
<td><strong>Frame parity split</strong>: even frames run full input processing. Odd frames skip to <code>clearItemUseOnButtonRelease</code>.</td>
</tr>
<tr>
<td>10</td>
<td><code>gatePlayerTriggeredEvent</code></td>
<td><strong>Weapon aiming</strong>: joystick moves the weapon crosshair (missile 1) with boundary clamping.</td>
</tr>
<tr>
<td>11</td>
<td><code>handleIndyMove</code></td>
<td><strong>Movement</strong>: read <code>SWCHA</code> → <code>getMoveDir</code> → move Indy → check room boundary override tables (<code>CheckRoomOverrideCondition</code>) → trigger room transitions if a boundary is crossed.</td>
</tr>
<tr>
<td>12</td>
<td><code>HandleIInventorySelect</code></td>
<td><strong>Left controller</strong>: fire button cycles through inventory slots. Handles item drop, bullet reload (+3), and shovel placement.</td>
</tr>
<tr>
<td>13</td>
<td><code>clearItemUseOnButtonRelease</code></td>
<td>Clears <code>USING_GRENADE_OR_PARACHUTE</code> flag on right fire button release.</td>
</tr>
<tr>
<td>14</td>
<td><code>handleItemUse</code></td>
<td><strong>Right controller</strong>: fire button dispatches the selected item — grenade throw/cook timer, parachute deploy, grapple hook launch, shovel dig, Ankh warp, revolver fire, whip strike. This is the largest single block in VBLANK.</td>
</tr>
<tr>
<td>15</td>
<td><code>updateIndyParachuteSprite</code></td>
<td><strong>Sprite selection</strong>: choose Indy&#39;s current sprite pointer — parachute sprite, standing sprite, or walk-cycle animation (advances frame on a timer).</td>
</tr>
<tr>
<td>16</td>
<td><code>handleMesaScroll</code></td>
<td><strong>Vertical scrolling</strong>: in Mesa Field or Valley of Poison, shift the camera offset (<code>roomObjectVar</code>) and adjust all object Y positions to scroll the world.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h5 tabindex="-1" dir="auto">Bank Switch → Bank 1: Room Handlers</h5><a id="user-content-bank-switch--bank-1-room-handlers" aria-label="Permalink: Bank Switch → Bank 1: Room Handlers" href="#bank-switch--bank-1-room-handlers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">At <code>finishedScrollUpdate</code>, the code writes <code>selectRoomHandler</code> as the target address and jumps through the <code>jumpToBank1</code> trampoline.</p>
<p dir="auto"><code>selectRoomHandler</code> dispatches via <code>roomHandlerJmpTable</code> — each room has its own handler that runs room-specific AI and physics:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Room</th>
<th>Handler</th>
<th>Key Logic</th>
</tr>
</thead>
<tbody>
<tr>
<td>Treasure Room</td>
<td><code>treasureRoomHandler</code></td>
<td>Item cycle timer, treasure availability, treasure spawning</td>
</tr>
<tr>
<td>Marketplace</td>
<td><em>(none — immediate return)</em></td>
<td>—</td>
</tr>
<tr>
<td>Entrance Room</td>
<td><code>entranceRoomHandler</code></td>
<td>Sets <code>screenEventState = $40</code></td>
</tr>
<tr>
<td>Black Market</td>
<td><code>blackMarketRoomHandler</code></td>
<td>Lunatic/blocker positioning, bribe check</td>
</tr>
<tr>
<td>Map Room</td>
<td><code>mapRoomHandler</code></td>
<td>Sun height from <code>timeOfDay</code>, Head of Ra beam, movement constraints</td>
</tr>
<tr>
<td>Mesa Side</td>
<td><code>mesaSideRoomHandler</code></td>
<td>Parachute/freefall physics, gravity, horizontal input</td>
</tr>
<tr>
<td>Temple Entrance</td>
<td><code>templeEntranceRoomHandler</code></td>
<td>Timepiece placement, room graphics from <code>entranceRoomEventState</code></td>
</tr>
<tr>
<td>Spider Room</td>
<td><code>spiderRoomHandler</code></td>
<td>Spider AI (passive→aggressive), web positioning, animation</td>
</tr>
<tr>
<td>Shining Light</td>
<td><code>roomOfShiningLightHandler</code></td>
<td>Chase AI, dungeon secret exit check</td>
</tr>
<tr>
<td>Mesa Field</td>
<td><code>mesaFieldRoomHandler</code></td>
<td>Pins P0/M0/Ball to center Y (<code>$7F</code>) for scrolling</td>
</tr>
<tr>
<td>Valley of Poison</td>
<td><code>valleyOfPoisonRoomHandler</code></td>
<td>Thief chase/escape AI, tsetse swarm spawning</td>
</tr>
<tr>
<td>Thieves&#39; Den</td>
<td><code>thievesDenRoomHandler</code></td>
<td>Moves 5 thieves with left/right boundary bounce</td>
</tr>
<tr>
<td>Well of Souls</td>
<td><code>WellOfSoulsRoomHandler</code></td>
<td>Sets mesa landing bonus, then shares thief-movement code</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">All handlers exit via <code>jmpSetupNewRoom</code>, which bank-switches back to Bank 0.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Bank Switch → Bank 0: Pre-Kernel Setup</h5><a id="user-content-bank-switch--bank-0-pre-kernel-setup" aria-label="Permalink: Bank Switch → Bank 0: Pre-Kernel Setup" href="#bank-switch--bank-0-pre-kernel-setup"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>setupNewRoom</code> prepares the TIA for display:</p>
<ol dir="auto">
<li>If <code>screenInitFlag</code> ≠ 0, call <code>updateRoomEventState</code> (one-shot room initialization), then clear the flag.</li>
<li>Set <code>NUSIZ0</code> from the per-room <code>HMOVETable</code> entry.</li>
<li>Set <code>CTRLPF</code> from <code>roomPFControlFlags</code> (playfield reflection/priority/ball size).</li>
<li>Set <code>COLUBK</code>, <code>COLUPF</code>, <code>COLUP0</code>, <code>COLUP1</code> from per-room color tables.</li>
<li>If in the Thieves&#39; Den or Well of Souls, initialize 5 thief HMOVE positions from table data.</li>
</ol>
<p dir="auto">Then <code>setObjPosX</code> positions all 5 TIA objects (P0, P1, M0, M1, Ball) using the coarse/fine HMOVE technique. This consumes <strong>6 scanlines</strong> (one WSYNC per object + one for HMOVE).</p>
<p dir="auto">Finally, <code>waitTime</code> spins on <code>INTIM</code> until the VBLANK timer expires, then bank-switches to Bank 1 for <code>drawScreen</code>.</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Phase 3: Visible Kernel (~192 Scanlines)</h4><a id="user-content-phase-3-visible-kernel-192-scanlines" aria-label="Permalink: Phase 3: Visible Kernel (~192 Scanlines)" href="#phase-3-visible-kernel-192-scanlines"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><strong>Entry point</strong>: <code>drawScreen</code> (Bank 1)</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Kernel Preamble (5 Scanlines)</h5><a id="user-content-kernel-preamble-5-scanlines" aria-label="Permalink: Kernel Preamble (5 Scanlines)" href="#kernel-preamble-5-scanlines"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The first few visible lines set up the display state:</p>
<ul dir="auto">
<li>Clear horizontal motion registers (<code>HMCLR</code>) and collision latches (<code>CXCLR</code>).</li>
<li>Write initial PF0/PF1/PF2 from per-room playfield tables.</li>
<li>Enable TIA output (<code>VBLANK = 0</code>), zero the <code>scanline</code> counter.</li>
<li>Disable the Ball sprite in the Map Room (used for the sun position mechanic).</li>
<li>Read <code>SWCHA</code> → set <code>REFP1</code> for Indy sprite reflection (skipped during death/Ark Room).</li>
<li>Three WSYNC+HMOVE pairs to settle object positions.</li>
<li>Dispatch to the appropriate kernel via RTS-trick: push return address from <code>kernelJumpTable</code> indexed by <code>KernelJumpTableIndex</code> for the current room, then <code>rts</code>.</li>
</ul>
<div dir="auto"><h5 tabindex="-1" dir="auto">Room Kernels (160 Scanlines)</h5><a id="user-content-room-kernels-160-scanlines" aria-label="Permalink: Room Kernels (160 Scanlines)" href="#room-kernels-160-scanlines"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The kernel index table maps each room to one of four kernels:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Index</th>
<th>Kernel</th>
<th>Rooms</th>
<th>Scanline Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>staticSpriteKernel</code></td>
<td>0–5</td>
<td>2 scanlines/iteration, 80 iterations</td>
</tr>
<tr>
<td>2</td>
<td><code>scrollingPlayfieldKernel</code></td>
<td>6–10</td>
<td>2 scanlines/iteration, 80 iterations</td>
</tr>
<tr>
<td>4</td>
<td><code>multiplexedSpriteKernel</code></td>
<td>11–12</td>
<td>State machine, variable per thief zone</td>
</tr>
<tr>
<td>6</td>
<td><code>arkPedestalKernel</code></td>
<td>13</td>
<td>1 scanline/iteration, ~160 lines</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong><code>staticSpriteKernel</code></strong> (Treasure Room, Marketplace, Entrance, Black Market, Map Room, Mesa Side):
Two scanlines per loop. Scanline 1: HMOVE, check snake/ball draw range, enable missiles M0 (web/swarm) and M1 (weapon) by comparing against their Y positions. Scanline 2: draw P0 sprite — bit 7 of the graphics data encodes inline TIA register writes (color/HMOVE) instead of shape data, allowing P0 to change color or position mid-frame. Enable the ball by scanline comparison.</p>
<p dir="auto"><strong><code>scrollingPlayfieldKernel</code></strong> (Temple Entrance, Spider Room, Shining Light, Mesa Field, Valley of Poison):
Two scanlines per loop with playfield scrolling. On each iteration, the scanline is compared to <code>p0DrawStartLine</code> — above that boundary, the kernel indexes <code>(pf1GfxPtrLo),y</code> / <code>(pf2GfxPtrLo),y</code> with a scroll offset (<code>roomObjectVar</code>) to render the scrolling wall. Below that boundary, <code>dynamicGfxData</code> renders destructible dungeon wall segments or cleared passages. Both paths draw P0 and P1 (Indy) by scanline–vs–Y comparison. The ball object is driven through <code>(kernelDataPtrLo),y</code> for the snake wiggle animation.</p>
<p dir="auto"><strong><code>multiplexedSpriteKernel</code></strong> (Thieves&#39; Den, Well of Souls):
Displays 5 enemy thieves using a single P0 hardware sprite, repositioned between each thief&#39;s zone (~32 scanlines each). Operates as a state machine via <code>kernelRenderState</code>: <strong>positioning phase</strong> (bit 7) uses a coarse/fine delay loop to place RESP0, <strong>drawing phase</strong> (bit 6) streams <code>(p0GfxPtrLo),y</code> and <code>(kernelDataPtrLo),y</code> for sprite and color data across 16 lines. Between thief zones, P1 (Indy) is drawn using the PHP/stack trick — <code>txs</code> redirects the stack pointer so that <code>php</code> writes directly to TIA enable registers (<code>ENABL</code>/<code>ENAM1</code>/<code>ENAM0</code> at <code>$1F</code>/<code>$1E</code>/<code>$1D</code>).</p>
<p dir="auto"><strong><code>arkPedestalKernel</code></strong> (Ark Room — title and ending screen):
Single-height scanlines (1 WSYNC per line). Lines 0–14: draw the Ark top/wings sprite with rainbow color cycling (only in win state). Lines 15–28: draw the Ark body with alternating gold patterns. Lines 29–143: draw Indy&#39;s standing sprite at the pedestal height determined by <code>adventurePoints</code> — above Indy is empty, below is the diamond-pattern <code>PedestalLiftSprite</code>. Lines 144–159: draw the pedestal base.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Inventory Kernel (~27 Scanlines)</h5><a id="user-content-inventory-kernel-27-scanlines" aria-label="Permalink: Inventory Kernel (~27 Scanlines)" href="#inventory-kernel-27-scanlines"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">All four room kernels converge at <code>drawInventoryKernel</code>, which draws the bottom-of-screen inventory strip:</p>
<ol dir="auto">
<li><strong>2 lines</strong>: Clear all sprites, fill PF1/PF2 solid (separator bar).</li>
<li><strong>2 lines</strong>: Set <code>NUSIZ0</code>/<code>NUSIZ1</code> to 3-copies-close mode, enable VDEL for both players, position P0/P1 for 48-pixel-wide multiplexed rendering.</li>
<li><strong>1 line</strong>: HMOVE to fine-position, set inventory item colors (gold), position ball (selection cursor).</li>
<li><strong>1 line</strong>: Clear playfield, set <code>COLUBK</code> to black.</li>
<li><strong>5 lines</strong>: Burgundy background border.</li>
<li><strong>8 lines</strong>: <code>drawInventoryItems</code> — render 6 inventory item sprites using the 48-pixel GRP0/GRP1 VDEL technique (write P0, P1, P0, P1, P0, P1 in rapid succession each line).</li>
<li><strong>4 lines</strong>: Clear sprites, reset VDEL/NUSIZ, draw selection cursor ball.</li>
<li><strong>4 lines</strong>: Final separator lines and overscan preparation.</li>
</ol>
<div dir="auto"><h4 tabindex="-1" dir="auto">Phase 4: Overscan (~30 Scanlines of CPU Time)</h4><a id="user-content-phase-4-overscan-30-scanlines-of-cpu-time" aria-label="Permalink: Phase 4: Overscan (~30 Scanlines of CPU Time)" href="#phase-4-overscan-30-scanlines-of-cpu-time"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Immediately after the inventory kernel, the TIA is blanked (<code>VBLANK = $0F</code>) and the overscan timer is armed: <code>TIM64T = OVERSCAN_TIME</code> (36). This gives 36 × 64 = 2,304 cycles ≈ 30 scanlines. The stack pointer is also reset to <code>$FF</code> here.</p>
<div dir="auto"><h5 tabindex="-1" dir="auto">Bank 1 — Post-Kernel Logic</h5><a id="user-content-bank-1--post-kernel-logic" aria-label="Permalink: Bank 1 — Post-Kernel Logic" href="#bank-1--post-kernel-logic"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Step</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>updateSoundRegisters</code></td>
<td>Process both TIA audio channels (X=1, then X=0). Set AUDC, AUDV, AUDF. Dispatch to <code>playRaidersMarch</code> (effect <code>$9C</code>) or <code>playFluteMelody</code> (effect <code>$84</code>) for sustained music playback.</td>
</tr>
<tr>
<td>2</td>
<td><code>finishUpdateSound</code></td>
<td>If holding the Timepiece: toggle open/closed sprite on right fire press. If holding the Flute: activate Snake Charmer song.</td>
</tr>
<tr>
<td>3</td>
<td><code>updateEventState</code></td>
<td>If <code>screenEventState</code> bit 7 is set: animate the on-screen event (move object toward target via <code>updateMoveToTarget</code>), update timepiece graphics pointer for the snake reveal animation.</td>
</tr>
<tr>
<td>4</td>
<td><code>UpdateInvItemPos</code></td>
<td>Position 3 inventory display objects (X=2,3,4) via <code>UpdateInvObjPos</code> — converts item slot sprite pointers into on-screen X positions.</td>
</tr>
<tr>
<td>5</td>
<td><em>(death check)</em></td>
<td><strong>Death dissolve sequence</strong>: if <code>gameEventFlag</code> bit 7 is set, shrink <code>indySpriteHeight</code> by 1 line every 16 frames with a descending sound effect. At height &lt; 3 (hat only), rotate the flag and pause for 60 frames. At frame 120: respawn with full height, decrement <code>livesLeft</code>. If <code>livesLeft</code> goes negative, set <code>gameEventFlag = $FF</code> (triggers game-over on the next frame&#39;s overflow check).</td>
</tr>
<tr>
<td>6</td>
<td><code>invItemSelectCycle</code></td>
<td>If not in the Ark Room: read <code>SWCHA</code> left/right to cycle inventory selection. Handle hourglass → grapple initialization in Mesa Field. Drive the grapple state machine (incrementing stages, position alignment checks).</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h5 tabindex="-1" dir="auto">Bank Switch → Bank 0: Collision Handling</h5><a id="user-content-bank-switch--bank-0-collision-handling" aria-label="Permalink: Bank Switch → Bank 0: Collision Handling" href="#bank-switch--bank-0-collision-handling"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">At <code>jmpObjHitHandeler</code>, the code bank-switches to Bank 0 and enters the collision dispatch chain. This reads the TIA collision registers that were latched during the kernel:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Step</th>
<th>Label</th>
<th>Collision Register</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>checkWeaponPlayerHit</code></td>
<td><code>CXM1P</code></td>
<td>Weapon (M1) hit player/thief → flip thief direction, clear weapon, apply <code>thiefShotPenalty</code>.</td>
</tr>
<tr>
<td>2</td>
<td><code>checkWeaponPlayfieldHit</code></td>
<td><code>CXM1FB</code></td>
<td>Weapon hit playfield → destroy dungeon wall segment (modify <code>dynamicGfxData</code> bitmask).</td>
</tr>
<tr>
<td>3</td>
<td><code>checkWeaponBallHit</code></td>
<td><code>CXM1FB</code> bit 6</td>
<td>Weapon hit ball/snake → kill the snake.</td>
</tr>
<tr>
<td>4</td>
<td><code>checkIndyBallHit</code></td>
<td><code>CXP1FB</code></td>
<td>Indy hit playfield/ball → timepiece pickup, flute immunity check, tsetse fly paralysis, snake death.</td>
</tr>
<tr>
<td>5</td>
<td><code>checkMesaSideExit</code></td>
<td><code>CXM0P</code></td>
<td>Mesa Side: M0 collision enters Well of Souls; falling off (Indy Y ≥ <code>$4F</code>) enters Valley of Poison.</td>
</tr>
<tr>
<td>6</td>
<td><code>checkPlayerCollision</code></td>
<td><code>CXPPMM</code></td>
<td>Player-player collision → dispatches to room-specific handlers via <code>playerHitJumpTable</code> for pickups and interactions (whip, key, baskets, shovel, parachute landing, etc.).</td>
</tr>
<tr>
<td>7</td>
<td><code>playerHitDefault</code></td>
<td><code>CXP1FB</code></td>
<td>Secondary dispatch → <code>playfieldHitJumpTable</code> for wall/boundary collisions and idle room logic.</td>
</tr>
<tr>
<td>8</td>
<td><code>checkMissile0Hit</code></td>
<td><code>CXM0P</code></td>
<td>M0-player collisions (spider web capture, tsetse swarm death), grenade detonation timer check.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">After the collision chain completes, execution falls through to <code>newFrame</code>, which spins on <code>INTIM</code> waiting for the overscan timer to expire — and the cycle begins again.</p>

<p dir="auto">Both banks contain a symmetric trampoline routine (<code>jumpToBank1</code> in Bank 0, <code>JumpToBank0</code> in Bank 1). The trampoline writes self-modifying code into zero-page RAM (<code>temp0</code>–<code>temp5</code>):</p>
<div data-snippet-clipboard-copy-content="temp0: LDA $FFF8/$FFF9    ; reading the strobe address switches banks
temp3: JMP &lt;target&gt;        ; then jumps to the target address"><pre><code>temp0: LDA $FFF8/$FFF9    ; reading the strobe address switches banks
temp3: JMP &lt;target&gt;        ; then jumps to the target address
</code></pre></div>
<p dir="auto">The caller sets <code>temp4</code>/<code>temp5</code> to the target address before jumping to the trampoline. Executing <code>jmp temp0</code> reads the bank strobe (switching ROM) and immediately jumps to the target label in the new bank.</p>
<p dir="auto"><strong>Bank switches per frame</strong> (in execution order):</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>#</th>
<th>Direction</th>
<th>Trigger</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Bank 0 → 1</td>
<td><code>finishedScrollUpdate</code></td>
<td><code>selectRoomHandler</code> (room-specific handler)</td>
</tr>
<tr>
<td>2</td>
<td>Bank 1 → 0</td>
<td><code>jmpSetupNewRoom</code></td>
<td><code>setupNewRoom</code> (pre-kernel color/position setup)</td>
</tr>
<tr>
<td>3</td>
<td>Bank 0 → 1</td>
<td><code>jmpDisplayKernel</code></td>
<td><code>drawScreen</code> (visible kernel + overscan)</td>
</tr>
<tr>
<td>4</td>
<td>Bank 1 → 0</td>
<td><code>jmpObjHitHandeler</code></td>
<td><code>checkWeaponPlayerHit</code> (collision dispatch)</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Bank 1 also has a safety stub (<code>BANK1Start</code>) at its reset vector entry — it immediately reads <code>BANK0STROBE</code> to switch back to Bank 0 if Bank 1 is entered on power-on.</p>

<p dir="auto"><strong>Title / Ark Room</strong>: The Ark Room (<code>ID_ARK_ROOM</code>, <code>$0D</code>) serves double duty as the title screen and the endgame screen. On cold boot, <code>startGame</code> sets <code>currentRoomId = ID_ARK_ROOM</code> and fills inventory with copyright text sprites. The VBLANK Ark Room logic plays the Raiders March, runs the pedestal elevator animation (lowering Indy to his score height), and checks the fire button for restart.</p>
<p dir="auto"><strong>Death Sequence</strong>: Setting <code>gameEventFlag</code> bit 7 triggers the death dissolve during overscan. Indy&#39;s sprite height shrinks by one line every 16 frames. Once only the hat remains (height &lt; 3), the flag is rotated and the sprite disappears for 60 frames. At frame 120, Indy respawns at full height and <code>livesLeft</code> is decremented. If lives drop below zero, <code>gameEventFlag</code> is set to <code>$FF</code> — on the next frame, the VBLANK overflow check catches this and transitions to the Ark Room.</p>
<p dir="auto"><strong>Room Transitions</strong>: Triggered by the boundary override system in <code>handleIndyMove</code>. When Indy crosses a room edge (checked via <code>CheckRoomOverrideCondition</code> against per-room boundary tables), <code>currentRoomId</code> is changed and <code>initRoomState</code> reinitializes all per-room state — sprites, playfield pointers, object positions, and event flags. Special transitions include: Mesa Side fall into Valley of Poison (Y position check), M0 collision into Well of Souls, blown-open wall alignment into the Temple, and Ankh warp directly to Mesa Field.</p>

<p dir="auto">The game uses <strong>4 different scanline kernels</strong> selected via <code>KernelJumpTableIndex</code> and <code>kernelJumpTable</code>:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Index</th>
<th>Kernel</th>
<th>Rooms</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>staticSpriteKernel</code></td>
<td>Treasure Room, Marketplace, Entrance Room, Black Market, Map Room, Mesa Side</td>
</tr>
<tr>
<td>1</td>
<td><code>scrollingPlayfieldKernel</code></td>
<td>Temple Entrance, Spider Room, Shining Light, Mesa Field, Valley of Poison</td>
</tr>
<tr>
<td>2</td>
<td><code>multiplexedSpriteKernel</code> (thiefKernel)</td>
<td>Thieves&#39; Den, Well of Souls</td>
</tr>
<tr>
<td>3</td>
<td><code>arkPedestalKernel</code></td>
<td>Ark Room (title/ending)</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Each kernel handles TIA register writes differently to accommodate the visual needs of those rooms — the thief kernel manages multiple P0 objects across scanlines, while the playfield kernel handles scrolling dungeon walls.</p>
<ul dir="auto">
<li><strong><code>staticSpriteKernel</code></strong>: P0&#39;s data stream is dual-purpose — bit 7 encodes direct TIA register writes (color/HMOVE) instead of graphics. Simplest kernel.</li>
<li><strong><code>scrollingPlayfieldKernel</code></strong>: Full PF1/PF2 rendering from pointer tables, dynamic dungeon wall segments, conventional P0/P1 drawing, ball object for timepiece. Supports scrollable rooms.</li>
<li><strong><code>multiplexedSpriteKernel</code></strong>: P0 is repositioned and redrawn multiple times per frame via coarse timing loops — classic scanline multiplexing to display several enemies from one hardware sprite.</li>
<li><strong><code>arkPedestalKernel</code></strong>: Single-purpose kernel for the title/ending screen — draws the Ark sprite and Indy on a height-adjustable pedestal.</li>
</ul>

<p dir="auto">There are <strong>14 rooms</strong> defined as constants (IDs <code>$00</code>–<code>$0D</code>):</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>ID</th>
<th>Constant</th>
<th>Room</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$00</code></td>
<td><code>ID_TREASURE_ROOM</code></td>
<td>Treasure Room</td>
</tr>
<tr>
<td><code>$01</code></td>
<td><code>ID_MARKETPLACE</code></td>
<td>Marketplace</td>
</tr>
<tr>
<td><code>$02</code></td>
<td><code>ID_ENTRANCE_ROOM</code></td>
<td>Entrance Room</td>
</tr>
<tr>
<td><code>$03</code></td>
<td><code>ID_BLACK_MARKET</code></td>
<td>Black Market</td>
</tr>
<tr>
<td><code>$04</code></td>
<td><code>ID_MAP_ROOM</code></td>
<td>Map Room</td>
</tr>
<tr>
<td><code>$05</code></td>
<td><code>ID_MESA_SIDE</code></td>
<td>Side of Mesa</td>
</tr>
<tr>
<td><code>$06</code></td>
<td><code>ID_TEMPLE_ENTRANCE</code></td>
<td>Temple Entrance</td>
</tr>
<tr>
<td><code>$07</code></td>
<td><code>ID_SPIDER_ROOM</code></td>
<td>Spider Room</td>
</tr>
<tr>
<td><code>$08</code></td>
<td><code>ID_ROOM_OF_SHINING_LIGHT</code></td>
<td>Room of Shining Light</td>
</tr>
<tr>
<td><code>$09</code></td>
<td><code>ID_MESA_FIELD</code></td>
<td>Mesa Field</td>
</tr>
<tr>
<td><code>$0A</code></td>
<td><code>ID_VALLEY_OF_POISON</code></td>
<td>Valley of Poison</td>
</tr>
<tr>
<td><code>$0B</code></td>
<td><code>ID_THIEVES_DEN</code></td>
<td>Thieves&#39; Den</td>
</tr>
<tr>
<td><code>$0C</code></td>
<td><code>ID_WELL_OF_SOULS</code></td>
<td>Well of Souls</td>
</tr>
<tr>
<td><code>$0D</code></td>
<td><code>ID_ARK_ROOM</code></td>
<td>Ark Room (Title/End)</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Room transitions call <code>initRoomState</code> which loads per-room data from tables: <code>roomBGColorTable</code>, <code>roomPFColorTable</code>, <code>PFControlTable</code>, <code>objectPosXTable</code>, <code>roomObjPosYTable</code>, playfield graphics pointers, and sprite data.</p>
<p dir="auto">Each room has a <strong>handler</strong> dispatched from <code>roomHandlerJmpTable</code> (Bank 1), which runs room-specific logic every frame.</p>

<p dir="auto">The player can carry up to <strong>6 items</strong> (<code>MAX_INVENTORY_ITEMS</code>). Each slot is a pair of zero-page pointers (<code>invSlotLo</code>/<code>invSlotHi</code> through <code>invSlotLo6</code>/<code>invSlotHi6</code>) that point directly to 8-byte sprite data in the <code>inventorySprites</code> table.</p>
<p dir="auto">Item IDs are computed at assembly time as offsets from the sprite table:</p>
<div data-snippet-clipboard-copy-content="ID = (spriteLabel - inventorySprites) / HEIGHT_ITEM_SPRITES"><pre><code>ID = (spriteLabel - inventorySprites) / HEIGHT_ITEM_SPRITES
</code></pre></div>
<p dir="auto">Key items and their IDs include:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Item</th>
<th>Constant</th>
</tr>
</thead>
<tbody>
<tr>
<td>Empty</td>
<td><code>ID_INVENTORY_EMPTY</code></td>
</tr>
<tr>
<td>Whip</td>
<td><code>ID_INVENTORY_WHIP</code></td>
</tr>
<tr>
<td>Flute</td>
<td><code>ID_INVENTORY_FLUTE</code></td>
</tr>
<tr>
<td>Coins</td>
<td><code>ID_INVENTORY_COINS</code></td>
</tr>
<tr>
<td>Grenade (Market)</td>
<td><code>ID_MARKETPLACE_GRENADE</code></td>
</tr>
<tr>
<td>Grenade (Black Market)</td>
<td><code>ID_BLACK_MARKET_GRENADE</code></td>
</tr>
<tr>
<td>Key</td>
<td><code>ID_INVENTORY_KEY</code></td>
</tr>
<tr>
<td>Revolver</td>
<td><code>ID_INVENTORY_REVOLVER</code></td>
</tr>
<tr>
<td>Head of Ra</td>
<td><code>ID_INVENTORY_HEAD_OF_RA</code></td>
</tr>
<tr>
<td>Parachute</td>
<td><code>ID_INVENTORY_PARACHUTE</code></td>
</tr>
<tr>
<td>Timepiece</td>
<td><code>ID_INVENTORY_TIME_PIECE</code></td>
</tr>
<tr>
<td>Ankh</td>
<td><code>ID_INVENTORY_ANKH</code></td>
</tr>
<tr>
<td>Chai</td>
<td><code>ID_INVENTORY_CHAI</code></td>
</tr>
<tr>
<td>Hourglass</td>
<td><code>ID_INVENTORY_HOUR_GLASS</code></td>
</tr>
<tr>
<td>Shovel</td>
<td><code>ID_INVENTORY_SHOVEL</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Selection uses the left joystick. <code>selectedItemSlot</code> tracks the cursor position (byte offset 0,2,4,6,8,10 into the slot array), and <code>selectedInventoryId</code> holds the current item&#39;s ID. Items are added via <code>placeItemInInventory</code> and removed via <code>removeItem</code>.</p>
<p dir="auto"><strong>Item Tracking Bitmasks:</strong></p>
<p dir="auto">The game tracks which items have been collected using two separate bitmasks:</p>
<ul dir="auto">
<li><strong><code>basketItemStatus</code></strong> — Tracks <strong>spawnable items</strong> found at fixed world locations. In the Marketplace, these are the three literal baskets that contain the Key, Grenades, and Revolver. In the Treasure Room, the term &#34;basket&#34; is a code abstraction — it simply means the item is in its original, non-picked-up state (P0 displays the cycling item, and touching it picks it up). These items can respawn when dropped.</li>
<li><strong><code>pickupItemStatus</code></strong> — Tracks <strong>unique items</strong> that exist as one-of-a-kind objects in the world: Whip, Shovel, Head of Ra, Timepiece, Hourglass, Ankh, and Chai. Once collected, their world placement changes.</li>
</ul>
<p dir="auto">The <code>itemIndexTable</code> determines which bitmask applies to each item: even indices use <code>basketItemStatus</code>, odd indices use <code>pickupItemStatus</code>. The helper routines <code>showItemAsTaken</code>, <code>setItemAsNotTaken</code>, and <code>isItemAlreadyTaken</code> handle the bit manipulation transparently.</p>

<p dir="auto">The score (<code>adventurePoints</code>) starts at <code>INIT_SCORE</code> (100) and is modified in <code>getFinalScore</code>. Lower is better — bonuses are subtracted and penalties are added.</p>
<p dir="auto"><strong>Bonuses (subtracted):</strong></p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
<th>Points</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>findingArkBonus</code></td>
<td>Found the Ark</td>
<td>10</td>
</tr>
<tr>
<td><code>usingParachuteBonus</code></td>
<td>Used parachute</td>
<td>3</td>
</tr>
<tr>
<td><code>ankhUsedBonus</code></td>
<td>Used Ankh for Mesa skip</td>
<td>9</td>
</tr>
<tr>
<td><code>yarFoundBonus</code></td>
<td>Found Yar easter egg</td>
<td>5</td>
</tr>
<tr>
<td><code>mapRoomBonus</code></td>
<td>Used Head of Ra</td>
<td>14</td>
</tr>
<tr>
<td><code>mesaLandingBonus</code></td>
<td>Landed on mesa</td>
<td>3</td>
</tr>
<tr>
<td><code>livesLeft</code></td>
<td>Remaining lives</td>
<td>varies</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>Penalties (added):</strong></p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
<th>Points</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>grenadeOpeningPenalty</code></td>
<td>Blasted wall</td>
<td>2</td>
</tr>
<tr>
<td><code>escapePrisonPenalty</code></td>
<td>Escaped dungeon via secret exit</td>
<td>13</td>
</tr>
<tr>
<td><code>thiefShotPenalty</code></td>
<td>Shot the thief</td>
<td>4</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">The final value determines Indy&#39;s pedestal height in the Ark Room.</p>

<p dir="auto">Implemented in <code>playerHitInWellOfSouls</code>. All three conditions must be true:</p>
<ol dir="auto">
<li><code>indyPosY &gt;= $3F</code> — Indy is deep enough in the Well</li>
<li><code>diggingState == $54</code> — dirt fully cleared via shovel</li>
<li><code>secretArkMesaID == activeMesaID</code> — correct mesa (discovered via Map Room)</li>
</ol>
<p dir="auto">When all three are met, <code>arkRoomStateFlag</code> is set positive, triggering the endgame sequence in <code>arkPedestalKernel</code> which shows the Ark above Indy&#39;s pedestal.</p>

<div dir="auto"><h4 tabindex="-1" dir="auto">Grappling Hook (Mesa Field)</h4><a id="user-content-grappling-hook-mesa-field" aria-label="Permalink: Grappling Hook (Mesa Field)" href="#grappling-hook-mesa-field"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Calculated in <code>calculateMesaGrapple</code> — converts the hook&#39;s pixel position to a grid ID:</p>
<div data-snippet-clipboard-copy-content="RegionY = ((HookY - 6) + ScrollOffset) / 16
RegionX = (HookX - 16) / 32"><pre><code>RegionY = ((HookY - 6) + ScrollOffset) / 16
RegionX = (HookX - 16) / 32
</code></pre></div>

<p dir="auto">In <code>mapRoomHandler</code>, when Indy holds the Head of Ra and the sun (driven by <code>timeOfDay</code>) is at the correct position, a beam reveals the Ark&#39;s mesa using data from <code>mapRoomArkLocX</code> / <code>mapRoomArkLocY</code>.</p>

<p dir="auto"><code>timeOfDay</code> increments every ~63 frames (roughly once per second), driven in the VBLANK section. It controls the timepiece display, treasure room rotation, sun position, and Head of Ra timing.</p>

<p dir="auto">Handled in <code>handleMesaScroll</code> — the camera offset <code>roomObjectVar</code> shifts all object positions when Indy nears screen edges, bounded by <code>MESA_MAP_MAX_HEIGHT</code> (<code>$50</code>).</p>

<p dir="auto">Two channels with effect timers (<code>soundChan0Effect</code>, <code>soundChan1Effect</code>). The Raiders March plays from <code>raidersMarchFreqTable</code> when triggered with <code>RAIDERS_MARCH</code> (<code>$9C</code>). The flute melody uses <code>snakeCharmFreqTable</code> with <code>SNAKE_CHARM_SONG</code> (<code>$84</code>).</p>

<p dir="auto">Triggered via <code>HandleEasterEgg</code> — finding Yar on the Flying Saucer Mesa sets <code>yarFoundBonus</code>. When combined with a high enough score, Howard Scott Warshaw&#39;s initials (<code>devInitialsGfx0</code> / <code>devInitialsGfx1</code>) appear in the inventory strip at <code>checkShowDevInitials</code>.</p>

<ul dir="auto">
<li><strong>Right joystick</strong>: Movement + action button (use items/weapons)</li>
<li><strong>Left joystick</strong>: Inventory selection + drop button</li>
<li>Input is read from <code>SWCHA</code> (<code>$0280</code>) and <code>INPT5</code> (fire buttons)</li>
</ul>
</article></div></div>
  </body>
</html>
