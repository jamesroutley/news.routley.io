<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://two-wrongs.com/awk-state-machine-parser-pattern.html">Original</a>
    <h1>The Awk state machine parser pattern (2018)</h1>
    
    <div id="readability-page-1" class="page"><div>
                <p>
I run <a href="http://ganglia.sourceforge.net/">the Ganglia Monitoring System</a> on the home <abbr>lan</abbr> to keep an eye on
temperatures, loads, disk usages, network throughput and such on the gateway
and, more recently, my desktop workstation as well<sup><a id="fnr.1" href="#fn.1">1</a></sup><span><sup>1</sup> The primary reason is
that I have noticed some instability, and I would like to know if it’s related
to temperature.</span>. Since temperature is not reported by default, let’s say we
want to parse the output<sup><a id="fnr.2" href="#fn.2">2</a></sup><span><sup>2</sup> Using the default format, which is only loosely
structured. There is a <code>-u</code> flag that you should use to get machine friendly
output, but we’ll pretend that doesn’t exist for the purpose of this article.</span>
of <code>lm_sensors</code> and report it to the monitoring system by using the <code>gmetric</code>
command.
</p>

<p>
So this is what we have to extract relevant numbers from.
</p>

<pre>radeon-pci-0100
Adapter: PCI adapter
temp1:        +50.5°C  (crit = +120.0°C,
                        hyst = +90.0°C)

k10temp-pci-00c3
Adapter: PCI adapter
temp1:        +36.8°C  (high = +70.0°C)
                       (crit = +80.0°C,
                        hyst = +78.0°C)

f71889ed-isa-0480
Adapter: ISA adapter
+3.3V:        +3.23 V
in1:          +1.07 V  (max =  +2.04 V)
in2:          +1.09 V
in3:          +0.89 V
in4:          +0.58 V
in5:          +1.23 V
in6:          +1.53 V
3VSB:         +3.25 V
Vbat:         +3.31 V
fan1:        3978 RPM
fan2:           0 RPM  ALARM
fan3:           0 RPM  ALARM
temp1:        +31.0°C  (high = +85.0°C,
                        hyst = +81.0°C)
                       (crit = +80.0°C,
                        hyst = +76.0°C)
                        sensor = transistor
temp2:        +43.0°C  (high = +85.0°C,
                        hyst = +77.0°C)
                       (crit = +100.0°C,
                        hyst = +92.0°C)
                        sensor = thermistor
temp3:        +38.0°C  (high = +70.0°C,
                        hyst = +68.0°C)
                       (crit = +85.0°C,
                        hyst = +83.0°C)
                        sensor = transistor
</pre>

<p>
It’s divided into sections, but not in a way that <abbr>awk</abbr> understands right away.
As you have suspected from the title, the key is to realise that whenever you
encounter a section heading (or something else that indicates you’ve left the
previous section), you make a note of that in the program state. So in my
script, that is expressed as
</p>

<p><label>In[1]:</label></p><div>
<pre>


<span>BEGIN</span> {
    
    unit = <span>&#34;none&#34;</span>;
}

<span>/^radeon-pci-/</span> {
    
    unit = <span>&#34;GPU&#34;</span>;
}

<span>/^k10temp-pci-/</span> {
    
    unit = <span>&#34;CPU&#34;</span>;
}

<span>/^f71889ed-isa-/</span> {
    
    
    unit = <span>&#34;SYS&#34;</span>;
}

<span>/^temp[0-9]:/</span> {
    
    
    number = <span>substr</span>($1, 5, 1);

    
    <span>match</span>($2, <span>/+([0-9.]+)°C/</span>, matches);
    temp = <span>substr</span>(
        $2,
        matches[1, <span>&#34;start&#34;</span>],
        matches[1, <span>&#34;length&#34;</span>]
    );

    
    temps[unit <span>&#34;_&#34;</span> number] = temp;
}

<span>END</span> {
    
    <span>for</span> (temp <span>in</span> temps) {
        <span>system</span>(
            <span>&#34;gmetric -t uint16 -u Celsius&#34;</span>
            <span>&#34; -n &#34;</span> temp <span>&#34; -v &#34;</span> temps[temp]
        );
    }
}
</pre>
</div>

<p>
The general pattern, as you probably realise, is a bunch of small pattern-action
statements that look like<sup><a id="fnr.3" href="#fn.3">3</a></sup><span><sup>3</sup> Where text enclosed in angle brackets represent
metasyntactic variables, i.e. placeholders in this generic example.</span>
</p>

<p><label>In[2]:</label></p><div>
<pre><span>/〈regex for section header〉/</span> {
    〈state variable〉 = 〈section identifier〉
}
</pre>
</div>

<p>
and then one or more pattern-action statements that actually extract data that
look something like
</p>

<p><label>In[3]:</label></p><div>
<pre><span>/〈regex indicating data to parse/</span> {
    <span>switch</span> (〈state variable〉) {
    <span>case</span> 〈section A〉:
        〈action〉;
    <span>case</span> 〈section B〉:
        〈different action〉;
    }
}
</pre>
</div>

<p>
Once you’re fairly comfortable with <abbr>awk</abbr>, using it for these things is so
convenient that I highly recommend spending some time to get familiar with it.
It’s a tiny language that can be learnt in a day or so, but surprisingly useful.
</p>

            </div></div>
  </body>
</html>
