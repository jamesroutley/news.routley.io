<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.dbalan.in/blog/2024/03/25/boostrap-a-macos-machine-with-nix/index.html">Original</a>
    <h1>Bootstrapping a Mac with Nix</h1>
    
    <div id="readability-page-1" class="page"><section><article>
  
  

  <section><p>With <a href="https://github.com/LnL7/nix-darwin">nix-darwin</a> and
<a href="https://github.com/nix-community/home-manager">home-manager</a> it is possible to
manage almost all of a mac configuration declaratively. So when I got my new
Macbook I was pretty sure this is the way to go. Unfortunately, the bootstrap
is a bit involved. These are my notes from the process, which hopefully
serves as a tutorial.</p>
<h2 id="installing-dependencies">Installing dependencies</h2>
<p>We need to install some software manually before we can go full steam with
configurations stored as nix files, the primary one being <code>nix</code> itself.</p>
<p>Install nix with the <a href="https://install.determinate.systems/">determinate systems nix installer</a>, it comes with sensible defaults and a nicer uninstaller.</p>
<p>Unfortunately, the GUI installer installs <code>x86_64</code> version of nix, so I had to use <code>curl |sh</code> for my <code>aarch64</code> Macbook.</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span>curl</span> <span>--proto</span> <span>&#39;=https&#39;</span> <span>--tlsv1.2</span> <span>-sSf</span> <span>-L</span> https://install.determinate.systems/nix <span>|</span> <span>sh</span> <span>-s</span> <span>--</span> install</span></code></pre></div>
<p><img src="https://comsec.ethz.ch/images/nix-install.png"/></p>
<p>If you havenâ€™t already, also install <code>Xcode tools</code> with <code>xcode-select --install</code></p>
<h2 id="generating-initial-configurations">Generating initial configurations</h2>
<p>We are going to use <code>nix-darwin</code> to keep a system wide configuration, which
would represent packages that are installed, configuration for packages and
configuration like shell aliases, files etc.</p>
<p>nix-darwin has support for both classic <code>configuration.nix</code> tied to a nix-channel
as well as flakes, I chose the latter as it allows more finer control over dependency versions<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div id="cb2"><pre><code><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span>%</span> nix flake init <span>-t</span> nix-darwin</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span>wrote:</span> /Users/db/code/private/config/flake.nix</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span># replace the hostname</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span>%</span> sed <span>-i</span> <span>&#39;&#39;</span> <span>&#34;s/simple/</span><span>$(</span><span>scutil</span> <span>--get</span> LocalHostName<span>)</span><span>/&#34;</span> flake.nix</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span># Add to revision control</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span>git</span> init</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span>git</span> add flake.nix</span></code></pre></div>
<p>This generates an example flake file, with some boilerplate code to get started.</p>
<p>With some light editing:</p>
<ol type="1">
<li>Moved the configuration to its on own file <code>configuration.nix</code>, and added it to git tree<a href="#fn2" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</li>
<li>The appropriate <code>hostPlatform</code> for your mac. <code>nixpkgs.hostPlatform = &#34;aarch64-darwin&#34;;</code></li>
<li>Set the home directory path <code>users.users.dj.home = &#34;/Users/dj&#34;;</code></li>
</ol>
<p>We end up with</p>
<h3 id="flake.nix">flake.nix</h3>
<div id="cb3"><pre><code><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span>description</span> <span>=</span> <span>&#34;System flake configuration file&#34;</span><span>;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span>inputs</span> <span>=</span> <span>{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span>nixpkgs</span>.<span>url</span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span>nix-darwin</span>.<span>url</span> <span>=</span> <span>&#34;github:LnL7/nix-darwin&#34;</span><span>;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span>nix-darwin</span>.<span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span>outputs</span> <span>=</span> inputs@<span>{</span> <span>self</span><span>,</span> <span>nix-darwin</span><span>,</span> <span>nixpkgs</span> <span>}</span>: <span>{</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span># Build darwin flake using:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span># $ darwin-rebuild build --flake .#MacBook-Pro</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span>darwinConfigurations</span>.<span>&#34;</span>MacBook-Pro<span>&#34;</span> <span>=</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      nix<span>-</span>darwin.lib.darwinSystem <span>{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span>system</span> <span>=</span> <span>&#34;aarch64-darwin&#34;</span><span>;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span>modules</span> <span>=</span> <span>[</span> <span>./configuration.nix</span> <span>];</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      <span>};</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span># Expose the package set, including overlays, for convenience.</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span>darwinPackages</span> <span>=</span> self.darwinConfigurations.<span>&#34;MacBook-Pro&#34;</span>.pkgs<span>;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<h3 id="configuration.nix">configuration.nix</h3>
<div id="cb4"><pre><code><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span>{</span> <span>config</span><span>,</span> <span>lib</span><span>,</span> <span>pkgs</span><span>,</span> <span>...</span> <span>}</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span># List packages installed in system profile. To search by name, run:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span># $ nix-env -qaP | grep wget</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span>environment</span>.<span>systemPackages</span> <span>=</span> <span>with</span> pkgs<span>;</span> <span>[</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span>];</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span>users</span>.<span>users</span>.<span>dj</span>.<span>home</span> <span>=</span> <span>&#34;/Users/dj&#34;</span><span>;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span># Auto upgrade nix package and the daemon service.</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span>services</span>.<span>nix-daemon</span>.<span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span># nix.package = pkgs.nix;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span># Necessary for using flakes on this system.</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span>nix</span>.<span>settings</span>.<span>experimental-features</span> <span>=</span> <span>&#34;nix-command flakes&#34;</span><span>;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span># Create /etc/zshrc that loads the nix-darwin environment.</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span>programs</span>.<span>zsh</span>.<span>enable</span> <span>=</span> <span>true</span><span>;</span> <span># default shell on catalina</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span># programs.fish.enable = true;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span># Used for backwards compatibility, please read the changelog before changing.</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span># $ darwin-rebuild changelog</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span>system</span>.<span>stateVersion</span> <span>=</span> <span>3</span><span>;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span>nix</span>.<span>configureBuildUsers</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span># The platform the configuration will be used on.</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span>nixpkgs</span>.<span>hostPlatform</span> <span>=</span> <span>&#34;aarch64-darwin&#34;</span><span>;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Its time to bootstrap the system with <code>nix-darwin</code>!</p>
<div id="cb5"><pre><code><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span>%</span> nix run nix-darwin <span>--</span> switch <span>--flake</span> ~/.config/nix-darwin</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span>building</span> the system configuration...</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span>[1/38/42</span> built, 227 copied <span>(</span><span>1406.7/1407.6</span> MiB<span>)</span><span>,</span> 237.3 MiB DL] building darwin-uninstaller <span>(</span><span>fixupPhase</span><span>)</span><span>:</span> str</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span>Password:</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span>setting</span> up /run via /etc/synthetic.conf...</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span>user</span> defaults...</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span>setting</span> up user launchd services...</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span>setting</span> up /Applications/Nix Apps...</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span>setting</span> up pam...</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span>applying</span> patches...</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span>setting</span> up /etc...</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span>system</span> defaults...</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span>setting</span> up launchd services...</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span>creating</span> service org.nixos.activate-system</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span>reloading</span> service org.nixos.nix-daemon</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span>reloading</span> nix-daemon...</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span>waiting</span> for nix-daemon</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span>waiting</span> for nix-daemon</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span>configuring</span> networking...</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span>setting</span> nvram variables...</span></code></pre></div>
<p>During the bootstrap, <code>nix-darwin</code> installs the command <code>darwin-rebuild</code>, subsequent rebuilds should use <code>darwin-rebuild</code>.</p>
<p>Both <code>nix-darwin</code> and <code>darwin-rebuild</code> follows same semantics as <code>nixos-rebuild</code>, <code>test</code> for test activation, <code>build</code> for only building the configuration, <code>switch</code> for commit and activate etc.</p>
<h2 id="install-some-packages">Install some packages</h2>
<p>I have a set of packages that I like to have available system-wide (for all users). Add those to
<code>environment.systemPackages</code> in <code>configuration.nix</code>, which gives us:</p>
<div id="cb6"><pre><code><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span>{</span> <span>config</span><span>,</span> <span>lib</span><span>,</span> <span>pkgs</span><span>,</span> <span>...</span> <span>}</span>:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span># List packages installed in system profile. To search by name, run:</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span># $ nix-env -qaP | grep wget</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span>environment</span>.<span>systemPackages</span> <span>=</span> <span>with</span> pkgs<span>;</span> <span>[</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    vim</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    curl</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    gitAndTools.gitFull</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    mg</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    mosh</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span>];</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>Activate with <code>darwin-rebuild switch --flake ~/path-to-config-directory</code></p>
<h2 id="home-manager">Home Manager</h2>
<p><a href="https://github.com/nix-community/home-manager">home-manager</a> is a nix community project for managing user environments, it comes with a <a href="https://home-manager-options.extranix.com/">tone of module for configuring more day-to-day user facing programs</a>, for e.g the git module for configuring, well git.</p>
<div id="cb7"><pre><code><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>programs.git = <span>{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span>extraConfig</span> <span>=</span> <span>{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span>github</span>.<span>user</span> <span>=</span> <span>&#34;&lt;user&gt;&#34;</span><span>;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span>init</span> <span>=</span> <span>{</span> <span>defaultBranch</span> <span>=</span> <span>&#34;trunk&#34;</span><span>;</span> <span>};</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span>diff</span> <span>=</span> <span>{</span> <span>external</span> <span>=</span> <span>&#34;</span><span>${</span>pkgs.difftastic<span>}</span><span>/bin/difft&#34;</span><span>;</span> <span>};</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<p>Install <code>home-manager</code> with flakes,</p>
<ol type="1">
<li>Add a flake input in the inputs section</li>
</ol>
<div id="cb8"><pre><code><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>home<span>-</span>manager = <span>{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span>url</span> <span>=</span> <span>&#34;github:nix-community/home-manager&#34;</span><span>;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<ol start="2" type="1">
<li>And add the module to the <code>modules</code> section</li>
</ol>
<div id="cb9"><pre><code><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>home<span>-</span>manager.darwinModules.home<span>-</span>manager <span>{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span># `home-manager` config</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span>home-manager</span>.<span>useGlobalPkgs</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span>home-manager</span>.<span>useUserPackages</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span>home-manager</span>.<span>users</span>.<span>db</span> <span>=</span> <span>import</span> <span>./home.nix</span><span>;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<p>I choose to keep the home configuration in a separate file, <code>home.nix</code>.</p>
<div id="cb10"><pre><code><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span>{</span> <span>config</span><span>,</span> <span>lib</span><span>,</span> <span>pkgs</span><span>,</span> <span>...</span> <span>}</span>:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span>home</span>.<span>stateVersion</span> <span>=</span> <span>&#34;23.11&#34;</span><span>;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span>programs</span>.<span>git</span> <span>=</span> <span>{</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span>userName</span> <span>=</span> <span>&#34;name&#34;</span><span>;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span>userEmail</span> <span>=</span> <span>&#34;mail@example.org&#34;</span><span>;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span>extraConfig</span> <span>=</span> <span>{</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>      <span>github</span>.<span>user</span> <span>=</span> <span>&#34;&lt;user&gt;&#34;</span><span>;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      <span>init</span> <span>=</span> <span>{</span> <span>defaultBranch</span> <span>=</span> <span>&#34;trunk&#34;</span><span>;</span> <span>};</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span>diff</span> <span>=</span> <span>{</span> <span>external</span> <span>=</span> <span>&#34;</span><span>${</span>pkgs.difftastic<span>}</span><span>/bin/difft&#34;</span><span>;</span> <span>};</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>Also the updated <code>flake.nix</code> is now</p>
<div id="cb11"><pre><code><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span>description</span> <span>=</span> <span>&#34;System flake configuration file&#34;</span><span>;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span>inputs</span> <span>=</span> <span>{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span>nixpkgs</span>.<span>url</span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span>nixpkgs-unstable</span>.<span>url</span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span>nix-darwin</span>.<span>url</span> <span>=</span> <span>&#34;github:LnL7/nix-darwin&#34;</span><span>;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span>nix-darwin</span>.<span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span>home-manager</span> <span>=</span> <span>{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:nix-community/home-manager&#34;</span><span>;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span>outputs</span> <span>=</span> inputs@<span>{</span> <span>self</span><span>,</span> <span>nix-darwin</span><span>,</span> <span>nixpkgs</span><span>,</span> <span>home-manager</span><span>,</span> <span>nix-homebrew</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span>,</span> <span>homebrew-core</span><span>,</span> <span>homebrew-cask</span><span>,</span> <span>homebrew-bundle</span><span>,</span> <span>...</span> <span>}</span>:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span>{</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      <span># Build darwin flake using:</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>      <span># $ darwin-rebuild build --flake .#MacBook-Pro</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>      <span>darwinConfigurations</span>.<span>&#34;</span>MacBook-Pro<span>&#34;</span> <span>=</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        nix<span>-</span>darwin.lib.darwinSystem <span>{</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>          <span>system</span> <span>=</span> <span>&#34;aarch64-darwin&#34;</span><span>;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>          <span>modules</span> <span>=</span> <span>[</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            <span>./configuration.nix</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            home-manager.darwinModules.home-manager</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            <span>{</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>              <span># `home-manager` config</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>              <span>home-manager</span>.<span>useGlobalPkgs</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>              <span>home-manager</span>.<span>useUserPackages</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>              <span>home-manager</span>.<span>users</span>.<span>db</span> <span>=</span> <span>import</span> <span>./home.nix</span><span>;</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>          <span>];</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span>};</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>      <span># Expose the package set, including overlays, for convenience.</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>      <span>darwinPackages</span> <span>=</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        self.darwinConfigurations.<span>&#34;MacBook-Pro&#34;</span>.pkgs<span>;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>If you get an error <code>Error: HOME is set to &#34;/Users/&lt;username&gt;&#34; but we expect &#34;/var/empty&#34;</code>, make sure you have set <code>users.users.&lt;username&gt;.home</code> in configuration.nix.</p>
<h2 id="manage-homebrew-applications">Manage homebrew applications</h2>
<p>Sadly, nix still has some catching up to do with mac compatibility, biggest gripe for me was <a href="https://github.com/LnL7/nix-darwin/issues/214">accessing GUI apps with spotlight seems to need some workarounds</a>. Luckily brew solves this and we can just install applications with brew, still managed by nix.</p>
<p><code>nix-darwin</code> can declaratively manage brew packages, however we need <a href="https://github.com/zhaofengli/nix-homebrew">nix-homebrew</a> to install brew itself and manage the taps declaratively.</p>
<p>Grab nix-homebrew using flakes, and also add the taps itself as inputs, this maybe the most underrated flakes feature. We can pin the taps to a specific version!</p>
<div id="cb12"><pre><code><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>inputs = <span>{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span>nix-homebrew</span> <span>=</span> <span>{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:zhaofengli-wip/nix-homebrew&#34;</span><span>;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span>homebrew-core</span> <span>=</span> <span>{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:homebrew/homebrew-core&#34;</span><span>;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      <span>flake</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span>homebrew-cask</span> <span>=</span> <span>{</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:homebrew/homebrew-cask&#34;</span><span>;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      <span>flake</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span>homebrew-bundle</span> <span>=</span> <span>{</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:homebrew/homebrew-bundle&#34;</span><span>;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>      <span>flake</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span></code></pre></div>
<p>.. and import the module into the system configuration.</p>
<div id="cb13"><pre><code><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>nix<span>-</span>homebrew.darwinModules.nix<span>-</span>homebrew</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span>nix-homebrew</span> <span>=</span> <span>{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span># Apple Silicon Only: Also install Homebrew under the default Intel prefix for Rosetta 2</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span>enableRosetta</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span>user</span> <span>=</span> <span>&#34;username&#34;</span><span>;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span>taps</span> <span>=</span> <span>{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span>&#34;</span>homebrew/homebrew-core<span>&#34;</span> <span>=</span> homebrew<span>-</span>core<span>;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span>&#34;homebrew/homebrew-cask&#34;</span> <span>=</span> homebrew<span>-</span>cask<span>;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span>&#34;homebrew/homebrew-bundle&#34;</span> <span>=</span> homebrew<span>-</span>bundle<span>;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span>mutableTaps</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
<p>The package installations are itself managed by nix-darwin, using <code>homebrew.*</code> options.</p>
<div id="cb14"><pre><code><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>homebrew = <span>{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span>global</span>.<span>autoIpdate</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span>casks</span> <span>=</span> <span>[</span> <span>&#34;kitty&#34;</span> <span>];</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span>}</span>;</span></code></pre></div>
<h2 id="fin">Fin!</h2>
<p>If you have followed through all of the above, like me, you should have a mac with almost everything configured declaratively, using nix.</p>
<p>Further customizations options can be found in</p>
<ul>
<li><a href="https://daiderd.com/nix-darwin/manual/index.html">nix-darwin options search</a>, you could also use <code>man configuration.nix</code></li>
<li><a href="https://home-manager-options.extranix.com/">Home manager option search</a></li>
</ul>
<p>This setup helps me share configuration with my other machines; they are just an <code>import</code> away! However this bootstrapping is neither simple nor short, thatâ€™s definitly something to improve.</p>
<h2 id="final-configuration-files">Final configuration files</h2>
<details>
<summary>
flake.nix
</summary>
<div id="cb15"><pre><code><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span>description</span> <span>=</span> <span>&#34;System flake configuration file&#34;</span><span>;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span>inputs</span> <span>=</span> <span>{</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span>nixpkgs</span>.<span>url</span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span>nixpkgs-unstable</span>.<span>url</span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span>;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span>nix-darwin</span>.<span>url</span> <span>=</span> <span>&#34;github:LnL7/nix-darwin&#34;</span><span>;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span>nix-darwin</span>.<span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span>home-manager</span> <span>=</span> <span>{</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:nix-community/home-manager&#34;</span><span>;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span>inputs</span>.<span>nixpkgs</span>.<span>follows</span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span>nix-homebrew</span> <span>=</span> <span>{</span> <span>url</span> <span>=</span> <span>&#34;github:zhaofengli-wip/nix-homebrew&#34;</span><span>;</span> <span>};</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span>homebrew-core</span> <span>=</span> <span>{</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:homebrew/homebrew-core&#34;</span><span>;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>      <span>flake</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span>homebrew-cask</span> <span>=</span> <span>{</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:homebrew/homebrew-cask&#34;</span><span>;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>      <span>flake</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span>homebrew-bundle</span> <span>=</span> <span>{</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>      <span>url</span> <span>=</span> <span>&#34;github:homebrew/homebrew-bundle&#34;</span><span>;</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>      <span>flake</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span>outputs</span> <span>=</span> inputs@<span>{</span> <span>self</span><span>,</span> <span>nix-darwin</span><span>,</span> <span>nixpkgs</span><span>,</span> <span>home-manager</span><span>,</span> <span>nix-homebrew</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span>,</span> <span>homebrew-core</span><span>,</span> <span>homebrew-cask</span><span>,</span> <span>homebrew-bundle</span><span>,</span> <span>...</span> <span>}</span>: <span>{</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>      <span># Build darwin flake using:</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>      <span># $ darwin-rebuild build --flake .#MacBook-Pro</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>      <span>darwinConfigurations</span>.<span>&#34;</span>MacBook-Pro<span>&#34;</span> <span>=</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        nix<span>-</span>darwin.lib.darwinSystem <span>{</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>          <span>system</span> <span>=</span> <span>&#34;aarch64-darwin&#34;</span><span>;</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>          <span>modules</span> <span>=</span> <span>[</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>            <span>./configuration.nix</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>            home-manager.darwinModules.home-manager</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>            <span>{</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>              <span># `home-manager` config</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>              <span>home-manager</span>.<span>useGlobalPkgs</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>              <span>home-manager</span>.<span>useUserPackages</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>              <span>home-manager</span>.<span>users</span>.<span>db</span> <span>=</span> <span>import</span> <span>./home.nix</span><span>;</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            nix-homebrew.darwinModules.nix-homebrew</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            <span>{</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>              <span>nix-homebrew</span> <span>=</span> <span>{</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>                <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>                <span># Apple Silicon Only: Also install Homebrew under the default Intel prefix for Rosetta 2</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>                <span>enableRosetta</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>                <span>user</span> <span>=</span> <span>&#34;db&#34;</span><span>;</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>                <span>taps</span> <span>=</span> <span>{</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>                  <span>&#34;</span>homebrew/homebrew-core<span>&#34;</span> <span>=</span> homebrew<span>-</span>core<span>;</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>                  <span>&#34;homebrew/homebrew-cask&#34;</span> <span>=</span> homebrew<span>-</span>cask<span>;</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>                  <span>&#34;homebrew/homebrew-bundle&#34;</span> <span>=</span> homebrew<span>-</span>bundle<span>;</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>                <span>};</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>                <span>mutableTaps</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>              <span>};</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>            <span>}</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>          <span>];</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        <span>};</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>      <span># Expose the package set, including overlays, for convenience.</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>      <span>darwinPackages</span> <span>=</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>        self.darwinConfigurations.<span>&#34;MacBook-Pro&#34;</span>.pkgs<span>;</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
</details>
<details>
<summary>
configuration.nix
</summary>
<div id="cb16"><pre><code><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span>{</span> <span>config</span><span>,</span> <span>lib</span><span>,</span> <span>pkgs</span><span>,</span> <span>...</span> <span>}</span>:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span># List packages installed in system profile. To search by name, run:</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span># $ nix-env -qaP | grep wget</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span>environment</span>.<span>systemPackages</span> <span>=</span> <span>with</span> pkgs<span>;</span> <span>[</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    vim</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    curl</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    gitAndTools.gitFull</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    mg</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    mosh</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span>];</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span>homebrew</span> <span>=</span> <span>{</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span>global</span>.<span>autoUpdate</span> <span>=</span> <span>false</span><span>;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span>casks</span> <span>=</span> <span>[</span> <span>&#34;kitty&#34;</span> <span>];</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span>users</span>.<span>users</span>.<span>db</span>.<span>home</span> <span>=</span> <span>&#34;/Users/db&#34;</span><span>;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span># Auto upgrade nix package and the daemon service.</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span>services</span>.<span>nix-daemon</span>.<span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span># nix.package = pkgs.nix;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  <span># Necessary for using flakes on this system.</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span>nix</span>.<span>settings</span>.<span>experimental-features</span> <span>=</span> <span>&#34;nix-command flakes&#34;</span><span>;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span># Create /etc/zshrc that loads the nix-darwin environment.</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span>programs</span>.<span>zsh</span>.<span>enable</span> <span>=</span> <span>true</span><span>;</span> <span># default shell on catalina</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span># programs.fish.enable = true;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span># Used for backwards compatibility, please read the changelog before changing.</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span># $ darwin-rebuild changelog</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span>system</span>.<span>stateVersion</span> <span>=</span> <span>3</span><span>;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span>nix</span>.<span>configureBuildUsers</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span># The platform the configuration will be used on.</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span>nixpkgs</span>.<span>hostPlatform</span> <span>=</span> <span>&#34;aarch64-darwin&#34;</span><span>;</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
</details>
<details>
<summary>
home.nix
</summary>
<div id="cb17"><pre><code><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span>{</span> <span>config</span><span>,</span> <span>pkgs</span><span>,</span> <span>...</span> <span>}</span>:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span>{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span>home</span>.<span>stateVersion</span> <span>=</span> <span>&#34;23.11&#34;</span><span>;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span>programs</span>.<span>git</span> <span>=</span> <span>{</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span>enable</span> <span>=</span> <span>true</span><span>;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span>userName</span> <span>=</span> <span>&#34;user name&#34;</span><span>;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span>userEmail</span> <span>=</span> <span>&#34;email&#34;</span><span>;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span>extraConfig</span> <span>=</span> <span>{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>      <span>github</span>.<span>user</span> <span>=</span> <span>&#34;gh_user&#34;</span><span>;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>      <span>init</span> <span>=</span> <span>{</span> <span>defaultBranch</span> <span>=</span> <span>&#34;trunk&#34;</span><span>;</span> <span>};</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>      <span>diff</span> <span>=</span> <span>{</span> <span>external</span> <span>=</span> <span>&#34;</span><span>${</span>pkgs.difftastic<span>}</span><span>/bin/difft&#34;</span><span>;</span> <span>};</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span>};</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span>};</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span>}</span></span></code></pre></div>
</details>
</section>
</article>
</section></div>
  </body>
</html>
