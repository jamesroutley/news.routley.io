<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/below/HelloSilicon">Original</a>
    <h1>An Introduction to ARM64 Assembly on Apple Silicon Macs</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">An introduction to assembly on Apple silicon Macs.</p>

<p dir="auto">In this repository, I will code along with the book <a href="https://link.springer.com/book/10.1007/978-1-4842-5881-1?source=shoppingads&amp;locale=de&amp;cjsku=9781484258804" rel="nofollow">Programming with 64-Bit ARM Assembly Language</a>, adjusting all sample code for Apple&#39;s ARM64 line of computers. While Apple&#39;s marketing material seems to avoid a name for the platform and talks only about the M1 processor, the developer documentation uses the term &#34;Apple silicon&#34;. I will use this term in the following.</p>
<p dir="auto">The original source code can be found <a href="https://github.com/Apress/programming-with-64-bit-ARM-assembly-language">here</a>.</p>

<p dir="auto">While I pretty much assume that people who made it here meet most if not all required prerequisites, it doesn&#39;t hurt to list them.</p>
<ul dir="auto">
<li>
<p dir="auto">You need <a href="https://developer.apple.com/xcode/" rel="nofollow">Xcode 12.2</a> or later, and to make things easier, the command line tools should be installed. This ensures that the tools are found in default locations (namely <code>/usr/bin</code>). If you are not sure that the tools are installed, check <em>Preferences → Locations</em> in Xcode or run <code>xcode-select --install</code>.</p>
</li>
<li>
<p dir="auto">All application samples also require at least <a href="https://developer.apple.com/macos/" rel="nofollow">macOS Big Sur</a>, <a href="https://developer.apple.com/ios/" rel="nofollow">iOS 14</a> or their respective watchOS or tvOS equivalents. Especially for the later three systems it is not a necessity per-se (neither is Xcode 12.2), but it makes things a lot simpler.</p>
</li>
<li>
<p dir="auto">Finally, while all samples can be adjusted to work on the iPhone and all other of Apple&#39;s ARM64 devices, for best results you should have access to an <a href="https://www.apple.com/newsroom/2020/11/introducing-the-next-generation-of-mac/" rel="nofollow">Apple silicon Mac</a>.</p>
</li>
</ul>

<p dir="auto">I would like to thank <a href="https://github.com/claui">@claui</a>, <a href="https://github.com/jannau">@jannau</a>, <a href="https://github.com/jrosengarden">@jrosengarden</a>, <a href="https://github.com/m-schmidt">@m-schmidt</a>, <a href="https://github.com/saagarjha">@saagarjha</a>, and <a href="https://github.com/zhuoweir">@zhuowei</a>! They helped me when I hit a wall, or asked questions that let me improve the content.</p>

<p dir="auto">With the exception of the existing iOS samples, the book is based on the Linux operating system. Apple&#39;s operating systems (macOS, iOS, watchOS and tvOS) are actually just flavors of the <a href="https://en.wikipedia.org/wiki/Darwin_(operating_system)" rel="nofollow">Darwin</a> operating system, so they share a set of common core components.</p>
<p dir="auto">Linux and Darwin, which were both inspired by <a href="http://www.unix.org/what_is_unix/history_timeline.html" rel="nofollow">AT&amp;T Unix System V</a>, are significantly different at the level we are looking at. For the listings in the book, this mostly concerns system calls (i.e. when we want the Kernel to do someting for us), and the way Darwin accesses memory.</p>
<p dir="auto">This file is organized so that you can read the book, and read about the differences for Apple silicon side by side. The headlines in this document follow those in the book.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 1: Getting Started</h2><a id="user-content-chapter-1-getting-started" aria-label="Permalink: Chapter 1: Getting Started" href="#chapter-1-getting-started"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<p dir="auto">The default Calculator.app on macOS has a &#34;Programmer Mode&#34;, too. You enable it with <em>View → Programmer</em> (⌘3).</p>

<p dir="auto">Apple has made certain platform specific choices for the registers:</p>
<ul dir="auto">
<li>Apple reserves <strong>X18</strong> for its own use. Do not use this register.</li>
<li>The frame pointer register (<strong>FP</strong>, <strong>X29</strong>) must always address a valid frame record.</li>
</ul>

<p dir="auto">The book uses Linux GNU tools, such as the GNU <code>as</code> assembler. While there is an <code>as</code> command on macOS, it will invoke the integrated <a href="https://clang.llvm.org" rel="nofollow">LLVM Clang</a> assembler by default. And even if there is the <code>-Q</code> option to use the GNU based assembler, this was only ever an option for x86_64 — and is already deprecated as of this writing.</p>
<div data-snippet-clipboard-copy-content="% as -Q -arch arm64
/usr/bin/as: can&#39;t specifiy -Q with -arch arm64"><pre><code>% as -Q -arch arm64
/usr/bin/as: can&#39;t specifiy -Q with -arch arm64
</code></pre></div>
<p dir="auto">Thus, the GNU assembler syntax is not an option, and the code will have to be adjusted for the Clang assembler syntax.</p>
<p dir="auto">Likewise, while there is a <code>gcc</code> command on macOS, this simply calls the Clang C-compiler. For transparancy, all calls to <code>gcc</code> will be replaced with <code>clang</code>.</p>
<div data-snippet-clipboard-copy-content="% gcc --version
Configured with: --prefix=/Applications/Xcode-beta.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode-beta.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
Apple clang version 12.0.0 (clang-1200.0.32.27)
Target: arm64-apple-darwin20.1.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin"><pre><code>% gcc --version
Configured with: --prefix=/Applications/Xcode-beta.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode-beta.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
Apple clang version 12.0.0 (clang-1200.0.32.27)
Target: arm64-apple-darwin20.1.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin
</code></pre></div>

<p dir="auto">If you are reading this, I assume you already knew that the macOS Terminal can be found in <em>Applications → Utilities → Terminal.app</em>. But if you didn&#39;t I feel honored to tell you and I wish you lots of fun on this journey! Don&#39;t be afraid to ask questions.</p>
<p dir="auto">To make &#34;Hello World&#34; run on Apple silicon, first the changes from page 78 (Chapter 3) have to be applied to account for the differences between Darwin and the Linux kernel.
To silence the warning, I insert <code>.align 4</code> (or <code>.p2align 2</code>), because Darwin likes things to be aligned on even boundaries. The books mentions this in Aligning Data in Chapter 5, page 114.</p>
<p dir="auto">System calls in Linux and macOS have several differences due to the unique conventions of each system. Here are some key distinctions:</p>
<ul dir="auto">
<li>Function Number: The function numbers differ between the two systems, with Linux using 64 and macOS using 4. The table for Darwin (Apple) system calls can be found at this link: <a href="https://opensource.apple.com/source/xnu/xnu-7195.81.3/bsd/kern/syscalls.master.auto.html" rel="nofollow">Darwin System Calls</a>. Please note that this is a specific version (the most recent at the time of writing), and newer versions can be found <a href="https://opensource.apple.com/source/xnu/" rel="nofollow">here</a>.</li>
</ul>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p><p dir="auto">Darwin function numbers are considered private by Apple, and are subject to change. They are provided here for educational purposes only</p>
</div>
<ul dir="auto">
<li>Address for Storing Function Numbers: The address used for storing function numbers also varies. In Linux, it’s on X8, while in macOS, it’s on X16.</li>
<li>Interruption Call: The call for interruption is 0 in Linux, whereas it’s 0x80 on Apple Silicon.</li>
</ul>
<p dir="auto">To make the linker work, a little more is needed, most of it should look familiar to Mac/iOS developers. These changes need to be applied to the <code>makefile</code> and to the <code>build</code> file. The complete call to the linker looks like this:</p>
<div data-snippet-clipboard-copy-content="ld -o HelloWorld HelloWorld.o \
	-lSystem \
	-syslibroot `xcrun -sdk macosx --show-sdk-path` \
	-e _start \
	-arch arm64"><pre><code>ld -o HelloWorld HelloWorld.o \
	-lSystem \
	-syslibroot `xcrun -sdk macosx --show-sdk-path` \
	-e _start \
	-arch arm64
</code></pre></div>
<p dir="auto">We know the <code>-o</code> switch, let&#39;s examine the others:</p>
<ul dir="auto">
<li><code>-lSystem</code> tells the linker to link our executable with <code>libSystem.dylib</code>. We do that to add the <code>LC_MAIN</code> load command to the executable. Generally, Darwin does not support <a href="https://developer.apple.com/library/archive/qa/qa1118/_index.html" rel="nofollow">statically linked executables</a>. It is <a href="https://stackoverflow.com/questions/32453849/minimal-mach-o-64-binary/32659692#32659692" rel="nofollow">possible</a>, if not especially elegant to create executables without using <code>libSystem.dylib</code>. I will go deeper into that topic when time permits. For people who read <em>Mac OS X Internals</em> I will just add that this replaced <code>LC_UNIXTHREAD</code> as of MacOS X 10.7.</li>
<li><code>-sysroot</code>: In order to find <code>libSystem.dylib</code>, it is mandatory to tell our linker where to find it. It seems this was not necessary on macOS 10.15 because <em>&#34;New in macOS Big Sur 11 beta, the system ships with a built-in dynamic linker cache of all system-provided libraries. As part of this change, copies of dynamic libraries are no longer present on the filesystem.&#34;</em>. We use <code>xcrun -sdk macosx --show-sdk-path</code> to dynamically use the currently active version of Xcode.</li>
<li><code>-e _start</code>: Darwin expects an entrypoint <code>_main</code>. In order to keep the sample both as close as possible to the book, and to allow it&#39;s use within the C-Sample from <em>Chapter 3</em>, I opted to keep <code>_start</code> and tell the linker that this is the entry point we want to use</li>
<li><code>-arch arm64</code> for good measure, let&#39;s throw in the option to cross-compile this from an Intel Mac. You can leave this off when running on Apple silicon.</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto">Reverse Engineering Our Program</h3><a id="user-content-reverse-engineering-our-program" aria-label="Permalink: Reverse Engineering Our Program" href="#reverse-engineering-our-program"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">While the <code>objdump</code> command line program works just as well on Darwin and produces the expected output, also try the <code>--macho</code> (or <code>-m</code>) option, which causes objdump to use the Mach-O specific object file parser.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 2: Loading and Adding</h2><a id="user-content-chapter-2-loading-and-adding" aria-label="Permalink: Chapter 2: Loading and Adding" href="#chapter-2-loading-and-adding"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The changes from <a href="https://github.com/below/HelloSilicon#chapter-1">Chapter 1</a> (makefile, alignment, system calls) have to be applied.</p>

<p dir="auto">The gcc assembler accepts <code>MOV X1, X2, LSL #1</code>, which is not defined by the <a href="https://developer.arm.com/documentation/dui0801/g/A64-General-Instructions/MOV--register-?lang=en" rel="nofollow">ARM Compiler User Guide</a>, instead <code>LSL X1, X2, #1</code> (etc) is used. After all, both are just aliasses for the instruction <code>ORR X1, XZR, X2, LSL #1</code>.</p>

<p dir="auto">Clang requires the source register to be 32-bit. This makes sense because with these extensions, the upper 32 Bit of a 64-bit register will never be touched:</p>

<p dir="auto">The GNU Assembler seems to ignore this and allows you to specifiy a 64-bit source register.</p>


<p dir="auto">On macOS, <code>gdb</code> has been replaced with the <a href="https://lldb.llvm.org" rel="nofollow">LLDB Debugger</a> <code>lldb</code> of the LLVM project. The syntax is not always the same as for gdb, so I will note the differences here.</p>
<p dir="auto">To start debugging our <strong>movexamps</strong> program, enter the command</p>

<p dir="auto">This yields the abbreviated output:</p>
<div data-snippet-clipboard-copy-content="(lldb) target create &#34;movexamps&#34;
Current executable set to &#39;movexamps&#39; (arm64).
(lldb)"><pre><code>(lldb) target create &#34;movexamps&#34;
Current executable set to &#39;movexamps&#39; (arm64).
(lldb)
</code></pre></div>
<p dir="auto">Commands like <code>run</code> or <code>list</code> work just the same, and there is a nice <a href="https://lldb.llvm.org/use/map.html" rel="nofollow">GDB to LLDB command map</a>.</p>
<p dir="auto">To disassemble our program, a slightly different syntax is used for lldb:</p>

<p dir="auto">Note that because we are linking a dynamic executable, the listing will be long and include other <code>start</code> functions. Our code will be listed under the line <code>movexamps`start</code>.</p>
<p dir="auto">Likewise, lldb wants the breakpoint name without the underscore: <code>b start</code></p>
<p dir="auto">To get the registers on lldb, we use <strong>register read</strong> (or <strong>re r</strong>). Without arguments, this command will print all registers, or you can specify just the registers you would like to see, like <code>re r SP X0 X1</code>.</p>
<p dir="auto">We can see all the breakpoints with <strong>breakpoint list</strong> (or <strong>br l</strong>). We can delete a breakpoint with <strong>breakpoint delete</strong> (or <strong>br de</strong>) specifying the breakpoint number to delete.</p>
<p dir="auto"><strong>lldb</strong> has even more powerful mechanisms to display memory. The main command is <strong>memory read</strong> (or <strong>m read</strong>). For starters, these are the parameters used by the book:</p>
<div data-snippet-clipboard-copy-content="memory read -fx -c4 -s4 $address"><pre><code>memory read -fx -c4 -s4 $address
</code></pre></div>
<p dir="auto">where</p>
<ul dir="auto">
<li><strong>-f</strong> is the display format</li>
<li><strong>-s</strong> size of the data</li>
<li><strong>-c</strong> count</li>
</ul>

<p dir="auto">As an exercise, I have added code to find the default Xcode toolchain on macOS. In the book they are using this to later switch from a Linux to an Android toolchain. This process is much different for macOS and iOS: It does not usually involve a different toolchain, but instead a different Software Development Kit (SDK). You can see this in <a href="https://github.com/below/HelloSilicon#listing-1-1">Listing 1-1</a> where <code>-sysroot</code> is set.</p>
<p dir="auto">That said, while it is possible to build an iOS executable with the command line it is not a trivial process. So for building apps I will stick to Xcode.</p>

<p dir="auto">As <a href="https://github.com/below/HelloSilicon#chapter-10">Chapter 10</a> focusses on building an app that will run on iOS, I have chosen to simply create a Command Line Tool here which is now using the same <code>HelloWorld.s</code> file.</p>
<p dir="auto">Be aware that the function numbers are not only different, but on Darwin, they are considered private and subject to change.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 4: Controlling Program Flow</h2><a id="user-content-chapter-4-controlling-program-flow" aria-label="Permalink: Chapter 4: Controlling Program Flow" href="#chapter-4-controlling-program-flow"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Besides the common changes, we face a new issue which is described in the book in Chapter 5: Darwin does not like <code>LDR X1, =symbol</code>, it will produce the error <code>ld: Absolute addressing not allowed in arm64 code</code>. If we use <code>ASR X1, symbol</code>, as suggested in Chapter 3 of the book, our data has to be in the read-only <code>.text</code> section. In this sample however, we want writable data.</p>
<p dir="auto">The <a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/x86_64_code.html#//apple_ref/doc/uid/TP40005044-SW1" rel="nofollow">Apple Documentation</a> tells us that on Darwin:</p>
<blockquote>
<p dir="auto">All large or possibly nonlocal data is accessed indirectly through a global offset table (GOT) entry. The GOT entry is accessed directly using RIP-relative addressing.</p>
</blockquote>
<p dir="auto">And by default, on Darwin all data contained in the <code>.data</code> section, where data is writeable, is &#34;possibly nonlocal&#34;.</p>
<p dir="auto">The full answer can be found <a href="https://reverseengineering.stackexchange.com/a/15324" rel="nofollow">here</a>:</p>
<blockquote>
<p dir="auto">The <code>ADRP</code> instruction loads the address of the 4KB page anywhere in the +/-4GB (33 bits) range of the current instruction (which takes 21 high bits of the offset). This is denoted by the <code>@PAGE</code> operator. then, we can either use <code>LDR</code> or <code>STR</code> to read or write any address inside that page or <code>ADD</code> to to calculate the final address using the remaining 12 bits of the offset (denoted by <code>@PAGEOFF</code>).</p>
</blockquote>
<p dir="auto">So this:</p>
<div data-snippet-clipboard-copy-content="	LDR	X1, =outstr // address of output string"><pre><code>	LDR	X1, =outstr // address of output string
</code></pre></div>
<p dir="auto">becomes this:</p>
<div data-snippet-clipboard-copy-content="	ADRP	X1, outstr@PAGE	// address of output string 4k page
	ADD	X1, X1, outstr@PAGEOFF // offset to outstr within the page"><pre><code>	ADRP	X1, outstr@PAGE	// address of output string 4k page
	ADD	X1, X1, outstr@PAGEOFF // offset to outstr within the page
</code></pre></div>

<p dir="auto">I was asked how to read the command line, and I gladly <a href="https://github.com/below/HelloSilicon/issues/22#issuecomment-682205151" data-hovercard-type="issue" data-hovercard-url="/below/HelloSilicon/issues/22/hovercard">answered</a> the question.</p>
<p dir="auto">Sample code can be found in Chapter 4 in the file <a href="https://github.com/below/HelloSilicon/blob/main/Chapter%2004/case.s"><code>case.s</code></a>.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 5: Thanks for the Memories</h2><a id="user-content-chapter-5-thanks-for-the-memories" aria-label="Permalink: Chapter 5: Thanks for the Memories" href="#chapter-5-thanks-for-the-memories"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The important differences in memory addressing for Darwin were already addresed above.</p>

<p dir="auto">The <code>quad</code>, <code>octa</code> and <code>fill</code> keywords must be in lowercase for the llvm assembler. (See bottom of this file)</p>

<p dir="auto">Changes like in Chapter 4.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 6: Functions and the Stack</h2><a id="user-content-chapter-6-functions-and-the-stack" aria-label="Permalink: Chapter 6: Functions and the Stack" href="#chapter-6-functions-and-the-stack"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">As we learned in Chapter 5, all assembler directives (like <code>.equ</code>) must be in lowercase.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 7: Linux Operating System Services</h2><a id="user-content-chapter-7-linux-operating-system-services" aria-label="Permalink: Chapter 7: Linux Operating System Services" href="#chapter-7-linux-operating-system-services"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>asm/unistd.h</code> does not exist in the Apple SDKs, instead <code>sys/syscalls.h</code> can be used.</p>
<p dir="auto"><strong>Warning:</strong> Be aware that syscall numbers in Darwin are officially considered private and subject to change. They are presented here for educational purposes only.</p>
<p dir="auto">It is also important to notice that while the calls and definitions look similar, Linux and Darwin are not the same: <code>AT_FDCWD</code> is -100 on Linux, but must be -2 on Darwin.</p>
<p dir="auto">Unlike Linux, errors are signified by setting the carry flag, and the error codes are non-negative. We therefore <code>MOV</code> the result into the required register instead of <code>ADDS</code> (we don&#39;t need to check for negative numbers, and need to preserve the condition flags) and B.CC to the success path.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 8: Programming GPIO Pins</h2><a id="user-content-chapter-8-programming-gpio-pins" aria-label="Permalink: Chapter 8: Programming GPIO Pins" href="#chapter-8-programming-gpio-pins"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This chapter is specifically for the Raspberry Pi 4, so there is nothing to do here.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 9: Interacting with C and Python</h2><a id="user-content-chapter-9-interacting-with-c-and-python" aria-label="Permalink: Chapter 9: Interacting with C and Python" href="#chapter-9-interacting-with-c-and-python"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">For transparency reasons, I replaced <code>gcc</code> with <code>clang</code>.</p>

<p dir="auto">Apart from the usual changes, Apple diverges from the ARM64 standard ABI (i.e. the convention how functions are called) for variadic functions. Variadic functions are functions which take a variable number of arguments, and <code>printf</code> is one of them. Where Linux will accept arguments passed in the registers we must pass them on the stack for Darwin.</p>
<div data-snippet-clipboard-copy-content="str     X1, [SP, #-32]! // Move the stack pointer four doublewords (32 bytes) down and push X1 onto the stack
str     X2, [SP, #8]    // Push X2 to one doubleword above the current stack pointer
str     X3, [SP, #16]   // Push X3 to two doublewords above the current stack pointer
adrp    X0, ptfStr@PAGE // printf format str
add     X0, X0, ptfStr@PAGEOFF  // add offset for format str
bl      _printf // call printf
add     SP, SP, #32 // Clean up stack"><pre><code>str     X1, [SP, #-32]! // Move the stack pointer four doublewords (32 bytes) down and push X1 onto the stack
str     X2, [SP, #8]    // Push X2 to one doubleword above the current stack pointer
str     X3, [SP, #16]   // Push X3 to two doublewords above the current stack pointer
adrp    X0, ptfStr@PAGE // printf format str
add     X0, X0, ptfStr@PAGEOFF  // add offset for format str
bl      _printf // call printf
add     SP, SP, #32 // Clean up stack
</code></pre></div>
<p dir="auto">So first, we are growing the stack downwards 32 bytes to make room for three 64-bit values. We are creating space for a fourth value for padding because, as pointed out on page 137 in the book, ARM hardware requires the stack pointer to always be 16-byte aligned.</p>
<p dir="auto">In the same command, <strong>X1</strong> is stored at the new location of the stack pointer.</p>
<p dir="auto">Now, we fill the rest of the space that was just created by storing <strong>X2</strong> in a location eight bytes above, and <strong>X3</strong> 16 bytes above the stack pointer. Note that the <strong>str</strong> commands for <strong>X2</strong> and <strong>X3</strong> do not move <strong>SP</strong>.</p>
<p dir="auto">We could fill the stack in different ways; what is important that the <code>printf</code> function expects the parameters as doubleword values in order, upwards from the current stackpointer. So in the case of the <code>debug.s</code> file, it expects the parameter for the <code>%c</code> to be at the location of <strong>SP</strong>, the parameter for <code>%32ld</code> at one doubleword above this, and finally the parameter for <code>%016lx</code> two doublewords, 16 bytes, above the current stack pointer.</p>
<p dir="auto">What we have effectively done is <a href="https://en.wikipedia.org/wiki/Stack-based_memory_allocation" rel="nofollow">allocating memory on the stack</a>. As we, the caller, &#34;own&#34; that memory we need to release it after the function branch, in this case simply by shrinking the stack (upwards) by the 32 bytes we allocated. The instruction <code>add SP, SP, #32</code> will do that.</p>

<p dir="auto"><code>mytoupper</code> was prefixed with <code>_</code> as this is necessary for C on Darwin to find it.</p>

<p dir="auto">No change was required.</p>

<p dir="auto">Instead of a shared <code>.so</code> ELF library, a dynamic Mach-O libary is created. Further information can be found here: <a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/CreatingDynamicLibraries.html" rel="nofollow">Creating Dynamic Libraries</a></p>

<p dir="auto">In inline-assembly, which we are using here, The <code>cont</code> label must be declared as a local label by prefixing it with <code>L</code>. While this was not necessary in pure assembly, like in Chapter 5, the llvm C-Frontend will automatically add the directive <a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/040-Assembler_Directives/asm_directives.html#//apple_ref/doc/uid/TP30000823-SW13" rel="nofollow"><code>.subsections_via_symbols</code></a> to the code:</p>
<blockquote>
<p dir="auto">Funny Darwin hack: This flag tells the linker that no global symbols contain code that falls through to other global symbols (e.g. the obvious implementation of multiple entry points).  If this doesn&#39;t occur, the linker can safely perform dead code stripping. Since LLVM never generates code that does this, it is always safe to set.
(From <a href="https://github.com/llvm/llvm-project/blob/89b57061f7b769e9ea9bf6ed686e284f3e55affe/llvm/lib/Target/AArch64/AArch64AsmPrinter.cpp#L568">llvm source code</a>)</p>
</blockquote>
<p dir="auto">While we are using the LLVM toolchain, in assembly — including inline-assembly — all safety checks are off so we must take extra precautions and specifically declare the forward label local.</p>
<p dir="auto">Also, the size of one variable had to be changed from int to long to make the compiler complete happy and remove all warnings</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Calling Assembly from Python</h3><a id="user-content-calling-assembly-from-python" aria-label="Permalink: Calling Assembly from Python" href="#calling-assembly-from-python"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<p dir="auto">While the <code>uppertst5.py</code> file only needed a minimal change, calling the code is a little more challenging. On Apple silicon Macs, Python is a Mach-O universal binary with two architectures, x86_64 and arm64e:</p>
<div data-snippet-clipboard-copy-content="% lipo -info /usr/bin/python3 
Architectures in the fat file: /usr/bin/python3 are: x86_64 arm64e"><pre><code>% lipo -info /usr/bin/python3 
Architectures in the fat file: /usr/bin/python3 are: x86_64 arm64e
</code></pre></div>
<p dir="auto">Notably absent is the arm64 architecture we were building for up to this point. This makes our dylib unusable with Python.</p>
<p dir="auto">arm64e is the <a href="https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/armv8-a-architecture-2016-additions" rel="nofollow">Armv-8 architecture</a>, which Apple is using since the A12 chip. If you want to address devices prior to the A12, you must stick to arm64. The first Macs to use ARM64 run on the M1 CPU based on the A14 architecture, thus Apple decided to take advangage of the new features.</p>
<p dir="auto">So, what to do? We could compile everything as arm64e, but that would make the library useless on devices like the iPhone X or older, and we would like to support them, too.</p>
<p dir="auto">Above, you read something about a <em>universal binary</em>. For a very long time, the Mach-O executable format was supporting several processor architectures in a single file. This includes, but is not limited to, Motorola 68k (on NeXT computers), PowerPC, Intel x86, as well ARM code, each with their 32 and 64 bit variantes where applicable. In this case, I am building a universal dynamic library which includes both arm64 and arm64e code. More information can be found <a href="https://developer.apple.com/documentation/xcode/building_a_universal_macos_binary" rel="nofollow">here</a>.</p>
<p dir="auto">While most of the Python IDEs that work for Linux are also avilable for macOS, as of this writing, the only Python IDEs which itself runs as arm64 — and thus will load arm64 libraries — is Python.org <a href="https://www.python.org/downloads/macos/" rel="nofollow">IDLE</a>, version 3.10 or newer.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/below/HelloSilicon/blob/main/images/Figure_9-1.png?raw=true"><img src="https://github.com/below/HelloSilicon/raw/main/images/Figure_9-1.png?raw=true" alt="Figure 9-1. . Our Python program running in the IDLE IDE" title="Our Python program running in the IDLE IDE"/></a></p>
<p dir="auto"><em><strong>Figure 9-1.</strong></em> <em>Our Python program running in the IDLE IDE</em></p>
<p dir="auto">Alternatively, you can use the command line to test the program. (As of macOS 12.3, Apple <a href="https://developer.apple.com/documentation/macos-release-notes/macos-12_3-release-notes" rel="nofollow">removed Python 2</a> and developers should use Python 3)</p>
<div data-snippet-clipboard-copy-content="% python3 uppertst5.py 
b&#39;This is a test!&#39;
b&#39;THIS IS A TEST!&#39;
16"><pre><code>% python3 uppertst5.py 
b&#39;This is a test!&#39;
b&#39;THIS IS A TEST!&#39;
16
</code></pre></div>
<p dir="auto">A final note: While the Apple python3 binary is arm64e, the Python Framework used by IDLE is arm64. The fact that the library built in this chapter is a universal binary containing both architectures allows it to be used in either environment.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 10: Interfacing with Kotlin and Swift</h2><a id="user-content-chapter-10-interfacing-with-kotlin-and-swift" aria-label="Permalink: Chapter 10: Interfacing with Kotlin and Swift" href="#chapter-10-interfacing-with-kotlin-and-swift"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">No changes in the core code were required, but instead of just an iOS app I created a SwiftUI app that will work on macOS, iOS, watchOS (Series 4 and later), and tvOS.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 11: Multiply, Divide, and Accumulate</h2><a id="user-content-chapter-11-multiply-divide-and-accumulate" aria-label="Permalink: Chapter 11: Multiply, Divide, and Accumulate" href="#chapter-11-multiply-divide-and-accumulate"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">At this point, the changes should be self-explainatory. The usual makefile adjustments, <code>.align 4</code>, address mode changes, and <code>_printf</code> adjustments.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 12: Floating-Point Operations</h2><a id="user-content-chapter-12-floating-point-operations" aria-label="Permalink: Chapter 12: Floating-Point Operations" href="#chapter-12-floating-point-operations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Like in Chapter 11, all the chages have been introduced already. Nothing new here.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 13: Neon Coprocessor</h2><a id="user-content-chapter-13-neon-coprocessor" aria-label="Permalink: Chapter 13: Neon Coprocessor" href="#chapter-13-neon-coprocessor"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Once again, the Clang assembler wants a slightly different syntax: Where gcc accepts</p>
<div data-snippet-clipboard-copy-content="MUL V6.4H, V0.4H, V3.4H[0]"><pre><code>MUL V6.4H, V0.4H, V3.4H[0]
</code></pre></div>
<p dir="auto">the Clang assembler expects</p>

<p dir="auto">All other changes to the code should be trivial at this point.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 14: Optimizing Code</h2><a id="user-content-chapter-14-optimizing-code" aria-label="Permalink: Chapter 14: Optimizing Code" href="#chapter-14-optimizing-code"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">No unusal changes here.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Chapter 15: Reading and Understanding Code</h2><a id="user-content-chapter-15-reading-and-understanding-code" aria-label="Permalink: Chapter 15: Reading and Understanding Code" href="#chapter-15-reading-and-understanding-code"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<p dir="auto">Some place to start reading ARM64 code in the Darwin Kernel can be found in <a href="https://github.com/apple/darwin-xnu/blob/master/osfmk/arm64/bcopy.s">bcopy.s</a>. There is a lot more in that directory and the repository in general.</p>

<p dir="auto">No changes were required. The &#34;tiny&#34; code model is not supported for Mach-O excecutables:</p>
<div data-snippet-clipboard-copy-content="% clang -O3 -mcmodel=tiny -o upper upper.c
fatal error: error in backend: tiny code model is only supported on ELF"><pre><code>% clang -O3 -mcmodel=tiny -o upper upper.c
fatal error: error in backend: tiny code model is only supported on ELF
</code></pre></div>

<p dir="auto">All that can be said is that clang automatically enables position-independent executables, and the option <code>-no-pie</code> does not work. Therefore, the exploit shown in the <code>upper.s</code> file can not be reproduced.</p>

<ul dir="auto">
<li><a href="https://developer.apple.com/documentation/xcode/writing_arm64_code_for_apple_platforms" rel="nofollow">Writing ARM64 Code for Apple Platforms</a>, documentation how Apple platforms diverge from the standard 64-bit ARM architecture</li>
<li><a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/0-Introduction/introduction.html#//apple_ref/doc/uid/TP40001827-SW1" rel="nofollow">Mach-O Programming Topics</a>, an excellent introduction to the Mach-O executable format and how it differs from ELF. Even if it still refrences PowerPC 64-bit architecture and says nothing about ARM, most of it is still true.</li>
<li><a href="https://stackoverflow.com/a/42399119/1600891" rel="nofollow">What is required for a Mach-O executable to load?</a></li>
<li><a href="https://www.pearson.ch/Informatik/Macintosh/EAN/9780134426549/Mac-OS-X-Internals" rel="nofollow">Mac OS X Internals, A Systems Approach</a> Amit Singh, 2007. For better or worse, this is still the definite compendium on the core of macOS and it&#39;s siblings.</li>
<li><a href="https://developer.apple.com/videos/play/wwdc2020/10686/" rel="nofollow">WWDC20: Explore the new system architecture of Apple silicon Macs</a> A system overview of the new Apple silicon machines</li>
<li><a href="https://opensource.apple.com/source/xnu/" rel="nofollow">Darwin Source Code</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0487/latest/" rel="nofollow">ARM Architecture Reference Manual</a></li>
</ul>

<p dir="auto"><em>&#34;The C language is case-sensitive. Compilers are case-sensitive. The Unix command line, ufs, and nfs file systems are case-sensitive. I&#39;m case-sensitive too, especially about product names. The IDE is called Xcode. Big X, little c. Not XCode or xCode or X-Code. Remember that now.&#34;</em> — Chris Espinosa</p>
</article></div></div>
  </body>
</html>
