<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://punchagan.muse-amuse.in/blog/elfeed-index-0-bytes/">Original</a>
    <h1>Why my Elfeed index was 0 bytes</h1>
    
    <div id="readability-page-1" class="page"><div>
  <section>
    <p>Why my Elfeed index was 0 bytes</p>
    <p>
      <time>30 Jan 2026</time> 
      
       | 
      
      
      <span> <a href="https://punchagan.muse-amuse.in/tags/emacs">emacs</a> <a href="https://punchagan.muse-amuse.in/tags/blag">blag</a> <a href="https://punchagan.muse-amuse.in/tags/elfeed">elfeed</a> <a href="https://punchagan.muse-amuse.in/tags/programming">programming</a>  </span>
      
    </p>
    <div><p>My Linux machine crashed, while I was in the middle of a video call. I
restarted quickly, and continued the discussion. Later, when I was trying to
sync <a href="https://github.com/skeeto/elfeed">Elfeed</a> updates onto the <a href="https://github.com/punchagan/elfeed-offline/">Elfeed Offline</a> app on my phone, I found it acting
weird. All the <a href="https://punchagan.muse-amuse.in/blog/offline-friendly-elfeed-web-ui/">bazillion things</a> needed to get it working were in place, but it
was still complaining about the Emacs Elfeed server not being accessible. I
tried opening Elfeed inside Emacs and failed! The index file in <a href="https://punchagan.muse-amuse.in/blog/elfeed-db-back-up-hooks/">Elfeed’s DB was
empty</a>! Gone! Poof!</p>
<p>Frustrating, but I didn’t have time to look into what happened. I would’ve been
furious if I had been using Elfeed for longer and had a lot more metadata
saved. But, it was only a few weeks of lost metadata - posts I read, starred,
etc. I quickly setup a <a href="https://punchagan.muse-amuse.in/blog/elfeed-db-back-up-hooks/">Git based backup</a> to prevent future losses and moved on.</p>
<p>Later, I found time to dig into what might have happened…</p>

<p>Elfeed stores all the metadata for all the posts in an <code>index</code> file with a
<a href="https://en.wikipedia.org/wiki/Content-addressable_storage">content addressed store</a> of the contents of each of the posts. The index file is
simply a dump of the hash-table containing the metadata for the subscribed
feeds, their entries and metadata like tags, read/unread status, etc.</p>
<p>The DB save happens in <a href="https://github.com/skeeto/elfeed/blob/a39fb78e34ee25dc8baea83376f929d7c128344f/elfeed-db.el#L271"><code>elfeed-db-save</code></a>, which simply dumps the hash-table to
disk inside a call to the <code>with-temp-file</code> macro.</p>
<div><pre tabindex="0"><code data-lang="emacs-lisp"><span><span><span>(</span><span>defun</span> <span>elfeed-db-save</span> <span>()</span>
</span></span><span><span>  <span>; &lt;snip&gt;</span>
</span></span><span><span>  <span>(</span><span>with-temp-file</span> <span>(</span><span>expand-file-name</span> <span>&#34;index&#34;</span> <span>elfeed-db-directory</span><span>)</span>
</span></span><span><span>    <span>; ...</span>
</span></span><span><span>    <span>(</span><span>princ</span> <span>(</span><span>format</span> <span>&#34;;;; Elfeed Database Index (version %s)\n\n&#34;</span>
</span></span><span><span>                       <span>elfeed-db-version</span><span>))</span>
</span></span><span><span>    <span>; ...</span>
</span></span><span><span>    <span>(</span><span>prin1</span> <span>elfeed-db</span><span>)</span>
</span></span><span><span>    <span>;...</span>
</span></span><span><span>    <span>))</span>
</span></span></code></pre></div><p><code>with-temp-file</code>, as its documentation says, lets you create a new buffer,
evaluate the <code>body</code> there, and write the buffer to <code>file</code>. For a moment, I
thought there was some temporary file involved, but nope! I guess the name
comes as an extension from <code>with-temp-buffer</code> which does create a temporary
buffer where the <code>body</code> of the macro gets evaluated. Stripped to its core, <a href="https://github.com/emacs-mirror/emacs/blob/3b547e4f5dc99dc157b52a059cf234f7a5d15112/lisp/subr.el#L5300-L5318">this
function</a> is:</p>
<div><pre tabindex="0"><code data-lang="emacs-lisp"><span><span><span>`</span><span>(</span><span>let</span> <span>((</span><span>,</span><span>temp-file</span> <span>,</span><span>file</span><span>)</span>
</span></span><span><span>       <span>(</span><span>,</span><span>temp-buffer</span> <span>(</span><span>generate-new-buffer</span> <span>&#34; *temp file*&#34;</span> <span>t</span><span>)))</span>
</span></span><span><span>   <span>(</span><span>prog1</span>
</span></span><span><span>       <span>(</span><span>with-current-buffer</span> <span>,</span><span>temp-buffer</span>
</span></span><span><span>         <span>,@</span><span>body</span><span>)</span>
</span></span><span><span>     <span>(</span><span>with-current-buffer</span> <span>,</span><span>temp-buffer</span>
</span></span><span><span>       <span>(</span><span>write-region</span> <span>nil</span> <span>nil</span> <span>,</span><span>temp-file</span> <span>nil</span> <span>0</span><span>))))</span>
</span></span></code></pre></div><h2 id="write-region-and-o-trunc"><code>write-region</code> and <code>O_TRUNC</code></h2>
<p>So, <a href="https://github.com/emacs-mirror/emacs/blob/3b547e4f5dc99dc157b52a059cf234f7a5d15112/src/fileio.c#L5512"><code>write-region</code> is the workhorse</a> which writes the contents of the temporary
buffer to disk. It’s a roughly 300 line long C function that essentially opens
the file with the flags <code>O_WRONLY | O_CREAT | O_TRUNC</code> (in this case) and then
does something to write the contents to the file, etc. Honestly, I didn’t look
at anything else too carefully after I spotted the <code>O_TRUNC</code>.</p>
<p>The man page of <code>open</code> explains <code>O_TRUNC</code> as follows:</p>
<blockquote>
<p>O_TRUNC :: If the file already exists and is a regular file and the access mode
allows writing (i.e., is O_RDWR or O_WRONLY) it will be truncated to
length 0.</p>
</blockquote>
<p>Voilà!</p>
<p>The write is not atomic. The file first gets truncated to length 0, and then we
hope that the new contents get correctly written before something goes wrong.</p>
<p>It now makes sense why the file got truncated to 0 bytes. The crash happened
after the <code>open</code>, but before the write. Somehow the crash happened in this
short window, and poof!</p>
<h2 id="emacs-has-backup-files-doesn-t-it">Emacs has backup files, doesn’t it?</h2>
<p>Temporary files with <code>~</code> in their file extensions have definitely annoyed me in
the past when Emacs created them where I didn’t want them. So, I do know that
Emacs has back-up mechanisms out of the box. But, it turns out that the backups
occur in code paths that are more interactive, like <code>save-buffer</code>,
<code>write-file</code>, etc. And not via the programmatic APIs like <code>write-region</code> or the
higher level <code>with-temp-file</code>. <code>save-buffer</code> calls <code>backup-buffer</code> before
writing, but <code>write-region</code> is much more low-level and doesn’t deal with
backups.</p>
<h2 id="the-fix">The fix</h2>
<p>My “fix” for this is to backup the Elfeed data in a git repository to be able
to recover from any such corruptions of data, which I already wrote about <a href="https://punchagan.muse-amuse.in/blog/elfeed-db-back-up-hooks/">here</a>.</p>
<p>I know that any code that uses <code>with-temp-file</code> (or <code>write-region</code>) could be
affected by this, and the right fix for this may be to write to a temporary
file and rename it. Maybe next time I lose data I’ll actually fix it properly.</p>
</div>
  </section>

  <section>
    <p>
  Feel free to send me an <a href="mailto:punchagan+blog@muse-amuse.in">email</a> with your
  comments.
</p>

    




  </section>
</div></div>
  </body>
</html>
