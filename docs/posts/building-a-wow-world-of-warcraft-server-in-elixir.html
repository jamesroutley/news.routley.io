<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pikdum.dev/posts/thistle-tea/">Original</a>
    <h1>Building a WoW (World of Warcraft) Server in Elixir</h1>
    
    <div id="readability-page-1" class="page"><div>
    
  

  
  
  <i><time datetime="2024-07-14T00:00:00+00:00">July 14, 2024</time></i>

  <p><a href="https://github.com/pikdum/thistle_tea">Thistle Tea</a> is my new World of Warcraft private server project.
You can log in, create a character, run around, and cast spells to kill mobs, with everything synchronized between players as expected for an MMO.
It was floating around in my head to build this for a while, since I have an incurable nostalgia for early WoW.
I first mentioned this on May 13th and didn’t expect to get any further than login, character creation, and spawning into the map.
Here’s a recount of the first month of development.</p>
<h2 id="prep-work">Prep Work</h2>
<p>Before coding, I did some research and came up a plan.</p>
<ul>
<li>Code this in Elixir, using the actor model.</li>
<li><a href="https://github.com/mangoszero/database">MaNGOS</a> has done the hard work on collecting all the data, so use it.</li>
<li>Use <a href="https://github.com/mtrudel/thousand_island">Thousand Island</a> as the socket server.</li>
<li>Treat this project as an excuse to learn more Elixir.</li>
<li>Reference existing projects and documentation rather than working from scratch.</li>
<li>Speed along the happy path rather than try and handle every error.</li>
</ul>
<h2 id="day-1---june-2nd">Day 1 - June 2nd</h2>
<p>There are two main parts to a World of Warcraft server: the authentication server and the game server.
Up first was authentication, since you can’t do anything without logging in.</p>
<p>To learn more about the requests and responses, I built a quick MITM proxy between the client and a MaNGOS server to log all packets.
It wasn’t as useful as expected, since not much was consistent, but it did help me internalize how the requests and responses worked.</p>
<p>The first byte of an authentication packet is the opcode, which indicates which message it is, and the rest is a payload with the relevant data.
I was able to extract the fields from the payload by pattern matching on the binary data.</p>
<p>The auth flow can be simplified as:</p>
<ul>
<li>Client sends a <strong>CMD_AUTH_LOGON_CHALLENGE</strong> packet</li>
<li>Server sends back some data for the client to use in crypto calculations</li>
<li>Client sends a <strong>CMD_AUTH_LOGON_PROOF</strong> packet with the client proof</li>
<li>If the client proof matches what’s expected, server sends over the server_proof</li>
<li>Client is now authenticated</li>
</ul>
<p>It uses SRP6, which I hadn’t heard of before this.
Seems like the idea is to avoid transmitting an unencrypted password and instead both the client and server independently calculate a proof that only matches if they both know the correct password.
If the proof matches, then authentication is successful.</p>
<p>So basically, what I needed to do was:</p>
<ul>
<li>Listen for data over the socket</li>
<li>Once data received, parse what message it is out of the header section</li>
<li>Handle each one differently</li>
<li>Send back the appropriate packet</li>
</ul>
<p>This whole part is well documented, but I still ran into some issues with the cryptography.
Luckily, I found a blog post and an accompanying Elixir implementation, so I was able to substitute my broken cryptography with working cryptography.
Without that, I would’ve been stuck at this part for a very long time (maybe forever).
Wasn’t able to get login working on day 1, but I was close.</p>
<p>Links:</p>
<ul>
<li><a href="https://wowdev.wiki/Login">https://wowdev.wiki/Login</a></li>
<li><a href="http://srp.stanford.edu/design.html">http://srp.stanford.edu/design.html</a></li>
<li><a href="https://shadowburn-project.org/2018/10/17/logging-in-with-vanilla.html">https://shadowburn-project.org/2018/10/17/logging-in-with-vanilla.html</a></li>
<li><a href="https://gitlab.com/shadowburn/shadowburn">https://gitlab.com/shadowburn/shadowburn</a></li>
<li><a href="https://hexdocs.pm/elixir/main/binaries-strings-and-charlists.html">https://hexdocs.pm/elixir/main/binaries-strings-and-charlists.html</a></li>
</ul>
<h2 id="day-2---june-3rd">Day 2 - June 3rd</h2>
<p>I spent some time cleaning up the code and found a logic error where I reversed some crypto bytes that weren’t supposed to be.
Fixing that made auth work, finally getting a success with hardcoded credentials.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240603_21h10m37s_grim.avif" alt=""/></p>
<p>Next up was getting the realm list to work, by handling <strong>CMD_REALM_LIST</strong> and returning which game server to connect to.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240603_21h26m33s_grim.avif" alt=""/></p>
<p>This got me out of the tedious auth bits and I could get to building the game server.</p>
<p>Links:</p>
<ul>
<li><a href="https://wowdev.wiki/CMD_REALM_LIST_Client">https://wowdev.wiki/CMD_REALM_LIST_Client</a></li>
<li><a href="https://wowdev.wiki/CMD_REALM_LIST_Server">https://wowdev.wiki/CMD_REALM_LIST_Server</a></li>
</ul>
<h2 id="day-3---june-4th">Day 3 - June 4th</h2>
<p>The goal for today was to get spawned into the world.
But first more tedious auth bits.</p>
<p>The game server auth flow can be simplified as:</p>
<ul>
<li>When client first connects, server sends <strong>SMSG_AUTH_CHALLENGE</strong>, with a random seed</li>
<li>Client sends back <strong>CMSG_AUTH_SESSION</strong>, with another client proof</li>
<li>If client proof matches server proof, server sends a successful <strong>SMSG_AUTH_RESPONSE</strong></li>
</ul>
<p>This negotaties how to encrypt/decrypt future packet headers.
Luckily Shadowburn also had crypto code for this, so I was able to use it here.
The server proof requires a value previously calculated by the authentication server, so I used an Agent to store that session value.
It worked, but I later refactored it to use ETS for a simpler interface.</p>
<p>After that, it’s something like:</p>
<ul>
<li>Client sends message to server</li>
<li>Server decrypts header, which contains message size (2 bytes) and opcode (4 bytes)</li>
<li>Server handles message and sends back 0 or more messages to client</li>
</ul>
<p>First was handling <strong>CMSG_CHAR_CREATE</strong> and <strong>CMSG_CHAR_ENUM</strong>, so I could create and list characters.
I originally used an Agent for storage here as well, which made things quick to prototype.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240604_16h06m17s_grim.avif" alt=""/></p>
<p>Then I got side-tracked for a bit trying to get equipment to show up, since I had all the equipment display ids hardcoded to 0.
I looked through the MaNGOS database and hardcoded a few proper display ids before moving on.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240604_19h02m30s_grim.avif" alt=""/></p>
<p>After that was handling <strong>CMSG_PLAYER_LOGIN</strong>.
I found an example minimal <strong>SMSG_UPDATE_OBJECT</strong> spawn packet, which was supposed to spawn me in Northshire Abbey.</p>
<p>That’s probably the most important packet, since it does everything from:</p>
<ul>
<li>Spawning things into the world, like players, mobs, objects, etc.</li>
<li>Updating their values, like health, position, level, etc.</li>
</ul>
<p>It has a lot of different forms, can batch multiple object updates into a single packet, and has a compressed variant.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240604_20h08m46s_grim.avif" alt=""/></p>
<p>Whoops, had the coordinates a bit off.</p>
<p>After fixing that, I was in the human starting area as expected.
No player model yet, though.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240604_20h18m34s_grim.avif" alt=""/></p>
<p>I thought movement was broken, but it turns out all keybinds were being unset on every login, so the movement keys just weren’t bound.
Manually navigating to the keybinding configuration and resetting them to default allowed me to move around.</p>
<p>Next up was adding more to that spawn packet to use the player race and proper starting area.
The starting areas were grabbed from a MaNGOS database that I converted over to SQLite and wired up with Ecto.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240604_20h59m35s_grim.avif" alt=""/></p>
<p>Last for the night was to get logout working.</p>
<p>The implementation was something like:</p>
<ul>
<li>After receiving a <strong>CMSG_LOGOUT_REQUEST</strong>, use <code>Process.send_after/3</code> to queue a <strong>:login_complete</strong> message that would send <strong>SMSG_LOGOUT_COMPLETE</strong> to the client in 20 seconds</li>
<li>Store a reference to that timer in state</li>
<li>If received a <strong>CMSG_LOGOUT_CANCEL</strong>, cancel the timer and remove it from state</li>
</ul>
<p>This was the first piece that really took advantage of Elixir’s message passing.</p>
<p>The white chat box was weird, but it was nice being able to log in.</p>
<p>Links:</p>
<ul>
<li><a href="https://wowdev.wiki/Opcodes">https://wowdev.wiki/Opcodes</a></li>
<li><a href="https://wowdev.wiki/SMSG_UPDATE_OBJECT">https://wowdev.wiki/SMSG_UPDATE_OBJECT</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_update_object.html">https://gtker.com/wow_messages/docs/smsg_update_object.html</a></li>
<li><a href="https://gtker.com/wow_messages/ir/implementing_world.html">https://gtker.com/wow_messages/ir/implementing_world.html</a></li>
<li><a href="https://github.com/vdechef/mysql2sqlite">https://github.com/vdechef/mysql2sqlite</a></li>
</ul>
<h2 id="day-4---june-5th">Day 4 - June 5th</h2>
<p>First up was reorganizing the code, since my game.ex GenServer was getting too large.</p>
<p>My strategy for that was:</p>
<ul>
<li>Split out related messages into separate files
<ul>
<li>auth.ex, character.ex, ping.ex, etc.</li>
<li>wrapped in the <code>__using__</code> macro</li>
</ul>
</li>
<li>Include those back into game.ex with <code>use</code></li>
</ul>
<p>It worked, but it messed with line numbers in error messages and made things harder to debug.</p>
<p>After that, I wanted to generate that spawn packet properly rather than hardcoding.
The largest piece of this was figuring out the update mask for the update fields.</p>
<p>There are a ton of fields for the different types of objects <strong>SMSG_UPDATE_OBJECT</strong> handles.
Before the raw object fields in the payload, there’s a bit mask with bits set at offsets that correspond to the fields being sent.
Without that, the client wouldn’t know what to do with the values.</p>
<p>So, I needed to write a function that would generate this bit mask from the fields I pass in.
Luckily it’s all well documented, but it still took a while to get to a working implementation.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/types/update-mask.html">https://gtker.com/wow_messages/types/update-mask.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/object.html">https://gtker.com/wow_messages/docs/object.html</a></li>
</ul>
<h2 id="day-5---june-6th">Day 5 - June 6th</h2>
<p>Referencing MaNGOS, I added some more messages that the server sends to the client after a <strong>CMSG_PLAYER_LOGIN</strong>.
One of these, <strong>SMSG_ACCOUNT_DATA_TIMES</strong>, fixed the white chat box and keybinds being reset.</p>
<p>I also added <strong>SMSG_COMPRESSED_UPDATE_OBJECT</strong>, which compresses the <strong>SMSG_UPDATE_OBJECT</strong> packet with <code>:zlib.compress/1</code>.
This was more straightforward than expected, and I made things use the compressed variant if it’s actually smaller.
I’m expecting this to have even more benefits when I get to batching object updates, but right now I’m only updating objects one by one.</p>
<p>Movement would come up soon, so I started adding the handlers for those packets.</p>
<h2 id="day-6---june-7th">Day 6 - June 7th</h2>
<p>In the update packet, I still had the object guid hardcoded.
This is because it wants a packed guid and I needed to write some functions to handle that.
Rather than the entire guid, a packed guid is a byte mask followed by all non-zero bytes.
The byte mask has bits set that correspond to where the following bytes go in the unpacked guid.
This is for optimizing packet size, since a guid is always 8 bytes but a packed guid can be as small as 2 bytes.</p>
<p>This took a while, because the client was crashing when I changed the packed guid from <code>&lt;&lt;1, 4&gt;&gt;</code> to anything else.
After trying different things and wasting a lot of time, I realized that the guid was in two places in the packet and they needed to match.
A quick fix later and things were working as expected.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/types/packed-guid.html">https://gtker.com/wow_messages/types/packed-guid.html</a></li>
</ul>
<h2 id="day-7---june-8th">Day 7 - June 8th</h2>
<p>It was about time to start implementing the actual MMO features, starting with seeing other players.
To test, I hardcoded another update packet after the player’s with a different guid, to try and spawn something other than the player.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240607_23h59m00s_grim.avif" alt=""/></p>
<p>Then I used a Registry to keep track of logged in players and their spawn packets.
After entering the world, I would use <code>Registry.dispatch/3</code> to:</p>
<ul>
<li>spawn all logged in players for that player</li>
<li>spawn that player for all other players</li>
<li>both using <strong>SMSG_UPDATE_OBJECT</strong></li>
</ul>
<p>After that, I  added a similar dispatch when handling movement packets to broadcast movement to all other players.
This is where the choice of Elixir really started to shine, and I quickly had players able to see each other move around the screen.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240608_01h02m37s_grim.avif" alt=""/></p>
<p>I tested this approach with multiple windows open and it was very cool to see everything synchronized.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240608_19h17m07s_grim.avif" alt=""/></p>
<p>I added a handler for <strong>CMSG_NAME_QUERY</strong> to get names to stop showing up as Unknown and also despawned players with <strong>SMSG_DESTROY_OBJECT</strong> when logging out.</p>
<p>This is where I started noticing a bug: occasionally I wouldn’t be able to decrypt a packet successfully, which would lead to all future attempts for that connection failing too, since there’s a counter as part of the decryption function.
I couldn’t figure out how to resolve it yet, though, or reliably reproduce.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/docs/movementinfo.html">https://gtker.com/wow_messages/docs/movementinfo.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/msg_move_start_forward_client.html">https://gtker.com/wow_messages/docs/msg_move_start_forward_client.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/msg_move_start_backward_server.html">https://gtker.com/wow_messages/docs/msg_move_start_backward_server.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/cmsg_name_query.html">https://gtker.com/wow_messages/docs/cmsg_name_query.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_name_query_response.html">https://gtker.com/wow_messages/docs/smsg_name_query_response.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_destroy_object.html">https://gtker.com/wow_messages/docs/smsg_destroy_object.html</a></li>
</ul>
<h2 id="day-8---june-9th">Day 8 - June 9th</h2>
<p>To get chat working, I handled <strong>CMSG_MESSAGECHAT</strong> and broadcasted <strong>SMSG_MESSAGECHAT</strong> to players, using <code>Registry.dispatch/3</code> here too.
I only focused on /say here and it’s all players rather than nearby.
Something to fix later.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240609_01h43m59s_grim.avif" alt=""/></p>
<p>Related to that weird decryption bug, I handled the case where the server received more than one packet at once.
This might’ve helped a bit, but didn’t completely resolve the issue.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/docs/cmsg_messagechat.html">https://gtker.com/wow_messages/docs/cmsg_messagechat.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_messagechat.html">https://gtker.com/wow_messages/docs/smsg_messagechat.html</a></li>
</ul>
<h2 id="day-9---june-10th">Day 9 - June 10th</h2>
<p>I still had authentication with a hardcoded username, password, and salt, so it was about time to fix that.
Rather than go with PostgreSQL or SQLite for the database, I decided to go with Mnesia, since one of my goals was to learn more about Elixir and its ecosystem.
I briefly tried plain :mnesia, but decided to use Memento for a cleaner interface.</p>
<p>So, I added models for Account and Character and refactored everything to use them.
The character object is kept in process state and only persisted to the database on logout or disconnect.
Saving on a <strong>CMSG_PING</strong> or just periodically could be a good idea too, eventually.
Right now data isn’t persisted to disk, since I’m still iterating on the data model, but that should be straightforward to toggle later.</p>
<p>Links:</p>
<ul>
<li><a href="https://www.erlang.org/doc/apps/mnesia/mnesia.html">https://www.erlang.org/doc/apps/mnesia/mnesia.html</a></li>
<li><a href="https://elixirschool.com/en/lessons/storage/mnesia">https://elixirschool.com/en/lessons/storage/mnesia</a></li>
<li><a href="https://github.com/sheharyarn/memento">https://github.com/sheharyarn/memento</a></li>
</ul>
<h2 id="day-10---june-11th">Day 10 - June 11th</h2>
<p>Today was standardizing the logging, handling a bit more of chat, and handling an unencrypted <strong>CMSG_PING</strong>.
I was thinking that could be part of the intermittent decryption issues too, but looking back I don’t think I’ve ever had my client send that unencrypted anyways.</p>
<h2 id="day-11---june-12th">Day 11 - June 12th</h2>
<p>I wanted equipment working so players weren’t naked all the time, so I started on that.
Using the MaNGOS item_template table, I wired things up to set random equipment on character creation.
Then I added that to the response to <strong>CMSG_CHAR_ENUM</strong> so they would show up in the login screen.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240612_00h50m55s_grim.avif" alt=""/></p>
<p>Up next was getting it showing in game.</p>
<h2 id="day-12---june-13th">Day 12 - June 13th</h2>
<p>It took a bit to figure out the proper offsets for each piece of equipment in the update mask, but I eventually got it working.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240613_18h13m22s_grim.avif" alt=""/></p>
<p>Since equipment is part of the update object packet, it just worked for other players, which was nice.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240613_18h41m43s_grim.avif" alt=""/></p>
<h2 id="day-13---june-14th">Day 13 - June 14th</h2>
<p>I had player movement synchronizing between players properly so I wanted to get sitting working too.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240614_00h39m20s_grim.avif" alt=""/></p>
<p>Whoops.
Weird things happen when field offsets or sizes are incorrect when building that update mask.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240614_00h50m30s_grim.avif" alt=""/></p>
<p>After that, I wanted to play around a bit by randomizing equipment on every jump.
Here I learned that you need to send all fields in the update object packet, like health, or they get reset.
I was trying to just send the equipment changes but I’d die on every jump.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240614_20h11m08s_grim.avif" alt=""/></p>
<p>After making sure to send all fields, it was working as expected.</p>
<h2 id="day-14---june-15th">Day 14 - June 15th</h2>
<p>Took a break.</p>
<h2 id="day-15---june-16th">Day 15 - June 16th</h2>
<p>Today was refactoring and improvements.
I reworked things into proper modules, since it was getting hard to debug when all the line numbers were wrong.
Now game.ex called the appropriate module’s <code>handle_packet/3</code> function, rather than combining everything with <code>use</code>.</p>
<p>I also reworked things so players were spawned with their current position instead of the initial position saved in the registry.
This included some changes to make building an update packet more straightforward.</p>
<h3 id="day-16---june-17th">Day 16 - June 17th</h3>
<p>Today was just playing around and no code changes.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240617_01h25m24s_grim.avif" alt=""/></p>
<p>Not sure why the model is messed up here, but it seems like it’s something with my computer rather than anything server related.</p>
<h2 id="day-17---june-18th">Day 17 - June 18th</h2>
<p>The world was feeling a bit empty, so I wanted to spawn in mobs.
First was hardcoding an update packet that should spawn a mob and having it trigger on /say.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240618_18h20m25s_grim.avif" alt=""/></p>
<p>After that, I used the creature table of the MaNGOS database to get proper mobs spawning.
I used a GenServer for this so every mob would be a process and keep track of their own state.
Communication between mobs and players would happen through message passing.
First I hardcoded a few select ids in the starting area to load, and after that worked I loaded them all.</p>
<p>Rather than spawn all ~57k mobs for the player, I wired things up to only spawn mobs within a certain range.
This looked like:</p>
<ul>
<li>Store mob pids in a Registry, along with their x, y, z position</li>
<li>Create a <code>within_range/2</code> function that takes in two x, y, z tuples</li>
<li>On player login, dispatch on that MobRegistry, using <code>within_range/2</code> to only build spawn packets for mobs within range</li>
<li>On player movement, do the same</li>
</ul>
<p>It worked really well and I could run around and see the mobs.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240618_20h02m55s_grim.avif" alt=""/></p>
<p>Next up was optimization and despawning mobs that were now out of range.</p>
<h2 id="day-18---june-19th">Day 18 - June 19th</h2>
<p>For optimization, I didn’t want to send duplicate spawn packets for mobs that were already spawned.
I also wanted to despawn mobs that were out of range.
To do this, I used ETS to track which guids were spawned for a player.</p>
<p>In the dispatch, the logic was:</p>
<ul>
<li>if in_range and not spawned, spawn</li>
<li>if not in_range and spawned, despawn</li>
<li>otherwise, ignore</li>
</ul>
<p>Despawning was done through the same <strong>SMSG_DESTROY_OBJECT</strong> packet used for despawning a player after logging out.</p>
<p>After getting that working, I ran around the world and explored for a bit.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240619_00h23m11s_grim.avif" alt=""/></p>
<p>I noticed something wrong when exploring Westfall.
Bugs were spawning in the air and then falling down to the ground.
Turns out I wasn’t separating mobs by map, so Westfall had mobs from Silithus mixed in.
To fix, I reworked both the mob and player registries to use the map as the key.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240619_00h41m11s_grim.avif" alt=""/></p>
<p>Having mobs standing in place was a bit boring and I wanted them to move around.
Turns out this is pretty complicated and I’ll actually have to use the map files to generate paths that don’t float or clip through the ground.
There are a few projects for this, all a bit difficult to include in an Elixir project.
I’m thinking RPC could work, but not sure if it’ll be performant enough yet.</p>
<p>The standard update object packet can be used for mob movement here, since it has a movement block, but there might be some more specialized packets to look into later too.</p>
<p>Without using the map data, I couldn’t get the server movement to line up with what happened in the client.
So, I settled with getting mobs to spin at random speeds.</p>
<video controls="" src="./2024-06-19%2018-21-02-[00.00.799-00.02.699]-audio.webm"></video>

<p>That was a bit silly and used a lot of CPU, so I tweaked it to just randomly change orientation instead.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/docs/movementblock.html">https://gtker.com/wow_messages/docs/movementblock.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/compressedmove.html">https://gtker.com/wow_messages/docs/compressedmove.html</a></li>
<li><a href="https://github.com/namreeb/namigator">https://github.com/namreeb/namigator</a></li>
</ul>
<h2 id="day-19---june-20th">Day 19 - June 20th</h2>
<p>Here I got mob names working by implementing <strong>CMSG_CREATURE_QUERY</strong>.
This crashed the client when querying mobs that didn’t have a model, so I removed them from being loaded.
I also started loading in mob movement data and optimized the query a bit to speed up startup.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240620_18h33m27s_grim.avif" alt=""/></p>
<p>I finally got some people to help me test the networking later that day.
It didn’t start very well.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240620_22h20m18s_grim.avif" alt=""/></p>
<p>Turns out I hadn’t tested this locally since adding mobs and the player/mob spawn/despawns were conflicting with each other due to guid collisions.
Players were being constantly spawned in and out.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240620_22h22m55s_grim.avif" alt=""/></p>
<p>I did some emergency patching to make it so players are never despawned, even out of range.
I also turned off /say spawning boars since that was getting annoying.
That worked for now.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240620_23h03m05s_grim.avif" alt=""/></p>
<p>There were still some major issues.
My helper had 450 ms latency and would crash when running to areas with a lot of mobs.
I couldn’t reproduce, though, with my 60 ms latency.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/docs/cmsg_creature_query.html">https://gtker.com/wow_messages/docs/cmsg_creature_query.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_creature_query_response.html">https://gtker.com/wow_messages/docs/smsg_creature_query_response.html</a></li>
</ul>
<h2 id="day-20---june-21">Day 20 - June 21</h2>
<p>To reproduce the issue from the previous night, I connected to my local server from my laptop on the same network.
On my laptop, I used <code>tc</code> to simulate a ton of latency and wired things up so equipment would change on any movement instead of just jump.
This sent a lot of packets when spinning and I was finally able to reproduce.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240621_23h35m50s_grim.avif" alt=""/></p>
<p>Turns out the crashing issues were from not receiving a complete packet, but still trying to decrypt and handle it.
I was handling if the server got more than one packet, but not if the server got a partial packet.</p>
<p>Referencing Shadowburn’s implementation, the fix for this was to let the packet data accumulate until there’s enough to handle.
This finally resolved the weird decryption issue I ran into on day 7.</p>
<p>For the guid collision issue, I added a large offset to creature guids so they won’t conflict with player guids.</p>
<h2 id="day-21---june-22">Day 21 - June 22</h2>
<p>Took a break.</p>
<h2 id="day-22---june-23">Day 22 - June 23</h2>
<p>Worked on <strong>CMSG_ITEM_NAME_QUERY</strong> a bit, but there’s still something wrong here.
It could be that it’s trying to calculate damage using some values I’m not passing to the client yet.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240623_17h34m30s_grim.avif" alt=""/></p>
<p>Decided spells would be next, so I started on that.
First was sending spells over with <strong>SMSG_INITIAL_SPELLS</strong> on login, using the initial spells in MaNGOS, so I’d have something in the spellbook.
Everything was instant cast though, for some reason.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240623_20h41m09s_grim.avif" alt=""/></p>
<p>Turns out I needed to set <strong>unit_mod_cast_speed</strong> in the player update packet for cast times to show up properly in the client.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240623_21h53m34s_grim.avif" alt=""/></p>
<p>I started by handling <strong>CMSG_CAST_SPELL</strong>, which would send a successful <strong>SMSG_CAST_RESULT</strong> after the spell cast time, so other spells could be cast.
I also handled <strong>CMSG_CANCEL_CAST</strong>, to cancel that timer.
This implementation looked a bit like the logout logic.</p>
<p>The starting animation for casting a spell would play, but no cast bar or anything further.</p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/docs/smsg_initial_spells.html">https://gtker.com/wow_messages/docs/smsg_initial_spells.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/cmsg_cast_spell.html">https://gtker.com/wow_messages/docs/cmsg_cast_spell.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/cmsg_cancel_cast.html">https://gtker.com/wow_messages/docs/cmsg_cancel_cast.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_cast_result.html">https://gtker.com/wow_messages/docs/smsg_cast_result.html</a></li>
</ul>
<h2 id="days-23-to-26---june-24-to-27">Days 23 to 26 - June 24 to 27</h2>
<p>Took a longer break.</p>
<h2 id="day-27---june-28">Day 27 - June 28</h2>
<p>I was able to get a cast bar showing up by sending <strong>SMSG_SPELL_START</strong> after receiving the cast spell packet.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240628_22h57m17s_grim.avif" alt=""/></p>
<p>The projectile effect took a bit longer to figure out.
I needed to send a <strong>SMSG_SPELL_GO</strong> after the cast was complete, with the proper target guids.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240628_23h58m06s_grim.avif" alt=""/></p>
<p>Links:</p>
<ul>
<li><a href="https://gtker.com/wow_messages/docs/smsg_spell_start.html">https://gtker.com/wow_messages/docs/smsg_spell_start.html</a></li>
<li><a href="https://gtker.com/wow_messages/docs/smsg_spell_go.html">https://gtker.com/wow_messages/docs/smsg_spell_go.html</a></li>
</ul>
<h2 id="day-28---june-29">Day 28 - June 29</h2>
<p>I got self-cast spells working by setting the target guid to the player’s guid.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240629_00h13m16s_grim.avif" alt=""/></p>
<h2 id="day-29---june-30">Day 29 - June 30</h2>
<p>Another break.</p>
<h2 id="day-30---july-1">Day 30 - July 1</h2>
<p>Since I had spells somewhat working, next I had to clean up the implementation.
I dispatched the <strong>SMSG_SPELL_START</strong> and <strong>SMSG_SPELL_GO</strong> packets to nearby players and fixed spell cancelling.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240701_18h44m36s_grim.avif" alt=""/></p>
<h2 id="day-31---july-2">Day 31 - July 2</h2>
<p>I added levels to mobs, random from their minimum to maximum level, previously hardcoded 1.
Then I made spells do some hardcoded damage, so mobs could die.
Mobs would still randomly change orientation when dead, so added a check to only move if alive.</p>
<p><img src="https://pikdum.dev/posts/thistle-tea/20240702_20h41m22s_grim.avif" alt=""/></p>
<p>That seemed like a good stopping point and was one month since I started writing code for the project.</p>
<h2 id="future-plans">Future Plans</h2>
<p>I’ll slowly work on this, adding more functionality as I go.
My goal isn’t a 1:1 Vanilla server, but more something that fits well with Elixir’s capabilities, so I don’t plan on accepting limitations for the sake of accuracy or similar.
I’d like to see how many players this approach can handle and how it compares in performance to other implementations eventually too.</p>
<p>Some things on the list:</p>
<ul>
<li>proper mob + player stats</li>
<li>proper damage calculations</li>
<li>pvp</li>
<li>quests</li>
<li>mob movement + combat ai</li>
<li>loot + inventory management</li>
<li>more spells + effects</li>
<li>tons of refactoring</li>
<li>benchmarking</li>
<li>gameplay loop, in general</li>
</ul>
<p>So still plenty more work to do. :)</p>
<p>Thanks to all the projects I’ve referenced for this, most of which I’ve tried to link here.</p>
<p>I wouldn’t have gotten very far without them and their awesome documentation.</p>

  <hr/>
  
  

  <details>
    <summary>Comments</summary>
    
  </details>

  </div></div>
  </body>
</html>
