<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://openwrt.org/docs/guide-user/network/wan/smartphone.usb.tethering">Original</a>
    <h1>OpenWrt: Smartphone USB Tethering</h1>
    
    <div id="readability-page-1" class="page"><div>

<div>
<div>
<div>
<p>
This article relies on the following:
</p>

</div>
</div>
</div>



<div>

<p>
USB tethering is used to connect your OpenWrt Router to the Internet by using the your smartphone.
It&#39;s more convenient and has better performance (lower latency) than turning your smartphone into an access point and using that.
It also is less of a CPU load on your phone, charges your phone, and allows you the flexibility of doing things with your OpenWrt router that you cannot do with your phone like connecting multiple devices with ease, both wireless and wired, to each other and to the internet.
In order to maximize performance, you should turn your tethered phone Wi-Fi and Bluetooth off.
</p>


</div>





<div>

<p>
For the easiest installation, have a wired upstream internet connection to boot-strap this process.
You will need: the router, your tethering phone, necessary cables, a laptop and an upstream internet connection via Ethernet for initial setup.
Instead of a wired upstream connection to plug into the router <abbr title="Wide Area Network">WAN</abbr> port, is also possible to download necessary packages below, through your laptop while tethered to your phone, the same way you can get the OpenWrt distribution for your router.
</p>

<p>
A common protocol for Android based devices for tethering via USB is RNDIS:
</p>
<pre>opkg update
opkg <span>install</span> kmod-usb-net-rndis</pre>

<p>
However Android devices come with great diversity, therefor some require different <a href="https://en.wikipedia.org/wiki/Ethernet_over_USB" title="https://en.wikipedia.org/wiki/Ethernet_over_USB">protocols</a>. For instance newer devices may use NCM, others may require EEM or even need a subset implementation. 
</p>

<p>
<strong>NOTE:</strong> Try the following protocol(s) if you don&#39;t have a `usb0` interface come up or device keeps disconnecting:
</p>
<pre>opkg install kmod-usb-net-cdc-ncm

# Huawei may need its own implementation!
opkg install kmod-usb-net-huawei-cdc-ncm

# More protocols:
kmod-usb-net-cdc-eem
kmod-usb-net-cdc-ether
kmod-usb-net-cdc-subset</pre>

<p>
Extra steps depending on <a href="https://openwrt.org/docs/guide-user/storage/usb-installing" title="docs:guide-user:storage:usb-installing" data-wiki-id="docs:guide-user:storage:usb-installing">USB type and drivers</a> for your router:
</p>
<pre>opkg update
opkg <span>install</span> kmod-nls-base kmod-usb-core kmod-usb-net kmod-usb-net-cdc-ether kmod-usb2</pre>

<p>
Additional steps for iOS devices:
</p>
<pre>opkg update
opkg <span>install</span> kmod-usb-net-ipheth usbmuxd libimobiledevice usbutils
 
<span># Call usbmuxd</span>
usbmuxd <span>-v</span>
 
<span># Add usbmuxd to autostart</span>
<span>sed</span> <span>-i</span> <span>-e</span> <span>&#34;<span>\$</span>i usbmuxd&#34;</span> <span>/</span>etc<span>/</span>rc.local</pre>

<p>
If you need to manually download the packages on another device for bootstrapping, see <a href="https://openwrt.org/downloads#get_additional_software_packages" title="downloads" data-wiki-id="downloads">get_additional_software_packages</a>. The Kernel modules will be in the <abbr title="Uniform Resource Locator">URL</abbr> of form downloads.openwrt.org/releases/[your release]/targets/[your target]/generic/packages/ and other packages (iOS stuff in this case) in downloads.openwrt.org/releases/[release]/packages/[instruction set]/packages/.
</p>

</div>


<div>

<p>
Connect the smartphone to the USB port of the router with the USB cable, and then enable <code>USB Tethering</code> from the Android settings.
Turn on the phone&#39;s <code>Developer Options</code> <em>[Find the <code>Build</code> information in the <code>About Phone</code> menu, and tap rapidly 7 x]</em>.
There is a <code>Default USB Configuration: USB Tethering</code> option.
The phone will now immediately turn on USB Tethering mode when plugged into a configured router [or laptop], without further commands.
However, <strong>it is necessary to remove the screen lock on the phone.
A locked phone will not start USB Tethering by itself</strong>.
</p>

<p>
For iPhones, you may have to disable and re-enable the <em>Personal Hotspot/Allow Others to Join</em> setting on the iPhone to force the OpenWrt <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> client to get an <abbr title="Internet Protocol">IP</abbr> address from the eth1 iPhone interface.
Disabling and re-enabling the <em>Personal Hotspot/Allow Others to Join</em> setting on the iPhone is also required if you disconnect the iPhone from the OpenWrt USB port and re-connect it later, unless you cache Trust records (see watchdog section and/or LeJeko&#39;s Github repository in reference section).
</p>

<p>
iPhones starting from iOS 11 will terminate the USB data connections after one hour by default to improve security. This can easily be changed via:
</p>

<p>
<code>Settings &gt; Touch ID/Face ID &amp; Passcode &gt; USB Accessories &gt; ON</code> (<a href="https://www.macworld.com/article/233368/that-s-right-you-can-t-turn-off-personal-hotspot-in-ios-13-and-ipados-13.html" title="https://www.macworld.com/article/233368/that-s-right-you-can-t-turn-off-personal-hotspot-in-ios-13-and-ipados-13.html" rel="ugc nofollow">macworld</a>)
</p>

</div>

<h3 id="a_command-line_interface">3.a Command-line interface</h3>
<div>

<p>
On the router, enter:
</p>
<pre><span># Enable tethering</span>
uci <span>set</span> network.wan.ifname=<span>&#34;usb0&#34;</span>
uci <span>set</span> network.wan6.ifname=<span>&#34;usb0&#34;</span>
uci commit network
<span>/</span>etc<span>/</span>init.d<span>/</span>network restart</pre>

<p>
For iPhones, replace the interface name <code>usb*</code> with <code>eth*</code> depending on router.
</p>

<p>
It should be all working at this point.
To activate wireless connections to the router, go to Network, Wireless and set then enable the interfaces.
</p>

</div>


<div>

<p>
Go to Network, Interfaces.
You can either assign the existing <abbr title="Wide Area Network">WAN</abbr> to usb0 like 3.a above, or create a whole new interface if you want to swap between the <abbr title="Wide Area Network">WAN</abbr> Ethernet port and your tethering device (such as in a dual-wan fail-over situation). To make changes in the web interface equivalent to the above command line instructions: simply edit the existing default <abbr title="Wide Area Network">WAN</abbr> interface, and change the physical device to usb0, then Save &amp; Apply.
</p>

<p>
Instead, to create a whole new interface, make a new one called <strong>TetheringWAN</strong>, and bind to it the new *usb0* network device (restart if you do not see it yet. And, for some cases, the new interface may be called &#39;*eth1*: check what the log is showing in your case). Set the protocol to <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> client mode or DHCPv6 client mode if the <abbr title="Internet Service Provider">ISP</abbr> assigns <abbr title="Internet Protocol version 6">IPv6</abbr>, and under the Firewall Settings tab, place it into the <abbr title="Wide Area Network">WAN</abbr> zone.
Save changes.
</p>

<p>
See the following screenshots.</p>

<p>
After committing the changes the new TetheringWAN should be activated.
Otherwise, restart it with the buttons you find in the <strong>Interface</strong> page of LuCI web interface.
</p>

</div>


<div>

<p>
If all went well, you should be able to see something like the following in the kernel log
</p>

<pre>[  168.599245] usb 1-1: new high-speed USB device number 2 using orion-ehci
[  175.997290] usb 1-1: USB disconnect, device number 2
[  176.449246] usb 1-1: new high-speed USB device number 3 using orion-ehci
[  176.654650] rndis_host 1-1:1.0 usb0: register &#39;rndis_host&#39; at usb-f1050000.ehci-1, RNDIS device, ee:da:c0:50:ff:44</pre>

<p>
Note how the last line tells us that this new “RNDIS device” was bound to interface <strong>usb0</strong>.
</p>

<p>
<img src="https://openwrt.org/lib/images/smileys/icon_exclaim.gif" alt=":!:"/> The above messages will not be shown with iPhone tethering.
</p>

</div>








<div>

<p>
If your tethering connection fails every so often, and:
</p>


<p>
Then it might be fixed with the following solution:
</p>
<pre><span># Install packages</span>
opkg update
opkg <span>install</span> hub-ctrl
 
<span># Save connectivity checking script</span>
<span>cat</span> <span>&lt;&lt;</span> <span>&#34;EOF&#34;</span> <span>&gt;</span> <span>/</span>root<span>/</span>wan-watchdog.sh
<span>#!/bin/sh</span>
 
<span># Fetch WAN gateway</span>
. <span>/</span>lib<span>/</span>functions<span>/</span>network.sh
network_flush_cache
network_find_wan NET_IF
network_get_gateway NET_GW <span>&#34;<span>${NET_IF}</span>&#34;</span>
 
<span># Check WAN connectivity</span>
<span>TRIES</span>=<span>&#34;0&#34;</span>
<span>while</span> <span>[</span> <span>&#34;<span>${TRIES}</span>&#34;</span> <span>-lt</span> <span>5</span> <span>]</span>
<span>do</span>
    <span>if</span> <span>ping</span> <span>-c</span> <span>1</span> <span>-w</span> <span>3</span> <span>&#34;<span>${NET_GW}</span>&#34;</span> <span>&amp;&gt;</span> <span>/</span>dev<span>/</span>null
    <span>then</span> <span>exit</span> <span>0</span>
    <span>else</span> <span>let</span> TRIES++
    <span>fi</span>
<span>done</span>
 
<span># Restart network</span>
<span>/</span>etc<span>/</span>init.d<span>/</span>network stop
hub-ctrl <span>-h</span> <span>0</span> <span>-P</span> <span>1</span> <span>-p</span> <span>0</span>
<span>sleep</span> <span>1</span>
hub-ctrl <span>-h</span> <span>0</span> <span>-P</span> <span>1</span> <span>-p</span> <span>1</span>
<span>/</span>etc<span>/</span>init.d<span>/</span>network start
EOF
<span>chmod</span> +x <span>/</span>root<span>/</span>wan-watchdog.sh
 
<span># Add cron job</span>
<span>cat</span> <span>&lt;&lt;</span> <span>&#34;EOF&#34;</span> <span>&gt;&gt;</span> <span>/</span>etc<span>/</span>crontabs<span>/</span>root
<span>*</span> <span>*</span> <span>*</span> <span>*</span> <span>*</span> <span>/</span>root<span>/</span>wan-watchdog.sh
EOF</pre>

<p>
Every 1 minute, the script will be run, ping <abbr title="Wide Area Network">WAN</abbr> gateway, and if there are 5 consecutive failures, it will stop the network, power off the USB hub (which will terminate tethering on the phone), power it back on, then restart the network.
This solution is much faster than restarting the whole router.
</p>

</div>


<div>

<p>
Once you set up iPhone tethering as per above, you&#39;ll notice several issues:
</p>


<p>
Save following script to some location that survives reboot, e.g. <code>/etc/lockdown</code>, and execute it after every reboot.
It should keep tethering up and running as long as iPhone is connected.
</p>
<pre><span># Save watchdog script</span>
<span>mkdir</span> <span>-p</span> <span>/</span>etc<span>/</span>lockdown
<span>cat</span> <span>&lt;&lt;</span> <span>&#34;EOF&#34;</span> <span>&gt;</span> <span>/</span>etc<span>/</span>lockdown<span>/</span>watchdog.sh
<span>#!/bin/sh</span>
<span># A small script to make life with iPhone tethering less cumbersome on OpenWrt</span>
<span># Petr Vyskocil, Apr 2020</span>
<span># Public domain</span>
 
<span># After you successfully allow iPhone tethering, copy files with name like</span>
<span># /var/lib/lockdown/12345678-9ABCDEF012345678.plist to /etc/lockdown/locks.</span>
<span># That way, you won&#39;t have to set up trust again after router reboots.</span>
<span>if</span> <span>[</span> <span>-e</span> <span>/</span>etc<span>/</span>lockdown<span>/</span>locks <span>]</span>
<span>then</span>
    <span>mkdir</span> <span>-p</span> <span>/</span>var<span>/</span>lib<span>/</span>lockdown
    <span>cp</span> <span>-f</span> <span>/</span>etc<span>/</span>lockdown<span>/</span>locks<span>/*</span> <span>/</span>var<span>/</span>lib<span>/</span>lockdown<span>/</span>
<span>fi</span>
 
<span># lockdown records restored, now we can launch usbmuxd. Don&#39;t launch it sooner!</span>
usbmuxd
 
<span># We are up and running now. But unfortunately if your carrier signal is weak, iPhone will</span>
<span># drop connection from time to time and you&#39;d have to unplug and replug USB cable to start tethering</span>
<span># again. Script below automates that activity.</span>
 
<span># First wait a bit - we just brought the interface up by usbmuxd</span>
<span>sleep</span> <span>20</span>
 
<span># If we see iPhone ethernet interface, try to ping iPhone router&#39;s address (172.20.10.1).</span>
<span># When the ping is unsuccessful, rebind iPhone ethernet USB driver and wait for things to settle down</span>
<span>while</span> :
<span>do</span>
    <span>for</span> i <span>in</span> <span>/</span>sys<span>/</span>bus<span>/</span>usb<span>/</span>drivers<span>/</span>ipheth<span>/*</span>:<span>*</span>
    <span>do</span>
        <span>test</span> <span>-e</span> <span>&#34;<span>${i}</span>&#34;</span> <span>||</span> <span>continue</span>
        <span>ping</span> <span>-w</span> <span>3</span> 172.20.10.1 <span>&amp;&gt;</span> <span>/</span>dev<span>/</span>null
        <span>if</span> <span>[</span> <span>&#34;<span>${?}</span>&#34;</span> <span>-ne</span> <span>0</span> <span>]</span>; <span>then</span>
            <span>echo</span> <span>&#34;<span>${i##*/}</span>&#34;</span> <span>&gt;</span> <span>&#34;<span>${i%/*}</span>&#34;</span><span>/</span>unbind
            <span>echo</span> <span>&#34;<span>${i##*/}</span>&#34;</span> <span>&gt;</span> <span>&#34;<span>${i%/*}</span>&#34;</span><span>/</span><span>bind</span>
            <span>sleep</span> <span>20</span>
        <span>fi</span>
    <span>done</span>
    <span>sleep</span> <span>1</span>
<span>done</span>
EOF
<span>chmod</span> +x <span>/</span>etc<span>/</span>lockdown<span>/</span>watchdog.sh
 
<span># Add watchdog script to autostart</span>
<span>sed</span> <span>-i</span> <span>-e</span> <span>&#34;<span>\$</span>i (/etc/lockdown/watchdog.sh) &amp;&#34;</span> <span>/</span>etc<span>/</span>rc.local</pre>

</div>


<p>
If your Android phone does not seem to detect that there is something attached to the USB port and refuses to switch to USB tethering, you might want to install <strong>DriveDroid</strong> and try to enable various methods of using USB guest for its own functionality.
This does solve that issue in my phone (which is running LineageOS nightly and sometimes after I update does show this issue).
You will probably need <strong>root</strong> (administrator) access on your device though.
</p>


<div>

<p>
Cell phone companies are slowing transitioning to <abbr title="Internet Protocol version 6">IPv6</abbr>, and they might assign your SIM an <abbr title="Internet Protocol version 6">IPv6</abbr> subnet bigger than a /64, typically, a /56 or /48, but sometimes a /60. You may use an assignment larger than a /64 (/56 or /48) to provide native <abbr title="Internet Protocol version 6">IPv6</abbr> addresses and connectivity to your <abbr title="Local Area Network">LAN</abbr>. A quick way to test, assuming your device is *usb0*, is to create the <strong>TetheringWAN</strong> interface as suggested above, but instead of <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> client, choose DHCPv6 client instead.<br/>

</p>

<p>
If your provider does not assign a subnet larger than a /64, you could use <a href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6.nat6" title="docs:guide-user:network:ipv6:ipv6.nat6" data-wiki-id="docs:guide-user:network:ipv6:ipv6.nat6"> NAT6 and IPv6 masquerading</a> to enable <abbr title="Internet Protocol version 6">IPv6</abbr> access for your <abbr title="Local Area Network">LAN</abbr> clients but you should really ask your provider to assign you a /56 instead. One of the features of <abbr title="Internet Protocol version 6">IPv6</abbr> is enough address space to move away from <abbr title="Network Address Translation">NAT</abbr> and CGNAT.</p>

</div>


<div>

<p>
If you don&#39;t see something like the sample kernel log output in your device&#39;s log then your device might be lacking proper USB drivers (drivers to operate the USB controllers at all).
Check <a href="https://openwrt.org/docs/guide-user/storage/usb-installing" title="docs:guide-user:storage:usb-installing" data-wiki-id="docs:guide-user:storage:usb-installing">Installing USB drivers</a> and report the issue in a bug report or in the mailing list, as devices should have base USB drivers integrated and working already.
</p>

<p>
For other issues it might be worth it to check <a href="https://openwrt.org/docs/guide-user/network/wan/wwan/ethernetoverusb_rndis" title="docs:guide-user:network:wan:wwan:ethernetoverusb_rndis" data-wiki-id="docs:guide-user:network:wan:wwan:ethernetoverusb_rndis"> the article about using RNDIS dongles</a> as Android tethering is using the same protocol.
</p>

</div>

</div></div>
  </body>
</html>
