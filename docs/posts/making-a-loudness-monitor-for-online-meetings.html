<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rolisz.ro/2023/02/02/making-a-loudness-monitor/">Original</a>
    <h1>Making a loudness monitor for online meetings</h1>
    
    <div id="readability-page-1" class="page"><article>

            

            <figure>
                <img srcset="/content/images/size/w300/2023/02/jason-rosewell-ASKeuOZqhYU-unsplash.jpg 300w,
                            /content/images/size/w600/2023/02/jason-rosewell-ASKeuOZqhYU-unsplash.jpg 600w,
                            /content/images/size/w1000/2023/02/jason-rosewell-ASKeuOZqhYU-unsplash.jpg 1000w,
                            /content/images/size/w2000/2023/02/jason-rosewell-ASKeuOZqhYU-unsplash.jpg 2000w" sizes="(max-width: 800px) 400px,
                        (max-width: 1170px) 1170px,
                            2000px" src="https://rolisz.ro/content/images/size/w2000/2023/02/jason-rosewell-ASKeuOZqhYU-unsplash.jpg" alt="Making a loudness monitor for online meetings"/>
            </figure>

            <section>
                <div>
                    <p>As I work from home 90% of the time, I run into a small issue during meetings: I sometimes speak too loudly. Before my daughter Gloria arrived, this was something that annoyed my wife and others in the house, but now, when Gloria is sleeping, this is not just an annoyance, it&#39;s a BIG problem, because nobody wants to wake up a toddler. </p><p>While I do have monitoring that alerts me via Signal that I&#39;m speaking too loud (my wife), I wanted to write a program to do that all the time, in the spirit of using programming to <a href="https://rolisz.ro/2022/03/15/on-the-usefulness-of-a-little-bit-of-programming/">make my life nicer</a>.</p><p>So I started to look for a Python library that can give me information about the sound level from my microphone. A quick Kagi search revealed several options, but <code>sounddevice</code> seemed like the best one.</p><p>The first step is to identify the microphone. For that I need the name as it&#39;s know to the operating system. I can get that by running the following code in a Python console:</p><pre><code>&gt; import sounddevice as sd
&gt; sd.query_devices()
0 Microsoft Sound Mapper - Input, MME (2 in, 0 out)
1 Microphone (Yeti Stereo Microph, MME (2 in, 0 out)
2 Microphone (WO Mic Device), MME (2 in, 0 out)
....
&gt; sd.query_devices()[1][&#39;name&#39;]
&#39;Microphone (Yeti Stereo Microph&#39;</code></pre><p>I get a long list of stuff, but I see something with Yeti in the name so I grab that one. </p><p>Now let&#39;s start listening to the microphone. Sounddevice offers a callback based API, where it passes along the raw audio data received from the microphone. From that, I estimate the loudness by calculating the norm of the sound:</p><pre><code>import numpy as np
import sounddevice as sd


def print_sound(indata, frames, t, status):
    volume = np.linalg.norm(indata) * 10
    print(volume)


name = &#39;Microphone (Yeti Stereo Microph&#39;
with sd.InputStream(device=name,callback=print_sound):
    for i in range(5):
        sd.sleep(1000)</code></pre><p>Running this gives something as follows. Can you guess where I snapped my fingers?</p><pre><code>0.3724626451730728
0.6015866994857788
0.9348087012767792
0.7427176833152771
0.8615989238023758
0.7162655889987946
0.5638395622372627
0.7117109000682831
59.17434215545654
50.70761203765869
20.951063632965088
14.069621562957764
9.29598331451416
5.908793210983276
3.782018721103668
2.402055263519287
1.7902085185050964
1.1522774398326874
0.793280228972435</code></pre><p>The next step is to make it warn me when I speak too loud. For this I keep a buffer of the latest sound intensities in order to be able to detect when either something loud has been happening for a long time or if a really loud noise happened in the last frames:</p><pre><code>import time
from collections import deque

import numpy as np
import sounddevice as sd


last_alert = time.time() - 10
q = deque(maxlen=200)


def print_sound(indata, frames, t, status):
    global last_alert
    volume_norm = np.linalg.norm(indata) * 10
    q.append(volume_norm)
    last_elements = [q[i] for i in range(-min(50, len(q)), 0)]
    recent_avg_sound = sum(last_elements) / len(last_elements)
    num_high_count = len([x for x in q if x &gt; 20])
    if num_high_count &gt; 30 or recent_avg_sound &gt; 50:
        if time.time() - last_alert &gt; 10:
            print(f&#34;You are speaking at {volume_norm:.2f}. Think of Gloria!\a&#34;)
            last_alert = time.time()


name = &#39;Microphone (Yeti Stereo Microph&#39;
with sd.InputStream(device=name,callback=print_sound):
    while True:
        sd.sleep(1000)</code></pre><p>Now, when running from a Terminal (either on Windows or Linux), this will make a bell sound if in the last 5 seconds (that&#39;s about 200 frames) there have been more than 30 frames with loudness over 20 or if in the last second the average was over 50 (this would mean a really loud sound). </p><p>If you want to run this outside of Terminal, you can use <code>beepy</code> for example to make sounds and replace the <code>print</code> statement with this:</p><pre><code>from beepy import beep

beep(sound=&#34;error&#34;)
</code></pre><p>To run this on startup on Windows, I created the following ps1 script in the startup folder:</p><pre><code>C:\Users\Roland\Programming\mic_check\.venv\Scripts\pythonw.exe C:\Users\Roland\Programming\mic_check\mic_check.py
</code></pre><p>Another improvement would be to make it easier to see current loudness and to be able to quit it easily (because the ps1 script runs in the background). For this I used the <code>infi.systray</code> library on Windows:</p><pre><code>from infi.systray import SysTrayIcon

def quit(systray):
    global still_on
    still_on = False


menu_options = ()
systray = SysTrayIcon(&#34;icon.ico&#34;, &#34;Mic check tray icon&#34;, menu_options, on_quit=quit)
systray.start()
still_on = True
name = &#39;Microphone (Yeti Stereo Microph&#39;
with sd.InputStream(device=name,callback=print_sound):
    while still_on:
        sd.sleep(1000)</code></pre><p>And now, hopefully I&#39;ll learn to control my loudness better!</p><p>You can find the full code <a href="https://gist.github.com/rolisz/df3aed4bda88e1a6c8ed33f8672b4b28">here</a>.</p>
                </div>
            </section>

                <section>
    <h3>Subscribe to rolisz&#39;s blog</h3>
	
</section>

            
            
            

        </article></div>
  </body>
</html>
