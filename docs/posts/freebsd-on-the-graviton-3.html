<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.daemonology.net/blog/2022-05-23-FreeBSD-Graviton-3.html">Original</a>
    <h1>FreeBSD on the Graviton 3</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>
Amazon
<a href="https://aws.amazon.com/blogs/aws/join-the-preview-amazon-ec2-c7g-instances-powered-by-new-aws-graviton3-processors/">announced
the Graviton 3</a> processor and C7g instance family in November 2021, but it
took six months before they were ready for
<a href="https://aws.amazon.com/blogs/aws/new-amazon-ec2-c7g-instances-powered-by-aws-graviton3-processors/">general
availability</a>; in the mean time, however, as the maintainer of the
FreeBSD/EC2 platform I was able to get early access to these instances.
</p><p>
As far as FreeBSD is concerned, Graviton 3 is mostly just a faster
version of the Graviton 2: Most things &#34;just work&#34;, and the things which
don&#39;t work on Graviton 2 — hotplug devices and cleanly shutting down
an instance via the EC2 API — also don&#39;t work on Graviton 3.  (Want
to help get these fixed?  <a href="https://www.patreon.com/cperciva">Sponsor
my work on FreeBSD/EC2 so I have a few more paid hours to work on this.</a>)
The one notable <em>architectural</em> difference with the Graviton 3 is
the addition of Pointer Authentication, which makes use of &#34;unused&#34; bits
in pointers to guard against some vulnerabilities (e.g. buffer overflows
which overwrite pointers).  Andrew Turner recently
<a href="https://cgit.freebsd.org/src/commit?id=85b7c566f1538f9a2e85f76bf5b41380701987a7">added
support for arm64 pointer authentication to FreeBSD</a>.
</p><p>
But since Graviton 3 is largely a &#34;faster Graviton 2&#34;, the obvious question
is &#34;how much faster&#34; — so I launched a couple instances (c6g.8xlarge
and c7g.8xlarge) with 500 GB root disks and started comparing.
</p><p>
The first performance test I always run on FreeBSD is a quick microbenchmark
of hashing performance: The <tt>md5</tt> command (also known as
<tt>sha1</tt>, <tt>sha256</tt>, <tt>sha512</tt>, and many other things) has
a &#34;time trial&#34; mode which hashes 100000 blocks of 10000 bytes each.  I ran
a few of these hashes:
</p><p>
Moving on, the next thing I did was to get a copy of the FreeBSD src and
ports trees.  Three commands: First, install <tt>git</tt> using the
<tt>pkg</tt> utility; second, <tt>git clone</tt> the FreeBSD src tree;
and third, use <tt>portsnap</tt> to get the latest ports tree (this last
one is largely a benchmark of <tt>fork(2)</tt> performance since
<tt>portsnap</tt> is a shell script):
</p><p>
Well, now that I had a FreeBSD source tree cloned, I had to run the
most classic FreeBSD benchmark: Rebuilding the FreeBSD base system (world
and kernel).  I checked out the 13.1-RELEASE source tree (normally I would
test building HEAD, but for benchmarking purposes I wanted to make sure
that other people would be able to run exactly the same compile later) and
timed <tt>make buildworld buildkernel -j32</tt> (the <tt>-j32</tt> tells
the FreeBSD build to make use of all 32 cores on these systems):
</p><p>
Ok, that&#39;s the base FreeBSD system; what about third-party packages?  I
built the <tt>apache24</tt>, <tt>Xorg</tt>, and <tt>libreoffice</tt>
packages (including all of their dependencies, starting from a clean
system each time).  In the interest of benchmarking the package builds
rather than the mirrors holding source code, I ran a <tt>make fetch-recursive</tt>
for each of the packages (downloading source code for the package and
all of its dependencies) first and only timed the builds.
</p><p>
All told, the Graviton 3 is a very nice improvement over the Graviton 2:
With the exception of <tt>sha256</tt> — which, at 1.2 GB/s, is
likely more than fast enough already — we consistently see a CPU
speedup of between 30% and 45%.  I look forward to moving some of my
workloads across to Graviton 3 based instances! 
</p>



<p><a href="https://disqus.com">blog comments powered by <span>Disqus</span></a>
</p></div></div>
  </body>
</html>
