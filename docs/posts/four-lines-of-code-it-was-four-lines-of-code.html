<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://boston.conman.org/2024/06/30.1">Original</a>
    <h1>Four lines of code it was four lines of code</h1>
    
    <div id="readability-page-1" class="page"><div id="content">

<!-- google_ad_section_start --> <!-- Hey, it can't hurt! -->
<h2><a name="2024-06-30" href="https://boston.conman.org/2024/06/30">Sunday, June 30, 2024</a></h2>

<h3><a rel="bookmark" name="2024-06-30.1" href="https://boston.conman.org/2024/06/30.1">Four lines of code … it was four lines of code</a></h3>

<!-- debugging, profiling, Lua, C, networking protocols, gopher, Gemini, performance, system calls -->

<p><a href="https://boston.conman.org/2024/06/23.2">It was bugging me</a>.</p>

<p>I checked last night,
and found the following:</p>

<table>
  <caption>CPU utilization after a week</caption>
  <thead>
    <tr><th> </th> <th>CPU</th> <th>requests</th></tr>
  </thead>
  <tbody>
    <tr><td>gopher</td> <td>28:37</td> <td>8360</td></tr>
    <tr><td>gemini</td> <td>6:02</td> <td>24345</td></tr>
  </tbody>
</table>


<p>How can a <abbr title="Transmission Control Protocol">TCP</abbr> service take <em>more</em> time than a <abbr title="Transport Layer Security">TLS</abbr> service?
Especially when <abbr title="Transport Layer Security">TLS</abbr> <em>runs</em> over <abbr title="Transmission Control Protocol">TCP</abbr>?
And <abbr title="Transport Layer Security">TLS</abbr> generates <em>six times</em> the packets than <abbr title="Transmission Control Protocol">TCP</abbr>?</p>

<p>There&#39;s some difference in how I handle <abbr title="Transmission Control Protocol">TCP</abbr> and <abbr title="Transport Layer Security">TLS</abbr> that&#39;s causing this.
Profiling the code didn&#39;t reveal much as my attempts kept showing that <a href="https://en.wikipedia.org/wiki/Gopher_(protocol)">gopher</a> should be using less CPU than <a href="https://geminiprotocol.net/">Gemini</a>,
so then it was just a matter of staring at code and thinking hard.</p>

<p>It wasn&#39;t easy.
Yes,
there are some differences between 
<a href="https://github.com/spc476/lua-conmanorg/blob/628992e0a63d062aeabfeb90fc6f524df4f6fd17/lua/nfl/tcp.lua">the <abbr title="Transmission Control Protocol">TCP</abbr> interface</a> and
<a href="https://github.com/spc476/lua-conmanorg/blob/628992e0a63d062aeabfeb90fc6f524df4f6fd17/lua/nfl/tls.lua">the <abbr title="Transport Layer Security">TLS</abbr> interface</a>,
so it was a matter of going through the code,
bringing them closer in implementation and seeing if that fixed things.
I would fix the code,
run a test,
see it not make a difference,
and try again.
Eventually,
I came across <a href="https://github.com/spc476/lua-conmanorg/blob/628992e0a63d062aeabfeb90fc6f524df4f6fd17/lua/nfl/tcp.lua#L72">this bit of code</a>:</p>

<pre title="Lua">-- ---------------------------------------------------------------------
-- It might be a bug *somewhere*, but on Linux, this is required to get
-- Unix domain sockets to work with the NFL driver.  There&#39;s a race
-- condition where writting data then calling close() may cause the
-- other side to receive no data.  This does NOT appoear to happen with
-- TCP sockets, but this doesn&#39;t hurt the TCP side in any case.
-- ---------------------------------------------------------------------
    
while self.__socket.sendqueue and ios.__socket.sendqueue &gt; 0 do
  nfl.SOCKETS:update(self.__socket,&#39;w&#39;)
  coroutine.yield()
end
</pre>


<p>This bit of code wasn&#39;t in the <abbr title="Transport Layer Security">TLS</abbr> implementation,
and as the comment says,
it “shouldn&#39;t” hurt the <abbr title="Transmission Control Protocol">TCP</abbr> path,
but hey,
it was only needed for local (or Unix) domain sockets to begin with,
so let me try removing that bit of code and run a test.</p>

<table>
  <caption>Test before removing the code, 275 requests; time in seconds</caption>
  <thead>
    <tr><th> </th> <th>CPU</th> <th>real</th> <th>user</th> <th>sys</th></tr>
  </thead>
  <tbody>
    <tr><td>gopher</td> <td>18</td> <td>46.726</td> <td>13.971</td> <td>4.059</td></tr>
    <tr><td>gemini</td> <td>4</td> <td>107.928</td> <td>3.951</td> <td>0.322</td></tr>
  </tbody>
</table>


<table>
  <caption>Test after removing the code, 275 requests; time in seconds</caption>
  <thead>
    <tr><th> </th> <th>CPU</th> <th>real </th> <th>user</th> <th>sys</th></tr>
  </thead>
  <tbody>
    <tr><td>gopher</td> <td>0</td> <td>52.403</td> <td>0.635</td> <td>0.185</td></tr>
    <tr><td>gemini</td> <td>4</td> <td>103.290</td> <td>3.957</td> <td>0.285</td></tr>
  </tbody>
</table>


<p><strong>THAT&#39;S</strong> more like it!</p>

<p>Now,
about that code … this is my best guess as to what was going on.</p>

<p>The <code>sendqueue</code> field is a Linux-only field,
so I&#39;m checking to see if it exists,
and then checking the value
(if only to avoid the “attempt to compare number with nil” Lua error on non-Linux systems).
This returns the number of bytes the kernel has yet to send,
so we switch the socket to trigger an event when we can write to it,
and yield.
Even worse,
the check isn&#39;t just a simple variable fetch,
but ends up being an <code>ioctl()</code> system call.
Twice!</p>

<p>Now the “write” event code:</p>

<pre title="Lua">if event.write then
  if #ios.__output &gt; 0 then
    local bytes,err = ios.__socket:send(nil,ios.__output)
    if err == 0 then
      ios.__wbytes = ios.__wbytes + bytes
      ios.__output = ios.__output:sub(bytes + 1,-1)
    else
      syslog(&#39;error&#39;,&#34;socket:send() = %s&#34;,errno[err])
      nfl.SOCKETS:remove(ios.__socket)
      nfl.schedule(ios.__co,false,errno[err],err)
    end
  end
  
  if #ios.__output == 0 then
    nfl.SOCKETS:update(ios.__socket,&#39;r&#39;)
    nfl.schedule(ios.__co,true)
  end
end
</pre>


<p>There&#39;s probably no data to be sent (<code>ios.__output</code> is empty) so we immediately switch the socket back to trigger for readability,
then resume the coroutine handling the socket.
It goes back to the <code>while</code> loop,
setting the socket back to trigger on writability,
and kept bouncing like that until the kernel buffer had been sent.</p>

<p>As I wrote,
this fixed an issue I had with local domain sockets—it wasn&#39;t an issue with an <abbr title="Internet Protocol">IP</abbr> socket,
and in fact,
was the wrong thing to do for an <abbr title="Internet Protocol">IP</abbr> socket.</p>

<p>And as it is with these types of bugs,
finding the root cause is not trivial,
but the fix almost always is.</p>

<hr/>

<h4>Discussions about this entry</h4>

<ul>
<li><a href="https://lobste.rs/s/myfkbt">Four lines of code … it was four lines of code | Lobsters</a></li>
<li><a href="https://news.ycombinator.com/item?id=40842275">Four lines of code it was four lines of code | Hacker News</a></li>

</ul>


<!-- google_ad_section_end -->
</div><div id="lawyer">

        <p>You have my permission to link freely to any entry here.  Go
        ahead, I won&#39;t bite.  I promise.</p>
        
        <p>The dates are the permanent links to that day&#39;s entries (or
        entry, if there is only one entry).  The titles are the permanent
        links to <em>that</em> entry only.  The format for the links are
        simple: Start with the base link for this site: <a class="page" href="https://boston.conman.org/">https://boston.conman.org/</a>, then add the date you are
        interested in, say <a href="https://boston.conman.org/2000/08/01">2000/08/01</a>,
        so that would make the final <abbr title="Uniform Resource
        Locator">URL</abbr>:</p>
        
        <p><a class="page" href="https://boston.conman.org/2000/08/01">https://boston.conman.org/2000/08/01</a></p>
        
        <p>You can also specify the entire month by leaving off the day
        portion.  You can even select <a class="page" href="https://boston.conman.org/about/technical.html">an arbitrary portion of time.</a></p>
        
        <p>You may also note subtle shading of the links and that&#39;s
        intentional: the “closer” the link is (relative to the
        page) the “brighter” it appears.  It&#39;s an experiment in
        using color shading to denote the distance a link is from here.  If
        you don&#39;t notice it, don&#39;t worry; it&#39;s not all <em>that</em>
        important.</p>
        
        <p>It is assumed that every brand name, slogan, corporate name,
        symbol, design element, et cetera mentioned in these pages is a
        protected and/or trademarked entity, the sole property of its
        owner(s), and acknowledgement of this status is implied.</p>
        
</div></div>
  </body>
</html>
