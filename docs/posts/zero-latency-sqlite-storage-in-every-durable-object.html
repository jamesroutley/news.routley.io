<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://simonwillison.net/2024/Oct/13/zero-latency-sqlite-storage-in-every-durable-object/">Original</a>
    <h1>Zero-latency SQLite storage in every Durable Object</h1>
    
    <div id="readability-page-1" class="page"><div>



<p><strong><a href="https://blog.cloudflare.com/sqlite-in-durable-objects/">Zero-latency SQLite storage in every Durable Object</a></strong> (<a href="https://lobste.rs/s/kjx2vk/zero_latency_sqlite_storage_every" title="lobste.rs">via</a>) Kenton Varda introduces the next iteration of Cloudflare&#39;s <a href="https://developers.cloudflare.com/durable-objects/">Durable Object</a> platform, which recently upgraded from a key/value store to a full relational system based on SQLite.</p>
<p>For useful background on the first version of Durable Objects take a look at <a href="https://digest.browsertech.com/archive/browsertech-digest-cloudflares-durable/">Cloudflare&#39;s durable multiplayer moat</a> by Paul Butler, who digs into its popularity for building WebSocket-based realtime collaborative applications.</p>
<p>The new SQLite-backed Durable Objects is a fascinating piece of distributed system design, which advocates for a really interesting way to architect a large scale application.</p>
<p>The key idea behind Durable Objects is to colocate application logic with the data it operates on. A Durable Object comprises code that executes on the same physical host as the SQLite database that it uses, resulting in blazingly fast read and write performance.</p>
<p>How could this work at scale?</p>
<blockquote>
<p>A single object is inherently limited in throughput since it runs on a single thread of a single machine. To handle more traffic, you create more objects. This is easiest when different objects can handle different logical units of state (like different documents, different users, or different &#34;shards&#34; of a database), where each unit of state has low enough traffic to be handled by a single object</p>
</blockquote>
<p>Kenton presents the example of a flight booking system, where each flight can map to a dedicated Durable Object with its own SQLite database - thousands of fresh databases per airline per day.</p>
<p>Each DO has a unique name, and Cloudflare&#39;s network then handles routing requests to that object wherever it might live on their global network.</p>
<p>The technical details are fascinating. Inspired by <a href="https://litestream.io/">Litestream</a>, each DO constantly streams a sequence of WAL entries to object storage - batched every 16MB or every ten seconds. This also enables point-in-time recovery for up to 30 days through replaying those logged transactions.</p>
<p>To ensure durability within that ten second window, writes are also forwarded to five replicas in separate nearby data centers as soon as they commit, and the write is only acknowledged once three of them have confirmed it.</p>
<p>The JavaScript API design is interesting too: it&#39;s blocking rather than async, because the whole point of the design is to provide fast single threaded persistence operations:</p>
<div><pre><span>let</span> <span>docs</span> <span>=</span> <span>sql</span><span>.</span><span>exec</span><span>(</span><span>`</span>
<span>  SELECT title, authorId FROM documents</span>
<span>  ORDER BY lastModified DESC</span>
<span>  LIMIT 100</span>
<span>`</span><span>)</span><span>.</span><span>toArray</span><span>(</span><span>)</span><span>;</span>

<span>for</span> <span>(</span><span>let</span> <span>doc</span> <span>of</span> <span>docs</span><span>)</span> <span>{</span>
  <span>doc</span><span>.</span><span>authorName</span> <span>=</span> <span>sql</span><span>.</span><span>exec</span><span>(</span>
    <span>&#34;SELECT name FROM users WHERE id = ?&#34;</span><span>,</span>
    <span>doc</span><span>.</span><span>authorId</span><span>)</span><span>.</span><span>one</span><span>(</span><span>)</span><span>.</span><span>name</span><span>;</span>
<span>}</span></pre></div>

<p>This one of their examples deliberately exhibits the N+1 query pattern, because that&#39;s something SQLite is <a href="https://www.sqlite.org/np1queryprob.html">uniquely well suited to handling</a>.</p>
<p>The system underlying Durable Objects is called Storage Relay Service, and it&#39;s been powering Cloudflare&#39;s existing-but-different <a href="https://developers.cloudflare.com/d1/">D1 SQLite system</a> for over a year.</p>
<p>I was curious as to where the objects are created. <a href="https://developers.cloudflare.com/durable-objects/reference/data-location/#provide-a-location-hint">According to this</a> (via <a href="https://news.ycombinator.com/item?id=41832547#41832812">Hacker News</a>):</p>
<blockquote>
<p>Durable Objects do not currently change locations after they are created. By default, a Durable Object is instantiated in a data center close to where the initial <code>get()</code> request is made. [...] To manually create Durable Objects in another location, provide an optional <code>locationHint</code> parameter to <code>get()</code>.</p>
</blockquote>
<p>And in a footnote:</p>
<blockquote>
<p>Dynamic relocation of existing Durable Objects is planned for the future.</p>
</blockquote>
<p><a href="https://where.durableobjects.live/">where.durableobjects.live</a> is a neat site that tracks where in the Cloudflare network DOs are created - I just visited it and it said:</p>
<blockquote>
<p>This page tracks where new Durable Objects are created; for example, when you loaded this page from <strong>Half Moon Bay</strong>, a worker in <strong>San Jose, California, United States (SJC)</strong> created a durable object in <strong>San Jose, California, United States (SJC)</strong>.</p>
</blockquote>
<p><img alt="Where Durable Objects Live.    Created by the wonderful Jed Schmidt, and now maintained with ❤️ by Alastair. Source code available on Github.    Cloudflare Durable Objects are a novel approach to stateful compute based on Cloudflare Workers. They aim to locate both compute and state closest to end users.    This page tracks where new Durable Objects are created; for example, when you loaded this page from Half Moon Bay, a worker in San Jose, California, United States (SJC) created a durable object in Los Angeles, California, United States (LAX).    Currently, Durable Objects are available in 11.35% of Cloudflare PoPs.    To keep data fresh, this application is constantly creating/destroying new Durable Objects around the world. In the last hour, 394,046 Durable Objects have been created(and subsequently destroyed), FOR SCIENCE!    And a map of the world showing lots of dots." src="https://static.simonwillison.net/static/2024/where-durable-objects.jpg"/></p>



</div></div>
  </body>
</html>
