<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.hellofresh.com/recipes-and-generative-ai-6d74a107860c?gi=86e12b1a8c6d">Original</a>
    <h1>Food and Generative AI</h1>
    
    <div id="readability-page-1" class="page"><div><div><div><div><div><div><div><div><div><a href="https://medium.com/@hasnain3257" rel="noopener follow"><div><div aria-hidden="false"><div><div><p><img alt="Hasnain Raza" src="https://miro.medium.com/v2/resize:fill:88:88/1*wyu7-IRBv98Hx4755ZEFqA.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/></p></div></div></div></div></a><a href="https://engineering.hellofresh.com" rel="noopener  ugc nofollow"><div><div><div aria-hidden="false"><div><div><p><img alt="HelloTech" src="https://miro.medium.com/v2/resize:fill:48:48/1*21bfFIjN4ybVTEpqQURdiw.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto"/></p></div></div></div></div></div></a></div></div></div></div></div></div></div><p id="4365"><em>Disclaimer: HelloFresh does not currently use generative AI models anywhere in the recipe creation pipeline. Everything in this article is purely research and exploration.</em></p><p id="b3de">Our HelloFresh menus are created by local recipe developers who carefully curate the meal selection taking into consideration local preferences and seasonal ingredients. Our core value is to listen to our customers and use their feedback to continually optimise our service and develop new recipes.</p></div></div><div><div><p id="70f0">If a recipe is suboptimal, we lose customer satisfaction, time and revenue in refining it. How might one go about tackling these challenges? We’re going to explore one way in this blog: generative AI — more specifically: generative language models.</p><p id="dcad">We will explore how training language models on the order of ~1M parameters can be a relatively easy task, generating models that are fit for purpose, are not costly to train or host and can run in realtime on CPUs without any need for heavy investment in infrastructure or setup, and have a significantly lower risk for hallucinations since the vocabulary (“action space”) is limited to the culinary domain. These are some substantial advantages compared to large language models which have parameters on the scale of billions.</p><p id="f365"><strong>Generative AI for Recipes?</strong></p><p id="6729">The idea of AI generated food isn’t new. You can log into ChatGPT now and ask it to give you an idea of what to cook, or give it a list of ingredients and tell you what to make. It might generate something that tastes great, or not. But these are not necessarily aligned to the HelloFresh brand, style, ingredients or recipe philosophy.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-WC1lI0O4ShXGrJBHs0H2Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*-WC1lI0O4ShXGrJBHs0H2Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*-WC1lI0O4ShXGrJBHs0H2Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*-WC1lI0O4ShXGrJBHs0H2Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*-WC1lI0O4ShXGrJBHs0H2Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*-WC1lI0O4ShXGrJBHs0H2Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*-WC1lI0O4ShXGrJBHs0H2Q.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*-WC1lI0O4ShXGrJBHs0H2Q.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="454" loading="eager" role="presentation"/></picture></div></div><figcaption>ChatGPT’s version of a “Teriyaki Chicken” recipe (full recipe not shown). Not necessarily aligned to the HelloFresh brand, assortment, style or flavour profile. It also lacks the actual creation, refinement and testing by a chef — the much needed “human touch”.</figcaption></figure><p id="8576">In this blog post, we will specifically explore the creation of recipe ideas (titles or headlines, no full recipes) through a language model that conforms to HelloFresh’s business domain and style via some special prompts. Noticeably, we will not explore “large” (billions of parameters large) language models for this task, but a “tiny” (hundreds of thousands of parameters large) language model.</p><p id="6382"><strong>Why not use LLMs for this purpose?</strong></p><p id="1e81">This is a good question, if ChatGPT can already give you ideas about what to cook, why not use the API? Or self host an open source LLM? Well there are multiple reasons why:</p><ol><li id="05cd">These pre-trained LLMs may not conform to the HelloFresh brand, guidelines, style, ingredients, taste profile or other constraints without significant prompt engineering or fine-tuning.</li><li id="89ad">Hosting and fine-tuning LLMs for such a specific and simple machine learning problem may be overkill, especially in terms of costs and time for experimentation. It may make sense later though.</li><li id="8e1f">Using APIs (like ChatGPT) brings concerns around pricing, handling of PII, and model tuning . A small internally trained language model doesn’t have the same drawbacks.</li><li id="a8f2">Some of the licenses of open source LLMs and APIs don’t allow for commercial use.</li><li id="0650">Exploration on how much of current LLM ideas can be brought to tinier language models for our niche language domain.</li></ol><p id="8d22">With that out of the way, let’s start by understanding language modelling.</p><p id="b6ed"><strong>Language Modelling</strong></p><p id="4d8b">Language modelling primarily refers to one specific task in machine learning. It is the task of modelling the probability distribution of next words (or tokens) given the current and previous words (or token).</p><p id="903c">A token simply refers to the unit of language we choose to work with (characters of the alphabet, words, sub-words, parts of sentences etc are all valid “tokenisations”).</p><p id="e01e">The probability of a sentence which is composed of 3 tokens: t₁, t₂, t₃ can then be expressed as:</p><p id="d29f"><strong><em>P(t₁, t₂, t₃) = P(t₁)P(t₂|t₁)P(t₃|t₁, t₂)</em></strong></p><p id="0234">Nowadays, the most common way to model these probability distributions is via some neural network (or function) “<strong><em>Fₚ</em></strong>”, where “<strong><em>p</em></strong>” are the function’s parameters. This can be expressed as:</p><p id="fd1b"><strong><em>P(t₂ | t₁) = Fₚ(t₁)</em></strong></p><p id="fb5e">or more generally as:</p><p id="b4ef"><strong>P(tₙ₊₁ | tₙ, tₙ₋₁, tₙ₋₂, …, t₁) = Fₚ(tₙ, tₙ₋₁, tₙ₋₂, …, t₁)</strong></p><p id="f2e4">The idea is that the set of parameters “<strong><em>p</em></strong>” need to be tuned such that these probabilities are maximised over the entire training corpus, which in our case is HelloFresh recipe titles.</p><p id="9f03">The function <strong><em>F</em></strong> these days is usually some variation of a <em>transformer decoder</em>, where <strong><em>p</em></strong> are the billions (in case of large language models) of parameters that need to be tuned to fit this distribution.</p><h2 id="0453">Transformers:</h2><p id="2226">The transformer architecture was initially introduced in the paper “<a href="https://arxiv.org/abs/1706.03762" rel="noopener ugc nofollow" target="_blank">Attention is all you need</a>”. The paper details an encoder-decoder architecture where the encoder encodes information from one domain, while the decoder tries to use this information to generate most probable tokens in another domain. This can be highly useful for tasks like language translation, where you might want to encode a french sentence, and use that to inform the translation to english in the decoder.</p><blockquote><p id="379f"><strong>Attention</strong> refers to this model basically applying different weights to different tokens or features, such that higher weights mean more “attention” is paid to those tokens (this is a very crude but sufficient explanation of attention).</p></blockquote><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p_EjLnjHGFAENqD2I8Z_rw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*p_EjLnjHGFAENqD2I8Z_rw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*p_EjLnjHGFAENqD2I8Z_rw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*p_EjLnjHGFAENqD2I8Z_rw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*p_EjLnjHGFAENqD2I8Z_rw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*p_EjLnjHGFAENqD2I8Z_rw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*p_EjLnjHGFAENqD2I8Z_rw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*p_EjLnjHGFAENqD2I8Z_rw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="540" loading="lazy" role="presentation"/></picture></div></div><figcaption>The original transformer architecture proposed in the paper “Attention is all you need” by Vaswani et al. The block on the left is generally referred to as the “encoder”, while the block on the right is a “decoder”.</figcaption></figure><p id="65f0">Observant readers will realize here that encoder-decoder architectures aren’t necessarily suitable for our “next token prediction” task, since we aren’t trying to do something like translation. This is where the concepts of causal self attention and GPTs (generative pre-trained transformers) comes in.</p><p id="cdca">Causal self attention is the task of applying attention across a series of tokens, without letting future tokens affect the attention on the current token. This is precisely how we’ve formulated the language modeling task above (Probability of <em>“tᵢ”</em> is dependent on all tokens that came before and up to the iᵗʰ token but not after the iᵗʰ token).</p><p id="c64c">It turns out that this is a really appropriate task for the decoder in the transformer architecture. This combined with huge amounts of language data scraped from the internet, forms the basis for pre-training these generative transformers (this is literally where the name GPT comes from). This turns out to be a very powerful scheme for learning a robust language model, and this idea is explored in the “<a href="https://cdn.openai.com/research-covers/language-unsupervised/language_understanding_paper.pdf" rel="noopener ugc nofollow" target="_blank">GPT-1</a>” and “<a href="https://d4mucfpksywv.cloudfront.net/better-language-models/language-models.pdf" rel="noopener ugc nofollow" target="_blank">GPT-2</a>” papers by OpenAI.</p><p id="7441">The GPT architecture we choose to train for recipe titles corresponds to the GPT-2 architecture. Curious readers can also look at the original codebase of <a href="https://github.com/openai/gpt-2/blob/master/src/model.py#L147" rel="noopener ugc nofollow" target="_blank">GPT-2</a>.</p><figure><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 1100w, https://miro.medium.com/v2/resize:fit:338/format:webp/1*cPTgdpUOHRuB9IUA09nM5A.png 338w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 169px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*cPTgdpUOHRuB9IUA09nM5A.png 640w, https://miro.medium.com/v2/resize:fit:720/1*cPTgdpUOHRuB9IUA09nM5A.png 720w, https://miro.medium.com/v2/resize:fit:750/1*cPTgdpUOHRuB9IUA09nM5A.png 750w, https://miro.medium.com/v2/resize:fit:786/1*cPTgdpUOHRuB9IUA09nM5A.png 786w, https://miro.medium.com/v2/resize:fit:828/1*cPTgdpUOHRuB9IUA09nM5A.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*cPTgdpUOHRuB9IUA09nM5A.png 1100w, https://miro.medium.com/v2/resize:fit:338/1*cPTgdpUOHRuB9IUA09nM5A.png 338w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 169px"/><img alt="" width="169" height="800" loading="lazy" role="presentation"/></picture></div><figcaption>Modified GPT-2 decoder without positional encoding used in this post.</figcaption></figure><p id="7ecf">For our version of the GPT, we remove the positional encodings — this is heavily motivated by the findings from “<a href="https://arxiv.org/abs/2203.16634" rel="noopener ugc nofollow" target="_blank">Transformer language models without positional encoding still learn positional information</a>” by Haviv et al. The paper shows that for small context lengths, transformers with and without positional encodings perform almost identically. This is great for us, since the average number of tokens in our recipe titles is about 60.</p><h2 id="4785">Data Collection and Preprocessing:</h2><p id="463e">HelloFresh has been around for almost 12 years now and today operates 7 brands across 18 markets. This means that it has a significant database of customer approved recipe data — across countries, cuisines, dietary preferences, food trends and regional ingredients, for now we used only English language recipes.</p><p id="9f43">This is an encouraging sign, since it means we have data that is diverse, a good ingredient for data required for machine learning. HelloFresh believes in data driven decision making, to enable this across the company, it has implemented a “<a rel="noopener ugc nofollow" target="_blank" href="https://juicetin.bearblog.dev/hellofresh-journey-to-the-data-mesh-7fe590f26bda">data mesh</a>”, enabling anyone to consume or produce most types of data. This works to our advantage as data collection is simply a matter of writing one query.</p><p id="a57a">After preprocessing this data, we get recipe titles that have been standardised to look like this:</p><pre><span id="1556">balsamic glazed dutch carrots with thyme  and  pepitas</span></pre><p id="a728">For training, we need to add some special tokens into this recipe title. These tokens serve as prompts to the model. They are listed as:</p><ol><li id="5c93">“[CUI]” — represents the start of a cuisine.</li><li id="fc32">“[PROT]” — represents the primary protein in the recipe</li><li id="da72">“[SOT]” — represents the start of the recipe title.</li><li id="f682">“[EOT]” — represents the end of the title.</li></ol><p id="61cb">So the recipe titles are transformed to look like:</p><pre><span id="ab60">[CUI] fusion [PROT] none [SOT] balsamic glazed dutch carrots with thyme and pepitas [EOT]</span></pre><p id="252e">This representation helps us to be able to generate recipe titles in many ways. For example, if we just wanted a recipe title without caring about the cuisine or protein, we can feed in the “[SOT]” token to the model and wait for the “[EOT]” token. Similarly, if we wanted to condition the generation of the title on some protein and cuisine, we could do: “[CUI] Japanese [PROT] chicken [SOT]” and wait for the “[EOT]” to get a Japanese recipe that uses chicken. This works because of the conditional probabilities explained above:</p><p id="4238"><strong><em>P(t₆ | t₁=[CUI], t₂=Japanese, t₃=[PROT], t₄=chicken, t₅=[SOT]) = Fₚ(t₁=[CUI], t₂=Japanese, t₃=[PROT], t₄=chicken, t₅=[SOT])</em></strong></p><h2 id="e633">Let’s train a model:</h2><p id="50da">The process of training using the tokenized recipe title involves a data loader that generates two samples. The first is the input sequence to the model, and the second is the sequence that the model should predict.</p><p id="5c8f">Training on the corpus of recipes from HelloFresh, we can visualize the loss going down and how the model’s generation performance evolves through the course of training.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zdTBo-cD2aDiggXdPBX7gQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*zdTBo-cD2aDiggXdPBX7gQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*zdTBo-cD2aDiggXdPBX7gQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*zdTBo-cD2aDiggXdPBX7gQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*zdTBo-cD2aDiggXdPBX7gQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*zdTBo-cD2aDiggXdPBX7gQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*zdTBo-cD2aDiggXdPBX7gQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*zdTBo-cD2aDiggXdPBX7gQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="232" loading="lazy" role="presentation"/></picture></div></div><figcaption>The training and validation negative log likelihood error (lower is better).</figcaption></figure><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VY8zkLk_69bPYuvAOFVtuw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*VY8zkLk_69bPYuvAOFVtuw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*VY8zkLk_69bPYuvAOFVtuw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*VY8zkLk_69bPYuvAOFVtuw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*VY8zkLk_69bPYuvAOFVtuw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*VY8zkLk_69bPYuvAOFVtuw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*VY8zkLk_69bPYuvAOFVtuw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*VY8zkLk_69bPYuvAOFVtuw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="232" loading="lazy" role="presentation"/></picture></div></div><figcaption>The training and validation perplexity (lower is better).</figcaption></figure><p id="f82c">The training progresses as expected, with some overfitting which we don’t investigate in this blog. Now let’s see how the generation quality evolves over the course of training:</p><p id="a56c">At Epoch 0 (One pass of training over the entire data):</p><pre><span id="8039">Prompt: [CUI]</span></pre><p id="d7a7">Already not bad, by the time we reach Epoch 39 (40 passes over the training data):</p><pre><span id="7d3b">Prompt: [CUI]</span></pre><p id="3fbc">This looks reasonable, so we integrate this into an app to make it usable and build some extra features to help recipe ideation.</p><h2 id="0066">Streamlit App:</h2><p id="4551">We use <a href="https://streamlit.io/" rel="noopener ugc nofollow" target="_blank">Streamlit</a> to quickly setup an app that uses the model to generate recipe titles.</p></div></div><div><div><p id="3325">Alongside it, the app also uses the embeddings generated from the model to find existing HelloFresh recipes that are closest to the generated recipe. This enables us to figure out how “novel” a generated recipe title is. For these “closest” recipes, we also show some metrics (if available) like: what the recipe rating is, last time it was on the menu and cost. This may help us to know if this generated recipe is a good, novel enough candidate to iterate on.</p><figure><div role="button" tabindex="0"><div><picture><source srcset="https://miro.medium.com/v2/resize:fit:640/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LO6W6gl8nxT0N8lIR1pp2w.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcset="https://miro.medium.com/v2/resize:fit:640/1*LO6W6gl8nxT0N8lIR1pp2w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*LO6W6gl8nxT0N8lIR1pp2w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*LO6W6gl8nxT0N8lIR1pp2w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*LO6W6gl8nxT0N8lIR1pp2w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*LO6W6gl8nxT0N8lIR1pp2w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*LO6W6gl8nxT0N8lIR1pp2w.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*LO6W6gl8nxT0N8lIR1pp2w.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" width="700" height="395" loading="eager" role="presentation"/></picture></div></div><figcaption>Clicking on a recipe shows it’s closest existing neighbours along with their available metrics</figcaption></figure><h2 id="979e">Conclusion</h2><p id="e474">There we have it, a fast novel recipe idea generator for HelloFresh recipes. The tool is powered by a “tiny” GPT model running in Streamlit, running in near real-time on a CPU, without any pre-training. The performance is sufficient even without pre-training or using a larger model.</p><p id="ac9a">The use of “similar” recipes to judge performance can be improved. We will need to investigate if reinforcement learning can be applied to learn policies to generate titles that maximize (or minimize) certain metrics (like recipe ratings, to generate only recipes that are likely to score high with customers) with applications of papers like<a href="https://arxiv.org/abs/2305.18290" rel="noopener ugc nofollow" target="_blank"> Direct Preference Optimisation</a> or<a href="https://arxiv.org/abs/1707.06347" rel="noopener ugc nofollow" target="_blank"> Proximal Policy Optimisation</a> for this purpose. Alongside there will be more work into deep learning for recipe translations, generative AI for recipe images, title and steps generation and curation. These will be discussed in possible follow ups to this post.</p></div></div></div>
  </body>
</html>
