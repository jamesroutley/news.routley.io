<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://wasmer.io/posts/wasmer-takes-webassembly-libraries-manistream-with-wai">Original</a>
    <h1>Wasmer takes WebAssembly libraries mainstream with WAI</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Integrating with other languages and distributing binaries has always raised the WebAssembly&#39;s barrier to entry for the average developer, and at Wasmer our goal is to make trivial creating universal libraries that work anywhere.</p>
<p>Today, we are happy to announce <a href="https://github.com/wasmerio/wasmer-pack">Wasmer Pack</a>, a tool which integrates with <a href="https://wapm.io/">the WebAssembly Package Manager</a> and <a href="https://github.com/wasmerio/wai">WebAssembly Interfaces</a> (&#34;WAI&#34;) to create packages that can be imported from other languages.</p>
<p><img src="https://wasmer.io/images/blog/use-wai.png" alt="/images/blog/use-wai.png"/></p>
<blockquote>
<p><strong>Note:</strong> WAI builds on top of <a href="https://github.com/WebAssembly/interface-types/blob/main/proposals/interface-types/Explainer.md">the WebAssembly Interface Types specification</a> and its first working implementation, <code>wit-bindgen</code>. Unfortunately, the maintainers behind <code>wit-bindgen</code> <a href="https://github.com/bytecodealliance/wit-bindgen/issues/306">were reluctant</a> to allow <a href="https://github.com/bytecodealliance/wit-bindgen/pull/173">integration of Wasmer</a> upstream, so we&#39;ve forked the project under a new name.</p>
<p>A key difference between WAI and <code>wit-bindgen</code> is the focus on stability - people should be able to start using WAI right now.</p>
</blockquote>
<p>The WAI addition to the <a href="https://wapm.io/">WebAssembly Package Manager</a> streamlines the way developers use WebAssembly in their applications by automatically generating installable packages for your language of choice.</p>
<p>In fact, you can see it in action right now with <a href="https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm">the <code>vscode-wasm</code> plugin</a> which uses the automatically generated <a href="https://wapm.io/wasmer/wabt">wabt WAI bindings</a>, used by more than 94 thousand developers worldwide!</p>
<p><em>WAPM is not tied to just the WAI format though, we are working to allow integrating <strong>any kind of Wasm bindings</strong> into the Package Manager (such as <a href="https://extism.org/">Extism</a>)... if you maintain a binding format we want to hear from you!</em></p>
<h2 id="user-content-how-do-i-create-a-universal-webassembly-library-with-rust-and-wai">How Do I Create a Universal WebAssembly Library with Rust and WAI?</h2>
<p>Everything revolves around WAI files.</p>
<p>These define the <strong>W</strong>eb<strong>A</strong>ssembly <strong>I</strong>nterfaces your library will expose, and from there our tooling will generate some glue code that makes it easier to implement.</p>
<p>First, create a new Rust project and add <a href="https://lib.rs/wai-bindgen-rust">the <code>wai-bindgen-rust</code> crate</a> as a dependency.</p>
<pre><code>$ cargo new --lib tutorial-01
$ cd tutorial-01
$ cargo add wai-bindgen-rust
</code></pre>
<p>Now, let&#39;s define a WAI file that lets us add two floating point numbers.</p>
<pre><code>// calculator.wai

/// Add two numbers.
add: func(a: float32, b: float32) -&gt; float32
</code></pre>
<p>We can use the <code>wai_bindgen_rust::export!()</code> macro to &#34;export&#34; this interface (i.e. make it available to some host application).</p>
<pre><code><span>// src/lib.rs</span>

<span>// generate the WAI glue code under the `calculator` module</span>
wai_bindgen_rust::export!(<span>&#34;calculator.wai&#34;</span>);

<span>// Create a type to attach our functionalty to</span>
<span><span>struct</span> <span>Calculator</span></span>;

<span>// Implement the trait generated by our glue code</span>
<span>impl</span> crate::calculator::Calculator <span>for</span> Calculator {
	<span><span>fn</span> <span>add</span></span>(a: <span>f32</span>, b: <span>f32</span>) -&gt; <span>f32</span> { a + b }
}
</code></pre>
<p>ðŸ’¡ You can use <code>cargo expand</code> to see the generated code and the <code>Calculator</code> trait&#39;s definition (<code>cargo install cargo-expand</code>).</p>
<h3 id="user-content-lets-publish-it">Letâ€™s publish it!</h3>
<p>Publishing requires installing <code>wapm</code> with <a href="https://docs.wasmer.io/ecosystem/wapm/getting-started">the Wasmer installer</a> and the <a href="https://github.com/wasmerio/cargo-wapm"><code>cargo wapm</code></a>  helper installed (<code>cargo install cargo-wapm</code>). If you haven&#39;t already, make sure to run <code>wapm login</code> to log into your WAPM account (don&#39;t forget to <a href="https://wapm.io/signup">sign up</a> if you haven&#39;t already).</p>
<p>Now we&#39;re set up, we&#39;ll need to update <code>Cargo.toml</code> so this package can be published to WAPM.</p>
<pre><code><span># Cargo.toml</span>
<span>[package]</span>
<span>name</span> = <span>&#34;tutorial-01&#34;</span>
<span>version</span> = <span>&#34;0.1.0&#34;</span>
<span>description</span> = <span>&#34;A simple calculator&#34;</span>

<span>[package.metadata.wapm]</span>
<span>namespace</span> = <span>&#34;&lt;YOUR_USERNAME&gt;&#34;</span>  <span># The namespace to publish it to</span>
<span>abi</span> = <span>&#34;none&#34;</span> <span># How to compile the crate. &#34;none&#34; is &#34;wasm32-unknown-unknown&#34;</span>
<span>bindings</span> = { wai-version = <span>&#34;0.2.0&#34;</span>, exports = <span>&#34;calculator.wai&#34;</span> }</code></pre>
<p>Now we need to tell the Rust compiler to generate a <code>cdylib</code> (&#34;C-compatible
dynamic library&#34;). It&#39;s also a good idea to add the <code>rlib</code> crate type so
integration tests can import the library as a Rust dependency.</p>
<pre><code><span># Cargo.toml</span>
<span>[lib]</span>
<span>crate-type</span> = [<span>&#34;cdylib&#34;</span>, <span>&#34;rlib&#34;</span>]</code></pre>
<p>And publish!</p>
<pre><code><span>$</span><span> cargo wapm</span></code></pre>
<p><em>Note: WAI also works with other languages, such as C or C++. If you want to publish packages to WAPM with it, you will need to use <code>wapm publish</code> instead of <code>cargo wapm</code>.</em></p>
<h2 id="user-content-consuming-wapm-packages-in-your-codebase">Consuming WAPM Packages in your codebase</h2>
<p>Let&#39;s add this <code>wai/tutorial-01</code> package to a JavaScript project.</p>
<p>First, we&#39;ll need to create a new JavaScript package and add the <code>wai/tutorial-01</code> package as a dependency.</p>
<pre><code><span>$</span><span> wasmer add --yarn wai/tutorial-01</span></code></pre>
<p>This runs <code>yarn add</code> under the hood. Depending on the project, you might use the <code>--npm</code> flag to do <code>npm install</code> or <code>--pip</code> for <code>pip install</code>.</p>
<p>Now, let&#39;s create a script.</p>
<pre><code><span>import</span> { bindings } <span>from</span> <span>&#34;wai/tutorial-01&#34;</span>;

<span>async</span> <span><span>function</span> <span>main</span>(<span></span>) </span>{
	<span>const</span> calculator = <span>await</span> bindings.calculator();
	<span>const</span> four = calculator.add(<span>2</span>, <span>2</span>);
	<span>console</span>.log(<span>&#34;2 + 2 =&#34;</span>, four);
}

main();</code></pre>
<p>Or, if you want to do it in python:</p>
<pre><code><span>$</span><span> wasmer add --pip wai/tutorial-01</span></code></pre>
<pre><code><span>from</span> tutorial_01 <span>import</span> bindings

calculator = bindings.calculator()
print(<span>&#34;2+2 = &#34;</span>, calculator.add(<span>2.0</span>, <span>2.0</span>))</code></pre>
<h2 id="user-content-whats-next">What&#39;s Next?</h2>
<p>If you&#39;ve been hesitant to use WebAssembly because it&#39;s hard to get started, go ahead and check out <a href="https://wasmerio.github.io/wasmer-pack/user-docs/">our tutorial series</a>!</p>
<p>WAPM uses the <a href="https://github.com/wasmerio/wasmer-pack">Wasmer Pack</a> project to generate these native packages. Feel free to browse the source code, or create tickets on the issue tracker if you have any questions.</p>
<p>We&#39;d love to hear from projects looking to integrate WAPM packages into their own apps. If this sounds like you, reach out <a href="https://slack.wasmer.io/">on Slack</a>, by <a href="mailto:engineering@wasmer.io">email</a>, or the Wasmer Pack issue tracker, and we&#39;ll help you get started.</p>
</div></div></div>
  </body>
</html>
