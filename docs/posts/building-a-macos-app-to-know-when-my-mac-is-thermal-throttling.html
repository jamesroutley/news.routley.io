<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://stanislas.blog/2025/12/macos-thermal-throttling-app/">Original</a>
    <h1>Building a macOS app to know when my Mac is thermal throttling</h1>
    
    <div id="readability-page-1" class="page"><div id="main-content"><article><header><div><p><time datetime="2025-12-27 22:33:00.601 +0000 UTC">27 December 2025</time><span>¬∑</span><span>2204 words</span><span>¬∑</span><span title="Reading time">11 mins</span></p></div><div><picture><source srcset="https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_fd91f6e5cc3e5ff7.webp 330w,https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_b573e1e8b9b63ca7.webp 660w
,https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_57fe643193b6214a.webp 1024w
,https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_6d3c5a2fa9ef56d5.webp 1320w" sizes="100vw" type="image/webp"/><img width="1596" height="1100" data-zoom-src="https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle.png" src="https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_fa2e75ce3cb92b4b.png" srcset="https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_1215a78af35bc126.png 330w,https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_fa2e75ce3cb92b4b.png 660w
,https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_ba1d91e322f298e8.png 1024w
,https://stanislas.blog/2025/12/macos-thermal-throttling-app/mac-throttle_hu_1219593febb198bc.png 1320w" sizes="100vw"/></picture></div></header><section><div><p>This is the story about how I built <a href="https://github.com/angristan/MacThrottle" target="_blank" rel="noreferrer">MacThrottle</a>.</p><p>I‚Äôve been very happy with my M2 MacBook Air for the past few years. However, when using an external display, especially a very demanding one like a 4K 120Hz display, I‚Äôve noticed it started struggling more. Since it lacks fans, you can‚Äôt hear it struggling, but you can feel it as everything becomes very slow or unresponsive: that‚Äôs when thermal throttling kicks in.</p><p>I know it‚Äôs thermal throttling because I can see in iStat Menus that my CPU usage is 100% while the power usage in watts goes down.</p><p>It‚Äôs even more obvious with <a href="https://www.seense.com/menubarstats/mxpg/" target="_blank" rel="noreferrer">MX Power Gadget</a>: You can see the power usage and frequency of the performance core dropping, as usage keeps being 100%:</p><figure><img src="https://kracekumar.com/post/migrating-from-mypy-to-ty/mx-power-gadget-throttling.png" alt="MX Power Gadget"/></figure><p>I‚Äôve also hit thermal throttling with my work MacBook Pro. It‚Äôs the 14&#34; M4 Max variant, <a href="https://www.bestlaptop.deals/articles/m4-macbook-pros-ultimate-review-performance-power-efficiency-battery-life?utm_source=chatgpt.com#Sustained-Performance" target="_blank" rel="noreferrer">which is the worst variant</a> because the thermal envelope of the 14&#34; is too small for the max output for the M4 Max. On my previous 14&#34; M1 Pro MacBook Pro, I‚Äôve never even heard the fans in 3 years‚Ä¶</p><p>That being said, I still love Apple Silicon for the performance and power usage, it‚Äôs still a dramatic improvement over the Intel days. ü´∂</p><p>Anyway, I wanted to know: is there a way to tell if the Apple Silicon SoC is thermal throttling, that is not based on heuristics like in my screenshot?</p><h2 id="getting-the-thermal-state-programmatically">Getting the thermal state programmatically <span><a href="#getting-the-thermal-state-programmatically" aria-label="Anchor">#</a></span></h2><p>This was a wilder ride than I expected. It‚Äôs possible to know programmatically if the Mac is throttled, because macOS exposes this in various but inconsistent ways.</p><p>The approach that Apple recommends is to use <a href="https://developer.apple.com/documentation/foundation/processinfo/thermalstate-swift.enum" target="_blank" rel="noreferrer"><code>ProcessInfo.thermalState</code></a> from <code>Foundation</code>:</p><div><pre tabindex="0"><code data-lang="swift"><span><span>‚ûú  <span>~</span> swift <span>-</span>e &#39;<span>import</span> Foundation; print([<span>&#34;nominal&#34;</span>, <span>&#34;fair&#34;</span>, <span>&#34;serious&#34;</span>, <span>&#34;critical&#34;</span>][ProcessInfo.processInfo.thermalState.rawValue])&#39;
</span></span><span><span>nominal
</span></span></code></pre></div><p>Sounds good, right? However, I knew that another tool could provide this information, though it needed root: <a href="https://ss64.com/mac/powermetrics.html" target="_blank" rel="noreferrer"><code>powermetrics</code></a>.</p><div><pre tabindex="0"><code data-lang="sh"><span><span>‚ûú  ~ sudo powermetrics -s thermal
</span></span><span><span>
</span></span><span><span>Password:
</span></span><span><span>Machine model: Mac14,2
</span></span><span><span>OS version: 25B78
</span></span><span><span>Boot arguments:
</span></span><span><span>Boot time: Sun Nov <span>23</span> 10:19:29 <span>2025</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>*** Sampled system activity <span>(</span>Wed Dec <span>17</span> 09:48:34 <span>2025</span> +0100<span>)</span> <span>(</span>5001.07ms elapsed<span>)</span> ***
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>**** Thermal pressure ****
</span></span><span><span>
</span></span><span><span>Current pressure level: Nominal
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>*** Sampled system activity <span>(</span>Wed Dec <span>17</span> 09:48:39 <span>2025</span> +0100<span>)</span> <span>(</span>5001.25ms elapsed<span>)</span> ***
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span>**** Thermal pressure ****
</span></span><span><span>
</span></span><span><span>Current pressure level: Nominal
</span></span></code></pre></div><p>(yes the output has that many newlines)</p><p>Both report the pressure level to be ‚Äúnominal‚Äù, they must be the same‚Ä¶right?</p><p>After running a few stress tests <code>stress-ng --cpu 0 -t 600</code>, I started to see the two values diverge!</p><p>For some reason, the granularity is different between <code>ProcessInfo.thermalState</code> and <code>powermetrics</code>. They have a different amount of possible states and they don‚Äôt line up.</p><p>Here is my empirical experience:</p><table><thead><tr><th><code>ProcessInfo.thermalState</code></th><th><code>powermetrics</code></th></tr></thead><tbody><tr><td>nominal</td><td>nominal</td></tr><tr><td><strong>fair</strong></td><td><strong>moderate</strong></td></tr><tr><td><strong>fair</strong></td><td><strong>heavy</strong></td></tr></tbody></table><p>I never managed to hit these states, so I don‚Äôt know if they match, but they‚Äôre technically defined:</p><table><thead><tr><th><code>ProcessInfo.thermalState</code></th><th><code>powermetrics</code></th></tr></thead><tbody><tr><td>serious</td><td>trapping</td></tr><tr><td>critical</td><td>sleeping</td></tr></tbody></table><p>In practice, when my Mac starts getting hot, from the <code>powermetrics</code> perspective it goes into <code>moderate</code>, and when it starts throttling, it goes into <code>heavy</code>. The problem is that with <code>ProcessInfo</code>, both are covered by the <code>fair</code> state, so it‚Äôs not really useful to know when the Mac is <em>actually</em> throttling. ‚òπÔ∏è</p><p>I thought maybe this was an iOS vs macOS thing? But <a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/power_efficiency_guidelines_osx/RespondToThermalStateChanges.html" target="_blank" rel="noreferrer">Apple references it in the macOS docs</a> as well. Maybe it was more consistent on Intel Macs?</p><p>I stumbled upon <a href="https://dmaclach.medium.com/thermals-and-macos-c0db81062889" target="_blank" rel="noreferrer">this article</a> from Dave MacLachlan, a Googler working on Apple stuff, from 2020. I learned that there are other CLI tools to get thermal data, but they don‚Äôt seem to work on my Apple Silicon MacBook:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>‚ûú sudo thermal levels
</span></span><span><span>Thermal levels are unsupported on this machine.
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="sh"><span><span>‚ûú sudo pmset -g thermlog
</span></span><span><span>Note: No thermal warning level has been recorded
</span></span><span><span>Note: No performance warning level has been recorded
</span></span><span><span>Note: No CPU power status has been recorded
</span></span><span><span>^C
</span></span></code></pre></div><p>But the most interesting thing I learned is that the data <code>powermetrics</code> shows is actually coming from <code>thermald</code>. And <code>thermald</code> writes the current thermal pressure to the Darwin notification system (<code>notifyd</code>)!</p><div><pre tabindex="0"><code data-lang="sh"><span><span>‚ûú notifyutil -g com.apple.system.thermalpressurelevel
</span></span><span><span>
</span></span><span><span>com.apple.system.thermalpressurelevel <span>0</span>
</span></span></code></pre></div><p>The various levels are defined in <code>OSThermalNotification.h</code> according to the article. Indeed:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>‚ûú  ~ xcrun --sdk macosx --show-sdk-path
</span></span><span><span>/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX26.2.sdk
</span></span><span><span>‚ûú  ~ SDK<span>=</span><span>&#34;</span><span>$(</span>xcrun --sdk macosx --show-sdk-path<span>)</span><span>&#34;</span>
</span></span><span><span>‚ûú  ~ find <span>&#34;</span>$SDK<span>/usr/include&#34;</span> -name <span>&#39;OSThermalNotification.h&#39;</span>
</span></span><span><span>/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX26.2.sdk/usr/include/libkern/OSThermalNotification.h
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="c"><span><span>‚ûú  <span>~</span> head <span>-</span>n <span>52</span> <span>&#34;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX26.2.sdk/usr/include/libkern/OSThermalNotification.h&#34;</span>
</span></span><span><span><span>/*
</span></span></span><span><span><span> * Copyright (c) 2007 Apple Inc. All rights reserved.
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * @APPLE_LICENSE_HEADER_START@
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * This file contains Original Code and/or Modifications of Original Code
</span></span></span><span><span><span> * as defined in and that are subject to the Apple Public Source License
</span></span></span><span><span><span> * Version 2.0 (the &#39;License&#39;). You may not use this file except in
</span></span></span><span><span><span> * compliance with the License. Please obtain a copy of the License at
</span></span></span><span><span><span> * http://www.opensource.apple.com/apsl/ and read it before using this
</span></span></span><span><span><span> * file.
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * The Original Code and all software distributed under the License are
</span></span></span><span><span><span> * distributed on an &#39;AS IS&#39; basis, WITHOUT WARRANTY OF ANY KIND, EITHER
</span></span></span><span><span><span> * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
</span></span></span><span><span><span> * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
</span></span></span><span><span><span> * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
</span></span></span><span><span><span> * Please see the License for the specific language governing rights and
</span></span></span><span><span><span> * limitations under the License.
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * @APPLE_LICENSE_HEADER_END@
</span></span></span><span><span><span> */</span>
</span></span><span><span>
</span></span><span><span><span>#ifndef _OSTHERMALNOTIFICATION_H_
</span></span></span><span><span><span>#define _OSTHERMALNOTIFICATION_H_
</span></span></span><span><span>
</span></span><span><span><span>#include</span> <span>&lt;_bounds.h&gt;</span><span>
</span></span></span><span><span><span>#include</span> <span>&lt;sys/cdefs.h&gt;</span><span>
</span></span></span><span><span><span>#include</span> <span>&lt;Availability.h&gt;</span><span>
</span></span></span><span><span><span>#include</span> <span>&lt;TargetConditionals.h&gt;</span><span>
</span></span></span><span><span>
</span></span><span><span><span>_LIBC_SINGLE_BY_DEFAULT</span>()
</span></span><span><span>
</span></span><span><span><span>/*
</span></span></span><span><span><span>**  OSThermalNotification.h
</span></span></span><span><span><span>**
</span></span></span><span><span><span>**  Notification mechanism to alert registered tasks when device thermal conditions
</span></span></span><span><span><span>**  reach certain thresholds. Notifications are triggered in both directions
</span></span></span><span><span><span>**  so clients can manage their memory usage more and less aggressively.
</span></span></span><span><span><span>**
</span></span></span><span><span><span>*/</span>
</span></span><span><span>
</span></span><span><span>__BEGIN_DECLS
</span></span><span><span>
</span></span><span><span><span>/* Define pressure levels usable by OSThermalPressureLevel */</span>
</span></span><span><span><span>typedef</span> <span>enum</span> {
</span></span><span><span><span>#if TARGET_OS_OSX || TARGET_OS_MACCATALYST
</span></span></span><span><span>        kOSThermalPressureLevelNominal <span>=</span> <span>0</span>,
</span></span><span><span>        kOSThermalPressureLevelModerate,
</span></span><span><span>        kOSThermalPressureLevelHeavy,
</span></span><span><span>        kOSThermalPressureLevelTrapping,
</span></span><span><span>        kOSThermalPressureLevelSleeping
</span></span></code></pre></div><p>The funny thing is that <code>OSThermalNotification.h</code> is barely referenced anywhere, there are only three pages of Google results. <a href="https://bazel.googlesource.com/bazel/+/refs/heads/release-9.0.0-pre.20241023.1rc1/src/main/native/darwin/system_thermal_monitor_jni.cc" target="_blank" rel="noreferrer">It seems to be used in Bazel</a> for example. That post was a big help.</p><p>What‚Äôs great about this approach is that it doesn‚Äôt require root! I can subscribe to the notification system for the <code>com.apple.system.thermalpressurelevel</code> event to get the (good) thermal state!</p><p>Here is a snippet to get it in Swift:</p><div><pre tabindex="0"><code data-lang="swift"><span><span><span>import</span> Foundation
</span></span><span><span>
</span></span><span><span>@_silgen_name(<span>&#34;notify_register_check&#34;</span>)
</span></span><span><span><span>private</span> <span>func</span> <span>notify_register_check</span>(
</span></span><span><span>  <span>_</span> name: <span>UnsafePointer</span>&lt;<span>CChar</span>&gt;, <span>_</span> token: <span>UnsafeMutablePointer</span>&lt;<span>Int32</span>&gt;
</span></span><span><span>) -&gt; <span>UInt32</span>
</span></span><span><span>@_silgen_name(<span>&#34;notify_get_state&#34;</span>)
</span></span><span><span><span>private</span> <span>func</span> <span>notify_get_state</span>(<span>_</span> token: <span>Int32</span>, <span>_</span> state: <span>UnsafeMutablePointer</span>&lt;<span>UInt64</span>&gt;) -&gt; <span>UInt32</span>
</span></span><span><span>@_silgen_name(<span>&#34;notify_cancel&#34;</span>)
</span></span><span><span><span>private</span> <span>func</span> <span>notify_cancel</span>(<span>_</span> token: <span>Int32</span>) -&gt; <span>UInt32</span>
</span></span><span><span>
</span></span><span><span><span>let</span> notifyOK: <span>UInt32</span> = <span>0</span>
</span></span><span><span><span>let</span> name = <span>&#34;com.apple.system.thermalpressurelevel&#34;</span>
</span></span><span><span>
</span></span><span><span><span>var</span> token: <span>Int32</span> = <span>0</span>
</span></span><span><span><span>let</span> reg = name.withCString { notify_register_check($0, &amp;token) }
</span></span><span><span><span>guard</span> reg == notifyOK <span>else</span> { <span>fatalError</span>(<span>&#34;notify_register_check failed: </span><span>\(</span>reg<span>)</span><span>&#34;</span>) }
</span></span><span><span><span>defer</span> { <span>_</span> = notify_cancel(token) }
</span></span><span><span>
</span></span><span><span><span>var</span> state: <span>UInt64</span> = <span>0</span>
</span></span><span><span><span>let</span> got = notify_get_state(token, &amp;state)
</span></span><span><span><span>guard</span> got == notifyOK <span>else</span> { <span>fatalError</span>(<span>&#34;notify_get_state failed: </span><span>\(</span>got<span>)</span><span>&#34;</span>) }
</span></span><span><span>
</span></span><span><span><span>let</span> label =
</span></span><span><span>  <span>switch</span> state {
</span></span><span><span>  <span>case</span> <span>0</span>: <span>&#34;nominal&#34;</span>
</span></span><span><span>  <span>case</span> <span>1</span>: <span>&#34;moderate&#34;</span>
</span></span><span><span>  <span>case</span> <span>2</span>: <span>&#34;heavy&#34;</span>
</span></span><span><span>  <span>case</span> <span>3</span>: <span>&#34;trapping&#34;</span>
</span></span><span><span>  <span>case</span> <span>4</span>: <span>&#34;sleeping&#34;</span>
</span></span><span><span>  <span>default</span>: <span>&#34;unknown(</span><span>\(</span>state<span>)</span><span>)&#34;</span>
</span></span><span><span>  }
</span></span><span><span>
</span></span><span><span><span>print</span>(<span>&#34;</span><span>\(</span>state<span>)</span><span> </span><span>\(</span>label<span>)</span><span>&#34;</span>)
</span></span></code></pre></div><p>Prints:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>‚ûú  ~ swift thermal.swift
</span></span><span><span><span>0</span> nominal
</span></span></code></pre></div><p>Now that I had a useful value to work with, it was time to build the app.</p><h2 id="building-macthrottle">Building MacThrottle <span><a href="#building-macthrottle" aria-label="Anchor">#</a></span></h2><p>Armed with Opus 4.5, I set out to build a little menu bar app where I could see, at a glance, if my Apple Silicon die was trying to save itself from crossing 110¬∞C. I called it <a href="https://github.com/angristan/MacThrottle" target="_blank" rel="noreferrer">MacThrottle</a>.</p><p>I built a simple SwiftUI app for the menu bar that shows me the status in a superbly original thermometer icon. The thermometer is filled depending on the thermal state, and its color changes from green to red. I have like 20 menu bar icons and they‚Äôre all monochromatic, so the color in the thermometer is very subtle to keep things consistent.</p><p>The app is a simple SwiftUI app. Apple provides a scene called <a href="https://developer.apple.com/documentation/SwiftUI/MenuBarExtra" target="_blank" rel="noreferrer">MenuBarExtra</a> to render a menu bar control. It was simpler than I expected! To make it a pure menu bar app with no dock icon, you just need to set <code>LSUIElement</code> to <code>true</code> in <code>Info.plist</code>.</p><figure><img src="https://kracekumar.com/post/migrating-from-mypy-to-ty/mac-throttle-old.png" alt="An early version of MacThrottle"/><figcaption>An early version of MacThrottle, just reporting the thermal state</figcaption></figure><h3 id="first-approach-root-helper-for-powermetrics">First approach: root helper for <code>powermetrics</code> <span><a href="#first-approach-root-helper-for-powermetrics" aria-label="Anchor">#</a></span></h3><p>I explained the various approaches to get the thermal pressure level in the previous section. But when I was building the app, I discovered later on that <code>thermald</code> was publishing the thermal state to <code>notifyd</code>. So at first, I thought I had to use <code>powermetrics</code> to get useful thermal state changes. Since that unfortunately requires root access, the app needed root access too.</p><p>To reduce the scope of what runs as root, I did not run the app itself as root. Instead, the app does not work by default, but it gives you the option to install a helper. It does this through an AppleScript <code>with administrator privileges</code> to prompt for access.</p><p>The helper is just a bash script run as a launchd daemon:</p><div><pre tabindex="0"><code data-lang="xml"><span><span>‚ûú  ~ cat /Library/LaunchDaemons/com.macthrottle.thermal-monitor.plist
</span></span><span><span><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span><span><span>&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span><span><span>&lt;plist</span> <span>version=</span><span>&#34;1.0&#34;</span><span>&gt;</span>
</span></span><span><span><span>&lt;dict&gt;</span>
</span></span><span><span>    <span>&lt;key&gt;</span>Label<span>&lt;/key&gt;</span>
</span></span><span><span>    <span>&lt;string&gt;</span>com.macthrottle.thermal-monitor<span>&lt;/string&gt;</span>
</span></span><span><span>    <span>&lt;key&gt;</span>ProgramArguments<span>&lt;/key&gt;</span>
</span></span><span><span>    <span>&lt;array&gt;</span>
</span></span><span><span>        <span>&lt;string&gt;</span>/usr/local/bin/mac-throttle-thermal-monitor<span>&lt;/string&gt;</span>
</span></span><span><span>    <span>&lt;/array&gt;</span>
</span></span><span><span>    <span>&lt;key&gt;</span>RunAtLoad<span>&lt;/key&gt;</span>
</span></span><span><span>    <span>&lt;true/&gt;</span>
</span></span><span><span>    <span>&lt;key&gt;</span>KeepAlive<span>&lt;/key&gt;</span>
</span></span><span><span>    <span>&lt;true/&gt;</span>
</span></span><span><span><span>&lt;/dict&gt;</span>
</span></span><span><span><span>&lt;/plist&gt;</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="sh"><span><span>‚ûú  ~ cat /usr/local/bin/mac-throttle-thermal-monitor
</span></span><span><span><span>#!/bin/bash</span>
</span></span><span><span>OUTPUT_FILE<span>=</span><span>&#34;/tmp/mac-throttle-thermal-state&#34;</span>
</span></span><span><span>
</span></span><span><span><span>while</span> true; <span>do</span>
</span></span><span><span>    THERMAL_OUTPUT<span>=</span><span>$(</span>powermetrics -s thermal -n <span>1</span> -i <span>1</span> 2&gt;/dev/null | grep -i <span>&#34;Current pressure level&#34;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>if</span> <span>echo</span> <span>&#34;</span>$THERMAL_OUTPUT<span>&#34;</span> | grep -qi <span>&#34;sleeping&#34;</span>; <span>then</span>
</span></span><span><span>        PRESSURE<span>=</span><span>&#34;sleeping&#34;</span>
</span></span><span><span>    <span>elif</span> <span>echo</span> <span>&#34;</span>$THERMAL_OUTPUT<span>&#34;</span> | grep -qi <span>&#34;trapping&#34;</span>; <span>then</span>
</span></span><span><span>        PRESSURE<span>=</span><span>&#34;trapping&#34;</span>
</span></span><span><span>    <span>elif</span> <span>echo</span> <span>&#34;</span>$THERMAL_OUTPUT<span>&#34;</span> | grep -qi <span>&#34;heavy&#34;</span>; <span>then</span>
</span></span><span><span>        PRESSURE<span>=</span><span>&#34;heavy&#34;</span>
</span></span><span><span>    <span>elif</span> <span>echo</span> <span>&#34;</span>$THERMAL_OUTPUT<span>&#34;</span> | grep -qi <span>&#34;moderate&#34;</span>; <span>then</span>
</span></span><span><span>        PRESSURE<span>=</span><span>&#34;moderate&#34;</span>
</span></span><span><span>    <span>elif</span> <span>echo</span> <span>&#34;</span>$THERMAL_OUTPUT<span>&#34;</span> | grep -qi <span>&#34;nominal&#34;</span>; <span>then</span>
</span></span><span><span>        PRESSURE<span>=</span><span>&#34;nominal&#34;</span>
</span></span><span><span>    <span>else</span>
</span></span><span><span>        PRESSURE<span>=</span><span>&#34;unknown&#34;</span>
</span></span><span><span>    <span>fi</span>
</span></span><span><span>
</span></span><span><span>    <span>echo</span> <span>&#34;{\&#34;pressure\&#34;:\&#34;</span>$PRESSURE<span>\&#34;,\&#34;timestamp\&#34;:</span><span>$(</span>date +%s<span>)</span><span>}&#34;</span> &gt; <span>&#34;</span>$OUTPUT_FILE<span>&#34;</span>
</span></span><span><span>    chmod <span>644</span> <span>&#34;</span>$OUTPUT_FILE<span>&#34;</span>
</span></span><span><span>    sleep <span>10</span>
</span></span><span><span><span>done</span>
</span></span></code></pre></div><p>The bash script writes the thermal state to a file every few seconds and the app reads it every few seconds!</p><h3 id="using-the-thermald-ipc-notifications">Using the <code>thermald</code> IPC notifications <span><a href="#using-the-thermald-ipc-notifications" aria-label="Anchor">#</a></span></h3><p>Once I discovered I could use the notification system without elevated privileges, <a href="https://github.com/angristan/MacThrottle/commit/20f3861073634b7c42fc427eb151c07ba2bfe2c6" target="_blank" rel="noreferrer">I replaced the helper</a> by code in the app to read the value from the notification system directly. Much simpler üéâ</p><h3 id="temperature-and-fans">Temperature and fans <span><a href="#temperature-and-fans" aria-label="Anchor">#</a></span></h3><p>I wanted to show the temperature and fan speed (when supported) in a little graph in the menu bar app. This would allow me to correlate the thermal state with increased temperature, for example.</p><p>Again, there are multiple APIs to read the temperature. First, I <a href="https://github.com/angristan/MacThrottle/blob/7ccdb5939fb5530ba87e5376e8b6589c4a3aa081/MacThrottle/Services/TemperatureReaders.swift#L245" target="_blank" rel="noreferrer">started using an undocumented API from IOKit</a>, but I realised I was getting ~80¬∫C max, while iStat Menus or MX Power Gadget would show &gt;100¬∫C.</p><p><a href="https://github.com/exelban/stats/tree/master/SMC" target="_blank" rel="noreferrer">Stats</a>, the open source alternative to iStat Menus, helped me use the SMC instead and get the correct values. But the SMC is a much more unstable API because each SoC has <a href="https://github.com/angristan/MacThrottle/blob/7ccdb5939fb5530ba87e5376e8b6589c4a3aa081/MacThrottle/Services/TemperatureReaders.swift#L58-L60" target="_blank" rel="noreferrer">different keys</a> to access the temperature data:</p><div><pre tabindex="0"><code data-lang="swift"><span><span><span>private</span> <span>let</span> m1Keys = [<span>&#34;Tp01&#34;</span>, <span>&#34;Tp05&#34;</span>, <span>&#34;Tp09&#34;</span>, <span>&#34;Tp0D&#34;</span>, <span>&#34;Tp0H&#34;</span>, <span>&#34;Tp0L&#34;</span>, <span>&#34;Tp0P&#34;</span>, <span>&#34;Tp0X&#34;</span>, <span>&#34;Tp0b&#34;</span>]
</span></span><span><span><span>private</span> <span>let</span> m2Keys = [<span>&#34;Tp01&#34;</span>, <span>&#34;Tp05&#34;</span>, <span>&#34;Tp09&#34;</span>, <span>&#34;Tp0D&#34;</span>, <span>&#34;Tp0X&#34;</span>, <span>&#34;Tp0b&#34;</span>, <span>&#34;Tp0f&#34;</span>, <span>&#34;Tp0j&#34;</span>]
</span></span><span><span><span>private</span> <span>let</span> m3Keys = [<span>&#34;Tf04&#34;</span>, <span>&#34;Tf09&#34;</span>, <span>&#34;Tf0A&#34;</span>, <span>&#34;Tf0B&#34;</span>, <span>&#34;Tf0D&#34;</span>, <span>&#34;Tf0E&#34;</span>, <span>&#34;Tf44&#34;</span>, <span>&#34;Tf49&#34;</span>, <span>&#34;Tf4A&#34;</span>, <span>&#34;Tf4B&#34;</span>]
</span></span></code></pre></div><p>Though the M3 keys seem to work on my M4 Max work MacBook Pro‚Ä¶</p><p>I ended up using SMC first to get the accurate temperature and fall back to IOKit if SMC doesn‚Äôt work.</p><p>For the graph, I wanted a compact visualization that would show me the thermal history at a glance.</p><p>The graph packs three layers of information:</p><ul><li>Colored background segments for each thermal state (green for nominal, yellow for moderate, orange for heavy, red for critical)</li><li>A solid line for CPU temperature with a dynamic Y-axis that adjusts to actual values</li><li>A dashed cyan line for fan speed percentage (on Macs that have fans)</li></ul><p>I didn‚Äôt want to spend too much time making a super fancy graph system. Since it polls every two seconds, the graph gets very busy after a while. So I decided to keep it down to 10 minutes, since the thermal state history is mostly interesting short-term.</p><p>I also added hover tooltips using <code>onContinuousHover</code>.</p><p>When the system was under load, I noticed the graph hovering was not very smooth on my 120Hz display. I found out I can add <a href="https://www.hackingwithswift.com/books/ios-swiftui/enabling-high-performance-metal-rendering-with-drawinggroup" target="_blank" rel="noreferrer"><code>.drawingGroup</code> to my SwiftUI canvas to use GPU rendering!</a>. Indeed, I <a href="https://github.com/angristan/MacThrottle/commit/b85e55c65423a2a8385dcf40b0853a38e5bbd130" target="_blank" rel="noreferrer">added it</a>, and it was smooth again.</p><figure><img src="https://kracekumar.com/post/migrating-from-mypy-to-ty/mac-throttle-with-fans.jpeg" alt="MacThrottle showing fan speed"/><figcaption>Graph with pressure state, temp and fans. Tooltip on hover to get past value is supported.</figcaption></figure><h3 id="adding-macos-notifications">Adding macOS notifications <span><a href="#adding-macos-notifications" aria-label="Anchor">#</a></span></h3><p>I also added notifications so I get alerted when the state changes, in case I miss the menu bar icon. It can alert on specific state transitions, and optionally on recovery. This is useful to know when it‚Äôs time to kill a VS Code instance or a Docker container!</p><figure><img src="https://kracekumar.com/post/migrating-from-mypy-to-ty/mac-throttle-notification.png" alt="MacThrottle notification alerting of heavy thermal pressure"/><figcaption>To be fair, it can get a bit noisy on a struggling MacBook Air‚Ä¶</figcaption></figure><p>It‚Äôs true that I usually already notice when the Mac is getting slow, but sometimes the Mac gets slow when it‚Äôs swapping heavily. At least now I know when it‚Äôs just too hot.</p><h3 id="launching-the-app-at-login">Launching the app at Login <span><a href="#launching-the-app-at-login" aria-label="Anchor">#</a></span></h3><p>Of course, I want the app to start automatically now, since it works so well!</p><p>I expected that I would need to write <code>.plist</code> again, but no, it‚Äôs extremely easy to prompt the user to add a ‚Äúlogin item‚Äù as macOS calls it, using <a href="https://developer.apple.com/documentation/servicemanagement/smappservice" target="_blank" rel="noreferrer"><code>SMAppService</code></a>.</p><div><pre tabindex="0"><code data-lang="swift"><span><span>SMAppService.mainApp.register()    <span>// enable auto-start</span>
</span></span><span><span>SMAppService.mainApp.unregister()  <span>// disable auto-start</span>
</span></span><span><span>SMAppService.mainApp.status == .enabled  <span>// check current state</span>
</span></span></code></pre></div><h2 id="how-to-use-it">How to use it <span><a href="#how-to-use-it" aria-label="Anchor">#</a></span></h2><p>Since I don‚Äôt have an Apple Developer account, I can‚Äôt notarize the app, so installing it from the <a href="https://github.com/angristan/MacThrottle/releases" target="_blank" rel="noreferrer">releases</a> is going to require a few extra clicks in <code>Privacy and Security</code>.</p><p>And for Macs that disallow it entirely, building from source with Xcode is the only way. I added instructions <a href="https://github.com/angristan/MacThrottle?tab=readme-ov-file#option-2-build-locally" target="_blank" rel="noreferrer">in the README</a>.</p><p>Hope this is useful to someone else!</p></div></section></article></div></div>
  </body>
</html>
