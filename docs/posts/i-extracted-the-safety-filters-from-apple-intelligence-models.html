<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/BlueFalconHD/apple_generative_model_safety_decrypted">Original</a>
    <h1>I extracted the safety filters from Apple Intelligence models</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Decrypted Generative Model safety files for Apple Intelligence containing filters</p>

<ul dir="auto">
<li><code>decrypted_overrides/</code>: Contains decrypted overrides for various models.
<ul dir="auto">
<li><code>com.apple.*/</code>: Directory named using the Asset Specifier assosciated with the safety info
<ul dir="auto">
<li><code>Info.plist</code>: Contains metadata for the override</li>
<li><code>AssetData/</code>: Contains the decrypted JSON files</li>
</ul>
</li>
</ul>
</li>
<li><code>get_key_lldb.py</code>: Script to get the encryption key (see usage info below)</li>
<li><code>decrypt_overrides.py</code>: Script to decrypt the overrides (see usage info below)</li>
</ul>


<p dir="auto"><code>cryptography</code> is the only dependency required to run the decryption script. You can install it using pip:</p>

<div dir="auto"><h3 tabindex="-1" dir="auto">Getting the encryption key</h3><a id="user-content-getting-the-encryption-key" aria-label="Permalink: Getting the encryption key" href="#getting-the-encryption-key"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To retrieve the encryption key (generated by ModelCatalog.Obfuscation.readObfuscatedContents) for the overrides, you must attach LLDB to GenerativeExperiencesSafetyInferenceProvider (<code> /System/Library/ExtensionKit/Extensions/GenerativeExperiencesSafetyInferenceProvider.appex/Contents/MacOS/GenerativeExperiencesSafetyInferenceProvider</code>). Also it is important that this is Xcode&#39;s LLDB, not the default macOS one or LLVM&#39;s lldb. The method I recommend to get LLDB to attach:</p>
<ul dir="auto">
<li>Run <code>sudo killall GenerativeExperiencesSafetyInferenceProvider; sudo xcrun lldb -w -n GenerativeExperiencesSafetyInferenceProvider /System/Library/ExtensionKit/Extensions/GenerativeExperiencesSafetyInferenceProvider.appex/Contents/MacOS/GenerativeExperiencesSafetyInferenceProvider</code></li>
<li>In the Shortcuts app, create a dummy shortcut that uses the Generative Model action (&#34;Use Model&#34;) and select the On-Device option. Type whatever you want into the text field, it doesn&#39;t matter. Then run the shortcut.</li>
<li>You should see LLDB attach to (the newly started instance of) GenerativeExperiencesSafetyInferenceProvider with a message like this:</li>
</ul>
<div data-snippet-clipboard-copy-content="(lldb) process attach --name &#34;GenerativeExperiencesSafetyInferenceProvider&#34; --waitfor
Process 53629 stopped
* thread #1, stop reason = signal SIGSTOP
    frame #0: 0x00000001839f41f8 dyld`dyld4::PrebuiltLoader::dependent(dyld4::RuntimeState const&amp;, unsigned int, mach_o::LinkedDylibAttributes*) const + 116
dyld`dyld4::PrebuiltLoader::dependent:
-&gt;  0x1839f41f8 &lt;+116&gt;: add    x0, sp, #0xe
    0x1839f41fc &lt;+120&gt;: mov    x1, x19
    0x1839f4200 &lt;+124&gt;: bl     0x1839e50dc    ; dyld4::Loader::LoaderRef::loader(dyld4::RuntimeState const&amp;) const
    0x1839f4204 &lt;+128&gt;: ldrh   w8, [x20, #0x4]
Target 0: (GenerativeExperiencesSafetyInferenceProvider) stopped.
Executable binary set to &#34;/System/Library/ExtensionKit/Extensions/GenerativeExperiencesSafetyInferenceProvider.appex/Contents/MacOS/GenerativeExperiencesSafetyInferenceProvider&#34;.
Architecture set to: arm64e-apple-macosx-."><pre><code>(lldb) process attach --name &#34;GenerativeExperiencesSafetyInferenceProvider&#34; --waitfor
Process 53629 stopped
* thread #1, stop reason = signal SIGSTOP
    frame #0: 0x00000001839f41f8 dyld`dyld4::PrebuiltLoader::dependent(dyld4::RuntimeState const&amp;, unsigned int, mach_o::LinkedDylibAttributes*) const + 116
dyld`dyld4::PrebuiltLoader::dependent:
-&gt;  0x1839f41f8 &lt;+116&gt;: add    x0, sp, #0xe
    0x1839f41fc &lt;+120&gt;: mov    x1, x19
    0x1839f4200 &lt;+124&gt;: bl     0x1839e50dc    ; dyld4::Loader::LoaderRef::loader(dyld4::RuntimeState const&amp;) const
    0x1839f4204 &lt;+128&gt;: ldrh   w8, [x20, #0x4]
Target 0: (GenerativeExperiencesSafetyInferenceProvider) stopped.
Executable binary set to &#34;/System/Library/ExtensionKit/Extensions/GenerativeExperiencesSafetyInferenceProvider.appex/Contents/MacOS/GenerativeExperiencesSafetyInferenceProvider&#34;.
Architecture set to: arm64e-apple-macosx-.
</code></pre></div>
<ul dir="auto">
<li>In this repository&#39;s root, run the command in LLDB: <code>command script import get_key_lldb.py</code></li>
<li>Then run <code>c</code> to continue the process. LLDB will print the encryption key to the console and save it to <code>./key.bin</code>.</li>
</ul>

<p dir="auto">To decrypt the overrides, run the following command in the root of this repository:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python decrypt_overrides.py /System/Library/AssetsV2/com_apple_MobileAsset_UAF_FM_Overrides/purpose_auto \
  -k key.bin \
  -o decrypted_overrides"><pre>python decrypt_overrides.py /System/Library/AssetsV2/com_apple_MobileAsset_UAF_FM_Overrides/purpose_auto \
  -k key.bin \
  -o decrypted_overrides</pre></div>
<p dir="auto">The <code>decrypted_overrides</code> directory will be created if it does not exist, and the decrypted overrides will be placed in it. This is only necessary if the overrides have been updated, there is already a decrypted version of the overrides in this repository that is up to date as of June 28, 2025.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Understanding the overrides</h2><a id="user-content-understanding-the-overrides" aria-label="Permalink: Understanding the overrides" href="#understanding-the-overrides"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The overrides are JSON files that contain safety filters for various generative models. Each override is associated with a specific model context (from what I can tell) and contains rules that determine how the model should behave in certain situations, such as filtering out harmful content or ensuring compliance with safety standards.</p>
<p dir="auto">Here is an example of one of the overrides <code>metadata.json</code> file sourced from <code>dec_out_repo/decrypted_overrides/com.apple.gm.safety_deny.output.code_intelligence.base</code>. Note the <code>output</code> part of the specifier, which indicates that this is a safety override for model output rather than user input:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;reject&#34;: [
    &#34;xylophone copious opportunity defined elephant 10out&#34;,
    &#34;xylophone copious opportunity defined elephant out&#34;
  ],
  &#34;remove&#34;: [],
  &#34;replace&#34;: {},
  &#34;regexReject&#34;: [
    &#34;(?i)\\bbitch\\b&#34;,
    &#34;(?i)\\bdago\\b&#34;,
    &#34;(?i)\\bdyke\\b&#34;,
    &#34;(?i)\\bhebe\\b&#34;,
    ...
  ],
  &#34;regexRemove&#34;: [],
  &#34;regexReplace&#34;: {}
}"><pre>{
  <span>&#34;reject&#34;</span>: [
    <span><span>&#34;</span>xylophone copious opportunity defined elephant 10out<span>&#34;</span></span>,
    <span><span>&#34;</span>xylophone copious opportunity defined elephant out<span>&#34;</span></span>
  ],
  <span>&#34;remove&#34;</span>: [],
  <span>&#34;replace&#34;</span>: {},
  <span>&#34;regexReject&#34;</span>: [
    <span><span>&#34;</span>(?i)<span>\\</span>bbitch<span>\\</span>b<span>&#34;</span></span>,
    <span><span>&#34;</span>(?i)<span>\\</span>bdago<span>\\</span>b<span>&#34;</span></span>,
    <span><span>&#34;</span>(?i)<span>\\</span>bdyke<span>\\</span>b<span>&#34;</span></span>,
    <span><span>&#34;</span>(?i)<span>\\</span>bhebe<span>\\</span>b<span>&#34;</span></span>,
    <span>...</span>
  ],
  <span>&#34;regexRemove&#34;</span>: [],
  <span>&#34;regexReplace&#34;</span>: {}
}</pre></div>
<p dir="auto">Here, the <code>reject</code> field contains exact phrases which will result in a guardrail violation. The <code>remove</code> field contains phrases that will be removed from the output, while the <code>replace</code> field contains phrases that will be replaced with other phrases. The <code>regexReject</code>, <code>regexRemove</code>, and <code>regexReplace</code> fields contain regular expressions that will be used to match and filter content in a similar manner.</p>
</article></div></div>
  </body>
</html>
