<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sidneys1.com/retrocomputing/2024/10/04/booting-sun-sparc-servers.html">Original</a>
    <h1>Booting Sun Sparc Servers</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
		<p>In early 2022 <a href="https://sidneys1.com/retrocomputing/2022/06/03/retro-roundup.html">I got several Sun SPARC servers</a> for free off of a FreeCycle ad: I was recently
<a href="https://news.ycombinator.com/item?id=41722918" target="_blank">called out</a> for not providing any sort of update on those devices… so here we go!</p>

<!--more-->

<h2 id="the-devices">The Devices</h2>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Released</th>
      <th>Original MSRP</th>
      <th>Inflation-adjusted (2024)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SPARCstation 20</td>
      <td>Mar. 1994</td>
      <td>$12,195</td>
      <td>$26,080</td>
    </tr>
    <tr>
      <td>Ultra 1 Creator</td>
      <td>Nov. 1995</td>
      <td>$25,995</td>
      <td>$53,276</td>
    </tr>
    <tr>
      <td>Axil Ultima 1</td>
      <td>Sep. 1996</td>
      <td>$9,995</td>
      <td>$19,939</td>
    </tr>
  </tbody>
</table>

<h2 id="nvram-woes">NVRAM Woes</h2>

<p><img src="https://sidneys1.com/images/sparc-journey/invalid-nvram.jpg" alt="Invalid NVRAM boot messages" title="Invalid NVRAM boot messages" onclick="document.getElementById(&#39;213-invalid-nvram-boot-messages&#39;).showModal()"/>
	
	<em>Click to zoom.</em>
</p>

<dialog id="213-invalid-nvram-boot-messages" onclick="document.getElementById(&#39;213-invalid-nvram-boot-messages&#39;).close()">
	<!-- <form method="dialog">
		<button class="close">X</button>
	  </form> -->
	<img src="https://sidneys1.com/images/sparc-journey/invalid-nvram.jpg" alt="Invalid NVRAM boot messages" title="Invalid NVRAM boot messages" loading="lazy"/>
</dialog>

<p>Sun SPARC machines store some of their BIOS configuration in a chip called an
<dfn><abbr title="non-volatile RAM">NVRAM</abbr></dfn>, a special type of writeable random access memory that does not
clear its contents when the machine powers off. This is usually a small RAM chip with its own internal battery that
recharges when the machine is running. Unfortunately this means that when the devices is powered off for extremely long
periods the NVRAM loses its values. Even more unfortunately, over time the NVRAM battery degrades to the point where it
can no longer be recharged, and every power cycle results in a compete configuration wipe.</p>

<p>Such is the case with my SPARC machines; upon powering on we’re greeted with a sad message.
<code>Incorrect configuration checksum; Ethernet address ff:ff:ff:ff:ff:ff, Host ID: ffffffff. The IDPROM contents are invalid</code>
means that our NVRAM has been cleared (the term IDPROM is a historical artifact – older Sun architectures used a
<dfn><abbr title="Programmable ROM">PROM</abbr></dfn> chip instead of an NVRAM chip). Thankfully, there’s a process in
place to restore it manually by entering NVRAM values by hand. Here’s the general process:</p>

<ol>
  <li>Boot your Sun SPARC machine. When you see the <code>The IDPROM contents are invalid</code> message, press <kbd><kbd>STOP</kbd>+<kbd>A</kbd></kbd> (<kbd>STOP</kbd> is a special key on Sun keyboards). This should drop you to the <code>ok</code> prompt, which is the OpenBoot debugging prompt.
<!-- TODO: take photo of STOP key. --></li>
  <li>
    <p>Now we’re going to poke values into our NVRAM using the <code>mkp</code> command. This command has a format <code>&lt;value&gt; &lt;location&gt; mkp</code>. Here’s the layout of NVRAM, or at least the parts we care about:</p>

    <table>
      <thead>
        <tr>
          <th>Location(s)</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>0</td>
          <td>Always <code>1</code> (format/version number).</td>
        </tr>
        <tr>
          <td>1</td>
          <td>First byte of HostID (machine type<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>).</td>
        </tr>
        <tr>
          <td>2–7</td>
          <td>6-byte ethernet address (first three bytes should be <code>80:00:20</code>).</td>
        </tr>
        <tr>
          <td>8–b</td>
          <td>Date of manufacture (can be zeros).</td>
        </tr>
        <tr>
          <td>c–e</td>
          <td>Remainder of HostID.</td>
        </tr>
        <tr>
          <td>f</td>
          <td>IDPROM checksum - bitwise exclusive-or of locations 0–e.</td>
        </tr>
      </tbody>
    </table>

    <p>So let’s start poking values into NVRAM:</p>

    <div>
<div><div><pre><code>ok set-defaults
ok <span>1</span> 0 mkp
ok <span>80</span> 1 mkp
ok <span>8</span> 2 mkp
ok <span>0</span> 3 mkp
ok <span>20</span> 4 mkp
ok <span>c0</span> 54 mkp
ok <span>ff</span> 6 mkp
ok <span>ee</span> 7 mkp
ok <span>0</span> 8 mkp
ok <span>0</span> 9 mkp
ok <span>0</span> a mkp
ok <span>0</span> b mkp
ok <span>c0</span> c mkp
ok <span>ff</span> d mkp
ok <span>ee</span> e mkp
ok <span>0 f 0 do i idprom@ xor loop f</span> mkp</code></pre></div></div>
<div>

        <table>
          <thead>
            <tr>
              <th>Locations</th>
              <th>Values</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>0–7</td>
              <td><code><span>01</span><span>80</span><span>080020c0ffee</span></code></td>
            </tr>
            <tr>
              <td>8–f</td>
              <td><code><span>00000000</span><span>c0ffee</span><span>??</span></code></td>
            </tr>
          </tbody>
        </table>

        <!-- {: .compact-table} -->

      </div></div>

    <p>That last line is a small function that will generate the checksum that goes in location <code>f</code>.</p>
  </li>
  <li>
    <p>Enter <code>banner</code> at the <code>ok</code> prompt. This will print out the system banner, and allow us to
validate that the values we’ve entered are correct. If all is well, you should see something like this:</p>

    <div><div><pre><code>ok banner
Sun Ultra 1 UPA/SBus (UltraSPARC 167MHz), Keyboard Present
OpenBoot 3.7, 384 MB memory installed, Serial #12648430.
Ethernet address <span>8:0:20:c0:ff:ee</span>, Host ID: <span>80</span><span>c0ffee</span>.</code></pre></div></div>

    <p>If, instead, you see a message like <code>The IDPROM contents are invalid</code> after the banner, then either the
checksum is wrong (check that you typed it correctly!) or the first byte of the HostID is incorrect – this byte
specifies the machine type, and must match the machine you’re trying to boot<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>. Don’t forget to re-generate the
checksum after updating any of these values!</p>
  </li>
  <li>Finally enter <code>reset</code> at the <code>ok</code> prompt, which will restart the boot process. Because we
haven’t lost power, however, the NVRAM will retain the values we’ve set. Wait for the machine to boot. This can take
quite a while, especially if there is a lot of RAM in the machine. Pro tip, plugging an ethernet cable between the
Sun server and another machine can help here – otherwise the Sun server can spend a lot of time complaining about
<code>SUNW,hme0: Link Down - cable problem?</code>. I plugged the Sun Ultra 1 into a powered on Raspberry Pi 3b
and it stopped complaining.</li>
  <li>Eventually you’ll be brought to a Unix login, assuming the machine is running Solaris. If you know the password,
great; if not, things get tricky<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" rel="footnote">2</a></sup>. <!-- TODO: talk about clearing root password by booting debian -->
Once logged in, you can set the date and time (for as long as the machine is
powered on, anyways) at the <code>root#</code> prompt with <code>date 1004102024</code> (in format
<code>mmddHHMMYY</code>).</li>
</ol>

<h2 id="results">Results</h2>

<h3 id="sun-ultra-1-creator">Sun Ultra 1 Creator</h3>

<p>The Sun Ultra 1 was the first machine I tried to boot, and so far the only one to successfully fully boot.</p>





<h3 id="sun-sparcstation-20">Sun SPARCstation 20</h3>

<p><img src="https://sidneys1.com/images/sparc-journey/sp20-simm-errors.jpg" alt="SPARCstation 20 SIMM Errors" title="SPARCstation 20 SIMM Errors" onclick="document.getElementById(&#39;211-sparcstation-20-simm-errors&#39;).showModal()"/>
	
	<em>Click to zoom.</em>
</p>

<dialog id="211-sparcstation-20-simm-errors" onclick="document.getElementById(&#39;211-sparcstation-20-simm-errors&#39;).close()">
	<!-- <form method="dialog">
		<button class="close">X</button>
	  </form> -->
	<img src="https://sidneys1.com/images/sparc-journey/sp20-simm-errors.jpg" alt="SPARCstation 20 SIMM Errors" title="SPARCstation 20 SIMM Errors" loading="lazy"/>
</dialog>

<p>After some stumbles learning about the machine-type byte in the host ID<sup id="fnref:1:2" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>, this machine was able to get past the NVRAM
check, but failed during memory diagnostics. This output repeated for some 10 minutes before I turned the machine off.
For J0301, it looks like the fourth bit of the lowest byte (<code>0b00010000</code>) is faulty, always set to <code>0b1</code>. For example,
the pattern <code>0b10100101</code> (<code>0xa5</code>) becomes <code>0b10110101</code> (<code>0xb5</code>). For J0302, something stranger seems to be happening, as
<code>0b10100101</code> (<code>0xa5</code>) becomes <code>0x01001010</code> (<code>0x4a</code>) and <code>0b11111111</code> (<code>0xff</code>) becomes <code>0b11101111</code> (<code>0xef</code>).</p>

<table>
  <thead>
    <tr>
      <th>U-number<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" rel="footnote">3</a></sup></th>
      <th>Physical Addresses</th>
      <th>Expected Value</th>
      <th>Observed Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>J0301</td>
      <td><code>0x0c4012a8</code>–<code>0x0c4fb2a8</code></td>
      <td><code>0xa5a5a5a5</code></td>
      <td><code>0xa5a5a5b5</code></td>
    </tr>
    <tr>
      <td>J0301</td>
      <td><code>0x0c4012a8</code>–<code>0x0c4fb2a8</code></td>
      <td><code>0x00</code></td>
      <td><code>0x10</code></td>
    </tr>
    <tr>
      <td>J0302</td>
      <td><code>0x188ff2b8</code>–<code>0x18a011a9</code></td>
      <td><code>0xa5a5a5a5</code></td>
      <td><code>0xa5a5a54a</code></td>
    </tr>
    <tr>
      <td>J0302</td>
      <td><code>0x188ff2b8</code>–<code>0x18a011a9</code></td>
      <td><code>0xffffffff</code></td>
      <td><code>0xffffffef</code></td>
    </tr>
  </tbody>
</table>

<p>One fun detail I noticed poking around this machine: there’s a little bear with a top hat silkscreened onto the
motherboard:</p>

<p><img src="https://sidneys1.com/images/sparc-journey/sparcstation-mobo-zoom.jpg" alt="asdf"/></p>





<h3 id="axil-ultima-1">Axil Ultima 1</h3>

<p>Perhaps the saddest story here, and a testament to the quality and reliability of original Sun hardware, this Sun clone
initially had some struggles booting, and wouldn’t recognize keyboard input. After a couple power cycles, however, it
stopped booting altogether.</p>





<h2 id="notes">Notes</h2>

<p>I did start writing a section about my efforts last year to boot NetBSD on this machine. I honestly can’t remember if I
had much luck in the end, and I was having difficulty repeating these steps and running out of time to work on this
project. So I’ve decided to leave this section as-is here at the end; the steps <em>should</em> be technically accurate, but as
I said I haven’t had time to verify them and/or finish writing the section. You can check out
<ruby><a href="https://www.netbsd.org/docs/network/netboot/intro.sun.html" target="_blank">this page from NetBSD</a>
<rt>Archived at: <a href="https://web.archive.org/web/2/https://www.netbsd.org/docs/network/netboot/intro.sun.html" target="_blank">Wayback Machine</a>.</rt></ruby> with more instructions if
you’re really interested.</p>

<h3 id="et-tu-root-e">Et tu, root-e?</h3>

<p>Now that we’ve managed to convince our Sun server to begin booting, there’s a few others problems. First, Solaris
doesn’t support DHCP, and cannot get a IP address; second, it also doesn’t have a configuration for its own hostname.
Let’s look at configuring those. Instead of DHCP, Solaris uses <defn><abbr title="Reverse Address Resolution Protocol">RARP</abbr></defn>,
an older protocol (1984; DHCP was first defined in 1993).</p>

<p>Now, <defn><abbr title="Address Resolution Protocol">ARP</abbr></defn> is a link-layer protocol that allows
internet-layer addresses (IPs) to be resolved to link-layer addresses (MACs). <em>Reverse</em> ARP is used to resolve a MAC to
an IP. So, I hooked up a Raspberry Pi 3b with an ethernet cable directly to the Sun server. At boot time, Solaris will
send out a broadcast request with its MAC address (configured via NVRAM) and then will listen for a response to
auto-configure its IP. We can install the <code>rarpd</code> package on our Pi, and configure it to know the IP address associated
with our Sun’s MAC.</p>

<p>Checking <code>man rarpd</code> we can note a few important details: first, an association between MAC addresses and hostnames is
configured in <code>/etc/ethers</code>. Second, an association between hostnames and IPs is read from <code>/etc/hosts</code> (this file
already exist on all Linux systems). Third, there’s a section about “bootable images”:</p>

<blockquote>
  <p>By  default  rarpd  also checks if a bootable image, of a name starting with the IP address in hexadecimal upper-case
letters, is present in the TFTP boot directory before it decides whether to respond to the RARP request.  The
comparison involves exactly the first eight characters, and ignores any additional character.  A file name shorter
than eight characters in length is unsuccessful.  Typically, 192.168.0.122 would correspond to  an  image  named like
C0A8007A.SUN.</p>
</blockquote>

<p>Ok, that’s a lot to chew on, but the gist is that we can do the following:</p>

<div>
<div>
    <div data-file-name="/etc/ethers"><div><pre><code><span>b8</span>:<span>27</span>:<span>eb</span>:<span>fc</span>:<span>10</span>:<span>0</span><span>c</span> <span>pi</span>            <span># Our Pi
</span><span>08</span>:<span>00</span>:<span>20</span>:<span>c0</span>:<span>ff</span>:<span>ee</span> <span>SUN</span>.<span>TEST</span>.<span>COM</span>  <span># Our Sun
</span></code></pre></div>    </div>
  </div>
<div>
    <div data-file-name="/etc/hosts"><div><pre><code><span>127</span>.<span>0</span>.<span>0</span>.<span>1</span>    <span>pi</span>            <span># Our Pi
</span><span>192</span>.<span>168</span>.<span>6</span>.<span>37</span> <span>SUN</span>.<span>TEST</span>.<span>COM</span>  <span># Our Sun
</span></code></pre></div>    </div>
  </div>
</div>

<p>And as for the bootable images, for now we’ll run <code>rarp</code> without that restriction using the <code>-e</code> parameter. We’ll also
use <code>-d</code> so that the daemon stays connected to the TTY and we can continue to see log messages. Make sure the system
service isn’t running with <code>sudo systemctl stop rarpd</code>. Now we can run <code>sudo rarpd -e -d</code>. Now let’s boot again and see
if we get an IP address.</p>

<!-- The Axil started to boot, but then on subsequent power cycles deteriorated to the point of no longer printing any output. -->

<!--
Notes:
- https://forum.vcfed.org/index.php?threads/how-to-workaround-when-your-sun-ultra-5-10-nvram-no-longer-works.52997/
  on how to reprogram the nvram
- https://www.sun3arc.org/FAQ/sun-nvram-hostid.faq.phtml
  lots of facts, specifically the requisite first bytes of the hostid.
- http://sunsite.uakom.sk/sunworldonline/swol-11-1995/swol-11-fusion.intro.html
- https://www.edn.com/axil-launches-the-axil-ultima-1-and-axil-ultima-2-workstations-and-servers/

 -->


	</div></div>
  </body>
</html>
