<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://amitp.blogspot.com/2025/02/emacs-tree-sitter-custom-highlighting.html">Original</a>
    <h1>Emacs Tree-sitter custom highlighting</h1>
    
    <div id="readability-page-1" class="page"><section id="2519063997791380449">
<time timestamp="2025-02-27T15:32:00-08:00">Thursday, February 27, 2025</time>
<p>
A few years ago I <a href="https://amitp.blogspot.com/2022/07/axial-name-highlighting.html">blogged about custom tree-sitter-based syntax highlighting in emacs</a>. I started out with highlighting certain keywords in red. I wanted to show the keywords that interrupt control flow:
</p>

<figure>
  <img alt="" src="https://www.redblobgames.com/x/screenshots/emacs-highlight-control-flow-keywords.png"/>
  <figcaption>Screenshot showing syntax highlighting of keywords in black or red</figcaption>
</figure>

<p>
I highlight regular keywords (<code>while</code>, <code>if</code>) in bold. I highlight control flow interrupting keywords (<code>return</code>, <code>continue</code>) in red.
</p>

<p>
That&#39;s syntax highlighting.
</p>

<p>
But I also wanted to highlight names based on their <em>meaning</em>. 
</p>

<a name="more"></a>

<p>
In some projects I&#39;m working with horizontal and vertical measurements, and I thought it would be nice to highlight those variable names differently. In some projects I&#39;m working with Delaunay+Voronoi meshes, and I wanted to highlight the triangles, edges, and polygons differently. In some projects I&#39;m working with hexagonal grids, and I wanted to highlight the three axes differently, like I do <a href="https://www.redblobgames.com/grids/hexagons/">in my guide to hexagonal grids</a>. In some projects I am working with html+js mixed code, and I wanted to highlight the html vs js differently, like I do <a href="https://www.redblobgames.com/making-of/circle-drawing/#coordinate-systems">in my tutorial on how I write interactive tutorials</a>.
</p>

<p>
In that blog post from a few years ago, I had used <a href="https://emacs-tree-sitter.github.io/">emacs tree-sitter mode</a> to implement this type of highlighting. Since then, emacs has incorporated <a href="https://www.masteringemacs.org/article/how-to-get-started-tree-sitter">its own tree-sitter mode</a>, which works differently from the third party package. I decided to update my code to work with the new tree-sitter functions.
</p>

<p>
Let&#39;s start with highlighting keywords. This doesn&#39;t really need tree sitter mode, but I&#39;m using it because I want to highlight more in part 2 of this post. The <code>treesit-font-lock-rules</code> function compiles tree sitter <em>patterns</em> into some internal format. Since the set of keywords is different per language, I&#39;m going to make one variable per language. Here&#39;s the one for Python:
</p>

<div>
<pre>(<span>defface</span> <span>amitp-control-keyword-face</span>)
(<span>defvar</span> <span>amitp/python-treesit-settings</span>
  (treesit-font-lock-rules
   <span>:language</span> &#39;python
   <span>:feature</span> &#39;keyword
   <span>:override</span> t
   &#39;(
     ([<span>&#34;assert&#34;</span> <span>&#34;await&#34;</span> <span>&#34;break&#34;</span> <span>&#34;continue&#34;</span> <span>&#34;finally&#34;</span> <span>&#34;raise&#34;</span> <span>&#34;return&#34;</span> <span>&#34;yield&#34;</span>]
      @amitp-control-keyword-face)
     )
   ))
</pre>
</div>

<p>
This will highlight those keywords in my <code>amitp-control-keyword-face</code> instead of the default <code>font-lock-keyword-face</code>.
</p>

<p>
A minor note â€” I had tried reusing my previous tree-sitter face names, which were named with periods (<kbd>variable.horizontal</kbd>) and colons (<kbd>amitp:keyword</kbd>), but I ran into some errors, so I switched to only using dashes (<kbd>variable-horizontal</kbd>) for the new tree sitter modes.
</p>

<p>
I then have to <em>install</em> these highlighting rules into <code>treesit-font-lock-settings</code>, which is a buffer-local variable. So I install it from a hook:
</p>

<div>
<pre>(add-hook &#39;python-ts-mode-hook
          (<span>lambda</span> ()
            (<span>setq-local</span> treesit-font-lock-settings
                        (append treesit-font-lock-settings
                                amitp/python-treesit-settings))))
</pre>
</div>

<p>
That&#39;s all it took to get my keywords highlighting the way I wanted. But wait, there&#39;s more!
</p>

<p>
I had noticed that type aliases didn&#39;t highlight the way I wanted. Here&#39;s the screenshot:
</p>

<figure>
  <img alt="Screenshot shows that the word &#39;type&#39; is not highlighted as a keyword" src="https://www.redblobgames.com/x/screenshots/emacs-highlight-keyword-vs-identifier-before.png"/>
</figure>

<p>
The keyword <kbd>type</kbd> isn&#39;t being highlighted here. I could add it as a keyword like the others:
</p>

<div>
<pre>(<span>defvar</span> <span>amitp/python-treesit-settings</span>
  (treesit-font-lock-rules
   <span>:language</span> &#39;python
   <span>:feature</span> &#39;keyword
   <span>:override</span> t
   &#39;(
     ([<span>&#34;assert&#34;</span> <span>&#34;await&#34;</span> <span>&#34;break&#34;</span> <span>&#34;continue&#34;</span> <span>&#34;finally&#34;</span> <span>&#34;raise&#34;</span> <span>&#34;return&#34;</span> <span>&#34;yield&#34;</span>]
      @amitp-control-keyword-face)
     ([<span>&#34;type&#34;</span>] @font-lock-keyword-face) 
     )
   ))
</pre>
</div>

<p>
Alternatively, I could modify python.el&#39;s <code>python--treesit-keywords</code> to include <kbd>&#34;type&#34;</kbd>.
</p>

<p>
However, unlike other keywords, <kbd>type</kbd> is a <a href="https://docs.python.org/3/reference/lexical_analysis.html#soft-keywords">soft keyword</a> in Python, not a full keyword. That means it can be used in other contexts such a function call:
</p>

<figure>
  <img alt="Screenshot shows that the word &#39;type&#39; can occur as both a keyword and an identifier" src="https://www.redblobgames.com/x/screenshots/emacs-highlight-keyword-vs-identifier-before.png"/>
</figure>

<p>
I don&#39;t want to highlight those uses. I used <kbd>M-x treesit-inspect-mode</kbd> to learn the tree-sitter parse tree context. And then I made the rules highlight the word <code>type</code> <em>only</em> when it occurred in the context of defining a type alias:
</p>

<div>
<pre>(<span>defvar</span> <span>amitp/python-treesit-settings</span>
  (treesit-font-lock-rules
   <span>:language</span> &#39;python
   <span>:feature</span> &#39;keyword
   <span>:override</span> t
   &#39;(
     ([<span>&#34;assert&#34;</span> <span>&#34;await&#34;</span> <span>&#34;break&#34;</span> <span>&#34;continue&#34;</span> <span>&#34;finally&#34;</span> <span>&#34;raise&#34;</span> <span>&#34;return&#34;</span> <span>&#34;yield&#34;</span>]
      @amitp-control-keyword-face)
     ((type_alias_statement <span>&#34;type&#34;</span> @font-lock-keyword-face)) 
     )
   ))
</pre>
</div>

<p>
Here&#39;s the result:
</p>

<figure>
  <img alt="Screenshot shows that the word &#39;type&#39; when used as a keyword is highlighted differently than when used as a function" src="https://www.redblobgames.com/x/screenshots/emacs-highlight-keyword-vs-identifier-after.png"/>
  <figcaption>&#34;type&#34; keyword vs &#34;type&#34; function</figcaption>
</figure>

<p>
This is one of the nice things I get by using tree-sitter highlighting instead of regex highlighting.
</p>

<p>
I also changed import statements to be highlighted the way I want, by marking <kbd>import NAME</kbd> and <kbd>from name import NAME</kbd> in a different face:
</p>

<div>
<pre>  (treesit-font-lock-rules
   <span>:language</span> &#39;python
   <span>:feature</span> &#39;definition
   <span>:override</span> t
   &#39;(
     ((import_statement name: (dotted_name (identifier) @font-lock-variable-name-face)))
     ((import_from_statement module_name: (dotted_name (identifier))
                             name: (dotted_name (identifier) @font-lock-variable-name-face)))
     )
</pre>
</div>

<p>
I&#39;m still experimenting to figure out what rules I want to have. I try things and then delete some of them. I&#39;ve found <kbd>M-x treesit-inspect-mode</kbd> to be quite useful.
</p>

<p>
In part 2 I&#39;ll explore heuristics to highlight based on variable names I commonly use.
</p>
<p>
Labels:
<a href="https://amitp.blogspot.com/search/label/emacs" rel="tag">emacs</a>
</p>

</section></div>
  </body>
</html>
