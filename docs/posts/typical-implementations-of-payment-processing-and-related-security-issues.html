<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kaimi.io/en/2022/07/20-years-of-payment-processing-problems-en/">Original</a>
    <h1>Typical implementations of payment processing and related security issues</h1>
    
    <div id="readability-page-1" class="page"><article id="post-6983">
	<!-- .entry-header -->

	
	
	<div>
		<p><img src="https://kaimi.io/wp-content/uploads/2022/07/header-1024x455.png" alt="" width="840" height="373" srcset="https://kaimi.io/wp-content/uploads/2022/07/header-1024x455.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/header-300x133.png 300w, https://kaimi.io/wp-content/uploads/2022/07/header-768x341.png 768w, https://kaimi.io/wp-content/uploads/2022/07/header-1536x683.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/header-1200x533.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/header.png 1800w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></p>
<p>Electronic payment systems have existed on the Internet for a long time, and some bugs in them are twenty years old. We&#39;ve found critical vulnerabilities allowing us to steal money and drive up the balance. Today we will analyze typical implementations of payment processing and related security issues.</p>

<p><strong>Overview of payment systems and typical API implementations</strong></p>
<p>But let&#39;s go back to the present and list the main modern major payment systems/e-payment services that allow you to accept payments on your own website:</p>
<ul>
<li>PayPal</li>
<li>WebMoney</li>
<li>YooMoney (former Yandex.Money)</li>
<li>Qiwi</li>
<li>Alipay</li>
<li>etc.</li>
</ul>
<p><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/payment-systems.png" alt="" width="804" height="632" srcset="https://kaimi.io/wp-content/uploads/2022/07/payment-systems.png 804w, https://kaimi.io/wp-content/uploads/2022/07/payment-systems-300x236.png 300w, https://kaimi.io/wp-content/uploads/2022/07/payment-systems-768x604.png 768w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></p>
<p>As well as dozens of lesser-known systems with names you are not likely familiar with, not to mention the emergence of hundreds of new ones specializing in cryptocurrencies.</p>
<p>Despite the apparent simplicity, the payment processing, in terms of creating a secure software implementation, is a complex process that still causes problems for both large trading platforms and new electronic payment systems, which periodically enter the market with &#34;new and convenient&#34; APIs and other ways of integration. What does a typical payment processing look like? First, let&#39;s take a look at the current implementation described by PayPal, the so-called PayPal Express Checkout.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/paypal-express.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/paypal-express.png" alt="" width="700" height="562" srcset="https://kaimi.io/wp-content/uploads/2022/07/paypal-express.png 700w, https://kaimi.io/wp-content/uploads/2022/07/paypal-express-300x241.png 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a></p>
<p>This implementation can be considered relatively safe, and here&#39;s why:</p>
<ul>
<li>Payment parameters are not transmitted explicitly, a token is used instead</li>
<li>The server of the payment system does not send the results to some URL on its own, instead your website has to request them and process the response</li>
<li>In general, the interaction layout is implemented in such a way that a potential developer has a minimum of opportunities to &#34;shoot himself in the foot&#34;</li>
</ul>
<p>And now let&#39;s look at the diagram offered by WebMoney:</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/webmoney-workflow.gif" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/webmoney-workflow.gif" alt="" width="595" height="768"/></a></p>
<p>The process diagram doesn&#39;t make any sense. Also, the diagram does not reflect a number of nuances, such as request signing. Or that the URL which receives the technical payment information from the payment system and the URL where the user is redirected to (to view the payment details) should be different. The architecture used by WebMoney often emerges elsewhere, in one form or another, usually in other payment systems that have been created in the Commonwealth of Independent States.</p>
<p><strong>Typical Problems</strong></p>
<p>What was the problem? Earlier I mentioned the URLs on the merchant side that are supposed to accept the payment information. According to <a href="https://wiki.wmtransfer.com/projects/webmoney/wiki/Web_Merchant_Interface" target="_blank" rel="noopener">the documentation</a>, WebMoney has three entities:</p>
<ul>
<li><strong>Success URL</strong> - the URL (on the merchant&#39;s website) to which the buyer&#39;s web browser will be redirected if the payment in the Web Merchant Interface service is successful. The URL can be prefixed with &#34;http://&#34; or &#34;https://&#34;.</li>
<li><strong>Fail URL</strong> - the URL (on the merchant&#39;s website) to which the buyer&#39;s Internet browser will be redirected if the payment in the Web Merchant Interface service has not been completed for some reason. The URL can be prefixed with &#34;http://&#34; or &#34;https://&#34;.</li>
<li><strong>Result URL</strong> - the URL (on the merchant&#39;s website) to which the Web Merchant Interface service sends an HTTP POST or SMTP notification about the payment with its complete details. The URL can be prefixed with &#34;http://&#34;, &#34;https://&#34; or &#34;mailto:&#34;.</li>
</ul>
<p>What some developers do after reading the documentation:</p>
<ol>
<li>Use a single URL, which allows to figure out the address of the handler (also the handler, including the Result URL, can be displayed in the payment form on the WebMoney site, but this does not always happen and probably depends on the settings).</li>
<li>Incorrectly implement signature verification for the request that comes to the Result URL. This allows the customer to substitute payment details.</li>
<li>Check the signature, but don&#39;t check the amount that was sent to the Result URL. This allows you to get a $100 item by paying, for example, $0.01.</li>
<li>Check the signature, the amount, but not the <a href="https://www.php.net/manual/en/language.types.integer.php" target="_blank" rel="noopener">format</a> of the transferred amounts. Remember, I mentioned sending payment parameters through the client&#39;s browser? WebMoney correctly handles the value of <code>1e1</code> or <code>0xFF</code>, but the comparison of such numbers on older versions of PHP, taking into account the <a href="https://www.php.net/manual/en/types.comparisons.php" target="_blank" rel="noopener">nuances of comparisons in the PHP language</a>, can lead to the most unexpected consequences.</li>
<li>Not exactly a payment system problem, but what about <a href="https://en.wikipedia.org/wiki/Race_condition" target="_blank" rel="noopener">race conditions</a> and identical internal payment IDs on the merchant&#39;s server? Hello, balance multiplication.</li>
<li>...</li>
</ol>
<p><strong>Signature of requests​</strong></p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/steam-issue.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/steam-issue-1024x408.png" alt="" width="840" height="335" srcset="https://kaimi.io/wp-content/uploads/2022/07/steam-issue-1024x408.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-300x120.png 300w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-768x306.png 768w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-1536x612.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-1200x478.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue.png 1904w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<ol>
<li>When paying via WebMoney, the users, in accordance with the specifications of the payment system, were redirected to the WebMoney site, where they could see the amount of payment, account number and other parameters.</li>
<li>After pressing the &#34;Next&#34; button and authenticating in the system, information about the URL responsible for processing the payment result (Result URL) became available.</li>
<li>The user could generate a request to the target URL, which, according to the WebMoney specification (well, almost), informed the payment system that the payment was successful.</li>
<li>Profit!</li>
</ol>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2-1024x457.png" alt="" width="840" height="375" srcset="https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2-1024x457.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2-300x134.png 300w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2-768x342.png 768w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2-1536x685.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2-1200x535.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/steam-issue-2.png 1839w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<ol>
<li>Known unified payment results handler.</li>
<li>Lack of signature verification (and no signature in the request as such).</li>
<li>Use of data transmitted through the user&#39;s browser as a trusted source of payment information (although, according to WebMoney specifications, this could be done through a callback coming from WebMoney servers).</li>
</ol>
<p>All this allowed making dummy transactions and buying anything that used Global Collect processing without paying. The problem was eliminated only after ~2 weeks of wide exploitation.</p>
<p>Another similar problem, but a bit more complicated, was recently discovered in <a href="https://hackerone.com/reports/1295844" target="_blank" rel="noopener">Smart2Pay</a>.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/length-extension-2.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/length-extension-2.png" alt="" width="500" height="210" srcset="https://kaimi.io/wp-content/uploads/2022/07/length-extension-2.png 978w, https://kaimi.io/wp-content/uploads/2022/07/length-extension-2-300x126.png 300w, https://kaimi.io/wp-content/uploads/2022/07/length-extension-2-768x324.png 768w" sizes="(max-width: 500px) 85vw, 500px"/></a></p>
<ul>
<li><a href="https://github.com/bwall/HashPump" target="_blank" rel="noopener">https://github.com/bwall/HashPump</a></li>
<li><a href="https://github.com/iagox86/hash_extender" target="_blank" rel="noopener">https://github.com/iagox86/hash_extender</a></li>
</ul>
<p><strong>“Result URL” disclosure​</strong></p>
<p>Repeat the HTTP request a couple of hundred times. After banning our client, the web application throwed an exception. Its text contained the secret URL. By following it, we could finalize the payment.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/woopay-2.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/woopay-2-1024x161.png" alt="" width="840" height="132" srcset="https://kaimi.io/wp-content/uploads/2022/07/woopay-2-1024x161.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/woopay-2-300x47.png 300w, https://kaimi.io/wp-content/uploads/2022/07/woopay-2-768x120.png 768w, https://kaimi.io/wp-content/uploads/2022/07/woopay-2-1536x241.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/woopay-2-1200x188.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/woopay-2.png 1658w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p><strong>Payment attributes</strong></p>
<p>One of the options for integrating with YooMoney (former Yandex.Money) is a <a href="https://yoomoney.ru/docs/payment-buttons/using-api/forms" target="_blank" rel="noopener">money transfer form</a> or its <a href="https://web.archive.org/web/20210225030211/https://yookassa.ru/docs/payment-solution/payment-form/basics" target="_blank" rel="noopener">old implementation</a>. It can be identified by the presence of HTTP requests to the following URLs:</p><!-- Urvanov Syntax Highlighter v2.8.27 -->

		<div id="urvanov-syntax-highlighter-62d5b5994a9b5735519554" data-settings=" minimize scroll-mouseover">
		
			
			
			
			<div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>https</span><span>:</span><span>//yoomoney.ru/eshop.xml</span></p><p><span>https</span><span>:</span><span>//yoomoney.ru/quickpay/confirm.xml</span></p></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Right when you send the request, you need to substitute the payment amount in it:</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/yoomoney-ok-en.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/yoomoney-ok-en.png" alt="" width="700" height="325" srcset="https://kaimi.io/wp-content/uploads/2022/07/yoomoney-ok-en.png 700w, https://kaimi.io/wp-content/uploads/2022/07/yoomoney-ok-en-300x139.png 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a></p>
<p>A small example:</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en-1024x446.png" alt="" width="840" height="366" srcset="https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en-1024x446.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en-300x131.png 300w, https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en-768x335.png 768w, https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en-1536x669.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en-1200x523.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/masha-bot-en.png 1880w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p>The screenshot shows the Telegram voice assistant bot subscription, but the payment amount is not checked, allowing you to purchase it for an arbitrary price. Change <code>1990</code> to <code>19</code> to get it for real cheap. This kind of vulnerability is pretty common (for example, there are many well-known bot services in Telegram which suffer from the same issue), including on popular international resources (an old example – the purchase of a <a href="https://kaimi.io/2011/09/almost-for-free-minecraft/" target="_blank" rel="noopener">Minecraft</a> license). You can still encounter this even in 2022.</p>
<p>Another relevant example, but not related to the payment amount, but rather to the currency, was present in <a href="https://en.wikipedia.org/wiki/Qiwi" target="_blank" rel="noopener">QIWI</a>. You could top up the wallet balance by sending SMS to a short number, and the currency was transmitted through the client&#39;s browser at several stages (selecting the currency and amount, sending SMS), where the server trusted the client&#39;s data. As a result, $100 was credited to the account, for a payment of 100 rubles.</p>
<p>What about 2022?</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/arm-2.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/arm-2-1024x298.png" alt="" width="840" height="244" srcset="https://kaimi.io/wp-content/uploads/2022/07/arm-2-1024x298.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/arm-2-300x87.png 300w, https://kaimi.io/wp-content/uploads/2022/07/arm-2-768x224.png 768w, https://kaimi.io/wp-content/uploads/2022/07/arm-2-1200x349.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/arm-2.png 1278w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p>This means the problem is still relevant.</p>
<p><strong>Formats and types comparison</strong></p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/anti-possible.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/anti-possible-1024x189.png" alt="" width="840" height="155" srcset="https://kaimi.io/wp-content/uploads/2022/07/anti-possible-1024x189.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/anti-possible-300x55.png 300w, https://kaimi.io/wp-content/uploads/2022/07/anti-possible-768x141.png 768w, https://kaimi.io/wp-content/uploads/2022/07/anti-possible-1536x283.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/anti-possible-1200x221.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/anti-possible.png 1878w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p>Another mistake is the peculiarities of typecasting.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/meme.jpeg" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/meme.jpeg" alt="" width="796" height="718" srcset="https://kaimi.io/wp-content/uploads/2022/07/meme.jpeg 796w, https://kaimi.io/wp-content/uploads/2022/07/meme-300x271.jpeg 300w, https://kaimi.io/wp-content/uploads/2022/07/meme-768x693.jpeg 768w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a></p>
<p>NodeJS is another example of a language with dynamic typing. When adding a string to a number, it will concatenate <code>1+&#34;1&#34; = &#34;11&#34;</code>. However, if we subtract a number from the string, the string is converted to the number <code>&#34;11&#34;-1 = 10</code>.</p><!-- Urvanov Syntax Highlighter v2.8.27 -->

		
<!-- [Format Time: 0.0001 seconds] -->
<p>It is obvious, that this JSON is correct: there is the <em>amount</em> parameter with the value 100. But this will also be a valid JSON:</p><!-- Urvanov Syntax Highlighter v2.8.27 -->

		
<!-- [Format Time: 0.0000 seconds] -->
<p>Here, the type of the amount parameter is a <strong>string</strong>. Depending on the algorithm of JSON processing (by the way, interesting <a href="https://bishopfox.com/blog/json-interoperability-vulnerabilities" target="_blank" rel="noopener">relatively related article</a>), someone may add the value of this parameter to the number <code>1337</code>, and the result will be <code>1337100</code>, and not what was originally intended.</p>
<p><strong>Business logic flaws</strong></p>
<ol>
<li>Open the balance top up interface (the balance is $1000, the top up amount is $100).</li>
<li>The web app remembers your current balance.</li>
<li>Meanwhile, we spend money (send it to the second account).</li>
<li>After completing the transaction, the balance will be $1100.</li>
</ol>
<p>What also deserves a special mention, is the shopping cart logic on resources where several currencies are supported. A vulnerability that was found in the Xbox regional store a few years ago (and has re-appeared a couple more times after the fix):</p>
<ol>
<li>You add the product to the shopping cart for the minimum price in rubles.</li>
<li>You look for expensive games in the store, the prices of which are listed in US dollars.</li>
<li>Add them to your cart.</li>
<li>The store calculates the total cost of items, but items with USD prices are recalculated to RUB at a ratio of one to one.</li>
</ol>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/xbox.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/xbox-1024x566.png" alt="" width="840" height="464" srcset="https://kaimi.io/wp-content/uploads/2022/07/xbox-1024x566.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/xbox-300x166.png 300w, https://kaimi.io/wp-content/uploads/2022/07/xbox-768x424.png 768w, https://kaimi.io/wp-content/uploads/2022/07/xbox-1200x663.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/xbox.png 1408w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p>The screenshot above shows that the cost of games in the shopping cart is indicated in rubles, but the actual amount hints that it should have been in dollars (or should be completely different after conversion at the appropriate exchange rate).</p>
<p>Votes on <a href="http://vk.com/" target="_blank" rel="noopener">VKontakte</a> were added by sending the paid SMS while having a near-zero balance. You send an SMS, the telecom operator can&#39;t take the money (there is no <a href="https://en.wikipedia.org/wiki/Overdraft" target="_blank" rel="noopener">overdraft</a>), but the votes are still replenished.</p>
<p>That short number is in fact an alias of a real phone number that is used by the SMS gateway for integration with the API. Apply a little social engineering to the support service:</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/sms-2.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/sms-2-1024x447.png" alt="" width="840" height="367" srcset="https://kaimi.io/wp-content/uploads/2022/07/sms-2-1024x447.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/sms-2-300x131.png 300w, https://kaimi.io/wp-content/uploads/2022/07/sms-2-768x335.png 768w, https://kaimi.io/wp-content/uploads/2022/07/sms-2-1536x670.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/sms-2-2048x893.png 2048w, https://kaimi.io/wp-content/uploads/2022/07/sms-2-1200x523.png 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p><code>Request type: other topic.</code></p>
<p>The next step is to use spoofing services (to <a href="https://en.wikipedia.org/wiki/Caller_ID_spoofing" target="_blank" rel="noopener">spoof Caller ID</a>) to send an SMS from a number of an account with a lot of money. This method has never been tested by me, although in theory it looks extremely promising. Some experts say that it is possible to link a credit card via SMS (in a similar way), and then to drain money from the card.</p>
<p>Now let&#39;s examine the refund operation. If you consider the canonical refund process, it becomes obvious that at each stage it is possible to skip or incorrectly implement some of the checks, which will lead to financial losses.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/refund-1.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/refund-1-1024x556.png" alt="" width="840" height="456" srcset="https://kaimi.io/wp-content/uploads/2022/07/refund-1-1024x556.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/refund-1-300x163.png 300w, https://kaimi.io/wp-content/uploads/2022/07/refund-1-768x417.png 768w, https://kaimi.io/wp-content/uploads/2022/07/refund-1-1200x652.png 1200w, https://kaimi.io/wp-content/uploads/2022/07/refund-1.png 1522w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p><strong>Rounding, integer overflow, and negative numbers</strong></p>
<ol>
<li>A user converts 0.29 RUB to US dollars.</li>
<li>If the value of one dollar is 60 RUB, the amount of 0.29 RUB corresponds to USD 0.0048333333333333333333333333.</li>
<li>This amount will be rounded to two decimal places, i.e. to 0.01 USD (one cent).</li>
<li>Then the user converts 0.01 USD back to rubles and receives 0.60 RUB.</li>
<li>Thus, the user &#34;wins&#34; 0.31 RUB.</li>
</ol>
<p>The problem can still be found in large financial institutions (various banks and exchanges).</p>
<p>If you look closely, you can see the vulnerability, although it is already fixed. Overflows and bugs with negative amount transactions can be encountered periodically, even with banks from the top 100 list. Transaction with a negative amount is a trivial bug when working with signed numbers, and yes, it <strong>still happens too</strong>.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/negative-balance-en.jpeg" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/negative-balance-en.jpeg" alt="" width="480" height="853" srcset="https://kaimi.io/wp-content/uploads/2022/07/negative-balance-en.jpeg 480w, https://kaimi.io/wp-content/uploads/2022/07/negative-balance-en-169x300.jpeg 169w" sizes="(max-width: 480px) 85vw, 480px"/></a></p>
<p><strong>Race condition</strong></p>
<p>A conventionally canonical example:</p>
<ol>
<li>We perform a transaction to transfer funds from the available balance.</li>
<li>We perform the same operation N times, and let&#39;s consider we should run out of balance at (N-1)th request or earlier. Sending requests with minimal delay may exploit the race condition and overcome this limitation (here <a href="https://ru.wikipedia.org/wiki/HTTP_pipelining" target="_blank" rel="noopener">HTTP-pipelining</a>, HTTP2 features (multiple requests within one TCP session), etc. come to rescue).</li>
<li>We get a negative balance, which is not permitted under normal circumstances.</li>
</ol>
<p>A small example related to the cryptocurrency exchange.</p>
<p>The operation algorithm was as follows:</p>
<ol>
<li>We create a take profit of 0,1 BTC, when the price of Bitcoin is $100,000.</li>
<li>The exchange withdraws (locks) 0,1 BTC from the account balance.</li>
<li>We delete the take profit by sending 438695936458926734 requests.</li>
<li>The exchange &#34;returns&#34; 0.1 × N BTC, where N is the number of simultaneous operations.</li>
</ol>
<p>This category of problems is not specific to financial transactions. This also includes problems like <a href="https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use" target="_blank" rel="noopener">TOCTOU</a>, when, for example, the application checks the file signature, then some time passes, and then the application reads the contents of the file (which can be substituted by that time).</p>
<p>One of the problems was present on <a href="http://xss.is/" target="_blank" rel="noopener">xss.is</a> in the system for transferring BTC between accounts.</p>
<p>You can use Burp Suite with the <a href="https://portswigger.net/bappstore/9abaa233088242e8be252cd4ff534988" target="_blank" rel="noopener">Turbo Intruder</a> plugin for testing. And you can read more about this category of problems in <a href="https://lab.wallarm.com/race-condition-in-web-applications/" target="_blank" rel="noopener">this article</a>.</p>
<p>So, we deposit 0.1337 BTC and send a lot of transfer requests.</p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/race-3.jpeg" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/race-3-1024x474.jpeg" alt="" width="840" height="389" srcset="https://kaimi.io/wp-content/uploads/2022/07/race-3-1024x474.jpeg 1024w, https://kaimi.io/wp-content/uploads/2022/07/race-3-300x139.jpeg 300w, https://kaimi.io/wp-content/uploads/2022/07/race-3-768x355.jpeg 768w, https://kaimi.io/wp-content/uploads/2022/07/race-3-1200x555.jpeg 1200w, https://kaimi.io/wp-content/uploads/2022/07/race-3.jpeg 1210w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/race-4.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/race-4-1024x648.png" alt="" width="840" height="532" srcset="https://kaimi.io/wp-content/uploads/2022/07/race-4-1024x648.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/race-4-300x190.png 300w, https://kaimi.io/wp-content/uploads/2022/07/race-4-768x486.png 768w, https://kaimi.io/wp-content/uploads/2022/07/race-4-1536x973.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/race-4-2048x1297.png 2048w, https://kaimi.io/wp-content/uploads/2022/07/race-4-1200x760.png 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/race-5.png" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/race-5-1024x649.png" alt="" width="840" height="532" srcset="https://kaimi.io/wp-content/uploads/2022/07/race-5-1024x649.png 1024w, https://kaimi.io/wp-content/uploads/2022/07/race-5-300x190.png 300w, https://kaimi.io/wp-content/uploads/2022/07/race-5-768x487.png 768w, https://kaimi.io/wp-content/uploads/2022/07/race-5-1536x973.png 1536w, https://kaimi.io/wp-content/uploads/2022/07/race-5-2048x1298.png 2048w, https://kaimi.io/wp-content/uploads/2022/07/race-5-1200x760.png 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"/></a></p>
<p><a href="https://kaimi.io/wp-content/uploads/2022/07/race-6.jpeg" target="_blank" rel="noopener"><img loading="lazy" src="https://kaimi.io/wp-content/uploads/2022/07/race-6.jpeg" alt="" width="712" height="414" srcset="https://kaimi.io/wp-content/uploads/2022/07/race-6.jpeg 712w, https://kaimi.io/wp-content/uploads/2022/07/race-6-300x174.jpeg 300w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px"/></a></p>
<p><strong>Summary</strong></p>
<p>© Kaimi &amp; Bo0oM​</p>
<p>The article was originally posted on 06.22.2022 on <a href="https://xss.is" target="_blank" rel="noopener noreferrer">xss.is</a> forum.</p>
	</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article></div>
  </body>
</html>
