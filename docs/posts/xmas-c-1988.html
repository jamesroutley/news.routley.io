<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://udel.edu/~mm/xmas/">Original</a>
    <h1>Xmas.c (1988)</h1>
    
    <div id="readability-page-1" class="page">

<h2>xmas.c</h2>

 In 1988 an impressive piece of C code named xmas.c
 was a winner in the International Obfuscated C Code Contest.
 After years of being impressed by the program (I first
 saw it around 2000), in November 2008, with some spare time on my hands,
 I decided to rip apart the code and figure out what was going on.

 <h3>The Code</h3>
 <a href="https://udel.edu/~mm/xmas/xmas.c">Click here to download the code.</a>
<xmp>
/*
Least likely to compile successfully: <ian@unipalm.co.uk> Ian Phillipps 

    Ian Phillipps
    Cambridge Consultants Ltd
    Science Park
    Milton Road
    Cambridge CB4 4DW
    England

Compile and run without parameters.

The program is smaller than even the 'compressed' form of its output,
and thus represents a new departure in text compression standards.

The judges thought that this program looked like what you would get
by pounding on the keys of an old typewriter at random.

Copyright (c) 1988, Landon Curt Noll & Larry Bassel.
All Rights Reserved.  Permission for personal, educational or non-profit use
is granted provided this this copyright and notice are included in its entirety
and remains unaltered.  All other uses must receive prior permission in
writing from both Landon Curt Noll and Larry Bassel.
*/

#include <stdio.h>
main(t,_,a)
char
*
a;
{
        return!

0<t?
t<3?

main(-79,-13,a+
main(-87,1-_,
main(-86, 0, a+1 )


+a)):

1,
t<_?
main(t+1, _, a )
:3,

main ( -94, -27+t, a )
&&t == 2 ?_
<13 ?

main ( 2, _+1, "%s %d %d\n" )

:9:16:
t<0?
t<-72?
main( _, t,
"@n'+,#'/*{}w+/w#cdnr/+,{}r/*de}+,/*{*+,/w{%+,/w#q#n+,/#{l,+,/n{n+,/+#n+,/#;\
#q#n+,/+k#;*+,/'r :'d*'3,}{w+K w'K:'+}e#';dq#'l q#'+d'K#!/+k#;\
q#'r}eKK#}w'r}eKK{nl]'/#;#q#n'){)#}w'){){nl]'/+#n';d}rw' i;# ){nl]!/n{n#'; \
r{#w'r nc{nl]'/#{l,+'K {rw' iK{;[{nl]'/w#q#\
\
n'wk nw' iwk{KK{nl]!/w{%'l##w#' i; :{nl]'/*{q#'ld;r'}{nlwb!/*de}'c ;;\
{nl'-{}rw]'/+,}##'*}#nc,',#nw]'/+kd'+e}+;\
#'rdq#w! nr'/ ') }+}{rl#'{n' ')# }'+}##(!!/")
:
t<-50?
_==*a ?
putchar(31[a]):

main(-65,_,a+1)
:
main((*a == '/') + t, _, a + 1 )
:

0&#60;t?

main ( 2, 2 , "%s")
:*a=='/'||

main(0,

main(-61,*a, "!ek;dc i@bK'(q)-[w]*%n+r3#l,{}:\nuwloca-O;m
.vpbks,fxntdCeghiry")

,a+1);}

</xmp>

<h3>The Output</h3>

Amazingly, the output is

<pre>[mm@noise]$ xmas
On the first day of Christmas my true love gave to me
a partridge in a pear tree.

On the second day of Christmas my true love gave to me
two turtle doves
and a partridge in a pear tree.

On the third day of Christmas my true love gave to me
three french hens, two turtle doves
and a partridge in a pear tree.

On the fourth day of Christmas my true love gave to me
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the fifth day of Christmas my true love gave to me
five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the sixth day of Christmas my true love gave to me
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the seventh day of Christmas my true love gave to me
seven swans a-swimming,
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the eigth day of Christmas my true love gave to me
eight maids a-milking, seven swans a-swimming,
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the ninth day of Christmas my true love gave to me
nine ladies dancing, eight maids a-milking, seven swans a-swimming,
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the tenth day of Christmas my true love gave to me
ten lords a-leaping,
nine ladies dancing, eight maids a-milking, seven swans a-swimming,
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the eleventh day of Christmas my true love gave to me
eleven pipers piping, ten lords a-leaping,
nine ladies dancing, eight maids a-milking, seven swans a-swimming,
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.

On the twelfth day of Christmas my true love gave to me
twelve drummers drumming, eleven pipers piping, ten lords a-leaping,
nine ladies dancing, eight maids a-milking, seven swans a-swimming,
six geese a-laying, five gold rings;
four calling birds, three french hens, two turtle doves
and a partridge in a pear tree.
</pre>

<h3>Analysis</h3>

So, how in the world was this accomplished?  First, the code needs to be
rewritten in a more legible manner.  Let&#39;s replace all <tt>a ? b : c</tt>
constructs with explicit <tt>if-then-else</tt> blocks.  Additionally, it is
helpful to define character strings whose names will become clear shortly.

<pre>#include &lt;stdio.h&gt;

char *words =
&#34;@n&#39;+,#&#39;/*{}w+/w#cdnr/+,{}r/*de}+,/*{*+,/w{%+,/w#q#n+,/#{l+,/n{n+,/+#n+,/#\
;#q#n+,/+k#;*+,/&#39;r :&#39;d*&#39;3,}{w+K w&#39;K:&#39;+}e#&#39;;dq#&#39;l \
q#&#39;+d&#39;K#!/+k#;q#&#39;r}eKK#}w&#39;r}eKK{nl]&#39;/#;#q#n&#39;){)#}w&#39;){){nl]&#39;/+#n&#39;;d}rw&#39; i;# \
){nl]!/n{n#&#39;; r{#w&#39;r nc{nl]&#39;/#{l,+&#39;K {rw&#39; iK{;[{nl]&#39;/w#q#n&#39;wk nw&#39; \
iwk{KK{nl]!/w{%&#39;l##w#&#39; i; :{nl]&#39;/*{q#&#39;ld;r&#39;}{nlwb!/*de}&#39;c \
;;{nl&#39;-{}rw]&#39;/+,}##&#39;*}#nc,&#39;,#nw]&#39;/+kd&#39;+e}+;#&#39;rdq#w! nr&#39;/ &#39;) }+}{rl#&#39;{n&#39; &#39;)# \
}&#39;+}##(!!/&#34;;

char *shift = &#34;!ek;dc i@bK&#39;(q)-[w]*%n+r3#l,{}:\nuwloca-O;m .vpbks,fxntdCeghiry&#34;;

main() {
    xmas(1, 0, &#39;\0&#39;);
}

xmas(int t, int _, char *a) {

    if (t &lt; -72) {
        return xmas(_, t, words);
    }

    if (t &lt; -50) {
        if (_ == *a) {
            return putchar(a[31]);
        } else {
            return xmas(-65, _, a+1);
        }
    }

    if (t &lt; 0) {
        return xmas((*a == &#39;/&#39;)+t, _, a+1);
    }

    if (t == 0) {
        if (*a == &#39;/&#39;) {
            return 1;
        } else {
            return xmas(0, xmas(-61, *a, shift), a+1);
        }
    }

    if (t == 1) {
        return xmas(2, 2, &#34;%s&#34;);
    }

    if (t == 2)
        xmas(-79, -13, a + xmas(-87, 1-_, a + xmas(-86, 0, a+1)));

    if (t &lt; _)
        xmas(t+1, _, a);

    if (xmas(-94, -27+t, a) &amp;&amp; t == 2) {
        if (_ &lt; 13)
            return xmas(2, _+1, &#34;%s %d %d\n&#34;);
        else
            return 9;
    } else {
        return 16;
    }
}
</pre>

Already we can see some hint of what is happening.  The variable <tt>t</tt> has
special significance in controlling the direction of recursion.  The
first conditional, <tt>if (t &lt; -72)</tt>, is just misdirection mostly
for the fun of
it.  It swaps the first two arguments and recurses using the encrypted string
of words for the final argument.  The utility of the conditional is how it
allows nested recursion as seen in the <tt>if (t == 2)</tt> block by ignoring
the third argument.

<p>The second block has more real work going on.  If the character stored
in the variable <tt>_</tt> does not match the first character of the
string <tt>a</tt>, the code recurses in such a way that this same block
of code will again be entered.  That is, <tt>t=-65</tt> forces a return
to the <tt>if (t &lt; -50)</tt> block.  The recursion steps through string
<tt>a</tt>, character by character.  When finally <tt>_ == a</tt>, the
character at <tt>a+31</tt> is printed and returned.

</p><p>Further study shows why this is done.  The string I renamed to
<tt>shift</tt> is really two strings concatenated.  A character found in the
first half of the string is 31 places away from its decoded equivalent.  For
instance, the exclamation point at the first place in the string is followed 31
places later by a newline.  So the string offers the solution to a
substitution cipher.

</p><p>In the code below, comments are added.  The variable <tt>shift</tt> has a
comment under it lining up the decoded (shifted by 31) values of the string.
For example, under the first character <tt>!</tt>, is character in the string
shifted by 31 places, the newline character.  The encoded/decoded halves of
the string are separated at the colon character.

</p><p>The other variable, newly named <tt>words</tt> in the code below, is the
set of encrypted words used to print the Christmas carol lyrics.  Using the
cipher solution string, the words have been decoded in the comments of the
source code below.  Notice that the ordinal numbers and lines of verses are
separated by slash characters.

</p><p>The third conditional, <tt>if (t &lt; 0)</tt> is used to find <tt>|t|</tt> slash
characters and then after <tt>t</tt> recursions, to return <tt>xmas(0, _,
a+1)</tt>, where <tt>a+1</tt> is the string starting at the character after the
slash.  Again, through recursion it simply gets us to the character after 
|t|&#39;th slash.  The next call goes into the conditional block described next.

</p><p>The fourth conditional, <tt>if (t == 0)</tt>, uses recursion with the
2nd conditional block, <tt>t &lt; -50</tt>, to print out the decoded string up
to the next slash and then returns 1.

</p><p>The <tt>t == 1</tt> block is used just a single time at the start to get
the recursion going properly, that is, with <tt>xmas(2, 2, &#34;%s&#34;)</tt> where
the string is unimportant because it is never used.

</p><p>The <tt>t == 2</tt> block is used to print &#34;On the <i>[ordinal]</i> day of
Christmas my true love gave to me\n&#34;.

</p><p>The final two conditional blocks keep the recursion running in two
directions.  First, the final block counts up to day 12.  The second
to last block, counts down from the current day to print lyrics of the
current verse in reverse order.

</p><pre>#include &lt;stdio.h&gt;

<SPAN color="#0000ff">/*
 * Substitution cipher solution.  Letters up to and including the colon are 
 * shifted by 31 places to the right to find the decoded value.
 */</SPAN>
char *shift = &#34;!ek;dc i@bK&#39;(q)-[w]*%n+r3#l,{}:\nuwloca-O;m .vpbks,fxntdCeghiry&#34;;
<SPAN color="#0000ff">         /*  &#34;\nuwloca-O;m .vpbks,fxntdCeghiry&#34;; */</SPAN>

char *words =
&#34;@n&#39;+,#&#39;/*{}w+/w#cdnr/+,{}r/*de}+,/*{*+,/w{%+,/w#q#n+,/#{l+,/n{n+,/+#n+,/#\
;#q#n+,/+k#;*+,/&#39;r :&#39;d*&#39;3,}{w+K w&#39;K:&#39;+}e#&#39;;dq#&#39;l \
q#&#39;+d&#39;K#!/+k#;q#&#39;r}eKK#}w&#39;r}eKK{nl]&#39;/#;#q#n&#39;){)#}w&#39;){){nl]&#39;/+#n&#39;;d}rw&#39; i;# \
){nl]!/n{n#&#39;; r{#w&#39;r nc{nl]&#39;/#{l,+&#39;K {rw&#39; iK{;[{nl]&#39;/w#q#n&#39;wk nw&#39; \
iwk{KK{nl]!/w{%&#39;l##w#&#39; i; :{nl]&#39;/*{q#&#39;ld;r&#39;}{nlwb!/*de}&#39;c \
;;{nl&#39;-{}rw]&#39;/+,}##&#39;*}#nc,&#39;,#nw]&#39;/+kd&#39;+e}+;#&#39;rdq#w! nr&#39;/ &#39;) }+}{rl#&#39;{n&#39; &#39;)# \
}&#39;+}##(!!/&#34;;

<SPAN color="#0000ff">/*
  Decoded values of &#39;words&#39; using the substitution cipher string &#39;shift&#39;:

&#34;@n&#39;+,#&#39;/*{}w+/w#cdnr/+,{}r/*de}+,/*{*+,/w{%+,/w#q#n+,/#{l+,/n{n+,/+#n+,/#\
 <SPAN color="#00ff00">On the /first/second/third/fourth/fifth/sixth/seventh/eigth/ninth/tenth/e </SPAN>

;#q#n+,/+k#;*+,/&#39;r :&#39;d*&#39;3,}{w+K w&#39;K:&#39;+}e#&#39;;dq#&#39;l \
<SPAN color="#00ff00">leventh/twelfth/ day of Christmas my true love ga </SPAN>

q#&#39;+d&#39;K#!/+k#;q#&#39;r}eKK#}w&#39;r}eKK{nl]&#39;/#;#q#n&#39;){)#}w&#39;){){nl]&#39;/+#n&#39;;d}rw&#39; i;# \
<SPAN color="#00ff00">ve to me0/twelve drummers drumming, /eleven pipers piping, /ten lords a-lea </SPAN>

){nl]!/n{n#&#39;; r{#w&#39;r nc{nl]&#39;/#{l,+&#39;K {rw&#39; iK{;[{nl]&#39;/w#q#n&#39;wk nw&#39; \
<SPAN color="#00ff00">ping,0/nine ladies dancing, /eight maids a-milking, /seven swans a\ </SPAN>

iwk{KK{nl]!/w{%&#39;l##w#&#39; i; :{nl]&#39;/*{q#&#39;ld;r&#39;}{nlwb!/*de}&#39;c \
<SPAN color="#00ff00">-swimming,0/six geese a-laying, /five gold rings;0/four ca
</SPAN>

;;{nl&#39;-{}rw]&#39;/+,}##&#39;*}#nc,&#39;,#nw]&#39;/+kd&#39;+e}+;#&#39;rdq#w! nr&#39;/ &#39;) }+}{rl#&#39;{n&#39; &#39;)# \
<SPAN color="#00ff00">lling birds, /three french hens, /two turtle doves0and /a partridge in a pea </SPAN>

}&#39;+}##(!!/&#34;;
<SPAN color="#00ff00">r tree.00/ </SPAN>

*/</SPAN>

main() {
    xmas(1, 0, &#39;\0&#39;);
}

xmas(int t, int _, char *a) {

    <SPAN color="#0000ff">/* Swap first two args and use new 3rd. */</SPAN>
    if (t &lt; -72) {
        return xmas(_, t, words);
    }

    <SPAN color="#0000ff">/*
     * Loop through a till a==_, then print char at a+31.
     * That is, given character in variable &#39;_&#39; and substitution cipher
     * solution in &#39;a&#39;, decode character &#39;_&#39; and print &amp; return it.
     */</SPAN>
    if (t &lt; -50) {
        if (_ == *a) {
            return putchar(a[31]);
        } else {
            <SPAN color="#0000ff">/* Loop until _ == *a. */</SPAN>
            return xmas(-65, _, a+1);
        }
    }

    <SPAN color="#0000ff">/*
     * Loop until finding -t number of slash characters in a[] and
     * return string starting at character after that slash.
     */</SPAN>
    if (t &lt; 0) {
        return xmas((*a == &#39;/&#39;)+t, _, a+1);
    }

    <SPAN color="#0000ff">/*
     * Decode &amp; print word up to next slash character and then return 1.
     */</SPAN>
    if (t == 0) {
        if (*a == &#39;/&#39;) {
            return 1;
        } else {
            return xmas(0, xmas(-61, *a, shift), a+1);
        }
    }

    <SPAN color="#0000ff">/*
     * Start off recursion.  Only called once at very start.
     */</SPAN>
    if (t == 1) {
        return xmas(2, 2, &#34;%s&#34;);
    }

    if (t == 2)
        xmas(-79, <SPAN color="#0000ff">/* &#34; day of Christmas my true love gave to me\n&#34; */</SPAN>
             -13,
             a + xmas(-87, <SPAN color="#0000ff">/* print which day of Christmas it is */</SPAN>
                      1-_,
                      a + xmas(-86, 0, a+1))); <SPAN color="#0000ff">/* &#34;On the &#34; */</SPAN>

    <SPAN color="#0000ff">/*
     * Recurse, count down days of Christmas
     * from &#39;_&#39; to print lyrics of current verse in reverse day order.
     * I.e., day 12, day 11, etc.
     */</SPAN>
    if (t &lt; _)
        xmas(t+1, _, a);

    <SPAN color="#0000ff">/*
     * Print phrase for current verse.
     * E.g., t == 2: &#34;a partridge in a pear tree\n\n&#34;
     * etc.
     */</SPAN>
    if (xmas(-94, -27+t, a) &amp;&amp; t == 2) {
        if (_ &lt; 13)
            <SPAN color="#0000ff">/* Recurse to next higher day of Christmas.  String not used. */</SPAN>
            return xmas(2, _+1, &#34;%s %d %d\n&#34;);
        else
            <SPAN color="#0000ff">/* Just misdirection, return value not used. */</SPAN>
            return 9;
    } else {
        <SPAN color="#0000ff">/* More misdirection! */</SPAN>
        return 16;
    }
}
</pre>

<h2>Simpler</h2>

With new understanding of what&#39;s going on, the program can be simplified
by using some iteration and C string library routines.  I have to admit to
preferring recursion myself, but since the analysis has gone this far, let&#39;s
not stop now.  Here&#39;s what we might see after further simplification:

<pre>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

char *words =
&#34;@n&#39;+,#&#39;/*{}w+/w#cdnr/+,{}r/*de}+,/*{*+,/w{%+,/w#q#n+,/#{l+,/n{n+,/+#n+,/#\
;#q#n+,/+k#;*+,/&#39;r :&#39;d*&#39;3,}{w+K w&#39;K:&#39;+}e#&#39;;dq#&#39;l \
q#&#39;+d&#39;K#!/+k#;q#&#39;r}eKK#}w&#39;r}eKK{nl]&#39;/#;#q#n&#39;){)#}w&#39;){){nl]&#39;/+#n&#39;;d}rw&#39; i;# \
){nl]!/n{n#&#39;; r{#w&#39;r nc{nl]&#39;/#{l,+&#39;K {rw&#39; iK{;[{nl]&#39;/w#q#n&#39;wk nw&#39; \
iwk{KK{nl]!/w{%&#39;l##w#&#39; i; :{nl]&#39;/*{q#&#39;ld;r&#39;}{nlwb!/*de}&#39;c \
;;{nl&#39;-{}rw]&#39;/+,}##&#39;*}#nc,&#39;,#nw]&#39;/+kd&#39;+e}+;#&#39;rdq#w! nr&#39;/ &#39;) }+}{rl#&#39;{n&#39; &#39;)# \
}&#39;+}##(!!/&#34;;

char *shift = &#34;!ek;dc i@bK&#39;(q)-[w]*%n+r3#l,{}:\nuwloca-O;m .vpbks,fxntdCeghiry&#34;;

main() {
    xmas(2, 2, &#34;&#34;);
}

xmas(int t, int _, char *a) {

    <SPAN color="#0000ff">/*
     * Loop until finding |t| number of slash characters in a[] and
     * return string starting at character after that slash.
     */</SPAN>
    if (t &lt; 0) {
        while (t++ &lt; 0)
            a = 1 + index(a, &#39;/&#39;);
        return xmas(0, _, a);
    }

    <SPAN color="#0000ff">/*
     * Decode &amp; print word up to next slash character and return 0 or any int.
     */</SPAN>
    if (t == 0) {
        while (*a != &#39;/&#39;)
            putchar(index(shift, *a++)[31]); <SPAN color="#0000ff">/* Decode *a and print it. */</SPAN>
        return 0;
    }

    if (t == 2) {
        <SPAN color="#0000ff">/* 2nd arg is a don&#39;t-care since it&#39;s unused. */</SPAN>
        xmas(0, 0, words); <SPAN color="#0000ff">/* &#34;On the &#34; */</SPAN>
        xmas(1-_, 0, words); <SPAN color="#0000ff">/* print which day of Christmas it is */</SPAN>
        xmas(-13, 0, words); <SPAN color="#0000ff">/* &#34; my true love gave to me\n&#34; */</SPAN>
    }

    <SPAN color="#0000ff">/*
     * Recurse and count down days of Christmas
     * from &#39;_&#39; down to and including day 2.
     */</SPAN>
    if (t &lt; _)
        xmas(t+1, _, a);

    <SPAN color="#0000ff">/*
     * t==2: &#34;a partridge in a pear tree\n\n&#34;
     * etc.
     */</SPAN>
    xmas(-27+t, 0, words);
    if (t == 2 &amp;&amp; _ &lt; 13)
        return xmas(2, _+1, &#34;&#34;); <SPAN color="#0000ff">/* Next higher day of Christmas. */</SPAN>
}
</pre>

<h2>In Conclusion...</h2>

This could go on till the ultimate simplification of doing nothing more than
printing out the lyrics, but you get the idea.  This is one of the better
obfuscated C programs I&#39;ve come across because of using the
substitution cipher along with recursion.  That was followed by the addition
of a small bit of unnecessary code and use of random arguments when the
arguments were in fact not made use of.  A very nice little bundle of C
code!

<p>Understanding what&#39;s happening is still a long way from writing it.  What a
great example of creativity.

</p><p>Merry Christmas!<!-- Start of StatCounter Code -->



<!-- End of StatCounter Code -->



</p></div>
  </body>
</html>
