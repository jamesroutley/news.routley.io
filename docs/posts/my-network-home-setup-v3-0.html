<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://giuliomagnifico.blog/networking/2022/08/14/home-network_v3.html">Original</a>
    <h1>My network home setup v3.0</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <div>
  <section>

     <div>
  <section>









<article itemscope="" itemtype="http://schema.org/BlogPosting">

    <div itemprop="articleBody">

      <p>The previous releases/posts to read, are:</p>

<ul>
  <li>
    <p><a href="https://giuliomagnifico.blog/networking/2022/01/14/my-home-setup.html" target="\_blank">My hardware and software setup for a new house</a></p>
  </li>
  <li>
    <p><a href="https://giuliomagnifico.blog/networking/2022/06/02/my-network-home-setup.html" target="\_blank">My network home setup - v2.0</a></p>
  </li>
</ul>

<p>Changelog for this <em>v3.0</em></p>

<p>from: <code>Modem -&gt; wireless router -&gt; internet</code></p>

<p>to: <code>Modem -&gt; router -&gt; managed switch - access point -&gt; internet</code></p>

<p>Improving some features and keeping almost the same settings. Here are some final photos:</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_6659.jpg" alt="setupv3"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_6656.jpg" alt="setupv3"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_6664.jpg" alt="setupv3"/></p>

<h2 id="introduction">Introduction</h2>

<p>All is started because I wanted to improve my home network since I’m waiting for the FTTH upgrade at 1000/200Mbps. And my actual configuration is far to handle 1Gbps connection, the R7800 is fantastic but is unable to do NAT and SQM shaping at 1Gbps, and the new Macs M1/M2 are using the new Wi-Fi  AX/6 that is not supported in the R7800. I get a maximum speed of 866mbps on 2x2 antenna with Wi-Fi 5. Ironically, my older intel iMac was able to use 1166mbps on 3x3 antenna on Wi-Fi 5. 
So I needed a more powerful router device capable to handle the speed of 1Gbps and I also need a Wi-Fi 6/AX access point.</p>

<p>My idea at the beginning was to buy a new router with Wi-Fi 6, but at the moment (July 2022) OpenWRT doesn’t support any serious AX router, it only supports some basic AX routers. So I have to use one of those for the Wi-Fi but I have to use a(nother) powerful device to route the traffic. 
For this feature I choose the NanoPi R4S (link) that’s a  small ARMv8 device from FriendlyElec with a powerful exa core CPU, a WAN and a LAN port. Looks perfect to be used with OpenWRT (the default software is already OpenWRT, only maintained and customized by FriendlyElec). 
I also prefer the idea to have two different devices to do two different things.</p>

<p>This router is capable to handle SQM shaping at 900+mbps, is not very expensive (130€ on Amazon, and we’re inside the inflation crisis) and is well supported by OpenWRT community also in the latest master 22.02rc.</p>

<p>I had to be careful to choose the R4S model with 4GB of RAM, not the 1GB or R4SE model (because the 1GB version is not officially supported and the same for the SE because it has the microSD slot but also 32GB eMMC storage). 
I’ve also read about some issues such as random reboot or some issues with the soft reboot due to not enough power to the microSD card, but my unit (maybe because is newer) doesn’t suffer from any of these issues.</p>

<p>So I received the nanoPi R4S and started to replace the R7800 with it:</p>

<h2 id="r4s-configuration">R4S configuration</h2>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_6531.jpg" alt="R4S"/></p>

<p>Official OpenWRT wiki page as reference: <a href="https://openwrt.org/toh/friendlyarm/nanopi_r4s_v1">FriendlyARM nanoPi R4S</a></p>

<p>First step is to write the ext4 OpenWRT image to the microSD (link download), then ‘ssh @root 192.168.1.1’ and the first thing I’ve done was to install LuCi, so ‘opkg update’…and it was not working nor ping anything. So I checked the network config ‘cat /etc/default/network’ and I saw that there isn’t the DNS and gateway.</p>

<p>Then I edited with VI the network config file and I added the gateway and DNS to the LAN (because opkg needs the DNS to resolve the repositories and install the packages):</p>

<div><div><pre><code>config interface &#39;lan&#39;
	option device &#39;br-lan&#39;
	option proto &#39;static&#39;
	option netmask &#39;255.255.255.0&#39;
	list dns &#39;192.168.1.4&#39;
	option ipaddr &#39;192.168.1.2&#39;
</code></pre></div></div>

<p>After, I downloaded LuCI, in order to have a comfortable view to start to configure all the settings, but before this I thought a lot on how to configure it to avoid to make a mess with the R7800.</p>

<p>I decided to use the address of <em>192.168.1.10</em> for the R4S (<em>.1.2</em> the R7800) and I added an old TP-Link router in access point mode to <em>.1.11</em>. Why? Because with this setup I was able to test if the R4S was working as WAN router + access point, simply by turning off the R7800 and change the gateway of my test client to <em>192.168.1.10</em> (or the R4S IP to <em>.1.2</em>)., without make any change to the R7800.</p>

<p>Since I couldn’t simply import the R7800 backup to the R4S, because the R7800 has a switch that’s software based, and the R4S is DSA based, I had to rewrite all the network settings. 
It’s possible also to copy/paste them but you have to be careful because some syntax names are different, i.e. <code>eth0.1</code> instead of <code>eth0</code> and other issues with VLANs. So I preferred  to reconfigure the WAN, LAN, modem, firewall, etc…</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-13%20at%2008.38.54.jpeg" alt="r4s-network"/></p>

<p>Tested it and it was working fine and it was acquiring the WAN IP.</p>

<p>So I decided to turn off the R7800, change the IP of the R4S to <em>192.168.1.2</em> (the IP assigned to the R7800) and use the old TP-Link router as an access point with the same SSID and password as it was on the R7800 (in order to have all the clients that can connect to it without knowing that is another router. For testing only obviously)</p>

<p>Rebooted all the devices and all was working fine. 
At this point I decided to use the R7800 as Access Point only and so, I disconnected the WAN cable from the it and I changed its IP to <em>192.168.1.3</em>, in order to have the R4S -router- on <em>.1.2</em> and the R7800 -access point- on <em>.1.3</em>  (with only LAN access).</p>

<p>Then I had to reconfigure in the R4S the same environment also for the packages and other settings.</p>

<p>For the opkg section I chosen to put one window of the R7800 behind one of the R4S and manually search-install only the packages I need, and since I love the minimal setup, if I didn’t remember if I was using one packet or not, I decided to not install it. So I installed all the the “Prometheus and collectd” exporter, the DDNS, SQM, WireGuard, Network Bandwitch Monitor, LuCi stats, etc… but it was easy and fast.</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-07-31%20at%2008.11.10.jpeg" alt="opkg-config"/></p>

<p>When I finished with the packages I configured them again following the previous settings as the R7800.</p>

<p>For the WireGuard setting I copied-pasted the keys and all the other settings, and my clients went able to connect to my VPN in the same way as before without re-configure all.</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-07-31%20at%2017.24.23.jpeg" alt="wireguard-config"/>
(as you can see the WAN was <em>eth0.2</em> -sfw config- now <em>eth0</em> -DSA config- )</p>

<p>Then I attached the USB drive I was using to save all the data of the R7800 captured by <em>collectd</em> and the network stats from <em>nlbwmon</em>, without  format or delete something. I mounted the drive and configured the <em>RRDtool</em>  to write on it (<em>/mnt/sda1</em>). It will create a new folder called with name of your device (R4S in my case) and your old folder -R7800- will remain intact. Same for nlbwmon.</p>

<p>All was working inside the R4S but the hard thing is to have all that work fine on the Grafana server.</p>

<p>As expected, when I opened the page of my Grafana server (<em>192.168.1.6:3001</em>) I saw lots of blanks graphs. But this was not due my fault but because the R4S don’t have Wi-Fi, normal and expected.</p>

<p>So I went inside the Grafana server (a RaspberryPI, see <a href="https://giuliomagnifico.blog/networking/2022/06/02/my-network-home-setup.html#h-r7800-router--openwrt--tasty-stats" target="\_blank">the old config post</a>) and I added to the Prometheus config file (<em>prometheus.yml</em>)  also the R7800 field, in order to collect the Wi-Fi stats from the R7800 and the other stats from the R4S. All in the same Grafana instance.</p>

<div><div><pre><code>   static_configs:
    - targets: [&#34;localhost:9090&#34;]
    - targets: [&#34;192.168.1.2:9100&#34;]
    - targets: [&#34;192.168.1.3:9100&#34;]
    - targets: [&#34;192.168.1.6:9103&#34;]

remote_write:
 - url: https://prometheus-prod-01-eu-west-0.grafana.net/api/prom/push
   basic_auth:
    username: #
    password: #
</code></pre></div></div>

<p>And I started to configure the Wi-Fi panels in order to retrieve the data from the changed <em>exported_instance</em> to R7800, as below:</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-15%20at%2008.06.41.jpeg" alt="Grafana-panel"/></p>

<p>I also left the <em>collect-node-exporter</em> plug-in on the R7800, in order to retrieve also the temperature of it.</p>

<p>When all the graphs are configured I had a nice setup that gives me both the R4S stats and R7800 stats all in one instance/dashboard, but I can also switch to view the temperature, RAM and CPU usage of the R7800, by simply changing the <em>host</em>.</p>

<p>Watch the below gif:</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/dash1.gif" alt="Grafana-dash"/></p>

<p>This is handy because with both stats/istances I can have also push notifications of different parameters for both the R7800 and R4S all together. For example when the R7800 records a Wi-Fi noise below -100dBm or when the temperature is over 60°C, but also the push notifications from the R4S for example when there’s a spike in the SQM istance, or load is over 0.1, etc.. here are some of my Grafana triggers that send me the push notifications via Pushover:</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-13%20at%2013.32.20.jpeg" alt="Grafana-alerts"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_410A96097612-1.jpeg" alt="Pushover-iOS"/></p>

<p>And since in the <em>prometheus.yml</em>  I added also the <em>remote_write</em> setting, this mean the server is writing to my free Grafana Cloud account, and I can also view the same dashboard from everywhere outside my LAN and without turn on the home VPN.</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-13%20at%2013.24.02.jpeg" alt="Remote-Grafana"/></p>

<p>To have the same identical dashboard on the cloud account you need to paste your local .json config but remember that when you copy the .json from local to cloud, in order to save it without errors you need to change all the database source/id with the id of your cloud database of course. And also replace the dashboard id + uid:</p>

<p><code>&#34;id&#34;: local21id,</code> to <code>&#34;id&#34;: previous-cloud -id,</code></p>

<p><code>&#34;uid&#34;: &#34;local-xyz&#34;</code> to <code>&#34;uid&#34;: &#34;your-grafanacloud-db&#34;</code></p>

<p>and uid + version at the end of the json to match the cloud .json (save it before override):</p>

<div><div><pre><code>  &#34;timezone&#34;: &#34;browser&#34;,
  &#34;title&#34;: &#34;OpenWrt cloud&#34;,
  &#34;uid&#34;: &#34;0CCohKrafr&#34;,
  &#34;version&#34;: 33,
  &#34;weekStart&#34;: &#34;&#34;
</code></pre></div></div>
<h2 id="access-point-r7800">Access Point R7800</h2>

<p>At the moment I’m still using the R7800 as access point, because I’m waiting for a better support of  OpenWrt for this protocol, since I tried the Netgear WAX202 with OpenWrt but I was not happy of the Wi-Fi coverage and speed. If you’re near the router the speed is superior to the R7800, but just few meters/one wall away and the speeed decreases consistently (ax drivers are still quite new)</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/18c18e4453b7f819f7ab7e9d1e03b11daa5a71c4.jpeg" alt="test-WAX202"/></p>

<p>Anyway in order to setup the R7800 (or any other OpenWrt router) to work as an access point is very easy. I deleted all the network interfaces and I left only the LAN, then just assign to it another IP (<em>192.168.1.3</em>), and the gateway of your main router (<em>.1.2</em>). And I left the wireless interfaces as they were. I also deleted all the QoS packages/scripts because this will be done by the R4S, and I also deleted a startup script that was keeping the R7800 CPU stuck at 1.7GHz, because now I prefer that it’s able to scale from 0.6GHz go 1.7Ghz, since I don’t need all the CPU instant power (and heat) to work only as AP. 
But anyway there’s an easy guide on the OpenWrt website: <a href="https://openwrt.org/docs/guide-user/network/wifi/dumbap" target="\_blank">Wireless Access Point / Dumb Access Point</a>.</p>

<p>And a new configuration that I had to do on the Access Point -R7800- was the Guest WLAN. These are a new wireless and network interfaces that are separated and isolated from the main LAN, in order to let the clients connected to the Guest Wi-Fi able to have internet access, also retrieve DNS and DHCP, but unable to have access of the main LAN.</p>

<p>This could have been done in different ways: by creating a virtual interface on the R4S and assigning it to a separate VLAN, or using the VLAN feature in the switch, but I don’t like virtual interfaces nor dedicate a switch port to a VLAN.</p>

<p>I’ve made this on the R7800 in this way:</p>
<ul>
  <li>I created the network interface on a different subnet (<em>192.168.3.1</em>), assigned it to a new firewall zone and enabled the DHCP on this interface</li>
  <li>Then I created a new wireless interface -Magnifico Guest- bridged to the Guest network interface and with isolated clients.</li>
  <li>Inside the firewall I assigned the masquerades option to the Guest interface to LAN so the clients can retrieve the DNS informations from my local Unbound recursive server from the main LAN, and the clients can also benefit from the Pi-Hole adblocker, but they can’t browse other devices on the main LAN</li>
</ul>

<p>Network interface:</p>
<div><div><pre><code>config interface &#39;guest&#39;
	option proto &#39;static&#39;
	option ipaddr &#39;192.168.3.1&#39;
	option netmask &#39;255.255.255.0&#39;
	option type &#39;bridge&#39;
	option device &#39;wlan0-1&#39;
	list dns &#39;192.168.1.4&#39;
</code></pre></div></div>
<p>Wireless interface:</p>
<div><div><pre><code>config wifi-iface &#39;guest&#39;
	option device &#39;radio0&#39;
	option mode &#39;ap&#39;
	option ssid &#39;Magnifico Guest&#39;
	option key &#39;###&#39;
	option encryption &#39;psk-mixed&#39;
	option isolate &#39;1&#39;
	option network &#39;guest&#39;
</code></pre></div></div>
<p>Firewall:</p>
<div><div><pre><code>config zone &#39;guest&#39;
	option name &#39;guest&#39;
	list network &#39;guest&#39;
	option input &#39;REJECT&#39;
	option forward &#39;REJECT&#39;
	list device &#39;br-lan&#39;
	option masq &#39;1&#39;
	option output &#39;ACCEPT&#39;
	option family &#39;ipv4&#39;

config forwarding
	option src &#39;guest&#39;
	option dest &#39;lan&#39;

config rule
	option name &#39;Guest-DNS&#39;
	option src &#39;guest&#39;
	option target &#39;ACCEPT&#39;
	option family &#39;ipv4&#39;
	option src_port &#39;53&#39;
	list proto &#39;all&#39;

config rule
	option src &#39;guest&#39;
	option dest &#39;lan&#39;
	option name &#39;Block-Guest-LAN&#39;
	list dest_ip &#39;192.168.1.1/24&#39;
	option target &#39;REJECT&#39;
</code></pre></div></div>

<p>The configs in LuCi:</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-14%20at%2008.41.42.jpeg" alt="config-guest"/>
<img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-14%20at%2008.42.12.jpeg" alt="config-guest"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-14%20at%2008.39.30.jpeg" alt="config-guest"/></p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-14%20at%2013.48.40.jpeg" alt="config-guest"/></p>

<p>And a gif of the result of what I mean for “unable to browse the other devices in LAN”:</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/RPReplay_Final1660478171.gif" alt="Guest-access"/></p>

<p>Just to make a recap, in the end the overall configurations are:</p>
<ul>
  <li>On both, router and AP, the Collectd instance with Prometheus exporter plug-in</li>
  <li>The <em>prometheus.yml</em> that retrieves info from two local addresses</li>
  <li>
<em>remote_write</em> of Prometheus to my Grafana cloud</li>
  <li>A simply touch to view the stats of one or another router</li>
  <li>A unique Pushover instance that send on my phone the alerts from both routers</li>
  <li>The AP with a guest WLAN separated from the main LAN but able to use the Pi-Hole/Unbound for the DNS resolving and adblocking.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Latest things to do were only to configure the QoS ports priority on the Netgear switch</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-13%20at%2014.00.16.jpeg" alt="switch ports"/></p>

<p>I’ve build some ethernet cables ethernet with the correct length, and with these <a href="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_6594-2.jpg" target="\_blank">beautiful black RJ45 plugs</a> (I will rebuild all of the cable plugs)</p>

<p><img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/IMG_6658.jpg" alt="cables"/></p>

<p>And finally tested the connection wired
<img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-11%20at%2009.23.33.jpeg" alt="wired connection"/></p>

<p>And wireless
<img src="https://giuliomagnifico.blog/_images/2022/home-network-v3/Screen%20Shot%202022-08-13%20at%2014.08.34.jpeg" alt="wireless connection"/></p>



    </div>

</article>
<!--  --></section>
</div>


  </section>
  
</div>

      </div>
    </div></div>
  </body>
</html>
