<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/dcmoura/spyql">Original</a>
    <h1>Show HN: SPyQL â€“ SQL with Python in the middle</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text">
<p dir="auto">SQL with Python in the middle</p>
<p dir="auto"><a href="https://pypi.org/project/spyql/" rel="nofollow"><img src="https://camo.githubusercontent.com/2237d1e37e851c96d12682c430b4e80b87ff4341d94a5c52626e7a608c701a1b/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f737079716c2e737667" alt="https://pypi.python.org/pypi/spyql" data-canonical-src="https://img.shields.io/pypi/v/spyql.svg"/></a>
<a href="https://pypi.org/project/spyql/" rel="nofollow"><img src="https://camo.githubusercontent.com/0e32cbcb9da1a1727eccc6ce0ac0a112bd5482f21df767fc9639c499b927bbe4/68747470733a2f2f696d672e736869656c64732e696f2f7472617669732f64636d6f7572612f737079716c2e737667" alt="https://travis-ci.com/dcmoura/spyql" data-canonical-src="https://img.shields.io/travis/dcmoura/spyql.svg"/></a>
<a href="https://spyql.readthedocs.io/en/latest/" rel="nofollow"><img src="https://camo.githubusercontent.com/58da0c4a779ee1591815882664c8325f2a4abd1d00412df11cae56b3ec6acdc9/68747470733a2f2f72656164746865646f63732e6f72672f70726f6a656374732f737079716c2f62616467652f3f76657273696f6e3d6c6174657374" alt="https://spyql.readthedocs.io/en/latest/?version=latest" data-canonical-src="https://readthedocs.org/projects/spyql/badge/?version=latest"/></a>
<a href="https://codecov.io/gh/dcmoura/spyql" rel="nofollow"><img src="https://camo.githubusercontent.com/919428558423453872d033da8cfba362b788765a2689fbee559d174da2178e89/68747470733a2f2f636f6465636f762e696f2f67682f64636d6f7572612f737079716c2f6272616e63682f6d61737465722f67726170682f62616467652e7376673f746f6b656e3d35433749374c47383134" alt="codecov" data-canonical-src="https://codecov.io/gh/dcmoura/spyql/branch/master/graph/badge.svg?token=5C7I7LG814"/></a>
<a href="https://github.com/psf/black"><img src="https://camo.githubusercontent.com/d91ed7ac7abbd5a6102cbe988dd8e9ac21bde0a73d97be7603b891ad08ce3479/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f636f64652532307374796c652d626c61636b2d3030303030302e737667" alt="code style: black" data-canonical-src="https://img.shields.io/badge/code%20style-black-000000.svg"/></a>
<a href="https://opensource.org/licenses/MIT" rel="nofollow"><img src="https://camo.githubusercontent.com/78f47a09877ba9d28da1887a93e5c3bc2efb309c1e910eb21135becd2998238a/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d4d49542d79656c6c6f772e737667" alt="license: MIT" data-canonical-src="https://img.shields.io/badge/License-MIT-yellow.svg"/></a></p>
<h2 dir="auto"><a id="user-content-concept" aria-hidden="true" href="#concept"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Concept</h2>
<p dir="auto">SpyQL is a query language that combines:</p>
<ul dir="auto">
<li>the simplicity and structure of SQL</li>
<li>with the power and readability of Python</li>
</ul>
<div data-snippet-clipboard-copy-content="SELECT
    date.fromtimestamp(purchase_ts) AS purchase_date,
    price * quantity AS total
FROM csv
WHERE department.upper() == &#39;IT&#39;
TO json"><pre><span>SELECT</span>
    <span>date</span>.fromtimestamp(purchase_ts) <span>AS</span> purchase_date,
    price <span>*</span> quantity <span>AS</span> total
<span>FROM</span> csv
<span>WHERE</span> <span>department</span>.<span>upper</span>() <span>==</span> <span><span>&#39;</span>IT<span>&#39;</span></span>
TO json</pre></div>
<p dir="auto">SQL provides the structure of the query, while Python is used to define expressions, bringing along a vast ecosystem of packages.</p>
<h2 dir="auto"><a id="user-content-spyql-command-line-tool" aria-hidden="true" href="#spyql-command-line-tool"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>SpyQL command-line tool</h2>
<p dir="auto">With the SpyQL command-line tool you can make SQL-like SELECTs powered by Python on top of text data (e.g. CSV and JSON). Data can come from files but also from data streams, such as as Kafka, or from databases such as PostgreSQL. Basically, data can come from any command that outputs text :-). More, data can be generated by a Python iterator! Take a look at the examples section to see how to query parquet, process API calls, transverse directories of zipped JSONs, among many other things.</p>
<p dir="auto">SpyQL also allows you to easily convert between text data formats:</p>
<ul dir="auto">
<li>
<p dir="auto"><code>FROM</code>: CSV, JSON, TEXT and Python iterators (YES, you can use a list comprehension as the data source)</p>
</li>
<li>
<p dir="auto"><code>TO</code>: CSV, JSON, SQL (INSERT statements), pretty terminal printing, and terminal plotting.</p>
</li>
</ul>
<p dir="auto">The JSON format is <a href="https://jsonlines.org" rel="nofollow">JSON lines</a>, where each line has a valid JSON object or array. Piping with <a href="https://stedolan.github.io/jq/" rel="nofollow">jq</a> allows SpyQL to handle any JSON input (more on the examples section).</p>
<p dir="auto">You can leverage command line tools to process other file types like Parquet and XML  (more on the examples section).</p>
<h3 dir="auto"><a id="user-content-installation" aria-hidden="true" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installation</h3>
<p dir="auto">To install SpyQL, run this command in your terminal:</p>

<h3 dir="auto"><a id="user-content-hello-world" aria-hidden="true" href="#hello-world"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Hello world</h3>
<p dir="auto">To test your installation run in the terminal:</p>
<div data-snippet-clipboard-copy-content="spyql &#34;SELECT &#39;Hello world&#39; as Message TO pretty&#34;"><pre>spyql <span><span>&#34;</span>SELECT &#39;Hello world&#39; as Message TO pretty<span>&#34;</span></span></pre></div>
<p dir="auto">Output:</p>
<div data-snippet-clipboard-copy-content="Message
-----------
Hello world"><pre><code>Message
-----------
Hello world
</code></pre></div>
<p dir="auto">Try replacing the output format by json and csv, and try adding more columns. e.g. run in the terminal:</p>
<div data-snippet-clipboard-copy-content="spyql &#34;SELECT &#39;Hello world&#39; as message, 1+2 as three TO json&#34;"><pre>spyql <span><span>&#34;</span>SELECT &#39;Hello world&#39; as message, 1+2 as three TO json<span>&#34;</span></span></pre></div>
<p dir="auto">Output:</p>
<div data-snippet-clipboard-copy-content="{&#34;message&#34;: &#34;Hello world&#34;, &#34;three&#34;: 3}"><pre>{<span>&#34;message&#34;</span>: <span><span>&#34;</span>Hello world<span>&#34;</span></span>, <span>&#34;three&#34;</span>: <span>3</span>}</pre></div>
<h2 dir="auto"><a id="user-content-principles" aria-hidden="true" href="#principles"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Principles</h2>
<p dir="auto">Right now, the focus is on building a command-line tool that follows these core principles:</p>
<ul dir="auto">
<li><strong>Simple</strong>: simple to use with a straightforward implementation</li>
<li><strong>Familiar</strong>: you should feel at home if you are acquainted with SQL and Python</li>
<li><strong>Light</strong>: small memory footprint that allows you to process large data that fit into your machine</li>
<li><strong>Useful</strong>: it should make your life easier, filling a gap in the eco-system</li>
</ul>
<h2 dir="auto"><a id="user-content-syntax" aria-hidden="true" href="#syntax"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Syntax</h2>
<div data-snippet-clipboard-copy-content="[ IMPORT python_module [ AS identifier ] [, ...] ]
SELECT [ DISTINCT | PARTIALS ] 
    [ * | python_expression [ AS output_column_name ] [, ...] ]
    [ FROM csv | spy | text | python_expression | json [ EXPLODE path ] ]
    [ WHERE python_expression ]
    [ GROUP BY output_column_number | python_expression  [, ...] ]
    [ ORDER BY output_column_number | python_expression
        [ ASC | DESC ] [ NULLS { FIRST | LAST } ] [, ...] ]
    [ LIMIT row_count ]
    [ OFFSET num_rows_to_skip ]
    [ TO csv | json | spy | sql | pretty | plot ]"><pre>[ IMPORT python_module [ <span>AS</span> identifier ] [, ...] ]
<span>SELECT</span> [ DISTINCT | PARTIALS ] 
    [ <span>*</span> | python_expression [ <span>AS</span> output_column_name ] [, ...] ]
    [ <span>FROM</span> csv | spy | <span>text</span> | python_expression | json [ EXPLODE <span>path</span> ] ]
    [ <span>WHERE</span> python_expression ]
    [ <span>GROUP BY</span> output_column_number | python_expression  [, ...] ]
    [ <span>ORDER BY</span> output_column_number | python_expression
        [ <span>ASC</span> | <span>DESC</span> ] [ NULLS { FIRST | LAST } ] [, ...] ]
    [ <span>LIMIT</span> row_count ]
    [ OFFSET num_rows_to_skip ]
    [ TO csv | json | spy | sql | pretty | plot ]</pre></div>
<h2 dir="auto"><a id="user-content-notable-differences-to-sql" aria-hidden="true" href="#notable-differences-to-sql"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Notable differences to SQL</h2>
<p dir="auto">In SpyQL:</p>
<ul dir="auto">
<li>there is guarantee that the order of the output rows is the same as in the input (if no reordering is done)</li>
<li>the <code>AS</code> keyword must precede a column alias definition (it is not optional as in SQL)</li>
<li>you can always access the nth input column by using the default column names <code>colN</code> (e.g. <code>col1</code> for the first column)</li>
<li>currently only a small subset of SQL is supported, namely <code>SELECT</code> statements without: sub-queries, joins, set operations, etc (check the <a href="#syntax">Syntax</a> section)</li>
<li>sub-queries are achieved by piping (see the [Command line examples](#command line examples)
section)</li>
<li>aggregation functions have the suffix <code>_agg</code> to avoid conflicts with python&#39;s built-in functions:</li>
</ul>
<table>
<thead>
<tr>
<th>Operation</th>
<th>PostgreSQL</th>
<th>SpyQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sum all values of a column</td>
<td><code>SELECT sum(col_name)</code></td>
<td><code>SELECT sum_agg(col_name)</code></td>
</tr>
<tr>
<td>Sum an array</td>
<td><code>SELECT sum(a) FROM (SELECT unnest(array[1,2,3]) AS a) AS t</code></td>
<td><code>SELECT sum([1,2,3])</code></td>
</tr>
</tbody>
</table>
<ul dir="auto">
<li>expressions are pure Python:</li>
</ul>
<table>
<thead>
<tr>
<th>SQL</th>
<th>SpySQL</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x = y</code></td>
<td><code>x == y</code></td>
</tr>
<tr>
<td><code>x BETWEEN a AND b</code></td>
<td><code>a &lt;= x &lt;= b</code></td>
</tr>
<tr>
<td><code>CAST(x AS INTEGER)</code></td>
<td><code>int(x)</code></td>
</tr>
<tr>
<td><code>CASE WHEN x &gt; 0 THEN 1 ELSE -1 END</code></td>
<td><code>1 if x &gt; 0 else -1</code></td>
</tr>
<tr>
<td><code>upper(&#39;hello&#39;)</code></td>
<td><code>&#39;hello&#39;.upper()</code></td>
</tr>
</tbody>
</table>
<h2 dir="auto"><a id="user-content-notable-differences-to-python" aria-hidden="true" href="#notable-differences-to-python"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Notable differences to Python</h2>
<h3 dir="auto"><a id="user-content-additional-syntax" aria-hidden="true" href="#additional-syntax"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Additional syntax</h3>
<p dir="auto">We added additional syntax for making querying easier:</p>
<table>
<thead>
<tr>
<th>Python</th>
<th>SpySQL shortcut</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>json[&#39;hello&#39;][&#39;planet earth&#39;]</code></td>
<td><code>json-&gt;hello-&gt;&#39;planet earth&#39;</code></td>
<td>Easy access of elements in  dicts (e.g. JSONs)</td>
</tr>
</tbody>
</table>
<h3 dir="auto"><a id="user-content-null-datatype" aria-hidden="true" href="#null-datatype"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>NULL datatype</h3>
<p dir="auto">Python&#39;s <code>None</code> generates exceptions when making operations on missing data, breaking query execution (e.g. <code>None + 1</code> throws a <code>TypeError</code>). To overcome this, we created a <code>NULL</code> type that has the same behavior as in SQL (e.g. <code>NULL + 1</code> returns <code>NULL</code>), allowing for queries to continue processing data.</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Native Python throws</th>
<th>SpySQL returns</th>
<th>SpySQL warning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NULL + 1</code></td>
<td><code>NameError</code></td>
<td><code>NULL</code></td>
<td></td>
</tr>
<tr>
<td><code>a_dict[&#39;inexistent_key&#39;]</code></td>
<td><code>KeyError</code></td>
<td><code>NULL</code></td>
<td>yes</td>
</tr>
<tr>
<td><code>int(&#39;&#39;)</code></td>
<td><code>ValueError</code></td>
<td><code>NULL</code></td>
<td>yes</td>
</tr>
<tr>
<td><code>int(&#39;abc&#39;)</code></td>
<td><code>ValueError</code></td>
<td><code>NULL</code></td>
<td>yes</td>
</tr>
</tbody>
</table>
<p dir="auto">The above dictionary key access only returns <code>NULL</code> if the dict is an instance of <code>NullSafeDict</code>. SpyQL adds <code>NullSafeDict</code>, which extends python&#39;s native <code>dict</code>. JSONs are automatically loaded as <code>NullSafeDict</code>. Unless you are creating dictionaries on the fly you do not need to worry about this.</p>
<h2 dir="auto"><a id="user-content-importing-python-modules-and-user-defined-functions" aria-hidden="true" href="#importing-python-modules-and-user-defined-functions"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Importing python modules and user-defined functions</h2>
<p dir="auto">By default, spyql do some commonly used imports:</p>
<ul dir="auto">
<li>everything from the <code>math</code> module</li>
<li><code>datetime</code>, <code>date</code> and <code>timezone</code> from the <code>datetime</code> module</li>
<li>the <code>re</code> module</li>
</ul>
<p dir="auto">SpyQL queries support a single import statement at the beginning of the query where several modules can be imported (e.g. <code>IMPORT numpy AS np, sys SELECT ...</code>). Note that the python syntax <code>from module import identifier</code> is not supported in queries.</p>
<p dir="auto">In addition, you can create a python file that is loaded before executing queries. Here you can define imports, functions, variables, etc using regular python code. Everything defined in this file is available to all your spyql queries. The file should be located at <code>XDG_CONFIG_HOME/spyql/init.py</code>. If the environment variable <code>XDG_CONFIG_HOME</code> is not defined, it defaults to <code>HOME/.config</code> (e.g. <code>/Users/janedoe/.config/spyql/init.py</code>).</p>
<h2 dir="auto"><a id="user-content-example-queries" aria-hidden="true" href="#example-queries"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Example queries</h2>
<p dir="auto">You can run the following example queries in the terminal:
<code>spyql &#34;the_query&#34; &lt; a_data_file</code></p>
<p dir="auto">Example data files are not provided on most cases.</p>
<h3 dir="auto"><a id="user-content-query-a-csv-and-print-a-pretty-table" aria-hidden="true" href="#query-a-csv-and-print-a-pretty-table"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Query a CSV (and print a pretty table)</h3>
<div data-snippet-clipboard-copy-content="SELECT a_col_name, &#39;positive&#39; if col2 &gt;= 0 else &#39;negative&#39; AS sign
FROM csv
TO pretty"><pre><span>SELECT</span> a_col_name, <span><span>&#39;</span>positive<span>&#39;</span></span> if col2 <span>&gt;=</span> <span>0</span> else <span><span>&#39;</span>negative<span>&#39;</span></span> <span>AS</span> sign
<span>FROM</span> csv
TO pretty</pre></div>
<h3 dir="auto"><a id="user-content-convert-csv-to-a-flat-json" aria-hidden="true" href="#convert-csv-to-a-flat-json"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Convert CSV to a flat JSON</h3>
<div data-snippet-clipboard-copy-content="SELECT * FROM csv TO json"><pre><span>SELECT</span> <span>*</span> <span>FROM</span> csv TO json</pre></div>
<h3 dir="auto"><a id="user-content-convert-from-csv-to-a-hierarchical-json" aria-hidden="true" href="#convert-from-csv-to-a-hierarchical-json"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Convert from CSV to a hierarchical JSON</h3>
<div data-snippet-clipboard-copy-content="SELECT {&#39;client&#39;: {&#39;id&#39;: col1, &#39;name&#39;: col2}, &#39;price&#39;: 120.40}
FROM csv TO json"><pre><span>SELECT</span> {<span><span>&#39;</span>client<span>&#39;</span></span>: {<span><span>&#39;</span>id<span>&#39;</span></span>: col1, <span><span>&#39;</span>name<span>&#39;</span></span>: col2}, <span><span>&#39;</span>price<span>&#39;</span></span>: <span>120</span>.<span>40</span>}
<span>FROM</span> csv TO json</pre></div>
<p dir="auto">or</p>
<div data-snippet-clipboard-copy-content="SELECT {&#39;id&#39;: col1, &#39;name&#39;: col2} AS client, 120.40 AS price
FROM csv TO json"><pre><span>SELECT</span> {<span><span>&#39;</span>id<span>&#39;</span></span>: col1, <span><span>&#39;</span>name<span>&#39;</span></span>: col2} <span>AS</span> client, <span>120</span>.<span>40</span> <span>AS</span> price
<span>FROM</span> csv TO json</pre></div>
<h3 dir="auto"><a id="user-content-json-to-csv-filtering-out-nulls" aria-hidden="true" href="#json-to-csv-filtering-out-nulls"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>JSON to CSV, filtering out NULLs</h3>
<div data-snippet-clipboard-copy-content="SELECT json-&gt;client-&gt;id AS id, json-&gt;client-&gt;name AS name, json-&gt;price AS price
FROM json
WHERE json-&gt;client-&gt;name is not NULL
TO csv"><pre><span>SELECT</span> json<span>-</span><span>&gt;</span>client<span>-</span><span>&gt;</span>id <span>AS</span> id, json<span>-</span><span>&gt;</span>client<span>-</span><span>&gt;</span>name <span>AS</span> name, json<span>-</span><span>&gt;</span>price <span>AS</span> price
<span>FROM</span> json
<span>WHERE</span> json<span>-</span><span>&gt;</span>client<span>-</span><span>&gt;</span>name <span>is not NULL</span>
TO csv</pre></div>
<h3 dir="auto"><a id="user-content-explode-json-to-csv" aria-hidden="true" href="#explode-json-to-csv"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Explode JSON to CSV</h3>
<div data-snippet-clipboard-copy-content="SELECT json-&gt;invoice_num AS id, json-&gt;items-&gt;name AS name, json-items-&gt;price AS price
FROM json
EXPLODE json-&gt;items
TO csv"><pre><span>SELECT</span> json<span>-</span><span>&gt;</span>invoice_num <span>AS</span> id, json<span>-</span><span>&gt;</span>items<span>-</span><span>&gt;</span>name <span>AS</span> name, json<span>-</span>items<span>-</span><span>&gt;</span>price <span>AS</span> price
<span>FROM</span> json
EXPLODE json<span>-</span><span>&gt;</span>items
TO csv</pre></div>
<p dir="auto">Sample input:</p>
<div data-snippet-clipboard-copy-content="{&#34;invoice_num&#34; : 1028, &#34;items&#34;: [{&#34;name&#34;: &#34;tomatoes&#34;, &#34;price&#34;: 1.5}, {&#34;name&#34;: &#34;bananas&#34;, &#34;price&#34;: 2.0}]}
{&#34;invoice_num&#34; : 1029, &#34;items&#34;: [{&#34;name&#34;: &#34;peaches&#34;, &#34;price&#34;: 3.12}]}"><pre>{<span>&#34;invoice_num&#34; </span>: <span>1028</span>, <span>&#34;items&#34;</span>: [{<span>&#34;name&#34;</span>: <span><span>&#34;</span>tomatoes<span>&#34;</span></span>, <span>&#34;price&#34;</span>: <span>1.5</span>}, {<span>&#34;name&#34;</span>: <span><span>&#34;</span>bananas<span>&#34;</span></span>, <span>&#34;price&#34;</span>: <span>2.0</span>}]}
{<span>&#34;invoice_num&#34; </span>: <span>1029</span>, <span>&#34;items&#34;</span>: [{<span>&#34;name&#34;</span>: <span><span>&#34;</span>peaches<span>&#34;</span></span>, <span>&#34;price&#34;</span>: <span>3.12</span>}]}</pre></div>
<p dir="auto">Output:</p>
<div data-snippet-clipboard-copy-content="id, name, price
1028, tomatoes, 1.5
1028, bananas, 2.0
1029, peaches, 3.12"><pre><code>id, name, price
1028, tomatoes, 1.5
1028, bananas, 2.0
1029, peaches, 3.12
</code></pre></div>
<h3 dir="auto"><a id="user-content-python-iteratorlistcomprehension-to-json" aria-hidden="true" href="#python-iteratorlistcomprehension-to-json"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Python iterator/list/comprehension to JSON</h3>
<div data-snippet-clipboard-copy-content="SELECT 10 * cos(col1 * ((pi * 4) / 90)
FROM range(80)
TO json"><pre><span>SELECT</span> <span>10</span> <span>*</span> cos(col1 <span>*</span> ((pi <span>*</span> <span>4</span>) <span>/</span> <span>90</span>)
<span>FROM</span> range(<span>80</span>)
TO json</pre></div>
<p dir="auto">or</p>
<div data-snippet-clipboard-copy-content="SELECT col1
FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]
TO json"><pre><span>SELECT</span> col1
<span>FROM</span> [<span>10</span> <span>*</span> cos(i <span>*</span> ((pi <span>*</span> <span>4</span>) <span>/</span> <span>90</span>)) for i <span>in</span> range(<span>80</span>)]
TO json</pre></div>
<h3 dir="auto"><a id="user-content-importing-python-modules" aria-hidden="true" href="#importing-python-modules"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Importing python modules</h3>
<p dir="auto">Here we import <code>hashlib</code> to calculate a md5 hash for each input line.
Before running this example you need to install the <code>hashlib</code> package (<code>pip install hashlib</code>).</p>
<div data-snippet-clipboard-copy-content="IMPORT hashlib as hl
SELECT hl.md5(col1.encode(&#39;utf-8&#39;)).hexdigest()
FROM text"><pre>IMPORT hashlib <span>as</span> hl
<span>SELECT</span> <span>hl</span>.<span>md5</span>(<span>col1</span>.<span>encode</span>(<span><span>&#39;</span>utf-8<span>&#39;</span></span>)).hexdigest()
<span>FROM</span> <span>text</span></pre></div>
<h3 dir="auto"><a id="user-content-getting-the-top-5-records" aria-hidden="true" href="#getting-the-top-5-records"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Getting the top 5 records</h3>
<div data-snippet-clipboard-copy-content="SELECT int(score) AS score, player_name
FROM csv
ORDER BY 1 DESC NULLS LAST, score_date
LIMIT 5"><pre><span>SELECT</span> <span>int</span>(score) <span>AS</span> score, player_name
<span>FROM</span> csv
<span>ORDER BY</span> <span>1</span> <span>DESC</span> NULLS LAST, score_date
<span>LIMIT</span> <span>5</span></pre></div>
<h3 dir="auto"><a id="user-content-aggregations" aria-hidden="true" href="#aggregations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Aggregations</h3>
<p dir="auto">Totals by player, alphabetically ordered.</p>
<div data-snippet-clipboard-copy-content="SELECT json-&gt;player_name, sum_agg(json-&gt;score) AS total_score
FROM json
GROUP BY 1
ORDER BY 1"><pre><span>SELECT</span> json<span>-</span><span>&gt;</span>player_name, sum_agg(json<span>-</span><span>&gt;</span>score) <span>AS</span> total_score
<span>FROM</span> json
<span>GROUP BY</span> <span>1</span>
<span>ORDER BY</span> <span>1</span></pre></div>
<h3 dir="auto"><a id="user-content-partial-aggregations" aria-hidden="true" href="#partial-aggregations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Partial aggregations</h3>
<p dir="auto">Calculating the cumulative sum of a variable using the <code>PARTIALS</code> modifier. Also demoing the lag aggregator.</p>
<div data-snippet-clipboard-copy-content="SELECT PARTIALS 
    json-&gt;new_entries, 
    sum_agg(json-&gt;new_entries) AS cum_new_entries,
    lag(json-&gt;new_entries) AS prev_entries
FROM json
TO json"><pre><span>SELECT</span> PARTIALS 
    json<span>-</span><span>&gt;</span>new_entries, 
    sum_agg(json<span>-</span><span>&gt;</span>new_entries) <span>AS</span> cum_new_entries,
    lag(json<span>-</span><span>&gt;</span>new_entries) <span>AS</span> prev_entries
<span>FROM</span> json
TO json</pre></div>
<p dir="auto">Sample input:</p>
<div data-snippet-clipboard-copy-content="{&#34;new_entries&#34; : 10}
{&#34;new_entries&#34; : 5}
{&#34;new_entries&#34; : 25}
{&#34;new_entries&#34; : null}
{}
{&#34;new_entries&#34; : 100}"><pre>{<span>&#34;new_entries&#34; </span>: <span>10</span>}
{<span>&#34;new_entries&#34; </span>: <span>5</span>}
{<span>&#34;new_entries&#34; </span>: <span>25</span>}
{<span>&#34;new_entries&#34; </span>: <span>null</span>}
{}
{<span>&#34;new_entries&#34; </span>: <span>100</span>}</pre></div>
<p dir="auto">Output:</p>
<div data-snippet-clipboard-copy-content="{&#34;new_entries&#34; : 10,   &#34;cum_new_entries&#34; : 10,  &#34;prev_entries&#34;: null}
{&#34;new_entries&#34; : 5,    &#34;cum_new_entries&#34; : 15,  &#34;prev_entries&#34;: 10}
{&#34;new_entries&#34; : 25,   &#34;cum_new_entries&#34; : 40,  &#34;prev_entries&#34;: 5}
{&#34;new_entries&#34; : null, &#34;cum_new_entries&#34; : 40,  &#34;prev_entries&#34;: 25}
{&#34;new_entries&#34; : null, &#34;cum_new_entries&#34; : 40,  &#34;prev_entries&#34;: null}
{&#34;new_entries&#34; : 100,  &#34;cum_new_entries&#34; : 140, &#34;prev_entries&#34;: null}"><pre>{<span>&#34;new_entries&#34; </span>: <span>10</span>,   <span>&#34;cum_new_entries&#34; </span>: <span>10</span>,  <span>&#34;prev_entries&#34;</span>: <span>null</span>}
{<span>&#34;new_entries&#34; </span>: <span>5</span>,    <span>&#34;cum_new_entries&#34; </span>: <span>15</span>,  <span>&#34;prev_entries&#34;</span>: <span>10</span>}
{<span>&#34;new_entries&#34; </span>: <span>25</span>,   <span>&#34;cum_new_entries&#34; </span>: <span>40</span>,  <span>&#34;prev_entries&#34;</span>: <span>5</span>}
{<span>&#34;new_entries&#34; </span>: <span>null</span>, <span>&#34;cum_new_entries&#34; </span>: <span>40</span>,  <span>&#34;prev_entries&#34;</span>: <span>25</span>}
{<span>&#34;new_entries&#34; </span>: <span>null</span>, <span>&#34;cum_new_entries&#34; </span>: <span>40</span>,  <span>&#34;prev_entries&#34;</span>: <span>null</span>}
{<span>&#34;new_entries&#34; </span>: <span>100</span>,  <span>&#34;cum_new_entries&#34; </span>: <span>140</span>, <span>&#34;prev_entries&#34;</span>: <span>null</span>}</pre></div>
<p dir="auto">If <code>PARTIALS</code>was omitted the result would be equivalent to the last output row.</p>
<h3 dir="auto"><a id="user-content-distinct-rows" aria-hidden="true" href="#distinct-rows"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Distinct rows</h3>
<div data-snippet-clipboard-copy-content="SELECT DISTINCT *
FROM csv"><pre><span>SELECT DISTINCT</span> <span>*</span>
<span>FROM</span> csv</pre></div>
<h2 dir="auto"><a id="user-content-command-line-examples" aria-hidden="true" href="#command-line-examples"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Command line examples</h2>
<p dir="auto">To run the following examples, type <code>Ctrl-x Ctrl-e</code> on you terminal. This will open your default editor (emacs/vim). Paste the code of one of the examples, save and exit.</p>
<h3 dir="auto"><a id="user-content-queries-on-parquet-with-directories" aria-hidden="true" href="#queries-on-parquet-with-directories"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Queries on Parquet with directories</h3>
<p dir="auto">Here, <code>find</code> transverses a directory and executes <code>parquet-tools</code> for each parquet file, dumping each file to json format. <code>jq -c</code> makes sure that the output has 1 json per line before handing over to spyql. This is far from being an efficient way to query parquet files, but it might be a handy option if you need to do a quick inspection.</p>
<div data-snippet-clipboard-copy-content="find /the/directory -name &#34;*.parquet&#34; -exec parquet-tools cat --json {} \; |
jq -c |
spyql &#34;
	SELECT json-&gt;a_field, json-&gt;a_num_field * 2 + 1
	FROM json
&#34;"><pre>find /the/directory -name <span><span>&#34;</span>*.parquet<span>&#34;</span></span> -exec parquet-tools cat --json {} <span>\;</span> <span>|</span>
jq -c <span>|</span>
spyql <span><span>&#34;</span></span>
<span>	SELECT json-&gt;a_field, json-&gt;a_num_field * 2 + 1</span>
<span>	FROM json</span>
<span><span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-querying-multiple-jsongz-files" aria-hidden="true" href="#querying-multiple-jsongz-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Querying multiple json.gz files</h3>
<div data-snippet-clipboard-copy-content="gzcat *.json.gz |
jq -c |
spyql &#34;
	SELECT json-&gt;a_field, json-&gt;a_num_field * 2 + 1
	FROM json
&#34;"><pre>gzcat <span>*</span>.json.gz <span>|</span>
jq -c <span>|</span>
spyql <span><span>&#34;</span></span>
<span>	SELECT json-&gt;a_field, json-&gt;a_num_field * 2 + 1</span>
<span>	FROM json</span>
<span><span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-querying-yaml--xml--toml-files" aria-hidden="true" href="#querying-yaml--xml--toml-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Querying YAML / XML / TOML files</h3>
<p dir="auto"><a href="https://kislyuk.github.io/yq/#" rel="nofollow">yq</a> converts yaml, xml and toml files to json, allowing to easily query any of these with spyql.</p>
<div data-snippet-clipboard-copy-content="cat file.yaml | yq -c | spyql &#34;SELECT json-&gt;a_field FROM json&#34;"><pre>cat file.yaml <span>|</span> yq -c <span>|</span> spyql <span><span>&#34;</span>SELECT json-&gt;a_field FROM json<span>&#34;</span></span></pre></div>
<div data-snippet-clipboard-copy-content="cat file.xml | xq -c | spyql &#34;SELECT json-&gt;a_field FROM json&#34;"><pre>cat file.xml <span>|</span> xq -c <span>|</span> spyql <span><span>&#34;</span>SELECT json-&gt;a_field FROM json<span>&#34;</span></span></pre></div>
<div data-snippet-clipboard-copy-content="cat file.toml | tomlq -c | spyql &#34;SELECT json-&gt;a_field FROM json&#34;"><pre>cat file.toml <span>|</span> tomlq -c <span>|</span> spyql <span><span>&#34;</span>SELECT json-&gt;a_field FROM json<span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-kafka-to-postegresql-pipeline" aria-hidden="true" href="#kafka-to-postegresql-pipeline"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Kafka to PostegreSQL pipeline</h3>
<p dir="auto">Read data from a kafka topic and write to postgres table name <code>customer</code>.</p>
<div data-snippet-clipboard-copy-content="kafkacat -b the.broker.com -t the.topic |
spyql -Otable=customer -Ochunk_size=1 --unbuffered &#34;
	SELECT
		json-&gt;customer-&gt;id AS id,
		json-&gt;customer-&gt;name AS name
	FROM json
	TO sql
&#34; |
psql -U an_user_name -h a.host.com a_database_name"><pre>kafkacat -b the.broker.com -t the.topic <span>|</span>
spyql -Otable=customer -Ochunk_size=1 --unbuffered <span><span>&#34;</span></span>
<span>	SELECT</span>
<span>		json-&gt;customer-&gt;id AS id,</span>
<span>		json-&gt;customer-&gt;name AS name</span>
<span>	FROM json</span>
<span>	TO sql</span>
<span><span>&#34;</span></span> <span>|</span>
psql -U an_user_name -h a.host.com a_database_name</pre></div>
<h3 dir="auto"><a id="user-content-monitoring-statistics-in-kafka" aria-hidden="true" href="#monitoring-statistics-in-kafka"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Monitoring statistics in Kafka</h3>
<p dir="auto">Read data from a kafka topic, continuously calculating statistics.</p>
<div data-snippet-clipboard-copy-content="kafkacat -b the.broker.com -t the.topic |
spyql --unbuffered &#34;
	SELECT PARTIALS
        count_agg(*) AS running_count,
		sum_agg(value) AS running_sum,
		min_agg(value) AS min_so_far, 
        value AS current_value
	FROM json
	TO csv
&#34; "><pre>kafkacat -b the.broker.com -t the.topic <span>|</span>
spyql --unbuffered <span><span>&#34;</span></span>
<span>	SELECT PARTIALS</span>
<span>        count_agg(*) AS running_count,</span>
<span>		sum_agg(value) AS running_sum,</span>
<span>		min_agg(value) AS min_so_far, </span>
<span>        value AS current_value</span>
<span>	FROM json</span>
<span>	TO csv</span>
<span><span>&#34;</span></span> </pre></div>
<h3 dir="auto"><a id="user-content-sub-queries-piping" aria-hidden="true" href="#sub-queries-piping"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Sub-queries (piping)</h3>
<p dir="auto">A special file format (spy) is used to efficiently pipe data between queries.</p>
<div data-snippet-clipboard-copy-content="cat a_file.json |
spyql &#34;
	SELECT &#39; &#39;.join([json-&gt;first_name, json-&gt;middle_name, json-&gt;last_name]) AS full_name
	FROM json
	TO spy&#34; |
spyql &#34;SELECT full_name, full_name.upper() FROM spy&#34;"><pre>cat a_file.json <span>|</span>
spyql <span><span>&#34;</span></span>
<span>	SELECT &#39; &#39;.join([json-&gt;first_name, json-&gt;middle_name, json-&gt;last_name]) AS full_name</span>
<span>	FROM json</span>
<span>	TO spy<span>&#34;</span></span> <span>|</span>
spyql <span><span>&#34;</span>SELECT full_name, full_name.upper() FROM spy<span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-queries-over-apis" aria-hidden="true" href="#queries-over-apis"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Queries over APIs</h3>
<div data-snippet-clipboard-copy-content="curl https://reqres.in/api/users?page=2 |
spyql &#34;
	SELECT
		json-&gt;data-&gt;email AS email,
		&#39;Dear {}, thank you for being a great customer!&#39;.format(json-&gt;data-&gt;first_name) AS msg
	FROM json
	EXPLODE json-&gt;data
	TO json
&#34;"><pre>curl https://reqres.in/api/users<span>?</span>page=2 <span>|</span>
spyql <span><span>&#34;</span></span>
<span>	SELECT</span>
<span>		json-&gt;data-&gt;email AS email,</span>
<span>		&#39;Dear {}, thank you for being a great customer!&#39;.format(json-&gt;data-&gt;first_name) AS msg</span>
<span>	FROM json</span>
<span>	EXPLODE json-&gt;data</span>
<span>	TO json</span>
<span><span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-plotting-to-the-terminal" aria-hidden="true" href="#plotting-to-the-terminal"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Plotting to the terminal</h3>
<div data-snippet-clipboard-copy-content="spyql &#34;
    SELECT col1
    FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]
    TO plot
&#34;"><pre>spyql <span><span>&#34;</span></span>
<span>    SELECT col1</span>
<span>    FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]</span>
<span>    TO plot</span>
<span><span>&#34;</span></span></pre></div>
<h3 dir="auto"><a id="user-content-plotting-with-gnuplot" aria-hidden="true" href="#plotting-with-gnuplot"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Plotting with gnuplot</h3>
<p dir="auto">To the terminal:</p>
<div data-snippet-clipboard-copy-content="spyql &#34;
    SELECT col1
    FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]
    TO csv
&#34; |
sed 1d |
feedgnuplot --terminal &#39;dumb 80,30&#39; --exit --lines"><pre>spyql <span><span>&#34;</span></span>
<span>    SELECT col1</span>
<span>    FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]</span>
<span>    TO csv</span>
<span><span>&#34;</span></span> <span>|</span>
sed 1d <span>|</span>
feedgnuplot --terminal <span><span>&#39;</span>dumb 80,30<span>&#39;</span></span> --exit --lines</pre></div>
<p dir="auto">To GUI:</p>
<div data-snippet-clipboard-copy-content="spyql &#34;
    SELECT col1
    FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]
    TO csv
&#34; |
sed 1d |
feedgnuplot --lines --points --exit"><pre>spyql <span><span>&#34;</span></span>
<span>    SELECT col1</span>
<span>    FROM [10 * cos(i * ((pi * 4) / 90)) for i in range(80)]</span>
<span>    TO csv</span>
<span><span>&#34;</span></span> <span>|</span>
sed 1d <span>|</span>
feedgnuplot --lines --points --exit</pre></div>
<hr/>
<p dir="auto"><em>This package was created with <a href="https://github.com/audreyr/cookiecutter">Cookiecutter</a> and the <code>audreyr/cookiecutter-pypackage</code> <a href="https://github.com/audreyr/cookiecutter-pypackage">project template</a>.</em></p>
</article>
        </div></div>
  </body>
</html>
