<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://engineering.fb.com/2022/11/16/culture/meta-code-review-time-improving/">Original</a>
    <h1>Improving code review time</h1>
    
    <div id="readability-page-1" class="page"><div>

		<ul>
<li aria-level="1"><span>Code reviews are one of the most important parts of the software development process</span></li>
<li aria-level="1"><span>At Meta we’ve recognized the need to make code reviews as fast as possible without sacrificing quality</span></li>
<li aria-level="1"><span>We’re sharing several tools and steps we’ve taken at Meta to reduce the time waiting for code reviews</span></li>
</ul>
<p><span>When done well, code reviews can <a href="https://engineering.fb.com/2022/07/20/security/how-meta-and-the-security-industry-collaborate-to-secure-the-internet/" target="_blank" rel="noopener">catch bugs</a>,<a href="https://engineering.fb.com/2021/02/23/data-infrastructure/silent-data-corruption/"> teach best practices</a>, and <a href="https://engineering.fb.com/2020/12/10/developer-tools/probabilistic-flakiness/" target="_blank" rel="noopener">ensure high code qualit</a>y. At Meta we call an individual set of changes made to the codebase a “diff.” While we like to move fast at Meta, every diff must be reviewed, without exception. But, as the Code Review team, we also understand that when reviews take longer, people get less done.</span></p>
<p><span>We’ve studied several metrics to learn more about code review bottlenecks that lead to unhappy developers and used that knowledge to build features that help speed up the code review process without sacrificing review quality. We’ve found a correlation between slow diff review times (P75) and engineer dissatisfaction. Our tools to surface diffs to the right reviewers at key moments in the code review lifecycle have significantly improved the diff review experience.</span></p>
<h2><span>What makes a diff review feel slow?</span></h2>
<p><span>To answer this question we started by looking at our data. We track a metric that we call “Time In Review,” which is a measure of how long a diff is waiting on review across all of its individual review cycles. We only account for the time when the diff is waiting on reviewer action.</span></p>
<figure id="attachment_19635" aria-describedby="caption-attachment-19635"><img decoding="async" src="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image2.png?w=987" alt="" width="987" height="296" srcset="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image2.png 987w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image2.png?resize=916,275 916w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image2.png?resize=768,230 768w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image2.png?resize=96,29 96w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image2.png?resize=192,58 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19635">Time In Review is calculated as the sum of the time spent in blue sections.</figcaption></figure>
<p><span>What we discovered surprised us. When we looked at the data in early 2021, our median (P50) hours in review for a diff was only a few hours, which we felt was pretty good. However, looking at P75 (i.e., the slowest 25 percent of reviews) we saw diff review time increase by as much as a day. </span></p>
<p><span>We analyzed the correlation between Time In Review and user satisfaction (as measured by a company-wide survey). The results were clear</span><span>: </span><span>The longer someone’s slowest 25 percent of diffs take to review, the less satisfied they were by their code review process. We now had our north star metric: P75 Time In Review. </span></p>
<p><span>Driving down Time In Review would not only make people more satisfied with their code review process, it would also increase the productivity of every engineer at Meta. Driving down Time to Review for our diffs means our engineers are spending significantly less time on reviews – making them more productive and more satisfied with the overall review process.</span></p>
<h2><span>Balancing speed with quality</span></h2>
<p><span>However, simply optimizing for the speed of review could lead to negative side effects, like encouraging rubber-stamp reviewing. We needed a guardrail metric to protect against negative unintended consequences. We settled on “Eyeball Time” – the total amount of time reviewers spent looking at a diff. An increase in rubber-stamping would lead to a decrease in Eyeball Time.</span></p>
<p><span>Now we have established our goal metric, Time In Review, and our guardrail metric, Eyeball Time. What comes next?</span></p>
<h2><span>Build, experiment, and iterate</span></h2>
<p><span>Nearly every product team at Meta uses experimental and data-driven processes to release and iterate on features. However, this process is still very new to internal tools teams like ours. There are  a number of challenges (sample size, randomization, network effect) that we’ve had to overcome that product teams do not have. We address these challenges with new data foundations for running </span><a href="https://research.facebook.com/blog/2021/08/testing-product-changes-with-network-effects/" target="_blank" rel="noopener"><span>network experiments</span></a><span> and using techniques to reduce variance and increase sample size. This extra effort is worth it </span><span>— </span><span>by laying the foundation of an experiment, we can later prove the impact and the effectiveness of the features we’re building.</span></p>
<figure id="attachment_19636" aria-describedby="caption-attachment-19636"><img decoding="async" loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image3.png?w=632" alt="" width="632" height="1024" srcset="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image3.png 655w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image3.png?resize=565,916 565w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image3.png?resize=632,1024 632w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image3.png?resize=96,156 96w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image3.png?resize=192,311 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19636">The experimental process: The selection of goal and guardrail metrics is driven by the hypothesis we hold for the feature. We built the foundations to easily choose different experiment units to randomize treatment, including randomization by user clusters.</figcaption></figure>
<h2><span>Next reviewable diff</span></h2>
<p><span>The inspiration for this feature came from an unlikely place — video streaming services. It’s easy to binge watch shows on certain streaming services because of how seamless the transition is from one episode to another. What if we could do that for code reviews? By queueing up diffs we could encourage a diff review flow state, allowing reviewers to make the most of their time and mental energy.</span></p>
<p><img decoding="async" loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png?w=1024" alt="" width="1024" height="512" srcset="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png 1071w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png?resize=916,458 916w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png?resize=768,384 768w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png?resize=1024,512 1024w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png?resize=96,48 96w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image4.png?resize=192,96 192w" sizes="(max-width: 992px) 100vw, 62vw"/></p>
<p><span>And so Next Reviewable Diff was born. We use machine learning to identify a diff that the current reviewer is highly likely to want  to review. Then we surface that diff to the reviewer after they finish their current code review. We make it easy to cycle through possible next diffs and quickly remove themselves as a reviewer if a diff is not relevant to them.</span></p>
<p><span>After its launch, we found that this feature resulted in a 17 percent overall increase in review actions per day (such as accepting a diff, commenting, etc.) and that engineers that use this flow perform 44 percent more review actions than the average reviewer!</span></p>
<h2><span>Improving reviewer recommendations</span></h2>
<p><span>The choice of reviewers that an author selects for a diff is very important. Diff authors want reviewers who are going to review their code well, quickly, and who are experts for the code their diff touches. Historically, Meta’s reviewer recommender looked at a limited set of data to make recommendations, leading to problems with new files and staleness as engineers changed teams.</span></p>
<p><span>We built a new reviewer recommendation system, incorporating work hours awareness and file ownership information. This allows reviewers that are available to review a diff and are more likely to be great reviewers to be prioritized. We rewrote the model that powers these recommendations to support backtesting and automatic retraining too.</span></p>
<p><img decoding="async" loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?w=1024" alt="" width="1024" height="104" srcset="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png 1645w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?resize=916,93 916w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?resize=768,78 768w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?resize=1024,104 1024w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?resize=1536,156 1536w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?resize=96,10 96w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image1.png?resize=192,19 192w" sizes="(max-width: 992px) 100vw, 62vw"/></p>
<p><span>The result? A 1.5 percent increase in diffs reviewed within 24 hours and an increase in top three recommendation accuracy (how often the actual reviewer is one of the top three suggested) from below 60 percent to nearly 75 percent. As an added bonus, the new model was also 14 times faster (P90 latency)!</span></p>
<h2><span>Stale Diff Nudgebot</span></h2>
<p><span>We know that a small proportion of stale diffs can make engineers unhappy, even if their diffs are reviewed quickly otherwise.  Slow reviews have other effects too </span><span>— </span><span>the code itself becomes stale, authors have to context switch, and overall productivity drops. To directly address this, we built Nudgebot, which was inspired by </span><a href="https://dl.acm.org/doi/abs/10.1145/3544791" target="_blank" rel="noopener"><span>research done at Microsoft</span></a><span>.</span></p>
<p><span>For diffs that were taking an extra long time to review, Nudgebot determines the subset of reviewers that are most likely to review the diff. Then it  sends them a chat ping with the appropriate context for the diff along with a set of quick actions that allow recipients to jump right into reviewing.</span></p>
<p><span>Our experiment with Nudgebot had great results. The average Time In Review for all diffs dropped 7 percent (adjusted to exclude weekends) and the proportion of diffs that waited longer than three days for review dropped 12 percent! The success of this feature was </span><a href="https://users.encs.concordia.ca/~pcr/paper/NudgeBot2022FSE-preprint.pdf" target="_blank" rel="noopener"><span>individually published</span></a><span> as well.</span></p>
<figure id="attachment_19638" aria-describedby="caption-attachment-19638"><img decoding="async" loading="lazy" src="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?w=1024" alt="" width="1024" height="569" srcset="https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg 1768w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?resize=916,509 916w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?resize=768,427 768w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?resize=1024,569 1024w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?resize=1536,853 1536w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?resize=96,53 96w, https://engineering.fb.com/wp-content/uploads/2022/11/Code-Reviews-at-Meta-image5.jpg?resize=192,107 192w" sizes="(max-width: 992px) 100vw, 62vw"/><figcaption id="caption-attachment-19638">This is what a chat notification about a set of stale diffs looks like to a reviewer, while showing one of the potential interactions of “Remind Me Later.”</figcaption></figure>
<h2><span>What comes next?</span></h2>
<p><span>Our current and future work is focused on questions like:</span></p>
<ul>
<li aria-level="1"><span>What is the right set of people to be reviewing a given diff?</span></li>
<li aria-level="1"><span>How can we make it easier for reviewers to have the information they need to give a high quality review?</span></li>
<li aria-level="1"><span>How can we leverage AI and machine learning to improve the code review process?</span></li>
</ul>
<p><span>We’re continually pursuing  answers to these questions, and we’re looking forward to finding more ways to streamline developer processes in the future!</span></p>
<p><span>Are you interested in building the future of developer productivity? </span><a href="https://www.metacareers.com/jobs/" target="_blank" rel="noopener"><span>Join us</span></a><span>!</span></p>
<h2><span>Acknowledgements</span></h2>
<p><i><span>We’d like to thank the following people for their help and contributions to this post:  Louise Huang, Seth Rogers, and James Saindon.</span></i></p>

		
	</div></div>
  </body>
</html>
