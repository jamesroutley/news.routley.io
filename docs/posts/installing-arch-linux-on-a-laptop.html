<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://giacomo.coletto.io/blog/arch-amd/">Original</a>
    <h1>Installing Arch Linux on a Laptop</h1>
    
    <div id="readability-page-1" class="page"><div>    <section>    <span id="copyButtonIDLE"> <svg width="24" height="24" viewBox="0 0 21.6 21.6" data-icon="copy"> <title>copy icon</title> <symbol id="ai:local:copy"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4.8 9.8c0-2.828 0-4.243.879-5.121C6.557 3.8 7.972 3.8 10.8 3.8h3c2.828 0 4.243 0 5.121.879.879.878.879 2.293.879 5.121v5c0 2.828 0 4.243-.879 5.121-.878.879-2.293.879-5.121.879h-3c-2.828 0-4.243 0-5.121-.879C4.8 19.043 4.8 17.628 4.8 14.8z"></path><path d="M4.8 17.8a3 3 0 0 1-3-3v-6c0-3.771 0-5.657 1.172-6.828S6.029.8 9.8.8h4a3 3 0 0 1 3 3"></path></g></symbol><use xlink:href="#ai:local:copy"></use>  </svg> </span> <span id="codeCopyClicked"> <svg width="24" height="24" viewBox="0 0 21.6 21.6" data-icon="copy-clicked"> <title>copy clicked icon</title> <symbol id="ai:local:copy-clicked"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4.8 9.8c0-2.828 0-4.243.879-5.121C6.557 3.8 7.972 3.8 10.8 3.8h3c2.828 0 4.243 0 5.121.879.879.878.879 2.293.879 5.121v5c0 2.828 0 4.243-.879 5.121-.878.879-2.293.879-5.121.879h-3c-2.828 0-4.243 0-5.121-.879C4.8 19.043 4.8 17.628 4.8 14.8z"></path><path d="M4.8 17.8a3 3 0 0 1-3-3v-6c0-3.771 0-5.657 1.172-6.828S6.029.8 9.8.8h4a3 3 0 0 1 3 3"></path><path stroke-linecap="round" stroke-linejoin="round" d="m9.672 12.493 1.714 1.6 4.286-4"></path></g></symbol><use xlink:href="#ai:local:copy-clicked"></use>  </svg> </span>   <header> <header>   </header> <!-- <div class="mt-3"> --> <p><time data-pagefind-sort="date[datetime]" datetime="2024-09-14T00:00:00.000Z"> Sep 14, 2024 </time> ·
 <span data-pagefind-ignore=""> 22 min read </span> </p>  <a href="https://giacomo.coletto.io/tags/arch-linux/" data-tag="arch-linux" data-pagefind-filter="tags"> Arch Linux </a> </header> <nav data-astro-cid-iukfgdcn=""> <details id="TOCMobile" data-astro-cid-iukfgdcn=""> <summary data-astro-cid-iukfgdcn="">Contents</summary> <ul data-astro-cid-iukfgdcn=""> <li data-astro-cid-iukfgdcn=""> <a href="#introduction" data-astro-cid-iukfgdcn=""> Introduction </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#requirements" data-astro-cid-iukfgdcn=""> Requirements </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#before-rebooting" data-astro-cid-iukfgdcn=""> Before rebooting </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#modifying-uefi-settings" data-astro-cid-iukfgdcn=""> Modifying UEFI settings </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#booting-from-archiso" data-astro-cid-iukfgdcn=""> Booting from ArchISO </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#wi-fi-setup" data-astro-cid-iukfgdcn=""> Wi-Fi setup </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#preparing-the-ssd" data-astro-cid-iukfgdcn=""> Preparing the SSD </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#ideal-sector-size" data-astro-cid-iukfgdcn=""> Ideal sector size </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#boot-partition" data-astro-cid-iukfgdcn=""> Boot partition </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#encrypted-root-partition" data-astro-cid-iukfgdcn=""> Encrypted root partition </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#lvm-volumes" data-astro-cid-iukfgdcn=""> LVM volumes </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#file-systems" data-astro-cid-iukfgdcn=""> File systems </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#mounting" data-astro-cid-iukfgdcn=""> Mounting </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#chrooting" data-astro-cid-iukfgdcn=""> Chrooting </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#command-line-interface" data-astro-cid-iukfgdcn=""> Command line interface </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#graphical-user-interface" data-astro-cid-iukfgdcn=""> Graphical user interface </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#display-server" data-astro-cid-iukfgdcn=""> Display server </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#desktop-environment" data-astro-cid-iukfgdcn=""> Desktop environment </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#graphical-boot" data-astro-cid-iukfgdcn=""> Graphical boot </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#boot-process" data-astro-cid-iukfgdcn=""> Boot process </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#kernel-command-line" data-astro-cid-iukfgdcn=""> Kernel command line </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#temporary-file-system" data-astro-cid-iukfgdcn=""> Temporary file system </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#secure-boot" data-astro-cid-iukfgdcn=""> Secure Boot </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#unified-kernel-image" data-astro-cid-iukfgdcn=""> Unified Kernel Image </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#tpm-unlock" data-astro-cid-iukfgdcn=""> TPM unlock </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#uefi-boot-entries" data-astro-cid-iukfgdcn=""> UEFI boot entries </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#other-configurations" data-astro-cid-iukfgdcn=""> Other configurations </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#audio" data-astro-cid-iukfgdcn=""> Audio </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#bluetooth" data-astro-cid-iukfgdcn=""> Bluetooth </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#printing" data-astro-cid-iukfgdcn=""> Printing </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#wi-fi-backend" data-astro-cid-iukfgdcn=""> Wi-Fi backend </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#graphics-card" data-astro-cid-iukfgdcn=""> Graphics card </a> </li><li data-astro-cid-iukfgdcn=""> <a href="#reboot" data-astro-cid-iukfgdcn=""> Reboot </a> </li> </ul> </details> </nav>   <section> <img src="https://giacomo.coletto.io/images/arch-amd.webp" alt="Pingu the archer shooting at a laptop" width="1200" height="630"/> </section> <article id="articleBody" data-title="Installing Arch Linux on a laptop" data-description="How I got rid of Windows and never looked back" data-url="https://giacomo.coletto.io/blog/arch-amd/"> <h2 id="introduction"><a href="#introduction">Introduction</a></h2>
<p>After deciding to replace Windows with a more privacy-friendly OS, and reading about different Linux distributions, I opted for the <a href="https://manjaro.org/products/download/x86">Plasma version of Manjaro Linux</a> for a few reasons:</p>
<ul>
<li>Plasma looks very similar to the Windows UI, but more modern</li>
<li>It is a <a href="https://itsfoss.com/rolling-release/">rolling release</a> distribution, as Manjaro derives from Arch Linux</li>
<li>It has a <a href="https://www.tecmint.com/wp-content/uploads/2022/07/Manjaro-Installation-Language.png">guided graphical installation</a>, unlike Arch Linux</li>
<li>It has a large community</li>
</ul>
<p>After two years of familiarizing myself with the Linux ecosystem, terminal commands, and possible customization, I felt ready to remove the middle man that was Manjaro and go straight for Arch Linux.</p>
<p>In this guide, I explain how I installed Arch Linux on my laptop with these features:</p>
<ul>
<li><a href="https://kde.org/announcements/megarelease/6/">Plasma 6</a>: the UI is great and consistent everywhere</li>
<li><a href="https://www.freedesktop.org/wiki/Software/Plymouth/">Plymouth</a>: the boot process should also look nice</li>
<li><a href="https://wayland.freedesktop.org/">Wayland</a>: a modern display server alternative to X11</li>
<li><a href="https://www.pipewire.org/">PipeWire</a>: a modern audio management alternative to PulseAudio and JACK</li>
<li><a href="https://sourceware.org/lvm2/">LVM</a>: multiple virtual partitions inside a single encrypted partition</li>
<li><a href="https://en.wikipedia.org/wiki/Disk_encryption#Full_disk_encryption">Full-disk encryption</a>: preventing thieves from accessing data</li>
<li><a href="https://wiki.archlinux.org/title/Systemd-cryptenroll#Trusted_Platform_Module">TPM2 PIN decryption</a>: avoid entering a long passphrase at every boot</li>
<li><a href="https://wiki.archlinux.org/title/Unified_kernel_image">Unified Kernel Image</a>: the system boots from a single file</li>
<li><a href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot">Secure Boot</a>: prevent booting from unauthorized drives</li>
</ul>
<p>Most of these steps can be found in the <a href="https://wiki.archlinux.org/title/Category:Installation_process">Arch Wiki</a>, even if they span several pages.
I aim to make the process as straightforward as possible, even for a novice.</p>
<h3 id="requirements"><a href="#requirements">Requirements</a></h3>
<ul>
<li> A modern laptop with an SSD and TPM2</li>
<li> A spare USB flash drive</li>
<li> Internet connectivity</li>
<li> Patience. Lots of it.</li>
</ul>
<h2 id="before-rebooting"><a href="#before-rebooting">Before rebooting</a></h2>
<p>Download the <a href="https://archlinux.org/download/">official installation ISO</a> using a BitTorrent client like <a href="https://www.qbittorrent.org/">qBittorrent</a>.</p>
<p>Mount the ISO to a USB flash drive, or copy it to a <a href="https://giacomo.coletto.io/blog/ventoy">Ventoy flash drive</a>.</p>
<p>Please make a backup of important files in the SSD, as it will be formatted.</p>
<h2 id="modifying-uefi-settings"><a href="#modifying-uefi-settings">Modifying UEFI settings</a></h2>
<p>Before booting from the installation medium, let’s configure a couple of UEFI settings.</p>
<p>First, ensure you have a <strong>UEFI admin password</strong>; otherwise, Secure Boot can be disabled by anyone.</p>
<p>Then, enable the <strong>Secure Boot setup mode</strong>. With this, we can replace the Secure Boot keys later from the OS.</p>
<p>Since instructions vary for each manufacturer, you need to find a guide for your device.</p>
<h2 id="booting-from-archiso"><a href="#booting-from-archiso">Booting from ArchISO</a></h2>
<p>Next, we can plug in the installation drive and boot from the ISO file. After a few seconds, you should see the following command line interface:</p>
<figure><a href="https://giacomo.coletto.io/images/arch-amd-iso.avif"><img src="https://giacomo.coletto.io/images/arch-amd-iso.avif" alt="The CLI interface of ArchISO" width="706" height="370" loading="lazy"/></a><figcaption>The CLI interface of ArchISO</figcaption></figure>
<p>First, set the keyboard layout, time zone, and silence the PC speaker:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># load the italian keyboard layout</span></span>
<span data-line=""><span>loadkeys</span><span> it</span></span>
<span data-line=""> </span>
<span data-line=""><span># silence the speaker</span></span>
<span data-line=""><span>rmmod</span><span> pcspkr</span></span>
<span data-line=""> </span>
<span data-line=""><span># enlarge the font</span></span>
<span data-line=""><span>setfont</span><span> ter-128b</span></span>
<span data-line=""> </span>
<span data-line=""><span># set the correct time</span></span>
<span data-line=""><span>timedatectl</span><span> set-timezone</span><span> &#34;Europe/Rome&#34;</span></span>
<span data-line=""><span>timedatectl</span><span> set-ntp</span><span> true</span></span></code></pre></figure>
<h3 id="wi-fi-setup"><a href="#wi-fi-setup">Wi-Fi setup</a></h3>
<p>If you don’t have an Ethernet cable nearby, set up wi-fi connectivity:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>iwctl</span></span></code></pre></figure>
<p>From the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>iwctl</span></span></code></span> prompt, run <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>device list</span></span></code></span>. You should see the following:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>                                   Devices                                   *  </span></span>
<span data-line=""><span>--------------------------------------------------------------------------------  </span></span>
<span data-line=""><span> Name                  Address               Powered     Adapter     Mode         </span></span>
<span data-line=""><span>--------------------------------------------------------------------------------  </span></span>
<span data-line=""><span> </span><mark data-highlighted-chars=""><span>wlan0</span></mark><span>                 7c:76:35:83:65:43     </span><mark data-highlighted-chars=""><span>on</span></mark><span>          phy0        station        </span></span></code></pre></figure>
<p>If the device is off, activate it with</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>device</span><span> wlan0</span><span> set-property</span><span> Powered</span><span> on</span></span></code></pre></figure>
<p>Then, connect to your network and exit <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>iwctl</span></span></code></span>:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>station</span><span> wlan0</span><span> connect</span><span> &#34;My SSID&#34;</span></span>
<span data-line=""><span>exit</span></span></code></pre></figure>
<p>From the shell prompt, check for connectivity:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>ping</span><span> -c</span><span> 3</span><span> archlinux.org</span></span></code></pre></figure>
<h2 id="preparing-the-ssd"><a href="#preparing-the-ssd">Preparing the SSD</a></h2>
<p>Now we will format and organize the disk into several partitions.
We will then initialize the OS and <a href="https://en.wikipedia.org/wiki/Chroot">chroot</a> into it.</p>
<h3 id="ideal-sector-size"><a href="#ideal-sector-size">Ideal sector size</a></h3>
<p>For optimal performance, set the ideal sector size of the SSD.</p>
<details>
  <summary>For SATA</summary>
Check the available sector sizes:
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>hdparm</span><span> -I</span><span> /dev/sda</span><span> |</span><span> grep</span><span> &#39;Sector size:&#39;</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>       Logical  Sector size:                   </span><mark data-highlighted-chars=""><span>512</span></mark><span> bytes  </span></span>
<span data-line=""><span>       Physical Sector size:                  </span><mark data-highlighted-chars=""><span>4096</span></mark><span> bytes</span></span></code></pre></figure>
<p>If sector size 4096 is suppoted, select it and confirm the change:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>hdparm</span><span> --set-sector-size</span><span> 4096</span><span> --please-destroy-my-drive</span><span> /dev/sda</span></span>
<span data-line=""><span>hdparm</span><span> -I</span><span> /dev/sda</span><span> |</span><span> grep</span><span> &#39;Sector size:&#39;</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>       Logical  Sector size:                  </span><mark data-highlighted-chars=""><span>4096</span></mark><span> bytes  </span></span>
<span data-line=""><span>       Physical Sector size:                  </span><mark data-highlighted-chars=""><span>4096</span></mark><span> bytes</span></span></code></pre></figure>
</details>
<details>
  <summary>For NVMe</summary>
 Check the performance of different LBA sizes:
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nvme</span><span> id-ns</span><span> -H</span><span> /dev/nvme0n1</span><span> |</span><span> grep</span><span> &#34;Relative Performance&#34;</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>LBA Format  0 : Metadata Size: 0   bytes - Data Size: 512 bytes - Relative Performance: 0x2 Good </span><mark data-highlighted-chars=""><span>(in use)</span></mark></span>
<span data-line=""><span>LBA Format  1 : Metadata Size: 0   bytes - Data Size: 4096 bytes - Relative Performance: 0x1 </span><mark data-highlighted-chars=""><span>Better</span></mark></span></code></pre></figure>
<p>Select the best LBA format (1 in this case) and confirm the change:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nvme</span><span> format</span><span> --lbaf=1</span><span> /dev/nvme0n1</span></span>
<span data-line=""><span>nvme</span><span> id-ns</span><span> -H</span><span> /dev/nvme0n1</span><span> |</span><span> grep</span><span> &#34;Relative Performance&#34;</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>LBA Format  0 : Metadata Size: 0   bytes - Data Size: 512 bytes - Relative Performance: 0x2 Good</span></span>
<span data-line=""><span>LBA Format  1 : Metadata Size: 0   bytes - Data Size: 4096 bytes - Relative Performance: 0x1 </span><mark data-highlighted-chars=""><span>Better</span></mark><span> </span><mark data-highlighted-chars=""><span>(in use)</span></mark></span></code></pre></figure>
</details>
<p>From now on, I will assume the SSD is <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/dev/nvme0n1</span></span></code></span>.</p>
<h3 id="boot-partition"><a href="#boot-partition">Boot partition</a></h3>
<p>Create a 1GB boot partition to store the bootloader:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># create a new partition table</span></span>
<span data-line=""><span>parted</span><span> -s</span><span> /dev/nvme0n1</span><span> mklabel</span><span> gpt</span></span>
<span data-line=""> </span>
<span data-line=""><span># create a boot partition</span></span>
<span data-line=""><span>parted</span><span> -s</span><span> /dev/nvme0n1</span><span> mkpart</span><span> &#34;ESP&#34;</span><span> fat32</span><span> 1MiB</span><span> 1025MiB</span></span>
<span data-line=""> </span>
<span data-line=""><span># make the partition bootable</span></span>
<span data-line=""><span>parted</span><span> -s</span><span> /dev/nvme0n1</span><span> set</span><span> 1</span><span> esp</span><span> on</span></span></code></pre></figure>
<h3 id="encrypted-root-partition"><a href="#encrypted-root-partition">Encrypted root partition</a></h3>
<p>Create a large OS partition, and encrypt it using a strong passphrase when prompted:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># create a linux partition with the remaining space</span></span>
<span data-line=""><span>parted</span><span> -s</span><span> /dev/nvme0n1</span><span> mkpart</span><span> &#34;OS&#34;</span><span> ext4</span><span> 1025MiB</span><span> 100%</span></span>
<span data-line=""> </span>
<span data-line=""><span># make the new partition a LUKS volume</span></span>
<span data-line=""><span>cryptsetup</span><span> luksFormat</span><span> /dev/nvme0n1p2</span><span> \</span></span>
<span data-line=""><span> --cipher</span><span> aes-xts-plain64</span><span> \</span></span>
<span data-line=""><span> --key-size</span><span> 512</span><span> \</span></span>
<span data-line=""><span> --hash</span><span> sha512</span><span> \</span></span>
<span data-line=""><span> --pbkdf</span><span> argon2id</span><span> \</span></span>
<span data-line=""><span> --iter-time</span><span> 5000</span><span> \</span></span>
<span data-line=""><span> --sector-size</span><span> 4096</span></span></code></pre></figure>
<p>Decrypt the LUKS volume:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>cryptsetup</span><span> open</span><span> /dev/nvme0n1p2</span><span> &#34;cryptpart&#34;</span></span></code></pre></figure>
<p>The content of the volume is now available at <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/dev/mapper/cryptpart</span></span></code></span>.</p>
<h3 id="lvm-volumes"><a href="#lvm-volumes">LVM volumes</a></h3>
<p>In our case, LVM makes it easy to allocate virtual partitions inside an encrypted SSD partition.</p>
<blockquote>
<p>Why not use the LUKS volume directly as a single partition?</p>
</blockquote>
<p>Using LVM terminology, our decrypted LUKS volume will be used as a “physical volume” (PV). We will add this PV to a “volume group” (VG). Then, we will create different “logical volumes” (LV) that will be allocated to the VG.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># create the physical volume</span></span>
<span data-line=""><span>pvcreate</span><span> /dev/mapper/cryptpart</span></span>
<span data-line=""> </span>
<span data-line=""><span># create the volume group and assign the pv to it</span></span>
<span data-line=""><span>vgcreate</span><span> &#34;os&#34;</span><span> /dev/mapper/cryptpart</span></span>
<span data-line=""> </span>
<span data-line=""><span># create a 25 GB logical volume for backup purpose (optional)</span></span>
<span data-line=""><span>lvcreate</span><span> -L</span><span> 25GB</span><span> &#34;os&#34;</span><span> -n</span><span> backup</span></span>
<span data-line=""> </span>
<span data-line=""><span># create a 100 GB logical volume for system files </span></span>
<span data-line=""><span>lvcreate</span><span> -L</span><span> 100GB</span><span> &#34;os&#34;</span><span> -n</span><span> root</span></span>
<span data-line=""> </span>
<span data-line=""><span># create a volume with the remaining space for user files</span></span>
<span data-line=""><span>lvcreate</span><span> -l</span><span> 100%FREE</span><span> &#34;os&#34;</span><span> -n</span><span> home</span></span>
<span data-line=""><span>lvreduce</span><span> -L</span><span> -256M</span><span> os/home</span></span></code></pre></figure>
<p>You can now check these groups by running:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>lvdisplay</span></span>
<span data-line=""><span>lsblk</span></span></code></pre></figure>
<p>The output should look like this:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span>NAME              MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS  </span></span>
<span data-line=""><span>nvme0n1           259:0    0 465.8G  0 disk     </span></span>
<span data-line=""><span>  nvme0n1p1       259:1    0     1G  0 part  </span></span>
<span data-line=""><span>  nvme0n1p2       259:2    0 464.8G  0 part    </span></span>
<span data-line=""><span>   cryptpart      254:0    0 464.7G  0 crypt    </span></span>
<span data-line=""><span>     </span><mark data-highlighted-chars=""><span>os-backup</span></mark><span>    254:1    0    25G  0 lvm     </span></span>
<span data-line=""><span>     </span><mark data-highlighted-chars=""><span>os-root</span></mark><span>      254:2    0   200G  0 lvm     </span></span>
<span data-line=""><span>     </span><mark data-highlighted-chars=""><span>os-home</span></mark><span>      254:3    0 239.5G  0 lvm   </span></span></code></pre></figure>
<h3 id="file-systems"><a href="#file-systems">File systems</a></h3>
<p>Now that the logical volumes are in place, we can build the file system for them and for the boot partition:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># logical volumes</span></span>
<span data-line=""><span>mkfs.ext4</span><span> /dev/os/backup</span></span>
<span data-line=""><span>mkfs.ext4</span><span> /dev/os/root</span></span>
<span data-line=""><span>mkfs.ext4</span><span> /dev/os/home</span></span>
<span data-line=""> </span>
<span data-line=""><span># boot partition</span></span>
<span data-line=""><span>mkfs.fat</span><span> -F32</span><span> /dev/nvme0n1p1</span></span></code></pre></figure>
<h3 id="mounting"><a href="#mounting">Mounting</a></h3>
<p>The last step is to mount these file systems into folders, so we can place our new OS files inside:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># logical volumes</span></span>
<span data-line=""><span>mount</span><span> --mkdir</span><span> /dev/os/root</span><span>   /mnt</span></span>
<span data-line=""><span>mount</span><span> --mkdir</span><span> /dev/os/backup</span><span> /mnt/backup</span></span>
<span data-line=""><span>mount</span><span> --mkdir</span><span> /dev/os/home</span><span>   /mnt/home</span></span>
<span data-line=""><span>mkdir</span><span> /mnt/boot</span></span>
<span data-line=""> </span>
<span data-line=""><span># boot partition</span></span>
<span data-line=""><span>mount</span><span> --mkdir</span><span> /dev/nvme0n1p1</span><span> /mnt/efi</span></span></code></pre></figure>
<h3 id="chrooting"><a href="#chrooting">Chrooting</a></h3>
<p>The new system has its root folder “<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/</span></span></code></span>” mounted to <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/mnt</span></span></code></span>.
We can initialize it by installing some packages:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>pacstrap</span><span> &#34;/mnt&#34;</span><span> base</span><span> linux</span><span> linux-firmware</span><span> &#34;intel-ucode&#34;</span><span> nano</span><span> networkmanager</span><span> jq</span><span> lvm2</span></span></code></pre></figure>
<p>If you have an <strong>AMD processor</strong>, replace <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>intel-ucode</span></span></code></span> with <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>amd-ucode</span></span></code></span>.</p>
<p>Once done, save the current disk configuration to the root volume:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>genfstab</span><span> -U</span><span> /mnt</span><span> &gt;&gt;</span><span> /mnt/etc/fstab</span></span></code></pre></figure>
<p>Now, let’s enter the new Arch Linux system as if we booted from it:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>arch-chroot</span><span> /mnt</span></span></code></pre></figure>
<h2 id="command-line-interface"><a href="#command-line-interface">Command line interface</a></h2>
<p>I highly recommend taking some time now to follow the customization and productivity enhancement I wrote in <a href="https://giacomo.coletto.io/blog/arch-conf/">this post</a>, as it will greatly improve your user experience for the rest of this guide.</p>
<p>From now on, I will assume you have created an unprivileged user to run <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>yay</span></span></code></span>.</p>
<h2 id="graphical-user-interface"><a href="#graphical-user-interface">Graphical user interface</a></h2>
<p>Once the CLI is set up, installing the GUI is a breeze.</p>
<figure><a href="https://giacomo.coletto.io/images/arch-amd-plasma.avif"><img src="https://giacomo.coletto.io/images/arch-amd-plasma.avif" alt="How KDE Plasma 6 will look" width="1920" height="1080" loading="lazy"/></a><figcaption>How KDE Plasma 6 will look</figcaption></figure>
<h3 id="display-server"><a href="#display-server">Display server</a></h3>
<p>Let’s install some packages needed to run graphical applications:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> wayland</span><span> qt6-wayland</span><span> qt6-virtualkeyboard</span><span> sddm-git</span><span> xorg-xeyes</span><span> xorg-xwayland</span><span> xdg-desktop-portal</span><span> wl-clipboard</span><span> glfw-wayland</span><span> drm_tool</span></span></code></pre></figure>
<p>Set the default cursor to match the Breeze theme:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nano</span><span> /usr/share/icons/default/index.theme</span></span></code></pre></figure>
<p>And replace “Awaita” with “Breeze”:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="ini" data-theme="github-light github-dark">index.theme</figcaption><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span>[Icon Theme]</span><span>  </span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="removed"><span>Inherits</span><span>=Awaita</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>Inherits</span><span>=Breeze</span></span></code></pre></figure>
<h3 id="desktop-environment"><a href="#desktop-environment">Desktop environment</a></h3>
<p>Now we can install the desktop environment (Plasma) and session manager (SDDM):</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> plasma-meta</span><span> kde-gtk-config</span><span> sddm</span><span> xorg-xinit</span><span> xorg-xhost</span><span> phonon-qt6-vlc</span><span> qt6-multimedia-ffmpeg</span><span> dnsmasq</span><span> kdenetwork-filesharing</span></span></code></pre></figure>
<p>We need to configure SDDM to launch Plasma using Wayland:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nano</span><span> /etc/sddm.conf.d/10-wayland.conf</span></span></code></pre></figure>
<p>Copy the following into the file:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="ini" data-theme="github-light github-dark">10-wayland.conf</figcaption><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span>[General]</span></span>
<span data-line=""><span>DisplayServer</span><span>=wayland</span></span>
<span data-line=""><span>GreeterEnvironment</span><span>=</span><span>QT_WAYLAND_SHELL_INTEGRATION</span><span>=layer-shell</span></span>
<span data-line=""> </span>
<span data-line=""><span>[Wayland]</span></span>
<span data-line=""><span>CompositorCommand</span><span>=kwin_wayland --drm --no-lockscreen --no-global-shortcuts --inputmethod qtvirtualkeyboard</span></span>
<span data-line=""> </span>
<span data-line=""><span>[Theme]</span></span>
<span data-line=""><span>EnableAvatars</span><span>=true</span></span>
<span data-line=""><span>DisableAvatarsThreshold</span><span>=7</span></span></code></pre></figure>
<p>Once we apply this configuration, we can start SDDM on each boot:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>systemctl</span><span> enable</span><span> sddm</span></span></code></pre></figure>
<figure><a href="https://giacomo.coletto.io/images/arch-amd-sddm.avif"><img src="https://giacomo.coletto.io/images/arch-amd-sddm.avif" alt="How SDDM will look" width="4080" height="2294" loading="lazy"/></a><figcaption>How SDDM will look</figcaption></figure>
<!--
We can also set the Breeze theme for TK applications (like `gitk`):

```bash
ttk-theme-chooser breeze 
```
-->
<h3 id="graphical-boot"><a href="#graphical-boot">Graphical boot</a></h3>
<p>With the current setup, the boot process would display text in a terminal until we see SDDM’s login screen.
By using a Plymouth theme, we can hide this behind a nicer loading screen:</p>
<figure><a href="https://giacomo.coletto.io/images/arch-amd-plymouth.avif"><img src="https://giacomo.coletto.io/images/arch-amd-plymouth.avif" alt="How Plymouth with the Breeze theme will look" width="1920" height="1008" loading="lazy"/></a><figcaption>How Plymouth with the Breeze theme will look</figcaption></figure>
<p>Install Plymouth and set the Breeze theme:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> plymouth-git</span><span> plymouth-theme-arch-breeze-git</span></span>
<span data-line=""><span>plymouth-set-default-theme</span><span> arch-breeze</span></span></code></pre></figure>
<p>Now that the graphical part is complete, we can tackle the most delicate part: configuring the boot process.</p>
<h2 id="boot-process"><a href="#boot-process">Boot process</a></h2>
<p>There are several components to be configured for the boot process to work smoothly and securely.</p>
<p>The final result will be a single file placed in the unencrypted boot partition, signed with a Secure Boot “db” key. When Secure Boot is on, the laptop can only boot from this file.</p>
<h3 id="kernel-command-line"><a href="#kernel-command-line">Kernel command line</a></h3>
<p>First, we need to configure the Linux kernel to find our root volume and display Plymouth properly.</p>
<p>Run <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>blkid</span></span></code></span> and save the UUID of the encrypted SSD partition, which has <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>type=&#34;crypto_LUKS&#34;</span></span></code></span>:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span>/dev/nvme0n1p1: </span><span>UUID</span><span>=</span><span>&#34;9EAC-DCD1&#34;</span><span> BLOCK_SIZE</span><span>=</span><span>&#34;4096&#34;</span><span> TYPE</span><span>=</span><span>&#34;vfat&#34;</span><span> PARTLABEL</span><span>=</span><span>&#34;ESP&#34;</span><span> PARTUUID</span><span>=</span><span>&#34;ded4c683-b672-45af-9bee-10887c030b71&#34;</span><span>  </span></span>
<span data-line=""><span>/dev/nvme0n1p2: </span><span>UUID</span><span>=</span><span>&#34;</span><mark data-highlighted-chars=""><span>2e708dd6-61e4-40ec-b30e-ca119d4467e5</span></mark><span>&#34;</span><span> TYPE</span><span>=</span><span>&#34;</span><mark data-highlighted-chars=""><span>crypto_LUKS</span></mark><span>&#34;</span><span> PARTLABEL</span><span>=</span><span>&#34;OS&#34;</span><span> PARTUUID</span><span>=</span><span>&#34;6e6e282a-4ad7-4c9b-8fff-22f353b9c552&#34;</span><span>  </span></span>
<span data-line=""><span>/dev/mapper/cryptpart: </span><span>UUID</span><span>=</span><span>&#34;wWfAjv-lv5u-Mbyo-iAZT-K8He-6nIc-TNGpfP&#34;</span><span> TYPE</span><span>=</span><span>&#34;LVM2_member&#34;</span></span>
<span data-line=""><span>/dev/mapper/os-backup: </span><span>UUID</span><span>=</span><span>&#34;9c4f9b51-f68e-4d4f-bbd1-f32948ba7018&#34;</span><span> BLOCK_SIZE</span><span>=</span><span>&#34;4096&#34;</span><span> TYPE</span><span>=</span><span>&#34;ext4&#34;</span></span>
<span data-line=""><span>/dev/mapper/os-home: </span><span>UUID</span><span>=</span><span>&#34;c5391d08-7901-4296-bf0a-a7f7c94e44dc&#34;</span><span> BLOCK_SIZE</span><span>=</span><span>&#34;4096&#34;</span><span> TYPE</span><span>=</span><span>&#34;ext4&#34;</span></span>
<span data-line=""><span>/dev/mapper/os-root: </span><span>UUID</span><span>=</span><span>&#34;f52ad892-4f7a-4377-9e70-e6890b553760&#34;</span><span> BLOCK_SIZE</span><span>=</span><span>&#34;4096&#34;</span><span> TYPE</span><span>=</span><span>&#34;ext4&#34;</span></span></code></pre></figure>
<p>Create a file with the kernel parameters:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>mkdir</span><span> -p</span><span> /etc/cmdline.d</span></span>
<span data-line=""><span>nano</span><span> /etc/cmdline.d/custom.conf</span></span></code></pre></figure>
<p>Copy the following into the file:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="ini" data-theme="github-light github-dark">custom.conf</figcaption><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span># encrypted partition uuid, name, and options</span></span>
<span data-line=""><span>rd.luks.name</span><span>=</span><span>2e708dd6-61e4-40ec-b30e-ca119d4467e5</span><span>=cryptpart</span></span>
<span data-line=""><span>rd.luks.options</span><span>=discard,no-read-workqueue,no-write-workqueue</span></span>
<span data-line=""> </span>
<span data-line=""><span># root directory</span></span>
<span data-line=""><span>root</span><span>=/dev/os/root  </span></span>
<span data-line=""><span>rw</span></span>
<span data-line=""><span>rootwait</span></span>
<span data-line=""> </span>
<span data-line=""><span># plymouth</span></span>
<span data-line=""><span>quiet</span></span>
<span data-line=""><span>splash</span></span>
<span data-line=""><span>vt.global_cursor_default</span><span>=0</span></span>
<span data-line=""><span>fbcon</span><span>=nodefer</span></span>
<span data-line=""> </span>
<span data-line=""><span># prevent launching privileged commands from the boot shell</span></span>
<span data-line=""><span>rd.shell</span><span>=0</span></span>
<span data-line=""><span>rd.emergency</span><span>=reboot</span></span></code></pre></figure>
<h3 id="temporary-file-system"><a href="#temporary-file-system">Temporary file system</a></h3>
<p>We will now configure the generation of the boot temporary file system, a file that contains the Linux kernel and other boot utilities.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nano</span><span> /etc/mkinitcpio.conf</span></span></code></pre></figure>
<p>To use the TPM and early graphical boot, comment out the existing <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>MODULES</span></span></code></span> array, make a copy, and add <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>tpm_tis</span></span></code></span> and your GPU modules to it. In this case, <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>i915</span></span></code></span> is the module for the integrated Intel GPU:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">mkinitcpio.conf</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><mark data-highlighted-chars="" data-chars-id="added"><span>#</span></mark><span>MODULES=()</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>MODULES</span><span>=</span><span>(</span><span>tpm_tis</span><span> i915</span><span>)</span></span>
<span data-line=""> </span>
<span data-line=""><span># ...</span></span></code></pre></figure>
<p>In the same file, make a copy of the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>HOOKS</span></span></code></span> array and modify it in this way:</p>
<ul>
<li>replace the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>base</span></span></code></span> and <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>udev</span></span></code></span> hooks with <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>systemd</span></span></code></span></li>
<li>move <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>keyboard</span></span></code></span> after <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>systemd</span></span></code></span></li>
<li>add <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>plymouth</span></span></code></span> after <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>kms</span></span></code></span></li>
<li>replace <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>keymap</span></span></code></span> and <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>consolefont</span></span></code></span> with <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>sd-vconsole</span></span></code></span></li>
<li>add <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>sd-encrypt</span></span></code></span> and <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>lvm2</span></span></code></span> after <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>block</span></span></code></span></li>
</ul>
<p>The final result should look like this:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">mkinitcpio.conf</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-line-numbers="" data-language="bash" data-theme="github-light github-dark" data-line-numbers-max-digits="2"><span data-line=""><span># ...</span></span>
<span data-line=""> </span>
<span data-line=""><mark data-highlighted-chars="" data-chars-id="added"><span>#</span></mark><span>HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block filesystems fsck)</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>HOOKS</span><span>=</span><span>(</span><span>systemd</span><span> keyboard</span><span> autodetect</span><span> microcode</span><span> modconf</span><span> kms</span><span> plymouth</span><span> sd-vconsole</span><span> block</span><span> sd-encrypt</span><span> lvm2</span><span> filesystems</span><span> fsck</span><span>)</span></span>
<span data-line=""> </span>
<span data-line=""><span># ...</span></span></code></pre></figure>
<h3 id="secure-boot"><a href="#secure-boot">Secure Boot</a></h3>
<p>By default, most computers authorize only Microsoft’s signature, so that only the official Windows bootloader can be executed at boot.</p>
<p>Now, we will create and enroll our own keys as UEFI variables.
We will then use the db key to sign our bootloader automatically every time it gets rebuilt.</p>
<p>Install these utilities and generate your Secure Boot keys:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> efibootmgr</span><span> sbctl</span><span> sbsigntools</span></span>
<span data-line=""><span>sbctl</span><span> create-keys</span></span></code></pre></figure>
<p>Check if the system has been booted into Setup Mode before enrolling your Secure Boot keys:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>sbctl</span><span> status</span></span></code></pre></figure>
<p>You should see:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>Installed:      ✓ sbctl is installed</span></span>
<span data-line=""><span>Owner GUID:     ge708dd6-61e4-40ec-b30e-ca119d4467e5</span></span>
<span data-line=""><span>Setup Mode:     ✓ Enabled</span></span>
<span data-line=""><span>Secure Boot:    ✗ Disabled</span></span>
<span data-line=""><span>Vendor Keys:    microsoft</span></span></code></pre></figure>
<p>Then, you can enroll your keys:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>sbctl</span><span> enroll-keys</span><span> -m</span></span></code></pre></figure>
<p>Create a new hook at <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/etc/initcpio/post/sbsign</span></span></code></span> that automatically signs the unified kernel image whenever <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>mkinitcpio</span></span></code></span> is run:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">sbsign</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>#!/usr/bin/env bash</span></span>
<span data-line=""> </span>
<span data-line=""><span>uki</span><span>=</span><span>&#34;</span><span>$3</span><span>&#34;</span></span>
<span data-line=""><span>[[ </span><span>-n</span><span> &#34;</span><span>$uki</span><span>&#34;</span><span> ]] </span><span>||</span><span> exit</span><span> 0</span></span>
<span data-line=""> </span>
<span data-line=""><span>key</span><span>=</span><span>/var/lib/sbctl/keys/db/db.key</span></span>
<span data-line=""><span>cert</span><span>=</span><span>/var/lib/sbctl/keys/db/db.pem</span></span>
<span data-line=""><span>if</span><span> !</span><span> sbverify</span><span> --cert</span><span> &#34;</span><span>$cert</span><span>&#34;</span><span> &#34;</span><span>$uki</span><span>&#34;</span><span> &amp;</span><span>&gt;</span><span>/dev/null; </span><span>then</span></span>
<span data-line=""><span> sbsign</span><span> --key</span><span> &#34;</span><span>$key</span><span>&#34;</span><span> --cert</span><span> &#34;</span><span>$cert</span><span>&#34;</span><span> --output</span><span> &#34;</span><span>$uki</span><span>&#34;</span><span> &#34;</span><span>$uki</span><span>&#34;</span><span> &amp;</span><span>&gt;</span><span>/dev/null</span></span>
<span data-line=""><span>fi</span></span></code></pre></figure>
<p>Make the file executable:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>chmod</span><span> +x</span><span> /etc/initcpio/post/sbsign</span></span></code></pre></figure>
<p>Remove some unneeded <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>sbctl</span></span></code></span> hooks:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>rm</span><span> -f</span><span> /usr/lib/initcpio/post/sbctl</span><span> /usr/share/libalpm/hooks/zz-sbctl.hook</span></span></code></pre></figure>
<p>Prevent pacman from restoring them by editing <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/etc/pacman.conf</span></span></code></span>:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="ini" data-theme="github-light github-dark">pacman.conf</figcaption><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-line-numbers="" data-language="ini" data-theme="github-light github-dark" data-line-numbers-max-digits="2"><span data-line=""><span># ...</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>[options]</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>NoExtract</span><span>    = usr/lib/initcpio/post/sbctl  </span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>NoExtract</span><span>    = usr/share/libalpm/hooks/zz-sbctl.hook</span></span>
<span data-line=""> </span>
<span data-line=""><span># ...</span></span></code></pre></figure>
<h3 id="unified-kernel-image"><a href="#unified-kernel-image">Unified Kernel Image</a></h3>
<p>Make a backup copy of <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>/etc/mkinitcpio.d/linux.preset</span></span></code></span>:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>mv</span><span> /etc/mkinitcpio.d/linux.preset</span><span> /etc/mkinitcpio.d/linux.preset.bak</span></span></code></pre></figure>
<p>Then, create a new .preset file:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nano</span><span> /etc/mkinitcpio.d/linux.preset</span></span></code></pre></figure>
<p>Copy the following into the file:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">linux.preset</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>ALL_kver</span><span>=</span><span>&#34;/boot/vmlinuz-linux&#34;</span><span>  </span></span>
<span data-line=""><span>PRESETS</span><span>=</span><span>(</span><span>&#39;default&#39;</span><span> &#39;fallback&#39;</span><span>)</span></span>
<span data-line=""> </span>
<span data-line=""><span>default_uki</span><span>=</span><span>&#34;/efi/arch.efi&#34;</span></span>
<span data-line=""><span>fallback_uki</span><span>=</span><span>&#34;/efi/arch-fallback.efi&#34;</span><span>  </span></span>
<span data-line=""><span>fallback_options</span><span>=</span><span>&#34;-S autodetect&#34;</span></span></code></pre></figure>
<p>The <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>fallback_uki</span></span></code></span> option will create another unified kernel image with different settings, useful in case you have problems booting from the default file.</p>
<p>Now that we have everything in place, we can finally generate and sign the two unified kernel images:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>mkinitcpio</span><span> -P</span></span></code></pre></figure>
<p>Check that two files have been created inside the boot partition, and that they are signed with your Secure Boot key:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>ls</span><span> -la</span><span> /efi</span></span>
<span data-line=""><span>sbverify</span><span> --cert</span><span> /var/lib/sbctl/keys/db/db.pem</span><span> /efi/arch.efi</span></span>
<span data-line=""><span>sbverify</span><span> --cert</span><span> /var/lib/sbctl/keys/db/db.pem</span><span> /efi/arch-fallback.efi</span></span></code></pre></figure>
<h3 id="tpm-unlock"><a href="#tpm-unlock">TPM unlock</a></h3>
<p>With the current setup, we would need to enter the LUKS decryption passphrase at every boot.
We can use our TPM to protect the LUKS encryption key, and retrieve it after we enter a PIN:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>systemd-cryptenroll</span><span> \</span></span>
<span data-line=""><span> --tpm2-device=auto</span><span> \</span></span>
<span data-line=""><span> --tpm2-pcrs=0+1+5+7+8</span><span> \</span></span>
<span data-line=""><span> --tpm2-with-pin=true</span><span> \</span></span>
<span data-line=""><span> /dev/nvme0n1p2</span></span></code></pre></figure>
<p>You can check that a new entry has been created under the “Tokens” section of the LUKS header:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>cryptsetup</span><span> luksDump</span><span> /dev/nvme0n1p2</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span># ...</span></span>
<span data-line=""> </span>
<span data-line=""><span>Tokens:</span></span>
<span data-line=""><span>  0: systemd-tpm2</span></span>
<span data-line=""><span>        tpm2-hash-pcrs:   0+1+5+7+8</span></span>
<span data-line=""><span>        tpm2-pcr-bank:    sha256</span></span>
<span data-line=""><span>        tpm2-pubkey:</span></span>
<span data-line=""><span>                    (null)</span></span>
<span data-line=""><span>        tpm2-pubkey-pcrs: </span></span>
<span data-line=""><span>        tpm2-primary-alg: ecc</span></span>
<span data-line=""><span>        tpm2-blob:  00 9e 00 20 3c cc 11 f3 44 33 0f 35 5e 37 f3 ee</span></span>
<span data-line=""> </span>
<span data-line=""><span># ...</span></span></code></pre></figure>
<p>Starting from the next boot, the PIN prompt will look this:</p>
<figure><a href="https://giacomo.coletto.io/images/arch-amd-tpm.avif"><img src="https://giacomo.coletto.io/images/arch-amd-tpm.avif" alt="How the PIN prompt will look" width="1600" height="908" loading="lazy"/></a><figcaption>How the PIN prompt will look</figcaption></figure>
<h3 id="uefi-boot-entries"><a href="#uefi-boot-entries">UEFI boot entries</a></h3>
<p>The final step before rebooting is actually creating two UEFI boot entries for these two UKIs:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>efibootmgr</span><span> \</span></span>
<span data-line=""><span> --create</span><span> \</span></span>
<span data-line=""><span> --disk</span><span> /dev/nvme0n1</span><span> \</span></span>
<span data-line=""><span> --part</span><span> 1</span><span> \</span></span>
<span data-line=""><span> --label</span><span> &#34;Arch Linux&#34;</span><span> \</span></span>
<span data-line=""><span> --loader</span><span> &#34;</span><span>\\</span><span>arch.efi&#34;</span></span>
<span data-line=""> </span>
<span data-line=""><span>efibootmgr</span><span> \</span></span>
<span data-line=""><span> --create</span><span> \</span></span>
<span data-line=""><span> --disk</span><span> /dev/nvme0n1</span><span> \</span></span>
<span data-line=""><span> --part</span><span> 1</span><span> \</span></span>
<span data-line=""><span> --label</span><span> &#34;Arch Linux Fallback&#34;</span><span> \</span></span>
<span data-line=""><span> --loader</span><span> &#34;</span><span>\\</span><span>arch-fallback.efi&#34;</span></span></code></pre></figure>
<h2 id="other-configurations"><a href="#other-configurations">Other configurations</a></h2>
<p>Now that the boot process is done, we can finalize our installation with some desktop-specific features.</p>
<h3 id="audio"><a href="#audio">Audio</a></h3>
<p>To make audio work out of the box, install PipeWire:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> pipewire</span><span> pipewire-alsa</span><span> pipewire-jack</span><span> pipewire-pulse</span><span> pipewire-v4l2</span><span> wireplumber</span><span> alsa-utils</span></span></code></pre></figure>
<h3 id="bluetooth"><a href="#bluetooth">Bluetooth</a></h3>
<p>For Bluetooth connectivity, install Bluez:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> bluez</span></span></code></pre></figure>
<!--
Battery level monitoring is not enabled by default, so let's enable it:

```bash
sed -i /etc/bluetooth/main.conf \
 -e "s|^#Experimental = false$|Experimental = true|"
systemctl enable bluetooth
```

The same applies for audio profile switching:

```bash
 mkdir -p "/etc/pipewire/media-session.d/"
 cp "/usr/share/pipewire/media-session.d/bluez-monitor.conf" "/etc/pipewire/media-session.d/"
 sed -i "/etc/pipewire/media-session.d/bluez-monitor.conf" \
  -e "s|bluez5.autoswitch-profile = role|bluez5.autoswitch-profile = true|"
```


### Firefox

If you plan to use Firefox in Plasma, you can enable the KDE file picker instead of the GTK one. As your **unprivileged user**, run:

```bash
yay -S firefox

mkdir -p "$HOME/.local/share/applications"
cp "/usr/share/applications/firefox.desktop" "$HOME/.local/share/applications"
sed -i "$HOME/.local/share/applications/firefox.desktop" \
    -e "s|Exec=/usr/lib/firefox/firefox %u|Exec=env GTK_USE_PORTAL=1 /usr/lib/firefox/firefox %u|"
```
-->
<h3 id="printing"><a href="#printing">Printing</a></h3>
<p>CUPS comes with a web interface to manage printers. To install it, run:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> cups</span><span> cups-pdf</span></span>
<span data-line=""><span>systemctl</span><span> enable</span><span> cups</span></span></code></pre></figure>
<h3 id="wi-fi-backend"><a href="#wi-fi-backend">Wi-Fi backend</a></h3>
<p>By default, NetworkManager uses <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>wpa_supplicant</span></span></code></span> as its wireless network backend.
To use the newer <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>iwd</span></span></code></span>, create a custom configuration file:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nano</span><span> /etc/NetworkManager/conf.d/custom.conf</span></span></code></pre></figure>
<p>Copy the following into the file:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="ini" data-theme="github-light github-dark">custom.conf</figcaption><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span>[main]</span></span>
<span data-line=""><span>rc-manager</span><span>=resolvconf</span></span>
<span data-line=""> </span>
<span data-line=""><span>[device]</span></span>
<span data-line=""><span>wifi.backend</span><span>=iwd</span></span></code></pre></figure>
<p>Start NetworkManager on each boot:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>systemctl</span><span> enable</span><span> NetworkManager</span></span></code></pre></figure>
<h3 id="graphics-card"><a href="#graphics-card">Graphics card</a></h3>
<p>To keep the guide straightforward, we only covered the example of a laptop with an integrated Intel GPU.
However, there are a few configurations to change based on your GPU:</p>
<details>
  <summary>Intel-only</summary>
Install the user-space driver:
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> mesa</span><span> mesa-demos</span><span> mesa-utils</span><span> vulkan-intel</span><span> intel-media-driver</span><span> intel-gpu-tools</span></span></code></pre></figure>
</details>
<details>
  <summary>Nvidia-only</summary>
<p>Install the Nvidia kernel driver:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> nvidia</span><span> nvtop</span></span></code></pre></figure>
<p>Append to the kernel command line the following:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">/etc/cmdline.d/custom.conf</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-line-numbers="" data-language="bash" data-theme="github-light github-dark" data-line-numbers-max-digits="2"><span data-line=""><span># ...</span></span>
<span data-line=""> </span>
<span data-line=""><span># nvidia gpu</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>nvidia_drm.modeset</span><span>=1</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>nvidia_drm.fbdev</span><span>=1</span></span></code></pre></figure>
<p>In your temporary file system configuration file, replace the Intel module with Nvidia modules:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">/etc/mkinitcpio.conf</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line="" data-highlighted-line="" data-highlighted-line-id="removed"><span>MODULES</span><span>=</span><span>(</span><span>tpm_tis</span><span> i915</span><span>)</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>MODULES</span><span>=</span><span>(</span><span>tpm_tis</span><span> nvidia</span><span> nvidia_modeset</span><span> nvidia_uvm</span><span> nvidia_drm</span><span>)</span></span></code></pre></figure>
<p>Create an update hook that will regenerate the UKI every time Nvidia drivers gets updated:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>nano</span><span> /usr/share/libalpm/hooks/nvidia.hook</span></span></code></pre></figure>
<p>Copy the following into the file:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="ini" data-theme="github-light github-dark">nvidia.hook</figcaption><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark"><span data-line=""><span>[Trigger]</span></span>
<span data-line=""><span>Operation</span><span>=Install</span></span>
<span data-line=""><span>Operation</span><span>=Upgrade</span></span>
<span data-line=""><span>Operation</span><span>=Remove</span></span>
<span data-line=""><span>Type</span><span>=Package</span></span>
<span data-line=""><span>Target</span><span>=nvidia</span></span>
<span data-line=""><span>Target</span><span>=usr/lib/modules/*/vmlinuz</span></span>
<span data-line=""> </span>
<span data-line=""><span>[Action]</span></span>
<span data-line=""><span>Description</span><span>=Update NVIDIA module in initcpio</span></span>
<span data-line=""><span>Depends</span><span>=mkinitcpio</span></span>
<span data-line=""><span>When</span><span>=PostTransaction</span></span>
<span data-line=""><span>NeedsTargets</span></span>
<span data-line=""><span>Exec</span><span>=/bin/sh -c </span><span>&#39;while read -r trg; do case $trg in linux*) exit 0; esac; done; /usr/bin/mkinitcpio -P&#39;</span></span></code></pre></figure>
<p>Regenerate the UKI:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>mkinitcpio</span><span> -P</span></span></code></pre></figure>
</details>
<details>
  <summary>AMD-only</summary>
<p>Install the user-space drivers:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> mesa</span><span> mesa-vdpau</span><span> libva-mesa-driver</span><span> vulkan-radeon</span><span> radeontop</span></span></code></pre></figure>
<p>In your temporary file system configuration file, remove the Intel module:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="bash" data-theme="github-light github-dark">/etc/mkinitcpio.conf</figcaption><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line="" data-highlighted-line="" data-highlighted-line-id="removed"><span>MODULES</span><span>=</span><span>(</span><span>tpm_tis</span><span> i915</span><span>)</span></span>
<span data-line="" data-highlighted-line="" data-highlighted-line-id="added"><span>MODULES</span><span>=</span><span>(</span><span>tpm_tis</span><span>)</span></span></code></pre></figure>
<p>Regenerate the UKI:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>mkinitcpio</span><span> -P</span></span></code></pre></figure>
</details>
<details>
  <summary>Intel + Nvidia laptop</summary>
Install both Intel user-space and Nvidia kernel drivers:
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> mesa</span><span> mesa-demos</span><span> mesa-utils</span><span> vulkan-intel</span><span> vulkan-mesa-layers</span><span> intel-media-driver</span><span> intel-gpu-tools</span><span> nvidia</span><span> nvidia-prime</span><span> nvtop</span></span></code></pre></figure>
<p>To run apps using the dedicated GPU, prepend them with <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>prime-run</span></span></code></span>:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># should run on intel integrated card</span></span>
<span data-line=""><span>glxgears</span></span>
<span data-line=""> </span>
<span data-line=""><span># should run on nvidia dedicated card</span></span>
<span data-line=""><span>prime-run</span><span> glxgears</span></span></code></pre></figure>
</details>
<details>
  <summary>Intel + AMD laptop</summary>
Install both Intel and AMD user-space drivers:
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>yay</span><span> -S</span><span> mesa</span><span> mesa-demos</span><span> mesa-utils</span><span> vulkan-intel</span><span> vulkan-mesa-layers</span><span> intel-media-driver</span><span> intel-gpu-tools</span><span> libva-mesa-driver</span><span> vulkan-radeon</span><span> radeontop</span></span></code></pre></figure>
<p>To run apps using the dedicated GPU, prepend them with <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="github-light github-dark"><span data-line=""><span>DRI_PRIME=1</span></span></code></span>:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span># should run on intel integrated card</span></span>
<span data-line=""><span>glxgears</span></span>
<span data-line=""> </span>
<span data-line=""><span># should run on amd dedicated card</span></span>
<span data-line=""><span>DRI_PRIME</span><span>=</span><span>1</span><span> glxgears</span></span></code></pre></figure>
</details>
<p>In case of issues, refer to the Graphics category in the <a href="https://wiki.archlinux.org/title/Category:Graphics">Arch Wiki</a>.</p>
<h2 id="reboot"><a href="#reboot">Reboot</a></h2>
<p>You can finally reboot and test that everything works well.</p>
<!--

Before rebooting, 

- check that `/etc/cmdline/custom.conf` points to the UUID of the LUKS partition, and that root points to the lvm logical volume
- check that /etc/fstab contains /backup, /home, /efi and /swapfile
- check that /efi/arch.efi has been generated recently and has a valid signature

Once done, 

-->
<p>To reboot, exit from the chroot and unmount all volumes and partitions.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>exit</span></span>
<span data-line=""><span>umount</span><span> /mnt/backup</span></span>
<span data-line=""><span>umount</span><span> /mnt/home</span></span>
<span data-line=""><span>umount</span><span> /mnt/efi</span></span>
<span data-line=""><span>umount</span><span> /mnt</span></span>
<span data-line=""><span>vgchange</span><span> -an</span><span> &#34;os&#34;</span></span>
<span data-line=""><span>cryptsetup</span><span> luksClose</span><span> /dev/mapper/cryptpart</span></span>
<span data-line=""><span>shutdown</span></span></code></pre></figure>
<p>At the next boot, Plymouth will prompt you for your TPM PIN, followed by SDDM prompting you for your user password.</p>
<p>Once logged in, you can check that the setup mode of UEFI Secure Boot has been disabled:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark"><span data-line=""><span>sbctl</span><span> status</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="txt" data-theme="github-light github-dark"><code data-language="txt" data-theme="github-light github-dark"><span data-line=""><span>Installed:      ✓ sbctl is installed</span></span>
<span data-line=""><span>Owner GUID:     ge708dd6-61e4-40ec-b30e-ca119d4467e5</span></span>
<span data-line=""><span>Setup Mode:     ✓ Disabled</span></span>
<span data-line=""><span>Secure Boot:    ✓ Enabled</span></span>
<span data-line=""><span>Vendor Keys:    microsoft</span></span></code></pre></figure>
<p>If it’s still enabled, remember to disable it from your UEFI settings.</p>
<p>Happy Arching!
</p><figure><a href="https://giacomo.coletto.io/images/arch-happy.avif"><img src="https://giacomo.coletto.io/images/arch-happy.avif" alt="Pingu the archer cheering" width="1420" height="1063" loading="lazy"/></a><figcaption>Pingu the archer cheering</figcaption></figure> </article>   <section data-pagefind-ignore=""> <p id="textLikes">
Did you enjoy the article?
</p>  <!-- <p>Subscribe for more</p>--> <div>   <p id="likesUpdater" data-endpoint="https://likes.cf.coletto.io/" data-page="https://giacomo.coletto.io/blog/arch-amd/" data-liked="false"> <svg width="32" height="32" viewBox="0 0 17.1 17.1" data-icon="heart"> <title>heart icon</title> <symbol id="ai:local:heart"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="m8.55 3.194-.154-.164C6.418.933 3.147 1.18 1.469 3.552-.02 5.657.337 8.636 2.275 10.28l6.275 5.323 6.275-5.323c1.938-1.644 2.295-4.623.806-6.728C13.953 1.18 10.682.933 8.704 3.03Z"></path></symbol><use xlink:href="#ai:local:heart"></use>  </svg> </p> <p id="likesClicked"> <svg width="32" height="32" viewBox="0 0 17.1 17.1" data-icon="heart-clicked"> <title>heart icon</title> <symbol id="ai:local:heart-clicked"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="m5.55 7.888 1.8 1.715 4.2-4m-3-2.41-.154-.163C6.418.933 3.147 1.18 1.469 3.552-.02 5.657.337 8.636 2.275 10.28l6.275 5.323 6.275-5.323c1.938-1.644 2.295-4.623.806-6.728C13.953 1.18 10.682.933 8.704 3.03Z"></path></symbol><use xlink:href="#ai:local:heart-clicked"></use>  </svg> </p>   <p id="copyURL" data-url="https://giacomo.coletto.io/blog/arch-amd/"> <svg width="32" height="32" viewBox="0 0 19.5 19.5" data-icon="share"> <title>share icon</title> <use xlink:href="#ai:local:share"></use>  </svg> </p> <!-- 
  <a href=`/tags/${tag}/${tag}.atom`>
    <Icon name="feed" title="feed icon" width={32} height={32} class="fill-black dark:fill-white"/>
  </a>
  --> </div> </section>  <section data-pagefind-ignore="">  <p>Discuss it with others:</p>   </section> <section><h2>
Other posts for you
</h2><section><div data-tags="arch-linux"> <p><a href="https://giacomo.coletto.io/blog/arch-arm/"> <img src="https://giacomo.coletto.io/images/arch-arm.webp" alt="Pingu the archer shooting at a Raspberry Pi" loading="lazy"/> </a></p> </div><div data-tags="arch-linux"> <p><a href="https://giacomo.coletto.io/blog/arch-conf/"> <img src="https://giacomo.coletto.io/images/arch-conf.webp" alt="Feels good man facing a Yakuake terminal window" loading="lazy"/> </a></p> </div></section></section>    </section>  <nav data-astro-cid-obewoz47=""> <a href="#top" data-astro-cid-obewoz47="">Contents</a>  </nav>    </div></div>
  </body>
</html>
