<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.hiler.eu/win32-the-only-stable-abi/">Original</a>
    <h1>Win32 Is the Only Stable ABI on Linux</h1>
    
    <div id="readability-page-1" class="page"><div id="main">
            
                
                
            
            <h2 id="tldr">TL;DR</h2>

<ul>
  <li>Glibc 2.36 was released and all the games using EAC EOS are no longer
playable.</li>
  <li>A user did bisect and found <a href="https://github.com/ValveSoftware/Proton/issues/6051#issuecomment-1206888814">the offending commit</a>.</li>
  <li>I’ve filed <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456">a Glibc bug</a> hoping for a quick revert.</li>
  <li>Turns out other things are also broken.</li>
  <li>Most likely it will stay this way.</li>
  <li>Win32 (via Wine + friends) is the only stable ABI on Linux :-P</li>
</ul>

<h2 id="dthash-and-dtgnuhash">
<code>DT_HASH</code> and <code>DT_GNU_HASH</code>
</h2>

<p>In ELF format there are two ways of providing a hash table of symbols. <code>DT_HASH</code>
and <code>DT_GNU_HASH</code>. The first one is part of <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#hash">SYSV generic ABI</a> and is
well documented and marked as mandatory. DT_GNU_HASH is a newer, smaller, and
faster replacement that is <a href="https://sourceware.org/legacy-ml/binutils/2006-10/msg00377.html">not documented</a>,
implemented in a few places (Glibc, GNU ld, Musl, LLVM, mold, etc.) and a
subject of a <a href="https://flapenguin.me/elf-dt-gnu-hash">couple</a> of <a href="http://deroko.phearless.org/dt_gnu_hash.txt">blog</a> posts that I’ve
<a href="https://blogs.oracle.com/solaris/post/gnu-hash-elf-sections">found</a>. Turns out it also doesn’t provide the same
functionality as <code>DT_HASH</code>. To get the number of symbols you have to <a href="https://groups.google.com/g/generic-abi/c/th5919osPAQ/m/hRL78ooqBAAJ">completely
parse it</a>.</p>

<p>It’s worth noting that unless you are building <code>ELFOSABI_NONE</code> binaries you are
<a href="https://groups.google.com/g/generic-abi/c/th5919osPAQ/m/CWQyAu36AwAJ">not forced to follow the generic ABI.</a> Glibc uses
<code>ELFOSABI_GNU</code> so technically not including <code>DT_HASH</code> is fine.</p>

<p>Glibc was forcing having both sections for a very long time claiming to maintain
compatibility. It was <a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=e47de5cb2d4dbecb58f569ed241e8e95c568f03c">recently dropped</a> and the build instead
relies on “the defaults”.</p>

<h2 id="the-regressions">The Regression(s)</h2>

<p>This problem was first noticed by rolling-release distros users when <a href="https://github.com/ValveSoftware/Proton/issues/6051">games
using EAC EOS stopped working</a>. There’s also an open
source project that has regressed - a frame rate limiter called
<a href="https://bugs.gentoo.org/863863">libstrangle</a>. The non-EAC game <a href="https://github.com/ValveSoftware/Proton/issues/6051#issuecomment-1212748397">Shovel Knight is broken
as well</a>.</p>

<p>Those are only a few breakages users of the more bleeding-edge distros found
shortly after the Glibc 2.36 release. I suspect there will be more broken games
(and other software) once 2.36 will hit the mainstream.</p>

<h2 id="to-abi-or-not-to-abi">To ABI Or Not To ABI</h2>

<ul>
  <li><a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456#c11"><code>DT_HASH</code> is not part of the ABI.</a></li>
  <li><a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456#c7">It’s not an ABI break - the lookup information is still there, just in a
different format.</a></li>
  <li><a href="https://sourceware.org/pipermail/libc-alpha/2022-August/141304.html">Having DT_HASH is up to distributions.</a></li>
  <li><a href="https://sourceware.org/bugzilla/show_bug.cgi?id=29456#c9">It saves 16kB (&lt; 1% of total size).</a></li>
  <li><a href="https://groups.google.com/g/generic-abi/c/th5919osPAQ/m/CaZd-bT1AwAJ"><code>DT_HASH</code> should not be mandatory in gABI.</a></li>
</ul>

<p>I suggest you read through all the linked discussions and develop your own
opinion on who is responsible for what exactly.</p>

<p>Personally I share <a href="https://youtu.be/5PmHRSeA2c8?t=509">Linus’ opinion</a> that changing ABI is okay as
long as no one has noticed, but once it gets noticed - then it’s a regression.
Once it’s a
thing people depend on, it becomes a feature.</p>

<p>Sadly not everything can be easily modified to accommodate or recompiled.</p>

<p>Shifting the problem downstream onto the distributions is also problematic and
<a href="https://gitlab.com/torkel104/libstrangle/-/issues/59">adds to fragmentation.</a></p>

<p>I know that <a href="https://sourceware.org/pipermail/libc-alpha/2022-August/141304.html"><code>DT_GNU_HASH</code> is a thing for 16 years already</a>
and most distributions have switched to using it and only it by default. For
those 16 years, it was Glibc who provided the compatibility and overrode the
defaults for everyone and there never were any easy-to-spot deprecation
warnings. It’s also unrealistic to expect every ELF consumer to keep up with
undocumented developments of the format.</p>

<h2 id="why---hash-stylegnu-is-the-default">Why <code>--hash-style=gnu</code> is The Default?</h2>

<p>Kinda by accident? GCC’s default behavior is to allow linkers to do whatever
they want. The GNU Linker defaults to “both”</p>

<pre><code>ld --help | grep hash-style
  --hash-style=STYLE          Set hash style to sysv/gnu/both.  Default: both
</code></pre>

<p>while <a href="https://github.com/rui314/mold/blob/415673a49e24b1f4189000b9eb4fb1a36a697093/elf/mold.h#L1475">mold defaults to “sysv”</a>. So why most things are built
with <code>--hash-style=gnu</code>? On a lot of distributions <code>gcc -v</code> claims that</p>

<pre><code>Configured with: /build/gcc/src/gcc/configure ... --with-linker-hash-style=gnu ...
</code></pre>

<p>which seems to be a leftover from the days long gone where <code>DT_GNU_HASH</code> was so
young that <code>ld</code>’s default was still <code>sysv</code>. Distributions wanted to have the
promised speedup so they have just forced this and it stuck.</p>

<p>This seems to spread further - clang does distro detection and <a href="https://github.com/llvm/llvm-project/blob/b405407/clang/lib/Driver/ToolChains/Linux.cpp#L241-L244">seems to be
mimicking</a> whatever the distro is doing with their default <code>gcc</code>.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>I think this whole situation shows why creating native games for Linux is
challenging. It’s hard to blame developers for targeting Windows and relying on
Wine + friends. It’s just much more stable and much less likely to break and
stay broken.</p>

        </div></div>
  </body>
</html>
