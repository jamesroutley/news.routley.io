<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jeffgeerling.com/blog/2023/nvme-ssd-boot-raspberry-pi-5">Original</a>
    <h1>NVMe SSD boot with the Raspberry Pi 5</h1>
    
    <div id="readability-page-1" class="page"><div><p><img src="https://www.jeffgeerling.com/sites/default/files/images/pi-5-pcie-nvme.jpg" width="700" height="408" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-d332d0ab-364c-4bab-8986-b1e1b413ef43" data-insert-attach="{&#34;id&#34;:&#34;d332d0ab-364c-4bab-8986-b1e1b413ef43&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="Pi 5 PCIe NVMe Kioxia XG8 SSD"/></p>

<p>In my <a href="https://www.youtube.com/watch?v=nBtOEmUqASQ">video about the brand new Raspberry Pi 5</a>, I mentioned the new external PCIe port makes it possible to boot the standard Pi 5 model B directly off NVMe storage—an option which is <em>much</em> faster and more reliable than standard microSD storage (even with industrial-rated cards!).</p>

<p>Enabling NVMe boot is pretty easy, you add a line to <code>/boot/config.txt</code>, <a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#BOOT_ORDER">modify the <code>BOOT_ORDER</code></a> in the bootloader configuration, and reboot!</p>

<p>Of course, you&#39;ll also need to get Pi OS onto the NVMe, and there are a few ways to do that—I&#39;ll walk you through my favorite method below.</p>

<blockquote>
  <p>Note: Raspberry Pi announced they are developing an official <a href="https://pipci.jeffgeerling.com/hats/pi-nvme-hat.html">Raspberry Pi M.2 HAT</a>, but there is no word on a launch date for it yet. I am also tracking other <a href="https://pipci.jeffgeerling.com/hats">PCIe HATs for Raspberry Pi 5 here</a>.</p>
</blockquote>

<h2>Enable the external PCI Express port</h2>

<p>First, enable the external PCIe port on the Raspberry Pi 5. Edit <code>/boot/config.txt</code> and add the following at the bottom:</p>

<pre><code># Add to bottom of /boot/config.txt
dtparam=pciex1

# Note: You could also just add the following (it is an alias to the above line)
# dtparam=nvme

# Optionally, you can control the PCIe lane speed using this parameter
# dtparam=pciex1_gen=3
</code></pre>

<p>I have the <code>pciex1_gen=3</code> part commented out above because Raspberry Pi <em>allows</em> you to tweak the bus speed (you can choose Gen 1 for 2.5 GS/s, Gen 2 for 5 GS/s, and Gen 3 for 8 GS/s), but the port is only rated for up to PCIe Gen 2 speeds.</p>

<p>In practice, I have been able to run multiple NVMe SSDs at Gen 3.0 speed (getting up to 900 MB/sec) on my alpha Pi 5, but YMMV—PCIe can be very fickle, depending on the quality of the FFC cable and connections on your own setup.</p>

<h2>Set NVMe early in the boot order</h2>

<p>The PCIe connection should work after a reboot, but your Pi won&#39;t try booting off an NVMe SSD yet. For that, you need to change the <code>BOOT_ORDER</code> in the Raspberry Pi&#39;s bootloader configuration:</p>

<pre><code># Edit the EEPROM on the Raspberry Pi 5.
sudo rpi-eeprom-config --edit pieeprom.bin

# Change the BOOT_ORDER line to the following:
BOOT_ORDER=0xf416

# Press Ctrl-O, then enter, to write the change to the file.
# Press Ctrl-X to exit nano (the editor).
</code></pre>

<p>Read <a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#BOOT_ORDER">Raspberry Pi&#39;s documentation on BOOT_ORDER</a> for all the details. For now, the pertinent bit is the <code>6</code> at the end: that is what tells the Pi to attempt NVMe boot first!</p>

<p>Reboot your Raspberry Pi 5 to make the change take effect.</p>

<p>NVMe boot won&#39;t work unless you have the external PCI Express port enabled, <em>and</em> there&#39;s a working NVMe drive with a valid boot partition! If you don&#39;t have that (e.g. you used Raspberry Pi Imager with an external USB NVMe adapter to flash Pi OS to an NVMe drive from another computer), then follow the steps in the next section to clone your existing Pi OS install to an NVMe SSD.</p>

<h2>Clone your microSD boot volume to an NVMe SSD</h2>

<p>Assuming you already have Raspberry Pi OS on a microSD card that is booting your Raspberry Pi 5 internally, and the NVMe SSD is connected and visible (check if you see a device <code>/dev/nvme0n1</code> after running <code>lsblk</code>), you can use <a href="https://github.com/billw2/rpi-clone"><code>rpi-clone</code></a> to clone the internal microSD boot volumes to your NVMe SSD:</p>

<pre><code># Install rpi-clone.
git clone -b 123-nvme https://github.com/geerlingguy/rpi-clone.git
cd rpi-clone
sudo cp rpi-clone rpi-clone-setup /usr/local/sbin

# Clone to the NVMe drive (usually nvme0n1, but check with `lsblk`).
sudo rpi-clone nvme0n1
</code></pre>

<blockquote>
  <p>Note: I&#39;m using my fork of <code>rpi-clone</code>, because the official version has not merged <a href="https://github.com/billw2/rpi-clone/pull/147">NVMe support</a> yet.</p>
</blockquote>

<h2>NVMe behind a PCIe bridge / switch</h2>

<p>Currently the Raspberry Pi 5 only exposes one PCIe lane externally—though there are four more lanes taken up by the RP1 chip. Typical PC motherboards have a number of lanes to play with, so you often find two, three, or even <em>four</em> M.2 NVMe slots on high-end motherboards.</p>

<p>Even there, some motherboards have PCI Express switches (or &#39;bridges&#39;) which allow multiple PCIe devices to share the same lane or lanes, in a similar way an Ethernet switch can allow multiple computers to share a single network connection.</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/nvme-boot-behind-pcie-switch-raspberry-pi-.jpeg" width="700" height="394" data-insert-type="image" data-entity-type="file" data-entity-uuid="insert-image-1b1c79c8-92fe-47d6-b8cd-d019a482c7d6" data-insert-attach="{&#34;id&#34;:&#34;1b1c79c8-92fe-47d6-b8cd-d019a482c7d6&#34;,&#34;attributes&#34;:{&#34;alt&#34;:[&#34;alt&#34;,&#34;description&#34;],&#34;title&#34;:[&#34;title&#34;]}}" alt="NVMe boot behind PCIe switch on Raspberry Pi"/></p>

<p>On the Compute Module 4, <a href="https://github.com/raspberrypi/firmware/issues/1684">bootloader space constraints prevented NVMe boot if you used a switch</a>, but I wonder if that restriction is lifted on the Raspberry Pi 5—and if so, is it already implemented?</p>

<p>As of now, no. I can <em>see</em> and <em>use</em> an NVMe SSD through a PCIe switch, but I am not able to <em>boot</em> the Raspberry Pi 5 from it, unless it is directly connected (as the lone PCIe device on the bus).</p>

<p>I&#39;ve opened an issue to ask about this feature in the Raspberry Pi firmware repo: <a href="https://github.com/raspberrypi/firmware/issues/1833">Can&#39;t boot Pi 5 via NVMe behind PCIe switch / bridge</a>.</p></div></div>
  </body>
</html>
