<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://devnonsense.com/posts/tcp-connection-timeout-mystery/">Original</a>
    <h1>TCP connection timeout mystery</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><p>For over a year, I’ve been investigating a strange issue with the internet in my apartment.
I’m posting the details here in case someone more knowledgeable than me can solve the mystery.</p><p>I live in graduate student housing with internet provided by the university campus.
Usually things work reasonably well, with one exception. On the wired network, I cannot connect
to IP addresses used by Bunny CDN.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></p><p><img src="https://devnonsense.com/img/bunny-cdn-curl-timeout.png" alt="Screenshot of curl to fonts.bunny.net failing with “SSL connection timeout”"/></p><p>Many websites use Bunny CDN to serve static assets.
The connection timeouts break these sites. Some fail to load images, some load after a 60 second timeout,
and some cannot load at all. I’ve seen consistent failures on all of the following sites:</p><ul><li><a href="https://plausible.io">plausible.io</a> is served from Bunny CDN.</li><li><a href="https://dunnedwards.com">dunnedwards.com</a> uses <a href="https://h6a8m2f3.rocketcdn.me/">h6a8m2f3.rocketcdn.me</a> backed by Bunny CDN.</li><li><a href="https://www.ravelry.com">ravelry.com</a> loads stylesheets from <a href="https://style-cdn.ravelrycache.com">style-cdn.ravelrycache.com</a> and analytics scripts from plausible.io, both backed by Bunny CDN.</li><li><a href="https://fosstodon.org">fosstodon.org</a> previously used Bunny CDN for images (but now uses Fastly).</li><li><a href="https://en-americas-support.nintendo.com/">Nintendo’s US support site</a> loads a stylesheet from <a href="https://cdn.icomoon.io">cdn.icomoon.io</a> backed by Bunny CDN.</li><li><a href="https://bunny.net">The Bunny CDN website itself</a> loads fonts from… Bunny CDN!</li></ul><p>This issue occurs <em>only</em> on the campus network, and only when connected to the wired network (the university also provides wireless eduroam and guest networks, which work correctly). It happens on every device and operating system I’ve tested (laptop/phone/desktop and Linux/Windows/macOS/iOS). It happens whether connecting through a NetGear WiFi router or connecting my computer directly to the campus network via Ethernet. It happens using both HTTP and HTTPS (but ping works fine).</p><p>It happens consistently, <em>every time</em> I test it. Packet captures of the timeouts always show the exact same behavior:</p><p><img src="https://devnonsense.com/img/bunny-cdn-timeout-packet-capture.png" alt="Screenshot of packet capture for TCP connection timeout"/></p><ol><li><strong>Packet #1</strong>: Client (136.152.38.228) sends SYN to server (169.150.221.147).</li><li><strong>Packet #2</strong>: Server responds with SYN+ACK.</li><li><strong>Packet #3</strong>: Client responds with ACK to complete the TCP 3-way handshake.</li><li><strong>Packet #8</strong>: Server resends SYN+ACK, indicating that it never received the client ACK.</li><li>Client and server repeatedly resend ACK and SYN+ACK.</li><li><strong>Packet #17</strong>: Client times out and terminates the connection with FIN+ACK.</li></ol><p>This looks to me like the client ACK never reaches the server.</p><p>My best guess is that maybe asymmetric routing causes the campus firewall to drop packets:</p><ol><li>Client SYN goes through the firewall.</li><li>Server SYN+ACK routed back to the client, incorrectly bypassing the firewall.</li><li>Client ACK goes to the firewall and gets dropped because the firewall never received the server SYN+ACK.</li></ol><p>However, I don’t know what routing misconfiguration could cause this or why it
affects only IP addresses from Bunny CDN.</p><p>I spent over a week trying to escalate this problem through <a href="https://studenttech.berkeley.edu/">Berkeley Student Tech Services</a>.
After I explained the problem to three different teams, someone from the Network Operations and Services team closed
the ticket, telling me:</p><blockquote><p>Since it is happening with only certain websites, you should ensure that there is not a static DNS entry in the wired connection of your device that is in conflict with our DNS service. We are not seeing any indication that this is an issue with our network at this point in time…
This is all functioning as it was designed to per the Principal Wifi Engineer for the campus.</p></blockquote><p>As you might imagine, I found this response unconvincing.<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></p><p>I’m still very curious what could cause an issue like this. Why are the client ACK packets to those specific IP addresses being dropped?
Is there something special about Bunny CDN that could interact badly with the campus network configuration?</p><p><strong>Do you know the answer (or have an informed guess)?</strong> If so, please <a href="https://devnonsense.com/contact">email me</a>!</p></div></div>
  </body>
</html>
