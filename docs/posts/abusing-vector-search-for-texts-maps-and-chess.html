<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ashvardanian.com/posts/abusing-vector-search/">Original</a>
    <h1>Abusing Vector Search for Texts, Maps, and Chess</h1>
    
    <div id="readability-page-1" class="page"><div><p>Vector Search is hot!
Everyone is pouring resources into a seemingly new and AI-related topic.
But are there any non-AI-related use cases?
Are there features you want from your vector search engine, but are too afraid to ask?</p><blockquote><p lang="en" dir="ltr">Last week was üî• for vector search. Weaviate raised $50M, and Pinecone raised $100M... That&#39;s a lot and makes you believe that vector search is hard. But it&#39;s not. I have spent the last few days implementing a single-file vector search engine... üßµ 1/7 <a href="https://t.co/NBvKufNYTz">https://t.co/NBvKufNYTz</a></p>‚Äî Ashot Vardanian (@ashvardanian) <a href="https://twitter.com/ashvardanian/status/1653528562648125440?ref_src=twsrc%5Etfw">May 2, 2023</a></blockquote><p>A few days ago, I built a new Vector Search engine - <a href="https://github.com/unum-cloud/usearch">USearch</a>.
Entirely open-source, Apache 2.0, free for commercial use.
It implements HNSW - ‚ÄúHierarchical Navigable Small World‚Äù graphs, the most commonly used data-structure for Vector Search.</p><ul><li>It‚Äôs short - just 1000 lines of C++11.</li><li>It‚Äôs fast - assuming high memory-locality and SIMD tricks.</li><li>It‚Äôs compatible with Python, JavaScript, Java, Rust, <del>GoLang</del>, and Wolfram.</li></ul><p>Most importantly, USearch supports non-equidimensional vectors and custom similarity measures!
It‚Äôs a general-purpose data structure, limited only by your imagination and applicable to more than AI.
Let‚Äôs highlight some weird use cases and under-the-radar features.</p><h2 id="geo-spatial-indexing">Geo-Spatial Indexing</h2><p>When working with geospatial data, the most common representation is a combination of latitude and longitude.
One would use the Haversine distance to compute the distance between two points on a sphere.
USearch natively supports it.
So without further to do, I took a CSV with geo-locations of 140 thousand towns and districts from Kaggle and tried to find all the closest cities.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-0-1"><a href="#hl-0-1"> 1</a>
</span><span id="hl-0-2"><a href="#hl-0-2"> 2</a>
</span><span id="hl-0-3"><a href="#hl-0-3"> 3</a>
</span><span id="hl-0-4"><a href="#hl-0-4"> 4</a>
</span><span id="hl-0-5"><a href="#hl-0-5"> 5</a>
</span><span id="hl-0-6"><a href="#hl-0-6"> 6</a>
</span><span id="hl-0-7"><a href="#hl-0-7"> 7</a>
</span><span id="hl-0-8"><a href="#hl-0-8"> 8</a>
</span><span id="hl-0-9"><a href="#hl-0-9"> 9</a>
</span><span id="hl-0-10"><a href="#hl-0-10">10</a>
</span><span id="hl-0-11"><a href="#hl-0-11">11</a>
</span><span id="hl-0-12"><a href="#hl-0-12">12</a>
</span><span id="hl-0-13"><a href="#hl-0-13">13</a>
</span><span id="hl-0-14"><a href="#hl-0-14">14</a>
</span><span id="hl-0-15"><a href="#hl-0-15">15</a>
</span><span id="hl-0-16"><a href="#hl-0-16">16</a>
</span><span id="hl-0-17"><a href="#hl-0-17">17</a>
</span><span id="hl-0-18"><a href="#hl-0-18">18</a>
</span><span id="hl-0-19"><a href="#hl-0-19">19</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>usearch</span> <span>import</span> <span>Index</span>
</span></span><span><span>
</span></span><span><span><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
</span></span><span><span><span>import</span> <span>numpy</span> <span>as</span> <span>np</span>
</span></span><span><span><span>import</span> <span>geocoder</span>
</span></span><span><span>
</span></span><span><span><span>my_coordinates</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>(</span><span>geocoder</span><span>.</span><span>ip</span><span>(</span><span>&#39;me&#39;</span><span>)</span><span>.</span><span>latlng</span><span>,</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>df</span> <span>=</span> <span>pd</span><span>.</span><span>read_csv</span><span>(</span><span>&#39;cities.csv&#39;</span><span>)</span>
</span></span><span><span><span>coordinates</span> <span>=</span> <span>np</span><span>.</span><span>zeros</span><span>((</span><span>df</span><span>.</span><span>shape</span><span>[</span><span>0</span><span>],</span> <span>2</span><span>),</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span><span>coordinates</span><span>[:,</span> <span>0</span><span>]</span> <span>=</span> <span>df</span><span>[</span><span>&#39;latitude&#39;</span><span>]</span><span>.</span><span>to_numpy</span><span>(</span><span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span><span>coordinates</span><span>[:,</span> <span>1</span><span>]</span> <span>=</span> <span>df</span><span>[</span><span>&#39;longitude&#39;</span><span>]</span><span>.</span><span>to_numpy</span><span>(</span><span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span><span>labels</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>(</span><span>range</span><span>(</span><span>df</span><span>.</span><span>shape</span><span>[</span><span>0</span><span>]),</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>longlong</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>index</span> <span>=</span> <span>Index</span><span>(</span><span>metric</span><span>=</span><span>&#39;haversine&#39;</span><span>)</span>
</span></span><span><span><span>index</span><span>.</span><span>add</span><span>(</span><span>labels</span><span>,</span> <span>coordinates</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>matches</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index</span><span>.</span><span>search</span><span>(</span><span>my_coordinates</span><span>,</span> <span>10</span><span>)</span>
</span></span><span><span><span>print</span><span>(</span><span>df</span><span>.</span><span>iloc</span><span>[</span><span>matches</span><span>])</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Sitting in a cafe in San Francisco, I received this.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-1-1"><a href="#hl-1-1"> 1</a>
</span><span id="hl-1-2"><a href="#hl-1-2"> 2</a>
</span><span id="hl-1-3"><a href="#hl-1-3"> 3</a>
</span><span id="hl-1-4"><a href="#hl-1-4"> 4</a>
</span><span id="hl-1-5"><a href="#hl-1-5"> 5</a>
</span><span id="hl-1-6"><a href="#hl-1-6"> 6</a>
</span><span id="hl-1-7"><a href="#hl-1-7"> 7</a>
</span><span id="hl-1-8"><a href="#hl-1-8"> 8</a>
</span><span id="hl-1-9"><a href="#hl-1-9"> 9</a>
</span><span id="hl-1-10"><a href="#hl-1-10">10</a>
</span><span id="hl-1-11"><a href="#hl-1-11">11</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="txt"><span><span>            id                              name  state_id state_code  state_name  country_id country_code   country_name  latitude  longitude wikiDataId
</span></span><span><span>128666  125809                     San Francisco      1416         CA  California         233           US  United States  37.77493 -122.41942        Q62
</span></span><span><span>128430  121985                  Mission District      1416         CA  California         233           US  United States  37.75993 -122.41914      Q7469
</span></span><span><span>127999  114046  City and County of San Francisco      1416         CA  California         233           US  United States  37.77823 -122.44250  Q13188841
</span></span><span><span>127991  113964                         Chinatown      1416         CA  California         233           US  United States  37.79660 -122.40858   Q2720635
</span></span><span><span>128483  122925                        Noe Valley      1416         CA  California         233           US  United States  37.75018 -122.43369   Q3342640
</span></span><span><span>128864  128294                 Visitacion Valley      1416         CA  California         233           US  United States  37.71715 -122.40433    Q495373
</span></span><span><span>128049  115006                         Daly City      1416         CA  California         233           US  United States  37.70577 -122.46192    Q370925
</span></span><span><span>127926  112800                          Brisbane      1416         CA  California         233           US  United States  37.68077 -122.39997    Q917671
</span></span><span><span>128712  125970                         Sausalito      1416         CA  California         233           US  United States  37.85909 -122.48525    Q828729
</span></span><span><span>127927  112825                         Broadmoor      1416         CA  California         233           US  United States  37.68660 -122.48275   Q2944590
</span></span></code></pre></td></tr></tbody></table></div></div><blockquote><p><a href="https://www.kaggle.com/datasets/liewyousheng/geolocation">Dataset</a>.
<a href="https://github.com/ashvardanian/abusing-vector-search/blob/main/gis.py">Source</a>.</p></blockquote><h2 id="stonks">Sto(n)ks</h2><p>We got lucky.
We were working with GIS data, and USearch has the Haversine metric bundled.
What if your metric of choice isn‚Äôt present?
Let‚Äôs imagine you are analyzing the stock market or the price change of a particular asset.
The first thing to do is to investigate which other assets follow the same trend.
In other words, which assets are covariant?
Covariance isn‚Äôt included.</p><p><img loading="lazy" src="https://ashvardanian.com/abusing-vector-search/covariance.png#center" alt="Covariance Formula for USearch"/></p><p>But once you check the formula, you realize it resembles the ‚ÄúInner Product‚Äù metric.
If you have used FAISS, you know it doesn‚Äôt ship the angular distance, as it expects you to normalize vectors.
Same here.
We can pre-process the vectors, subtracting the <code>np.mean</code>, before passing to <code>usearch.Index</code>, and things will work.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-2-1"><a href="#hl-2-1"> 1</a>
</span><span id="hl-2-2"><a href="#hl-2-2"> 2</a>
</span><span id="hl-2-3"><a href="#hl-2-3"> 3</a>
</span><span id="hl-2-4"><a href="#hl-2-4"> 4</a>
</span><span id="hl-2-5"><a href="#hl-2-5"> 5</a>
</span><span id="hl-2-6"><a href="#hl-2-6"> 6</a>
</span><span id="hl-2-7"><a href="#hl-2-7"> 7</a>
</span><span id="hl-2-8"><a href="#hl-2-8"> 8</a>
</span><span id="hl-2-9"><a href="#hl-2-9"> 9</a>
</span><span id="hl-2-10"><a href="#hl-2-10">10</a>
</span><span id="hl-2-11"><a href="#hl-2-11">11</a>
</span><span id="hl-2-12"><a href="#hl-2-12">12</a>
</span><span id="hl-2-13"><a href="#hl-2-13">13</a>
</span><span id="hl-2-14"><a href="#hl-2-14">14</a>
</span><span id="hl-2-15"><a href="#hl-2-15">15</a>
</span><span id="hl-2-16"><a href="#hl-2-16">16</a>
</span><span id="hl-2-17"><a href="#hl-2-17">17</a>
</span><span id="hl-2-18"><a href="#hl-2-18">18</a>
</span><span id="hl-2-19"><a href="#hl-2-19">19</a>
</span><span id="hl-2-20"><a href="#hl-2-20">20</a>
</span><span id="hl-2-21"><a href="#hl-2-21">21</a>
</span><span id="hl-2-22"><a href="#hl-2-22">22</a>
</span><span id="hl-2-23"><a href="#hl-2-23">23</a>
</span><span id="hl-2-24"><a href="#hl-2-24">24</a>
</span><span id="hl-2-25"><a href="#hl-2-25">25</a>
</span><span id="hl-2-26"><a href="#hl-2-26">26</a>
</span><span id="hl-2-27"><a href="#hl-2-27">27</a>
</span><span id="hl-2-28"><a href="#hl-2-28">28</a>
</span><span id="hl-2-29"><a href="#hl-2-29">29</a>
</span><span id="hl-2-30"><a href="#hl-2-30">30</a>
</span><span id="hl-2-31"><a href="#hl-2-31">31</a>
</span><span id="hl-2-32"><a href="#hl-2-32">32</a>
</span><span id="hl-2-33"><a href="#hl-2-33">33</a>
</span><span id="hl-2-34"><a href="#hl-2-34">34</a>
</span><span id="hl-2-35"><a href="#hl-2-35">35</a>
</span><span id="hl-2-36"><a href="#hl-2-36">36</a>
</span><span id="hl-2-37"><a href="#hl-2-37">37</a>
</span><span id="hl-2-38"><a href="#hl-2-38">38</a>
</span><span id="hl-2-39"><a href="#hl-2-39">39</a>
</span><span id="hl-2-40"><a href="#hl-2-40">40</a>
</span><span id="hl-2-41"><a href="#hl-2-41">41</a>
</span><span id="hl-2-42"><a href="#hl-2-42">42</a>
</span><span id="hl-2-43"><a href="#hl-2-43">43</a>
</span><span id="hl-2-44"><a href="#hl-2-44">44</a>
</span><span id="hl-2-45"><a href="#hl-2-45">45</a>
</span><span id="hl-2-46"><a href="#hl-2-46">46</a>
</span><span id="hl-2-47"><a href="#hl-2-47">47</a>
</span><span id="hl-2-48"><a href="#hl-2-48">48</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>import</span> <span>os</span>
</span></span><span><span><span>import</span> <span>time</span>
</span></span><span><span><span>from</span> <span>statistics</span> <span>import</span> <span>covariance</span>
</span></span><span><span>
</span></span><span><span><span>from</span> <span>usearch</span> <span>import</span> <span>Index</span>
</span></span><span><span><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
</span></span><span><span><span>import</span> <span>numpy</span> <span>as</span> <span>np</span>
</span></span><span><span>
</span></span><span><span><span>directory</span><span>:</span> <span>str</span> <span>=</span> <span>&#39;stocks&#39;</span>
</span></span><span><span><span>last_days</span><span>:</span> <span>int</span> <span>=</span> <span>30</span>
</span></span><span><span><span>tickets</span><span>:</span> <span>list</span><span>[</span><span>str</span><span>]</span> <span>=</span> <span>[]</span>
</span></span><span><span><span>ticket_to_prices</span><span>:</span> <span>dict</span><span>[</span><span>str</span><span>,</span> <span>np</span><span>.</span><span>array</span><span>]</span> <span>=</span> <span>{}</span>
</span></span><span><span><span>index</span> <span>=</span> <span>Index</span><span>(</span><span>ndim</span><span>=</span><span>last_days</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>for</span> <span>filename</span> <span>in</span> <span>os</span><span>.</span><span>listdir</span><span>(</span><span>directory</span><span>):</span>
</span></span><span><span>    <span>path</span> <span>=</span> <span>os</span><span>.</span><span>path</span><span>.</span><span>join</span><span>(</span><span>directory</span><span>,</span> <span>filename</span><span>)</span>
</span></span><span><span>    <span>ticket</span> <span>=</span> <span>filename</span><span>.</span><span>split</span><span>(</span><span>&#39;.&#39;</span><span>)[</span><span>0</span><span>]</span>
</span></span><span><span>    <span>df</span> <span>=</span> <span>pd</span><span>.</span><span>read_csv</span><span>(</span><span>path</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>prices_list</span> <span>=</span> <span>df</span><span>[</span><span>&#39;Close&#39;</span><span>][</span><span>-</span><span>last_days</span><span>:]</span><span>.</span><span>to_list</span><span>()</span>
</span></span><span><span>    <span>prices</span> <span>=</span> <span>np</span><span>.</span><span>zeros</span><span>(</span><span>last_days</span><span>,</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span>    <span>prices</span><span>[</span><span>-</span><span>len</span><span>(</span><span>prices_list</span><span>):]</span> <span>=</span> <span>prices_list</span>
</span></span><span><span>
</span></span><span><span>    <span>tickets</span><span>.</span><span>append</span><span>(</span><span>ticket</span><span>)</span>
</span></span><span><span>    <span>index</span><span>.</span><span>add</span><span>(</span><span>len</span><span>(</span><span>index</span><span>),</span> <span>prices</span> <span>-</span> <span>np</span><span>.</span><span>mean</span><span>(</span><span>prices</span><span>))</span>
</span></span><span><span>    <span>ticket_to_prices</span><span>[</span><span>ticket</span><span>]</span> <span>=</span> <span>prices</span>
</span></span><span><span>
</span></span><span><span><span>selected_ticker</span> <span>=</span> <span>&#39;AAPL&#39;</span>
</span></span><span><span>
</span></span><span><span><span>tic</span> <span>=</span> <span>time</span><span>.</span><span>perf_counter</span><span>()</span>
</span></span><span><span><span>selected_prices</span> <span>=</span> <span>ticket_to_prices</span><span>[</span><span>selected_ticker</span><span>]</span>
</span></span><span><span><span>approx_matches</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index</span><span>.</span><span>search</span><span>(</span>
</span></span><span><span>    <span>selected_prices</span> <span>-</span> <span>np</span><span>.</span><span>mean</span><span>(</span><span>selected_prices</span><span>),</span> <span>10</span><span>)</span>
</span></span><span><span><span>approx_tickets</span> <span>=</span> <span>[</span><span>tickets</span><span>[</span><span>match</span><span>]</span> <span>for</span> <span>match</span> <span>in</span> <span>approx_matches</span><span>]</span>
</span></span><span><span><span>toc</span> <span>=</span> <span>time</span><span>.</span><span>perf_counter</span><span>()</span>
</span></span><span><span><span>print</span><span>(</span><span>&#39;Approximate matches:&#39;</span><span>,</span> <span>&#39;,&#39;</span><span>.</span><span>join</span><span>(</span><span>approx_tickets</span><span>))</span>
</span></span><span><span><span>print</span><span>(</span><span>f</span><span>&#39;- Measurement took </span><span>{</span><span>toc</span> <span>-</span> <span>tic</span><span>:</span><span>0.4f</span><span>}</span><span> seconds&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>tic</span> <span>=</span> <span>time</span><span>.</span><span>perf_counter</span><span>()</span>
</span></span><span><span><span>covariances</span> <span>=</span> <span>[</span>
</span></span><span><span>    <span>(</span><span>ticket</span><span>,</span> <span>covariance</span><span>(</span><span>selected_prices</span><span>,</span> <span>prices</span><span>))</span>
</span></span><span><span>    <span>for</span> <span>ticket</span><span>,</span> <span>prices</span> <span>in</span> <span>ticket_to_prices</span><span>.</span><span>items</span><span>()]</span>
</span></span><span><span><span>covariances</span> <span>=</span> <span>sorted</span><span>(</span><span>covariances</span><span>,</span> <span>key</span><span>=</span><span>lambda</span> <span>x</span><span>:</span> <span>x</span><span>[</span><span>1</span><span>],</span> <span>reverse</span><span>=</span><span>True</span><span>)</span>
</span></span><span><span><span>exact_tickets</span> <span>=</span> <span>[</span><span>ticket</span> <span>for</span> <span>ticket</span><span>,</span> <span>_</span> <span>in</span> <span>covariances</span><span>[:</span><span>10</span><span>]]</span>
</span></span><span><span><span>toc</span> <span>=</span> <span>time</span><span>.</span><span>perf_counter</span><span>()</span>
</span></span><span><span><span>print</span><span>(</span><span>&#39;Exact matches:&#39;</span><span>,</span> <span>&#39;,&#39;</span><span>.</span><span>join</span><span>(</span><span>exact_tickets</span><span>))</span>
</span></span><span><span><span>print</span><span>(</span><span>f</span><span>&#39;- Measurement took </span><span>{</span><span>toc</span> <span>-</span> <span>tic</span><span>:</span><span>0.4f</span><span>}</span><span> seconds&#39;</span><span>)</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Running the script, we get a 2&#39;000x performance improvement over the naive Python approach for a small collection of 5&#39;884 entries covering a month of closing prices.
The benefits would be more significant with more extensive collections and longer ranges.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-3-1"><a href="#hl-3-1">1</a>
</span><span id="hl-3-2"><a href="#hl-3-2">2</a>
</span><span id="hl-3-3"><a href="#hl-3-3">3</a>
</span><span id="hl-3-4"><a href="#hl-3-4">4</a>
</span><span id="hl-3-5"><a href="#hl-3-5">5</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="txt"><span><span>Approximate matches: ELC, NVR, SEB, BKNG, MKL, TPL, CABO, TSLA, GOOGL, GOOG
</span></span><span><span>- Measurement took 0.0001 seconds
</span></span><span><span>
</span></span><span><span>Exact matches: ELC, NVR, MKL, TPL, CABO, AZO, BA, ISRG, FLGE, AMZN
</span></span><span><span>- Measurement took 0.2396 seconds
</span></span></code></pre></td></tr></tbody></table></div></div><blockquote><p><a href="https://www.kaggle.com/datasets/jacksoncrow/stock-market-dataset">Dataset</a>.
<a href="https://github.com/ashvardanian/abusing-vector-search/blob/main/stocks.py">Source</a>.</p></blockquote><h2 id="chess">Chess?!</h2><p>Imagine having to search through a database of chess positions.
There are specialized methods, often based on Zobrist hashing.
But there is also a more straightforward way.
A chess board can be easily encoded with 64 bytes, where each byte encodes a particular piece.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-4-1"><a href="#hl-4-1">1</a>
</span><span id="hl-4-2"><a href="#hl-4-2">2</a>
</span><span id="hl-4-3"><a href="#hl-4-3">3</a>
</span><span id="hl-4-4"><a href="#hl-4-4">4</a>
</span><span id="hl-4-5"><a href="#hl-4-5">5</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="cpp"><span><span><span>enum</span> <span>piece_t</span> <span>{</span>
</span></span><span><span>    <span>w_king_k</span><span>,</span> <span>w_queen_k</span><span>,</span> <span>b_king_k</span><span>,</span> <span>b_queen_k</span><span>,</span>
</span></span><span><span>    <span>w_pawn_k</span><span>,</span> <span>w_rook_k</span><span>,</span> <span>b_pawn_k</span><span>,</span> <span>b_rook_k</span><span>,</span>
</span></span><span><span>    <span>w_bishop_k</span><span>,</span> <span>w_knight_k</span><span>,</span> <span>b_bishop_k</span><span>,</span> <span>b_knight_k</span><span>,</span>
</span></span><span><span><span>};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>You can compare two boards with a Hamming distance - <code>index_gt&lt;hamming_gt&lt;piece_t&gt;&gt;</code>.
Alternatively, you can design a custom scheme to weigh pieces differently, assuming pawns‚Äô positions affect the game less than those of queens.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-5-1"><a href="#hl-5-1"> 1</a>
</span><span id="hl-5-2"><a href="#hl-5-2"> 2</a>
</span><span id="hl-5-3"><a href="#hl-5-3"> 3</a>
</span><span id="hl-5-4"><a href="#hl-5-4"> 4</a>
</span><span id="hl-5-5"><a href="#hl-5-5"> 5</a>
</span><span id="hl-5-6"><a href="#hl-5-6"> 6</a>
</span><span id="hl-5-7"><a href="#hl-5-7"> 7</a>
</span><span id="hl-5-8"><a href="#hl-5-8"> 8</a>
</span><span id="hl-5-9"><a href="#hl-5-9"> 9</a>
</span><span id="hl-5-10"><a href="#hl-5-10">10</a>
</span><span id="hl-5-11"><a href="#hl-5-11">11</a>
</span><span id="hl-5-12"><a href="#hl-5-12">12</a>
</span><span id="hl-5-13"><a href="#hl-5-13">13</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="cpp"><span><span><span>unsigned</span> <span>weight</span><span>(</span><span>piece_t</span> <span>piece</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>switch</span> <span>(</span><span>piece</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>case</span> <span>w_king_k</span><span>:</span> <span>w_queen_k</span><span>:</span> <span>b_king_k</span><span>:</span> <span>b_queen_k</span><span>:</span> <span>return</span> <span>5u</span><span>;</span>
</span></span><span><span>        <span>case</span> <span>w_rook_k</span><span>:</span> <span>w_bishop_k</span><span>:</span> <span>w_knight_k</span><span>:</span> <span>b_rook_k</span><span>:</span> <span>b_bishop_k</span><span>:</span> <span>b_knight_k</span><span>:</span> <span>return</span> <span>3u</span><span>;</span>
</span></span><span><span>        <span>default</span><span>:</span> <span>return</span> <span>1u</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>struct</span> <span>position_distance_t</span> <span>{</span>
</span></span><span><span>    <span>unsigned</span> <span>operator</span> <span>()</span> <span>(</span><span>piece_t</span> <span>const</span> <span>*</span><span>board_a</span><span>,</span> <span>piece_t</span> <span>const</span> <span>*</span><span>board_b</span><span>,</span> <span>std</span><span>::</span><span>size_t</span><span>,</span> <span>std</span><span>::</span><span>size_t</span><span>)</span> <span>const</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>std</span><span>::</span><span>transform_reduce</span><span>(</span><span>board_a</span><span>,</span> <span>board_a</span> <span>+</span> <span>64</span><span>,</span> <span>board_b</span><span>,</span> <span>0u</span><span>,</span> <span>std</span><span>::</span><span>plus</span> <span>{},</span> <span>&amp;</span><span>weight</span><span>);</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span><span>};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>This should also work for any other board or card game with discrete states, like Chess, Shogi, or Poker.</p><h2 id="text-search">Text Search</h2><p>With LLMs and Socratic Models, Natural Language Processing is on the rise.
The go-to way of searching through texts is now embedding them with BERT, or something specialized, like ColBERT, and then putting outputs into a Vector Search engine: a modern representation and a modern index structure.
What if we combine an ancient representation with a modern index, retro-futuristically?</p><h3 id="tokens">Tokens</h3><p>Typically, one would tokenize the text, pass it to the transformer, and then put the embedding into a Vector Search engine.
Still, one can compare the two texts by avoiding the intermediate step and intersecting the sets of present tokens to compute Jaccard similarity.
For that USearch has <code>SetsIndex</code>.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-6-1"><a href="#hl-6-1"> 1</a>
</span><span id="hl-6-2"><a href="#hl-6-2"> 2</a>
</span><span id="hl-6-3"><a href="#hl-6-3"> 3</a>
</span><span id="hl-6-4"><a href="#hl-6-4"> 4</a>
</span><span id="hl-6-5"><a href="#hl-6-5"> 5</a>
</span><span id="hl-6-6"><a href="#hl-6-6"> 6</a>
</span><span id="hl-6-7"><a href="#hl-6-7"> 7</a>
</span><span id="hl-6-8"><a href="#hl-6-8"> 8</a>
</span><span id="hl-6-9"><a href="#hl-6-9"> 9</a>
</span><span id="hl-6-10"><a href="#hl-6-10">10</a>
</span><span id="hl-6-11"><a href="#hl-6-11">11</a>
</span><span id="hl-6-12"><a href="#hl-6-12">12</a>
</span><span id="hl-6-13"><a href="#hl-6-13">13</a>
</span><span id="hl-6-14"><a href="#hl-6-14">14</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>usearch</span> <span>import</span> <span>SetsIndex</span>
</span></span><span><span><span>from</span> <span>transformers</span> <span>import</span> <span>BertTokenizer</span>
</span></span><span><span>
</span></span><span><span><span>sets_index</span> <span>=</span> <span>SetsIndex</span><span>()</span>
</span></span><span><span><span>tokenizer</span> <span>=</span> <span>BertTokenizer</span><span>.</span><span>from_pretrained</span><span>(</span><span>&#39;bert-base-uncased&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>text2set</span><span>(</span><span>sample</span><span>:</span> <span>str</span><span>)</span> <span>-&gt;</span> <span>np</span><span>.</span><span>array</span><span>:</span>
</span></span><span><span>    <span>encoding</span> <span>=</span> <span>tokenizer</span><span>.</span><span>encode</span><span>(</span><span>sample</span><span>,</span> <span>truncation</span><span>=</span><span>True</span><span>)</span>
</span></span><span><span>    <span>encoding</span> <span>=</span> <span>encoding</span><span>[</span><span>1</span><span>:</span><span>-</span><span>1</span><span>]</span>
</span></span><span><span>    <span>encoding</span> <span>=</span> <span>sorted</span><span>(</span><span>set</span><span>(</span><span>encoding</span><span>))</span>
</span></span><span><span>    <span>encoding</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>(</span><span>encoding</span><span>,</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>int32</span><span>)</span>
</span></span><span><span>    <span>return</span> <span>encoding</span>
</span></span><span><span>
</span></span><span><span><span>sets_index</span><span>.</span><span>add</span><span>(</span><span>42</span><span>,</span> <span>text2set</span><span>(</span><span>&#39;The answer to all your questions&#39;</span><span>))</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Taking the HackerNews dataset and ~85K of its first entries, I‚Äôve constructed an index and searched for <code>theoretical physics</code>.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-7-1"><a href="#hl-7-1">1</a>
</span><span id="hl-7-2"><a href="#hl-7-2">2</a>
</span><span id="hl-7-3"><a href="#hl-7-3">3</a>
</span><span id="hl-7-4"><a href="#hl-7-4">4</a>
</span><span id="hl-7-5"><a href="#hl-7-5">5</a>
</span><span id="hl-7-6"><a href="#hl-7-6">6</a>
</span><span id="hl-7-7"><a href="#hl-7-7">7</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="txt"><span><span>Results:
</span></span><span><span>- 1. A science podcast you can try is Physics Frontiers. It gets pretty technical.
</span></span><span><span>     https://news.ycombinator.com/item?id=23588415
</span></span><span><span>- 2. I wonder why exponentials are so common in nature&amp;#x2F;physics but tetration is not
</span></span><span><span>     https://news.ycombinator.com/item?id=32285985
</span></span><span><span>- 3. Which is why of course physics departments pay you ~50% to do a PhD, whereas in Computer Science...
</span></span><span><span>     https://news.ycombinator.com/item?id=21440764
</span></span></code></pre></td></tr></tbody></table></div></div><p>Probably not ideal, but it works!</p><h3 id="hashes">Hashes</h3><p>Variable length representations aren‚Äôt always fast to work with.
If you know that the text will be having similar size, a common approach is to generate hash-like fingerprints.
For that USearch has <code>HashIndex</code>.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-8-1"><a href="#hl-8-1">1</a>
</span><span id="hl-8-2"><a href="#hl-8-2">2</a>
</span><span id="hl-8-3"><a href="#hl-8-3">3</a>
</span><span id="hl-8-4"><a href="#hl-8-4">4</a>
</span><span id="hl-8-5"><a href="#hl-8-5">5</a>
</span><span id="hl-8-6"><a href="#hl-8-6">6</a>
</span><span id="hl-8-7"><a href="#hl-8-7">7</a>
</span><span id="hl-8-8"><a href="#hl-8-8">8</a>
</span><span id="hl-8-9"><a href="#hl-8-9">9</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>usearch</span> <span>import</span> <span>HashIndex</span>
</span></span><span><span>
</span></span><span><span><span>hash_index</span> <span>=</span> <span>HashIndex</span><span>(</span><span>bits</span><span>=</span><span>1024</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>def</span> <span>text2hashes</span><span>(</span><span>sample</span><span>:</span> <span>str</span><span>)</span> <span>-&gt;</span> <span>np</span><span>.</span><span>array</span><span>:</span>
</span></span><span><span>    <span>words</span> <span>=</span> <span>sample</span><span>.</span><span>lower</span><span>()</span><span>.</span><span>split</span><span>()</span>
</span></span><span><span>    <span>return</span> <span>np</span><span>.</span><span>array</span><span>([</span><span>hash</span><span>(</span><span>word</span><span>)</span> <span>for</span> <span>word</span> <span>in</span> <span>words</span><span>],</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>int64</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>hash_index</span><span>.</span><span>add</span><span>(</span><span>42</span><span>,</span> <span>text2hashes</span><span>(</span><span>&#39;The answer to all your questions&#39;</span><span>))</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>This won‚Äôt give you high-quality search results.
Still, some companies would use a variation of that approach in complex multi-stage search pipelines.</p><blockquote><p><a href="https://huggingface.co/datasets/fast-flash/fast-flash-hackernews-posts">Dataset</a>.
<a href="https://github.com/ashvardanian/abusing-vector-search/blob/main/tokens.py">Source</a>.</p></blockquote><h2 id="multi-index-lookups">Multi-Index Lookups</h2><p>Most Search systems operate on more than one embedding.
Imagine an online marketplace like Airbnb or Booking.
Once you open a listing, the platform will suggest a few alternatives.
It will search for nearby locations with similar pictures and textual descriptions.
Typically, geospatial indexing will be handled by a specialized system, but we can now put everything together.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-9-1"><a href="#hl-9-1"> 1</a>
</span><span id="hl-9-2"><a href="#hl-9-2"> 2</a>
</span><span id="hl-9-3"><a href="#hl-9-3"> 3</a>
</span><span id="hl-9-4"><a href="#hl-9-4"> 4</a>
</span><span id="hl-9-5"><a href="#hl-9-5"> 5</a>
</span><span id="hl-9-6"><a href="#hl-9-6"> 6</a>
</span><span id="hl-9-7"><a href="#hl-9-7"> 7</a>
</span><span id="hl-9-8"><a href="#hl-9-8"> 8</a>
</span><span id="hl-9-9"><a href="#hl-9-9"> 9</a>
</span><span id="hl-9-10"><a href="#hl-9-10">10</a>
</span><span id="hl-9-11"><a href="#hl-9-11">11</a>
</span><span id="hl-9-12"><a href="#hl-9-12">12</a>
</span><span id="hl-9-13"><a href="#hl-9-13">13</a>
</span><span id="hl-9-14"><a href="#hl-9-14">14</a>
</span><span id="hl-9-15"><a href="#hl-9-15">15</a>
</span><span id="hl-9-16"><a href="#hl-9-16">16</a>
</span><span id="hl-9-17"><a href="#hl-9-17">17</a>
</span><span id="hl-9-18"><a href="#hl-9-18">18</a>
</span><span id="hl-9-19"><a href="#hl-9-19">19</a>
</span><span id="hl-9-20"><a href="#hl-9-20">20</a>
</span><span id="hl-9-21"><a href="#hl-9-21">21</a>
</span><span id="hl-9-22"><a href="#hl-9-22">22</a>
</span><span id="hl-9-23"><a href="#hl-9-23">23</a>
</span><span id="hl-9-24"><a href="#hl-9-24">24</a>
</span><span id="hl-9-25"><a href="#hl-9-25">25</a>
</span><span id="hl-9-26"><a href="#hl-9-26">26</a>
</span><span id="hl-9-27"><a href="#hl-9-27">27</a>
</span><span id="hl-9-28"><a href="#hl-9-28">28</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>usearch</span> <span>import</span> <span>Index</span>
</span></span><span><span><span>from</span> <span>uform</span> <span>import</span> <span>get_model</span>
</span></span><span><span><span>from</span> <span>ucall.rich_posix</span> <span>import</span> <span>Server</span>
</span></span><span><span>
</span></span><span><span><span>server</span> <span>=</span> <span>Server</span><span>()</span>
</span></span><span><span>
</span></span><span><span><span>index_images</span> <span>=</span> <span>Index</span><span>(</span><span>ndim</span><span>=</span><span>256</span><span>)</span>
</span></span><span><span><span>index_texts</span> <span>=</span> <span>Index</span><span>(</span><span>ndim</span><span>=</span><span>256</span><span>)</span>
</span></span><span><span><span>index_coordinates</span> <span>=</span> <span>Index</span><span>(</span><span>metric</span><span>=</span><span>&#39;haversine&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>model</span> <span>=</span> <span>get_model</span><span>(</span><span>&#39;unum-cloud/uform-vl-english&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>@server</span>
</span></span><span><span><span>def</span> <span>recommend</span><span>(</span><span>text</span><span>:</span> <span>str</span><span>,</span> <span>image</span><span>:</span> <span>Image</span><span>,</span> <span>latitude</span><span>:</span> <span>float</span><span>,</span> <span>longitude</span><span>:</span> <span>float</span><span>)</span> <span>-&gt;</span> <span>list</span><span>[</span><span>int</span><span>]:</span>
</span></span><span><span>
</span></span><span><span>    <span>vector_image</span> <span>=</span> <span>model</span><span>.</span><span>encode_image</span><span>(</span><span>model</span><span>.</span><span>preprocess_image</span><span>(</span><span>image</span><span>))</span><span>.</span><span>numpy</span><span>()</span>
</span></span><span><span>    <span>vector_text</span> <span>=</span> <span>model</span><span>.</span><span>encode_text</span><span>(</span><span>model</span><span>.</span><span>preprocess_text</span><span>(</span><span>text</span><span>))</span><span>.</span><span>numpy</span><span>()</span>
</span></span><span><span>    <span>vector_coordinate</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>([</span><span>latitude</span><span>,</span> <span>longitude</span><span>],</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>similar_images</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index_images</span><span>.</span><span>search</span><span>(</span><span>vector_image</span><span>,</span> <span>30</span><span>)</span>
</span></span><span><span>    <span>similar_texts</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index_texts</span><span>.</span><span>search</span><span>(</span><span>vector_text</span><span>,</span> <span>30</span><span>)</span>
</span></span><span><span>    <span>similar_coordinates</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index_coordinates</span><span>.</span><span>search</span><span>(</span><span>vector_coordinate</span><span>,</span> <span>100</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span># If a listing is physically close and matches text or image, it must be first.</span>
</span></span><span><span>    <span>similar_contents</span> <span>=</span> <span>set</span><span>(</span><span>similar_images</span><span>)</span> <span>+</span> <span>set</span><span>(</span><span>similar_texts</span><span>)</span>
</span></span><span><span>    <span>return</span> <span>[</span><span>label</span> <span>for</span> <span>label</span> <span>in</span> <span>similar_coordinates</span> <span>if</span> <span>label</span> <span>in</span> <span>similar_contents</span><span>]</span>
</span></span><span><span>
</span></span><span><span><span>server</span><span>.</span><span>run</span><span>()</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="fused-embeddings">Fused Embeddings</h3><p>When using mid-fusion models like UForm, you can get a multi-modal embedding out of the box.
Thus you can save one index lookup and still get more relevant results.</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-10-1"><a href="#hl-10-1"> 1</a>
</span><span id="hl-10-2"><a href="#hl-10-2"> 2</a>
</span><span id="hl-10-3"><a href="#hl-10-3"> 3</a>
</span><span id="hl-10-4"><a href="#hl-10-4"> 4</a>
</span><span id="hl-10-5"><a href="#hl-10-5"> 5</a>
</span><span id="hl-10-6"><a href="#hl-10-6"> 6</a>
</span><span id="hl-10-7"><a href="#hl-10-7"> 7</a>
</span><span id="hl-10-8"><a href="#hl-10-8"> 8</a>
</span><span id="hl-10-9"><a href="#hl-10-9"> 9</a>
</span><span id="hl-10-10"><a href="#hl-10-10">10</a>
</span><span id="hl-10-11"><a href="#hl-10-11">11</a>
</span><span id="hl-10-12"><a href="#hl-10-12">12</a>
</span><span id="hl-10-13"><a href="#hl-10-13">13</a>
</span><span id="hl-10-14"><a href="#hl-10-14">14</a>
</span><span id="hl-10-15"><a href="#hl-10-15">15</a>
</span><span id="hl-10-16"><a href="#hl-10-16">16</a>
</span><span id="hl-10-17"><a href="#hl-10-17">17</a>
</span><span id="hl-10-18"><a href="#hl-10-18">18</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>index_contents</span> <span>=</span> <span>Index</span><span>(</span><span>ndim</span><span>=</span><span>384</span><span>)</span>
</span></span><span><span><span>index_coordinates</span> <span>=</span> <span>Index</span><span>(</span><span>metric</span><span>=</span><span>&#39;haversine&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>model</span> <span>=</span> <span>get_model</span><span>(</span><span>&#39;unum-cloud/uform-vl-english&#39;</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>@server</span>
</span></span><span><span><span>def</span> <span>recommend</span><span>(</span><span>text</span><span>:</span> <span>str</span><span>,</span> <span>image</span><span>:</span> <span>Image</span><span>,</span> <span>latitude</span><span>:</span> <span>float</span><span>,</span> <span>longitude</span><span>:</span> <span>float</span><span>)</span> <span>-&gt;</span> <span>list</span><span>[</span><span>int</span><span>]:</span>
</span></span><span><span>
</span></span><span><span>    <span>vector_content</span> <span>=</span> <span>model</span><span>.</span><span>encode_multimodal</span><span>(</span>
</span></span><span><span>        <span>image</span><span>=</span><span>model</span><span>.</span><span>preprocess_image</span><span>(</span><span>image</span><span>),</span>
</span></span><span><span>        <span>text</span><span>=</span><span>model</span><span>.</span><span>preprocess_text</span><span>(</span><span>text</span><span>))</span><span>.</span><span>numpy</span><span>()</span>
</span></span><span><span>    <span>vector_coordinate</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>([</span><span>latitude</span><span>,</span> <span>longitude</span><span>],</span> <span>dtype</span><span>=</span><span>np</span><span>.</span><span>float32</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span>similar_contents</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index_contents</span><span>.</span><span>search</span><span>(</span><span>vector_content</span><span>,</span> <span>60</span><span>)</span>
</span></span><span><span>    <span>similar_coordinates</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index_coordinates</span><span>.</span><span>search</span><span>(</span><span>vector_coordinate</span><span>,</span> <span>100</span><span>)</span>
</span></span><span><span>
</span></span><span><span>    <span># If a listing is physically close and matches contents, it must be first.</span>
</span></span><span><span>    <span>return</span> <span>[</span><span>label</span> <span>for</span> <span>label</span> <span>in</span> <span>similar_coordinates</span> <span>if</span> <span>label</span> <span>in</span> <span>similar_contents</span><span>]</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="jit-ed-user-defined-functions">JIT-ed User Defined Functions</h3><p>If you use a less specialized model, don‚Äôt worry.
You can concatenate the textual and image vector and customize the index to take your alternative similarity function.
In C++, it‚Äôs as easy as passing a custom <code>template</code> argument.
With Numba, however, you can get to the C++ layer without getting to the C++ layer.
Once you <a href="https://numba.readthedocs.io/en/stable/reference/jit-compilation.html#c-callbacks">JIT-compile your function</a>, you can pass it‚Äôs address to the C++ library like this:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span id="hl-11-1"><a href="#hl-11-1"> 1</a>
</span><span id="hl-11-2"><a href="#hl-11-2"> 2</a>
</span><span id="hl-11-3"><a href="#hl-11-3"> 3</a>
</span><span id="hl-11-4"><a href="#hl-11-4"> 4</a>
</span><span id="hl-11-5"><a href="#hl-11-5"> 5</a>
</span><span id="hl-11-6"><a href="#hl-11-6"> 6</a>
</span><span id="hl-11-7"><a href="#hl-11-7"> 7</a>
</span><span id="hl-11-8"><a href="#hl-11-8"> 8</a>
</span><span id="hl-11-9"><a href="#hl-11-9"> 9</a>
</span><span id="hl-11-10"><a href="#hl-11-10">10</a>
</span><span id="hl-11-11"><a href="#hl-11-11">11</a>
</span><span id="hl-11-12"><a href="#hl-11-12">12</a>
</span><span id="hl-11-13"><a href="#hl-11-13">13</a>
</span><span id="hl-11-14"><a href="#hl-11-14">14</a>
</span><span id="hl-11-15"><a href="#hl-11-15">15</a>
</span><span id="hl-11-16"><a href="#hl-11-16">16</a>
</span><span id="hl-11-17"><a href="#hl-11-17">17</a>
</span><span id="hl-11-18"><a href="#hl-11-18">18</a>
</span><span id="hl-11-19"><a href="#hl-11-19">19</a>
</span><span id="hl-11-20"><a href="#hl-11-20">20</a>
</span><span id="hl-11-21"><a href="#hl-11-21">21</a>
</span><span id="hl-11-22"><a href="#hl-11-22">22</a>
</span><span id="hl-11-23"><a href="#hl-11-23">23</a>
</span><span id="hl-11-24"><a href="#hl-11-24">24</a>
</span><span id="hl-11-25"><a href="#hl-11-25">25</a>
</span><span id="hl-11-26"><a href="#hl-11-26">26</a>
</span><span id="hl-11-27"><a href="#hl-11-27">27</a>
</span><span id="hl-11-28"><a href="#hl-11-28">28</a>
</span><span id="hl-11-29"><a href="#hl-11-29">29</a>
</span></code></pre></td><td><pre tabindex="0"><code data-lang="py"><span><span><span>from</span> <span>numba</span> <span>import</span> <span>cfunc</span><span>,</span> <span>types</span><span>,</span> <span>carray</span>
</span></span><span><span>
</span></span><span><span><span>signature</span> <span>=</span> <span>types</span><span>.</span><span>float32</span><span>(</span>
</span></span><span><span>    <span>types</span><span>.</span><span>CPointer</span><span>(</span><span>types</span><span>.</span><span>float32</span><span>),</span>
</span></span><span><span>    <span>types</span><span>.</span><span>CPointer</span><span>(</span><span>types</span><span>.</span><span>float32</span><span>),</span>
</span></span><span><span>    <span>types</span><span>.</span><span>size_t</span><span>,</span> <span>types</span><span>.</span><span>size_t</span><span>)</span>
</span></span><span><span>
</span></span><span><span>
</span></span><span><span><span>@cfunc</span><span>(</span><span>signature</span><span>)</span>
</span></span><span><span><span>def</span> <span>metric</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>,</span> <span>_</span><span>,</span> <span>_</span><span>):</span>
</span></span><span><span>    <span>a_array</span> <span>=</span> <span>carray</span><span>(</span><span>a</span><span>,</span> <span>512</span><span>)</span>
</span></span><span><span>    <span>b_array</span> <span>=</span> <span>carray</span><span>(</span><span>b</span><span>,</span> <span>512</span><span>)</span>
</span></span><span><span>    <span>text_similarity</span> <span>=</span> <span>0.0</span>
</span></span><span><span>    <span>image_similarity</span> <span>=</span> <span>0.0</span>
</span></span><span><span>    <span>for</span> <span>i</span> <span>in</span> <span>range</span><span>(</span><span>256</span><span>):</span>
</span></span><span><span>        <span>image_similarity</span> <span>+=</span> <span>a_array</span><span>[</span><span>i</span><span>]</span> <span>*</span> <span>b_array</span><span>[</span><span>i</span><span>]</span>
</span></span><span><span>        <span>text_similarity</span> <span>+=</span> <span>a_array</span><span>[</span><span>i</span> <span>+</span> <span>256</span><span>]</span> <span>*</span> <span>b_array</span><span>[</span><span>i</span> <span>+</span> <span>256</span><span>]</span>    
</span></span><span><span>    <span>return</span> <span>2</span> <span>-</span> <span>image_similarity</span> <span>-</span> <span>text_similarity</span>
</span></span><span><span>
</span></span><span><span><span>index_contents</span> <span>=</span> <span>Index</span><span>(</span><span>ndim</span><span>=</span><span>512</span><span>,</span> <span>metric_pointer</span><span>=</span><span>metric</span><span>.</span><span>address</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span>@server</span>
</span></span><span><span><span>def</span> <span>recommend</span><span>(</span><span>text</span><span>:</span> <span>str</span><span>,</span> <span>image</span><span>:</span> <span>Image</span><span>,</span> <span>latitude</span><span>:</span> <span>float</span><span>,</span> <span>longitude</span><span>:</span> <span>float</span><span>)</span> <span>-&gt;</span> <span>list</span><span>[</span><span>int</span><span>]:</span>
</span></span><span><span>
</span></span><span><span>    <span>vector_image</span> <span>=</span> <span>model</span><span>.</span><span>encode_image</span><span>(</span><span>model</span><span>.</span><span>preprocess_image</span><span>(</span><span>image</span><span>))</span><span>.</span><span>numpy</span><span>()</span>
</span></span><span><span>    <span>vector_text</span> <span>=</span> <span>model</span><span>.</span><span>encode_text</span><span>(</span><span>model</span><span>.</span><span>preprocess_text</span><span>(</span><span>text</span><span>))</span><span>.</span><span>numpy</span><span>()</span>
</span></span><span><span>    <span>vector_content</span> <span>=</span> <span>np</span><span>.</span><span>concatenate</span><span>((</span><span>vector_image</span><span>,</span> <span>vector_text</span><span>))</span>
</span></span><span><span>    <span>similar_contents</span><span>,</span> <span>_</span><span>,</span> <span>_</span> <span>=</span> <span>index_contents</span><span>.</span><span>search</span><span>(</span><span>vector_content</span><span>,</span> <span>60</span><span>)</span>
</span></span><span><span>    <span>...</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>We have just built a composite recommendation system with zero microservices or dollars spent on private APIs.
The only thing left is to choose an excellent neural network tuned for your domain!
Which may not even be needed with the upcoming snapshots of UForm, promising better generalization across domains.</p><hr/><p><img loading="lazy" src="https://ashvardanian.com/abusing-vector-search/usearch-approaches-white.png" alt="USearch Vector Search Approaches"/></p><p>Not bad, right?
HNSW is a simple data structure, but unlike many older approaches, it has many applications.
That‚Äôs why we aren‚Äôt keen on quantization.
It takes away too many excellent properties.
That being said, we know that the core algorithm has space for improvement!
So feel free to fork it and try it yourself!</p><ul><li><a href="https://github.com/unum-cloud/USearch">USearch</a> in-memory vector search üîç</li><li><a href="https://github.com/unum-cloud/UStore">UStore</a> up to 10x faster multi-modal database üíæ</li><li><a href="https://github.com/unum-cloud/UForm">UForm</a> tiny efficient multi-modal transformers üß†</li><li><a href="https://github.com/unum-cloud/UCall">UCall</a> up to 100x faster networking ‚òéÔ∏è</li></ul><p>Don‚Äôt forget to star on GitHub ü§ó and <a href="https://discord.gg/A6wxt6dS9j">reach out on Discord</a> if you have any questions.</p></div></div>
  </body>
</html>
