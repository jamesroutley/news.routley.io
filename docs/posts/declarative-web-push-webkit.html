<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://webkit.org/blog/16535/meet-declarative-web-push/">Original</a>
    <h1>Declarative Web Push – WebKit</h1>
    
    <div id="readability-page-1" class="page"><div>
                <menu><menuitem><h6><label for="table-of-contents-toggle">Contents</label></h6><ul><li><a href="#the-status-quo">The status quo</a></li><li><a href="#how-to-use-declarative-web-push">How to use Declarative Web Push</a></li><li><a href="#a-note-on-backwards-compatibility">A note on backwards compatibility</a></li><li><a href="#what-if-i-can%e2%80%99t-send-the-notification-description-through-the-internet">What if I can’t send the notification description through the internet?</a></li><li><a href="#standards-work">Standards work</a></li></ul></menuitem></menu>                
                <p>Web Push notifications are a powerful and important part of the web platform.</p>
<p>As someone’s very famous uncle once said, <a href="https://en.wikipedia.org/wiki/With_great_power_comes_great_responsibility#Use_in_Spider-Man_media">with great power comes great responsibility</a>. When we added Web Push to WebKit we knew it was imperative to maintain people’s expectations of power efficiency and privacy.</p>
<p>We took a deliberate approach to maintain those expectations when implementing <a href="https://webkit.org/blog/12945/meet-web-push/">Web Push for Safari</a> on macOS, for <a href="https://webkit.org/blog/13878/web-push-for-web-apps-on-ios-and-ipados/">web apps saved to the Home Screen</a> on iOS and iPadOS, and <a href="https://webkit.org/blog/14205/news-from-wwdc23-webkit-features-in-safari-17-beta/#web-apps">web apps on Mac</a>.  We knew running extra code to display notifications could impact battery life. We knew that Web Push’s reliance on service worker JavaScript was at odds with our broad approach to user privacy on the web. We learned that the protections we felt necessary for user privacy challenged assumptions web developers had about Web Push in other browsers. So we challenged ourselves to <a href="https://github.com/WebKit/explainers/blob/main/DeclarativeWebPush/README.md">propose something better</a> for end users, web developers, and browsers.</p>
<p>Declarative Web Push allows web developers to request a Web Push subscription and display user visible notifications without requiring an installed <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers">service worker</a>. Service worker JavaScript can <em>optionally</em> change the contents of an incoming notification. Unlike with original Web Push, there is no penalty for service workers failing to display a notification; the declarative push message itself is used as a fallback in case the optional JavaScript processing step fails.</p>
<p>Declarative Web Push is more energy efficient and more private by design. It is easier for you, the web developer to use. And it’s backwards compatible with existing Web Push notifications.</p>
<p>Keep reading for our thinking on the challenges that result from how Web Push works today. Or jump straight to <a href="https://www.webkit.org/blog/16535/meet-declarative-web-push/#how-to-use-declarative-web-push">how to use Declarative Web Push</a>. You can test it out in iOS and iPadOS 18.4.</p>
<h2><a name="the-status-quo"></a>The status quo</h2>
<p>Existing Web Push notifications were designed with a JavaScript-first mindset. Instead of a remote push directly describing a user visible notification, the more abstract concept of a “push message” is handled by the website’s service worker JavaScript.</p>
<p>The website first needs to have a service worker registered. It can then use that <code>ServiceWorkerRegistration</code> to create a <code>PushSubscription</code>, which gives the website the information it needs to remotely send a push message to the browser.</p>
<p>To give users direct control, WebKit requires you as the developer to always show a notification; no silent push messages are allowed. Therefore we require push subscriptions to set the <code>userVisibleOnly</code> flag to <code>true</code>. While this can be frustrating, the original Web Push design made this necessary to protect user privacy and battery life.</p>
<p>Once a push message is received on the device, the browser makes sure there is an instance of the service worker JavaScript and then dispatches a <code>PushEvent</code> to it. The code handling that event inspects the data in the push message, using it to make a call to <code>ServiceWorkerRegistration.showNotification(...)</code> to display the user visible notification.</p>
<p>While some popular JavaScript libraries abstract away some of these complexities, there’s a lot of code involved, and a lot can subtly go wrong.</p>
<h3><a name="challenge-1-%e2%80%94-silent-push-protection"></a>Challenge 1 — Silent push protection</h3>
<p>Recall that WebKit requires the <code>userVisibleOnly</code> flag be set to true when registering for a push subscription. The JavaScript in a ServiceWorker’s <code>PushEvent</code> handler has the responsibility of showing that user visible notification. Allowing websites to remotely wake up a device for silent background work is a privacy violation and expends energy. So if an event handler doesn’t show the user visible notification for any reason we <a href="https://webkit.org/blog/12945/meet-web-push/#:~:text=Violations%20of%20the%20userVisibleOnly%20promise%20will%20result%20in%20a%20push%20subscription%20being%20revoked.">revoke its push subscription</a></p>
<p>Unfortunately bugs in a service worker script, networking conditions, or local device conditions all might prevent a timely call to <code>showNotification</code>. These scenarios might not always be the fault of the script author and can be difficult to debug. It would be better if there were technical enforcement of the <code>userVisibleOnly</code> promise and therefore the silent push penalty box could be ignored.</p>
<h3><a name="challenge-2-%e2%80%94-tracking-data"></a>Challenge 2 — Tracking data</h3>
<p>We’ve <a href="https://webkit.org/blog/category/privacy/">blogged about it before</a> and we’ll blog about it again; Privacy is a fundamental human right.</p>
<p>Since the first version of Safari we’ve focused on privacy. WebKit goes above and beyond the privacy protections required by web standards. As the web platform evolved, so did our strategies to protect user privacy. This now includes active blocking and removal of website data, like with <a href="https://webkit.org/blog/7675/intelligent-tracking-prevention/">Intelligent Tracking Prevention</a> (shortened as ITP).</p>
<p>ITP deletes all website data for websites you haven’t visited in a while. This includes service worker registrations. While this can be frustrating to web developers, it’s key to protecting user privacy. It’s a hard tradeoff we make intentionally given how committed we are to protecting users.</p>
<p>When we implemented Web Push that created a dilemma. Since creating and using a push subscription is inherently tied to having a service worker, ITP removing a service worker registration would render the push subscription useless. Since having strong anti-tracking prevention features seems to be fundamentally at odds with the JavaScript-driven nature of existing Web Push, wouldn’t it be better if Web Push notifications could be delivered without any JavaScript?</p>
<p>So what does Declarative Web Push look like in practice?</p>
<h2><a name="how-to-use-declarative-web-push"></a>How to use Declarative Web Push</h2>
<p>To use any flavor of Web Push you first use a <code>PushManager</code> to acquire a push subscription. Web Push on Apple’s platforms uses the same Apple Push Notification service that powers native push on all Apple devices. You do not need to be a member of the Apple Developer Program to use it.</p>
<p>The only <code>PushManager</code> available with original Web Push is <code>ServiceWorkerRegistration.pushManager</code>.</p>
<pre><code><span>const</span> <span>subscription</span> <span>=</span> <span>await</span> <span>window</span>.<span>pushManager</span>.<span>subscribe</span>({
    <span>userVisibleOnly</span><span>:</span> <span>true</span>,
    <span>applicationServerKey</span><span>:</span> <span>arrayForPublicKey</span>
});
</code></pre>
<p>If you do also have a registered service worker scoped to the root level of your website domain, it shares the same push subscription as the window object. But the removal of that service worker registration will not affect the associated push subscription.</p>
<p>Sending a push message to that push subscription works exactly as before. For a notification to be handled declaratively the <em>contents</em> of the push message must match the <a href="https://pr-preview.s3.amazonaws.com/w3c/push-api/pull/385.html#declarative-push-message">declarative standard JSON format.</a> This standardized format guarantees that the browser has enough information to display a user-visible notification without any JavaScript.</p>
<pre><code>{
    <span>&#34;web_push&#34;</span><span>:</span> <span>8030</span>,
    <span>&#34;notification&#34;</span><span>:</span> {
        <span>&#34;title&#34;</span><span>:</span> <span>&#34;Webkit.org — Meet Declarative Web Push&#34;</span>,
        <span>&#34;lang&#34;</span><span>:</span> <span>&#34;en-US&#34;</span>,
        <span>&#34;dir&#34;</span><span>:</span> <span>&#34;ltr&#34;</span>,
        <span>&#34;body&#34;</span><span>:</span> <span>&#34;Send push notifications without JavaScript or service worker!&#34;</span>,
        <span>&#34;navigate&#34;</span><span>:</span> <span>&#34;https://webkit.org/blog/16535/meet-declarative-web-push/&#34;</span>,
        <span>&#34;silent&#34;</span><span>:</span> <span>false</span>,
        <span>&#34;app_badge&#34;</span><span>:</span> <span>&#34;1&#34;</span>
    }
}
</code></pre>
<p>The top level <code>&#34;web_push&#34;</code> value is an homage to <a href="https://datatracker.ietf.org/doc/html/rfc8030">RFC 8030</a> – Generic Event Delivery Using HTTP Push. This is the magic value that opts the rest of your push message into declarative parsing.</p>
<p>The <code>&#34;notification&#34;</code> value is a dictionary that describes the user visible notification to the browser. Like when you create a notification programmatically in JavaScript, a non-empty <code>&#34;title&#34;</code> value is required. Most of the optional members of the <a href="https://notifications.spec.whatwg.org/#dictdef-notificationoptions">NotificationOptions dictionary</a> can also be specified.</p>
<p>So far we’ve mostly discussed the automatic display of a notification without JavaScript. Something useful needs to happen without JavaScript when a user activates a declarative notification. That’s where the required <code>&#34;navigate&#34;</code> value comes in. It describes a URL that will be navigated to by the browser upon activation.</p>
<p>Finally, if the web app supports running in an app-like mode that supports the <a href="https://www.w3.org/TR/badging/">Badging API</a>, such as <a href="https://webkit.org/blog/14112/badging-for-home-screen-web-apps/">Home Screen web apps on iOS</a>, the declarative message can include an updated application badge.</p>
<h2><a name="a-note-on-backwards-compatibility"></a>A note on backwards compatibility</h2>
<p>In practice, a vast majority of Web Push messages are already JSON. They describe a user visible notification to be displayed. The service worker JavaScript handling those push messages simply parses the JSON to display the notification programatically. But the format of those JSON messages varies on a per-website basis.</p>
<p>Most applications will find it straightforward to send the declarative standard JSON in their push messages and rewrite their service worker’s <code>PushEvent</code> handler to display it. Once those two steps are taken, those Web Push messages become backwards compatible with browsers that do not yet support Declarative Web Push.</p>
<p>If your push message arrives to a newer browser, it’s handled declaratively by the browser. If it arrives to an older browser, it’s handled imperatively by JavaScript as it always had been.</p>
<p>Always standardizing on the declarative standard JSON has the nice side effect of introducing consistency across all projects, further reducing maintenance burden for prolific web developers.</p>
<h2><a name="what-if-i-can%e2%80%99t-send-the-notification-description-through-the-internet"></a>What if I can’t send the notification description through the internet?</h2>
<p>All apps — no matter their platform — might not be able to send the visible content of a notification through push services. How a notification should display often relies on application state local to the user’s device. Maybe the user has used the app in ways the server is not aware of yet, requiring an update to the notification. Or maybe the app is for secure communication and decryption keys for the notification payload only exist within the app on the device.</p>
<p>In these cases, code is needed to process the incoming push message to display something meaningful.</p>
<figure><img fetchpriority="high" decoding="async" src="https://webkit.org/wp-content/uploads/declarative-web-push-notification.png" alt="" width="1078" height="321" srcset="https://webkit.org/wp-content/uploads/declarative-web-push-notification.png 1078w, https://webkit.org/wp-content/uploads/declarative-web-push-notification-300x89.png 300w, https://webkit.org/wp-content/uploads/declarative-web-push-notification-1024x305.png 1024w, https://webkit.org/wp-content/uploads/declarative-web-push-notification-768x229.png 768w" sizes="(max-width: 1078px) 100vw, 1078px"/></figure>
<p>Native iOS apps that run into these edge cases have a tool call <a href="https://developer.apple.com/documentation/usernotifications/unnotificationserviceextension"><code>UNNotificationServiceExtension</code></a> which allows a small snippet of application code to run in response to an incoming push notification. The incoming notification <em>always</em> has enough content to display a user visible “fallback notification”, but the app’s notification service extension is given a short amount of time to consult the app’s local data storage and propose a new, more meaningful notification.</p>
<p>If there’s a bug in the notification extension, or the required data is not available, or some other unforeseen scenario causes it to fail to show a different notification in time, the original “fallback content” is displayed instead.</p>
<figure><img decoding="async" src="https://webkit.org/wp-content/uploads/declarative-web-push-secure.png" alt="" width="1078" height="297" srcset="https://webkit.org/wp-content/uploads/declarative-web-push-secure.png 1078w, https://webkit.org/wp-content/uploads/declarative-web-push-secure-300x83.png 300w, https://webkit.org/wp-content/uploads/declarative-web-push-secure-1024x282.png 1024w, https://webkit.org/wp-content/uploads/declarative-web-push-secure-768x212.png 768w" sizes="(max-width: 1078px) 100vw, 1078px"/></figure>
<p>For web apps with Declarative Web Push, service worker JavaScript fills the same role. When a Declarative Web Push message arrives and a service worker is installed, a push event is dispatched to it like before.</p>
<p><code>PushEvent</code> now has the context of the “proposed notification” from the Declarative Web Push message. If the event handler displays a replacement notification properly, the proposed notification is ignored. If the event handler fails to display a replacement notification in time, the fallback is used.</p>
<p>Because there is always a user visible notification — therefore a privacy breaking silent push remains impossible — browsers don’t have to apply their “silent push penalties” to Declarative Web Push messages.</p>
<p>iOS also supports <a href="https://support.apple.com/en-al/guide/iphone/iph47c931112/ios#:~:text=Remove%20apps%20and%20data,Drive%20in%20the%20Files%20app.">offloading unused native apps</a> which frees up the storage used by the application code while leaving minimal application functionality in place. In this scenario, the <code>UNNotificationServiceExtension</code> code is gone but unmodified notifications can still be displayed for the application.</p>
<p>This is quite similar to how Declarative Web Push notifications work on iOS after the website’s service worker JavaScript has been removed either by the user or by ITP. The modification of an incoming push message is no longer possible but the unmodified notification can still be displayed.</p>
<h2><a name="standards-work"></a>Standards work</h2>
<p>We’re excited about Declarative Web Push and want it supported everywhere.</p>
<p>Around the time we published our <a href="https://github.com/WebKit/explainers/blob/main/DeclarativeWebPush/README.md">WebKit Declarative Web Push explainer</a>, we also approached the other browser vendors and interested parties about it at <a href="https://www.w3.org/2023/09/TPAC/">TPAC 2023</a> and raised <a href="https://github.com/w3c/push-api/issues/360">an issue against the Push API</a> to discuss it. While standards bodies will always nit pick on the details, the overall goal of the proposal was well met.</p>
<p>In 2024, we actively made proposals to the various specs involved, making changes to our implementation as well reasoned feedback came in:</p>
<ul>
<li><a href="https://github.com/whatwg/notifications/pull/213">Allow notifications and actions to specify a navigable URL</a> against the Notifications API enables notifications to navigate without involving JavaScript after an end user clicks them. (We also made various editorial changes to the Notifications API as part of standardizing Declarative Web Push.)</li>
<li><a href="https://github.com/w3c/push-api/pull/385">Add Declarative Web Push</a> against the Push API specification defines the new declarative format.</li>
<li><a href="https://github.com/w3c/push-api/pull/393">Expose pushManager on Window</a> against the Push API specification enables the Push API API to be used without the need for a service worker.</li>
</ul>
<p>We feel the feature has a good enough foundation for us to ship it and for web developers to start experimenting with it. We foresee future enhancements enabled by this solid foundation. And we hope it ends up widely available soon.</p>
<p>We encourage you to reach out to us on <a href="https://webkit.slack.com/">WebKit’s Slack</a> or our <a href="https://bugs.webkit.org/">issue tracker</a> to share your experiences working with this great new feature.</p>

                            </div></div>
  </body>
</html>
