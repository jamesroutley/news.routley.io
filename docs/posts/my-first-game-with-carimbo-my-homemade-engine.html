<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nullonerror.org/2024/10/08/my-first-game-with-carimbo/">Original</a>
    <h1>My first game with Carimbo, my homemade engine</h1>
    
    <div id="readability-page-1" class="page"><div>
<header>
<h3>
<a href="https://nullonerror.org/" title="Home">NULL on error</a>
<small>flipping bits whilst updating pixels</small>
</h3>
</header>
<main><article>

<time datetime="2024-10-08T00:00:00+00:00">08 Oct 2024</time>
<p><a href="https://youtu.be/nVRzCstyspQ"><img src="https://nullonerror.org/public/2024-10-08-my-first-game-with-carimbo/megarick.webp" alt="MegaRick Game"/></a>
<a href="https://youtu.be/nVRzCstyspQ">https://youtu.be/nVRzCstyspQ</a></p>
<h3 id="tldr">TL;DR</h3>
<p>After a while, I decided to resume work on <a href="https://github.com/carimbolabs/carimbo">my game engine</a>.</p>
<p>I made a game for my son. I could have used an existing engine, but I chose to write everything from scratch because code is like pasta‚Äîit‚Äôs much better and more enjoyable when homemade.</p>
<p>This actually reminds me of when my father used to build my toys, from kites to wooden slides. Good memories. I have decided to do the same using what I know: programming.</p>
<p>You can watch it here or <a href="https://play.carimbo.cloud/1.0.10/carimbolabs/megarick/1.0.7/720p">play it here</a>, (runs in the browser thanks to WebAssembly), use <code>A</code> and <code>D</code> for moving around and <code>space</code> to shoot.</p>
<p>The engine was written in C++17, and the games are in Lua. The engine exposes some primitives to the Lua VM, which in turn coordinates the entire game.</p>
<p><a href="https://github.com/carimbolabs/megarick">Game source code</a> and <a href="https://github.com/carimbolabs/carimbo">engine source code</a>.</p>
<p>Artwork by <a href="https://www.fiverr.com/yuugenpixie">Aline Cardoso @yuugenpixie</a>.</p>
<h3 id="going-deep">Going Deep</h3>
<p>The entire game is scripted in <a href="https://www.lua.org">Lua</a>.</p>
<p>First, we create the engine itself.</p>
<div><div><pre><code><span>local</span> <span>engine</span> <span>=</span> <span>EngineFactory</span><span>.</span><span>new</span><span>()</span>
    <span>:</span><span>set_title</span><span>(</span><span>&#34;Mega Rick&#34;</span><span>)</span>
    <span>:</span><span>set_width</span><span>(</span><span>1920</span><span>)</span>
    <span>:</span><span>set_height</span><span>(</span><span>1080</span><span>)</span>
    <span>:</span><span>set_fullscreen</span><span>(</span><span>false</span><span>)</span>
    <span>:</span><span>create</span><span>()</span>
</code></pre></div></div>
<p>Then we point to some resources for asset prefetching; they are loaded lazily to avoid impacting the <em>game loop</em>.</p>
<div><div><pre><code><span>engine</span><span>:</span><span>prefetch</span><span>({</span>
  <span>&#34;blobs/bomb1.ogg&#34;</span><span>,</span>
  <span>&#34;blobs/bomb2.ogg&#34;</span><span>,</span>
  <span>&#34;blobs/bullet.png&#34;</span><span>,</span>
  <span>&#34;blobs/candle.png&#34;</span><span>,</span>
  <span>&#34;blobs/explosion.png&#34;</span><span>,</span>
  <span>&#34;blobs/octopus.png&#34;</span><span>,</span>
  <span>&#34;blobs/player.png&#34;</span><span>,</span>
  <span>&#34;blobs/princess.png&#34;</span><span>,</span>
  <span>&#34;blobs/ship.png&#34;</span>
<span>})</span>
</code></pre></div></div>
<p>We created the postal service, which is something I borrowed from languages like <em>Erlang</em>, where an entity can send messages to any other. As we‚Äôll see below, the bullet sends a hit message when it collides with the octopus, and the octopus, upon receiving the hit, decrements its own health.</p>
<p>We also obtain the SoundManager to play sounds and spawn the main entities.</p>
<div><div><pre><code><span>local</span> <span>postal</span> <span>=</span> <span>PostalService</span><span>.</span><span>new</span><span>()</span>
<span>local</span> <span>soundmanager</span> <span>=</span> <span>engine</span><span>:</span><span>soundmanager</span><span>()</span>
<span>local</span> <span>octopus</span> <span>=</span> <span>engine</span><span>:</span><span>spawn</span><span>(</span><span>&#34;octopus&#34;</span><span>)</span>
<span>local</span> <span>player</span> <span>=</span> <span>engine</span><span>:</span><span>spawn</span><span>(</span><span>&#34;player&#34;</span><span>)</span>
<span>local</span> <span>princess</span> <span>=</span> <span>engine</span><span>:</span><span>spawn</span><span>(</span><span>&#34;princess&#34;</span><span>)</span>
<span>local</span> <span>candle1</span> <span>=</span> <span>engine</span><span>:</span><span>spawn</span><span>(</span><span>&#34;candle&#34;</span><span>)</span>
<span>local</span> <span>candle2</span> <span>=</span> <span>engine</span><span>:</span><span>spawn</span><span>(</span><span>&#34;candle&#34;</span><span>)</span>
</code></pre></div></div>
<p>It‚Äôs not a triple-A title, but I‚Äôm very careful with resource management. A widely known technique is to create an object pool that you can reuse. In the code below, we limit it to a maximum of 3 bullets present on the screen.</p>
<p>The <code>on_update</code> method is a callback called each loop in the engine. In the case of the bullet, I check if it has approached the green octopus. If so, I send a message to it indicating that it received a hit.</p>
<div><div><pre><code><span>for</span> <span>_</span> <span>=</span> <span>1</span><span>,</span> <span>3</span> <span>do</span>
  <span>local</span> <span>bullet</span> <span>=</span> <span>engine</span><span>:</span><span>spawn</span><span>(</span><span>&#34;bullet&#34;</span><span>)</span>
  <span>bullet</span><span>:</span><span>set_placement</span><span>(</span><span>-</span><span>128</span><span>,</span> <span>-</span><span>128</span><span>)</span>
  <span>bullet</span><span>:</span><span>on_update</span><span>(</span><span>function</span><span>(</span><span>self</span><span>)</span>
    <span>if</span> <span>self</span><span>.</span><span>x</span> <span>&gt;</span> <span>1200</span> <span>then</span>
      <span>postal</span><span>:</span><span>post</span><span>(</span><span>Mail</span><span>.</span><span>new</span><span>(</span><span>0</span><span>,</span> <span>&#34;bullet&#34;</span><span>,</span> <span>&#34;hit&#34;</span><span>))</span> <span>-- id 0 is the octopus</span>
      <span>bullet</span><span>:</span><span>unset_action</span><span>()</span>
      <span>bullet</span><span>:</span><span>set_placement</span><span>(</span><span>-</span><span>128</span><span>,</span> <span>-</span><span>128</span><span>)</span> <span>-- move to ouside the screen</span>
      <span>table.insert</span><span>(</span><span>bullet_pool</span><span>,</span> <span>bullet</span><span>)</span> <span>-- back to the pool</span>
    <span>end</span>
  <span>end</span><span>)</span>
  <span>table.insert</span><span>(</span><span>bullet_pool</span><span>,</span> <span>bullet</span><span>)</span>
<span>end</span>
</code></pre></div></div>
<p>On the octopus‚Äôs side, when it receives a ‚Äúhit‚Äù message, the entity triggers an explosion animation, switches to attack mode, and decreases its health by 1. If it reaches 0, it changes the animation to ‚Äúdead‚Äù.</p>
<div><div><pre><code><span>octopus</span><span>:</span><span>set_action</span><span>(</span><span>&#34;idle&#34;</span><span>)</span>
<span>octopus</span><span>:</span><span>set_placement</span><span>(</span><span>1200</span><span>,</span> <span>620</span><span>)</span>
<span>octopus</span><span>:</span><span>on_mail</span><span>(</span><span>function</span><span>(</span><span>self</span><span>,</span> <span>message</span><span>)</span>
  <span>if</span> <span>message</span> <span>==</span> <span>&#39;hit&#39;</span> <span>then</span>
    <span>bomb</span><span>()</span>
    <span>octopus</span><span>:</span><span>set_action</span><span>(</span><span>&#34;attack&#34;</span><span>)</span>
    <span>life</span> <span>=</span> <span>life</span> <span>-</span> <span>1</span>
    <span>if</span> <span>life</span> <span>&lt;=</span> <span>0</span> <span>then</span>
      <span>self</span><span>:</span><span>set_action</span><span>(</span><span>&#34;dead&#34;</span><span>)</span>
    <span>end</span>
  <span>end</span>
<span>end</span><span>)</span>
</code></pre></div></div>
<p>And finally, the player‚Äôs <code>on_update</code>, where I apply the velocity if any movement keys are pressed, or set the animation to idle if none are pressed.</p>
<p>We also have the projectile firing, where the fire function is called, taking an instance of a bullet from the pool, placing it in a semi-random position, and applying velocity.</p>
<div><div><pre><code><span>local</span> <span>function</span> <span>fire</span><span>()</span>
  <span>if</span> <span>#</span><span>bullet_pool</span> <span>&gt;</span> <span>0</span> <span>then</span>
    <span>local</span> <span>bullet</span> <span>=</span> <span>table.remove</span><span>(</span><span>bullet_pool</span><span>)</span>
    <span>local</span> <span>x</span> <span>=</span> <span>(</span><span>player</span><span>.</span><span>x</span> <span>+</span> <span>player</span><span>.</span><span>size</span><span>.</span><span>width</span><span>)</span> <span>-</span> <span>30</span>
    <span>local</span> <span>y</span> <span>=</span> <span>player</span><span>.</span><span>y</span> <span>+</span> <span>30</span>
    <span>local</span> <span>offset_y</span> <span>=</span> <span>(</span><span>math.random</span><span>(</span><span>-</span><span>2</span><span>,</span> <span>2</span><span>))</span> <span>*</span> <span>20</span>

    <span>bullet</span><span>:</span><span>set_placement</span><span>(</span><span>x</span><span>,</span> <span>y</span> <span>+</span> <span>offset_y</span><span>)</span>
    <span>bullet</span><span>:</span><span>set_velocity</span><span>(</span><span>Vector2D</span><span>.</span><span>new</span><span>(</span><span>0</span><span>.</span><span>6</span><span>,</span> <span>0</span><span>))</span>
    <span>bullet</span><span>:</span><span>set_action</span><span>(</span><span>&#34;default&#34;</span><span>)</span>

    <span>local</span> <span>sound</span> <span>=</span> <span>&#34;bomb&#34;</span> <span>..</span> <span>math.random</span><span>(</span><span>1</span><span>,</span> <span>2</span><span>)</span>
    <span>soundmanager</span><span>:</span><span>play</span><span>(</span><span>sound</span><span>)</span>
  <span>end</span>
<span>end</span>

<span>player</span><span>:</span><span>on_update</span><span>(</span><span>function</span><span>(</span><span>self</span><span>)</span>
  <span>local</span> <span>velocity</span> <span>=</span> <span>Vector2D</span><span>.</span><span>new</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>)</span>

  <span>if</span> <span>engine</span><span>:</span><span>is_keydown</span><span>(</span><span>KeyEvent</span><span>.</span><span>space</span><span>)</span> <span>then</span>
    <span>if</span> <span>not</span> <span>shooting</span> <span>then</span>
      <span>fire</span><span>()</span>
      <span>shooting</span> <span>=</span> <span>true</span>
    <span>end</span>
  <span>else</span>
    <span>shooting</span> <span>=</span> <span>false</span>
  <span>end</span>

  <span>if</span> <span>engine</span><span>:</span><span>is_keydown</span><span>(</span><span>KeyEvent</span><span>.</span><span>a</span><span>)</span> <span>then</span>
    <span>velocity</span><span>.</span><span>x</span> <span>=</span> <span>-</span><span>.</span><span>4</span>
  <span>elseif</span> <span>engine</span><span>:</span><span>is_keydown</span><span>(</span><span>KeyEvent</span><span>.</span><span>d</span><span>)</span> <span>then</span>
    <span>velocity</span><span>.</span><span>x</span> <span>=</span> <span>.</span><span>4</span>
  <span>end</span>

  <span>if</span> <span>velocity</span><span>:</span><span>moving</span><span>()</span> <span>then</span>
    <span>self</span><span>:</span><span>set_action</span><span>(</span><span>&#34;run&#34;</span><span>)</span>
    <span>if</span> <span>velocity</span><span>:</span><span>left</span><span>()</span> <span>then</span>
      <span>self</span><span>:</span><span>set_flip</span><span>(</span><span>Flip</span><span>.</span><span>horizontal</span><span>)</span>
    <span>else</span>
      <span>self</span><span>:</span><span>set_flip</span><span>(</span><span>Flip</span><span>.</span><span>none</span><span>)</span>
    <span>end</span>
  <span>elseif</span> <span>velocity</span><span>:</span><span>zero</span><span>()</span> <span>then</span>
    <span>self</span><span>:</span><span>set_action</span><span>(</span><span>&#34;idle&#34;</span><span>)</span>
  <span>end</span>

  <span>self</span><span>:</span><span>set_velocity</span><span>(</span><span>velocity</span><span>)</span>
<span>end</span><span>)</span>
</code></pre></div></div>
<h3 id="in-the-end">In The End</h3>
<p>In the end, he requested some <em>minor</em> tweaks, such as the projectile being the princess sprite, the target being the player, and the entity that shoots being the green octopus. ü§∑‚Äç‚ôÇÔ∏è</p>
<p><img src="https://nullonerror.org/public/2024-10-08-my-first-game-with-carimbo/tweaks.jpeg" alt="Tweaks"/></p>
</article>

</main>

</div></div>
  </body>
</html>
