<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erikarow.land/notes/bash-completion">Original</a>
    <h1>Bash Completion</h1>
    
    <div id="readability-page-1" class="page"><section id="Bash-Completion">

<p>This week, I’ve been exploring how tab completion works in Bash. 
I knew that it was possible to generate bash completions for command line utilities,
but I never knew how it worked.</p>
<p>So I cracked open the source code for <a href="https://click.palletsprojects.com/en/8.1.x/"><code>click</code></a>, a python framework for command line applications that had shell completion as a feature. Helpfully, the shell completions were contained in <a href="https://github.com/pallets/click/blob/d0af32d8e7d78f4fdaf9c3d1559e1ffaac1b2569/src/click/shell_completion.py#L92"><code>shell_completion.py</code></a>.<label for="fn1"></label>

<span>
</span>
</p>
<p>The most helpful line was one that looked like this:</p>
<pre><code>complete -o nosort -F complete_function program_name
</code></pre>
<p>With both precise <code>completion_function</code> and <code>program_name</code> determined by the installation of the <code>click</code> application.</p>
<p><code>complete</code> is a bash builtin, but <code>help complete</code> provides little detail as to how it works. In particular, there’s no mention of the <code>-F</code> flag that <code>click</code> uses.</p>
<section id="Info-to-the-Rescue">
<h2>Info to the Rescue</h2>
<p>While <code>help</code> proved to be unhelpful, 
<code>info</code> a tool I knew about, 
but hadn’t previously explored, 
had exactly what I needed.</p>
<p><a href="https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion.html">Section 8.6</a> Programmable Completion and <a href="https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion-Builtins.html">Section 8.7</a> Programmable Completion Builtins proved to share exactly what I wanted to know.<label for="fn2"></label>

<span>
</span>
</p>
<p>Let’s walk through our line of bash from before:</p>
<section id="complete-program_name">
<h3><code>complete program_name</code></h3>
<p><code>complete</code> works by registering completions for a particular <code>name</code>, in most cases this is the builtin or program that we want completions for.
Once those completions are registered, the particular method defined will work every time completion is invoked, typically by the the <code>tab</code> key.</p>
</section>
<section id="o-nosort">
<h3><code>-o nosort</code></h3>
<p><code>-o</code> sets a <code>comp-option</code> with specifies extra behavior for <code>complete</code>.</p>
<p>In this case, <code>-o nosort</code> tells <code>complete</code> not to sort the completions array that it receives.
In this case, it allows <code>click</code> to precisely control the order of completions that it shows.</p>
</section>
<section id="F-complete_function">
<h3><code>-F complete_function</code></h3>
<p>This is most interesting part of <code>complete</code>’s behavior.
<code>-F</code> specifies a bash function that will be invoked when completions are asked for on the registered name.</p>
<p>This function receives three arguments from <code>complete</code>:</p>
<ul>
<li>
<code>$1</code> is set to the the name of command which is receiving completions.
</li>
<li>
<code>$2</code> is set to the word being completed.
</li>
<li>
<code>$3</code> is set to the word preceding the word being completed.
</li>
</ul>
<p><code>$3</code> allows for the invoked function to handle nested commands, such as <code>git</code>’s <code>branch</code> which will complete on available branches for the repo.</p>
<p>When the function finishes, the completions are retrieved from the value of the <code>COMPREPLY</code> array variable.</p>
</section>
</section>
<section id="Putting-it-together">
<h2>Putting it together</h2>
<p>I now had a mental model of how the completions worked, but I wanted to solidify my knowledge by creating a minimal example.</p>
<p>My <code>name</code>d command will be <code>my_echo</code>, a shell wrapper around <code>echo</code>.</p>
<pre><code>#!/usr/bin/env bash
echo $1
</code></pre>
<p>With that in mind, I wrote the following bash:</p>
<pre><code>_my_echo_complete() {
  local options=(&#34;hello&#34; &#34;hear&#34; &#34;world&#34; &#34;today&#34;)
  for option in ${options[*]};
  do
    COMPREPLY+=($(echo &#34;$option&#34; | grep $2));
  done
}

_my_echo_setup() {
  complete -F _my_echo_complete my_echo
}

_my_echo_setup
</code></pre>
<p>I hadn’t worked with bash arrays before, so it took some experimentation to learn about <code>()</code> to create an array.
Note that the parenthesis are used both for <code>options</code> and next to the <code>+=</code> on <code>COMPREPLY</code>.</p>
<p>The <code>[*]</code> operator inside <code>${options[*]}</code> unpacks the array so that <code>for</code> can iterate through it.</p>
<p>Once I wrote this bash, I added it to a file called <code>complete_function</code> which I then sourced:</p>
<pre><code>$ source complete_function
</code></pre>
<p><img alt="bash completion example gif" src="https://matan-h.com/bash_completion_example.gif"/></p>
<p>This version still has issues (hitting tab with no input makes grep throw error once for every item in the array),
but it’s a working version of tab completion for a program I “wrote”.</p>
<p>I look forward to trying to add tab completion in bash to future tools.<label for="fn3"></label>

<span>
</span>
</p>
</section>
</section></div>
  </body>
</html>
