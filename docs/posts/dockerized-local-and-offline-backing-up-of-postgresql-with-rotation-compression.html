<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/efrecon/pgbackup">Original</a>
    <h1>Dockerized local and offline backing up of PostgreSQL with rotation, compression</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">This project covers two intertwined use cases:</p>
<ol dir="auto">
<li>Continuous and regular dumps of one or all <a href="https://www.postgresql.org/" rel="nofollow">PostgreSQL</a> databases at a given
host in a format that permits recovery in case of disasters.  This is
<code>backup.sh</code>.</li>
<li>Continuous and regular copying of these dumps in a compressed form to a
(supposedly) remote directory in order to facilitate offsite backup and
recovery in case of disasters. This is <code>offsite.sh</code>.</li>
</ol>
<p dir="auto">The project is tuned for usage within a Dockerised environment and each tool
described below performs only one backup or compression.  Typical scenarios will
periodically restart containers based on this image using a host-wide cron-like
daemon such as <a href="https://github.com/efrecon/dockron">dockron</a>.</p>
<h2 tabindex="-1" id="user-content-example" dir="auto"><a href="#example">Example<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<p dir="auto">An example <a href="https://docs.docker.com/compose/" rel="nofollow">compose</a> file is provided as a plausible real-life scenario.  The
file <code>docker-compose.yml</code> starts up the following containers:</p>
<ol dir="auto">
<li><code>db</code>, an instance of the PostgreSQL database.</li>
<li><code>pgbackup</code>, which runs <code>backup.sh</code> once and will perform a backup of all
databases when it starts.</li>
<li><code>davbackup</code>, which runs <code>offsite.sh</code> once and will copy the latest backup to
another volume in compressed form. This could be a WebDAV mounted volume,
even though it isn&#39;t since this is just an example.</li>
<li><code>pulse</code>, runs an instance of <code>efrecon/dockron</code> and will restart the two
previous containers from time to time so they can regularly perform their
operations.</li>
</ol>
<h2 tabindex="-1" id="user-content-usage-and-command-line-options" dir="auto"><a href="#usage-and-command-line-options">Usage and Command-Line Options<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h2>
<h3 tabindex="-1" id="user-content-backupsh" dir="auto"><a href="#backupsh"><code>backup.sh</code><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">This shell (not bash) script has the following options:</p>
<div data-snippet-clipboard-copy-content="Description:
  backup.sh will backup one or all PostgreSQL databases at a given (remote)
  host, and rotate dumps to keep disk usage under control.

Usage:
  backup.sh [-option arg]...

  where all dash-led single options are as follows:
    -v              Be more verbose
    -h host         Specify host to connect to, defaults to localhost
    -p port         Specify port of daemon, defaults to 5432
    -u user         User to authenticate with at database, defaults to postgres.
    -w password     Password for user, defaults to empty
    -W path         Same as -w, but read content of password from file instead
    -d destination  Directory where to place (and rotate) backups.
    -n basename     Basename for file to create, date-tags allowed, defaults to: %Y%m%d-%H%M%S.sql
    -k keep         Number of backups to keep, defaults to empty, meaning keep all backups
    -b database     Name of database to backup, defaults to empty, meaning all databases
    -t command      Command to execute once done, path to backup will be passed as an argument.
    -o output       Output type: sql or csv (only tables content)."><pre><code>Description:
  backup.sh will backup one or all PostgreSQL databases at a given (remote)
  host, and rotate dumps to keep disk usage under control.

Usage:
  backup.sh [-option arg]...

  where all dash-led single options are as follows:
    -v              Be more verbose
    -h host         Specify host to connect to, defaults to localhost
    -p port         Specify port of daemon, defaults to 5432
    -u user         User to authenticate with at database, defaults to postgres.
    -w password     Password for user, defaults to empty
    -W path         Same as -w, but read content of password from file instead
    -d destination  Directory where to place (and rotate) backups.
    -n basename     Basename for file to create, date-tags allowed, defaults to: %Y%m%d-%H%M%S.sql
    -k keep         Number of backups to keep, defaults to empty, meaning keep all backups
    -b database     Name of database to backup, defaults to empty, meaning all databases
    -t command      Command to execute once done, path to backup will be passed as an argument.
    -o output       Output type: sql or csv (only tables content).
</code></pre></div>
<p dir="auto">When the <code>output</code> type is <code>sql</code>, an entire dump of the database(s) will be
generated using <a href="https://www.postgresql.org/docs/10/static/app-pgdump.html" rel="nofollow"><code>pg_dump</code></a> or <a href="https://www.postgresql.org/docs/10/static/app-pg-dumpall.html" rel="nofollow"><code>pg_dumpall</code></a>. When the <code>output</code>
type is <code>csv</code>, a sub-directory of the <code>destination</code> directory will be created
using the <code>basename</code>. Under this directory, there will be as many directories
created as there are databases to dump, with the same name as the database. In
these, one file for each table will be created, with the same name as the table
and the extension <code>.csv</code>.</p>
<p dir="auto">CSV output do <strong>not</strong> capture anything else than the data itself, meaning that
no functions, triggers, etc. can be backed up using this mechanism.</p>
<h3 tabindex="-1" id="user-content-offsitesh" dir="auto"><a href="#offsitesh"><code>offsite.sh</code><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto">This shell (not bash) script has the following options:</p>
<div data-snippet-clipboard-copy-content="Description:
  offline.sh will compress the latest file matching a pattern, compress it,
  move it to a destination directory and rotate files in this directory
  to keep disk space under control. Compression via zip is preferred,
  otherwise gzip.

Usage:
  offline.sh [-option arg] pattern

  where all dash-led single options are as follows:
    -v              Be more verbose
    -d destination  Directory where to place (and rotate) compressed copies, default to current dir
    -k keep         Number of compressed copies to keep, defaults to empty, meaning all
    -c level        Compression level, defaults to 0, meaning no compression
    -w password     Password for compressed archive, only when zip available
    -W path         Same as -w, but read content of password from file instead
    -t command      Command to execute once done, path to copy will be passed as an argument"><pre><code>Description:
  offline.sh will compress the latest file matching a pattern, compress it,
  move it to a destination directory and rotate files in this directory
  to keep disk space under control. Compression via zip is preferred,
  otherwise gzip.

Usage:
  offline.sh [-option arg] pattern

  where all dash-led single options are as follows:
    -v              Be more verbose
    -d destination  Directory where to place (and rotate) compressed copies, default to current dir
    -k keep         Number of compressed copies to keep, defaults to empty, meaning all
    -c level        Compression level, defaults to 0, meaning no compression
    -w password     Password for compressed archive, only when zip available
    -W path         Same as -w, but read content of password from file instead
    -t command      Command to execute once done, path to copy will be passed as an argument
</code></pre></div>
<h3 tabindex="-1" id="user-content-docker" dir="auto"><a href="#docker">Docker<svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></h3>
<p dir="auto"><code>multi.sh</code> is specified as the default entrypoint for the image; it relays both
scripts.  The following command would for example request <code>backup.sh</code> for help:</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run -it --rm efrecon/pgbackup backup -?"><pre>docker run -it --rm efrecon/pgbackup backup -<span>?</span></pre></div>
<p dir="auto">By default, the Docker image encapsulates <code>multi.sh</code> behind <a href="https://github.com/krallin/tini"><code>tini</code></a> so
that it will be able to properly terminate sub-processes when stopping the
container.</p>
<p dir="auto">In a typical Docker environment, database initialisation takes time. This means
that depending on the database container will not be enough. The Docker image
for this project provides a <a href="https://gist.github.com/efrecon/86456960e2110b287632fd7f42c1cd31">script</a> aiming at waiting for the connection to the
postgres database to be responsive. How to perform this and chain it behind
<code>tini</code> is exemplified in the <code>docker-compose.yml</code> file.</p>
</article>
          </div></div>
  </body>
</html>
