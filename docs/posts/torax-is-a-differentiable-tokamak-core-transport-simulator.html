<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/google-deepmind/torax">Original</a>
    <h1>TORAX is a differentiable tokamak core transport simulator</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><a href="https://github.com/google-deepmind/torax/actions/workflows/pytest.yml"><img src="https://github.com/google-deepmind/torax/actions/workflows/pytest.yml/badge.svg" alt="Unittests"/></a></p>

<p dir="auto">TORAX is a differentiable tokamak core transport simulator aimed for fast and accurate forward modelling, pulse-design, trajectory optimization, and controller design workflows. TORAX is written in Python-JAX, with the following motivations:</p>
<ul dir="auto">
<li>Open-source and extensible, aiding with flexible workflow coupling</li>
<li>JAX provides auto-differentiation capabilities and code compilation for fast runtimes. Differentiability allows for gradient-based nonlinear PDE solvers for fast and accurate modelling, and for sensitivity analysis of simulation results to arbitrary parameter inputs, enabling applications such as trajectory optimization and data-driven parameter identification for semi-empirical models. Auto-differentiability allows for these applications to be easily extended with the addition of new physics models, or new parameter inputs, by avoiding the need to hand-derive Jacobians</li>
<li>Python-JAX is a natural framework for the coupling of ML-surrogates of physics models</li>
</ul>
<p dir="auto">For more comprehensive documentation, see our <a href="https://torax.readthedocs.io/" rel="nofollow">readthedocs page</a>.</p>
<p dir="auto">TORAX now has the following physics feature set:</p>
<ul dir="auto">
<li>Coupled PDEs of ion and electron heat transport, electron particle transport, and current diffusion
<ul dir="auto">
<li>Finite-volume-method</li>
<li>Multiple solver options: linear with Pereverzev-Corrigan terms, nonlinear with Newton-Raphson, nonlinear with optimization using the jaxopt library</li>
</ul>
</li>
<li>Ohmic power, ion-electron heat exchange, fusion power, bootstrap current with the analytical Sauter model</li>
<li>Time dependent boundary conditions and sources</li>
<li>Coupling to the QLKNN10D <a href="https://doi.org/10.1063/1.5134126" rel="nofollow">[van de Plassche et al, Phys. Plasmas 2020]</a> QuaLiKiz-neural-network surrogate for physics-based turbulent transport</li>
<li>General geometry, provided via CHEASE equilibrium files
<ul dir="auto">
<li>For testing and demonstration purposes, a single CHEASE equilibrium file is available in the data/geo directory. It corresponds to an ITER hybrid scenario equilibrium based on simulations in <a href="https://doi.org/10.1088/0029-5515/50/11/115007" rel="nofollow">[Citrin et al, Nucl. Fusion 2010]</a>, and was obtained from <a href="https://gitlab.com/qualikiz-group/pyntegrated_model" rel="nofollow">PINT</a>. A PINT license file is available in data/geo.</li>
</ul>
</li>
</ul>
<p dir="auto">Additional heating and current drive sources can be provided by prescribed formulas, or user-provided analytical models.</p>
<p dir="auto">Model implementation was verified through direct comparison of simulation outputs to the RAPTOR <a href="https://iopscience.iop.org/article/10.1088/0741-3335/54/2/025002" rel="nofollow">[Felici et al, Plasma Phys. Control. Fusion 2012]</a> tokamak transport simulator.</p>
<p dir="auto">This is not an officially supported Google product.</p>

<p dir="auto">Short term development plans include:</p>
<ul dir="auto">
<li>Time dependent geometry</li>
<li>More flexible initial conditions</li>
<li>Implementation of forward sensitivity calculations w.r.t. control inputs and parameters</li>
<li>Implementation of persistent compilation cache for CPU</li>
<li>More extensive documentation and tutorials</li>
<li>Visualisation improvements</li>
</ul>
<p dir="auto">Longer term desired features include:</p>
<ul dir="auto">
<li>Sawtooth model (Porcelli + reconnection)</li>
<li>Neoclassical tearing modes (modified Rutherford equation)</li>
<li>Radiation sinks
<ul dir="auto">
<li>Cyclotron radiation</li>
<li>Bremsstrahlung</li>
<li>Line radiation</li>
</ul>
</li>
<li>Neoclassical transport + multi-ion transport, with a focus on heavy impurities</li>
<li>IMAS coupling</li>
<li>Stationary-state solver</li>
<li>Momentum transport</li>
</ul>
<p dir="auto">Contributions in line with the roadmap are welcome. In particular, TORAX is envisaged as a natural framework for coupling of various ML-surrogates of physics models. These could include surrogates for turbulent transport, neoclassical transport, heat and particle sources, line radiation, pedestal physics, and core-edge integration, MHD, among others.</p>


<p dir="auto">Install Python 3.10 or greater.</p>
<p dir="auto">Make sure that tkinter is installed:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt-get install python3-tk"><pre>sudo apt-get install python3-tk</pre></div>

<p dir="auto">Install virtualenv (if not already installed):</p>
<div dir="auto" data-snippet-clipboard-copy-content="pip install --upgrade pip"><pre>pip install --upgrade pip</pre></div>

<p dir="auto">Create a code directory where you will install the virtual env and other TORAX
dependencies.</p>
<div dir="auto" data-snippet-clipboard-copy-content="mkdir /path/to/torax_dir &amp;&amp; cd &#34;$_&#34;"><pre>mkdir /path/to/torax_dir <span>&amp;&amp;</span> <span>cd</span> <span><span>&#34;</span><span>$_</span><span>&#34;</span></span></pre></div>
<p dir="auto">Where <code>/path/to/torax_dir</code> should be replaced by a path of your choice.</p>
<p dir="auto">Create a TORAX virtual env:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 -m venv toraxvenv"><pre>python3 -m venv toraxvenv</pre></div>
<p dir="auto">Activate the virtual env:</p>
<div dir="auto" data-snippet-clipboard-copy-content="source toraxvenv/bin/activate"><pre><span>source</span> toraxvenv/bin/activate</pre></div>
<p dir="auto">Download QLKNN dependencies:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://gitlab.com/qualikiz-group/qlknn-hyper.git"><pre>git clone https://gitlab.com/qualikiz-group/qlknn-hyper.git</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="export TORAX_QLKNN_MODEL_PATH=&#34;$PWD&#34;/qlknn-hyper"><pre><span>export</span> TORAX_QLKNN_MODEL_PATH=<span><span>&#34;</span><span>$PWD</span><span>&#34;</span></span>/qlknn-hyper</pre></div>
<p dir="auto">It is recommended to automate the environment variable export. For example, if using bash, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="echo export TORAX_QLKNN_MODEL_PATH=&#34;$PWD&#34;/qlknn-hyper &gt;&gt; ~/.bashrc"><pre><span>echo</span> <span>export</span> TORAX_QLKNN_MODEL_PATH=<span><span>&#34;</span><span>$PWD</span><span>&#34;</span></span>/qlknn-hyper <span>&gt;&gt;</span> <span>~</span>/.bashrc</pre></div>
<p dir="auto">The above command only needs to be run once on a given system.</p>
<p dir="auto">Download and install the TORAX codebase via http:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/google-deepmind/torax.git"><pre>git clone https://github.com/google-deepmind/torax.git</pre></div>
<p dir="auto">or ssh (ensure that you have the appropriate SSH key uploaded to github).</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone git@github.com:google-deepmind/torax.git"><pre>git clone git@github.com:google-deepmind/torax.git</pre></div>
<p dir="auto">Enter the TORAX directory and pip install the dependencies.</p>
<div dir="auto" data-snippet-clipboard-copy-content="cd torax; pip install -e ."><pre><span>cd</span> torax<span>;</span> pip install -e <span>.</span></pre></div>
<p dir="auto">If you want to install with the dev dependencies (useful for running <code>pytest</code>
and installing <code>pyink</code> for lint checking), then run with the <code>[dev]</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="cd torax; pip install -e .[dev]"><pre><span>cd</span> torax<span>;</span> pip install -e .[dev]</pre></div>
<p dir="auto">Optional: Install additional GPU support for JAX if your machine has a GPU:
<a href="https://jax.readthedocs.io/en/latest/installation.html#supported-platforms" rel="nofollow">https://jax.readthedocs.io/en/latest/installation.html#supported-platforms</a></p>

<p dir="auto">The following command will run TORAX using the default configuration file
<code>examples/basic_config.py</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 run_simulation_main.py \
   --config=&#39;torax.examples.basic_config&#39; --log_progress"><pre>python3 run_simulation_main.py \
   --config=<span><span>&#39;</span>torax.examples.basic_config<span>&#39;</span></span> --log_progress</pre></div>
<p dir="auto">To run more involved, ITER-inspired simulations, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 run_simulation_main.py \
   --config=&#39;torax.examples.iterhybrid_rampup&#39; --log_progress"><pre>python3 run_simulation_main.py \
   --config=<span><span>&#39;</span>torax.examples.iterhybrid_rampup<span>&#39;</span></span> --log_progress</pre></div>
<p dir="auto">and</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 run_simulation_main.py \
   --config=&#39;torax.examples.iterhybrid_predictor_corrector&#39; --log_progress"><pre>python3 run_simulation_main.py \
   --config=<span><span>&#39;</span>torax.examples.iterhybrid_predictor_corrector<span>&#39;</span></span> --log_progress</pre></div>
<p dir="auto">Additional configuration is provided through flags which append the above run command, and environment variables:</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Set environment variables</h3><a id="user-content-set-environment-variables" aria-label="Permalink: Set environment variables" href="#set-environment-variables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Path to the QuaLiKiz-neural-network parameters. Note: if installation instructions above were followed, this may already be set.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export TORAX_QLKNN_MODEL_PATH=&#34;&lt;myqlknnmodelpath&gt;&#34;"><pre>$ <span>export</span> TORAX_QLKNN_MODEL_PATH=<span><span>&#34;</span>&lt;myqlknnmodelpath&gt;<span>&#34;</span></span></pre></div>
<p dir="auto">Path to the geometry file directory. This prefixes the path and filename provided in the <code>geometry_file</code> geometry constructor argument in the run config file. If not set, <code>TORAX_GEOMETRY_DIR</code> defaults to the relative path <code>torax/data/third_party/geo</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export TORAX_GEOMETRY_DIR=&#34;&lt;mygeodir&gt;&#34;"><pre>$ <span>export</span> TORAX_GEOMETRY_DIR=<span><span>&#34;</span>&lt;mygeodir&gt;<span>&#34;</span></span></pre></div>
<p dir="auto">If true, error checking is enabled in internal routines. Used for debugging. Default is false since it is incompatible with the persistent compilation cache.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export TORAX_ERRORS_ENABLED=&lt;True/False&gt;"><pre>$ <span>export</span> TORAX_ERRORS_ENABLED=<span>&lt;</span>True/False<span>&gt;</span></pre></div>
<p dir="auto">If false, JAX does not compile internal TORAX functions. Used for debugging. Default is true.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ export TORAX_COMPILATION_ENABLED=&lt;True/False&gt;"><pre>$ <span>export</span> TORAX_COMPILATION_ENABLED=<span>&lt;</span>True/False<span>&gt;</span></pre></div>

<p dir="auto">Output simulation time, dt, and number of stepper iterations (dt backtracking with nonlinear solver) carried out at each timestep.</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 run_simulation_main.py \
   --config=&#39;torax.examples.iterhybrid_predictor_corrector&#39; \
   --log_progress"><pre>python3 run_simulation_main.py \
   --config=<span><span>&#39;</span>torax.examples.iterhybrid_predictor_corrector<span>&#39;</span></span> \
   --log_progress</pre></div>
<p dir="auto">Live plotting of simulation state and derived quantities.</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 run_simulation_main.py \
   --config=&#39;torax.examples.iterhybrid_predictor_corrector&#39; \
   --plot_progress"><pre>python3 run_simulation_main.py \
   --config=<span><span>&#39;</span>torax.examples.iterhybrid_predictor_corrector<span>&#39;</span></span> \
   --plot_progress</pre></div>
<p dir="auto">Combination of the above.</p>
<div dir="auto" data-snippet-clipboard-copy-content="python3 run_simulation_main.py \
   --config=&#39;torax.examples.iterhybrid_predictor_corrector&#39; \
   --log_progress --plot_progress"><pre>python3 run_simulation_main.py \
   --config=<span><span>&#39;</span>torax.examples.iterhybrid_predictor_corrector<span>&#39;</span></span> \
   --log_progress --plot_progress</pre></div>

<p dir="auto">Once complete, the time history of a simulation state and derived quantities is written to <code>state_history.nc</code>. The output path is written to stdout.</p>
<p dir="auto">To take advantage of the in-memory (non-persistent) cache, the process does not end upon simulation termination. It is possible to modify the runtime_params, toggle the <code>log_progress</code> and <code>plot_progress</code> flags, and rerun the simulation. Only the following modifications will then trigger a recompilation:</p>
<ul dir="auto">
<li>Grid resolution</li>
<li>Evolved variables (equations being solved)</li>
<li>Changing internal functions used, e.g. transport model, or time_step_calculator</li>
</ul>

<p dir="auto">You can get out of the Python virtual env by deactivating it:</p>


<p dir="auto">Under construction</p>

<p dir="auto">A technical report is in preparation and will soon be made available for citing.</p>
</article></div></div>
  </body>
</html>
