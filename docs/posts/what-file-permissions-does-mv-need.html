<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="http://iafisher.com/blog/2024/11/mv-file-permissions">Original</a>
    <h1>What file permissions does mv need?</h1>
    
    <div id="readability-page-1" class="page"><div class="page">
  <header>
  <a href="http://iafisher.com/">home</a>
  <a href="http://iafisher.com/blog">blog</a>
  <a href="http://iafisher.com/portfolio">portfolio</a>
  <a href="https://outsiderart.substack.com/" target="_blank">outsider art</a>
  <a href="https://github.com/iafisher" target="_blank">github</a>
</header>


  
  

  <p>What Unix file permissions are required for <code>mv path/to/src/file path/to/dest</code>, assuming that <code>dest/</code> is an existing directory that is not <code>src/</code>?</p>
<p>Neither I nor ChatGPT nor any of the dozen programmers I asked could give a completely correct answer off the top of their heads.</p>
<p>If you&#39;d like, take a moment to think about it for yourself. Otherwise, scroll down to see the answer.</p>


<ol>
<li><code>+w</code> on <code>src/</code> and <code>dest/</code></li>
<li><code>+x</code> on <em>every</em> directory named in <code>path/to/src/</code> and <code>path/to/dest/</code>, including the implicit current directory for relative paths</li>
<li>If <code>file</code> is a directory on the same filesystem as <code>dest/</code>, <code>+w</code> on <code>file</code></li>
<li>If <code>src/</code> has the sticky bit set, then you must be either the owner of <code>file</code> or the owner of <code>src/</code></li>
<li>If <code>src/</code> and <code>dest/</code> are on different filesystems, then <code>+r</code> on <code>file</code></li>
<li>If <code>src/</code> and <code>dest/</code> are on different filesystems and <code>file</code> is a directory, then <code>+r</code> on every regular file and directory in <code>file</code> (and all subdirectories), and <code>+wx</code> on every non-empty directory.</li>
</ol>
<p><em>(This was tested on Linux and macOS. <a href="mailto:ian@iafisher.com">Email me</a> if you think I&#39;ve missed something.)</em></p>
<p>Commentary:</p>
<ul>
<li>Many thought you needed permissions on <code>f</code> itself, but – aside from the edge cases #3 and #5 – you do not, because renaming a file does not require either reading or altering its contents, only the contents of the source and target directories (hence #1).</li>
<li>Quite a few people had a vague idea that <em>execute</em> permissions had some special meaning for directories, but only a couple specifically knew that they are needed to access paths within that directory, and no one mentioned that you need <em>execute</em> not just on <code>src/</code> and <code>dest/</code> but also all the other directories in the path.</li>
<li>No one remembered #3. Admittedly, it&#39;s a bit of an <em>ad hoc</em> requirement that only exists because a directory has a special <code>..</code> entry that points to its parent, which must be updated if a directory is moved. Interestingly, if <code>src/</code> and <code>dest/</code> are the same, <code>+w</code> is required on macOS but not on Linux.</li>
<li>#4 sounds like arcana, but it applies to at least one very well-known directory: <code>/tmp</code>. The sticky bit is intended for shared directories so that a user cannot interfere with others&#39; files – hence the ownership permissions required.</li>
<li>Likewise, #5 and #6 apply to <code>/tmp</code>, which is typically mounted as its own filesystem. The <code>rename</code> syscall doesn&#39;t work across filesystems, so the <code>mv</code> command emulates it by reading the source file, unlinking it from the source directory, and recreating it in the target directory. Because it has to read the contents of the file, <code>+r</code> permissions are necessary.</li>
</ul>
<p>What does it mean for me?</p>
<ul>
<li>#2 applies to accessing paths generally, so it&#39;s good to know besides its implications for <code>mv</code>.</li>
<li>To prevent others from moving files out of a directory (or renaming them), deny them <em>write</em> permissions.</li>
<li>You should probably be aware that <code>mv</code> does something completely different when moving between filesystems (another implication is that it is not atomic). You should probably also be aware that <code>/tmp</code> is typically a different filesystem.</li>
<li>If you are trying to <code>mv</code> something and hitting a permissions error, you may need to work your way through this list.</li>
</ul>
<h2>Further reading</h2>
<ul>
<li><a href="https://linux.die.net/man/2/rename"><code>man 2 rename</code></a> covers the first three requirements under <code>EACCES</code> in the &#34;Errors&#34; section.</li>
<li><a href="https://linux.die.net/man/7/path_resolution"><code>man 7 path_resolution</code></a> describes the Linux path resolution process.</li>
<li><a href="https://dotat.at/@/2024-10-22-tmp.html">&#34;against <code>/tmp</code>&#34;</a> covers the meaning of the sticky bit.</li>
<li>Sections 4.5 and 4.15 of <em>Advanced Programming in the Unix Environment</em> cover Unix file permissions and <code>rename</code>, respectively. ∎</li>
</ul>

  
</div></div>
  </body>
</html>
