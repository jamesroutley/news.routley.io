<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cceckman.com/writing/rust-iterator-optimizations/">Original</a>
    <h1>Rust Iterator Optimizations</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>I recently read Nicole Tietz-Sokolskaya’s article <a href="https://ntietz.com/blog/rusts-iterators-optimize-footgun/">“Rust’s iterators optimize nicely—and contain a footgun”</a>.
It’s a great investigation – read it before continuing!</p>
<p>Her conclusion is:</p>
<blockquote>
<p>Rust will optimize iterator usage in much the same way that Haskell does. It will combine arbitrary iterator usage and reduce it down to a for loop. That’s pretty neat!</p>
</blockquote>
<p>I agree, that’s neat! She also asks:</p>
<blockquote>
<p>Now, how does it do it? That’s beyond my expertise. It happens somewhere in the compiler. I’d love to find that out, though!</p>
</blockquote>
<p>I’ve been doing some work with LLVM’s optimization pipelines recently, so I thought I knew the answer.
(Spoiler: I was right!) I played around with <a href="https://godbolt.org">Compiler Explorer</a> to confirm, and learned some more about how to use it along the way.
Here’s what I found!</p>
<h2 id="hypothesis-monomorphization-and-inlining">Hypothesis: Monomorphization and inlining</h2>
<p>My hypothesis was that this comes from a combinination of two techniques:
<em>monomorphization</em> in the Rust compiler, and <em>inlining</em> in the LLVM optimizer.</p>
<p>The Rust compiler <a href="https://en.wikipedia.org/wiki/Monomorphization">monomorphizes</a> generic types
and functions (all the things with <code>&lt;...&gt;</code> in their name). With a type or function <code>MyGeneric&lt;X: ...&gt;</code>,
Rust creates a new type for each fill of <code>X</code> (<code>MyGeneric&lt;Foo&gt;</code>, <code>MyGeneric&lt;Bar&gt;</code>), and treats
them separately down the line: when typechecking, when generating code, etc.</p>
<p>For <a href="https://doc.rust-lang.org/std/iter/struct.Map.html"><code>Iterator::map()</code></a>, <a href="https://doc.rust-lang.org/std/iter/struct.Filter.html"><code>Iterator::filter()</code></a>, and similar combinators, that means filling in the type of
the underlying iterator (<code>my_iter</code> in <code>my_iter.map(f)</code>) and the functor applied (<code>f</code> in <code>my_iter.map(f)</code>).
These concrete types are <em>probably</em> only used in one place: where the <em>particular</em> functor <code>f</code> is applied.</p>
<p>When the Rust compiler is done with doing “Rust stuff” (type checking, borrow checking…),
it outputs to a codegen backend to optimize and compile machine code. By default, this
backend is <a href="https://llvm.org">LLVM</a>, so the Rust compiler outputs code in the <a href="https://llvm.org/docs/LangRef.html">LLVM Intermediate Representation</a>.</p>
<p>The LLVM optimizer can see when a function is only called in one place: the monomorphized <code>Map&lt;MyArray, F1&gt;::next</code>
is only called from <code>Filter&lt;Map&lt;MyArray, F1&gt;, F2&gt;::next</code>, which is only called from <code>my_example</code>. In these cases,
instead of paying the overhead of a function call, the compiler might chose to <em>inline</em> the code from the callee,
into the caller; and then optimize that caller further.</p>
<p>I thought between these two techniques, the Rust compiler and LLVM optimizer would get <em>most</em> of the way towards
“all these functions are the same”; additional optimizations would drive them even closer together.</p>
<p>Turns out – yes, as far as I can tell! Let’s see it in action!</p>
<h2 id="monomorphization-experimentally">Monomorphization, experimentally</h2>
<p>Matt Godbolt et al.’s <a href="https://godbolt.org">Compiler Explorer</a> is a purpose-built tool for this kind of
investigation: taking a small code sample, and seeing how the code is treated by different stages of compilation.</p>
<p>I’m using <code>rustc 1.78.0</code> as the Rust compiler, which <em>should</em> lead to pretty consistent output below;
<a href="https://cceckman.com">let me know</a> if you spot any errors!</p>
<p>I’ll take a slightly different example than Nicole’s code for this, to start off with.
Check <a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQAJnLOAGQImbAA5TwAjbFJfPwAHdCViByY3Dy9fcgSk%2ByEgkPC2KJifPxtsOxSRIhZSIjTPbzLsW1ymatqifLDI6NjrGrqGjLLBruCeor7SgEprdDNSVE4uAFIfAGZVgFYAIWD6CYgQgDdomZ2AEVWtAEEaJgBqOI8lAH1sM6YlCBnH1YA7LsbrdHmDHowiI91Ep/htLv89jxyI8/I8NijZI9tldVhtgXdwdClAA6YjRX4golEkl0ehECmAlzqJmPABU6n%2BPm2qLh13hjy0F0J1LBJLYLDiECZLIBLmhXN2jx4wtBosetLIHxYqCQ0rlsvlcVIwSI9CYYEg6x8gOBAOupRR6hmF3xIMB1zu7s2O32TEOIWOn3OuLuD0ebGCFjeWEwPz%2Btqp4MhxL5iN2yNRKIxjyxOO2/IJarBMLJDNIlJFotpDHL%2BuZrI5XJ5Pj5eIRKqT1YlUplrM5AFplar1RrBKRtbr64bnibhObLdLSon7danS68UWPe67nEzBFHuGJcFfv8gV3nq8Pl945uL5GmNHY7e3V77Vw5vRuNt%2BN5ePx0G4AAlCwoSUBYlmwLkNj4cgiG0D85gAaxAbYtEMbhpH4NhUPQv8dHIQCuH4JQQHQ%2BCuB0OY4FgFAMDYOIGGiShqHoxjGBiUgeABAAOdC6XLUiIAiBDyAiYJagAT24WDxNYUhJIAeQiXQKgo2D6I4YRFP9aTKP4HAIjMYAXAkehSP/cgcAlExJH0qyCFINSCDOCyCOwdQKjMBkZP4U0WlEw4IlIKS3BwUSiBNHDLLOUgIkSbBLmwGzgADUB9LmGgjGAJQADUCGwAB3RS4mYXy5GEMQJE4GQKsUFQNFE/RkSMEwQHMSxDAICJSMgOZ0DiNoLIA2KTRwXqoFYDgQGwQg2nIE4JDMFYfC0Hw%2BBdawWmcxwIGcYZvGRQIJkKYoDGyZIhAO87EkuphulOvpkXKSohA6IZ3EaAwXrad7xgKXoYmesZruBzoHsBqQ5nAxZlihjCuB/ch8IA7hHg6ohUGVEleJJLRHggfBiDIaCVX4CiqLmJBsBYHAYl%2BBGsPIHC0OR0SiJIsi4IQzaUOkDYSW2AE1oATg2GC1p4bYfBFhGNl/dnuHJnnyBo5AQEcliIC4AcHnQAdCCUcRSEwAdFo8bABym7AlC4US2KY0hQnYFYMaxngcZ4vGDOS4xUstpRJKKdw3P4WbibGgwBOiAcWCISLuu8m3ROj0gB005giFDgRaxjwzjIHYJBBT3O0%2BCSxzFepgBw4GpMDjlgU/kKrJFqwRhGUNRNHs5qttaFInCYVxPoyI6h4hqYgayW62lB6echSCezue7aq7%2BuefqqMYl6egZOg37eTshlU4Kc7ACEwMjP2/BX7KIgIAlygBZR4AEkgMefKiuidHQPdz28YEyJiQUgpMURuAYo7UmMxlYZSpjTOm1BkKoQAGwkmkDLYWKCUE8RFrxaQAIWqYWwlILQeFFbEWsFzCmiEEY%2BFvgRDm3M4ELWiEkRw0ggA%3D%3D">this out</a> (in another tab)!</p>
<p>The upper-left panel has the source file, with each line highlighted in a different color.
The bottom-left panel has the fully-compiled code (we’ll ignore that),
and the right panel has the LLVM bytecode.</p>
<p>Note how on the right, there’s a matching color to the source line:
this is “what that source line was compiled to”.</p>
<p>If we look at the <code>@example::plus_evens::h3e97a5ef4523fe5e</code> and <code>@example::minus_odds::h9a0c327b983eb5fa</code>,
we see they have the same structure: allocate some values, make some calls, return.
The calls are mostly the same, even: <code>Iterator::filter</code>, then <code>Iterator::map</code>, then <code>Iterator::for_each</code>.</p>
<p>But! Look closely- as of the compiler version I used, I got:</p>
<table>
<thead>
<tr>
<th><code>plus_evens</code></th>
<th><code>minus_odds</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_ZN4core5slice29_[...]hba5496e8cfd60364E</code></td>
<td>(same)</td>
</tr>
<tr>
<td><code>filter::hd00cdd721ef593af</code></td>
<td><code>filter::he3404cc7f49effb9</code></td>
</tr>
<tr>
<td><code>map::h4dc70664041aed73</code></td>
<td><code>map::h9ffee8949f77ed3e</code></td>
</tr>
<tr>
<td><code>for_each::h2fc5b39b6cc128db</code></td>
<td><code>for_each::h99898954021474f8</code></td>
</tr>
</tbody>
</table>
<p>That first call – to <code>core5slice29</code>-something-something – is the same.
That makes sense: in both cases, we’re taking a 5-element array and getting an iterator for it.</p>
<p>But the other calls are different!</p>
<ul>
<li>The <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.filter"><code>filter</code> call</a> has a <em>generic</em> argument for the type of the predicate;
every closure has <a href="https://doc.rust-lang.org/reference/types/closure.html">“a unique, anonymous type”</a>.
<code>|i| i % 2 == 0</code> and <code>|i| i % 2 == 1</code> are not just different objects – they also have different types.</li>
<li>The return type of <code>filter</code> is a <code>Filter&lt;Self, P&gt;</code>. The generic type <code>Filter</code> has
type parameters <code>Self</code>, the type of the iterator we called it on, and <code>P</code>,
the type of the predicate closure – so even though we called <code>filter</code> on “the same type of iterator”-over-slices,
we still get different return types, because the closures are different.</li>
<li>Same for <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.map"><code>map</code></a>: the returned type,
<code>Map&lt;Self, F&gt;</code>, includes the “called” type and the mapping function (closure).</li>
</ul>
<p>The net return type that we call <code>for_each</code> on is something like <code>Map&lt;Filter&lt;SliceIter, AnonPredicate&gt;, AnonMapper&gt;</code>.</p>
<p>This has occasionally annoyed me when using Rust iterators:
I have wound up with deeply nested <em>types</em>, of the form <code>Fold&lt;FilterMap&lt;Enumerate&lt;...&gt;&gt;&gt;</code>
or similar, because each call “captures” the previous type in its return type.</p>
<p>But! Because of that, the functions generated for these types – their <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#tymethod.next"><code>next</code></a>, <code>map</code>, <code>for_each</code> methods –
are only used in one place. That makes it easy for LLVM to decide to inline!</p>
<h2 id="inlining-experimentally">Inlining, experimentally</h2>
<p>Inlining a function definition – replacing “call to function” with “text of function” –
has some tradeoffs: it skips the call overhead and allows new optimizations, but expands the
(instruction) size of each caller. If a function is only called from one place, though,
it can be a net <em>decrease</em> in program size – usually a win!</p>
<p>I’ve heard and seen that LLVM is pretty aggressive in inlining. Let’s see how it works on
these two examples, using Compiler Explorer’s “Opt Pipeline” view.</p>
<p>We can see what optimizations the compiler is doing
by going to the compiler pane (the one that says <code>rustc</code>) and clicking “Add new…” &gt; “Opt Pipeline”.
It might take a minute to load,<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> then we get
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQ0gEzlnABkCJmwAOU8AI2xSKQA2cgAHdCViByY3Dy8ff2TU%2ByFg0Ii2aNieBJtsO3SRIhZSIkzPbz9rbFsCpjqGoiLwqJj463rG5uy2y17%2BkrL4gEprdDNSVE4uAFItAEEN3wBmDYBWACEmdAB9NmNgRmOAES3tmiYAajp6IhiLoiRmK5YiQg81eGwA7Ccnq9oa9GERXuolKD9vdQaceORXv5XvtMbJXkcHht9pCdjCEUoAHTEGLAqHkmGUj5fUgQcEudTs14AKnUoN8RyxyMeKNeWnm9IZr0p1yB7M5YJcCP5J1ePAlZKl0sEpAu2BYqCQbMVCqViVIISI9CYYEge184MhYMevmx6nmEpJT3Bjx23oOxzOl2uJjuR19zzezO%2BsuBoIhkth2HhiOFaJOGKxmNxr3xhPDxNJ23JiOpLLpmqlTIYLIBcpNXIINB5fL2gt8wuJqK08dVInQHAgrd8qvV8dRHRUvdeYSE2HHGuLWqZZD1BqN8q55st1ttbNdjp99sx7s9RZ9XEW9G4R343l4/HQ3AAShZ4Uplqt53t9nxyERtEvRYAGsQCOLRDG4aR%2BDYMCIPvHRyCfLh%2BCUEAIIArgdEWOBYBQDA2ESBgYkoagCKIxhYlIHgwQADgg6NSDQiBIkA8hIhCBoAE9uD/DjWFILiAHlIl0apML/AiOGEISmHoHisP4HBIjMYAXAkeg0IfcgcBDW51kQwhSHEggADdsC0xDsHUaozC%2BXj%2BEtDo2PoAhIlIbi3BwNiiAtWDtPM0hIhSbB7mwPTXJMQDFhoIxgCUAA1AhsAAdyExJmAcuRhDECROBkbLFBUDQ2P0DEjCi8xLEMNy0MgRZ0ESLotMfQKLRwOqoFYDgQGwQgunIUyJDMdZfC0Xw%2BA9dpOnSJwmFcdwWgMIIQgGUohgxPI0iEcZvE2lJtqYGZBnKaaTKEHoxkW7IMSqGoLtGPpVtmDaRl6XaDCmRpjvW8pFg/FY1ikK8bzvNjkNeKqiFQNVKToykewgfBiDIflf3mfhMOwxY/hYHBYmBSCuGg8hYPA8gEMfbhUPQ/9opAnwjjh2jfDiaR9gATiOOjWekPmif2MHFKQ6m6cUnDEFw5AQAICgqAgLgAFoXnQRXCCUcRSEwRWho8bBFe6iyuDY8jiNIMJ2HWKGYZ4ZmEaU8KbkYRWlC40p3Es/g%2BpR9qDEYxWWCIXy3Lsiy2P9qTmCIT2BBrGI1ewFTgEVkJBHDuPSBTphLHMe6mEVjh6kwQOWHD%2BRcskArBGEZQ1E0YWyrOvO5oWrI9oCeafrmfb8nSD6e8OrvXrurpLqaa725H2pHqH06vvHtvPpn56TuB/9jOwAhMHQkGuFvCnwe4QJAgSgBZV4AEln1eJLUpiSG3xtu3EeRkhSDRzM3EIs2P4xsXsfILjfG1AGZHDiJSPwHMwRaDiHEWiUDaLSDBOVKCME4IH2FshGmGForkClhAFAjUiCqAIBlSK2Bb4pVIgrZW5w1YEA1g0bWusRoG0tkoY2wtTaUQtj1Lg1tYbw0Mo7UM%2BtXbu00mxTAnhEjKzMPQegBcsDyPWH%2Bb2b8t5%2BwzgnJOWc07C39iEDA2dsAAEcRrCAIBIRWiQWBKBUDHQx2dfJmDzgXZMeMS5lxyuISushq5FTrqVT6HRxJ9QAOKkGWIkEAjEfh/CYHWJuXxMAX3mtZWmqRlINAAOpb1%2BCAAUGEN6aPFETfelMRZcHSvCEhZDVo32Sile%2BAjbZCNeEjfqqMfyfwHBRe%2BPS/5YyAoA/UwDCbXmJmg8mlSsHWFpsMqaoEjjSEpBNME%2BwwFaD8DRTZYCBZC0QnMxZu9fCHKpihf%2BIzAqpEcNIIAA%3D">this view</a>.</p>
<p>The new “Opt Pipeline Viewer” panel has a drop-down to select which function we’re looking at.
Along the right are the <a href="https://llvm.org/docs/Passes.html">LLVM optimization passes</a> that the Rust compiler is running;
I’ve filtered down to only those that have an effect. Clicking the pass name on the left-hand
subpanel shows what the pass did, as a left/right diff; for instance,
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQ0gEzlnABkCJmwAOU8AI2xSKQA2cgAHdCViByY3Dy8ff2TU%2ByFg0Ii2aNieBJtsO3SRIhZSIkzPbz9rbFsCpjqGoiLwqJj463rG5uy2y17%2BkrL4gEprdDNSVE4uAFItAEEN3wBmDYBWACEmdAB9NmNgRmOAES3tmiYAajp6IhiLoiRmK5YiQg81eGwA7Ccnq9oa9GERXuolKD9vdQaceORXv5XvtMbJXkcHht9pCdjCEUoAHTEGLAqHkmGUj5fUgQcEudTs14AKnUoN8RyxyMeKNeWnm9IZr0p1yB7M5YJcCP5J1ePAlZKl0sEpAu2BYqCQbMVCqViVIISI9CYYEge184MhYMevmx6nmEpJT3Bjx23oOxzOl2uJjuR19zzezO%2BsuBoIhkth2HhiOFaJOGKxmNxr3xhPDxNJ23JiOpLLpmqlTIYLIBcpNXIINB5fL2gt8wuJqK08dVInQHAgrd8qvV8dRHRUvdeYSE2HHGuLWqZZD1BqN8q55st1ttbNdjp99sx7s9RZ9XEW9G4R343l4/HQ3AAShZ4Uplqt53t9nxyERtEvRYAGsQCOLRDG4aR%2BDYMCIPvHRyCfLh%2BCUEAIIArgdEWOBYBQDA2ESBgYkoagCKIxhYlIHgwQADgg6NSDQiBIkA8hIhCBoAE9uD/DjWFILiAHlIl0apML/AiOGEISmHoHisP4HBIjMYAXAkeg0IfcgcBDW51kQwhSHEggADdsC0xDsHUaozC%2BXj%2BEtDo2PoAhIlIbi3BwNiiAtWDtPM0hIhSbB7mwPTXJMQDFhoIxgCUAA1AhsAAdyExJmAcuRhDECROBkbLFBUDQ2P0DEjCi8xLEMNy0MgRZ0ESLotMfQKLRwOqoFYDgQGwQgunIUyJDMdZfC0Xw%2BA9dpOnSJwmFcdwWgMIIQgGUohgxPI0iEcZvE2lJtqYGZBnKaaTKEHoxkW7IMSqGoLtGPpVtmDaRl6XaDCmRpjvW8pFg/FY1ikK8bzvNjkNeKqiFQNVKToykewgfBiDIflf3mfhMOwxY/hYHBYmBSCuGg8hYPA8gEMfbhUPQ/9opAnwjjh2jfDiaR9gATiOOjWekPmif2MHFKQ6m6cUnDEFw5AQAICgqAgLgAFoXnQRXCCUcRSEwRWho8bBFe6iyuDY8jiNIMJ2HWKGYZ4ZmEaU8KbkYRWlC40p3Es/g%2BpR9qDEYxWWCIXy3Lsiy2P9qTmCIT2BBrGI1ewFTgEVkJBHDuPSBTphLHMe6mEVjh6kwQOWHD%2BRcskArBGEZQ1E0YWyrOvO5oWrI9oCeafrmfb8nSD6e8OrvXrurpLqaa725H2pHqH06vvHtvPpn56TuB/9jOwAhMHQkGuFvCnwe4QJAgSgBZV4AEln1eJLUpiSG3xtu3EeRkhSDRzM3EIs2P4xsXsfILjfG1AGZHDiJSPwHMwRaDiHEWiUDaLSDBOVKCME4IH2FshGmGForkClhAFAjUiCqAIBlSK2Bb4pVIgrZW5w1YEA1g0bWusRoG0tkoY2wtTaUQtj1Lg1tYbw0Mo7UM%2BtXbu00mxTAnhEjKzMPQegBcsDyPWH%2Bb2b8t5%2BwzgnJOWc07C39iEDA2dsAAEcRrCAIBIRWiQWBKBUDHQx2dfJmDzgXZMeMS5lxyuISushq5FTrqVT6HRxJ9QAOKkGWIkEAjEfh/CYHWJuXxMAX3mtZEAvgObWC3onBoAB1LevxMnk18tgTe29xRE33pTEWXB0rwhIWQ1aN9kopXvgI22QjXhI36qjH8n8BwUXvgMv%2BWMgKAP1MAwm15iZoPJrUrB1habjKmqBI40hKQTTBPsMBWg/A0V2WAgWQtEJLNWbvXwpyqYoX/hMwKqRHDSCAA%3D%3D">the “Eliminate PHI nodes pass”</a>
just changed a comment at the top.</p>
<p>By default, the Rust compiler isn’t doing a lot of optimization.
If we add the <a href="https://doc.rust-lang.org/rustc/codegen-options/index.html#opt-level"><code>-C opt-level=1</code></a> flag to the compiler invocation,<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> we get
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQ0gEzlnABkCJmwAOU8AI2xSKQA2cgAHdCViByY3Dy8ff2TU%2ByFg0Ii2aNieBJtsO3SRIhZSIkzPbz9rbFsCpjqGoiLwqJj463rG5uy2y17%2BkrL4gEprdDNSVE4uAFItAEEN3wBmDYBWACEmdAB9NmNgRmOAES3tmiYAajp6IhiLoiRmK5YiQg81eGwA7Ccnq9oa9GERXuolKD9vdQaceORXv5XvtMbJXkcHht9pCdjCEUoAHTEGLAqHkmGUj5fUgQcEudTs14AKnUoN8RyxyMeKNeWnm9IZr0p1yB7M5YJcCP5J1ePAlZKl0sEpAu2BYqCQbMVCqViVIISI9CYYEge184MhYMevmx6nmEpJT3Bjx23oOxzOl2uJjuR19zzezO%2BsuBoIhkth2HhiOFaJOGKxmNxr3xhPDxNJ23JiOpLLpmqlTIYLIBcpNXIINB5fL2gt8wuJqK08dVInQHAgrd8qvV8dRHRUvdeYSE2HHGuLWqZZD1BqN8q55st1ttbNdjp99sx7s9RZ9XEW9G4R343l4/HQ3AAShZ4Uplqt53t9nxyERtEvRYAGsQCOLRDG4aR%2BDYMCIPvHRyCfLh%2BCUEAIIArgdEWOBYBQDA2ESBgYkoagCKIxhYlIHgwQADgg6NSDQiBIkA8hIhCBoAE9uD/DjWFILiAHlIl0apML/AiOGEISmHoHisP4HBIjMYAXAkeg0IfcgcBDW51kQwhSHEggADdsC0xDsHUaozC%2BXj%2BEtDo2PoAhIlIbi3BwNiiAtWDtPM0hIhSbB7mwPTXJMQDFhoIxgCUAA1AhsAAdyExJmAcuRhDECROBkbLFBUDQ2P0DEjCi8xLEMNy0MgRZ0ESLotIAWiVRqiBaxhzPoLs/3QQKLRwOqoFYDgQGwQgunIUyJDMdZfC0Xw%2BA9dpOnSJwmFcdwWgMIIQgGUohgxPI0iEcZvBOlIzqYGZBnKNaTKEHoxh27IMSqGpntGPoDtmY6Rl6C6DCmRo7qO8pFg/FY1ikK8bzvNjkNeKqiFQNVKToykewgfBiDIflf3mfhMOwxY/hYHBYmBSCuGg8hYPA8gEMfbhUPQ/9opAnwjkx2jfDiaR9gATiOOiBekSXaf2RHFKQtnOcUnDEFw5AQAICgqAgLgWpedAWsIJRxFITAWtmjxsBasaLK4NjyOI0gwnYdZUfRng%2BexpTwpuRgWqULjSncSz%2BEm/GhoMRiWpYIhfLcuyLLYyOpOYIhg4EGsYgN7AVOAFqQkEROM9IPOmEscwvqYFqOHqTBo5YRP5FyyQCsEYRlDUTQ5bKx6K827askugItvBuYrvydJgbHm6R4Bz6uhepo3sHufah%2BmeHtBxeB5Bte/vuuH/2M7ACEwdD4a4W9maR7hAkCBKAFlXgASWfV4ktSmIUbfN2PZxvGSFIITTMbhCIOyAcTRWZNyAUyptQbmRw4iUj8MLMEWg4hxFoig2i0gwTlSgjBOCV85bIXZhhaK5BVYQBQB1VQBAMqRWwO/FKpFta63OAbAgRsGim3NvNK2zslC2zlvbSiTtxpcFdhjLGhlvahktv7QOmk2KYE8IkXWZh6D0CrlgDR6w/yhwASfCORcs45xLgXOWkcQgYFLtgAAjvNYQBAJAtUSCwJQKg05WNLr5MwFcq7JkpnXBuOVxDN1kK3IqHdSogw6OJSaABxUgyxEggEYj8P4TA6w9y%2BJgJ%2BW1rIgF8MLawJ9s4NAAOon1%2BEUpmvlsDH1PuKWml8Wbyy4OleEtD6EHTfslFKn9JHu2ka8XGU0CY/mAQOCin9JkQNJkBaB%2BpYE02vHTAhTM2kkOsBzBZq1QJHGkJSZaYJ9gIK0H4GiZyEHS1lohbZezz6%2BDuazFCkDFmBVSI4aQQA%3D%3D">these results</a>
– check out how many more passes have an effect!</p>
<p>Looking at <code>filter_then_map</code>,<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup> we can see “InlinerPass” is active (towards the top of the passes list).
It changes the LLVM IR
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQ0gEzlnABkCJmwAOU8AI2xSKQA2cgAHdCViByY3Dy8ff2TU%2ByFg0Ii2aNieBJtsO3SRIhZSIkzPbz9rbFsCpjqGoiLwqJj463rG5uy2y17%2BkrL4gEprdDNSVE4uAFItAEEN3wBmDYBWACEmdAB9NmNgRmOAES3tmiYAajp6IhiLoiRmK5YiQg81eGwA7Ccnq9oa9GERXuolKD9vdQaceORXv5XvtMbJXkcHht9pCdjCEUoAHTEGLAqHkmGUj5fUgQcEudTs14AKnUoN8RyxyMeKNeWnm9IZr0p1yB7M5YJcCP5J1ePAlZKl0sEpAu2BYqCQbMVCqViVIISI9CYYEge184MhYMevmx6nmEpJT3Bjx23oOxzOl2uJjuR19zzezO%2BsuBoIhkth2HhiOFaJOGKxmNxr3xhPDxNJ23JiOpLLpmqlTIYLIBcpNXIINB5fL2gt8wuJqK08dVInQHAgrd8qvV8dRHRUvdeYSE2HHGuLWqZZD1BqN8q55st1ttbNdjp99sx7s9RZ9XEW9G4R343l4/HQ3AAShZ4Uplqt53t9nxyERtEvRYAGsQCOLRDG4aR%2BDYMCIPvHRyCfLh%2BCUEAIIArgdEWOBYBQDA2ESBgYkoagCKIxhYlIHgwQADgg6NSDQiBIkA8hIhCBoAE9uD/DjWFILiAHlIl0apML/AiOGEISmHoHisP4HBIjMYAXAkeg0IfcgcBDW51kQwhSHEggADdsC0xDsHUaozC%2BXj%2BEtDo2PoAhIlIbi3BwNiiAtWDtPM0hIhSbB7mwPTXJMQDFhoIxgCUAA1AhsAAdyExJmAcuRhDECROBkbLFBUDQ2P0DEjCi8xLEMNy0MgRZ0ESLotIAWiVRqiBaxhzPoLs/3QQKLRwOqoFYDgQGwQgunIUyJDMdZfC0Xw%2BA9dpOnSJwmFcdwWgMIIQgGUohgxPI0iEcZvBOlIzqYGZBnKNaTKEHoxh27IMSqGpntGPoDtmY6Rl6C6DCmRo7qO8pFg/FY1ikK8bzvNjkNeKqiFQNVKToykewgfBiDIflf3mfhMOwxY/hYHBYmBSCuGg8hYPA8gEMfbhUPQ/9opAkBfGkSlaJoo4eFo3mBbBIXaNxa8uH2RHFKQtnOcUnDEFw5AQAICgqAgLgWpedAWsIJRxFITAWtmjxsBasaLK4NjyOI0gwnYdZUfRnhMdo7GlPCm5GBapQuNKdxLP4Sb8aGgxGJalgiF8ty7Istjo6k5giFDgQaxiQ3sBU4AWpCQRk6z0gC6YSxzC%2BpgWo4epMFjlhk/kXLJAKwRhGUNRNHlsrHqrzbtqyS6Ai28G5iu/J0mBiebrHgHPq6F6mje4eF9qH654e0Hl6HkGN7%2B%2B64f/YzsAITB0Phrhb2ZpHuECQIEoAWVeABJZ9XiS1KYhRt93c97HXi4ymgTH8mY3CEUdoTdUJMubkAplTag3MjhxEpH4AAnGCLQcQ4i0QwbRaQYJypQRglINBqDsH0S0PRaQItcFglkCzBWKFrAc1JpecgasIAoA6qoAgGVIrYE/ilUiOs9bnENgQY2DQzYW3mtbF2Sg7bywdpRZ240uBuwxljQyvtQxW0DsHTSbFMCeESHrMw9B6A1ywBY9Yf5w4kEjhiaOylVJlyLvLaOIQMDl2wAAR3msIAgEgWqJBYEoFQGcvHl18mYKuNdkyUwbk3HK4hW6yHbkVLupUQYdHEpNAA4qQZYiQQCMR%2BH8JgdY%2B5fEwC/La1lSHWDPrnBoAB1M%2BvweZM18tgU%2B59xS02vow5C6V4S8P4QdD%2ByUUrf00R7bRgC8aOKgZicBFFv6gOJkrMmcD9QIJptLemsF6KUiOPsX8aC0E8DQULQhS0b7y2QuzDCsDQLi0pMLUWgsvk0KITLOWiFnk7KArTXwgLWbMLYatQKqRHDSCAA%3D">significantly</a>,
turning the function from “just a few calls” to “several basic blocks”.
And the only call is to <code>std::io::stdio::_print</code> – we’ve inlined the calls to <code>iter</code>, <code>filter</code>, <code>map</code>, and <code>for_each</code>!</p>
<p>If you look carefully – and have been reading <a href="https://llvm.org/docs/LangRef.html">LLVM IR</a> for <a href="https://www.recurse.com/">the last six weeks</a> –
you can see the control flow of <code>filter</code> and <code>for_each</code>:</p>
<p><img src="https://cceckman.com/writing/rust-iterator-optimizations/cfg.svg" alt="Control-flow graph of filter_then_map"/></p>
<p>There’s some interesting numeric optimizations I’ll defer to this footnote.<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup></p>
<p>There’s also missed optimizations, like the conditional edges from the start block –
I <em>think</em> that’s “left over” <code>for_each</code> code, for skipping the iteration if it’s empty,
but I’m not sure.</p>
<p>The nice thing about the “pass” architecture is that not all passes have to do everything;
this pass “just” inlines, later passes can do optimizations like
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQAZgBM5M4AMgRM2AByngBG2KQgAGzkAA7oSsQOTG4eXr4BKWn2QiFhkWwxcYk22HYZIkQspERZnt7%2B1ti2hUx1DUTFEdGxCdb1jc05bZa9/aXlCQCU1uhmpKicXACkWgCCG34%2BGwCsAEJM6AD6bMbAjEcAIlvbNEwA1HT0RLHnREjMlyxJCDzF4bADsx0eLyhL0YRBe6iUIJ8dxBJx45BeARePgxsheh3uGx8EJ20PhSgAdMRYkDIWToRT3p9SBAwS51GyXgAqdQgvyHTFIh7Il5aeZ0%2BkvClXQFsjmglzwvnHF48cWkyVSwSkc7YFioJCshXyxVJUihIj0JhgSB7PxgiGgh5%2BLHqebi4mPMEPHZe/ZHU4XK4mW6HH1PV5Mr4yoEg8ESmHYOEIoWo47ozEYnEvPEEsNEknbMkIqnM2kayWMhjM/6y42cgg0bm8vYCvxCokorRxlUidAcCAtvwqtVxlEdFQ9l7hITYMfqouaxlkXX6w1yzlmi1Wm2sl0O712jFuj2F71cRb0biHfjeXj8dDcABKFjhSmWqznex8fHIRG0F6LAA1iAhxaIY3DSPwbCgeBd46OQj5cPwSggOB/5cDoixwLAKAYGwSQMLElDUPhhGMHEpA8KCAAc4FRqQqEQFEAHkFEoQNAAntwv7sawpCcQA8lEujVBhv74RwwiCUw9DcZh/A4FEZjAC4Ej0Kh97kDgwY3OsCGEKQYkEAAbtgmkIdg6jVGYnw8fwFodKx9AEFEpBcW4OCsUQ5owVpZmkFEqTYHc2C6S5JgAYsNBGMASgAGoENgADuglJMw9lyMIYgSJwMhZYoKgaKx%2BjokYkXmJYhiuahkCLOgSRdJpAC0ioNUQzWMGZ9Cdr%2B6ABeaOC1VArAcCA2CEF05AmRIZjrH4Wh%2BHw7rtJ0GROEwrjuC0BjBKEAxlEM6L5OkQjjN4x2pKdTAzIMcTolUNRCD0YzbTkD0dMZz2jH0%2B2zEdIy9OdBhTI0t2HfdizvisaxSJe163qxSEvJVRCoKqFK0RS3YQPgxBkHyP7zPwGFYYsvwsDgcRAhBXBQeQMFgeQ8EPtwKFoX%2BUXASAfjSBSNHUYcPA0bzAugkLNE4leXA%2BIjCmIWznMKdhiA4cgIAEBQVAQFwzXPOgzWEEo4ikJgzUzR42DNaN5lcKxZFEaQ4TsOsqPozwmM0djilhdcjDNUonFlO4Fn8BN%2BODQYDHNSwRA%2Ba5tnmax0eScwRChwI1axIb2DKcAzWhIIydZ6QBdMJY5hPUwzUcPUmCxywyfyDlkj5YIwjKGomjy6Vq1fd4EDOMD6J7SUd0GCdXTD8kV1dODcwfWt31A29F191XL2/WPEMgz90%2Bg1vB0L4sPnYNgBCYGh8NcDezNI9wQRBPFACyLwAJJPi8iUpbEKOvu7ntsYvFxpNAm34MxuAIo7QmaoSZc3IBTKm1BuaHHiBSaQfgACcoItDxHiDRbBNFpCgjKpBaCvgPbxGkD4aQRCtCYKwfEHwhxJZ33lkhdm6EorkDVhAFA7VVAEHShFbA39kokR1nrM4hsCDGwaGbC2c1rYuyUHbeWDsKLOzGlwN2GMsYGV9iGK2gdg4aVYpgTwSQ9ZmHoPQGuWAbHrF/OHEgkd0TRyUipMuRd5bR1CBgcu2AACOc1hAEAkM1JILAlAqAzn48uPkzBVxrkmSmDcm7ZXEK3WQ7dCpdxKiDT6dgJoAHFSDLCSCABi3xfhMFrOvT4mA36bSsiAah1gL65waAAdQvj8HmTNT7n0vmKWmt8WYKy4GlOEgjhH7S/klZKv9dEe30cAvGriYEYkgeRX%2B4DiZKzJggvUSCabS3pjBfBFJmHxCFocTBWgcE%2BCoQECZHDrAc1JoBcgIFxYUmFqLQWALaGkJlnLBC7yvkrWln4cFrNkKHO%2BQFNIjhpBAA%3D%3D">unrolling</a>
and
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMQAZgBM5M4AMgRM2AByngBG2KQgAGzkAA7oSsQOTG4eXr4BKWn2QiFhkWwxcYk22HYZIkQspERZnt7%2B1ti2hUx1DUTFEdGxCdb1jc05bZa9/aXlCQCU1uhmpKicXACkWgCCG34%2BGwCsAEJM6AD6bMbAjEcAIlvbNEwA1HT0RLHnREjMlyxJCDzF4bADsx0eLyhL0YRBe6iUIJ8dxBJx45BeARePgxsheh3uGx8EJ20PhSgAdMRYkDIWToRT3p9SBAwS51GyXgAqdQgvyHTFIh7Il5aeZ0%2BkvClXQFsjmglzwvnHF48cWkyVSwSkc7YFioJCshXyxVJUihIj0JhgSB7PxgiGgh5%2BLHqebi4mPMEPHZe/ZHU4XK4mW6HH1PV5Mr4yoEg8ESmHYOEIoWo47ozEYnEvPEEsNEknbMkIqnM2kayWMhjM/6y42cgg0bm8vYCvxCokorRxlUidAcCAtvwqtVxlEdFQ9l7hITYMfqouaxlkXX6w1yzlmi1Wm2sl0O712jFuj2F71cRb0biHfjeXj8dDcABKFjhSmWqznex8fHIRG0F6LAA1iAhxaIY3DSPwbCgeBd46OQj5cPwSggOB/5cDoixwLAKAYGwSQMLElDUPhhGMHEpA8KCAAc4FRqQqEQFEAHkFEoQNAAntwv7sawpCcQA8lEujVBhv74RwwiCUw9DcZh/A4FEZjAC4Ej0Kh97kDgwY3OsCGEKQYkEAAbtgmkIdg6jVGYnw8fwFodKx9AEFEpBcW4OCsUQ5owVpZmkFEqTYHc2C6S5JgAYsNBGMASgAGoENgADuglJMw9lyMIYgSJwMhZYoKgaKx%2BjokYkXmJYhiuahkCLOgSRdJpAC0ioNUQzWMGZ9Cdr%2B6ABeaOC1VArAcCA2CEF05AmRIZjrH4Wh%2BHw7rtJ0GROEwrjuC0BjBKEAxlEM6L5OkQjjN4x2pKdTAzIMcTolUNRCD0YzbTkD0dMZz2jH0%2B2zEdIy9OdBhTI0t2HfdizvisaxSJe163qxSEvJVRCoKqFK0RS3YQPgxBkHyP7zPwGFYYsvwsDgcRAhBXBQeQMFgeQ8EPtwKFoX%2BUXASAfjSBSNHUYcPA0bzAugkLNE4leXA%2BIjCmIWznMKdhiA4cgIAEBQVAQFwzXPOgzWEEo4ikJgzUzR42DNaN5lcKxZFEaQ4TsOsqPozwmM0djilhdcjDNUonFlO4Fn8BN%2BODQYDHNSwRA%2Ba5tnmax0eScwRChwI1axIb2DKcAzWhIIydZ6QBdMJY5hPUwzUcPUmCxywyfyDlkj5YIwjKGomjy6Vq1fd4EDOMD6J7SUd0GCdXTD8kV1dODcwfWt31A29F191XL2/WPEMgz90%2Bg1vB0L4sPnYNgBCYGh8NcDezNI9wQRBPFACyLwAJJPi8iUpbEKOvu7ntsYvFxpNAm34MxuAIo7QmaoSZc3IBTKm1BuaHHiBSaQfgACcoItDxHiDRbBNFpCgjKpBaCvgPbxGkD4aQRCtCYKwfEHwhxJZ33lkhdm6EorkDVhAFA7VVAEHShFbA39kokR1nrM4hsCDGwaGbC2c1rYuyUHbeWDsKLOzGlwN2GMsYGV9iGK2gdg4aVYpgTwSQ9ZmHoPQGuWAbHrF/OHEgkd0TRyUipMuRd5bR1CBgcu2AACOc1hAEAkM1JILAlAqAzn48uPkzBVxrkmSmDcm7ZXEK3WQ7dCpdxKiDT6dgJoAHFSDLCSCABi3xfhMFrOvT4mA36bSsqBB6F9c4NAAOoXx%2BDzJmp9z6XzFLTW%2BLMFZcDSnCQRwj9pfySslX%2BuiPb6OAXjVxMCMSQPIr/cBxMlZkwQXqJBNNpb0xgvgikzD4hC0OJgrQOCfBUICOMjh1gOak0AuQEC4sKTC1FoLf5tDSEyzlghN5nyVrSz8GC1myEDlfICmkRw0ggA">eliminating the loop altogether</a>.<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup></p>
<h2 id="loops-and-combinators">Loops and combinators</h2>
<p>OK, so we’ve gone through Compiler Explorer on these examples, up to <code>opt-level=1</code>.
We’ve done <code>.filter().map()</code> and <code>filter_map()</code>; let’s add the <code>for ... in</code>
version to cover all the cases from [Nicole’s post][ntiez-iter].</p>
<p><a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMpW8s4AyBEzYAHKeAEbYpCAATL4ADuhKxA5Mbh5ePuSJyfZCgcFhbJHRcdbYtnlMIkQspETpnt48vjbYdqk1dUQFoRFRsa219Y2ZLdbDPUF9xQNxAJTW6GakqJxcAKRaAIIbMQDMGwCsAEJM6AD6bMbAjMcAIlvbNEwA1HT0RFEXREjMVyx4hB5q8NgB2E5PV7Q16MIivdRKUH7e6g048civGKY/aY2SvI4PDb7SE7GEIpQAOmIUWBUPJMMpHy%2BpAg4Jc6nZrwAVOpQTEjljkY8Ua8tPN6QzXpTrkD2ZywS4EfyTq8eBKyVLpYJSBdsCxUEg2YqFUr4qQgkR6EwwJA9jFwZCwY8YtiEfMJSSnuDHjtvQdjmdLtcTHcjr7nm9md9ZcDQRDJbDsPDEcK0ScMVicXjMYTw8TSdtyYjqSy6ZqpUyGCyAXKTVyCDQeXy9oKYsLiaitPHVSJ0BwIC2Yqr1fHURUVD3XiEhNgxxqi1qmWQ9QajfKuebLdbbWzXY6ffbMeoPQXvc7vX6A6dzgDQ9giTsXu8V0E4weK0mU0jO%2BnM27cVefE8xFQtyR1ZUggpUtaRBD9FylRtlVbIVO1/bt4K1Bkt2EHc7X3BML1dY89gzT0wK1Q9Pyo3ZnS4RZ6G4I5%2BG8Xh%2BHQbgACULHhJRllWOc9n2PhyCIbR6MWABrEAjl8RiuGkfg2Bk3xWJ0cgOK4fglBAXwxK4HRFjgWAUAwNh4gYKJKGoMyLMYaJSB4MEAA5fGjUgdIgcJxPIcIgjqABPbgRL81hSACgB5cJdHafSRLMjhhAiph6CCgz%2BBwcIzGAFwJHoHS2PIHAQ1udZ1MIUhYoIAA3bACvU7B1HaMwvmC/hLQqHz6AIcJSECtwcB8ogLWUwratIcIkmwe5sBK7qTHExYaCMYAlAANQIbAAHcIviZg2rkYQxAkTgZEOxQVA0Hz9AxIwFvMSxDB6nTIEWdB4iqAqAFolXeogvsYWr6E7ET0HGi0cBeqBWA4EBsEIKpyGqiQzHWOIYj4D1ykqVInCYVx3CaAwAmmIoSgMHIUiEUZmmyJIqaYXoyYGDE2g6IQuhGQmxmxqqOcmJn%2BmiVnJhpgxLG6QXZmFxY%2BJWNYpAYpiWJ8zTXgeohUDVSkXMpbsIHwYgyH5YT5n4fTDMWP4WBwaJgUMbhFPIZTZPINT2O4bTdNExapNiaRKWcpyjh4ZyYmkIOwRD5zcXk/YVfSjTPZ99KjMQYzkBAAgKCoCAuC%2Bl50C%2BwglHEUhMC%2B5GPGwL6YbqrgfNsyzSBCdh1g1rWeB15y9Yy2abkYL6lAC4p3Hq/h4aNiGDHcr6WCIYaepauqfNnhLmCIceBGrKJi%2BwLLgC%2BoJBFXnfSCPphLHMdmmC%2BjhakweeWFX%2BRjskM7BGEZQ1E0RObt5m%2BeMCYZFpiTQoQsKb0yqGLDElMqhS3JqzCofNqii25rTNmVROZTHAdLcWaCQH4MlqTCB6pRKVWwAQTAuklZcGYm7VW3B/D%2BDWgAWVeAASU4q8Da20ojqx4p3buetXgGwRsbISmY3DmWbibdU5tfbkGtrbagfsjgADZKTSBiAATjBFodR6jnJ6OctIMEt1HZKRAMJSk6jpD7AjtILQOjdHqP2EcGODDE6aS9npRa5AM4QBQH9VQBA9rzWwLwra1k84F3OMXAgpc6gVyrqjWubclAN0Tk3eyrdYZcA7trXW5V%2B73iHiPSa%2BUfKYE8PEAuZh6D0DvlgBp6wRKTxINPDEs9MrZQvifROs8ggYEvtgAAjqjYQBAJBfXiCwJQKgt5DMvsNMwN877Jhtk/F%2BR1xDv1kJ/C6P9rri2QXYeGABxUgyx4ggB1BcIIACviYA4fjRqUgjjWCofvOoAB1KhvxYiu2GtgSh1DxQOzoQndSmldrwlCeE6YPDNpbX4YUruxTRGG06XIzE0i7L8MkWbFOlslH6hUfbeSTtlJGMpO49RIcjg6K0Po/YdjsTuyTlpaw3sLYSXINJKOlJQ7h0jtHUVFiuDxy8TC5OfKsbyRiNCj23L5WLHGskRw0ggA%3D">This is what we get!</a>
The active passes aren’t quite the same:
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMpW8s4AyBEzYAHKeAEbYpCAATL4ADuhKxA5Mbh5ePuSJyfZCgcFhbJHRcdbYtnlMIkQspETpnt48vjbYdqk1dUQFoRFRsa219Y2ZLdbDPUF9xQNxAJTW6GakqJxcAKRaAIIbMQDMGwCsAEJM6AD6bMbAjMcAIlvbNEwA1HT0RFEXREjMVyx4hB5q8NgB2E5PV7Q16MIivdRKUH7e6g048civGKY/aY2SvI4PDb7SE7GEIpQAOmIUWBUPJMMpHy%2BpAg4Jc6nZrwAVOpQTEjljkY8Ua8tPN6QzXpTrkD2ZywS4EfyTq8eBKyVLpYJSBdsCxUEg2YqFUr4qQgkR6EwwJA9jFwZCwY8YtiEfMJSSnuDHjtvQdjmdLtcTHcjr7nm9md9ZcDQRDJbDsPDEcK0ScMVicXjMYTw8TSdtyYjqSy6ZqpUyGCyAXKTVyCDQeXy9oKYsLiaitPHVSJ0BwIC2Yqr1fHURUVD3XiEhNgxxqi1qmWQ9QajfKuebLdbbWzXY6ffbMeoPQXvc7vX6A6dzgDQ9giTsXu8V0E4weK0mU0jO%2BnM27cVefE8xFQtyR1ZUggpUtaRBD9FylRtlVbIVO1/bt4K1Bkt2EHc7X3BML1dY89gzT0wK1Q9Pyo3ZnS4RZ6G4I5%2BG8Xh%2BHQbgACULHhJRllWOc9n2PhyCIbR6MWABrEAjl8RiuGkfg2Bk3xWJ0cgOK4fglBAXwxK4HRFjgWAUAwNh4gYKJKGoMyLMYaJSB4MEAA5fGjUgdIgcJxPIcIgjqABPbgRL81hSACgB5cJdHafSRLMjhhAiph6CCgz%2BBwcIzGAFwJHoHS2PIHAQ1udZ1MIUhYoIAA3bACvU7B1HaMwvmC/hLQqHz6AIcJSECtwcB8ogLWUwratIcIkmwe5sBK7qTHExYaCMYAlAANQIbAAHcIviZg2rkYQxAkTgZEOxQVA0Hz9AxIwFvMSxDB6nTIEWdB4iqAqAFolXeogvsYWr6E7ET0HGi0cBeqBWA4EBsEIKpyGqiQzHWOIYj4D1ykqVInCYVx3CaAwAmmIoSgMHIUiEUZmmyJIqaYXoyYGDE2g6IQuhGQmxmxqqOcmJn%2BmiVnJhpgxLG6QXZmFxY%2BJWNYpAYpiWJ8zTXgeohUDVSkXMpbsIHwYgyH5YT5n4fTDMWP4WBwaJgUMbhFPIZTZPINT2O4bTdNExapNiaRKWcpyjh4ZyYmkIOwRD5zcXk/YVfSjTPZ99KjMQYzkBAAgKCoCAuC%2Bl50C%2BwglHEUhMC%2B5GPGwL6YbqrgfNsyzSBCdh1g1rWeB15y9Yy2abkYL6lAC4p3Hq/h4aNiGDHcr6WCIYaepauqfNnhLmCIceBGrKJi%2BwLLgC%2BoJBFXnfSCPphLHMdmmC%2BjhakweeWFX%2BRjskM7BGEZQ1E0RObt5m%2BeMCYZFpiTQoQsKb0yqGLDElMqhS3JqzCofNqii25rTNmVROZTHAdLcWaCQH4MlqTCB6pRKVWwAQTAuklZcGYm7VW3B/D%2BDWgAWVeAASU4q8Da20ojqx4p3buetXgGwRsbISmY3DmWbibdU5tfbkGtrbagfsjgADZKTSBiAATjBFodR6jnJ6OctIMEt1HZKRAMJSk6jpD7AjtILQOjdHqP2EcGODDE6aS9npRa5AM4QBQH9VQBA9rzWwLwra1k84F3OMXAgpc6gVyrqjWubclAN0Tk3eyrdYZcA7trXW5V%2B73iHiPSa%2BUfKYE8PEAuZh6D0DvlgBp6wRKTxINPDEs9MrZQvifROs8ggYEvtgAAjqjYQBAJBfXiCwJQKgCoiSGZfYaZgb532TDbJ%2BL8jriHfrIT%2BF0f7XXFsguw8MADipBljxBADqC4QQAFfEwBw/GjUZLWCofvOoAB1KhvxYiu2GtgSh1DxQOzoQndSmldrwlCeE6YPDNpbX4YUruxTRGG06XIzE0i7L8MkWbFOlslH6hUfbeSTtlJGMpO49RIcjg6K0Po/YdjsTuyTlpaw3sLYSXINJKOlJQ7h0jtHUVFiuDxy8TC5OfKsbyRiNCj23L5WLHGskRw0ggA%3D"><code>for_in</code></a>
activates soem earlier passes compared to
<a href="https://godbolt.org/#z:OYLghAFBqd5TKALEBjA9gEwKYFFMCWALugE4A0BIEAZgQDbYB2AhgLbYgDkAjF%2BTXRMiAZVQtGIHgBYBQogFUAztgAKAD24AGfgCsp5eiyahSAVyVFyKxqiIEh1ZpgDC6embZMpW8s4AyBEzYAHKeAEbYpCAATL4ADuhKxA5Mbh5ePuSJyfZCgcFhbJHRcdbYtnlMIkQspETpnt48vjbYdqk1dUQFoRFRsa219Y2ZLdbDPUF9xQNxAJTW6GakqJxcAKRaAIIbMQDMGwCsAEJM6AD6bMbAjMcAIlvbNEwA1HT0RFEXREjMVyx4hB5q8NgB2E5PV7Q16MIivdRKUH7e6g048civGKY/aY2SvI4PDb7SE7GEIpQAOmIUWBUPJMMpHy%2BpAg4Jc6nZrwAVOpQTEjljkY8Ua8tPN6QzXpTrkD2ZywS4EfyTq8eBKyVLpYJSBdsCxUEg2YqFUr4qQgkR6EwwJA9jFwZCwY8YtiEfMJSSnuDHjtvQdjmdLtcTHcjr7nm9md9ZcDQRDJbDsPDEcK0ScMVicXjMYTw8TSdtyYjqSy6ZqpUyGCyAXKTVyCDQeXy9oKYsLiaitPHVSJ0BwIC2Yqr1fHURUVD3XiEhNgxxqi1qmWQ9QajfKuebLdbbWzXY6ffbMeoPQXvc7vX6A6dzgDQ9giTsXu8V0E4weK0mU0jO%2BnM27cVefE8xFQtyR1ZUggpUtaRBD9FylRtlVbIVO1/bt4K1Bkt2EHc7X3BML1dY89gzT0wK1Q9Pyo3ZnS4RZ6G4I5%2BG8Xh%2BHQbgACULHhJRllWOc9n2PhyCIbR6MWABrEAjl8RiuGkfg2Bk3xWJ0cgOK4fglBAXwxK4HRFjgWAUAwNh4gYKJKGoMyLMYaJSB4MEAA5fGjUgdIgcJxPIcIgjqABPbgRL81hSACgB5cJdHafSRLMjhhAiph6CCgz%2BBwcIzGAFwJHoHS2PIHAQ1udZ1MIUhYoIAA3bACvU7B1HaMwvmC/hLQqHz6AIcJSECtwcB8ogLWUwratIcIkmwe5sBK7qTHExYaCMYAlAANQIbAAHcIviZg2rkYQxAkTgZEOxQVA0Hz9AxIwFvMSxDB6nTIEWdB4iqAqAFolXeogvsYWr6E7ET0HGi0cBeqBWA4EBsEIKpyGqiQzHWOIYj4D1ykqVInCYVx3CaAwAmmIoSgMHIUiEUZmmyJIqaYXoyYGDE2g6IQuhGQmxmxqqOcmJn%2BmiVnJhpgxLG6QXZmFxY%2BJWNYpAYpiWJ8zTXgeohUDVSkXMpbsIHwYgyH5YT5n4fTDMWP4WBwaJgUMbhFPIZTZPINT2O4bTdNExapNiaRKWcpyjh4ZyYmkIOwRD5zcXk/YVfSjTPZ99KjMQYzkBAAgKCoCAuC%2Bl50C%2BwglHEUhMC%2B5GPGwL6YbqrgfNsyzSBCdh1g1rWeB15y9Yy2abkYL6lAC4p3Hq/h4aNiGDHcr6WCIYaepauqfNnhLmCIceBGrKJi%2BwLLgC%2BoJBFXnfSCPphLHMdmmC%2BjhakweeWFX%2BRjskM7BGEZQ1E0RObt5m%2BeMCYZFpiTQoQsKb0yqGLDElMqhS3JqzCofNqii25rTNmVROZTHAdLcWaCQH4MlqTCB6pRKVWwAQTAuklZcGYm7VW3B/D%2BDWgAWVeAASU4q8Da20ojqx4p3buetXgGwRsbISmY3DmWbibdU5tfbkGtrbagfsjgADZKTSBiAATjBFodR6jnJ6OctIMEt1HZKRAMJSk6jpD7AjtILQOjdHqP2EcGODDE6aS9npRa5AM4QBQH9VQBA9rzWwLwra1k84F3OMXAgpc6gVyrqjWubclAN0Tk3eyrdYZcA7trXW5V%2B73iHiPSa%2BUfKYE8PEAuZh6D0DvlgBp6wRKTxINPDEs9MrZQvifROs8ggYEvtgAAjqjYQBAJBfXiCwJQKgCoiSGZfYaZgb532TDbJ%2BL8jriHfrIT%2BF0f7XXFsguw8MADipBljxBAO5WsACviYA4fjRqMlrBUP3nUAA6lQ34sRXbDWwJQ6h4oHZ0ITupTSu14ShPCdMHhm0tr8MKV3YpojDadLkZiaRdl%2BGSLNinS2Sj9QqPtvJJ2ykjGUnceokORwdFaH0fsOx2J3ZJy0tYb2FsJLkGklHSkodw6R2jiKixXB45eOhcnXlWN5IxChR7LlcrFjjWSI4aQQA%3D%3D%3D"><code>filter_map</code></a>.
(A guess: since more of the control flow is in the function <em>before</em> inlining, these passes can act ~immediately.)</p>
<p>A lot of passes seem to be repeated, though – I think this is because one optimization can unlock
new opportunities for another. The net result is exactly what Nicole says:
the <code>filter</code>, <code>filter_map</code>, and <code>for_in</code> implementations all optimize to the same machine code.<sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup></p>
<p>I like this! Write the code you find readable – let the machine figure out how to run it quickly!</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>Thanks to Nicole for writing the post that kicked this off, and Anvay for working with me through a bunch of
LLVM experiments <a href="https://recurse.com">recently</a>.</p>


</div></div>
  </body>
</html>
