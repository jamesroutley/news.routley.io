<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://david.deno.dev/posts/faster-prettier-with-dprint/">Original</a>
    <h1>Speeding up Prettier locally and on your CI with dprint</h1>
    
    <div id="readability-page-1" class="page"><div>
      <article>
  

  <div>
    <p><a href="https://prettier.io/">Prettier</a> is a JavaScript-based code formatter with
support for many languages.</p>
<p><a href="https://dprint.dev">dprint</a> is a Rust-based code formatting platform that
formats code with formatting plugins including a Prettier plugin.</p>
<h2>Overview</h2>
<p>Many developers often run a step to verify their code has been formatted with an
automated code formatter like Prettier.</p>
<p>In this post, we&#39;ll speed up Prettier&#39;s format checking of a TypeScript codebase
from ~40s to under 1s on the second run.</p>
<h2>Previous Prettier setup</h2>
<p>Say we have a Node-based repo with about 520 TypScript files in the <code>src</code> folder
for a total size of 16MB. This repo has a <em>package.json</em> with Prettier installed
that verifies formatting. It looks similar to the following:</p>
<pre><code>
<span>{</span>
  
  <span>&#34;scripts&#34;</span><span>:</span> <span>{</span>
    <span>&#34;fmt-check&#34;</span><span>:</span> <span>&#34;prettier --check --end-of-line lf \&#34;src/**/*.ts\&#34;&#34;</span>
  <span>}</span><span>,</span>
  <span>&#34;devDependencies&#34;</span><span>:</span> <span>{</span>
    <span>&#34;prettier&#34;</span><span>:</span> <span>&#34;^2.6.2&#34;</span>
  <span>}</span>
<span>}</span>
</code></pre>
<p>Verification is run by executing the <code>fmt-check</code> script:</p>
<pre><code>npm run fmt-check
</code></pre>
<p>Our GitHub actions CI executes the following steps:</p>
<pre><code>
<span>steps:</span>
  
<span>-</span> <span>uses:</span> <span>actions/checkout@v3</span>
  
<span>-</span> <span>uses:</span> <span>actions/setup-node@v3</span>
  <span>with:</span>
    <span>node-version:</span> <span>&#39;16&#39;</span>
  
<span>-</span> <span>name:</span> <span>Cache</span>
  <span>uses:</span> <span>actions/cache@v3</span>
  <span>with:</span>
    <span>path:</span> <span>|
      ~/.npm
</span>    <span>key:</span> <span>${{</span> <span>runner.os</span> <span>}}-node-${{</span> <span>hashFiles(&#39;**/package-lock.json&#39;)</span> <span>}}</span>
  
<span>-</span> <span>run:</span> <span>npm</span> <span>ci</span>
  
<span>-</span> <span>name:</span> <span>prettier</span>
  <span>run:</span> <span>npm</span> <span>run</span> <span>fmt-check</span>
</code></pre>
<p>When running this on our CI, the &#34;prettier&#34; step takes about 41s.</p>
<p><img src="https://david.deno.dev/posts/faster-prettier-with-dprint/initial_prettier_ci_run.png" alt="Prettier&#39;s workflow step taking 41s to run."/></p>
<h2>Switching to dprint</h2>
<p>We can speed this up by using dprint as our code formatting CLI with the
<a href="https://github.com/dprint/dprint-plugin-prettier">dprint-plugin-prettier</a>
plugin.</p>
<h3>CLI setup</h3>
<p>To begin, run the following commands in the root directory of the project:</p>
<pre><code>
npm install --save-dev dprint

npx dprint init 

npx dprint config add dprint/dprint-plugin-prettier
</code></pre>
<p>A <em>dprint.json</em> file will have been created with the Prettier plugin specified:</p>
<pre><code>
<span>{</span>
  <span>&#34;includes&#34;</span><span>:</span> <span>[</span><span>&#34;**/*.*&#34;</span><span>]</span><span>,</span>
  <span>&#34;excludes&#34;</span><span>:</span> <span>[</span><span>]</span><span>,</span>
  <span>&#34;plugins&#34;</span><span>:</span> <span>[</span>
    <span>&#34;https://plugins.dprint.dev/prettier-0.7.0.json@4e846f43b32981258cef5095b3d732522947592e090ef52333801f9d6e8adb33&#34;</span>
  <span>]</span>
<span>}</span>
</code></pre>
<p>For this example, update the <code>includes</code> glob to only have the <code>src</code> directory
and match the extensions Prettier supports that you use in your project. In this
case, I&#39;m only interested in formatting ts files, but in your case you may
specify any of the file extensions Prettier supports (ex.
<code>src/**/*.{ts,js,html,css}</code>).</p>
<!-- deno-fmt-ignore -->
<pre><code>
<span>{</span>
  <span>&#34;includes&#34;</span><span>:</span> <span>[</span><span>&#34;src/**/*.ts&#34;</span><span>]</span><span>,</span>
  <span>&#34;excludes&#34;</span><span>:</span> <span>[</span><span>]</span><span>,</span>
  <span>&#34;prettier&#34;</span><span>:</span> <span>{</span>
    
  <span>}</span><span>,</span>
  
<span>}</span>
</code></pre>
<p>Now remove <code>prettier</code> from your <em>package.json</em> and update the <code>fmt-check</code> script
to use the <code>dprint check</code> command instead:</p>
<pre><code>
<span>{</span>
  
  <span>&#34;scripts&#34;</span><span>:</span> <span>{</span>
    <span>&#34;fmt-check&#34;</span><span>:</span> <span>&#34;dprint check&#34;</span>
  <span>}</span><span>,</span>
  <span>&#34;devDependencies&#34;</span><span>:</span> <span>{</span>
    <span>&#34;dprint&#34;</span><span>:</span> <span>&#34;^0.25.1&#34;</span>
  <span>}</span>
<span>}</span>
</code></pre>
<p>Try running <code>npm run fmt-check</code> locally a couple times. The first time will be
faster than Prettier because it formats files on multiple threads using Prettier
snapshotted in a Deno runtime (via
<a href="https://crates.io/crates/deno_core">deno_core</a>). The second run should complete
almost instantaneously because dprint will skip files it already knows are
formatted based on past runs.</p>
<h3>CI setup</h3>
<p>Although the above changes will be faster than Prettier as-is in the CI, we want
to take advantage of dprint&#39;s incremental formatting and save its cache.</p>
<p>To do this, we need to update our GitHub actions file to cache the
<code>~/.cache/dprint</code> folder and also use <code>dprint.json</code> as a cache key in order to
bust the cache whenever we update the <em>dprint.json</em> file:</p>
<pre><code>
<span>steps:</span>
  
<span>-</span> <span>uses:</span> <span>actions/checkout@v3</span>
  
<span>-</span> <span>uses:</span> <span>actions/setup-node@v3</span>
  <span>with:</span>
    <span>node-version:</span> <span>&#39;16&#39;</span>
  
<span>-</span> <span>name:</span> <span>Cache</span>
  <span>uses:</span> <span>actions/cache@v3</span>
  <span>with:</span>
    <span>path:</span> <span>|
      ~/.npm
      ~/.cache/dprint
</span>    <span>key:</span> <span>${{</span> <span>runner.os</span> <span>}}-node-${{</span> <span>hashFiles(&#39;**/package-lock.json&#39;,</span> <span>&#39;**/dprint.json&#39;</span><span>)</span> <span>}}</span>
  
<span>-</span> <span>run:</span> <span>npm</span> <span>ci</span>
  
<span>-</span> <span>name:</span> <span>dprint</span> <span>w/</span> <span>dprint-plugin-prettier</span>
  <span>run:</span> <span>npm</span> <span>run</span> <span>fmt-check</span>
</code></pre>
<h3>Testing it out</h3>
<p>On first run, we can see dprint takes 35s to execute:</p>
<p><img src="https://david.deno.dev/posts/faster-prettier-with-dprint/initial_dprint_ci_run.png" alt="Dprint&#39;s workflow step taking 35s to execute."/></p>
<p>This is only slightly better than Prettier because our GitHub action runner only
has 2 cores. It&#39;s still not great. Looking at the &#34;Post Cache&#34; step output, we
can see our cache was saved:</p>
<p><img src="https://david.deno.dev/posts/faster-prettier-with-dprint/post_cache_step.png" alt="Shows the &#34;Post Cache&#34; workflow step uploading the cache to be downloaded for next time."/></p>
<p>Let&#39;s test running our CI again by pushing a message only commit:</p>
<pre><code>git commit --allow-empty --only -m <span>&#34;Test out incremental formatting.&#34;</span>
git push
</code></pre>
<p>Watching the GitHub action workflow run, we can see the cache being loaded:</p>
<p><img src="https://david.deno.dev/posts/faster-prettier-with-dprint/cache_load_step.png" alt="Shows the &#34;Cache&#34; workflow step downloading the cache we saved from the last workflow run."/></p>
<p>...and the formatting verification step now takes under 1 second to run:</p>
<p><img src="https://david.deno.dev/posts/faster-prettier-with-dprint/incremental_dprint_ci_run.png" alt="Dprint&#39;s workflow step now showing as taking 0s to run."/></p>
<h2>Final notes</h2>
<p>We&#39;ve seen how we can use <a href="https://dprint.dev">dprint</a>&#39;s CLI to speed up
formatting with Prettier. For an example repo, see
<a href="https://github.com/dsherret/faster_prettier_example">faster_prettier_example</a>.</p>
<p>This is great for projects already using Prettier that don&#39;t want to switch to a
new formatter, but the initial format without an incremental cache was still
kind of slow. We could speed it up by using dprint&#39;s TypeScript and JavaScript
Rust-based code formatter instead (see
<a href="https://dprint.dev/plugins/typescript/">dprint-plugin-typescript</a>) with the
caveat that it will format code slightly differently that Prettier (but it has a
lot of configuration settings you could tune to try to get it close).</p>
<p>In this scenario, on the CI it takes 10s to run the first time before the cache
gets it under 1s:</p>
<p><img src="https://david.deno.dev/posts/faster-prettier-with-dprint/initial_dprint-plugin-typescript_ci_run.png" alt="dprint-plugin-typescript&#39;s workflow step taking 10s to run the first time."/></p>
<p>Thanks for reading!</p>

  </div>
</article>

    </div></div>
  </body>
</html>
