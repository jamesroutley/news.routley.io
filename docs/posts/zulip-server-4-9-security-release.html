<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.zulip.com/2022/01/25/zulip-server-4-9-security-release/">Original</a>
    <h1>Zulip Server 4.9 security release</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
    <article>

        <header>

            <section>
                <a href="https://blog.zulip.com/tag/release-announcements/">Release announcements</a>
            </section>

            


            <div>
                <section>
                    <ul>
                        <li>
                            <a href="https://apenwarr.ca/author/alex/">
                                <img src="https://www.gravatar.com/avatar/6040af6e26d481c0e5fd4ac2fe4ea460?s=250&amp;d=mm&amp;r=x" alt="Alex Vandiver"/>
                            </a>
                        </li>
                    </ul>
                    <div>
                        
                        <p><time datetime="2022-01-24">Jan 24, 2022</time>
                            <span><span>•</span> 5 min read</span>
                        </p>
                    </div>
                </section>
            </div>

        </header>

        <section>
            <p>We released Zulip Server 4.9 today! This is a security release, containing critical security fixes, as well as important cherry-picked bug fixes, since Zulip Server 4.8.</p><h2 id="upgrading"><strong><strong><strong>Upgrading</strong></strong></strong></h2><p>We strongly recommend that all installations upgrade to this new release. See the <a href="https://zulip.readthedocs.io/en/stable/production/upgrade-or-modify.html#upgrading-to-a-release" rel="noreferrer nofollow noopener"><u>upgrade instructions</u></a> in the Zulip documentation. If you need help, best-effort support is available on <u><a href="https://zulip.com/developer-community/">chat.zulip.org</a></u>.</p><h2 id="reminder-upgrade-your-host-operating-system">Reminder: upgrade your host operating system</h2><p>As a reminder, <a href="https://blog.zulip.com/2021/12/01/zulip-server-4-8-security-release/">we have deprecated</a> support for Ubuntu 18.04 Bionic, because the upstream vendor no longer provides security support for important Zulip dependencies. Specifically, Ubuntu 18.04 remains supported in this release and will be supported in the rest of the Zulip Server 4.x series, but will not be supported in the upcoming Zulip Server 5.0 release.</p><p>We recommend planning to upgrade any Zulip servers you manage which are running on Ubuntu 18.04 over the next few months. See our <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-the-operating-system">OS upgrade documentation</a> for how to correctly upgrade a Zulip server.</p><h2 id="notable-changes">Notable changes</h2><ul><li><a href="#cve-2021-43799-remote-code-execution-vulnerability-involving-rabbitmq">CVE-2021-43799</a>: Remote execution of code involving RabbitMQ. <a href="#cve-2021-43799-remote-code-execution-vulnerability-involving-rabbitmq">See below</a> for more details.</li><li>Closed access to RabbitMQ port 25672; initial installs tried to close this port, but failed to restart RabbitMQ for the configuration.</li><li>Removed the <code>rabbitmq.nodename</code> configuration in <code>zulip.conf</code>; all RabbitMQ instances will be reconfigured to have a nodename of <code>zulip@localhost</code>. You can remove this setting from your <code>zulip.conf</code> configuration file, if it exists.</li><li>Added missing support for the Camo image proxy in the <a href="https://github.com/zulip/docker-zulip">Docker image</a>. This resolves a longstanding issue with image previews, if enabled, appearing as broken images for Docker-based installs.</li><li>Fixed a bug which allowed a user to edit a message to add a wildcard mention when they did not have permissions to send such messages originally.</li><li>Fixed a bug in the <a href="https://blog.zulip.com/2021/07/22/zulip-server-4-4/#fixing-potential-database-corruption-caused-by-host-os-upgrades">tool that corrects database corruption</a> caused by updating the operating system hosting PostgreSQL, which previously omitted some indexes from its verification. If you updated the operating system of your Zulip instance from Ubuntu 18.04 to 20.04, or from Debian Stretch to Debian Buster, you should run the tool, even if you did so previously; full details and instructions are available in <a href="https://blog.zulip.com/2021/07/22/zulip-server-4-4/#fixing-potential-database-corruption-caused-by-host-os-upgrades">the previous blog post</a>.</li><li>Began routing requests from the Camo image proxy through a non-Smokescreen proxy, if one is configured; because Camo includes logic to deny access to private subnets, routing its requests through Smokescreen is generally not necessary.</li><li>Fixed a bug where changing the Camo secret required running <code>zulip-puppet-apply</code>.</li><li>Fixed <code>scripts/setup/compare-settings-to-template</code> to be able to run from any directory.</li><li>Switched Let&#39;s Encrypt renewal to use its own timer, rather than our custom cron job. This fixes a bug where occasionally <code>nginx</code> would not reload after getting an updated certificate.</li><li>Updated documentation and tooling to note that installs using <code>upgrade-zulip-from-git</code> require 3 GB of RAM, or 2 GB and at least 1 GB of swap.</li></ul><p>This release fixes a critical security vulnerability: CVE-2021-43799. Due to a combination of bugs (detailed below), some Zulip servers that have not been rebooted since installation have an insecure RabbitMQ configuration that can be exploited for <strong>remote execution of arbitrary code</strong>. This issue affects all previously released versions of Zulip.</p><p>The underlying vulnerability also affects any Debian or Ubuntu system that has installed the <code>rabbitmq-server</code> package. Unless the issue is separately blocked by a firewall, just <code>apt install rabbitmq-server</code> is sufficient to make your system vulnerable to remote code execution due to this issue.</p><p>For context, <a href="https://www.rabbitmq.com/">RabbitMQ</a> is a clustered database optimized around managing queues, written in <a href="https://www.erlang.org/">Erlang</a>. Zulip uses RabbitMQ to send data to other parts of the application.</p><p>The combination of bugs is as follows:</p><ul><li>RabbitMQ opens port 25672 as a “<a href="https://www.erlang.org/doc/apps/erts/erl_dist_protocol.html">distribution port</a>,” used for inter-node communication in RabbitMQ clusters. Port 25672 is secured via an Erlang “<a href="https://www.erlang.org/doc/reference_manual/distributed.html#security">magic cookie</a>;” however, Erlang’s default scheme for generating this cookie uses an insecure randomizer, and can be easily brute-forced by a remote process that can access that port. Neither the Debian/Ubuntu packages for <code>rabbitmq-server</code> nor Zulip&#39;s own configuration overrode that default randomizer. Successful access to the distribution port allows arbitrary execution of code, by design.</li><li>Zulip’s configuration was intended to configure RabbitMQ to only listen on <code>localhost</code> for port 25672. However, a subtle bug in Zulip’s configuration resulted in some Zulip installations incorrectly having port 25672 listening on all interfaces until the service or server was restarted.</li></ul><p>Together, these issues mean that a newly installed Zulip server is vulnerable to a brute force attack leading to arbitrary code execution as the <code>rabbitmq</code> system user. This system user only has direct access to RabbitMQ traffic (which includes the content of all new Zulip messages sent on the server). But any system user access on a server can potentially be combined with any unpatched privilege escalation vulnerabilities in the host operating system for greater access.</p><h2 id="mitigation-and-patching">Mitigation and patching</h2><p>This vulnerability is mitigated by restarting RabbitMQ with <code>service rabbitmq-server restart</code>, which will ensure Zulip’s existing configuration to limit access to port 25672 is in effect.</p><p>The Zulip upgrade tool patches CVE-2021-43799 by regenerating the Erlang magic cookie using a secure algorithm, and fixing the bug that made it possible for port 25672 to remain open.</p><p>While we recommend installing this upgrade promptly, using a firewall to block port 25672 to your Zulip server is an effective way to mitigate risk (though doing so only prevents attacks coming from outside the firewall).</p><p>We also suggest that you use a firewall to block port 4369, the Erlang <code>epmd</code> “mapping demon” port, which is also accessible on all interfaces. This security release does not close port 4369 down to <code>localhost</code>, because multiple overlapping bugs in Erlang and Ubuntu make it difficult to do so reliably. While we are not aware of any vulnerabilities in the <code>epmd</code> server listening on this port, it is only of use in RabbitMQ clustering situations, and there is never any reason to expose it to the public Internet.</p><p><strong>Zulip development environments</strong></p><h2 id="concluding-thoughts">Concluding thoughts</h2><p>CVE-2021-43799 was discovered by the Zulip security team. However, the underlying issues with Erlang’s “magic cookie” randomizer <a href="https://www.erlang.org/doc/reference_manual/distributed.html#security">have been documented for years</a> with publicly-available exploit code, so it is highly likely that threat actors are already actively exploiting the broader issue with RabbitMQ, as well as other services written in Erlang.</p><p>Previously, <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-1279" rel="noreferrer nofollow noopener">CVE-2018-1279</a> was filed for a similar vulnerability in RabbitMQ, but was overly-specific about the affected software, and understated the impact of the vulnerability.  That CVE was <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=924768">noted by Debian</a>, but its scope was misunderstood, and it was mistakenly marked &#34;fixed&#34; by an unrelated change in a different package.</p><p>We were very disappointed to discover that this important security issue with Erlang and RabbitMQ has been public for years, and not addressed by upstream projects before now. As part of preparing this release, we reported to both Debian and Ubuntu that <code>apt install rabbitmq-server</code> opens servers to remote execution of code, with the goal of doing a coordinated public disclosure around this issue.</p><p><a href="https://metadata.ftp-master.debian.org/changelogs//main/r/rabbitmq-server/rabbitmq-server_3.9.8-3_changelog">Debian published the <code>rabbitmq-server</code> 3.9.8-3 release to <code>unstable</code> today</a> in response to our report. This change has not yet been backported to stable releases, and as of this writing, neither Debian nor Ubuntu has told us they plan to issue a security advisory. For non-Zulip installs, upgrading to the <code>3.9.8-3</code> Debian release of <code>rabbitmq-server</code> will not correct existing vulnerable Debian/Ubuntu installations with insecure magic cookies; it only improves cookie generation for new installations. We continue to advocate for a security advisory, as well as an updated release that will patch vulnerable systems on upgrade.</p><p>Our postmortem plans in response to this incident include accelerating the timeline on existing plans to replace RabbitMQ with a different tool for managing queues.</p><p>We love feedback from the Zulip user community. Here are a few ways you can connect:</p><ul><li>Join <u><a href="https://zulip.com/developer-community/">chat.zulip.org</a></u> and provide feedback directly to the development community!</li><li><a href="https://twitter.com/zulip" rel="noreferrer nofollow noopener"><u>Follow us on Twitter</u></a>, or join our <a href="https://groups.google.com/forum/#!forum/zulip-announce" rel="noreferrer nofollow noopener"><u>announcement mailing list</u></a> (or <a href="https://blog.zulip.com/#subscribe" rel="noreferrer nofollow noopener"><u>subscribe to the blog posts</u></a>, which are mostly a subset of the already low-volume mailing list).</li></ul>
        </section>


    </article>
</div></div>
  </body>
</html>
