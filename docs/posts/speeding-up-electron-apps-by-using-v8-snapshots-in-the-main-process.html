<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/RaisinTen/electron-snapshot-experiment">Original</a>
    <h1>Speeding up Electron apps by using V8 snapshots in the main process</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">This experiment shows how you can use V8 snapshot to speed up the <code>require()</code>s for the main process of your Electron application by <strong>more than 80%!</strong></p>
<p dir="auto">(All measurements have been peformed on an <code>x86_64</code> macOS running Sonoma <code>14.6.1</code>.)</p>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/before.png"><img src="https://github.com/RaisinTen/electron-snapshot-experiment/raw/main/before.png" alt=""/></a></p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Total startup time</td>
<td>426ms</td>
</tr>
<tr>
<td>Total <code>require()</code>s time</td>
<td>215ms</td>
</tr>
<tr>
<td>Electron startup time</td>
<td>211ms</td>
</tr>
<tr>
<td>Electron binary size</td>
<td>227MB</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/after.png"><img src="https://github.com/RaisinTen/electron-snapshot-experiment/raw/main/after.png" alt=""/></a></p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Total startup time</td>
<td>272ms</td>
</tr>
<tr>
<td>Total <code>require()</code>s time</td>
<td>41ms</td>
</tr>
<tr>
<td>Electron startup time</td>
<td>231ms</td>
</tr>
<tr>
<td>Electron binary size</td>
<td>238MB</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<p dir="auto">This has successfully removed 81% of the time spent running all the <code>require()</code>s causing an overall 36% performance improvement to the total startup time with minor changes to the Electron startup time and binary sizes!</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th></th>
<th>Before</th>
<th>After</th>
<th>Difference</th>
<th>% change</th>
</tr>
</thead>
<tbody>
<tr>
<td>Total startup time</td>
<td>426ms</td>
<td>272ms</td>
<td>154ms</td>
<td>36%</td>
</tr>
<tr>
<td>Total <code>require()</code>s time</td>
<td>215ms</td>
<td>41ms</td>
<td>174ms</td>
<td>81%</td>
</tr>
<tr>
<td>Electron startup time</td>
<td>211ms</td>
<td>231ms</td>
<td>-20ms</td>
<td>-10%</td>
</tr>
<tr>
<td>Electron binary size</td>
<td>227MB</td>
<td>238MB</td>
<td>-11MB</td>
<td>-5%</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>

<ol dir="auto">
<li><code>yarn</code> - Installs the dependency modules and applies the patches from <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/patches"><code>patches</code></a>.</li>
<li><code>yarn use-snapshot</code> - Generates the V8 snapshot which contains the compilation and execution results of the dependency modules.</li>
<li><code>yarn start</code> - Starts the application at improved speed because it uses the V8 snapshot. Quitting the app would write the <code>events.json</code> file created by <a href="https://github.com/RaisinTen/perftrace"><code>perftrace</code></a> which can be opened up in <a href="https://ui.perfetto.dev" rel="nofollow">https://ui.perfetto.dev</a> to view the performance traces.</li>
<li><code>yarn reset-snapshot</code> - Stops using the V8 snapshot.</li>
<li><code>yarn start</code> - Starts the application but does not use the V8 snapshot. Quitting the app would write the <code>events.json</code> file created by <a href="https://github.com/RaisinTen/perftrace"><code>perftrace</code></a> which can be opened up in <a href="https://ui.perfetto.dev" rel="nofollow">https://ui.perfetto.dev</a> to view the performance traces.</li>
</ol>

<p dir="auto"><a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/main.js"><code>main.js</code></a> is the code for a typical Electron application that <code>require()</code>s a bunch of JS dependencies, runs some setup code and then opens a window. Of the total 426ms startup time, the <code>require()</code>s alone take up 215ms, which is 50%! We can reduce this further by using V8 snapshot.</p>
<section data-identity="ed57aa63-99ea-4c6f-a151-c5732f9954f3" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div data-json="{&#34;data&#34;:&#34;flowchart TD\n\nsubgraph Dependency installation\n  yarn -- installs --&amp;gt; node_modules\n  node_modules -- manually copied over --&amp;gt; unsnapshottable.js\n  node_modules -- patch-package --&amp;gt; snapshottable-code[\&#34;snapshottable code\&#34;]\nend\n\nsubgraph Generating the snapshot\n  snapshot.js -- require(...) --&amp;gt; snapshottable-code\n  snapshot.js -- electron-link --&amp;gt; cache/snapshot.js\n  cache/snapshot.js -- electron-mksnapshot --&amp;gt; v8_context_snapshot.x86_64.bin &amp;amp; snapshot_blob.bin\n  v8_context_snapshot.x86_64.bin -- renamed --&amp;gt; browser_v8_context_snapshot.bin\n  browser_v8_context_snapshot.bin -- copied into --&amp;gt; electron-bundle[\&#34;electron bundle\&#34;]\n  electron-fuses[\&#34;@electron/fuses\&#34;] -- flip LoadBrowserProcessSpecificV8Snapshot fuse to true --&amp;gt; electron-bundle\nend\n\nsubgraph App using the snapshot\n  electron -- loads --&amp;gt; browser_v8_context_snapshot.bin\n  electron -- runs --&amp;gt; main.js -- runs --&amp;gt; v8-snapshots-util.js\n  v8-snapshots-util.js -- monkey-patches --&amp;gt; require[\&#34;require(...)\&#34;] -- load modules from --&amp;gt; browser_v8_context_snapshot.bin\n  main.js -- hydrates the snapshot --&amp;gt; unsnapshottable.js\n  main.js --&amp;gt; require\nend\n&#34;}" data-plain="flowchart TD

subgraph Dependency installation
  yarn -- installs --&gt; node_modules
  node_modules -- manually copied over --&gt; unsnapshottable.js
  node_modules -- patch-package --&gt; snapshottable-code[&#34;snapshottable code&#34;]
end

subgraph Generating the snapshot
  snapshot.js -- require(...) --&gt; snapshottable-code
  snapshot.js -- electron-link --&gt; cache/snapshot.js
  cache/snapshot.js -- electron-mksnapshot --&gt; v8_context_snapshot.x86_64.bin &amp; snapshot_blob.bin
  v8_context_snapshot.x86_64.bin -- renamed --&gt; browser_v8_context_snapshot.bin
  browser_v8_context_snapshot.bin -- copied into --&gt; electron-bundle[&#34;electron bundle&#34;]
  electron-fuses[&#34;@electron/fuses&#34;] -- flip LoadBrowserProcessSpecificV8Snapshot fuse to true --&gt; electron-bundle
end

subgraph App using the snapshot
  electron -- loads --&gt; browser_v8_context_snapshot.bin
  electron -- runs --&gt; main.js -- runs --&gt; v8-snapshots-util.js
  v8-snapshots-util.js -- monkey-patches --&gt; require[&#34;require(...)&#34;] -- load modules from --&gt; browser_v8_context_snapshot.bin
  main.js -- hydrates the snapshot --&gt; unsnapshottable.js
  main.js --&gt; require
end
" dir="auto">
    <div dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">flowchart TD

subgraph Dependency installation
  yarn -- installs --&gt; node_modules
  node_modules -- manually copied over --&gt; unsnapshottable.js
  node_modules -- patch-package --&gt; snapshottable-code[&#34;snapshottable code&#34;]
end

subgraph Generating the snapshot
  snapshot.js -- require(...) --&gt; snapshottable-code
  snapshot.js -- electron-link --&gt; cache/snapshot.js
  cache/snapshot.js -- electron-mksnapshot --&gt; v8_context_snapshot.x86_64.bin &amp; snapshot_blob.bin
  v8_context_snapshot.x86_64.bin -- renamed --&gt; browser_v8_context_snapshot.bin
  browser_v8_context_snapshot.bin -- copied into --&gt; electron-bundle[&#34;electron bundle&#34;]
  electron-fuses[&#34;@electron/fuses&#34;] -- flip LoadBrowserProcessSpecificV8Snapshot fuse to true --&gt; electron-bundle
end

subgraph App using the snapshot
  electron -- loads --&gt; browser_v8_context_snapshot.bin
  electron -- runs --&gt; main.js -- runs --&gt; v8-snapshots-util.js
  v8-snapshots-util.js -- monkey-patches --&gt; require[&#34;require(...)&#34;] -- load modules from --&gt; browser_v8_context_snapshot.bin
  main.js -- hydrates the snapshot --&gt; unsnapshottable.js
  main.js --&gt; require
end
</pre>
    </div>
  </div>
  <span role="presentation">
    <span data-view-component="true">
  <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true" data-view-component="true">
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
    <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>    <span>Loading</span>
</span>
  </span>
</section>

<p dir="auto">Let&#39;s break this down!</p>

<section data-identity="34031d3e-95ec-40c9-838d-b4450d4e591c" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div data-json="{&#34;data&#34;:&#34;flowchart TD\n\nyarn -- installs --&amp;gt; node_modules\nnode_modules -- manually copied over --&amp;gt; unsnapshottable.js\nnode_modules -- patch-package --&amp;gt; snapshottable-code[\&#34;snapshottable code\&#34;]\n&#34;}" data-plain="flowchart TD

yarn -- installs --&gt; node_modules
node_modules -- manually copied over --&gt; unsnapshottable.js
node_modules -- patch-package --&gt; snapshottable-code[&#34;snapshottable code&#34;]
" dir="auto">
    <div dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">flowchart TD

yarn -- installs --&gt; node_modules
node_modules -- manually copied over --&gt; unsnapshottable.js
node_modules -- patch-package --&gt; snapshottable-code[&#34;snapshottable code&#34;]
</pre>
    </div>
  </div>
  <span role="presentation">
    <span data-view-component="true">
  <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true" data-view-component="true">
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
    <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>    <span>Loading</span>
</span>
  </span>
</section>

<p dir="auto">When <code>yarn</code> is run, it installs the dependencies of the project and also runs the postinstall script to patch the installed packages, so that those could be added to the V8 snapshot.</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16"> <span>&#34;postinstall&#34;</span>: <span><span>&#34;</span>patch-package<span>&#34;</span></span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">The <a href="https://v8.dev/blog/custom-startup-snapshots" rel="nofollow">V8 snapshot</a> is just a serialized heap of V8. During application startup, the V8 heap is deserialized from the snapshot, so that we have the <a href="https://v8.dev/docs/embed#contexts" rel="nofollow">V8 context</a> populated with the same JS objects that were present during the snapshot creation. There is an important limitation to V8 snapshots: the snapshot can only capture V8&#39;s heap. Any interaction from V8 with the outside is off-limits when creating the snapshot. This includes usage of functionalities from the Node.js or Electron runtime that do not belong to the JS language - things like the <code>require(&#39;http&#39;)</code> builtin module, the global <code>process</code> object, etc. To include a dependency module into the V8 snapshot, we need to make sure that executing the module code doesn&#39;t require the presence of anything that is not already a part of the JS language.</p>
<p dir="auto">Executing this code would require the presence of <code>require()</code> from Node.js and the https module object, so that it can be monkey-patched. This code cannot be a part of the V8 snapshot because neither of the two are a part of the JS language:</p>
<div dir="auto" data-snippet-clipboard-copy-content="const https = require(&#39;https&#39;);
https.get = function (_url, _options, cb) {
  // ...
};"><pre><span>const</span> <span>https</span> <span>=</span> <span>require</span><span>(</span><span>&#39;https&#39;</span><span>)</span><span>;</span>
<span>https</span><span>.</span><span>get</span> <span>=</span> <span>function</span> <span>(</span><span>_url</span><span>,</span> <span>_options</span><span>,</span> <span>cb</span><span>)</span> <span>{</span>
  <span>// ...</span>
<span>}</span><span>;</span></pre></div>
<p dir="auto">However, once our Electron app starts running, we would be able to run this code because by then, <code>require()</code> and the https module object would be available. This means that to make this script snapshottable, we would need to patch it, so that we can move the unsnapshottable code out of this script and run it during application startup after this script has been deserialized from the V8 snapshot.</p>
<p dir="auto">When <code>patch-package</code> is run, it applies the patches from <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/patches"><code>patches</code></a> which removes the unsnapshottable code from the modules. The unsnapshottable code is then moved over to <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/unsnapshottable.js"><code>unsnapshottable.js</code></a> which is run during application startup in <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/6f2c267c04bc97861e6df1ab409f61f3e2f80c01/main.js#L22"><code>main.js</code></a>.</p>

<section data-identity="789336de-a151-4c91-bf05-21b4281c13a1" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div data-json="{&#34;data&#34;:&#34;flowchart TD\n\nsnapshot.js -- require(...) --&amp;gt; snapshottable-code[\&#34;snapshottable code\&#34;]\nsnapshot.js -- electron-link --&amp;gt; cache/snapshot.js\ncache/snapshot.js -- electron-mksnapshot --&amp;gt; v8_context_snapshot.x86_64.bin &amp;amp; snapshot_blob.bin\nv8_context_snapshot.x86_64.bin -- renamed --&amp;gt; browser_v8_context_snapshot.bin\nbrowser_v8_context_snapshot.bin -- copied into --&amp;gt; electron-bundle[\&#34;electron bundle\&#34;]\nelectron-fuses[\&#34;@electron/fuses\&#34;] -- flip LoadBrowserProcessSpecificV8Snapshot fuse to true --&amp;gt; electron-bundle\n&#34;}" data-plain="flowchart TD

snapshot.js -- require(...) --&gt; snapshottable-code[&#34;snapshottable code&#34;]
snapshot.js -- electron-link --&gt; cache/snapshot.js
cache/snapshot.js -- electron-mksnapshot --&gt; v8_context_snapshot.x86_64.bin &amp; snapshot_blob.bin
v8_context_snapshot.x86_64.bin -- renamed --&gt; browser_v8_context_snapshot.bin
browser_v8_context_snapshot.bin -- copied into --&gt; electron-bundle[&#34;electron bundle&#34;]
electron-fuses[&#34;@electron/fuses&#34;] -- flip LoadBrowserProcessSpecificV8Snapshot fuse to true --&gt; electron-bundle
" dir="auto">
    <div dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">flowchart TD

snapshot.js -- require(...) --&gt; snapshottable-code[&#34;snapshottable code&#34;]
snapshot.js -- electron-link --&gt; cache/snapshot.js
cache/snapshot.js -- electron-mksnapshot --&gt; v8_context_snapshot.x86_64.bin &amp; snapshot_blob.bin
v8_context_snapshot.x86_64.bin -- renamed --&gt; browser_v8_context_snapshot.bin
browser_v8_context_snapshot.bin -- copied into --&gt; electron-bundle[&#34;electron bundle&#34;]
electron-fuses[&#34;@electron/fuses&#34;] -- flip LoadBrowserProcessSpecificV8Snapshot fuse to true --&gt; electron-bundle
</pre>
    </div>
  </div>
  <span role="presentation">
    <span data-view-component="true">
  <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true" data-view-component="true">
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
    <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>    <span>Loading</span>
</span>
  </span>
</section>

<p dir="auto">The V8 snapshot is generated by running <code>yarn use-snapshot</code>.</p>
<p dir="auto">It executes the <a href="https://github.com/atom/electron-link"><code>electron-link</code></a> module to generate the <code>cache/snapshot.js</code> file from <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/snapshot.js"><code>snapshot.js</code></a>:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L10" data-line-number="10"></td>
          <td id="LC10"> <span>const</span> <span>baseDirPath</span> <span>=</span> <span>path</span><span>.</span><span>resolve</span><span>(</span><span>__dirname</span><span>,</span> <span>&#39;..&#39;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L11" data-line-number="11"></td>
          <td id="LC11">  </td>
        </tr>

        <tr>
          <td id="L12" data-line-number="12"></td>
          <td id="LC12"> <span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;Creating a linked script..&#39;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L13" data-line-number="13"></td>
          <td id="LC13"> <span>const</span> <span>result</span> <span>=</span> <span>await</span> <span>electronLink</span><span>(</span><span>{</span> </td>
        </tr>

        <tr>
          <td id="L14" data-line-number="14"></td>
          <td id="LC14">   <span>baseDirPath</span>: <span>baseDirPath</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L15" data-line-number="15"></td>
          <td id="LC15">   <span>mainPath</span>: <span>`<span><span>${</span><span>baseDirPath</span><span>}</span></span>/snapshot.js`</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16">   <span>cachePath</span>: <span>`<span><span>${</span><span>baseDirPath</span><span>}</span></span>/cache`</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17">   <span>shouldExcludeModule</span>: <span>(</span><span>modulePath</span><span>)</span> <span>=&gt;</span> <span>excludedModules</span><span>.</span><span>hasOwnProperty</span><span>(</span><span>modulePath</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18"> <span>}</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19">  </td>
        </tr>

        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20"> <span>const</span> <span>snapshotScriptPath</span> <span>=</span> <span>`<span><span>${</span><span>baseDirPath</span><span>}</span></span>/cache/snapshot.js`</span> </td>
        </tr>

        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21"> <span>fs</span><span>.</span><span>writeFileSync</span><span>(</span><span>snapshotScriptPath</span><span>,</span> <span>result</span><span>.</span><span>snapshotScript</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22">  </td>
        </tr>

        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23"> <span>// Verify if we will be able to use this in `mksnapshot`</span> </td>
        </tr>

        <tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24"> <span>vm</span><span>.</span><span>runInNewContext</span><span>(</span><span>result</span><span>.</span><span>snapshotScript</span><span>,</span> <span>undefined</span><span>,</span> <span>{</span><span>filename</span>: <span>snapshotScriptPath</span><span>,</span> <span>displayErrors</span>: <span>true</span><span>}</span><span>)</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto"><a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/snapshot.js"><code>snapshot.js</code></a> contains code that calls <code>require()</code> on all the dependency modules that can be a part of the V8 snapshot. <a href="https://github.com/atom/electron-link"><code>electron-link</code></a> starts from <code>snapshot.js</code> and traverses the entire require graph and replaces all the require calls to the builtin Node.js and Electron modules that cannot be a part of the V8 snapshot in each file with a function that will be called at runtime. The output, <code>cache/snapshot.js</code>, contains the code for all the modules reachable from the entry point.</p>
<p dir="auto">Consider these file contents:</p>
<p dir="auto"><strong><code>snapshot.js</code></strong></p>

<p dir="auto"><strong><code>node_modules/a/index.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const os = require(&#39;os&#39;);
exports.os = function () {  return os.version(); };
exports.tmpdir = function () {  return os.tmpdir(); };"><pre><span>const</span> <span>os</span> <span>=</span> <span>require</span><span>(</span><span>&#39;os&#39;</span><span>)</span><span>;</span>
<span>exports</span><span>.</span><span>os</span> <span>=</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>  <span>return</span> <span>os</span><span>.</span><span>version</span><span>(</span><span>)</span><span>;</span> <span>}</span><span>;</span>
<span>exports</span><span>.</span><span>tmpdir</span> <span>=</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>  <span>return</span> <span>os</span><span>.</span><span>tmpdir</span><span>(</span><span>)</span><span>;</span> <span>}</span><span>;</span></pre></div>
<p dir="auto">Passing these through <code>electron-link</code> would produce this <code>cache/snapshot.js</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="// ...
function generateSnapshot () {
  // ...
  function customRequire (modulePath) {
    // Polyfill of Node.js&#39; require() that is used in the V8 snapshot
    // to load the modules from the functions below.
  }
  // ...
    &#34;./snapshot.js&#34;: function (exports, module, __filename, __dirname, require, define) {
      require(&#34;./node_modules/a/index.js&#34;);

    },
    &#34;./node_modules/a/index.js&#34;: function (exports, module, __filename, __dirname, require, define) {
      let os;

      function get_os() {
        return os = os || require(&#39;os&#39;);
      }

      exports.os = function () {  return get_os().version(); };
      exports.tmpdir = function () {  return get_os().tmpdir(); };

    },
  // ...

  // Executes all the module contents and populates customRequire.cache with the exports objects.
  customRequire(&#34;./snapshot.js&#34;)
  return {
    customRequire,
    setGlobals: function (newGlobal, newProcess, newWindow, newDocument, newConsole, nodeRequire) {
      // Sets the globals in the V8 snapshot with the passed values.
    },
    // ...
  };
}
// ...

// Once the V8 heap gets deserialized from the V8 snapshot, this variable can be directly accessed in the entrypoint script.
var snapshotResult = generateSnapshot.call({})

// ..."><pre><span>// ...</span>
<span>function</span> <span>generateSnapshot</span> <span>(</span><span>)</span> <span>{</span>
  <span>// ...</span>
  <span>function</span> <span>customRequire</span> <span>(</span><span>modulePath</span><span>)</span> <span>{</span>
    <span>// Polyfill of Node.js&#39; require() that is used in the V8 snapshot</span>
    <span>// to load the modules from the functions below.</span>
  <span>}</span>
  <span>// ...</span>
    <span>&#34;./snapshot.js&#34;</span>: <span>function</span> <span>(</span><span>exports</span><span>,</span> <span>module</span><span>,</span> <span>__filename</span><span>,</span> <span>__dirname</span><span>,</span> <span>require</span><span>,</span> <span>define</span><span>)</span> <span>{</span>
      <span>require</span><span>(</span><span>&#34;./node_modules/a/index.js&#34;</span><span>)</span><span>;</span>

    <span>}</span><span>,</span>
    <span>&#34;./node_modules/a/index.js&#34;</span>: <span>function</span> <span>(</span><span>exports</span><span>,</span> <span>module</span><span>,</span> <span>__filename</span><span>,</span> <span>__dirname</span><span>,</span> <span>require</span><span>,</span> <span>define</span><span>)</span> <span>{</span>
      <span>let</span> <span>os</span><span>;</span>

      <span>function</span> <span>get_os</span><span>(</span><span>)</span> <span>{</span>
        <span>return</span> <span>os</span> <span>=</span> <span>os</span> <span>||</span> <span>require</span><span>(</span><span>&#39;os&#39;</span><span>)</span><span>;</span>
      <span>}</span>

      <span>exports</span><span>.</span><span>os</span> <span>=</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>  <span>return</span> <span>get_os</span><span>(</span><span>)</span><span>.</span><span>version</span><span>(</span><span>)</span><span>;</span> <span>}</span><span>;</span>
      <span>exports</span><span>.</span><span>tmpdir</span> <span>=</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>  <span>return</span> <span>get_os</span><span>(</span><span>)</span><span>.</span><span>tmpdir</span><span>(</span><span>)</span><span>;</span> <span>}</span><span>;</span>

    <span>}</span><span>,</span>
  <span>// ...</span>

  <span>// Executes all the module contents and populates customRequire.cache with the exports objects.</span>
  <span>customRequire</span><span>(</span><span>&#34;./snapshot.js&#34;</span><span>)</span>
  <span>return</span> <span>{</span>
    customRequire<span>,</span>
    <span>setGlobals</span>: <span>function</span> <span>(</span><span>newGlobal</span><span>,</span> <span>newProcess</span><span>,</span> <span>newWindow</span><span>,</span> <span>newDocument</span><span>,</span> <span>newConsole</span><span>,</span> <span>nodeRequire</span><span>)</span> <span>{</span>
      <span>// Sets the globals in the V8 snapshot with the passed values.</span>
    <span>}</span><span>,</span>
    <span>// ...</span>
  <span>}</span><span>;</span>
<span>}</span>
<span>// ...</span>

<span>// Once the V8 heap gets deserialized from the V8 snapshot, this variable can be directly accessed in the entrypoint script.</span>
<span>var</span> <span>snapshotResult</span> <span>=</span> <span>generateSnapshot</span><span>.</span><span>call</span><span>(</span><span>{</span><span>}</span><span>)</span>

<span>// ...</span></pre></div>
<p dir="auto">Executing the contents of the <code>cache/snapshot.js</code> script will not depend on anything that is not already a part of the JS language, so the resulting V8 heap at the end of running this script can be snapshotted and it would contain the exports of all the dependency modules.</p>
<p dir="auto">Then the <a href="https://github.com/electron/mksnapshot"><code>electron-mksnapshot</code></a> module is used to process the <code>cache/snapshot.js</code> script and generate the V8 snapshot:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L26" data-line-number="26"></td>
          <td id="LC26"> <span>const</span> <span>outputBlobPath</span> <span>=</span> <span>baseDirPath</span> </td>
        </tr>

        <tr>
          <td id="L27" data-line-number="27"></td>
          <td id="LC27"> <span>console</span><span>.</span><span>log</span><span>(</span><span>`Generating startup blob in &#34;<span><span>${</span><span>outputBlobPath</span><span>}</span></span>&#34;`</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L28" data-line-number="28"></td>
          <td id="LC28"> <span>childProcess</span><span>.</span><span>execFileSync</span><span>(</span> </td>
        </tr>

        <tr>
          <td id="L29" data-line-number="29"></td>
          <td id="LC29">   <span>path</span><span>.</span><span>resolve</span><span>(</span> </td>
        </tr>

        <tr>
          <td id="L30" data-line-number="30"></td>
          <td id="LC30">     <span>__dirname</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L31" data-line-number="31"></td>
          <td id="LC31">     <span>&#39;..&#39;</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L32" data-line-number="32"></td>
          <td id="LC32">     <span>&#39;node_modules&#39;</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L33" data-line-number="33"></td>
          <td id="LC33">     <span>&#39;.bin&#39;</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L34" data-line-number="34"></td>
          <td id="LC34">     <span>&#39;mksnapshot&#39;</span> <span>+</span> <span>(</span><span>process</span><span>.</span><span>platform</span> <span>===</span> <span>&#39;win32&#39;</span> ? <span>&#39;.cmd&#39;</span> : <span>&#39;&#39;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L35" data-line-number="35"></td>
          <td id="LC35">   <span>)</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L36" data-line-number="36"></td>
          <td id="LC36">   <span>[</span><span>snapshotScriptPath</span><span>,</span> <span>&#39;--output_dir&#39;</span><span>,</span> <span>outputBlobPath</span><span>]</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">It creates the <code>v8_context_snapshot.x86_64.bin</code> and <code>snapshot_blob.bin</code> files, of which only <code>v8_context_snapshot.x86_64.bin</code> is required.</p>
<p dir="auto">In <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/tools/copy-v8-snapshot.js"><code>tools/copy-v8-snapshot.js</code></a>, the <code>v8_context_snapshot.x86_64.bin</code> file is copied into the electron bundle and renamed to <code>browser_v8_context_snapshot.bin</code>. Then the <a href="https://github.com/electron/fuses"><code>@electron/fuses</code></a> module is used to flip the <a href="https://www.electronjs.org/docs/latest/tutorial/fuses#loadbrowserprocessspecificv8snapshot" rel="nofollow"><code>loadBrowserProcessSpecificV8Snapshot</code></a> fuse of the electron binary to <code>true</code>, so that during startup, the Electron browser process loads the V8 heap from the <code>browser_v8_context_snapshot.bin</code> V8 snapshot file.</p>

<section data-identity="b8dfb54d-34e7-454b-b8d5-628b8b03f995" data-host="https://viewscreen.githubusercontent.com" data-src="https://viewscreen.githubusercontent.com/markdown/mermaid?docs_host=https%3A%2F%2Fdocs.github.com" data-type="mermaid" aria-label="mermaid rendered output container">
  <div data-json="{&#34;data&#34;:&#34;flowchart TD\n\nelectron -- loads --&amp;gt; browser_v8_context_snapshot.bin\nelectron -- runs --&amp;gt; main.js -- runs --&amp;gt; v8-snapshots-util.js\nv8-snapshots-util.js -- monkey-patches --&amp;gt; require[\&#34;require(...)\&#34;] -- load modules from --&amp;gt; browser_v8_context_snapshot.bin\nmain.js -- hydrates the snapshot --&amp;gt; unsnapshottable.js\nmain.js --&amp;gt; require\n&#34;}" data-plain="flowchart TD

electron -- loads --&gt; browser_v8_context_snapshot.bin
electron -- runs --&gt; main.js -- runs --&gt; v8-snapshots-util.js
v8-snapshots-util.js -- monkey-patches --&gt; require[&#34;require(...)&#34;] -- load modules from --&gt; browser_v8_context_snapshot.bin
main.js -- hydrates the snapshot --&gt; unsnapshottable.js
main.js --&gt; require
" dir="auto">
    <div dir="auto">
      <pre lang="mermaid" aria-label="Raw mermaid code">flowchart TD

electron -- loads --&gt; browser_v8_context_snapshot.bin
electron -- runs --&gt; main.js -- runs --&gt; v8-snapshots-util.js
v8-snapshots-util.js -- monkey-patches --&gt; require[&#34;require(...)&#34;] -- load modules from --&gt; browser_v8_context_snapshot.bin
main.js -- hydrates the snapshot --&gt; unsnapshottable.js
main.js --&gt; require
</pre>
    </div>
  </div>
  <span role="presentation">
    <span data-view-component="true">
  <svg style="box-sizing: content-box; color: var(--color-icon-primary);" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true" data-view-component="true">
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-opacity="0.25" stroke-width="2" vector-effect="non-scaling-stroke" fill="none"></circle>
    <path d="M15 8a7.002 7.002 0 00-7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"></path>
</svg>    <span>Loading</span>
</span>
  </span>
</section>

<p dir="auto">The <code>yarn start</code> command is used to start the app.</p>
<p dir="auto">During startup, Electron loads the <code>browser_v8_context_snapshot.bin</code> file and deserializes the V8 heap from it. Now, the <code>snapshotResult</code> variable which was defined in the <code>cache/snapshot.js</code> V8 snapshot script would be available in the current V8 context. Then when Electron starts executing the app code from <code>main.js</code>, the <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/v8-snapshots-util.js"><code>v8-snapshots-util.js</code></a> script gets run at first.</p>
<p dir="auto">The <code>snapshotResult.customRequire.cache</code> variable is prepopulated with a map of module paths and the exports objects of those modules. Since the <code>snapshotResult</code> variable would also be available to the <code>v8-snapshots-util.js</code> script, it monkey-patches the <code>require()</code> functionality, so that it is optimized to return the module exports object directly from the <code>snapshotResult.customRequire.cache</code> map for modules that belong to the V8 snapshot and using the default functionality of compiling and executing the modules from scratch for modules that do not belong to the V8 snapshot:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L6" data-line-number="6"></td>
          <td id="LC6"> <span>const</span> <span>Module</span> <span>=</span> <span>require</span><span>(</span><span>&#39;module&#39;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L7" data-line-number="7"></td>
          <td id="LC7"> <span>const</span> <span>entryPointDirPath</span> <span>=</span> <span>__dirname</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L8" data-line-number="8"></td>
          <td id="LC8"> <span>// console.log(&#39;entryPointDirPath:&#39;, entryPointDirPath)</span> </td>
        </tr>

        <tr>
          <td id="L9" data-line-number="9"></td>
          <td id="LC9">  </td>
        </tr>

        <tr>
          <td id="L10" data-line-number="10"></td>
          <td id="LC10"> <span>Module</span><span>.</span><span>prototype</span><span>.</span><span>require</span> <span>=</span> <span>function</span> <span>(</span><span>module</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L11" data-line-number="11"></td>
          <td id="LC11">   <span>const</span> <span>absoluteFilePath</span> <span>=</span> <span>Module</span><span>.</span><span>_resolveFilename</span><span>(</span><span>module</span><span>,</span> <span>this</span><span>,</span> <span>false</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L12" data-line-number="12"></td>
          <td id="LC12">   <span>let</span> <span>relativeFilePath</span> <span>=</span> <span>path</span><span>.</span><span>relative</span><span>(</span><span>entryPointDirPath</span><span>,</span> <span>absoluteFilePath</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L13" data-line-number="13"></td>
          <td id="LC13">   <span>if</span> <span>(</span><span>!</span><span>relativeFilePath</span><span>.</span><span>startsWith</span><span>(</span><span>&#39;./&#39;</span><span>)</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L14" data-line-number="14"></td>
          <td id="LC14">     <span>relativeFilePath</span> <span>=</span> <span>`./<span><span>${</span><span>relativeFilePath</span><span>}</span></span>`</span> </td>
        </tr>

        <tr>
          <td id="L15" data-line-number="15"></td>
          <td id="LC15">   <span>}</span> </td>
        </tr>

        <tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16">   <span>if</span> <span>(</span><span>process</span><span>.</span><span>platform</span> <span>===</span> <span>&#39;win32&#39;</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17">     <span>relativeFilePath</span> <span>=</span> <span>relativeFilePath</span><span>.</span><span>replace</span><span>(</span><span><span>/</span>\\<span>/</span>g</span><span>,</span> <span>&#39;/&#39;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18">   <span>}</span> </td>
        </tr>

        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19">   <span>let</span> <span>cachedModule</span> <span>=</span> <span>snapshotResult</span><span>.</span><span>customRequire</span><span>.</span><span>cache</span><span>[</span><span>relativeFilePath</span><span>]</span> </td>
        </tr>

        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20">   <span>if</span> <span>(</span><span>snapshotResult</span><span>.</span><span>customRequire</span><span>.</span><span>cache</span><span>[</span><span>relativeFilePath</span><span>]</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21">     <span>// console.log(&#39;Snapshot cache hit:&#39;, relativeFilePath)</span> </td>
        </tr>

        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22">   <span>}</span> </td>
        </tr>

        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23">   <span>if</span> <span>(</span><span>!</span><span>cachedModule</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24">     <span>// console.log(&#39;Uncached module:&#39;, module, relativeFilePath)</span> </td>
        </tr>

        <tr>
          <td id="L25" data-line-number="25"></td>
          <td id="LC25">     <span>cachedModule</span> <span>=</span> <span>{</span> <span>exports</span>: <span>Module</span><span>.</span><span>_load</span><span>(</span><span>module</span><span>,</span> <span>this</span><span>,</span> <span>false</span><span>)</span> <span>}</span> </td>
        </tr>

        <tr>
          <td id="L26" data-line-number="26"></td>
          <td id="LC26">     <span>snapshotResult</span><span>.</span><span>customRequire</span><span>.</span><span>cache</span><span>[</span><span>relativeFilePath</span><span>]</span> <span>=</span> <span>cachedModule</span> </td>
        </tr>

        <tr>
          <td id="L27" data-line-number="27"></td>
          <td id="LC27">   <span>}</span> </td>
        </tr>

        <tr>
          <td id="L28" data-line-number="28"></td>
          <td id="LC28">   <span>return</span> <span>cachedModule</span><span>.</span><span>exports</span> </td>
        </tr>

        <tr>
          <td id="L29" data-line-number="29"></td>
          <td id="LC29"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">Then <code>v8-snapshots-util.js</code> calls <code>snapshotResult.setGlobals()</code> to replace the polyfilled globals present in the V8 snapshot, like <code>customRequire()</code> for <code>require()</code>, with the actual ones that are available at runtime, so that when the exported code gets run it uses the actual globals instead of the limited polyfills defined in <code>cache/snapshot.js</code>:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L31" data-line-number="31"></td>
          <td id="LC31"> <span>snapshotResult</span><span>.</span><span>setGlobals</span><span>(</span> </td>
        </tr>

        <tr>
          <td id="L32" data-line-number="32"></td>
          <td id="LC32">   <span>global</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L33" data-line-number="33"></td>
          <td id="LC33">   <span>process</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L34" data-line-number="34"></td>
          <td id="LC34">   <span>undefined</span> <span>/* window */</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L35" data-line-number="35"></td>
          <td id="LC35">   <span>undefined</span> <span>/* document */</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L36" data-line-number="36"></td>
          <td id="LC36">   <span>console</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L37" data-line-number="37"></td>
          <td id="LC37">   <span>require</span> </td>
        </tr>

        <tr>
          <td id="L38" data-line-number="38"></td>
          <td id="LC38"> <span>)</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">Now that <code>require()</code> has been configured to load dependency modules from the V8 snapshot, <code>main.js</code> runs <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/unsnapshottable.js"><code>unsnapshottable.js</code></a> to execute the parts of those modules that had to be patched because those were not snapshottable.</p>
<p dir="auto">Finally, the application code is ready to use the dependency modules from the V8 snapshot!</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24"> <span>const</span> <span>semver</span> <span>=</span> <span>require</span><span>(</span><span>&#39;semver&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L25" data-line-number="25"></td>
          <td id="LC25"> <span>const</span> <span>circularJSON</span> <span>=</span> <span>require</span><span>(</span><span>&#39;circular-json&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L26" data-line-number="26"></td>
          <td id="LC26"> <span>const</span> <span>_</span> <span>=</span> <span>require</span><span>(</span><span>&#39;lodash&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L27" data-line-number="27"></td>
          <td id="LC27"> <span>const</span> <span>async</span> <span>=</span> <span>require</span><span>(</span><span>&#39;async&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L28" data-line-number="28"></td>
          <td id="LC28"> <span>const</span> <span>i18n</span> <span>=</span> <span>require</span><span>(</span><span>&#39;i18next&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L29" data-line-number="29"></td>
          <td id="LC29"> <span>const</span> <span>jsonStorage</span> <span>=</span> <span>require</span><span>(</span><span>&#39;electron-json-storage&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L30" data-line-number="30"></td>
          <td id="LC30"> <span>const</span> <span>uuidV4</span> <span>=</span> <span>require</span><span>(</span><span>&#39;uuid/v4&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L31" data-line-number="31"></td>
          <td id="LC31"> <span>const</span> <span>nedb</span> <span>=</span> <span>require</span><span>(</span><span>&#39;nedb&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L32" data-line-number="32"></td>
          <td id="LC32"> <span>const</span> <span>sentry</span> <span>=</span> <span>require</span><span>(</span><span>&#39;@sentry/node&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L33" data-line-number="33"></td>
          <td id="LC33"> <span>const</span> <span>sh</span> <span>=</span> <span>require</span><span>(</span><span>&#39;shelljs&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L34" data-line-number="34"></td>
          <td id="LC34"> <span>const</span> <span>sudo</span> <span>=</span> <span>require</span><span>(</span><span>&#39;sudo-prompt&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L35" data-line-number="35"></td>
          <td id="LC35"> <span>const</span> <span>SerializedError</span> <span>=</span> <span>require</span><span>(</span><span>&#39;serialised-error&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L36" data-line-number="36"></td>
          <td id="LC36"> <span>const</span> <span>initializeUpdater</span> <span>=</span> <span>require</span><span>(</span><span>&#39;@postman/app-updater&#39;</span><span>)</span><span>.</span><span>init</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L37" data-line-number="37"></td>
          <td id="LC37"> <span>const</span> <span>{</span> WebSocketServer <span>}</span> <span>=</span> <span>require</span><span>(</span><span>&#39;ws&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L38" data-line-number="38"></td>
          <td id="LC38"> <span>const</span> <span>{</span> encryptAES<span>,</span> decryptAES <span>}</span> <span>=</span> <span>require</span><span>(</span><span>&#39;@raisinten/aes-crypto-js&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L39" data-line-number="39"></td>
          <td id="LC39"> <span>const</span> <span>ipc</span> <span>=</span> <span>require</span><span>(</span><span>&#39;node-ipc&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L40" data-line-number="40"></td>
          <td id="LC40"> <span>const</span> <span>{</span> Originator<span>,</span> Collectors <span>}</span> <span>=</span> <span>require</span><span>(</span><span>&#39;@postman/app-logger&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L41" data-line-number="41"></td>
          <td id="LC41"> <span>const</span> <span>forge</span> <span>=</span> <span>require</span><span>(</span><span>&#39;node-forge&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L42" data-line-number="42"></td>
          <td id="LC42"> <span>const</span> <span>pem</span> <span>=</span> <span>require</span><span>(</span><span>&#39;@postman/pem&#39;</span><span>)</span><span>;</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>


<p dir="auto">All the <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/patches"><code>patches</code></a> and <a href="https://github.com/RaisinTen/electron-snapshot-experiment/blob/main/unsnapshottable.js"><code>unsnapshottable.js</code></a> code belong to these categories:</p>
<div dir="auto"><h4 tabindex="-1" dir="auto">Exporting code that inherits from Node.js builtins</h4><a id="user-content-exporting-code-that-inherits-from-nodejs-builtins" aria-label="Permalink: Exporting code that inherits from Node.js builtins" href="#exporting-code-that-inherits-from-nodejs-builtins"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">If a constructor is exported from a module that inherits from Node.js builtins like <code>EventEmitter</code>, it would not be possible to add it to the snapshot:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const util = require(&#39;util&#39;);
const EventEmitter = require(&#39;events&#39;);

function X() {
  // ...
}

util.inherits(X, EventEmitter);

module.exports = {
  X
};"><pre><span>const</span> <span>util</span> <span>=</span> <span>require</span><span>(</span><span>&#39;util&#39;</span><span>)</span><span>;</span>
<span>const</span> <span>EventEmitter</span> <span>=</span> <span>require</span><span>(</span><span>&#39;events&#39;</span><span>)</span><span>;</span>

<span>function</span> <span>X</span><span>(</span><span>)</span> <span>{</span>
  <span>// ...</span>
<span>}</span>

<span>util</span><span>.</span><span>inherits</span><span>(</span><span>X</span><span>,</span> <span>EventEmitter</span><span>)</span><span>;</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>{</span>
  X
<span>}</span><span>;</span></pre></div>
<p dir="auto">This has been handled by moving the use of the Node.js builtins from the module code into <code>unsnapshottable.js</code>:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="function X() {
  // ...
}

module.exports = {
  X
};"><pre><span>function</span> <span>X</span><span>(</span><span>)</span> <span>{</span>
  <span>// ...</span>
<span>}</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>{</span>
  X
<span>}</span><span>;</span></pre></div>
<p dir="auto"><strong><code>unsnapshottable.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const util = require(&#39;util&#39;);
const EventEmitter = require(&#39;events&#39;);
const { X } = require(&#39;module&#39;);

util.inherits(X, EventEmitter);"><pre><span>const</span> <span>util</span> <span>=</span> <span>require</span><span>(</span><span>&#39;util&#39;</span><span>)</span><span>;</span>
<span>const</span> <span>EventEmitter</span> <span>=</span> <span>require</span><span>(</span><span>&#39;events&#39;</span><span>)</span><span>;</span>
<span>const</span> <span>{</span> X <span>}</span> <span>=</span> <span>require</span><span>(</span><span>&#39;module&#39;</span><span>)</span><span>;</span>

<span>util</span><span>.</span><span>inherits</span><span>(</span><span>X</span><span>,</span> <span>EventEmitter</span><span>)</span><span>;</span></pre></div>
<p dir="auto">Since <code>require()</code> uses a cache, modifications to the exported object are persisted across multiple <code>require()</code> calls to the same module. Hence, it is possible to make <code>X</code> inherit from <code>EventEmitter</code> dynamically at runtime when those Node.js builtins are available.</p>
<p dir="auto">For example, the inheritance logic of the <code>glob</code> module has been patched in:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L1" data-line-number="1"></td>
          <td id="LC1"> <span>diff --git a/node_modules/glob/glob.js b/node_modules/glob/glob.js</span> </td>
        </tr>

        <tr>
          <td id="L2" data-line-number="2"></td>
          <td id="LC2"> index 37a4d7e..c6b7be1 100644 </td>
        </tr>

        <tr>
          <td id="L3" data-line-number="3"></td>
          <td id="LC3"> <span>--- a/node_modules/glob/glob.js</span> </td>
        </tr>

        <tr>
          <td id="L4" data-line-number="4"></td>
          <td id="LC4"> <span>+++ b/node_modules/glob/glob.js</span> </td>
        </tr>

        <tr>
          <td id="L5" data-line-number="5"></td>
          <td id="LC5"> <span>@@ -113,7 +113,6 @@</span> glob.hasMagic = function (pattern, options_) { </td>
        </tr>

        <tr>
          <td id="L6" data-line-number="6"></td>
          <td id="LC6">  } </td>
        </tr>

        <tr>
          <td id="L7" data-line-number="7"></td>
          <td id="LC7">   </td>
        </tr>

        <tr>
          <td id="L8" data-line-number="8"></td>
          <td id="LC8">  glob.Glob = Glob </td>
        </tr>

        <tr>
          <td id="L9" data-line-number="9"></td>
          <td id="LC9"> <span><span>-</span>inherits(Glob, EE)</span> </td>
        </tr>

        <tr>
          <td id="L10" data-line-number="10"></td>
          <td id="LC10">  function Glob (pattern, options, cb) { </td>
        </tr>

        <tr>
          <td id="L11" data-line-number="11"></td>
          <td id="LC11">    if (typeof options === &#39;function&#39;) { </td>
        </tr>

        <tr>
          <td id="L12" data-line-number="12"></td>
          <td id="LC12">      cb = options </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">and moved into:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17"> <span>// Make require(&#39;glob&#39;).Glob inherit from EventEmitter. This needs to be done</span> </td>
        </tr>

        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18"> <span>// here because EventEmitter is not a part of the default V8 context which is</span> </td>
        </tr>

        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19"> <span>// used to generate the V8 snapshot.</span> </td>
        </tr>

        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20"> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21">   <span>const</span> <span>glob</span> <span>=</span> <span>require</span><span>(</span><span>&#39;glob&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22">   <span>util</span><span>.</span><span>inherits</span><span>(</span><span>glob</span><span>.</span><span>Glob</span><span>,</span> <span>EventEmitter</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<div dir="auto"><h4 tabindex="-1" dir="auto">Exporting classes that inherit from Node.js builtins</h4><a id="user-content-exporting-classes-that-inherit-from-nodejs-builtins" aria-label="Permalink: Exporting classes that inherit from Node.js builtins" href="#exporting-classes-that-inherit-from-nodejs-builtins"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">We use a similar trick for classes that inherit from Node.js builtins by using <code>extends</code> and <code>super</code> keywords:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const EventEmitter = require(&#39;events&#39;);

class X extends EventEmitter {
  constructor() {
    super();
    // ...
  }
  // ...
}

module.exports = {
  X
};"><pre><span>const</span> <span>EventEmitter</span> <span>=</span> <span>require</span><span>(</span><span>&#39;events&#39;</span><span>)</span><span>;</span>

<span>class</span> <span>X</span> <span>extends</span> <span>EventEmitter</span> <span>{</span>
  <span>constructor</span><span>(</span><span>)</span> <span>{</span>
    <span>super</span><span>(</span><span>)</span><span>;</span>
    <span>// ...</span>
  <span>}</span>
  <span>// ...</span>
<span>}</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>{</span>
  X
<span>}</span><span>;</span></pre></div>
<p dir="auto">The module code can be added to the V8 snapshot with the following modifications:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const EventEmitter = require(&#39;events&#39;);

class X {
  constructor() {
    EventEmitter.call(this);
    // ...
  }
  // ...
}

module.exports = {
  X
};"><pre><span>const</span> <span>EventEmitter</span> <span>=</span> <span>require</span><span>(</span><span>&#39;events&#39;</span><span>)</span><span>;</span>

<span>class</span> <span>X</span> <span>{</span>
  <span>constructor</span><span>(</span><span>)</span> <span>{</span>
    <span>EventEmitter</span><span>.</span><span>call</span><span>(</span><span>this</span><span>)</span><span>;</span>
    <span>// ...</span>
  <span>}</span>
  <span>// ...</span>
<span>}</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>{</span>
  X
<span>}</span><span>;</span></pre></div>
<p dir="auto"><strong><code>unsnapshottable.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const EventEmitter = require(&#39;events&#39;);
const { X } = require(&#39;module&#39;);

function extendClass(target, base) {
  Object.setPrototypeOf(target, base); // Static properties of base can now be accessed on target.
  Object.setPrototypeOf(target.prototype, base.prototype); // Prototypal properties of base can now be accessed on target.
}

extendClass(X, EventEmitter);"><pre><span>const</span> <span>EventEmitter</span> <span>=</span> <span>require</span><span>(</span><span>&#39;events&#39;</span><span>)</span><span>;</span>
<span>const</span> <span>{</span> X <span>}</span> <span>=</span> <span>require</span><span>(</span><span>&#39;module&#39;</span><span>)</span><span>;</span>

<span>function</span> <span>extendClass</span><span>(</span><span>target</span><span>,</span> <span>base</span><span>)</span> <span>{</span>
  <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>target</span><span>,</span> <span>base</span><span>)</span><span>;</span> <span>// Static properties of base can now be accessed on target.</span>
  <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>target</span><span>.</span><span>prototype</span><span>,</span> <span>base</span><span>.</span><span>prototype</span><span>)</span><span>;</span> <span>// Prototypal properties of base can now be accessed on target.</span>
<span>}</span>

<span>extendClass</span><span>(</span><span>X</span><span>,</span> <span>EventEmitter</span><span>)</span><span>;</span></pre></div>
<p dir="auto">Use of <code>extends</code> have been substituted with a dynamic class inheritance logic in <code>unsnapshottable.js</code> and use of <code>super</code> has been replaced with a call to the base class constructor which also passes the <code>this</code> object.</p>
<p dir="auto">For example, the inheritance logic of the <code>node_modules/ws/lib/websocket-server.js</code> module has been patched in:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L208" data-line-number="208"></td>
          <td id="LC208"> <span>diff --git a/node_modules/ws/lib/websocket-server.js b/node_modules/ws/lib/websocket-server.js</span> </td>
        </tr>

        <tr>
          <td id="L209" data-line-number="209"></td>
          <td id="LC209"> index bac30eb..89de725 100644 </td>
        </tr>

        <tr>
          <td id="L210" data-line-number="210"></td>
          <td id="LC210"> <span>--- a/node_modules/ws/lib/websocket-server.js</span> </td>
        </tr>

        <tr>
          <td id="L211" data-line-number="211"></td>
          <td id="LC211"> <span>+++ b/node_modules/ws/lib/websocket-server.js</span> </td>
        </tr>

        <tr>
          <td id="L212" data-line-number="212"></td>
          <td id="LC212"> <span>@@ -26,7 +26,7 @@</span> const CLOSED = 2; </td>
        </tr>

        <tr>
          <td id="L213" data-line-number="213"></td>
          <td id="LC213">   * </td>
        </tr>

        <tr>
          <td id="L214" data-line-number="214"></td>
          <td id="LC214">   * @extends EventEmitter </td>
        </tr>

        <tr>
          <td id="L215" data-line-number="215"></td>
          <td id="LC215">   */ </td>
        </tr>

        <tr>
          <td id="L216" data-line-number="216"></td>
          <td id="LC216"> <span><span>-</span>class WebSocketServer extends EventEmitter {</span> </td>
        </tr>

        <tr>
          <td id="L217" data-line-number="217"></td>
          <td id="LC217"> <span><span>+</span>class WebSocketServer {</span> </td>
        </tr>

        <tr>
          <td id="L218" data-line-number="218"></td>
          <td id="LC218">    /** </td>
        </tr>

        <tr>
          <td id="L219" data-line-number="219"></td>
          <td id="LC219">     * Create a `WebSocketServer` instance. </td>
        </tr>

        <tr>
          <td id="L220" data-line-number="220"></td>
          <td id="LC220">     * </td>
        </tr>

        <tr>
          <td id="L221" data-line-number="221"></td>
          <td id="LC221"> <span>@@ -54,7 +54,7 @@</span> class WebSocketServer extends EventEmitter { </td>
        </tr>

        <tr>
          <td id="L222" data-line-number="222"></td>
          <td id="LC222">     * @param {Function} [callback] A listener for the `listening` event </td>
        </tr>

        <tr>
          <td id="L223" data-line-number="223"></td>
          <td id="LC223">     */ </td>
        </tr>

        <tr>
          <td id="L224" data-line-number="224"></td>
          <td id="LC224">    constructor(options, callback) { </td>
        </tr>

        <tr>
          <td id="L225" data-line-number="225"></td>
          <td id="LC225"> <span><span>-</span>    super();</span> </td>
        </tr>

        <tr>
          <td id="L226" data-line-number="226"></td>
          <td id="LC226"> <span><span>+</span>    EventEmitter.call(this);</span> </td>
        </tr>

        <tr>
          <td id="L227" data-line-number="227"></td>
          <td id="LC227">   </td>
        </tr>

        <tr>
          <td id="L228" data-line-number="228"></td>
          <td id="LC228">      options = { </td>
        </tr>

        <tr>
          <td id="L229" data-line-number="229"></td>
          <td id="LC229">        maxPayload: 100 * 1024 * 1024, </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">and moved into:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L145" data-line-number="145"></td>
          <td id="LC145"> <span>// Move the code for making WebSocket from &#39;ws/lib/websocket-server&#39; inherit from</span> </td>
        </tr>

        <tr>
          <td id="L146" data-line-number="146"></td>
          <td id="LC146"> <span>// EventEmitter here because EventEmitter is not a part of the V8 snapshot.</span> </td>
        </tr>

        <tr>
          <td id="L147" data-line-number="147"></td>
          <td id="LC147"> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L148" data-line-number="148"></td>
          <td id="LC148">   <span>const</span> <span>WebSocketServer</span> <span>=</span> <span>require</span><span>(</span><span>&#39;./node_modules/ws/lib/websocket-server&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L149" data-line-number="149"></td>
          <td id="LC149">   <span>extendClass</span><span>(</span><span>WebSocketServer</span><span>,</span> <span>EventEmitter</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L150" data-line-number="150"></td>
          <td id="LC150"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<div dir="auto"><h4 tabindex="-1" dir="auto">Re-exporting Node.js builtins</h4><a id="user-content-re-exporting-nodejs-builtins" aria-label="Permalink: Re-exporting Node.js builtins" href="#re-exporting-nodejs-builtins"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Since Node.js builtins are not a part of the V8 snapshot, those cannot be re-exported from a module belonging to the V8 snapshot:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const fs = require(&#39;fs&#39;);

exports.f = function f() { /* ... */ };
exports.read = fs.read;
exports.write = fs.write;"><pre><span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;fs&#39;</span><span>)</span><span>;</span>

<span>exports</span><span>.</span><span>f</span> <span>=</span> <span>function</span> <span>f</span><span>(</span><span>)</span> <span>{</span> <span>/* ... */</span> <span>}</span><span>;</span>
<span>exports</span><span>.</span><span>read</span> <span>=</span> <span>fs</span><span>.</span><span>read</span><span>;</span>
<span>exports</span><span>.</span><span>write</span> <span>=</span> <span>fs</span><span>.</span><span>write</span><span>;</span></pre></div>
<p dir="auto">This can be fixed by moving the code for re-exporting the Node.js builtins into <code>unsnapshottable.js</code>:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="exports.f = function f() { /* ... */ };"><pre><span>exports</span><span>.</span><span>f</span> <span>=</span> <span>function</span> <span>f</span><span>(</span><span>)</span> <span>{</span> <span>/* ... */</span> <span>}</span><span>;</span></pre></div>
<p dir="auto"><strong><code>unsnapshottable.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const fs = require(&#39;fs&#39;);
const module = require(&#39;module&#39;);

module.read = fs.read;
module.write = fs.write;"><pre><span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;fs&#39;</span><span>)</span><span>;</span>
<span>const</span> <span>module</span> <span>=</span> <span>require</span><span>(</span><span>&#39;module&#39;</span><span>)</span><span>;</span>

<span>module</span><span>.</span><span>read</span> <span>=</span> <span>fs</span><span>.</span><span>read</span><span>;</span>
<span>module</span><span>.</span><span>write</span> <span>=</span> <span>fs</span><span>.</span><span>write</span><span>;</span></pre></div>
<p dir="auto">For example, the exports of the <code>node_modules/nedb/lib/storage.js</code> module has been patched in:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L14" data-line-number="14"></td>
          <td id="LC14"> <span>diff --git a/node_modules/nedb/lib/storage.js b/node_modules/nedb/lib/storage.js</span> </td>
        </tr>

        <tr>
          <td id="L15" data-line-number="15"></td>
          <td id="LC15"> index 128f9cc..c405ad6 100755 </td>
        </tr>

        <tr>
          <td id="L16" data-line-number="16"></td>
          <td id="LC16"> <span>--- a/node_modules/nedb/lib/storage.js</span> </td>
        </tr>

        <tr>
          <td id="L17" data-line-number="17"></td>
          <td id="LC17"> <span>+++ b/node_modules/nedb/lib/storage.js</span> </td>
        </tr>

        <tr>
          <td id="L18" data-line-number="18"></td>
          <td id="LC18"> <span>@@ -14,12 +14,6 @@</span> var fs = require(&#39;fs&#39;) </td>
        </tr>

        <tr>
          <td id="L19" data-line-number="19"></td>
          <td id="LC19">    , storage = {} </td>
        </tr>

        <tr>
          <td id="L20" data-line-number="20"></td>
          <td id="LC20">    ; </td>
        </tr>

        <tr>
          <td id="L21" data-line-number="21"></td>
          <td id="LC21">   </td>
        </tr>

        <tr>
          <td id="L22" data-line-number="22"></td>
          <td id="LC22"> <span><span>-</span>storage.exists = fs.exists;</span> </td>
        </tr>

        <tr>
          <td id="L23" data-line-number="23"></td>
          <td id="LC23"> <span><span>-</span>storage.rename = fs.rename;</span> </td>
        </tr>

        <tr>
          <td id="L24" data-line-number="24"></td>
          <td id="LC24"> <span><span>-</span>storage.writeFile = fs.writeFile;</span> </td>
        </tr>

        <tr>
          <td id="L25" data-line-number="25"></td>
          <td id="LC25"> <span><span>-</span>storage.unlink = fs.unlink;</span> </td>
        </tr>

        <tr>
          <td id="L26" data-line-number="26"></td>
          <td id="LC26"> <span><span>-</span>storage.appendFile = fs.appendFile;</span> </td>
        </tr>

        <tr>
          <td id="L27" data-line-number="27"></td>
          <td id="LC27"> <span><span>-</span>storage.readFile = fs.readFile;</span> </td>
        </tr>

        <tr>
          <td id="L28" data-line-number="28"></td>
          <td id="LC28">  storage.mkdirp = mkdirp; </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">and moved into:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L57" data-line-number="57"></td>
          <td id="LC57"> <span>// Move the code for attaching the fs module methods from &#39;nedb/lib/storage&#39; to</span> </td>
        </tr>

        <tr>
          <td id="L58" data-line-number="58"></td>
          <td id="LC58"> <span>// here because the fs module is not available in the V8 snapshot.</span> </td>
        </tr>

        <tr>
          <td id="L59" data-line-number="59"></td>
          <td id="LC59"> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L60" data-line-number="60"></td>
          <td id="LC60">   <span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;node:fs&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L61" data-line-number="61"></td>
          <td id="LC61">   <span>const</span> <span>storage</span> <span>=</span> <span>require</span><span>(</span><span>&#39;nedb/lib/storage&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L62" data-line-number="62"></td>
          <td id="LC62">   <span>storage</span><span>.</span><span>exists</span> <span>=</span> <span>fs</span><span>.</span><span>exists</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L63" data-line-number="63"></td>
          <td id="LC63">   <span>storage</span><span>.</span><span>rename</span> <span>=</span> <span>fs</span><span>.</span><span>rename</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L64" data-line-number="64"></td>
          <td id="LC64">   <span>storage</span><span>.</span><span>writeFile</span> <span>=</span> <span>fs</span><span>.</span><span>writeFile</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L65" data-line-number="65"></td>
          <td id="LC65">   <span>storage</span><span>.</span><span>unlink</span> <span>=</span> <span>fs</span><span>.</span><span>unlink</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L66" data-line-number="66"></td>
          <td id="LC66">   <span>storage</span><span>.</span><span>appendFile</span> <span>=</span> <span>fs</span><span>.</span><span>appendFile</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L67" data-line-number="67"></td>
          <td id="LC67">   <span>storage</span><span>.</span><span>readFile</span> <span>=</span> <span>fs</span><span>.</span><span>readFile</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L68" data-line-number="68"></td>
          <td id="LC68"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<div dir="auto"><h4 tabindex="-1" dir="auto">Exporting objects of classes that depend on Node.js builtins</h4><a id="user-content-exporting-objects-of-classes-that-depend-on-nodejs-builtins" aria-label="Permalink: Exporting objects of classes that depend on Node.js builtins" href="#exporting-objects-of-classes-that-depend-on-nodejs-builtins"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">It is not possible to create an object of a class if the construction logic requires Node.js builtins to be present as those are not a part of the V8 snapshot:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="class X {
  constructor() {
    this.x = process.getActiveResourcesInfo();
  }
};

module.exports = new X();"><pre><span>class</span> <span>X</span> <span>{</span>
  <span>constructor</span><span>(</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>x</span> <span>=</span> <span>process</span><span>.</span><span>getActiveResourcesInfo</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span><span>;</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>new</span> <span>X</span><span>(</span><span>)</span><span>;</span></pre></div>
<p dir="auto">This can be fixed by just exporting the class from the module and then later on in <code>unsnapshottable.js</code>, replacing the exports object with an instance of the class:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="class X {
  constructor() {
    this.x = process.getActiveResourcesInfo();
  }
};

module.exports = X;"><pre><span>class</span> <span>X</span> <span>{</span>
  <span>constructor</span><span>(</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>x</span> <span>=</span> <span>process</span><span>.</span><span>getActiveResourcesInfo</span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span><span>;</span>

<span>module</span><span>.</span><span>exports</span> <span>=</span> <span>X</span><span>;</span></pre></div>
<p dir="auto"><strong><code>unsnapshottable.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const X = require(&#39;module&#39;);
require.cache[require.resolve(&#39;x&#39;)] = new X();"><pre><span>const</span> <span>X</span> <span>=</span> <span>require</span><span>(</span><span>&#39;module&#39;</span><span>)</span><span>;</span>
<span>require</span><span>.</span><span>cache</span><span>[</span><span>require</span><span>.</span><span>resolve</span><span>(</span><span>&#39;x&#39;</span><span>)</span><span>]</span> <span>=</span> <span>new</span> <span>X</span><span>(</span><span>)</span><span>;</span></pre></div>
<p dir="auto">For example, the exports of the <code>node_modules/node-ipc/node-ipc.js</code> module has been patched in:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L47" data-line-number="47"></td>
          <td id="LC47"> <span>diff --git a/node_modules/node-ipc/node-ipc.js b/node_modules/node-ipc/node-ipc.js</span> </td>
        </tr>

        <tr>
          <td id="L48" data-line-number="48"></td>
          <td id="LC48"> index 1c63360..bf84820 100644 </td>
        </tr>

        <tr>
          <td id="L49" data-line-number="49"></td>
          <td id="LC49"> <span>--- a/node_modules/node-ipc/node-ipc.js</span> </td>
        </tr>

        <tr>
          <td id="L50" data-line-number="50"></td>
          <td id="LC50"> <span>+++ b/node_modules/node-ipc/node-ipc.js</span> </td>
        </tr>

        <tr>
          <td id="L51" data-line-number="51"></td>
          <td id="LC51"> <span>@@ -18,4 +18,7 @@</span> class IPCModule extends IPC{ </td>
        </tr>

        <tr>
          <td id="L52" data-line-number="52"></td>
          <td id="LC52">      } </td>
        </tr>

        <tr>
          <td id="L53" data-line-number="53"></td>
          <td id="LC53">  } </td>
        </tr>

        <tr>
          <td id="L54" data-line-number="54"></td>
          <td id="LC54">   </td>
        </tr>

        <tr>
          <td id="L55" data-line-number="55"></td>
          <td id="LC55"> <span><span>-</span>module.exports=new IPCModule;</span> </td>
        </tr>

        <tr>
          <td id="L56" data-line-number="56"></td>
          <td id="LC56"> <span><span>+</span>// This returns the IPCModule class instead of the IPCModule instance, so that</span> </td>
        </tr>

        <tr>
          <td id="L57" data-line-number="57"></td>
          <td id="LC57"> <span><span>+</span>// this can be snapshotted. In unsnapshottable.js, this module gets</span> </td>
        </tr>

        <tr>
          <td id="L58" data-line-number="58"></td>
          <td id="LC58"> <span><span>+</span>// monkey-patched to return an IPCModule instance instead of the class.</span> </td>
        </tr>

        <tr>
          <td id="L59" data-line-number="59"></td>
          <td id="LC59"> <span><span>+</span>module.exports=IPCModule;</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">and moved into:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L152" data-line-number="152"></td>
          <td id="LC152"> <span>// Monkey-patch the &#39;node-ipc&#39; module to export an IPCModule instance instead of</span> </td>
        </tr>

        <tr>
          <td id="L153" data-line-number="153"></td>
          <td id="LC153"> <span>// the IPCModule class because that is what the original module does. It has</span> </td>
        </tr>

        <tr>
          <td id="L154" data-line-number="154"></td>
          <td id="LC154"> <span>// been patched to return the class, so that it can be snapshotted.</span> </td>
        </tr>

        <tr>
          <td id="L155" data-line-number="155"></td>
          <td id="LC155"> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L156" data-line-number="156"></td>
          <td id="LC156">   <span>const</span> <span>IPCModule</span> <span>=</span> <span>require</span><span>(</span><span>&#39;node-ipc&#39;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L157" data-line-number="157"></td>
          <td id="LC157">   <span>require</span><span>.</span><span>cache</span><span>[</span><span>require</span><span>.</span><span>resolve</span><span>(</span><span>&#39;node-ipc&#39;</span><span>)</span><span>]</span> <span>=</span> <span>new</span> <span>IPCModule</span><span>(</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L158" data-line-number="158"></td>
          <td id="LC158"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<div dir="auto"><h4 tabindex="-1" dir="auto">Uses of Buffer and TypedArray in the global scope</h4><a id="user-content-uses-of-buffer-and-typedarray-in-the-global-scope" aria-label="Permalink: Uses of Buffer and TypedArray in the global scope" href="#uses-of-buffer-and-typedarray-in-the-global-scope"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Since Buffer is a Node.js builtin and TypedArrays are not supported in V8 snapshots (<a href="https://v8.dev/blog/custom-startup-snapshots" rel="nofollow">since the backing store may be allocated outside of V8</a>), those cannot be used in the global scope of snapshotted modules:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const b = Buffer.from([1, 2, 3]);

function f() {
  // Do something with b.
}

function g() {
  // Do something with b.
}

exports.f = f;
exports.g = g;"><pre><span>const</span> <span>b</span> <span>=</span> <span>Buffer</span><span>.</span><span>from</span><span>(</span><span>[</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>]</span><span>)</span><span>;</span>

<span>function</span> <span>f</span><span>(</span><span>)</span> <span>{</span>
  <span>// Do something with b.</span>
<span>}</span>

<span>function</span> <span>g</span><span>(</span><span>)</span> <span>{</span>
  <span>// Do something with b.</span>
<span>}</span>

<span>exports</span><span>.</span><span>f</span> <span>=</span> <span>f</span><span>;</span>
<span>exports</span><span>.</span><span>g</span> <span>=</span> <span>g</span><span>;</span></pre></div>
<p dir="auto">This can be fixed by creating the Buffer / TypedArray instances lazily only when needed:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="let b;
function initB() {
  if (b) return;
  b = Buffer.from([1, 2, 3]);
}

function f() {
  initB();
  // Do something with b.
}

function g() {
  initB();
  // Do something with b.
}

exports.f = f;
exports.g = g;"><pre><span>let</span> <span>b</span><span>;</span>
<span>function</span> <span>initB</span><span>(</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>b</span><span>)</span> <span>return</span><span>;</span>
  <span>b</span> <span>=</span> <span>Buffer</span><span>.</span><span>from</span><span>(</span><span>[</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>]</span><span>)</span><span>;</span>
<span>}</span>

<span>function</span> <span>f</span><span>(</span><span>)</span> <span>{</span>
  <span>initB</span><span>(</span><span>)</span><span>;</span>
  <span>// Do something with b.</span>
<span>}</span>

<span>function</span> <span>g</span><span>(</span><span>)</span> <span>{</span>
  <span>initB</span><span>(</span><span>)</span><span>;</span>
  <span>// Do something with b.</span>
<span>}</span>

<span>exports</span><span>.</span><span>f</span> <span>=</span> <span>f</span><span>;</span>
<span>exports</span><span>.</span><span>g</span> <span>=</span> <span>g</span><span>;</span></pre></div>
<p dir="auto">For example, the buffer creation in the <code>node_modules/ws/lib/permessage-deflate.js</code> module has been modified into a lazy initialization:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L67" data-line-number="67"></td>
          <td id="LC67"> <span>diff --git a/node_modules/ws/lib/permessage-deflate.js b/node_modules/ws/lib/permessage-deflate.js</span> </td>
        </tr>

        <tr>
          <td id="L68" data-line-number="68"></td>
          <td id="LC68"> index 94603c9..99b4e10 100644 </td>
        </tr>

        <tr>
          <td id="L69" data-line-number="69"></td>
          <td id="LC69"> <span>--- a/node_modules/ws/lib/permessage-deflate.js</span> </td>
        </tr>

        <tr>
          <td id="L70" data-line-number="70"></td>
          <td id="LC70"> <span>+++ b/node_modules/ws/lib/permessage-deflate.js</span> </td>
        </tr>

        <tr>
          <td id="L71" data-line-number="71"></td>
          <td id="LC71"> <span>@@ -6,7 +6,13 @@</span> const bufferUtil = require(&#39;./buffer-util&#39;); </td>
        </tr>

        <tr>
          <td id="L72" data-line-number="72"></td>
          <td id="LC72">  const Limiter = require(&#39;./limiter&#39;); </td>
        </tr>

        <tr>
          <td id="L73" data-line-number="73"></td>
          <td id="LC73">  const { kStatusCode } = require(&#39;./constants&#39;); </td>
        </tr>

        <tr>
          <td id="L74" data-line-number="74"></td>
          <td id="LC74">   </td>
        </tr>

        <tr>
          <td id="L75" data-line-number="75"></td>
          <td id="LC75"> <span><span>-</span>const TRAILER = Buffer.from([0x00, 0x00, 0xff, 0xff]);</span> </td>
        </tr>

        <tr>
          <td id="L76" data-line-number="76"></td>
          <td id="LC76"> <span><span>+</span>// Buffer is not a part of the V8 snapshot, so instead of calling Buffer.alloc()</span> </td>
        </tr>

        <tr>
          <td id="L77" data-line-number="77"></td>
          <td id="LC77"> <span><span>+</span>// directly, use a function that calls that instead.</span> </td>
        </tr>

        <tr>
          <td id="L78" data-line-number="78"></td>
          <td id="LC78"> <span><span>+</span>let TRAILER;</span> </td>
        </tr>

        <tr>
          <td id="L79" data-line-number="79"></td>
          <td id="LC79"> <span><span>+</span>function initTrailer() {</span> </td>
        </tr>

        <tr>
          <td id="L80" data-line-number="80"></td>
          <td id="LC80"> <span><span>+</span>  if (TRAILER) return;</span> </td>
        </tr>

        <tr>
          <td id="L81" data-line-number="81"></td>
          <td id="LC81"> <span><span>+</span>  TRAILER = Buffer.from([0x00, 0x00, 0xff, 0xff]);</span> </td>
        </tr>

        <tr>
          <td id="L82" data-line-number="82"></td>
          <td id="LC82"> <span><span>+</span>}</span> </td>
        </tr>

        <tr>
          <td id="L83" data-line-number="83"></td>
          <td id="LC83">  const kPerMessageDeflate = Symbol(&#39;permessage-deflate&#39;); </td>
        </tr>

        <tr>
          <td id="L84" data-line-number="84"></td>
          <td id="LC84">  const kTotalLength = Symbol(&#39;total-length&#39;); </td>
        </tr>

        <tr>
          <td id="L85" data-line-number="85"></td>
          <td id="LC85">  const kCallback = Symbol(&#39;callback&#39;); </td>
        </tr>

        <tr>
          <td id="L86" data-line-number="86"></td>
          <td id="LC86"> <span>@@ -359,7 +365,10 @@</span> class PerMessageDeflate { </td>
        </tr>

        <tr>
          <td id="L87" data-line-number="87"></td>
          <td id="LC87">      this._inflate[kCallback] = callback; </td>
        </tr>

        <tr>
          <td id="L88" data-line-number="88"></td>
          <td id="LC88">   </td>
        </tr>

        <tr>
          <td id="L89" data-line-number="89"></td>
          <td id="LC89">      this._inflate.write(data); </td>
        </tr>

        <tr>
          <td id="L90" data-line-number="90"></td>
          <td id="LC90"> <span><span>-</span>    if (fin) this._inflate.write(TRAILER);</span> </td>
        </tr>

        <tr>
          <td id="L91" data-line-number="91"></td>
          <td id="LC91"> <span><span>+</span>    if (fin) {</span> </td>
        </tr>

        <tr>
          <td id="L92" data-line-number="92"></td>
          <td id="LC92"> <span><span>+</span>      initTrailer();</span> </td>
        </tr>

        <tr>
          <td id="L93" data-line-number="93"></td>
          <td id="LC93"> <span><span>+</span>      this._inflate.write(TRAILER);</span> </td>
        </tr>

        <tr>
          <td id="L94" data-line-number="94"></td>
          <td id="LC94"> <span><span>+</span>    }</span> </td>
        </tr>

        <tr>
          <td id="L95" data-line-number="95"></td>
          <td id="LC95">   </td>
        </tr>

        <tr>
          <td id="L96" data-line-number="96"></td>
          <td id="LC96">      this._inflate.flush(() =&gt; { </td>
        </tr>

        <tr>
          <td id="L97" data-line-number="97"></td>
          <td id="LC97">        const err = this._inflate[kError]; </td>
        </tr>
    </tbody></table>
  </div>
</div>

<div dir="auto"><h4 tabindex="-1" dir="auto">Modules that uses or monkey-patches Node.js builtins during module execution</h4><a id="user-content-modules-that-uses-or-monkey-patches-nodejs-builtins-during-module-execution" aria-label="Permalink: Modules that uses or monkey-patches Node.js builtins during module execution" href="#modules-that-uses-or-monkey-patches-nodejs-builtins-during-module-execution"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Since Node.js builtins are not a part of the V8 snapshot, those cannot be monkey-patched or used during module execution if it needs to belong to the V8 snapshot:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="// snapshottable code

const fs = require(&#39;fs&#39;);
fs.read = function () {
  // ...
};

delete process.env.OLDPWD;

process.on(&#39;exit&#39;, (code) =&gt; {
  console.log(&#39;Process exit event with code: &#39;, code);
});"><pre><span>// snapshottable code</span>

<span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;fs&#39;</span><span>)</span><span>;</span>
<span>fs</span><span>.</span><span>read</span> <span>=</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>
  <span>// ...</span>
<span>}</span><span>;</span>

<span>delete</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>OLDPWD</span><span>;</span>

<span>process</span><span>.</span><span>on</span><span>(</span><span>&#39;exit&#39;</span><span>,</span> <span>(</span><span>code</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;Process exit event with code: &#39;</span><span>,</span> <span>code</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">This can be fixed by simply moving the problematic code into <code>unsnapshottable.js</code>:</p>
<p dir="auto"><strong><code>module.js</code></strong></p>

<p dir="auto"><strong><code>unsnapshottable.js</code></strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="const fs = require(&#39;fs&#39;);
fs.read = function () {
  // ...
};

delete process.env.OLDPWD;

process.on(&#39;exit&#39;, (code) =&gt; {
  console.log(&#39;Process exit event with code: &#39;, code);
});"><pre><span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;fs&#39;</span><span>)</span><span>;</span>
<span>fs</span><span>.</span><span>read</span> <span>=</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>
  <span>// ...</span>
<span>}</span><span>;</span>

<span>delete</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>OLDPWD</span><span>;</span>

<span>process</span><span>.</span><span>on</span><span>(</span><span>&#39;exit&#39;</span><span>,</span> <span>(</span><span>code</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>&#39;Process exit event with code: &#39;</span><span>,</span> <span>code</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto">For example, the code in the <code>agent-base</code> module that monkey-patched the Node.js builtins has been removed in:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L7" data-line-number="7"></td>
          <td id="LC7"> <span><span>-</span>require(&#39;./patch-core&#39;);</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">and moved to <code>unsnapshottable.js</code> in:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L90" data-line-number="90"></td>
          <td id="LC90"> <span>// Make require(&#39;agent-base&#39;) inherit from EventEmitter. This needs to be done</span> </td>
        </tr>

        <tr>
          <td id="L91" data-line-number="91"></td>
          <td id="LC91"> <span>// here because EventEmitter is not a part of the default V8 context which is</span> </td>
        </tr>

        <tr>
          <td id="L92" data-line-number="92"></td>
          <td id="LC92"> <span>// used to generate the V8 snapshot. Also, runs &#39;agent-base/patch-core&#39;.</span> </td>
        </tr>

        <tr>
          <td id="L93" data-line-number="93"></td>
          <td id="LC93"> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L94" data-line-number="94"></td>
          <td id="LC94">   <span>require</span><span>(</span><span>&#39;agent-base/patch-core&#39;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L95" data-line-number="95"></td>
          <td id="LC95">   <span>util</span><span>.</span><span>inherits</span><span>(</span><span>Agent</span><span>,</span> <span>EventEmitter</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L96" data-line-number="96"></td>
          <td id="LC96"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

</article></div></div>
  </body>
</html>
