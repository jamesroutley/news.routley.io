<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://techcommunity.microsoft.com/t5/azure-database-for-postgresql/uk-covid-19-dashboard-built-using-postgres-and-citus-for/ba-p/3036276">Original</a>
    <h1>The implementation of the UK Covid-19 dashboard</h1>
    
    <div id="readability-page-1" class="page"><div>
		<div itemprop="text" id="bodyDisplay">
	
		<div>
			
				
					
					
						<p>From the beginning of the COVID-19 pandemic, the United Kingdom (UK) government has made it a top priority to track key health metrics and to share those metrics with the public.</p>

<p>And the citizens of the UK were hungry for information, as they tried to make sense of what was happening. Maps, graphs, and tables became the lingua franca of the pandemic. As a result, the <a href="https://coronavirus.data.gov.uk/" target="_blank" rel="noopener nofollow noreferrer">GOV.UK Coronavirus dashboard</a> became one of the most visited public service websites in the United Kingdom.</p>

<p><span image-alt="case-map-UK-coronavirus-dashboard-june2021-central-westminster-1920x1080.png"><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333260i9BD0B442C32BD739/image-size/medium?v=v2&amp;px=400" role="button" title="case-map-UK-coronavirus-dashboard-june2021-central-westminster-1920x1080.png" alt="case-map-UK-coronavirus-dashboard-june2021-central-westminster-1920x1080.png" li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333260i9BD0B442C32BD739?v=v2" li-image-display-id="&#39;333260i9BD0B442C32BD739&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/></span></p>

<p>The list of people who rely on the UK Coronavirus dashboard is quite long: government personnel, public health officials, healthcare employees, journalists, and the public <strong><em>all</em></strong> use the same service.</p>

<blockquote>
<p>“While ministers and scientists are able to see individual data sets before the public, the dashboard itself is an example of truly democratized, open-access data: the latest graphs and someone sitting at home in Newcastle sees the latest trends and graphs for the first time at 4pm, the same moment as Boris Johnson [the Prime Minister] in his office in Downing Street does.”</p>
<p><em>—<a href="https://inews.co.uk/news/politics/coronavirus-dashboard-gov-uk-public-health-england-team-interview-870463" target="_self" rel="nofollow noopener noreferrer">The i newspaper, 12 February 2021, Behind the scenes of the coronavirus dashboard</a></em></p>
</blockquote>
<p>In addition to exemplifying the value of open-access data, the UK Coronavirus dashboard is open source. All of the software, and the SQL queries themselves, can be found on GitHub, under the <a href="https://github.com/publichealthengland/coronavirus-dashboard/blob/v3-development/LICENSE" target="_blank" rel="noopener noreferrer">MIT license</a> with the data available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener nofollow noreferrer">Open Government License 3.0</a>.</p>

<p>Accessibility is another important design principle. The dashboard is designed for people with different disabilities. The interface is simple to use and enables anyone to navigate the data, letting you visualize trends over time and across geographic regions.</p>

<p>This post is a deep dive into how the UK Coronavirus analytics dashboard came to be, and why it’s architected the way it’s architected. In this post you’ll learn about the database challenges the team faced as the dashboard needed to scale—with an eye toward how the UKHSA team uses Azure, the Azure Database for PostgreSQL managed service, and the Citus extension which transforms Postgres into a distributed database.</p>

<h2 id="toc-hId-332863281">The birth of the UK Coronavirus dashboard</h2>

<p>The earliest UK Coronavirus dashboard was a simple dashboard using ArcGIS.</p>

<p>This was quickly replaced by a simple, single-page service. In April 2020, when the GOV.UK Coronavirus (COVID-19) dashboard first went online (<a href="https://webarchive.nationalarchives.gov.uk/ukgwa/20200415101052/https:/coronavirus.data.gov.uk/" target="_blank" rel="noopener nofollow noreferrer">UK National archive of the original 15 April 2020 dashboard here</a>), it contained just 4 metrics:</p>

<ul>
<li>number of cases, daily</li>
<li>number of cases, cumulative</li>
<li>number of deaths in the UK, daily</li>
<li>number of deaths in the UK, cumulative</li>
</ul>

<p>Soon after, the NHS turned the project over to Public Health England (now called UKHSA), an executive agency of the UK’s Department of Health and Social Care, to enhance the application. That is when Pouria Hadjibagheri became involved.</p>

<p>The technical and development lead for the <a href="https://coronavirus.data.gov.uk/" target="_blank" rel="noopener nofollow noreferrer">GOV.UK Coronavirus dashboard</a> at the UK Health Security Agency (UKHSA, formerly Public Health England) is Pouria Hadjibagheri, the Deputy Head of Software Engineering for Data and Web Services. Since April of 2020, Pouria has led the technical aspects of the mission to gather and publish daily statistics on the coronavirus pandemic in the UK.</p>

<p><span image-alt="Figure 1: Screenshot of the GOV.UK Coronavirus dashboard’s daily update page taken in December 2021, depicting vaccinations, cases, deaths, hospitalizations, and number of tests. This real-time analytics dashboard uses open source software available on GitHub and built by the UKHSA team—running on top of the Hyperscale (Citus) option in the Azure Database for PostgreSQL managed service. The UK Coronavirus dashboard also uses other Azure services, including: Azure Functions, Azure Cache for Redis, Azure App Service, Azure Front Door, Azure Service Bus, Azure Storage and Storage Queues, Azure Logic Apps, Azure API Management, Azure Event Grid, Azure Load Balancer, Azure Virtual Machine Scale Sets, Azure Container Registry, Azure DNS, Azure Virtual Network, Azure Service Principal, Azure Private Endpoint, Application Insights in Azure Monitor, and Azure DevOps with Bicep files."><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333287iA031BD70B6A7D4ED/image-size/large?v=v2&amp;px=999" role="button" title="figure1-uk-coronavirus-dashboard-999px.png" alt="Figure 1: Screenshot of the GOV.UK Coronavirus dashboard’s daily update page taken in December 2021, depicting vaccinations, cases, deaths, hospitalizations, and number of tests. This real-time analytics dashboard uses open source software available on GitHub and built by the UKHSA team—running on top of the Hyperscale (Citus) option in the Azure Database for PostgreSQL managed service. The UK Coronavirus dashboard also uses other Azure services, including: Azure Functions, Azure Cache for Redis, Azure App Service, Azure Front Door, Azure Service Bus, Azure Storage and Storage Queues, Azure Logic Apps, Azure API Management, Azure Event Grid, Azure Load Balancer, Azure Virtual Machine Scale Sets, Azure Container Registry, Azure DNS, Azure Virtual Network, Azure Service Principal, Azure Private Endpoint, Application Insights in Azure Monitor, and Azure DevOps with Bicep files." li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333287iA031BD70B6A7D4ED?v=v2" li-image-display-id="&#39;333287iA031BD70B6A7D4ED&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/><span onclick="event.preventDefault();">Figure 1: Screenshot of the GOV.UK Coronavirus dashboard’s daily update page taken in December 2021, depicting vaccinations, cases, deaths, hospitalizations, and number of tests. This real-time analytics dashboard uses open source software available on GitHub and built by the UKHSA team—running on top of the Hyperscale (Citus) option in the Azure Database for PostgreSQL managed service. The UK Coronavirus dashboard also uses other Azure services, including: Azure Functions, Azure Cache for Redis, Azure App Service, Azure Front Door, Azure Service Bus, Azure Storage and Storage Queues, Azure Logic Apps, Azure API Management, Azure Event Grid, Azure Load Balancer, Azure Virtual Machine Scale Sets, Azure Container Registry, Azure DNS, Azure Virtual Network, Azure Service Principal, Azure Private Endpoint, Application Insights in Azure Monitor, and Azure DevOps with Bicep files.</span></span></p>

<h2 id="toc-hId--1474591182">When the UK government started to use the dashboard in its daily coronavirus briefings</h2>

<p>In June of 2020, Pouria’s team was in the midst of architecting and evolving a more scalable system to power the application. Then they were asked to enhance the online dashboard so it could replace the slides being shared in the UK government’s daily coronavirus briefings—and so they did.</p>

<p>At that point, there were about 1,500 online users of the dashboard at peak times during the day. And then the <a href="https://twitter.com/BorisJohnson/status/1276215501530767360" target="_blank" rel="noopener nofollow noreferrer">UK Prime Minister tweeted the URL to the dashboard</a>. Boom.</p>

<p>All of a sudden, there was a surge in the number of users, all the way up to about 80,000 users within five minutes. From then on, the number of average daily users was 30,000 to 40,000, and it just kept going up.</p>

<p>Over the next year, Pouria’s team expanded the analytics dashboard, adding in more metrics and more interactive features. Today, the application has an average of 1 million unique users per day, generating up to 70 million hits per day.</p>
<h2 id="toc-hId-1012921651">Entire time series data set—currently 800M rows of data—gets updated each &amp; every day</h2>

<p>At first, the analytics dashboard only included data from a small number of sources, such as data from press conferences, tweets, or announcements made on the NHS website.</p>

<p>As the project grew, like so many analytics applications, people wanted to answer even more questions with the dashboard; and so, the team began collecting more data from more sources.</p>

<p>Today hospitals report the data to the NHS, and the NHS reports it to the UKHSA team. The team also established robust links to obtain data from different sources, including arrangements with:</p>

<ul>
<li>Offices of national statistics for the UK nations to get statistics based on death certificates</li>
<li>National Health Service (NHS)</li>
<li>Departments of Health and Social Care to get testing data</li>
<li>National Immunisation Management System to get vaccination data</li>
<li>Public health agencies to get data on cases and deaths</li>
</ul>

<p>Even though some of these data are already in the public domain by the time the dashboard is updated at 4pm, most people wait until 4pm before they use the data. The main reason for this is that the UK Coronavirus dashboard gives users a platform from which they can download consistent and well-structured data that has been QA<em>’</em>ed. They also get to see visualization, with the ability to download exactly what they need, and in the format they need.</p>

<p>At the time this post was published, the analytics dashboard and its underlying database—the Azure Database for PostgreSQL managed service—process over 55 million data points every day, aggregated in the data pipeline from approximately 800 million rows sent by different sources.  </p>

<p>The UKHSA team also updates the entire time-series data set daily. The deduplications, corrections, identifications—all of these happen every day on the entire data set to ensure the accuracy and integrity of each publication.</p>

<p>As a result, there are now over 7.5 billion records in the distributed PostgreSQL database (that’s not rows, rather, these are records, as some are nested JSON payloads). The total number of records goes up by over 50 million each day.</p>

<p>In parallel to this increase in the number of data sources and the amount of data, the UKHSA team also added new features and capabilities to the analytics dashboard in some pretty significant ways, by adding:</p>

<ul>
<li><a href="https://coronavirus.data.gov.uk/details/download" target="_blank" rel="noopener nofollow noreferrer">downloadable data sets</a> (you can download any part of the data that as published on a specific date in the past)</li>
<li>new visualizations</li>
<li>new search capabilities</li>
<li>interactive capabilities across 6 administrative and healthcare boundaries with different levels of granularity</li>
</ul>

<p>For example, you can search on postcodes to quickly see data on testing, cases, vaccinations, hospital admissions, and deaths. You can even use an interactive map to visualize which areas have the greatest percentage of first and second vaccination doses.</p>
<h2 id="toc-hId--794532812"></h2>
<p>The metrics in this table should give you a feel for the size and scale of the UK Coronavirus dashboard at the time of publication in December 2020.</p>

<table>
<tbody>
<tr>
<td colspan="2"><strong>Amount of activity (as of Dec 10, 2021)</strong></td>
</tr>
<tr>
<td># daily average users</td>
<td>1.5 million</td>
</tr>
<tr>
<td># concurrent users/minute, at peak</td>
<td>85K-100K</td>
</tr>
<tr>
<td>median # requests hitting CDN at peak</td>
<td>250K</td>
</tr>
<tr>
<td>total # daily requests (hits)</td>
<td>78 million</td>
</tr>
<tr>
<td># weekly pageviews</td>
<td>80 million</td>
</tr>
<tr>
<td># daily downloads</td>
<td>7.8 million</td>
</tr>
<tr>
<td colspan="2"><strong>Volume of data (as of Dec 10, 2021)</strong></td>
</tr>
<tr>
<td># metrics published daily</td>
<td>215</td>
</tr>
<tr>
<td>total # data points published per day</td>
<td>55 million for 8,000 areas</td>
</tr>
<tr>
<td># records in PostgreSQL database</td>
<td>7.5 billion</td>
</tr>
<tr>
<td># rows in PostgreSQL database</td>
<td>5.9 billion</td>
</tr>
</tbody>
</table>

<p><span image-alt="Figure 3: Metrics screenshot from the Microsoft Azure portal that depicts a sum of the total requests (on the y-axis) hitting the GOV.UK Coronavirus dashboard by time (x-axis), showing how there is a massive 10X increase in the number of requests shortly after 4:00 PM each day, when the new data is published by Pouria and the UKHSA team."><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333336iB8F78D4007D2E5CA/image-size/large?v=v2&amp;px=999" role="button" title="figure3-azure-portal-metrics-screenshot-999px.png" alt="Figure 3: Metrics screenshot from the Microsoft Azure portal that depicts a sum of the total requests (on the y-axis) hitting the GOV.UK Coronavirus dashboard by time (x-axis), showing how there is a massive 10X increase in the number of requests shortly after 4:00 PM each day, when the new data is published by Pouria and the UKHSA team." li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333336iB8F78D4007D2E5CA?v=v2" li-image-display-id="&#39;333336iB8F78D4007D2E5CA&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/><span onclick="event.preventDefault();">Figure 3: Metrics screenshot from the Microsoft Azure portal that depicts a sum of the total requests (on the y-axis) hitting the GOV.UK Coronavirus dashboard by time (x-axis), showing how there is a massive 10X increase in the number of requests shortly after 4:00 PM each day, when the new data is published by Pouria and the UKHSA team.</span></span></p>

<h2 id="toc-hId-1692980021">The performance challenges of scaling with high concurrency</h2>

<p>Today, the number of users querying the analytics dashboard peaks each day at 4:00pm, when new data is released.</p>

<p>There might be 30,000 concurrent hits per minute right before 4pm. Then as soon as the data are released, it goes up to 250,000 to 300,000 hits per minute. The service has been designed to immediately start caching new requests, but at the 4pm daily release time, almost all of the hits get to the server, as that is the point at which all caches are flushed to make new data available.</p>

<p>The number of concurrent users at peak is 60,000 to 100,000 depending on day and prevalence—and that’s just the people browsing the actual website, not users who are using the <a href="https://coronavirus.data.gov.uk/details/developers-guide" target="_blank" rel="noopener nofollow noreferrer">three APIs</a>.</p>

<p>If database responses are even the slightest bit slow, users will feel it. Providing near real-time query responses is paramount. The difference between 200 and 300 milliseconds is the difference between the website being responsive, or not.</p>


<ul>
<li><strong>Why is a difference of just 100 milliseconds a big deal—especially during the peak?</strong> Additional latency can trigger a negative domino effect of performance issues, triggered by the back-pressure of asynchronous services. Even though the asynchronous services are throttled, the number of incoming requests keeps growing. Eventually, left ignored, the incoming requests will likely fail because they will time out. </li>
</ul>

<ul>
<li><strong>What is back-pressure?</strong> Synchronous services wait for the system to respond before issuing the next request, which means they are not always able to fully utilize the hardware when there are additional requests. Conversely, asynchronous services issue requests without waiting and are thus able to take advantage of parallelism in the database. However, they might issue more requests than the hardware can handle, which can cause significant slowdowns and failures: this is a phenomenon known as back-pressure. Asynchronous services therefore need a mechanism to handle back-pressure, for instance by limiting the total number of concurrent requests to the database.</li>
</ul>

<p>Eleven months earlier at the beginning of 2021, as the number of concurrent users querying the dashboard continued to spike, the application was starting to face some serious performance issues.</p>

<p>To support this high level of concurrency led the team to decide they needed a distributed database. But which one?</p>

<h2 id="toc-hId--114474442">The search for a distributed database</h2>

<p>In January 2021, after experimenting with the database and running many, many tests, Pouria decided to move the application to run on <a href="https://docs.microsoft.com/azure/postgresql/hyperscale/" target="_blank" rel="noopener noreferrer">Hyperscale (Citus)</a> in the Azure Database for PostgreSQL managed service. Hyperscale (Citus) uses the Citus extension to Postgres—an <a href="https://github.com/citusdata/citus" target="_blank" rel="noopener noreferrer">open source extension</a> that transforms Postgres into a distributed database.</p>

<p>At the time of writing, the Citus distributed database cluster adopted by the team on Azure is HA-enabled for high availability and has 12 worker nodes with a combined total of 192 vCores, ~1.5 TB of memory, and 24 TB of storage. (The Citus coordinator node has 64 vCores, 256 GB of memory, and 1 TB of storage.)</p>

<h3 id="toc-hId-576087032">Why Postgres?</h3>
<p>Why Postgres? Pouria wanted the database integrity—and the ability to join and aggregate data—that you get from a relational database like Postgres. And he also wanted the versatility of being able to handle NoSQL-style, loosely-structured data—which is something Postgres also offers.</p>

<p>PostgreSQL has always been Pouria’s preferred RDBMS (relational) database. He and his team had a lot of experience with the nitty gritty of Postgres—and are very comfortable with it.</p>

<h3 id="toc-hId--1231367431">Support for the Python ORM mattered</h3>
<p>In Python, there are several readily available Object Relational Management [ORM] libraries that support PostgreSQL, so the team didn’t have to write an adapter or wrapper for connecting the application to Postgres.</p>

<p>Postgres has established drivers, is supported by all major frameworks in all major languages, plus existing tools to connect to databases and third-party tools. It immediately reduces the workload. When you’re using Postgres together with Python, you don’t have to reinvent the wheel each time you want to do something with the database. And that is an important consideration for a fast-moving project.</p>

<h3 id="toc-hId-1256145402">The ability to scale was a key requirement</h3>
<p>With PostgreSQL, you can use the <a href="https://github.com/citusdata/citus" target="_blank" rel="noopener noreferrer">Citus extension</a> to scale out the database horizontally. And on Azure, Citus is available as a managed service, called Hyperscale (Citus).</p>

<p>To handle the ever-growing demand for more data, there was need for a database that could scale, and that could scale as high as the project demanded.</p>

<p>The team found that principles of sharding employed by Citus were both easy to understand and adopt. The robustness of Citus had already been demonstrated by the positive feedback from other organizations who were already using Citus. After much testing and comparison of different database options, they concluded that <a href="https://docs.microsoft.com/azure/postgresql/hyperscale/" target="_blank" rel="noopener noreferrer">Hyperscale (Citus)</a> was exactly what he needed, and that the <a href="https://youtu.be/X-aAgXJZRqM" target="_blank" rel="noopener nofollow noreferrer">Citus extension to Postgres</a> could sustain the workload in a distributed fashion. Hence, a future-proof solution.</p>

<h3 id="toc-hId--551309061">The need for High Availability (HA) drove UKHSA to use a managed database service in the cloud</h3>
<p>Because the coronavirus dashboard is a critical service that laypeople, civic leaders, healthcare workers, hospitals, and government agencies all rely on, it was important to use a managed database service that could give them reliable backups, support, security, and recovery/restore capabilities.</p>

<h3 id="toc-hId-1241040293">The UK Coronavirus dashboard relies on a holistic suite of services on Microsoft Azure</h3>
<p>The UKHSA team leverages so many Azure services. Some of these Azure services are simply not available on other clouds. Namely, Citus is only available as a managed database service on Azure—and the team neither had the time nor the staffing to deploy and manage the database themselves. Another example of a unique service in Azure used in building the dashboard is <a href="https://docs.microsoft.com/azure/azure-functions/" target="_blank" rel="noopener noreferrer">Azure Functions</a>—the serverless infrastructure in Azure—which offer <a href="https://docs.microsoft.com/azure/azure-functions/durable/durable-functions-overview?tabs=csharp" target="_blank" rel="noopener noreferrer">durable functions</a> for orchestrating distributed jobs.</p>
<p>And of course, support also matters, 24x7. Azure customer support has been helpful and responsive, on any and at any time of the day.</p>

<h3 id="toc-hId--566414170">Postgres support for JSON and JSONB is more than just a crowd favorite</h3>
<p>The UKHSA team’s Postgres database—well, actually, it’s a distributed database because the team is using Hyperscale (Citus) on Azure to distribute the database across a cluster—has about 7.5 billion records, including nested JSON payloads.</p>

<p>With Postgres, you can essentially combine the relational aspects of SQL with the flexibility of NoSQL databases. Pouria’s team stores every value in the Postgres database as a JSON payload—either a JSON object or JSON array. They give props to the way Postgres handles JSON formats and payloads, and the ability to use GIN indices to optimize SQL queries.</p>

<h2 id="toc-hId-1792015944">Open source, open data, &amp; transparency as guiding design principles</h2>

<h3 id="toc-hId-113644200">The fact that PostgreSQL is open source was another important factor</h3>
<p>One of Pouria’s conditions for working on this project was that it had to be open source. Being able to see the actual code base is an important factor in many applications. This is a service that people need to trust, and for Pouria, that meant people should be able to see the code and ensure it is high quality. Everything had to be open source.</p>


<p><SPAN size="5">The result of this open source commitment: transparency to the public, more trust in the dashboard, and improved security.</SPAN></p>

<p>Speaking of transparency, you can also get a glimpse into the kinds of things that Pouria’s team deals with every day by looking at the <a href="https://coronavirus.data.gov.uk/details/whats-new" target="_blank" rel="noopener nofollow noreferrer">Coronavirus dashboard’s “What’s new” page</a>, where you’ll see the data issues, new metrics, changes to metrics, and other updates.</p>

<h3 id="toc-hId--1693810263">It helps that Citus is open source, too</h3>
<p>The fact that you can use <a href="https://github.com/citusdata/citus" target="_blank" rel="noopener noreferrer">Citus open source</a> locally was an important factor, too. It helps that the code Pouria and his team wrote—which has been written with the Citus distributed database in mind—can be run locally by just creating a <a href="https://github.com/citusdata/citus#running-citus-using-docker" target="_blank" rel="noopener noreferrer">Docker container</a> and running that code in the container. Citus being open source has enabled the UKHSA team to develop quite comprehensive, containerized test suites.</p>

<p>Another benefit to running on top of open source technologies is the transparency into what’s happening in the code—and the ability to file issues directly with the developers on GitHub. As Pouria worked to optimize and improve the analytics dashboard, he ended up filing several issues in the GitHub repo, including the bulleted issues below. Most of the issues Pouria filed have since been fixed on GitHub.</p>

<ul>
<li><a href="https://github.com/citusdata/citus/issues/5117" target="_blank" rel="noopener noreferrer">Altering (ENUM) types fails with err 57014</a></li>
<li><a href="https://github.com/citusdata/citus/issues/4845" target="_blank" rel="noopener noreferrer">Failure to create composite indices on distributed tables that are partitioned</a></li>
<li><a href="https://github.com/citusdata/citus/issues/5108" target="_blank" rel="noopener noreferrer">Dropping partition sets permanent lock &amp; the partition never drops</a></li>
</ul>

<p><span image-alt="Figure 4: Diagram depicting the data model used by the UK Coronavirus Dashboard team. The data model is highly relational and leverages the power of NoSQL in that there are JSONB payloads in the time_series table. This data model gives the team versatility to accommodate future needs in that the JSONB payloads can/do change quite frequently and are easy to change; but the overall relational data model does not change which provides data integrity for these immutable things. Hyperscale (Citus) is used to distribute 3 of the tables across an Azure Database for PostgreSQL server group."><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333292iB3E81ADE044336F7/image-size/large?v=v2&amp;px=999" role="button" title="figure4-database-schema-uk-coronavirus-dashboard-999px.png" alt="Figure 4: Diagram depicting the data model used by the UK Coronavirus Dashboard team. The data model is highly relational and leverages the power of NoSQL in that there are JSONB payloads in the time_series table. This data model gives the team versatility to accommodate future needs in that the JSONB payloads can/do change quite frequently and are easy to change; but the overall relational data model does not change which provides data integrity for these immutable things. Hyperscale (Citus) is used to distribute 3 of the tables across an Azure Database for PostgreSQL server group." li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333292iB3E81ADE044336F7?v=v2" li-image-display-id="&#39;333292iB3E81ADE044336F7&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/><span onclick="event.preventDefault();">Figure 4: Diagram depicting the data model used by the UK Coronavirus Dashboard team. The data model is highly relational and leverages the power of NoSQL in that there are JSONB payloads in the time_series table. This data model gives the team versatility to accommodate future needs in that the JSONB payloads can/do change quite frequently and are easy to change; but the overall relational data model does not change which provides data integrity for these immutable things. Hyperscale (Citus) is used to distribute 3 of the tables across an Azure Database for PostgreSQL server group.</span></span></p>

<h2 id="toc-hId-664619851">Combining Postgres range partitioning &amp; Citus sharding to scale a time-series workload</h2>

<p>The UKHSA team has been able to scale their analytics application—while still delivering sub-second query response times to their users—by capitalizing on the Citus ability to distribute data and queries across the database cluster. Or, to use the Azure terminology, across a <a href="https://docs.microsoft.com/azure/postgresql/concepts-hyperscale-nodes" target="_blank" rel="noopener noreferrer">Hyperscale (Citus) server group</a>.</p>

<p>In addition to sharding and distributing Postgres with Citus, the team also makes extensive use of the Postgres range partitioning feature. Each day’s worth of data is currently split into five Postgres partitions based on area type.</p>

<p>When the analytics dashboard sends a query to the database, it does not query the entire time-series table. Rather, only the relevant Postgres partition is queried. Pointing directly to a partition<sup><a id="fnref-1" role="doc-noteref" href="#fn-1" target="_self" rel="nofollow noopener noreferrer" name="fnref-1">[1]</a></sup> that does not contain more than 10 or 12 million rows speeds up query responses quite substantially.</p>

<h3 id="toc-hId--1013751893">Sharding strategy: choosing a distribution column</h3>
<p>For the Citus <a href="https://docs.citusdata.com/en/stable/develop/api_udf.html#create-distributed-table" target="_blank" rel="noopener nofollow noreferrer">distribution column</a> (some of you might call this the sharding key), the team has done something unusual and has created a particularly granular column in their data model. They generate a 12-digit hash value using a BLAKE algorithm for fast hashing, calculated from 4 fields: <code>release_id</code>, <code>area_id</code>, <code>metric_id</code>, and <code>date</code>.  </p>

<p>Distributing their data across the cluster by this hash value enables most of the SQL queries to be parallelized across the nodes in the Citus database cluster. The result: the query responses are quick enough to deliver the snappy, near real-time experience that the dashboard visitors have come to expect. Even when the visitor’s interactive queries are triggering all sorts of complexity under the covers.  </p>

<p>At the same time, using a hash over something like a random UUID prevents duplication. There are times when the data needs to be updated after it has already been deployed to the database—e.g. when a new version is submitted by the source. In that case, having a consistent sharding key enables updates of the existing data.</p>

<p><span image-alt="Figure 5: To optimize performance, SQL queries are pointed directly to a sharded partition rather than to the parent time-series table. The output of the SQL query above—shown in PyCharm, one of the development environments the UKHSA team uses—gives you a glimpse into different types of payload stored in the database."><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333293i80E168C51C11A65A/image-size/large?v=v2&amp;px=999" role="button" title="figure5-PyCharm-query-1600px.png" alt="Figure 5: To optimize performance, SQL queries are pointed directly to a sharded partition rather than to the parent time-series table. The output of the SQL query above—shown in PyCharm, one of the development environments the UKHSA team uses—gives you a glimpse into different types of payload stored in the database." li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333293i80E168C51C11A65A?v=v2" li-image-display-id="&#39;333293i80E168C51C11A65A&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/><span onclick="event.preventDefault();">Figure 5: To optimize performance, SQL queries are pointed directly to a sharded partition rather than to the parent time-series table. The output of the SQL query above—shown in PyCharm, one of the development environments the UKHSA team uses—gives you a glimpse into different types of payload stored in the database.</span></span></p>

<h2 id="toc-hId-1344678221">Deep dive into database tuning for complex SQL queries</h2>
<p>Migrating to Hyperscale (Citus) was straightforward—after all, Citus is an extension to Postgres and is compatible with tools in the Postgres ecosystem. Additionally, the UKHSA team and especially Pouria already had extensive experience in Postgres.</p>

<p>The team decided to migrate to Citus gradually, integrating different microservices at different times. They planned the upgrade such that the code for each microservice was updated and then deployed internally over a period of just over 1.5 months. The service was then subjected to extensive load testing—and meticulous QA by different members of the wider dashboard team—to ensure the integrity of the data before deployment to production.</p>

<p>While the UKHSA team was in the midst of migration and testing, they determined some performance tuning needed to be done for some of the more complex queries used by the UK Coronavirus analytics dashboard. To optimize performance, Pouria collaborated with the Citus database engineers on the Postgres team at Microsoft. Together, they tuned the database by adjusting settings for the <code>max_locks_per_transaction</code>, <code>max_adaptive_executor_pool_size</code>, and <code>task_assignment_policy</code>.</p>

<h3 id="toc-hId--333693523">Max locks per transaction</h3>
<p>When the team migrated the landing pages and postcode search pages—the most demanding part of the service in terms of the complexity of database queries—to run on top of Citus, they saw that latency was initially quite high. In some cases, the page would not respond and just fail. All transactions in the database would subsequently fail as well. They investigated and determined that the number of locks generated were the cause and that in some cases, there were as many as 120,000 locks in place. Those locks brought everything to a halt.</p>


<p><span image-alt="Figure 6: The postcode page on the GOV.UK Coronavirus dashboard, which enables users to look up local summary of stats in a particular UK postcode, is one of the more demanding on the dashboard site. This is a local postcode summary page for Westminster’s SW1A 0AA, for the Houses of Parliament. Hyperscale (Citus) in Azure Database for PostgreSQL might have to serve 12 or more SQL queries for this page alone at any given moment. (https://coronavirus.data.gov.uk/search?postcode=SW1A+0AA)"><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333338i54DEB20F8F24C88B/image-size/large?v=v2&amp;px=999" role="button" title="figure6-uk-coronavirus-dashboard-postcode-page-999px.png" alt="Figure 6: The postcode page on the GOV.UK Coronavirus dashboard, which enables users to look up local summary of stats in a particular UK postcode, is one of the more demanding on the dashboard site. This is a local postcode summary page for Westminster’s SW1A 0AA, for the Houses of Parliament. Hyperscale (Citus) in Azure Database for PostgreSQL might have to serve 12 or more SQL queries for this page alone at any given moment. (https://coronavirus.data.gov.uk/search?postcode=SW1A+0AA)" li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333338i54DEB20F8F24C88B?v=v2" li-image-display-id="&#39;333338i54DEB20F8F24C88B&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/><span onclick="event.preventDefault();">Figure 6: The postcode page on the GOV.UK Coronavirus dashboard, which enables users to look up local summary of stats in a particular UK postcode, is one of the more demanding on the dashboard site. This is a local postcode summary page for Westminster’s SW1A 0AA, for the Houses of Parliament. Hyperscale (Citus) in Azure Database for PostgreSQL might have to serve 12 or more SQL queries for this page alone at any given moment. (https://coronavirus.data.gov.uk/search?postcode=SW1A+0AA)</span></span></p>

<p>It turned out that querying using the <code>partition_id</code>was part of the issue. Everywhere in the application, including on the APIs, the queries were always directed at a single partition. Citus gives you the flexibility to do that, and when you do, you can decrease latency, especially with very large databases. However, in this particular case, because data is required from multiple area types, the query was using the <code>partition_id</code> instead of directly querying the partition. That was one of the reasons so many locks were being set all over the place.</p>

<p>The team began to address the issue by breaking a long, 250-line SQL query into subqueries. The long SQL query was used to present the number of cases in a particular postcode area, which requires a demanding set of operations.</p>

<p>The intention was to push these jobs down to individual workers and shards. To do that, the team decided to change the approach from using Postgres CTEs (Common Table Expressions) to using subqueries, and then subqueries of subqueries.</p>

<p>Below you can see a side-by-side comparison of the EXPLAIN plan for the SQL query before and after the optimization, with and without the query pushdowns. The entire SQL query (and query_plan) for both the <a href="https://gist.github.com/xenatisch/75012db7f9ccd1ea2470e55bca019eb9#file-cache_repopulation-normal-sql" target="_blank" rel="noopener noreferrer">normal/original query</a> and the <a href="https://gist.github.com/xenatisch/75012db7f9ccd1ea2470e55bca019eb9#file-cache_repopulation-optimised-sql" target="_blank" rel="noopener noreferrer">optimized-for-Citus query</a>—can be seen in <a href="https://gist.github.com/xenatisch/75012db7f9ccd1ea2470e55bca019eb9" target="_blank" rel="noopener noreferrer">Pouria’s gist on GitHub</a>.</p>

<p>In the side-by-side comparison of the Postgres <code>EXPLAIN</code>plans below, note:</p>
<ul>
<li>the <a href="https://gist.github.com/xenatisch/75012db7f9ccd1ea2470e55bca019eb9#file-query_plan-normal-txt" target="_blank" rel="noopener noreferrer">normal query_plan on the left</a> looks like a shark tooth</li>
<li>whereas the <a href="https://gist.github.com/xenatisch/75012db7f9ccd1ea2470e55bca019eb9#file-query_plan-optimised-txt" target="_blank" rel="noopener noreferrer">optimized query_plan on the right</a> looks like a simple wave</li>
</ul>

<p>This is because in the optimized pushdown version of the SQL query, the subqueries do not return results to the Citus coordinator node one at a time, rather, thanks to Citus, the subquery results are returned in a parallelized way.</p>

<p><span image-alt="Figure 7: The UKHSA team needed to break up a particularly long SQL query, which retrieves granular data per postcode, to address latency issues caused by locks. This is a side-by-side comparison of the EXPLAIN plans for the SQL query before and after optimization."><img src="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333295i27D41CA83F3B4DDD/image-size/large?v=v2&amp;px=999" role="button" title="figure7-side-by-side-query-explain-plans-depicting-sharktooth-999px.png" alt="Figure 7: The UKHSA team needed to break up a particularly long SQL query, which retrieves granular data per postcode, to address latency issues caused by locks. This is a side-by-side comparison of the EXPLAIN plans for the SQL query before and after optimization." li-image-url="https://techcommunity.microsoft.com/t5/image/serverpage/image-id/333295i27D41CA83F3B4DDD?v=v2" li-image-display-id="&#39;333295i27D41CA83F3B4DDD&#39;" li-message-uid="&#39;3036276&#39;" li-messages-message-image="true" li-bindable="" tabindex="0" li-bypass-lightbox-when-linked="true" li-use-hover-links="false"/><span onclick="event.preventDefault();">Figure 7: The UKHSA team needed to break up a particularly long SQL query, which retrieves granular data per postcode, to address latency issues caused by locks. This is a side-by-side comparison of the EXPLAIN plans for the SQL query before and after optimization.</span></span></p>

<p>However, they learned that no matter how much they pushed the queries down and optimized, it would still create more locks than the system can handle.</p>

<p>The solution? Increase the <a href="https://www.postgresql.org/docs/current/runtime-config-locks.html" target="_blank" rel="noopener nofollow noreferrer">PostgreSQL setting</a> for <code>max_locks_per_transaction</code>. Instead of the default setting of 64, the Citus and UKHSA team changed the setting to 10,000—which matched the number of partitions per node. This is a problem that happens in Postgres when you query parent tables with a large number of partitions, especially when the partitions contain time series data. The issue is further amplified when the partitions are also sharded with Citus. In such cases, setting the maximum number of locks to a high number becomes critical.</p>

<p>After optimizing the query, changing the <code>max_locks_per_transaction</code>setting, and directly querying the Postgres partitions where possible, a much smaller number of locks are generated—usually no more than 400 at peak.</p>

<h3 id="toc-hId--2141147986">Max adaptive executor pool size</h3>
<p>For certain types of SQL queries, Pouria and the Citus engineers also adjusted the <code>citus.max_adaptive_executor_pool_size</code>to limit the number of connections that Citus generates in the current session.</p>

<p>With Pouria’s sharding strategy, every single SQL query is parallelized across multiple nodes in the Citus cluster, both the simple and complex queries. The problem was that parallelizing simple, short lookup queries was adding overhead, because Citus had to create multiple connections across worker nodes.</p>

<p>So, the team set the <a href="https://docs.citusdata.com/en/stable/develop/api_guc.html?highlight=citus.max_adaptive_executor_pool_size#citus-max-adaptive-executor-pool-size-integer" target="_blank" rel="noopener nofollow noreferrer">citus.max_adaptive_executor_pool_size</a> to <code>1</code> for short lookup queries, so that there is only one connection per node. For more demanding queries, including ones that do aggregations, the team set the max adaptive pool size to the default value of 16.</p>

<p>Capitalizing on this Citus flexibility to prioritize which types of SQL queries should get more or fewer connections was quite effective in the team’s efforts to optimize performance.</p>

<h3 id="toc-hId-1044526788">Round-robin task assignment policy</h3>
<p>The analytics dashboard uses Citus to distribute 3 Postgres tables:</p>

<ul>
<li>the time-series table (<code>time_series</code>),</li>
<li>the postcodes lookup table (<code>postcode_lookup</code>),</li>
<li>a table with headline data (<code>private_report</code>)</li>
</ul>

<p>The rest of the Citus tables are either <a href="https://docs.citusdata.com/en/stable/get_started/concepts.html#type-2-reference-tables" target="_blank" rel="noopener nofollow noreferrer">reference tables</a> or <a href="https://docs.citusdata.com/en/stable/get_started/concepts.html#type-3-local-tables" target="_blank" rel="noopener nofollow noreferrer">local tables</a>, which are local to the coordinator node. With Citus, by default, a query on a reference table will run on the first worker node, known as the “first replica”.</p>

<p>Pouria changed the <a href="https://docs.citusdata.com/en/stable/develop/api_guc.html?highlight=citus.task_assignment_policy#citus-task-assignment-policy-enum" target="_blank" rel="noopener nofollow noreferrer">citus.task_assignment_policy</a> setting to “round-robin” to avoid having every reference table query hit the same node. The <a href="https://docs.citusdata.com/en/stable/develop/api_guc.html#citus-task-assignment-policy-enum" target="_blank" rel="noopener nofollow noreferrer">round-robin policy</a> assigns tasks to workers by alternating between different replicas. When SQL queries are on the Citus reference table—a frequent occurrence when using the <a href="https://coronavirus.data.gov.uk/details/developers-guide/generic-api" target="_blank" rel="noopener nofollow noreferrer">Generic API</a>—they will go to the first node in the cluster, then the second. Using multiple workers instead of just the first worker node enhances performance.</p>

<h2 id="toc-hId--892010394">Key learnings for building a large, responsive application</h2>

<p>Pouria shared a few more insights on how to architect an application that can handle a tremendous amount of time series data—and deliver a user experience with those 200 millisecond response times that feel so responsive.</p>

<h3 id="toc-hId-1724585158">Architecting the analytics service in a principled way</h3>
<p>The pressure to deliver a new application quickly can sometimes steer an organization to build services the easy way. In the case of the UK’s COVID-19 analytics dashboard, failing to implement a proper structure for the database, or a proper structure for the code—or neglecting to architect an application that could be scaled—would have created major issues down the line.</p>

<p>What’s a proper structure for the database? Like everything else in software engineering, it depends on the specifics of a project. In this situation, Pouria’s team followed best practices in RDBMS design, data integrity, connection pooling, versatility and reusability of code, as well as developing a thorough understanding of the data. In fact, Pouria’s deep understanding of the data is the reason they chose to use a JSONB payload (combining RDBMS with NoSQL) to ensure they could accommodate unexpected needs that might arise in the future.</p>

<p>When Pouria and team started, they never thought they would have over 1 million unique users a day, nor did they think that they would have to accommodate 50 to 70 million hits per day. Although no one anticipated this level of growth and popularity, Pouria’s team did build a system that could accommodate future needs and enable distributed scale. That turned out to be a smart decision that made all the difference in the success and impact of the UK Coronavirus dashboard.</p>

<h3 id="toc-hId--82869305">Implementing multiple layers of caching on top of your database</h3>
<p>Caching is used to improve responsiveness and reduce latency during the enormous traffic spikes that the UK Coronavirus dashboard experiences every day at 4:00pm.</p>

<p>Pouria’s team uses multiple layers of caching that are meticulously choreographed to work in tandem and reduce the load directed at the database. They use Azure Front Door as a CDN cache (content delivery network) that caches all the query responses for a predetermined period of time.</p>

<p>They also have an API management (APIM)–level cache that uses Azure Cache for Redis. Pouria wrote a bespoke policy in APIM to generatea uniformly distributed random number for each request and caches the response for that period of time, in seconds. Doing so prevents the several hundred thousand caches from expiring (and being refreshed) at the same time.</p>

<p>Another Redis cache on Azure helps with postcode searches. This cache helps ensure that each part of a postcode look up query—which maps postcodes to all of the 6 area types for which the data are published—is only requested from the Postgres database once. Postcode requests are structured into different areas and then asynchronous calls are made to Redis. Only if Redis does not have the data is the request forwarded to the database.</p>

<p>Finally, Pouria has a client-side cache on the browser that is shorter than the CDN. Using all of these caches might not be common practice... but in the UK Coronavirus dashboard’s case, the caches help to maintain a responsive application, while ensuring the freshness of data that is presented. The expiry time for identical queries is different in different layers. This ensures:</p>

<ul>
<li><strong>Freshness of data:</strong> client-side (browser) cache durations never exceed 2 minutes. This ensures the freshness of data and improve overall user experience.</li>
<li><strong>Reduction of short-term load:</strong> Website data are cached in the CDN, the duration of which also doesn’t exceed 2 minutes. This is particularly important because flushing CDN cache can take up to 10 minutes, which would cause extensive confusion for users when new data are released. The 2-minute period ensures that identical requests reach the backend at a lower frequency and thereby reduces the load on both APIM and Redis servers.</li>
<li><strong>Reduction of medium-term load with added contingency:</strong> Redis cache—the duration of which can be anything between 10 minutes to 8 hours for time series data and up to 2 weeks for generic data—are structured such that they are invalidated as soon as new data are released.</li>
<li><strong>Reduction of long-term load for large payloads:</strong> Storage-based caching for <a href="https://coronavirus.data.gov.uk/details/developers-guide/bulk-downloads-api" target="_blank" rel="noopener nofollow noreferrer">APIv2</a>—which powers the <a href="https://coronavirus.data.gov.uk/details/download" target="_blank" rel="noopener nofollow noreferrer">downloads page</a> that supplies data sets containing millions of rows—are retained indefinitely based on the release date to ensure that identical requests are only ever processed once.</li>
</ul>

<h3 id="toc-hId--1890323768">Pre-populated cache with Azure Cache for Redis</h3>
<p>Minutes or seconds before data is queried, approximately 9K items of cache are pre-populated in order to speed up response times for some chunky, complex SQL queries from approximately 920 ms to approximately 50 ms.</p>

<p>The chunky SQL queries are complex because not all metrics on the page are available for all areas every day. For instance, vaccination data in England are published at MSOA<sup><a id="fnref-2" role="doc-noteref" href="#fn-2" target="_self" rel="nofollow noopener noreferrer" name="fnref-2">[2]</a></sup> level, while in Scotland, they are published at local authority level.</p>

<p>To support these types of SQL queries on the fly would require many UNIONs &amp; JOINs and would take too long. By pre-processing this rather tricky part of the calculations, these SQL queries can be pushed down to the worker nodes in the Citus database cluster and thereby parallelized. And things are faster. </p>

<h2 id="toc-hId-468106346">Distributing Postgres has been essential for scalability</h2>

<p>For Pouria and the UKHSA team, the decision to use Azure Database for PostgreSQL—and to distribute Postgres across a cluster of nodes with Hyperscale (Citus)—has enabled the GOV.UK Coronavirus dashboard to deliver fast response times to millions of users. Even with an ever-growing time series data set.</p>

<p>With 7.5 billion records (and growing) in this PostgreSQL database—distributed across a cluster with Citus—the UK coronavirus dashboard has queries that execute in less than 3 milliseconds. Another example of the near-instantaneous performance that Citus on Azure provides: you can download an LTLA dataset that triggers a query and gives you over 5 million data points in under 10 seconds.</p>

<p>Pouria feels the type of data handled by the UK Coronavirus dashboard is probably one of the most demanding you could have in a database because it’s time series, it’s massive, and  requires complex queries targeted at only a handful of rows to be processed in real time. It’s rare to deal with time-series data with this magnitude of transactions and this amount of data in each response. The term that Pouria uses to describe the number of Postgres database operations and the volume of data involved in each transaction is “absolutely colossal.” The takeaway is that if Citus can handle this, it can likely handle any volume of data.</p>

<hr/>
<h2 id="toc-hId--1339348117">Acknowledgements</h2>

<p>After collaborating on this blog post and reflecting on the work involved and the far-reaching impact of the <a href="https://coronavirus.data.gov.uk/" target="_blank" rel="noopener nofollow noreferrer">GOV.UK Coronavirus dashboard</a>, we wish to express the uttermost gratitude to all of our respective teammates—both at the UKHSA (formerly PHE) and in the Postgres and Citus team at Microsoft—who have worked on this project. Your contributions and collaboration have built the analytics dashboard into the service that it is today. In particular, a special shout out to:</p>

<p>* <strong>David Jephson</strong> – Deputy head of the UK Coronavirus Dashboard (data and pipeline), UKHSA</p>
<p>* <strong>James Westwood</strong> – Deputy head of the UK Coronavirus Dashboard (data and pipeline), UKHSA</p>
<p>* <strong>Brogan Goble</strong> – Software and DevOps Engineer, UKHSA</p>
<p>...</p>
<p>* <strong>Sai Srirampur</strong> – Technical lead of Citus customer engineering and Principal Engineering Manager at Microsoft</p>

<p><SPAN size="2"><em>—With our sincere thanks, co-authors </em><a href="https://twitter.com/Pouriaaa" target="_blank" rel="noopener nofollow noreferrer"><strong><em>Pouria Hadjibagheri</em></strong></a><em> and </em><a href="https://twitter.com/clairegiordano" target="_blank" rel="noopener nofollow noreferrer"><strong><em>Claire Giordano</em></strong></a></SPAN></p>
<hr/>
<section>
<p><strong>Footnotes</strong></p>
<ol role="list">
<li role="listitem">
<p>Postgres enables you to query the parent table that is partitioned. Once you have the right filters in the query, Postgres automatically routes the SQL query to the right partition and executes it. That’s how many Postgres users take advantage of Postgres partitioning. In the case of the GOV.UK Coronavirus dashboard, the UKHSA team chose to directly query the partitions as a performance optimization, to reduce the extra planning overhead. <a role="doc-backlink" href="#fnref-1" target="_self" rel="nofollow noopener noreferrer">↩</a></p>
</li>
<li role="listitem">
<p>MSOA: Middle-Layer Super Output areas are statistical boundaries that contained around ~5,000 residents each when they were last created, around ~2011. The estimated population for each MSOA is updated annually by the Office for National Statistics. <a role="doc-backlink" href="#fnref-2" target="_self" rel="nofollow noopener noreferrer">↩</a></p>
</li>
</ol>
</section>
					
				
			
			
			
				
			
			
			
			
			
			
		</div>
		
		
	

	
	
</div>
	</div></div>
  </body>
</html>
