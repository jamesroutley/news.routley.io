<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.tymscar.com/posts/imgurukproxy/">Original</a>
    <h1>Imgur geo-blocked the UK, so I geo-unblocked my network</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Imgur decided to block UK users. Honestly? I don’t really care that much. I haven’t actively browsed the site in years. But it used to be everywhere. Back when Reddit embedded everything on Imgur, maybe fifteen years ago, it was genuinely useful. Then Reddit built their own image hosting, Discord did the same, and Imgur slowly faded into the background.</p><p>Except it never fully disappeared. And since the block, I keep stumbling across Imgur links that just show “unavailable.” It’s mildly infuriating.</p><p><img src="https://blog.tymscar.com/imgur-uk/not-working.png" alt="Imgur showing unavailable in the UK"/></p><h2 id="the-minecraft-shader-problem">The Minecraft shader problem<a href="#the-minecraft-shader-problem" arialabel="Anchor">#</a></h2><p>Here’s a concrete example. I was playing Minecraft with some work colleagues and wanted to try different shaders. Most shader pages embed preview images hosted on Imgur. So I’d click through shader after shader, and every single preview was just gone. I couldn’t see what any of them looked like without the images.</p><p>This kind of thing happens constantly now. Old forum posts, Reddit threads, documentation pages, random project READMEs. Imgur links are still scattered across the internet, and in the UK, they’re all broken.</p><h2 id="why-i-didnt-just-install-a-vpn">Why I didn’t just install a VPN<a href="#why-i-didnt-just-install-a-vpn" arialabel="Anchor">#</a></h2><p>The obvious solution is to use a VPN. Change your location, problem solved. But I have a few issues with that approach.</p><p>First, I just <a href="https://blog.tymscar.com/posts/wifi7speedhunt/">upgraded to 2.5 Gbps internet</a> and I don’t want to route all my traffic through a VPN and take the speed hit. I have this bandwidth for a reason.</p><p>Second, even if I installed a VPN on my main machine, what about my phone? My laptop? My desktop? Every device would need the VPN running, and I’d have to remember to connect it before browsing. It’s messy.</p><p>I wanted something cleaner: a solution that works for every device on my network, automatically, without any client-side configuration.</p><h2 id="the-network-level-approach">The network-level approach<a href="#the-network-level-approach" arialabel="Anchor">#</a></h2><p>I already run a homelab with Traefik as my reverse proxy, Pi-hole for DNS, and everything declaratively configured with NixOS. If you’ve read my <a href="https://blog.tymscar.com/posts/nixosdockerwithsecrets/">previous post on Docker containers with secrets</a>, you’ll recognise the pattern.</p><p>The idea was simple: intercept all requests to <code>i.imgur.com</code> at the DNS level, route them through a VPN-connected container, and serve the images back. Every device on my network automatically uses Pi-hole for DNS via DHCP, so this would be completely transparent.</p><p>Here’s the flow:</p><ol><li>Device requests <code>i.imgur.com</code></li><li>Pi-hole returns my Traefik instance’s IP instead</li><li>Traefik sees the SNI hostname and routes to Gluetun</li><li>Gluetun tunnels the request through a VPN</li><li>Nginx (attached to Gluetun’s network) proxies to the real Imgur</li><li>Image comes back through the tunnel to the device</li></ol><h2 id="why-nginx-when-i-already-have-traefik">Why Nginx when I already have Traefik?<a href="#why-nginx-when-i-already-have-traefik" arialabel="Anchor">#</a></h2><p>Good question. Gluetun isn’t a reverse proxy. It’s a container that provides VPN connectivity to other containers attached to its network namespace. So I needed something inside Gluetun’s network to actually handle the proxying. Nginx was the simplest choice.</p><p>The Nginx config is minimal. It just does TCP passthrough with SNI:</p><div><pre tabindex="0"><code data-lang="nginx"><span><span><span>user</span> <span>nginx</span>;
</span></span><span><span><span>worker_processes</span> <span>auto</span>;
</span></span><span><span><span>error_log</span> <span>/var/log/nginx/error.log</span> <span>warn</span>;
</span></span><span><span><span>pid</span> <span>/var/run/nginx.pid</span>;
</span></span><span><span>
</span></span><span><span><span>events</span> {
</span></span><span><span>    <span>worker_connections</span> <span>1024</span>;
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span><span>stream</span> {
</span></span><span><span>    <span>resolver</span> 127.0.0.1 <span>valid=30s</span>;
</span></span><span><span>    <span>resolver_timeout</span> <span>5s</span>;
</span></span><span><span>
</span></span><span><span>    <span>server</span> {
</span></span><span><span>        <span>listen</span> <span>443</span>;
</span></span><span><span>        <span>ssl_preread</span> <span>on</span>;
</span></span><span><span>        <span>proxy_pass</span> i.imgur.com:<span>443</span>;
</span></span><span><span>        <span>proxy_connect_timeout</span> <span>10s</span>;
</span></span><span><span>        <span>proxy_timeout</span> <span>60s</span>;
</span></span><span><span>    }
</span></span><span><span>}
</span></span></code></pre></div><p>This listens on port 443, reads the SNI header to confirm the destination, and passes the connection through to the real <code>i.imgur.com</code>. The TLS handshake happens end-to-end; Nginx never sees the decrypted traffic.</p><h2 id="the-docker-setup">The Docker setup<a href="#the-docker-setup" arialabel="Anchor">#</a></h2><p>The compose file runs two containers. Gluetun handles the VPN connection, and Nginx attaches to Gluetun’s network:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>version</span>: <span>&#39;3.8&#39;</span>
</span></span><span><span>
</span></span><span><span><span>services</span>:
</span></span><span><span>  <span>gluetun</span>:
</span></span><span><span>    <span>image</span>: <span>qmcgaw/gluetun:latest</span>
</span></span><span><span>    <span>container_name</span>: <span>gluetun</span>
</span></span><span><span>    <span>cap_add</span>:
</span></span><span><span>      - <span>NET_ADMIN</span>
</span></span><span><span>    <span>devices</span>:
</span></span><span><span>      - <span>/dev/net/tun:/dev/net/tun</span>
</span></span><span><span>    <span>environment</span>:
</span></span><span><span>      - <span>VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}</span>
</span></span><span><span>      - <span>VPN_TYPE=wireguard</span>
</span></span><span><span>      - <span>WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}</span>
</span></span><span><span>      - <span>SERVER_COUNTRIES=${SERVER_COUNTRIES}</span>
</span></span><span><span>      - <span>FIREWALL=on</span>
</span></span><span><span>      - <span>FIREWALL_INPUT_PORTS=443</span>
</span></span><span><span>      - <span>FIREWALL_OUTBOUND_SUBNETS=10.0.0.0/8</span>
</span></span><span><span>      - <span>DOT=on</span>
</span></span><span><span>      - <span>DOT_PROVIDERS=cloudflare</span>
</span></span><span><span>      - <span>HEALTH_VPN_DURATION_INITIAL=30s</span>
</span></span><span><span>    <span>volumes</span>:
</span></span><span><span>      - <span>./gluetun:/gluetun</span>
</span></span><span><span>    <span>restart</span>: <span>unless-stopped</span>
</span></span><span><span>    <span>networks</span>:
</span></span><span><span>      - <span>proxy</span>
</span></span><span><span>    <span>healthcheck</span>:
</span></span><span><span>      <span>test</span>: [<span>&#34;CMD&#34;</span>, <span>&#34;/gluetun-entrypoint&#34;</span>, <span>&#34;healthcheck&#34;</span>]
</span></span><span><span>      <span>interval</span>: <span>30s</span>
</span></span><span><span>      <span>timeout</span>: <span>10s</span>
</span></span><span><span>      <span>retries</span>: <span>3</span>
</span></span><span><span>      <span>start_period</span>: <span>30s</span>
</span></span><span><span>
</span></span><span><span>  <span>imgur-proxy</span>:
</span></span><span><span>    <span>image</span>: <span>nginx:alpine</span>
</span></span><span><span>    <span>container_name</span>: <span>imgur-proxy</span>
</span></span><span><span>    <span>depends_on</span>:
</span></span><span><span>      <span>gluetun</span>:
</span></span><span><span>        <span>condition</span>: <span>service_healthy</span>
</span></span><span><span>    <span>network_mode</span>: <span>&#34;service:gluetun&#34;</span>
</span></span><span><span>    <span>volumes</span>:
</span></span><span><span>      - <span>./nginx.conf:/etc/nginx/nginx.conf:ro</span>
</span></span><span><span>    <span>restart</span>: <span>unless-stopped</span>
</span></span><span><span>
</span></span><span><span><span>networks</span>:
</span></span><span><span>  <span>proxy</span>:
</span></span><span><span>    <span>external</span>: <span>true</span>
</span></span></code></pre></div><p>The key detail is <code>network_mode: &#34;service:gluetun&#34;</code>. This makes Nginx share Gluetun’s network stack, so all its traffic automatically goes through the VPN tunnel.</p><p>I’m not going to mention which VPN provider I use. It’s one of the major ones with WireGuard support, but honestly I’m not thrilled with it. Use whatever you have.</p><h2 id="traefik-routing">Traefik routing<a href="#traefik-routing" arialabel="Anchor">#</a></h2><p>The final piece is telling Traefik to route <code>i.imgur.com</code> traffic to the Gluetun container. This uses TCP routing with TLS passthrough:</p><div><pre tabindex="0"><code data-lang="yaml"><span><span><span>tcp</span>:
</span></span><span><span>  <span>routers</span>:
</span></span><span><span>    <span>imgur-router</span>:
</span></span><span><span>      <span>rule</span>: <span>&#34;HostSNI(`i.imgur.com`)&#34;</span>
</span></span><span><span>      <span>entryPoints</span>:
</span></span><span><span>        - <span>https</span>
</span></span><span><span>      <span>service</span>: <span>imgur-service</span>
</span></span><span><span>      <span>tls</span>:
</span></span><span><span>        <span>passthrough</span>: <span>true</span>
</span></span><span><span>  <span>services</span>:
</span></span><span><span>    <span>imgur-service</span>:
</span></span><span><span>      <span>loadBalancer</span>:
</span></span><span><span>        <span>servers</span>:
</span></span><span><span>          - <span>address</span>: <span>&#34;gluetun:443&#34;</span>
</span></span></code></pre></div><p>The <code>passthrough: true</code> is important. It means Traefik doesn’t terminate TLS; it just inspects the SNI header and forwards the connection.</p><h2 id="nixos-integration">NixOS integration<a href="#nixos-integration" arialabel="Anchor">#</a></h2><p>Following the same pattern from my <a href="https://blog.tymscar.com/posts/nixosdockerwithsecrets/">Docker with secrets post</a>, I created a systemd service that runs the compose stack with Agenix-managed secrets:</p><div><pre tabindex="0"><code data-lang="nix"><span><span>{ pkgs<span>,</span> config<span>,</span> <span>...</span> }:
</span></span><span><span><span>let</span>
</span></span><span><span>  docker-env <span>=</span> config<span>.</span>age<span>.</span>secrets<span>.</span>docker-imgur-proxy<span>.</span>path;
</span></span><span><span><span>in</span>
</span></span><span><span>{
</span></span><span><span>  systemd<span>.</span>services<span>.</span>imgur-proxy <span>=</span> {
</span></span><span><span>    description <span>=</span> <span>&#34;Imgur Proxy with VPN&#34;</span>;
</span></span><span><span>    after <span>=</span> [
</span></span><span><span>      <span>&#34;network.target&#34;</span>
</span></span><span><span>      <span>&#34;docker.service&#34;</span>
</span></span><span><span>      <span>&#34;docker-create-proxy-network.service&#34;</span>
</span></span><span><span>    ];
</span></span><span><span>    wants <span>=</span> [
</span></span><span><span>      <span>&#34;docker.service&#34;</span>
</span></span><span><span>      <span>&#34;docker-create-proxy-network.service&#34;</span>
</span></span><span><span>    ];
</span></span><span><span>    serviceConfig <span>=</span> {
</span></span><span><span>      ExecStart <span>=</span> <span>&#34;</span><span>${</span>pkgs<span>.</span>docker<span>}</span><span>/bin/docker compose --env-file </span><span>${</span>docker-env<span>}</span><span> -f docker-compose.yml up --force-recreate&#34;</span>;
</span></span><span><span>      ExecStop <span>=</span> <span>&#34;</span><span>${</span>pkgs<span>.</span>docker<span>}</span><span>/bin/docker compose -f docker-compose.yml down&#34;</span>;
</span></span><span><span>      WorkingDirectory <span>=</span> <span>&#34;/home/tymscar/dotfiles/apps/nixos/docker/imgur-proxy&#34;</span>;
</span></span><span><span>      Restart <span>=</span> <span>&#34;always&#34;</span>;
</span></span><span><span>    };
</span></span><span><span>    wantedBy <span>=</span> [ <span>&#34;multi-user.target&#34;</span> ];
</span></span><span><span>  };
</span></span><span><span>}
</span></span></code></pre></div><p>The VPN credentials are stored encrypted with Agenix, so my entire dotfiles repo stays public while keeping secrets safe.</p><h2 id="the-result">The result<a href="#the-result" arialabel="Anchor">#</a></h2><p>Now when any device on my network requests an Imgur image, it works. My phone, my laptop, guest devices, everything. No VPN apps to install, no browser extensions, no manual configuration. Pi-hole intercepts the DNS, Traefik routes the connection, and Gluetun tunnels it through a non-UK exit point.</p><p><img src="https://blog.tymscar.com/imgur-uk/working.png" alt="Imgur working after the fix"/></p><p>The latency increase is negligible for loading images, and it only affects Imgur traffic. Everything else still goes direct at full speed.</p><p>Is this overkill for viewing the occasional Imgur image? Probably. But it’s a clean solution that requires minimal ongoing maintenance, and it scratches the homelab itch. Plus I can finally see what those Minecraft shaders look like.</p></div></div></div>
  </body>
</html>
