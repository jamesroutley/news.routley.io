<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://words.filippo.io/claude-debugging/">Original</a>
    <h1>Claude Code Can Debug Low-level Cryptography</h1>
    
    <div id="readability-page-1" class="page"><section>
            <!-- buttondown-editor-mode: plaintext -->
<p>Over the past few days I wrote a new Go implementation of ML-DSA, a post-quantum signature algorithm specified by NIST last summer. I <a href="https://twitch.tv/filosottile">livecoded</a> it all over four days, finishing it on Thursday evening. Except… Verify was always rejecting valid signatures.</p>
<pre><code>$ bin/go test crypto/internal/fips140/mldsa
--- FAIL: TestVector (0.00s)
    mldsa_test.go:47: Verify: mldsa: invalid signature
    mldsa_test.go:84: Verify: mldsa: invalid signature
    mldsa_test.go:121: Verify: mldsa: invalid signature
FAIL
FAIL     crypto/internal/fips140/mldsa   2.142s
FAIL
</code></pre>
<p>I was exhausted, so I tried debugging for half an hour and then gave up, with the intention of coming back to it the next day with a fresh mind.</p>
<p>On a whim, I figured I would let Claude Code take a shot while I read emails and resurfaced from hyperfocus. I mostly expected it to flail in some maybe-interesting way, or rule out some issues.</p>
<p>Instead, it rapidly figured out a fairly complex low-level bug in my implementation of a relatively novel cryptography algorithm. I am sharing this because it made me realize I still don’t have a good intuition for when to invoke AI tools, and because I think it’s a fantastic case study for anyone who’s still skeptical about their usefulness.</p>
<blockquote>
<p>Full disclosure: Anthropic gave me a few months of Claude Max for free. They reached out one day and told me they were giving it away to some open source maintainers. Maybe it’s a ploy to get me hooked so I’ll pay for it when the free coupon expires. Maybe they hoped I’d write something like this. Maybe they are just nice. Anyway, they made no request or suggestion to write anything public about Claude Code. Now you know.</p>
</blockquote>
<h2 id="finding-the-bug">Finding the bug</h2>
<p>I started Claude Code v2.0.28 with Opus 4.1 and no system prompts, and gave it the following prompt (typos included):</p>
<blockquote>
<p>I implemented ML-DSA in the Go standard library, and it all works except that verification always rejects the signatures. I know the signatures are right because they match the test vector.</p>
<p>YOu can run the tests with “bin/go test crypto/internal/fips140/mldsa”</p>
<p>You can find the code in src/crypto/internal/fips140/mldsa</p>
<p>Look for potential reasons the signatures don’t verify. ultrathink</p>
<p>I spot-checked and w1 is different from the signing one.</p>
</blockquote>
<p>To my surprise, it pinged me a few minutes later with <a href="https://go-review.googlesource.com/c/go/+/716540/1..2">a complete fix</a>.</p>
<p>Maybe I shouldn’t be surprised! Maybe it would have been clear to anyone more familiar with AI tools that this was a good AI task: a well-scoped issue with failing tests. On the other hand, this is a low-level issue in a fresh implementation of a complex, <em>relatively novel</em> algorithm.</p>
<p>It figured out that I had merged <code>HighBits</code> and <code>w1Encode</code> into a single function for using it from Sign, and then reused it from Verify where <code>UseHint</code> already produces the high bits, effectively taking the high bits of w1 twice in Verify.</p>
<p>Looking at <a href="https://gist.github.com/FiloSottile/d019f68db7143493c6a7e9c5fd08e872">the log</a>, it loaded the implementation into the context and then <em>immediately</em> figured it out, without any exploratory tool use! After that it wrote itself a cute little test that reimplemented half of verification to confirm the hypothesis, wrote a mediocre fix, and checked the tests pass.</p>
<p>I <a href="https://go-review.googlesource.com/c/go/+/716540/2..3">threw the fix away</a> and refactored <code>w1Encode</code> to take high bits as input, and changed the type of the high bits, which is both clearer and saves a round-trip through Montgomery representation. Still, this 100% saved me a bunch of debugging time.</p>
<h2 id="a-second-synthetic-experiment">A second synthetic experiment</h2>
<p>On Monday, I had also finished implementing signing with failing tests. There were two bugs, which I fixed in the following couple evenings.</p>
<p>The first one was due to <a href="https://go-review.googlesource.com/c/go/+/716240/1..2">somehow computing a couple hardcoded constants (1 and -1 in the Montgomery domain) wrong</a>. It was very hard to find, requiring a lot of deep printfs and guesswork. Took me maybe an hour or two.</p>
<p>The second one was easier: <a href="https://go-review.googlesource.com/c/go/+/716240/2..3">a value that ends up encoded in the signature was too short (32 bits instead of 32 bytes)</a>. It was relatively easy to tell because only the first four bytes of the signature were the same, and then the signature lengths were different.</p>
<p>I figured these would be an interesting way to validate Claude’s ability to help find bugs in low-level cryptography code, so I checked out the old version of the change with the bugs (yay Jujutsu!) and kicked off a fresh Claude Code session with this prompt:</p>
<blockquote>
<p>I am implementing ML-DSA in the Go standard library, and I just finished implementing signing, but running the tests against a known good test vector it looks like it goes into an infinite loop, probably because it always rejects in the Fiat-Shamir with Aborts loop.</p>
<p>You can run the tests with “bin/go test crypto/internal/fips140/mldsa”</p>
<p>You can find the code in src/crypto/internal/fips140/mldsa</p>
<p>Figure out why it loops forever, and get the tests to pass. ultrathink</p>
</blockquote>
<p>It spent <a href="https://gist.github.com/FiloSottile/d16c37b2fada56875a894cdd2670a860">some time doing printf debugging and chasing down incorrect values very similarly to how I did it, and then figured out and fixed the wrong constants</a>. Took Claude definitely less than it took me. Impressive.</p>
<p>It gave up after fixing that bug even if the tests still failed, so I started a fresh session (on the assumption that the context on the wrong constants would do more harm than good investigating an independent bug), and gave it this prompt:</p>
<blockquote>
<p>I am implementing ML-DSA in the Go standard library, and I just finished implementing signing, but running the tests against a known good test vector they don’t match.</p>
<p>You can run the tests with “bin/go test crypto/internal/fips140/mldsa”</p>
<p>You can find the code in src/crypto/internal/fips140/mldsa</p>
<p>Figure out what is going on. ultrathink</p>
</blockquote>
<p><a href="https://gist.github.com/FiloSottile/b184888663c5d57078dc90b1a019981b">It took a couple wrong paths, thought for quite a bit longer, and then found this one too</a>. I honestly expected it to fail initially.</p>
<p>It’s interesting how Claude found the “easier” bug more difficult. My guess is that maybe the large random-looking outputs of the failing tests did not play well with its attention.</p>
<p>The fix it proposed was updating only the allocation’s length and not its capacity, but whatever, the point is finding the bug, and I’ll usually want to throw away the fix and rewrite it myself anyway.</p>
<p>Three out of three one-shot debugging hits with no help is <em>extremely impressive</em>. Importantly, there is no need to trust the LLM or review its output when its job is just saving me an hour or two by telling me where the bug is, for me to reason about it and fix it.</p>
<p>As ever, I wish we had better tooling for using LLMs which didn’t look like chat or autocomplete or “make me a PR.” For example, how nice would it be if every time tests fail, an LLM agent was kicked off with the task of figuring out why, and only notified us if it did before we fixed it?</p>
<p>
    <img src="https://assets.buttondown.email/images/fdf79d45-0e03-4a52-b2d1-6c9c645aa773.png?w=800&amp;fit=max" alt="An image of Clippy, the paperclip with eyes from Microsoft Office, with a speech bubble saying &#39;FYI, your tests are failing because you are taking the HighBits of w1 in w1Encode, but w1 in Verify is already the high bits output of UseHint.&#39;"/>
</p>

<p>For more low-level cryptography <del>bugs</del> implementations, follow me on Bluesky at <a href="https://bsky.app/profile/filippo.abyssdomain.expert">@filippo.abyssdomain.expert</a> or on Mastodon at <a href="https://abyssdomain.expert/@filippo">@filippo@abyssdomain.expert</a>. I promise I almost never post about AI.</p>
<h2 id="the-picture">The picture</h2>
<p>Enjoy the silliest floof. Surely this will help redeem me in the eyes of folks who consider AI less of a tool and more of something to be hated or loved.</p>
<p><img alt="A calico cat lying upside-down on a wooden floor, body curved around a coffee table leg, looking a bit derpy, with a feather toy on a string dangling nearby" src="https://assets.buttondown.email/images/fb8c2eda-1d87-4edb-a8a4-1c80ff9ec36b.jpeg?w=960&amp;fit=max"/></p>
<p>My work is made possible by <a href="https://geomys.org">Geomys</a>, an organization of professional Go maintainers, which is funded by <a href="https://smallstep.com/">Smallstep</a>, <a href="https://www.avalabs.org/">Ava Labs</a>, <a href="https://goteleport.com/">Teleport</a>, <a href="https://tailscale.com/">Tailscale</a>, and <a href="https://sentry.io/">Sentry</a>. Through our retainer contracts they ensure the sustainability and reliability of our open source maintenance work and get a direct line to my expertise and that of the other Geomys maintainers. (Learn more in the <a href="https://words.filippo.io/geomys">Geomys announcement</a>.)
Here are a few words from some of them!</p>
<p>Teleport — For the past five years, attacks and compromises have been shifting from traditional malware and security breaches to identifying and compromising valid user accounts and credentials with social engineering, credential theft, or phishing. <a href="https://goteleport.com/platform/identity/?utm=filippo">Teleport Identity</a> is designed to eliminate weak access patterns through access monitoring, minimize attack surface with access requests, and purge unused permissions via mandatory access reviews.</p>
<p>Ava Labs — We at <a href="https://www.avalabs.org">Ava Labs</a>, maintainer of <a href="https://github.com/ava-labs/avalanchego">AvalancheGo</a> (the most widely used client for interacting with the <a href="https://www.avax.network">Avalanche Network</a>), believe the sustainable maintenance and development of open source cryptographic protocols is critical to the broad adoption of blockchain technology. We are proud to support this necessary and impactful work through our ongoing sponsorship of Filippo and his team.</p>
        </section></div>
  </body>
</html>
