<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.tomoliver.net/posts/using-an-slr-as-a-webcam-nixos">Original</a>
    <h1>How to use your DSLR from 2008 as a webcam in 2022 (NixOS)</h1>
    
    <div id="readability-page-1" class="page"><article><div><div><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272068%27%20height=%271914%27/%3e"/></span><img alt="Canon eos rebel xs being used as a webcam" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></p><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271364%27%20height=%271144%27/%3e"/></span><img alt="Canon eos rebel xs being used as a webcam" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></p></div></div>
<p>This year after largely abandoning my macbook in favour of a nixos machine, I started getting requests to &#34;turn my camera on&#34; when video calling people. This was a problem because I didn&#39;t actually have a webcam. I thought about buying one but then I realised that I had a perfectly good Canon EOS rebel XS DSLR circa 2008 lying around on my shelf. This camera has a mini-USB port, so naturally I pondered: DSLR + mini-USB + desktop PC = possible webcam ?</p>
<p>But there is just one problem. My Canon EOS rebel XS isn&#39;t actually capable of recording video. It can take some nice pictures but that&#39;s about it. So that&#39;s the end of that then.</p>
<p><em>Or is it?</em></p>
<p>There happens to be some amazing open source software called gphoto2.
Once installed it will allow you to control an array of different supported cameras from your computer (find out if yours is supported with <span>gphoto2 --list-cameras</span>). This includes taking photos and videos.
After installing, try taking a picture with it like so:
<span>gphoto2 --capture-image-and-download</span>. You should hear the shutter activate and the image will be saved to your current working directory.</p>
<p>Despite the aforementioned lack of video functionality on my camera, I decided to try <span>gphoto2 --capture-movie</span> anyway. Somehow, although my camera does not support video natively, this tool still manages to spit out an mjpeg file (For my camera I needed to put it in &#34;live-view&#34; mode before gphoto2 could record video. This consisted of putting it on portrait mode and then pressing the &#34;set&#34; button so that the viewfinder is off and the screen is displaying an image). Unfortunately though this is not enough to be able to use it as a webcam. It still needs to get assigned a video device such as <span>/dev/video**</span>.</p>
<h2>How do?</h2>
<p>First of all if you haven&#39;t already, you&#39;re gonna want to grab <span>gphoto2</span> and <span>ffmpeg</span>.</p>
<p>And maybe <span>mpv</span> also.</p>
<div><div><p>NIX</p><pre><p><span><span></span><span>.</span><span>.</span><span>.</span><span></span></span></p><p><span><span>environment</span><span>.</span><span>systemPackages </span><span>=</span><span> </span><span>with</span><span> pkgs</span><span>;</span><span> </span><span>[</span><span></span></span></p><p><span><span>  ffmpeg</span></span></p><p><span><span>  gphoto2</span></span></p><p><span><span>  mpv</span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span></span></p></pre></div></div>
<p>To create the virtual video device we will need to make use of the v4l2 Linux kernel module. It can be installed by adding to the extra module packages in configuration.nix.</p>
<div><div><p>NIX</p><pre><p><span><span></span><span>.</span><span>.</span><span>.</span><span></span></span></p><p><span><span>boot</span><span>.</span><span>extraModulePackages </span><span>=</span><span> </span><span>with</span><span> config</span><span>.</span><span>boot</span><span>.</span><span>kernelPackages</span><span>;</span><span></span></span></p><p><span><span></span><span>[</span><span> v4l2loopback</span><span>.</span><span>out </span><span>]</span><span>;</span><span></span></span></p><p><span><span>boot</span><span>.</span><span>kernelModules </span><span>=</span><span> </span><span>[</span><span></span></span></p><p><span><span>  </span><span>&#34;v4l2loopback&#34;</span><span></span></span></p><p><span><span></span><span>]</span><span>;</span><span></span></span></p><p><span><span>boot</span><span>.</span><span>extraModprobeConfig </span><span>=</span><span> </span><span>&#39;&#39;</span></span></p><p><span><span>  options v4l2loopback exclusive_caps=1 card_label=&#34;Virtual Camera&#34;</span></span></p><p><span><span>&#39;&#39;</span><span>;</span><span></span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span></span></p></pre></div></div>
<p>You will now need to run <span>sudo nixos-rebuild switch</span> and also reboot your computer since we have made some changes to the kernel.</p>
<p>Now try running this command:</p>
<div><div><p>SHELL</p><pre><p><span><span>gphoto2 --stdout --capture-movie </span><span>|</span><span></span></span></p><p><span><span>    ffmpeg -i - -vcodec rawvideo -pix_fmt yuv420p -f v4l2 /dev/video0</span></span></p></pre></div></div>
<p>You should see output like this:</p>
<div><div><pre><p><span><span>ffmpeg version 4.4.1 Copyright (c) 2000-2021 the FFmpeg developers</span></span></p><p><span><span>  built with gcc 11.3.0 (GCC)</span></span></p><p><span><span>  configuration: --disable-static ...</span></span></p><p><span><span>  libavutil      56. 70.100 / 56. 70.100</span></span></p><p><span><span>  libavcodec     58.134.100 / 58.134.100</span></span></p><p><span><span>  libavformat    58. 76.100 / 58. 76.100</span></span></p><p><span><span>  libavdevice    58. 13.100 / 58. 13.100</span></span></p><p><span><span>  libavfilter     7.110.100 /  7.110.100</span></span></p><p><span><span>  libavresample   4.  0.  0 /  4.  0.  0</span></span></p><p><span><span>  libswscale      5.  9.100 /  5.  9.100</span></span></p><p><span><span>  libswresample   3.  9.100 /  3.  9.100</span></span></p><p><span><span>  libpostproc    55.  9.100 / 55.  9.100</span></span></p><p><span><span>Capturing preview frames as movie to &#39;stdout&#39;. Press Ctrl-C to abort.</span></span></p><p><span><span>[mjpeg @ 0x1dd0380] Format mjpeg detected only with low score of 25, misdetection possible!</span></span></p><p><span><span>Input #0, mjpeg, from &#39;pipe:&#39;:</span></span></p><p><span><span>  Duration: N/A, bitrate: N/A</span></span></p><p><span><span>  Stream #0:0: Video: mjpeg (Baseline), yuvj422p(pc, bt470bg/unknown/unknown), 768x512 ...</span></span></p><p><span><span>Stream mapping:</span></span></p><p><span><span>  Stream #0:0 -&gt; #0:0 (mjpeg (native) -&gt; rawvideo (native))</span></span></p><p><span><span>[swscaler @ 0x1e27340] deprecated pixel format used, make sure you did set range correctly</span></span></p><p><span><span>Output #0, video4linux2,v4l2, to &#39;/dev/video0&#39;:</span></span></p><p><span><span>  Metadata:</span></span></p><p><span><span>    encoder         : Lavf58.76.100</span></span></p><p><span><span>  Stream #0:0: Video: rawvideo (I420 / 0x30323449) ...</span></span></p><p><span><span>    Metadata:</span></span></p><p><span><span>      encoder         : Lavc58.134.100 rawvideo</span></span></p><p><span><span>frame=  289 fps= 23 q=-0.0 size=N/A time=00:00:11.56 bitrate=N/A speed=0.907x</span></span></p></pre></div></div>
<p>Now try this command:</p>
<div><div><p>SHELL</p><pre><p><span><span>mpv av://v4l2:/dev/video0 --profile</span><span>=</span><span>low-latency --untimed</span></span></p></pre></div></div>
<p>You should now be able to see the video feed from your webcam.</p>
<div><div><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272200%27%20height=%271650%27/%3e"/></span><img alt="Streaming a live feed from the webcam" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></p><p><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%272200%27%20height=%271650%27/%3e"/></span><img alt="Streaming a live feed from the webcam" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></p></div></div>
<h2>What about starting the webcam automatically?</h2>
<p>It is a bit annoying to have to execute a command every time we want to use our webcam. Luckily there are ways for this command to be automatically run on startup.</p>
<p>I have decided to implement this webcam startup command as a systemd service.</p>
<div><div><div><div width="0"><p><span>1</span></p><p>This line causes the service to be started before you log in</p></div></div></div><div><p>NIX</p><pre><p><span><span># configuration.nix</span><span></span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span><span></span></span></p><p><span><span>  systemd</span><span>.</span><span>services</span><span>.</span><span>webcam </span><span>=</span><span> </span><span>{</span><span></span></span></p><p><span><span>    enable </span><span>=</span><span> </span><span>true</span><span>;</span><span></span></span></p><p><span><span>    script </span><span>=</span><span> </span><span>&#39;&#39;</span></span></p><p><span><span>      </span><span>$</span><span>{</span><span>pkgs</span><span>.</span><span>gphoto2</span><span>}</span><span>/bin/gphoto2 --stdout --capture-movie |</span></span></p><p><span><span>        </span><span>$</span><span>{</span><span>pkgs</span><span>.</span><span>ffmpeg</span><span>}</span><span>/bin/ffmpeg -i - \</span></span></p><p><span><span>            -vcodec rawvideo -pix_fmt yuv420p -f v4l2  /dev/video0</span></span></p><p><span><span>    &#39;&#39;</span><span>;</span><span></span></span></p><p><span><span><span>1</span><span>wantedBy = [ &#34;multi-user.target&#34; ];</span></span></span></p><p><span><span>  </span><span>}</span><span>;</span><span></span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span></span></p></pre></div><div><div><div width="0"><p><span>1</span></p><p>This line causes the service to be started before you log in</p></div></div></div></div>
<p>Now if you do a quick <span>sudo nixos-rebuild switch</span> and reboot your computer you should find that the webcam service is running.</p>
<p>To check for any problems we can use <span>systemctl status webcam</span> which will tell us the last time the service was run as well as log of its last output. Handy for debugging.</p>
<h2>Are we done?</h2>
<p>Its very tempting to stop here.
However considering the current global crises it may be pertinent to wonder whether it is necessary to have the webcam on all the time. It strikes me as sub-optimal for 3 obvious reasons:</p>
<ol>
<li>Its a waste of electricity.</li>
<li>There are privacy concerns associated with this kind of thing.</li>
<li>I have to keep changing the battery (solved by <a href="https://www.amazon.co.uk/F1TP-Adapter-Battery-Coupler-Cameras/dp/B096KQWVTL">this</a>)</li>
</ol>
<p>My camera has a lens cap, so to be honest the second point does not really bother me. I can always put the lens cap on when I am not using the webcam to make sure certain government agencies aren&#39;t being entertained at my expense.
However, leaving a big power hungry DSLR camera on 24/7 certainly is not doing anything for my electricity bill. That&#39;s not to mention the CPU overhead required for decoding the video... which upon measurement with <span>htop</span> looks to be around 10%. Not insignificant especially when considering that I&#39;m not exactly running a podcast here, I don&#39;t have that many video calls in a day.</p>
<p>The ideal scenario:</p>
<ul>
<li>I leave my camera plugged in to my computer all the time but switched <em>off</em></li>
<li>When I want to use the webcam I switch on the camera with its power button</li>
<li>My computer then automatically detects the camera and starts the systemd service</li>
<li>After finishing with the webcam I switch it off again</li>
</ul>
<p>To achieve this we need to make use of a custom udev rule.
A udev rule is something that tells your computer to perform a certain task when it discovers that a device has become available. This could be an external hard drive or even non-usb devices.
In our case we need it to recognise the camera through its usb connection.</p>
<p>We need to specify what command is to be run when the udev rule is triggered.
For that I am creating a derivation (nix package) that simply restarts the systemd service. You could also add logging to this for debugging purposes.</p>
<div><div><div><div width="0"><p><span>1</span></p><p>Convert script to nix derivation.</p></div></div></div><div><p>NIX</p><pre><p><span><span># start-webcam.nix</span><span></span></span></p><p><span><span></span><span>with</span><span> </span><span>import</span><span> </span><span>&lt;</span><span>nixpkgs</span><span>&gt;</span><span> </span><span>{</span><span> </span><span>}</span><span>;</span><span></span></span></p><p><span><span><span>1</span><span>writeShellScriptBin</span></span><span>&#34;start-webcam&#34;</span><span> </span><span>&#39;&#39;</span></span></p><p><span><span>  systemctl restart webcam</span></span></p><p><span><span>  # debugging example</span></span></p><p><span><span>  # echo &#34;hello&#34; &amp;&gt; /home/tom/myfile.txt</span></span></p><p><span><span>  # If myfile.txt gets created then we know the udev rule has triggered properly</span></span></p><p><span><span>&#39;&#39;</span></span></p></pre></div><div><div><div width="0"><p><span>1</span></p><p>Convert script to nix derivation.</p></div></div></div></div>
<p>Now to actually define the udev rule.
First of all we need to find out the device and vendor id of the camera.
This is done using the <span>lsusb</span> command. Since I don&#39;t see myself using this particularly often I will install it temporarily using <span>nix-shell</span>.</p>
<p>This can be done like so: <span>nix-shell -p usbutils</span></p>
<p>Then running <span>lsusb</span> we get the following output:</p>
<div><div><p>SHELL</p><pre><p><span><span>[</span><span>nix-shell:~/environment</span><span>]</span><span>$ lsusb</span></span></p><p><span><span></span><span>..</span><span>.</span></span></p><p><span><span>Bus 002 Device 008: ID 04a9:317b Canon, Inc. Canon Digital Camera</span></span></p><p><span><span></span><span>..</span><span>.</span></span></p></pre></div></div>
<p>We can see from this output that the vendor ID is <span>04a9</span> and the device ID is <span>317b</span>.</p>
<p>We can now create the udev rule.</p>
<div><div><div><div width="0"><p><span>1</span></p><p>Import the derivation we made earlier.</p></div></div></div><div><p>NIX</p><pre><p><span><span># configuration.nix</span><span></span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span><span></span></span></p><p><span><span></span><span>let</span><span></span></span></p><p><span><span>  startWebcam </span><span>=</span><span> </span><span>import</span><span> </span><span><span>1</span><span>./start-webcam.nix;</span></span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span><span></span></span></p><p><span><span>services</span><span>.</span><span>udev</span><span>.</span><span>extraRules </span><span>=</span><span> </span><span>&#39;&#39;</span></span></p><p><span><span>  ACTION==&#34;add&#34;,  \</span></span></p><p><span><span>  SUBSYSTEM==&#34;usb&#34;, \</span></span></p><p><span><span>  ATTR{idVendor}==&#34;04a9&#34;, \</span></span></p><p><span><span>  ATTR{idProduct}==&#34;317b&#34;,  \</span></span></p><p><span><span>  RUN+=&#34;</span><span>$</span><span>{</span><span>startWebcam</span><span>}</span><span>/bin/start-webcam&#34;</span></span></p><p><span><span>&#39;&#39;</span><span>;</span><span></span></span></p><p><span><span></span><span>.</span><span>.</span><span>.</span></span></p></pre></div><div><div><div width="0"><p><span>1</span></p><p>Import the derivation we made earlier.</p></div></div></div></div>
<p>We just need to remove the <span>wantedBy = [ &#34;multi-user.target&#34; ];</span> line in our systemd service. If we leave this in then the service will start automatically when we next reboot whether the camera is switched on or not.</p>
<p>One more <span>sudo nixos-rebuild switch</span> and we are finished!</p>
<p>Thanks for reading this far.
I hope this article has made you think twice before chucking some of your old tech.</p></article></div>
  </body>
</html>
