<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.aawadia.dev/2022/12/20/cats-pi-and-machine-learning/">Original</a>
    <h1>Cats, Pi, and Machine Learning</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
<h2 id="Introduction"><a href="#Introduction" title="Introduction"></a>Introduction</h2><p>There is a cat that wanders around my neighbourhood. I wanted to build something that would notify me whenever it came to my backyard.</p>
<p>I thought to myself, if I can get a picture of my backyard as the input I can process the image by checking if there is a cat in it and send a notification to my phone as the output.</p>
<p>For the picture input, I attached a camera module to a raspberry pi 4. For the processing, I wrote some code that would run on the pi, which would periodically take an image and run object detection on it. For the output, I relied on sending a message via Signal to my phone.</p>
<h2 id="The-hardware"><a href="#The-hardware" title="The hardware"></a>The hardware</h2><p>The raspberry pi 4 has a dedicated slot to connect the camera module. It also has a slot for display output that looks identical to the camera slot. The camera slot is the one that is closer to the USB/Ethernet slots. The board also has the text ‘camera’ and ‘display’ embedded to label the slots. If the camera does not work check to make sure it is not connected to the display port. This image might be helpful to locate the camera slot <a href="https://miro.medium.com/max/1200/1*2xIz14qQgQ81lZlo3XXdrQ.png" target="_blank" rel="noopener">https://miro.medium.com/max/1200/1*2xIz14qQgQ81lZlo3XXdrQ.png</a> . Always power the pi off before connecting or disconnecting the camera module. After connecting the camera your pi should look something like <a href="https://projects-static.raspberrypi.org/projects/getting-started-with-picamera/dbf2d9575be4756f79e4293a047a8a531d340710/en/images/pi-camera-attached.jpg" target="_blank" rel="noopener">https://projects-static.raspberrypi.org/projects/getting-started-with-picamera/dbf2d9575be4756f79e4293a047a8a531d340710/en/images/pi-camera-attached.jpg</a> [the blue side of the ribbon faces the USB port]</p>
<p>Once connected, ssh into the pi and use <code>sudo raspi-config</code> to enable the camera in the interface settings. If <code>raspi-config</code> does not resolve use <code>sudo apt install raspi-config</code> to install it.</p>
<p>How do you check if the camera hardware is hooked up correctly? The command to check that is <code>vcgencmd get_camera</code> if you see <code>detected=1</code> then everything is working - if it returns <code>detected=0</code> the cable is not connected properly to the raspberry pi board.</p>
<h2 id="The-software"><a href="#The-software" title="The software"></a>The software</h2><p>The core loop of the application is to periodically take a picture and perform object detection on it and based on the results send the notification. I added an http server in there as well to see the last picture taken in my browser. All the code was written in kotlin and the pi was running <code>AdoptOpenJDK-16.0.1+9</code> JVM</p>
<h3 id="Taking-an-image"><a href="#Taking-an-image" title="Taking an image"></a>Taking an image</h3><p>To take pictures I used the library <code>https://github.com/Hopding/JRPiCam</code>. It allows taking a picture as a file saved on disk as well as getting the buffered image object purely in memory. I opted for the latter, which doesn’t require periodic cleanup of all the files created. I wanted the camera taking pictures every minute - this would end up creating more than a thousand image files every day.</p>
<p>The camera is surprisingly configurable providing, all kinds of, tuning options such as exposure, brightness, resolution, and rotations/flips to name a few. I didn’t do anything fancy and created a basic camera object</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>val</span> piCamera = RPiCamera(<span>&#34;/home/pi/cats&#34;</span>)</span></pre></td></tr></tbody></table></figure>
<p>The <code>bufferedStill</code> is of type <code>BufferedImage</code>, which is more than just an array of bytes of the frame. I needed to code an adapter that would convert the <code>BufferedImage</code> to a Vert.x <code>Buffer</code> class which could then be easily moved around over the network [for the detection request]</p>
<p>The adapter ended up being only a few lines using <code>javax.imageio.*</code></p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span><span>fun</span> <span>imageToBuffer</span><span>(bufferedImage: <span>BufferedImage</span>)</span></span>: Buffer {</span></pre></td></tr></tbody></table></figure>
<p>That takes care of getting the picture, in a convenient format that we can work with, of the backyard into the application.</p>
<p>To trigger the image capture periodically, I used Vert.x’s <code>setPeriodic</code>. Vert.x will also be used to create the admin/debug http server and the web client that makes the notification and detection requests</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>val</span> vertx = Vertx.vertx()</span></pre></td></tr></tbody></table></figure>
<h3 id="Http-server"><a href="#Http-server" title="Http server"></a>Http server</h3><p>Didn’t go too crazy with the debug http server. One <code>GET</code> endpoint that returns the most recently captured image as the response.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>val</span> router = Router.router(vertx)</span></pre></td></tr></tbody></table></figure>
<h3 id="Object-detection"><a href="#Object-detection" title="Object detection"></a>Object detection</h3><p>To detect whether an image has a cat in it, I used a pre-trained SSD object detection model from Onnx hub. It would take the image as an input and return the class labels with their probabilities of anything detected as the result. The kotlin deep learning library [<a href="https://github.com/Kotlin/kotlindl]" target="_blank" rel="noopener">https://github.com/Kotlin/kotlindl]</a> from Jetbrains came in handy as it provides all the primitives required to achieve object detection based on an input image.</p>
<p>The detection can be done as follows</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>private</span> <span>val</span> modelHub = ONNXModelHub(cacheDirectory = File(<span>&#34;cache/pretrainedModels&#34;</span>))</span></pre></td></tr></tbody></table></figure>
<p>The detection does not happen on the pi itself. The detection model is exposed as an API on my server. The API docs are available <a href="https://blog.aawadia.dev/api">here</a></p>
<p>The gist is that the endpoint takes in an image and returns the detected object as a json response</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span></span></pre></td></tr></tbody></table></figure>
<p>Now we need some code that runs on the Pi, which will take the image coming in from the camera and make the above request to get the detected objects. Once again, we use Vert.x to do that by creating a web client and making a post request</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>val</span> webclient = WebClient.create(vertx)</span></pre></td></tr></tbody></table></figure>
<p>After that, it is parsing the http response and checking if any detected object has the class label <code>cat</code> with probability &gt; <code>0.7</code>. If yes, send out the notification [if something else was detected - send a notification for that as well].</p>
<h3 id="Notification"><a href="#Notification" title="Notification"></a>Notification</h3><p>A while back I deployed signal’s rest api [ <a href="https://github.com/bbernhard/signal-cli-rest-api" target="_blank" rel="noopener">https://github.com/bbernhard/signal-cli-rest-api</a> ] to my server, which is what I used here to send a signal message as a notification when a cat was detected in the captured image. The <code>base64_attachments</code> allows me to put the base64 encoded bytes of the captured image, which will then also be sent as an attachment.</p>
<figure><table><tbody><tr><td><pre><span>1</span></pre></td><td><pre><span><span>val</span> body = JsonObject()</span></pre></td></tr></tbody></table></figure>
<h2 id="Final-result"><a href="#Final-result" title="Final result"></a>Final result</h2><p>I got the image <a href="https://imgur.com/a/vYs1W1L" target="_blank" rel="noopener">https://imgur.com/a/vYs1W1L</a> with the message <code>cat detected with probability 0.954</code> on my phone when the cat came by to visit. Everything worked as expected!</p>
<p>I also added a cooldown to the signal message notification so I wouldn’t continuously get spammed with messages if the cat decided to linger around.</p>
<h2 id="Other-work"><a href="#Other-work" title="Other work"></a>Other work</h2><p>Want to know what reddit is saying about cats? Search across 2.9 million+ comments =&gt; <a href="https://conversations.aawadia.dev/find?query=cats&amp;selectedCategory=all" target="_blank" rel="noopener">https://conversations.aawadia.dev/find?query=cats&amp;selectedCategory=all</a></p>
</div></div>
  </body>
</html>
