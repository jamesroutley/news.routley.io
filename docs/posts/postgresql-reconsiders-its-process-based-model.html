<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/934940/3abb2d4086680b78/">Original</a>
    <h1>PostgreSQL reconsiders its process-based model</h1>
    
    <div id="readability-page-1" class="page"><div>
<!-- $Id: slink-trial,v 1.1 2005-11-04 21:27:01 corbet Exp $ -->
<center>
<table>
<tbody><tr><td>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider accepting the trial offer on the right.  Thank you
for visiting LWN.net!
</p></td><td>
<div>
<h3>Free trial subscription</h3>
           <p>
           Try LWN for free for 1 month: no payment
           or credit card required.  <a href="https://lwn.net/Promo/slink-trial2-3/claim">Activate
           your trial subscription now</a> and see why thousands of
           readers subscribe to LWN.net.
           
</p></div>
</td>
</tr>

</tbody></table>
</center>
<p>
In the fast-moving open-source world, programs can come and go quickly; a
tool that has many users today can easily be eclipsed by something better
next week.  Even in this environment, though, some programs endure for a
long time.  As an example, consider <a href="https://postgresql.org">the
PostgreSQL database system</a>, which <a href="https://www.postgresql.org/docs/current/history.html">traces its
history</a> back to 1986.  Making fundamental changes to a large code base
with that much history is never an easy task.  As fundamental changes go,
moving PostgreSQL away from its process-oriented model is not a small one,
but it is one that the project is considering seriously.
</p><p>
A PostgreSQL instance runs as a large set of cooperating processes,
including one for each connected client.  These processes communicate
through a number of shared-memory regions using an elaborate library that
enables the creation of complex data structures in a setting where not all
processes have the same memory mapped at the same address.  This model has
served the project well for many years, but the world has changed a lot
over the history of this project.  As a result, PostgreSQL developers are
increasingly thinking that it may be time to make a change.
</p><h4>A proposal</h4>
<p>
At the beginning of June, Heikki Linnakangas, seemingly following up on
some in-person conference discussions, posted <a href="https://lwn.net/ml/pgsql-hackers/31cc6df9-53fe-3cd9-af5b-ac0d801163f4@iki.fi/">a
proposal</a> to move PostgreSQL to a threaded model.
</p><blockquote>
	I feel that there is now pretty strong consensus that it would be a
	good thing, more so than before. Lots of work to get there, and
	lots of details to be hashed out, but no objections to the idea at
	a high level.
	<p>
	The purpose of this email is to make that silent consensus explicit.
</p></blockquote>
<p>
The message gave a quick overview of some of the challenges involved in
making such a move, and acknowledged, in an understated way, that this
transition &#34;<q>surely cannot be done fully in one release</q>&#34;.  One thing
that was missing was a discussion of <i>why</i> this big change would be
desirable, but that was filled in as the discussion went on.  As Andres
Freund <a href="https://lwn.net/ml/pgsql-hackers/20230607213721.al3etgcgtija3ytz@awork3.anarazel.de/">put
it</a>:
</p><blockquote>
	I think we&#39;re starting to hit quite a few limits related to the
	process model, particularly on bigger machines. The overhead of
	cross-process context switches is inherently higher than switching
	between threads in the same process - and my suspicion is that that
	overhead will continue to increase. Once you have a significant
	number of connections we end up spending a *lot* of time in TLB
	misses, and that&#39;s inherent to the process model, because you can&#39;t
	share the TLB across processes.
</blockquote>
<p>
He also pointed out that the process model imposes costs on development,
forcing the project to maintain a lot of duplicated code, including several
memory-management mechanisms that would be unneeded in a single address
space.  In <a href="https://lwn.net/ml/pgsql-hackers/20230612192430.kfffuxfh4bzjzgez@awork3.anarazel.de/">a
later message</a> he also added that it would be possible to share state
more efficiently between threads, since they all run within the same
address space.
</p><p>
The reaction of some developers, though, made it clear that the &#34;<q>pretty
strong consensus</q>&#34; cited by Linnakangas might not be quite that strong after
all.  Tom Lane <a href="https://lwn.net/ml/pgsql-hackers/4178104.1685978307@sss.pgh.pa.us/">said</a>: &#34;<q>I
think this will be a disaster.  There is far too much code that will get
broken</q>&#34;.  He <a href="https://lwn.net/ml/pgsql-hackers/268998.1686103322@sss.pgh.pa.us/">added</a> later
that the cost of this change would be &#34;<q>enormous</q>&#34;, it would create
&#34;<q>more than one security-grade bug</q>&#34;, and that the benefits would not
justify the cost.  Jonathan Katz <a href="https://lwn.net/ml/pgsql-hackers/cd27db0c-01ae-ba4d-f141-8712cbb4188c@postgresql.org/">suggested</a>
that there might be other work that should have a higher priority.  Others
worried that losing the isolation provided by separate processes could make
the system less robust overall.
</p><p>
Still, many PostgreSQL developers seem to be cautiously in favor of at
least exploring this change.  Robert Haas <a href="https://lwn.net/ml/pgsql-hackers/CA+TgmoY=hioNYW124e0CZ6Lbo_pVyeMw_rK+9fzzH6Aa85RYgw@mail.gmail.com/">said</a>
that PostgreSQL does not scale well on larger systems, mostly as a result
of the resources consumed by all of those processes.  &#34;<q>Not all databases
have this problem, and PostgreSQL isn&#39;t going to be able to stop having it
without some kind of major architectural change</q>&#34;.  Just switching to
threads might not be enough, he said, but he suggested that this change
would enable a number of other improvements.
</p><h4>How to get there</h4>
<p>
Moving the core of the PostgreSQL server into a single address space will
certainly present a number of challenges.  The biggest one, as <a href="https://lwn.net/ml/pgsql-hackers/CA+TgmoZKrgkd+jEbRRpOYoG14Ue9GLWTH2kKH_Yhac3s6Ofemg@mail.gmail.com/">pointed
out</a> by Haas and others, would appear to be the server&#39;s &#34;<q>widespread
and often gratuitous use of global variables</q>&#34;.  Globals work well
enough when each server process has its own set, but that approach clearly
falls apart when threads are used instead.  <a href="https://lwn.net/ml/pgsql-hackers/86b55b50-a408-1604-1967-b4f87e9d7d0c@garret.ru/">According
to Konstantin Knizhnik</a>, there are about 2,000 such variables currently
used by the PostgreSQL server.
</p><p>
A couple of approaches to this problem were discussed.  One was pulling all
of the global variables into a big &#34;session state&#34; structure that would be
thread-local.  That idea quickly loses its appeal, though, when one
considers trying to create and maintain a 2,000-member structure, so the
project is unlikely to go this way.  The alternative is to simply throw all
of the globals into thread-local storage, an approach that is easy and
would work, but heavy use of thread-local storage would exact a performance
penalty that would reduce the benefits of the switch to threads in the
first place.  Haas said that marking globals specially (to put them into
thread-local storage, among other things) would be a beneficial project
in its own right, as that would be a good first step in reducing their use.
Freund <a href="https://lwn.net/ml/pgsql-hackers/20230607215809.igzd2mkgmaarawb3@awork3.anarazel.de/">agreed</a>,
saying that this effort would pay off even if the switch to threads never
happens.
</p><p>
But, Freund <a href="https://lwn.net/ml/pgsql-hackers/20230608184848.4ejjqjeeicgbnbzb@awork3.anarazel.de/">cautioned</a>,
moving global variables to thread-local storage is the easiest part of the
job:
</p><blockquote>
	 Redesigning postmaster, defining how to deal with extension
	 libraries, extension compatibility, developing tools to make
	 developing a threaded postgres feasible, dealing with freeing
	 session lifetime memory allocations that previously were freed via
	 process exit, making the change realistically reviewable,
	 portability are all much harder.
</blockquote>
<p>
An interesting point that received surprisingly little attention in the
discussion is that Knizhnik <a href="https://lwn.net/ml/pgsql-hackers/4658520e-5cd0-6242-e54c-c3af0a85890a@garret.ru/">has
already done a threads port</a> of PostgreSQL.  The global-variable
problem, he said, was not that difficult.  He had more trouble with
configuration data, error handling, signals, and the like.  Support for
externally maintained extensions will be a challenge.  Still, he saw some
significant benefits in working in the threaded environment.  Anybody who
is thinking about taking on this project would be well advised to look
closely at this work as a first step.
</p><p>
Another complication that the PostgreSQL developers have in mind is that of
supporting both the process-based and thread-based modes, perhaps
indefinitely.  The need to continue to support running in the process-based
mode would make it harder to take advantage of some of the benefits offered
by threads, and would significantly increase the maintenance burden
overall.  Haas, though, <a href="https://lwn.net/ml/pgsql-hackers/CA+TgmoaWMgRf4xv8N7_1XqZyT-KWeD=n0mN2fm4i_Mwmg6oepg@mail.gmail.com/">is
not convinced</a> that it would ever be possible to remove support for the
process-based mode.  Threads might not perform better for all use cases, or
some important extensions may never gain support for running in threads.
The removal of process support is, as he noted, a question that can only
really be considered once threads are working well.
</p><p>
That point is, obviously, a long way into the future, assuming it arrives
at all.  While the outcome of the discussion suggests that most PostgreSQL
developers think that this change is good in the abstract, there are also
clearly concerns about how it would work in practice.  And, perhaps more
importantly, nobody has, yet, stepped up to say that they would be willing
to put in the time to push this effort forward.  Without that crucial
ingredient, there will be no switch to threads in any sort of foreseeable
future.<br clear="all"/></p>
               </div></div>
  </body>
</html>
