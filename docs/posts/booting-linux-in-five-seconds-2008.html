<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/299483/">Original</a>
    <h1>Booting Linux in five seconds (2008)</h1>
    
    <div id="readability-page-1" class="page"><div>
<center>
           <div><b>Benefits for LWN subscribers</b><p>The primary benefit from <a href="https://words.filippo.io/subscribe/">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!</p></div>
           </center>
           
<p>At the Linux Plumbers Conference Thursday,
<a href="http://www.fenrus.org/">Arjan van de
Ven</a>, Linux developer at Intel and author of
PowerTOP, and Auke Kok, another Linux developer at
Intel&#39;s <a href="http://oss.intel.com/en-us/">Open
Source Technology Center</a>, demonstrated a Linux
system booting in five seconds.  The hardware was
an Asus EEE PC, which has solid-state storage,
and the two developers beat the five second
mark with two software loads: one modified <a href="http://fedoraproject.org/">Fedora</a> and one  
modified <a href="http://www.moblin.org/">Moblin</a>.
They had to hold up the EEE PC for the audience,
since the time required to finish booting was less
than the time needed for the projector to sync.</p>

<p>How did they do it?  Arjan said it starts with
the right attitude.  &#34;<q>It&#39;s not about booting faster,
it&#39;s about booting in 5 seconds</q>&#34;.  Instead of saving
a second here and there, set a time budget for the
whole system, and make each step of the boot finish
in its allotted time.  And no cheating.  &#34;<q>Done booting
means CPU and disk idle<q>&#34;, Arjan said.  No fair putting
up the desktop while still starting services behind
the scenes.  (An audience member pointed out that
Microsoft does this.)  The &#34;done booting&#34; time did
not include bringing up the network, but did include
starting NetworkManager.  A system with a conventional
hard disk will have to take longer to start up: Arjan
said he has run the same load on a ThinkPad and achieved
a 10-second boot time.</q></q></p>

<p>Out of the box, Fedora takes
45 seconds from power on to <a href="http://www.gnome.org/projects/gdm/">GDM</a>  
login screen.  A tool called <a href="http://www.bootchart.org/">Bootchart</a>,  
by Ziga Mahkovec, offers some details.  In a
Bootchart graph of the Fedora boot (fig. 1), the
system does some apparently time-wasting things.
It spends a full second starting the loopback
device—checking to see if all the network
interfaces on the system are loopback.  Then there&#39;s
two seconds to start &#34;sendmail.&#34;  &#34;<q>Everybody pays
because someone else wants to run a mail server<q>&#34;,
Arjan said, and suggested that for the common
laptop use case—an SMTP server used only
for outgoing mail—the user can simply run <a href="http://packages.debian.org/stable/mail/ssmtp">ssmtp</a>.</q></q></p>  

<table>
<tbody><tr><td>
<a href="http://lwn.net/Articles/299538/">
<img src="https://static.lwn.net/images/fastboot/fastboot-f1_sm.png" alt="[Fedora bootchart]" width="150" height="249"/>
</a>
</td></tr>
<tr><td>
<b>Figure 1</b>
</td></tr></tbody></table>

<p>Another time-consuming process
on Fedora was &#34;setroubleshootd,&#34; a <a href="http://danwalsh.livejournal.com/7995.html">useful  
tool</a> for finding problems with Security Enhanced
Linux (SELinux) configuration.  It took five seconds.
Fedora was not to blame for everything.  Some upstream
projects had puzzling delays as well.  The X Window
System runs the C preprocessor and compiler on
startup, in order to build its keyboard mappings.</p>

<p>Ubuntu&#39;s boot time is about the same: two
seconds shorter (fig. 2).  It spends 12 seconds running
modprobe running a shell running modprobe, which
ends up loading a single module.  The tool for adding
license-restricted drivers takes 2.5 seconds—on
a system with no restricted drivers needed.
&#34;<q>Everybody else pays for the binary driver<q>&#34;, Arjan
said.  And Ubuntu&#39;s GDM takes another 2.5 seconds of
pure CPU time, to display the background image.</q></q></p>

<table>
<tbody><tr><td>
<a href="http://lwn.net/Articles/299540/">
<img src="https://static.lwn.net/images/fastboot/fastboot-f2_sm.png" alt="[Ubuntu bootchart]" width="150" height="230"/>
</a>
</td></tr>
<tr><td>
<b>Figure 2</b>
</td></tr></tbody></table>

<p>Both distributions use splash screens.  Arjan and
Auke agreed, &#34;<q>We hate splash screens.  By the time
you see it, we want to be done</q>&#34;.  The development
time that distributions spend on splash screens is
much more than the Intel team spent on booting fast
enough not to need one.</p>

<h3>How they did it: the kernel</h3>

<p>Step one was to make the budget.  The kernel
gets one second to start, including all modules.
&#34;Early boot&#34; including init scripts and background
tasks, gets another second.  X gets another second,
and the desktop environment gets two.</p>

<p>The kernel has to be built without initrd, which
takes half a second with nothing in it.  So all
modules required for boot must be built into the
kernel.  &#34;<q>With a handful of modules you cover 95% of
laptops out there<q>&#34;, Arjan said.  He suggested building
an initrd-based image to cover the remaining 5%.</q></q></p>

<p>Some kernel work made it possible to do
asynchronous initialization of some subsystems.
For example, the modified kernel starts the Advanced
Host Controller Interface (AHCI) initialization,
to handle storage, at the same time as the Universal
Host Controller Interface (UHCI), in order to handle
USB (fig.3).  &#34;<q>We can boot the kernel probably in
half a second but we got it down to a second and we
stopped<q>&#34;, Arjan said.  The kernel should be down to
half a second by 2.6.28, thanks to a brand-new fix
in the AHCI support, he added.</q></q></p>

<table>
<tbody><tr><td>
<a href="http://lwn.net/Articles/299542/">
<img src="https://static.lwn.net/images/fastboot/fastboot-f3_sm.png" alt="[Asynchronous hardware
init]" width="250" height="71"/>
</a>
</td></tr>
<tr><td>
<b>Figure 3</b>
</td></tr></tbody></table>

<p>One more kernel change was a small patch to support
readahead.  The kernel now keeps track of which blocks
it has to read at boot, then makes that information
available to userspace when booting is complete.
That enables readahead, which is part of the early
boot process.</p>

<h3>How they did it: readahead and init</h3>

<p>Fedora uses <a href="http://upstart.ubuntu.com/">Upstart</a>  
as a replacement for the historic &#34;init&#34; that
traditionally is the first userspace program to run.
But the Intel team went back to the original init.
The order of tasks that init handles is modified
to do three things at the same time: first, an
&#34;sReadahead&#34; process, to read blocks from
disk so that they&#39;re cached in memory, second,
the critical path: filesystem check, then the <a href="http://www.freedesktop.org/wiki/Software/dbus">D-Bus</a>  
inter-process communication system,
then X, then the desktop.  And the
third set of programs to start is the <a href="http://www.freedesktop.org/wiki/Software/hal">Hardware  
Abstraction Layer (HAL)</a>, then the <a href="http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html">udev</a>  
manager for hot-plugged devices, then networking.
udev is used only to support devices that might
be added later—the system has a persistent,
old-school /dev directory so that boot doesn&#39;t depend
on udev.</p>

<p>The arrangement of tasks helps get efficient use
out of the CPU.  For example, X delays for about
half a second probing for video modes, and that&#39;s
when HAL does its CPU-intensive startup (fig. 4).</p>

<table>
<tbody><tr><td>
<a href="http://lwn.net/Articles/299545/">
<img src="https://static.lwn.net/images/fastboot/fastboot-f4_sm.png" alt="[Parallel tasks]" width="150" height="88"/>
</a>
</td></tr>
<tr><td>
<b>Figure 4</b>
</td></tr></tbody></table>

<p>In a graph of disk and CPU use, both are
at maximum for most of the boot time, thanks
to sReadahead.  When X starts, it never has to
wait to read from disk, since everything it needs
is already in cache.  sReadahead is based on Fedora <a href="http://dailypackage.fedorabook.com/index.php?/archives/59-Wednesday-Why-Readahead.html">Readahead</a>,
but is modified to take advantage of
the kernel&#39;s new list of blocks read.
sReadahead is to be released next week on <a href="http://www.moblin.org/">moblin.org</a>,  
and the kernel patch is intended for mainline as
soon as Arjan can go over it with ext3 filesystem
maintainer Ted Ts&#39;o.  (Ted, in the audience, offered
some suggestions for reordering blocks on disk to
speed boot even further.)</p>

<p>There&#39;s a hard limit of 75MB of reads in order
to boot, set by the maximum transfer speed of the
Flash storage:  3 seconds of I/O at 25MB/s.  So,
&#34;<q>We don&#39;t read the whole file. We read only the
pieces of the file we actually use<q>&#34;, Arjan said.
sReadahead uses the &#34;idle&#34; I/O scheduler, so that if
anything else needs the disk it gets it.  
With readahead turned off, the system boots in seven
seconds, but with readahead, it meets the target of five.</q></q></p>

<p>X is still problematic.  &#34;<q>We had to do a lot
of damage to X<q>&#34;, Arjan said.  Some of the work
involved eliminating the C compiler run by re-using
keyboard mappings, but other work was more temporary.
The current line of X development, though, puts more
of the hardware detection and configuration into the
kernel, which should cut the total startup time.
Since part of the kernel&#39;s time budget is already
spent waiting for hardware to initialize, and it
can initialize more than one thing at a time, it&#39;s
a more efficient use of time to have the kernel
initialize the video hardware at the same time it
does USB and ATA.  X developer Keith Packard, in the
audience and also an Intel employee, offered help.
Setting the video mode in the kernel would not
let the kernel initialize it at the same time as
the rest of the hardware, as shown in figure 3.
The fast-booting system does not use GDM but boots
straight to a user session, running the XFCE desktop
environment.  Instead of GDM, Arjan said later,
a distribution could boot to the desktop session of
the last user, but start the screensaver right away.
If a different user wanted to log in, he or she could
use the screensaver&#39;s &#34;switch user&#34; button.</q></q></p>

<table>
<tbody><tr><td>
<a href="http://lwn.net/Articles/299546/">
<img src="https://static.lwn.net/images/fastboot/fastboot-f5_sm.png" alt="[5 second boot]" width="66" height="230"/>
</a>
</td></tr>
<tr><td>
<b>Figure 5</b>
</td></tr></tbody></table>


<p>In conclusion, Arjan said, &#34;<q>Don&#39;t settle for &#39;make
boot faster.&#39;  It&#39;s the wrong question.  The question
is &#39;make boot fast&#39;</q>&#34;.  And don&#39;t make all users wait
because a few people run a filesystem that requires
a module or sendmail on their laptops.  &#34;<q>Make it
so you only pay the price if you use the feature</q>&#34;.
Distributions shouldn&#39;t have to maintain separate
initrd-based and initrd-free kernel packages, he said
later.  The kernel could try to boot initrd-free,
then fall back if for whatever reason it couldn&#39;t
see /sbin/init, as might happen if it&#39;s missing the
module needed to mount the root filesystem.</p>

<p>PowerTOP spawned a flurry of power-saving hacks
from all areas of the Linux software scene.  The
combination of Bootchart, readahead, and a five-second
target looks likely to set off a friendly boot time
contest among Linux people as well.  At the conference
roundup Friday, speaker Kyle McMartin announced that
both Fedora and Ubuntu have fixed some delays in
their boot process, and there was much applause.</p><p>


FIGURE CREDIT: Arjan van de Ven and Auke Kok, Intel</p></div></div>
  </body>
</html>
