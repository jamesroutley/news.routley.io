<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xcp-ng.org/blog/2023/05/23/new-xen-updates-on-risc-v/">Original</a>
    <h1>New Xen updates on RISC-V</h1>
    
    <div id="readability-page-1" class="page"><div>
              
              <p>In this update, we&#39;re going to explore the recent additions to Xen&#39;s staging. These updates encompass bug fixes, initialization/checks, and enhancements to RISC-V smoke testing. You can view our initial report at the following location:</p><figure><a href="https://xcp-ng.org/blog/2023/02/07/current-xen-risc-v-support-status/"><div><p>Current Xen RISC-V support status</p><p>Take a look at our current progress on our RISC-V port to the Xen Project.</p><p><img src="https://xcp-ng.org/blog/content/images/size/w256h256/2022/09/SVG-_XCPNG---Badge.png" alt=""/><span>Oleksii Kurochko</span></p></div><p><img src="https://xcp-ng.org/blog/content/images/2023/02/riscvdc.jpg" alt=""/></p></a></figure><p><strong>Since then, all blockers have been merged</strong>. Let&#39;s dive into the highlights now.</p><div><p>ü•≥</p><p><strong>Spoiler alert</strong>: we also managed to boot our first Dom0 on top of a RISC-V architecture while using clean and mergeable code!</p></div><h3 id="smoke-tests">Smoke tests</h3><p>Big ups to Andrew C. for making RISC-V smoke testing a whole lot easier. His patch has now made it so that updating the RISC-V smoke test after rolling out each new feature isn&#39;t needed anymore. Before this change came along, we had to tweak the string in the RISC-V smoke test every single time, just to ensure we hadn&#39;t messed up anything in the RISC-V build.</p><div><p>‚òùÔ∏è</p><p><strong>What is <a href="https://en.wikipedia.org/wiki/Smoke_testing_(software)?ref=xcp-ng.org">smoke testing</a>?</strong> It&#39;s a preliminary testing to reveal simple failures severe enough to, for example, reject a prospective software release. It&#39;s very useful and used in the Xen Project to avoid breaking code being merged.</p></div><h3 id="initialization-and-checks">Initialization and checks</h3><p>We managed to add the <code>.bss</code> <a href="https://gitlab.com/xen-project/xen/-/commit/cfa0409f7cbb674c160b92335e9345e7e051dc1e?ref=xcp-ng.org">section initialization</a>. <code>.bss</code> is a section of an executable that contains declared variables but not assigned. Following this, reading and saving of hart (CPU) id and DTB passed by a bootloader <a href="https://gitlab.com/xen-project/xen/-/commit/537ed7a41b83290fe5afecc389d03ff4e8573324?ref=xcp-ng.org">was also merged</a>. As a part of the patch, the <code>start_xen()</code> function prototype was updated. It started to receive the boot CPU id and an address of DTB.</p><p>Also, <a href="https://gitlab.com/xen-project/xen/-/commit/d1e67674591c262e7cedfcd42547a3f64caec251?ref=xcp-ng.org">FPU was disabled</a> to detect illegal usage of floating points in kernel space.</p><p>Then, Andrew C. (again!) <a href="https://gitlab.com/xen-project/xen/-/commit/44843cee3d2b8daa09e5860fc4574219b57acde8?ref=xcp-ng.org">provided linker assertions</a> to check the safety of the zeroing loops for <code>.bss</code> section. In short, the linker assertion is a mechanism to check if all is fine with a binary/exectable during linkage stage of compilation.</p><p>Another <a href="https://gitlab.com/xen-project/xen/-/commit/c57cd4d45c4e54b3906171499258dbd3556855d4?ref=xcp-ng.org">recent update</a> saw the merging of a new patch designed to maintain all addresses of <code>cpu0_boot_stack</code> (among others) as Program Counter (PC)-relative. This change is beneficial in situations where a binary needs to be relocated. Under such circumstances, we wouldn&#39;t need to alter the address of a variable, such as <code>cpu0_boot_stack</code>; we would still be able to access the variable without causing any faults. The issue originated from the pseudo instruction <code>la</code>, which can be transformed to either <code>auipc/addi</code> or <code>auipc/l{w|d}</code>, depending on the <code>.option</code> directive: <code>nopic</code> and <code>pic</code>, or compiler flags. Before the introduction of the patch, <code>la</code> would transform to <code>auipc/l{w|d}</code>. In the case of <code>cpu0_boot_stack[]</code>, this would result in the usage of <code>GLOBAL_OFFSET_TABLE</code>, where all addresses would be without taking into account the possibility that the linker address might differ from the load address (meaning that addresses inside got sections will be relative to linker time).</p><p>As a result of the previous patch and to be sure that <code>.got</code> section won&#39;t be used explicit check that <code>.got{.plt}</code> <a href="https://gitlab.com/xen-project/xen/-/commit/3146c0f10140e23594c8185568f887111e504977?ref=xcp-ng.org">section is empty was added</a>.</p><figure><img src="https://xcp-ng.org/blog/content/images/2023/05/riscvimg.svg" alt="" loading="lazy"/></figure><h3 id="bug-macro">BUG() macro</h3><p>Since the last update, the most significant feature that has been integrated is a generic implementation of <code>BUG()</code> and its associated macros (originating from <code>bug.h</code>). Within Xen&#39;s code base, a substantial portion of <code>bug.h</code>&#39;s content is replicated across all architectures. Consequently, it was determined that a new configuration, <code>CONFIG_GENERIC_BUG_FRAME</code>, should be established. The base version of <code>bug.h</code> from x86 was adopted as the foundation. You can access these four commits in these locations: <a href="https://gitlab.com/xen-project/xen/-/commit/60a9b07150558b212918aa8fedd532be246b03d7?ref=xcp-ng.org">1</a>, <a href="https://gitlab.com/xen-project/xen/-/commit/faafb5cb736db67a5790854c63bf3c76dd4df7e0?ref=xcp-ng.org">2</a>, <a href="https://gitlab.com/xen-project/xen/-/commit/71efa7b868e64d29b2a0488e015e80798f1fde8a?ref=xcp-ng.org">3</a> and <a href="https://gitlab.com/xen-project/xen/-/commit/720ebfbad3e3bee8aa18e37e08ef597f493f8bf8?ref=xcp-ng.org">4</a>.</p><p>While the generic implementation hasn&#39;t been utilized for RISC-V yet, it is slated for use as soon as the integration of basic exception handling takes place. Up until now, only the x86 has transitioned to this generic implementation, whereas Arm is due for the switch after some further testing is done.</p><p><strong>This further demonstrates that the development of a new CPU architecture aids in streamlining the entire code base, thereby making it cleaner!</strong></p><h3 id="finding-bugs-and-helping-arm-arch">Finding bugs and helping Arm arch</h3><p>During the development of the <a href="https://gitlab.com/xen-project/xen/-/commit/380a8c0c65bfb84dab54ab4641cca1387cc41edb?ref=xcp-ng.org">generic bug functionality</a>, an alignment issue was discovered with Arm&#39;s *(<code>.proc.info</code>) section. Entries in this section are expected to conform to a 4-byte alignment, and the compiler will interact with them using 4-byte load instructions. With Arm32, the processor stringently enforces this alignment; any deviations can lead to a data abort. Unfortunately, the current linker script doesn&#39;t specify this alignment requirement, meaning we are dependent on the compiler/linker&#39;s ability to appropriately pad the preceding sections. This issue was detected during attempts to utilize the forthcoming generic bug infrastructure in conjunction with the compiler provided by Yocto.</p><h3 id="mmu-and-exceptions">MMU and exceptions</h3><p>Aspects relating to the Memory Management Unit (MMU) and basic exception handling are currently undergoing code review. This is the next element that is set to be prepared and integrated into Xen&#39;s staging branch. You can track the ongoing discussion on the Xen mailing list by searching for the following topics:</p><ul><li>Enable MMU for RISC-V</li><li>RISC-V basic exception handling implementation</li></ul><p>As you can observe, significant progress is being made across numerous subjects!</p><figure><img src="https://xcp-ng.org/blog/content/images/2023/05/xen_project_logo_dualcolor_384x160.png" alt="" loading="lazy" width="384" height="160"/></figure><h3 id="booting-a-dom0">Booting a Dom0</h3><p>The other big progress is the <strong>ability to now boot a Dom0 with clean code</strong> that could be merged upstream soon, without any conflict. This project is still ongoing, but it&#39;s a clear indication that we&#39;re making rapid strides! You can find the most recent updates (in the latest branch) in the following location:</p><figure><a href="https://gitlab.com/xen-project/people/olkur/xen/-/tree/latest?ref_type=heads&amp;ref=xcp-ng.org"><div><p>Files ¬∑ latest ¬∑ xen-project / people / olkur / xen ¬∑ GitLab</p><p>Mirror of the Xen Repository (PRs not accepted see: http://wiki.xenproject.org/wiki/Submitting_Xen_Project_Patches)</p><p><img src="https://gitlab.com/assets/favicon-72a2cad5025aa931d6ea56c3201d1f18e68a8cd39788c7c80d5b2b82aa5143ef.png" alt=""/><span>GitLab</span></p></div><p><img src="https://gitlab.com/assets/twitter_card-570ddb06edf56a2312253c5872489847a0f385112ddbcd71ccfa1570febab5d2.jpg" alt=""/></p></a></figure><p>If you want to test it yourself, you can do the following command to build Xen:</p><pre><code>CONTAINER=riscv64 ./automation/scripts/containerize make XEN_TARGET_ARCH=riscv64 -C xen build V=1</code></pre><p>And then to run it, you need to use Qemu this way:</p><pre><code>qemu-system-riscv64 -M virt -smp 1 -nographic -m 2g -kernel xen/xen -device &#39;guest-loader,kernel=&lt;path/linux&gt;/arch/riscv/boot/Image.gz,addr=0x80400000,bootargs=rw root=/dev/ram console=hvc0 keep_bootcon bootmem_debug debug&#34;</code></pre><p>That wraps up today&#39;s update. Thank you for your time and interest in reading this piece. I hope you found it enlightening and useful. Be sure to stay connected for more thrilling updates and insights in the future.</p>
                <section>
                  
                  <ul>
                      <li>
                        <a href="https://xcp-ng.org/blog/tag/devblog/" title="Devblog">Devblog</a>
                      </li>
                      <li>
                        <a href="https://xcp-ng.org/blog/tag/xen/" title="Xen">Xen</a>
                      </li>
                  </ul>
                </section>
            </div></div>
  </body>
</html>
