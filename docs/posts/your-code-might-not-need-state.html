<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.onsclom.net/posts/simulator-state">Original</a>
    <h1>Your Code Might Not Need State</h1>
    
    <div id="readability-page-1" class="page"><div>
      <p>The bouncing DVD logo is a fun and easy coding project. Watching Daniel Shiffman code it in p5.js is one of my earliest programming memories. However, the naive solution is far from optimal.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0j86zuqqTlQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
<p>If you haven’t already made this DVD bouncing logo, give a try! Really, take a break from reading and come back. We are going to go over the naive implementation, and I don’t want to spoil it.</p>
<p>Okay, welcome back! You probably wrote code that works very similar to Daniel’s. You need to track the logo’s <code>x</code>, <code>y</code>, <code>dx</code>, and <code>dy</code>. If the logo hits a side wall you flip its <code>dx</code>, and if it hits the ceiling or floor you flip the <code>dy</code>. This totally works! Doing this in TypeScript it might look like:</p>
<pre is:raw=""><code><span><span>const</span><span> </span><span>dvdLogo</span><span> </span><span>=</span><span> document.</span><span>getElementById</span><span>(</span><span>&#34;dvd-logo&#34;</span><span>) </span><span>as</span><span> </span><span>HTMLDivElement</span></span>
<span><span>let</span><span> x </span><span>=</span><span> </span><span>0</span></span>
<span><span>let</span><span> y </span><span>=</span><span> </span><span>0</span></span>
<span><span>let</span><span> dx </span><span>=</span><span> </span><span>1</span></span>
<span><span>let</span><span> dy </span><span>=</span><span> </span><span>1</span></span>
<span></span>
<span><span>function</span><span> </span><span>update</span><span>() {</span></span>
<span><span>  x </span><span>+=</span><span> dx</span></span>
<span><span>  y </span><span>+=</span><span> dy</span></span>
<span><span>  dvdLogo.style.left </span><span>=</span><span> x </span><span>+</span><span> </span><span>&#34;px&#34;</span></span>
<span><span>  dvdLogo.style.top </span><span>=</span><span> y </span><span>+</span><span> </span><span>&#34;px&#34;</span></span>
<span><span>  </span><span>if</span><span> (x </span><span>&lt;</span><span> </span><span>0</span><span> </span><span>||</span><span> x </span><span>+</span><span> dvdLogo.clientWidth </span><span>&gt;</span><span> window.innerWidth) </span></span>
<span><span>    dx </span><span>*=</span><span> </span><span>-</span><span>1</span></span>
<span><span>  </span><span>if</span><span> (y </span><span>&lt;</span><span> </span><span>0</span><span> </span><span>||</span><span> y </span><span>+</span><span> dvdLogo.clientHeight </span><span>&gt;</span><span> window.innerHeight) </span></span>
<span><span>    dy </span><span>*=</span><span> </span><span>-</span><span>1</span></span>
<span><span>}</span></span>
<span></span>
<span><span>(</span><span>function</span><span> </span><span>loop</span><span>() {</span></span>
<span><span>  </span><span>update</span><span>()</span></span>
<span><span>  </span><span>requestAnimationFrame</span><span>(loop)</span></span>
<span><span>})()</span></span></code></pre>
<p>But there’s actually a totally different way to do this. First, let’s define some things.</p>
<ul>
<li>
<p><strong>Animation</strong>: takes time as a parameter and returns an image.</p>
</li>
<li>
<p><strong>Simulation</strong>: takes some <code>state</code> then returns updated <code>state</code> and image.</p>
</li>
</ul>
<p>These types can be defined in TypeScript.</p>
<pre is:raw=""><code><span><span>type</span><span> </span><span>Animation</span><span> </span><span>=</span><span> (</span><span>time</span><span>:</span><span> </span><span>number</span><span>) </span><span>=&gt;</span><span> </span><span>Image</span></span>
<span></span>
<span><span>type</span><span> </span><span>Simulation</span><span> </span><span>=</span><span> &lt;</span><span>T</span><span>&gt;(</span><span>state</span><span>:</span><span> </span><span>T</span><span>) </span><span>=&gt;</span><span> { </span><span>state</span><span>:</span><span> </span><span>T</span><span>, </span><span>image</span><span>:</span><span> </span><span>Image</span><span> }</span></span></code></pre>
<p><small>(If you don’t understand these types it’s OK)</small></p>
<p>Our naive DVD logo implementation would be a <code>Simulation</code>. Ok… maybe it doesn’t fit the exact type definition. We aren’t doing pure functional programming. But the essence is the same. We read state (<code>x</code>, <code>y</code>, <code>dx</code>, <code>dy</code>), compute new state, and render (update the position).</p>
<p>Would it be possible to describe the bouncing DVD logo as an <code>Animation</code>? Can we actually eliminate the need for state? Think about this for a while.</p>
<p>If you’re like me, at first, this sounds impossible. We would need to come up with some advanced formula to account for collisions and calculate the position of our logo for any given time.</p>
<p>But, it’s really not too complex. Let’s simplify things by thinking about one dimension.</p>
<pre is:raw=""><code><span><span>function</span><span> </span><span>update</span><span>(</span><span>time</span><span>:</span><span> </span><span>number</span><span>) {</span></span>
<span><span>  </span><span>const</span><span> </span><span>xRange</span><span> </span><span>=</span><span> window.innerWidth </span><span>-</span><span> dvdLogo.clientWidth</span></span>
<span><span>  </span><span>const</span><span> </span><span>x</span><span> </span><span>=</span><span> (time) </span><span>%</span><span> (xRange </span><span>*</span><span> </span><span>2</span><span>)</span></span>
<span><span>  dvdLogo.style.left </span><span>=</span><span> </span><span>`${</span><span>x</span><span> </span><span>&lt;=</span><span> </span><span>xRange</span><span> </span><span>?</span><span> </span><span>x</span><span> </span><span>:</span><span> </span><span>xRange</span><span> </span><span>*</span><span> </span><span>2</span><span> </span><span>-</span><span> </span><span>x</span><span>}px`</span></span>
<span><span>}</span></span></code></pre>
<p>A little math goes a long way! Isn’t that cool? You can probably guess how to calculate the <code>y</code> position now. Here’s the full solution.</p>
<pre is:raw=""><code><span><span>const</span><span> </span><span>dvdLogo</span><span> </span><span>=</span><span> document.</span><span>getElementById</span><span>(</span><span>&#34;dvd-logo&#34;</span><span>) </span><span>as</span><span> </span><span>HTMLDivElement</span></span>
<span></span>
<span><span>function</span><span> </span><span>update</span><span>(</span><span>time</span><span>:</span><span> </span><span>number</span><span>) {</span></span>
<span><span>  </span><span>const</span><span> </span><span>xRange</span><span> </span><span>=</span><span> window.innerWidth </span><span>-</span><span> dvdLogo.clientWidth</span></span>
<span><span>  </span><span>const</span><span> </span><span>yRange</span><span> </span><span>=</span><span> window.innerHeight </span><span>-</span><span> dvdLogo.clientHeight</span></span>
<span><span>  </span><span>const</span><span> </span><span>x</span><span> </span><span>=</span><span> (time) </span><span>%</span><span> (xRange </span><span>*</span><span> </span><span>2</span><span>)</span></span>
<span><span>  </span><span>const</span><span> </span><span>y</span><span> </span><span>=</span><span> (time) </span><span>%</span><span> (yRange </span><span>*</span><span> </span><span>2</span><span>)</span></span>
<span><span>  dvdLogo.style.left </span><span>=</span><span> </span><span>`${</span><span>x</span><span> </span><span>&lt;=</span><span> </span><span>xRange</span><span> </span><span>?</span><span> </span><span>x</span><span> </span><span>:</span><span> </span><span>xRange</span><span> </span><span>*</span><span> </span><span>2</span><span> </span><span>-</span><span> </span><span>x</span><span>}px`</span></span>
<span><span>  dvdLogo.style.top </span><span>=</span><span> </span><span>`${</span><span>y</span><span> </span><span>&lt;=</span><span> </span><span>yRange</span><span> </span><span>?</span><span> </span><span>y</span><span> </span><span>:</span><span> </span><span>yRange</span><span> </span><span>*</span><span> </span><span>2</span><span> </span><span>-</span><span> </span><span>y</span><span>}px`</span></span>
<span><span>}</span></span>
<span></span>
<span><span>(</span><span>function</span><span> </span><span>loop</span><span>() {</span></span>
<span><span>  </span><span>update</span><span>(Date.</span><span>now</span><span>()</span><span>/</span><span>10</span><span>)</span></span>
<span><span>  </span><span>requestAnimationFrame</span><span>(loop)</span></span>
<span><span>})()</span></span></code></pre>
<p>We converted our previous <code>Simulation</code> into an <code>Animation</code>. Instead of maintaing state, we calculate positions using just <code>time</code>. Not only did we make the code simpler, but we also made the code function better!</p>
<p>How? Well, there were actually a couple of problems with our previous code:</p>
<ol>
<li>
<p>The <code>Simulation</code> solution is framerate dependent. The DVD would move faster with higher framerates. The <code>Animation</code> solution is framerate independent.</p>
</li>
<li>
<p>The <code>Simulation</code> actually has a bug. If you resize the window to be smaller you can trap the DVD logo on an edge. Resizing the window in the <code>Animation</code> solution means we recalculate to the correct position.</p>
</li>
</ol>
<p>In addition to all this, <code>Animations</code> have a lot of benefits over <code>Simulations</code>. They are easier to test, easier to rewind or fast forward, and it’s possible to instantly get the result for any point in time.</p>
<p>But wait, we can take this DVD example further! The DVD logo changes color every time it hits a wall. Surely we need state for that, right?</p>
<p>Actually, it’s possible to calculate the amount of bounces that happened since <code>time</code> equalled 0.</p>
<pre is:raw=""><code><span><span>const</span><span> </span><span>bounces</span><span> </span><span>=</span><span> Math.</span><span>floor</span><span>(time </span><span>/</span><span> xRange) </span><span>+</span><span> Math.</span><span>floor</span><span>(time </span><span>/</span><span> yRange)</span></span></code></pre>
<p>And we can use that to choose a color.</p>
<pre is:raw=""><code><span><span>const</span><span> </span><span>colors</span><span> </span><span>=</span><span> [</span><span>&#34;red&#34;</span><span>, </span><span>&#34;green&#34;</span><span>, </span><span>&#34;blue&#34;</span><span>, </span><span>&#34;yellow&#34;</span><span>]</span></span>
<span><span>dvdLogo.style.backgroundColor </span><span>=</span><span> colors[bounces </span><span>%</span><span> colors.</span><span>length</span><span>]</span><span>!</span></span></code></pre>
<p>Isn’t that cool?! Or maybe you think we’ve been getting really lucky with these examples. Maybe you remembered something tricky. The actual DVD logo picks a color randomly. You probably think this is where we are finally stumped.</p>
<p>Well, with a seeded random function this is possible too!</p>
<pre is:raw=""><code><span><span>const</span><span> </span><span>random</span><span> </span><span>=</span><span> (</span><span>seed</span><span>:</span><span> </span><span>number</span><span>) </span><span>=&gt;</span><span> Math.</span><span>sin</span><span>(seed </span><span>*</span><span> </span><span>1000</span><span>) </span><span>*</span><span> </span><span>0.5</span><span> </span><span>+</span><span> </span><span>0.5</span></span>
<span><span>const</span><span> </span><span>randIndex</span><span> </span><span>=</span><span> Math.</span><span>floor</span><span>(</span><span>random</span><span>(bounces) </span><span>*</span><span> colors.</span><span>length</span><span>)</span></span>
<span><span>dvdLogo.style.backgroundColor </span><span>=</span><span> colors[randIndex]</span><span>!</span></span></code></pre>
<p>Ok, well, maybe this isn’t the best random function. I’m getting a bit lazy now. But I’m sure you get the idea.</p>
<p>Try out the <a href="https://www.onsclom.net/dvd-logo">live demo</a>! Try refreshing the page. The DVD logo <em>magically</em> remembers its state!</p>
<p>Next time you find yourself rushing to use state, try spending some more time at the whiteboard. Not only will it make your code simpler, but it also might make it better.</p>
      
    </div></div>
  </body>
</html>
