<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://qorg11.net/tech_posts/freebsd_as_desktop.html">Original</a>
    <h1>Fear and Loathing in FreeBSD</h1>
    
    <div id="readability-page-1" class="page"><div id="content">


<div id="outline-container-org20f8a33">
<h2 id="org20f8a33">Fear and loathing in FreeBSD, or qorg’s experiences with FreeBSD</h2>

<div id="outline-container-org97e8087">
<h3 id="org97e8087">Introduction</h3>
<div id="text-org97e8087">
<p>
Not so long ago I wrote <a href="https://qorg11.net/openbsd.xhtml">my experiences with OpenBSD</a>. This post was
about my experiences with OpenBSD but as a server, not as
desktop. Using an operating system as a desktop is completely
different than using it as a server.
</p>

<p>
One day I thought “damn, Linux sucks! But I have to use this because
the developer of the browser that I use is an asshole!”. And had to
stick to Linux for a while. But then another day I thought “Hmm,
FreeBSD claims to run Linux binaries better than Linux, let’s give it
a try”. Good operating systems have to sell themselves some
way. And that claim worked for me. So I went to FreeBSD.org, clicked
the big yellow button that says “Download FreeBSD” and downloaded the
memstick image for amd64 because that’s what my computer runs.
</p>

<p>
I will be updating this site as I have more experiences with
FreeBSD. So add to bookmarks!
</p>

<p>
Last update: 2022-06-21
</p>
</div>
</div>

<div id="outline-container-org2ef4912">
<h3 id="org2ef4912">Installation</h3>
<p>
The installation was pretty straight forward. I don’t think many
people can get lost in this. I just selected ZFS as my file system
(more on that later). And I don’t remember much other things in the
installation. And as I forgot them. I don’t think they are very worth
mentioning.
</p>
</div>

<div id="outline-container-orgdecf4b0">
<h3 id="orgdecf4b0">Networking</h3>
<div id="text-orgdecf4b0">
<p>
Sadly I no longer have the router in my room so I can’t use an
ethernet cable. So I have to use the dreaded wireless card. I was very
surprised when I find out this Atheros card is supported by FreeBSD so
I don’t have to open the computer and put an Intel one. For the
network card to work, I only had to modify the kernel booting
process. Sounds very hard but it is just editing
<code>/boot/loader.conf/)</code>. I added the following lines to use the <code>ath</code>
driver:
</p>

<div>
<pre><span>if_ath_load</span>=<span>&#34;YES&#34;</span>                                                    
<span>if_ath_pci_load</span>=<span>&#34;YES&#34;</span>
</pre>
</div>

<p>
Then, in <code>/etc/rc.conf</code> (we will talk about it later)
</p>

<div>
<pre><span>wlans_ath0</span>=<span>&#34;wlan0&#34;</span>
<span>ifconfig_wlan0</span>=<span>&#34;up&#34;</span>
</pre>
</div>

<p>
And then, i can just create a wpa_supplicant config file that works
for my router, and run <code># wpa_supplicant -iwlan0 -c
/etc/wpa_supplicant.conf -B</code>. And then call <code>dhclient</code> so I get an IP
address. But I guess I should use a static IP address so I don’t have
to call dhclient everytime I boot up my computer. But I don’t get that
to work.
</p>
</div>
</div>

<div id="outline-container-org754c98f">
<h3 id="org754c98f">Making the fresh installed system a desktop.</h3>
<div id="text-org754c98f">
<p>
I’m no longer a Linux user. Now I am a BSD user. As such I must be
aware about this “X11” thing. So I had to install the <code>xorg</code>
package. FreeBSD comes with a binary package manager called <code>pkg</code>. We
will talk more about this in the packages section. I just had to run
<code># pkg install xorg</code>. Add the user <code>qorg</code> to the <code>video</code> group and
configure my <code>.xinitrc</code> so everytime i run <code>startx</code>, <code>bspwm</code> is
started.
</p>

<p>
I had to add i915kms_load=“YES” to =/boot/loader.conf). Which is the
driver for Intel integrated graphics cards. Or something like that.
</p>

<p>
As mentioned before. I had to modify my .xinitrc (something that as a
former Linux user I have never done because I always used lxdm as
display manager. But as FreeBSD doesn’t have lxdm available I had to
get alternatives). My .xinitrc looks like this:
</p>

<div>
<pre>dunst&amp;
xrdb .Xdefaults&amp;
compton&amp;
xset r rate 300 50&amp;
feh --bg-fill ~/.wall.png 
sxhkd
<span>exec</span> bspwm
</pre>
</div>

<p>
With that <code>.xinitrc</code>, running <code>startx</code> just works.
</p>
</div>
</div>

<div id="outline-container-org87fb8c6">
<h3 id="org87fb8c6">Package management</h3>
<p>
FreeBSD comes with 2 options to install packages: binary-based
packages and port-based packages which installs packages compiling
them from source code.
</p>

<div id="outline-container-org79dbfba">
<h4 id="org79dbfba">Binary package management</h4>
<div id="text-org79dbfba">
<p>
I installed an operating system because I wanted to use it. And it is
impossible to use an operating system if you cannot install software
in it. Fortunately, FreeBSD comes with a package manager called <code>pkg</code>,
a very original name for a package manager. It is very simple to use,
and very fast. I would say it is faster, or at least as fast as
<code>xbps</code>, the fastest package manager I know. Using it is very simple,
here a few examples:
</p>

<div>
<pre><span># </span><span>All these commands must be run as root.</span>

<span># </span><span>Install the package &#34;emacs&#34;</span>
pkg install emacs
<span># </span><span>Deinstall the package &#34;emacs&#34;</span>
pkg remove emacs
<span># </span><span>Remove all the unneeded dependencies</span>
pkg autoremove
<span># </span><span>List all packages that contain &#34;edit&#34; in its name</span>
pkg search edit
<span># </span><span>List all packages that contain &#34;editor&#34; in its comment</span>
pkg search -S comment editor
</pre>
</div>

<p>
Unfortunately, <code>pkg</code> comes with very insane defaults. You have to type
’y’ and then ’enter’ to confirm you want to install a package. As
<code>pkg</code> defaults to “No”. I guess this is a security feature for some
users. But as I’m too lazy to press the ’Y’ key, and I’d rather just
to press enter, I edited <code>/usr/local/etc/pkg.conf</code> and added the
following content:
</p>

<div>
<pre><span># </span><span>I don&#39;t want to press &#39;Y&#39; everytime.</span>
<span>DEFAULT_ALWAYS_YES</span>=yes
<span>AUTOCLEAN</span>=yes
<span>IP_VERSION</span>=4
<span># </span><span>I don&#39;t want to wait to upgrade a package. I&#39;ll update my system</span>
<span># </span><span>only when I want :)</span>
<span>REPO_AUTOUPDATE</span>=no
</pre>
</div>
</div>
</div>

<div id="outline-container-org185e416">
<h4 id="org185e416">Source package management</h4>
<div id="text-org185e416">
<p>
Sadly I can’t talk a lot about this one because I have a very
overheated machine and if I compiled something in this computer we
would have the biggest destruction known to civilized man since 476
A.D.
</p>

<p>
But I can compile small software without a lot of problem.
</p>

<p>
First you have to get the port collection if you didn’t do it in the
installer with the following command:
</p>

<p>
<code># portsnap fetch extract</code>
</p>

<p>
Which will, fetch the port collection and extract them in
<code>/usr/ports</code>. These ports are just a collection of Makefiles. Which
will download and build the source code from you. These makefiles are
very easy to work with, and also to write. As i’m the maintainer for
some FreeBSD packages :)
</p>

<p>
You can also configure which CFLAGS you want <b>by default</b>. Just edit
the <code>/etc/make.conf</code> file. Mine looks like this:
</p>

<div>
<pre><span>CFLAGS+</span>= -O2 -pipe -march=native -mtune=native
<span>DEVELOPER</span>=yes
<span>MAKE_JOBS_UNSAFE</span>=yes
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc85a92d">
<h3 id="orgc85a92d">Linux emulation</h3>
<div id="text-orgc85a92d">
<p>
As I mentioned before, what was keeping me at the Linux hell was the
Web Browser known as Pale Moon. I followed <a href="https://docs.freebsd.org/en/books/handbook/linuxemu/">the guide</a> to run Linux
software in FreeBSD. Downloaded Pale Moon, and after installing a few
dependencies, yup, it worked just like if I was using it in Linux.
</p>

<p>
Then I <code>rm -rf palemoon</code> and moved to firefox. Don’t really know why.
</p>
</div>
</div>
<div id="outline-container-org40b45bc">
<h3 id="org40b45bc">Multimedia</h3>
<div id="text-org40b45bc">
<p>
This was kind of a pain, <code>oss</code> didn’t want to work for undisclosed
reasons. Too lazy to install sndio. So I went the easy way and just
installed pulseaudio. Call me what you will. But I want to listen to
Madvillain, not say “I DON’T USE PULSEAUDIO” in the internet. I use
<code>cmus</code> as my music player. The binary distribution of cmus comes with
the PulseAudio plugin disabled so I had to install it from the ports
system.
</p>

<p>
mpv and audio in FireFox just worked.
</p>
</div>
</div>
<div id="outline-container-org5c952bc">
<h3 id="org5c952bc">ZFS</h3>
<p>
After years of using UFS, it was time for a change. ZFS was
introdouced experimentally in FreeBSD 7. And in the latest version, it
is the default filesystem. This filesystem is, described by itself as
“The last word in file system” That makes sense to me. They are not
going to say it’s a bad filesystem if they want people to use it. And
if i’m using a filesystem that takes most of my RAM, it should be good
at least. And, yes, ZFS is good.
</p>
<div id="outline-container-org9507550">
<h4 id="org9507550">Pools and storage</h4>
<div id="text-org9507550">
<p>
“A storage pool is the most basic building block of ZFS. A pool
consists of one or more vdevs, the underlying devices that store the
data.”. I don’t understand any of that. But a pool must be created to
create your filesystems (datasets) and volumes. In the default
installation, the dataset is called “zroot”.
</p>

<p>
These “file systems” are similar to partitions. It is mounted wherever
you want and has its own metadata.
</p>
</div>
</div>
<div id="outline-container-org7f6ed34">
<h4 id="org7f6ed34">Creating and configuring datasets</h4>
<div id="text-org7f6ed34">
<p>
My friend Endemic has a lot of media that must be stored, he has lost
media, music from bands no one has ever heard of and soviet movies and
obscure breakcore. This kind of media has to be archived and zfs does
a great work creating that. ZFS has also a compression feature,
supporting a lot of compression algorithms.
</p>

<p>
So to create the zpool that I want to be mounted in /storage, I ran
the following commands (as root)
</p>

<div>
<pre><span># </span><span>Create the pool storage in the /dev/da0 device, which is an external</span>
<span># </span><span>hard drive</span>
zpool create storage /dev/da0
<span># </span><span>Set zstd-9 compression in the pool.</span>
zfs set <span>compression</span>=zstd-9 storage
</pre>
</div>

<p>
And that’s it. Then when you copy big files to /storage they will be
compressed. And as our CPU is fast and zstd uses a fast algorithm, you
probably won’t notice that you’re actually compressing and
decompressing files all the time. Which is good. You can also use
zstd-19 as compression, which redouce the filesize of everything by a
lot. But this has a drawback, quoting from the <a href="https://docs.freebsd.org/en/books/handbook/zfs/index.html">FreeBSD ZFS reference</a>:
</p>

<blockquote>
<p>
ZFS offers 19 levels of Zstd compression, each offering
incrementally more space savings in exchange for slower
compression. The default level is zstd-3 and offers greater
compression than LZ4 without being much slower. Levels above 10
require large amounts of memory to compress each block and systems
with less than 16 GB of RAM should not use them. ZFS uses a selection
of the Zstd_fast_ levels also, which get correspondingly faster but
supports lower compression ratios. ZFS supports zstd-fast-1 through
zstd-fast-10, zstd-fast-20 through zstd-fast-100 in increments of 10,
and zstd-fast-500 and zstd-fast-1000 which provide minimal
compression, but offer high performance.
</p>
</blockquote>

<p>
And as I use a ThinkPad in which I didn’t even bother on adding more
RAM. I use zstd-9. Which compresses the files somehow good. You can
see the stats with <code>zfs get used,compressratio,compression,logicalused
dataset</code>.
</p>

<pre>zroot  used           64.1G           -
zroot  compressratio  1.15x           -
zroot  compression    zstd-9          local
zroot  logicalused    66.1G           -
</pre>

<p>
Used is the revelant to the filesystem size. And logicalused is the
size the filesystem would have without compression. So this means I
have saved 2GBs thanks to zstd-9. I do not feel any performance difference.
</p>
</div>
</div>
<div id="outline-container-orgb88e6b9">
<h4 id="orgb88e6b9">Snapshots</h4>
<div id="text-orgb88e6b9">
<p>
We all fuck it sometime. And that is okay. What is not okay is to lose
data. ZFS contains a tool to create snapshots of a dataset. Which are
basically backups that restore your filesystem to a certain
point. These are very useful to recover lost data. You can create a
backup of your <code>home</code> partition like this:
</p>

<div>
<pre>zfs snapshot zroot/usr/home@(date +%F)
</pre>
</div>

<p>
After creating the snapshot and completely trusting ZFS, i ran rm -rf
~/*. Which nuked my home directory and everything in it. Then I ran
<code>zfs rollback zroot/usr/home@2022-06-18</code> and it was restored. Like
nothing ever happened. According to the FreeBSD reference, snapshots
can take a lot of disk space so you should delete them as they’re no
longer needed.
</p>
</div>
</div>
<div id="outline-container-orgc9d1cf6">
<h4 id="orgc9d1cf6">Other features</h4>
<p>
ZFS has features like incremental backups, encryption, RAIDS, but I
haven’t tried them.
</p>
</div>
</div>

</div>
</div></div>
  </body>
</html>
