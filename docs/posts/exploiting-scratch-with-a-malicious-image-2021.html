<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mnemonic.no/blog/exploiting-scratch-with-a-malicious-image/">Original</a>
    <h1>Exploiting Scratch with a malicious image (2021)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody">
                                




<p><em>Written by Stig Magnus Baugstø, Security Consultant, mnemonic</em></p>
<p><em>Note that this blog post is for educational purposes only and to raise awareness on SVG security and untrusted data. </em><em>The vulnerability was patched in October 2020, 8 months before this publication.</em></p>

<h2>TL;DR</h2>
<p>Scratch is an open-source programming language and has more than 70 million registered users across 150 countries. It is commonly used as an educational tool for students to create games, animations and stories.</p>
<p>A vulnerability existed in <em>Scratch</em> and <em>Scratch Desktop</em> versions prior to v.3.17.1 that an attacker could exploit to execute arbitrary code. The exploit utilises a maliciously crafted SVG file that grants an attacker full control of Scratch’s code and GUI, and enables us to launch arbitrary executables on the system if running on <em>Scratch Desktop. </em></p>
<p>Using Scratch as a practical example, this post will demonstrate why you shouldn’t open or download files from untrusted parties, even for a seemingly innocent program such as Scratch. It will also show some of the security pitfalls of the SVG file format.</p>

<p><img src="https://www.mnemonic.no/contentassets/a16ff4ab11eb42f68768d5a82060dbda/image37l4s.png" alt="" width="800" height="518"/></p>
<h2>Some background - what is Scratch?</h2>
<p><a href="https://scratch.mit.edu/" target="_blank" rel="noopener">Scratch</a> is an open-source <em>MIT</em> developed programming language and tool for block-based visual programming. It is primarily made for children between the age of 8-16, but enables anyone to easily create interactive stories, games and animations.</p>
<p>Schools and educational institutions use Scratch as an introduction to algorithmic and creative thinking, as Scratch&#39;s intuitive user interface makes it a good tool to start learning programming. You can start using the tool right away from <a href="https://scratch.mit.edu/projects/editor/?tutorial=getStarted" target="_blank" rel="noopener">Scratch’s official website</a>, host it yourself or download and use their <a href="https://scratch.mit.edu/download" target="_blank" rel="noopener"><em>Electron</em> based desktop version</a>.</p>
<h2>The vulnerability in question</h2>
<p>I recently came across a known security vulnerability in Scratch&#39;s SVG rendering engine that was disclosed on Scratch&#39;s official forums on October 21<sup>st</sup> 2020 by the forum user <a href="https://scratch.mit.edu/users/apple502j/" target="_blank" rel="noopener">apple502j</a>. <a href="https://scratch.mit.edu/discuss/topic/449794/" target="_blank" rel="noopener">The forum thread</a> describes a <a href="https://owasp.org/www-community/attacks/xss/" target="_blank" rel="noopener">cross-site scripting (XSS)</a> vulnerability with the <em>Common Vulnerability and Exposures</em> (CVE) ID of <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7750" target="_blank" rel="noopener">CVE-2020-7750</a>.</p>
<p>Curious as I am, I immediately started looking for public exploits using common search engines and the <a href="https://www.exploit-db.com" target="_blank" rel="noopener">Exploit Database</a>. Though I couldn’t find one, the forum post does link to the <a href="https://gist.github.com/apple502j/b1a4af80050175d0a23021a38b28ba57" target="_blank" rel="noopener">source of the patch</a> while <a href="https://snyk.io/vuln/SNYK-JS-SCRATCHSVGRENDERER-1020497" target="_blank" rel="noopener">Snyk&#39;s vulnerability listing</a> mentions the vulnerable functions and provides a link to the <a href="https://github.com/LLK/scratch-svg-renderer/commit/9ebf57588aa596c4fa3bb64209e10ade395aee90" target="_blank" rel="noopener">commit</a> for the patch. Armed with this information it shouldn&#39;t be too hard to create an exploit for the vulnerability.</p>
<p>My main motivation for publishing this information is to raise awareness. The following post demonstrates that you must never download and open files from untrusted parties, even for innocent programs such as Scratch. Developers should also beware the security pitfalls of the SVG file format.</p>
<p>A patch for the exploited vulnerability was released more than seven months ago making it less likely to be abused today. On that note, I would like to add a reminder to always make sure you keep your software up to date with the latest security patches and be careful with files of unknown origin.</p>
<h2>What makes the SVG file format potentially dangerous?</h2>
<p>Some very basic knowledge on the <em>Scalable Vector Graphics</em> (SVG) file format is required to understand this exploit.</p>
<p>SVG is a <em>text based</em> file format for computer graphics based on <em>Extensible Markup Language</em> (XML) that is widely used within the Scratch environment. While more traditional image formats like <em>JPG</em> or <em>PNG</em> consist of binary data, SVG is <em>text based</em>, which means that the file itself consists of human readable text.</p>
<p>If you download the <a href="https://www.mnemonic.no/UI/logo.svg" target="_blank" rel="noopener">mnemonic logo</a> from our webpage and open the file in a text editor, you reveal its true content:</p>



<div>
        <a href="https://www.mnemonic.no/contentassets/a5e278c3d72c4617bf801da10077f422/02_svg_format.png?width=1600&amp;quality=60">
    <figure>
        <img src="https://www.mnemonic.no/contentassets/a5e278c3d72c4617bf801da10077f422/02_svg_format.png?width=790&amp;factor=2&amp;quality=60" alt="" itemprop="image"/>
    </figure>
        </a>
</div>
<p>Modifying the content (right) in your text editor will change how your web browser will render the logo (left). Altering one of the color codes will change some color in the rendered image.</p>
<p>But what makes the SVG file format potentially dangerous? The answer is perhaps surprising - SVG files can contain <em>JavaScript</em>, <em>CSS</em> and load external content. A true security nightmare if you don&#39;t tread carefully.</p>
<p>You can add the following snippet to the SVG file above in order to display a popup alert when rendering the image:</p>
<hr/>
<pre>&lt;script&gt;alert(&#39;Game over!&#39;);&lt;/script&gt;</pre>
<hr/>
<p>The result is illustrated below:</p>



<div>
        <a href="https://www.mnemonic.no/contentassets/88f64a5b84374736b98de9f63bc3d423/03_svg_game_over.png?width=1600&amp;quality=60">
    <figure>
        <img src="https://www.mnemonic.no/contentassets/88f64a5b84374736b98de9f63bc3d423/03_svg_game_over.png?width=790&amp;factor=2&amp;quality=60" alt="" itemprop="image"/>
    </figure>
        </a>
</div>
<p>Uploading similar &#34;malicious&#34; SVG files to web-based solutions that do not properly sanitise and validate the SVG contents may cause security issues in web-based applications.</p>
<p>Scratch has its own <a href="https://github.com/LLK/scratch-svg-renderer" target="_blank" rel="noopener">SVG rendering engine</a> and the vulnerability we exploit resides within this component of Scratch.</p>
<h2><span lang="EN-US">Using JavaScript and XSS with malicious intent</span></h2>
<p><strong><em>JavaScript</em></strong><strong> (JS)</strong> is considered one the core technologies of modern web sites. It&#39;s a <em>client side</em> scripting language that enables dynamic functionality in web sites. Most modern web sites rely on JavaScript and disabling support for JavaScript in your web browser will likely leave you with a poor browsing experience.</p>
<p>JavaScript is powerful as it can alter the contents of the current web page, perform generic computation and communicate with third-parties. In other words; control JavaScript and you control the user&#39;s entire experience.</p>
<p><strong><em>Cross-site scripting</em></strong><strong> (XSS)</strong> vulnerabilities enable attackers to inject and execute arbitrary client-side JavaScript in to web pages accessible by other users. For example by uploading our modified SVG image above to a third party website and making the “Game over” popup appear after loading the image. You then have an XSS proof of concept attack.</p>
<p>The innocent <em>alert</em> can potentially be replaced with any JavaScript you want. For example a key logger, a site redirector or any arbitrary functionality. Imagine a social media platform with a XSS vulnerability; a threat actor that has managed to inject a JS payload may eavesdrop on all you and your friends posts and perhaps perform actions on your behalf.</p>
<p>XSS can also be user together with tools such as <a href="https://beefproject.com/" target="_blank" rel="noopener">the browser exploitation framework</a> (BeEF) to trick users into downloading malicious executables and compromise their clients.</p>
<h2><span lang="EN-US">Investigating the vulnerability</span></h2>
<p>The first thing you need to explore a vulnerability is a copy of the vulnerable target. Ideally, a local copy so you can do what you want without interfering with live solutions.</p>
<p>A friendly reminder: <strong>never</strong> attempt to exploit a third party&#39;s system(s) without getting a written approval in advance, or you may face legal consequences.</p>
<p>The official Scratch website does not include a complete list of previous versions, so cherry picking a vulnerable desktop version prior to 3.17.1 requires a bit more effort. You can grab the source code of a specific release (tag) from the <a href="https://github.com/LLK/" target="_blank" rel="noopener">official Git repository</a> and build it yourself. Or you can do as I did and guess the download URL of a previous version that still seems to be active.</p>
<p>You can download <a href="https://downloads.scratch.mit.edu/desktop/Scratch%20Desktop%20Setup%203.10.2.exe" target="_blank" rel="noopener">Scratch Desktop version 3.10.2 for Windows here</a>. If this link stops working, try the <a href="https://web.archive.org/web/20210225011334/https:/downloads.scratch.mit.edu/desktop/Scratch%20Desktop%20Setup%203.10.2.exe" target="_blank" rel="noopener">cached Web Archive version</a> instead. Browsing the Web Archive for other vulnerable versions may also be a feasible approach. The <em>SHA256 checksum</em> of the linked executable should be:</p>
<hr/>
<pre>038a1cf7024c12d9667979219dc2c5c434b9b87aceb359042c5f26642b13cbe</pre>
<hr/>
<p>The last step is to install the software. Remember that this is outdated and vulnerable software, so you should never install it on personal or business critical systems; doing so will put your equipment and data at risk. I recommend installing it in an isolated environment, like a <em>virtual machine</em> (VM) or some other virtualised environment.</p>



<div>
        <a href="https://www.mnemonic.no/contentassets/415018b081184e36aa8bc5e4888b4cf3/04_scratch_installed.png?width=1600&amp;quality=60">
    <figure>
        <img src="https://www.mnemonic.no/contentassets/415018b081184e36aa8bc5e4888b4cf3/04_scratch_installed.png?width=790&amp;factor=2&amp;quality=60" alt="" itemprop="image"/>
    </figure>
        </a>
</div>
<h2><span lang="EN-US">Initial (failed) attempt</span></h2>
<p>I prefer to save time if I can, so my initial idea was to upload our modified SVG above and hope that I hit the vulnerable code path:</p>
<p><img src="https://www.mnemonic.no/contentassets/a16ff4ab11eb42f68768d5a82060dbda/imageepa1g.png" alt="" width="800" height="518"/></p>
<p>I expected to see the same alert pop-up that we saw earlier. Unfortunately, no dice! Seems like we have to dig into the source code.</p>
<h2><span lang="EN-US">Static code analysis</span></h2>
<p><a href="https://snyk.io/vuln/SNYK-JS-SCRATCHSVGRENDERER-1020497" target="_blank" rel="noopener">Snyk</a> mentions the functions <em>loadString</em> and <em>_transformMeasurements</em> in Scratch&#39;s SVG renderer. Looking at the <a href="https://github.com/LLK/scratch-svg-renderer/commit/9ebf57588aa596c4fa3bb64209e10ade395aee90" target="_blank" rel="noopener">commit for the patch</a> indicates that the vulnerability lays within <em>src/svg-renderer.js</em> on line 372. We need to somehow manipulate our SVG file into hitting this vulnerable code path and execute our payload.</p>
<p>Let&#39;s download this source code repository and investigate the source prior to the patch. Here using <em>Git Bash</em> for Windows:</p>
<hr/>
<pre><a href="https://www.mnemonic.no/cdn-cgi/l/email-protection" data-cfemail="dab7b4bfb7b5b4b3b99aa9b9a8bbaeb9b2f7acb7">[email protected]</a> MINGW64 ~</pre>
<hr/>
<p>Using <em>git log</em> we can investigate the commits surrounding the patch (<em>9ebf57588a</em>). Note that you can search within git log using forward slash (<em>/</em>). Commit <em>16974b462c0</em>, which is two commits earlier, seems like a good candidate as there&#39;s no SVG sanitisation in the commit contents.</p>
<hr/>
<pre><a href="https://www.mnemonic.no/cdn-cgi/l/email-protection" data-cfemail="066b68636b69686f65467565746772656e2b706b">[email protected]</a> MINGW64 ~</pre>
<hr/>
<p>Opening the file and looking at the contents and surrounding comments of the vulnerable <em>_transformMeasurements</em> function, I notice that the function itself seems to be some sort of code &#34;hack&#34; to retrieve the true measurements of the loaded SVG. The source code (blindly) clones the SVG, appends it to the <em>document body</em> (&#34;display window&#34;), retrieves its measurements and removes the clone from the <em>document body</em>:</p>
<hr/>
<pre>_transformMeasurements () {</pre>
<hr/>
<p>The code looks vulnerable upon first sight and Mozilla&#39;s documentation on <em>cloneNode</em> indicates that the SVG is cloned as is, without being sanitised. Our previous attempt at exploitation did not hit this code, as nothing happened upon loading our malicious SVG.</p>
<p>We need to figure out how to reach this code path by looking for code that calls the <em>_transformMeasurements</em> function. Searching the source code with <em>Git Bash</em> for Windows:</p>
<hr/>
<pre><a href="https://www.mnemonic.no/cdn-cgi/l/email-protection" data-cfemail="c1acafa4acaeafa8a281b2a2b3a0b5a2a9ecb7ac">[email protected]</a> MINGW64 ~/scratch-svg-renderer ((16974b4...))</pre>
<hr/>
<p>We can see that the function is called on line 104 and 109 in <em>./src/svg-renderer.js</em>. These calls are both within the <em>loadString</em> function, which is also mentioned by <a href="https://snyk.io/vuln/SNYK-JS-SCRATCHSVGRENDERER-1020497">Snyk</a>. Let&#39;s dig into this function:</p>

<hr/>
<pre>loadString (svgString, fromVersion2) {</pre>
<hr/>
<p>One of two conditions needs to be met in order for the vulnerable <em>_transformMeasurements</em> function to be called. The first condition, <em>if (fromVersion2)</em>, is true if the <em>fromVersion2</em> variable contains a value that evaluates to <em>true</em>. This variable is externally provided to the function and is difficult to determine how to control at this point.</p>
<h2><span lang="EN-US">Second (failed) attempt</span></h2>
<p>The second condition is more promising; <em>else if (!this._svgTag.getAttribute(&#39;viewBox&#39;))</em>. Notice the exclamation mark (<em>!</em>), which means <em>not</em> in JavaScript. The <em>not</em> reverses the result of the preceding statement, which checks for the presence of the <em>viewBox</em> attribute in the initial <em>svg</em> tag of the file.</p>
<p>The condition can be written in English as <em>call _transformMeasurements if the SVG is missing the viewBox attribute</em>. This is interesting!</p>
<p>Looking at the content of our previously modified SVG, we notice that the <em>viewBox</em> attribute is clearly present:</p>
<hr/>
<pre>&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; xmlns:xlink=&#34;http://www.w3.org/1999/xlink&#34; <strong>viewBox=&#34;0 0 135.97 25.19&#34;</strong>&gt;&lt;script&gt;alert(&#39;Game over!&#39;);&lt;/script&gt;&lt;defs&gt;...</pre>
<hr/>
<p>It&#39;s immediately tempting to remove the attribute from the file and retry our payload, but if you looked clearly at the code above you may have noticed the <em>DOMParser</em> and call to <em>fixupSvgString</em>. I suspect our trivial payload may be sanitised by these.</p>
<p>I read the <a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMParser">DOMParser documentation</a> and ran some local JavaScript experiments using the <em>console</em> of the embedded <em>web developer tools</em> in my browser to verify that this function only converts a text string to HTML DOM elements, not tinkering with our payload.</p>
<p>However, the <em>fixupSvgString</em> function residing in <em>src/fixup-svg-string.js</em> removes our script content from the SVG:</p>
<hr/>
<pre>module.exports = function (svgString) {</pre>
<hr/>

<h2>Event handlers to the rescue</h2>
<p>So, how can we execute arbitrary JavaScript within our malicious SVG when script contents are stripped?</p>
<p>The answer is through <a href="https://developer.mozilla.org/en-US/docs/Web/Events/Event_handlers" target="_blank" rel="noopener">event handlers</a>. SVGs can contain <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/SVG_Image_Tag" target="_blank" rel="noopener">image</a> tags to include external raster images. This tag supports the <em>onload</em> and <em>onerror</em> event handlers, among others. We can use this to change our payload to the following:</p>
<hr/>
<pre><code>&lt;image href=&#34;http://127.0.0.1:8765/doesNotExist.png&#34; onerror=&#34;alert(&#39;Pwned by mnemonic!&#39;)&#34; /&gt;</code></pre>
<hr/>

<p>The snippet attempts to load a picture (<em>doesNotExist.png</em>) from a web server hopefully not running on your local machine (<em>127.0.0.1</em>) at port <em>8765</em>. The intention is to make this load operation fail, so that the malicious <em>onerror</em> event handler is triggered, executing our arbitrary JavaScript code.</p>

<p>Our entire SVG file will then look like this:</p>
<hr/>
<pre><code>&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; xmlns:xlink=&#34;http://www.w3.org/1999/xlink&#34;&gt;</code></pre>
<hr/>

<p>Note that I have removed the <em>viewBox</em> attribute of the opening <em>&lt;svg&gt;</em> tag.</p>
<p>The result? Success! Our “Game Over” popup appears after loading the SVG into Scratch.</p>
<p><img src="https://www.mnemonic.no/contentassets/a16ff4ab11eb42f68768d5a82060dbda/06_exptest02.gif" alt="" width="800" height="518"/></p>
<h2><span lang="EN-US">Leveraging the exploit</span></h2>
<p>The popup proves that we&#39;re capable of running arbitrary JavaScript within the application, but how can we use it for something more powerful? The short answer is that you can replace the proof-of-concept code with any JavaScript you like. The longer answer is that you need to mind the context of the application.</p>
<p>There are several versions of Scratch available, and what you can do depends on which version you use. We’ll look at and exploit both the desktop and web-based versions.</p>
<p>The <em>Scratch Desktop</em> application we&#39;ve been using in this blog post runs as a local application in Windows and enables more severe exploits. Scratch is still a web application under the hood, but the desktop application is built with <a href="https://www.electronjs.org/" target="_blank" rel="noopener">Electron</a>, enabling web pages to run as local desktop applications. We can take advantage of the Electron ecosystem to perform operating system calls on the host computer using the following new shortened SVG payload:</p>
<hr/>
<pre>&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; xmlns:xlink=&#34;http://www.w3.org/1999/xlink&#34;&gt;</pre>
<hr/>

<p><img src="https://www.mnemonic.no/contentassets/a16ff4ab11eb42f68768d5a82060dbda/imagegh0y.png" alt="" width="800" height="518"/><code></code></p>
<p>This proof of concept launches a Windows terminal (<em>cmd.exe</em>) using the embedded Electron JavaScript library of the desktop application. XXS vulnerabilities are in practice <em>remote code execution </em>(RCE) vulnerabilities with Electron. The same approach can be used to execute a covert reverse shell payload easily generated with tools such as <a href="https://www.offensive-security.com/metasploit-unleashed/Msfvenom/" target="_blank" rel="noopener">msfvenom</a>. This would allow an attacker to take control over the host computer.</p>
<p>The web browser version, similar to the one hosted on the official Scratch website, does not allow your script to do anything more than JavaScript running on a traditional website. However with that said, this presents plenty of opportunities for an attacker to further compromise the client, for example by using the <a href="https://beefproject.com/" target="_blank" rel="noopener">BeEF framework</a> mentioned earlier.</p>
<p>This last payload is intended for the web browser based version of Scratch and is made to illustrate the severity of the vulnerability even without access to calling system executables. I&#39;m borrowing the publicly available picture of our department manager for this example, and hope he&#39;ll forgive me, and then I&#39;ll use the <em>onload</em> rather than the <em>onerror</em> event handler. This example also illustrates SVG&#39;s ability to load external content:</p>
<hr/>
<pre>&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; xmlns:xlink=&#34;http://www.w3.org/1999/xlink&#34;&gt;</pre>
<hr/>
<p>I&#39;ll also store it in a Scratch project file for this example, to show you that the vulnerability can be hidden within seemingly innocent project files. Scratch&#39;s project files are plain <em>zip archives</em> that have their file extensions renamed to <em>.sb3</em>.</p>
<p>I first created a basic Scratch project, saved it, then renamed the extension to <em>.zip</em> and extracted its content. Then, I replaced one of the SVGs with the payload above and made a new zip file of all the files. The last step was to rename the extension into <em>.sb3</em> and reload the project in Scratch. The result is shown below:</p>
<p><img src="https://www.mnemonic.no/contentassets/a16ff4ab11eb42f68768d5a82060dbda/imagelfj2.png" alt="" width="800" height="518"/></p>
<p>We see that the graphical user interface is completely redrawn with contents of our choosing, including Andreas’ picture.</p>
<h2>Closing statements</h2>
<p>This blog post used information from a publicly known vulnerability in <em>Scratch</em> and <em>Scratch Desktop</em> to develop a functional proof of concept exploit. The intention is to raise awareness of SVG security considerations and expose the danger of untrusted files, even in &#34;innocent&#34; applications.</p>
<p>I would like to give special thanks to my colleague Kaspar Papli for his technical review of the methods and exploits used.</p>
<p>Developers, be careful with SVG!</p>
<p>Everyone, be careful with untrusted files!</p>






                            </div></div>
  </body>
</html>
