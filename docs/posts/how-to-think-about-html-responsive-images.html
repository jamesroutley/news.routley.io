<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://danburzo.ro/responsive-images-html/">Original</a>
    <h1>How to think about HTML responsive images</h1>
    
    <div id="readability-page-1" class="page"><div id="main" tabindex="-1">
<article>
	
	
	
	<p>The days with an immobilized knee are long and I’ve just read through the <a href="https://html.spec.whatwg.org/multipage/images.html">Images section</a> of the <abbr>HTML</abbr> Standard, as one does, hoping to better understand how responsive images work.</p>
<h2>What’s a responsive image?</h2>
<p>The term <em>responsive image</em> encompasses two complementary approaches.</p>
<p>In the context of <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Responsive_Design#responsive_imagesmedia">responsive web design</a>, a responsive image is one that’s made fluid with the <code>width</code>, <code>height</code>, <code>aspect-ratio</code>, and <code>object-*</code> properties, as part of <abbr>CSS</abbr> layouts that change with the viewport size and other media conditions.</p>
<p>But what the <abbr>HTML</abbr> Standard is concerned with, and what this article talks about, are the so-called “adaptive images” enabled by the <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/srcset"><code>srcset</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/sizes"><code>sizes</code></a> attributes on <code>&lt;img&gt;</code>, and the dedicated <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture"><code>&lt;picture&gt;</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/source"><code>&lt;source&gt;</code></a> elements. These <abbr>HTML</abbr> features help the browser pick the most appropriate image <em>content</em> for the current environment.</p>
<p>Here’s how I made sense of responsive image content, progressing from simpler to more complicated — and then back to simple.</p>

<h2>Level 1: one image, one resolution</h2>
<p>Let’s start with the simplest image markup:</p>
<figure>
<p><img src="https://danburzo.ro/img/responsive-images/puppy.jpg" alt="A black and white pupper, glancing inquisitively"/>
</p>
<pre><code><span><span><span>&lt;</span>img</span> <span>src</span><span><span>=</span><span>&#34;</span>puppy.jpg<span>&#34;</span></span> <span>alt</span><span><span>=</span><span>&#34;</span>A black and white pupper, glancing inquisitively<span>&#34;</span></span><span>&gt;</span></span></code></pre>
</figure>
<p>In the absence of any attributes or styles to dictate otherwise, <code>puppy.jpg</code> renders at its natural width and height, <code>120px</code> by <code>150px</code> in <abbr>CSS</abbr> pixels.</p>
<p>A <abbr>CSS</abbr> pixel is <a href="https://drafts.csswg.org/css-values/#device-pixel">defined</a> as <q>the visual angle of one pixel on a device with a device pixel density of 96dpi and a distance from the reader of an arm’s length</q> or about 0.0213 degrees.</p>
<p>Modern phones are used at a much smaller distance than arm’s length. Their screens need to have a greater density to look good: the visual angle of 0.0213° at a distance of 50 centimeters computes to a pixel on a 137ppi (pixels per inch) display.</p>
<p>The 2556×1179px physical resolution of an iPhone 15, packed in a display that measures 6.1 inches diagonally, gives it a pixel density of 460 ppi. That’s more than three times denser than our nominal <abbr>CSS</abbr> display. The iPhone can therefore comfortably use three device pixels to draw each <abbr>CSS</abbr> pixel, and web content will have more or less the same size as when viewed on a regular monitor placed further away.</p>
<p>This ratio between a device pixel and a <abbr>CSS</abbr> pixel is called the <em>device pixel ratio</em> and is available on <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio"><code>window.devicePixelRatio</code></a>. The device pixel ratio is not a fixed measure of the capabilities of the physical display. The display resolution chosen by the user, or zooming in and out of the web page, can also influence the ratio. Zooming into the page makes for fewer, larger <abbr>CSS</abbr> pixels, so the device pixel ratio increases.</p>
<p>Back to our image. On devices that have a device pixel ratio of 2 or 3 (usually called <a href="https://en.wikipedia.org/wiki/Retina_display">retina displays</a> regardless of brand), the image looks blurry at its natural size: the display can potentially use two or three separate device pixels in the space of a <abbr>CSS</abbr> pixel, but we only give it one image pixel to draw. On these denser displays, the image looks better when scaled down to increase its density to match that of the display. When one image pixel becomes one device pixel, instead of two or three, the image is as crisp as it gets.</p>
<figure>
<p><img src="https://danburzo.ro/img/responsive-images/puppy.jpg" alt="A black and white pupper, glancing inquisitively" width="120"/>
<img src="https://danburzo.ro/img/responsive-images/puppy.jpg" alt="A black and white pupper, glancing inquisitively" width="60"/>
<img src="https://danburzo.ro/img/responsive-images/puppy.jpg" alt="A black and white pupper, glancing inquisitively" width="40"/>
</p>
<pre><code><span><span><span>&lt;</span>img</span> <span>src</span><span><span>=</span><span>&#34;</span>puppy.jpg<span>&#34;</span></span> <span>width</span><span><span>=</span><span>&#34;</span>120<span>&#34;</span></span> <span>alt</span><span><span>=</span><span>&#34;</span>…<span>&#34;</span></span><span>&gt;</span></span> </code></pre>
<figcaption>
<p>The same <code>120px</code> by <code>150px</code> image is rendered at its natural size, then scaled down in half, and finally to 1/3 of its natural width.</p>
</figcaption>
</figure>
<p>The rendered size of an <code>&lt;img&gt;</code> element can be adjusted with the <code>width</code> and <code>height</code> <abbr>HTML</abbr> attributes, or with equivalent <abbr>CSS</abbr> properties.</p>
<p>It’s best to <a href="https://www.smashingmagazine.com/2020/03/setting-height-width-images-important-again/">include explicit <code>width</code> and <code>height</code> attributes</a> on the <code>&lt;img&gt;</code>. That way the browser can leave room for the image beforehand and prevent layout shifts as the image loads. It also helps presentation in contexts that don’t ship the author’s <abbr>CSS</abbr>, such as <abbr>RSS</abbr> feeds. (I can count at least three feeds in my reader with huge, distracting icons that are, no doubt, stray images without sizing attributes.)</p>
<h2>Level 2: one image, many resolutions</h2>
<p>For a sharp image on displays of various densities, shrinking the same image file to various degrees to increase its density is insufficient. We need commensurately larger images that pack more detail.</p>
<figure>
<img src="https://danburzo.ro/img/responsive-images/puppy-sizes.png" alt="The same image of our pupper at three different scales, one next to each other" width="2003" height="1303"/>
<figcaption>
<p>Images with progressively larger resolutions, representing the same content.</p>
</figcaption>
</figure>
<figure>
<p><img src="https://danburzo.ro/img/responsive-images/puppy.jpg" alt="A black and white pupper, glancing inquisitively" width="120"/>
<img src="https://danburzo.ro/img/responsive-images/puppy-hd.jpg" alt="A black and white pupper, glancing inquisitively" width="120"/>
<img src="https://danburzo.ro/img/responsive-images/puppy-ultra-hd.jpg" alt="A black and white pupper, glancing inquisitively" width="120"/>
</p>
<pre><code><span><span><span>&lt;</span>img</span> <span>src</span><span><span>=</span><span>&#34;</span>puppy.jpg<span>&#34;</span></span> <span>width</span><span><span>=</span><span>&#34;</span>120<span>&#34;</span></span> <span>alt</span><span><span>=</span><span>&#34;</span>…<span>&#34;</span></span><span>&gt;</span></span> </code></pre>
<figcaption>
When shrunk to their ideal density, all three images render at the same size.
</figcaption>
</figure>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/srcset"><code>srcset</code></a> attribute lets you pack all the images on a single <code>&lt;img&gt;</code> tag, and let the browser choose the most appropriate for each situation.</p>
<figure>
<p><img srcset="/img/responsive-images/puppy-ultra-hd.jpg 3x, /img/responsive-images/puppy-hd.jpg 2x" src="https://danburzo.ro/img/responsive-images/puppy.jpg" alt="A black and white pupper, glancing inquisitively"/>
</p>
<pre><code><span><span><span>&lt;</span>img</span> </span></code></pre>
</figure>
<figcaption>
</figcaption>
<p>Each entry in <code>srcset</code> has a pixel density descriptor: a floating-point number followed by the unit <code>x</code>. The descriptor next to each image source declares the image density at which that source is meant to be rendered. If omitted for a source, a <code>1x</code> descriptor is assumed.</p>
<p>The <code>src</code> attribute on the <code>&lt;img&gt;</code> is both a fallback for browsers that don’t support <code>srcset</code> (a vanishingly small lot) and a contribution to the set of image source candidates with an implicit <code>1x</code> pixel density descriptor.</p>
<p>The browser will select the most appropriate image source out of the set of candidates, based not only on the display density, but possibly other factors such as network speed and mobile data preferences. This choice is made <q>in an implementation-defined manner</q>, meaning the browser is free to choose whatever it thinks works best.</p>
<p>In the absence of <code>width</code> and <code>height</code> <abbr>HTML</abbr> attributes to dictate otherwise, whatever image source is selected will be rendered at its <em>density-corrected natural dimensions</em>, which are the image’s natural dimensions divided by its declared density. The density-corrected natural dimensions can be accessed on the <abbr>DOM</abbr> object’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/naturalWidth"><code>naturalWidth</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/naturalHeight"><code>naturalHeight</code></a> properties:</p>
<pre><code>img<span>.</span>naturalWidth <span>===</span> intrinsicWidth <span>/</span> density<span>;</span></code></pre>
<p>At <code>1x</code> density,  the element’s density-corrected natural dimensions correspond to the file’s natural (intrinsic) dimensions. At <code>2x</code> density, the image is rendered at half the number of <abbr>CSS</abbr> pixels as the file’s natural dimensions.</p>
<p>Because of the way we’ve generated our three images and declared their intended densities, they all render at a width of <code>120px</code>, regardless of which image source the browser chooses. So there’s no issue with adding the recommended explicit width and height attributes:</p>
<pre><code><span><span><span>&lt;</span>img</span> </span></code></pre>
<p>To tell which image source the browser has chosen at any given point, look at the <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/currentSrc"><code>currentSrc</code></a> property on the image element.</p>
<h2>Level 3: dynamic image density</h2>
<p>The <code>srcset</code> attribute with pixel density descriptors works well for images that are meant to be displayed at their (density-corrected) natural size.</p>
<p>But images often participate in responsive layouts and are made fluid with <abbr>CSS</abbr>, so an image renders at various densities depending on the layout. On a large screen, the image may be part of a three-column layout. On a smaller screen, the layout may collapse to a single column with full-width images.</p>
<p>This is a case where the image density changes but the display density doesn’t, so <code>srcset</code> with density descriptors won’t cut it.</p>
<p>There’s a second way we can use <code>srcset</code>. To help the browser choose an image source of appropriate density when media conditions change, we can swap our density descriptors for a combination of <em>width descriptors</em> and a separate <code>sizes</code> attribute.</p>
<p>Instead of describing the intended image densities, width descriptors (using the <code>w</code> suffix) declare the natural (intrinsic) width of each of the image sources.</p>
<p>This information, by itself, is not enough for the browser to make a meaningful choice. It needs to know how the image is going to be laid out. This is accomplished with the <code>sizes</code> attribute, which declares the layout width of the image in one or more media conditions.</p>
<figure>
<p><img srcset="/img/responsive-images/puppy-ultra-hd.jpg 360w, /img/responsive-images/puppy-hd.jpg 240w, /img/responsive-images/puppy.jpg 120w" sizes="(min-width: 50em) 10em, 80vw" alt="A black and white pupper, glancing inquisitively"/>
</p>
<pre><code><span><span><span>&lt;</span>img</span></span></code></pre>
<figcaption>
<p>The <code>srcset</code> attribute declares three image sources using width (<code>w</code>) descriptors: one <code>360px</code> wide, one <code>240px</code> wide, and a final one <code>120px</code> wide. The <code>sizes</code> attribute describes how the image is laid out: on devices wider than 400px, they are rendered at a width of <code>10em</code>, otherwise they occupy 80% of the viewport width.</p>
</figcaption>
</figure>
<p>We’re free to declare the layout width with any <abbr>CSS</abbr> unit for <code>&lt;length&gt;</code>, and use <code>calc()</code> and other <a href="https://drafts.csswg.org/css-values/#math-function">math functions</a>, to try to <em>roughly</em> match the image’s actual layout width.</p>
<blockquote>
<p>Percentages aren’t allowed in the <code>sizes</code> attribute, as they wouldn’t match the usual understanding of <em>percentage of the parent’s width</em>. Remember that choosing image sources for <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/loading">eagerly-loaded</a> images happens <em>before</em> layout, so we can only refer to things known beforehand, such as the viewport’s dimensions.</p>
<p>As we’ll see later on, lazily-loaded images, which are fetched <em>after</em> layout, <a href="#sizes-auto">don’t need to juggle</a> any of this <code>sizes</code> stuff.</p>
</blockquote>
<p>The purpose of the <code>sizes</code> attribute is to help convert width descriptors to density descriptors. Width descriptors are turned into density descriptors by:</p>
<ol>
<li>identifying the size that matches the current media conditions among the values in <code>sizes</code>;</li>
<li>resolving the size value to <abbr>CSS</abbr> pixels;</li>
<li>dividing the declared width by that amount of pixels.</li>
</ol>
<p>The density computed from a source’s width descriptor and a layout size is called the source’s <em>effective density</em>.</p>
<p>In a larger viewport that’s, say, 1920 pixels wide, our image is intended to be displayed at a width of <code>10em</code>, which computes to <code>10 * 16px = 160px</code> in <abbr>CSS</abbr> pixels. The large image source, having a declared width of <code>360px</code>, when rendered <code>160px</code> wide, will have an effective density of  <code>360/160 = 2.25</code>. The medium and small images will have effective densities of <code>1.5</code> and <code>0.75</code> respectively. On this viewport width, the equivalent <code>srcset</code> with density descriptors is:</p>
<pre><code><span><span><span>&lt;</span>img</span></span></code></pre>
<p>In a smaller viewport that is 300 pixels wide, our images are meant to be displayed at <code>80vw</code>, which computes to <code>300px * 80/100 = 240px</code> <abbr>CSS</abbr> pixels. In these media conditions, our three image sources will have effective densities of <code>1.5</code>, <code>1</code>, and <code>0.5</code> respectively. On this smaller viewport width, the equivalent <code>srcset</code> with density descriptors is:</p>
<pre><code><span><span><span>&lt;</span>img</span></span></code></pre>
<p>Therefore, <code>srcset</code> with width descriptors, combined with <code>sizes</code>, is a way to assign a <strong>dynamic density</strong> to image sources, roughly based on how the image is laid out in various media conditions.</p>
<p>When <code>srcset</code> uses width descriptors, the image’s <code>src</code> is purely a fallback for browsers that don’t support it. The attribute can’t contribute an image source, because there’s no way to attach a width descriptor to its value.</p>
<p>The two <code>srcset</code> flavors are both ultimately resolved to a set of image sources with density descriptors, but they don’t mix well. You can’t use width descriptors for some sources and density descriptors for others in a single <code>srcset</code>. Either use width descriptors <em>with</em> the <code>sizes</code> attribute, or density descriptors <em>without</em> the <code>sizes</code> attribute. In the former case, <code>sizes</code> is necessary; in the latter, it serves no purpose and is ignored.</p>
<blockquote>
<p><strong>Don’t rely on the default.</strong> When we say <code>sizes</code> is required for width descriptors, it means a <abbr>HTML</abbr> document omitting it <a href="https://validator.w3.org/">won’t validate</a> and it won’t be <em>canon</em>. But <abbr>HTML</abbr> is tolerant of author errors and defaults to a value of <code>100vw</code>. As Eric Portis <a href="https://alistapart.com/blog/post/article-update-dont-rely-on-default-sizes/">explains</a>, you don’t want to rely on that default, as it potentially nudges the browser to fetch images much larger than needed, defeating the whole purpose of the feature.</p>
</blockquote>
<h2>Level 4: the <code>&lt;picture&gt;</code> element</h2>
<p>The <code>srcset</code> attribute on the <code>&lt;img&gt;</code> merely provides a set of candidate sources to the browser, along with enough information about them to allow for an informed choice. As Mat Marquis writes in the <a href="https://web.dev/learn/images/">Learn Images</a> course, it makes <code>srcset</code> a <a href="https://web.dev/learn/images/descriptive">descriptive syntax</a>. It says to the browser: <q>here’s what I have, now <em>you</em> pick!</q></p>
<p>There’s another <abbr>HTML</abbr> feature with which we can be <a href="https://web.dev/learn/images/prescriptive">more prescriptive</a> and say <q>only consider these image sources if these conditions are met</q>. This is done with one or more <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/source"><code>&lt;source&gt;</code></a> elements associated with the <code>&lt;img&gt;</code> by virtue of being wrapped together in a <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture"><code>&lt;picture&gt;</code></a> element:</p>
<pre><code><span><span><span>&lt;</span>picture</span><span>&gt;</span></span></code></pre>
<p>The <code>&lt;picture&gt;</code> element is a container that augments its inner <code>&lt;img&gt;</code> by providing more sets of image sources to choose from, declared with <code>&lt;source&gt;</code> elements. If the browser doesn’t support these elements, no harm is done: they’re ignored and the <code>&lt;img&gt;</code> works as if it were alone.</p>
<p><small>(You might say <code>&lt;picture&gt;</code> is the original <a href="https://adactio.com/journal/20618"><abbr>HTML</abbr> web component</a>, but that’s an angle for another day.)</small></p>
<p>Like image elements, <code>&lt;source&gt;</code>s use the <code>srcset</code> and <code>sizes</code> attributes to declare their set of image sources. In addition, they accept two attributes that condition their contribution:</p>
<ul>
<li>the <code>type</code> attribute declares the media type of the image set, so that the browser can skip image formats it doesn’t understand;</li>
<li>the <code>media</code> attribute declares the media conditions where the image set makes sense, which the browser skips if they don’t apply.</li>
</ul>
<p>The first source that matches the current media conditions and media type capabilities defines the pool of image candidates, from which the browser chooses the most appropriate one as with <code>&lt;img srcset&gt;</code>. If no sources apply to the current circumstances, the image’s own <code>srcset</code> or <code>src</code> is used as a fallback.</p>
<h3>The <code>type</code> attribute</h3>
<p>The <code>type</code> attribute enables us to serve newer, more efficient image formats to supporting browsers without ruining it for the others. If a browser can’t use <code>image/avif</code>, or <code>image/webp</code> it can just ignore the respective <code>&lt;source&gt;</code> elements.</p>
<figure>
<pre><code><span><span><span>&lt;</span>picture</span><span>&gt;</span></span></code></pre>
<figcaption>
<p>Serving newer image formats safely with <code>&lt;source&gt;</code> elements with a <code>type</code> attribute. If we omitted the <code>type</code> attribute, or used <code>puppy.avif</code> and <code>puppy.webp</code> directly in the image’s <code>srcset</code> attribute, unsuspecting older browsers would fetch formats they don’t understand, resulting in a broken image.</p>
</figcaption>
</figure>
<h3>The <code>media</code> attribute</h3>
<p>The <code>media</code> attribute can contain any media condition. We could, for example, serve an alternative image for dark mode, and a higher-contrast version appropriate for printing.</p>
<figure>
	<p><img src="https://danburzo.ro/img/responsive-images/macos-light.png" width="200" alt="The Display settings in MacOS, rendered in light mode."/>
		<img src="https://danburzo.ro/img/responsive-images/macos-dark.png" width="200" alt="The Display settings in MacOS, rendered in dark mode."/>
		<img src="https://danburzo.ro/img/responsive-images/macos-contrast.png" width="200" alt="The Display settings in MacOS, rendered in high-contrast mode."/>
	</p>
<figcaption>
<p>Three styles for illustrating a portion of the macOS display settings: light mode, dark mode, and high-contrast mode.</p>
</figcaption>
</figure>
<figure>
<div>
<picture>
	<source media="(prefers-color-scheme: dark)" srcset="/img/responsive-images/macos-dark.png"/>
	<source media="print" srcset="/img/responsive-images/macos-contrast.png"/>
	<img src="https://danburzo.ro/img/responsive-images/macos-light.png" alt="The Display settings in MacOS, rendered in light mode."/>
</picture>
</div>
<pre><code><span><span><span>&lt;</span>picture</span><span>&gt;</span></span></code></pre>
<figcaption>
<p>A <code>&lt;picture&gt;</code> element uses the three styles in <code>&lt;source&gt;</code> elements, with the appropriate media queries. Above the code: Live picture, as chosen by the browser. Try switching to dark mode, or print-previewing the page to see the effect.</p>
</figcaption>
</figure>
<p>The same rules for <code>srcset</code> and <code>sizes</code> apply to <code>&lt;source&gt;</code> elements: you can’t mix density descriptors and width descriptors in a single <code>srcset</code>, and you must use the <code>sizes</code> attribute with, and only with, width descriptors.</p>
<p><code>&lt;source&gt;</code> elements also have rules of their own:</p>
<ul>
<li>each <code>&lt;source&gt;</code> must generally have some sort of <code>type</code> or <code>media</code> condition, or both, attached to it. Only if the image itself doesn’t have a <code>srcset</code> already, one bare, conditionless <code>&lt;source&gt;</code> is allowed.</li>
<li>there’s no <code>src</code> attribute on <code>&lt;source&gt;</code> because <a href="https://github.com/ResponsiveImagesCG/picture-element/issues/78">it would be confusing</a> and besides, any valid <code>src</code> can be plopped into <code>srcset</code> instead.</li>
</ul>
<h2>Level 5: art direction</h2>
<p>While a <code>srcset</code> is meant to represent the same image content at different scales, multiple <code>&lt;source&gt;</code> elements can represent different content altogether. In the previous example, we used the <code>media</code> attribute to serve images styled according to user preferences.</p>
<p>The different images don’t need to have the same aspect ratio. In fact, there’s nothing stopping us from serving radically different images in various scenarios. On a large screen, a photograph could be a wide shot of the subject, while on smaller screens that can be cropped closer to the action.</p>
<p>The technique is often called art-directing responsive images.</p>
<figure>
	<img src="https://danburzo.ro/img/responsive-images/puppy-art-direction.png" alt="An image of the pupper with a square around its face to indicate a close-up image crops" width="640" height="530"/>
<figcaption>
Art directing an image: a close-up crop of 200px by 200px is chosen for smaller screens.
</figcaption>
</figure>
<p>Since setting the <code>width</code> and <code>height</code> on the <code>&lt;img&gt;</code> element <a href="#width-height-important">is important</a>, it seemed like a great idea to <a href="https://github.com/whatwg/html/issues/4968">add support</a> for <code>width</code> and <code>height</code> attributes on <code>&lt;source&gt;</code> elements. The dimensions can then be imparted to the image element when the source is selected. (The case for sources also getting <a href="https://github.com/whatwg/html/issues/6627">their own <code>alt</code> attribute</a> is still being made.)</p>
<figure>
<div>
	<picture>
		<source srcset="/img/responsive-images/puppy-closeup.jpg" width="200" height="200" media="(max-width: 40em)"/>
		<img src="https://danburzo.ro/img/responsive-images/puppy-ultra-hd.jpg" width="450" height="600" alt="A black and white pupper, glancing inquisitively"/>
	</picture>
</div>
<pre><code><span><span><span>&lt;</span>picture</span><span>&gt;</span></span></code></pre>
<figcaption>
<p>An art-directed responsive image displays a close-up of the subject when the viewport is less than <code>40em</code> (<code>640px</code>) wide. Notice the <code>width</code> and <code>height</code> attributes on the <code>&lt;source&gt;</code> element.</p>
</figcaption>
</figure>
<blockquote>
<p><strong>Cropping after image load:</strong> Images can also be art-directed with <abbr>CSS</abbr> using the <code>object-fit</code>, <code>object-position</code>, and <code>object-view-box</code> properties. However, to the extent that is practical, using <code>&lt;picture&gt;</code> to serve the pre-cropped images saves some bandwidth and compute energy.</p>
</blockquote>
<h2 id="sizes-auto">Extra credit: lazy images with <code>sizes=auto</code></h2>
<p>As promised in the introduction, we end with a bit of respite from the complexity of responsive image markup.</p>
<p>A recent addition to the <abbr>HTML</abbr> Standard allows lazily-loaded images to ditch the arduous, hand-coded, approximated values in the <code>sizes</code> attribute. Instead, with the <code>auto</code> value, the browser uses the image’s actual layout width to compute more accurate densities for the image candidates.</p>
<p>Eric Portis <a href="https://ericportis.com/posts/2023/auto-sizes-pretty-much-requires-width-and-height/">covers the feature and its caveats</a> in admirable detail. I won’t repeat the points here, because this thing is already getting too long.</p>
<h2>How browsers choose one image</h2>
<p>Now that we’ve covered the theory of providing image source candidates, let’s find out how browsers actually pick the most appropriate one.</p>
<p>I’ve run a couple of quick tests on MacBook Pro and iPhone, and dipped into browser source code to confirm the behavior (insofar as I am looking at the right code to begin with).</p>
<h3>Density descriptors in <code>srcset</code></h3>
<figure>
	<img srcset="
		/demos/responsive-images/placeholders/300x200@0.1x.png 0.1x,
		/demos/responsive-images/placeholders/300x200@0.2x.png 0.2x,
		/demos/responsive-images/placeholders/300x200@0.3x.png 0.3x,
		/demos/responsive-images/placeholders/300x200@0.4x.png 0.4x,
		/demos/responsive-images/placeholders/300x200@0.5x.png 0.5x,
		/demos/responsive-images/placeholders/300x200@0.6x.png 0.6x,
		/demos/responsive-images/placeholders/300x200@0.7x.png 0.7x,
		/demos/responsive-images/placeholders/300x200@0.8x.png 0.8x,
		/demos/responsive-images/placeholders/300x200@0.9x.png 0.9x,
		/demos/responsive-images/placeholders/300x200@1x.png 1x,
		/demos/responsive-images/placeholders/300x200@1.1x.png 1.1x,
		/demos/responsive-images/placeholders/300x200@1.2x.png 1.2x,
		/demos/responsive-images/placeholders/300x200@1.3x.png 1.3x,
		/demos/responsive-images/placeholders/300x200@1.4x.png 1.4x,
		/demos/responsive-images/placeholders/300x200@1.5x.png 1.5x,
		/demos/responsive-images/placeholders/300x200@1.6x.png 1.6x,
		/demos/responsive-images/placeholders/300x200@1.7x.png 1.7x,
		/demos/responsive-images/placeholders/300x200@1.8x.png 1.8x,
		/demos/responsive-images/placeholders/300x200@1.9x.png 1.9x,
		/demos/responsive-images/placeholders/300x200@2x.png 2x,
		/demos/responsive-images/placeholders/300x200@2.2x.png 2.2x,
		/demos/responsive-images/placeholders/300x200@2.4x.png 2.4x,
		/demos/responsive-images/placeholders/300x200@2.6x.png 2.6x,
		/demos/responsive-images/placeholders/300x200@2.8x.png 2.8x,
		/demos/responsive-images/placeholders/300x200@3x.png 3x,
		/demos/responsive-images/placeholders/300x200@3.2x.png 3.2x,
		/demos/responsive-images/placeholders/300x200@3.4x.png 3.4x,
		/demos/responsive-images/placeholders/300x200@3.6x.png 3.6x,
		/demos/responsive-images/placeholders/300x200@3.8x.png 3.8x,
		/demos/responsive-images/placeholders/300x200@4x.png 4x
	" alt="A placeholder image displaying its size and density, as chosen by the browser"/>	
<figcaption>
<p>The image above uses several image sources of <code>300×200px</code> constant size, but labeled and declared with density descriptors ranging from <code>0.1x</code> to <code>4x</code> in the <code>srcset</code> attribute. This shows us which source the browser picks. <a href="https://danburzo.ro/demos/responsive-images/density.html">Test: image density selection</a>.</p>
</figcaption>
</figure>
<p><strong>Firefox.</strong> At <code>100%</code> zoom, the device pixel ratio is <code>2</code>. Zooming in and out of the page updates the <abbr>DPR</abbr> and re-fetches the image with the smallest density that’s higher than the current <abbr>DPR</abbr>, or the highest density available when all densities are too small. Relevant code in <a href="https://github.com/mozilla/gecko-dev/blob/46dae934738073c4f51c2b628503fe3bf84f89d2/dom/base/ResponsiveImageSelector.cpp#L331"><code>Responsive<wbr/>Image<wbr/>Selector.cpp<wbr/>#L331</code></a>.</p>
<p><strong>Chrome.</strong> The browser selects the image with the density closest to the <abbr>DPR</abbr> when loading the page. Zooming in and out of the page updates the <abbr>DPR</abbr>, but the browser will only fetch another, more appropriate image on page refresh. It will also prefer the densest image source it has in its cache, even if its density is much higher than needed. Relevant code in <a href="https://github.com/chromium/chromium/blob/3167b39925e4ea2c1983d049c8a440d023a727bb/third_party/blink/renderer/core/html/parser/html_srcset_parser.cc#L424"><code>html<wbr/>_srcset<wbr/>_parser.cc<wbr/>#L424</code></a>.</p>
<p><strong>Safari.</strong> The <abbr>DPR</abbr> is fixed to a value of <code>2</code> on the MacBook and <code>3</code> on the iPhone. Zooming in and out of the page doesn’t update the <abbr>DPR</abbr> or fetch another image. Like in Firefox, you get the image with the smallest density that’s higher than this fixed <abbr>DPR</abbr>. Relevant code in <a href="https://github.com/WebKit/WebKit/blob/4e262b07baa1b55186d79a67b35f326cfdea48b2/Source/WebCore/html/parser/HTMLSrcsetParser.cpp#L266"><code>HTML<wbr/>Srcset<wbr/>Parser.cpp<wbr/>#L266</code></a>.</p>
<p>All in all, given the browser algorithms, every image source is evaluated, and the order in <code>srcset</code> doesn’t affect the choice. Do keep in mind that only the first item for each particular density (be it declared density or effective density) is kept, and any duplicates are pruned.</p>
<p>As far as I can tell, browsers aren’t currently applying any of the sophisticated decision-making envisioned by the <abbr>HTML</abbr> Standard. An image density close to the current <abbr>DPR</abbr> is always favored.</p>
<p>With the exception of Firefox, which responds to zooming, browsers stick to their choice of image source throughout the page session. Pinch-zooming does not affect <abbr>DPR</abbr> in any browser, so raster images don’t get magically enhanced if you pinch into them (this is <a href="https://drafts.csswg.org/cssom-view/#dom-window-devicepixelratio">by design</a>).</p>
<h3>Width descriptors in <code>srcset</code></h3>
<figure>
	<img srcset="
		/demos/responsive-images/placeholders/300x200.png 300w,
		/demos/responsive-images/placeholders/600x400.png 600w,
		/demos/responsive-images/placeholders/900x600.png 900w,
		/demos/responsive-images/placeholders/1200x800.png 1200w,
		/demos/responsive-images/placeholders/1500x1000.png 1500w,
		/demos/responsive-images/placeholders/1800x1200.png 1800w,
		/demos/responsive-images/placeholders/2100x1400.png 2100w,
		/demos/responsive-images/placeholders/2400x1600.png 2400w,
		/demos/responsive-images/placeholders/2700x1800.png 2700w,
		/demos/responsive-images/placeholders/3000x2000.png 3000w" alt="A placeholder image displaying its size, as chosen by the browser"/>	
<figcaption>
<p>The image above uses several image sources with the same aspect ratio but different scales, labeled and declared with width descriptors ranging from <code>300w</code> to <code>3000w</code> in the <code>srcset</code>. The declared layout width of the image is <code>sizes=&#34;100vw&#34;</code>. This shows us which image source the browser picks.</p>
<p>(<strong>Note:</strong> To make it fit in the article’s layout, the image is made responsive with <code>max-width: 100%; height: auto</code>. Open the test in a separate tab to evaluate more accurately: <a href="https://danburzo.ro/demos/responsive-images/width.html">Test: image width selection</a>)</p>
</figcaption>
</figure>
<p>When using width descriptors in <code>srcset</code>, we expect the browser to factor in the <code>sizes</code> attribute (here having a value of <code>100vw</code>) to compute density descriptors that update along with the viewport. It’s no surprise then that browsers behave more or less like with density descriptors, with the added benefit that the image sources get re-evaluated more often.</p>
<p><strong>Firefox.</strong> Resizing the browser window causes the browser to choose the image with the appropriate effective density at any given moment. Zooming in and out of the page re-evaluates things but generally doesn’t produce any effect: while the size of the <abbr>CSS</abbr> pixel increases (and with it, the <abbr>DPR</abbr>), <code>100vw</code> evaluates to fewer <abbr>CSS</abbr> pixels, which results in more or less constant image density throughout.</p>
<p><strong>Chrome.</strong> Like in Firefox, resizing the browser window causes the browser to re-evaluate the image sources based on their effective density. As seen with the density descriptor test, Chrome caches the images it fetches and always uses the densest available. Once fetched for a large viewport, a dense image will be used even as you shrink the viewport.</p>
<p><strong>Safari</strong> is the most conservative about fetching other images. With <code>sizes=&#34;100vw&#34;</code>, the image source is evaluated once on page load, and resizing the browser window has no effect. With an attribute that contains media conditions, such as <code>sizes=&#34;(max-width: 400px) 25vw, (max-width: 800px) 50vw, 100vw&#34;</code>, it re-evaluates the image sources once a different size applies.</p>
<p>Safari’s approach means <code>sizes=&#34;100vw&#34;</code> does not make an image fluid like in the other browsers, which update the density-corrected natural dimensions after each resize. The dimensions are only computed once, when the source is first rendered.</p>
<h2>Conclusion</h2>
<p>I haven’t included more elaborate browser tests because they make my brain hurt, but we’ve hopefully made sense of how <abbr>HTML</abbr> responsive images are specified to work and got a glimpse of how current browsers choose image sources.</p>
<p>Some further readings:</p>
<ul>
<li><a href="https://web.dev/learn/images/">Learn images</a> by Mat Marquis</li>
<li><a href="https://ericportis.com/posts/2014/srcset-sizes/">Srcset and sizes</a> (2014) by Eric Portis</li>
<li><a href="https://cloudfour.com/thinks/responsive-images-101-definitions/">Responsive Images 101</a> (2015), a ten-part series (and <a href="https://cloudfour.com/thinks/announcing-our-new-ebook-responsive-images-101/">book</a>) by Jason Grigsby</li>
</ul>

</article>

</div></div>
  </body>
</html>
