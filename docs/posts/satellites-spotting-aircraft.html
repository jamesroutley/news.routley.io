<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.marksblogg.com/ai-sar-satellites-umbra-aircraft-detection.html">Original</a>
    <h1>Satellites Spotting Aircraft</h1>
    
    <div id="readability-page-1" class="page"><div id="article_text">
            <p>Umbra Space is a 9-year-old manufacturer and operator of a Synthetic Aperture Radar (SAR) satellite fleet. These satellites can see through clouds, smoke, rain, snow and certain types of camouflage attempting to cover the ground below. SAR can capture images day or night at resolutions as fine as 16cm. SpaceX launched Umbra&#39;s first satellite in 2021 and has a total of ten in orbit at the moment.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra_satellite.jpg"><img alt="Umbras Satellite" src="https://tech.marksblogg.com/theme/images/umbra_satellite.jpg"/></a></p><p>SAR collects images via radar waves rather than optically. The resolution of the resulting imagery can be improved the longer a point is captured as the satellite flies over the Earth. This also means video is possible as shown with this SAR imagery from another provider below.</p>
<p><a href="https://www.youtube.com/watch?v=cwDjJqtx_og"><img alt="Umbras Satellite Tasking" src="https://tech.marksblogg.com/theme/images/sar_video.gif"/></a></p><p>Umbra has an open data programme where they share SAR imagery from 500+ locations around the world. The points on the map below are coloured based on the satellite that captured the imagery.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra_open_data_locations.jpg"><img alt="Umbras Open Data Locations" src="https://tech.marksblogg.com/theme/images/umbra_open_data_locations.jpg"/></a></p><p>The subject matter largely focuses on manufacturing plants, airports, spaceports, large infrastructure projects and volcanos. Umbra state that the imagery being offered for free in their open data programme would have otherwise cost $4M to purchase.</p>
<p>Included in this feed are 140+ images of Bangkok Airport (BKK) that have been taken over the past two years. The image below links to the video I posted on LinkedIn.</p>
<p><a href="https://www.linkedin.com/posts/marklitwintschik_the-past-18-months-of-bangkoks-suvarnabhumi-activity-7217855129687887872-2cJN?utm_source=share&amp;utm_medium=member_desktop"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/bkk.gif"/></a></p><div id="aircraft-in-sar-imagery">
<h2>Aircraft in SAR Imagery</h2>
<p>Aircraft at known airports transmitting ADS-B messages do a good job of telling the world where they are. <a href="https://umbra.space/pricing/">Paying ~$5K</a> for this sort of SAR imagery doesn&#39;t make a lot of sense. But aircraft that have turned their ADS-B transponders off and are parked on a public highway are a different matter.</p>
<p><a href="https://www.youtube.com/watch?v=5iE8TPwCocM"><img alt="F-35A on a highway in Finland" src="https://tech.marksblogg.com/theme/images/umbra-msfa/brave_VHRUVysRRU.jpg"/></a></p><p>To add to this, it&#39;s rare in Northern Europe to have a clear sky regardless of the time of year. Clouds can be a real challenge here.</p>
<p>That said, some aircraft can be difficult to spot in SAR imagery. Below is Esri&#39;s satellite image of an Aircraft Boneyard.</p>
<p><a href="https://tech.marksblogg.com/theme/images/esri_aircraft_boneward.jpg"><img alt="Esri&#39;s Image of an Aircraft Boneyard" src="https://tech.marksblogg.com/theme/images/esri_aircraft_boneward.jpg"/></a></p><p>Below is Umbra&#39;s image of the same location. Though it was taken on a different day and some aircraft might have been moved around, you can see that a lot of the aircraft in the bottom left are barely visible unless you zoom in very closely and pay attention to artefacts that give away a large man-made object is present.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra_aircraft_boneward.jpg"><img alt="Umbras SAR Image of an Aircraft Boneyard" src="https://tech.marksblogg.com/theme/images/umbra_aircraft_boneward.jpg"/></a>
</p></div>
<div id="sardet-100k-msfa">
<h2>SARDet-100K &amp; MSFA</h2>
<p>In March, a <a href="https://arxiv.org/abs/2403.06534">paper</a> was published titled &#34;SARDet-100K: Towards Open-Source Benchmark and ToolKit for Large-Scale SAR Object Detection&#34;. It describes a new dataset called SARDet-100K and the Multi-Stage with Filter Augmentation (MSFA) framework for detecting objects in SAR imagery.</p>
<p>The dataset is made up of 117K SAR images with 246K objects annotated within them. These were sourced from ten existing datasets. The annotations highlight aircraft, bridges, cars, harbours, ships and tanks.</p>
<p>The framework tries to bridge the gap between RGB and SAR imagery. There are also several tools to help reduce multiplicative speckle noise and artefacts in SAR imagery.</p>
<p>In this post, I&#39;ll try to detect aircraft in Umbra&#39;s imagery using SARDet-100K and MSFA.</p>
</div>
<div id="my-workstation">
<h2>My Workstation</h2>
<p>I&#39;m using a 6 GHz Intel Core <a href="https://www.intel.com/content/www/us/en/products/sku/236773/intel-core-i9-processor-14900k-36m-cache-up-to-6-00-ghz/specifications.html">i9-14900K</a> CPU. It has 8 performance cores and 16 efficiency cores with a total of 32 threads and 32 MB of L2 cache. It has a liquid cooler attached and is housed in a spacious, full-sized, Cooler Master HAF 700 computer case. I&#39;ve come across videos on YouTube where people have managed to overclock the i9-14900KF to <a href="https://www.youtube.com/watch?v=fb7pl7PZOYo">9.1 GHz</a>.</p>
<p>The system has 96 GB of DDR5 RAM clocked at 6,000 MT/s and a 5th-generation, Crucial T700 4 TB NVMe M.2 SSD which can read at speeds up to 12,400 MB/s. There is a heatsink on the SSD to help keep its temperature down. This is my system&#39;s C drive.</p>
<p>The system is powered by a 1,200-watt, fully modular, Corsair Power Supply and is sat on an ASRock Z790 Pro RS Motherboard.</p>
<p>I&#39;m running Ubuntu 22 LTS via Microsoft&#39;s Ubuntu for Windows on Windows 11 Pro. In case you&#39;re wondering why I don&#39;t run a Linux-based desktop as my primary work environment, I&#39;m still using an Nvidia GTX 1080 GPU which has better driver support on Windows and I use ArcGIS Pro from time to time which only supports Windows natively.</p>
</div>
<div id="installing-prerequisites">
<h2>Installing Prerequisites</h2>
<p>I&#39;ll be using Python and a few other tools to help analyse the data in this post.</p>
<div><pre><span></span>$<span> </span>sudo<span> </span>apt<span> </span>update
$<span> </span>sudo<span> </span>apt<span> </span>install<span> </span><span>\</span>
<span>    </span>aws-cli<span> </span><span>\</span>
<span>    </span>gdal-bin<span> </span><span>\</span>
<span>    </span>jq<span> </span><span>\</span>
<span>    </span>python3-pip<span> </span><span>\</span>
<span>    </span>python3-virtualenv
</pre></div>
<p>I&#39;ll set up a Python Virtual Environment and install some dependencies.</p>
<div><pre><span></span>$<span> </span>virtualenv<span> </span>~/.msfa
$<span> </span><span>source</span><span> </span>~/.msfa/bin/activate

$<span> </span>pip<span> </span>install<span> </span><span>\</span>
<span>    </span>boto3<span> </span><span>\</span>
<span>    </span>geopandas<span> </span><span>\</span>
<span>    </span>osgeo<span> </span><span>\</span>
<span>    </span>pandas<span> </span><span>\</span>
<span>    </span>rich<span> </span><span>\</span>
<span>    </span>shapely<span> </span><span>\</span>
<span>    </span>typer
</pre></div>
<p>The following will install some PyTorch dependencies.</p>
<div><pre><span></span>$<span> </span>pip<span> </span>install<span> </span><span>\</span>
<span>    </span><span>torch</span><span>==</span><span>2</span>.0.1<span> </span><span>\</span>
<span>    </span><span>torchvision</span><span>==</span><span>0</span>.15.2<span> </span><span>\</span>
<span>    </span><span>torchaudio</span><span>==</span><span>2</span>.0.2<span> </span><span>\</span>
<span>    </span>--index-url<span> </span>https://download.pytorch.org/whl/cu118
</pre></div>
<p>MSFA relies on a number of OpenMMLab packages.</p>
<div><pre><span></span>$<span> </span>pip<span> </span>install<span> </span>-U<span> </span>openmim
$<span> </span>mim<span> </span>install<span> </span>-U<span> </span><span>\</span>
<span>    </span>mmengine<span> </span><span>\</span>
<span>    </span>mmcv<span> </span><span>\</span>
<span>    </span>mmdet<span> </span><span>\</span>
<span>    </span>mmpretrain
</pre></div>
<p>The following will install the MSFA Framework.</p>
<div><pre><span></span>$<span> </span>git<span> </span>clone<span> </span>https://github.com/zcablii/SARDet_100K
$<span> </span><span>cd</span><span> </span>SARDet_100K/MSFA

$<span> </span>pip<span> </span>install<span> </span>-r<span> </span>requirements.txt
$<span> </span>pip<span> </span>install<span> </span>-v<span> </span>-e<span> </span>.
</pre></div>
<p>I had some issues with SciPy 1.14.1 so I&#39;ve downgraded to version 1.12.0.</p>
<div><pre><span></span>$<span> </span>pip<span> </span>install<span> </span>-U<span> </span><span>&#39;scipy&lt;1.13&#39;</span>
</pre></div>
<p>I&#39;ll use DuckDB, along with its <a href="https://github.com/isaacbrodsky/h3-duckdb">H3</a>, <a href="https://duckdb.org/docs/extensions/json">JSON</a>, <a href="https://duckdb.org/docs/data/parquet/overview">Parquet</a> and <a href="https://duckdb.org/docs/extensions/spatial.html">Spatial</a> extensions, in this post.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~
$<span> </span>wget<span> </span>-c<span> </span>https://github.com/duckdb/duckdb/releases/download/v1.0.0/duckdb_cli-linux-amd64.zip
$<span> </span>unzip<span> </span>-j<span> </span>duckdb_cli-linux-amd64.zip
$<span> </span>chmod<span> </span>+x<span> </span>duckdb
$<span> </span>~/duckdb
</pre></div>
<div><pre><span></span><span>INSTALL</span><span> </span><span>h3</span><span> </span><span>FROM</span><span> </span><span>community</span><span>;</span>
<span>INSTALL</span><span> </span><span>json</span><span>;</span>
<span>INSTALL</span><span> </span><span>parquet</span><span>;</span>
<span>INSTALL</span><span> </span><span>spatial</span><span>;</span>
</pre></div>
<p>I&#39;ll set up DuckDB to load every installed extension each time it launches.</p>

<div><pre><span></span>.timer on
.width 180
LOAD h3;
LOAD json;
LOAD parquet;
LOAD spatial;
</pre></div>
<p>The maps in this post were rendered with <a href="https://www.qgis.org/en/site/forusers/download.html">QGIS</a> version 3.38.0. QGIS is a desktop application that runs on Windows, macOS and Linux. The application has grown in popularity in recent years and has ~15M application launches from users around the world each month.</p>
<p>I used QGIS&#39; <a href="https://geoinformaticsworld.com/how-to-download-and-install-google-earth-images-in-qgis-using-tiles-plugin/">Tile+ plugin</a> to add geospatial context with Esri&#39;s World Imagery and CARTO&#39;s Basemaps to the maps.</p>
</div>
<div id="downloading-satellite-imagery">
<h2>Downloading Satellite Imagery</h2>
<p>Umbra&#39;s Open Data feed has grown to just under 45 TB as of this writing.</p>
<div><pre><span></span>$<span> </span>mkdir<span> </span>-p<span> </span>~/umbra_bkk
$<span> </span><span>cd</span><span> </span>~/umbra_bkk

$<span> </span>aws<span> </span>--no-sign-request<span> </span><span>\</span>
<span>      </span>--output<span> </span>json<span> </span><span>\</span>
<span>      </span>s3api<span> </span><span>\</span>
<span>      </span>list-objects<span> </span><span>\</span>
<span>      </span>--bucket<span> </span>umbra-open-data-catalog<span> </span><span>\</span>
<span>      </span>--max-items<span>=</span><span>1000000</span><span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>jq<span> </span>-c<span> </span><span>&#39;.Contents[]&#39;</span><span> </span><span>\</span>
<span>    </span>&gt;<span> </span>umbra.s3.json
</pre></div>
<div><pre><span></span>$<span> </span><span>echo</span><span> </span><span>&#34;Total objects: &#34;</span><span> </span><span>`</span>wc<span> </span>-l<span> </span>umbra.s3.json<span> </span><span>|</span><span> </span>cut<span> </span>-d<span>&#39; &#39;</span><span> </span>-f1<span>`</span>,<span> </span><span>\</span>
<span>   </span><span>&#34; TB: &#34;</span><span> </span><span>`</span>jq<span> </span>.Size<span> </span>umbra.s3.json<span> </span><span>|</span><span> </span>awk<span> </span><span>&#39;{s+=$1}END{print s/1024/1024/1024/1024}&#39;</span><span>`</span>
</pre></div>
<div><pre><span></span>Total objects:  33813,  TB:  44.9067
</pre></div>
<p>I&#39;ll download the GeoTIFF deliverables and JSON Metadata files for Bangkok Airport. These add up to ~35 GB in size.</p>
<div><pre><span></span>$<span> </span><span>for</span><span> </span>FORMAT<span> </span><span>in</span><span> </span>json<span> </span>tif<span>;</span><span> </span><span>do</span>
<span>    </span>aws<span> </span>s3<span> </span>--no-sign-request<span> </span><span>\</span>
<span>           </span>sync<span> </span><span>\</span>
<span>           </span>--exclude<span>=</span><span>&#34;*&#34;</span><span> </span><span>\</span>
<span>           </span>--include<span>=</span><span>&#34;*.</span><span>$FORMAT</span><span>&#34;</span><span> </span><span>\</span>
<span>           </span><span>&#34;s3://umbra-open-data-catalog/sar-data/tasks/Suvarnabhumi International Airport, Thailand/&#34;</span><span> </span><span>\</span>
<span>           </span>~/umbra_bkk/
<span>  </span><span>done</span>
</pre></div>
</div>
<div id="umbra-s-bangkok-airport-imagery">
<h2>Umbra&#39;s Bangkok Airport Imagery</h2>
<p>The 140+ images taken of BKK airport all have a footprint 5 x 5KM. That said, the footprints all cover slightly different areas. Below is a rendering of the footprints over the two year period.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/footprints.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/footprints.jpg"/></a></p><p>I&#39;ll extract some metadata of interest and load it into a DuckDB table.</p>
<div><pre><span></span>$<span> </span><span>cd</span><span> </span>~/umbra_bkk
$<span> </span>python3
</pre></div>
<div><pre><span></span><span>import</span> <span>json</span>
<span>from</span>   <span>pathlib</span>        <span>import</span> <span>Path</span>

<span>from</span>   <span>rich.progress</span> <span>import</span> <span>track</span>


<span>with</span> <span>open</span><span>(</span><span>&#39;enriched.json&#39;</span><span>,</span> <span>&#39;w&#39;</span><span>)</span> <span>as</span> <span>f</span><span>:</span>
    <span>for</span> <span>filename</span> <span>in</span> <span>track</span><span>(</span><span>list</span><span>(</span><span>Path</span><span>(</span><span>&#39;.&#39;</span><span>)</span><span>.</span><span>glob</span><span>(</span><span>&#39;**/*_METADATA.json&#39;</span><span>))):</span>
        <span>rec</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>open</span><span>(</span><span>filename</span><span>,</span> <span>&#39;r&#39;</span><span>)</span><span>.</span><span>read</span><span>())</span>

        <span>out</span> <span>=</span> <span>{</span><span>&#39;filename&#39;</span><span>:</span>       <span>str</span><span>(</span><span>filename</span><span>),</span>
               <span>&#39;sat_num&#39;</span><span>:</span>        <span>rec</span><span>[</span><span>&#39;umbraSatelliteName&#39;</span><span>],</span>
               <span>&#39;imaging_mode&#39;</span><span>:</span>   <span>rec</span><span>[</span><span>&#39;imagingMode&#39;</span><span>],</span>
               <span>&#39;polarisation&#39;</span><span>:</span>   <span>&#39;, &#39;</span><span>.</span><span>join</span><span>(</span><span>sorted</span><span>(</span><span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;polarizations&#39;</span><span>])),</span>
               <span>&#39;start&#39;</span><span>:</span>          <span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;startAtUTC&#39;</span><span>],</span>
               <span>&#39;finish&#39;</span><span>:</span>         <span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;endAtUTC&#39;</span><span>],</span>
               <span>&#39;radarBand&#39;</span><span>:</span>      <span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;radarBand&#39;</span><span>],</span>
               <span>&#39;azimuth_meters&#39;</span><span>:</span> <span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;maxGroundResolution&#39;</span><span>][</span><span>&#39;azimuthMeters&#39;</span><span>],</span>
               <span>&#39;range_meters&#39;</span><span>:</span>   <span>rec</span><span>[</span><span>&#39;collects&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;maxGroundResolution&#39;</span><span>][</span><span>&#39;rangeMeters&#39;</span><span>],</span>
               <span>&#39;azimuth_looks&#39;</span><span>:</span>  <span>rec</span><span>[</span><span>&#39;derivedProducts&#39;</span><span>][</span><span>&#39;GEC&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;looks&#39;</span><span>][</span><span>&#39;azimuth&#39;</span><span>],</span>
               <span>&#39;range_looks&#39;</span><span>:</span>    <span>rec</span><span>[</span><span>&#39;derivedProducts&#39;</span><span>][</span><span>&#39;GEC&#39;</span><span>][</span><span>0</span><span>][</span><span>&#39;looks&#39;</span><span>][</span><span>&#39;range&#39;</span><span>]}</span>

        <span>f</span><span>.</span><span>write</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>out</span><span>,</span> <span>sort_keys</span><span>=</span><span>True</span><span>)</span> <span>+</span> <span>&#39;</span><span>\n</span><span>&#39;</span><span>)</span>
</pre></div>

<div><pre><span></span><span>CREATE</span><span> </span><span>OR</span><span> </span><span>REPLACE</span><span> </span><span>TABLE</span><span> </span><span>umbra</span><span> </span><span>AS</span>
<span>    </span><span>SELECT</span><span> </span><span>*</span><span> </span><span>EXCLUDE</span><span>(</span><span>start</span><span>,</span><span> </span><span>finish</span><span>),</span>
<span>           </span><span>start</span><span>::</span><span>DATETIME</span><span> </span><span>AS</span><span> </span><span>start</span><span>,</span>
<span>           </span><span>finish</span><span>::</span><span>DATETIME</span><span> </span><span>AS</span><span> </span><span>finish</span>
<span>    </span><span>FROM</span><span>   </span><span>READ_JSON</span><span>(</span><span>&#39;enriched.json&#39;</span><span>);</span>
</pre></div>
<p>Below are the number of images for each month and the satellite that took them.</p>
<div><pre><span></span><span>WITH</span><span> </span><span>a</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>    </span><span>SELECT</span><span> </span><span>STRFTIME</span><span>(</span><span>start</span><span>,</span><span> </span><span>&#39;%Y-%m&#39;</span><span>)</span><span> </span><span>yyyy_mm</span><span>,</span>
<span>           </span><span>sat_num</span><span>,</span>
<span>           </span><span>count</span><span>(</span><span>*</span><span>)</span><span> </span><span>num_recs</span>
<span>    </span><span>FROM</span><span> </span><span>umbra</span>
<span>    </span><span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span><span>,</span><span> </span><span>2</span>
<span>    </span><span>ORDER</span><span> </span><span>BY</span><span> </span><span>1</span><span>,</span><span> </span><span>2</span>
<span>)</span>
<span>PIVOT</span><span>    </span><span>a</span>
<span>ON</span><span>       </span><span>sat_num</span>
<span>USING</span><span>    </span><span>SUM</span><span>(</span><span>num_recs</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>yyyy_mm</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>yyyy_mm</span><span>;</span>
</pre></div>
<div><pre><span></span>┌─────────┬──────────┬──────────┬──────────┬──────────┐
│ yyyy_mm │ UMBRA_04 │ UMBRA_05 │ UMBRA_06 │ UMBRA_08 │
│ varchar │  int128  │  int128  │  int128  │  int128  │
├─────────┼──────────┼──────────┼──────────┼──────────┤
│ 2023-02 │        7 │        5 │          │          │
│ 2023-03 │        6 │        5 │          │          │
│ 2023-04 │        8 │        7 │          │          │
│ 2023-05 │        5 │        6 │          │          │
│ 2023-06 │        3 │       10 │        6 │          │
│ 2023-07 │        4 │        7 │        2 │          │
│ 2023-08 │        6 │        8 │          │          │
│ 2023-09 │        4 │        3 │          │          │
│ 2023-10 │        3 │        4 │          │          │
│ 2023-11 │        4 │        2 │          │          │
│ 2024-01 │        1 │        3 │        4 │          │
│ 2024-02 │          │        3 │        6 │          │
│ 2024-03 │        2 │        1 │          │        1 │
│ 2024-05 │          │        1 │        2 │          │
│ 2024-06 │          │        1 │          │          │
│ 2024-07 │          │          │        1 │          │
│ 2024-08 │          │        1 │          │          │
├─────────┴──────────┴──────────┴──────────┴──────────┤
│ 17 rows                                   5 columns │
└─────────────────────────────────────────────────────┘
</pre></div>
<p>All of the images have the same polarisation and use the X radar band.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>imaging_mode</span><span>,</span>
<span>         </span><span>polarisation</span><span>,</span>
<span>         </span><span>radarBand</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>FROM</span><span>     </span><span>umbra</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>3</span><span>;</span>
</pre></div>
<div><pre><span></span>┌──────────────┬──────────────┬───────────┬──────────────┐
│ imaging_mode │ polarisation │ radarBand │ count_star() │
│   varchar    │   varchar    │  varchar  │    int64     │
├──────────────┼──────────────┼───────────┼──────────────┤
│ SPOTLIGHT    │ VV           │ X         │          142 │
└──────────────┴──────────────┴───────────┴──────────────┘
</pre></div>
<p>The highest resolution imagery in this dataset is 17.48 cm.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>sat_num</span><span>,</span>
<span>         </span><span>ROUND</span><span>(</span><span>MIN</span><span>(</span><span>azimuth_meters</span><span> </span><span>*</span><span> </span><span>100</span><span>),</span><span> </span><span>2</span><span>)</span><span> </span><span>AS</span><span> </span><span>cm_res</span><span>,</span>
<span>FROM</span><span>     </span><span>umbra</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>2</span>
</pre></div>
<div><pre><span></span>┌──────────┬────────┐
│ sat_num  │ cm_res │
│ varchar  │ double │
├──────────┼────────┤
│ UMBRA_06 │  17.48 │
│ UMBRA_05 │  17.73 │
│ UMBRA_08 │   25.0 │
│ UMBRA_04 │   25.0 │
└──────────┴────────┘
</pre></div>
<p>Below are the resolution buckets for each satellite.</p>
<div><pre><span></span><span>WITH</span><span> </span><span>a</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>    </span><span>SELECT</span><span> </span><span>(</span><span>ROUND</span><span>(</span><span>ROUND</span><span>(</span><span>azimuth_meters</span><span> </span><span>*</span><span> </span><span>100</span><span>)</span><span> </span><span>/</span><span> </span><span>10</span><span>)</span><span> </span><span>*</span><span> </span><span>10</span><span>)::</span><span>INT</span><span> </span><span>AS</span><span> </span><span>cm_res</span><span>,</span>
<span>           </span><span>sat_num</span>
<span>    </span><span>FROM</span><span>   </span><span>umbra</span>
<span>)</span>
<span>PIVOT</span><span>    </span><span>a</span>
<span>ON</span><span>       </span><span>sat_num</span>
<span>USING</span><span>    </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>cm_res</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>cm_res</span><span>;</span>
</pre></div>
<div><pre><span></span>┌────────┬──────────┬──────────┬──────────┬──────────┐
│ cm_res │ UMBRA_04 │ UMBRA_05 │ UMBRA_06 │ UMBRA_08 │
│ int32  │  int64   │  int64   │  int64   │  int64   │
├────────┼──────────┼──────────┼──────────┼──────────┤
│     20 │        0 │        4 │        6 │        0 │
│     30 │        2 │        5 │        7 │        1 │
│     40 │        8 │        8 │        4 │        0 │
│     50 │       34 │       36 │        1 │        0 │
│     60 │        7 │       13 │        3 │        0 │
│     70 │        2 │        1 │        0 │        0 │
└────────┴──────────┴──────────┴──────────┴──────────┘
</pre></div>
<p>The majority of imagery only had one look but there are a few 2 and 3-look images in this dataset as well.</p>
<div><pre><span></span><span>SELECT</span><span>   </span><span>ROUND</span><span>(</span><span>azimuth_looks</span><span>)::</span><span>INT</span><span> </span><span>as</span><span> </span><span>looks</span><span>,</span>
<span>         </span><span>COUNT</span><span>(</span><span>*</span><span>)</span><span> </span><span>num_images</span>
<span>FROM</span><span>     </span><span>umbra</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>1</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>1</span><span>;</span>
</pre></div>
<div><pre><span></span>┌───────┬────────────┐
│ looks │ num_images │
│ int32 │   int64    │
├───────┼────────────┤
│     1 │        119 │
│     2 │         21 │
│     3 │          2 │
└───────┴────────────┘
</pre></div>
<p>The number of looks correlates with a higher resolution.</p>
<div><pre><span></span><span>WITH</span><span> </span><span>a</span><span> </span><span>AS</span><span> </span><span>(</span>
<span>    </span><span>SELECT</span><span> </span><span>(</span><span>ROUND</span><span>(</span><span>ROUND</span><span>(</span><span>azimuth_meters</span><span> </span><span>*</span><span> </span><span>100</span><span>)</span><span> </span><span>/</span><span> </span><span>10</span><span>)</span><span> </span><span>*</span><span> </span><span>10</span><span>)::</span><span>INT</span><span> </span><span>AS</span><span> </span><span>cm_res</span><span>,</span>
<span>           </span><span>ROUND</span><span>(</span><span>azimuth_looks</span><span>)::</span><span>INT</span><span> </span><span>AS</span><span> </span><span>looks</span>
<span>    </span><span>FROM</span><span>   </span><span>umbra</span>
<span>)</span>
<span>PIVOT</span><span>    </span><span>a</span>
<span>ON</span><span>       </span><span>looks</span>
<span>USING</span><span>    </span><span>COUNT</span><span>(</span><span>*</span><span>)</span>
<span>GROUP</span><span> </span><span>BY</span><span> </span><span>cm_res</span>
<span>ORDER</span><span> </span><span>BY</span><span> </span><span>cm_res</span><span>;</span>
</pre></div>
<div><pre><span></span>┌────────┬───────┬───────┬───────┐
│ cm_res │   1   │   2   │   3   │
│ int32  │ int64 │ int64 │ int64 │
├────────┼───────┼───────┼───────┤
│     20 │     0 │     8 │     2 │
│     30 │     2 │    13 │     0 │
│     40 │    20 │     0 │     0 │
│     50 │    71 │     0 │     0 │
│     60 │    23 │     0 │     0 │
│     70 │     3 │     0 │     0 │
└────────┴───────┴───────┴───────┘
</pre></div>
</div>
<div id="downloading-sardet-100k-weights">
<h2>Downloading SARDet_100K Weights</h2>
<p>SARDet_100K hosts their model weights on Baidu Disk and <a href="https://liveuclac-my.sharepoint.com/:f:/g/personal/zcablii_ucl_ac_uk/EsCsvTBzlGlJkQogQ2_svKcB9K-0LXfgZPoUJBySPP2L5g?e=RsL0VA">OneDrive</a>. The ZIP file with the weights is 20 GB. Below are its contents.</p>
<div><pre><span></span>$<span> </span>du<span> </span>-hs<span> </span>/home/mark/ckpts/*<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>grep<span> </span><span>&#39;[0-9][MG]&#39;</span><span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>cut<span> </span>-d/<span> </span>-f1,5<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>sed<span> </span><span>&#39;s/\///g&#39;</span>
</pre></div>
<div><pre><span></span>1.1G    convnext_b_sar
1.1G    convnext_b_sar_wavelet
598M    convnext_s_sar
603M    convnext_s_sar_wavelet
339M    convnext_t_sar
344M    convnext_t_sar_wavelet
457M    fg_frcnn_dota_pretrain_sar_convnext_b_wavelet
228M    fg_frcnn_dota_pretrain_sar_convnext_t_wavelet
287M    fg_frcnn_dota_pretrain_sar_r101_wavelet
346M    fg_frcnn_dota_pretrain_sar_r152_wavelet
308M    fg_frcnn_dota_pretrain_sar_swin_s_wavelet
227M    fg_frcnn_dota_pretrain_sar_swin_t_wavelet
222M    fg_frcnn_dota_pretrain_sar_van_b_wavelet
173M    fg_frcnn_dota_pretrain_sar_van_s_wavelet
135M    fg_frcnn_dota_pretrain_sar_van_t_wavelet
214M    fg_frcnn_dota_pretrain_sar_wavelet_r50
2.2G    gfl_r50_denodet_sardet
210M    hrsid_frcnn_van_sar_wavelet_bs32_3
481M    pretrain_frcnn_dota_convnext_b_sar_wavelet
335M    pretrain_frcnn_dota_convnext_s_sar_wavelet
2.3G    pretrain_frcnn_dota_r101_sar
312M    pretrain_frcnn_dota_r101_sar_wavelet
372M    pretrain_frcnn_dota_r152_sar_wavelet
239M    pretrain_frcnn_dota_r50_sar_wavelet
333M    pretrain_frcnn_dota_swin_s_sar_wavelet
251M    pretrain_frcnn_dota_swin_t_sar_wavelet
246M    pretrain_frcnn_dota_van_b_sar_wavelet
197M    pretrain_frcnn_dota_van_s_sar_wavelet
160M    pretrain_frcnn_dota_van_t_sar_wavelet
377M    r101_sar_epoch_100.pth
382M    r101_sar_wavelet_epoch_100.pth
502M    r152_sar_wavelet
231M    r50_sar_epoch_100.pth
237M    r50_sar_wavelet_epoch_100.pth
210M    ssdd_frcnn_van_sar_wavelet_bs32_3
1.1G    swin_b_sar
596M    swin_s_sar
601M    swin_s_sar_wavelet
351M    swin_t_sar
356M    swin_t_sar_wavelet
338M    van_b_sar_wavelet_epoch_100.pth
173M    van_s_sar_epoch_100.pth
179M    van_s_sar_wavelet_epoch_100.pth
61M     van_t_sar_epoch_100.pth
66M     van_t_sar_wavelet_epoch_100.pth
</pre></div>
</div>
<div id="sar-aircraft-training-data">
<h2>SAR Aircraft Training Data</h2>
<p>Three of the ten datasets in SARDet_100K contain aircraft imagery.</p>
<div><pre><span></span>Datasets       | Objects     | Resolution | Band    | Polarization    | Satellites
---------------|-------------|------------|---------|-----------------|------------------------------
MSAR           | A, T, B, S  | ≤ 1m       | C       | HH, HV, VH, VV  | HISEA-1
SADD           | A           | 0.5-3m     | X       | HH              | TerraSAR-X
SAR-AIRcraft   | A           | 1m         | C       | Uni-polar       | GF-3
AIR_SARShip    | S           | 1,3m       | C       | VV              | GF-3
HRSID          | S           | 0.5-3m     | C/X     | HH, HV, VH, VV  | S-1B, TerraSAR-X, TanDEMX
ShipDataset    | S           | 3-25m      | C       | HH, VV, VH, HV  | S-1, GF-3
SSDD           | S           | 1-15m      | C/X     | HH, VV, VH, HV  | S-1, RadarSat-2, TerraSAR-X
OGSOD          | B, H, T     | 3m         | C       | VV/VH           | GF-3
SIVED          | C           | 0.1,0.3m   | Ka,Ku,X | VV/HH           | Airborne SAR synthetic slice
</pre></div>
<p>The object acronyms are (A)ircraft, (B)ridges, (C)ars, (H)arbours, (S)hips and (T)anks.</p>
<p>The Umbra imagery in this post uses VV polarisation which some of the MSAR data used as well.</p>
<p>SAR radar beams can switch between horizontal and vertical polarisation both when sending and receiving. These are denoted by two letters. For example: HV would mean horizontal transmission and vertical receiving.</p>
<p>Horizontal polarisation is ideal for flat and low surfaces, like rivers, bridges and power lines. Vertical polarisation is ideal for buildings, rough seas and transmission towers.</p>
<p>The aircraft training imagery was collected using the X band in some cases but the C band in others. The X band is good for urban monitoring and seeing through snow but it can&#39;t penetrate vegetation very well. This might make aircraft under a natural canopy harder to detect. The Umbra imagery in this post was all collected with the X band.</p>
</div>
<div id="bangkok-suvarnabhumi-international-airport">
<h2>Bangkok Suvarnabhumi International Airport</h2>
<p>I&#39;ll walk through the layout of Bangkok Suvarnabhumi International Airport (BKK). I used GeoFabrik&#39;s OpenStreetMap (OSM) <a href="https://download.geofabrik.de/asia.html">distributable</a> for Thailand and <a href="https://tech.marksblogg.com/extracting-osm-features.html">osm_split</a> to extract the geometry and metadata in the following images.</p>
<p>There are aircraft parking gates south of the main passenger terminal and all around the satellite terminal.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_hGG17JrgKN.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_hGG17JrgKN.jpg"/></a></p><p>Below is a closer view of the parking spots around the main passenger terminal.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_QvcK1CZsAA.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_QvcK1CZsAA.jpg"/></a></p><p>Below is a closer view of the parking spots around the satellite terminal.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_jwGpNvaRCU.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_jwGpNvaRCU.jpg"/></a></p><p>I&#39;ve overlaid four hours of ADS-B data from the evening of May 25th on the map. This gives a bit of ground truth as to where aircraft were located around the time Umbra took their image for that day.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_wgGXmp0h3I.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_wgGXmp0h3I.jpg"/></a></p><p>The ADS-B data was sourced from the <a href="https://tech.marksblogg.com/global-flight-tracking-adsb.html">adsb.lol</a> project. I built a tool called <a href="https://github.com/marklit/adsb_json">adsb_json</a> that converts the JSON adsb.lol produces into GeoPackage (GPKG) files.</p>
</div>
<div id="deondet">
<h2>DeonDet</h2>
<p>I&#39;ll run DeonDet on Umbra&#39;s image of BKK for May 25th. Below is a configuration file that ships with MSFA.</p>
<div><pre><span></span>$<span> </span>cat<span> </span>~/SARDet_100K/MSFA/local_configs/DeonDet/gfl_r50_denodet_sardet.py
</pre></div>
<div><pre><span></span><span>_base_</span> <span>=</span> <span>[</span>
    <span>&#39;../../configs/_base_/datasets/SARDet_100k.py&#39;</span><span>,</span>
    <span>&#39;../../configs/_base_/schedules/schedule_1x.py&#39;</span><span>,</span> <span>&#39;../../configs/_base_/default_runtime.py&#39;</span>
<span>]</span>
<span>num_classes</span> <span>=</span> <span>6</span>
<span>model</span> <span>=</span> <span>dict</span><span>(</span>
    <span>type</span><span>=</span><span>&#39;GFL&#39;</span><span>,</span>
    <span>data_preprocessor</span><span>=</span><span>dict</span><span>(</span>
        <span>type</span><span>=</span><span>&#39;DetDataPreprocessor&#39;</span><span>,</span>
        <span>mean</span><span>=</span><span>[</span><span>123.675</span><span>,</span> <span>116.28</span><span>,</span> <span>103.53</span><span>],</span>
        <span>std</span><span>=</span><span>[</span><span>58.395</span><span>,</span> <span>57.12</span><span>,</span> <span>57.375</span><span>],</span>
        <span>bgr_to_rgb</span><span>=</span><span>True</span><span>,</span>
        <span>pad_size_divisor</span><span>=</span><span>32</span><span>),</span>
    <span>backbone</span><span>=</span><span>dict</span><span>(</span>
        <span>type</span><span>=</span><span>&#39;ResNet&#39;</span><span>,</span>
        <span>depth</span><span>=</span><span>50</span><span>,</span>
        <span>num_stages</span><span>=</span><span>4</span><span>,</span>
        <span>out_indices</span><span>=</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>),</span>
        <span>frozen_stages</span><span>=</span><span>1</span><span>,</span>
        <span>norm_cfg</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;BN&#39;</span><span>,</span> <span>requires_grad</span><span>=</span><span>True</span><span>),</span>
        <span>norm_eval</span><span>=</span><span>True</span><span>,</span>
        <span>style</span><span>=</span><span>&#39;pytorch&#39;</span><span>,</span>
        <span>init_cfg</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;Pretrained&#39;</span><span>,</span> <span>checkpoint</span><span>=</span><span>&#39;torchvision://resnet50&#39;</span><span>)),</span>
    <span>neck</span><span>=</span><span>dict</span><span>(</span>
        <span>type</span><span>=</span><span>&#39;FrequencySpatialFPN&#39;</span><span>,</span>
        <span>in_channels</span><span>=</span><span>[</span><span>256</span><span>,</span> <span>512</span><span>,</span> <span>1024</span><span>,</span> <span>2048</span><span>],</span>
        <span>out_channels</span><span>=</span><span>256</span><span>,</span>
        <span>start_level</span><span>=</span><span>1</span><span>,</span>
        <span>add_extra_convs</span><span>=</span><span>&#39;on_input&#39;</span><span>,</span>
        <span>num_outs</span><span>=</span><span>5</span><span>,</span>
        <span>norm_cfg</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;GN&#39;</span><span>,</span> <span>num_groups</span><span>=</span><span>32</span><span>,</span> <span>requires_grad</span><span>=</span><span>True</span><span>)),</span>
    <span>bbox_head</span><span>=</span><span>dict</span><span>(</span>
        <span>type</span><span>=</span><span>&#39;GFLHead&#39;</span><span>,</span>
        <span>num_classes</span><span>=</span><span>num_classes</span><span>,</span>
        <span>in_channels</span><span>=</span><span>256</span><span>,</span>
        <span>stacked_convs</span><span>=</span><span>4</span><span>,</span>
        <span>feat_channels</span><span>=</span><span>256</span><span>,</span>
        <span>anchor_generator</span><span>=</span><span>dict</span><span>(</span>
            <span>type</span><span>=</span><span>&#39;AnchorGenerator&#39;</span><span>,</span>
            <span>ratios</span><span>=</span><span>[</span><span>1.0</span><span>],</span>
            <span>octave_base_scale</span><span>=</span><span>8</span><span>,</span>
            <span>scales_per_octave</span><span>=</span><span>1</span><span>,</span>
            <span>strides</span><span>=</span><span>[</span><span>8</span><span>,</span> <span>16</span><span>,</span> <span>32</span><span>,</span> <span>64</span><span>,</span> <span>128</span><span>]),</span>
        <span>loss_cls</span><span>=</span><span>dict</span><span>(</span>
            <span>type</span><span>=</span><span>&#39;QualityFocalLoss&#39;</span><span>,</span>
            <span>use_sigmoid</span><span>=</span><span>True</span><span>,</span>
            <span>beta</span><span>=</span><span>2.0</span><span>,</span>
            <span>loss_weight</span><span>=</span><span>1.0</span><span>),</span>
        <span>loss_dfl</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;DistributionFocalLoss&#39;</span><span>,</span> <span>loss_weight</span><span>=</span><span>0.25</span><span>),</span>
        <span>reg_max</span><span>=</span><span>16</span><span>,</span>
        <span>loss_bbox</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;GIoULoss&#39;</span><span>,</span> <span>loss_weight</span><span>=</span><span>2.0</span><span>)),</span>
    <span># training and testing settings</span>
    <span>train_cfg</span><span>=</span><span>dict</span><span>(</span>
        <span>assigner</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;ATSSAssigner&#39;</span><span>,</span> <span>topk</span><span>=</span><span>9</span><span>),</span>
        <span>allowed_border</span><span>=-</span><span>1</span><span>,</span>
        <span>pos_weight</span><span>=-</span><span>1</span><span>,</span>
        <span>debug</span><span>=</span><span>False</span><span>),</span>
    <span>test_cfg</span><span>=</span><span>dict</span><span>(</span>
        <span>nms_pre</span><span>=</span><span>1000</span><span>,</span>
        <span>min_bbox_size</span><span>=</span><span>0</span><span>,</span>
        <span>score_thr</span><span>=</span><span>0.05</span><span>,</span>
        <span>nms</span><span>=</span><span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;nms&#39;</span><span>,</span> <span>iou_threshold</span><span>=</span><span>0.6</span><span>),</span>
        <span>max_per_img</span><span>=</span><span>100</span><span>))</span>


<span>backend_args</span> <span>=</span> <span>None</span>
<span>train_pipeline</span> <span>=</span> <span>[</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;LoadImageFromFile&#39;</span><span>,</span> <span>backend_args</span><span>=</span><span>backend_args</span><span>),</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;LoadAnnotations&#39;</span><span>,</span> <span>with_bbox</span><span>=</span><span>True</span><span>),</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;Resize&#39;</span><span>,</span> <span>scale</span><span>=</span><span>(</span><span>1024</span><span>,</span> <span>1024</span><span>),</span> <span>keep_ratio</span><span>=</span><span>False</span><span>),</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;RandomFlip&#39;</span><span>,</span> <span>prob</span><span>=</span><span>0.5</span><span>),</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;PackDetInputs&#39;</span><span>)</span>
<span>]</span>

<span>test_pipeline</span> <span>=</span> <span>[</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;LoadImageFromFile&#39;</span><span>,</span> <span>backend_args</span><span>=</span><span>backend_args</span><span>),</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;Resize&#39;</span><span>,</span> <span>scale</span><span>=</span><span>(</span><span>1024</span><span>,</span> <span>1024</span><span>),</span> <span>keep_ratio</span><span>=</span><span>False</span><span>),</span>
    <span># If you don&#39;t have a gt annotation, delete the pipeline</span>
    <span>dict</span><span>(</span><span>type</span><span>=</span><span>&#39;LoadAnnotations&#39;</span><span>,</span> <span>with_bbox</span><span>=</span><span>True</span><span>),</span>
    <span>dict</span><span>(</span>
        <span>type</span><span>=</span><span>&#39;PackDetInputs&#39;</span><span>,</span>
        <span>meta_keys</span><span>=</span><span>(</span><span>&#39;img_id&#39;</span><span>,</span> <span>&#39;img_path&#39;</span><span>,</span> <span>&#39;ori_shape&#39;</span><span>,</span> <span>&#39;img_shape&#39;</span><span>,</span>
                   <span>&#39;scale_factor&#39;</span><span>))</span>
<span>]</span>

<span>train_dataloader</span> <span>=</span> <span>dict</span><span>(</span>
    <span>dataset</span><span>=</span><span>dict</span><span>(</span>
        <span>pipeline</span><span>=</span><span>train_pipeline</span><span>))</span>
<span>val_dataloader</span> <span>=</span> <span>dict</span><span>(</span>
    <span>dataset</span><span>=</span><span>dict</span><span>(</span>
        <span>pipeline</span><span>=</span><span>test_pipeline</span><span>))</span>
<span>test_dataloader</span> <span>=</span> <span>dict</span><span>(</span>
    <span>dataset</span><span>=</span><span>dict</span><span>(</span>
        <span>pipeline</span><span>=</span><span>test_pipeline</span><span>))</span>


<span># find_unused_parameters = True</span>
<span>optim_wrapper</span> <span>=</span> <span>dict</span><span>(</span>
    <span>optimizer</span><span>=</span><span>dict</span><span>(</span>
        <span>_delete_</span><span>=</span><span>True</span><span>,</span>
        <span>betas</span><span>=</span><span>(</span>
            <span>0.9</span><span>,</span>
            <span>0.999</span><span>,</span>
        <span>),</span> <span>lr</span><span>=</span><span>0.0001</span><span>,</span> <span>type</span><span>=</span><span>&#39;AdamW&#39;</span><span>,</span> <span>weight_decay</span><span>=</span><span>0.05</span><span>),</span>
    <span>type</span><span>=</span><span>&#39;OptimWrapper&#39;</span><span>)</span>
</pre></div>
<p>I&#39;ll copy Umbra&#39;s image into a working folder.</p>
<div><pre><span></span>$<span> </span>mkdir<span> </span>~/working
$<span> </span><span>cd</span><span> </span>~/working
$<span> </span>cp<span> </span>~/umbra_bkk/80f35b05-2902-46cc-9642-5d0e8916bf49/2024-05-25-15-37-54_UMBRA-06/2024-05-25-15-37-54_UMBRA-06_GEC.tif<span>&#34; ./</span>
</pre></div>
</div>
<div id="rational-polynomial-coefficients">
<h2>Rational Polynomial Coefficients</h2>
<p>This year, Umbra began including <a href="https://en.wikipedia.org/wiki/Rational_polynomial_coefficient">Rational polynomial coefficient</a> (RPC) metadata in their SAR imagery.</p>
<div><pre><span></span>$<span> </span>gdalinfo<span> </span>-json<span> </span><span>2024</span>-05-25-15-37-54_UMBRA-06_GEC.tif<span> </span><span>\</span>
<span>    </span><span>|</span><span> </span>jq<span> </span>-S<span> </span>.metadata.RPC
</pre></div>
<div><pre><span></span><span>{</span>
<span>  </span><span>&#34;ERR_BIAS&#34;</span><span>:</span><span> </span><span>&#34;-1&#34;</span><span>,</span>
<span>  </span><span>&#34;ERR_RAND&#34;</span><span>:</span><span> </span><span>&#34;-1&#34;</span><span>,</span>
<span>  </span><span>&#34;HEIGHT_OFF&#34;</span><span>:</span><span> </span><span>&#34;-30.6818097811395&#34;</span><span>,</span>
<span>  </span><span>&#34;HEIGHT_SCALE&#34;</span><span>:</span><span> </span><span>&#34;1414.21349937642&#34;</span><span>,</span>
<span>  </span><span>&#34;LAT_OFF&#34;</span><span>:</span><span> </span><span>&#34;13.6906792091218&#34;</span><span>,</span>
<span>  </span><span>&#34;LAT_SCALE&#34;</span><span>:</span><span> </span><span>&#34;0.0138548308915265&#34;</span><span>,</span>
<span>  </span><span>&#34;LINE_DEN_COEFF&#34;</span><span>:</span><span> </span><span>&#34;1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0&#34;</span><span>,</span>
<span>  </span><span>&#34;LINE_NUM_COEFF&#34;</span><span>:</span><span> </span><span>&#34;1.02231794327927e-05 0.215896351104129 -0.481367152531649 -0.848789645419274 -1.03956610619756e-05 0.00802968239297444 -0.00163693193778641 9.08138917922306e-05 0.000110851333886418 -0.0101589838895881 2.87171326664789e-05 -9.52685642544797e-07 -1.04184901360726e-06 0.000306411120496931 1.41330069687536e-07 2.04421034231927e-07 -5.98024000515252e-05 -7.13359480585107e-05 -1.9284524777315e-07 -0.00026831462493207&#34;</span><span>,</span>
<span>  </span><span>&#34;LINE_OFF&#34;</span><span>:</span><span> </span><span>&#34;8000&#34;</span><span>,</span>
<span>  </span><span>&#34;LINE_SCALE&#34;</span><span>:</span><span> </span><span>&#34;9297.59735239297&#34;</span><span>,</span>
<span>  </span><span>&#34;LONG_OFF&#34;</span><span>:</span><span> </span><span>&#34;100.750015998877&#34;</span><span>,</span>
<span>  </span><span>&#34;LONG_SCALE&#34;</span><span>:</span><span> </span><span>&#34;0.0141698426933747&#34;</span><span>,</span>
<span>  </span><span>&#34;SAMP_DEN_COEFF&#34;</span><span>:</span><span> </span><span>&#34;1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0&#34;</span><span>,</span>
<span>  </span><span>&#34;SAMP_NUM_COEFF&#34;</span><span>:</span><span> </span><span>&#34;1.07814928459238e-05 0.36389181356614 0.163208589638044 -0.916269610228506 -1.89359320515592e-05 0.00849839808635423 -0.00157666021207809 0.000118158419879778 0.000120048388193579 -0.010713791039376 3.02836674119795e-05 -1.00610258315293e-06 -1.10270841284789e-06 0.000323144987016618 1.47738197655541e-07 2.09165970874344e-07 -6.30683565149244e-05 -7.52268175348179e-05 -2.02759366303555e-07 -0.000282967947931177&#34;</span><span>,</span>
<span>  </span><span>&#34;SAMP_OFF&#34;</span><span>:</span><span> </span><span>&#34;8000&#34;</span><span>,</span>
<span>  </span><span>&#34;SAMP_SCALE&#34;</span><span>:</span><span> </span><span>&#34;12299.1294903148&#34;</span>
<span>}</span>
</pre></div>
<p>RPC allows for sophisticated and very accurate placement of imagery. Not all tools in GDAL work with RPC <a href="https://github.com/OSGeo/gdal/issues/10333">out of the box</a>. Issues of misplacement can come up if RPC isn&#39;t taken into account when processing imagery through different tooling. Below is an example where Tokyo&#39;s Haneda is east of where it should be.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_muOV8cZhCN.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_muOV8cZhCN.jpg"/></a></p><p>Before working with Umbra&#39;s imagery, I&#39;ll run it through <tt>gdalwarp</tt>. This will create a GeoTIFF that will be placed properly without the need for tools to fully understand RPC.</p>
<div><pre><span></span>$<span> </span>gdalwarp<span> </span><span>\</span>
<span>    </span>-t_srs<span> </span><span>&#34;EPSG:4326&#34;</span><span> </span><span>\</span>
<span>    </span><span>2024</span>-05-25-15-37-54_UMBRA-06_GEC.tif<span> </span><span>\</span>
<span>    </span>warped.tif
</pre></div>
</div>
<div id="tiling-imagery">
<h2>Tiling Imagery</h2>
<p>Umbra&#39;s images can be 10s of thousands of pixels wide and tall. When I ran this model on the original images, I was seeing fewer items detected than when I broke the image up into smaller tiles. Below I&#39;ll break up Umbra&#39;s BKK image into 4096x4096-pixel GeoTIFFs.</p>
<div><pre><span></span>$<span> </span>gdal_retile.py<span> </span><span>\</span>
<span>    </span>-s_srs<span> </span><span>&#34;EPSG:4326&#34;</span><span> </span><span>\</span>
<span>    </span>-ps<span> </span><span>4096</span><span> </span><span>4096</span><span> </span><span>\</span>
<span>    </span>-targetDir<span> </span>./<span> </span><span>\</span>
<span>    </span>warped.tif
</pre></div>
<p>Below is a screenshot of the tiles.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/tiles.png"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/tiles.png"/></a>
</p></div>
<div id="inference-on-tiles">
<h2>Inference on Tiles</h2>
<p>I&#39;ll run DeonDet on each tile and output the results into individual folders. Each folder will include an annotated image as well as a JSON file of the detections.</p>
<div><pre><span></span>$<span> </span><span>for</span><span> </span>FILENAME<span> </span><span>in</span><span> </span>warped<span>\_</span>*<span>\_</span>*.tif<span>;</span><span> </span><span>do</span>
<span>    </span><span>STEM</span><span>=</span><span>`</span><span>echo</span><span> </span><span>&#34;</span><span>$FILENAME</span><span>&#34;</span><span> </span><span>|</span><span> </span>grep<span> </span>-o<span> </span><span>&#39;[0-9]\_[0-9]&#39;</span><span>`</span>
<span>    </span><span>echo</span><span> </span><span>$STEM</span>
<span>    </span>mkdir<span> </span>-p<span> </span><span>&#34;out.</span><span>$STEM</span><span>&#34;</span>

<span>    </span>python3<span> </span><span>\</span>
<span>        </span>~/SARDet_100K/MSFA/image_demo.py<span> </span><span>\</span>
<span>        </span><span>&#34;./</span><span>$FILENAME</span><span>&#34;</span><span> </span><span>\</span>
<span>        </span>~/SARDet_100K/MSFA/local_configs/DeonDet/gfl_r50_denodet_sardet.py<span> </span><span>\</span>
<span>        </span>--weights<span> </span>~/ckpts/gfl_r50_denodet_sardet/epoch_best.pth<span> </span><span>\</span>
<span>        </span>--out-dir<span> </span><span>&#34;out.</span><span>$STEM</span><span>&#34;</span>
<span>  </span><span>done</span>
</pre></div>
<p>I wrote a Python script that reads the resulting detections and produces a single GPKG file of them.</p>

<div><pre><span></span><span>import</span> <span>itertools</span>
<span>from</span>   <span>glob</span>             <span>import</span> <span>glob</span>
<span>import</span> <span>json</span>

<span>import</span> <span>geopandas</span>        <span>as</span> <span>gpd</span>
<span>from</span>   <span>osgeo</span>            <span>import</span> <span>gdal</span>
<span>import</span> <span>pandas</span>           <span>as</span> <span>pd</span>
<span>from</span>   <span>shapely.geometry</span> <span>import</span> <span>box</span>
<span>import</span> <span>typer</span>


<span>app</span> <span>=</span> <span>typer</span><span>.</span><span>Typer</span><span>(</span><span>rich_markup_mode</span><span>=</span><span>&#39;rich&#39;</span><span>)</span>


<span>def</span> <span>get_coords</span><span>(</span><span>mx</span><span>,</span> <span>my</span><span>,</span> <span>x_min</span><span>,</span> <span>x_size</span><span>,</span> <span>y_min</span><span>,</span> <span>y_size</span><span>):</span>
    <span>px</span> <span>=</span> <span>mx</span> <span>*</span> <span>x_size</span> <span>+</span> <span>x_min</span>
    <span>py</span> <span>=</span> <span>my</span> <span>*</span> <span>y_size</span> <span>+</span> <span>y_min</span>

    <span>return</span> <span>px</span><span>,</span> <span>py</span>


<span>def</span> <span>get_scores</span><span>(</span><span>tile</span><span>=</span><span>&#39;4_3&#39;</span><span>):</span>
    <span>(</span><span>x_min</span><span>,</span>
     <span>x_size</span><span>,</span>
     <span>_</span><span>,</span>
     <span>y_min</span><span>,</span>
     <span>_</span><span>,</span>
     <span>y_size</span><span>)</span> <span>=</span> <span>gdal</span><span>.</span><span>Open</span><span>(</span><span>&#39;warped_</span><span>%s</span><span>.tif&#39;</span> <span>%</span> <span>tile</span><span>)</span><span>.</span><span>GetGeoTransform</span><span>()</span>

    <span>try</span><span>:</span>
        <span>recs</span> <span>=</span> <span>json</span><span>.</span><span>loads</span><span>(</span><span>open</span><span>(</span><span>&#39;out.</span><span>%s</span><span>/preds/warped_</span><span>%s</span><span>.json&#39;</span> <span>%</span> <span>(</span><span>tile</span><span>,</span> <span>tile</span><span>))</span><span>.</span><span>read</span><span>())</span>
    <span>except</span> <span>FileNotFoundError</span><span>:</span> <span># Inference failed for some reason</span>
        <span>return</span> <span>[]</span>

    <span>out</span> <span>=</span> <span>[]</span>

    <span>for</span> <span>num</span><span>,</span> <span>score</span> <span>in</span> <span>enumerate</span><span>(</span><span>recs</span><span>[</span><span>&#39;scores&#39;</span><span>]):</span>
        <span>x1</span><span>,</span> <span>y1</span><span>,</span> <span>x2</span><span>,</span> <span>y2</span> <span>=</span> <span>recs</span><span>[</span><span>&#39;bboxes&#39;</span><span>][</span><span>num</span><span>]</span>

        <span>r1</span> <span>=</span> <span>get_coords</span><span>(</span><span>x1</span><span>,</span> <span>y1</span><span>,</span> <span>x_min</span><span>,</span> <span>x_size</span><span>,</span> <span>y_min</span><span>,</span> <span>y_size</span><span>)</span>
        <span>r2</span> <span>=</span> <span>get_coords</span><span>(</span><span>x2</span><span>,</span> <span>y2</span><span>,</span> <span>x_min</span><span>,</span> <span>x_size</span><span>,</span> <span>y_min</span><span>,</span> <span>y_size</span><span>)</span>

        <span>out</span><span>.</span><span>append</span><span>((</span><span>score</span><span>,</span> <span>r1</span><span>[</span><span>0</span><span>],</span> <span>r1</span><span>[</span><span>1</span><span>],</span> <span>r2</span><span>[</span><span>0</span><span>],</span> <span>r2</span><span>[</span><span>1</span><span>]))</span>

    <span>return</span> <span>out</span>


<span>@app</span><span>.</span><span>command</span><span>()</span>
<span>def</span> <span>main</span><span>(</span><span>out</span><span>:</span><span>str</span><span>):</span>
    <span>tiles</span> <span>=</span> <span>[</span><span>x</span><span>.</span><span>split</span><span>(</span><span>&#39;.&#39;</span><span>)[</span><span>0</span><span>]</span><span>.</span><span>split</span><span>(</span><span>&#39;warped_&#39;</span><span>)[</span><span>-</span><span>1</span><span>]</span>
             <span>for</span> <span>x</span> <span>in</span> <span>glob</span><span>(</span><span>&#39;warped_*_*.tif&#39;</span><span>)]</span>

    <span>res</span> <span>=</span> <span>list</span><span>(</span><span>itertools</span><span>.</span><span>chain</span><span>.</span><span>from_iterable</span><span>(</span>
                    <span>list</span><span>(</span><span>filter</span><span>(</span><span>None</span><span>,</span>
                                <span>[</span><span>get_scores</span><span>(</span><span>tile</span><span>)</span>
                                 <span>for</span> <span>tile</span> <span>in</span> <span>tiles</span><span>]))))</span>

    <span>gdf</span> <span>=</span> <span>gpd</span><span>.</span><span>GeoDataFrame</span><span>(</span>
                <span>pd</span><span>.</span><span>DataFrame</span><span>({</span><span>&#39;score&#39;</span><span>:</span> <span>[</span><span>x</span><span>[</span><span>0</span><span>]</span> <span>for</span> <span>x</span> <span>in</span> <span>res</span><span>],</span>
                              <span>&#39;geom&#39;</span><span>:</span>  <span>[</span><span>box</span><span>(</span><span>x</span><span>[</span><span>1</span><span>],</span> <span>x</span><span>[</span><span>2</span><span>],</span> <span>x</span><span>[</span><span>3</span><span>],</span> <span>x</span><span>[</span><span>4</span><span>])</span>
                                       <span>for</span> <span>x</span> <span>in</span> <span>res</span><span>]}),</span>
                           <span>crs</span><span>=</span><span>&#39;4326&#39;</span><span>,</span>
                           <span>geometry</span><span>=</span><span>&#39;geom&#39;</span><span>)</span>
    <span>gdf</span><span>.</span><span>to_file</span><span>(</span><span>out</span><span>,</span> <span>driver</span><span>=</span><span>&#34;GPKG&#34;</span><span>)</span>


<span>if</span> <span>__name__</span> <span>==</span> <span>&#34;__main__&#34;</span><span>:</span>
    <span>app</span><span>()</span>
</pre></div>
<div><pre><span></span>$<span> </span>python<span> </span>json_to_gpkg.py<span> </span><span>\</span>
<span>    </span>--out<span>=</span>gfl_r50_denodet_sardet.gpkg
</pre></div>
<p>I&#39;ve disregarded the classes of objects being detected for this exercise. I just wanted to see how many plane parking spots were detected with a decent confidence score.</p>
<p>Most of the 0.4+ scores are in and around the runways, taxi and parking areas.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_SFV69QcbFS.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_SFV69QcbFS.jpg"/></a></p><p>There aren&#39;t many detections around where I suspect there are aircraft. I&#39;ll first show an RGB image of the satellite terminal parking area to help give some context.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_F323bHOojH.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_F323bHOojH.jpg"/></a></p><p>To the right of the image seems to be a lot of aircraft that haven&#39;t been detected. It&#39;s the same story when I look around the other parking areas in this results set as well.</p>
<p><a href="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_h1BJIVfqgt.jpg"><img alt="Umbra + MSFA" src="https://tech.marksblogg.com/theme/images/umbra-msfa/qgis-bin_h1BJIVfqgt.jpg"/></a></p><p>I would accept a lot of permanent infrastructure being falsely detected as an aircraft because I could geofence the results to just the areas aircraft can park or taxi. But in this case, the model is missing the aircraft altogether.</p>
</div>
<div id="further-research">
<h2>Further Research</h2>
<p>As I uncover more insights, I&#39;ll update this post with my findings.</p>
</div>

        </div><p>
            Thank you for taking the time to read this post. I offer both consulting and hands-on development services to clients in North America and Europe. If you&#39;d like to discuss how my offerings can help your business please contact me via <a href="https://uk.linkedin.com/in/marklitwintschik/">LinkedIn</a>.
        </p></div>
  </body>
</html>
