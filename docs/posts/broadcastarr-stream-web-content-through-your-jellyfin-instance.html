<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/Billos/Broadcastarr">Original</a>
    <h1>Broadcastarr: Stream web content through your Jellyfin instance</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Broadcastarr is a service that allows you to broadcast media content retrieved from web pages.</p>


<p dir="auto">The different actions are split into tasks that are handled by the AgendaTS service.
The tasks are:</p>
<ul dir="auto">
<li>Publish category
Ensures that the active categories are published, and starts indexing the categories for each active indexer.</li>
<li>Index category
Indexes the category for each a given indexer, schedules the next indexation and the grabbing of the broadcast stream.</li>
<li>Grab broadcast stream
Grabs the broadcast stream for each broadcast in the category, schedules the release of the broadcast.</li>
<li>Release broadcast
Releases the broadcast to the active releasers, schedules the publishing of associated group.</li>
<li>Publish group
Publishes the group to the active publishers.</li>
<li>Update category channel name
Updates the category channel name on the active publishers.</li>
<li>Delete broadcast
Deletes the broadcast.</li>
</ul>

<p dir="auto">Handles interactions and commands via Discord.
If no authorization was set, the bot will be available to everyone.
Available commands:</p>
<ul dir="auto">
<li>addcategory</li>
<li>addrole</li>
<li>indexcategory</li>
<li>removecategory</li>
<li>setcategoryemoji</li>
<li>setconfig</li>
<li>setgroupemoji</li>
<li>togglegroup</li>
<li>toggleindexer</li>
</ul>

<p dir="auto">A releaser is a service that can read the broadcasts.</p>
<p dir="auto">Implemented releasers:</p>
<ul dir="auto">
<li>Jellyfin</li>
</ul>

<p dir="auto">A publisher is a service that can publish the categories, groups and broadcasts to different platforms.</p>
<p dir="auto">Implemented publishers:</p>
<ul dir="auto">
<li>Discord</li>
<li>Matrix</li>
</ul>

<p dir="auto">The service is designed to be scalable and can be deployed on multiple instances.</p>

<p dir="auto">The docker compose includes a Wireguard client that allows the workers to scrape and grab the broadcasts from the web pages through a VPN.
The used configuration file is ./wg0.conf.</p>

<p dir="auto">First you need to create the env files and fill them with the correct values.</p>
<div data-snippet-clipboard-copy-content="cp .env.default .env
cp .env.init.default .env.init"><pre><code>cp .env.default .env
cp .env.init.default .env.init
</code></pre></div>
<p dir="auto">Then you need to initialize the database and shut it down.</p>
<div data-snippet-clipboard-copy-content="docker compose up init
docker compose down init"><pre><code>docker compose up init
docker compose down init
</code></pre></div>
<p dir="auto">Finally you can start the service.</p>
<div data-snippet-clipboard-copy-content="docker compose up -d server worker"><pre><code>docker compose up -d server worker
</code></pre></div>
<p dir="auto">Additionally you can have multiple workers in the compose file to handle more tasks at the same time.</p>


<p dir="auto">In the .env.init file:</p>
<ul dir="auto">
<li>Set the different delay values (in second).</li>
<li>Set the limit values (in minutes).</li>
<li>Set the Categories to create with their respective emoji.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="CATEGORIES_EMOJI=Football:‚öΩ,Basketball:üèÄ"><pre><span>CATEGORIES_EMOJI</span><span>=</span><span>Football:‚öΩ,Basketball:üèÄ</span></pre></div>
<ul dir="auto">
<li>Set the groups to create with their respective category and country.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="GROUPS=&#34;Football:France*Ligue 1,Spain*La Liga|Basketball:USA*NBA&#34;"><pre><span>GROUPS</span><span>=</span><span><span>&#34;</span>Football:France*Ligue 1,Spain*La Liga|Basketball:USA*NBA<span>&#34;</span></span></pre></div>
<ul dir="auto">
<li>Set the discord webhookks to activate.</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="DISCORD_WEBHOOKS=&#34;Football:id:token,Rugby:id:token&#34;"><pre><span>DISCORD_WEBHOOKS</span><span>=</span><span><span>&#34;</span>Football:id:token,Rugby:id:token<span>&#34;</span></span></pre></div>
<p dir="auto">Add the definitions of the indexers as json files in the ./src/init/data</p>
<div dir="auto" data-snippet-clipboard-copy-content="type Replacement = {
  regex: RegExp;
  replace: string;
}

type DateReplacement = {
  regex: RegExp;
  format: string;
}

type Selector = {
  path: string;
}

type TextContentSelector = Selector &amp; {
  attribute?: string;
  replacement?: Replacement;
}

type DateSelector = TextContentSelector &amp; {
  format?: string;
  dateReplacement?: DateReplacement;
}

type RegexSelector&lt;T extends Record&lt;string, string&gt;&gt; = TextContentSelector &amp; {
  regex: RegExp;
  default?: T;
}"><pre><span>type</span> <span>Replacement</span> <span>=</span> <span>{</span>
  <span>regex</span>: <span>RegExp</span><span>;</span>
  <span>replace</span>: <span>string</span><span>;</span>
<span>}</span>

<span>type</span> <span>DateReplacement</span> <span>=</span> <span>{</span>
  <span>regex</span>: <span>RegExp</span><span>;</span>
  <span>format</span>: <span>string</span><span>;</span>
<span>}</span>

<span>type</span> <span>Selector</span> <span>=</span> <span>{</span>
  <span>path</span>: <span>string</span><span>;</span>
<span>}</span>

<span>type</span> <span>TextContentSelector</span> <span>=</span> <span>Selector</span> <span>&amp;</span> <span>{</span>
  <span>attribute</span>?: <span>string</span><span>;</span>
  <span>replacement</span>?: <span>Replacement</span><span>;</span>
<span>}</span>

<span>type</span> <span>DateSelector</span> <span>=</span> <span>TextContentSelector</span> <span>&amp;</span> <span>{</span>
  <span>format</span>?: <span>string</span><span>;</span>
  <span>dateReplacement</span>?: <span>DateReplacement</span><span>;</span>
<span>}</span>

<span>type</span> <span>RegexSelector</span><span>&lt;</span><span>T</span> <span>extends</span> <span>Record</span><span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>&gt;</span><span>&gt;</span> <span>=</span> <span>TextContentSelector</span> <span>&amp;</span> <span>{</span>
  <span>regex</span>: <span>RegExp</span><span>;</span>
  <span>default</span>?: <span>T</span><span>;</span>
<span>}</span></pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="{
  &#34;name&#34;: string,
  &#34;url&#34;: string,
  &#34;active&#34;: boolean,
  // The data to configure the indexation
  &#34;data&#34;: {
    &#34;category&#34;: {
      // The links to retrieve the categories
      &#34;links&#34;: Selector[],
      // When set, the lookup is a map category =&gt; strings to look for in the category name in the links textContent retrieved by the links selectors
      &#34;lookups&#34;: Map&lt;string, string[]&gt;,
    },
    // Element to wait before looking for links
    &#34;loadPageElement&#34;: string,
    // Broadcasts can be grouped by sets, in this case we start by looking for the day
    &#34;broadcastSets&#34;: {
        // The selectors to retrieve the sets of broadcasts
        &#34;selector&#34;: Selector[],
        // The selectors to retrieve the day
        &#34;day&#34;: DateSelector[],
        // Some sites have  a &#34;today&#34; string instead of the current date, in this case we need to replace it
        &#34;today&#34;: {
        &#34;regex&#34;: string,
        &#34;format&#34;: string,
        },
    },
    // The selectors to retrieve the broadcasts, is run in the context of the set, or the page if not set
    &#34;broadcast&#34;: {
      // The selectors to retrieve the broadcasts
      &#34;selector&#34;: Selector[],
      // The selectors to retrieve the broadcast start time, is run in the context of the broadcast
      &#34;startTime&#34;: DateSelector[],
      // The selectors to retrieve the broadcast link, is run in the context of the broadcast
      &#34;link&#34;: TextContentSelector[],
      // The selectors to retrieve the broadcast title, is run in the context of the broadcast
      &#34;name&#34;: TextContentSelector[],
      // The selectors to retrieve the broadcast group, is run in the context of the broadcast
      &#34;group&#34;: RegexSelector[],
    },
    // The selectors to retrieve the next page link, as long as there is a next page, and the broadcastSets start before the future limit, we go to the next page and continue the indexation
    &#34;nextPage&#34;: Selector[],
  },
  // The data to configure the grabbing
  &#34;interceptorData&#34;: {
    // Element to wait before looking for stream items
    &#34;loadPageElement&#34;: string,
    // The selectors to retrieve the stream items
    &#34;streamItems&#34;: Selector[],
    // The selectors to retrieve the score of the broadcast, is run in the context of the stream item
    &#34;positiveScores&#34;: Selector[],
    // The selectors to retrieve the link of the broadcast, is run in the context of the stream item
    &#34;link&#34;: TextContentSelector[],
    // If set, we go to the link(s) previously found with a referer header
    &#34;referer&#34;: string,
    // If set, we click on the items found (play button for instance)
    &#34;clickButton&#34;: Selector[],
  }
}"><pre><span>{</span>
  <span>&#34;name&#34;</span>: <span>string</span><span>,</span>
  <span>&#34;url&#34;</span>: <span>string</span><span>,</span>
  <span>&#34;active&#34;</span>: <span>boolean</span><span>,</span>
  <span>// The data to configure the indexation</span>
  <span>&#34;data&#34;</span>: <span>{</span>
    <span>&#34;category&#34;</span>: <span>{</span>
      <span>// The links to retrieve the categories</span>
      <span>&#34;links&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
      <span>// When set, the lookup is a map category =&gt; strings to look for in the category name in the links textContent retrieved by the links selectors</span>
      <span>&#34;lookups&#34;</span>: <span>Map</span><span>&lt;</span><span>string</span><span>,</span> string<span>[</span><span>]</span><span>&gt;</span><span>,</span>
    <span>}</span><span>,</span>
    <span>// Element to wait before looking for links</span>
    <span>&#34;loadPageElement&#34;</span>: <span>string</span><span>,</span>
    <span>// Broadcasts can be grouped by sets, in this case we start by looking for the day</span>
    <span>&#34;broadcastSets&#34;</span>: <span>{</span>
        <span>// The selectors to retrieve the sets of broadcasts</span>
        <span>&#34;selector&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
        <span>// The selectors to retrieve the day</span>
        <span>&#34;day&#34;</span>: <span>DateSelector</span><span>[</span><span></span><span>]</span><span>,</span>
        <span>// Some sites have  a &#34;today&#34; string instead of the current date, in this case we need to replace it</span>
        <span>&#34;today&#34;</span>: <span>{</span>
        <span>&#34;regex&#34;</span>: <span>string</span><span>,</span>
        <span>&#34;format&#34;</span>: <span>string</span><span>,</span>
        <span>}</span><span>,</span>
    <span>}</span><span>,</span>
    <span>// The selectors to retrieve the broadcasts, is run in the context of the set, or the page if not set</span>
    <span>&#34;broadcast&#34;</span>: <span>{</span>
      <span>// The selectors to retrieve the broadcasts</span>
      <span>&#34;selector&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
      <span>// The selectors to retrieve the broadcast start time, is run in the context of the broadcast</span>
      <span>&#34;startTime&#34;</span>: <span>DateSelector</span><span>[</span><span></span><span>]</span><span>,</span>
      <span>// The selectors to retrieve the broadcast link, is run in the context of the broadcast</span>
      <span>&#34;link&#34;</span>: <span>TextContentSelector</span><span>[</span><span></span><span>]</span><span>,</span>
      <span>// The selectors to retrieve the broadcast title, is run in the context of the broadcast</span>
      <span>&#34;name&#34;</span>: <span>TextContentSelector</span><span>[</span><span></span><span>]</span><span>,</span>
      <span>// The selectors to retrieve the broadcast group, is run in the context of the broadcast</span>
      <span>&#34;group&#34;</span>: <span>RegexSelector</span><span>[</span><span></span><span>]</span><span>,</span>
    <span>}</span><span>,</span>
    <span>// The selectors to retrieve the next page link, as long as there is a next page, and the broadcastSets start before the future limit, we go to the next page and continue the indexation</span>
    <span>&#34;nextPage&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
  <span>}</span><span>,</span>
  <span>// The data to configure the grabbing</span>
  <span>&#34;interceptorData&#34;</span>: <span>{</span>
    <span>// Element to wait before looking for stream items</span>
    <span>&#34;loadPageElement&#34;</span>: <span>string</span><span>,</span>
    <span>// The selectors to retrieve the stream items</span>
    <span>&#34;streamItems&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
    <span>// The selectors to retrieve the score of the broadcast, is run in the context of the stream item</span>
    <span>&#34;positiveScores&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
    <span>// The selectors to retrieve the link of the broadcast, is run in the context of the stream item</span>
    <span>&#34;link&#34;</span>: <span>TextContentSelector</span><span>[</span><span></span><span>]</span><span>,</span>
    <span>// If set, we go to the link(s) previously found with a referer header</span>
    <span>&#34;referer&#34;</span>: <span>string</span><span>,</span>
    <span>// If set, we click on the items found (play button for instance)</span>
    <span>&#34;clickButton&#34;</span>: <span>Selector</span><span>[</span><span></span><span>]</span><span>,</span>
  <span>}</span>
<span>}</span></pre></div>

<p dir="auto">Fill the .env file with the correct values.</p>

<ul dir="auto">
<li>[] Unit tests</li>
<li>[] Configuration to activate / deactivate publishers</li>
<li>[] Discord bot commands to activate / deactivate publishers</li>
<li>[] Configuration to activate / deactivate releasers</li>
<li>[] Discord bot commands to activate / deactivate releasers</li>
<li>[] Working API for TheSportsDB</li>
<li>[] Option to reload a stream when proxying has been requested</li>
<li>[] Script for versioning &amp; automated changelog generation with the releases</li>
<li>[] Create docker image that does not mount the src folder</li>
<li>[] Improve doc with screenshots</li>
</ul>
</article></div></div>
  </body>
</html>
