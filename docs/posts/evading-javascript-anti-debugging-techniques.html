<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.nullpt.rs/evading-anti-debugging-techniques">Original</a>
    <h1>Evading JavaScript anti-debugging techniques</h1>
    
    <div id="readability-page-1" class="page"><div><p>Debuggers serve as invaluable tools that empower developers to halt code execution and thoroughly
analyze its behavior at any given moment. By utilizing a debugger, developers can efficiently
identify and resolve issues within their code, making it an indispensable part of their toolkit.</p>
<figure><img alt="Chromium&#39;s dev tools debugger" sizes="100vw" srcset="/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=640&amp;q=75 640w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=750&amp;q=75 750w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=828&amp;q=75 828w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=3840&amp;q=75 3840w" src="https://www.nullpt.rs/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fchromium_debugger.webp&amp;w=3840&amp;q=75" width="100" height="100" decoding="async" data-nimg="1" loading="lazy"/><figcaption>Chromium&#39;s dev tools debugger</figcaption></figure>
<p>Debuggers are equally valuable tools for reverse-engineers, especially when dealing with obfuscated
code that frequently employs name-mangling techniques for variables and functions. By utilizing
debuggers, reverse-engineers can gain crucial insights into the functionality of obscured functions.
Companies that employ client-side protection are aware of this fact and thus devise strategies to thwart
attempts at debugging protected code.</p>
<p>Once upon a time, whenever you tried to open your devtools on Supreme&#39;s website, you found yourself trapped
in a pesky debugger loop. This made it incredibly annoying to reverse engineer their anti-bot scripts.</p>
<h2>The Obvious Approach</h2>
<p>In many browsers, there&#39;s an option to disable all breakpoints from triggering. While this approach will prevent
getting stuck in a loop, it comes with a trade-off â€“ the debugger&#39;s functionality for further analysis becomes
unavailable.</p>
<figure><img alt="Deactivating breakpoints in Chromium" sizes="100vw" srcset="/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=640&amp;q=75 640w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=750&amp;q=75 750w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=828&amp;q=75 828w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=3840&amp;q=75 3840w" src="https://www.nullpt.rs/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fdeactivate_breakpoints.webp&amp;w=3840&amp;q=75" width="100" height="100" decoding="async" data-nimg="1" loading="lazy"/><figcaption>Deactivating breakpoints in Chromium</figcaption></figure>
<p>For complex scripts like the anti-bot employed by Supreme, this approach was simply not an option.</p>
<h2>Trying an Extension</h2>
<p>Greasyfork scripts such as Anti Anti-debugger attempt to bypass these debugger traps by overriding the caller&#39;s
function body, removing the debugger statements, and <code>eval</code> the new function. While this approach seemed promising,
it unfortunately does not succeed with JScrambler-protected scripts due to the evaluation of debugger traps in a distinct
context.</p>
<p>They also utilize integrity checks<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup> and hide debugger calls inside of further obfuscated eval functions<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup>.</p>
<figure><img alt="JScrambler&#39;s debugger trap being called from an eval context" sizes="100vw" srcset="/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=640&amp;q=75 640w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=750&amp;q=75 750w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=828&amp;q=75 828w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=3840&amp;q=75 3840w" src="https://www.nullpt.rs/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fjscrambler_debug_trap.webp&amp;w=3840&amp;q=75" width="100" height="100" decoding="async" data-nimg="1" loading="lazy"/><figcaption>JScrambler&#39;s debugger trap being called from an eval context</figcaption></figure>
<h2>The Final Approach</h2>
<p>The approach my friend Jordin and I ultimately adopted involved renaming the debugger keyword entirely.
By renaming it to something like &#34;banana,&#34; the debugger would no longer trigger on occurrences of the <code>debugger</code>
keyword. To achieve this, we built customized version of Firefox. If you&#39;re interested in trying
this out, here&#39;s the patch we came up with.</p>
<pre><code><span><span>--- a/js/src/frontend/ReservedWords.h</span>
</span><span><span>+++ b/js/src/frontend/ReservedWords.h</span>
</span><span><span>@@ -20,7 +20,7 @@</span>
</span><span><span><span> </span><span>  MACRO(catch, catch_, TokenKind::Catch)                \
</span></span></span><span><span><span></span><span> </span><span>  MACRO(const, const_, TokenKind::Const)                \
</span></span></span><span><span><span></span><span> </span><span>  MACRO(continue, continue_, TokenKind::Continue)       \
</span></span></span><span><span><span></span></span><span><span>-</span><span>  MACRO(debugger, debugger, TokenKind::Debugger)        \
</span></span></span><span><span><span></span></span><span><span>+</span><span>  MACRO(ticket_debugger, debugger, TokenKind::Debugger) \
</span></span></span><span><span><span></span></span><span><span> </span><span>  MACRO(default, default_, TokenKind::Default)          \
</span></span></span><span><span><span></span><span> </span><span>  MACRO(delete, delete_, TokenKind::Delete)             \
</span></span></span><span><span><span></span><span> </span><span>  MACRO(do, do_, TokenKind::Do)                         \
</span></span></span><span><span><span></span></span><span>--- a/js/src/vm/CommonPropertyNames.h</span>
</span><span><span>+++ b/js/src/vm/CommonPropertyNames.h</span>
</span><span><span>@@ -107,7 +107,7 @@</span>
</span><span><span><span> </span><span>  MACRO_(currencySign, currencySign, &#34;currencySign&#34;)  \
</span></span></span><span><span><span></span><span> </span><span>  MACRO_(day, day, &#34;day&#34;)                             \
</span></span></span><span><span><span></span><span> </span><span>  MACRO_(dayPeriod, dayPeriod, &#34;dayPeriod&#34;)           \
</span></span></span><span><span><span></span></span><span><span>-</span><span>  MACRO_(debugger, debugger, &#34;debugger&#34;)              \
</span></span></span><span><span><span></span></span><span><span>+</span><span>  MACRO_(ticket_debugger, debugger, &#34;ticket_debugger&#34;)\
</span></span></span><span><span><span></span></span><span><span> </span><span>  MACRO_(decimal, decimal, &#34;decimal&#34;)                 \
</span></span></span></code></pre>
<p>Finding this was daunting as reading through a browser&#39;s codebase is never a fun time. A simple
grep for a keyword like &#34;debugger&#34; could produce thousands of results, making the search
even more challenging.</p>
<p>Many builds later, we tested our patch by loading the anti-bot script <code>ticket.js</code> and hooking
<code>Array.prototype.slice</code><sup><a href="#user-content-fn-3" id="user-content-fnref-3" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup> to call our new <code>ticket_debugger</code> keyword.</p>
<figure><img alt="Our new ticket_debugger keyword triggers a breakpoint" sizes="100vw" srcset="/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=640&amp;q=75 640w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=750&amp;q=75 750w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=828&amp;q=75 828w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=3840&amp;q=75 3840w" src="https://www.nullpt.rs/_next/image?url=%2Fposts%2Fevading-anti-debugging-techniques%2Fticket_debugger.webp&amp;w=3840&amp;q=75" width="100" height="100" decoding="async" data-nimg="1" loading="lazy"/><figcaption>Our new ticket_debugger keyword triggers a breakpoint</figcaption></figure>
<h2>It works!</h2>
<p>We introduced a new <code>ticket_debugger</code> keyword, which not only triggers a breakpoint but also resolves
the issue of the previous debugger infinite loop. We also extended this custom browser to
automatically retrieve the anti-bot&#39;s obfuscated encryption round keys and convert them back to their
original form, but I&#39;ll cover that in a later post :)</p>
</div></div>
  </body>
</html>
