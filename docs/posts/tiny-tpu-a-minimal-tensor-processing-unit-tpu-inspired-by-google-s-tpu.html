<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/tiny-tpu-v2/tiny-tpu">Original</a>
    <h1>Tiny-tpu: A minimal tensor processing unit (TPU), inspired by Google&#39;s TPU</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">A minimal tensor processing unit (TPU), reinvented from Google&#39;s TPU V2 and V1.</p>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span aria-label="Video description tinytpu.mp4">tinytpu.mp4</span>
    <span></span>
  </summary>

  <video src="https://private-user-images.githubusercontent.com/110429254/479205816-b5d6aefe-4250-4c6d-866e-65d519e4de74.mp4?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTU2MjA5NTEsIm5iZiI6MTc1NTYyMDY1MSwicGF0aCI6Ii8xMTA0MjkyNTQvNDc5MjA1ODE2LWI1ZDZhZWZlLTQyNTAtNGM2ZC04NjZlLTY1ZDUxOWU0ZGU3NC5tcDQ_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwODE5JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDgxOVQxNjI0MTFaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0zNWEyMWE1NjJmMWU2ZWM3NzM5ZmEzOWIwMWUyZjZjZjc3MWM3YjQzZDMzYTQ1MmJmNWQ1MzNhYjExODNlZjQ2JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.N7ISBK2SJSA3MfImv8Tx_v_rWAMyWTjOSMrzLt560dQ" data-canonical-src="https://private-user-images.githubusercontent.com/110429254/479205816-b5d6aefe-4250-4c6d-866e-65d519e4de74.mp4?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTU2MjA5NTEsIm5iZiI6MTc1NTYyMDY1MSwicGF0aCI6Ii8xMTA0MjkyNTQvNDc5MjA1ODE2LWI1ZDZhZWZlLTQyNTAtNGM2ZC04NjZlLTY1ZDUxOWU0ZGU3NC5tcDQ_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwODE5JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDgxOVQxNjI0MTFaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0zNWEyMWE1NjJmMWU2ZWM3NzM5ZmEzOWIwMWUyZjZjZjc3MWM3YjQzZDMzYTQ1MmJmNWQ1MzNhYjExODNlZjQ2JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.N7ISBK2SJSA3MfImv8Tx_v_rWAMyWTjOSMrzLt560dQ" controls="controls" muted="muted">

  </video>
</details>


<ul dir="auto">
<li><a href="#motivation">Motivation</a></li>
<li><a href="#architecture">Architecture</a>
<ul dir="auto">
<li><a href="#processing-element-pe">Processing Element (PE)</a></li>
<li><a href="#systolic-array">Systolic Array</a></li>
<li><a href="#vector-processing-unit-vpu">Vector Processing Unit (VPU)</a></li>
<li><a href="#unified-buffer-ub">Unified Buffer (UB)</a></li>
<li><a href="#control-unit">Control Unit</a></li>
</ul>
</li>
<li><a href="#instruction-set">Instruction Set</a></li>
<li><a href="#example-instruction-sequence">Example Instruction Sequence</a></li>
<li><a href="#future-steps">Future Steps</a></li>
<li><a href="#setup">Setup</a>
<ul dir="auto">
<li><a href="#macos-specific">MacOS specific</a></li>
<li><a href="#ubuntu-specific">Ubuntu specific</a></li>
</ul>
</li>
<li><a href="#adding-a-new-module-to-the-tiny-tpu">Adding a new module to the tiny-tpu</a>
<ul dir="auto">
<li><a href="#1-create-the-module-file">1. Create the module file</a></li>
<li><a href="#2-create-the-dump-file">2. Create the dump file</a></li>
<li><a href="#3-create-the-test-file">3. Create the test file</a></li>
<li><a href="#4-update-the-makefile">4. Update the Makefile</a></li>
<li><a href="#5-view-waveforms">5. View waveforms</a></li>
</ul>
</li>
<li><a href="#running-commands-from-makefile">Running commands from Makefile</a></li>
<li><a href="#fixed-point-viewing-in-gtkwave">Fixed point viewing in gtkwave</a></li>
<li><a href="#what-is-a-gtkw-file">What is a gtkw file?</a></li>
</ul>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tiny-tpu-v2/tiny-tpu/blob/main/images/tpu.png"><img src="https://github.com/tiny-tpu-v2/tiny-tpu/raw/main/images/tpu.png" alt="TPU Architecture"/></a></p>

<ul dir="auto">
<li><strong>Function</strong>: Performs a multiply-accumulate operation every clock cycle</li>
<li><strong>Data Flow</strong>:
<ul dir="auto">
<li>Incoming data is multiplied by a stored weight and added to an incoming partial sum to produce an output sum</li>
<li>Incoming data also passes through to the next element for propagation across the array</li>
</ul>
</li>
</ul>

<ul dir="auto">
<li><strong>Architecture</strong>: A grid of processing elements, starting from 2x2</li>
<li><strong>Data Movement</strong>:
<ul dir="auto">
<li>Input values flow horizontally across the array</li>
<li>Partial sums flow vertically down the array</li>
<li>Weights remain fixed within each processing element during computation</li>
</ul>
</li>
<li><strong>Input Preprocessing</strong>:
<ul dir="auto">
<li>Input matrices are rotated 90 degrees (implemented in hardware)</li>
<li>Inputs are staggered for correct computation in the systolic array</li>
<li>Weight matrices are transposed and staggered to align with mathematical formulas</li>
</ul>
</li>
</ul>
<div dir="auto"><h3 tabindex="-1" dir="auto">Vector Processing Unit (VPU)</h3><a id="user-content-vector-processing-unit-vpu" aria-label="Permalink: Vector Processing Unit (VPU)" href="#vector-processing-unit-vpu"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li>Performs element-wise operations after the systolic array</li>
<li><strong>Control</strong>: Module selection depends on the computation stage</li>
<li><strong>Modules (pipelined)</strong>:
<ol dir="auto">
<li>Bias addition</li>
<li>Leaky ReLU activation function</li>
<li>MSE loss</li>
<li>Leaky ReLU derivative</li>
</ol>
</li>
</ul>

<ul dir="auto">
<li>Dual-port memory for storing intermediate values</li>
<li><strong>Stored Data</strong>:
<ul dir="auto">
<li>Input matrices</li>
<li>Weight matrices</li>
<li>Bias vectors</li>
<li>Post-activation values for backpropagation</li>
<li>Activation leak factors</li>
<li>Inverse batch size constant for MSE backpropagation</li>
</ul>
</li>
<li><strong>Interface</strong>:
<ul dir="auto">
<li>Two read and two write ports per data type</li>
<li>Data is accessed by specifying a start address and count</li>
<li>Reads can occur continuously in the background until the requested count is reached</li>
</ul>
</li>
</ul>

<ul dir="auto">
<li><strong>Instruction width</strong>: 94 bits</li>
<li>See <a href="#instruction-set">Instruction Set</a> section below for more information.</li>
</ul>

<p dir="auto">Our ISA is 94 bits wide. The full image is available in the <code>images/</code> folder.</p>
<p dir="auto">Our ISA defines all necessary signals for transferring data and interacting with our TPU. The implementation of the control unit (which reads instructions) can be found at <code>src/control_unit.sv</code>.</p>
<p dir="auto">The <code>instruction</code> bus is <strong>94 bits wide</strong> (<code>[93:0]</code>) and is divided into fields that directly control subsystems.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [0–4]: 1-bit Control Signals</h3><a id="user-content-bits-04-1-bit-control-signals" aria-label="Permalink: Bits [0–4]: 1-bit Control Signals" href="#bits-04-1-bit-control-signals"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Bit</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>sys_switch_in</code></td>
<td>System mode switch (general-purpose &#34;on/off&#34; CU)</td>
<td><code>1 = system active</code>, <code>0 = idle</code></td>
</tr>
<tr>
<td>1</td>
<td><code>ub_rd_start_in</code></td>
<td>Start UB (Unified Buffer) read transaction</td>
<td><code>1 = trigger read</code>, <code>0 = no read</code></td>
</tr>
<tr>
<td>2</td>
<td><code>ub_rd_transpose</code></td>
<td>UB read transpose mode</td>
<td><code>1 = transpose</code>, <code>0 = normal</code></td>
</tr>
<tr>
<td>3</td>
<td><code>ub_wr_host_valid_in_1</code></td>
<td>Host write channel 1 valid flag</td>
<td><code>1 = write valid</code>, <code>0 = not valid</code></td>
</tr>
<tr>
<td>4</td>
<td><code>ub_wr_host_valid_in_2</code></td>
<td>Host write channel 2 valid flag</td>
<td><code>1 = write valid</code>, <code>0 = not valid</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [6:5]: UB Read Column Size (2-bit)</h3><a id="user-content-bits-65-ub-read-column-size-2-bit" aria-label="Permalink: Bits [6:5]: UB Read Column Size (2-bit)" href="#bits-65-ub-read-column-size-2-bit"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[6:5]</td>
<td><code>ub_rd_col_size</code></td>
<td>Number of columns to read</td>
<td><code>00=0</code>, <code>01=1</code>, <code>10=2</code>, <code>11=3</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [14:7]: UB Read Row Size (8-bit)</h3><a id="user-content-bits-147-ub-read-row-size-8-bit" aria-label="Permalink: Bits [14:7]: UB Read Row Size (8-bit)" href="#bits-147-ub-read-row-size-8-bit"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[14:7]</td>
<td><code>ub_rd_row_size</code></td>
<td>Number of rows to read (0–255)</td>
<td><code>0x08 = read 8 rows</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [22:15]: UB Read Address (8-bit)</h3><a id="user-content-bits-2215-ub-read-address-8-bit" aria-label="Permalink: Bits [22:15]: UB Read Address (8-bit)" href="#bits-2215-ub-read-address-8-bit"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[22:15]</td>
<td><code>ub_rd_addr_in</code></td>
<td>UB read address (0–255)</td>
<td><code>0x10 = read bank 16</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [25:23]: UB Pointer Select (3-bit)</h3><a id="user-content-bits-2523-ub-pointer-select-3-bit" aria-label="Permalink: Bits [25:23]: UB Pointer Select (3-bit)" href="#bits-2523-ub-pointer-select-3-bit"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[25:23]</td>
<td><code>ub_ptr_sel</code></td>
<td>Selects UB pointer</td>
<td><code>3’b001 = route read ptr to bias module in VPU</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [41:26]: UB Write Host Data In 1 (16-bit, Fixed-Point)</h3><a id="user-content-bits-4126-ub-write-host-data-in-1-16-bit-fixed-point" aria-label="Permalink: Bits [41:26]: UB Write Host Data In 1 (16-bit, Fixed-Point)" href="#bits-4126-ub-write-host-data-in-1-16-bit-fixed-point"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[41:26]</td>
<td><code>ub_wr_host_data_in_1</code></td>
<td>First host write word</td>
<td><code>0xABCD</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [57:42]: UB Write Host Data In 2 (16-bit, Fixed-Point)</h3><a id="user-content-bits-5742-ub-write-host-data-in-2-16-bit-fixed-point" aria-label="Permalink: Bits [57:42]: UB Write Host Data In 2 (16-bit, Fixed-Point)" href="#bits-5742-ub-write-host-data-in-2-16-bit-fixed-point"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[57:42]</td>
<td><code>ub_wr_host_data_in_2</code></td>
<td>Second host write word</td>
<td><code>0x1234</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [61:58]: VPU Data Pathway (4-bit)</h3><a id="user-content-bits-6158-vpu-data-pathway-4-bit" aria-label="Permalink: Bits [61:58]: VPU Data Pathway (4-bit)" href="#bits-6158-vpu-data-pathway-4-bit"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[61:58]</td>
<td><code>vpu_data_pathway</code></td>
<td>Routing of data in VPU</td>
<td><code>0001=bias + relu routing</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [77:62]: Inverse Batch Size × 2 (16-bit, Fixed-Point)</h3><a id="user-content-bits-7762-inverse-batch-size--2-16-bit-fixed-point" aria-label="Permalink: Bits [77:62]: Inverse Batch Size × 2 (16-bit, Fixed-Point)" href="#bits-7762-inverse-batch-size--2-16-bit-fixed-point"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[77:62]</td>
<td><code>inv_batch_size_times_two_in</code></td>
<td>Precomputed scaling factor (2/batch)</td>
<td><code>0x0010 = (2/32)</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h3 tabindex="-1" dir="auto">Bits [93:78]: VPU Leak Factor (16-bit, Fixed-Point)</h3><a id="user-content-bits-9378-vpu-leak-factor-16-bit-fixed-point" aria-label="Permalink: Bits [93:78]: VPU Leak Factor (16-bit, Fixed-Point)" href="#bits-9378-vpu-leak-factor-16-bit-fixed-point"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Field</th>
<th>Signal</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>[93:78]</td>
<td><code>vpu_leak_factor_in</code></td>
<td>Leak factor for activation (e.g., Leaky ReLU)</td>
<td><code>0x00A0 = 0.625</code></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div dir="auto"><h2 tabindex="-1" dir="auto">Example Instruction Sequence</h2><a id="user-content-example-instruction-sequence" aria-label="Permalink: Example Instruction Sequence" href="#example-instruction-sequence"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Instructions are directly loaded into an instruction buffer on the chip from a testbench file.</p>
<ul dir="auto">
<li>See <code>tests/tpu.v</code> for our forward and backward pass instruction sequence</li>
<li>See the <a href="#setup">Setup</a> section on how to run this testbench</li>
</ul>

<ol dir="auto">
<li>Compiler for this instruction set</li>
<li>Scaling TPU to larger dimensions (256×256 or 512×512)</li>
</ol>

<p dir="auto">We are open source and appreciate any contributions! Here is our workflow and steps to set up our development environment:</p>

<ol dir="auto">
<li>Create a virtual environment and run:

</li>
<li>Install iverilog using Homebrew:

</li>
<li>Build gtkwave <strong>FROM SOURCE</strong> (important: other installation methods currently do not work)</li>
</ol>

<ol dir="auto">
<li>Create a virtual environment and run:

</li>
<li>Install gtkwave:

</li>
<li>Install iverilog:
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt install iverilog"><pre>sudo apt install iverilog</pre></div>
</li>
</ol>

<p dir="auto">Follow these steps to add a new module to the project:</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">1. Create the Module File</h3><a id="user-content-1-create-the-module-file" aria-label="Permalink: 1. Create the Module File" href="#1-create-the-module-file"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Add your new module file <code>&lt;MODULE_NAME&gt;.sv</code> in the <code>src/</code> directory.</p>

<p dir="auto">Create <code>dump_&lt;MODULE_NAME&gt;.sv</code> in the <code>test/</code> directory with the following code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="module dump();
initial begin
  $dumpfile(&#34;waveforms/&lt;MODULE_NAME&gt;.vcd&#34;);
  $dumpvars(0, &lt;MODULE_NAME&gt;); 
end
endmodule"><pre><span>module</span> <span>dump</span>();
<span>initial</span> <span>begin</span>
  <span>$dumpfile</span>(<span><span>&#34;</span>waveforms/&lt;MODULE_NAME&gt;.vcd<span>&#34;</span></span>);
  <span>$dumpvars</span>(<span>0</span>, <span>&lt;</span><span>MODULE_NAME</span><span>&gt;</span>); 
<span>end</span>
<span>endmodule</span></pre></div>

<p dir="auto">Create <code>test_&lt;MODULE_NAME&gt;.py</code> in the <code>test/</code> directory.</p>

<p dir="auto">Add your module to the <code>SOURCES</code> variable and create a test target:</p>
<div dir="auto" data-snippet-clipboard-copy-content="test_&lt;MODULE_NAME&gt;: $(SIM_BUILD_DIR)
	$(IVERILOG) -o $(SIM_VVP) -s &lt;MODULE_NAME&gt; -s dump -g2012 $(SOURCES) test/dump_&lt;MODULE_NAME&gt;.sv
	PYTHONOPTIMIZE=$(NOASSERT) MODULE=test_&lt;MODULE_NAME&gt; $(VVP) -M $(COCOTB_LIBS) -m libcocotbvpi_icarus $(SIM_VVP)
	! grep failure results.xml
	mv &lt;MODULE_NAME&gt;.vcd waveforms/ 2&gt;/dev/null || true"><pre><span>test_&lt;MODULE_NAME&gt;</span>: <span>$(<span>SIM_BUILD_DIR</span>)</span>
	<span>$(<span>IVERILOG</span>)</span> -o <span>$(<span>SIM_VVP</span>)</span> -s <span>&lt;</span>MODULE_NAME<span>&gt;</span> -s dump -g2012 <span>$(<span>SOURCES</span>)</span> test/dump_<span>&lt;</span>MODULE_NAME<span>&gt;</span>.sv
	PYTHONOPTIMIZE=<span>$(<span>NOASSERT</span>)</span> MODULE=test_<span>&lt;</span>MODULE_NAME<span>&gt;</span> <span>$(<span>VVP</span>)</span> -M <span>$(<span>COCOTB_LIBS</span>)</span> -m libcocotbvpi_icarus <span>$(<span>SIM_VVP</span>)</span>
	<span>!</span> grep failure results.xml
	mv <span>&lt;</span>MODULE_NAME<span>&gt;</span>.vcd waveforms/ <span>2&gt;</span>/dev/null <span>||</span> <span>true</span></pre></div>

<p dir="auto">Run the following command to view the generated waveforms:</p>
<div dir="auto" data-snippet-clipboard-copy-content="gtkwave waveforms/&lt;MODULE_NAME&gt;.vcd"><pre>gtkwave waveforms/<span>&lt;</span>MODULE_NAME<span>&gt;</span>.vcd</pre></div>

<p dir="auto">Run tests:</p>

<p dir="auto">View waveforms:</p>
<div dir="auto" data-snippet-clipboard-copy-content="gtkwave waveforms/&lt;MODULE_NAME&gt;.vcd"><pre>gtkwave waveforms/<span>&lt;</span>MODULE_NAME<span>&gt;</span>.vcd</pre></div>
<p dir="auto">Or use the shorthand:</p>


<ol dir="auto">
<li>Right-click all signals</li>
<li>Navigate to: <strong>Data Format</strong> → <strong>Fixed Point Shift</strong> → <strong>Specify</strong></li>
<li>Enter <code>8</code> and click <strong>OK</strong></li>
<li>Set: <strong>Data Format</strong> → <strong>Signed Decimal</strong></li>
<li>Enable: <strong>Data Format</strong> → <strong>Fixed Point Shift</strong> → <strong>ON</strong></li>
</ol>

<p dir="auto">A <code>.gtkw</code> file stores the signal configuration for <code>make show_&lt;MODULE_NAME&gt;</code>. You only need to save it once after running:</p>
<div dir="auto" data-snippet-clipboard-copy-content="gtkwave waveforms/&lt;MODULE_NAME&gt;.vcd"><pre>gtkwave waveforms/<span>&lt;</span>MODULE_NAME<span>&gt;</span>.vcd</pre></div>

<p dir="auto">The details of TPU architecture are closed source, as is most of chip design. We want this resource to be the ultimate guide to breaking into building chip accelerators for all levels of technical expertise — even if you just learned high school math and only know y = mx + b.</p>
<p dir="auto">Before this project, none of us had professional experience in hardware architecture/design. We started this ambitious project as a dedicated group wanting to break into hardware design. We&#39;ve collectively gained significant design experience from this project.</p>
<p dir="auto">We hope that the inventive nature of the article at <a href="https://tinytpu.com" rel="nofollow">tinytpu.com</a>, this README, and the code in this repository will help you walk through our steps and learn how to approach problems with an inventive mindset.</p>
</article></div></div>
  </body>
</html>
