<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://medium.com/@JasonWyatt/squeezing-performance-from-sqlite-explaining-the-virtual-machine-2550ef6c5db">Original</a>
    <h1>Squeezing Performance from SQLite: EXPLAINing the Virtual Machine</h1>
    
    <div id="readability-page-1" class="page"><article><span></span><section><div><div><div><div><div><div><div><div><div><a rel="noopener follow" href="https://medium.com/@JasonWyatt?source=post_page-----2550ef6c5db-----------------------------------"><div><p><img alt="Jason Feinstein" src="https://miro.medium.com/fit/c/56/56/1*WJz_cRRC5ck0JkG9VvlqAQ.jpeg" width="28" height="28"/></p></div></a></div></div></div></div></div><p id="c82d">The virtual machine? Yep, but not the Java Virtual Machine. In this post I will focus on providing you with a basic understanding SQLite’s “Virtual DataBase Engine” or VDBE.</p><figure><div role="button" tabindex="0"><p><img alt="" src="https://miro.medium.com/max/1400/1*mdQU_-TcsAuMb63qm0VIpQ.jpeg" width="700" height="280" role="presentation"/></p></div></figure><p id="ad3d">My “Squeezing Performance from SQLite” series is primarily meant for Android engineers, but this post in particular will dive into SQLite itself and the topics discussed will hold true for all developers who use it.</p></div></div></div><div><div><div><p id="3db2">I used to be under the impression th<span id="rmm"><span id="rmm">a</span></span>t SQLite parsed and ran statements like an interpreter, but it turns out that’s not quite the case. While looking for SQLite’s version of MySQL’s <code>EXPLAIN</code>, I stumbled across documentation that described the way SQLite operates:</p><blockquote><p id="800c">SQLite works by translating SQL statements into bytecode and then running that bytecode in a virtual machine. — <a href="https://sqlite.org/opcode.html" rel="noopener ugc nofollow" target="_blank">SQLite.org</a></p></blockquote><p id="5606">The SQLite virtual machine is called the “Virtual DataBase Engine”, or the “VDBE” for short.</p><figure><div role="button" tabindex="0"><div><div><div><p><img alt="" src="https://miro.medium.com/max/60/1*4t_9VZ_KCKWYoFMikBPyeQ.png?q=20" width="566" height="474" role="presentation"/></p><p><img alt="" width="566" height="474" role="presentation"/></p></div></div></div></div><figcaption>Incredibly simplified depiction of SQLite executing a Statement.</figcaption></figure><p id="e228">You might already know what a bytecode program in SQLite more commonly goes by: “prepared statement”. Also, just like most programs: prepared statements can take input (<code>?</code> variables).</p><p id="cb38">The bytecode program is a binary listing of instructions which each consist of an opcode and parameter values. Each opcode corresponds to a particular command that the VDBE knows how to process, and when being processed can operate on data contained within a bank of registers within the virtual machine. According to the official documentation, the number of registers is finite <em>but can be quite large</em> and depends on how SQLite was configured at compile time.</p><p id="cb3e">In the remainder of this article we’ll explore how SQL statements are processed by SQLite into bytecode programs, and then I’ll show you how you can examine the bytecode <em>your</em> statements get compiled into.</p></div></div></div><div><div><div><p id="9a48">When you ask SQLite to prepare a statement, your painstakingly handcrafted SQL is dissected (parsed), analyzed (query planned), and boiled down (compiled) into a bytecode program SQLite’s VDBE is capable of executing.</p><h2 id="1ca1">Tokenizing &amp; Parsing</h2><p id="1366">Just like any programming language, SQL starts as a bunch of text. To get from a string of text into something SQLite can understand, that text needs to be broken down and understood. This is what we call parsing.</p><p id="1362">SQLite’s parsing approach is made abundantly clear throughout the <a href="http://sqlite.org/lang.html" rel="noopener ugc nofollow" target="_blank">official documentation</a>. For example, if you’ve ever ended up at sqlite.org while looking for how you are supposed to write an INSERT statement — you’ve likely seen a diagram that explains a part of how SQLite’s parser works:</p><figure><div role="button" tabindex="0"><div><div><div><p><img alt="" src="https://miro.medium.com/max/60/1*vXnLid4UXB-IA4z_E37jDg.png?q=20" width="700" height="592" role="presentation"/></p><p><img alt="" width="700" height="592" role="presentation"/></p></div></div></div></div><figcaption>INSERT syntax diagram <a href="http://sqlite.org/lang_insert.html" rel="noopener ugc nofollow" target="_blank">(from sqlite.org)</a></figcaption></figure><p id="7324">Diagrams like the one above are a way of <a href="https://en.wikipedia.org/wiki/Syntax_diagram" rel="noopener ugc nofollow" target="_blank">visualizing</a> the <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form" rel="noopener ugc nofollow" target="_blank">Backus-Naur Form (BNF)</a> description of the SQL grammar that SQLite understands. Reading the syntax diagrams is a pretty straightforward process when you know what to look for:</p><ul><li id="ec5a">Ovals with text in <code>ALL CAPS</code> are keywords.</li><li id="a81f">Ovals with <code>lower-case-and-hypenated</code> text represent reusable grammar clauses (their syntax diagrams will be listed further down the page in the documentation).</li><li id="d5ef">Ovals with punctuation like parentheses, commas, etc are literal tokens that are required.</li><li id="7abd">The arrows that connect the ovals tell you the order in which the keywords, clauses, and tokens need to appear to construct a valid statement.</li></ul><h2 id="ac74">Query Planning</h2><p id="baac">After the statement has been parsed into its component parts, SQLite needs to decide how to approach executing the statement.</p><blockquote><p id="db04">For any given SQL statement, there might be hundreds or thousands or even millions of different algorithms of performing the operation. All of these algorithms will get the correct answer, though some will run faster than others. The query planner is an AI that tries to pick the fastest and most efficient algorithm for each SQL statement. — <a href="https://sqlite.org/queryplanner.html" rel="noopener ugc nofollow" target="_blank">SQLite.org</a></p></blockquote><p id="7545">Understanding how SQLite determines the best way to execute your statements is a big enough topic to warrant its own post. However, for this article it’s just important to know that there is an optimization step <em>between</em> parsing and compilation.</p><h2 id="4c71">Compilation</h2><p id="2362">Finally: after SQLite has determined how to best approach running your statement, it puts together a list of low-level bytecode instructions that describe the whole operation. That list of instructions is, quite literally, a program which will be run on the VDBE. A more popular name for the program compiled by SQLite is “prepared statement”.</p><p id="4cbd">Each bytecode instruction consists of an opcode (name of the instruction) and up to 5 parameters (input values or references to registers). In modern SQLite versions, there are over a hundred different types of instructions. They run the gamut between simple control-flow instructions like <code><a href="http://sqlite.org/opcode.html#Eq" rel="noopener ugc nofollow" target="_blank">Eq</a></code>: “jump to an instruction if two registers have the same value” and more database-specific instructions like <code>ResultRow</code>: which provides data to the database cursor at the current position, pointing at values which have been loaded into the VDBE’s registers.</p><p id="25b4">Once compiled into bytecode, a prepared statement does not need to be parsed or to go through the query planning process again. This is precisely what makes re-using prepared statements so fast when compared with opting not to re-use them.</p></div></div></div><div><div><div><p id="1870">Now that you know how your <em>raw</em> statement becomes a <em>prepared</em> statement, you may be wondering if it’s possible to examine the bytecode program that was compiled.</p><p id="c1dc">SQLite provides a mechanism you can use to inspect the bytecode it would generate for any statement. In order to see the bytecode, just prepend your statement with <code>EXPLAIN</code>. From the documentation:</p><blockquote><p id="5109">When the EXPLAIN keyword appears … it causes the statement to behave as a query that returns the sequence of <a href="https://sqlite.org/opcode.html" rel="noopener ugc nofollow" target="_blank">virtual machine instructions</a> it would have used to execute the command had the EXPLAIN keyword not been present. </p></blockquote><p id="a9f3"><code>EXPLAIN</code>&#39;s output is a series of rows where each row is an instruction in the prepared statement bytecode and each has 8 columns:</p><ul><li id="d474"><code>addr</code> — The instruction address.</li><li id="3f12"><code>opcode</code> — The instruction’s opcode.</li><li id="9bb5"><code>p1</code> through <code>p5</code> — Parameter values for the instruction.</li><li id="3bbb"><code>comment</code> — Comments explaining what the instruction is doing.</li></ul><p id="0cd1">That last column: <code>comment</code> will likely be empty unless you compile SQLite yourself and set the <code>-DSQLITE_ENABLE_EXPLAIN_COMMENTS</code> <a href="http://sqlite.org/compile.html#enable_explain_comments" rel="noopener ugc nofollow" target="_blank">option</a>.</p><p id="9c85">Let’s use <code>EXPLAIN</code> to take a look at the bytecode for a few statements. Because my install didn’t have the comments turned on, I’ll leave that out. Each example starts with the output you receive when you use <code>EXPLAIN</code>, followed by a <em>walk-through of the flow</em> that the VDBE takes through the bytecode program.</p><p id="2740"><em>(Note: all bytecode shown here is from SQLite 3.16.2, and may not be the same in other versions.)</em></p><h2 id="e144">“Hello World”</h2><pre><span id="e8fe">sqlite&gt; EXPLAIN SELECT &#34;hello world&#34;;</span></pre><p id="1b42">Sorry, I had to.</p><ol><li id="3405"><code><a href="http://sqlite.org/opcode.html#Init" rel="noopener ugc nofollow" target="_blank">Init</a> 0 1 0</code> — Denotes the start of the program and moves to address 1.</li><li id="d577"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 1 0 &#39;hello world&#39;</code> — “hello world” is stored in register 1.</li><li id="4fa8"><code><a href="http://sqlite.org/opcode.html#ResultRow" rel="noopener ugc nofollow" target="_blank">ResultRow</a> 1 1 0</code> — Let the cursor know that the register 1 contains a row of output.</li><li id="3bda"><code><a href="http://sqlite.org/opcode.html#Halt" rel="noopener ugc nofollow" target="_blank">Halt</a> 0 0 0</code> — Exit with error code <code>0</code> (everything is okay).</li></ol><h2 id="53f5">CREATE TABLE</h2><pre><span id="3109">sqlite&gt; EXPLAIN CREATE TABLE blog (</span></pre><ol><li id="18cf"><code><a href="http://sqlite.org/opcode.html#Init" rel="noopener ugc nofollow" target="_blank">Init</a> 0 27 0</code> — Start up and go immediately to address 27.</li><li id="ff25"><code><a href="http://sqlite.org/opcode.html#Transaction" rel="noopener ugc nofollow" target="_blank">Transaction</a> 0 1 0 0 01</code> — Start a write transaction on the current database and check that the database schema is the expected version.</li><li id="b967"><code><a href="http://sqlite.org/opcode.html#Goto" rel="noopener ugc nofollow" target="_blank">Goto</a> 0 1 0</code> — Jump back to address 1.</li><li id="6609"><code><a href="http://sqlite.org/opcode.html#ReadCookie" rel="noopener ugc nofollow" target="_blank">ReadCookie</a> 0 3 2</code> — Read cookie #2 (<a href="http://sqlite.org/fileformat.html#schema_format_number" rel="noopener ugc nofollow" target="_blank">the database format</a>) from the database and store its value in register 3.</li><li id="2ec4"><code><a href="http://sqlite.org/opcode.html#If" rel="noopener ugc nofollow" target="_blank">If</a> 3 5 0</code> — Jump to address 5 if the value in register 3 is not zero. <strong>Interpretation:</strong> we’re going to skip setting some cookies on the database if there is already a database format configured (let’s assume there isn’t one yet).</li><li id="3977"><code><a href="http://sqlite.org/opcode.html#SetCookie" rel="noopener ugc nofollow" target="_blank">SetCookie</a> 0 2 4</code> — Write <code>4</code> to cookie number 2 for the current database. This sets the database file format to 4.</li><li id="d292"><code><a href="http://sqlite.org/opcode.html#SetCookie" rel="noopener ugc nofollow" target="_blank">SetCookie</a> 0 5 1</code> — Write <code>1</code> to cookie number 5 for the current database. Cookie number 5 denotes the <a href="http://sqlite.org/fileformat.html#text_encoding" rel="noopener ugc nofollow" target="_blank">database file’s text encoding</a> format. By setting its value to <code>1</code>, we are choosing UTF-8.</li><li id="7d6f"><code><a href="http://sqlite.org/opcode.html#CreateTable" rel="noopener ugc nofollow" target="_blank">CreateTable</a> 0 2 0</code> — Create a new table and place its location in the database file at register 2.</li><li id="c2dc"><code><a href="http://sqlite.org/opcode.html#OpenWrite" rel="noopener ugc nofollow" target="_blank">OpenWrite</a> 0 1 0 5</code> — Open a read/write cursor called <code>0</code> with 5 columns on the table whose root page is <code>1</code>. </li><li id="301e"><code><a href="http://sqlite.org/opcode.html#NewRowid" rel="noopener ugc nofollow" target="_blank">NewRowid</a> 0 1 0</code> — Get a new rowid value and place it in register <code>1</code>.</li><li id="fe6a"><code><a href="http://sqlite.org/opcode.html#Blob" rel="noopener ugc nofollow" target="_blank">Blob</a> 6 3 0 _</code> — There is an empty blob of length <code>6</code>-bytes that we are going to store in register <code>3</code>.</li><li id="7e4d"><code><a href="http://sqlite.org/opcode.html#Insert" rel="noopener ugc nofollow" target="_blank">Insert</a> 0 3 1 _ 08</code> — Using cursor <code>0</code>, write the data in register <code>3</code> to the table using the value in register <code>1</code> as the key and increment the number of rows for the table.</li><li id="4641"><code><a href="http://sqlite.org/opcode.html#Close" rel="noopener ugc nofollow" target="_blank">Close</a> 0 0 0</code> — Close the cursor we opened previously (cursor <code>0</code>).</li><li id="a743"><code><a href="http://sqlite.org/opcode.html#Close" rel="noopener ugc nofollow" target="_blank">Close</a> 0 0 0</code> — No-op, since the cursor is already closed.</li><li id="7718"><code><a href="http://sqlite.org/opcode.html#Null" rel="noopener ugc nofollow" target="_blank">Null</a> 0 4 5</code> — Write <code>NULL</code> into registers <code>4</code> and <code>5</code>.</li><li id="a3cb"><code><a href="http://sqlite.org/opcode.html#OpenWrite" rel="noopener ugc nofollow" target="_blank">OpenWrite</a> 1 1 0 5</code> — Open a read/write cursor called <code>1</code> with 5 columns on the table whose root page is <code>1</code>.</li><li id="5c31"><code><a href="http://sqlite.org/opcode.html#SeekRowid" rel="noopener ugc nofollow" target="_blank">SeekRowid</a> 1 16 1</code> — Using cursor <code>1</code>, jump to address <code>16</code> if the cursor doesn’t contain a rowid of the value in register <code>1</code>. Otherwise move along. (let’s move along, since we did just write something to the value in register 1)</li><li id="82e8"><code><a href="http://sqlite.org/opcode.html#Rowid" rel="noopener ugc nofollow" target="_blank">Rowid</a> 1 5 0</code> — Store the value of the rowid for cursor <code>1</code> in register <code>5</code>.</li><li id="55e3"><code><a href="http://sqlite.org/opcode.html#IsNull" rel="noopener ugc nofollow" target="_blank">IsNull</a> 5 24 0</code> — Jump to address <code>24</code> if the value in register <code>5</code> is <code>NULL</code>.</li><li id="6d6f"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 6 0 &#39;table’</code> — Store <code>&#39;table&#39;</code> in register <code>6</code>.</li><li id="f73c"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 7 0 &#39;blog&#39;</code> — Store <code>&#39;blog&#39;</code> in register <code>7</code>.</li><li id="b7da"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 8 0 &#39;blog&#39;</code> — Store <code>&#39;blog&#39;</code> in register <code>8</code>.</li><li id="bd07"><code><a href="http://sqlite.org/opcode.html#Copy" rel="noopener ugc nofollow" target="_blank">Copy</a> 2 9 0</code> — Copy the value from register <code>2</code> to register <code>9</code>.</li><li id="dfdd"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 10 0 &#39;CREATE TABLE ....’</code> — Store the <code>CREATE TABLE</code> statement into register <code>10</code>.</li><li id="55bd"><code><a href="http://sqlite.org/opcode.html#MakeRecord" rel="noopener ugc nofollow" target="_blank">MakeRecord</a> 6 5 11 &#39;BBBDB&#39;</code> — Create a table record using registers <code>6</code> through <code>10</code> (6 + (5–1)) and store a reference to that record in register <code>11</code>. The <code>BBBDB</code> string says that the first three columns and the last column in the record should have a type-affinity of “blob”, and the fourth should be a number.</li><li id="f8d9"><code><a href="http://sqlite.org/opcode.html#Insert" rel="noopener ugc nofollow" target="_blank">Insert</a> 1 11 5</code> —Using cursor <code>1</code>, write the record data pointed to by register <code>11</code> using the rowid we’ve stored in register <code>5</code> as its key.</li><li id="67d1"><code><a href="http://sqlite.org/opcode.html#SetCookie" rel="noopener ugc nofollow" target="_blank">SetCookie</a> 0 1 1</code> — Set the value of <a href="http://sqlite.org/fileformat2.html#schema_cookie" rel="noopener ugc nofollow" target="_blank">the schema cookie</a> to <code>1</code>. The schema cookie is cookie number 1, and it denotes the current version of the database schema.</li><li id="a881"><code><a href="http://sqlite.org/opcode.html#ParseSchema" rel="noopener ugc nofollow" target="_blank">ParseSchema</a> 0 0 0 &#34;tbl_name=&#39;blog&#39;...&#34;</code> — Parse all schema entries in <code>sqlite_master</code> using the p4 param value as a <code>WHERE</code> clause. (this spawns another call into the VDBE)</li><li id="2559"><code><a href="http://sqlite.org/opcode.html#Halt" rel="noopener ugc nofollow" target="_blank">Halt</a> 0 0 0</code> — Terminate the program with an error code of <code>0</code> (success!).</li></ol><h2 id="14d4">INSERT</h2><p id="4592">Lastly, let’s see what it takes to add a row to our newly created <code>blog</code> table.</p><pre><span id="5abf">sqlite&gt; EXPLAIN INSERT INTO blog (title, author, pub_date, body) VALUES (&#39;Winter is Coming&#39;, &#39;Ned Stark&#39;, date(&#39;now&#39;), &#39;It comes in season 7.&#39;);</span></pre><ol><li id="721d"><code><a href="http://sqlite.org/opcode.html#Init" rel="noopener ugc nofollow" target="_blank">Init</a> 0 12 0</code> — Start up and go immediately to address 12.</li><li id="1bf5"><code><a href="http://sqlite.org/opcode.html#Transaction" rel="noopener ugc nofollow" target="_blank">Transaction</a> 0 1 1 0 01</code> — Start a write transaction on the current database and check that the database schema is the expected version.</li><li id="7a29"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 6 0 &#39;now’</code> — Store <code>&#39;now&#39;</code> in register <code>6</code>.</li><li id="55c9"><code><a href="http://sqlite.org/opcode.html#Goto" rel="noopener ugc nofollow" target="_blank">Goto</a> 0 1 0</code> — Jump to address <code>1</code>.</li><li id="1651"><code><a href="http://sqlite.org/opcode.html#OpenWrite" rel="noopener ugc nofollow" target="_blank">OpenWrite</a> 0 2 0 4</code> — Open a read/write cursor called <code>0</code> with <code>4</code> columns on the table whose root is at page <code>2</code>.</li><li id="0d25"><code><a href="http://sqlite.org/opcode.html#NewRowid" rel="noopener ugc nofollow" target="_blank">NewRowid</a> 0 1 0</code> — Get a new rowid for the table and store it in register <code>1</code>.</li><li id="22ed"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 2 0 &#39;Winter is Coming&#39;</code> — Store <code>&#39;Winter is Coming&#39;</code> in register <code>2</code>.</li><li id="bcdb"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 3 0 &#39;Ned Stark&#39;</code> — Store <code>&#39;Ned Stark&#39;</code> in register <code>3</code>.</li><li id="690f"><code><a href="http://sqlite.org/opcode.html#Function0" rel="noopener ugc nofollow" target="_blank">Function0</a> 1 6 4 date(-1) 01</code> — Invoke the <code>date</code> function using the value at register <code>6</code> as its only argument and store the result in register <code>4</code>.</li><li id="da67"><code><a href="http://sqlite.org/opcode.html#String8" rel="noopener ugc nofollow" target="_blank">String8</a> 0 5 0 &#39;It comes in season 7.&#39;</code> — Store <code>&#39;It comes in season 7.&#39;</code> in register <code>5</code>.</li><li id="b482"><code><a href="http://sqlite.org/opcode.html#HaltIfNull" rel="noopener ugc nofollow" target="_blank">HaltIfNull</a> 1299 2 2 &#39;blog.title&#39; 01</code> — If the value in register <code>2</code> is null, end the program with error code <code>1299</code>.</li><li id="f382"><code><a href="http://sqlite.org/opcode.html#HaltIfNull" rel="noopener ugc nofollow" target="_blank">HaltIfNull</a> 1299 2 3 &#39;blog.author&#39; 01</code> — If the value in register <code>3</code> is null, end the program with error code <code>1299</code>.</li><li id="9f8e"><code><a href="http://sqlite.org/opcode.html#MakeRecord" rel="noopener ugc nofollow" target="_blank">MakeRecord</a> 2 4 7 &#39;BBDB&#39;</code> — Create a table record using registers <code>2</code> through <code>5</code> (2 + (4–1)) and store a reference to that record in register <code>7</code>. The <code>BBDB</code> string says that the record should consist of two blobs, a number, and a blob (in that order).</li><li id="4d9e"><code><a href="http://sqlite.org/opcode.html#Insert" rel="noopener ugc nofollow" target="_blank">Insert</a> 0 7 1 &#39;blog&#39; 1b</code> — Insert the record pointed to by register <code>7</code> with the key in register <code>1</code> into the <code>blog</code> table. The <code>1b</code> value for <code>p5</code> is a bit mask denotes among other things that the VDBE should count the number of rows changed, and store the newest inserted row’s id for access later.</li><li id="5cff"><code><a href="http://sqlite.org/opcode.html#Halt" rel="noopener ugc nofollow" target="_blank">Halt</a> 0 0 0</code> — We’re done! Exit with error code of <code>0</code> (success).</li></ol><p id="db5f">If you’re still with me, nice work! If you’d like to learn even more about SQLite’s VDBE and bytecode, try looking through the <code>EXPLAIN</code> results for following on your own:</p><ul><li id="c210">Create a table with a compound primary key.</li><li id="88a0">Insert data into that table.</li><li id="8d0e">Create another table, add data to it that relates to the data in the first table, and do a <code>SELECT</code> query which <code>JOIN</code>s the two tables together.</li><li id="2a74">See what a <code>UNION</code> of <code>SELECT</code> queries does.</li></ul></div></div></div></div></section></article></div>
  </body>
</html>
