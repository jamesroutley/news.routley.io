<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.nginx.com/blog/improving-nginx-performance-with-kernel-tls/">Original</a>
    <h1>Improving NGINX Performance with Kernel TLS and SSL_sendfile</h1>
    
    <div id="readability-page-1" class="page"><div>
		
<p>Transport Layer Security (TLS) is an extremely popular cryptography protocol. Implementing TLS in the kernel (kTLS) improves performance by significantly reducing the need for copying operations between user space and the kernel.</p>
<p>Combining kTLS and <a target="_blank" href="https://man7.org/linux/man-pages/man2/sendfile.2.html" rel="noopener noreferrer"><code>sendfile()</code></a> means data is encrypted directly in kernel space, before being passed to the network stack for transmission. This eliminates the need to copy data into user space to be encrypted by TLS libraries and then back into kernel space for transmission. kTLS also enables offload of TLS processing to hardware, including <a target="_blank" href="https://people.freebsd.org/~gallatin/talks/euro2019-ktls.pdf" rel="noopener noreferrer">offload of TLS symmetric crypto processing to network devices</a>.</p>
<p>Modern Linux and FreeBSD kernels support offloading TLS to the kernel, and now NGINX Open Source does too! NGINX 1.21.4 <a target="_blank" href="https://hg.nginx.org/nginx/rev/65946a191197" rel="noopener noreferrer">introduces support for kTLS</a> when serving static files with <a target="_blank" href="https://www.openssl.org/docs/manmaster/man3/SSL_sendfile.html" rel="noopener noreferrer"><code>SSL_sendfile()</code></a>, which can hugely improve performance. As detailed below, both the kernel and OpenSSL must be built with kTLS for NGINX to use <code>SSL_sendfile()</code>.</p>
<p>In this blog we detail which operating system and OpenSSL versions support kTLS, and show how to build and configure the kernel and NGINX for kTLS. To give you an idea of the performance improvement you can expect from kTLS, we also share the specs and results of our testing on FreeBSD and Ubuntu.</p>
<p><strong>Note:</strong> kTLS implementations are quite new and evolving rapidly. This blog describes support for kTLS as of November 2021, but keep an eye out for announcements on <a target="_blank" href="https://nginx.org/en/" rel="noopener noreferrer"><strong>nginx.org</strong></a> and the <a href="https://www.nginx.com/blog/">NGINX blog</a> about changes to the information and instructions provided here.</p>
<h2>General Requirements</h2>
<ul>
<li>
<p>Operating system – Either of:</p>
<ul>
<li>
<p>FreeBSD 13.0+. As of November 2021, FreeBSD 13.0+ is the only OS that supports kTLS in NGINX without a manual build of NGINX to incorporate OpenSSL 3.0.0+. See <a href="#nginx-ktls-freebsd">Enabling NGINX with kTLS on FreeBSD</a>.</p>
</li>
<li>
<p>A Linux distribution built on Linux kernel version 4.17 or later, though we recommend using those built on version 5.2 or later when possible. (kTLS support is actually available in version 4.13, but OpenSSL 3.0.0 requires kernel header version 4.17 or later.)</p>
</li>
</ul>
</li>
<li>
<p>OpenSSL – Version 3.0.0 or later</p>
</li>
<li>
<p>NGINX – Version 1.21.4 or later (mainline)</p>
</li>
</ul>
<h2>Operating System Support</h2>
<h3 id="oss-with-support">OSs That Support kTLS</h3>
<p>As of November 2021, of the OSs <a target="_blank" href="https://nginx.org/en/linux_packages.html" rel="noopener noreferrer">supported by NGINX Open Source</a> the following support kTLS and the indicated ciphers. For details about cipher support, see <a href="#tls-protocol">TLS Protocol and Cipher Support</a>.</p>
<table>
<tbody>
<tr>
<th> </th>
<th>TLSv1.2 ciphers</th>
<th>TLSv1.3</th>
<th><code>TLS_CHACHA20_POLY1305_SHA256</code> cipher</th>
<th>Linux kernel version</th>
</tr>
<tr>
<td>Amazon Linux 2<strong>*</strong></td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>5.10</td>
</tr>
<tr>
<td>CentOS 8<strong>**</strong></td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>4.18</td>
</tr>
<tr>
<td>FreeBSD 13.0</td>
<td>✅</td>
<td>✅</td>
<td>❌ <strong><sup>***</sup></strong></td>
<td>N/A</td>
</tr>
<tr>
<td>RHEL 8</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>4.18</td>
</tr>
<tr>
<td>SLES 15 SP2</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>5.3</td>
</tr>
<tr>
<td>Ubuntu 20.04 LTS</td>
<td>✅</td>
<td>❌​​</td>
<td>❌</td>
<td>5.4</td>
</tr>
<tr>
<td>Ubuntu 21.04</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>5.11</td>
</tr>
<tr>
<td>Ubuntu 21.10</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>5.13</td>
</tr>
</tbody>
</table>
<p>  <strong>*</strong> Kernel version must be 5.10, not 4.14; see <a href="#oss-without-support">OSs That Do Not Support kTLS</a> and the <a target="_blank" href="https://aws.amazon.com/amazon-linux-2/faqs/#:~:text=Which%20kernel%20versions%20are%20available,kernel%204.14%20and%20kernel%205.10" rel="noopener noreferrer">Amazon Linux 2 FAQ</a></p>
<h3 id="oss-without-support">OSs That Do Not Support kTLS</h3>
<p>The following OSs do not support kTLS, for the indicated reason:</p>
<ul>
<li>Alpine Linux 3.11–3.14 – Kernel is built with the <code>CONFIG_TLS=n</code> option, which disables building kTLS as a module or as part of the kernel.</li>
<li>Amazon Linux 2 – Linux kernel version is 4.14 for the default Amazon Linux 2 AMI (see the <a target="_blank" href="https://aws.amazon.com/amazon-linux-2/faqs/#:~:text=Which%20kernel%20versions%20are%20available,kernel%204.14%20and%20kernel%205.10" rel="noopener noreferrer">Amazon Linux 2 FAQ</a>).</li>
<li>CentOS 7.4+ – Linux kernel version is 3.10. Inherits its kTLS support status from RHEL 7.4+ as its upstream source.</li>
<li>Debian 10 and 11 – Kernel is built with the <code>CONFIG_TLS=n</code> option (see the <a target="_blank" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=919807" rel="noopener noreferrer">Debian bug report logs</a>).</li>
<li>RHEL 7.4+ – Linux kernel version is <a target="_blank" href="https://access.redhat.com/articles/3078#RHEL7" rel="noopener noreferrer">3.10</a>.</li>
<li>SLES 12 SP5+ – Linux kernel version is <a target="_blank" href="https://www.suse.com/support/kb/doc/?id=000019587" rel="noopener noreferrer">4.12</a>.</li>
<li>Ubuntu 18.04 LTS – Linux kernel version is <a target="_blank" href="https://askubuntu.com/questions/517136/list-of-ubuntu-versions-with-corresponding-linux-kernel-version" rel="noopener noreferrer">4.15</a>.</li>
</ul>
<h3 id="tls-protocol">TLS Protocol and Cipher Support</h3>
<p>As detailed <a href="#oss-with-support">above</a>, OSs that support kTLS vary in their support for TLS protocols and ciphers. </p>
<p>With TLSv1.2, the kTLS module supports these ciphers:</p>
<ul>
<li><code>AES128-GCM-SHA256</code></li>
<li><code>AES256-GCM-SHA384</code></li>
<li><code>ECDHE-RSA-AES128-GCM-SHA256</code></li>
<li><code>ECDHE-RSA-AES256-GCM-SHA384</code></li>
</ul>
<p>With TLSv1.3, the kTLS module supports these cipher suites:</p>
<ul>
<li><code>TLS_AES_128_GCM_SHA256</code></li>
<li><code>TLS_AES_256_GCM_SHA384</code></li>
<li><code>TLS_CHACHA20_POLY1305_SHA256</code> (only some OSs, as specified in <a href="#oss-with-support">OSs That Support kTLS</a>)</li>
</ul>
<p>To verify which TLS ciphers supported by OpenSSL are enabled in your NGINX binary, run the <a target="_blank" href="https://www.openssl.org/docs/man1.0.2/man1/ciphers" rel="noopener noreferrer"><span><code>openssl-3.0.0/.openssl/bin/openssl</code> <code>ciphers</code></span></a> command in the directory where you built NGINX (for example, your home directory).</p>
<h2>Enabling kTLS in NGINX</h2>
<p>As mentioned in the introduction, kTLS improves NGINX performance because all encryption and decryption take place in the kernel. Data is encrypted directly in kernel space – before being passed to the network stack for transmission – eliminating the need to copy data into user space to be encrypted by TLS libraries and then back into kernel space for transmission.</p>
<p><a href="https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology.png"><img src="https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology.png" alt="" width="2048" height="1090" srcset="https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology.png 2048w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-300x160.png 300w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-1024x545.png 1024w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-768x409.png 768w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-1536x818.png 1536w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-150x80.png 150w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-640x341.png 640w, https://www.nginx.com/wp-content/uploads/2022/01/kTLS-NGINX_topology-320x170.png 320w" sizes="(max-width: 2048px) 100vw, 2048px"/></a></p>
<h3>Loading kTLS in the Kernel</h3>
<p>In modern FreeBSD and Linux distributions, kTLS is usually built as a module (with the <code>CONFIG_TLS=m</code> option). You must explicitly load the kTLS module into the kernel before you start NGINX.</p>
<ul>
<li>
<p>On FreeBSD, run these commands as the <code>root</code> user:</p>
<pre><code># <strong>kldload ktls_ocf</strong>
# <strong>sysctl kern.ipc.tls.enable=1</strong></code></pre>
<p>For details about the FreeBSD command options, see the man page for <a target="_blank" href="https://www.freebsd.org/cgi/man.cgi?query=ktls&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+13.0-RELEASE+and+Ports&amp;arch=default&amp;format=html" rel="noopener noreferrer"><code>ktls(4)</code></a>.</p>
</li><li>
<p>On Linux distributions, run this command as the <code>root</code> user:</p>
<pre><code># <strong>modprobe tls</strong></code></pre>
</li>
</ul>
<h3 id="nginx-ktls-freebsd">Enabling NGINX with kTLS on FreeBSD</h3>
<p>To enable kTLS support in NGINX on FreeBSD, you may use the same <a href="#nginx-ktls-linux">instructions</a> as for Linux distributions. However, we recommend that you perform the following steps to leverage the build of NGINX with kTLS in the <span>security/openssl-devel</span> port in the <a target="_blank" href="https://www.freebsd.org/ports/" rel="noopener noreferrer">FreeBSD Ports Collection</a>. For more information, including an overview of kTLS, see <a target="_blank" href="https://freebsdfoundation.org/wp-content/uploads/2020/07/TLS-Offload-in-the-Kernel.pdf" rel="noopener noreferrer">TLS Offload in the Kernel</a> on the FreeBSD website.</p>
<ol>
<li>
<p>Build OpenSSL 3.0 with kTLS support, selecting the appropriate options in the config menu: </p>
<pre><code># <strong>cd /usr/ports/security/openssl-devel &amp;&amp; make config &amp;&amp; make install</strong></code></pre>
</li>
<li>
<p>Modify <strong>/etc/make.conf</strong> to use <span>openssl-devel</span> as the default SSL library:</p>
<pre><code># <strong>echo &#34;DEFAULT_VERSIONS+=ssl=openssl-devel &gt;&gt; /etc/make.conf</strong></code></pre>
</li>
<li>
<p>Build NGINX:</p>
<pre><code># <strong>cd /usr/ports/www/nginx-devel &amp;&amp; make install</strong></code></pre>
</li>
</ol>
<h3 id="nginx-ktls-linux">Building NGINX with kTLS on Linux Distributions</h3>
<p>Most current Linux distributions include an OpenSSL version earlier than 3.0.0 (commonly, version 1.1). So you need to build NGINX from source with OpenSSL 3.0.0.</p>
<p>The two crucial options on the <code>configure</code> command that enable kTLS support are:</p>
<ul>
<li><code>--with-openssl=../openssl-3.0.0</code></li>
<li><code>--with-openssl-opt=enable-ktls</code></li>
</ul>
<p>The other <code>configure</code> options are for the modules included in the official <a target="_blank" href="https://nginx.org/en/linux_packages.html" rel="noopener noreferrer">NGINX binary packages</a> available at <strong>nginx.org</strong>. You may specify a custom set of modules instead. To see the build options used for your current NGINX binary, run <span><code>nginx</code> <code>-V</code></span>.</p>
<p>To build NGINX with OpenSSL 3.0.0, run the following commands:</p>
<pre><code>$ <strong>wget https://nginx.org/download/nginx-1.21.4.tar.gz</strong>
$ <strong>wget https://www.openssl.org/source/openssl-3.0.0.tar.gz</strong>
$ <strong>tar xzf openssl-3.0.0.tar.gz</strong>
$ <strong>cd nginx-1.21.4</strong>
$ <strong>./configure \
--with-debug \
--prefix=/usr/local \
--conf-path=/usr/local/etc/nginx/nginx.conf \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--pid-path=/var/run/nginx.pid \
--lock-path=/var/run/nginx.lock \
--http-client-body-temp-path=/var/cache/nginx/client_temp \
--http-proxy-temp-path=/var/cache/nginx/proxy_temp \
--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
--http-scgi-temp-path=/var/cache/nginx/scgi_temp \
--user=nginx \
--group=nginx \
--with-compat \
--with-file-aio \
--with-threads \
--with-http_addition_module \
--with-http_auth_request_module \
--with-http_dav_module \
--with-http_flv_module \
--with-http_gunzip_module \
--with-http_gzip_static_module \
--with-http_mp4_module \
--with-http_random_index_module \
--with-http_realip_module \
--with-http_secure_link_module \
--with-http_slice_module \
--with-http_ssl_module \
--with-http_stub_status_module \
--with-http_sub_module \
--with-http_v2_module \
--with-mail \
--with-mail_ssl_module \
--with-stream \
--with-stream_realip_module \
--with-stream_ssl_module \
--with-stream_ssl_preread_module \
--with-openssl=../openssl-3.0.0 \
--with-openssl-opt=enable-ktls \
--with-cc-opt=&#39;-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fPIC&#39; \
-with-ld-opt=&#39;-Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-z,now -Wl,--as-needed -pie&#39;</strong>
$ <strong>make –j4</strong>
$ <strong>make install</strong></code></pre>
<p><strong>Note:</strong> The resulting NGINX binary is statically linked with OpenSSL 3.0.0 libraries. If you later need to patch OpenSSL, you must download and unpack the new OpenSSL source archive, then run the commands above to rebuild the NGINX binary. </p>
<h3>Configuring NGINX</h3>
<p>To enable kTLS, include the <span><a target="_blank" href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_conf_command" rel="noopener noreferrer"><code>ssl_conf_command</code></a> directive with the <code>Options</code> <code>KTLS</code></span> parameter in the <code>server{}</code> context, as in this sample configuration used for our <a href="#testing">testing</a>:</p>
<pre><code>worker_processes auto;
error_log /var/log/nginx/error.log debug;

events {}

http {
    sendfile on;

    server {
        listen 443 ssl;
        ssl_certificate ssl/example.crt;
        ssl_certificate_key ssl/example.key;
        ssl_conf_command Options KTLS;
        ssl_protocols TLSv1.3;

        location / {
            root /data;
    	}
    }
}</code></pre>
<h3>Verifying kTLS is Enabled</h3>
<p>To verify that NGINX is using kTLS, <a target="_blank" href="https://docs.nginx.com/nginx/admin-guide/monitoring/debugging/" rel="noopener noreferrer">enable debugging mode</a> and check for <code>BIO_get_ktls_send()</code> and <code>SSL_sendfile()</code> in the error log. </p>
<pre><code>$ <strong>grep BIO /var/log/nginx/error.log</strong>
2021/11/10 16:02:46 [debug] 274550#274550: *2 BIO_get_ktls_send(): 1
2021/11/10 16:02:49 [debug] 274550#274550: *3 BIO_get_ktls_send(): 1
 
$ <strong>grep SSL_sendfile /var/log/nginx/error.log</strong>
2021/11/10 16:02:46 [debug] 274550#274550: *2 SSL_sendfile: 1048576
2021/11/10 16:02:49 [debug] 274550#274550: *3 SSL_sendfile: 1048576</code></pre>
<p><strong>Note:</strong> We recommend that you disable debugging mode after making these checks, especially in production environments. Debug logging incurs a performance penalty due to the large volume of write operations; also, debug logs can be huge and quickly exhaust available space on the disk partition.</p>
<h2>Performance Improvement with kTLS</h2>
<p>When serving static files under heavy load, <code>SSL_sendfile()</code> can <a target="_blank" href="https://people.freebsd.org/~gallatin/talks/euro2019-ktls.pdf" rel="noopener noreferrer">increase throughput by up to 2x</a> compared to user‑space TLS, but the size of the performance boost depends significantly on various factors (disk performance, system load, etc). It is also possible to reduce CPU usage if your network card supports TLS offload.</p>
<h3 id="testing">Testing Performance</h3>
<p>To measure the performance boost on your setup, use the following instructions to run a simple one‑thread test. As detailed below, our test results indicate a performance boost of up to nearly 30% without any specific tuning.</p>
<p>Hardware and software used:</p>
<ul>
<li>AWS t3.medium instance with:
<ul>
<li>4 GB RAM
</li><li>20 GB general purpose SSD
</li><li>Intel® Xeon® Platinum 8259CL CPU @ 2.50GHz with 2 cores</li>
</ul>
</li>
<li>FreeBSD 13.0 and Ubuntu 21.10</li>
<li>TLSv1.3 with the <code>TLS_AES_256_GCM_SHA384</code> cipher suite</li>
<li>NGINX 1.21.4, built and configured as specified in <a href="#Enabling-kTLS-in-NGINX">Enabling kTLS in NGINX</a>.</li>
</ul>
<p>To perform the test:</p>
<ol>
<li>
<p>Create a large file that fits completely in the disk cache:</p>
<pre><code># <strong>truncate -s 1g /data/1G</strong></code></pre>
</li>
<li>
<p>Run this command to check the throughput; the base command is repeated multiple times for  more accurate results. Pipe the output to the <code>ministat</code> utility[<a target="_blank" href="https://www.freebsd.org/cgi/man.cgi?query=ministat" rel="noopener noreferrer">FreeBSD</a>][<a target="_blank" href="https://manpages.ubuntu.com/manpages/impish/man1/ministat.1.html" rel="noopener noreferrer">Ubuntu</a>] for a basic  statistical analysis.</p>
<pre><code># <strong>for i in &#39;seq 1 100&#39;; do curl -k -s -o /dev/null -w &#39;%{speed_download}\n&#39; https://localhost/1G; done | ministat</strong></code></pre>
</li>
</ol>
<h3>Results of Performance Testing</h3>
<p>In the following results from our tests, presented as output from <code>ministat</code>, each value is the download speed in kBytes/second. </p>
<p>Throughput for FreeBSD 13.0 without kTLS:</p>
<pre><code>    N           Min           Max        Median           Avg        Stddev
x  10        532225        573348        555616      555155.6     10239.137</code></pre>
<p>Throughput for FreeBSD 13.0 with kTLS:</p>
<pre><code>    N           Min           Max        Median           Avg        Stddev
x  10        629379        723164        717349      708600.4     28304.766</code></pre>
<p>Throughput for Ubuntu 21.10 without kTLS:</p>
<pre><code>    N           Min           Max        Median           Avg        Stddev
x  10        529199        705720        662354      654321.6     48025.103</code></pre>
<p>Throughput for Ubuntu 21.10 with kTLS:</p>
<pre><code>    N           Min           Max        Median           Avg        Stddev
x  10        619105        760208        756278      741848.3     43255.246</code></pre>
<p>In our testing, kTLS boosted performance more with FreeBSD than Ubuntu. The percentage improvement was as follows:</p>
<table>
<tbody>
<tr>
<th> </th>
<th>Min</th>
<th>Max</th>
<th>Median</th>
<th>Avg</th>
</tr>
<tr>
<td>FreeBSD 13.0</td>
<td>18%</td>
<td>26%</td>
<td>29%</td>
<td>28%</td>
</tr>
<tr>
<td>Ubuntu 21.10</td>
<td>16%</td>
<td>8%</td>
<td>14%</td>
<td>13%</td>
</tr>
</tbody>
</table>
<h2>Summary</h2>
<p>NGINX 1.21.4 introduces support for kTLS when serving static files with <code>SSL_sendfile()</code>. Our testing shows that performance improves by between 8% and 29%, depending on the operating system.</p>
<p>We’re interested in hearing about your experiences with kTLS and NGINX, and especially the results of your testing on other OSs! Please share them in the comments section below.</p>
	</div></div>
  </body>
</html>
