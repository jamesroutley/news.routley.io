<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://terinstock.com/post/2025/02/Netboot-Windows-11-with-iSCSI-and-iPXE/">Original</a>
    <h1>Netboot Windows 11 with iSCSI and iPXE</h1>
    
    <div id="readability-page-1" class="page"><div><figure><a href="https://terinstock.com/media/f9/fb032e2f72ad1df49f59f6bee29b35b7eabf8068eb9245bb0c950b9aac4ab8.png"><img src="https://terinstock.com/media/f9/fb032e2f72ad1df49f59f6bee29b35b7eabf8068eb9245bb0c950b9aac4ab8.png" alt="A fictious screenshot of a permanent ban from a game, in the Windows 95 installer style, with a 90s-era PC and a joystick in the left banner. The text is titled &#34;Permanent Suspension&#34; and reads &#34;Your account has been permanently suspended due to the use of unauthorized Operating Systems or unauthorized virtual machines. This type of behavior causes damage to our community and the game&#39;s competitive integrity. This action will not be reversed.&#34;"/></a><figcaption><h4>Purposefully ambiguous and fictious permanent ban.</h4><p>(created with <a href="https://digipres.club/@foone">@foone</a>’s <a href="https://deathgenerator.com/">The Death Generator</a>)</p></figcaption></figure><p>My primary operating system is Linux: I have it installed on my laptop and desktop. Thanks to the amazing work of the <a href="https://www.winehq.org/">WINE</a>, <a href="https://www.codeweavers.com/">CodeWeavers</a>, and <a href="https://www.valvesoftware.com/">Valve</a> developers, it’s also where I do PC gaming. I can spin up Windows in a virtual machine for the rare times I need to use it, and even pass through a GPU if I want to do gaming.</p><p>There is one pretty big exception: playing the AAA game ████████████████ with friends. Unfortunately, the developer only allows Windows. If you attempt to run the game on Linux or they detect you’re running in a virtual machine, your device and account are permanently banned. I would prefer not to be permanently banned.</p><p>For the past several years my desktop has also had a disk dedicated to maintaining a Windows install. I’d prefer to use the space in my PC case<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> for disks for Linux. Since I already run a home NAS, and my Windows usage is infrequent, I wondered if I could offload the Windows install to my NAS instead. This lead me down the course of netbooting Windows 11 and writing up these notes on how to do a simplified “modern” version.</p><p>My first task was determining how to get a computer to boot from a NAS. My experience with network block devices is with Ceph RBD, where a device is mounted into an already running operating system. For booting over an Ethernet IP network the standard is iSCSI. A great way to boot from an iSCSI disk is with <a href="https://ipxe.org">iPXE</a>. To avoid any mistakes during this process, I removed all local drives from the system.<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></p><p>I didn’t want to run a TFTP server on my home network, or reconfigure DHCP to provide TFTP configuration. Even if I did, the firmware for my motherboard is designed for “<span>gamers</span>”, there’s no PXE ROM. I can enable UEFI networking and a network boot option appears in the boot menu, but no DHCP requests are made<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>. Fortunately, iPXE is available as <a href="https://boot.ipxe.org/ipxe.usb">bootable USB image</a>, which loaded and started trying to fetch configuration from the network.</p><p>Hitting <code>ctrl-b</code> as directed on screen to drop to the iPXE shell, I could verify basic functionality was working.</p><pre tabindex="0"><code>iPXE 1.21.1+ (e7585fe) -- Open Source Network Boot Firmware -- https://ipxe.org
Features: DNS FTP HTTP HTTPS iSCSI NFS TFTP VLAN SRP AoE EFI Menu
iPXE&gt; dhcp
Configuring (net0 04:20:69:91:C8:DD)...... ok
iPXE&gt; show ${net0/ip}
192.0.2.3
</code></pre><p>I decided to use <a href="https://github.com/fujita/tgt">tgt</a> as the iSCSI target daemon on my NAS<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup> as the configuration seemed the least complicated. In <code>/etc/tgt/targets.conf</code> I configured it with two targets: one as the block device I wanted to install Windows onto and the other being the installation ISO.</p><pre tabindex="0"><code data-lang="sgml">&lt;target iqn.2025-02.com.example:win-gaming&gt;
    backing-store /dev/zvol/zroot/sans/win-gaming
    params thin-provisioning=1
&lt;/target&gt;

&lt;target iqn.2025-02.com.example:win11.iso&gt;
    backing-store /opt/isos/Win11_24H2_English_x64.iso
    device-type cd
    readonly 1
&lt;/target&gt;
</code></pre><p>Back on the PC, I could tell iPXE to use these iSCSI disks, then boot onto the DVD. As multiple network drives are being added, each must be given a different drive ID starting from <code>0x80</code>.</p><pre tabindex="0"><code>iPXE&gt; sanhook --drive 0x80 iscsi:nas.example.com:::1:iqn.2025-02.com.example:win-gaming
Registered SAN device 0x80
iPXE&gt; sanhook --drive 0x81 iscsi:nas.example.com:::1:iqn.2025-02.com.example:win11.iso
Registered SAN device 0x81
iPXE&gt; sanboot --drive 0x81
Booting from SAN device 0x81
</code></pre><p>After a minute of the Windows 11 logo and a spinner, the Windows 11 setup appears. In an ideal situation, I could immediately start installing. Unfortunately, the Windows 11 DVD does not ship drivers for my network card, and the iSCSI connection information passed to the booted system from iPXE couldn’t be used. I’m a bit impressed the GUI loaded at all, instead of just crashing.</p><p>To rectify this, I would need to build a <a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-intro">Windows PE</a> image that included my networking drivers. WinPE is the minimal environment used when installing Windows. Fortunately, Microsoft has made this pretty easy nowadays. I downloaded and installed the <a href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install">Windows Assessment and Deployment Kit</a> and the Windows PE add-on. After running “Deployment and Imaging Tools Environment” as an administrator, I could make a folder containing a base WinPE image.</p><pre tabindex="0"><code>&gt; mkdir C:\winpe
&gt; copype amd64 C:\winpe\amd64
</code></pre><p>After mounting the image, I was able to slipstream the <a href="https://www.intel.com/content/www/us/en/download/727998/intel-network-adapter-driver-for-microsoft-windows-11.html">Intel drivers</a>. I searched through the inf files to find the folder that supported my network card.</p><pre tabindex="0"><code>&gt; imagex /mountrw C:\winpe\amd64\media\sources\boot.wim C:\winpe\amd64\mount
&gt; dism /image:C:\winpe\amd64\mount /add-driver /driver:C:\temp\intel\PRO1000\Winx64\W11\
&gt; imagex /unmount /commit C:\winpe\amd64\mount
</code></pre><p>This new image is what we need to boot into to install Windows. As my NAS is also running an HTTP server, I copied over the files relevant to netbooting: from “C:‍\winpe\amd64\media” I copied “boot/BCD”, “boot/boot.sdi”, and “sources/boot.wim”, preserving the folders. I also downloaded <a href="https://github.com/ipxe/wimboot/releases">wimboot</a> to the same directory.</p><p>You can use iPXE to execute a script fetched with HTTP, which I took advantage of to reduce the amount of typing I’ll need to do at the shell. I saved the following script as “install.ipxe” in the same HTTP directory.</p><pre tabindex="0"><code data-lang="ipxe">#!ipxe

sanhook --drive 0x80 iscsi:nas.example.com:::1:iqn.2025-02.com.example:win-gaming
sanhook --drive 0x81 iscsi:nas.example.com:::1:iqn.2025-02.com.example:win11.iso
kernel wimboot
initrd boot/BCD BCD
initrd boot/boot.sdi boot.sdi
initrd sources/boot.wim boot.wim
boot
</code></pre><p>Rebooting back to the iPXE prompt I could then boot using this script.</p><pre tabindex="0"><code>iPXE&gt; dhcp
iPXE&gt; chain http://nas.example.com/ipxe/install.ipxe
</code></pre><p>After a few seconds I was booted into WinPE with a Command Prompt. The command “wpeinit” ran automatically, configuring the network card and mounting the iSCSI disks. I found the DVD had been mounted as drive “D”, and could start the Windows Setup with “D:‍\setup.exe”.</p><p>However, after reaching the “Searching for Disks” screen the installer closed itself without any error. This seems to be a bug with the new version of setup, as restarting it and selecting the “Previous Version of Setup” on an earlier page used a version of the installer that worked.</p><p>The installation was spread across several restarts. Fortunately, once the installation files are copied over, nothing but the main disk image is required, reducing what I needed to type in the iPXE shell. The HTTP server could also be cleaned up at this point.</p><pre tabindex="0"><code>iPXE&gt; dhcp
iPXE&gt; sanboot iscsi:nas.example.com:::1:iqn.2025-02.com.example:win-gaming
</code></pre><p>After several more minutes, and a forced installation of a Windows zero-day patch, I was greeted by a Windows 11 desktop, booted over iSCSI. Task Manager even reports the C drive as being “SDD (iSCSI)”.</p><p>Booting from a USB stick and typing into an iPXE prompt every time I want to boot into Windows isn’t a great user experience. Fortunately, iPXE is also available as an <a href="https://boot.ipxe.org/ipxe.efi">EFI application</a> which can be installed to the local EFI System Partition. I also discovered that iPXE will execute commands provided on the command line.</p><p>I reinstalled the disks used for Linux, copied over ipxe.efi to the EFI System Partition, and added a new entry to systemd-boot by creating “$ESP/loader/entries/win11.conf”</p><pre tabindex="0"><code>title Windows 11 (iPXE)
efi /ipxe/ipxe.efi
options prompt &amp;&amp; dhcp &amp;&amp; sanboot iscsi:nas.example.com:::1:iqn.2025-02.com.example:win-gaming
</code></pre><p>There seems to be a bug where the first word in the options field is ignored.<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup> I used a valid iPXE command <code>prompt</code>, which also provides a clear signal should it ever start being interpreted in the future version.</p><p>After a little bit of extra setup (installing Firefox and switching to dark mode), I was able to install Steam and the game. The game took a little bit longer to install due the slower disk speed over my network (time to upgrade to 10GbE?), but there was no noticeable delay during normal gameplay. I didn’t see any network saturation or high disk latencies in Task Manager during loading.</p></div></div>
  </body>
</html>
