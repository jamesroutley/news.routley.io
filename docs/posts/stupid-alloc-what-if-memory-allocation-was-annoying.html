<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/shadyfennec/stupidalloc">Original</a>
    <h1>Stupid alloc â€“ what if memory allocation was annoying</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">Mostly a weird exercise in how much you can make a memory allocator suck.</p>
<p dir="auto">This allocator will create and open files to use as the allocation&#39;s data, through a memory map. If you enable the <code>interactive</code> feature, it will even prompt you for a file name every time
the program allocates something! Cool!</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-how-to-use-it" aria-hidden="true" href="#how-to-use-it"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>How to use it</h2>
<p dir="auto">don&#39;t</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-no-but-really-how-does-one-use-this" aria-hidden="true" href="#no-but-really-how-does-one-use-this"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>No but really how does one use this</h2>
<p dir="auto">Using <code>cargo add</code>:</p>

<p dir="auto">Manually specifying the dependency in <code>Cargo.toml</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="[dependencies]
stupidalloc = { version = &#34;0.1.0&#34; }"><pre>[<span>dependencies</span>]
<span>stupidalloc</span> = { <span>version</span> = <span><span>&#34;</span>0.1.0<span>&#34;</span></span> }</pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-the-interactive-feature" aria-hidden="true" href="#the-interactive-feature"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>The <code>interactive</code> feature</h3>
<p dir="auto">The crate comes with a feature, <code>interactive</code>, that will open confirmation and file picker dialog windows instead of silently opening and allocating memory. Enable it at your own risk,
as sometimes dialogs are unavailable. This crate uses <a href="https://crates.io/crates/native-dialog" rel="nofollow"><code>native-dialog</code></a> for this feature.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-using-the-allocator" aria-hidden="true" href="#using-the-allocator"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Using the allocator</h2>
<ul dir="auto">
<li>You can use it as the global allocator of your program, but it may lead to wonkiness and weird stuff like prompting for allocations before <code>main()</code> is executed!</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="use stupidalloc::StupidAlloc;

#[global_allocator]
static GLOBAL: StupidAlloc = StupidAlloc;

fn main() {
    // ...
}"><pre><span>use</span> stupidalloc<span>::</span><span>StupidAlloc</span><span>;</span>

<span>#<span>[</span>global_allocator<span>]</span></span>
<span>static</span> <span>GLOBAL</span><span>:</span> <span>StupidAlloc</span> = <span>StupidAlloc</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>// ...</span>
<span>}</span></pre></div>
<ul dir="auto">
<li>By using the <a href="https://doc.rust-lang.org/beta/unstable-book/library-features/allocator-api.html" rel="nofollow"><code>allocator_api</code></a> nightly feature, you can selectively
allocate single objects with this allocator:</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="// Requires nightly
#![feature(allocator_api)]

use stupidalloc::StupidAlloc;

fn main() {
    let normal_box = Box::new(1);

    let stupid_box = Box::new_in(1, StupidAlloc);
}"><pre><span>// Requires nightly</span>
<span>#!<span>[</span>feature<span>(</span>allocator_api<span>)</span><span>]</span></span>

<span>use</span> stupidalloc<span>::</span><span>StupidAlloc</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>let</span> normal_box = <span>Box</span><span>::</span><span>new</span><span>(</span><span>1</span><span>)</span><span>;</span>

    <span>let</span> stupid_box = <span>Box</span><span>::</span><span>new_in</span><span>(</span><span>1</span><span>,</span> <span>StupidAlloc</span><span>)</span><span>;</span>
<span>}</span></pre></div>
<p dir="auto">A cool usage is to stop the execution of your program (through your favourite <code>stdin</code> read) and then go look at the allocation files with a hex editor (might I recommend <a href="https://github.com/sharkdp/hexyl">Hexyl</a>?)</p>
<p dir="auto">To help you with that, the allocator exposes a few helper functions:</p>
<ul dir="auto">
<li><code>StupidAlloc.state()</code> returns a <code>HashMap</code> where the key is the address of the memory map (and so the address of the allocated object), and the value is a <code>PathBuf</code> to the associated file.</li>
<li><code>StupidAlloc</code> implements <code>fmt::Display</code>, so running <code>println!(&#34;{StupidAlloc}&#34;)</code> will print a lovely summary of all the allocations currently being tracked.</li>
<li><code>StupidAlloc.file_of(x)</code> will return the file associated to the linked object, if it exists. Obviously this only works with stuff allocated with the stupid allocator. An example of use:</li>
</ul>
<div dir="auto" data-snippet-clipboard-copy-content="// Still requires nightly
#![feature(allocator_api)]

use stupidalloc::StupidAlloc;

fn main() {
    let stupid_box = Box::new_in(1, StupidAlloc);

    // Since it&#39;s a Box&lt;i32&gt;, we need to pass &amp;i32 to the function to get the 
    // address of where the integer is.
    let file = StupidAlloc.file_of(&amp;*stupid_box).unwrap();

    // Go nuts with it!
}"><pre><span>// Still requires nightly</span>
<span>#!<span>[</span>feature<span>(</span>allocator_api<span>)</span><span>]</span></span>

<span>use</span> stupidalloc<span>::</span><span>StupidAlloc</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>let</span> stupid_box = <span>Box</span><span>::</span><span>new_in</span><span>(</span><span>1</span><span>,</span> <span>StupidAlloc</span><span>)</span><span>;</span>

    <span>// Since it&#39;s a Box&lt;i32&gt;, we need to pass &amp;i32 to the function to get the </span>
    <span>// address of where the integer is.</span>
    <span>let</span> file = <span>StupidAlloc</span><span>.</span><span>file_of</span><span>(</span><span>&amp;</span><span>*</span>stupid_box<span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>

    <span>// Go nuts with it!</span>
<span>}</span></pre></div>
<p dir="auto">Another cool usage is to be able to see how stuff is laid out in memory, without
having to use memory viewers or complicated GDB syntax!</p>
<p dir="auto">For example, ever wanted to see how a <code>Vec&lt;T&gt;</code> is organised in memory?</p>
<div dir="auto" data-snippet-clipboard-copy-content="use stupidalloc::StupidAlloc;

#[global_allocator]
static GLOBAL: StupidAlloc = StupidAlloc;

fn main() {
    let boxed_vec = Box::new(vec![1, 2, 3]);

    println!(&#34;{}&#34;, StupidAlloc.file_of(&amp;*boxed_vec).unwrap().display());

    // Somehow pause execution
}"><pre><span>use</span> stupidalloc<span>::</span><span>StupidAlloc</span><span>;</span>

<span>#<span>[</span>global_allocator<span>]</span></span>
<span>static</span> <span>GLOBAL</span><span>:</span> <span>StupidAlloc</span> = <span>StupidAlloc</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>let</span> boxed_vec = <span>Box</span><span>::</span><span>new</span><span>(</span><span>vec</span><span>!</span><span>[</span><span>1</span>, <span>2</span>, <span>3</span><span>]</span><span>)</span><span>;</span>

    <span>println</span><span>!</span><span>(</span><span>&#34;{}&#34;</span>, <span>StupidAlloc</span>.file_of<span>(</span>&amp;*boxed_vec<span>)</span>.unwrap<span>(</span><span>)</span>.display<span>(</span><span>)</span><span>)</span><span>;</span>

    <span>// Somehow pause execution</span>
<span>}</span></pre></div>
<p dir="auto">This program will print the path of the allocation file for the <code>Vec&lt;T&gt;</code> struct
(and not the allocation for the data of the <code>Vec</code>, because then we&#39;d only see
the numbers 1, 2, 3!). Open it in a hex viewer, and you can try and guess what
each field is, and try to corroborate it with the <a href="https://doc.rust-lang.org/stable/std/vec/struct.Vec.html" rel="nofollow">struct&#39;s definition</a>.
If your system allows you to (I know Windows can be a bit restrictive), try and
modify the length and/or capacity fields and see what happens afterwards!</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-disclaimers" aria-hidden="true" href="#disclaimers"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Disclaimers</h2>
<ul dir="auto">
<li>I do not claim that this library is perfect and free of any fault. Here there be typos and mistakes and examples that I didn&#39;t test and don&#39;t work. Send an issue if something&#39;s wrong!</li>
<li>If you don&#39;t have file picker / file dialog capabilities (minimal i3 installation, TTY-only, ...), <code>interactivity</code> won&#39;t work.</li>
<li>I only tested this on Windows and Linux. If it doesn&#39;t work on MacOS or any other OS, sorry. If it doesn&#39;t work for you on Windows or Linux: weird! Hit me up.</li>
<li>If you mess with the memory files in any way you&#39;ll mess up with your program memory, but seeing as this is topologically the same as messing with <code>/proc/mem</code> I consider this a cool feature.</li>
<li>I&#39;m probably going to work on this <em>a little bit more</em> to add some quality-of-life features, but that&#39;s it. It&#39;s a shitpost, not a serious library.</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-old-demo" aria-hidden="true" href="#old-demo"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>(old) Demo</h2>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span aria-label="Video description 2023-06-30.22-43-38.mp4">2023-06-30.22-43-38.mp4</span>
    <span></span>
  </summary>

  <video src="https://user-images.githubusercontent.com/68575248/250579436-f2490dc1-8412-4450-9359-7387f79682ea.mp4" data-canonical-src="https://user-images.githubusercontent.com/68575248/250579436-f2490dc1-8412-4450-9359-7387f79682ea.mp4" controls="controls" muted="muted">

  </video>
</details>

</article>
          </div></div>
  </body>
</html>
