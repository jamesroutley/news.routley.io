<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://steve.dignam.xyz/2025/06/20/interesting-bits-of-postgres-grammar/">Original</a>
    <h1>Interesting Bits of Postgres Grammar</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">
  

  <div itemprop="articleBody">
    <p>I’ve been working on <a href="https://squawkhq.com">Squawk</a> for a while, it’s a linter for PostgreSQL, and it <a href="https://github.com/sbdchd/squawk/releases/tag/v2.0.0">now</a> uses a <a href="https://github.com/sbdchd/squawk/blob/f68b1a81c03bbc3cc8e84bb2d2e5219ca2b610ac/crates/squawk_parser/src/grammar.rs">handmade parser</a>.</p>

<p>So let’s explore some interesting bits from the <a href="https://github.com/postgres/postgres/blob/2f6e240d7ac930698995ac608695cb0368f504f2/src/backend/parser/gram.y">Postgres grammar</a>.</p>

<h2 id="custom-operators">Custom Operators</h2>

<p><a href="https://github.com/postgres/postgres/blob/5861b1f343b52ac358912707788214fb8dc981e5/src/backend/parser/gram.y#L824C1-L834C70">Very few operators are defined in the grammar itself</a> and lots of Postgres features rely on custom operators.</p>

<p>For example, Postgres uses <a href="https://www.postgresql.org/docs/17/functions-geometry.html"><code>&lt;-&gt;</code> for comparing geometric types</a>, along with a whole host of others: <code>##</code>, <code>@-@</code>, <code>#</code>, <code>@&gt;</code>, <code>&lt;@&gt;</code>, <code>&amp;&lt;</code>, <code>&amp;&gt;</code>, <code>|&gt;&gt;</code>, <code>|&lt;&lt;</code>, <code>&lt;^</code>, <code>&gt;^</code>, <code>?-</code>, <code>?|</code>, <code>?||</code>, <code>~=</code>.</p>

<p>Note: custom operators can be prefix or infix, but not postfix.</p>

<p>A neat consequence of custom operators is that the following <a href="https://trino.io/docs/current/functions/lambda.html">lambda expression syntax from Trino</a> parses natively in Postgres:</p>

<div><div><pre><code><span>select</span> <span>array_filter</span><span>(</span>
  <span>array</span><span>[</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>],</span>
  <span>e</span> <span>-&gt;</span> <span>(</span><span>e</span> <span>%</span> <span>2</span><span>)</span> <span>=</span> <span>0</span>
<span>);</span>
</code></pre></div></div>

<p>Albiet with the wrong precedence.</p>

<h2 id="precedence-with-compound-selects">Precedence with Compound <code>select</code>s</h2>

<p>The following:</p>

<div><div><pre><code><span>select</span> <span>foo</span> <span>union</span> <span>select</span> <span>bar</span> <span>order</span> <span>by</span> <span>baz</span><span>;</span>
</code></pre></div></div>

<p>Parses the same as:</p>

<div><div><pre><code><span>(</span><span>select</span> <span>foo</span> <span>union</span> <span>select</span> <span>bar</span><span>)</span> <span>order</span> <span>by</span> <span>baz</span><span>;</span>
</code></pre></div></div>

<p>Meaning the <code>order by</code> clause is applied to the overall compound select.</p>

<h2 id="percent-types">Percent Types</h2>

<p>With <code>create function</code>, you can <a href="https://www.postgresql.org/docs/17/sql-createfunction.html">specify types based on a table’s column type</a>.</p>

<p>For example, using the type of column <code>c</code> on table <code>t</code>:</p>

<div><div><pre><code><span>create</span> <span>function</span> <span>f</span><span>(</span><span>a</span> <span>t</span><span>.</span><span>c</span><span>%</span><span>type</span><span>)</span>
<span>as</span> <span>&#39;select 1&#39;</span> <span>language</span> <span>plpgsql</span><span>;</span>
</code></pre></div></div>

<h2 id="string-continuation">String Continuation</h2>

<p>If you have two string literals separated by new lines, then they’ll be merged together:</p>



<p>returns <code>&#39;foobar&#39;</code></p>

<p>But if there’s a comment in between, it’s a syntax error:</p>

<div><div><pre><code><span>select</span> <span>&#39;foo&#39;</span> <span>/* hmm */</span>
<span>&#39;bar&#39;</span><span>;</span>
</code></pre></div></div>

<div><div><pre><code>Query 1 ERROR at Line 2: : ERROR:  syntax error at or near &#34;&#39;bar&#39;&#34;
LINE 2: &#39;bar&#39;;
        ^
</code></pre></div></div>

<p>This behavior is part of the <a href="https://www.postgresql.org/docs/17/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS">SQL standard</a>.</p>

<h2 id="quoted-idents">Quoted Idents</h2>

<p>In Postgres you can optionally quote your identifiers, so the following are the same:</p>

<div><div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>t</span><span>;</span>
<span>select</span> <span>*</span> <span>from</span> <span>&#34;t&#34;</span><span>;</span>
</code></pre></div></div>

<p>If you want to include a double quote in your identifier name, you can escape it like so:</p>

<div><div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>&#34;foo </span><span>&#34;&#34;</span><span> bar&#34;</span>
</code></pre></div></div>

<p>which will select from the <code>foo &#34; bar</code> table.</p>

<h2 id="unicode-escapes">Unicode Escapes</h2>

<p>You can also prefix quoted identifiers with <code>U&amp;</code> and pass unicode escape codes:</p>

<div><div><pre><code><span>-- `74` is the unicode number for `t`</span>
<span>select</span> <span>*</span> <span>from</span> <span>U</span><span>&amp;</span><span>&#34;</span><span>\0</span><span>074&#34;</span><span>;</span>
</code></pre></div></div>

<p>And if you want to change the escape character from <code>\</code>, you can write:</p>

<div><div><pre><code><span>-- `74` is the unicode number for `t`</span>
<span>select</span> <span>*</span> <span>from</span> <span>U</span><span>&amp;</span><span>&#34;!0074&#34;</span> <span>uescape</span> <span>&#39;!&#39;</span><span>;</span>
</code></pre></div></div>

<h2 id="operator-function">Operator Function</h2>

<p>Instead of using an operator directly:</p>



<p>You can use the operator function:</p>



<p>Which allows specifying the operator’s schema:</p>

<div><div><pre><code><span>select</span> <span>1</span> <span>operator</span><span>(</span><span>pg_catalog</span><span>.</span><span>+</span><span>)</span> <span>2</span><span>;</span>
</code></pre></div></div>

<p>It also works as a prefix operator:</p>



<h2 id="conclusion">Conclusion</h2>

<p>Overall, I think custom operators diverge the most from other mainstream languages and can be tricky to implement.</p>

  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
