<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/oxidecomputer/helios">Original</a>
    <h1>Helios: A distribution of Illumos powering the Oxide Rack</h1>
    
    <div id="readability-page-1" class="page"><div><p>I’ve noticed a common issue people bump into (including myself) more than once now when starting out with Rust, and thought I’d share what I’ve come to see as the natural solution!</p><p>For illustration purposes, let’s say you have this function that simulates a growing garden of plants:</p><pre data-lang="rust"><code data-lang="rust"><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;) </span><span>{
</span><span>  </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>    </span><span>*</span><span>plant_height </span><span>+= </span><span>4</span><span>; </span><span>//summer growth
</span><span>  </span><span>}
</span><span>  </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>    </span><span>*</span><span>plant_height </span><span>+= </span><span>2</span><span>; </span><span>//fall growth
</span><span>  </span><span>}
</span><span>  </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>    </span><span>*</span><span>plant_height </span><span>+= </span><span>1</span><span>; </span><span>//winter growth
</span><span>  </span><span>}
</span><span>  </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>    </span><span>*</span><span>plant_height </span><span>+= </span><span>3</span><span>; </span><span>//spring growth
</span><span>  </span><span>}
</span><span>
</span><span>  println!(</span><span>&#34;at the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, garden);
</span><span>}
</span></code></pre><p>one natural simplification is to make a small closure that can grow all plants some specified amount:</p><pre data-lang="rust"><code data-lang="rust"><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;) </span><span>{
</span><span>  </span><span>let </span><span>mut </span><span>grow_all </span><span>= </span><span>|</span><span>rate</span><span>| </span><span>{
</span><span>    </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>      </span><span>*</span><span>plant_height </span><span>+=</span><span> rate;
</span><span>    </span><span>}
</span><span>  </span><span>}</span><span>;
</span><span>  </span><span>grow_all</span><span>(</span><span>4</span><span>); </span><span>//summer growth
</span><span>  </span><span>grow_all</span><span>(</span><span>2</span><span>); </span><span>//fall growth
</span><span>  </span><span>grow_all</span><span>(</span><span>1</span><span>); </span><span>//winter growth
</span><span>  </span><span>grow_all</span><span>(</span><span>3</span><span>); </span><span>//spring growth
</span><span>
</span><span>  println!(</span><span>&#34;at the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, garden);
</span><span>}
</span></code></pre><p>Let’s say you now want to build out the model to simulate hurricanes, that sometimes destroy a plant between fall and winter, and you try to do this:</p><pre data-lang="rust"><code data-lang="rust"><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;) </span><span>{
</span><span>  </span><span>let </span><span>mut </span><span>grow_all </span><span>= </span><span>|</span><span>rate</span><span>| </span><span>{
</span><span>    </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>      </span><span>*</span><span>plant_height </span><span>+=</span><span> rate;
</span><span>    </span><span>}
</span><span>  </span><span>}</span><span>;
</span><span>  </span><span>grow_all</span><span>(</span><span>4</span><span>); </span><span>//summer growth
</span><span>  </span><span>grow_all</span><span>(</span><span>2</span><span>); </span><span>//fall growth
</span><span>  garden[</span><span>0</span><span>] </span><span>= </span><span>0</span><span>; </span><span>//hurricane destroyed least protected plant!
</span><span>  </span><span>grow_all</span><span>(</span><span>1</span><span>); </span><span>//winter growth
</span><span>  </span><span>grow_all</span><span>(</span><span>3</span><span>); </span><span>//spring growth
</span><span>
</span><span>  println!(</span><span>&#34;at the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, garden);
</span><span>}
</span></code></pre><p>Then rust blows up in your face!</p><pre data-lang="bash"><code data-lang="bash"><span>error[E0499]:</span><span> cannot borrow `</span><span>garden</span><span>` as mutable more than once at a time
</span><span>  </span><span>--</span><span>&gt;</span><span> src/lib.rs:11:3
</span><span>   </span><span>|
</span><span>4  </span><span>|   </span><span>let</span><span> mut grow_all </span><span>= |</span><span>rate</span><span>|</span><span> {
</span><span>   </span><span>|                      </span><span>------</span><span> first mutable borrow occurs here
</span><span>5  </span><span>|     for</span><span> plant_height </span><span>in &amp;</span><span>mut</span><span> garden {
</span><span>   |                              ------ first borrow occurs due to use of `</span><span>garden</span><span>` in closure
</span><span>...
</span><span>11 |   garden</span><span>[</span><span>0</span><span>]</span><span> = 0; //hurricane destroyed least protected plant!
</span><span>   |   ^^^^^^ second mutable borrow occurs here
</span><span>12 |   grow_all(1); //winter growth
</span><span>   |   -------- first borrow later used here
</span><span>
</span><span>For more information about this error, try `</span><span>rustc</span><span> --explain</span><span> E0499`.
</span></code></pre><p>The closure we created does use a mutable reference to garden, and keeps it until the function isn’t called anymore. Trying to use the variable somewhere else before this closure isn’t used anymore would violate rusts rules around only allowing one mutable borrow. But what should we do in these kinds of situations then?</p><p>One approach I’ve seen is to just make it a function that takes a mutable borrow to the garden, this way, it can give back the variable between calls:</p><pre data-lang="rust"><code data-lang="rust"><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;) </span><span>{
</span><span>  </span><span>fn </span><span>grow_all</span><span>(</span><span>garden</span><span>: </span><span>&amp;mut</span><span> [</span><span>u8</span><span>], </span><span>rate</span><span>: </span><span>u8</span><span>) </span><span>{
</span><span>    </span><span>for</span><span> plant_height </span><span>in</span><span> garden </span><span>{
</span><span>      </span><span>*</span><span>plant_height </span><span>+=</span><span> rate;
</span><span>    </span><span>}
</span><span>  </span><span>}
</span><span>  </span><span>grow_all</span><span>(</span><span>&amp;mut</span><span> garden, </span><span>4</span><span>); </span><span>//summer growth
</span><span>  </span><span>grow_all</span><span>(</span><span>&amp;mut</span><span> garden, </span><span>2</span><span>); </span><span>//fall growth
</span><span>  garden[</span><span>0</span><span>] </span><span>= </span><span>0</span><span>; </span><span>//hurricane destroyed least protected plant!
</span><span>  </span><span>grow_all</span><span>(</span><span>&amp;mut</span><span> garden, </span><span>1</span><span>); </span><span>//winter growth
</span><span>  </span><span>grow_all</span><span>(</span><span>&amp;mut</span><span> garden, </span><span>3</span><span>); </span><span>//spring growth
</span><span>
</span><span>  println!(</span><span>&#34;at the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, garden);
</span><span>}
</span></code></pre><p>I’d say this is okay, but feels a bit clumsy and isn’t great if you’re modifying more than one variable. Another approach I’ve seen is to create a macro:</p><pre data-lang="rust"><code data-lang="rust"><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;) </span><span>{
</span><span>
</span><span>    </span><span>macro_rules! </span><span>grow_all </span><span>{
</span><span>        (</span><span>$rate</span><span>:</span><span>expr</span><span>) </span><span>=&gt; </span><span>{
</span><span>            </span><span>for</span><span> plant_height </span><span>in &amp;mut</span><span> garden </span><span>{
</span><span>                </span><span>*</span><span>plant_height </span><span>+= </span><span>$rate</span><span>;
</span><span>            </span><span>}
</span><span>        </span><span>}</span><span>;
</span><span>    </span><span>}
</span><span>
</span><span>    grow_all!(</span><span>4</span><span>); </span><span>// Summer growth
</span><span>    grow_all!(</span><span>2</span><span>); </span><span>// Fall growth
</span><span>    garden[</span><span>0</span><span>] </span><span>= </span><span>0</span><span>; </span><span>// Hurricane destroyed least protected plant!
</span><span>    grow_all!(</span><span>1</span><span>); </span><span>// Winter growth
</span><span>    grow_all!(</span><span>3</span><span>); </span><span>// Spring growth
</span><span>
</span><span>    println!(</span><span>&#34;At the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, garden);
</span><span>}
</span></code></pre><p>This doesn’t feel great either to me. I expect macros to perform magic when needed, but shoveling dirt with them feels wrong (and potentially creates a lot of code duplication, even if it’s hidden in this case).</p><p>More often than not, it might be a sign that you want some behaviors associated with some collection of data, exactly what structs are for!</p><pre data-lang="rust"><code data-lang="rust"><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;) </span><span>{
</span><span>    
</span><span>    </span><span>struct </span><span>Garden </span><span>{ heights</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt; </span><span>}
</span><span>    
</span><span>    </span><span>impl </span><span>Garden </span><span>{
</span><span>        </span><span>fn </span><span>grow_all</span><span>(</span><span>&amp;mut </span><span>self</span><span>, </span><span>rate</span><span>: </span><span>u8</span><span>) </span><span>{
</span><span>            </span><span>for</span><span> plant_height </span><span>in &amp;mut </span><span>self</span><span>.</span><span>heights </span><span>{
</span><span>                </span><span>*</span><span>plant_height </span><span>+=</span><span> rate;
</span><span>            </span><span>}
</span><span>        </span><span>}
</span><span>    </span><span>}
</span><span>    
</span><span>    </span><span>let </span><span>mut</span><span> g </span><span>=</span><span> Garden </span><span>{</span><span> heights: garden </span><span>}</span><span>;
</span><span>
</span><span>    g</span><span>.</span><span>grow_all</span><span>(</span><span>4</span><span>); </span><span>// Summer growth
</span><span>    g</span><span>.</span><span>grow_all</span><span>(</span><span>2</span><span>); </span><span>// Fall growth
</span><span>    g</span><span>.</span><span>heights[</span><span>0</span><span>] </span><span>= </span><span>0</span><span>; </span><span>// Hurricane destroyed least protected plant!
</span><span>    g</span><span>.</span><span>grow_all</span><span>(</span><span>1</span><span>); </span><span>// Winter growth
</span><span>    g</span><span>.</span><span>grow_all</span><span>(</span><span>3</span><span>); </span><span>// Spring growth
</span><span>
</span><span>    println!(</span><span>&#34;At the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, g</span><span>.</span><span>heights);
</span><span>}
</span></code></pre><p>If this is a construct useful outside of this function, you might want to do this:</p><pre data-lang="rust"><code data-lang="rust"><span>struct </span><span>Garden </span><span>{ heights</span><span>: </span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt; </span><span>}
</span><span>    
</span><span>impl </span><span>Garden </span><span>{
</span><span>    </span><span>fn </span><span>grow_all</span><span>(</span><span>&amp;mut </span><span>self</span><span>, </span><span>rate</span><span>: </span><span>u8</span><span>) </span><span>{
</span><span>        </span><span>for</span><span> plant_height </span><span>in &amp;mut </span><span>self</span><span>.</span><span>heights </span><span>{
</span><span>            </span><span>*</span><span>plant_height </span><span>+=</span><span> rate;
</span><span>        </span><span>}
</span><span>    </span><span>}
</span><span>    
</span><span>    </span><span>fn </span><span>hurricane</span><span>(</span><span>&amp;mut </span><span>self</span><span>) </span><span>{
</span><span>        </span><span>self</span><span>.</span><span>heights[</span><span>0</span><span>] </span><span>= </span><span>0</span><span>;
</span><span>    </span><span>}
</span><span>}
</span><span>    
</span><span>fn </span><span>grow_garden_for_a_year</span><span>(</span><span>mut </span><span>garden</span><span>: Garden) </span><span>{
</span><span>
</span><span>    garden</span><span>.</span><span>grow_all</span><span>(</span><span>4</span><span>); </span><span>// Summer growth
</span><span>    garden</span><span>.</span><span>grow_all</span><span>(</span><span>2</span><span>); </span><span>// Fall growth
</span><span>    garden</span><span>.</span><span>hurricane</span><span>(); </span><span>// Hurricane destroyed least protected plant!
</span><span>    garden</span><span>.</span><span>grow_all</span><span>(</span><span>1</span><span>); </span><span>// Winter growth
</span><span>    garden</span><span>.</span><span>grow_all</span><span>(</span><span>3</span><span>); </span><span>// Spring growth
</span><span>
</span><span>    println!(</span><span>&#34;At the end of the year, plant heights are </span><span>{:?}</span><span>&#34;</span><span>, garden</span><span>.</span><span>heights);
</span><span>}
</span></code></pre><p>Even if it is a bit more verbose, I think it’s a great thing that Rust almost forces the realization that you are dealing with a collection of data that has some associated behaviors, and that this can be better expressed.</p><p>Let me know your thoughts!</p></div></div>
  </body>
</html>
