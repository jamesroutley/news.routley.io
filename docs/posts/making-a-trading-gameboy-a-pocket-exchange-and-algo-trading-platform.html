<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://questdb.io/blog/making-a-trading-gameboy/">Original</a>
    <h1>Making a trading Gameboy: A pocket exchange and algo trading platform</h1>
    
    <div id="readability-page-1" class="page"><article><p>QuestDB is a next-generation
  database for <a href="https://www.scannedinavian.com/market-data/">market data</a>. It offers premium ingestion throughput,
  enhanced SQL analytics that can power through analysis, and cost-saving hardware efficiency. It&#39;s
  <a href="https://github.com/questdb/questdb">open source</a>, applies open formats, and is ideal for <a href="https://www.scannedinavian.com/glossary/tick-data/">tick data</a>.</p>
<hr/>
<p>So in a nutshell I made this:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/gb-vid.gif" loading="lazy"/></p><figcaption>A trading Gameboy</figcaption></div></figure>
<h2 id="the-story">The story<a aria-label="Direct link to The story" title="Direct link to The story" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#the-story">​</a></h2>
<p>I didn&#39;t wake up one day thinking I&#39;d make a trading Gameboy.</p>
<p>It all came about gradually. Some might say I fell into a rabbit hole.</p>
<p>While it&#39;s satisfying to create something, I took the most pleasure in learning
new things and gradually solving new problems.</p>
<p>This post is to share much of that I have learned.</p>
<h2 id="from-displaying-a-price">From displaying a price...<a aria-label="Direct link to From displaying a price..." title="Direct link to From displaying a price..." href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#from-displaying-a-price">​</a></h2>
<p>My kid had a <a href="https://www.scannedinavian.com/blog/raspberry-pi-5-benchmark/" rel="">Raspberry Pi</a> and he loved it.</p>
<p>Debian came pre-installed with a version of minecraft, and he really enjoyed
having a tiny single-board computer with dangling wires. Unfortunately, the
bare-bones setup was also a weakness and we ended up stepping on the HDMI
connector and rendering the board unusable.</p>
<p>One day, he asked if I could get him a replacement. Upon checking the
<a href="https://www.raspberrypi.com/" rel="noopener noreferrer nofollow">Raspberry Pi website</a>, I came across the
Raspberry Pi Pico microcontroller and a basic electronic kit with buttons, LEDs,
and a two-line display which seemed more appropriate for his age.</p>
<p>Unlike the Raspberry Pi computer, the Pico is a microcontroller. Mostly this
means it&#39;s not running an operating system and instead can run simple code. They
are also typically less powerful with only 256kb of RAM instead of Gigabytes for
the bigger brother, and have a lower clock speed.</p>
<p>However, this also means the controller starts immediately running your code
upon power up, and it does not have to share resources to maintain an underlying
system. This results in low power consumption, making them appropriate for
battery-powered use cases.</p>
<p>After blinking a few coloured LEDs, we found that we could use potentiometers to
control how much electricity would go through the circuit. We could then read
this value from a screen. With some tinkering, we made a calculator which would
multiply two numbers which are set using the potentiometer:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/calculator.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<p>This was a pretty cool object to bring to school for a demo, and both of us were
pretty satisfied. But it then occurred to me that we could do so much more with
these, particularly as I found that some versions of the Pico microcontroller
contained a wireless chip.</p>
<p>So, as someone deeply interested in finance, I knew that <em>technically</em> nothing
could stop me from connecting to, say, an API and then display stock prices on
the screen. And that&#39;s what I ended up doing with the Raspberry Pi Pico, and a
matrix of LEDs:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/led-matrix.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<p>There were a few variations of this idea with train times and so on, but the
main concept was there. It then occurred to me that simply looking at a price
may not be as interesting, so I started experimenting with charts instead.</p>
<p>This meant using a different display, able to render more details. I found one
called the
<a href="https://shop.pimoroni.com/products/pico-display-pack-2-0?variant=39374122582099" rel="noopener noreferrer nofollow">Pimoroni Pico Display Pack 2.0</a>,
which came with a lot of benefits for my use case.</p>
<ul>
<li>First, it included a socket, which means one can simply fit the
microcontroller to the back of the display and not worry with wires.</li>
</ul>
<ul>
<li>
<p>Second, it came with 4 built-in buttons which also simplifies wiring.</p>
</li>
<li>
<p>Lastly, it has a
<a href="https://github.com/pimoroni/pimoroni-pico/blob/main/micropython/modules/picographics/README.md" rel="noopener noreferrer nofollow">pretty robust library</a>
which allows you to display primitives on a screen such as text, lines,
squares, circles, polygons, etc.</p>
</li>
</ul>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/display-pack.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<p>Above I used the buttons to allow the player to take a long or short position in
the underlying. However, I quickly found the game uninteresting because it was
purely based on luck: Watch a line on the screen and go long/short/flat.</p>
<p>I knew I wanted to gamify this, but had to find a different model to make it
enjoyable.</p>
<h2 id="to-making-markets">...To making markets<a aria-label="Direct link to ...To making markets" title="Direct link to ...To making markets" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#to-making-markets">​</a></h2>
<p>It then occurred to me that a market-making game would be more interesting.</p>
<p>When market-making, you are quoting on both exchanges and over the counter,
hedging in the underlying market and taking/managing risk. A large difference
between market making and the previous game is that in market making, you are
constantly quoting both sides, and other participants come and trade against
you.</p>
<p>But you don&#39;t decide whether to buy or sell, your counterparties do. However,
you can then decide what to do with this position, for example hedge it
immediately, warehouse it, etc.</p>
<p>One particularly satisfying dynamic was to offset the flow: Get a position
through someone hitting your quotes and shortly after receive an opposite trade
which closes this position. While you could have closed the position yourself,
waiting for passive flow instead means you don&#39;t cross the bid-ask spread and
maximise your margin.</p>
<p>It quickly dawned on me that four buttons would not be sufficient. This led me
to the rabbit hole of 3D printing. I won&#39;t go into too much detail here, but I
bought a
<a href="https://www.prusa3d.com/fr/produit/kit-de-l-original-prusa-mini-2/" rel="noopener noreferrer nofollow">Prusa Mini +</a>,
some calipers, and after some measurements, a lot of trial and error, and a
lousy soldering job, I ended up with this.</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/gameboy-first.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<h2 id="game-on">Game on!<a aria-label="Direct link to Game on!" title="Direct link to Game on!" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#game-on">​</a></h2>
<p>In this game, there is a red line representing the fair value, and your bid and
offer prices in green and blue. You can control your quotes by increasing or
decreasing the spread, and skewing your quotes up and down to attract more flow
on the side you&#39;re axed on (where you have a preference or bias towards buying
or selling).</p>
<p>Say you just bought a lot of XYZ. You probably want to sell and don&#39;t want to
buy more of it. You would then skew your quotes down by a few basis points which
makes it more likely for you to sell (you are giving a more aggressive sell
price), and conversely less likely to buy.</p>
<p>However, at this stage I started running into some issues. The first was that
building this was very tedious. I had to solder a lot of cables within this box.
In addition, I was unsatisfied with the software side and the game felt slow and
clunky.</p>
<p>So with the same concept, I went for a complete overhaul.</p>
<h3 id="the-idea-of-the-game">The idea of the game<a aria-label="Direct link to The idea of the game" title="Direct link to The idea of the game" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#the-idea-of-the-game">​</a></h3>
<p>In this game, you act as a market-maker on the ETF markets. Your job is to quote
a tradeable bid price and ask price on the exchange at all times, while
answering OTC requests for larger trades and managing your risk. You control
your prices through algo parameters and fight for being first in the orderbook
on the side you prefer to trade on. You can also place orders manually.</p>
<p>To manage your risk, you can trade in the underlying markets. For example, if
you sell S&amp;P 500 ETFs, you are short. To mitigate this risk, you can buy a hedge
instrument (for example S&amp;P500 futures) which are perfectly correlated to the
ETF and therefore render yourself immune to market movements.</p>
<p>As you trade the ETFs on exchange and OTC, you accumulate risk which you can
choose to neutralise in the hedge markets. Doing so has a cost and reduces the
margin you make on each trade. So does trading the ETF directly with the market
as you&#39;d pay the spread. You can execute hedges via algos such as TWAP which
make your hedge adjust slower, but also at a lower cost since you spread
execution over time.</p>
<p>If you&#39;re doing a good job, you capture a lot of flow, win a lot of trade
requests, and don&#39;t lose money nor take disproportionate risk. Events such as a
release new financial figures or major news happen from time to time, so you
want to make sure you&#39;re not outright long or short when this happens.
Additionally, you don&#39;t have the best latency, so you want to avoid keeping your
quotes during figures as you&#39;d be subject to latency arbitrage.</p>
<p>Overall this is a good representation of the dynamics of market-making in the
ETF space, and a good entry point for beginners or junior traders to understand
the basic principles behind it.</p>
<h2 id="improving-the-hardware">Improving the hardware<a aria-label="Direct link to Improving the hardware" title="Direct link to Improving the hardware" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#improving-the-hardware">​</a></h2>
<p>Let&#39;s dig more into the constructive details.</p>
<h3 id="pcb">PCB<a aria-label="Direct link to PCB" title="Direct link to PCB" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#pcb">​</a></h3>
<p>To avoid cutting and soldering wires, the solution was a printed circuit board
(PCB). I downloaded <a href="https://www.kicad.org/" rel="noopener noreferrer nofollow">Kicad</a>, which is an open-source PCB
design tool, and got started. To my surprise, the process was much easier than I
thought and I could go from complete zero to ordering my PCBs online in a couple
of days.</p>
<p>The first step is to design the diagram, which means listing all components and
their connections in a schematic way. In my case, the diagram looks like the
following:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/kicad-schema.webp" loading="lazy"/></p><figcaption>Click to zoom</figcaption></div></figure>
<p>The buttons are on the left-hand side. The microcontroller in the middle, the
display on the right. Other items include the speaker, the on-off button and the
battery management system which handles the lithium battery&#39;s charge and
discharge.</p>
<p>Once they are connected like this, the system knows I will need to route traces
between all these connector points, and we can start making the PCB.</p>
<p>To my surprise, the drawing of traces (the electrical connection between two
points) is done by hand. The schematic we just made only helps guiding
connections from one point to another and making sure all connections are
implemented.</p>
<p>So after designing the schematic, it was time to place the components on the
board and to draw the traces to join the related connectors:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/kicad-pcb.webp" loading="lazy"/></p><figcaption>Click to zoom</figcaption></div></figure>
<p>I was particularly pleased to find that I could leave some copper exposed to
display text. It&#39;s something I found visually attractive.</p>
<p>Anyways, once the components are placed on the board and the connections are
drawn, you can export gerber files which you can then upload on
<a href="https://www.pcbway.com/" rel="noopener noreferrer nofollow">PCB Way</a> to order the boards. They arrived within 4
days which is impressive considering that their manufacturing involves many
steps, and that they shipped from China.</p>
<h3 id="3d-printed-case">3D printed Case<a aria-label="Direct link to 3D printed Case" title="Direct link to 3D printed Case" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#3d-printed-case">​</a></h3>
<p>Kicad allows us to export the PCB 3D model and footprint. This meant I could
design a case around it to 3D print later:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/pcb-3d.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<p>What&#39;s nice is that you can import the model into something like Autodesk Fusion
360, and then design the case around it. In this instance, I projected the PCB
sketch imported from Kicad (the purple lines) and created a structure around it
using offsets from the Kicad drawing. I left some holes for the screws and used
the feature which automatically models the thread in 3D:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/box-drawing.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<p>I designed this with the intent of leaving the PCB exposed, so the case was
simply covering the back of the PCB and the battery. The result is the simple
case displayed in red below which 3D-prints in half an hours or so:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/case-view.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<h2 id="rewriting-the-software">Rewriting the software<a aria-label="Direct link to Rewriting the software" title="Direct link to Rewriting the software" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#rewriting-the-software">​</a></h2>
<p>As mentioned, there was a lot to improve in the first software iteration.</p>
<p>For this new one, I decided to start from scratch.</p>
<h3 id="reference-price">Reference price<a aria-label="Direct link to Reference price" title="Direct link to Reference price" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#reference-price">​</a></h3>
<p>The previous game model was based on a random walk of the price. I know, it&#39;s
not ideal. But I started this fetching real prices and I soon found that this
was not ideal for a game for a few reasons.</p>
<p>First, in the space of few minutes, the prices don&#39;t change that much. Creating
the reference price myself meant I could inject events such as market crashes
and whatnot to spice things up a bit.</p>
<p>Another consideration was that the API calls from the Pico took a long time, and
this was a blocking operation.</p>
<p>The model looks like the following:</p>
<div><div><pre tabindex="0"><code><span><span>async</span><span> </span><span>def</span><span> </span><span>flow</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>BLUE</span><span>}</span><span>EXCHANGE</span><span>{</span><span>ENDC</span><span>}</span><span>: </span><span>{</span><span>GREEN</span><span>}</span><span>Start Ref Price Service</span><span>{</span><span>ENDC</span><span>}</span><span>&#39;</span><span>)</span><span></span><br/></span><span><span>    </span><span>while</span><span> self</span><span>.</span><span>running</span><span>:</span><span></span><br/></span><span><span>        self</span><span>.</span><span>price </span><span>=</span><span> </span><span>round</span><span>(</span><span>self</span><span>.</span><span>price</span><br/></span><span><span>                           </span><span>*</span><span> </span><span>(</span><span>1</span><span> </span><span>+</span><span> self</span><span>.</span><span>next_jump</span><span>)</span><span></span><br/></span><span><span>                           </span><span>+</span><span> random</span><span>.</span><span>uniform</span><span>(</span><span>-</span><span>0.01</span><span>,</span><span> </span><span>0.01</span><span>)</span><span> </span><span>*</span><span> random</span><span>.</span><span>uniform</span><span>(</span><span>0.0</span><span>,</span><span> </span><span>5.0</span><span>)</span><span> </span><span>*</span><span> self</span><span>.</span><span>vol_multiplier</span><span>,</span><span> </span><span>2</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>next_jump </span><span>=</span><span> </span><span>0</span><span></span><br/></span><span><span></span><br/></span><span><span></span><br/></span><span><span>        </span><span>if</span><span> self</span><span>.</span><span>figures_mode</span><span>:</span><span></span><br/></span><span><span>            self</span><span>.</span><span>figures_elapsed </span><span>+=</span><span> </span><span>1</span><span></span><br/></span><span><span>            </span><span>if</span><span> self</span><span>.</span><span>figures_elapsed </span><span>&gt;</span><span> self</span><span>.</span><span>figures_duration</span><span>:</span><span></span><br/></span><span><span>                self</span><span>.</span><span>figures_mode </span><span>=</span><span> </span><span>False</span><span></span><br/></span><span><span>                self</span><span>.</span><span>figures_elapsed </span><span>=</span><span> </span><span>0</span><span></span><br/></span><span><span>                self</span><span>.</span><span>reset_volatility</span><span>(</span><span>)</span><span></span><br/></span><span><span>                </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>RED</span><span>}</span><span>JUMP</span><span>{</span><span>ENDC</span><span>}</span><span>: Exit high vola mode&#39;</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>        </span><span>else</span><span>:</span><span></span><br/></span><span><span>            self</span><span>.</span><span>ticks_to_next_jump </span><span>-=</span><span> </span><span>1</span><span></span><br/></span><span><span>            </span><span>if</span><span> self</span><span>.</span><span>ticks_to_next_jump </span><span>&lt;</span><span> </span><span>0</span><span>:</span><span></span><br/></span><span><span>                </span><span>from</span><span> config </span><span>import</span><span> FIGURES_VOL_MULT</span><br/></span><span><span>                self</span><span>.</span><span>figures_mode </span><span>=</span><span> </span><span>True</span><span></span><br/></span><span><span>                self</span><span>.</span><span>set_next_jump_time</span><span>(</span><span>)</span><span></span><br/></span><span><span>                self</span><span>.</span><span>introduce_jump</span><span>(</span><span>)</span><span></span><br/></span><span><span>                self</span><span>.</span><span>change_volatility</span><span>(</span><span>FIGURES_VOL_MULT </span><span>*</span><span> self</span><span>.</span><span>vol_multiplier</span><span>)</span><span></span><br/></span><span><span>                </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>RED</span><span>}</span><span>JUMP</span><span>{</span><span>ENDC</span><span>}</span><span>: Jump triggered&#39;</span><span>)</span><span></span><br/></span><span><span>                </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>RED</span><span>}</span><span>JUMP</span><span>{</span><span>ENDC</span><span>}</span><span>: Enter high vola mode&#39;</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>        </span><span>await</span><span> aio</span><span>.</span><span>sleep_ms</span><span>(</span><span>self</span><span>.</span><span>tick_rate</span><span>)</span><br/></span></code></pre></div></div>
<p>Essentially, the whole game is based around a reference price, and that
reference price moves between two ticks following a random walk.</p>
<p>However, I introduced a figures concept whereby at certain moments, economic
figures are released, and the price jumps at that time. Then, markets are more
volatile (the price changes by a larger amount between two ticks), until such
point that it reverts to normal trading mode with standard volatility.</p>
<p>You can think of this reference price as the &#39;fair&#39; price for the consensus of
market participants.</p>
<h3 id="exchange">Exchange<a aria-label="Direct link to Exchange" title="Direct link to Exchange" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#exchange">​</a></h3>
<p>With a reference price, I can start constructing other concepts. In the previous
iteration, there was only one bid and offer, meaning the player always won the
trades.</p>
<p>Because of this, I simulated the effects of player actions (skew and spread) by
affecting the relative probabilities that a player would receive a trade on
either bid or offer sides at each tick.</p>
<p>In this iteration, I wanted to simulate the dynamics of a real orderbook and
queue position. In the real world, you only get the trade if you&#39;re first in the
queue, and I wanted a similar dynamic:</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> exchange</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>from</span><span> config </span><span>import</span><span> MAX_OB_SIZE</span><br/></span><span><span>    self</span><span>.</span><span>sell_orders </span><span>=</span><span> </span><span>[</span><span>]</span><span></span><br/></span><span><span>    self</span><span>.</span><span>buy_orders </span><span>=</span><span> </span><span>[</span><span>]</span><span></span><br/></span><span><span>    self</span><span>.</span><span>exchange </span><span>=</span><span> exchange</span><br/></span><span><span>    self</span><span>.</span><span>max_order_count </span><span>=</span><span> MAX_OB_SIZE</span><br/></span><span><span>    self</span><span>.</span><span>last_order_type </span><span>=</span><span> </span><span>None</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>def</span><span> </span><span>add_order</span><span>(</span><span>self</span><span>,</span><span> trader_id</span><span>,</span><span> order_type</span><span>,</span><span> price</span><span>,</span><span> quantity</span><span>,</span><span> is_quote</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>&#34;&#34;&#34;</span><br/></span><span><span>    Adds an order to the correct heap.</span><br/></span><span><span>    Sets self.last_order_type so that the matching engine knows who</span><br/></span><span><span>    was the aggressor. Otherwise, it may execute trades at the limit from the</span><br/></span><span><span>    aggressor instead of the resting order.</span><br/></span><span><span>    &#34;&#34;&#34;</span><span></span><br/></span><span><span>    </span><span>if</span><span> trader_id </span><span>in</span><span> self</span><span>.</span><span>exchange</span><span>.</span><span>traders</span><span>:</span><span></span><br/></span><span><span>        order </span><span>=</span><span> Order</span><span>(</span><span>trader_id</span><span>,</span><span> price</span><span>,</span><span> quantity</span><span>,</span><span> is_quote</span><span>)</span><span></span><br/></span><span><span>        </span><span>if</span><span> order_type </span><span>==</span><span> </span><span>&#39;buy&#39;</span><span>:</span><span></span><br/></span><span><span>            heapq</span><span>.</span><span>heappush</span><span>(</span><span>self</span><span>.</span><span>buy_orders</span><span>,</span><span> </span><span>(</span><span>-</span><span>price</span><span>,</span><span> order</span><span>)</span><span>)</span><span></span><br/></span><span><span>        </span><span>elif</span><span> order_type </span><span>==</span><span> </span><span>&#39;sell&#39;</span><span>:</span><span></span><br/></span><span><span>            heapq</span><span>.</span><span>heappush</span><span>(</span><span>self</span><span>.</span><span>sell_orders</span><span>,</span><span> </span><span>(</span><span>price</span><span>,</span><span> order</span><span>)</span><span>)</span><span></span><br/></span><span><span>        </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>BLUE</span><span>}</span><span>EXCHANGE</span><span>{</span><span>ENDC</span><span>}</span><span>: </span><span>{</span><span>ORANGE</span><span>}</span><span>new </span><span>{</span><span>&#34;quote&#34;</span><span> </span><span>if</span><span> is_quote </span><span>else</span><span> </span><span>&#34;order&#34;</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span>: trader:</span><span>{</span><span>GREEN</span><span>}</span><span>{</span><span>trader_id</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> - </span><span>{</span><span>RED</span><span>}</span><span>{</span><span>order_type</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> - </span><span>{</span><span>CYAN</span><span>}</span><span>{</span><span>quantity</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> @ </span><span>{</span><span>RED</span><span>}</span><span>{</span><span>price</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span>&#39;</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>last_order_type </span><span>=</span><span> order_type</span><br/></span><span><span>        self</span><span>.</span><span>_match_orders</span><span>(</span><span>)</span><span></span><br/></span><span><span>    </span><span>else</span><span>:</span><span></span><br/></span><span><span>        </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>BLUE</span><span>}</span><span>EXCHANGE</span><span>{</span><span>ENDC</span><span>}</span><span>: </span><span>{</span><span>RED</span><span>}</span><span>REJECTED ORDER</span><span>{</span><span>ENDC</span><span>}</span><span> trader_id </span><span>{</span><span>trader_id</span><span>}</span><span> is not registered&#39;</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>def</span><span> </span><span>_match_orders</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>&#34;&#34;&#34;</span><br/></span><span><span>    This is the main logic of the matching engine</span><br/></span><span><span>    Checks buy and sell orders both exist</span><br/></span><span><span>    Then enters a loop while the best bid &gt;= best ask</span><br/></span><span><span>    Exits loop and matching when that stops being the case</span><br/></span><span><span>    When there is a match, issues a trade on both sides and reduces the</span><br/></span><span><span>    remaining order by the matching size.</span><br/></span><span><span>    &#34;&#34;&#34;</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>while</span><span> self</span><span>.</span><span>buy_orders </span><span>and</span><span> self</span><span>.</span><span>sell_orders</span><span>:</span><span></span><br/></span><span><span>        best_buy </span><span>=</span><span> self</span><span>.</span><span>buy_orders</span><span>[</span><span>0</span><span>]</span><span>[</span><span>1</span><span>]</span><span></span><br/></span><span><span>        best_sell </span><span>=</span><span> self</span><span>.</span><span>sell_orders</span><span>[</span><span>0</span><span>]</span><span>[</span><span>1</span><span>]</span><span></span><br/></span><span><span></span><br/></span><span><span>        </span><span>if</span><span> </span><span>-</span><span>self</span><span>.</span><span>buy_orders</span><span>[</span><span>0</span><span>]</span><span>[</span><span>0</span><span>]</span><span> </span><span>&gt;=</span><span> self</span><span>.</span><span>sell_orders</span><span>[</span><span>0</span><span>]</span><span>[</span><span>0</span><span>]</span><span>:</span><span></span><br/></span><span><span>            trade_quantity </span><span>=</span><span> </span><span>min</span><span>(</span><span>best_buy</span><span>.</span><span>quantity</span><span>,</span><span> best_sell</span><span>.</span><span>quantity</span><span>)</span><span></span><br/></span><span><span>            </span><span>if</span><span> self</span><span>.</span><span>last_order_type </span><span>==</span><span> </span><span>&#39;buy&#39;</span><span>:</span><span></span><br/></span><span><span>                trade_price </span><span>=</span><span> best_sell</span><span>.</span><span>price</span><br/></span><span><span>            </span><span>else</span><span>:</span><span></span><br/></span><span><span>                trade_price </span><span>=</span><span> </span><span>-</span><span>self</span><span>.</span><span>buy_orders</span><span>[</span><span>0</span><span>]</span><span>[</span><span>0</span><span>]</span><span></span><br/></span><span><span></span><br/></span><span><span>            best_buy</span><span>.</span><span>quantity </span><span>-=</span><span> trade_quantity</span><br/></span><span><span>            best_sell</span><span>.</span><span>quantity </span><span>-=</span><span> trade_quantity</span><br/></span><span><span>            edge </span><span>=</span><span> </span><span>int</span><span>(</span><span>(</span><span>trade_price </span><span>/</span><span> self</span><span>.</span><span>exchange</span><span>.</span><span>rpm</span><span>.</span><span>get_ref_price</span><span>(</span><span>)</span><span> </span><span>-</span><span>1</span><span>)</span><span> </span><span>*</span><span> </span><span>10_000</span><span>)</span><span></span><br/></span><span><span>            </span><span>print</span><span>(</span><span>f&#34;</span><span>{</span><span>BLUE</span><span>}</span><span>EXCHANGE</span><span>{</span><span>ENDC</span><span>}</span><span>: </span><span>{</span><span>ORANGE</span><span>}</span><span>New trade</span><span>{</span><span>ENDC</span><span>}</span><span>: </span><span>{</span><span>GREEN</span><span>}</span><span>{</span><span>trade_quantity</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> @ </span><span>{</span><span>RED</span><span>}</span><span>{</span><span>trade_price</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> between </span><span>{</span><span>GREEN</span><span>}</span><span>trader </span><span>{</span><span>best_buy</span><span>.</span><span>trader_id</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> and </span><span>{</span><span>GREEN</span><span>}</span><span>trader </span><span>{</span><span>best_sell</span><span>.</span><span>trader_id</span><span>}</span><span>{</span><span>ENDC</span><span>}</span><span> EDGE: </span><span>{</span><span>edge</span><span>}</span><span>&#34;</span><span>)</span><span></span><br/></span><span><span>            self</span><span>.</span><span>exchange</span><span>.</span><span>notify_trade_listeners</span><span>(</span><span>Trade</span><span>(</span><span>best_buy</span><span>.</span><span>trader_id</span><span>,</span><span> best_sell</span><span>.</span><span>trader_id</span><span>,</span><span> trade_quantity</span><span>,</span><span> trade_price</span><span>,</span><span> edge</span><span>,</span><span> self</span><span>.</span><span>last_order_type</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>)</span><span>)</span><span></span><br/></span><span><span>            self</span><span>.</span><span>exchange</span><span>.</span><span>risk_engine</span><span>.</span><span>register_etf_trade</span><span>(</span><span>best_buy</span><span>.</span><span>trader_id</span><span>,</span><span> </span><span>&#39;buy&#39;</span><span>,</span><span> trade_quantity</span><span>,</span><span> trade_price</span><span>)</span><span></span><br/></span><span><span>            self</span><span>.</span><span>exchange</span><span>.</span><span>risk_engine</span><span>.</span><span>register_etf_trade</span><span>(</span><span>best_sell</span><span>.</span><span>trader_id</span><span>,</span><span> </span><span>&#39;sell&#39;</span><span>,</span><span> trade_quantity</span><span>,</span><span> trade_price</span><span>)</span><span></span><br/></span><span><span>            </span><span>if</span><span> best_buy</span><span>.</span><span>quantity </span><span>==</span><span> </span><span>0</span><span>:</span><span></span><br/></span><span><span>                heapq</span><span>.</span><span>heappop</span><span>(</span><span>self</span><span>.</span><span>buy_orders</span><span>)</span><span></span><br/></span><span><span>            </span><span>if</span><span> best_sell</span><span>.</span><span>quantity </span><span>==</span><span> </span><span>0</span><span>:</span><span></span><br/></span><span><span>                heapq</span><span>.</span><span>heappop</span><span>(</span><span>self</span><span>.</span><span>sell_orders</span><span>)</span><span></span><br/></span><span><span>        </span><span>else</span><span>:</span><span></span><br/></span><span><span>            </span><span>break</span><br/></span></code></pre></div></div>
<p>The logic is that traders can add orders to the bid and ask sides of the
orderbook. These are then stored in a heapq.</p>
<p>Since the micropython implementation only implements minheap, I had to store one
of the sides by taking the opposite of the price so that it would be stored in
the correct order. This is why some negative signs appear in the code suce as
this <code>-self.buy_orders[0][0] &gt;= self.sell_orders[0][0]</code>.</p>
<h3 id="creating-agents">Creating agents<a aria-label="Direct link to Creating agents" title="Direct link to Creating agents" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#creating-agents">​</a></h3>
<p>Having done this, I could start creating agents. These agents would, for
example, place orders randomly in the book with a price relative to the current
reference price:</p>
<div><div><pre tabindex="0"><code><span><span>async</span><span> </span><span>def</span><span> </span><span>start_bot</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>from</span><span> random </span><span>import</span><span> choice</span><span>,</span><span> randint</span><br/></span><span><span>    </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>BLUE</span><span>}</span><span>EXCHANGE</span><span>{</span><span>ENDC</span><span>}</span><span>: </span><span>{</span><span>GREEN</span><span>}</span><span>bot online</span><span>{</span><span>ENDC</span><span>}</span><span>&#39;</span><span>)</span><span></span><br/></span><span><span>    </span><span>while</span><span> </span><span>True</span><span>:</span><span></span><br/></span><span><span>        ref_price </span><span>=</span><span> self</span><span>.</span><span>rpm</span><span>.</span><span>get_ref_price</span><span>(</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>orderbook</span><span>.</span><span>add_order</span><span>(</span><span>randint</span><span>(</span><span>0</span><span>,</span><span> self</span><span>.</span><span>bot_count</span><span>-</span><span>1</span><span>)</span><span>,</span><span></span><br/></span><span><span>                                 choice</span><span>(</span><span>[</span><span>&#39;buy&#39;</span><span>,</span><span> </span><span>&#39;sell&#39;</span><span>]</span><span>)</span><span>,</span><span></span><br/></span><span><span>                                 randint</span><span>(</span><span>int</span><span>(</span><span>0.995</span><span> </span><span>*</span><span> ref_price </span><span>*</span><span> </span><span>100</span><span>)</span><span>,</span><span> </span><span>int</span><span>(</span><span>1.005</span><span> </span><span>*</span><span> ref_price </span><span>*</span><span> </span><span>100</span><span>)</span><span>)</span><span> </span><span>/</span><span> </span><span>100</span><span>,</span><span></span><br/></span><span><span>                                 randint</span><span>(</span><span>20</span><span>,</span><span> </span><span>800</span><span>)</span><span>,</span><span></span><br/></span><span><span>                                 </span><span>False</span><span>)</span><span></span><br/></span><span><span>        </span><span>await</span><span> aio</span><span>.</span><span>sleep_ms</span><span>(</span><span>self</span><span>.</span><span>bot_loop_ms</span><span>)</span><br/></span></code></pre></div></div>
<p>The result of the above is a stream of orders coming on both sides of the
orderbook.</p>
<p>Some of these orders are resting, and populate the orderbook.</p>
<p>Some are crossing the spread, taking liquidity from the book, and resulting in
trade matches.</p>
<p>When a trade happens, both counterparties are notified, and the risk engine is
updated with the new positions.</p>
<p>This is a simple placeholder for now, but it&#39;s relatively easy to implement a
set of smarter agents, each with their own logic and incentives, including
competing market-makers, and arbitrageurs.</p>
<p>The player logic is different and more akin to controlling an algo:</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>player_turn</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>from</span><span> master</span><span>.</span><span>cash_market_manager </span><span>import</span><span> HedgeOrder</span><br/></span><span><span>    </span><span>if</span><span> self</span><span>.</span><span>turns_awaited </span><span>&gt;=</span><span> self</span><span>.</span><span>turn_latency</span><span>:</span><span></span><br/></span><span><span>        self</span><span>.</span><span>turns_awaited </span><span>=</span><span> </span><span>0</span><span></span><br/></span><span><span>        self</span><span>.</span><span>cancel_quotes</span><span>(</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>calculate_quotes</span><span>(</span><span>)</span><span></span><br/></span><span><span>        </span><span>if</span><span> self</span><span>.</span><span>quoting</span><span>:</span><span></span><br/></span><span><span>            self</span><span>.</span><span>exchange</span><span>.</span><span>orderbook</span><span>.</span><span>add_order</span><span>(</span><span>self</span><span>.</span><span>trader_id</span><span>,</span><span> </span><span>&#39;buy&#39;</span><span>,</span><span> self</span><span>.</span><span>own_bid</span><span>,</span><span> self</span><span>.</span><span>clip_size</span><span>,</span><span> </span><span>True</span><span>)</span><span></span><br/></span><span><span>            self</span><span>.</span><span>exchange</span><span>.</span><span>orderbook</span><span>.</span><span>add_order</span><span>(</span><span>self</span><span>.</span><span>trader_id</span><span>,</span><span> </span><span>&#39;sell&#39;</span><span>,</span><span> self</span><span>.</span><span>own_ask</span><span>,</span><span> self</span><span>.</span><span>clip_size</span><span>,</span><span> </span><span>True</span><span>)</span><span></span><br/></span><span><span>        </span><span>if</span><span> self</span><span>.</span><span>auto_hedge_active</span><span>:</span><span></span><br/></span><span><span>            self</span><span>.</span><span>exchange</span><span>.</span><span>cash_market</span><span>.</span><span>cancel_hedges</span><span>(</span><span>self</span><span>.</span><span>trader_id</span><span>)</span><span></span><br/></span><span><span>            risk </span><span>=</span><span> self</span><span>.</span><span>exchange</span><span>.</span><span>risk_engine</span><span>.</span><span>risk_metrics</span><span>[</span><span>self</span><span>.</span><span>trader_id</span><span>]</span><span></span><br/></span><span><span>            q </span><span>=</span><span> </span><span>-</span><span>risk</span><span>.</span><span>etf_position </span><span>-</span><span> risk</span><span>.</span><span>hedge_position</span><br/></span><span><span>            </span><span>if</span><span> </span><span>abs</span><span>(</span><span>q</span><span>)</span><span> </span><span>&gt;</span><span> self</span><span>.</span><span>auto_hedge_threshold</span><span>:</span><span></span><br/></span><span><span>                side_is_buy </span><span>=</span><span> </span><span>True</span><span> </span><span>if</span><span> q </span><span>&gt;</span><span> </span><span>0</span><span> </span><span>else</span><span> </span><span>False</span><span></span><br/></span><span><span>                self</span><span>.</span><span>exchange</span><span>.</span><span>cash_market</span><span>.</span><span>add_cash_order</span><span>(</span><span>HedgeOrder</span><span>(</span><span>side_is_buy</span><span>,</span><span> </span><span>abs</span><span>(</span><span>q</span><span>)</span><span>,</span><span> self</span><span>.</span><span>trader_id</span><span>,</span><span> </span><span>max</span><span>(</span><span>20</span><span>,</span><span>int</span><span>(</span><span>abs</span><span>(</span><span>q</span><span>)</span><span>/</span><span>20</span><span>)</span><span>)</span><span>)</span><span>)</span><span></span><br/></span><span><span>    </span><span>else</span><span>:</span><span></span><br/></span><span><span>        self</span><span>.</span><span>turns_awaited </span><span>+=</span><span> </span><span>1</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>def</span><span> </span><span>calculate_quotes</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    spot </span><span>=</span><span> self</span><span>.</span><span>rpm_price</span><br/></span><span><span>    spot_skewed </span><span>=</span><span> spot </span><span>*</span><span> </span><span>(</span><span>1</span><span> </span><span>+</span><span> self</span><span>.</span><span>skew_bps </span><span>/</span><span> </span><span>10000</span><span>)</span><span></span><br/></span><span><span>    half_spread </span><span>=</span><span> spot_skewed </span><span>*</span><span> self</span><span>.</span><span>spread_bps </span><span>/</span><span> </span><span>10000</span><span> </span><span>/</span><span> </span><span>2</span><span></span><br/></span><span><span>    self</span><span>.</span><span>own_bid</span><span>,</span><span> self</span><span>.</span><span>own_ask </span><span>=</span><span> </span><span>round</span><span>(</span><span>spot_skewed </span><span>-</span><span> half_spread</span><span>,</span><span> </span><span>2</span><span>)</span><span>,</span><span> </span><span>round</span><span>(</span><span>spot_skewed </span><span>+</span><span> half_spread</span><span>,</span><span> </span><span>2</span><span>)</span><br/></span></code></pre></div></div>
<p>The parameter <code>turn_latency</code> is so that a player&#39;s algo can only update quotes
periodically. This replicates the throttling implemented by exchanges whereby
traders cannot continuously update their quotes with every tick.</p>
<p>When the latency has elapsed, a few things happen:</p>
<ol>
<li>The current player quotes are cancelled with the exchange</li>
<li>New quotes are calculated using the current quoting parameters</li>
<li>The quotes are sent back to the exchange.</li>
</ol>
<p>In addition, other orders may be sent automatically to another market for
hedging if the player sets up their algo to automatically hedge the flow.</p>
<h3 id="display">Display<a aria-label="Direct link to Display" title="Direct link to Display" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#display">​</a></h3>
<p>I decided to split the display into a bunch of sections which can be rendered
separately.</p>
<p>For example, here is the class displaying the current ref price on the screen.</p>
<div><div><pre tabindex="0"><code><span><span>from</span><span> frames</span><span>.</span><span>bounded_area </span><span>import</span><span> BoundedArea</span><br/></span><span><span></span><span>from</span><span> config </span><span>import</span><span> CHART_WIDTH</span><br/></span><span><span></span><br/></span><span><span></span><span>class</span><span> </span><span>PriceSection</span><span>:</span><span></span><br/></span><span><span>    </span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> player</span><span>,</span><span> display</span><span>)</span><span>:</span><span></span><br/></span><span><span>        </span><span>from</span><span> config </span><span>import</span><span> PRICE_SECTION_HEIGHT</span><br/></span><span><span>        self</span><span>.</span><span>player </span><span>=</span><span> player</span><br/></span><span><span>        self</span><span>.</span><span>area </span><span>=</span><span> BoundedArea</span><span>(</span><span>display</span><span>,</span><span> </span><span>1</span><span> </span><span>+</span><span> CHART_WIDTH</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>320</span><span> </span><span>-</span><span> </span><span>1</span><span> </span><span>-</span><span> CHART_WIDTH </span><span>-</span><span> </span><span>1</span><span>,</span><span></span><br/></span><span><span>                                PRICE_SECTION_HEIGHT</span><span>,</span><span> </span><span>&#39;GRAY&#39;</span><span>,</span><span> </span><span>&#39;BLACK&#39;</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>def</span><span> </span><span>plot_all</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>        self</span><span>.</span><span>area</span><span>.</span><span>draw_background</span><span>(</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>display_price</span><span>(</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>area</span><span>.</span><span>draw_perimeter</span><span>(</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>def</span><span> </span><span>display_price</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>        price </span><span>=</span><span> self</span><span>.</span><span>player</span><span>.</span><span>ref_prices</span><span>.</span><span>array</span><span>[</span><span>-</span><span>1</span><span>]</span><span></span><br/></span><span><span>        self</span><span>.</span><span>area</span><span>.</span><span>write_centred</span><span>(</span><span>&#39;{0:.2f}&#39;</span><span>.</span><span>format</span><span>(</span><span>price</span><span>)</span><span>,</span><span> </span><span>&#39;WHITE&#39;</span><span>,</span><span> </span><span>1</span><span> </span><span>+</span><span> CHART_WIDTH</span><span>,</span><span></span><br/></span><span><span>                                </span><span>320</span><span> </span><span>-</span><span> </span><span>1</span><span> </span><span>-</span><span> CHART_WIDTH </span><span>-</span><span> </span><span>1</span><span>,</span><span> </span><span>5</span><span>,</span><span> </span><span>2</span><span>)</span><br/></span></code></pre></div></div>
<p>So in this case, this is what displays the price in the top-right corner with a
value of 50.22:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/display-price.webp" loading="lazy"/></p><figcaption></figcaption></div></figure>
<p>There are multiple other sections like this. The one displaying the chart area,
the one with the controls, the news, the risk section, the market depth chart,
the orderbook table, the trades feed, and so on.</p>
<p>By rendering them independently, I can then place them relatively to one another
and potentially schedule their update cycles at different moments if needed.</p>
<h2 id="some-things-i-learned">Some things I learned<a aria-label="Direct link to Some things I learned" title="Direct link to Some things I learned" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#some-things-i-learned">​</a></h2>
<h3 id="buttons-are-not-that-simple">Buttons are not that simple<a aria-label="Direct link to Buttons are not that simple" title="Direct link to Buttons are not that simple" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#buttons-are-not-that-simple">​</a></h3>
<p>It is really easy to program a microcontroller to react to a button press.
Connect the button, and write some micropython like the following:</p>
<div><div><pre tabindex="0"><code><span><span>import</span><span> machine</span><br/></span><span><span>button </span><span>=</span><span> machine</span><span>.</span><span>Pin</span><span>(</span><span>12</span><span>,</span><span> machine</span><span>.</span><span>Pin</span><span>.</span><span>IN</span><span>,</span><span> machine</span><span>.</span><span>Pin</span><span>.</span><span>PULL_UP</span><span>)</span><span></span><br/></span><span><span></span><span>while</span><span> </span><span>True</span><span>:</span><span></span><br/></span><span><span>    </span><span>if</span><span> </span><span>not</span><span> button</span><span>.</span><span>value</span><span>(</span><span>)</span><span>:</span><span></span><br/></span><span><span>        </span><span>print</span><span>(</span><span>&#39;Button pressed!&#39;</span><span>)</span><br/></span></code></pre></div></div>
<p>However when the program becomes larger, this approach stops working. One of the
reasons is that you may be pressing the button at the moment where the loop is
executing some other code.</p>
<p>By the time your code gets back to evaluating <code>button.value()</code>, you may have
released it. Ideally, you&#39;d want your inputs to be immediately registered.</p>
<p>Another consideration is that button presses, from a signal perspective, are not
how one intuitively may think. Instinct tells us that the button is an on/off
switch, and therefore pressing it should look like the following:</p>
<div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span>____________|-----------------------|__________________</span><br/></span><span><span>            ^                       v</span><br/></span><span><span>          press                  release</span><br/></span></code></pre></div></div>
<p>However, in practice, it looked more like the following.</p>
<div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span>____________|-|_|-|_|-|_|--------|__________________</span><br/></span><span><span>            ^                       v</span><br/></span><span><span>          press                  release</span><br/></span></code></pre></div></div>
<p>It seems like the signal needs to stabilise after a button press and may
oscillate initially, even if the button is pressed continuously. This has two
consequences.</p>
<ul>
<li>First, it means you may register several presses instead of one.</li>
</ul>
<ul>
<li>Second, depending on timing, your software may not register a button press if
the signal jumped to the low state at that exact time.</li>
</ul>
<p>To circumvent this, I used <code>interrupt requests</code> which will monitor a signal
change and interrupt execution to run the routine called by the button press. I
coupled this with a timeout to avoid processing the same button input multiple
times.</p>
<p>In this case, the trigger is the &#39;falling&#39; edge of the signal:</p>
<div><div><pre tabindex="0"><code><span><span>    </span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>        </span><span>from</span><span> machine </span><span>import</span><span> Pin</span><br/></span><span><span>        self</span><span>.</span><span>last_change_ms </span><span>=</span><span> ticks_ms</span><span>(</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>callbacks </span><span>=</span><span> </span><span>{</span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>        self</span><span>.</span><span>red_button </span><span>=</span><span> Pin</span><span>(</span><span>13</span><span>,</span><span> mode</span><span>=</span><span>Pin</span><span>.</span><span>IN</span><span>,</span><span> pull</span><span>=</span><span>Pin</span><span>.</span><span>PULL_UP</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>red_button</span><span>.</span><span>irq</span><span>(</span><span>trigger</span><span>=</span><span>Pin</span><span>.</span><span>IRQ_FALLING</span><span>,</span><span> handler</span><span>=</span><span>self</span><span>.</span><span>red_isr</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span>    </span><span>def</span><span> </span><span>red_isr</span><span>(</span><span>self</span><span>,</span><span> pin</span><span>)</span><span>:</span><span></span><br/></span><span><span>        </span><span>if</span><span> </span><span>&#39;RE&#39;</span><span> </span><span>in</span><span> self</span><span>.</span><span>callbacks </span><span>and</span><span> time</span><span>.</span><span>ticks_diff</span><span>(</span><span>ticks_ms</span><span>(</span><span>)</span><span>,</span><span> self</span><span>.</span><span>last_change_ms</span><span>)</span><span> </span><span>&gt;</span><span> BTN_FREQ_MS</span><span>:</span><span></span><br/></span><span><span>            </span><span>print</span><span>(</span><span>f&#39;</span><span>{</span><span>RED</span><span>}</span><span>BUTTONS</span><span>{</span><span>ENDC</span><span>}</span><span>: notifying button listener </span><span>{</span><span>RED</span><span>}</span><span>RED</span><span>{</span><span>ENDC</span><span>}</span><span>&#39;</span><span>)</span><span></span><br/></span><span><span>            self</span><span>.</span><span>callbacks</span><span>[</span><span>&#39;RE&#39;</span><span>]</span><span>(</span><span>)</span><span></span><br/></span><span><span>            self</span><span>.</span><span>last_change_ms </span><span>=</span><span> ticks_ms</span><span>(</span><span>)</span><br/></span></code></pre></div></div>
<p>Since the same button may have different functions depending on the context, for
example depending on which menu you are currently in, each button press is
triggering a callback.</p>
<p>Changes in menu context send a list of callbacks to override the previous one
and setup the new actions. I found this made the buttons more generic.</p>
<h3 id="ram-issues">RAM issues<a aria-label="Direct link to RAM issues" title="Direct link to RAM issues" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#ram-issues">​</a></h3>
<p>I quickly ended up with memory issues whereby the program would crash with an
error message such as <code>Memory allocation failed, failed to allocate 256 bytes</code>
or something like this.</p>
<p>What happened here is two things.</p>
<ul>
<li>First, 256kb is not so much</li>
<li>Second, it is relatively easy to end up with memory fragmentation.
Fragmentation means that I have enough bytes in memory to allocate to my
object, however these bytes are not contiguous and scattered across the memory
range making the allocation impossible.</li>
</ul>
<p>I watched a few videos from the creator of
<a href="https://micropython.org/" rel="noopener noreferrer nofollow">MicroPython</a>, and read documentation online. This led
to a few discoveries which helped.</p>
<h4 id="using-const">Using const()<a aria-label="Direct link to Using const()" title="Direct link to Using const()" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#using-const">​</a></h4>
<p>Say you have config values which won&#39;t change at runtime. When defining them as
<code>LOOP_FREQUENCY_MS = 250</code>, this may create a variable which requires more
memory. In this example, the system may allocate 32 bits for an <code>int</code> whereas I
only need 8 bits.</p>
<p>In some instances, for example when writing <code>c = 22 ... a = b x c</code>, I now
understand the compiler may detect that 22 is a constant and therefore apply
this for you, but being explicit does not hurt.</p>
<h4 id="proactive-memory-defragmentation">Proactive memory defragmentation<a aria-label="Direct link to Proactive memory defragmentation" title="Direct link to Proactive memory defragmentation" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#proactive-memory-defragmentation">​</a></h4>
<p>MicroPython has a garbage collection mechanism which triggers automatically.</p>
<p>However, it may only trigger once the memory is already fragmented, and not be
able to help. When starting up the game, I create a lot of objects. As a result,
this may not immediately trigger a connection.</p>
<p>I used <code>gc.collect()</code> profusely at startup and found that this helps make sure
that whatever memory is consumed by my objects is packed tighter together to
reduce fragmentation and its effects down the line.</p>
<h4 id="precompiling">Precompiling<a aria-label="Direct link to Precompiling" title="Direct link to Precompiling" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#precompiling">​</a></h4>
<p>MicroPython is an interpreted language whereby the code you write is transformed
into bytecode at compilation time. However, this compilation happens at startup
on the board itself, and can leave a significant memory footprint behind.</p>
<p>As I was struggling with memory issues, I considered compiling ahead of time,
and copying the files to the board.</p>
<p>The compile script uses <a href="https://pypi.org/project/mpy-cross/" rel="noopener noreferrer nofollow">mpy-cross</a> and
looks like this:</p>
<div><div><pre tabindex="0"><code><span><span>#!/bin/sh</span><br/></span><span><span></span><br/></span><span><span>MPY_CROSS=&#34;mpy-cross/./mpy-cross&#34;</span><br/></span><span><span>SOURCE_DIR=&#34;.&#34;</span><br/></span><span><span>BUILD_DIR=&#34;$HOME/build&#34;</span><br/></span><span><span></span><br/></span><span><span>echo &#34;### Starting build&#34;</span><br/></span><span><span></span><br/></span><span><span>compile_to_mpy() {</span><br/></span><span><span>    local src_file=&#34;$1&#34;</span><br/></span><span><span>    local dest_file=&#34;$2&#34;</span><br/></span><span><span>    mkdir -p &#34;$(dirname &#34;$dest_file&#34;)&#34;</span><br/></span><span><span>    $MPY_CROSS &#34;$src_file&#34; -o &#34;$dest_file&#34;</span><br/></span><span><span>}</span><br/></span><span><span></span><br/></span><span><span>copy_file() {</span><br/></span><span><span>    local src_file=&#34;$1&#34;</span><br/></span><span><span>    local dest_file=&#34;$2&#34;</span><br/></span><span><span>    mkdir -p &#34;$(dirname &#34;$dest_file&#34;)&#34;</span><br/></span><span><span>    cp &#34;$src_file&#34; &#34;$dest_file&#34;</span><br/></span><span><span>}</span><br/></span><span><span></span><br/></span><span><span># Clear the build directory at the start</span><br/></span><span><span>rm -rf &#34;$BUILD_DIR&#34;</span><br/></span><span><span>mkdir -p &#34;$BUILD_DIR&#34;</span><br/></span><span><span></span><br/></span><span><span>echo &#34;### Starting build&#34;</span><br/></span><span><span>find &#34;$SOURCE_DIR&#34; -type d -name &#34;mpy-cross&#34; -prune -o -type f -print | while read -r src_file; do</span><br/></span><span><span>    relative_path=&#34;${src_file#$SOURCE_DIR/}&#34;</span><br/></span><span><span>    if [[ &#34;$src_file&#34; == *.py ]]; then</span><br/></span><span><span>        dest_file=&#34;$BUILD_DIR/${relative_path%.py}.mpy&#34;</span><br/></span><span><span>        echo &#34;### Compiling $dest_file&#34;</span><br/></span><span><span>        compile_to_mpy &#34;$src_file&#34; &#34;$dest_file&#34;</span><br/></span><span><span>    elif [[ &#34;$src_file&#34; == *.txt ]]; then</span><br/></span><span><span>        echo &#34;### Copying raw $dest_file&#34;</span><br/></span><span><span>        dest_file=&#34;$BUILD_DIR/$relative_path&#34;</span><br/></span><span><span>        copy_file &#34;$src_file&#34; &#34;$dest_file&#34;</span><br/></span><span><span>    fi</span><br/></span><span><span>    if [[ &#34;$src_file&#34; == *ain.py ]]; then</span><br/></span><span><span>        echo &#34;### Copying raw $dest_file&#34;</span><br/></span><span><span>        dest_file=&#34;$BUILD_DIR/$relative_path&#34;</span><br/></span><span><span>        copy_file &#34;$src_file&#34; &#34;$dest_file&#34;</span><br/></span><span><span>    fi</span><br/></span><span><span>done</span><br/></span></code></pre></div></div>
<p>This creates a set of <code>.mpy</code> files which are bytecode instead of the <code>.py</code>
files. Taking the compilation step from the board to the computer means less
memory usage and a faster startup time, although the onboard compilation is
quite quick and not noticeable.</p>
<h4 id="buffering">Buffering<a aria-label="Direct link to Buffering" title="Direct link to Buffering" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#buffering">​</a></h4>
<p>I have a few files such as a <code>.txt</code> containing information such as the list of
&#39;fun&#39; news to display during the game. I may be in situations where I cannot
load the file in memory in one go. So to avoid crashing when reading it, I count
the number of lines by reading it in a buffer:</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>count_lines</span><span>(</span><span>file</span><span>)</span><span>:</span><span></span><br/></span><span><span>    count </span><span>=</span><span> </span><span>0</span><span></span><br/></span><span><span>    </span><span>while</span><span> </span><span>True</span><span>:</span><span></span><br/></span><span><span>        </span><span>buffer</span><span> </span><span>=</span><span> </span><span>file</span><span>.</span><span>read</span><span>(</span><span>1024</span><span>)</span><span></span><br/></span><span><span>        </span><span>if</span><span> </span><span>not</span><span> </span><span>buffer</span><span>:</span><span></span><br/></span><span><span>            </span><span>break</span><span></span><br/></span><span><span>        count </span><span>+=</span><span> </span><span>buffer</span><span>.</span><span>count</span><span>(</span><span>&#39;\n&#39;</span><span>)</span><span></span><br/></span><span><span>    </span><span>return</span><span> count</span><br/></span></code></pre></div></div>
<p>In a similar way, I tried to steer clear of string variables and holding text in
memory as this can quickly accumulate when collecting objects with text. So
things like <code>side = &#39;buy&#39;</code> would be transformed into <code>&#39;side_is_buy: True</code> etc.</p>
<h3 id="speed-issues">Speed issues<a aria-label="Direct link to Speed issues" title="Direct link to Speed issues" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#speed-issues">​</a></h3>
<p>While I tried to be efficient, the game can be slow if not careful, even when
the microcontroller clocks 133 million times per second. In this section, we&#39;ll
look at some learnings which helped me make the game feel more fluid.</p>
<h4 id="multiprocessing">Multiprocessing<a aria-label="Direct link to Multiprocessing" title="Direct link to Multiprocessing" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#multiprocessing">​</a></h4>
<p>The first item is that the Pico has two cores, which means it can run two
processes in parallel. This means I can split the work two-ways and
theoretically do two things at the same time thereby (I simplify) run at twice
the speed.</p>
<p>One difficulty with multiprocessing is potential contention over resources. For
example, trying to modify a variable from one process while the other process is
reading it.</p>
<p>In this case, I decided to organise my two processes such that they are
independent. One runs the background game such as the exchange, bots, the
matching engine, and similar. The other handles the player side such as
rendering the game on screen, processing inputs, and so on.</p>
<p>The initialisation looks like this:</p>
<div><div><pre tabindex="0"><code><span><span></span><br/></span><span><span></span><span></span><br/></span><span><span>self</span><span>.</span><span>second_thread </span><span>=</span><span> _thread</span><span>.</span><span>start_new_thread</span><span>(</span><span>self</span><span>.</span><span>second_thread</span><span>,</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span>def</span><span> </span><span>second_thread</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    aio</span><span>.</span><span>create_task</span><span>(</span><span>self</span><span>.</span><span>exchange</span><span>.</span><span>flow</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span>    aio</span><span>.</span><span>create_task</span><span>(</span><span>self</span><span>.</span><span>exchange</span><span>.</span><span>simulate_order_book</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span>    aio</span><span>.</span><span>create_task</span><span>(</span><span>self</span><span>.</span><span>exchange</span><span>.</span><span>cash_market</span><span>.</span><span>flow</span><span>(</span><span>)</span><span>)</span><span></span><br/></span><span><span></span><br/></span><span><span></span><span></span><br/></span><span><span></span><span>from</span><span> game </span><span>import</span><span> Game</span><br/></span><span><span>next_step </span><span>=</span><span> Game</span><span>(</span><span>resources</span><span>)</span><span></span><br/></span><span><span></span><span>while</span><span> </span><span>True</span><span>:</span><span></span><br/></span><span><span>    next_step </span><span>=</span><span> </span><span>await</span><span> next_step</span><span>.</span><span>flow</span><span>(</span><span>)</span><br/></span></code></pre></div></div>
<h4 id="coroutines">Coroutines<a aria-label="Direct link to Coroutines" title="Direct link to Coroutines" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#coroutines">​</a></h4>
<p>The game consists of many small loops. The bots send orders in a loop at a given
frequency. The player&#39;s algo reacts to market data at a given frequency. The
display refreshes at a given frequency; there are many such intervals.</p>
<p>Having all these steps in a loop such as this is not optimal because it forces
all steps to execute sequentially:</p>
<div><div><pre tabindex="0"><code><span><span>while</span><span> </span><span>True</span><span>:</span><span></span><br/></span><span><span>    loop1</span><span>(</span><span>)</span><span></span><br/></span><span><span>    loop2</span><span>(</span><span>)</span><span></span><br/></span><span><span>    </span><span>.</span><span>.</span><span>.</span><br/></span></code></pre></div></div>
<p>Fortunately, micropython comes with a built-in implementation of <code>asyncio</code>.</p>
<p>This allows us to setup co-routines, then let them run at a given frequency by
using <code>await aio.sleep_ms(interval)</code>. This pauses the current co-routine and
opens up resources to schedule another co-routine whose execution is due.</p>
<p>Here is an example for the player turn loop, and asynchronous wait:</p>
<div><div><pre tabindex="0"><code><span><span>async</span><span> </span><span>def</span><span> </span><span>play</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>while</span><span> self</span><span>.</span><span>playing</span><span>:</span><span></span><br/></span><span><span>        self</span><span>.</span><span>rpm_price </span><span>=</span><span> self</span><span>.</span><span>exchange</span><span>.</span><span>rpm</span><span>.</span><span>get_ref_price</span><span>(</span><span>)</span><span></span><br/></span><span><span>        self</span><span>.</span><span>player_turn</span><span>(</span><span>)</span><span></span><br/></span><span><span>        </span><span>await</span><span> aio</span><span>.</span><span>sleep_ms</span><span>(</span><span>self</span><span>.</span><span>player_turn_ms</span><span>)</span><br/></span></code></pre></div></div>
<p>What&#39;s nice about this is that we can then easily separate the loop frequencies
for all routines, and increase the frequency for critical ones, while decreasing
it for background tasks which don&#39;t need a high update rate. All frequencies can
then be setup as <code>Const()</code> in a config file.</p>
<h4 id="overclocking">Overclocking<a aria-label="Direct link to Overclocking" title="Direct link to Overclocking" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#overclocking">​</a></h4>
<p>It would not be a real trading machine if it was not overclocked! Overclocking
means increasing the CPU clock frequency over its default value, in this case
133 Mhz. Doing so is easy in micropython and I found that I could double the
clock frequency without any issues:</p>
<div><div><pre tabindex="0"><code><span><span>from</span><span> machine </span><span>import</span><span> freq</span><br/></span><span><span></span><span>from</span><span> config </span><span>import</span><span> OVERCLOCK_MHZ</span><span>,</span><span> MAX_OVERCLOCK_MHZ</span><span>,</span><span> OVERCLOCK</span><br/></span><span><span></span><br/></span><span><span></span><span>async</span><span> </span><span>def</span><span> </span><span>main</span><span>(</span><span>)</span><span>:</span><span></span><br/></span><span><span>    </span><span>if</span><span> OVERCLOCK </span><span>and</span><span> OVERCLOCK_MHZ </span><span>&lt;</span><span> MAX_OVERCLOCK_MHZ</span><span>:</span><span></span><br/></span><span><span>        freq</span><span>(</span><span>OVERCLOCK_MHZ </span><span>*</span><span> </span><span>1_000_000</span><span>)</span><br/></span></code></pre></div></div>
<p>Overclocking is not without risks however, and the CPU may become unstable or
overheat as a result. So increasing it is possible but with some risks and
downsides such as shortening the life of your device. But doubling the clock
speed in a situation such as this is a quick and easy way to get the performance
boost I need.</p>
<h3 id="practical-issues">Practical issues<a aria-label="Direct link to Practical issues" title="Direct link to Practical issues" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#practical-issues">​</a></h3>
<p>Generally, users are guided towards <a href="https://thonny.org/" rel="noopener noreferrer nofollow">Thonny</a> as an IDE. It
is great in many ways. The REPL mode allows you to connect to your board, modify
your code on the device, and run it.</p>
<p>While it&#39;s perfect for small scripts such as collecting readings or controlling
a small item, it becomes much more complicated when using more advanced objects,
classes, etc. There is no version control, and very few syntax checks or
highlights.</p>
<p>The process mostly looked like this:</p>
<ul>
<li>Update a file on the Pico</li>
<li>Update another file</li>
<li>Save the first file</li>
<li>Run</li>
<li>Error message because the second file was not saved and therefore your code is
broken</li>
<li>Save the second file</li>
<li>Run</li>
<li>Get an error message because you made a small syntax error which was not
highlighted in the IDE</li>
</ul>
<p>A lot of issues I had at runtime were because of typos or small syntax issues
which IDEs equipped with syntax checks would catch instantly and highlight.</p>
<p>On the other hand, using a fully fledged IDE also makes life harder because you
lose the ability to browse and edit files on device. While this would have been
a no-go due to the annoying overhead of copying the code across many times over,
I found that using a small script helped a lot and rendered this step painless.</p>
<p>To that end, I used
<a href="https://docs.micropython.org/en/latest/reference/mpremote.html" rel="noopener noreferrer nofollow">mpremote</a> to
copy all my files to the board and lastly start the program:</p>
<div><div><pre tabindex="0"><code><span><span>echo </span><span>&#34;### Copying to device&#34;</span><span></span><br/></span><span><span></span><br/></span><span><span>cd $BUILD_DIR</span><br/></span><span><span>mpremote cp main</span><span>.</span><span>py </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r animations</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r frames</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r helpers</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r master</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r menus</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r resources</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote fs cp </span><span>-</span><span>r slave</span><span>/</span><span> </span><span>:</span><span></span><br/></span><span><span>mpremote cp config</span><span>.</span><span>mpy </span><span>:</span><span></span><br/></span><span><span>mpremote cp game</span><span>.</span><span>mpy </span><span>:</span><span></span><br/></span><span><span>mpremote cp main</span><span>.</span><span>mpy </span><span>:</span><span></span><br/></span><span><span>mpremote cp main</span><span>.</span><span>mpy </span><span>:</span><span></span><br/></span><span><span>mpremote cp about</span><span>.</span><span>txt </span><span>:</span><span></span><br/></span><span><span>mpremote cp news</span><span>.</span><span>txt </span><span>:</span><span></span><br/></span><span><span>mpremote run main</span><span>.</span><span>py</span><br/></span></code></pre></div></div>
<h2 id="does-it-questdb">Does it QuestDB?<a aria-label="Direct link to Does it QuestDB?" title="Direct link to Does it QuestDB?" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#does-it-questdb">​</a></h2>
<p>QuestDB is a monster for <a href="https://www.scannedinavian.com/market-data/" rel="">market data</a>. The Pico microcontroller
includes a wireless chip. So it&#39;s possible to connect it to the network, and
then to issue http requests to send data to a QuestDB instance.</p>
<p>Connecting to the wifi is pretty simple in micropython:</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>connect_to_wifi</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>  wlan </span><span>=</span><span> network</span><span>.</span><span>WLAN</span><span>(</span><span>network</span><span>.</span><span>STA_IF</span><span>)</span><span></span><br/></span><span><span>  wlan</span><span>.</span><span>active</span><span>(</span><span>True</span><span>)</span><span></span><br/></span><span><span>  wlan</span><span>.</span><span>connect</span><span>(</span><span>self</span><span>.</span><span>ssid</span><span>,</span><span> self</span><span>.</span><span>pwd</span><span>)</span><span></span><br/></span><span><span>  </span><span>print</span><span>(</span><span>f&#39;connecting </span><span>{</span><span>self</span><span>.</span><span>ssid</span><span>}</span><span>&#39;</span><span>)</span><br/></span></code></pre></div></div>
<p>And then we can sending data using a raw HTTP request. For example something
like this:</p>
<div><div><pre tabindex="0"><code><span><span>def</span><span> </span><span>send_results</span><span>(</span><span>self</span><span>)</span><span>:</span><span></span><br/></span><span><span>    query </span><span>=</span><span> </span><span>f&#34;INSERT INTO game(ref_price,timestamp, p_bid, p_ask, skew, pnl) &#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;VALUES(&#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;</span><span>{</span><span>str</span><span>(</span><span>self</span><span>.</span><span>current_ref_price</span><span>)</span><span>}</span><span>,&#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;systimestamp(),&#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;</span><span>{</span><span>str</span><span>(</span><span>self</span><span>.</span><span>current_player_bid</span><span>)</span><span>}</span><span>,&#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;</span><span>{</span><span>str</span><span>(</span><span>self</span><span>.</span><span>current_player_ask</span><span>)</span><span>}</span><span>,&#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;</span><span>{</span><span>str</span><span>(</span><span>self</span><span>.</span><span>player_skew</span><span>)</span><span>}</span><span>,&#34;</span><span> \</span><br/></span><span><span>            </span><span>f&#34;</span><span>{</span><span>str</span><span>(</span><span>self</span><span>.</span><span>player_pnl</span><span>)</span><span>}</span><span>)&#34;</span><span></span><br/></span><span><span>    full_url </span><span>=</span><span> self</span><span>.</span><span>url </span><span>+</span><span> </span><span>&#34;?query=&#34;</span><span> </span><span>+</span><span> self</span><span>.</span><span>url_encode</span><span>(</span><span>query</span><span>)</span><span></span><br/></span><span><span>    </span><span>print</span><span>(</span><span>full_url</span><span>)</span><span></span><br/></span><span><span>    </span><span>try</span><span>:</span><span></span><br/></span><span><span>        requests</span><span>.</span><span>get</span><span>(</span><span>url</span><span>=</span><span>full_url</span><span>)</span><br/></span></code></pre></div></div>
<p>I can then setup a Grafana dashboard with queries such as the following:</p>
<div><div><pre tabindex="0"><code><span><span>SELECT</span><span> </span><span>timestamp</span><span>,</span><span> ref_price</span><span>,</span><span> p_bid player_bid</span><span>,</span><span> p_ask player_ask</span><br/></span><span><span></span><span>FROM</span><span> game</span><br/></span><span><span></span><span>WHERE</span><span> $__timeFilter</span><span>(</span><span>timestamp</span><span>)</span><br/></span></code></pre></div></div>
<p>And tada!</p>
<p>Game stats are flowing in realtime into a QuestDB instance and displayed live in
a <a href="https://www.scannedinavian.com/docs/third-party-tools/grafana/" rel="">Grafana</a> dashboard. Of course, I
<a href="https://www.scannedinavian.com/blog/increase-grafana-refresh-rate-frequency/" rel="">set the refresh frequency to 250ms</a>
for more of a true HFT feel:</p>
<figure><div><p><img alt="An image" src="https://www.scannedinavian.com/img/blog/2024-10-24/game-on-grafana.webp" loading="lazy"/></p><figcaption>Click to zoom</figcaption></div></figure>
<p>It&#39;s pretty satisfying to see the quotes adjusting automatically to market
price. With more time, I could change the algo to adjust to the orderbook, fight
for position, or come up with many other creative situations.</p>
<p>Another satisfying thing is to watch the autohedge get to work when I cross my
threshold parameter. This threshold is dynamic, meaning that I can adjust it
over the game depending on my current risk appetite. As soon as it&#39;s crossed, it
sends orders in the other orderbook to hedge in the underlying.</p>
<p>What&#39;s less satisfying is my performance in this game. In this instance, it was
all going well until figures occurred. I was making money from the spread
collected on the flow. But when figures came out, I had a small short
position... and the markets jumped up.</p>
<p>Consequently, my PnL went from positive to negative. While I remembered to pull
quotes (I would have been demolished by arbitrage otherwise because I have
higher latency than the market), I didn&#39;t completely flatten my position.</p>
<p>I&#39;ll do better next time!</p>
<h2 id="in-conclusion">In conclusion<a aria-label="Direct link to In conclusion" title="Direct link to In conclusion" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#in-conclusion">​</a></h2>
<p>While accidental, this experience was very enriching for a few reasons.</p>
<p>First, as someone who always worked in dematerialised things (data, trading,
computers), it was great to work on something tangible and physical. There is a
pleasure in creation and this opened new perspectives in terms of daring to do
things with my hands such as fixing something at home or building.</p>
<p>I naturally feel more at home with a computer than with a hammer, and people in
the opposite situation tell me they are scared of computers. It&#39;s great to
realise that going from one to the other is possible, and feels great.</p>
<p>Second, I was amazed to discover 3D printers and CAD design. The state of
tooling is such that one can very easily design a part (PCB or other physical
object) to solve real world problems with infinitely more satisfaction than just
buying something off-the-shelf.</p>
<p>For example, my bedside table lamp comes with shades, and there is a set of two
disks which screw on the lamp shaft to hold the shade in place. These broke, and
within a few minutes I could print replacements for a fraction of the cost with
multiples of the satisfaction.</p>
<p>Most people I know have never seen such a machine before and I envy them for
their ability to see it in action for the first time materialising an object
before their eyes.</p>
<p>Third, I am truly impressed by the Raspberry Pi Pico, and the micropython
language. When I think microcontroller, I think toothbrush control or small RC
remote. But seeing it run an exchange, orderbook, matching engine, and
refreshing a display for a cost of around $8 is truly impressive.</p>
<p>They just released a new version with more cores, more memory, and other
features, and I can&#39;t wait to try it for other projects and to see what more
skilled makers will make of it!</p>
<h3 id="want-more-pi">Want more Pi?<a aria-label="Direct link to Want more Pi?" title="Direct link to Want more Pi?" href="https://www.scannedinavian.com/blog/making-a-trading-gameboy/#want-more-pi">​</a></h3>
<p>If this sort of thing is up your alley, we&#39;ve got more fun Pi projects:</p>
<ul>
<li><a href="https://www.scannedinavian.com/blog/time-series-monitoring-dashboard-grafana-questdb/" rel="">Fluid real-time dashboards with QuestDB and Grafana</a></li>
<li><a href="https://www.scannedinavian.com/blog/build-resource-monitor-grafana/" rel="">Build your own resource monitor</a></li>
<li><a href="https://www.scannedinavian.com/blog/tracking-sea-faring-ships-ais-grafana/" rel="">Tracking sea faring ships with AIS data and Grafana</a></li>
<li><a href="https://www.scannedinavian.com/blog/realtime-nyc-cab-data-visualized/" rel="">Visualizing real-time NYC cab data and geodata</a></li>
<li><a href="https://www.scannedinavian.com/blog/analyzing-the-ecb-historical-fx-rates/" rel="">Analyzing the beautiful charts and history behind ECB FX rates</a></li>
<li><a href="https://www.scannedinavian.com/blog/increase-grafana-refresh-rate-frequency/" rel="">Increase Grafana refresh rate frequency</a></li>
<li>Or check out our <a href="https://www.scannedinavian.com/blog/tags/GRAFANA/" rel="">Grafana blog tag</a></li>
</ul>
<p>Want to chat with us? Holler on social media or join in our engaging
<a href="https://community.questdb.io/" rel="noopener noreferrer nofollow">Community Forum</a> or our public
<a href="https://slack.questdb.io/" rel="noopener noreferrer nofollow">Slack</a>.</p><div><div><div><div><p><span>Subscribe to our newsletters for the latest. Secure and never shared or sold.</span></p></div></div></div></div></article></div>
  </body>
</html>
