<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nbailey.ca/post/block-scanners/">Original</a>
    <h1>Block web scanners with ipset and iptables</h1>
    
    <div id="readability-page-1" class="page"><div> <p>Anybody who runs an internet-facing webserver has seen their fair share of spammy scanners in the logs. It varies server to server, but some of mine get up to 15,000 scans per day.</p>
<p>Almost all of these are harmless network mappers, but they still annoy me. Many are compromised hosts or belong to hackers &amp; organized crime rings. While it’s possible to create false positives, it’s probably safe to block all of these.</p>
<p>So I’m going to ban these spammy scanners from my servers automatically, for several weeks at a time. Here’s how:</p>
<h2 id="configure-nginx-to-log-default-virtualhost-traffic">Configure Nginx to log default virtualhost traffic</h2>
<p>First and foremost, we need to separate the legit traffic from the scans. The easiest way to do this is to point the default virtualhost at a separate log file. For nginx, a default server block can be added to the end of <code>nginx.conf</code>:</p>
<pre><code>server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    server_name_in_redirect off;
    location / {
        return 404;
        access_log /var/log/nginx/spam.log; 
    }
}

server {
    listen 443 ssl  default_server;
    listen [::]:443 ssl default_server;
    server_name _;
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    ssl_protocols TLSv1.3 TLSv1.2;
    server_name_in_redirect off;
    location / {
        return 404;
        access_log /var/log/nginx/spam.log; 
    }
}
</code></pre><p>With this configuration, all traffic that does not have a valid hostname will be 404’d and logged to <code>spam.log</code>, keeping the actual server logs much cleaner. This logfile will also be used to generate our block list later.</p>
<p>Unless you have a well-known or high traffic site, this will filter about 95% of the scanner traffic, since they primarily scan IP ranges rather than by hostname.</p>
<h2 id="configure-logrotate-to-disable-compression">Configure logrotate to disable compression</h2>
<p>To make parsing historical data easier, we will disable compression on old web server log files. Make sure you have sufficient storage before doing this. For nginx, the file <code>/etc/logrotate.d/nginx</code> will have two lines commented out:</p>
<pre><code>        ...
        rotate 14
        #compress
        #delaycompress
        notifempty
        ...
</code></pre><p>Once applied, new log files will only be rotated, not gzipped. It is possible to unzip the compressed log files for analysis, but it is much easier to have them uncompressed.</p>
<h2 id="install-and-configure-ipset">Install and configure ipset</h2>
<p>Ipset is a tool for managing hash tables in the kernel for fast lookup. Rather than creating hundreds or thousands of individual firewall rules, a single rule can perform a quick lookup on the table without impacting performance in a meaningful way.</p>
<p>First, the tools must be installed:</p>
<pre><code>sudo apt install ipset ipset-persistent
sudo systemctl enable --now ipset.service
</code></pre>
<p>Then, the table can be created:</p>
<pre><code>ipset create scanners hash:ip hashsize 4096 counters
</code></pre>
<p>This creates an ipset list with counters enabled, which will allow us to check the hit rate on each rule later.</p>
<h2 id="process-nginx-logs-to-build-banned-ip-list">Process Nginx logs to build banned IP list</h2>
<p>A simple script is used to process the nginx log and generate the ipset list:</p>


<p>After execution, the ipset list will contain several IPs to block:</p>
<pre><code># ipset list -t

Name: scanners
Type: hash:ip
Revision: 5
Header: family inet hashsize 4096 maxelem 65536 counters bucketsize 12 initval 0xe1ff9cd2
Size in memory: 27632
References: 0
Number of entries: 359
</code></pre><p>Additionally, a cron job should be used to regularly refresh the list with any new malicious IPs from the nginx log file:</p>
<p><code>/etc/cron.d/droplist</code></p>
<pre><code>00 * * * *    root    /opt/blocklist_nginx.sh
</code></pre><h2 id="configure-iptables-to-lookup--block-banned-ips">Configure iptables to lookup &amp; block banned IPs</h2>
<p>The iptables rules for the server should be modified to include the set lookups. For performance reasons, established connections should be allowed to ‘bypass’ the rules - only new connections should be examined.</p>
<p>An example for a web server:</p>
<p><code>/etc/iptables/rules.v4</code></p>
<pre><code>*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m state --state INVALID -j DROP
-A INPUT -m set --match-set scanners src -j DROP
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT
-A INPUT -j DROP
COMMIT
</code></pre><p>Load the ruleset, either using iptables-restore or by restarting the system (if iptables-persistent is installed).</p>
<pre><code>sudo iptables-restore /etc/iptables/rules.v4
</code></pre>
<p>Before too long, the rules will begin to get matches, and therefore block requests.</p>
<pre><code># iptables -L -v -n

Chain INPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in    out   source           destination         
1007K 1173M ACCEPT     all  --  *     *     0.0.0.0/0        0.0.0.0/0        state RELATED,ESTABLISHED
   12  1344 DROP       all  --  *     *     0.0.0.0/0        0.0.0.0/0        state INVALID 
  268 15228 DROP       all  --  *     *     0.0.0.0/0        0.0.0.0/0        match-set scanners src
23196 1392K ACCEPT     all  --  lo    *     0.0.0.0/0        0.0.0.0/0        
  524 27891 ACCEPT     tcp  --  *     *     0.0.0.0/0        0.0.0.0/0        tcp dpt:80
 2829  170K ACCEPT     tcp  --  *     *     0.0.0.0/0        0.0.0.0/0        tcp dpt:443
    7   412 ACCEPT     tcp  --  *     *     192.168.1.0/24   0.0.0.0/0        tcp dpt:22
 7826  688K DROP       all  --  *     *     0.0.0.0/0        0.0.0.0/0        
</code></pre><p>Likewise, the ipset list will begin to show hits on the counters:</p>
<pre><code># ipset list scanners | tail -n +9 | sort -k 3 -g -r 

158.22.96.72 packets 103 bytes 28050
103.88.53.21 packets 68 bytes 1620
78.129.42.58 packets 29 bytes 1060
37.44.78.192 packets 13 bytes 890
</code></pre><p>This will grow over time as more requests are logged and dropped.</p>
<p>After 14 days, the nginx logs will be removed, and IPs will be flushed from the blocklist shortly after. Effectively, a banned IP will be blocked for just over two weeks.</p>
<p>It’s also possible to configure logrotate to retain additional logs, which would allow the list to grow over time and maintain a much larger list of banned hosts. This may or may not be desirable, depending on the threat model of the server.</p>
 </div></div>
  </body>
</html>
