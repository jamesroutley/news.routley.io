<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://aruarian.dance/blog/japan-ic-cards/">Original</a>
    <h1>Japan&#39;s IC cards are weird and wonderful</h1>
    
    <div id="readability-page-1" class="page"><div>
  <p><img src="https://aruarian.dance/blog/japan-ic-cards/banner.png"/></p><p><em>Discuss this post on <a href="https://news.ycombinator.com/item?id=43993711">Hacker News</a>, <a href="https://x.com/aecsocket/status/1922970685997023394">Twitter</a></em></p>
<p>While I was in Japan over winter, one thing that stood out to me was the incredible public transport system. Efficient and reliable, as expected, but the tap-in-tap-out gates at the stations were suspiciously fast. The London Underground gates don&#39;t work nearly as quick with Google Pay or any of my other contactless cards - what gives? I spent some time researching what makes Japan&#39;s transit card system (<a href="https://www.japan-guide.com/e/e2359_003.html">IC cards</a>) so unique compared to the West, and all of the interesting bits I learned along the way.</p>

<p>Near-field communication is a set of protocols which lets two devices communicate with each other without physically touching, using radio waves at 13.56 MHz (defined by <a href="https://en.wikipedia.org/wiki/ISO/IEC_14443">ISO/IEC 14443</a>). It&#39;s used all over the place:</p>
<ul>
<li>When you use a contactless debit card, Apple Pay, or Google Pay, you are using <a href="https://en.wikipedia.org/wiki/EMV">EMV</a>, standing for <a href="https://www.nytimes.com/2015/09/24/business/smallbusiness/coming-soon-to-checkouts-microchip-card-payment-systems.html">Europay, Mastercard, Visa</a> (<a href="https://archive.is/0CEDX">archive</a>), operating over ISO/IEC 14443.</li>
<li>When you tap into a station on the London Underground using an Oyster card, your card uses <a href="https://en.wikipedia.org/wiki/MIFARE#MIFARE_DESFire_family">MIFARE DESFire</a> to communicate with the gate reader (but if you are using a payment card, it uses EMV instead). Note that the Underground <a href="https://www.theguardian.com/technology/2008/jun/26/hitechcrime.oystercards">originally used MIFARE Classic</a>, but <a href="https://www.schneier.com/blog/archives/2008/08/hacking_mifare.html">&#34;the security...is terrible&#34;</a> (<a href="https://archive.is/GXBT">archive</a>) , resulting in the cards being trivial to clone, defeating its security.</li>
<li><a href="https://www.cdvi.co.uk/learn-about-access-control/what-is-access-control/understanding-mifare-credentials">Access control systems</a> (<a href="https://archive.is/TBCHL">archive</a>) for buildings, doors, etc. tend to use MIFARE Classic. Places like your office building, your gym, etc.</li>
</ul>
<blockquote>
<p><em>Wait... didn&#39;t you just say that the security of MIFARE Classic is terrible? Someone could clone my keycard - or worse yet, get into my (whatever) without even needing a keycard?</em></p>
<p>Yes, and it&#39;s <a href="https://www.keysight.com/blogs/en/tech/nwvs/2024/08/27/security-highlight-backdoor-key-found-in-mifare-classic-cards">worse than you think</a>. That&#39;s why it&#39;s considered legacy, and fortunately nothing security-critical really uses MIFARE Classic anymore. I mean, you&#39;re not worried about <a href="https://www.wired.com/story/saflok-hotel-lock-unsaflok-hack-technique/">someone breaking into your hotel room</a>, right?</p>
</blockquote>
<p>What&#39;s interesting about Japan (and Asia in general) is that they have their own type of NFC which basically does not exist in the West: <a href="https://en.wikipedia.org/wiki/FeliCa">FeliCa</a>, a standard developed by Sony, officially classified as NFC type F (as opposed to MIFARE, which is type A). In fact, <a href="https://ja.wikipedia.org/wiki/FeliCa#%E6%AD%B4%E5%8F%B2">FeliCa came first</a>, being developed in 1988; as opposed to Philips&#39; (now NXP) MIFARE which was <a href="https://www.sciencedirect.com/science/article/abs/pii/S1363412710000348">introduced in 1994</a>. FeliCa started getting widespread adoption initially not in Japan, but in Hong Kong, through its public transport <a href="https://en.wikipedia.org/wiki/Octopus_card#History">Octopus cards</a> in 1997 - only later did <a href="https://www.ejrcf.or.jp/jrtr/jrtr32/f20_shi.html">JR East adopt FeliCa for its Suica transit cards in November 2001</a>, and Rakuten started using FeliCa for its <a href="https://en.wikipedia.org/wiki/Edy">Edy</a> cards (the name <a href="https://cyberpunk.fandom.com/wiki/Eurodollar">reminds me of something...</a>). After that, <a href="https://www.sony.co.jp/en/Products/felica/business/data/FeliCa_E.pdf">a bunch of Asian countries adopted it</a>, like Vietnam and Bangladesh. They fill the same niche in those countries as they do in Japan: contactless prepaid cards and transit tickets.</p>
<p>Places like Hong Kong and Tokyo have <em>a lot</em> of commuters, leading to a lot of congestion around station gates. Sony realised this, and invested heavily into the performance of their technology - FeliCa cards boast an <a href="https://www.sony.co.jp/en/Products/felica/business/information/120405.html">advertised communication speed of up to 424kbps</a>, making a <a href="https://atadistance.net/2020/06/13/transit-gate-evolution-why-gate-speed-matters">noticeable improvement in gate processing speeds</a> compared to Western counterparts. Compare the speed of <a href="https://youtu.be/9TXkKDw3WWU">passing through a ticket gate on the Underground</a> to <a href="https://youtu.be/W6GrIQT58ak">a Tokyo ticket gate</a> (part of <a href="https://news.ycombinator.com/item?id=38710174">this HN discussion</a>) - you could practically sprint through. This is partly achieved by the fact that transactions only involve the card and the reader itself - the reader doesn&#39;t talk to an external server to perform a transaction. This makes IC cards <a href="https://en.wikipedia.org/wiki/Stored-value_card">stored-value cards</a> - as in, they store the value on themselves, rather than their value being stored on the backend where it&#39;s controlled fully by the operator. The card also stores a history of recent transactions, and you can use any NFC reader to read this, <a href="https://suikakeibo.jp/">even from your phone</a>. But this stored-value model raises some interesting points about security... we&#39;ll get back to that 🤔</p>
<p>These cards also come with some extra quality-of-life stuff, like conflict avoidance - a reader can detect when it&#39;s reading more than 1 FeliCa card at a time, and prevent any reading if so:</p>

<blockquote>
<p>As an aside, how the hell does Philips get an 8 year head start, and still design a card which is both slower than <em>and</em> less secure than FeliCa? I don&#39;t know if it&#39;s negligence, cost-cutting, or something else, but this leads to <a href="https://www.wired.com/2010/12/unsmart-investments-in-smart-cards/">real security issues in the real world</a>! <a href="https://www.cs.virginia.edu/~evans/pubs/usenix08/mifare.html">Security through obscurity does not work.</a></p>
</blockquote>

<p><a href="https://en.wikipedia.org/wiki/Osaifu-Keitai">Osaifu-Keitai</a> (<em>saifu</em>, &#34;wallet&#34;; <em>keitai</em>, &#34;mobile&#34;) is a system to let you use your phone as an IC card, emulating a Suica, Pasmo, or whatever else. Over the years there has been some confusion about the relationship between FeliCa, IC cards, Osaifu-Keitai, and how this relates to Apple and Google&#39;s phones. When I first started reading about this topic this all went over my head as well, but I&#39;ve tried to gather my findings here for future reference. A lot of this is thanks to FelicaDude (<a href="https://www.reddit.com/u/felicadude">Reddit</a>, <a href="https://twitter.com/felicadude">Twitter</a>), an anonymous internet stranger who disappeared a few years ago but seems to have a lot of knowledge about how FeliCa works. I can&#39;t verify any of this information, but it makes sense to me; and anyway, there&#39;s no way someone would lie on the internet, right?</p>
<p>Modern smartphones have NFC hardware. In order for a phone to be certified as NFC-capable, it must support NFC-A, NFC-B, and NFC-F (FeliCa). <strong>All phones which support NFC support FeliCa.</strong> Using NFC-F, you can use your phone to interact with an existing, physical IC card that you have in your possession. Using an app like <a href="https://suikakeibo.jp/">Suikakeibo</a>, you can do exactly this - here&#39;s a screenshot from my Xiaomi Redmi Note 13 Pro where I tap my PASMO card and read out its stored value and transaction history:</p>
<p><img src="https://aruarian.dance/blog/japan-ic-cards/suikakeibo.jpg" alt="Screenshot of the Suikakeibo app on a phone, showing card value and recent transaction history"/></p>
<p>However, <strong>NFC-F support is not enough to use your phone as an IC card.</strong> Instead, this requires Osaifu-Keitai support. Osaifu-Keitai was originally developed by NTT Docomo as a feature for <a href="https://en.wikipedia.org/wiki/Feature_phone#Japan">feature phones</a>, letting you use your phone to make calls and act as an IC card. Later, this was integrated into smartphones by taking advantage of <a href="https://en.wikipedia.org/wiki/Secure_element">secure elements</a> already present on the phone for other functions which require securely storing cryptographic keys (Apple Pay, Google Pay, biometric unlock). Modern phones have the necessary hardware to act as an IC card, but the secure element probably doesn&#39;t have the necessary keys. Phone vendors (Apple, Google) probably pay FeliCa Networks for each key they generate and put on a device (licensing or something). Since there&#39;s no point in generating keys for a device which will not be used in Japan, non-Japan SKUs don&#39;t have Osaifu-Keitai functionality. So even if you rooted your phone and had full access to the secure element, <strong>if your phone&#39;s secure element doesn&#39;t have the key, you can&#39;t use it as an IC card</strong>.</p>
<p><em>Clarification: The part about non-Japan SKUs applies to Android devices, but Apple eats the cost of the keys and gives all phones Osaifu-Keitai functionality. Osaifu-Keitai works on all modern iPhones, regardless of rooting or if it&#39;s a Japan device or not.</em></p>
<p><em>There may be more reasons that Android devices don&#39;t all have Osaifu-Keitai functionality besides missing the keys. I assume that there&#39;s also some kind of licensing or patent issues, but I couldn&#39;t find any public info on this, so I can&#39;t confirm my suspicions. <a href="https://news.ycombinator.com/item?id=44014573">One HN commenter</a> mentions <a href="https://github.com/kormax/osaifu-keitai-google-pixel">this GitHub repo</a> which seems to have more details on this.</em></p>

<p>When I first read about the fact that the card stores its value on itself, I immediately thought, <em>there&#39;s no way this is safe right?</em> After further reading, I think that these cards are actually incredibly secure, and I&#39;m kind of shocked how well it&#39;s stood the test of time (from 1988 btw!!!) - seriously a testament to how well you can do something if you plan it out right from the start and <a href="https://www.schneier.com/blog/archives/2008/08/hacking_mifare.html">don&#39;t pretend that obscurity is security</a> then <a href="https://web.archive.org/web/20081006211233/http://news.cnet.com/8301-10784_3-9985886-7.html">try to sue people who point out how shitty your system is</a>. I could find barely any info on successful attacks on FeliCa outside of <a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=7dc1ba2595f961bb71d8a761554dd9143ac8606c">a single paper</a> detailing a bug exploited by a cashier, which was caught anyway by audit logs and HK Octopus cards&#39; clearing house system. The only real concern I&#39;ve seen brought up is the fact that the crypto is proprietary, and probably buried underneath a mountain of NDAs, so the public can&#39;t audit it independently.</p>
<p>Generally speaking, IC cards are immune from:</p>
<ul>
<li>cloning (can&#39;t read the keys)</li>
<li>a successful attack on another card (each card has its own keys)</li>
<li>replay attacks (per-session unique keys are generated in the challenge/response)</li>
</ul>
<p>One possible attack vector would be exploiting Apple&#39;s IC card implementation. If an iPhone can emulate an IC card, then there&#39;s code <em>somewhere</em> on the system that can perform the necessary handshakes, right? However, the keys for this handshake are stored in the Secure Enclave. You&#39;re only getting into the SE if you are <a href="https://www.usenix.org/system/files/1401_08-12_mickens.pdf">Mossad</a>, <a href="https://en.wikipedia.org/wiki/Pegasus_(spyware)">NGO Group</a>, or another scary three-letter agency; and if you do manage that:</p>
<ul>
<li>you can do much more than spoof a Japanese transit card</li>
<li>you are probably about to make millions in your denomination of choice, either by being hired or by selling a zero-day</li>
<li>your lifespan has been dramatically shortened</li>
</ul>
<p>The only other attack vector is the reader itself. Card charging machines and station gates may be viable to some kind of attack, but even if you could pull one off, they (probably) send transaction logs to a central audit server somewhere, and your misdeeds will be easily flagged as an anomaly. This is exactly what happened in the paper linked above. Once your card has been flagged, its ID is probably added to a hotlist which is synced across all reader terminals under the operator&#39;s control, and if the reader detects a card on its hotlist, it immediately rejects the transaction. If you&#39;re lucky, it might even call over some law enforcement. Reader devices have limited space in this hotlist, so maybe you could generate millions of flagged cards, fill up the hotlists, then use one of your original/later flagged cards without being blocked? I&#39;m just spitballing at this point, I have no clue how this might work. But it&#39;s an interesting idea nonetheless.</p>
<p>Offline terminals, however, are a different story: something like a vending machine is not usually maintained by the card operator, but by a 3rd party who uses the operator&#39;s IC card reader. These kinds of machines are likely not networked, do not sync hotlists, and do not send audit logs - a viable attack vector! Unfortunately due to <a href="https://en.wikipedia.org/wiki/Euclidean_space">geometrical issues</a>, I am unable to bring a vending machine back home with me, so I can&#39;t investigate this.</p>

<p>After researching FeliCa for a while, I&#39;ve come up with some future ideas where I can take my thoughts.</p>
<p>I want to build out the software for a miniature version of a train station network. The entire software stack, from the gate-level (embedded microcontroller programming), to the station controller (maybe explore something to do with a CAN bus to connect multiple gates to a single station), all the way up to a control plane which tracks journeys across stations, and provides an audit log of transactions. Obviously this would never be something intended to be used in a real transit system, but it sounds like a fun hobby project 😁</p>
<p>Apart from that, maybe research <em>why</em> exactly FeliCa is so much faster than its competition for NFC communication. What&#39;s the physics behind it? Is there room to improve the speed, and get sub-100ms taps? This is nowhere close to my area of expertise, but if someone with relevant knowledge in this field could share their insight or write their own post, I&#39;m sure that would be an interesting read!</p>
<p>I&#39;m happy with what I&#39;ve learned about FeliCa. I am not at all an expert in NFC, mobile payment systems, cryptography, or cyber security, but I&#39;ve at least been able to get a glimpse into this unusual world. I wonder if I&#39;ll be able to ever apply this knowledge anywhere.</p>

</div></div>
  </body>
</html>
