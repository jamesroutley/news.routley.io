<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.bzero.se/ldapd/btree.html">Original</a>
    <h1>How the append-only btree works (2010)</h1>
    
    <div id="readability-page-1" class="page">


<p>
  Consider this 3-level b+tree. There are two levels of branch pages
  (the root is a branch page), and 5 leaf pages.  Data and keys are
  stored in the leaf pages.
</p>
<p>
  Leaf chaining, ie links between leaf pages for easy sequential
  access, is not supported as it would require the whole tree to
  be rewritten on each update.
</p>
<p>
  <a href="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/how-the-btree-works.pdf" title="click for PDF version">
    <img src="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/how-the-btree-works.png"/>
  </a>
</p>

<p>
  The pages are stored sequentially in the database file. Increasing
  page numbers means increasing file offsets. The meta page includes
  a pointer to the root page, a SHA1 hash, and statistics counters.
</p>
<p>
  When the file is opened it is scanned backwards page by page to
  find a valid meta page, and thus the root of the tree.
</p>
<p>
  <a href="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/sequential-page-view.pdf" title="click for PDF version">
    <img src="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/sequential-page-view.png"/>
  </a>
</p>

<p>
  When updating a value in leaf page 8, instead of changing the
  page in-place, a whole new page is appended to the file (here as
  page 12). Because the location of the page is changed, each parent
  page needs to be updated to point to the new locations.
</p>
<p>
  Leaf page 7 is not affected. A new root page is created
  as a copy of the previous root page, only the pointer to branch
  page 6 is updated to point to branch page 11.
</p>
<p>
  Any cursor still having a pointer to root page 9 can traverse the
  tree unaffected by the change. It will see a consistent snapshot
  of the database.  Dashed pages and pointers in the diagram are
  still there in the file, they are just not the last version.
</p>
<p>
  <a href="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/updated-btree.pdf" title="click for PDF version">
    <img src="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/updated-btree.png"/>
  </a>
</p>

<p>
  In the file, pages are written sequentially by appending new pages
  to the file. Already written pages are never modified.
</p>
<p>
  After each new generation of the tree is written, there is a meta
  page pointing to the new root.
</p>
<p>
  <a href="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/flattened-btree-page-structure.pdf" title="click for PDF version">
    <img src="http://ablwr.github.io/blog/2023/12/28/researching-file-formats-18-ds-store/flattened-btree-page-structure.png"/>
  </a>
</p>
<p>
  Changing one page (leaf page 8) resulted in 4 new pages being
  appended to the file. This wastes disk space, but writing consecutive
  pages to disk is more efficient than writing random locations.
  And there is no need for a transaction log, because <em>the
  database file <strong>is</strong> the transaction log</em>.
</p>


<!--p style="color: gray">
  Diagrams created in <a href="http://figr.bzero.se/">figr</a>.
</p-->




</div>
  </body>
</html>
