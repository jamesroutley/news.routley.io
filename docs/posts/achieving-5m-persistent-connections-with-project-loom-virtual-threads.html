<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/ebarlas/project-loom-c5m">Original</a>
    <h1>Achieving 5M persistent connections with Project Loom virtual threads</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">Project Loom C5M is an experiment to achieve 5 million persistent connections each in client and server
Java applications using <a href="https://openjdk.java.net/projects/loom/" rel="nofollow">OpenJDK Project Loom</a>
<a href="https://openjdk.java.net/projects/loom/" rel="nofollow">virtual threads</a>.</p>
<p dir="auto">The C5M name is inspired by the <a href="https://en.wikipedia.org/wiki/C10k_problem" rel="nofollow">C10k problem</a> proposed in 1999.</p>

<p dir="auto">The project consists of two simple components, <code>EchoServer</code> and <code>EchoClient</code>.</p>
<p dir="auto"><code>EchoServer</code> creates many TCP passive server sockets, accepting new connections on each as they come in.
For each active socket created, <code>EchoServer</code> receives bytes in and echoes them back out.</p>
<p dir="auto"><code>EchoClient</code> initiates many outgoing TCP connections to a range of ports on a single destination server.
For each socket created, <code>EchoClient</code> sends a message to the server, awaits the response, and goes to sleep
for a time before sending again.</p>
<p dir="auto"><code>EchoClient</code> terminates immediately if any of the follow occurs:</p>
<ul dir="auto">
<li>Connection timeout</li>
<li>Socket read timeout</li>
<li>Integrity error with message received</li>
<li>TCP connection closure</li>
<li>TCP connection reset</li>
<li>Any other unexpected I/O condition</li>
</ul>

<p dir="auto">After plenty of trial and error, I arrived at the following set of Linux kernel parameter changes
to support the target socket scale.</p>
<p dir="auto">The following article about achieving 1 million persistent connections with Erlang was very helpful in this regard:
<a href="https://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-1" rel="nofollow">https://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-1</a></p>
<p dir="auto"><code>/etc/sysctl.conf</code>:</p>
<div data-snippet-clipboard-copy-content="fs.file-max=10485760
fs.nr_open=10485760

net.core.somaxconn=16192
net.core.netdev_max_backlog=16192
net.ipv4.tcp_max_syn_backlog=16192

net.ipv4.ip_local_port_range = 1024 65535

net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 87380 16777216
net.ipv4.tcp_mem = 1638400 1638400 1638400

net.netfilter.nf_conntrack_buckets = 1966050
net.netfilter.nf_conntrack_max = 7864200

#EC2 Amazon Linux
#net.core.netdev_max_backlog = 65536
#net.core.optmem_max = 25165824
#net.ipv4.tcp_max_tw_buckets = 1440000"><pre><code>fs.file-max=10485760
fs.nr_open=10485760

net.core.somaxconn=16192
net.core.netdev_max_backlog=16192
net.ipv4.tcp_max_syn_backlog=16192

net.ipv4.ip_local_port_range = 1024 65535

net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 87380 16777216
net.ipv4.tcp_mem = 1638400 1638400 1638400

net.netfilter.nf_conntrack_buckets = 1966050
net.netfilter.nf_conntrack_max = 7864200

#EC2 Amazon Linux
#net.core.netdev_max_backlog = 65536
#net.core.optmem_max = 25165824
#net.ipv4.tcp_max_tw_buckets = 1440000
</code></pre></div>
<p dir="auto"><code>/etc/security/limits.conf</code>:</p>
<div data-snippet-clipboard-copy-content="* soft nofile 8000000
* hard nofile 9000000"><pre><code>* soft nofile 8000000
* hard nofile 9000000
</code></pre></div>
<h2 dir="auto"><a id="user-content-bare-metal" aria-hidden="true" href="#bare-metal"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Bare Metal</h2>
<p dir="auto">Two server-grade hosts were used for bare metal tests:</p>
<ul dir="auto">
<li>HPE ProLiant BL460c Gen10</li>
<li>2x 20 core CPU</li>
<li>128GB RAM</li>
<li>Xeon Gold 6230 CPUs</li>
<li>CentOS 7.9</li>
<li>Project Loom Early Access Build 19-loom+5-429 (2022/4/4) from <a href="https://jdk.java.net/loom/" rel="nofollow">https://jdk.java.net/loom/</a></li>
</ul>
<p dir="auto">The server launched with a passive server port range of [9000, 9099].</p>
<p dir="auto">The client launched with the same server target port range and a connections-per-port count of 50,000,
for a total of 5,000,000 target connections.</p>
<p dir="auto">I stopped the experiment after about 40 minutes of continuous operation. None of the errors, closures, or timeouts
outlined above occurred.</p>
<hr/>
<p dir="auto">The experiment ran for 40 minutes. About 200,000,000 messages were echoed.</p>
<p dir="auto">Server:</p>
<div data-snippet-clipboard-copy-content="[ebarlas@dct-kvm1.bmi ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer 0.0.0.0 9000 100 16192 16
Args[host=0.0.0.0, port=9000, portCount=100, backlog=16192, bufferSize=16]
[0] connections=0, messages=0
[1040] connections=0, messages=0
...
[10047] connections=765, messages=765
[11047] connections=7292, messages=7282
...
[2422192] connections=5000000, messages=199113472
[2423193] connections=5000000, messages=199216494
[2424195] connections=5000000, messages=199304727"><pre><code>[ebarlas@dct-kvm1.bmi ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer 0.0.0.0 9000 100 16192 16
Args[host=0.0.0.0, port=9000, portCount=100, backlog=16192, bufferSize=16]
[0] connections=0, messages=0
[1040] connections=0, messages=0
...
[10047] connections=765, messages=765
[11047] connections=7292, messages=7282
...
[2422192] connections=5000000, messages=199113472
[2423193] connections=5000000, messages=199216494
[2424195] connections=5000000, messages=199304727
</code></pre></div>
<p dir="auto">Client:</p>
<div data-snippet-clipboard-copy-content="[ebarlas@dct-kvm2.bmi ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient dct-kvm1.bmi.expertcity.com 9000 100 50000 60000 60000 60000
Args[host=dct-kvm1.bmi.expertcity.com, port=9000, portCount=100, numConnections=50000, socketTimeout=60000, warmUp=60000, sleep=60000]
[0] connections=8788, messages=8767
[1013] connections=25438, messages=25438
[2014] connections=45285, messages=45279
[3014] connections=64865, messages=64863
...
[2410230] connections=5000000, messages=199020253
[2411230] connections=5000000, messages=199092940
[2412230] connections=5000000, messages=199188157"><pre><code>[ebarlas@dct-kvm2.bmi ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient dct-kvm1.bmi.expertcity.com 9000 100 50000 60000 60000 60000
Args[host=dct-kvm1.bmi.expertcity.com, port=9000, portCount=100, numConnections=50000, socketTimeout=60000, warmUp=60000, sleep=60000]
[0] connections=8788, messages=8767
[1013] connections=25438, messages=25438
[2014] connections=45285, messages=45279
[3014] connections=64865, messages=64863
...
[2410230] connections=5000000, messages=199020253
[2411230] connections=5000000, messages=199092940
[2412230] connections=5000000, messages=199188157
</code></pre></div>
<hr/>
<p dir="auto">The <code>ss</code> command reflects that both client and server had 5,000,000+ sockets open.</p>
<p dir="auto">Server:</p>
<div data-snippet-clipboard-copy-content="[ebarlas@dct-kvm1.bmi ~]$ ss -s
Total: 5001570 (kernel 0)
TCP:   5000123 (estab 5000010, closed 4, orphaned 0, synrecv 0, timewait 2/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  15        11        4        
TCP	  5000119   17        5000102  
INET	  5000134   28        5000106  
FRAG	  0         0         0 "><pre><code>[ebarlas@dct-kvm1.bmi ~]$ ss -s
Total: 5001570 (kernel 0)
TCP:   5000123 (estab 5000010, closed 4, orphaned 0, synrecv 0, timewait 2/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  15        11        4        
TCP	  5000119   17        5000102  
INET	  5000134   28        5000106  
FRAG	  0         0         0 
</code></pre></div>
<p dir="auto">Client:</p>
<div data-snippet-clipboard-copy-content="[ebarlas@dct-kvm2.bmi ~]$ ss -s
Total: 5000735 (kernel 0)
TCP:   5000019 (estab 5000006, closed 5, orphaned 0, synrecv 0, timewait 4/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  12        8         4        
TCP	  5000014   13        5000001  
INET	  5000026   21        5000005  
FRAG	  0         0         0 "><pre><code>[ebarlas@dct-kvm2.bmi ~]$ ss -s
Total: 5000735 (kernel 0)
TCP:   5000019 (estab 5000006, closed 5, orphaned 0, synrecv 0, timewait 4/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  12        8         4        
TCP	  5000014   13        5000001  
INET	  5000026   21        5000005  
FRAG	  0         0         0 
</code></pre></div>
<hr/>
<p dir="auto">The server Java process used 32 GB of committed resident memory and 49 GB of virtual memory.
After running for 37m37s, it used 03h39m02s of CPU time.</p>
<p dir="auto">The client Java process used 26 GB of committed resident memory and 49 GB of virtual memory.
After running for 37m12s, it used 06h16m30s of CPU time.</p>
<p dir="auto">Server:</p>
<div data-snippet-clipboard-copy-content="COMMAND                                                                                              %CPU     TIME     ELAPSED   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer  582 03:39:02       37:37 35102 24.1 31806188 48537940"><pre><code>COMMAND                                                                                              %CPU     TIME     ELAPSED   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer  582 03:39:02       37:37 35102 24.1 31806188 48537940
</code></pre></div>
<p dir="auto">Client:</p>
<div data-snippet-clipboard-copy-content="COMMAND                                                                                              %CPU     TIME     ELAPSED   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient 1012 06:16:30       37:12 19339 20.0 26370892 48553472"><pre><code>COMMAND                                                                                              %CPU     TIME     ELAPSED   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient 1012 06:16:30       37:12 19339 20.0 26370892 48553472
</code></pre></div>
<hr/>
<p dir="auto">A dump of the Java platform threads confirmed expectations. 220 <em>total</em> threads and 80 <em>carrier</em> threads.</p>
<p dir="auto">As outlined in <a href="https://openjdk.java.net/jeps/425" rel="nofollow">JEP 425</a>, the number of carrier threads defaults
to <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Runtime.html#availableProcessors()" rel="nofollow">available processors</a>.</p>
<p dir="auto">The number of processors reports by the host is 80. 2 CPUs, 20 cores each, hyper-threading (2 threads each).</p>
<div data-snippet-clipboard-copy-content="$ grep ^processor /proc/cpuinfo  | wc -l
80
$ ./jdk-19/bin/jstack 28226 &gt; threads.txt
$ grep tid= threads.txt | wc -l
220
$ grep tid= threads.txt | grep ForkJoin | wc -l
80"><pre>$ grep ^processor /proc/cpuinfo  <span>|</span> wc -l
80
$ ./jdk-19/bin/jstack 28226 <span>&gt;</span> threads.txt
$ grep tid= threads.txt <span>|</span> wc -l
220
$ grep tid= threads.txt <span>|</span> grep ForkJoin <span>|</span> wc -l
80</pre></div>
<h2 dir="auto"><a id="user-content-ec2" aria-hidden="true" href="#ec2"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>EC2</h2>
<p dir="auto">Two EC2 instances were used for cloud tests:</p>
<ul dir="auto">
<li>c5.2xlarge</li>
<li>16GB RAM</li>
<li>8 vCPU</li>
<li>Amazon Linux 2 with Linux Kernel 5.10, AMI ami-00f7e5c52c0f43726</li>
<li>Project Loom Early Access Build 19-loom+5-429 (2022/4/4) from <a href="https://jdk.java.net/loom/" rel="nofollow">https://jdk.java.net/loom/</a></li>
</ul>
<p dir="auto">The server launched with a passive server port range of [9000, 9049].</p>
<p dir="auto">The client launched with the same server target port range and a connections-per-port count of 10,000,
for a total of 500,000 target connections.</p>
<p dir="auto">I stopped the experiment after about 35 minutes of continuous operation. None of the errors, closures, or timeouts
outlined above occurred.</p>
<hr/>
<p dir="auto">The experiment ran for 35 minutes. About 17,500,000 messages were echoed.</p>
<div data-snippet-clipboard-copy-content="[ec2-user@ip-10-39-197-143 ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer 0.0.0.0 9000 50 16192 16
Args[host=0.0.0.0, port=9000, portCount=50, backlog=16192, bufferSize=16]
[0] connections=0, messages=0
[1015] connections=0, messages=0
...
[17020] connections=2412, messages=2412
[18020] connections=10317, messages=10316
...
[2106644] connections=500000, messages=17414982
[2107645] connections=500000, messages=17423544"><pre><code>[ec2-user@ip-10-39-197-143 ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer 0.0.0.0 9000 50 16192 16
Args[host=0.0.0.0, port=9000, portCount=50, backlog=16192, bufferSize=16]
[0] connections=0, messages=0
[1015] connections=0, messages=0
...
[17020] connections=2412, messages=2412
[18020] connections=10317, messages=10316
...
[2106644] connections=500000, messages=17414982
[2107645] connections=500000, messages=17423544
</code></pre></div>
<div data-snippet-clipboard-copy-content="[ec2-user@ip-10-39-196-215 ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient 10.39.197.143 9000 50 10000 30000 60000 60000
Args[host=10.39.197.143, port=9000, portCount=50, numConnections=10000, socketTimeout=30000, warmUp=60000, sleep=60000]
[0] connections=131, messages=114
[1014] connections=4949, messages=4949
[2014] connections=13248, messages=13246
...
[2091751] connections=500000, messages=17428105
[2092751] connections=500000, messages=17432046"><pre><code>[ec2-user@ip-10-39-196-215 ~]$ ./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient 10.39.197.143 9000 50 10000 30000 60000 60000
Args[host=10.39.197.143, port=9000, portCount=50, numConnections=10000, socketTimeout=30000, warmUp=60000, sleep=60000]
[0] connections=131, messages=114
[1014] connections=4949, messages=4949
[2014] connections=13248, messages=13246
...
[2091751] connections=500000, messages=17428105
[2092751] connections=500000, messages=17432046
</code></pre></div>
<hr/>
<p dir="auto">The <code>ss</code> command reflects that both client and server had 500,000+ sockets open.</p>
<p dir="auto">Server:</p>
<div data-snippet-clipboard-copy-content="[ec2-user@ip-10-39-197-143 ~]$ ss -s
Total: 500233 (kernel 0)
TCP:   500057 (estab 500002, closed 0, orphaned 0, synrecv 0, timewait 0/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  8         4         4        
TCP	  500057    5         500052   
INET	  500065    9         500056   
FRAG	  0         0         0 "><pre><code>[ec2-user@ip-10-39-197-143 ~]$ ss -s
Total: 500233 (kernel 0)
TCP:   500057 (estab 500002, closed 0, orphaned 0, synrecv 0, timewait 0/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  8         4         4        
TCP	  500057    5         500052   
INET	  500065    9         500056   
FRAG	  0         0         0 
</code></pre></div>
<p dir="auto">Client:</p>
<div data-snippet-clipboard-copy-content="[ec2-user@ip-10-39-196-215 ~]$ ss -s
Total: 500183 (kernel 0)
TCP:   500007 (estab 500002, closed 0, orphaned 0, synrecv 0, timewait 0/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  8         4         4        
TCP	  500007    5         500002   
INET	  500015    9         500006   
FRAG	  0         0         0 "><pre><code>[ec2-user@ip-10-39-196-215 ~]$ ss -s
Total: 500183 (kernel 0)
TCP:   500007 (estab 500002, closed 0, orphaned 0, synrecv 0, timewait 0/0), ports 0

Transport Total     IP        IPv6
*	  0         -         -        
RAW	  0         0         0        
UDP	  8         4         4        
TCP	  500007    5         500002   
INET	  500015    9         500006   
FRAG	  0         0         0 
</code></pre></div>
<hr/>
<p dir="auto">The server Java process used 2.3 GB of committed resident memory and 8.4 GB of virtual memory.
After running for 35.12m, it used 14m42s of CPU time.</p>
<p dir="auto">The client Java process used 2.8 GB of committed resident memory and 8.9 GB of virtual memory.
After running for 34.88m, it used 25m19s of CPU time.</p>
<p dir="auto">Server:</p>
<div data-snippet-clipboard-copy-content="COMMAND                                                                                              %CPU     TIME   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer 36.7 00:12:42 18432 14.5 2317180 8434320"><pre><code>COMMAND                                                                                              %CPU     TIME   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoServer 36.7 00:12:42 18432 14.5 2317180 8434320
</code></pre></div>
<p dir="auto">Client:</p>
<div data-snippet-clipboard-copy-content="COMMAND                                                                                              %CPU     TIME   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient 73.9 00:25:19 18120 17.9 2848356 8901320"><pre><code>COMMAND                                                                                              %CPU     TIME   PID %MEM   RSS    VSZ
./jdk-19/bin/java --enable-preview -ea -cp project-loom-scale-1.0.0-SNAPSHOT.jar loomtest.EchoClient 73.9 00:25:19 18120 17.9 2848356 8901320
</code></pre></div>
</article>
          </div></div>
  </body>
</html>
