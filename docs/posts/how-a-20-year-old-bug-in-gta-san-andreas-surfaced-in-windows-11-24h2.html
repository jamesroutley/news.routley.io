<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://cookieplmonster.github.io/2025/04/23/gta-san-andreas-win11-24h2-bug/">Original</a>
    <h1>How a 20 year old bug in GTA San Andreas surfaced in Windows 11 24H2</h1>
    
    <div id="readability-page-1" class="page"><article>
  <header id="main">
    <div>
      
      <p>April 23, 2025</p>
      <p>14 min. to read</p>
    </div>
  </header>
  <section>
    
      <ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#investigating-the-bug" id="markdown-toc-investigating-the-bug">Investigating the bug</a>    <ul>
      <li><a href="#what-is-broken" id="markdown-toc-what-is-broken">What is broken?</a></li>
      <li><a href="#but-why-and-how" id="markdown-toc-but-why-and-how">But why and how?</a></li>
    </ul>
  </li>
  <li><a href="#here-be-dragons--the-true-root-cause" id="markdown-toc-here-be-dragons--the-true-root-cause">Here be dragons ‚Äì the true root cause</a>    <ul>
      <li><a href="#diving-deeper" id="markdown-toc-diving-deeper">Diving deeper</a></li>
      <li><a href="#whose-stack-is-it-anyway" id="markdown-toc-whose-stack-is-it-anyway">Whose Stack Is It Anyway?</a></li>
      <li><a href="#what-are-the-odds-this-only-broke-now-darn-windows-11" id="markdown-toc-what-are-the-odds-this-only-broke-now-darn-windows-11">What are the odds this only broke now? Darn Windows 11!</a></li>
    </ul>
  </li>
  <li><a href="#i-want-this-fixed-in-my-game" id="markdown-toc-i-want-this-fixed-in-my-game">I want this fixed in my game!</a></li>
  <li><a href="#final-word" id="markdown-toc-final-word">Final word</a></li>
</ul>

    

<p>On the <a href="https://github.com/CookiePLMonster/SilentPatch/issues/172" target="_blank">SilentPatch GitHub issue tracker</a>,
I received a rather specific bug report:</p>

<blockquote>
<h3 id="skimmer-airplane-doesnt-exist-in-windows-11-24h2">
  
  
    Skimmer airplane doesn‚Äôt exist in Windows 11 24H2
  
  
</h3>
    

  <p>When I upgraded my windows to version 24H2, the Skimmer plane disappear completely from the game.
It can‚Äôt be spawn using trainer nor it can‚Äôt be found anywhere on it‚Äôs normal spawn points.
I‚Äôm using both my modded copy (which is before the update, is completely fine) and vanilla copy with only silentpatch
(I tried the 2018, 2020 and the most recent version of silentpatch) and the plane still won‚Äôt exist.</p>
</blockquote>

<p>If this was the first time I had heard about it, I‚Äôd likely consider it dubious and suspect there are more things at play,
and it‚Äôs not specifically Windows 11 24H2. However, on GTAForums, I‚Äôve been receiving comments about this exact issue since November last year.
Some of them said SilentPatch causes this issue, others however stated the same happens on a completely unmodded game:</p>

<blockquote>
  <p>Apparently the skimmer cant spawn when playing on Windows 11 24h2 update, hope this bug gets fixed.</p>

  <p>EDIT: So I think I confirmed it, I set up a VM with Windows 11 23h2 and the damn plane spawns fine,
and updating that same VM to 24h2 breaks the skimmer, why would a small feature update in 2024 break a random plane in a 2005 game is anyone‚Äôs guess.</p>
</blockquote>

<blockquote>
  <p>After the latest Silent patch update there is no Skimmer in the game and when I try to spawn it with RZL-Trainer or Cheat Menu by Grinch,
the game freezes and I have to close it via Task Manager.</p>
</blockquote>

<blockquote>
  <p>[‚Ä¶] I was forced to update to 24H2, and now after the update, I have the same problem with the Skimmer in GTA SA as others.
This means that mods or anything else are not causing the issue, the problem appeared after the latest Windows update.</p>
</blockquote><hr/>

<p>My home PC is still on Windows 10 22H2, while my work machine is on Windows 11 23H2, and, to no surprise, neither machine reproduced the issue ‚Äì Skimmer spawned
on the water just fine, creating one via script and putting CJ in a driver‚Äôs seat worked too.</p>

<p>That said, I also asked a few people who upgraded to 24H2 to test this on their machines and they <strong>all</strong> hit this bug. Attempts to debug ‚Äúremotely‚Äù
by giving instructions over the chat didn‚Äôt go anywhere, so I set up a 24H2 virtual machine on my own. I copied the game over to the machine, set it up for remote
debugging from the host OS, headed to the usual place the Skimmer spawns, and sure enough, it wasn‚Äôt there. All other planes and boats still spawned fine,
only this one vehicle did not:</p>

<figure>
<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/gta_sa_SqUlKDKCRs.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/thumb/gta_sa_SqUlKDKCRs.jpg" alt="" width="1024" height="576"/></a><figcaption>Skimmer is gone.</figcaption></figure>

<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/gta_sa_qnldPBAKRl.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/thumb/gta_sa_qnldPBAKRl.jpg" alt="" width="1024" height="576"/></a><figcaption>Other planes are still here, though.</figcaption></figure>

</figure>

<p>I then used the script to spawn a Skimmer and put CJ inside it, just to be launched
<code>1.0287648030984853e+0031</code> = <strong>10.3 nonillion meters</strong>, or <strong>10.3 octillion kilometers</strong>, or <strong>1.087 quadrillion light-years</strong> up in the sky üòÜ</p>

<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/gta_sa_5KOLUPPHLe.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/thumb/gta_sa_5KOLUPPHLe.jpg" alt="" width="1024" height="576"/></a><figcaption>Scientists claim to have discovered a ‚Äònew color‚Äô no one has seen before.</figcaption></figure>

<p>With SilentPatch installed, the game freezes shortly after launching the player up, as the game code gets stuck in a loop.
Without SilentPatch, the game doesn‚Äôt freeze, but instead, it succumbs to a famous ‚Äúburn-in effect‚Äù known to occur when the camera gets launched into infinity or close to it.
Funny enough, you can still kind of make out the shape of the plane even though the animations give up completely to the inaccuracies of the floating point values:</p>

<figure>
<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/gta_sa_GXULFRni6Y.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/thumb/gta_sa_GXULFRni6Y.jpg" alt="" width="1024" height="576"/></a></figure>

<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/gta_sa_qQUqnmyhV6.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/thumb/gta_sa_qQUqnmyhV6.jpg" alt="" width="1024" height="576"/></a></figure>

</figure>

    
<h2 id="what-is-broken">
  
  
    What is broken? <a href="#what-is-broken"><svg viewBox="0 0 16 16" version="1.1" width="16" height="32" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>
  
  
</h2>
    

<p>But, enough messing around; now I knew it was a real bug and I needed to figure out the root cause. At this point it wasn‚Äôt possible to say
whether the game was at fault, or if I was really dealing with an API bug introduced in 24H2, as looking at how many games have issues with this OS version,
it could go either way.</p>

<p>I didn‚Äôt have much to go with, but the fact the game froze with SilentPatch installed provided me with a good starting point. Upon entering the seaplane,
the game froze in a very small loop in <code>CPlane::PreRender</code>, attempting to normalize the rotor blade angle to the 0-360 degree range:</p>

<div><div><pre><code><span>this</span><span>-&gt;</span><span>m_fBladeAngle</span> <span>=</span> <span>CTimer</span><span>::</span><span>ms_fTimeStep</span> <span>*</span> <span>this</span><span>-&gt;</span><span>m_fBladeSpeed</span> <span>+</span> <span>this</span><span>-&gt;</span><span>m_fBladeAngle</span><span>;</span>
<span>while</span> <span>(</span><span>this</span><span>-&gt;</span><span>m_fBladeAngle</span> <span>&gt;</span> <span>6.2831855</span><span>)</span>
<span>{</span>
  <span>this</span><span>-&gt;</span><span>m_fBladeAngle</span> <span>=</span> <span>this</span><span>-&gt;</span><span>m_fBladeAngle</span> <span>-</span> <span>6.2831855</span><span>;</span>
<span>}</span>
</code></pre></div></div>

<p>In the debugged session, <code>this-&gt;m_fBladeSpeed</code> was <code>3.73340132e+29</code>. This value is obviously enormous, big enough to make decrementing the value by <code>6.2831855</code>
entirely ineffective due to the difference in floating point exponents of these two values.<sup id="fnref:fp-explanation" role="doc-noteref"><a href="#fn:fp-explanation" rel="footnote">1</a></sup> But why is the blade speed so ridiculously high?
The blade speed is derived from the following formula:</p>
<div><div><pre><code><span>this</span><span>-&gt;</span><span>m_fBladeSpeed</span> <span>=</span> <span>(</span><span>v34</span> <span>-</span> <span>this</span><span>-&gt;</span><span>m_fBladeSpeed</span><span>)</span> <span>*</span> <span>CTimer</span><span>::</span><span>ms_fTimeStep</span> <span>/</span> <span>100.0</span> <span>+</span> <span>this</span><span>-&gt;</span><span>m_fBladeSpeed</span><span>;</span>
</code></pre></div></div>

<p>where <code>v34</code> is <strong>proportional to the plane‚Äôs altitude</strong>. This matches the initial findings ‚Äì as mentioned earlier, the ‚Äúburn-in effect‚Äù traditionally happens
when the camera is very far away from the map center, or at a great height.</p>

<p>What caused the plane to shoot so high up? There are two possibilities:</p>
<ol>
  <li>The plane spawns high up in the sky already.</li>
  <li>The plane spawns at ground level and then shoots up in the next frame.</li>
</ol>

<p>As for this test, I was spawning the Skimmer myself with a test script, so I could start from the function used in the game‚Äôs SCM (script) interpreter,
named <code>CCarCtrl::CreateCarForScript</code>. This function spawns a vehicle with a specified ID at the provided coordinates, and those come from my test script,
so I know they are correct. However, this function transforms the supplied Z coordinate slightly:</p>

<div><div><pre><code><span>if</span> <span>(</span><span>posZ</span> <span>&lt;=</span> <span>100.0</span><span>)</span>
<span>{</span>
  <span>posZ</span> <span>=</span> <span>CWorld</span><span>::</span><span>FindGroundZForCoord</span><span>(</span><span>posX</span><span>,</span> <span>posY</span><span>);</span>
<span>}</span>
<span>posZ</span> <span>+=</span> <span>newVehicle</span><span>-&gt;</span><span>GetDistanceFromCentreOfMassToBaseOfModel</span><span>();</span>
</code></pre></div></div>

<p><code>CEntity::GetDistanceFromCentreOfMassToBaseOfModel</code> contains multiple code paths, but the one used in this case simply gets the negated maximum Z value
of the model‚Äôs bounding box:</p>
<div><div><pre><code><span>return</span> <span>-</span><span>CModelInfo</span><span>::</span><span>ms_modelInfoPtrs</span><span>[</span><span>this</span><span>-&gt;</span><span>m_wModelIndex</span><span>]</span><span>-&gt;</span><span>pColModel</span><span>-&gt;</span><span>bbox</span><span>.</span><span>sup</span><span>.</span><span>z</span><span>;</span>
</code></pre></div></div>

<p>At this point, I expected this value to be incorrect, so I peeked into Skimmer‚Äôs bounding box values just to find out that the maximum Z value is indeed corrupted:</p>

<div><div><pre><code>- *(RwBBox**)0x00B2AC48	RwBBox *
  - sup	RwV3d
      x	-5.39924574	float
      y	-6.77431822	float
      z	-4.30747210e+33	float
  - inf	RwV3d
      x	5.42313004	float
      y	4.02343750	float
      z	1.87021971	float
</code></pre></div></div>

<p>If all the components of the bounding box were corrupted, I would have suspected some memory corruption, like another code writing past boundaries and overwriting
these values, but it‚Äôs specifically <code>sup.z</code> that is corrupted that is neither the first nor the last field in the bounding box. Once again, two possibilities came to my mind:</p>
<ol>
  <li>The collision file is read incorrectly and some fields remain uninitialized, or read unrelated data instead of the bounding box? Highly unlikely, but not impossible given that
  this issue could potentially have been an OS bug.</li>
  <li>The bounding box is read correctly, but then it‚Äôs updated with an outrageously incorrect value.</li>
</ol>

<p>A data breakpoint set up at <code>pColModel</code> reveals that at the time of the initial setup, the bounding box is correct, and the value of the Z coordinate is completely reasonable:</p>
<div><div><pre><code>- *(RwBBox**)0x00B2AC48	RwBBox *
  - sup	RwV3d
    x	-5.39924574	float
    y	-6.77431822	float
    z	-2.21952772	float
  - inf	RwV3d
    x	5.42313004	float
    y	4.02343750	float
    z	1.87021971	float
</code></pre></div></div>

<p>Turns out, the first time a vehicle with a specific model is spawned, the game sets up the suspension in a function <code>SetupSuspensionLines</code>, and updates the Z coordinate
of the bounding box to reflect the car‚Äôs natural suspension height:</p>
<div><div><pre><code><span>if</span> <span>(</span><span>pSuspensionLines</span><span>[</span><span>0</span><span>].</span><span>p1</span><span>.</span><span>z</span> <span>&lt;</span> <span>colModel</span><span>-&gt;</span><span>bbox</span><span>.</span><span>sup</span><span>.</span><span>z</span><span>)</span>
<span>{</span>
  <span>colModel</span><span>-&gt;</span><span>bbox</span><span>.</span><span>sup</span><span>.</span><span>z</span> <span>=</span> <span>pSuspensionLines</span><span>[</span><span>0</span><span>].</span><span>p1</span><span>.</span><span>z</span><span>;</span>
<span>}</span>
</code></pre></div></div>

<p>This is where things went wrong first. The suspension lines are computed using a combination of values from <code>handling.cfg</code> and the wheel scale parameter
coming from <code>vehicles.ide</code>:</p>
<div><div><pre><code><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>4</span><span>;</span> <span>i</span><span>++</span><span>)</span>
<span>{</span>
  <span>CVector</span> <span>posn</span><span>;</span>
  <span>modelInfo</span><span>-&gt;</span><span>GetWheelPosn</span><span>(</span><span>i</span><span>,</span> <span>posn</span><span>);</span>

  <span>posn</span><span>.</span><span>z</span> <span>+=</span> <span>pHandling</span><span>-&gt;</span><span>fSuspensionUpperLimit</span><span>;</span>
  <span>colModel</span><span>-&gt;</span><span>lines</span><span>[</span><span>i</span><span>].</span><span>p0</span> <span>=</span> <span>posn</span><span>;</span>

  <span>float</span> <span>wheelScale</span> <span>=</span> <span>i</span> <span>!=</span> <span>0</span> <span>&amp;&amp;</span> <span>i</span> <span>!=</span> <span>2</span> <span>?</span> <span>modelInfo</span><span>-&gt;</span><span>m_frontWheelScale</span> <span>:</span> <span>modelInfo</span><span>-&gt;</span><span>m_rearWheelScale</span><span>;</span>

  <span>posn</span><span>.</span><span>z</span> <span>+=</span> <span>pHandling</span><span>-&gt;</span><span>fSuspensionLowerLimit</span> <span>-</span> <span>pHandling</span><span>-&gt;</span><span>fSuspensionUpperLimit</span><span>;</span>
  <span>posn</span><span>.</span><span>z</span> <span>-=</span> <span>wheelScale</span> <span>/</span> <span>2.0</span><span>;</span>
  <span>colModel</span><span>-&gt;</span><span>lines</span><span>[</span><span>i</span><span>].</span><span>p1</span> <span>=</span> <span>posn</span><span>;</span>
<span>}</span>
</code></pre></div></div>

<p>Since I knew <code>colModel-&gt;lines[0].p1</code> is corrupted, this meant either <code>pHandling-&gt;fSuspensionLowerLimit</code>, <code>pHandling-&gt;fSuspensionUpperLimit</code>, or <code>wheelScale</code> were bogus.
Skimmer‚Äôs <code>handling.cfg</code> values didn‚Äôt seem any different to any other plane in the game, but then I spotted something interesting in <code>vehicles.ide</code>. Skimmer‚Äôs line looks like this:</p>
<div><div><pre><code>460, 	skimmer,	skimmer, 	plane,		SEAPLANE,	SKIMMER,	null,	ignore,		5,	0,	0
</code></pre></div></div>

<p>Compare this line to any other plane in the game, in this example Rustler:</p>
<div><div><pre><code>476, 	rustler, 	rustler, 	plane, 		RUSTLER, 	RUSTLER,	rustler, ignore,		10,	0,	0,		-1, 0.6, 0.3,		-1
</code></pre></div></div>

<p>The line is shorter and it‚Äôs missing the last four parameters, moreover, <strong>two of the missing parameters are the front and rear wheel scale!</strong>
This is normal for boats, but Skimmer is <strong>the only</strong> plane to omit these parameters.</p>

<p>Does re-adding those parameters fix the seaplane? Unsurprisingly, it does!</p>

<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/gta_sa_3hbE1KfRUe.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/screens/thumb/gta_sa_3hbE1KfRUe.jpg" alt="" width="1024" height="576"/></a></figure>
<h2 id="but-why-and-how">
  
  
    But why and how? <a href="#but-why-and-how"><svg viewBox="0 0 16 16" version="1.1" width="16" height="32" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>
  
  
</h2>
    

<p>I have a likely explanation for why Rockstar made this specific mistake in the data to begin with ‚Äì in Vice City, Skimmer was defined as a <strong>boat</strong>,
and therefore did not have those values defined by design!
When in San Andreas they changed Skimmer‚Äôs vehicle type to a <strong>plane</strong>, someone forgot to add those now-required extra parameters.
Since this game seldom verifies the completeness of its data, this mistake simply slipped under the radar.</p>

<p>Problem solved? Not quite yet, as for SilentPatch, I need to fix it from the code. A peek into the pseudocode of <code>CFileLoader::LoadVehicleObject</code>
reveals the true nature of this bug: the game assumes all parameters are always present in the definition line and it doesn‚Äôt default any but two parameters,
nor it checks the return value of <code>sscanf</code>, and so in the case of all boats and Skimmer, those parameters remained uninitialized:</p>
<div><div><pre><code><span>void</span> <span>CFileLoader</span><span>::</span><span>LoadVehicleObject</span><span>(</span><span>const</span> <span>char</span><span>*</span> <span>line</span><span>)</span>
<span>{</span>
  <span>int</span> <span>objID</span> <span>=</span> <span>-</span><span>1</span><span>;</span>
  <span>char</span> <span>modelName</span><span>[</span><span>24</span><span>];</span>
  <span>char</span> <span>texName</span><span>[</span><span>24</span><span>];</span>
  <span>char</span> <span>type</span><span>[</span><span>8</span><span>];</span>
  <span>char</span> <span>handlingID</span><span>[</span><span>16</span><span>];</span>
  <span>char</span> <span>gameName</span><span>[</span><span>32</span><span>];</span>
  <span>char</span> <span>anims</span><span>[</span><span>16</span><span>];</span>
  <span>char</span> <span>vehClass</span><span>[</span><span>16</span><span>];</span>
  <span>int</span> <span>frq</span><span>;</span>
  <span>int</span> <span>flags</span><span>;</span>
  <span>int</span> <span>comprules</span><span>;</span>
  <span>int</span> <span>wheelModelID</span><span>;</span> <span>// Uninitialized!</span>
  <span>float</span> <span>frontWheelScale</span><span>,</span> <span>rearWheelScale</span><span>;</span> <span>// Uninitialized!</span>
  <span>int</span> <span>wheelUpgradeClass</span> <span>=</span> <span>-</span><span>1</span><span>;</span> <span>// Funny enough, this one IS initialized</span>

  <span>int</span> <span>TxdSlot</span> <span>=</span> <span>CTxdStore</span><span>::</span><span>FindTxdSlot</span><span>(</span><span>&#34;vehicle&#34;</span><span>);</span>
  <span>if</span> <span>(</span><span>TxdSlot</span> <span>==</span> <span>-</span><span>1</span><span>)</span>
  <span>{</span>
    <span>TxdSlot</span> <span>=</span> <span>CTxdStore</span><span>::</span><span>AddTxdSlot</span><span>(</span><span>&#34;vehicle&#34;</span><span>);</span>
  <span>}</span>
  <span>sscanf</span><span>(</span><span>line</span><span>,</span> <span>&#34;%d %s %s %s %s %s %s %s %d %d %x %d %f %f %d&#34;</span><span>,</span> <span>&amp;</span><span>objID</span><span>,</span> <span>modelName</span><span>,</span> <span>texName</span><span>,</span> <span>type</span><span>,</span> <span>handlingID</span><span>,</span>
        <span>gameName</span><span>,</span> <span>anims</span><span>,</span> <span>vehClass</span><span>,</span> <span>&amp;</span><span>frq</span><span>,</span> <span>&amp;</span><span>flags</span><span>,</span> <span>&amp;</span><span>comprules</span><span>,</span> <span>&amp;</span><span>wheelModelID</span><span>,</span> <span>&amp;</span><span>frontWheelScale</span><span>,</span> <span>&amp;</span><span>rearWheelScale</span><span>,</span>
        <span>&amp;</span><span>wheelUpgradeClass</span><span>);</span>

  <span>// More processing here...</span>
<span>}</span>
</code></pre></div></div>

<p>Given the symptoms, those uninitialized values must have evaluated to small, valid floating point values all the way until now,
whereas with Windows 11 24H2 they got out of hand and tripped the bounding box calculations.</p>

<p>In SilentPatch, the fix is easy ‚Äì I wrap this call to <code>sscanf</code> and provide reasonable defaults for the final four parameters:</p>
<div><div><pre><code><span>static</span> <span>int</span> <span>(</span><span>*</span><span>orgSscanf</span><span>)(</span><span>const</span> <span>char</span><span>*</span> <span>s</span><span>,</span> <span>const</span> <span>char</span><span>*</span> <span>format</span><span>,</span> <span>...);</span>
<span>static</span> <span>int</span> <span>sscanf_Defaults</span><span>(</span><span>const</span> <span>char</span><span>*</span> <span>s</span><span>,</span> <span>const</span> <span>char</span><span>*</span> <span>format</span><span>,</span> <span>int</span><span>*</span> <span>objID</span><span>,</span> <span>char</span><span>*</span> <span>modelName</span><span>,</span> <span>char</span><span>*</span> <span>texName</span><span>,</span> <span>char</span><span>*</span> <span>type</span><span>,</span>
      <span>char</span><span>*</span> <span>handlingID</span><span>,</span> <span>char</span><span>*</span> <span>gameName</span><span>,</span> <span>char</span><span>*</span> <span>anims</span><span>,</span> <span>char</span><span>*</span> <span>vehClass</span><span>,</span> <span>int</span><span>*</span> <span>frequency</span><span>,</span> <span>int</span><span>*</span> <span>flags</span><span>,</span> <span>int</span><span>*</span> <span>comprules</span><span>,</span>
      <span>int</span><span>*</span> <span>wheelModelID</span><span>,</span> <span>float</span><span>*</span> <span>frontWheelSize</span><span>,</span> <span>float</span><span>*</span> <span>rearWheelSize</span><span>,</span> <span>int</span><span>*</span> <span>wheelUpgradeClass</span><span>)</span>
<span>{</span>
  <span>*</span><span>wheelModelID</span> <span>=</span> <span>-</span><span>1</span><span>;</span>
  <span>// Why 0.7 and not 1.0, I&#39;ll explain later</span>
  <span>*</span><span>frontWheelSize</span> <span>=</span> <span>0.7</span><span>;</span>
  <span>*</span><span>rearWheelSize</span> <span>=</span> <span>0.7</span><span>;</span>
  <span>*</span><span>wheelUpgradeClass</span> <span>=</span> <span>-</span><span>1</span><span>;</span>

  <span>return</span> <span>orgSscanf</span><span>(</span><span>s</span><span>,</span> <span>format</span><span>,</span> <span>objID</span><span>,</span> <span>modelName</span><span>,</span> <span>texName</span><span>,</span> <span>type</span><span>,</span> <span>handlingID</span><span>,</span> <span>gameName</span><span>,</span> <span>anims</span><span>,</span> <span>vehClass</span><span>,</span>
                  <span>frequency</span><span>,</span> <span>flags</span><span>,</span> <span>comprules</span><span>,</span> <span>wheelModelID</span><span>,</span> <span>frontWheelSize</span><span>,</span> <span>rearWheelSize</span><span>,</span> <span>wheelUpgradeClass</span><span>);</span>
<span>}</span>
</code></pre></div></div>

<p><a href="https://github.com/CookiePLMonster/SilentPatch/commit/881aded7237067202025934796cc2313104cba8c" target="_blank">Fixed!</a>
Another compatibility win for the patch.</p><hr/>

<p>If this was a regular bug, I would‚Äôve ended the post right here. However, in the case of this rabbit hole, the discovery of this fix only
raised more questions ‚Äì why did this break only now? What made the game work fine despite of this issue for over twenty years,
before a new update to Windows 11 suddenly challenged this status quo?</p>

<p><strong>Finally, is this somehow caused by a problem in Windows 11 24H2, or is this just an unfortunate coincidence, stars aligning just right?</strong></p>

    
<h2 id="diving-deeper">
  
  
    Diving deeper <a href="#diving-deeper"><svg viewBox="0 0 16 16" version="1.1" width="16" height="32" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>
  
  
</h2>
    

<p>At this point, the working theory was that the uninitialized local variables in <code>CFileLoader::LoadVehicleObject</code>
happened to have reasonable values until <em>something</em> changed in Windows 11 24H2, and those values became ‚Äúunreasonable‚Äù.
What I knew could <strong>not</strong> be the cause was the CRT (and thus, the <code>sscanf</code> call) ‚Äì San Andreas uses a statically compiled CRT,
and therefore any OS-level hotfixes wouldn‚Äôt apply to it.
However, considering the plethora of security enhancements in Windows 11, I couldn‚Äôt rule out that one of those enhancements,
for example, <strong>Kernel-mode Hardware-enforced Stack Protection</strong>, ends up scrambling the stack in a way the game‚Äôs bugged function doesn‚Äôt like.</p>

<p>I set up an experiment where I broke into a debugger before a <code>sscanf</code> call when parsing Skimmer‚Äôs line (vehicle ID 460) specifically,
and the observed variable values supported that claim. On my Windows 10 machine, they happened to be both <code>0.7</code>:</p>
<div><div><pre><code>frontWheelSize  0x01779f14 {0.699999988}
rearWheelSize   0x01779f10 {0.699999988}
</code></pre></div></div>
<p>while on the Win11 24H2 VM, they are huge, similar in order of magnitude to the wrong values observed in the bounding box earlier.
The stack pointer has also shifted by 4 bytes for some reason, but that is unlikely to be related ‚Äì and it‚Äôs likely caused by some changes
to the thread startup boilerplate inside <code>kernel32.dll</code>:</p>
<div><div><pre><code>frontWheelSize  0x01779f18 {7.84421263e+33}
rearWheelSize   0x01779f14 {4.54809690e-38}
</code></pre></div></div>

<p>This got me curious - <code>0.7</code> is a bit ‚Äútoo good‚Äù of a value to be a result of interpreting random garbage from the stack as a floating point;
what‚Äôs more likely is that it‚Äôs an actual floating point value that was sitting on the stack in exactly the right spot.
I then inspected <code>vehicles.ide</code> for TopFun ‚Äì the vehicle defined directly before Skimmer. Sure enough, its wheel scale is <code>0.7</code>!</p>
<div><div><pre><code>459,	topfun,		topfun,		car,		TOPFUN,		TOPFUN,		van,	ignore,		1,	0,	0,		-1, 0.7, 0.7,		-1
</code></pre></div></div>

<p><code>vehicles.ide</code> is parsed in order, in a function working similarly to this (pseudocode):</p>
<div><div><pre><code><span>void</span> <span>CFileLoader</span><span>::</span><span>LoadObjectTypes</span><span>(</span><span>const</span> <span>char</span><span>*</span> <span>filename</span><span>)</span>
<span>{</span>
  <span>// Open the file...</span>

  <span>while</span> <span>((</span><span>line</span> <span>=</span> <span>fgets</span><span>(</span><span>file</span><span>))</span> <span>!=</span> <span>NULL</span><span>)</span>
  <span>{</span>
    <span>// Parse the section indicators...</span>
    <span>switch</span> <span>(</span><span>section</span><span>)</span>
    <span>{</span>
      <span>// Different sections...</span>
    <span>case</span> <span>SECTION_CARS</span><span>:</span>
      <span>LoadVehicleObject</span><span>(</span><span>line</span><span>);</span>
      <span>break</span><span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Seems like the code somehow persisted the stale wheel scale values, so Skimmer ends up getting the same wheel scales as Topfun.
I set up another experiment to verify this claim:</p>
<ol>
  <li>Set up a breakpoint before <code>sscanf</code> again, but this time before Topfun‚Äôs line (vehicle ID 459) gets parsed.</li>
  <li>Set up write breakpoints on <code>frontWheelScale</code> and <code>rearWheelScale</code>.</li>
  <li>Resume execution until the game gets to parsing the next vehicle definition.</li>
</ol>

<p>Windows 10 verified my claim ‚Äì <strong>nothing wrote to these two stack values between the calls to <code>CFileLoader::LoadVehicleObject</code>,
so the function‚Äôs effective behavior was to preserve (albeit, unintentionally) the wheel scale values between the consecutive calls!</strong></p>

<p>Repeating the same exercise on Windows 11 24H2 triggered the write breakpoint! However, it wasn‚Äôt anywhere close to any security feature:
the stack values were overwritten by‚Ä¶ <code>LeaveCriticalSection</code> inside <code>fgets</code>:</p>
<div><div><pre><code>&gt;	ntdll.dll!_RtlpAbFindLockEntry@4()	Unknown
 	ntdll.dll!_RtlAbPostRelease@8()	Unknown
 	ntdll.dll!_RtlLeaveCriticalSection@4()	Unknown
 	gta_sa.exe!fgets()	Unknown
</code></pre></div></div>

<p>Seems like a change in Windows 11 24H2 modified the way <a href="https://learn.microsoft.com/en-us/windows/win32/sync/critical-section-objects" target="_blank">Critical Section Objects</a>
work internally, and the new code unlocking the critical section uses more stack space than the old one.
I ran one more experiment, comparing the changes to the stack space that happened after <code>sscanf</code> inside <code>LoadVehicleObject</code>, until the next invocation of this function.
Changed values are highlighted in red:</p>

<figure>
<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/stack-win10.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/stack-win10.jpg" alt="" width="1190" height="611"/></a><figcaption>On Windows 10, the stack values didn‚Äôt change much between the calls.
        In fact, you can spot the two values of <code>0x3F449BA6</code> = <code>0.768</code> (highlighted on the screenshot).
        They correspond to Landstalker‚Äôs wheel scales.</figcaption></figure>

<figure><a href="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/stack-win11.jpg" target="_blank"><img src="https://cookieplmonster.github.io/assets/img/posts/sa-win11-24h2-bug/stack-win11.jpg" alt="" width="1190" height="611"/></a><figcaption>On Windows 11 24H2, more stack space was modified by a new implementation of Critical Sections.
                The wheel scales are nowhere to be found, as they were overwritten!</figcaption></figure>

</figure>

<p>This is the exact proof I needed ‚Äì notice that in the Windows 10 run, some of the local variables are even still visible to the human eye (like the <code>normal</code> vehicle class),
while in Windows 11, they are completely gone. It‚Äôs also worth pointing out that even in Windows 10, <strong>the very next local variable</strong> after the wheel scales has been overwritten
by <code>LeaveCriticalSection</code>, which means the game was <strong>4 bytes away</strong> from hitting this exact bug years earlier! The luck at display here is insane.</p>
<h2 id="whose-stack-is-it-anyway">
  
  
    Whose Stack Is It Anyway? <a href="#whose-stack-is-it-anyway"><svg viewBox="0 0 16 16" version="1.1" width="16" height="32" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>
  
  
</h2>
    

<p>To illustrate why the game got away with this bug for so long, I need to show how the stack changes across calls.
Let‚Äôs say the stack looks like this after the call to <code>LoadVehicleObject</code>. <strong>Emphasis</strong> on the local variables we‚Äôre interested in:</p>

<table>
  <tbody>
    <tr>
      <td>return address from <code>LoadObjectTypes</code></td>
    </tr>
    <tr>
      <td>local variables of <code>LoadObjectTypes</code>‚Ä¶</td>
    </tr>
    <tr>
      <td>return address from <code>LoadVehicleObject</code></td>
    </tr>
    <tr>
      <td>local variables of <code>LoadVehicleObject</code>‚Ä¶</td>
    </tr>
    <tr>
      <td><strong>frontWheelScale</strong></td>
    </tr>
    <tr>
      <td><strong>rearWheelScale</strong></td>
    </tr>
    <tr>
      <td>more local variables‚Ä¶</td>
    </tr>
  </tbody>
</table>

<p>The call to <code>fgets</code>, and consequently <code>LeaveCriticalSection</code>, that follows the call to <code>LoadVehicleObject</code>, reuses the stack space previously occupied by that function,
as the lifetime of the function stack is limited to the duration of the function itself and once the function is done, this space is up for grabs again.
On Windows 10, the stack looked like this once <code>fgets</code> and <code>LeaveCriticalSection</code> returned:</p>

<table>
  <tbody>
    <tr>
      <td>return address from <code>LoadObjectTypes</code></td>
    </tr>
    <tr>
      <td>local variables of <code>LoadObjectTypes</code>‚Ä¶</td>
    </tr>
    <tr>
      <td>return address from <code>fgets</code></td>
    </tr>
    <tr>
      <td>local variables of <code>fgets</code>‚Ä¶</td>
    </tr>
    <tr>
      <td>return address from <code>LeaveCriticalSection</code></td>
    </tr>
    <tr>
      <td>local variables of <code>LeaveCriticalSection</code>‚Ä¶</td>
    </tr>
    <tr>
      <td><strong>frontWheelScale</strong></td>
    </tr>
    <tr>
      <td><strong>rearWheelScale</strong></td>
    </tr>
    <tr>
      <td>more local variables‚Ä¶</td>
    </tr>
  </tbody>
</table>

<p><span>Highlighted parts</span> overwrite what used to be the stack space of <code>LoadVehicleObject</code>,
but notice how it doesn‚Äôt reach the area of the stack where the wheel scales resided.
In Windows 11 24H2, <code>LeaveCriticalSection</code> uses more stack space, so the stack space instead looks more like this:</p>

<table>
  <tbody>
    <tr>
      <td>return address from <code>LoadObjectTypes</code></td>
    </tr>
    <tr>
      <td>local variables of <code>LoadObjectTypes</code>‚Ä¶</td>
    </tr>
    <tr>
      <td>return address from <code>fgets</code></td>
    </tr>
    <tr>
      <td>local variables of <code>fgets</code>‚Ä¶</td>
    </tr>
    <tr>
      <td>return address from <code>LeaveCriticalSection</code></td>
    </tr>
    <tr>
      <td>local variables of <code>LeaveCriticalSection</code>‚Ä¶</td>
    </tr>
    <tr>
      <td><strong>frontWheelScale is overwritten!</strong></td>
    </tr>
    <tr>
      <td><strong>rearWheelScale is overwritten!</strong></td>
    </tr>
    <tr>
      <td>more local variables‚Ä¶</td>
    </tr>
  </tbody>
</table>

<p>Parts of the stack <span>highlighted in red</span> are now also scrambled
when in the past they were left intact; those parts include the wheel scales read by the previous call to <code>LoadVehicleObject</code>!
This in turn exposes the bug caused by those variables being uninitialized, and since <code>sscanf</code> can‚Äôt read those values from Skimmer‚Äôs <code>vehicles.ide</code> definition,
they are kept as-is in garbage form, and propagate further to the vehicle‚Äôs data.</p>
<h2 id="what-are-the-odds-this-only-broke-now-darn-windows-11">
  
  
    What are the odds this only broke now? Darn Windows 11! <a href="#what-are-the-odds-this-only-broke-now-darn-windows-11"><svg viewBox="0 0 16 16" version="1.1" width="16" height="32" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>
  
  
</h2>
    

<p>I want to make it clear: <strong>all these findings prove that the bug is NOT an issue with Windows 11 24H2,
as things like the way the stack is used by internal WinAPI functions are not contractual and they may change at any time, with no prior notice</strong>.
The real issue here is the game relying on undefined behavior (uninitialized local variables), and to be honest,
I‚Äôm shocked that the game didn‚Äôt hit this bug on so many OS versions, although as I pointed out earlier, it was extremely close.
San Andreas still supported Windows 98, which means it got away with this bug in <strong>at least</strong> a dozen different Windows versions <strong>and</strong> many more releases of Wine!</p>

<p>‚Ä¶or, did it? I found it hard to believe that the game would never hit this issue on any of the many, many platforms it released on,
so I looked into the binary files of some other releases. While this bug was <strong>not</strong> fixed in the official 1.01 PC patch, it <strong>was</strong> fixed in the original Xbox release,
where a ‚Äúreasonable default‚Äù of <code>1.0</code> was added to the code, much like in my fix. This fix was then ‚Äúinherited‚Äù by many future versions of San Andreas, including:</p>
<ul>
  <li>Steam 3.0, newsteam, and RGL, as they were all based on the Xbox branch of the code.</li>
  <li>Any releases from War Drum Studios, including Android, X360, and PS3.</li>
  <li>The Definitive Edition.</li>
</ul>

<p>However, unlike Rockstar, I decided to use the wheel scale of <code>0.7</code> instead of <code>1.0</code> as a default, for multiple reasons:</p>
<ol>
  <li>This is the effective wheel scale Skimmer had on PC (and possibly PS2) until now since that‚Äôs the wheel scale of Topfun.</li>
  <li>Two other non-boat vehicles that float on water, Sea Sparrow and Vortex, both have a wheel scale of <code>0.7</code>.</li>
  <li>Many cars in the game have a wheel scale of <code>0.7</code>.</li>
</ol>

    

<p>The code fix will be included in <a href="https://github.com/CookiePLMonster/SilentPatch/milestone/3" target="_blank">the next SilentPatch hotfix</a>,
but for now, you may easily fix it yourself by editing <code>vehicles.ide</code>:</p>
<ol>
  <li>In your San Andreas directory, open <code>data\vehicles.ide</code> with Notepad.</li>
  <li>Scroll down to Skimmer‚Äôs line beginning with <code>460, 	skimmer</code>.</li>
  <li>Replace the original line with:
    <div><div><pre><code>460, 	skimmer,	skimmer, 	plane,		SEAPLANE,	SKIMMER,	null,	ignore,		5,	0,	0,		-1, 0.7, 0.7,		-1
</code></pre></div>    </div>
  </li>
  <li>Save the file.</li>
</ol>

    

<p>This was the most interesting bug I‚Äôve encountered for a while. I initially had a hard time believing that a bug like this would directly tie to a specific OS release,
but I was proven completely wrong. At the end of the day, it was a simple bug in San Andreas and this function should have never worked right,
and yet, at least on PC it hid itself for two decades.</p>

<p>This is an interesting lesson in compatibility: even changes to the stack layout of the internal implementations can have compatibility implications if an application
is bugged and unintentionally relies on a specific behavior. This is also not the first time I encountered issues like this: regular visitors might remember
<a href="https://cookieplmonster.github.io/mods/bully/">Bully: Scholarship Edition</a> which famously broke on Windows 10, for very similar reasons. Just like in this case,
Bully should have never worked properly to begin with, but instead, it got away with making incorrect assumptions for years, before changes in Windows 10 finally
made it run out of luck.</p>

<p>Yet again, we are reminded to:</p>
<ul>
  <li><strong>Validate your input data</strong> ‚Äì San Andreas was notoriously bad at this, and ultimately this was the main reason why an incomplete config line remained unnoticed.</li>
  <li><strong>Not ignore the compilation warnings</strong> ‚Äì this code most likely threw a warning in the original code that was either ignored or disabled!</li>
</ul>

<p>In the end, the GTA players are lucky: in many other games, issues like this would‚Äôve remained unfixed and they‚Äôd become a folk legend.
Thankfully, GTAs are moddable and well understood, so we can act upon problems like this and ensure the game stays functional for many more years to come.</p><hr/>


    
  </section>


  

  
  

</article></div>
  </body>
</html>
