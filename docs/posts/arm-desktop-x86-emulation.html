<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://marcin.juszkiewicz.com.pl/2025/07/22/arm-desktop-emulation/">Original</a>
    <h1>Arm Desktop: x86 Emulation</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>This post is part 5 of the &#34;Let me try to use an AArch64 system as a desktop&#34; series:</p>
    <ol id="series_parts">
            <li>
                <a href="https://marcin.juszkiewicz.com.pl/2015/09/21/aarch64-desktop-day-one/">AArch64 desktop: day one</a>
            </li>
            <li>
                <a href="https://marcin.juszkiewicz.com.pl/2015/09/22/aarch64-desktop-day-two/">AArch64 desktop: day two</a>
            </li>
            <li>
                <a href="https://marcin.juszkiewicz.com.pl/2015/09/25/aarch64-desktop-last-day/">AArch64 desktop: last day</a>
            </li>
            <li>
                <a href="https://marcin.juszkiewicz.com.pl/2025/07/07/arm-desktop-2025-attempt-part-one/">Arm desktop: 2025 attempt, part one</a>
            </li>
            <li>
                <a href="https://marcin.juszkiewicz.com.pl/2025/07/22/arm-desktop-emulation/">Arm desktop: emulation</a>
            </li>
    </ol>
		<p>Whenever people use a non-x86 system, sooner or later someone asks: “But can it run
[name of x86-64 only binary]?”. So, let’s check how to make it possible.</p>
<!--MORE-->

<h3>Software stack</h3>
<p>When you look for ‘how to run x86-64 apps on Fedora/Arm’, you usually end up
with <a href="https://docs.fedoraproject.org/en-US/fedora-asahi-remix/x86-support/">Asahi’s documentation about it</a>.</p>
<p>It is a good thing to read to understand the stack. But if your Arm system runs
a 4K page size kernel, then most of that documentation can be skipped. You would
not need <code>muvm</code> nor <code>binfmt-dispatcher</code> packages.</p>
<p>What you need is <strong><span>FEX</span>-emu</strong>, and nothing else, as it recommends all required components.</p>
<p>To make it easier, I recommend removing some of <span>QEMU</span> packages: 
<code>dnf remove qemu-static-*</code> so only <span>FEX</span>-emu will be used for running foreign
architecture binaries.</p>
<h4>Checking emulation</h4>
<p>Installing <span>FEX</span>-emu should also install the Fedora/x86-64 rootfs. So, let check
if emulation is working:</p>
<pre><code>$ uname -m
aarch64

$ FEXBash &#34;uname -m&#34;
erofsfuse 1.8.9
&lt;W&gt; erofs: /usr/share/fex-emu/RootFS/default.erofs mounted on /run/user/1000/.FEXMount2262322-Fjd32T with offset 0
x86_64
</code></pre>
<p>If you have errors at this stage, then check what you have in the
/usr/lib/binfmt.d/ directory. There should be only two files:</p>
<pre><code>$ ls /usr/lib/binfmt.d/ -l
-rw-r--r--. 1 root root 198 07-13 02:00 FEX-x86_64.conf
-rw-r--r--. 1 root root 195 07-13 02:00 FEX-x86.conf
</code></pre>
<h3>Geekbench 6</h3>
<p>So, let me check speed of the emulated <span>CPU</span>. I ran Geekbench 6 on it:</p>
<pre><code>CPU Information
  Name                  Neoverse N1
  Topology              1 Processor, 80 Cores
  Identifier            GenuineIntel Family 6 Model 166 Stepping 1
  Base Frequency        3.00 GHz
  L1 Instruction Cache  32.0 KB x 80
  L1 Data Cache         32.0 KB x 80
  L2 Cache              512 KB x 80
  L3 Cache              8.00 MB
  Instruction Sets      sse2 sse3 pclmul fma3 sse41 aesni avx avx2 shani vaes
</code></pre>
<p><a href="https://browser.geekbench.com/v6/cpu/12969474">Test results</a> were awful:</p>
<ul>
<li>Single core: 459</li>
<li>Multi core: 4110</li>
</ul>
<p>That’s the level of an Intel Atom <span>CPU</span> from 2021. My <span>AMD</span> Ryzen 5 3600 has much
better results.</p>
<h3>Can it be better?</h3>
<p>I asked <span>FEX</span>-Emu developers a few days ago with this kind of question. There are
several Arm <span>CPU</span> features that can be used to make emulation faster:</p>
<table>
<thead>
<tr>
<th>Section</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>Crypto</td>
<td><span>AES</span>, <span>CRC</span>, <span>SHA</span>, <span>PMULL</span></td>
</tr>
<tr>
<td><span>TSO</span> emulation</td>
<td>Apple Silicon <span>TSO</span> bit, <span>LRCPC</span>, <span>LRCPC2</span>, <span>LSE2</span></td>
</tr>
<tr>
<td>Flags stuff</td>
<td><span>AFP</span>, FlagM, FlagM2</td>
</tr>
<tr>
<td>Atomic operations</td>
<td><span>LSE</span></td>
</tr>
<tr>
<td>Misc</td>
<td><span>FCMA</span>, <span>FRINTTS</span>, <span>RPRES</span>, <span>SVE</span>, SVE_bitperm</td>
</tr>
<tr>
<td>Future</td>
<td><span>RCPC3</span>, <span>CSSC</span>, <span>RAND</span></td>
</tr>
</tbody>
</table>
<p>The Ampere Altra is an old, Arm v8.2 <span>CPU</span>. Its Neoverse-N1 cores are from 2019
and can support only a small subset of entries from the table above: all crypto
ones + <span>LSE</span> and <span>LRCPC</span>.</p>
<h3>Tips and tricks</h3>
<p>After publishing post I got some additional hints from <span>FEX</span>-emu folks to make
emulation a bit faster.</p>
<p>One is reducing precision of x86 <span>FPU</span>, second is disabling <span>TSO</span>. So my
configuration file (“~/.fex-emu/Config.json”) looks like this now:</p>
<pre><code>{
  &#34;Config&#34;: {
    &#34;RootFS&#34;: &#34;/usr/share/fex-emu/RootFS/default.erofs&#34;,
    &#34;X87ReducedPrecision&#34;: &#34;1&#34;,
    &#34;TSOEnabled&#34;: &#34;0&#34;
  },
  &#34;ThunksDB&#34;: {
    &#34;GL&#34;: 1,
    &#34;Vulkan&#34;: 1
  }
}
</code></pre>
<p>This gave Factorio a visible speed-up. Cannot compare Geekbench results cause it
crashes randomly after configuration changes.</p>
<h3>Steam</h3>
<p>Now that we have sorted out software, let’s start with games (because what else
would you do with x86(-64) emulation?). Which usually means Steam.</p>
<p>First of all, we need Steam package. I took it from the
<a href="https://ftp.icm.edu.pl/pub/Linux/dist/rpmfusion/nonfree/fedora/releases/42/Everything/x86_64/os/repoview/steam.html"><span>RPM</span> Fusion non-free</a>
page. The next step is installation. This is done without dependencies (those
will be provided by the <span>FEX</span>-emu rootfs), and we need to tell <span>RPM</span> that the
architecture of the package is not that important:</p>
<pre><code>$ sudo rpm -i steam-1.0.0.82-3.fc42.i686.rpm --nodeps --ignorearch
</code></pre>
<p>The next step is the Steam installation, where we run it under emulation:</p>
<pre><code>FEXBash steam
</code></pre>
<p>It can take some time, but at the end you should get the Steam window:</p>
<figure id="__yafg-figure-1">
<img alt="Steam" loading="lazy" src="https://marcin.juszkiewicz.com.pl/files/2025/07/steam-700x.jpeg" title="Steam"/>
<figcaption>Steam</figcaption>
</figure>
<p>So now we are ready to play some games, right?</p>
<h3>Factorio</h3>
<p>As you may know from <a href="https://marcin.juszkiewicz.com.pl/2025/03/04/factorio-is-a-drug/">one of my previous posts</a>,
I am addicted to the the Factorio game. So how it goes on an Ampere Altra-based system?</p>
<figure id="__yafg-figure-2">
<img alt="Factorio" loading="lazy" src="https://marcin.juszkiewicz.com.pl/files/2025/07/factorio-700x.jpeg" title="Factorio"/>
<figcaption>Factorio</figcaption>
</figure>
<p>Let me be honest: without tweaking <span>FEX</span>-Emu config it was unplayable. At least
not with my saved games, in 3440x1440 resolution. What was 60/60 on a Ryzen 5
3600 went to 8-11/59.5 ;(</p>
<p>After tweaking <span>FEX</span>-Emu configuration Factorio started to be more playable. In
areas with many robots it was running at 16-25 <span>FPS</span> and there were moments with
close to 60/60 but it had to be close zoom to deserted area. I may consider
attempt to finish game during 100 hours.</p>
<h3>A funny story</h3>
<p>A few days ago, @chenlin3 <a href="https://github.com/tianocore/edk2/pull/11318">added Ninja build solution for <span>EDK2</span> build system</a>.
I took a look at that change.</p>
<p>At first, I built the <span>ALTRA8UD</span>-<span>1L2T</span> firmware without using Ninja. It took 30
seconds (11 minutes of total <span>CPU</span> time). Then I did a run with Ninja. It took
2 minutes (72 minutes of total <span>CPU</span> time).</p>
<p>Hmm… It should be much faster. I retried and looked at the htop window. And I
saw a lot of “FEXInterpreter” lines… So it was running in emulation.</p>
<p>I then replaced the x86-64 binary of Ninja with a symlink to the aarch64 one, and
then it was a visible improvement.</p>
<p>I commented on the pull request with a <span>NAK</span>.</p>
<h3>Is it worth using?</h3>
<p>So, the final question is: “Is it worth using x86(-64) emulation at all?”…</p>
<p>I do not plan to use it much. I may try to play some older games like Torchlight
<span>II</span>, which I managed to run once and then it stopped working.</p>
	</div></div>
  </body>
</html>
