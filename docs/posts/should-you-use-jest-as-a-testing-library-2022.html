<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://backend.cafe/should-you-use-jest-as-a-testing-library">Original</a>
    <h1>Should you use jest as a testing library? (2022)</h1>
    
    <div id="readability-page-1" class="page"><div><section><div><div id="post-content-parent"><div id="post-content-wrapper"><p><a target="_blank" href="https://jestjs.io/"><code>jest</code></a>, the popular testing framework created by Facebook with over 50 million downloads per month, causes <a target="_blank" href="https://github.com/facebook/jest/issues/2549">many problems</a> for backend developers.</p>
<p>In this article, I try to recap the <code>jest</code>&#39;s cross and delight and how to deal with it and what is causing it.</p>
<h2 id="heading-how-does-jest-work">How does jest work?</h2>
<p><code>jest</code> is a JavaScript Testing Framework with many features, including <code>isolated</code> written on its website.
The isolation feature&#39;s target performance:</p>
<blockquote>
<p>Tests are parallelized by running them in their own processes to maximize performance.</p>
</blockquote>
<p>The <code>jest</code>&#39;s isolation comes from <a target="_blank" href="https://jestjs.io/docs/architecture">its architecture</a> that uses the <a target="_blank" href="https://nodejs.org/api/vm.html"><code>node:vm</code></a> core module under the hood.</p>
<p>The <code>vm</code> module lets <code>jest</code> run every test file into a sandbox with its own temporary context.
The context includes all the <code>global</code> classes such <code>Array</code>, <code>Error</code>, <code>Date</code> and many others - the <code>describe</code> and the <code>it</code> test function for example.
(<a target="_blank" href="https://github.com/facebook/jest/blob/e865fbd66e3dc4adf9d35a35ce91de1bee48bc93/packages/jest-environment-jsdom/src/index.ts"><em>Here the jest source code that does the trick</em></a>)</p>
<p>Since <code>jest</code> overwrites some of those components to provide you fancy features like mocks, fake clocks and a fast test execution,
it must set all the <code>vm</code>&#39;s <code>global</code> data to set up the context where the test&#39;s source code will be executed.</p>
<p>Unfortunately, when the Node.js core modules create a new instance of a <code>global</code> class,
<strong>they will not use</strong> the <code>vm</code>&#39;s context, but they fall back to the <strong>native implementation</strong>.</p>
<p>This means that the <code>instanceof</code> operator <a target="_blank" href="https://github.com/facebook/jest/issues/2549">will not work</a>
as expected, and it will generate false negatives!</p>
<pre><code><span>const</span> { parseArgs } = <span>require</span>(<span>&#39;util&#39;</span>)

test(<span>&#39;Array is not an Array&#39;</span>, <span>async</span> () =&gt; {
  <span>const</span> { values } = parseArgs({
    <span>args</span>: [<span>&#39;--bar&#39;</span>, <span>&#39;a&#39;</span>, <span>&#39;--bar&#39;</span>, <span>&#39;b&#39;</span>],
    <span>options</span>: {
      <span>bar</span>: {
        <span>type</span>: <span>&#39;string&#39;</span>,
        <span>multiple</span>: <span>true</span>
      }
    }
  })
  expect(values.bar).toEqual([<span>&#39;a&#39;</span>, <span>&#39;b&#39;</span>])
  expect(values.bar).toBeInstanceOf(<span>Array</span>) 
})
</code></pre>
<p>By running the above test with the command <code>jest test.js</code> <em>(with the default <code>jest</code> configuration)</em>
it will fail with the stange error:</p>
<pre><code>  ‚óè Array is not an Array

    expect(received).toBeInstanceOf(expected)

    Expected constructor: Array
    Received constructor: Array

      27 |   })
      28 |   expect(values.bar).toEqual([<span>&#39;a&#39;</span>, <span>&#39;b&#39;</span>])
    &gt; 29 |   expect(values.bar).toBeInstanceOf(Array)
</code></pre>
<p>This may seem a minor problem, you need just to avoid using the <code>instanceof</code> operator, but it is not.
The bigger problem is that the <code>instanceof</code> operator <strong>could be used</strong> by your dependencies tree to perform
some checks, and those conditions will fail.</p>
<p>For example, Fastify <a target="_blank" href="https://github.com/fastify/fastify/pull/3200">removed the <code>instanceof</code> operator</a>
from its codebase because it was causing problems for those developers that rely on <code>jest</code> as a testing framework.</p>
<h2 id="heading-how-to-fix-it">How to fix it?</h2>
<p>It depends üòÑ</p>
<p>You <a target="_blank" href="https://github.com/facebook/jest/issues/2549#issuecomment-521177864">can&#39;t</a> out of the box.
There is an open issue on <a target="_blank" href="https://github.com/nodejs/node/issues/31852">the Node.js repository</a>
to let the <code>node:vm</code> module to use the <code>vm</code>&#39;s context, but it is still open.
It seems that the Node.js core team is interested in fixing this problem by implementing the new <a target="_blank" href="https://github.com/tc39/proposal-shadowrealm">ShadowRealm</a> spec, and I think we will make some progress during 2023.</p>
<p>If you can&#39;t wait, there is a very quick solution by using the <a target="_blank" href="https://www.npmjs.com/package/jest-environment-node-single-context"><code>jest-environment-node-single-context</code></a> custom test enviroment.</p>
<pre><code>jest --testEnvironment jest-environment-node-single-context test.js
</code></pre>
<p>Now, all will work as expected:</p>
<pre><code> PASS  ./test.js
  ‚úì Array is not an Array (5 ms)
</code></pre>
<p>‚ö†Ô∏è Note that now the test is working because the <code>jest</code> isolation feature is totally disabled by running all the tests
in the same context.</p>
<p>Another working solution is to use a new <code>jest</code> runner: <a target="_blank" href="https://www.npmjs.com/package/jest-light-runner"><code>jest-light-runner</code></a>.
It spin up a Node.js worker thread for each test file giving you the same isolation feature of <code>jest</code> but without the <code>vm</code>&#39;s context.
Note that not all the <code>jest</code> features are supported by this runner, but all the most used features are working!</p>
<pre><code>jest --runner jest-light-runner test.js
</code></pre>
<h2 id="heading-summary">Summary</h2>
<p><code>jest</code> is a great testing framework, and it works well for frontend applications,
but you could face some issues if your dependencies rely on <code>instanceof</code>.</p>
<p>We discussed about how to fix this problem in different ways:</p>
<ul>
<li>Adopt the <code>jest-environment-node-single-context</code> custom test environment and its limitations</li>
<li>Use the <code>jest-light-runner</code> runner to get the same isolation feature of <code>jest</code> but with a subset of its features</li>
<li>Open an issue to the repository of the module that you are using and ask to remove the <code>instanceof</code> operator, <em>that is still a good practice</em></li>
<li>Choose another test framework. <em>I personally prefer <a target="_blank" href="https://www.npmjs.com/package/tap"><code>node-tap</code></a></em></li>
</ul>
<p>The <code>jest</code> architecture makes sense for frontend applications that run in the browser and has a different <code>global</code> context, but it does not suit the case for Node.js applications.</p>
<p>Now jump into this <a target="_blank" href="https://github.com/Eomm/fastify-discord-bot-demo/tree/HEAD/bonus/jest-instanceof">article source code</a>
to try the code snippets I wrote to verify my findings.</p>
<p>If you enjoyed this article, comment, share and follow me on <a target="_blank" href="https://twitter.com/ManuEomm">Twitter</a>!</p>
</div></div></div></section></div></div>
  </body>
</html>
