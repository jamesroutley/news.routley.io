<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://magnus.therning.org/2023-09-30-using-emacs-as-$editor.html">Original</a>
    <h1>Using Emacs as $Editor</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
<p>30 Sep 2023</p>
<p>
Continuing on from my experiment with <a href="https://magnus.therning.org/2023-09-10-using-emacs-for-the-scrollback-in-terminal-multiplexers.html">using Emacs as for scrollback in my
terminal multiplexer</a> I thought I&#39;d try to use it as my <code>$EDITOR</code> as well.
</p>

<p>
The two main cases where I use <code>$EDITOR</code> is
</p>

<ol>
<li>The occasional use of <code>git</code> on the command line, rebasing or writing a commit
message, and</li>
<li>Use of ZSH&#39;s <code>edit-command-line</code> functionality.</li>
</ol>

<p>
To make sure Emacs is starting up quickly enough I&#39;m using the same small setup
I created for the scrollback editing, so I&#39;m now setting <code>EDITOR</code> like this
</p>

<div>
<pre><span>export</span> <span>EDITOR</span>=<span>&#34;emacs -nw --init-directory ~/.se.d&#34;</span>
</pre>
</div>

<p>
Now that I want to use the same setup for editing I can&#39;t really jump into
<code>view-mode</code> every time Emacs starts so I have to be a bit more clever. The
following bit won&#39;t do
</p>

<div>
<pre><span>(</span>add-hook &#39;find-file-hook #&#39;view-mode<span>)</span>
</pre>
</div>

<p>
I need to somehow find out what starts Emacs and then only modify the hook when
needed. Unfortunately I haven&#39;t found anything that reveals that Emacs is
started by <a href="https://zellij.dev/">zellij</a>. Creating a separate little script that <span>zellij</span> uses would be
an option, of course, but for now I&#39;ve opted to make it the default and instead
refrain from adding the hook in the other two use cases.
</p>

<p>
ZSH doesn&#39;t make it easy to find out that it&#39;s <code>edit-command-line</code> either, but
as I&#39;ve observed that the command line sometimes doesn&#39;t look right after
leaving the editor I wanted to call <code>redisplay</code> to fix it up. That means I need
to have a function anyway, so using an environment variable becomes an easy way
to check if Emacs is being used to edit the command line.
</p>

<div>
<pre><span>function</span> <span>se-edit-command-line</span><span>()</span> <span>{</span>
    <span>export</span> <span>SE_SKIP_VIEW</span>=y
    zle edit-command-line
    <span>unset</span> SE_SKIP_VIEW
    zle redisplay
<span>}</span>
zle -N se-edit-command-line

<span>bindkey</span> -M vicmd <span>&#39;^V&#39;</span> se-edit-command-line
<span>bindkey</span> -M viins <span>&#39;^V&#39;</span> se-edit-command-line
</pre>
</div>

<p>
Unfortunately is seems <code>zle edit-command-line</code> doesn&#39;t pass on non-exported
environment variables, hence the explicit <code>export</code> and <code>unset</code>.
</p>

<p>
When <span>git</span> starts an editor it sets a few environment variables so it was easy
to just pick one that is set in both cases I care about. I picked
<code>GIT_EXEC_PATH</code>.
</p>

<p>
With these things in place I changed the slim setup to only add the hook when
neither of the environment variables are present
</p>

<div>
<pre><span>(</span><span>unless</span> <span>(</span><span>or</span> <span>(</span>getenv <span>&#34;SE_SKIP_VIEW&#34;</span><span>)</span>
            <span>(</span>getenv <span>&#34;GIT_EXEC_PATH&#34;</span><span>)</span><span>)</span>
  <span>(</span>add-hook &#39;find-file-hook #&#39;view-mode<span>)</span><span>)</span>
</pre>
</div>

<p>
Hopefully this works out well enough that I won&#39;t feel a need to go back to
using <a href="https://neovim.io/">Neovim</a> as my <code>$EDITOR</code>.
</p>

</div></div>
  </body>
</html>
