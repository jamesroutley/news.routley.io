<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://marvinh.dev/blog/speeding-up-javascript-ecosystem-part-6/">Original</a>
    <h1>Speeding up the JavaScript ecosystem â€“ Polyfills gone rogue</h1>
    
    <div id="readability-page-1" class="page"><p>ðŸ“– tl;dr: Many popular npm packages depend on 6-8x more packages than they need to. Most of these are unnecessary polyfills and it&#39;s one of the key reasons node_modules folders are so large. The eslint ecosystem seems to be most affected by this.</p><div>
						<p>In the previous posts we looked at runtime performance and I thought it would be fun to look at node modules install time instead. A lot has been already written about various algorithmic optimizations or using more performant syscalls, but why do we even have this problem in the first place? Why is every <code>node_modules</code> folders so big? Where are all these dependencies coming from?</p>
						<p>It all started when a buddy of mine noticed something odd with the dependency tree of his project. Whenever he updated a dependency, it would pull in several new ones and with each subsequent update the total number of dependencies grew over time.</p>
						<pre><code> â”œâ”€â”¬ arraybuffer.prototype.slice <span>1.0</span>.2</code></pre>
						<p>Now to be fair, there are valid reasons why a package might depend on an additional dependencies. Here, we began to notice a pattern though: The new dependencies were all polyfills for JavaScript functions that have long been supported everywhere. The <code>Object.defineProperties</code> method for example was shipped as part of the very first public Node <code>0.10.0</code> release dating back to 2013. Heck, even Internet Explorer 9 supported that. And yet there were numerous packages in that dependend on a polyfill for it.</p>
						<p>
							Among the various packages that pulled in <code>define-properties</code> was <a href="https://github.com/jsx-eslint/eslint-plugin-react/"><code>eslint-plugin-react</code></a>. It caught my eye, because it&#39;s very popular in the React ecosystem. Why does it pull in a polyfill for <code>Object.defineProperties</code>? There is no JavaScript engine that doesn&#39;t come with it already built in.
						</p>
						<h2>Polyfills that donâ€™t polyfill</h2>
						<p>Reading the source of the packages revealed something even more bizarre: The polyfill functions were imported and called directly, rather than patching missing functionality in the runtime environment. The whole point of a polyfill is to be transparent to the userâ€™s code. It should check if the function or method to patch is available and only add it if itâ€™s missing. When there is no need for the polyfill it should do nothing. The odd thing to me is that the functions were used directly like a function from a library.</p>
						<pre><code></code></pre>
						<p>Instead they should call <code>Object.defineProperties</code> directly. The whole point of polyfills is to patch <em>the environment</em> not be called directly. Compare this to what a polyfill for <code>Object.defineProperties</code> is supposed to look like:</p>
						<pre><code></code></pre>
						<p>The most common place where <code>define-properties</code> was used was ironically inside other polyfills, which loaded even more polyfills. And before you ask, the <code>define-properties</code> package relies on even more dependencies than just itself.</p>
						<pre><code><span>var</span> keys <span>=</span> <span>require</span><span>(</span><span>&#34;object-keys&#34;</span><span>)</span><span>;</span></code></pre>
						<p>Inside <code>eslint-plugin-react</code>, that polyfill is loaded via a polyfill for <code>Object.entries()</code> to process <a href="https://github.com/jsx-eslint/eslint-plugin-react/blob/ecadb92609998520be80d64c0bd6bc5e05934aa9/configs/all.js#L4">their configuration</a>:</p>
						<pre><code><span>const</span> fromEntries <span>=</span> <span>require</span><span>(</span><span>&#34;object.fromentries&#34;</span><span>)</span><span>;</span> </code></pre>
						<h2>Doing a little bit of housekeeping</h2>
						<p>At the time of this writing installing <code>eslint-plugin-react</code> pulls in a whopping number of 97 dependencies in total. I was curious about how much of these were polyfills and began patching them out one by one locally. After all was done, this brought down the total number of dependencies down to 15. Out of the original 97 dependencies 82 of them are not needed.</p>
						<p>Coincidentally, <code>eslint-plugin-import</code> which is equally popular in various eslint presets, shows a similar problems. Installing that fills up your <code>node_modules</code> folder with 87 packages. After another local cleanup pass I was able to cut down that number to just 17.</p>
						<h2>Filling up everyone&#39;s disk space</h2>
						<p>Now you might be wondering if youâ€™re affected or not. I did a quick search and basically every widely popular eslint plugin or preset that you can think of is affected. For some reason this whole ordeal reminds me of the <code>is-even</code>/<code>is-odd</code> incident the industry had a while back.</p>
						<p>Having so many dependencies makes it much harder to audit the dependencies of a project. It&#39;s a waste of space too. Case in point: Deleting all eslint plugins and presets in a project alone got rid of <code>220</code> packages.</p>
						<pre><code><span>pnpm</span> <span>-r</span> <span>rm</span> eslint-plugin-react eslint-plugin-import eslint-import-resolver-typescript eslint-config-next eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-prettier prettier eslint-config-prettier eslint-plugin-react-hooks</code></pre>
						<p>Maybe we don&#39;t need that many dependencies in the first place. My mind went to this fantastic quote by the creator of the Erlang programming language:</p>
						<blockquote>
							<p>You wanted a banana but what you got was a gorilla holding the banana and the entire jungle - Joe Armstrong</p>
						</blockquote>
						<p>All I wanted was some linting rules. I didnâ€™t want a bunch of polyfills that I don&#39;t need.</p>
					</div></div>
  </body>
</html>
