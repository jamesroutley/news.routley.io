<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://boredcaveman.xyz/post/0x1_dbless-torrent-website.html">Original</a>
    <h1>Database-less torrent website</h1>
    
    <div id="readability-page-1" class="page"><div><h2 id="databaselesstorrentwebsite">Database-less torrent website</h2>
<p>10/1/2022</p>
<h4 id="tldr">TL;DR</h4>
<p>Since IPFS, a p2p network for storing and retrieving files, has a javascript implementation that runs on browsers, it can be used in torrent websites to retrieve a small database from peers instead of the server. A .sqlite file, 13 MB in size containing around 135,000 records, can be retrieved in 8 seconds from the IPFS network using a 100 Mbit connection. Since the database object is small enough to be cached by the browser, subsequent visits take zero. <a href="https://boredcaveman.xyz/demo/megacat">Live demo here!</a></p>
<h3 id="websitesgodowntorrentsgetlost">Websites go down, torrents get lost</h3>
<p>Local file sharing websites are struggling with law enforcement and their only defence is to frequently delocate the website by changing DNS name and using new IP as reverse proxy. Many of them have been closed by their owners because of threats of legal actions. One little downside of this is that the owners hardly ever dump a backup database to the wild, so those torrents are virtually lost, because they can&#39;t be reached anymore by the public.</p>
<h3 id="databaseasatorrentservedfrompeers">Database as a torrent, served from peers</h3>
<p>Years ago I found out about <a href="https://ipfs.io/">IPFS</a>, a p2p network and protocol that aims to decentralize the Internet. It shares the same principles about peers and DHT network of BitTorrent to retrieve files based on hash, even though it&#39;s not intended to be a replacement. From the user perspective is much more easier to share and retrieve a file in this network. The only calls you need to use are <code>add()</code> and <code>cat()</code>. Know what? It runs on browser too!</p>
<p>Well, what could they do if someone hosts a torrent website without hosting any data or metadata about torrents? <strong>What if the torrent database is retrieved from a peer-to-peer network by the browser</strong>? In this case, who is violating what?</p>
<p>The only infos you need to store about a torrent are title, size and the magnet URI of course. Considering an average torrent title to be 50 bytes long, the size 14[^1] bytes and the magnet URI 40 bytes (without trackers informations), the size of a single record is about ~100 bytes. What about 100,000 records? Only 10 MB of storage for such amount of torrents. Even though it&#39;s relatively small compared to world wide torrent websites, like ThePirateBay hosting a 7 GB database with ~20 million records, it&#39;s enough for a local website and for communities around a general topic, small enough to be downloaded almost instantly from the IPFS network.</p>
<p>[^1]: size expressed in bytes, stored as a string</p>
<h3 id="letsseeitinaction">Let&#39;s see it in action!</h3>
<p><a href="https://boredcaveman.xyz/demo/megacat">Live demo here!</a></p>
<p>As I wanted to test the whole thing to see if it could actually work, I started looking for a dump and I found the database from <a href="https://archive.org/download/dump_release_tntvillage_2019-08-30">TNT Village</a>. What an irony: TNT Village, <a href="https://torrentfreak.com/court-orders-ethical-torrent-giant-tntvillage-to-stop-piracy-activity-191105/">closed in 2019</a>, was The italian file sharing website moderated by ScambioEtico, a project/political movement from the Italian Pirate Party. As they closed, The owner decided to dump the database in the current state before shutting down the whole thing. Unfortunately, no one used it to start a new website again and the community moved to other closed websites (private trackers). The torrents inside it are largely dead.</p>
<h4 id="shrinkingthedatabaseaddingitonipfs">Shrinking the database, adding it on IPFS</h4>
<p>To shrink the size of the dump, originally 26 MB containing 135,000 records, I dropped irrelevant columns like author and post referring to the (now closed) froum, and mildly-relevant columns like the author of the torrent and description. The result is a database of 13 MB, half size of the original. I then added an pinned it to my local IPFS node.</p>
<pre><code>$ sqlite3
sqlite&gt; .mode csv
sqlite&gt; .open dump.csv torrent
sqlite&gt; alter table drop *columns to save space*;
sqlite&gt; vacuum;
sqlite&gt; .save dump.sqlite
$ ipfs add dump.sqlite
$ ipfs pin add &#39;Qm...some1337cid...ftW&#39;
$ ipfs daemon
</code></pre>
<h4 id="ipfsonbrowser">IPFS on browser</h4>
<p><a href="https://js.ipfs.io/">Documentation</a></p>
<pre><code>&lt;script src=&#34;https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34;&gt;

async function loadAndCat(cid) {
    const node = await Ipfs.create()
    const stream = await node.cat(cid)

    let data = &#39;&#39;
    for await (const chunk of stream) {
        data += chunk.toString()
    }

    console.log(data)
}
loadIPFSAndCat(&#39;QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG/readme&#39;)

&lt;/script&gt;
</code></pre>
<h4 id="sqliteonbrowser">SQLite on browser</h4>
<p><a href="https://sql.js.org/">Documentation</a></p>
<pre><code>&lt;script src=&#34;https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34;&gt;

async function loadDBAndExec(query) {
    const SQLPromise = initSqlJs({
        locateFile: file =&gt; &#39;https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.wasm&#39;
    })

    const DBPromise = fetch(&#39;/path/to/database.sqlite&#39;) // This will be done on IPFS
        .then(result =&gt; result.arrayBuffer())

    const [SQL, buffer] = await Promise.all([SQLPromise, DBPromise])
    const db = new SQL.Database(new Uint8Array(buffer))
    db.exec(query)
}
loadDBAndExec(&#39;SELECT * FROM my_table LIMIT 10;&#39;)

&lt;/script&gt;
</code></pre>
<h4 id="merge">Merge</h4>
<pre><code>let dbPromise = new Promise((resolve, reject) =&gt; {
    try {
        Promise.all([getDbFromIPFS(), loadDbModule()])
            .then(([buffer, SQL]) =&gt; resolve(new SQL.Database(buffer)))
    } catch(e) {
        reject(e)
    }
})

async function getDbFromIPFS() {
    const node = await Ipfs.create()
    const stream = await node.cat(&#39;Qm...some1337cid...ftW&#39;)

    let i = 0
    const data = new Uint8Array(12873728) // DB size in bytes
    for await (const chunk of stream) {
        data.set(chunk, i)
        i += chunk.length
    }

    return data
}

function loadDbModule() {
    return initSqlJs({
        locateFile: file =&gt; &#39;https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.wasm&#39;
    })
}
</code></pre>
<pre><code>function search(searchString) {
    return dbPromise
        .then(database =&gt; database.exec(
            &#39;SELECT * FROM torrent WHERE title LIKE \&#39;&#39; + searchString.trim() + &#39;%\&#39; LIMIT 10;&#39;
        ))
}
search(&#39;something&#39;).then(result =&gt; console.log(result))
</code></pre>
<h3 id="results">Results</h3>
<ul>
<li>dbsize: 13 MB</li>
<li>records: 135,000 defined as (title, size, category, magnet URI)<ul>
<li>magnet URI w/o trackers informations to save space</li></ul></li>
<li>loading time (first time): 8 seconds on cold start (download time from IPFS)</li>
<li>loading time (on reload): 0 seconds (browser caching)</li>
</ul>
<h3 id="finalthoughts">Final thoughts</h3>
<h4 id="prosorderedbyrelevance">Pros ordered by relevance</h4>
<ul>
<li>it resists censorship<ul>
<li>taking down one website is useless, you should take down the file from IPFS</li></ul></li>
<li>in 8 seconds you have full access to every torrent ever uploaded</li>
<li>after first visit, the loading time is 0 till the database is updated (a new CID to download)</li>
</ul>
<h4 id="consorderedbyrelevance">Cons ordered by relevance</h4>
<ul>
<li>not fully decentralized<ul>
<li>connection to IPFS peers depends on few WebRTC servers that act as gateways. Maybe <a href="https://webtorrent.io/desktop/">WebTorrent</a> has more RTC servers</li></ul></li>
<li>text search is limited to <em>starts with</em> or <em>contains</em><ul>
<li>Unfortunately sql.js doesn&#39;t have the text search module. There are maybe other implementations having it</li></ul></li>
<li>small database<ul>
<li>since I consider 8 seconds the max time a user should wait for actually using a website of this kind, that means it can&#39;t host database heavier than 13 MB, so 130,000 records is the upper limit</li></ul></li>
<li>non-tech users can be scared of the loading percentage (perceived as an ad or cryptominer)</li>
</ul>
<p>Peace!</p>    </div></div>
  </body>
</html>
