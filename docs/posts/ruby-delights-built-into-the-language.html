<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://technology.doximity.com/articles/ruby-delights-built-into-the-language">Original</a>
    <h1>Ruby delights built into the language</h1>
    
    <div id="readability-page-1" class="page"><div><div><div><div><p><em>BTW, we&#39;re ⚡ hiring Infra, SRE, Web, Mobile, and Data engineers at <a href="https://work.doximity.com/positions">Doximity (see roles)</a> -- find out more about our <a href="https://technology.doximity.com/technology-stack">technical stack</a>.</em></p>

<hr/>



<p>The hidden gems that make Ruby a delight are not always... gems.  There are so many Ruby features <em>built in</em> to the language itself.  In <a href="https://technology.doximity.com/articles/the-hidden-gems-of-ruby-s-irb">the very first episode of this series</a>, we dove deep into the internals of one such gem bundled with Ruby&#39;s standard library: IRB.  Keeping on theme, I&#39;d like to take some time to explore some other areas of Ruby&#39;s source.</p>

<p>So get ready to open up that IRB console you read all about, and we&#39;ll explore some incredible Ruby examples provided to you by Ruby itself.</p>



<ol>
<li> <a href="#benchmark">benchmark.rb – Measure performance of Ruby code</a></li>
<li> <a href="#a-biorhythm-calculator">biorhythm.rb   – A biorhythm calculator</a></li>
<li> <a href="#display-a-simple-calendar">cal.rb – A simple calendar display</a></li>
<li> <a href="#suppress-echo-of-terminal-input-using-ioctl">cbreak.rb – Supress echo of terminal input using ioctl</a></li>
<li> <a href="#extending-pstore-for-the-cgi-session">cgi-session-pstore.rb – A file-based persistence mechanism for tracking the CGI Session as a Hash</a></li>
<li> <a href="#a-simple-tcp-server-and-client">clnt.rb, svr.rb and tsvr.rb –    Start a TCP socket server and connect a client</a></li>
<li> <a href="#test-code-coverage">coverage.rb – Simple test code coverage</a></li>
<li> <a href="#delegating-methods-with-ease">delegate.rb – Delegating methods with ease</a></li>
<li> <a href="#directory-access">dir.rb – Directory access</a></li>
<li> <a href="#drb-distributed-object-system-for-ruby">DRb – Distributed object system for Ruby (think RPC for OO)</a></li>
<li> <a href="#dualstack-tcp-server-and-client">dualstack-fetch.rb and dualstack-httpd.rb – A simultaneous multi-threaded IPv4/IPv6 TCP server and client</a></li>
<li> <a href="#evaluating-ruby">eval.rb   – A simple evaluator</a></li>
<li> <a href="#method-access">export.rb – method access example</a></li>
<li> <a href="#explore-the-ruby-grammar">exyacc.rb – Extract BNF from the yacc file</a></li>
<li> <a href="#factorial-calculator">fact.rb   – A factorial calculator</a></li>
<li> <a href="#fibonacci">fib.rb – Fibonacci number calculations</a></li>
<li> <a href="#unix-mail-from">from.rb   – Scan mail spool</a></li>
<li> <a href="#gather-full-paths">fullpath.rb   – Convert ls -lR to fullpath format</a></li>
<li> <a href="#saving-and-loading-ruby-instruction-sequences">iseq_loader.rb – A sample of compiler/loader for binary compiled file</a></li>
<li> <a href="#a-front-end-for-the-less-command">less.rb   – A front-end for the <code>less</code> command</a></li>
</ol>

<hr/>

<h2 id="benchmark">Benchmark</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/benchmark.rb">source: benchmark.rb</a></p>

<p>Benchmarking can be an incredibly valuable tool, but is quite the rabbit hole of theory vs. pragmatism.  The &#34;what&#34;, and &#34;how&#34;, of benchmarking is fraught with sharp opinions and inconsistent recommendations.  For now, we&#39;ll throw all that out the window and focus on Ruby&#39;s lovely example using the <a href="https://rubyapi.org/3.1/o/benchmark">Benchmark module</a> to calculate the fastest way to assign a single character string to a local variable inside various iterators.</p>
<div><pre><code>$&gt; ruby sample/benchmark.rb
[50000 times iterations of `a = &#34;1&#34;&#39;]
              user     system      total        real
for:      0.023797   0.000935   0.024732 (  0.025606)
times:    0.017888   0.000440   0.018328 (  0.018801)
upto:     0.016897   0.000565   0.017462 (  0.017925)
   0.014552   0.000614   0.015166 (  0.015863)
   0.016184   0.000804   0.016988 (  0.017833)
   0.015323   0.000534   0.015857 (  0.016280)
</code></pre></div>
<p>I think this is a nice little introduction to the power of the tool.  With a little tweaking we could try to isolate side-affects of the environment and VM (like garbage collection) and show some simple statistics on averages and total timing.  I&#39;ll leave that to you :-)</p>

<h3 id="irb-s-friendly-benchmarking-extension-measure">IRB&#39;s friendly benchmarking extension: measure</h3>

<p>As of Ruby 3.0, you can now get instant feedback on how long things take to process right  in IRB!</p>
<div><pre><code><span>irb</span><span>(</span><span>main</span><span>):</span><span>001</span><span>:</span><span>0</span><span>&gt;</span> <span>measure</span>
<span>TIME</span> <span>is</span> <span>added</span><span>.</span>
<span>=</span><span>&gt;</span> <span>nil</span>

<span>irb</span><span>(</span><span>main</span><span>):</span><span>002</span><span>:</span><span>0</span><span>&gt;</span> <span>sleep</span> <span>1</span>
<span>processing</span> <span>time: </span><span>1.004886</span><span>s</span>
<span>=&gt;</span> <span>1</span>

<span>irb</span><span>(</span><span>main</span><span>):</span><span>003</span><span>:</span><span>0</span><span>&gt;</span> <span>puts</span> <span>&#34;Measure me.&#34;</span>
<span>Measure</span> <span>me</span><span>.</span>
<span>processing</span> <span>time: </span><span>0.000043</span><span>s</span>
<span>=&gt;</span> <span>nil</span>

<span>irb</span><span>(</span><span>main</span><span>):</span><span>004</span><span>:</span><span>0</span><span>&gt;</span> <span>measure</span> <span>:off</span>
<span>=&gt;</span> <span>nil</span>
</code></pre></div>
<p>Check out my <a href="https://technology.doximity.com/articles/the-hidden-gems-of-ruby-s-irb">deep-dive on IRB</a> for more juicy features!</p>

<h3 id="learn-more-about-benchmarking-ruby-code">Learn More About Benchmarking Ruby Code</h3>

<p>Benchmarking is a popular (and broad) topic.  This sample is a tiny piece in the very large benchmarking pie.  If you want to dig in more, here are some great entry points:</p>

<ul>
<li>Much of <code>Benchmark</code> has moved to the <a href="https://github.com/ruby/benchmark">benchmark gem</a></li>
<li><a href="https://twitter.com/MattStudies">Matthew Gaudet</a>&#39;s 2016 RubyKaigi talk is a great introduction on the science of benchmarking: <a href="https://www.youtube.com/watch?v=kJDOpucaUR4">Ruby3x3: How are we going to measure 3x?</a></li>
<li>There are many <a href="https://rubybench.org/benchmarks">long-running Ruby benchmarks tracked by RubyBench</a>.</li>
<li><a href="https://eregon.me/blog/2022/01/06/benchmarking-cruby-mjit-yjit-jruby-truffleruby.html">Benchmarking various Ruby implementations</a></li>
<li><a href="https://www.mayerdan.com/ruby/2018/03/25/ruby-benchmarking">Learning by Benchmarking A Proposed Ruby Change</a> by <a href="https://twitter.com/danmayer">Dan Mayer</a></li>
<li><a href="https://github.com/fastruby/fast-ruby">fast-ruby</a>: micro-benchmarks of Ruby idioms.</li>
<li>The <a href="https://blog.testdouble.com/posts/2021-07-19-benchmarking-your-ruby-with-time_up/">time_up gem</a> is a great tool for benchmarking aggregates and comparing</li>
</ul>

<hr/>

<h2 id="a-biorhythm-calculator">A Biorhythm Calculator</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/biorhythm.rb">source: biorhythm.rb</a></p>

<p>I wasn&#39;t able to find the original post from the Newsgroup referenced in the comment, but this was by far one of my favorite examples.  It prompts you for your birth date, and then crunches some planetary numbers to calculate, AND GRAPH, your emotional (E), physical (P), and mental (M) well being!  This week I&#39;m sharp-as-a-tack, and slow and sad as a sack.  Here&#39;s to next week!</p>
<div><pre><code><span>$&gt;</span> ruby sample/biorhythm.rb
Your birthday <span>(</span>YYYYMMDD<span>)</span>: 19840221

<span>&gt;&gt;&gt;</span> Biorhythm <span>&lt;&lt;&lt;</span>
The birthday 1984.02.21 is a Tue
Age <span>in </span>days: <span>[</span>13770]

                     <span>P</span><span>=</span>physical, <span>E</span><span>=</span>emotional, <span>M</span><span>=</span>mental
             <span>-------------------------</span>+-------------------------
                     Bad Condition    |    Good Condition
             <span>-------------------------</span>+-------------------------
2021.11.03 : .E.......................|........................M
2021.11.04 : P.E......................|.......................M.
2021.11.05 : .P...E...................|.....................M...
2021.11.06 : ...P.....E...............|..................M......
2021.11.07 : .......P......E..........|..............M..........
2021.11.08 : ............P......E.....|..........M..............
2021.11.09 : ..................P......E......M..................
2021.11.10 : .........................P.M...E...................
2021.11.11 : .......................M.|......P...E..............
2021.11.12 : ..................M......|............P..E.........
             <span>-------------------------</span>+-------------------------
</code></pre></div>
<hr/>

<h2 id="display-a-simple-calendar">Display A Simple Calendar</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/cal.rb">source: cal.rb</a></p>

<p>Another fun example here with some practical use.  <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/cal.rb">Cal.rb</a> is a clone of the <a href="https://man7.org/linux/man-pages/man1/cal.1.html">linux cal(1) command</a> re-implemented in Ruby.  It will print out a calendar in your terminal in several flavors (examples below). It makes some very interesting use of <a href="https://github.com/ruby/ruby/blob/5b8d22ebe60267283a5ca4a1c2ddba507b3d8ba9/lib/getoptlong.rb#L87">GetoptLong</a> as well as some functional programming techniques extracted from an old 1988 textbook: <a href="https://www.amazon.com/Introduction-Functional-Programming-International-Computing/dp/0134841891/">Introduction to Functional Programming</a>.</p>

<p>Display the current month:</p>
<div><pre><code><span>$&gt;</span> ruby sample/cal.rb <span>-m</span>
   November 2021
 M Tu  W Th  F  S  S
 1  2  3  4  5  6  7
 8  9 10 11 12 13 14
15 16 17 18 19 20 21
22 23 24 25 26 27 28
29 30
</code></pre></div>
<p>Display the current month vertically:</p>
<div><pre><code><span>$&gt;</span> ruby sample/cal.rb <span>-t</span>
   November 2021
 S     7 14 21 28
 M  1  8 15 22 29
Tu  2  9 16 23 30
 W  3 10 17 24
Th  4 11 18 25
 F  5 12 19 26
 S  6 13 20 27
</code></pre></div>
<p>Display the whole year:</p>
<div><pre><code><span>$&gt;</span> ruby sample/cal.rb <span>-y</span>

      January               February               March
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
                1  2      1  2  3  4  5  6      1  2  3  4  5  6
 3  4  5  6  7  8  9   7  8  9 10 11 12 13   7  8  9 10 11 12 13
10 11 12 13 14 15 16  14 15 16 17 18 19 20  14 15 16 17 18 19 20
17 18 19 20 21 22 23  21 22 23 24 25 26 27  21 22 23 24 25 26 27
24 25 26 27 28 29 30  28                    28 29 30 31
31
       April                  May                   June
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
             1  2  3                     1         1  2  3  4  5
 4  5  6  7  8  9 10   2  3  4  5  6  7  8   6  7  8  9 10 11 12
11 12 13 14 15 16 17   9 10 11 12 13 14 15  13 14 15 16 17 18 19
18 19 20 21 22 23 24  16 17 18 19 20 21 22  20 21 22 23 24 25 26
25 26 27 28 29 30     23 24 25 26 27 28 29  27 28 29 30
                      30 31
        July                 August              September
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
             1  2  3   1  2  3  4  5  6  7            1  2  3  4
 4  5  6  7  8  9 10   8  9 10 11 12 13 14   5  6  7  8  9 10 11
11 12 13 14 15 16 17  15 16 17 18 19 20 21  12 13 14 15 16 17 18
18 19 20 21 22 23 24  22 23 24 25 26 27 28  19 20 21 22 23 24 25
25 26 27 28 29 30 31  29 30 31              26 27 28 29 30

      October               November              December
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
                1  2      1  2  3  4  5  6            1  2  3  4
 3  4  5  6  7  8  9   7  8  9 10 11 12 13   5  6  7  8  9 10 11
10 11 12 13 14 15 16  14 15 16 17 18 19 20  12 13 14 15 16 17 18
17 18 19 20 21 22 23  21 22 23 24 25 26 27  19 20 21 22 23 24 25
24 25 26 27 28 29 30  28 29 30              26 27 28 29 30 31
31
</code></pre></div>
<p>Display the calendar year: 1984</p>
<div><pre><code><span>$&gt;</span> ruby sample/cal.rb <span>-y</span> 1984

      January               February               March
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
 1  2  3  4  5  6  7            1  2  3  4               1  2  3
 8  9 10 11 12 13 14   5  6  7  8  9 10 11   4  5  6  7  8  9 10
15 16 17 18 19 20 21  12 13 14 15 16 17 18  11 12 13 14 15 16 17
22 23 24 25 26 27 28  19 20 21 22 23 24 25  18 19 20 21 22 23 24
29 30 31              26 27 28 29           25 26 27 28 29 30 31

       April                  May                   June
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
 1  2  3  4  5  6  7         1  2  3  4  5                  1  2
 8  9 10 11 12 13 14   6  7  8  9 10 11 12   3  4  5  6  7  8  9
15 16 17 18 19 20 21  13 14 15 16 17 18 19  10 11 12 13 14 15 16
22 23 24 25 26 27 28  20 21 22 23 24 25 26  17 18 19 20 21 22 23
29 30                 27 28 29 30 31        24 25 26 27 28 29 30

        July                 August              September
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
 1  2  3  4  5  6  7            1  2  3  4                     1
 8  9 10 11 12 13 14   5  6  7  8  9 10 11   2  3  4  5  6  7  8
15 16 17 18 19 20 21  12 13 14 15 16 17 18   9 10 11 12 13 14 15
22 23 24 25 26 27 28  19 20 21 22 23 24 25  16 17 18 19 20 21 22
29 30 31              26 27 28 29 30 31     23 24 25 26 27 28 29
                                            30
      October               November              December
 S  M Tu  W Th  F  S   S  M Tu  W Th  F  S   S  M Tu  W Th  F  S
    1  2  3  4  5  6               1  2  3                     1
 7  8  9 10 11 12 13   4  5  6  7  8  9 10   2  3  4  5  6  7  8
14 15 16 17 18 19 20  11 12 13 14 15 16 17   9 10 11 12 13 14 15
21 22 23 24 25 26 27  18 19 20 21 22 23 24  16 17 18 19 20 21 22
28 29 30 31           25 26 27 28 29 30     23 24 25 26 27 28 29
                                            30 31
</code></pre></div>
<h3 id="learn-more-about-dates-with-ruby">Learn More About Dates With Ruby</h3>

<ul>
<li>Be sure to check out the Ruby <a href="https://rubyapi.org/3.1/o/date">Date documentation</a></li>
<li><a href="https://twitter.com/gregnavis">Greg Navis</a> recently shared <a href="https://twitter.com/gregnavis/status/1600882033806364672">a lovely example of how to use Date objects for determining various date facts</a></li>
</ul>

<hr/>

<h2 id="suppress-echo-of-terminal-input-using-ioctl">Suppress Echo of Terminal Input Using ioctl</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/cbreak.rb">source: cbreak.rb</a></p>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/cbreak.rb">cbreak.rb</a> showcases several bit-wise operators and uses a special <a href="https://github.com/ruby/ruby/blob/d92f09a5eea009fa28cd046e9d0eb698e3d94c5c/spec/ruby/core/io/ioctl_spec.rb#L13">IO#ioctl</a> method to buffer an empty string in binary to hide (<em>not</em> echo) the input from <code>STDIN</code>.</p>

<p>While this may be a clever way to way to hide the input stream, as of Ruby 2.0 you can simply use <a href="https://rubyapi.org/3.1/o/io#method-i-noecho">IO#noecho</a> to achieve the same result.</p>

<hr/>

<h2 id="extending-pstore-for-the-cgi-session">Extending PStore For The CGI Session</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/cgi-session-pstore.rb">source: cgi-session-pstore.rb</a></p>

<p>While the days of CGI are behind many of us, the <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/cgi-session-pstore.rb">sample/cgi-session-pstore.rb</a> is a simple example of using the more impressive <a href="https://github.com/ruby/ruby/blob/ruby_3_1/lib/cgi/session/pstore.rb#L23">CGI::Session::PStore</a> which extends <a href="https://rubyapi.org/3.1/o/pstore">PStore</a> to create a file-based persistence mechanism for keeping track of the CGI Session as a Hash.</p>

<p>If you ever find the need for an efficient way to persist data represented as a hash to the file system, check out <code>PStore</code>!</p>

<h3 id="learn-more-about-pstore-in-ruby">Learn More About PStore In Ruby</h3>

<ul>
<li><a href="https://github.com/ruby/pstore">PStore</a> is now it&#39;s own gem!</li>
<li><a href="https://twitter.com/pawelpacana">Paweł Pacana</a> wrote up how they used it to <a href="https://blog.arkency.com/practical-use-of-ruby-pstore/">create a thread-safe persisted cache-store for a faraday plugin</a>!  Neat!</li>
</ul>

<hr/>

<h2 id="a-simple-tcp-server-and-client">A Simple TCP Server and Client</h2>

<p>Source files used in these examples:</p>

<ul>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/svr.rb">source: svr.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/clnt.rb">source: clnt.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/tsvr.rb">source: tsvr.rb</a></li>
</ul>

<p>The <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/svr.rb">svr.rb</a> shows how to start a simple (single-threaded) <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP Socket</a> server that echoes out the input:</p>
<div><pre><code><span>$&gt;</span> ruby sample/svr.rb
Trying localhost ... <span>done
</span>addr: AF_INET6:65390:::1:::1
server is on 65390:::1:::1
<span>#&lt;TCPServer:0x00007ff192818bf8&gt; is accepted</span>
<span>#&lt;TCPSocket:0x00007ff192850eb8&gt; is gone</span>
</code></pre></div>
<p>You can then connect to this TCP socket using Ruby with the <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/clnt.rb">clnt.rb</a>:</p>
<div><pre><code><span>$&gt;</span> ruby sample/clnt.rb
Trying localhost ... <span>done
</span>addr: AF_INET6:65392:::1:::1
peer: AF_INET6:65390:::1:::1
Check
Check
</code></pre></div>
<p>A multi-threaded TCP socket server example (<a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/tsvr.rb">tsvr.rb</a>) is also included!</p>
<div><pre><code><span>$&gt;</span> ruby sample/tsvr.rb
server is on 52276::::::
<span>#&lt;TCPSocket:0x00007f925101a488&gt; is accepted</span>
<span>#&lt;TCPSocket:0x00007f925101a488&gt; is gone</span>
</code></pre></div>
<p>With a little adjusting, you could easily stream your logs to a simple locally running TCP socket rather than taking up that valuable disk space 😁</p>

<h2 id="test-code-coverage">Test Code Coverage</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/coverage.rb">source: coverage.rb</a></p>

<p>The <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/coverage.rb">sample/coverage.rb</a> example shows how to use Ruby&#39;s native <code>Coverage</code> module to analyze and measure what parts of a Ruby program are run.  The file by itself doesn&#39;t measure anything, so I made a simple <code>cov.rb</code> file in the root of the <a href="https://github.com/fastruby/fast-ruby">fast-ruby source</a>:</p>
<div><pre><code><span># cov.rb</span>
<span>require_relative</span> <span>&#39;../ruby/sample/coverage.rb&#39;</span>
<span>load</span> <span>File</span><span>.</span><span>expand_path</span><span>(</span><span>&#39;./code/string/gsub-vs-tr.rb&#39;</span><span>)</span>
</code></pre></div>
<p>This runs code coverage on <a href="https://github.com/fastruby/fast-ruby/blob/ruby_3_1/code/string/gsub-vs-tr.rb">this gsub-vs-tr.rb benchmark file</a> and generated a <code>./code/string/gsub-vs-tr.rb.cov</code> file with the results:</p>
<div><pre><code>       1:    1:require &#39;benchmark/ips&#39;
       -:    2:
       1:    3:SLUG = &#39;writing-fast-ruby&#39;
       -:    4:
       1:    5:def slow
 4454286:    6:  SLUG.gsub(&#39;-&#39;, &#39; &#39;)
       -:    7:end
       -:    8:
       1:    9:def fast
13655760:   10:  SLUG.tr(&#39;-&#39;, &#39; &#39;)
       -:   11:end
       -:   12:
       1:   13:Benchmark.ips do |x|
 4454287:   14:  x.report(&#39;String#gsub&#39;) { slow }
13655761:   15:  x.report(&#39;String#tr&#39;)   { fast }
       1:   16:  x.compare!
       -:   17:end
</code></pre></div>
<h3 id="learn-more-about-code-coverage-in-ruby">Learn More About Code Coverage In Ruby</h3>

<ul>
<li>For a deeper dive on code coverage in Ruby, check out <a href="https://twitter.com/kevin_j_m">Kevin Murphy</a>&#39;s excellent article, <a href="https://kevinjmurphy.com/posts/rubys-got-you-covered/">&#34;Ruby&#39;s Got You Covered&#34;</a>.</li>
<li><a href="https://www.twitter.com/JemmaIssroff">Jemma Issroff</a> has <a href="https://jemma.dev/blog/ruby-code-coverage">an excellent article on the importance of both line and branch code coverage in Ruby</a>
– <a href="http://twitter.com/etagwerker">Ernesto Tagwerker</a> has <a href="https://www.fastruby.io/blog/rails/what-is-code-coverage-ruby-on-rails.html">a fantastic breakdown of code coverage reports for the Rails framework</a>. </li>
</ul>

<hr/>

<h2 id="delegating-methods-with-ease">Delegating Methods With Ease</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/delegate.rb">source: delegate.rb</a></p>

<p>Delegating methods is a great way to keep classes lean.  Ruby comes bundled with the <a href="https://github.com/ruby/delegate">Delegator gem</a> which is highlighted in the <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/delegate.rb">delegate.rb</a>.  Two takeaways here are:</p>

<ol>
<li>You can use <a href="https://rubyapi.org/3.1/o/object#method-i-DelegateClass"><code>DelegateClass</code></a> to proxy all methods to the provided class</li>
</ol>
<div><pre><code><span>require</span> <span>&#34;delegate&#34;</span>
<span>class</span> <span>SuperArray</span> <span>&lt;</span> <span>DelegateClass</span><span>(</span><span>Array</span><span>)</span>
  <span>def</span> <span>initialize</span><span>()</span>
    <span>super</span><span>([])</span>
  <span>end</span>
<span>end</span>

<span>SuperArray</span><span>.</span><span>new</span><span>.</span><span>push</span> <span>25</span> <span># =&gt; [25]</span>
</code></pre></div>
<ol>
<li>Proxy all methods to an instance:</li>
</ol>
<div><pre><code><span>require</span> <span>&#34;delegate&#34;</span>
<span>woo</span> <span>=</span> <span>Object</span><span>.</span><span>new</span>
<span>def</span> <span>woo</span><span>.</span><span>hoo</span>
  <span>puts</span> <span>&#34;woohoo!&#34;</span>
<span>end</span>
<span>SimpleDelegator</span><span>.</span><span>new</span><span>(</span><span>woo</span><span>).</span><span>hoo</span> <span># =&gt; &#34;woohoo!&#34;</span>
</code></pre></div>
<h3 id="learn-more-about-delegation-in-ruby">Learn More About Delegation In Ruby</h3>

<ul>
<li>Delegates are a great way to transition legacy objects into new objects that better represent how your application has grown 😁 They are also a common way to <a href="https://refactoring.guru/replace-inheritance-with-delegation">refactor away from inherited classes</a>.</li>
<li>Avdi has a wonderful article &#34;<a href="https://avdi.codes/sustainable-development-in-ruby-part-3-delegation/">Sustainable Development in Ruby, Part 3: Delegation</a>&#34; where he leaves some wisdom on when to consider using delegation and some caveats.</li>
</ul>

<hr/>

<h2 id="directory-access">Directory Access</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/dir.rb">source: dir.rb</a></p>

<p>This <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/dir.rb">dir.rb</a> provides some insight into the powerful <a href="https://github.com/ruby/ruby/blob/ruby_3_1/dir.rb"><code>Dir</code> class</a>. I modified the example to print out all Ruby files (<code>*.rb</code>) in the root of the Ruby project directory.</p>
<div><pre><code><span># directory access</span>
<span># list all .rb files</span>
<span>dirp</span> <span>=</span> <span>Dir</span><span>.</span><span>open</span><span>(</span><span>&#34;.&#34;</span><span>)</span>
<span>for</span> <span>f</span> <span>in</span> <span>dirp</span>
  <span>case</span> <span>f</span>
  <span>when</span> <span>/\.rb\z/</span>
    <span>print</span> <span>f</span><span>,</span> <span>&#34;</span><span>\n</span><span>&#34;</span>
  <span>else</span>
    <span># do not print</span>
  <span>end</span>
<span>end</span>
<span>dirp</span><span>.</span><span>close</span>
</code></pre></div>
<p>When I ran this, I found some interesting files! Like, what&#39;s the story behind <a href="https://github.com/ruby/ruby/blob/ruby_3_1/golf_prelude.rb"><code>golf_prelude.rb</code></a>?</p>
<div><pre><code><span>$&gt;</span> ruby sample/dirb.rb
array.rb
nilclass.rb
numeric.rb
prelude.rb
ast.rb
golf_prelude.rb
ractor.rb
KNOWNBUGS.rb
warning.rb
gem_prelude.rb
io.rb
timev.rb
trace_point.rb
dir.rb
kernel.rb
gc.rb
pack.rb
</code></pre></div>
<h3 id="learning-more-about-working-with-directories-in-ruby">Learning more about working with directories in Ruby</h3>

<ul>
<li><a href="https://rubyapi.org/3.1/o/dir">Dir</a> is a very powerful feature of Ruby.  I recommend checking out more of what it&#39;s capable of in the documentation, which has plenty of treats to discover.</li>
</ul>

<hr/>

<h2 id="drb-distributed-object-system-for-ruby">DRb: Distributed Object System For Ruby</h2>

<p>Source files used in these examples:</p>

<ul>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb">source: drb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dchats.rb">source: dchats.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dchatc.rb">source: dchatc.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dlogd.rb">source: dlogd.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dlogc.rb">source: dlogc.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/rinda-ring.rb">source: rinda-ring.rb</a></li>
</ul>

<p>If you&#39;re as unfamiliar with what a distributed object system is as I was, then you&#39;ll find some comfort in this <a href="https://www.druby.org/sidruby/2-1-understanding-distributed-object-systems.html">spectacular documentation on the subject</a>.</p>

<p><img src="https://res.cloudinary.com/dhttas9u5/image/upload/d2inprc2_w0zfp4.jpg" alt="Distributed Object Systems"/></p>

<p>TLDR; with <strong>dRuby</strong>, you can create distributed systems as if you were doing normal Ruby programming.  <a href="http://www.slideshare.net/Blaine/scaling-twitter">Twitter originally used dRuby and Rinda</a> before building its own queuing system, called Starling, in Ruby.</p>

<p>Ruby includes <em>many</em> examples of using dRuby in the source, but I&#39;ll showcase the most clear use-case I found:</p>

<ol>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dchats.rb">Distributed chat server</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dchatc.rb">Distributed chat client</a></li>
</ol>

<p>With those in place, we can then start a dRuby chat server:</p>
<div><pre><code><span>$&gt;</span> ruby sample/dchats.rb
druby://::1:53383
</code></pre></div>
<p>Then connect to the dRuby chat server as myself:</p>
<div><pre><code><span>$&gt;</span> ruby sample/dchatc.rb druby://::1:53383 Valentino
Hi
<span>&gt;</span>Valentino&lt; Hi
</code></pre></div>
<p>And connect another client named <strong>Robo</strong>:</p>
<div><pre><code><span>$&gt;</span> ruby sample/dchatc.rb druby://::1:53383 Robo
Hello
<span>&gt;</span>Robo&lt; Hello
</code></pre></div>
<p>And a small snapshot of our mind-bending conversation from Valentino&#39;s client:</p>
<div><pre><code>Hi
&gt;Valentino&lt; Hi
&lt;Robo&gt; Hello
What is up?
&gt;Valentino&lt; What is up?
&lt;Robo&gt; Nuttin Bot
</code></pre></div>
<p>Not the prettiest of chat apps, but the power of dRuby is distribution.  The chat clients don&#39;t have to be on the same OS, or even the same machine!</p>

<h3 id="learn-more-about-distributed-ruby">Learn More About Distributed Ruby</h3>

<p>The Ruby source has <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb">many other dRuby examples to explore</a>. One that I found of interest was <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dlogd.rb">the distributed log server</a> and <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/drb/dlogc.rb">example usage</a>.</p>

<p>For more dRuby in The Real World™, check out <a href="https://rubykaigi.org/2021-takeout/presentations/m_seki.html">Masatoshi Seki&#39;s enlightening Ruby Kaigi talk</a> where they use dRuby in embedded software for small medical devices.</p>

<p>Be sure to investigate the source of <a href="https://github.com/ruby/drb">this embedded drb gem</a>.</p>

<hr/>

<h2 id="dual-stack-tcp-server-and-client">Dual-stack TCP Server and Client</h2>

<p>Source files used in these examples:</p>

<ul>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/dualstack-httpd.rb">source: dualstack-httpd.rb</a></li>
<li><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/dualstack-fetch.rb">source: dualstack-fetch.rb</a></li>
</ul>

<p>First, we start up our multi-protocol daemon using the <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/dualstack-httpd.rb">dualstack-httpd.rb</a>:</p>
<div><pre><code><span>$&gt;</span> ruby sample/dualstack-httpd.rb
socket <span>#&lt;TCPServer:0x00007facd68303d0&gt; started, address 0.0.0.0 port 8888</span>
socket <span>#&lt;TCPServer:0x00007facd6833b98&gt; started, address :: port 8888</span>
socket 0.0.0.0 port 8888 listener started, pid 39003 thread <span>#&lt;Thread:0x00007facd6833300 sample/dualstack-httpd.rb:24 run&gt;</span>
socket :: port 8888 listener started, pid 39003 thread <span>#&lt;Thread:0x00007facd6832d38 sample/dualstack-httpd.rb:24 run&gt;</span>
socket :: port 8888 accepted, thread <span>#&lt;Thread:0x00007facd6831dc0 sample/dualstack-httpd.rb:30 run&gt;</span>
socket :: port 8888 got string
socket :: port 8888 processed, thread <span>#&lt;Thread:0x00007facd6831dc0 sample/dualstack-httpd.rb:30 run&gt; terminating</span>
socket :: port 8888 accepted, thread <span>#&lt;Thread:0x00007facd6853ab0 sample/dualstack-httpd.rb:30 run&gt;</span>
socket :: port 8888 got string
socket :: port 8888 processed, thread <span>#&lt;Thread:0x00007facd6853ab0 sample/dualstack-httpd.rb:30 run&gt; terminating</span>
</code></pre></div>
<p>Now we can use the <a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/dualstack-fetch.rb">dualstack-fetch.rb</a> example to connect to the server either over IPv4:</p>
<div><pre><code><span>$&gt;</span> ruby sample/dualstack-fetch.rb http://localhost:8888/
conntecting to localhost port 8888
conntected to ::1 port 8888
HTTP/1.0 200 OK
Content-type: text/plain

this is <span>test</span>: my name is :: port 8888, you sent:
<span>---start</span>
GET / HTTP/1.0
Host: localhost
<span>---end</span>
</code></pre></div>
<p>Or over IPv6:</p>
<div><pre><code><span>$&gt;</span> ruby sample/dualstack-fetch.rb http://:::8888/
conntecting to :: port 8888
conntected to ::1 port 8888
HTTP/1.0 200 OK
Content-type: text/plain

this is <span>test</span>: my name is :: port 8888, you sent:
<span>---start</span>
GET / HTTP/1.0
Host: ::
<span>---end</span>
</code></pre></div>
<h3 id="learn-more-about-ipv6-in-ruby">Learn more about IPv6 In Ruby</h3>

<p><a href="https://twitter.com/lensboel">Claus Lensbøl</a> has <a href="https://blog.cmol.me/ipv6-ruby-part-1-introduction-to-ipv6-f45c7cf18151">a great series on working with IPv6 in Ruby</a>.  He explores both the value of using it, as well as how to provide backwards compatibility for IPv4.</p>

<hr/>

<h2 id="evaluating-ruby">Evaluating Ruby</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/eval.rb">source: eval.rb</a></p>

<p>While there are quite a number of ways to evaluate Ruby code, the most notoriously easy of these is <a href="https://rubyapi.org/3.1/o/kernel#method-i-eval"><code>Kernel.eval</code></a>.  In just forty lines of code, this Ruby script creates a super simplified REPL reminiscent of IRB, and it even gracefully handles errors!</p>
<div><pre><code><span>$&gt;</span> ruby sample/eval.rb
ruby&gt; puts <span>&#34;Hello Ruby ❤️&#34;</span>
Hello Ruby ❤️
nil
ruby&gt; class BestLanguageEver
ruby| def is?
ruby| puts <span>&#34;Ruby, of course!&#34;</span>
ruby| end
ruby| end
:is?
ruby&gt; BestLanguageEver.new.is?
Ruby, of course!
nil
ruby&gt; hug
ERR: undefined <span>local </span>variable or method <span>`</span>hug<span>&#39; for main:Object
ruby&gt;
</span></code></pre></div>
<p>It does this by endlessly looping and waiting on <code>STDIN</code> for new lines.  Once one is entered, it pipes the content of that line through <a href="https://github.com/ruby/ruby/blob/ruby_3_1/vm_eval.c#L1802"><code>Kernel</code>&#39;s built-in <code>eval</code> method</a>.  This incredibly powerful method allows you to evaluate and execute arbitrary strings as if it were Ruby itself.  It can even do this <a href="https://github.com/ruby/ruby/blob/ruby_3_1/vm_eval.c#L1731">in the context of a specific binding</a> (if you pass it one), and you can also provide it with a file name and/or line number to attach to the stack trace in case there are any issues with its execution.</p>

<h3 id="learn-more-about-evaluating-ruby-code">Learn more about evaluating Ruby code</h3>

<p>First and foremost, check out Kevin Newton&#39;s incredible series: <a href="https://kddnewton.com/2022/11/30/advent-of-yarv-part-0.html">Advent of YARV</a>.  His multi-part exploration into the CRuby internals is absolutely incredible at describing in great detail all that goes into the CRuby stack.</p>

<p>There are so many great resources out there that offer some great detail into how Ruby executes your code.  The gold standard for this is, of course, Pat Shaughnessy&#39;s <a href="https://patshaughnessy.net/ruby-under-a-microscope"><em>Ruby Under A Microscope</em></a>.  This delightful book goes above and beyond to explain in the finest of detail how the YARV stack and the Ruby stack work together to evaluate and execute your Ruby code.  In this specific example provided in the Ruby source, it focuses on evaluating Ruby using <code>Kernel</code>; however, there are <a href="https://www.infoq.com/articles/eval-options-in-ruby/">several other ways to execute arbitrary ruby code that are outlined in this great article by Jay Fields</a>.  I also enjoyed this excellent write-up by Ilya Bylich on <a href="https://iliabylich.github.io/2020/01/25/evaluating-ruby-in-ruby.html">Evaluating Ruby in Ruby</a> that goes step-by-step through this process starting from the instruction sequence and following the frames through the stack using various examples.</p>

<hr/>

<h2 id="method-access">Method Access</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/export.rb">source: export.rb</a></p>

<p>This tiny example showcases the power of method access with the <code>public</code> and <code>private</code> keywords.  Now, if you&#39;re like me, you had <em>no idea these can take arguments</em>!  To make the example more clear as to what is happening, I made a small tweak to this example with some updated naming:</p>
<div><pre><code><span># sample/method_access.rb</span>
<span>class</span> <span>PrivatePuts</span>
   <span>private</span> <span>:puts</span>
<span>end</span>

<span>begin</span>
  <span>PrivatePuts</span><span>.</span><span>new</span><span>.</span><span>puts</span>
<span>rescue</span> <span>NoMethodError</span> <span>=&gt;</span> <span>e</span>
  <span>printf</span> <span>&#34;Tisk, tisk: %s</span><span>\n</span><span>&#34;</span><span>,</span> <span>e</span><span>.</span><span>message</span>
<span>end</span>

<span>class</span> <span>PublicPuts</span> <span>&lt;</span> <span>PrivatePuts</span>
  <span>def</span> <span>puts</span><span>(</span><span>*</span><span>args</span><span>)</span>
    <span>print</span> <span>&#34;Announcement: &#34;</span>
    <span>super</span>
  <span>end</span>
<span>end</span>

<span>PublicPuts</span><span>.</span><span>new</span><span>.</span><span>puts</span> <span>&#34;Hello, goodbye.&#34;</span>
</code></pre></div>
<p>When running this, you can see how we can &#34;export&#34;, or provide access to, a private method in a parent-class to a public method in a sub-class.</p>
<div><pre><code><span>$&gt;</span> ruby sample/method_access.rb
Tisk, tisk: private method <span>`</span>puts<span>&#39; called for #&lt;PrivatePuts:0x00007ff0a4833fa0&gt;
Announcement: Hello, goodbye.
</span></code></pre></div>
<h3 id="learn-more-about-method-access-in-ruby">Learn More About Method Access In Ruby</h3>

<p>&#34;So why is this example called <code>export.rb</code>?&#34; I hear you ask.  Well, as it turns out, <code>public</code> and <code>private</code> (amongst others) are <a href="https://github.com/ruby/ruby/blob/ruby_3_1/vm_method.c#L2268">implemented in the VM with the concept of method visibility</a>.  When these methods are called, they tell the interpreter to &#34;export&#34; the provided method(s) to the VM using <a href="https://github.com/ruby/ruby/blob/ruby_3_1/vm_method.c#L1596"><code>rb_export_method</code></a> and tell it what visibility it should have (<code>public</code>, <code>private</code>, <code>protected</code>).</p>

<p><a href="https://www.rubyguides.com/2018/10/method-visibility/">RubyGuides has a great article on method visibility in Ruby</a> with further examples within a few different contexts that may interest you.</p>

<hr/>

<h2 id="explore-the-ruby-grammar">Explore The Ruby Grammar</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/exyacc.rb">source: exyacc.rb</a></p>

<p>Ruby&#39;s entire grammar used to parse Ruby&#39;s syntax originates in <code>parse.y</code>.  We can use this clever example (taken from the Programming Perl book; yes, the one with a camel on it) to print out the grammar stored in it:</p>
<div><pre><code><span>$&gt;</span> ruby sample/exyacc.rb parse.y | <span>head</span> <span>-n</span> 28
</code></pre></div>
<p>I abbreviated quite a lot of the output for everyone&#39;s sanity, but if your curious mind gets to you then you can examine it and discover the excruciating detail of the Ruby language.</p>
<div><pre><code>program         : top_compstmt
                <span>;</span>

top_compstmt    : top_stmts opt_terms
                <span>;</span>

top_stmts       : none
                | top_stmt
                | top_stmts terms top_stmt
                | error top_stmt
                <span>;</span>

top_stmt        : stmt
                | keyword_BEGIN begin_block
                <span>;</span>

begin_block     : <span>&#39;{&#39;</span> top_compstmt <span>&#39;}&#39;</span>
                <span>;</span>

bodystmt        : compstmt
                  opt_rescue
                  k_else
                  compstmt
                  opt_ensure
                | compstmt
                  opt_rescue
                  opt_ensure
                <span>;</span>
</code></pre></div>
<p>There are two golden Easter Eggs that I found nestled into this lovely example.  First, if you look closely at the first line, you&#39;ll notice that the shebang declared makes use of two special options available in the <code>ruby</code> executable:</p>
<div><pre><code><span>#! /usr/local/bin/ruby -Kn</span>
</code></pre></div>
<ol>
<li><p><code>-K [ kcode]</code>  This option specifies the multi-byte character set code (e or E for EUC (extended Unix code); s or S for SJIS (Shift-JIS); u or U for UTF8; and a, A, n, or N for ASCII).</p></li>
<li><p><code>-n</code>  Places code within an input loop (as in <code>while gets; ... end</code>).</p></li>
</ol>

<p>The second golden feature nestled in here is the use of <code>ARGF</code>. <a href="https://rubyapi.org/3.1/o/argf">From the documentation for ARGF</a>:</p>

<blockquote>
<p>ARGF is a stream designed for use in scripts that process files given as command-line arguments or passed in via STDIN.</p>
</blockquote>

<p>As opposed to the more popular <a href="https://rubyapi.org/3.1/o/argv"><code>ARGV</code></a> (for extracting command line <em>arguments</em>), ARGF provides some delightful insight into how Ruby provides a way for easily working with files as arguments!  This functionality is <a href="https://github.com/ruby/ruby/blob/v3_1_2/io.c#L13088">built into Ruby&#39;s IO</a> and you can read about how the C code builds an enumerator for iterating over each line in the file(s) (as is done in this example).</p>

<h3 id="learn-more-about-ruby-s-grammar">Learn More About Ruby&#39;s Grammar</h3>

<p>The Ruby Hacking Guide has an incredible section all about the Ruby parser and how Ruby uses its grammar to parse and compile Ruby programs.  Anything and everything you&#39;ll ever need to know will be in there.</p>

<p>Kevin Newton also has <a href="https://kddnewton.com/2022/02/14/formatting-ruby-part-1.html">a fantastic breakdown of how Ruby makes use of Ripper</a> (a streaming Ruby parser) to parse Ruby syntax.  You can also find the entire history of how Ruby parsing has evolved on his <a href="https://kddnewton.com/parsing-ruby/">Parsing Ruby</a> site.</p>

<hr/>

<h2 id="factorial-calculator">Factorial Calculator</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/fact.rb">source: fact.rb</a></p>

<p>This is the first of many examples exploring mathematical concepts and formulas.  Adopting the right mathematical model can drastically improve the performance of your systems, as we&#39;ll see improving this example 🚀.</p>

<p>In this case, we&#39;re talking about <a href="https://en.wikipedia.org/wiki/Factorial">Factorials</a>.  Facto-what?  Don&#39;t worry, even if you&#39;re not familiar, the concept is simple.  Given a number <code>n</code>, the factorial is what you end up with by multiplying the number while decrementing it&#39;s value down to <code>1</code>. This can be expressed as the following formula:</p>
<div><pre><code>n! = n * (n - 1)!
</code></pre></div>
<p>Running the example we get what we expect out of <code>5!</code>: <code>5 * 4 * 3 * 2 * 1 = 120</code></p>
<div><pre><code><span>$&gt;</span> ruby samples/fact.rb 5
120
</code></pre></div>
<p>Now, to support common mathematical concepts and formula like this, Ruby comes with the incredible <a href="https://rubyapi.org/3.1/o/math"><code>Math module</code></a>, with a little tweaking of the original example, we can utilize the <a href="https://rubyapi.org/3.1/o/math#method-c-gamma"><code>Math.gamma</code> method</a> which implements a <a href="https://en.wikipedia.org/wiki/Gamma_function">Gamma Function</a> (basically the factorial of n - 1).  I&#39;ll be using the <code>benchmark-ips</code> gem to make it easier to understand the comparisons between reports of the benchmark we&#39;ll run to see how much we can improve things.</p>
<div><pre><code><span># sample/fact.rb – Updated to use Math.gamma with benchmark</span>
<span>require</span> <span>&#39;bundler/inline&#39;</span>

<span>gemfile</span> <span>do</span>
  <span>source</span> <span>&#39;https://rubygems.org&#39;</span>
  <span>gem</span> <span>&#34;benchmark-ips&#34;</span><span>,</span> <span>require: </span><span>false</span>
<span>end</span>
<span>require</span> <span>&#34;benchmark/ips&#34;</span>

<span>def</span> <span>fact</span><span>(</span><span>n</span><span>)</span>
  <span>return</span> <span>1</span> <span>if</span> <span>n</span> <span>==</span> <span>0</span>
  <span>f</span> <span>=</span> <span>1</span>
  <span>n</span><span>.</span><span>downto</span><span>(</span><span>1</span><span>)</span> <span>do</span> <span>|</span><span>i</span><span>|</span>
    <span>f</span> <span>*=</span> <span>i</span>
  <span>end</span>
  <span>f</span>
<span>end</span>

<span>def</span> <span>fact_gamma</span><span>(</span><span>n</span><span>)</span>
  <span>return</span> <span>1</span> <span>if</span> <span>n</span> <span>&lt;=</span> <span>1</span>
  <span>n</span> <span>*</span> <span>Math</span><span>.</span><span>gamma</span><span>(</span><span>n</span><span>)</span>
<span>end</span>

<span>Benchmark</span><span>.</span><span>ips</span> <span>do</span> <span>|</span><span>x</span><span>|</span>
  <span>x</span><span>.</span><span>report</span><span>(</span><span>&#34;original factorial example&#34;</span><span>)</span> <span>{</span> <span>fact</span><span>(</span><span>ARGV</span><span>[</span><span>0</span><span>].</span><span>to_i</span><span>)</span> <span>}</span>
  <span>x</span><span>.</span><span>report</span><span>(</span><span>&#34;factorial with gamma&#34;</span><span>)</span> <span>{</span> <span>fact_gamma</span><span>(</span><span>ARGV</span><span>[</span><span>0</span><span>].</span><span>to_i</span><span>)</span> <span>}</span>
  <span>x</span><span>.</span><span>compare!</span>
<span>end</span>
</code></pre></div>
<p>Now if we re-run the  script to find the factorial of 1000 (<code>1000!</code>):</p>
<div><pre><code><span>$&gt;</span> ruby sample/fact.rb 1000
Warming up <span>--------------------------------------</span>
original factorial example
                        90.000  i/100ms
factorial with gamma   203.392k i/100ms
Calculating <span>-------------------------------------</span>
original factorial example
                        896.596  <span>(</span>± 5.7%<span>)</span> i/s -      4.500k <span>in   </span>5.036761s
factorial with gamma      2.060M <span>(</span>± 3.9%<span>)</span> i/s -     10.373M <span>in   </span>5.044264s

Comparison:
factorial with gamma:  2059772.9 i/s
original factorial example:      896.6 i/s - 2297.33x  <span>(</span>± 0.00<span>)</span> slower
</code></pre></div>
<p>No, you&#39;re not reading that wrong.  Using <code>Math.gamma</code> to calculate factorials is <strong>2,297 times faster</strong>! With a whopping 2.06 million iterations per second!!  Let&#39;s make our machine try a little harder and calculate <code>100,000!</code>.</p>
<div><pre><code><span>$&gt;</span> ruby sample/fact.rb 100000
Warming up <span>--------------------------------------</span>
original factorial example
                         1.000  i/100ms
factorial with gamma   267.503k i/100ms
Calculating <span>-------------------------------------</span>
original factorial example
                          0.112  <span>(</span>± 0.0%<span>)</span> i/s -      1.000  <span>in   </span>8.945673s
factorial with gamma      2.563M <span>(</span>± 3.2%<span>)</span> i/s -     12.840M <span>in   </span>5.015354s

Comparison:
factorial with gamma:  2563085.9 i/s
original factorial example:        0.1 i/s - 22928528.45x  <span>(</span>± 0.00<span>)</span> slower
</code></pre></div>
<p>Incredible.  At a blazing 2.56 million iterations-per-second, this improvement really pulls away from the original with a <strong>22,928,528x improvement</strong>.</p>

<h3 id="learn-more-about-factorials">Learn More About Factorials</h3>

<p>&#34;But wait a minute here,&#34; I hear you say, &#34;HOW!??&#34;.  It gets this lovely boost by <a href="https://github.com/ruby/ruby/blob/v3_1_2/math.c#L835">storing static values for the first twenty two factorials in a table</a> and fetching them as it goes.  The rest of the <code>Math</code> module is also a great resource and worth exploring what else is in there.</p>

<p>Now that you know how to calculate factorials, there are some really powerful things you can use them for! Factorials are at the foundation of <a href="https://en.wikipedia.org/wiki/Discrete_mathematics#Combinatorics"><em>combinatorics</em> in discrete mathematics</a>, which explores how discrete structures can be combined or arranged; and they also poke their heads in many areas of statistics.  If you ever need to calculate how you can sort your favorite playlist, or figuring out the probability of picking out a blue M&amp;M from the pack.</p>

<hr/>

<h2 id="fibonacci">Fibonacci</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/fib.rb">source: fib.rb</a></p>

<p>At first glance, there&#39;s not much to this simple example, but aw shucks am I sucker for a good math problem.  It calculates a Fibonacci number at a specific position in the sequence.  At the top of the file is a small note by Matz that says, &#34;calculate Fibonacci(2) for benchmark&#34;.  Naturally, I decided to do some light investigation on calculating Fibonacci and setting up some small benchmarks.</p>

<p><a href="https://en.wikipedia.org/wiki/Fibonacci_number">After some quick research on Wikipedia</a>, I was surprised to find that Fibonacci numbers were not discovered by the Italian mathematician, but were first described as early as 200 BC in a work by an Indian poet and mathematician: <a href="https://en.wikipedia.org/wiki/Pingala">Acharya Pingala</a> on enumerating possible patterns of Sanskrit poetry formed from syllables of two lengths.  Truly fascinating; but let&#39;s get back to our example.</p>

<p>To get things started, let&#39;s take a quick look at the original example:</p>
<div><pre><code><span>def</span> <span>fib</span><span>(</span><span>n</span><span>)</span>
  <span>if</span> <span>n</span><span>&lt;</span><span>2</span>
    <span>n</span>
  <span>else</span>
    <span>fib</span><span>(</span><span>n</span><span>-</span><span>2</span><span>)</span><span>+</span><span>fib</span><span>(</span><span>n</span><span>-</span><span>1</span><span>)</span>
  <span>end</span>
<span>end</span>
</code></pre></div>
<p>This function takes an <code>Integer</code> <strong>n</strong> and recursively reduces the calculated Fibonacci number at that level.  Now, if this is really used in a benchmark, we should try and make this as fast as possible.  Let&#39;s see what kind of power we can bake into this Bad Mama Jama.</p>

<p>Thanks to <a href="https://www.rubyguides.com/2015/08/ruby-recursion-and-memoization/">this excellent article from RubyGuides</a>, there are a couple issues with the initial implementation.</p>

<p>Issue 1: Use of recursion on a boundless calculation</p>

<p>As pointed out in the article, Ruby has some limitations on how many times you can recursively call a method (around 7500 depending on your system; and funny enough, I found <a href="https://bugs.ruby-lang.org/issues/1218">an old rejected feature request to allow getting and setting the recursion limit</a>).  To get around this limitation, it is typical to use an iterative solution.</p>

<p>Issue 2: Lack of caching when reducing calculated</p>

<p>The article also points out that, due to the nature of the calculation, some values are re-calculated as the level of <strong>n</strong> grows.  To further improve our example, we can take advantage of caching the levels while we iterate , which gives us throughput at the expense of memory bloat (for higher levels); but hey, at least we&#39;re not StackOverflow&#39;in amirite?  I&#39;ve included both an inline cache and external cache example so we can see what kind of improvements we get in both a closed-function setting and one in an encapsulated setting (like creating a <code>Fibonacci</code> class :chuckle:)</p>
<div><pre><code><span>def</span> <span>fib_iterative_internal_cache</span><span>(</span><span>n</span><span>)</span>
  <span>cache</span> <span>=</span> <span>[</span><span>0</span><span>,</span> <span>1</span><span>]</span>
  <span>0</span><span>.</span><span>upto</span><span>(</span><span>i</span><span>)</span> <span>do</span> <span>|</span><span>i</span><span>|</span>
    <span>next</span> <span>if</span> <span>cache</span><span>[</span><span>n</span><span>]</span>
    <span>cache</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>i</span> <span>&lt;</span> <span>2</span> <span>?</span> <span>i</span> <span>:</span> <span>cache</span><span>[</span><span>i</span> <span>-</span> <span>1</span><span>]</span> <span>+</span> <span>cache</span><span>[</span><span>i</span> <span>-</span> <span>2</span><span>]</span>
  <span>end</span>
  <span>cache</span><span>[</span><span>n</span><span>]</span>
<span>end</span>

<span>@external_cache</span> <span>=</span> <span>[</span><span>0</span><span>,</span> <span>1</span><span>]</span>
<span>def</span> <span>fib_iterative_external_cache</span><span>(</span><span>n</span><span>)</span>
  <span>0</span><span>.</span><span>upto</span><span>(</span><span>n</span><span>)</span> <span>do</span> <span>|</span><span>i</span><span>|</span>
    <span>next</span> <span>if</span> <span>@external_cache</span><span>[</span><span>i</span><span>]</span>

    <span>@external_cache</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>i</span> <span>&lt;</span> <span>2</span> <span>?</span> <span>i</span> <span>:</span> <span>@external_cache</span><span>[</span><span>i</span> <span>-</span> <span>1</span><span>]</span> <span>+</span> <span>@external_cache</span><span>[</span><span>i</span> <span>-</span> <span>2</span><span>]</span>
  <span>end</span>
  <span>@external_cache</span><span>[</span><span>n</span><span>]</span>
<span>end</span>
</code></pre></div>
<p>A quick benchmark and we can see our improvements!  Also, we can now feel confident that we won&#39;t overflow the interpreter.</p>
<div><pre><code><span># Appended to our above examples</span>
<span>require</span> <span>&#34;benchmark/ips&#34;</span>

<span>Benchmark</span><span>.</span><span>ips</span> <span>do</span> <span>|</span><span>x</span><span>|</span>
  <span>x</span><span>.</span><span>report</span><span>(</span><span>&#34;original fib&#34;</span><span>)</span> <span>{</span> <span>fib</span><span>(</span><span>20</span><span>)</span> <span>}</span>
  <span>x</span><span>.</span><span>report</span><span>(</span><span>&#34;iterative fib (internal cache)&#34;</span><span>)</span> <span>{</span> <span>fib_iterative_internal_cache</span><span>(</span><span>20</span><span>)</span> <span>}</span>
  <span>x</span><span>.</span><span>report</span><span>(</span><span>&#34;iterative fib (external cache)&#34;</span><span>)</span> <span>{</span> <span>fib_iterative_external_cache</span><span>(</span><span>20</span><span>)</span> <span>}</span>
  <span>x</span><span>.</span><span>compare!</span>
<span>end</span>
</code></pre></div>
<p>Now running our updated example to see the results:</p>
<div><pre><code><span>$&gt;</span> ruby sample/fib.rb
6765
Warming up <span>--------------------------------------</span>
        original fib    55.000  i/100ms
iterative fib <span>(</span>internal cache<span>)</span>
                        15.498k i/100ms
iterative fib <span>(</span>external cache<span>)</span>
                        30.071k i/100ms
Calculating <span>-------------------------------------</span>
        original fib    554.945  <span>(</span>± 5.2%<span>)</span> i/s -      2.805k <span>in   </span>5.069228s
iterative fib <span>(</span>internal cache<span>)</span>
                        166.978k <span>(</span>± 7.8%<span>)</span> i/s -    836.892k <span>in   </span>5.048092s
iterative fib <span>(</span>external cache<span>)</span>
                        291.676k <span>(</span>± 7.2%<span>)</span> i/s -      1.473M <span>in   </span>5.082205s

Comparison:
iterative fib <span>(</span>external cache<span>)</span>:   291676.1 i/s
iterative fib <span>(</span>internal cache<span>)</span>:   166977.7 i/s - 1.75x  <span>(</span>± 0.00<span>)</span> slower
        original fib:      554.9 i/s - 525.59x  <span>(</span>± 0.00<span>)</span> slower
</code></pre></div>
<p>A <strong>554x improvement</strong>!  That&#39;s what I&#39;m talking about!  Although this is a great speed boost, this is math!  Shouldn&#39;t there be some kind of formula we can take advantage of to just, I don&#39;t know, <strong>calculate the solution all at once</strong>.  Well, you guessed it, hiding in plain sight, from our trusty Wikipedia article, we can extract two formula:</p>

<ol>
<li>Finding a positive Fibonacci number at position <strong>n</strong> in the sequence</li>
</ol>
<div><pre><code>Fn = [( (1 + √5)^n - (1 - √5)^n ) / (2^n × √5)]
</code></pre></div>
<ol>
<li>Finding a positive or negative Fibonacci number at position <strong>n</strong> in the sequence</li>
</ol>
<div><pre><code>Fn = [( (1 + √5)^n ) / (2^n × √5)]
</code></pre></div>
<p>Using these lovely new formulas, we can introduce two new examples that utilize the raw power of the CPU to calculate the values in, what some might say, a &#34;zero-sum game&#34; 😂.</p>
<div><pre><code><span># Appended to our ongoing example</span>

<span># Positive only equation</span>
<span># Fn = [( (1 + √5)^n ) / (2^n × √5)]</span>
<span>def</span> <span>fib_math_positives_only</span><span>(</span><span>n</span><span>)</span>
  <span>sqrt_of_five</span> <span>=</span> <span>Math</span><span>.</span><span>sqrt</span><span>(</span><span>5</span><span>)</span>
  <span>(</span>
    <span>((</span><span>1</span> <span>+</span> <span>sqrt_of_five</span><span>)</span><span>**</span><span>n</span><span>)</span> <span>/</span> <span>(</span><span>2</span><span>**</span><span>n</span> <span>*</span> <span>sqrt_of_five</span><span>)</span>
  <span>).</span><span>round</span>
<span>end</span>

<span># Positive and negative equation</span>
<span># Fn = ( (1 + √5)^n - (1 - √5)^n ) / (2^n × √5)</span>
<span>def</span> <span>fib_math</span><span>(</span><span>n</span><span>)</span>
  <span>sqrt_of_five</span> <span>=</span> <span>Math</span><span>.</span><span>sqrt</span><span>(</span><span>5</span><span>)</span>
  <span>(</span>
    <span>((</span><span>1</span> <span>+</span> <span>sqrt_of_five</span><span>)</span><span>**</span><span>n</span> <span>-</span> <span>(</span><span>1</span> <span>-</span> <span>sqrt_of_five</span><span>)</span> <span>**</span> <span>n</span><span>)</span> <span>/</span> <span>(</span><span>2</span><span>**</span><span>n</span> <span>*</span> <span>sqrt_of_five</span><span>)</span>
  <span>).</span><span>round</span>
<span>end</span>
</code></pre></div>
<p>Running our benchmark again on all of our examples:</p>
<div><pre><code><span>$&gt;</span> ruby sample/fib.rb
Warming up <span>--------------------------------------</span>
        original fib    49.000  i/100ms
iterative fib <span>(</span>internal cache<span>)</span>
                        17.331k i/100ms
iterative fib <span>(</span>external cache<span>)</span>
                        31.671k i/100ms
            fib math    90.836k i/100ms
fib math <span>(</span>positivesonly<span>)</span>
                       120.339k i/100ms
Calculating <span>-------------------------------------</span>
        original fib    550.045  <span>(</span>± 7.3%<span>)</span> i/s -      2.744k <span>in   </span>5.023195s
iterative fib <span>(</span>internal cache<span>)</span>
                        166.070k <span>(</span>± 6.7%<span>)</span> i/s -    831.888k <span>in   </span>5.034572s
iterative fib <span>(</span>external cache<span>)</span>
                        302.488k <span>(</span>± 8.8%<span>)</span> i/s -      1.520M <span>in   </span>5.075258s
            fib math    902.943k <span>(</span>± 6.7%<span>)</span> i/s -      4.542M <span>in   </span>5.057940s
fib math <span>(</span>positivesonly<span>)</span>
                          1.159M <span>(</span>± 7.4%<span>)</span> i/s -      5.776M <span>in   </span>5.017804s

Comparison:
fib math <span>(</span>positivesonly<span>)</span>:  1158712.8 i/s
            fib math:   902943.5 i/s - 1.28x  <span>(</span>± 0.00<span>)</span> slower
iterative fib <span>(</span>external cache<span>)</span>:   302487.6 i/s - 3.83x  <span>(</span>± 0.00<span>)</span> slower
iterative fib <span>(</span>internal cache<span>)</span>:   166070.4 i/s - 6.98x  <span>(</span>± 0.00<span>)</span> slower
        original fib:      550.0 i/s - 2106.58x  <span>(</span>± 0.00<span>)</span> slower

</code></pre></div>
<p><strong>WOW!</strong> Using raw computation get&#39;s us to a whopping <strong>2106x</strong> improvement!!  It <em>also</em> busts us out of our high-order memory concern albeit at a much smaller expense of the CPU; and we can save that resource benchmark for another time 😂.</p>

<p>So fun!</p>

<hr/>

<h2 id="unix-mail-from">Unix Mail From</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/from.rb">source: from.rb</a></p>

<p>This example showcases an implementation of the Unix mail program&#39;s &#34;from&#34; sub-command, which takes a list of messages and prints their message headers.</p>
<div><pre><code><span>$&gt;</span> ruby sample/from.rb codenamev
You have no mail.
</code></pre></div>
<p>Welp, short example, but I&#39;ll try again when I get some mail :-)</p>

<hr/>

<h2 id="gather-full-paths">Gather Full Paths</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/fullpath.rb">source: fullpath.rb</a></p>

<p>This is a great example showcasing how to take advantage of UNIX Pipes as input to your ruby in scripts!  This example takes the output from an <code>ls -lR</code> call and doctors up the output to show the full paths of the files!</p>

<p>For clarity of what is happening, I&#39;m sampling the last few lines of the output of <code>ls -lR</code> inside of the <code>sample</code> directory of the ruby source:</p>
<div><pre><code><span>$&gt;</span> <span>ls</span> <span>-lR</span> /Users/codenamev/src/opensource/ruby/sample | <span>tail</span>
<span>-rw-r--r--</span>  1 codenamev  staff    53 Sep 22 16:57 authors.markdown
<span>-rw-r--r--</span>  1 codenamev  staff   171 Sep 22 16:57 entry.rb
<span>-rw-r--r--</span>  1 codenamev  staff  1851 Sep 22 16:57 remarks.markdown

/Users/codenamev/src/opensource/ruby/sample/trick2018/05-tompng:
total 160
<span>-rw-r--r--</span>  1 codenamev  staff     67 Sep 22 16:57 authors.markdown
<span>-rw-r--r--</span>  1 codenamev  staff   1897 Sep 22 16:57 entry.rb
<span>-rw-r--r--</span>  1 codenamev  staff  66800 Sep 22 16:57 preview_of_output.png
<span>-rw-r--r--</span>  1 codenamev  staff    828 Sep 22 16:57 remarks.markdown
</code></pre></div>
<p>The output is trimmed, but we can at least see how this lovely script will give us a more workable list of full paths for all the files in this directory and their sub-directories:</p>
<div><pre><code><span>$&gt;</span> <span>ls</span> <span>-lR</span> /Users/codenamev/src/opensource/ruby/sample | ruby sample/fullpath.rb| <span>tail</span>
<span>-rw-r--r--</span>  1 codenamev  staff  5852 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/03-tompng/output.txt
<span>-rw-r--r--</span>  1 codenamev  staff   531 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/03-tompng/remarks.markdown
<span>-rw-r--r--</span>  1 codenamev  staff  5661 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/03-tompng/trick.png
<span>-rw-r--r--</span>  1 codenamev  staff    53 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/04-colin/authors.markdown
<span>-rw-r--r--</span>  1 codenamev  staff   171 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/04-colin/entry.rb
<span>-rw-r--r--</span>  1 codenamev  staff  1851 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/04-colin/remarks.markdown
<span>-rw-r--r--</span>  1 codenamev  staff     67 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/05-tompng/authors.markdown
<span>-rw-r--r--</span>  1 codenamev  staff   1897 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/05-tompng/entry.rb
<span>-rw-r--r--</span>  1 codenamev  staff  66800 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/05-tompng/preview_of_output.png
<span>-rw-r--r--</span>  1 codenamev  staff    828 Sep 22 16:57 /Users/codenamev/src/opensource/ruby/sample/trick2018/05-tompng/remarks.markdown
</code></pre></div>
<h3 id="learn-more-about-piping-to-ruby">Learn More About Piping To Ruby</h3>

<ul>
<li> <a href="https://ruby.social/@starr">Starr Horne</a> has an incredible write-up on <a href="https://www.honeybadger.io/blog/ruby-unix-command-line/">Level Up Your Command-Line-Fu With Ruby</a>.  So much to learn.  So much to love ❤️</li>
<li> <a href="https://www.paulfioravanti.com/">Paul Fioravanti</a> wrote this fairly entertaining piece: <a href="https://www.paulfioravanti.com/blog/pipe-codebase-into-ruby/">Pipe a Codebase into Ruby</a>.</li>
</ul>

<hr/>

<h2 id="saving-and-loading-ruby-instruction-sequences">Saving And Loading Ruby Instruction Sequences</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/iseq_loader.rb">source: iseq_loader.rb</a></p>

<p>The super special <a href="https://rubyapi.org/3.1/o/rubyvm/instructionsequence"><code>RubyVM::InstructionSequence</code></a> class is extended in this example to showcase how to compile ruby code into its instruction sequences into a separate file that can then be loaded at a later time.</p>

<p>The <a href="https://rubyapi.org/3.1/o/rubyvm/instructionsequence">Ruby documentation</a> does an excellent job explaining what this special class is and why you might want to use it:</p>

<blockquote>
<p>The InstructionSequence class represents a compiled sequence of instructions for the Virtual Machine used in MRI. Not all implementations of Ruby may implement this class, and for the implementations that implement it, the methods defined and behavior of the methods can change in any version.</p>

<p>With it, you can get a handle to the instructions that make up a method or a proc, compile strings of Ruby code down to VM instructions, and disassemble instruction sequences to strings for easy inspection. It is mostly useful if you want to learn how YARV works, but it also lets you control various settings for the Ruby iseq compiler.</p>
</blockquote>

<p>To test this out, I created a <code>simple_math.rb</code> file with <code>1 + 2</code> inside.  Then, I compiled the instructions for this file into another using this sample script:</p>
<div><pre><code><span>$&gt;</span> ruby sample/iseq_loader.rb simple_math.rb
Writing to file: simple_math.rb, simple_math.rb.yarb
</code></pre></div>
<p>Now that I have the compiled instructions, I opened up an IRB session with this example pre-loaded</p>
<div><pre><code><span>$&gt;</span> irb <span>-r</span> sample/iseq_loader.rb
</code></pre></div>
<p>Then I tested out loading the compiled file:</p>
<div><pre><code><span>irb</span><span>(</span><span>main</span><span>):</span><span>001</span><span>:</span><span>0</span><span>&gt;</span> <span>simple_math_iseq</span> <span>=</span> <span>RubyVM</span><span>::</span><span>InstructionSequence</span><span>::</span><span>FSStorage</span><span>.</span><span>new</span><span>.</span><span>load_iseq</span> <span>&#34;simple_math.rb&#34;</span>
<span>=&gt;</span> <span>&lt;</span><span>RubyVM</span><span>::</span><span>InstructionSequence</span><span>:&lt;</span><span>main</span><span>&gt;</span><span>@simple_math</span><span>.</span><span>rb</span><span>:</span><span>1</span><span>&gt;</span>
<span>irb</span><span>(</span><span>main</span><span>):</span><span>002</span><span>:</span><span>0</span><span>&gt;</span> <span>simple_math_iseq</span><span>.</span><span>eval</span>
<span>=&gt;</span> <span>3</span>
<span>irb</span><span>(</span><span>main</span><span>):</span><span>003</span><span>:</span><span>0</span><span>&gt;</span> <span>simple_math_iseq</span><span>.</span><span>to_a</span>
<span>=&gt;</span>
<span>[</span><span>&#34;YARVInstructionSequence/SimpleDataFormat&#34;</span><span>,</span>
 <span>3</span><span>,</span>
 <span>1</span><span>,</span>
 <span>1</span><span>,</span>
 <span>{</span><span>:arg_size</span><span>=&gt;</span><span>0</span><span>,</span> <span>:local_size</span><span>=&gt;</span><span>0</span><span>,</span> <span>:stack_max</span><span>=&gt;</span><span>2</span><span>,</span> <span>:node_id</span><span>=&gt;</span><span>4</span><span>,</span> <span>:code_location</span><span>=&gt;</span><span>[</span><span>1</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>5</span><span>],</span> <span>:node_ids</span><span>=&gt;</span><span>[</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>-</span><span>1</span><span>]},</span>
 <span>&#34;&lt;main&gt;&#34;</span><span>,</span>
 <span>&#34;simple_math.rb&#34;</span><span>,</span>
 <span>&#34;/Users/codenamev/src/opensource/ruby/sample/simple_math.rb&#34;</span><span>,</span>
 <span>1</span><span>,</span>
 <span>:top</span><span>,</span>
 <span>[],</span>
 <span>{},</span>
 <span>[],</span>
 <span>[</span><span>1</span><span>,</span> <span>:RUBY_EVENT_LINE</span><span>,</span> <span>[</span><span>:putobject_INT2FIX_1_</span><span>],</span> <span>[</span><span>:putobject</span><span>,</span> <span>2</span><span>],</span> <span>[</span><span>:opt_plus</span><span>,</span> <span>{</span><span>:mid</span><span>=&gt;</span><span>:</span><span>+</span><span>,</span> <span>:flag</span><span>=&gt;</span><span>16</span><span>,</span> <span>:orig_argc</span><span>=&gt;</span><span>1</span><span>}],</span> <span>[</span><span>:leave</span><span>]]]</span>
<span>irb</span><span>(</span><span>main</span><span>):</span><span>004</span><span>:</span><span>0</span><span>&gt;</span> <span>ls</span> <span>simple_math_iseq</span>
<span>RubyVM</span><span>::</span><span>InstructionSequence</span><span>#methods:</span>
  <span>absolute_path</span>  <span>base_label</span>  <span>disasm</span>  <span>disassemble</span>  <span>each_child</span>  <span>eval</span>  <span>first_lineno</span>  <span>inspect</span>  <span>label</span>  <span>path</span>  <span>script_lines</span>  <span>to_a</span>  <span>to_binary</span>  <span>trace_points</span>
<span>=&gt;</span> <span>nil</span>
<span>irb</span><span>(</span><span>main</span><span>):</span><span>005</span><span>:</span><span>0</span><span>&gt;</span> <span>simple_math_iseq</span><span>.</span><span>disasm</span>
<span>=&gt;</span> <span>&#34;== disasm: #&lt;ISeq:&lt;main&gt;@simple_math.rb:1 (1,0)-(1,5)&gt; (catch: FALSE)</span><span>\n</span><span>0000 putobject_INT2FIX_1_                                             (   1)[Li]</span><span>\n</span><span>0001 putobject                              2</span><span>\n</span><span>0003 opt_plus                               &lt;calldata!mid:+, argc:1, ARGS_SIMPLE&gt;[CcCr]</span><span>\n</span><span>0005 leave</span><span>\n</span><span>&#34;</span>
</code></pre></div>
<p>Neat!  With this, you can peek into the internals of CRuby&#39;s VM.  So, how is this useful?  Well, let&#39;s say you run into some Ruby code that is doing something you don&#39;t expect.  With <code>RubyVM::InstructionSequence</code>, you can peek into what is happening!</p>

<p>I was recently helping a co-worker debug an issue dynamically building keys for a hash.  I had thought that the keys were getting set as strings, but as it turns out, this particular notation of Ruby makes them symbols:</p>
<div><pre><code><span>irb</span><span>(</span><span>main</span><span>):</span><span>001</span><span>:</span><span>0</span><span>&gt;</span> <span>{</span> <span>&#34;thing1&#34;</span><span>:</span> <span>1</span><span>,</span> <span>&#34;thing2&#34;</span><span>:</span> <span>2</span> <span>}</span>
<span>=&gt;</span> <span>{</span><span>:thing1</span><span>=&gt;</span><span>1</span><span>,</span> <span>:thing2</span><span>=&gt;</span><span>2</span><span>}</span>
<span>irb</span><span>(</span><span>main</span><span>):</span><span>002</span><span>:</span><span>0</span><span>&gt;</span>
</code></pre></div>
<p>Using our trusty new tool, I disassembled the compiled CRuby code to see what was happening:</p>
<div><pre><code><span>irb</span><span>(</span><span>main</span><span>):</span><span>003</span><span>:</span><span>0</span><span>&gt;</span> <span>RubyVM</span><span>::</span><span>InstructionSequence</span><span>.</span><span>compile</span><span>(</span><span>&#39;{ &#34;thing1&#34;: 1, &#34;thing2&#34;: 2 }&#39;</span><span>).</span><span>disasm</span>
<span>=&gt;</span> <span>&#34;== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;:1 (1,0)-(1,28)&gt; (catch: FALSE)</span><span>\n</span><span>0000 duphash                                {:thing1=&gt;1, :thing2=&gt;2}  (   1)[Li]</span><span>\n</span><span>0002 leave</span><span>\n</span><span>&#34;</span>
</code></pre></div>
<p>Ah ha! While I thought it was using strings, the CRuby VM is building the hash with symbols!  I was able to confirm this by performing this same test with the old &#34;hashrocket&#34; Hash notation:</p>
<div><pre><code><span>irb</span><span>(</span><span>main</span><span>):</span><span>004</span><span>:</span><span>0</span><span>&gt;</span> <span>RubyVM</span><span>::</span><span>InstructionSequence</span><span>.</span><span>compile</span><span>(</span><span>&#39;{ &#34;thing1&#34; =&gt; 1, &#34;thing2&#34; =&gt; 2 }&#39;</span><span>).</span><span>disasm</span>
<span>=&gt;</span> <span>&#34;== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;:1 (1,0)-(1,32)&gt; (catch: FALSE)</span><span>\n</span><span>0000 duphash                                {</span><span>\&#34;</span><span>thing1</span><span>\&#34;</span><span>=&gt;1, </span><span>\&#34;</span><span>thing2</span><span>\&#34;</span><span>=&gt;2}(   1)[Li]</span><span>\n</span><span>0002 leave</span><span>\n</span><span>&#34;</span>
<span>irb</span><span>(</span><span>main</span><span>):</span><span>005</span><span>:</span><span>0</span><span>&gt;</span> <span>{</span> <span>&#34;thing1&#34;</span> <span>=&gt;</span> <span>1</span><span>,</span> <span>&#34;thing2&#34;</span> <span>=&gt;</span> <span>2</span> <span>}</span>
<span>=&gt;</span> <span>{</span><span>&#34;thing1&#34;</span><span>=&gt;</span><span>1</span><span>,</span> <span>&#34;thing2&#34;</span><span>=&gt;</span><span>2</span><span>}</span>
</code></pre></div>
<p>Good times.</p>

<h3 id="learn-more-about-ruby-s-vm">Learn More About Ruby&#39;s VM</h3>

<ul>
<li>Make sure to check out <a href="https://kddnewton.com/2022/11/30/advent-of-yarv-part-0.html">Kevin Newton&#39;s incredible Advent of YARV</a> for an in-depth look at CRuby&#39;s virtual machine and how you can make use of these instruction sequences!</li>
<li>For some fun, join Stefanni Brasil and Thiago Araujo over at <a href="https://www.hexdevs.com/">HexDevs</a> combine forces with Aaron Patterson in this great breakdown: <a href="https://www.hexdevs.com/posts/ruby-just-in-time-compiler-tenderjit/">A Tender Introduction to Ruby Internals with TenderJIT</a></li>
</ul>

<hr/>

<h2 id="a-front-end-for-the-less-command">A Front-end For The Less Command</h2>

<p><a href="https://github.com/ruby/ruby/blob/ruby_3_1/sample/less.rb">source: less.rb</a></p>

<p>This nifty little script allows you to combine the powers of <a href="https://man7.org/linux/man-pages/man1/less.1.html">less</a> and <a href="https://man7.org/linux/man-pages/man1/zcat.1p.html">zcat</a> to properly dump the contents of a file to one of these system pagers without having to care about whether it&#39;s compressed or not.  I had to alter the paths to match my system, but with that I was able to play around with some options:</p>
<div><pre><code><span>$&gt;</span> ruby sample/less.rb <span>-NR</span> <span>-p</span> mental <span>--use-color</span> sample/biorhythm.rb
</code></pre></div>
<p>This throws me into the less utility at the first occurrence of the pattern I provided (&#34;mental&#34;):</p>
<div><pre><code>    102   print &#34;                     P=physical, E=emotional, M=mental\n&#34;
    103   print &#34;             -------------------------+-------------------------\n&#34;
    104   print &#34;                     Bad Condition    |    Good Condition\n&#34;
    105   print &#34;             -------------------------+-------------------------\n&#34;
    106
    107   (dd - bd).step(dd - bd + display_period) do |z|
    108     phys, emot, geist = get_position(z)
    109
    110     printf &#34;%04d.%02d.%02d : &#34;, dd.year, dd.month, dd.day
    111     p = (phys / 2.0 + 0.5).to_i
    112     e = (emot / 2.0 + 0.5).to_i
    113     g = (geist / 2.0 + 0.5).to_i
    114     graph = &#34;.&#34; * 51
    115     graph[25] = ?|
    116     graph[p] = ?P
    117     graph[e] = ?E
    118     graph[g] = ?M
    119     print graph, &#34;\n&#34;
    120     dd = dd + 1
    121   end
    122   print &#34;             -------------------------+-------------------------\n\n&#34;
biorhythm.rb
</code></pre></div>
<p>I gzip&#39;ed the biorhythm.rb file and updated the example to use <code>gzcat</code> (because of <a href="https://serverfault.com/questions/570024/zcat-gzcat-works-in-linux-not-on-osx-general-linux-osx-compatibility">this issue with running <code>zcat</code> on MacOS</a>).  Running the same command on the new compressed file:</p>
<div><pre><code><span>$&gt;</span> ruby sample/less.rb <span>-NR</span> <span>-p</span> mental <span>--use-color</span> sample/biorhythm.rb.gz
</code></pre></div>
<p>And I get the same output above!  Niiiiiice.</p>

<hr/>

<h2 id="wrapping-it-up">Wrapping it up</h2>

<p>Whew!  That was a lot to uncover, but there is SO much more ahead of us.  I&#39;ve said it before, and I&#39;ll say it again!  The Ruby source is not so scary! It&#39;s not all C code. There&#39;s quite a lot of <strong>Ruby</strong> code inside.  And while it may be nice to reach for those external gems and tools, chances are you&#39;re missing out on what&#39;s already there.</p>

<hr/>

<p>Be sure to follow <a href="https://twitter.com/doximity_tech">@doximity_tech</a> if you&#39;d like to be notified about new blog posts.</p>
</div></div></div></div></div>
  </body>
</html>
