<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/arianvp/5f59f1783e3eaf1a2d4cd8e952bb4acf">Original</a>
    <h1>Native Secure Enclave backed SSH keys on macOS</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-ssh_macos_secure_enclaves-md">
      
      <div id="file-ssh_macos_secure_enclaves-md-readme" tabindex="0" role="region" aria-label="SSH_MACOS_SECURE_ENCLAVES.md content, created by arianvp on 05:53PM yesterday.">
    <article itemprop="text">
<p dir="auto">It turns out that MacOS Tahoe can generate and use secure-enclave backed SSH keys! This replaces projects like <a href="https://github.com/maxgoedjen/secretive">https://github.com/maxgoedjen/secretive</a></p>
<p dir="auto">There is a shared library <code>/usr/lib/ssh-keychain.dylib</code> that traditionally has been used to add smartcard support
to ssh by implementing <code>PKCS11Provider</code> interface. However since recently it also implements <code>SecurityKeyProivder</code>
which supports loading keys directly from the secure enclave! <code>SecurityKeyProvider</code> is what is normally used to talk to FIDO2 devices (e.g. <code>libfido2</code> can be used to talk to your Yubikey). However you can now use it to talk to your Secure Enclave instead!</p>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path>
</svg>
    <span>recording.mov</span>
    <span></span>
  </summary>

  <video src="https://private-user-images.githubusercontent.com/628387/517875041-ff033694-13e1-454e-b42b-b5c19e0fb2a0.mov?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjM5NTkxMDcsIm5iZiI6MTc2Mzk1ODgwNywicGF0aCI6Ii82MjgzODcvNTE3ODc1MDQxLWZmMDMzNjk0LTEzZTEtNDU0ZS1iNDJiLWI1YzE5ZTBmYjJhMC5tb3Y_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMTI0JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTEyNFQwNDMzMjdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT05OWIwOGY2ZThmYzI5ZDI4M2ZhZmU1NGE2YjgwMDE3NTYxMWUyNGU5OWNkYTNiN2IxNTIwY2Y3NThkYWNlN2YxJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.NDrJs0jysYDUQl3_YjlitqKx0ax1bFP8svBkCG3qNY0" data-canonical-src="https://private-user-images.githubusercontent.com/628387/517875041-ff033694-13e1-454e-b42b-b5c19e0fb2a0.mov?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjM5NTkxMDcsIm5iZiI6MTc2Mzk1ODgwNywicGF0aCI6Ii82MjgzODcvNTE3ODc1MDQxLWZmMDMzNjk0LTEzZTEtNDU0ZS1iNDJiLWI1YzE5ZTBmYjJhMC5tb3Y_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMTI0JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTEyNFQwNDMzMjdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT05OWIwOGY2ZThmYzI5ZDI4M2ZhZmU1NGE2YjgwMDE3NTYxMWUyNGU5OWNkYTNiN2IxNTIwY2Y3NThkYWNlN2YxJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.NDrJs0jysYDUQl3_YjlitqKx0ax1bFP8svBkCG3qNY0" controls="controls" muted="muted">

  </video>
</details>


<p dir="auto">See <code>man sc_auth</code> and <code>man ssh-keychain</code> for all the options</p>
<p dir="auto">To create a Secure Enclave backed key that requires biometrics, run the
following command and press TouchID:</p>
<pre><code>% sc_auth create-ctk-identity -l ssh -k p-256-ne -t bio
</code></pre>
<p dir="auto">You can confirm that the key was create with the <code>list-ctk-identities</code> command:</p>
<pre><code>arian@Mac ssh-keychain % sc_auth  list-ctk-identities       
Key Type Public Key Hash                          Prot Label Common Name Email Address Valid To        Valid 
p-256-ne A71277F0BC5825A7B3576D014F31282A866EF3BC bio  ssh   ssh                       23.11.26, 17:09 YES
</code></pre>
<p dir="auto">It also supports listing the ssh key fingerprints instead:</p>
<pre><code>% sc_auth  list-ctk-identities -t ssh
Key Type Public Key Hash                                    Prot Label Common Name Email Address Valid To        Valid 
p-256-ne SHA256:vs4ByYo+T9M3V8iiDYONMSvx2k5Fj2ujVBWt1j6yzis bio  ssh   ssh                       23.11.26, 17:09 YES 
</code></pre>
<p dir="auto">Keys can be deleted with</p>
<pre><code>% sc_auth delete-ctk-identity -h &lt;Public Key Hash&gt;
</code></pre>

<p dir="auto">You can &#34;download&#34; the public / private keypair from the secure enclave using the following command:</p>
<pre><code>% ssh-keygen -w /usr/lib/ssh-keychain.dylib -K -N &#34;&#34;
Enter PIN for authenticator: 
You may need to touch your authenticator to authorize key download.
Saved ECDSA-SK key to id_ecdsa_sk_rk
% cat id_ecdsa_sk_rk.pub 
sk-ecdsa-sha2-nistp256@openssh.com AAAAInNrLWVjZHNhLXNoYTItbmlzdHAyNTZAb3BlbnNzaC5jb20AAAAIbmlzdHAyNTYAAABBBKiHAiAZhcsZ95n85dkNGs9GnbDt0aNOia2gnuknYV2wKL3y0u+d3QrE9cFkmWXIymHZMglL+uJA+6mShY8SeykAAAAEc3NoOg== ssh:
</code></pre>
<p dir="auto">You can just use the empty string for PIN. For some reason <code>openssh</code> always asks for
it even if the authenticator in question does not use a PIN but a biometric.
Note that the &#34;private&#34; key here is just a reference to the FIDO credential. It does
not contain any secret key material. Hence I&#39;m specifiyng <code>-N &#34;&#34;</code> to skip an encryption
passphrase.</p>
<p dir="auto">Now if you copy this public key to your authorized keys file, it should work!</p>
<pre><code>% ssh-copy-id -i id_ecdsa_sk_rk localhost
% ssh -o SecurityKeyProvider=/usr/lib/ssh-keychain.dylib localhost
</code></pre>

<p dir="auto">Instead of downloading the public/private keypair to a file you can also directly
make the keys available to <code>ssh-agent</code>. For this you can use the following command:</p>
<pre><code>% ssh-add -K -S /usr/lib/ssh-keychain.dylib
Enter PIN for authenticator: 
Resident identity added: ECDSA-SK SHA256:vs4ByYo+T9M3V8iiDYONMSvx2k5Fj2ujVBWt1j6yzis
% ssh-add -L
sk-ecdsa-sha2-nistp256@openssh.com AAAAInNrLWVjZHNhLXNoYTItbmlzdHAyNTZAb3BlbnNzaC5jb20AAAAIbmlzdHAyNTYAAABBBKiHAiAZhcsZ95n85dkNGs9GnbDt0aNOia2gnuknYV2wKL3y0u+d3QrE9cFkmWXIymHZMglL+uJA+6mShY8SeykAAAAEc3NoOg== 
% ssh-copy-id localhost
% ssh -o SecurityKeyProvider=/usr/lib/ssh-keychain.dylib localhost
</code></pre>
<div dir="auto"><h2 dir="auto">Using the SecurityKeyProvider by default</h2><a id="user-content-using-the-securitykeyprovider-by-default" aria-label="Permalink: Using the SecurityKeyProvider by default" href="#using-the-securitykeyprovider-by-default"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>SecurityKeyProvider</code> can be configured in <code>.ssh/config</code> but I recommend setting
<code>export SSH_SK_PROVIDER=/usr/lib/ssh-keychain.dylib</code> in your <code>.zprofile</code> instead as
that environment variable gets picked up by <code>ssh</code>, <code>ssh-add</code> and <code>ssh-keygen</code>.</p>
<p dir="auto">This means you can just do:</p>
<pre><code>ssh-add -K
ssh my-server
</code></pre>
<p dir="auto">or</p>
<pre><code>ssh-keygen -K
ssh -i id_ecdsa_rk_sk my-server
</code></pre>
<p dir="auto">to ssh into your server</p>

<p dir="auto">There&#39;s also an exportable variant where the private key is encrypted using the secure enclave as opposed to generated on the secure enclave. This is might be considered less secure but is convenient for key backup.</p>
<pre><code>% sc_auth create-ctk-identity -l ssh-exportable -k p-256 -t bio
% sc_auth list-ctk-identities
p-256    A581E5404ED157C4C73FFDBDFC1339E0D873FCAE bio  ssh-exportable ssh-exportable               23.11.26, 19:50 YES  
% sc_auth export-ctk-identity -h A581E5404ED157C4C73FFDBDFC1339E0D873FCAE -f ssh-exportable.pem
Enter a password which will be used to protect the exported items:
Verify password:
</code></pre>
<p dir="auto">You can then re-import it on another device</p>
<pre><code>% sc_auth import-ctk-identities -f ssh-exportable.pem.p12 -t bio
Enter PKCS12 file password:
</code></pre>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
