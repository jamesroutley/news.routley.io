<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/jart/cosmopolitan/releases/tag/2.0">Original</a>
    <h1>Cosmopolitan Libc v2.0</h1>
    
    <div id="readability-page-1" class="page"><div data-pjax="true" data-test-selector="body-content" data-view-component="true"><p>Cosmopolitan Libc makes C/C++ a build-once run-anywhere language, like Java, except it doesn&#39;t need an interpreter or virtual machine. Instead, it reconfigures stock GCC to output a POSIX-approved polyglot format that runs natively on Linux + Mac + Windows + FreeBSD + OpenBSD + NetBSD + BIOS or UEFI with the best possible performance and the tiniest footprint imaginable.</p>
<h2>Getting Started</h2>
<p>If you use Linux, then you can build Cosmopolitan and its included software from source as follows:</p>
<div data-snippet-clipboard-copy-content="wget https://justine.lol/cosmopolitan/cosmopolitan-2.0.tar.gz
tar xf cosmopolitan-2.0.tar.gz
cd cosmopolitan
build/bootstrap/make.com -j8
o//examples/hello.com"><pre><code>wget https://justine.lol/cosmopolitan/cosmopolitan-2.0.tar.gz
tar xf cosmopolitan-2.0.tar.gz
cd cosmopolitan
build/bootstrap/make.com -j8
o//examples/hello.com
</code></pre></div>
<p>If you&#39;re doing your development work on Linux or BSD and you want to bring your own build system, then you need just five files to get started:</p>
<div data-snippet-clipboard-copy-content="wget https://justine.lol/cosmopolitan/cosmopolitan-amalgamation-2.0.zip
unzip cosmopolitan-amalgamation-2.0.zip
printf &#39;main() { printf(&#34;hello world\\n&#34;); }\n&#39; &gt;hello.c
gcc -g -Os -static -nostdlib -nostdinc -fno-pie -no-pie -mno-red-zone \
  -fno-omit-frame-pointer -pg -mnop-mcount -mno-tls-direct-seg-refs \
  -o hello.com.dbg hello.c -fuse-ld=bfd -Wl,-T,ape.lds -Wl,--gc-sections \
  -include cosmopolitan.h crt.o ape-no-modify-self.o cosmopolitan.a
objcopy -S -O binary hello.com.dbg hello.com"><pre>wget https://justine.lol/cosmopolitan/cosmopolitan-amalgamation-2.0.zip
unzip cosmopolitan-amalgamation-2.0.zip
<span>printf</span> <span><span>&#39;</span>main() { printf(&#34;hello world\\n&#34;); }\n<span>&#39;</span></span> <span>&gt;</span>hello.c
gcc -g -Os -static -nostdlib -nostdinc -fno-pie -no-pie -mno-red-zone \
  -fno-omit-frame-pointer -pg -mnop-mcount -mno-tls-direct-seg-refs \
  -o hello.com.dbg hello.c -fuse-ld=bfd -Wl,-T,ape.lds -Wl,--gc-sections \
  -include cosmopolitan.h crt.o ape-no-modify-self.o cosmopolitan.a
objcopy -S -O binary hello.com.dbg hello.com</pre></div>
<h2>Breaking Changes</h2>
<ul>
<li>You have to use <code>/zip/...</code> rather than <code>zip:...</code> when open()&#39;ing assets stored in the PKZIP structure of your executable program. <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/00611e9b06be11e8af3a05c5d60878377aa2b0bd/hovercard" href="https://github.com/jart/cosmopolitan/commit/00611e9b06be11e8af3a05c5d60878377aa2b0bd"><tt>00611e9</tt></a></li>
<li>You should use <code>/c/...</code> paths on Windows rather than <code>C:/...</code>. Your arguments and environment variables will be patched conservatively by the runtime to normalize <code>$PATH</code> and make life easy. It&#39;s still possible to use DOS, WIN32, NT, and other Microsoft-style paths with our APIs.</li>
<li>The default stack size has been reduced to 128kb. To learn how to increase this limit, or log your stack usage, please see <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/226aaf354786505e05283adfd52b43b668807336/hovercard" href="https://github.com/jart/cosmopolitan/commit/226aaf354786505e05283adfd52b43b668807336"><tt>226aaf3</tt></a></li>
<li>We renamed <code>LOGF</code> to <code>INFOF</code> in the logging API. <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/0584684a8202dbdfc2861a32bee3e73d0161a537/hovercard" href="https://github.com/jart/cosmopolitan/commit/0584684a8202dbdfc2861a32bee3e73d0161a537"><tt>0584684</tt></a></li>
<li>We no longer define <code>intmax_t</code> as 128-bit. We now violate the standard like everyone else, by defining it as 64-bit. We&#39;ve introduced a new <code>%jjd</code> formatting directive for <code>int128_t</code>. Functions like <code>bsrmax()</code> are now called <code>bsr128()</code>. <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/868af3f950c562baa1a73539703c6c78d51adceb/hovercard" href="https://github.com/jart/cosmopolitan/commit/868af3f950c562baa1a73539703c6c78d51adceb"><tt>868af3f</tt></a></li>
<li>We&#39;ve renamed <code>nothrow</code> to <code>dontthrow</code> and <code>nodiscard</code> is now <code>dontdiscard</code>. <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/868af3f950c562baa1a73539703c6c78d51adceb/hovercard" href="https://github.com/jart/cosmopolitan/commit/868af3f950c562baa1a73539703c6c78d51adceb"><tt>868af3f</tt></a></li>
<li>Remove undocumented and ANSI WIN32 APIs in <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/d3b599a79634d59eac64027fbebcf48553a299ce/hovercard" href="https://github.com/jart/cosmopolitan/commit/d3b599a79634d59eac64027fbebcf48553a299ce"><tt>d3b599a</tt></a> and <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/a157940ba61049420094a78829a062d57e78a44d/hovercard" href="https://github.com/jart/cosmopolitan/commit/a157940ba61049420094a78829a062d57e78a44d"><tt>a157940</tt></a></li>
</ul>
<h2>Features</h2>
<ul>
<li>We now favor the new <a href="https://justine.lol/apeloader/" rel="nofollow">APE loader</a> (see ape-no-modify-self.o). It&#39;s extracted automatically. It&#39;s fast. It maps your programs into memory without copying or self-modifying the header. An <code>--assimilate</code> flag is baked-in to the shell script at the tops of your binaries, so you can convert them to the platform-local format whenever you want. If you&#39;re using binfmt_misc then a separate <a href="https://justine.lol/pledge/#assimilate" rel="nofollow">assimilate program</a> is provided for doing just that. We also still distribute the classic ape.o bootloader.  <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/47a53e143b9baf1e25b7001dd377986f8fac2989/hovercard" href="https://github.com/jart/cosmopolitan/commit/47a53e143b9baf1e25b7001dd377986f8fac2989"><tt>47a53e1</tt></a></li>
<li>Binfmt_misc support for Linux users. This is the fastest way to run APE programs. You can install it by running the <code>ape/apeinstall.sh</code> program in this repository.</li>
<li>We&#39;ve polyfilled the OpenBSD pledge() and unveil() system calls for Linux. You can now use these APIs in your C/C++/Python/Redbean programs, or you can use the new <a href="https://justine.lol/pledge/" rel="nofollow">pledge.com command</a> to sandbox your existing Linux userspace.</li>
<li>We now use <a href="https://justine.lol/make/" rel="nofollow">Landlock Make</a> to build the repository, since it offers sandboxing and hermeticity guarantees. Our project will still build fine using vanilla GNU Make, since Landlock Make is backwards compatible.</li>
<li>We now offer support for threading that works on all six supported operating systems. Use the <a href="https://github.com/jart/cosmopolitan/blob/2.0/libc/thread/spawn.c"><code>_spawn()</code> and <code>_join()</code> functions</a>. We&#39;re working on POSIX Threads support and recommend using our new <code>pthread_mutex_lock</code> implementation. For examples of multi-threaded programs, see <a href="https://github.com/jart/cosmopolitan/blob/2.0/examples/greenbean.c">examples/greenbean.c</a> and <a href="https://github.com/jart/cosmopolitan/blob/2.0/tool/build/mkdeps.c">tool/build/mkdeps.c</a>.</li>
<li>You can now use the <code>_Thread_local</code> keyword. Your C runtime will now <a href="https://github.com/jart/cosmopolitan/blob/2.0/libc/runtime/enable_tls.c">always initialize Thread-Local Storage (TLS)</a> for your main process thread. Doing that means the minimum APE binary size had to be increased from 12kb to 16kb. We prefer using the <code>%fs</code> register. You must use the <code>-mno-tls-direct-seg-refs</code> flag. On Windows and Apple platforms, your executable will rewritten in memory at initialization to turn <code>%fs</code> opcodes into <code>%gs</code>. If you wish to control your segment registers, then you may do so by setting <code>__tls_enabled</code> to false and calling <code>arch_prctl</code>. Please note if you use threads, this will make <code>errno</code> no longer thread safe.</li>
<li>We now uniquely polyfill <code>mmap(MAP_STACK)</code> which brings the FreeBSD behavior to Linux. You must use it if you want your code to run on OpenBSD. Please see the <a href="https://justine.lol/cosmopolitan/documentation.html#mmap" rel="nofollow">mmap() documentation</a> to learn more.</li>
<li>The Cosmopolitan monolithic repository now offers the LLVM LIBCXX Standard Template Library for C++ developers. This is not currently available in the amalgamation.</li>
<li>Your Cosmopolitan binaries now include an <code>--ftrace</code> flag which logs C function calls to standard error. Please read the <a href="https://justine.lol/ftrace/" rel="nofollow">Logging C Functions</a> blog post which explains more. You need to use the <code>-pg</code> (and hopefully also <code>-mnop-mcount</code>) flag for this to work. If you don&#39;t want this functionality in your runtime, use <code>MODE=tiny</code> or <code>MODE=rel</code>.</li>
<li>Your Cosmopolitan binaries now include an <code>--strace</code> flag which logs system calls to standard error. This works consistently across platforms. It&#39;s especially helpful for ZIP-related system calls, which aren&#39;t handled by the kernel. Please read the <a href="https://justine.lol/ftrace/" rel="nofollow">Logging C Functions</a> blog post which explains more. If you don&#39;t want this functionality in your runtime, use <code>MODE=tiny</code> or <code>MODE=rel</code>. <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/14e192e5ba820c60fa4aef48c1a646b151723603/hovercard" href="https://github.com/jart/cosmopolitan/commit/14e192e5ba820c60fa4aef48c1a646b151723603"><tt>14e192e</tt></a></li>
<li>You can now use Actually Portable Python by building <code>o//third_party/python/python.com</code> which includes an <code>import cosmo</code> module that lets you use our best features too.</li>
<li>New <code>closefrom()</code> system call for Linux 5.9+, FreeBSD 8+, and OpenBSD.</li>
<li>The <code>clock_gettime</code> and <code>gettimeofday</code> functions now go 10x faster on Linux via the vDSO.</li>
<li>Our ASAN module is now able to trace the origin of memory allocations when generating reports.</li>
<li>Complex math functions are now available, thanks to Musl Libc.</li>
<li>Many math functions, e.g. pow(), now go faster, thanks to ARM.</li>
<li>New <code>nointernet()</code> function which is similar in spirit to djb&#39;s <code>disablenetwork()</code> function.</li>
<li>New string appending library. See appendd, appendf, appendr, appends, appendw, appendz, kappendf, kvappendf, and vappendf. What makes this library good is it&#39;s (a) fast, and (b) strings made by these functions can be passed to free().</li>
<li>We now offer a bulletproof unbreakable kprintf() family of functions as part of the <code>privileged</code> runtime.</li>
<li>SSL performance is now significantly improved. See <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/398f0c16fbdcd356bdfc14111434b0f0f8de7de5/hovercard" href="https://github.com/jart/cosmopolitan/commit/398f0c16fbdcd356bdfc14111434b0f0f8de7de5"><tt>398f0c1</tt></a> and <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/f3e28aa192d433c379b86df00d760d87da25a487/hovercard" href="https://github.com/jart/cosmopolitan/commit/f3e28aa192d433c379b86df00d760d87da25a487"><tt>f3e28aa</tt></a> and similar changes where we&#39;ve added x86 optimizations for computing SHA faster, Intel ADX code that makes RSA multiplication faster, clean up code to make <a href="https://github.com/jart/cosmopolitan/blob/2.0/third_party/mbedtls/everest.c">Everest curve25519</a> faster, and wrote an assembly implementation of NIST curve quasi-reduction.</li>
</ul>
<h2>Bug Fixes</h2>
<ul>
<li>Fork on Windows now works reliably <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/0cb6b6ff4b34a3503cd899ccbb12538a58d73b49/hovercard" href="https://github.com/jart/cosmopolitan/commit/0cb6b6ff4b34a3503cd899ccbb12538a58d73b49"><tt>0cb6b6f</tt></a> <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/98909b13913c80e9c61035d1fe371f4a6bed9edb/hovercard" href="https://github.com/jart/cosmopolitan/commit/98909b13913c80e9c61035d1fe371f4a6bed9edb"><tt>98909b1</tt></a> <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/e5314dedde3553973a3e8692ffec7a65a6be6d20/hovercard" href="https://github.com/jart/cosmopolitan/commit/e5314dedde3553973a3e8692ffec7a65a6be6d20"><tt>e5314de</tt></a></li>
<li>Memory maps on Windows now work reliably</li>
<li>Signals on Windows now works well enough for Redbean to offer a web server with a repl <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/072e1d29109f835a592a7e4edf53898fcea7ae88/hovercard" href="https://github.com/jart/cosmopolitan/commit/072e1d29109f835a592a7e4edf53898fcea7ae88"><tt>072e1d2</tt></a></li>
<li>Fix %c with nul character <a data-hovercard-type="commit" data-hovercard-url="https://github.com/jart/cosmopolitan/commit/3c285337a26bd4ca64a3d4297a00a064a29dc27a/hovercard" href="https://github.com/jart/cosmopolitan/commit/3c285337a26bd4ca64a3d4297a00a064a29dc27a"><tt>3c28533</tt></a></li>
<li>There&#39;s been a lot of fixes and fine tuning to the system call support magnums in <a href="https://github.com/jart/cosmopolitan/blob/2.0/libc/sysv/consts.sh">consts.sh</a> and <a href="https://github.com/jart/cosmopolitan/blob/2.0/libc/sysv/syscalls.sh">syscalls.sh</a></li>
<li>Many system call polyfills have been improved, e.g. sysinfo, statfs, pselect, ppoll, sleep, sched_yield, utimensat, setsockopt, clock_gettime, sigsuspend, etc.</li>
<li>We now polyfill ENOENT vs. ENOTDIR on Windows</li>
<li>Daemonization now works on Windows</li>
</ul></div></div>
  </body>
</html>
