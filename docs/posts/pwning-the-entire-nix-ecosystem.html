<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ptrpa.ws/nixpkgs-actions-abuse">Original</a>
    <h1>Pwning the Entire Nix Ecosystem</h1>
    
    <div id="readability-page-1" class="page"><section><time datetime="2025-09-11T00:00:00+02:00">Sep 11, 2025 - 5 &#39; read</time><span> <a href="https://ptrpa.ws/tag/nixpkgs">nixpkgs</a>, <a href="https://ptrpa.ws/tag/nix">nix</a>, <a href="https://ptrpa.ws/tag/github-actions">github-actions</a>, <a href="https://ptrpa.ws/tag/vulnerability">vulnerability</a></span><p>last year at nixcon, me and <a href="https://mastodon.catgirl.cloud/@49016">my friend lexi</a> gave <a href="https://ptrpa.ws/youtube.com/live/_7wqXN-7ebw?t=38450s">a lightning talk</a> about how we found a vulnerability in nixpkgs that would have allowed us to pwn pretty much the entire nix ecosystem and inject malicious code into nixpkgs. it only took us about a day from starting our search to reporting it and getting it fixed. since i unfortunately was too sick to attend this years nixcon, i thought it might be a good time to write up what we found and how we did it.</p><h2 id="github-actions-the-easy-target"> github actions: the easy target <a href="#github-actions-the-easy-target">#</a></h2><p>github actions is a ci/cd system by github that can do pretty much anything in a repo. it’s an easy target for attackers because if you have access to a workflow, you can just commit code without authorization and then you have a supply chain attack. plus, it’s all written in yaml <a href="https://ruudvanasseldonk.com/2023/01/11/the-yaml-document-from-hell">🇳🇴</a>, which was NEVER meant to be executed !!</p><div><div><pre><code><span>name</span><span>:</span> <span>learn-github-actions</span>
<span>on</span><span>:</span> <span>[</span><span>push</span><span>]</span>
<span>jobs</span><span>:</span>
  <span>check-bats-version</span><span>:</span>
    <span>runs-on</span><span>:</span> <span>ubuntu-latest</span>
    <span>steps</span><span>:</span>
      <span>-</span> <span>uses</span><span>:</span> <span>actions/checkout@v4</span>
      <span>-</span> <span>uses</span><span>:</span> <span>actions/setup-node@v4</span>
      <span>-</span> <span>run</span><span>:</span> <span>npm install -g bats</span>
      <span>-</span> <span>run</span><span>:</span> <span>bats -v</span>
</code></pre></div></div><p>this is a simple example of a github action. nothing fancy, just running some commands when code is pushed.</p><h2 id="the-dangerous-pull_request_target"> the dangerous pull_request_target <a href="#the-dangerous-pull_request_target">#</a></h2><p>actions run when a trigger activates them. there are a bunch of different triggers like pushes, commits, or pull requests. but there’s a special one called <code>pull_request_target</code> that has a few critical differences from regular <code>pull_request</code>.</p><p>crucially, unlike <code>pull_request</code>, <code>pull_request_target</code> has read/write and secret access by default, even on pull requests from forks. this isn’t vulnerable by itself, but things go south when you start trusting user input from those PRs.</p><p>github even warns about this in their docs:</p><blockquote><p>Warning: For workflows that are triggered by the <code>pull_request_target</code> event, the <code>GITHUB_TOKEN</code> is granted read/write repository permission unless the <code>permissions</code> key is specified and the workflow can access secrets, even when it is triggered from a fork.</p></blockquote><p>so we started looking for workflows in nixpkgs that use <code>pull_request_target</code> and found 14 files. some of them were secure, like this labeler example:</p><div><div><pre><code><span>name</span><span>:</span> <span>&#34;</span><span>Label</span><span> </span><span>PR&#34;</span>
<span>on</span><span>:</span>
  <span>pull_request_target</span><span>:</span>
<span>jobs</span><span>:</span>
  <span>labels</span><span>:</span>
    <span>runs-on</span><span>:</span> <span>ubuntu-latest</span>
    <span>steps</span><span>:</span>
      <span>-</span> <span>uses</span><span>:</span> <span>actions/labeler@8558fd74291d67161a8a</span>
        <span>with</span><span>:</span>
          <span>repo-token</span><span>:</span> <span>$</span>
</code></pre></div></div><p>this is safe because it just passes the token to a trusted action. but then we found some more interesting ones…</p><h2 id="the-editorconfig-vulnerability"> the editorconfig vulnerability <a href="#the-editorconfig-vulnerability">#</a></h2><p>the first vulnerable workflow we found was for checking editorconfig rules. here’s a simplified version of what it was doing:</p><div><div><pre><code><span>steps</span><span>:</span>
  <span>-</span> <span>name</span><span>:</span> <span>Get list of changed files from PR</span>
    <span>run</span><span>:</span> <span>gh api [...] | jq [ ... ] &gt; &#34;$HOME/changed_files&#34;</span>
  <span>-</span> <span>uses</span><span>:</span> <span>actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871</span>
    <span>with</span><span>:</span>
      <span>ref</span><span>:</span> <span>refs/pull/$/merge</span>
  <span>-</span> <span>name</span><span>:</span> <span>Checking EditorConfig</span>
    <span>run</span><span>:</span> <span>cat &#34;$HOME/changed_files&#34; | xargs -r editorconfig-checker</span>
</code></pre></div></div><p>the workflow would:</p><ol><li>get a list of files changed in the PR</li><li>checkout the PR code</li><li>run editorconfig-checker on those files</li></ol><p>the problem? it was using <code>xargs</code> to pass the filenames to editorconfig-checker. if you’ve read the <a href="https://man7.org/linux/man-pages/man1/xargs.1.html#:~:text=It%20is%20not%20possible%20for%20xargs%20to%20be%20used%20securely">man page for xargs</a>, you’ll see this warning:</p><blockquote><p>It is not possible for xargs to be used securely</p></blockquote><p>basically, we could create a file with a name that’s actually a command line argument. for example, if we added a file called <code>--help</code> to our PR, when the workflow ran <code>cat &#34;$HOME/changed_files&#34; | xargs -r editorconfig-checker</code>, the filename would be passed as an argument to editorconfig-checker, causing it to print its help message instead of checking files.</p><p><img src="https://ptrpa.ws/assets/images/posts/editor-config-run.png" alt="editor config run with help output"/></p><p>this is a classic command injection vulnerability. we didn’t take it further to try to execute arbitrary code since editorconfig-checker is written in go and we’d need to audit it more deeply, but it’s most likely possible.</p><h2 id="the-code-owners-vulnerability-local-file-inclusion"> the code owners vulnerability: local file inclusion <a href="#the-code-owners-vulnerability-local-file-inclusion">#</a></h2><p>the second vulnerable workflow we found was even more serious. it was checking the CODEOWNERS file in PRs:</p><div><div><pre><code><span>steps</span><span>:</span>
  <span>-</span> <span>uses</span><span>:</span> <span>actions/checkout@eef61447b9ff4aafe5dcd4e0bbf</span>
    <span>with</span><span>:</span>
      <span>ref</span><span>:</span> <span>refs/pull/$/merge</span>
      <span>path</span><span>:</span> <span>pr</span>
  <span>-</span> <span>run</span><span>:</span> <span>nix-build base/ci -A codeownersValidator</span>
  <span>-</span> <span>run</span><span>:</span> <span>result/bin/codeowners-validator</span>
    <span>env</span><span>:</span>
      <span>OWNERS_FILE</span><span>:</span> <span>pr/ci/OWNERS</span>
</code></pre></div></div><p>the workflow would:</p><ol><li>checkout the PR code</li><li>build the codeowners validator</li><li>run the validator on the OWNERS file from the PR</li></ol><p>the validator would echo the contents of the OWNERS file if there was an error. this meant we could put whatever we wanted in that file and it would get printed in the logs.</p><p>but it gets worse. since the workflow was checking out our PR code, we could replace the OWNERS file with a symbolic link to ANY file on the runner. like, say, the github actions credentials file:</p><div><div><pre><code><span>$ </span><span>rm </span>OWNERS
<span>$ </span><span>ln</span> <span>-s</span> /home/runner/runners/2.320.0/.credentials OWNERS
</code></pre></div></div><p>when the validator ran, it would try to read our symlinked file and helpfully print out an error message containing the first line:</p><p><img src="https://ptrpa.ws/assets/images/posts/codeowners-error.png" alt="screenshot of error message including censored token"/></p><p>and just like that, we had a github actions token with read/write access to nixpkgs. this would let us push directly to nixpkgs, bypassing all the normal review processes.</p><h2 id="the-fix"> the fix <a href="#the-fix">#</a></h2><p>after we found these vulnerabilities, we reported them to the nixpkgs maintainers, in this case infinisil, who immediately took action:</p><ol><li>they disabled the vulnerable workflows in the repos action settings</li><li>they fixed the vulnerabilities by properly separating untrusted data from privileged operations</li><li>they renamed the fixed workflows after the security fixes, this is because of another pitfall with <code>pull_request_target</code> allowing you to target any branch the action is on, even if it’s 5 or 10 years old as long as it hasn’t been disabled.</li></ol><p>the key lessons from this:</p><ul><li>avoid mixing untrusted data and secrets, or be very careful with them</li><li>only allow the permissions you really need</li><li>read the docs about permissions very carefully</li></ul><p>if you think your org has vulnerable github actions, you can use the panic button too:</p><ul><li>go to your org at https://github.com/[org]</li><li>go to the “Settings” tab</li><li>go to “Actions” → “General” section</li><li>under “Policies”, switch “All repositories” to “Disable”</li></ul><h2 id="conclusion"> conclusion <a href="#conclusion">#</a></h2><p>it only took us about a day to find, report, and help fix a vulnerability that could have compromised the entire nix ecosystem. this shows how important it is to be careful with github actions, especially when dealing with <code>pull_request_target</code>.</p><p>big thanks to intrigus and everyone at KITCTF (intrigus gave <a href="https://kitctf.de/learning/insecure-github-actions">a talk about exactly these issues</a> that taught us how this works), and thanks to infinisil for fixing this on the same day we reported it.</p><p>if you want to learn more, check out these resources:</p><ul><li><a href="https://kitctf.de/talks/2023-10-26-insecure-github-actions/insecure-github-actions.pdf]">https://kitctf.de/talks/2023-10-26-insecure-github-actions/insecure-github-actions.pdf</a></li><li><a href="https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/">https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/</a></li><li><a href="https://github.com/NixOS/nixpkgs/pull/351446">https://github.com/NixOS/nixpkgs/pull/351446</a></li></ul><p>also, if you’re curious, you can watch <a href="https://youtube.com/live/_7wqXN-7ebw?t=38450s">our original lightning talk</a> from nixcon</p><p>anyway that’s all. stay safe with your github actions. meow :3</p></section></div>
  </body>
</html>
