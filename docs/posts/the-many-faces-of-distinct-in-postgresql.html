<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://hakibenita.com/the-many-faces-of-distinct-in-postgre-sql">Original</a>
    <h1>The Many Faces of Distinct in PostgreSQL</h1>
    
    <div id="readability-page-1" class="page"><article data-progress-indicator="">
        <hr/>
<p>I started my programming career as an Oracle DBA. It took a few years but eventually I got fed up with the corporate world and I went about doing my own thing.</p>
<p>When I no longer had the comfy cushion of Oracle enterprise edition I discovered PostgreSQL. After I gotten over not having proper partitions and MERGE statement (aka UPSERT), I found some nice unique features in PostgreSQL. Oddly enough, a lot of them contained the word DISTINCT.</p>
<h3 id="distinct"><a href="#distinct">DISTINCT</a></h3>
<p>I created a simple Employee table with name, department and salary using mock data from <a href="https://www.mockaroo.com/" rel="noopener">this site</a>:</p>
<div><pre><span></span><span>haki=#</span> <span>\d</span> <span>employee</span>

<span>    Column   |         Type          | Modifiers</span>
<span>------------+-----------------------+-----------</span>
<span>    id         | integer               | not null</span>
<span>    name       | character varying(30) |</span>
<span>    department | character varying(30) |</span>
<span>    salary     | integer               |</span>

<span>haki=#</span> <span>select</span> <span>*</span> <span>from</span> <span>employee</span> <span>limit</span> <span>5</span><span>;</span>

<span>    id |      name      |      department      | salary</span>
<span>----+----------------+----------------------+--------</span>
<span>    1 | Carl Frazier   | Engineering          |   3052</span>
<span>    2 | Richard Fox    | Product Management   |  13449</span>
<span>    3 | Carolyn Carter | Engineering          |   8366</span>
<span>    4 | Benjamin Brown | Business Development |   7386</span>
<span>    5 | Diana Fisher   | Services             |  10419</span>
</pre></div>


<h4 id="what-is-distinct"><a href="#what-is-distinct">What is DISTINCT?</a></h4>
<blockquote>
<p>SELECT DISTINCT eliminates duplicate rows from the result.</p>
</blockquote>
<p>The simplest use of distinct is, for example, to get a unique list of
departments:</p>
<div><pre><span></span><span>haki=#</span> <span>SELECT</span> <span>DISTINCT</span> <span>department</span> <span>FROM</span> <span>employee</span><span>;</span>

<span>        department</span>
<span>--------------------------</span>
<span>    Services</span>
<span>    Support</span>
<span>    Training</span>
<span>    Accounting</span>
<span>    Business Development</span>
<span>    Marketing</span>
<span>    Product Management</span>
<span>    Human Resources</span>
<span>    Engineering</span>
<span>    Sales</span>
<span>    Research and Development</span>
<span>    Legal</span>
</pre></div>


<p><em>(easy CS students, I know it&#39;s not normalized…)</em></p>
<p>We can do the same thing with group by</p>
<div><pre><span></span><span>SELECT</span> <span>department</span> <span>FROM</span> <span>employee</span> <span>GROUP</span> <span>BY</span> <span>department</span><span>;</span>
</pre></div>


<p>But we are talking about DISTINCT.</p>
<hr/>
<h3 id="distinct-on"><a href="#distinct-on">DISTINCT ON</a></h3>
<p>A classic job interview question is <strong>finding the employee with the highest salary in each department</strong>.</p>
<p>This is what they teach in the university:</p>
<div><pre><span></span><span>haki=#</span> <span>SELECT</span>
    <span>*</span>
<span>FROM</span>
    <span>employee</span>
<span>WHERE</span>
    <span>(</span><span>department</span><span>,</span> <span>salary</span><span>)</span> <span>IN</span> <span>(</span>
        <span>SELECT</span>
            <span>department</span><span>,</span>
            <span>MAX</span><span>(</span><span>salary</span><span>)</span>
        <span>FROM</span>
            <span>employee</span>
        <span>GROUP</span> <span>BY</span>
            <span>department</span>
    <span>)</span>
<span>ORDER</span> <span>BY</span>
    <span>department</span><span>;</span>

<span> id |       name       |        department        | salary</span>
<span>----+------------------+--------------------------+--------</span>
<span> 30 | Sara Roberts     | Accounting               |  13845</span>
<span>  4 | Benjamin Brown   | Business Development     |   7386</span>
<span>  3 | Carolyn Carter   | Engineering              |   8366</span>
<span> 20 | Janet Hall       | Human Resources          |   2826</span>
<span><span> 14 | Chris Phillips   | Legal                    |   3706</span>
</span><span><span> 10 | James Cunningham | Legal                    |   3706</span>
</span><span> 11 | Richard Bradley  | Marketing                |  11272</span>
<span>  2 | Richard Fox      | Product Management       |  13449</span>
<span> 25 | Evelyn Rodriguez | Research and Development |  10628</span>
<span> 17 | Benjamin Carter  | Sales                    |   6197</span>
<span> 24 | Jessica Elliott  | Services                 |  14542</span>
<span>  7 | Bonnie Robertson | Support                  |  12674</span>
<span>  8 | Jean Bailey      | Training                 |  13230</span>
</pre></div>


<p><strong>Legal</strong> has two employees with the same high salary. Depending on the use case, this query can get pretty nasty.</p>
<p>If you graduated a while back, you already know a few things about databases and you heard about<strong> <a href="https://www.postgresql.org/docs/9.5/static/functions-window.html" rel="noopener">analytic and window functions</a></strong>, you might do this:</p>
<div><pre><span></span><span>WITH</span> <span>ranked_employees</span> <span>AS</span> <span>(</span>
    <span>SELECT</span>
<span>        <span>ROW_NUMBER</span><span>()</span> <span>OVER</span> <span>(</span>
</span><span>           <span>PARTITION</span> <span>BY</span> <span>department</span> <span>ORDER</span> <span>BY</span> <span>salary</span> <span>DESC</span>
</span><span>        <span>)</span> <span>AS</span> <span>rn</span><span>,</span>
</span>        <span>*</span>
    <span>FROM</span>
        <span>employee</span>
<span>)</span>
<span>SELECT</span>
    <span>*</span>
<span>FROM</span>
    <span>ranked_employees</span>
<span>WHERE</span>
<span>    <span>rn</span> <span>=</span> <span>1</span>
</span><span>ORDER</span> <span>BY</span>
    <span>department</span><span>;</span>
</pre></div>


<p>The result is the same without the duplicates:</p>
<div><pre><span></span> <span>rn</span> <span>|</span> <span>id</span> <span>|</span>       <span>name</span>       <span>|</span>        <span>department</span>        <span>|</span> <span>salary</span>
<span>----+----+------------------+--------------------------+--------</span>
  <span>1</span> <span>|</span> <span>30</span> <span>|</span> <span>Sara</span> <span>Roberts</span>     <span>|</span> <span>Accounting</span>               <span>|</span>  <span>13845</span>
  <span>1</span> <span>|</span>  <span>4</span> <span>|</span> <span>Benjamin</span> <span>Brown</span>   <span>|</span> <span>Business</span> <span>Development</span>     <span>|</span>   <span>7386</span>
  <span>1</span> <span>|</span>  <span>3</span> <span>|</span> <span>Carolyn</span> <span>Carter</span>   <span>|</span> <span>Engineering</span>              <span>|</span>   <span>8366</span>
  <span>1</span> <span>|</span> <span>20</span> <span>|</span> <span>Janet</span> <span>Hall</span>       <span>|</span> <span>Human</span> <span>Resources</span>          <span>|</span>   <span>2826</span>
  <span>1</span> <span>|</span> <span>14</span> <span>|</span> <span>Chris</span> <span>Phillips</span>   <span>|</span> <span>Legal</span>                    <span>|</span>   <span>3706</span>
  <span>1</span> <span>|</span> <span>11</span> <span>|</span> <span>Richard</span> <span>Bradley</span>  <span>|</span> <span>Marketing</span>                <span>|</span>  <span>11272</span>
<span>...</span>
</pre></div>


<p>Up until now, this is what I would have done.</p>
<p>Now for the real treat, PostgreSQL has a <strong>special nonstandard clause to find the first row in a group</strong>:</p>
<div><pre><span></span><span>SELECT</span> <span>DISTINCT</span> <span>ON</span> <span>(</span><span>department</span><span>)</span>
    <span>*</span>
<span>FROM</span>
    <span>employee</span>
<span>ORDER</span> <span>BY</span>
    <span>department</span><span>,</span>
    <span>salary</span> <span>DESC</span><span>;</span>
</pre></div>


<figure><img alt="This is wild!" src="https://hakibenita.com/images/01-the-many-faces-of-distinct-in-postgresql.png"/><figcaption>This is wild!</figcaption>
</figure>
<p><strong>This is wild! Why nobody told me this is possible?</strong></p>
<p><a href="https://www.postgresql.org/docs/current/static/sql-select.html#SQL-DISTINCT" rel="noopener">The docs</a> explain DISTINCT ON:</p>
<blockquote>
<p><em>SELECT DISTINCT ON ( expression [, …] ) keeps only the first row of each set of
rows where the given expressions evaluate to equal</em></p>
</blockquote>
<p>And the reason I haven&#39;t heard about it is:</p>
<blockquote>
<p>Nonstandard Clauses</p>
</blockquote>
<p>PostgreSQL does all the heavy lifting for us. The only requirement is that we ORDER BY the field we group by (<code>department</code> in this case). It also allows for &#34;grouping&#34; by more than one field which only makes this clause even more powerful.</p>
<hr/>
<h3 id="is-distinct-from"><a href="#is-distinct-from">IS DISTINCT FROM</a></h3>
<p>Comparing values in SQL can result in three outcomes - <code>true</code>, <code>false</code> or <code>unknown</code>:</p>
<div><pre><span></span><span>WITH</span> <span>t</span> <span>AS</span> <span>(</span>
    <span>SELECT</span> <span>1</span> <span>AS</span> <span>a</span><span>,</span> <span>1</span> <span>AS</span> <span>b</span> <span>UNION</span> <span>ALL</span>
    <span>SELECT</span> <span>1</span><span>,</span> <span>2</span> <span>UNION</span> <span>ALL</span>
    <span>SELECT</span> <span>NULL</span><span>,</span> <span>1</span> <span>UNION</span> <span>ALL</span>
    <span>SELECT</span> <span>NULL</span><span>,</span> <span>NULL</span>
<span>)</span>
<span>SELECT</span>
    <span>a</span><span>,</span>
    <span>b</span><span>,</span>
<span>    <span>a</span> <span>=</span> <span>b</span> <span>as</span> <span>equal</span>
</span><span>FROM</span>
    <span>t</span><span>;</span>

  <span>a</span>   <span>|</span>  <span>b</span>   <span>|</span> <span>equal</span>
<span>------+------+-------</span>
    <span>1</span> <span>|</span>    <span>1</span> <span>|</span> <span>t</span>
    <span>1</span> <span>|</span>    <span>2</span> <span>|</span> <span>f</span>
 <span>NULL</span> <span>|</span>    <span>1</span> <span>|</span> <span>NULL</span>
 <span>NULL</span> <span>|</span> <span>NULL</span> <span>|</span> <span>NULL</span>
</pre></div>


<p>The result of comparing NULL with NULL using equality (=) is UNKNOWN (marked as NULL in the table).</p>
<p><strong>In SQL 1 = 1 and NULL IS NULL but NULL != NULL.</strong></p>
<p>It&#39;s important to be aware of this subtlety because <strong>comparing nullable fields might yield unexpected results</strong>.</p>
<p>The full condition to get either true or false when comparing nullable fields is:</p>
<div><pre><span></span><span>(</span><span>a</span> <span>is</span> <span>null</span> <span>and</span> <span>b</span> <span>is</span> <span>null</span><span>)</span>
<span>or</span>
<span>(</span><span>a</span> <span>is</span> <span>not</span> <span>null</span> <span>and</span> <span>b</span> <span>is</span> <span>not</span> <span>null</span> <span>and</span> <span>a</span> <span>=</span> <span>b</span><span>)</span>
</pre></div>


<p>And the result:</p>
<div><pre><span></span>  <span>a</span>   <span>|</span>  <span>b</span>   <span>|</span> <span>equal</span> <span>|</span> <span>full_condition</span>
<span>------+------+-------+----------</span>
    <span>1</span> <span>|</span>    <span>1</span> <span>|</span> <span>t</span>     <span>|</span> <span>t</span>
    <span>1</span> <span>|</span>    <span>2</span> <span>|</span> <span>f</span>     <span>|</span> <span>f</span>
 <span>NULL</span> <span>|</span>    <span>1</span> <span>|</span> <span>NULL</span>  <span>|</span> <span>f</span>
 <span>NULL</span> <span>|</span> <span>NULL</span> <span>|</span> <span>NULL</span>  <span>|</span> <span>t</span>
</pre></div>


<p>This is the result we want but it is very long. <strong>Is there a better way?</strong></p>
<p>PostgreSQL implements the SQL standard for safely comparing nullable fields:</p>
<div><pre><span></span><span>haki=#</span> <span>SELECT</span>
    <span>a</span><span>,</span>
    <span>b</span><span>,</span>
    <span>a</span> <span>=</span> <span>b</span> <span>as</span> <span>equal</span><span>,</span>
<span>    <span>a</span> <span>IS</span> <span>DISTINCT</span> <span>FROM</span> <span>b</span> <span>AS</span> <span>is_distinct_from</span>
</span><span>FROM</span>
    <span>t</span><span>;</span>

<span>  a   |  b   | equal | is_distinct_from</span>
<span>------+------+-------+------------------</span>
<span>    1 |    1 | t     | f</span>
<span>    1 |    2 | f     | t</span>
<span> NULL |    1 | NULL  | t</span>
<span> NULL | NULL | NULL  | f</span>
</pre></div>


<p>PostgreSQL wiki explain <code>IS DISTINCT FROM</code>:</p>
<blockquote>
<p><strong>IS DISTINCT FROM<strong><em> and </em></strong>IS NOT DISTINCT FROM …</strong><em> treat NULL as if it was a
known value, rather than a special case for unknown.</em></p>
</blockquote>
<p>Much better - short and verbose.</p>
<h4 id="how-other-databases-handle-this"><a href="#how-other-databases-handle-this">How Other Databases Handle This?</a></h4>
<ul>
<li><strong>MySQL</strong> - A <a href="https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#operator_equal-to" rel="noopener">special operator</a> <code>&lt;=&gt;</code> with similar functionality.</li>
<li><strong>Oracle</strong> - Provides a function called <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14200/functions078.htm" rel="noopener">LNNVL</a> to compare nullable fields (good luck with that…).</li>
<li><strong>MSSQL</strong> - Couldn&#39;t find a similar function.</li>
</ul>
<hr/>
<h3 id="array_agg-distinct"><a href="#array_agg-distinct">ARRAY_AGG (DISTINCT)</a></h3>
<p><code>ARRAY_AGG</code> was one of the major selling points of PostgreSQL when I was
transitioning from Oracle.</p>
<p><code>ARRAY_AGG</code> aggregates values into an array:</p>
<div><pre><span></span><span>haki=#</span> <span>SELECT</span>
    <span>department</span><span>,</span>
    <span>ARRAY_AGG</span><span>(</span><span>name</span><span>)</span> <span>AS</span> <span>employees</span>
<span>FROM</span>
    <span>employee</span>
<span>GROUP</span> <span>BY</span>
    <span>department</span><span>;</span>

<span>    department        |        employees</span>
<span>----------------------+-------------------------------------</span>
<span>Services              | {&#34;Diana Fisher&#34;,&#34;Jessica Elliott&#34;}</span>
<span>Support               | {&#34;Bonnie Robertson&#34;}</span>
<span>Training              | {&#34;Jean Bailey&#34;}</span>
<span>Accounting            | {&#34;Phillip Reynolds&#34;,&#34;Sean Franklin&#34;}</span>
<span>Business Development  | {&#34;Benjamin Brown&#34;,&#34;Brian Hayes&#34;}</span>
<span>Marketing             | {&#34;Richard Bradley&#34;,&#34;Arthur Moreno&#34;}</span>
<span>Product Management    | {&#34;Richard Fox&#34;,&#34;Randy Wells&#34;}</span>
<span>Human Resources       | {&#34;Janet Hall&#34;}</span>
<span>Engineering           | {&#34;Carl Frazier&#34;,&#34;Carolyn Carter&#34;}</span>
<span>Sales                 | {&#34;Benjamin Carter&#34;}</span>
<span>Research and Develo.. | {&#34;Donna Reynolds&#34;,&#34;Ann Boyd&#34;}</span>
<span>Legal                 | {&#34;James Cunningham&#34;,&#34;George Hanson&#34;}</span>
</pre></div>


<p>I find <code>ARRAY_AGG</code> useful mostly in the CLI for getting a quick view of the data, or when used with an ORM.</p>
<p>PostgreSQL took it the extra mile and implemented the DISTINCT option for this aggregate function as well. Using DISTINCT we can, for example, quickly view the unique salaries in each department:</p>
<div><pre><span></span><span>haki=#</span> <span>SELECT</span>
    <span>department</span><span>,</span>
    <span>ARRAY_AGG</span><span>(</span><span>DISTINCT</span> <span>salary</span><span>)</span> <span>AS</span> <span>salaries</span>
<span>FROM</span>
    <span>employee</span>
<span>GROUP</span> <span>BY</span>
    <span>department</span><span>;</span>

<span>department                | salaries</span>
<span>--------------------------+---------------</span>
<span> Accounting               | {11203}</span>
<span> Business Development     | {2196,7386}</span>
<span> Engineering              | {1542,3052}</span>
<span> Human Resources          | {2826}</span>
<span> Legal                    | {1079,3706}</span>
<span> Marketing                | {5740}</span>
<span> Product Management       | {9101,13449}</span>
<span> Research and Development | {6451,10628}</span>
<span> Sales                    | {6197}</span>
<span> Services                 | {2119}</span>
<span> Support                  | {12674}</span>
<span> Training                 | {13230}</span>
</pre></div>


<p>We can immediately see that everyone in the support department are making the same salary.</p>
<h4 id="how-other-databases-handle-this_1"><a href="#how-other-databases-handle-this_1">How Other Databases Handle This?</a></h4>
<ul>
<li><strong>MySQL</strong> - Has a similar function called <a href="https://dev.mysql.com/doc/refman/5.6/en/group-by-functions.html#function_group-concat" rel="noopener">GROUP_CONCAT</a>.</li>
<li><strong>Oracle</strong> - Has an aggregate function called <a href="https://docs.oracle.com/cd/E11882_01/server.112/e41084/functions089.htm#SQLRF30030" rel="noopener">ListAgg</a>. It has no support for DISTINCT. Oracle introduced the function in version 11.2 and up until then the world wide web was filled with custom implementations.</li>
<li><strong>MsSQL</strong> - The closest I found was a function called <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/stuff-transact-sql" rel="noopener">STUFF</a> that accepts an expression.</li>
</ul>
<hr/>
<h3 id="take-away"><a href="#take-away">Take away</a></h3>
<p>The take away from this article is that you should always go back to the basics!</p>
    </article></div>
  </body>
</html>
