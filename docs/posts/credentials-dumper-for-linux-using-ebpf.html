<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/citronneur/pamspy">Original</a>
    <h1>Show HN: Credentials dumper for Linux using eBPF</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><code>pamspy</code> leverage eBPF technologies to achieve an equivalent work of <a href="https://github.com/blendin/3snake">3snake</a>.</p>
<p dir="auto">It will track a particular userland function inside the PAM (Pluggable Authentication Modules) library, used by many critical applications to handle authentication like:</p>
<ul dir="auto">
<li>sudo</li>
<li>sshd</li>
<li>passwd</li>
<li>gnome</li>
<li>x11</li>
<li>and many other ...</li>
</ul>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://0x539.lol/citronneur/pamspy/blob/main/.img/pamspy.gif"><img src="https://0x539.lol/citronneur/pamspy/raw/main/.img/pamspy.gif" alt="Demo" data-animated-image=""/></a></p>
<h2 dir="auto"><a id="user-content-how-to-launch" aria-hidden="true" href="#how-to-launch"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How to launch?</h2>
<p dir="auto"><code>pamspy</code> is built as a static binary without any dependencies, and available on the <a href="https://github.com/citronneur/pamspy/releases/">release</a> page.</p>
<div data-snippet-clipboard-copy-content="Usage: pamspy [OPTION...]
pamspy

Uses eBPF to dump secrets use by PAM (Authentication) module
By hooking the pam_get_authtok function in libpam.so

USAGE: ./pamspy -p $(/usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4) -d /var/log/trace.0

  -d, --daemon=PATH TO OUTPUT CREDENTIALS
                             Start pamspy in daemon mode and output in the file
                             passed as argument
  -p, --path=PATH            Path to the libpam.so file
  -r, --print-headers        Print headers of the program
  -v, --verbose              Verbose mode
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version

Mandatory or optional arguments to long options are also mandatory or optional
for any corresponding short options.

Report bugs to .
"><pre><code>Usage: pamspy [OPTION...]
pamspy

Uses eBPF to dump secrets use by PAM (Authentication) module
By hooking the pam_get_authtok function in libpam.so

USAGE: ./pamspy -p $(/usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4) -d /var/log/trace.0

  -d, --daemon=PATH TO OUTPUT CREDENTIALS
                             Start pamspy in daemon mode and output in the file
                             passed as argument
  -p, --path=PATH            Path to the libpam.so file
  -r, --print-headers        Print headers of the program
  -v, --verbose              Verbose mode
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version

Mandatory or optional arguments to long options are also mandatory or optional
for any corresponding short options.

Report bugs to .

</code></pre></div>
<p dir="auto">As <code>pamspy</code> rely on libpam, we have to set the path where libpam is installed on your distribution. To find where libpam is installed you can run the following command :</p>
<div data-snippet-clipboard-copy-content="&gt; /usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4
/lib/x86_64-linux-gnu/libpam.so.0"><pre><code>&gt; /usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4
/lib/x86_64-linux-gnu/libpam.so.0
</code></pre></div>
<p dir="auto">Once you get the path you can launch <code>pamspy</code> :</p>
<div data-snippet-clipboard-copy-content="&gt; ./pamspy -p /lib/x86_64-linux-gnu/libpam.so.0"><pre><code>&gt; ./pamspy -p /lib/x86_64-linux-gnu/libpam.so.0
</code></pre></div>
<p dir="auto">An easy way to launch <code>pamspy</code> is to use the following command :</p>
<div data-snippet-clipboard-copy-content="&gt; ./pamspy -p $(/usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4)"><pre><code>&gt; ./pamspy -p $(/usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4)
</code></pre></div>
<p dir="auto"><code>pamspy</code> can also be started as a daemon by providing an output file where credentials will be written:</p>
<div data-snippet-clipboard-copy-content="./pamspy -p $(/usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4) -d /tmp/credentials"><pre><code>./pamspy -p $(/usr/sbin/ldconfig -p | grep libpam.so | cut -d &#39; &#39; -f4) -d /tmp/credentials
</code></pre></div>
<h2 dir="auto"><a id="user-content-how-to-build" aria-hidden="true" href="#how-to-build"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How to build?</h2>
<p dir="auto">To build the static binary, we need third-party program. For eBPF we need <code>clang</code> to compile the C code into eBPF CO-RE code.
We also rely on <code>bpftool</code> to create a skeleton from ebpf program to include it in our userland program. Then we need also <code>libelf</code> to find the correct symbol in libpam.</p>
<div data-snippet-clipboard-copy-content="sudo apt install make clang-11 gcc libelf-dev bpftool"><pre><code>sudo apt install make clang-11 gcc libelf-dev bpftool
</code></pre></div>
<p dir="auto">Then just build!</p>
<div data-snippet-clipboard-copy-content="git clone https://github.com/citronneur/pamspy --recursive
cd pamspy/src
make"><pre><code>git clone https://github.com/citronneur/pamspy --recursive
cd pamspy/src
make
</code></pre></div>
<h2 dir="auto"><a id="user-content-how-does-it-works" aria-hidden="true" href="#how-does-it-works"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How does It works?</h2>
<p dir="auto"><code>pamspy</code> will load a userland return probe eBPF program to hook the <code>pam_get_authtok</code> function from <code>libpam.so</code>.
PAM stands for &#34;Pluggable Authentication Modules&#34;, and have a flexible design to manage a different kind of authentication on Linux.</p>
<p dir="auto">Each time an authentication process tries to check a new user, It will call <code>pam_get_authtok</code>, and will be here to dump the content of the critical secrets!</p>
<p dir="auto">Easy! Enjoy!</p>
<h2 dir="auto"><a id="user-content-credits-and-references" aria-hidden="true" href="#credits-and-references"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Credits and references</h2>
<p dir="auto">Thanks to @blendin for 3snake tool !!!</p>
</article>
          </div></div>
  </body>
</html>
