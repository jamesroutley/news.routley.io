<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://it-notes.dragas.net/2024/09/03/make-your-own-cdn-netbsd/">Original</a>
    <h1>Make Your Own CDN with NetBSD</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><h2 id="introduction"><span>Introduction</span>
<a href="#introduction"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h2><p>This article is a spin-off from <a href="https://it-notes.dragas.net/2024/08/29/make-your-own-cdn-openbsd/" target="_blank" rel="external nofollow noopener noreferrer">a previous post on how to create a self-hosted CDN</a>, based on OpenBSD, but this time we’ll focus on using <a href="https://www.netbsd.org/" target="_blank" rel="external nofollow noopener noreferrer">NetBSD</a>. The idea is to <a href="https://it-notes.dragas.net/2024/08/26/building-a-self-hosted-cdn-for-bsd-cafe-media/" target="_blank" rel="external nofollow noopener noreferrer">create reverse proxies with local caching</a>. These proxies would cache the content on the first request and serve it directly afterward. The proxies would be distributed across different regions, and the DNS would route requests to the nearest proxy based on the caller’s location. All this is achieved without relying on external CDNs, using self-managed tools instead.</p><p>NetBSD is a lightweight, stable, and secure operating system that supports a wide range of hardware, making it an excellent choice for a caching reverse proxy. Devices that other operating systems may soon abandon, such as early Raspberry Pi models or i386 architecture, are still fully supported by NetBSD and will continue to be so. Additionally, NetBSD is an outstanding platform for virtualization (using <a href="https://wiki.netbsd.org/ports/xen/howto/" target="_blank" rel="external nofollow noopener noreferrer">Xen</a> or <a href="https://www.netbsd.org/docs/guide/en/chap-virt.html" target="_blank" rel="external nofollow noopener noreferrer">qemu/nvmm</a>) and deserves more attention than it currently receives.</p><p>The choice of Varnish is based on several factors, with the main ones being the ability to keep the cache in RAM (which means it can run on read-only systems) and the ability to flush the cache remotely. For example, with each change to my blog, I can choose whether to perform an immediate flush (such as for a new article or an error) or wait for the cache’s “natural” expiration (such as for a typo or minor, non-critical changes).</p><p>While I won’t detail the installation process for NetBSD, as it depends heavily on the hardware you have available, I will guide you through setting up a self-hosted CDN using NetBSD, Varnish, nginx, and the acme.sh or lego tool for SSL certificate management.</p><h2 id="installation"><span>Installation</span>
<a href="#installation"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h2><p>During the installation of NetBSD, ensure that you enable support for binary package management. This will install <code>pkgin</code>, <a href="https://pkgin.net/" target="_blank" rel="external nofollow noopener noreferrer">a tool that simplifies package management</a> on NetBSD. If you skip this step during installation, you can still install pkgin later, but it’s easier to let the installer handle it.</p><p>Once your system is up and running, use pkgin to install the necessary packages: Varnish, nginx, and, depending on your preference, either acme.sh or Go (if you plan to compile lego). Although lego is not available as a precompiled package, you can easily compile it locally using Go, but for simplicity, I recommend using acme.sh.</p><p>For this setup, I will present two methods for generating and renewing certificates: using acme.sh or compiling lego - to reach the same final outcome as the <a href="https://it-notes.dragas.net/2024/08/29/make-your-own-cdn-openbsd/" target="_blank" rel="external nofollow noopener noreferrer">OpenBSD article</a>.</p><h3 id="option-1-using-acmesh-recommended"><span>Option 1: Using acme.sh (Recommended)</span>
<a href="#option-1-using-acmesh-recommended"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h3><p><a href="https://github.com/acmesh-official/acme.sh" target="_blank" rel="external nofollow noopener noreferrer">acme.sh</a> is a simple, yet powerful, shell script that handles certificate generation and renewal with ease. To install acme.sh:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>pkgin in acmesh varnish nginx</span></span></code></pre></td></tr></tbody></table></div></div><p>Once acme.sh is installed, you can proceed to configure it for certificate management. It supports DNS authentication and integrates with many DNS providers, making it a flexible choice.</p><h3 id="option-2-compiling-lego"><span>Option 2: Compiling Lego</span>
<a href="#option-2-compiling-lego"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h3><p>If you prefer to use lego, you will need to compile it manually, as it is not available as a precompiled package for NetBSD. First, install Go and other necessary packages:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>pkgin in go varnish nginx</span></span></code></pre></td></tr></tbody></table></div></div><p>To compile lego, you’ll need some disk space. Since the <code>/tmp</code> directory in NetBSD is often mounted as <code>tmpfs</code> (using RAM), you may run out of space during compilation if your system has limited memory. You can temporarily disable <code>tmpfs</code> by editing <code>/etc/fstab</code> and commenting out the relevant line:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span></code></pre></td><td><pre tabindex="0"><code data-lang="fallback"><span><span>#tmpfs           /tmp    tmpfs   rw,-m=1777,-s=ram%25</span></span></code></pre></td></tr></tbody></table></div></div><p>After rebooting, compile lego:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span><span>4
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span><span>export</span> <span>GO111MODULE</span><span>=</span>on
</span></span><span><span>go122 install github.com/go-acme/lego/v4/cmd/lego@latest
</span></span><span><span>
</span></span><span><span>cp go/bin/lego /usr/pkg/bin/</span></span></code></pre></td></tr></tbody></table></div></div><p>Once lego is compiled and installed, you can uncomment the <code>/tmp</code> line in <code>/etc/fstab</code> and reboot again.</p><h2 id="configuring-varnish-and-nginx"><span>Configuring Varnish and nginx</span>
<a href="#configuring-varnish-and-nginx"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h2><p>First, copy the necessary <code>rc.d</code> scripts for nginx and Varnish:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>cp /usr/pkg/share/examples/rc.d/nginx /etc/rc.d/
</span></span><span><span>cp /usr/pkg/share/examples/rc.d/varnishd /etc/rc.d/</span></span></code></pre></td></tr></tbody></table></div></div><p>Then, add the following to <code>/etc/rc.conf</code> to enable and configure nginx and Varnish:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span><span>3
</span></code></pre></td><td><pre tabindex="0"><code data-lang="gdscript3"><span><span><span>nginx</span><span>=</span><span>YES</span>
</span></span><span><span><span>varnishd</span><span>=</span><span>YES</span>
</span></span><span><span><span>varnishd_flags</span><span>=</span><span>&#34;-f /usr/pkg/etc/varnish/default.vcl -T localhost:9999 -a &#34;</span><span>/</span><span>var</span><span>/</span><span>run</span><span>/</span><span>varnish</span><span>.</span><span>sock</span><span>&#34;,user=nginx,group=varnish,mode=660 -s default,500m&#34;</span></span></span></code></pre></td></tr></tbody></table></div></div><p>In this configuration, Varnish listens on a Unix socket, and nginx connects to it. This approach is more efficient and helps avoid some issues that may arise when exposing Varnish over an IP/port.</p><h3 id="creating-the-varnish-vcl-configuration"><span>Creating the Varnish VCL Configuration</span>
<a href="#creating-the-varnish-vcl-configuration"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h3><p>Next, create the VCL configuration file for Varnish at <code>/usr/pkg/etc/varnish/default.vcl</code>:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>  1
</span><span>  2
</span><span>  3
</span><span>  4
</span><span>  5
</span><span>  6
</span><span>  7
</span><span>  8
</span><span>  9
</span><span> 10
</span><span> 11
</span><span> 12
</span><span> 13
</span><span> 14
</span><span> 15
</span><span> 16
</span><span> 17
</span><span> 18
</span><span> 19
</span><span> 20
</span><span> 21
</span><span> 22
</span><span> 23
</span><span> 24
</span><span> 25
</span><span> 26
</span><span> 27
</span><span> 28
</span><span> 29
</span><span> 30
</span><span> 31
</span><span> 32
</span><span> 33
</span><span> 34
</span><span> 35
</span><span> 36
</span><span> 37
</span><span> 38
</span><span> 39
</span><span> 40
</span><span> 41
</span><span> 42
</span><span> 43
</span><span> 44
</span><span> 45
</span><span> 46
</span><span> 47
</span><span> 48
</span><span> 49
</span><span> 50
</span><span> 51
</span><span> 52
</span><span> 53
</span><span> 54
</span><span> 55
</span><span> 56
</span><span> 57
</span><span> 58
</span><span> 59
</span><span> 60
</span><span> 61
</span><span> 62
</span><span> 63
</span><span> 64
</span><span> 65
</span><span> 66
</span><span> 67
</span><span> 68
</span><span> 69
</span><span> 70
</span><span> 71
</span><span> 72
</span><span> 73
</span><span> 74
</span><span> 75
</span><span> 76
</span><span> 77
</span><span> 78
</span><span> 79
</span><span> 80
</span><span> 81
</span><span> 82
</span><span> 83
</span><span> 84
</span><span> 85
</span><span> 86
</span><span> 87
</span><span> 88
</span><span> 89
</span><span> 90
</span><span> 91
</span><span> 92
</span><span> 93
</span><span> 94
</span><span> 95
</span><span> 96
</span><span> 97
</span><span> 98
</span><span> 99
</span><span>100
</span><span>101
</span><span>102
</span><span>103
</span><span>104
</span><span>105
</span><span>106
</span><span>107
</span><span>108
</span><span>109
</span><span>110
</span><span>111
</span><span>112
</span><span>113
</span><span>114
</span><span>115
</span><span>116
</span><span>117
</span><span>118
</span><span>119
</span><span>120
</span><span>121
</span><span>122
</span><span>123
</span><span>124
</span><span>125
</span><span>126
</span><span>127
</span><span>128
</span><span>129
</span><span>130
</span><span>131
</span><span>132
</span></code></pre></td><td><pre tabindex="0"><code data-lang="fallback"><span><span>vcl 4.1;
</span></span><span><span>import std;
</span></span><span><span>
</span></span><span><span># Backend - it-notes.dragas.net
</span></span><span><span>backend it_notes {
</span></span><span><span>    .host = &#34;myBackendIP&#34;;
</span></span><span><span>    .port = &#34;80&#34;;
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span># ACL - purge - it-notes.dragas.net
</span></span><span><span>acl purge_it_notes {
</span></span><span><span>    &#34;allowedToPurge_IP&#34;;
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_recv {
</span></span><span><span>    # it-notes.dragas.net
</span></span><span><span>    if (req.http.Host == &#34;it-notes.dragas.net&#34;) {
</span></span><span><span>        set req.backend_hint = it_notes;
</span></span><span><span>        set req.http.Host = &#34;it-notes.dragas.net&#34;;
</span></span><span><span>
</span></span><span><span>        # PURGE - it-notes.dragas.net
</span></span><span><span>        if (req.method == &#34;PURGE&#34;) {
</span></span><span><span>            std.log(&#34;Purge request received for &#34; + req.url);
</span></span><span><span>
</span></span><span><span>            if (!std.ip(req.http.X-Forwarded-For, &#34;0.0.0.0&#34;) ~ purge_it_notes) {
</span></span><span><span>                return (synth(405, &#34;Not allowed.&#34;));
</span></span><span><span>            }
</span></span><span><span>
</span></span><span><span>            if (req.url == &#34;/&#34; || req.url == &#34;/*&#34;) {
</span></span><span><span>                ban(&#34;req.http.host == &#34; + req.http.host);
</span></span><span><span>                return(synth(200, &#34;Entire cache has been cleared.&#34;));
</span></span><span><span>            }
</span></span><span><span>            return (purge);
</span></span><span><span>        }
</span></span><span><span>
</span></span><span><span>    } else {
</span></span><span><span>        # Other domains - 404
</span></span><span><span>        return (synth(404, &#34;Domain not found&#34;));
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    if (req.method != &#34;GET&#34; &amp;&amp; req.method != &#34;HEAD&#34;) {
</span></span><span><span>        return (pipe);
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    return (hash);
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_backend_response {
</span></span><span><span>    # TTL - it-notes.dragas.net
</span></span><span><span>    if (bereq.http.host == &#34;it-notes.dragas.net&#34;) {
</span></span><span><span>        if (bereq.url ~ &#34;\.(gif|jpg|jpeg|png|webp|ico|css|js)$&#34;) {
</span></span><span><span>            set beresp.ttl = 1w;
</span></span><span><span>            set beresp.grace = 1d;
</span></span><span><span>            set beresp.keep = 7d;
</span></span><span><span>            unset beresp.http.Set-Cookie;
</span></span><span><span>            unset beresp.http.Cache-Control;
</span></span><span><span>            set beresp.http.Cache-Control = &#34;public, max-age=604800&#34;;
</span></span><span><span>        } else {
</span></span><span><span>            set beresp.ttl = 15m;
</span></span><span><span>            set beresp.grace = 48h;
</span></span><span><span>            set beresp.keep = 7d;
</span></span><span><span>        }
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    # Remove some headers
</span></span><span><span>    unset beresp.http.Server;
</span></span><span><span>    unset beresp.http.X-Powered-By;
</span></span><span><span>    unset beresp.http.Via;
</span></span><span><span>
</span></span><span><span>    return (deliver);
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_deliver {
</span></span><span><span>    # Add X-Cache header
</span></span><span><span>    if (obj.hits &gt; 0) {
</span></span><span><span>        set resp.http.X-Cache = &#34;HIT&#34;;
</span></span><span><span>    } else {
</span></span><span><span>        set resp.http.X-Cache = &#34;MISS&#34;;
</span></span><span><span>    }
</span></span><span><span>
</span></span><span><span>    std.log(&#34;Delivering content for &#34; + req.url + &#34; - Cache: &#34; + resp.http.X-Cache);
</span></span><span><span>
</span></span><span><span>    # Remove Varnish headers
</span></span><span><span>    unset resp.http.Via;
</span></span><span><span>    unset resp.http.X-Varnish;
</span></span><span><span>
</span></span><span><span>    return (deliver);
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_hash {
</span></span><span><span>    hash_data(req.url);
</span></span><span><span>    if (req.http.host) {
</span></span><span><span>        hash_data(req.http.host);
</span></span><span><span>    } else {
</span></span><span><span>        hash_data(server.ip);
</span></span><span><span>    }
</span></span><span><span>    return (lookup);
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_hit {
</span></span><span><span>    return (deliver);
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_miss {
</span></span><span><span>    return (fetch);
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_purge {
</span></span><span><span>    std.log(&#34;Purge executed for &#34; + req.url);
</span></span><span><span>    return (synth(200, &#34;Purge successful&#34;));
</span></span><span><span>}
</span></span><span><span>
</span></span><span><span>sub vcl_synth {
</span></span><span><span>    set resp.http.Content-Type = &#34;text/html; charset=utf-8&#34;;
</span></span><span><span>    set resp.http.Retry-After = &#34;5&#34;;
</span></span><span><span>    synthetic({&#34;&lt;!DOCTYPE html&gt;
</span></span><span><span>        &lt;html&gt;
</span></span><span><span>            &lt;head&gt;
</span></span><span><span>                &lt;title&gt;&#34;} + resp.status + &#34; &#34; + resp.reason + {&#34;&lt;/title&gt;
</span></span><span><span>            &lt;/head&gt;
</span></span><span><span>            &lt;body&gt;
</span></span><span><span>                &lt;h1&gt;Status &#34;} + resp.status + &#34; &#34; + resp.reason + {&#34;&lt;/h1&gt;
</span></span><span><span>                &lt;p&gt;&#34;} + resp.reason + {&#34;&lt;/p&gt;
</span></span><span><span>                &lt;h3&gt;Guru Meditation:&lt;/h3&gt;
</span></span><span><span>                &lt;p&gt;XID: &#34;} + req.xid + {&#34;&lt;/p&gt;
</span></span><span><span>                &lt;hr&gt;
</span></span><span><span>                &lt;p&gt;Varnish cache server&lt;/p&gt;
</span></span><span><span>            &lt;/body&gt;
</span></span><span><span>        &lt;/html&gt;
</span></span><span><span>    &#34;});
</span></span><span><span>    return (deliver);
</span></span><span><span>}</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="configuring-nginx"><span>Configuring nginx</span>
<a href="#configuring-nginx"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h3><p>Now, modify the nginx configuration file at <code>/usr/pkg/etc/nginx/nginx.conf</code>. Set the number of worker processes to “auto” to take advantage of all server cores, and configure the reverse proxy for your site(s). Here’s an example configuration:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span> 1
</span><span> 2
</span><span> 3
</span><span> 4
</span><span> 5
</span><span> 6
</span><span> 7
</span><span> 8
</span><span> 9
</span><span>10
</span><span>11
</span><span>12
</span><span>13
</span><span>14
</span><span>15
</span><span>16
</span><span>17
</span><span>18
</span><span>19
</span><span>20
</span><span>21
</span><span>22
</span><span>23
</span><span>24
</span><span>25
</span><span>26
</span><span>27
</span><span>28
</span><span>29
</span><span>30
</span><span>31
</span><span>32
</span><span>33
</span><span>34
</span><span>35
</span><span>36
</span><span>37
</span></code></pre></td><td><pre tabindex="0"><code data-lang="gdscript3"><span><span><span>[</span><span>...</span><span>]</span>
</span></span><span><span><span>worker_processes</span>  <span>auto</span><span>;</span>
</span></span><span><span><span>[</span><span>...</span><span>]</span>
</span></span><span><span>
</span></span><span><span><span>server</span> <span>{</span>
</span></span><span><span>    <span>server_name</span> <span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>location</span> <span>/</span> <span>{</span>
</span></span><span><span>        <span>proxy_method</span> <span>$</span><span>request_method</span><span>;</span>
</span></span><span><span>        <span>proxy_set_header</span> <span>Host</span> <span>$</span><span>http_host</span><span>;</span>
</span></span><span><span>        <span>proxy_set_header</span> <span>X</span><span>-</span><span>Real</span><span>-</span><span>IP</span> <span>$</span><span>remote_addr</span><span>;</span>
</span></span><span><span>        <span>proxy_set_header</span> <span>X</span><span>-</span><span>Forwarded</span><span>-</span><span>For</span> <span>$</span><span>proxy_add_x_forwarded_for</span><span>;</span>
</span></span><span><span>        <span>proxy_set_header</span> <span>X</span><span>-</span><span>Forwarded</span><span>-</span><span>Proto</span> <span>$</span><span>scheme</span><span>;</span>
</span></span><span><span>
</span></span><span><span>        <span>proxy_pass</span> <span>http</span><span>:</span><span>//</span><span>unix</span><span>:</span><span>/</span><span>var</span><span>/</span><span>run</span><span>/</span><span>varnish</span><span>.</span><span>sock</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>access_log</span> <span>/</span><span>var</span><span>/</span><span>log</span><span>/</span><span>nginx</span><span>/</span><span>access</span><span>.</span><span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>.</span><span>log</span><span>;</span>
</span></span><span><span>    <span>error_log</span> <span>/</span><span>var</span><span>/</span><span>log</span><span>/</span><span>nginx</span><span>/</span><span>error</span><span>.</span><span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>.</span><span>log</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>listen</span> <span>[::]:</span><span>443</span> <span>ssl</span><span>;</span>
</span></span><span><span>    <span>listen</span> <span>443</span> <span>ssl</span><span>;</span>
</span></span><span><span>    <span>http2</span> <span>on</span><span>;</span>
</span></span><span><span>    <span># If you&#39;re using acme.sh, just change the location of the certificates</span>
</span></span><span><span>    <span>ssl_certificate</span> <span>/</span><span>root</span><span>/.</span><span>lego</span><span>/</span><span>certificates</span><span>/</span><span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>.</span><span>crt</span><span>;</span>
</span></span><span><span>    <span>ssl_certificate_key</span> <span>/</span><span>root</span><span>/.</span><span>lego</span><span>/</span><span>certificates</span><span>/</span><span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>.</span><span>key</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>server</span> <span>{</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>$</span><span>host</span> <span>=</span> <span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>return</span> <span>301</span> <span>https</span><span>:</span><span>//$</span><span>host</span><span>$</span><span>request_uri</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>    <span>server_name</span> <span>it</span><span>-</span><span>notes</span><span>.</span><span>dragas</span><span>.</span><span>net</span><span>;</span>
</span></span><span><span>    <span>listen</span> <span>80</span><span>;</span>
</span></span><span><span>    <span>listen</span> <span>[::]:</span><span>80</span><span>;</span>
</span></span><span><span>    <span>return</span> <span>404</span><span>;</span>
</span></span><span><span><span>}</span></span></span></code></pre></td></tr></tbody></table></div></div><h3 id="starting-varnish-and-nginx"><span>Starting Varnish and nginx</span>
<a href="#starting-varnish-and-nginx"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h3><p>Finally, start the Varnish and nginx services:</p><div><div><table><tbody><tr><td><pre tabindex="0"><code><span>1
</span><span>2
</span></code></pre></td><td><pre tabindex="0"><code data-lang="bash"><span><span>service varnishd start
</span></span><span><span>service nginx start</span></span></code></pre></td></tr></tbody></table></div></div><p>If everything is configured correctly, both Varnish and nginx will be up and running, ready to handle incoming connections.</p><h2 id="conclusion"><span>Conclusion</span>
<a href="#conclusion"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"></path></svg></a></h2><p>Congratulations, you have successfully set up your own CDN on NetBSD. This solution is lightweight, stable, and fully under your control, allowing you to break free from the constraints of major service providers. With NetBSD’s broad hardware support and minimal overhead, this setup can run on a wide variety of devices, making it a versatile choice for self-hosted solutions.</p><p>I’m using it as a test and as a read-only root filesystem with a RAM-only local cache for my blog on a <a href="https://www.raspberrypi.com/products/raspberry-pi-zero-w/" target="_blank" rel="external nofollow noopener noreferrer">Raspberry Pi Zero W (first edition)</a>, and as soon as I get the new FTTH, I’ll probably make it accessible via IPv6 for Italy, putting it physically into production.</p><p>If your goal is geo-replication, you can use DNS providers that offer location-based routing or set up your own DNS infrastructure to manage and resolve requests according to the user’s location. With multiple reverse proxies, separate DNS servers, and a well-configured cache, you can achieve a highly resilient system with minimal risk of a single point of failure.</p></div></div>
  </body>
</html>
