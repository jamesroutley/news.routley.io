<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lock.cmpxchg8b.com/slowterm.html">Original</a>
    <h1>Troubleshooting: Terminal Lag</h1>
    
    <div id="readability-page-1" class="page">

<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#window-effects">Window Effects</a></li>
<li><a href="#profiling">Profiling</a>
<ul>
<li><a href="#features">Features</a></li>
</ul></li>
<li><a href="#caching">Caching</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</nav>
<p>I think I should blog more about random troubleshooting sessions, if nothing else it will remind me what steps I took when it inevitably happens again!</p>
<p>Okay, here is the first one â€“ why is my <code>xterm</code> opening so slowly?</p>
<section id="background">
<h2>Background</h2>
<p>I have two similarly specced machines at my desk â€“ my primary workstation running Fedora Linux, and a Windows 11 machine. They share the same monitor and input devices, and I switch between them with an iogear KVM.</p>
<p>I do the bulk of my work in either a browser or a terminal. This is true even on Windows, where I rely heavily on <abbr title="Windows Subsystem for Linux"> WSL</abbr>.</p>
<p>This works well for me, and Iâ€™m happy enough with the setup.</p>
<section id="issue">
<h4>Issue</h4>
<p>I have the shortcut <kbd><abbr title="Windows Key">Super</abbr></kbd>+<kbd>1</kbd> bound to <code>xterm</code> on both machines, and I probably use this hundreds of times per day.</p>
<p>Here is how that looks on Fedora:</p>
<blockquote>
<figure>
<img src="https://lock.cmpxchg8b.com/img/fedora_terminal_open.gif" alt=""/><figcaption>Fedora Terminal</figcaption>
</figure>
</blockquote>
<p>It takes about <abbr title="9 frames @ 30fps">300ms</abbr> from key activation to a terminal being ready. This is fine, Iâ€™ve never noticed any problem.</p>
<p>However, letâ€™s compare that to Windows:</p>
<blockquote>
<figure>
<img src="https://lock.cmpxchg8b.com/img/windows_terminal_open.gif" alt=""/><figcaption>Windows Terminal</figcaption>
</figure>
</blockquote>
<p>Thatâ€™s about <abbr title="48 frames @ 30fps">1600ms</abbr> before I can type, over 5 times slower! This <em>is</em> slow enough that it bothers me, and I use this shortcut so often that I want to solve it.</p>
<p>I donâ€™t think many people care about <code>xterm</code> performance on Windows, so I guess that means itâ€™s up to me to solve this ðŸ™‚</p>
</section>
</section>
<section id="window-effects">
<h2>Window Effects</h2>
<p>Hey, wait a minuteâ€¦ <big><em><strong>ENHANCE!</strong></em></big> ðŸ‘€</p>
<blockquote>
<figure>
<img src="https://lock.cmpxchg8b.com/img/windows_terminal_fade.gif" alt=""/><figcaption>Windows Fading Effect</figcaption>
</figure>
</blockquote>
<p>Why does the window fade in like that? It looks like the Window is ready when the effect starts, but I canâ€™t interact with it until it completes. If I count those frames, this animation must be costing me ~200ms! ðŸ¤¬</p>
<p>I always disable anything like animation or compositing effects, so Iâ€™m confused where this is coming from.</p>
<blockquote>
<figure>
<img src="https://lock.cmpxchg8b.com/img/windows_performance.png" alt=""/><figcaption>Windows Performance Settings</figcaption>
</figure>
</blockquote>
<p>I tested with some native windows programs like <code>notepad</code> and <code>calc</code> â€“ they just appear instantlyâ€¦ so what is causing that?</p>
<p>I experimented with it a bit, I can see other windows behind it as it fades in, so I think something must be changing the opacity. Searching msdn, it looks like the function for that is <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setlayeredwindowattributes"><code>SetLayeredWindowAttributes()</code></a>.</p>
<p>Could something be calling that, is my X server betraying me?</p>
<pre><code>$ dumpbin /imports X410.exe  | grep SetLayeredWindowAttributes
                         33A SetLayeredWindowAttributes</code></pre>
<p>This looks like the culprit!! Iâ€™m using a server called <a href="https://x410.dev/">X410</a>, it seems like itâ€™s adding itâ€™s own animation effects, and doesnâ€™t have any way to disable it. Iâ€™m reluctant to switch to an alternative â€“ that could just replace this issue with a different issue to troubleshoot.</p>
<p>Is it possible I can just stop it from doing that with a debugger?</p>
<pre><code>$ cdb -p 6624
(19e0.2ad0): Break instruction exception - code 80000003 (first chance)
ntdll!DbgBreakPoint:
00007ff9`1f9b3c90 cc              int     3
0:014&gt; eb win32u!NtUserSetLayeredWindowAttributes c3
0:014&gt; .detach
Detached
NoTarget&gt; q
quit:</code></pre>
<p>Ah-ha, that actually worked!!!</p>
<p>Iâ€™ve added that <code>cdb</code> command into my xinit initialization, and it looks a lot snappier. That saved nearly 300ms, so weâ€™re down to just 4 times slower than Fedora!</p>
</section>
<section id="profiling">

<p>Okay, letâ€™s try get some real numbers. I like the tool <a href="https://github.com/sharkdp/hyperfine">hyperfine</a> for this, here are the initial results:</p>
<blockquote>
<figure>
<img src="https://lock.cmpxchg8b.com/img/hyperfine_windows.png" alt=""/><figcaption>Hyperfine Windows</figcaption>
</figure>
</blockquote>
<p>If we run it under optimal conditions, it takes about 900ms on Windows, and about 100ms on Fedora.</p>
<p>Now that I can reproduce the delay reliably, I can start exploring some theoriesâ€¦</p>
<section id="filesystem">
<h4>Filesystem</h4>
<p>My first thought is that filesystem performance under WSL can be very slow, could that explain the difference?</p>
<pre><code>taviso@WORKSTATION:~$ strace -wc -efile xterm -e true
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 43.93    0.014870          56       261        56 openat
 23.79    0.008053          31       257        33 access
 20.48    0.006932          32       211        12 newfstatat
  7.07    0.002394          23       100        54 readlink
  4.72    0.001596        1596         1           execve
------ ----------- ----------- --------- --------- ----------------
100.00    0.033845          40       830       155 total</code></pre>
<p>Nope, itâ€™s actually a bit faster on Windows! If I browse the logs, it looks related to fonts, and I do have fewer fonts installed on Windows. I suspect that causes <code>fontconfig</code> to query less files on initialization.</p>
<p>Whatever the reason, I concluded it wasnâ€™t a big proportion of startup time, so it doesnâ€™t seem worth worrying about.</p>
</section>
<section id="x-server">
<h4>X Server</h4>
<p>The issue must be the X server, how fast is a very simple X client?</p>
<pre><code>taviso@fedora:~$ hyperfine xdpyinfo
Benchmark 1: xdpyinfo
  Time (mean Â± Ïƒ):       4.6 ms Â±   0.8 ms    [User: 1.9 ms, System: 1.6 ms]
  Range (min â€¦ max):     3.1 ms â€¦   9.4 ms    317 runs
</code></pre>
<p>That <em>does</em> run slower on Windows, but not significantly slower â€“ perhaps I actually need to create a window to see a difference?</p>
<pre><code>taviso@fedora:~$ x11perf -repeat 1 -subs 8 -popup
    5600000 reps @   0.0010 msec (1040000.0/sec): Hide/expose window via popup (8 kids)
</code></pre>
<p>That is also slower on Windows â€“ this is understandable, it has to translate from X11 to win32 â€“ but not so slow that it adequately explains the problem alone.</p>
</section>
<section id="freetype">
<h4>FreeType</h4>
<p>Could it be a FreeType or FontConfig issue?</p>
<pre><code>taviso@WORKSTATION:~$ ftbench -p consola.ttf
executing tests:
  Load                           2.491 us/op     809010 done
  Load_Advances (Normal)         2.437 us/op     827190 done
  Load_Advances (Fast)           0.022 us/op   88575990 done
  Load_Advances (Unscaled)       0.013 us/op  147448890 done
  Render                         2.039 us/op     390870 done
  Get_Glyph                      0.921 us/op     509040 done
  Get_Char_Index                 0.018 us/op  111551968 done
  Iterate CMap                  21.539 us/op      88503 done
  New_Face                       6.271 us/op     284029 done
  Embolden                       2.491 us/op     357540 done
  Stroke                        24.663 us/op      69690 done
  Get_BBox                       0.865 us/op     487830 done
  Get_CBox                       0.679 us/op     506010 done</code></pre>
<p>Loading fonts is slightly slower, but the other numbers seem fine, and itâ€™s not <em>that</em> much slower. I donâ€™t think itâ€™s this.</p>
</section>
<section id="features">
<h3>Features</h3>
<p>Maybe I can get some clues from ltrace?</p>
<pre><code>$ ltrace -c xterm -e true
% time     seconds  usecs/call     calls      function
------ ----------- ----------- --------- --------------------
 26.74    1.977389      988694         2 XtRealizeWidget
 22.18    1.640132       14139       116 XtSetValues
 13.39    0.989966      197993         5 XtVaCreateManagedWidget
  6.42    0.474410         200      2361 strlen
  5.51    0.407617      203808         2 read
  4.21    0.311086         197      1572 FcCharSetHasChar
  2.92    0.215975        2571        84 XtCreateManagedWidget
  2.80    0.207397       69132         3 XtVaCreatePopupShell
  2.39    0.176458         218       808 XftTextExtents32
  1.51    0.111306      111306         1 XpmReadFileToPixmap
  1.48    0.109486      109486         1 XtOpenApplication
  1.44    0.106786         203       524 malloc</code></pre>
<p>This <code>XtRealizeWidget</code> call does seem slow, and I donâ€™t see that on Fedora, what is calling that?</p>
<pre><code>$ gdb --args ./xterm -e true
Reading symbols from ./xterm...
(gdb) b XtRealizeWidget
Breakpoint 1 at 0x2db20
(gdb) r
Breakpoint 1, 0x00007fffff43d940 in XtRealizeWidget () from /lib/x86_64-linux-gnu/libXt.so.6
(gdb) bt
#0  0x00007fffff43d940 in XtRealizeWidget () from /lib/x86_64-linux-gnu/libXt.so.6
...
#4  0x00007fffff44c4f6 in XtSetValues () from /lib/x86_64-linux-gnu/libXt.so.6
#5  0x0000000008086683 in UpdateMenuItem (menu=0x811c5c0 &lt;mainMenuEntries&gt;, which=0, val=1)
    at ./menu.c:1026
#6  0x000000000808a763 in update_toolbar () at ./menu.c:3366</code></pre>
<p>Ah-ha â€“ itâ€™s the toolbar feature. Itâ€™s disabled at compile time on Fedora, but I quite like it and enable it on Windows.</p>
<p>If I disable that, startup is a little faster, I wonder if there are any other features that are slowing down initializationâ€¦?</p>
<section id="parameter-scanning">
<h4>Parameter Scanning</h4>
<p>The <code>hyperfine</code> utility has a feature called <em>parameter scan</em>, where it it will try a bunch of settings for you and tell you which one is fastest.</p>
<p>Letâ€™s ask XTerm what features are available, and toggle each one on and off.</p>
<pre><code>$ xterm -report-xres -e true
activeIcon              : default
allowBoldFonts          : true
allowC1Printable        : false
allowColorOps           : true
allowFontOps            : false
allowMouseOps           : true
...</code></pre>
<p>Iâ€™ll start by extracting all the settings that are booleans.</p>
<pre><code>$ xterm -report-xres -e true | grep -Po &#39;^\S+(?=\s+: (true|false))&#39; | tr &#39;\n&#39; &#39;,&#39;
allowBoldFonts,allowColorOps,allowMouseOps...</code></pre>
<blockquote>
<p>Note: <code>xterm</code> has a <em>lot</em> of features, Iâ€™m truncating the list for brevity!</p>
</blockquote>
<p>Now we can give each of those to <code>hyperfine</code>, and let it figure out which settings have the most noticable effect.</p>
<p>That took about 20 minutes to run, and reports:</p>
<pre><code>$ hyperfine --parameter-list res allowBoldFonts,allow... \
            --parameter-list bool true,false \
            &#34;xterm -xrm &#39;XTerm*{res}: {bool}&#39; -e true&#34;
...
Benchmark 240: xterm -xrm &#39;XTerm*xftTrackMemUsage: false&#39; -e true
  Time (mean Â± Ïƒ):     140.1 ms Â±   7.4 ms    [User: 30.8 ms, System: 23.4 ms]
  Range (min â€¦ max):   129.2 ms â€¦ 153.4 ms    21 runs
 
Summary
  xterm -xrm &#39;XTerm*tekInhibit: true&#39; -e true ran
    1.01 Â± 0.08 times faster than xterm -xrm &#39;XTerm*allowSendEvents: false&#39; -e true
    ...</code></pre>
<p>This helped a little, I found a combination of options that saved around 200ms total. One example was <code>tekInhibit</code>, which disables the Tektronix emulation. Thatâ€™s usually used as a graphing mode â€“ itâ€™s actually <a href="https://web.archive.org/web/20100305175059/http://dim13.org/tek/">pretty cool</a>.</p>
<p>Still, it isnâ€™t a big enough difference, and this is as far as I was able to get through tweaking settings.</p>
<p>Iâ€™m starting to think that this is just death by a thousand cuts, everything just has some small overhead on Windows and it adds upâ€¦</p>
</section>
</section>
</section>
<section id="caching">

<p>Thereâ€™s a simple generic solution to slow startup performance: server mode.</p>
<p>The idea is to cache a few processes in the background, then all the slow stuff will already be done, ready for you to start working immediately.</p>
<p>XTerm doesnâ€™t have this feature natively, but itâ€™s not complicated, I can add it.</p>
<p>To do this, I will use <em>deferred mapping</em> â€“ that just means that a program is running, but the window is not visible yet.</p>
<p>I tried a few solutions and found one that works well, an <code>LD_PRELOAD</code> library. All it does is intercept any toplevel <a href="https://linux.die.net/man/3/xmapwindow"><code>XMapWindow()</code></a> calls, then pause execution until it receives a signal.</p>
<p>Itâ€™s a bit hacky, but my code is <a href="https://github.com/taviso/defermap">here</a>, if youâ€™re interested.</p>
<p>To use it, you need something to manage the cache for you in the background, <code>xargs</code> will work!</p>
<pre><code>$ xargs --null --arg-file=/dev/zero --max-procs=3 --replace -- \
     env LD_PRELOAD=defermap.so xterm -display :0 [PARAMS...]</code></pre>
<p>This will keep three xterms running in the background.</p>
<blockquote>
<p>Note: If you often rapidly start terminals in quick succession, increase <code>max-procs</code>.</p>
</blockquote>
<p>When you want a new terminal, instead of running <code>xterm</code> as you normally would, do this instead:</p>
<pre><code>$ pkill --oldest --signal SIGUSR1 xtermserver</code></pre>
<p>A terminal should appear near-instantly. You can now execute that instead of <code>xterm</code>, and startup performance should be solved.</p>
</section>
<section id="conclusion">

<p>This whole process took a while! Now I need to adjust my shortcuts to run <code>pkill</code> instead of <code>xterm</code>, and I can compare the results.</p>
<blockquote>
<figure>
<img src="https://lock.cmpxchg8b.com/img/windows_terminal_fixed.gif" alt=""/><figcaption>Windows Terminal</figcaption>
</figure>
</blockquote>
<p>Counting the frames in that video, itâ€™s down to about <abbr title="11 frames @
30fps">366ms</abbr>, just 60ms slower than Fedora, this is totally acceptable!</p>
<p>Iâ€™ve been using this configuration for a few days, so far itâ€™s working great. I havenâ€™t noticed any issues running it this way.</p>
<p>I highly doubt anyone else will find this useful, who else is using XTerm on Windows? ðŸ˜†</p>
<p>Nevertheless, if you have a better solution, or can think of something else I can try, let me know!</p>
</section>



</div>
  </body>
</html>
