<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.redhat.com/sysadmin/quadlet-podman">Original</a>
    <h1>Make systemd better for Podman with Quadlet</h1>
    
    <div id="readability-page-1" class="page"><div>

  
    

      
            <div property="schema:text"><p>One of the best features of <a href="https://www.redhat.com/en/topics/containers/what-is-podman?intcmp=701f20000012ngPAAQ" target="_blank">Podman</a> is how well it works with systemd. Podman uses the standard fork/exec model, which is easily adaptable to the systemd system and service manager model.</p>

<p><strong><em>[ Download now: <a href="https://developers.redhat.com/cheat-sheets/podman-basics-cheat-sheet?intcmp=701f20000012ngPAAQ" target="_blank">Podman basics cheat sheet</a> ]</em></strong></p>

<p>In <a href="https://www.redhat.com/sysadmin/podman-edge-healthcheck" target="_blank">Podman at the edge</a>, Valentin Rothberg writes:</p>

<blockquote>
<p>&#34;Running containerized workloads in systemd is a simple yet powerful means for reliable and rock-solid deployments. The systemd integration further lays the foundation for more advanced Podman features such as auto updates and rollbacks or running Kubernetes workloads in systemd. This integration allows systemd to manage service dependencies, monitor the lifecycle and service state, and possibly also restart services in case of failure.&#34;</p>
</blockquote>

<p>Once administrators realized that Podman works well in systemd unit files, the Podman upstream started getting questions on best practices for running Podman as a systemd service. We studied the issues and worked with the upstream systemd team to template these best practices. Podman added the <a href="https://docs.podman.io/en/latest/markdown/podman-generate-systemd.1.html" target="_blank"><code>podman generate systemd</code></a> command to create a unit file directly from a running container.</p>

<p><strong><em>[ Get the <a href="https://developers.redhat.com/cheat-sheets/systemd-commands-cheat-sheet?intcmp=701f20000012ngPAAQ" target="_blank">systemd commands cheat sheet</a> ] </em></strong></p>

<p>Alex Larsson created the <a href="https://github.com/containers/quadlet" target="_blank">Quadlet</a> project after <a href="https://blogs.gnome.org/alexl/2021/10/12/quadlet-an-easier-way-to-run-system-containers/" target="_blank">figuring out a better way to use this templating</a> using systemd generators to regenerate services on the fly using a generic systemd unit file definition. Quadlet hid the complexity of running containers under systemd from users, making writing unit files from scratch much easier to maintain. Think of it as a <a href="https://www.redhat.com/sysadmin/podman-compose-docker-compose" target="_blank">Compose</a> or Kubernetes file but for systemd. Once written, you can deploy it anywhere.</p>



<h2 id="what-is-quadlet">What is Quadlet?</h2>

<p>The original <a href="https://github.com/containers/quadlet" target="_blank">Quadlet repository</a> describes Quadlet this way:</p>

<blockquote>
<p>What do you get if you squash a Kubernetes <a href="https://kubernetes.io/docs/concepts/overview/components/#kubelet" target="_blank">kubelet</a>?</p>
</blockquote>

<p>Quadlet is a tool for running Podman containers under systemd in an optimal way by allowing containers to run under systemd in a declarative way. It has been merged into Podman 4.4.</p>

<p>As the (now frozen) Quadlet repository says:</p>

<blockquote>
<p>&#34;Containers are often used in a cloud context, and they are then used in combination with an orchestrator like Kubernetes. They are also commonly used during development and testing to manually manage containers on an ad-hoc basis.</p>

<p>&#34;However, there are also use cases where you want some kind of automatic container management, but on a smaller, single-node scale, and often more tightly integrated with the rest of the system. Typical examples of this can be embedded or automotive use, where there is no system administrator, or disconnected or edge servers.</p>

<p>&#34;The recommended way to do this is to use systemd to orchestrate the containers, since this is an already running process manager, and since podman containers are just child processes. There are many documents that describe how to use podman with systemd directly, but the end result are generally large, hard to maintain systemd config files. And often the container setup isn&#39;t optimal.&#34;</p>
</blockquote>

<p>Basically, anywhere you want to run a containerized system service without requiring human intervention, it&#39;s wise to use systemd to manage your locally running Podman containers.</p>

<p><strong><em>[ Check out <a href="https://www.redhat.com/sysadmin/podman-container-events-auditing" target="_blank">new container events and auditing features in Podman 4.4</a>. ]</em></strong></p>

<h2 id="podman-4.4-merges-quadlet-into-podman">Using Quadlet in Podman</h2>

<p>With Quadlet in Podman 4.4, you can create <code>CTRNAME.container</code> unit files that can be placed in one of the following directories:</p>

<pre><code>/usr/share/containers/systemd/
/etc/containers/systemd/</code></pre>

<p>For rootless users:</p>

<pre><code>$HOME/.config/containers/systemd/</code></pre>

<p>The following example creates a <code>mysleep.container</code> unit file that runs the <code>sleep 1000</code> command on a <strong>ubi9-minimal</strong> container image:</p>

<pre><code>cat $HOME/.config/containers/systemd/mysleep.container
[Unit]
Description=The sleep container
After=local-fs.target

[Container]
Image=registry.access.redhat.com/ubi9-minimal:latest
Exec=sleep 1000

[Install]
# Start by default on boot
WantedBy=multi-user.target default.target</code></pre>

<p>Notice the <code>[Container]</code> section. You just need to specify the <code>Image</code> you want to run and the command (<code>Exec</code>) that you want to run, and then you can use all of the other fields normally specified in a systemd unit file.</p>

<p>Now you need to inform systemd about the new unit file. Type:</p>

<pre><code>$ systemctl --user daemon-reload</code></pre>

<p>This creates a <code>mysleep.service</code> file based on the <code>mysleep.container</code> file.</p>

<pre><code>$ systemctl --user status mysleep.service
○ mysleep.service - The sleep container
 	Loaded: loaded (/home/dwalsh/.config/containers/systemd/mysleep.container; generated)
 	Active: inactive (dead)</code></pre>

<p>Now enable this service or start it up.</p>

<pre><code>$ systemctl --user start mysleep.service</code></pre>

<p>The <code>podman</code> command inside the generated service will download the <strong>ubi9-init</strong> image and start the specified command, <code>sleep 1000</code>.</p>

<p><strong><em>[ <a data-analytics-linktype="cta" href="https://lab.redhat.com/tracks/podman-deploy?intcmp=701f20000012ngPAAQ" target="_blank">Get hands on with Podman in this tutorial</a>. ]</em></strong></p>

<p>You can check the status of the service with:</p>

<pre><code>$ systemctl --user status mysleep.service
● mysleep.service - The sleep container
 	Loaded: loaded (/home/dwalsh/.config/containers/systemd/mysleep.container; generated)
 	Active: active (running) since Thu 2023-02-09 18:07:23 EST; 2s ago
   Main PID: 265651 (conmon)
  	Tasks: 3 (limit: 76815)
 	Memory: 1.6M
    	CPU: 94ms
 	CGroup: /user.slice/user-3267.slice/user@3267.service/app.slice/mysleep.service
         	├─libpod-payload-421c8293fc1ba7b6b08263e6895ed8187abb5ff136a7dfb073ed931883a68491
         	│ └─265653 /usr/bin/coreutils --coreutils-prog-shebang=sleep /usr/bin/sleep 1000
         	└─runtime
           	├─265648 /bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp &gt;
           	└─265651 /usr/bin/conmon --api-version 1 -c 421c8293fc1ba7b6b08263e6895ed8187abb5ff136a7dfb073ed&gt;

Feb 09 18:07:23 fedora systemd[2261]: Starting mysleep.service - The sleep container...
Feb 09 18:07:23 fedora podman[265630]: 2023-02-09 18:07:23.504068408 -0500 EST m=+0.044907849 container create &gt;
Feb 09 18:07:23 fedora podman[265630]: 2023-02-09 18:07:23.542799094 -0500 EST m=+0.083638534 container init 42&gt;
Feb 09 18:07:23 fedora systemd[2261]: Started mysleep.service - The sleep container.</code></pre>

<p>When Podman is installed, it registers a <a href="https://www.freedesktop.org/software/systemd/man/systemd.generator.html" target="_blank">systemd-generator</a> tool that looks for files in the above directories and runs the <code>/usr/libexec/podman/quadlet</code> executable.</p>

<p>You can examine the service file that Quadlet creates using the Quadlet command line:</p>

<pre><code>$ /usr/libexec/podman/quadlet -dryrun -user
quadlet-generator[265731]: Loading source unit file /home/dwalsh/.config/containers/systemd/mysleep.container
---mysleep.service---
[Unit]
Description=The sleep container
Before=local-fs.target
SourcePath=/home/dwalsh/.config/containers/systemd/mysleep.container
RequiresMountsFor=%t/containers

[X-Container]
Image=registry.access.redhat.com/ubi9-minimal:latest
Exec=sleep 1000

[Install]
# Start by default on boot
WantedBy=multi-user.target default.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
KillMode=mixed
ExecStopPost=-/usr/bin/podman rm -f -i --cidfile=%t/%N.cid
ExecStopPost=-rm -f %t/%N.cid
Delegate=yes
Type=notify
NotifyAccess=all
SyslogIdentifier=%N
ExecStart=/usr/bin/podman run --name=systemd-%N --cidfile=%t/%N.cid --replace --rm --log-driver passthrough --runtime /usr/bin/crun --cgroups=split --sdnotify=conmon -d registry.access.redhat.com/ubi9-minimal:latest sleep 1000</code></pre>

<p>The Quadlet-generated service file uses the same libraries as <code>podman generate systemd –new</code> but hides the complexity from the user.</p>

<p>One benefit is if a newer version of Podman is released with fixes or enhancements to the generator, your service is updated with the enhanced version the next time <code>systemctl daemon-reload</code> executes, such as upon reboot.</p>

<p>The container descriptions focus on the relevant container details, with no technical details about how the Podman integration works. This means they are straightforward to write and maintain, and integration can automatically improve as new Podman features become available. Now you can use the other cool features of Podman in systemd, like <a href="https://www.redhat.com/sysadmin/podman-auto-updates-rollbacks" target="_blank">auto-update and rollback</a>, for hands-free management of your containerized service&#39;s lifecycle.</p>



<p>Quadlet supports other advanced unit files, in addition to <strong>.container</strong>.</p>

<ul><li><strong>.kube</strong> allows you to specify a Kubernetes.yaml file, which tells Quadlet to create a service file to run pods and containers under systemd services based on Kubernetes.</li>
	<li><strong>.network</strong> tells Quadlet to create a service file that defines a Podman container network device. These network devices can then be used within <strong>.container</strong> and <strong>.kube</strong> unit files.</li>
	<li><strong>.volume</strong> tells Quadlet to create a service file that defines a Podman volume. These volumes can then be used within <strong>.container</strong> unit files.</li>
</ul><p>Find more information in the <a href="https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html" target="_blank">podman-systemd.unit(8)</a> file.</p>

<p>Future articles will describe advanced use cases for Quadlet.</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>Quadlet allows running containers under systemd in a declarative way. Similar to Compose or Kubernetes files, you can declare what you want to run without having to deal with all the complexities of running the workload.</p>

<p>Podman has a long history of integrating well into a modern Linux system, and Quadlet pushes the integration to the next level. Podman 4.4 has already been released to many Linux distributions, such as CentOS Stream and Fedora. Try out Quadlet and <a href="https://github.com/containers" target="_blank">let us know</a> what you think.</p>

<p><strong><em>[ <a href="https://enterprisersproject.com/kubernetes-everything-you-need-know?intcmp=701f20000012ngPAAQ" target="_blank">Kubernetes: Everything you need to know</a> ]</em></strong></p>
</div>
      
  
  </div></div>
  </body>
</html>
