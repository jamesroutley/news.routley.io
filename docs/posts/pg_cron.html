<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/citusdata/pg_cron">Original</a>
    <h1>Pg_cron</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text"><p dir="auto"><a href="https://www.citusdata.com/" rel="nofollow"><img src="https://github.com/citusdata/pg_cron/raw/main/github-banner.png" alt="Citus Banner"/></a></p>
<p dir="auto"><a href="https://slack.citusdata.com" rel="nofollow"><img src="https://camo.githubusercontent.com/02a19c775bbaf83cfd1f62a8ae110163cd48bda45bce19f64fdb51d54c09ff1a/687474703a2f2f736c61636b2e6369747573646174612e636f6d2f62616467652e737667" alt="Slack Status" data-canonical-src="http://slack.citusdata.com/badge.svg"/></a></p>
<h2 dir="auto"><a id="user-content-what-is-pg_cron" aria-hidden="true" href="#what-is-pg_cron"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What is pg_cron?</h2>
<p dir="auto">pg_cron is a simple cron-based job scheduler for PostgreSQL (10 or higher) that runs inside the database as an extension. It uses the same syntax as regular cron, but it allows you to schedule PostgreSQL commands directly from the database:</p>
<div data-snippet-clipboard-copy-content="-- Delete old data on Saturday at 3:30am (GMT)
SELECT cron.schedule(&#39;30 3 * * 6&#39;, $$DELETE FROM events WHERE event_time &lt; now() - interval &#39;1 week&#39;$$);
 schedule
----------
       42

-- Vacuum every day at 10:00am (GMT)
SELECT cron.schedule(&#39;nightly-vacuum&#39;, &#39;0 10 * * *&#39;, &#39;VACUUM&#39;);
 schedule
----------
       43

-- Change to vacuum at 3:00am (GMT)
SELECT cron.schedule(&#39;nightly-vacuum&#39;, &#39;0 3 * * *&#39;, &#39;VACUUM&#39;);
 schedule
----------
       43

-- Stop scheduling jobs
SELECT cron.unschedule(&#39;nightly-vacuum&#39; );
 unschedule 
------------
 t
(1 row)

SELECT cron.unschedule(42);
 unschedule
------------
          t"><pre><span><span>--</span> Delete old data on Saturday at 3:30am (GMT)</span>
<span>SELECT</span> <span>cron</span>.<span>schedule</span>(<span><span>&#39;</span>30 3 * * 6<span>&#39;</span></span>, $$<span>DELETE</span> <span>FROM</span> events <span>WHERE</span> event_time <span>&lt;</span> now() <span>-</span> interval <span><span>&#39;</span>1 week<span>&#39;</span></span>$$);
 schedule
<span><span>--</span>--------</span>
       <span>42</span>

<span><span>--</span> Vacuum every day at 10:00am (GMT)</span>
<span>SELECT</span> <span>cron</span>.<span>schedule</span>(<span><span>&#39;</span>nightly-vacuum<span>&#39;</span></span>, <span><span>&#39;</span>0 10 * * *<span>&#39;</span></span>, <span><span>&#39;</span>VACUUM<span>&#39;</span></span>);
 schedule
<span><span>--</span>--------</span>
       <span>43</span>

<span><span>--</span> Change to vacuum at 3:00am (GMT)</span>
<span>SELECT</span> <span>cron</span>.<span>schedule</span>(<span><span>&#39;</span>nightly-vacuum<span>&#39;</span></span>, <span><span>&#39;</span>0 3 * * *<span>&#39;</span></span>, <span><span>&#39;</span>VACUUM<span>&#39;</span></span>);
 schedule
<span><span>--</span>--------</span>
       <span>43</span>

<span><span>--</span> Stop scheduling jobs</span>
<span>SELECT</span> <span>cron</span>.<span>unschedule</span>(<span><span>&#39;</span>nightly-vacuum<span>&#39;</span></span> );
 unschedule 
<span><span>--</span>----------</span>
 t
(<span>1</span> row)

<span>SELECT</span> <span>cron</span>.<span>unschedule</span>(<span>42</span>);
 unschedule
<span><span>--</span>----------</span>
          t</pre></div>
<p dir="auto">pg_cron can run multiple jobs in parallel, but it runs at most one instance of a job at a time. If a second run is supposed to start before the first one finishes, then the second run is queued and started as soon as the first run completes.</p>
<p dir="auto">The schedule uses the standard cron syntax, in which * means &#34;run every time period&#34;, and a specific number means &#34;but only at this time&#34;:</p>
<div data-snippet-clipboard-copy-content=" ┌───────────── min (0 - 59)
 │ ┌────────────── hour (0 - 23)
 │ │ ┌─────────────── day of month (1 - 31)
 │ │ │ ┌──────────────── month (1 - 12)
 │ │ │ │ ┌───────────────── day of week (0 - 6) (0 to 6 are Sunday to
 │ │ │ │ │                  Saturday, or use names; 7 is also Sunday)
 │ │ │ │ │
 │ │ │ │ │
 * * * * *"><pre><code> ┌───────────── min (0 - 59)
 │ ┌────────────── hour (0 - 23)
 │ │ ┌─────────────── day of month (1 - 31)
 │ │ │ ┌──────────────── month (1 - 12)
 │ │ │ │ ┌───────────────── day of week (0 - 6) (0 to 6 are Sunday to
 │ │ │ │ │                  Saturday, or use names; 7 is also Sunday)
 │ │ │ │ │
 │ │ │ │ │
 * * * * *
</code></pre></div>
<p dir="auto">An easy way to create a cron schedule is: <a href="http://crontab.guru/" rel="nofollow">crontab.guru</a>.</p>
<p dir="auto">The code in pg_cron that handles parsing and scheduling comes directly from the cron source code by Paul Vixie, hence the same options are supported. Be aware that pg_cron always uses GMT!</p>
<h2 dir="auto"><a id="user-content-installing-pg_cron" aria-hidden="true" href="#installing-pg_cron"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Installing pg_cron</h2>
<p dir="auto">Install on Red Hat, CentOS, Fedora, Amazon Linux with PostgreSQL 12 using <a href="https://yum.postgresql.org/repopackages/" rel="nofollow">PGDG</a>:</p>
<div data-snippet-clipboard-copy-content="# Install the pg_cron extension
sudo yum install -y pg_cron_12"><pre><span><span>#</span> Install the pg_cron extension</span>
sudo yum install -y pg_cron_12</pre></div>
<p dir="auto">Install on Debian, Ubuntu with PostgreSQL 12 using <a href="https://wiki.postgresql.org/wiki/Apt" rel="nofollow">apt.postgresql.org</a>:</p>
<div data-snippet-clipboard-copy-content="# Install the pg_cron extension
sudo apt-get -y install postgresql-12-cron"><pre><span><span>#</span> Install the pg_cron extension</span>
sudo apt-get -y install postgresql-12-cron</pre></div>
<p dir="auto">You can also install pg_cron by building it from source:</p>
<div data-snippet-clipboard-copy-content="git clone https://github.com/citusdata/pg_cron.git
cd pg_cron
# Ensure pg_config is in your path, e.g.
export PATH=/usr/pgsql-12/bin:$PATH
make &amp;&amp; sudo PATH=$PATH make install"><pre>git clone https://github.com/citusdata/pg_cron.git
<span>cd</span> pg_cron
<span><span>#</span> Ensure pg_config is in your path, e.g.</span>
<span>export</span> PATH=/usr/pgsql-12/bin:<span>$PATH</span>
make <span>&amp;&amp;</span> sudo PATH=<span>$PATH</span> make install</pre></div>
<h2 dir="auto"><a id="user-content-setting-up-pg_cron" aria-hidden="true" href="#setting-up-pg_cron"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Setting up pg_cron</h2>
<p dir="auto">To start the pg_cron background worker when PostgreSQL starts, you need to add pg_cron to <code>shared_preload_libraries</code> in postgresql.conf. Note that pg_cron does not run any jobs as a long a server is in <a href="https://www.postgresql.org/docs/current/static/hot-standby.html" rel="nofollow">hot standby</a> mode, but it automatically starts when the server is promoted.</p>
<p dir="auto">By default, the pg_cron background worker expects its metadata tables to be created in the &#34;postgres&#34; database. However, you can configure this by setting the <code>cron.database_name</code> configuration parameter in postgresql.conf.</p>
<div data-snippet-clipboard-copy-content="# add to postgresql.conf:
shared_preload_libraries = &#39;pg_cron&#39;
cron.database_name = &#39;postgres&#39;"><pre><code># add to postgresql.conf:
shared_preload_libraries = &#39;pg_cron&#39;
cron.database_name = &#39;postgres&#39;
</code></pre></div>
<p dir="auto">After restarting PostgreSQL, you can create the pg_cron functions and metadata tables using <code>CREATE EXTENSION pg_cron</code>.</p>
<div data-snippet-clipboard-copy-content="-- run as superuser:
CREATE EXTENSION pg_cron;

-- optionally, grant usage to regular users:
GRANT USAGE ON SCHEMA cron TO marco;"><pre><span><span>--</span> run as superuser:</span>
CREATE EXTENSION pg_cron;

<span><span>--</span> optionally, grant usage to regular users:</span>
<span>GRANT</span> USAGE <span>ON</span> SCHEMA cron TO marco;</pre></div>
<p dir="auto"><strong>Important</strong>: By default, pg_cron uses libpq to open a new connection to the local database, which needs to be allowed by <a href="https://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html" rel="nofollow">pg_hba.conf</a>.
It may be necessary to enable <code>trust</code> authentication for connections coming from localhost in  for the user running the cron job, or you can add the password to a <a href="https://www.postgresql.org/docs/current/static/libpq-pgpass.html" rel="nofollow">.pgpass file</a>, which libpq will use when opening a connection.</p>
<p dir="auto">Alternatively, pg_cron can be configured to use background workers. In that case, the number of concurrent jobs is limited by the <code>max_worker_processes</code> setting, so you may need to raise that.</p>
<div data-snippet-clipboard-copy-content="# Schedule jobs via background workers instead of localhost connections
cron.use_background_workers = on
# Increase the number of available background workers from the default of 8
max_worker_processes = 20"><pre><code># Schedule jobs via background workers instead of localhost connections
cron.use_background_workers = on
# Increase the number of available background workers from the default of 8
max_worker_processes = 20
</code></pre></div>
<p dir="auto">You can also use a unix domain socket directory as the hostname and enable <code>trust</code> authentication for local connections in <a href="https://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html" rel="nofollow">pg_hba.conf</a>, which is normally safe:</p>
<div data-snippet-clipboard-copy-content="# Connect via a unix domain socket
cron.host = &#39;/tmp&#39;"><pre><code># Connect via a unix domain socket
cron.host = &#39;/tmp&#39;
</code></pre></div>
<p dir="auto">For security, jobs are executed in the database in which the <code>cron.schedule</code> function is called with the same permissions as the current user. In addition, users are only able to see their own jobs in the <code>cron.job</code> table.</p>
<h2 dir="auto"><a id="user-content-example-use-cases" aria-hidden="true" href="#example-use-cases"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Example use cases</h2>
<p dir="auto">Articles showing possible ways of using pg_cron:</p>
<ul dir="auto">
<li><a href="https://www.citusdata.com/blog/2018/01/24/citus-and-pg-partman-creating-a-scalable-time-series-database-on-postgresql/" rel="nofollow">Auto-partitioning using pg_partman</a></li>
<li><a href="https://www.citusdata.com/blog/2017/12/27/real-time-analytics-dashboards-with-citus/" rel="nofollow">Computing rollups in an analytical dashboard</a></li>
<li><a href="https://www.citusdata.com/blog/2016/09/09/pgcron-run-periodic-jobs-in-postgres/" rel="nofollow">Deleting old data, vacuum</a></li>
<li><a href="http://bonesmoses.org/2016/09/09/pg-phriday-irrelevant-inclinations/" rel="nofollow">Feeding cats</a></li>
<li><a href="https://fluca1978.github.io/2019/05/21/pgcron.html" rel="nofollow">Routinely invoking a function</a></li>
<li><a href="https://supabase.io/blog/2021/03/05/postgres-as-a-cron-server" rel="nofollow">Postgres as a cron server</a></li>
</ul>
<h2 dir="auto"><a id="user-content-managed-services" aria-hidden="true" href="#managed-services"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Managed services</h2>
<p dir="auto">The following table keeps track of which of the major managed Postgres services support pg_cron.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://aiven.io/postgresql" rel="nofollow">Aiven</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://www.alibabacloud.com/help/doc-detail/150355.htm" rel="nofollow">Alibaba Cloud</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://aws.amazon.com/rds/postgresql/" rel="nofollow">Amazon RDS</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://azure.microsoft.com/en-us/services/postgresql/" rel="nofollow">Azure</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://www.citusdata.com/product/cloud" rel="nofollow">Citus Cloud</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://www.crunchydata.com/products/crunchy-bridge/?ref=producthunt" rel="nofollow">Crunchy Bridge</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://www.digitalocean.com/products/managed-databases/" rel="nofollow">DigitalOcean</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://cloud.google.com/sql/postgresql/" rel="nofollow">Google Cloud</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://elements.heroku.com/addons/heroku-postgresql" rel="nofollow">Heroku</a></td>
<td><g-emoji alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">❌</g-emoji></td>
</tr>
<tr>
<td><a href="https://scalegrid.io/postgresql.html" rel="nofollow">ScaleGrid</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://www.scaleway.com/en/database/" rel="nofollow">Scaleway</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
<tr>
<td><a href="https://supabase.io/docs/guides/database" rel="nofollow">Supabase</a></td>
<td><g-emoji alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔️</g-emoji></td>
</tr>
</tbody>
</table>
</article>
        </div></div>
  </body>
</html>
