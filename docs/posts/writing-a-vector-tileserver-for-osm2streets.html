<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jakecoppinger.com/2023/01/lane-accurate-street-maps-with-openstreetmap-writing-a-vector-tileserver-for-osm2streets/">Original</a>
    <h1>Writing a Vector Tileserver for Osm2streets</h1>
    
    <div id="readability-page-1" class="page"><div>
<figure><img loading="lazy" width="2152" height="2112" src="https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap.png" alt="" srcset="https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap.png 2152w, https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap-300x294.png 300w, https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap-1024x1005.png 1024w, https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap-768x754.png 768w, https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap-1536x1507.png 1536w, https://jakecoppinger.com/wp-content/uploads/2023/01/safecyclingmap-2048x2010.png 2048w" sizes="(max-width: 2152px) 100vw, 2152px"/></figure>



<p>I’ve built <a href="https://safecyclingmap.com/" target="_blank" rel="noopener" title="">safecyclingmap.com</a>, an <a href="https://github.com/jakecoppinger/safe-cycling-map" target="_blank" rel="noopener" title="">open-source</a> proof of concept map that renders cycleways and streets down to the individual lanes, to assist cyclists picking safe routes and support advocacy for reallocating road space to more efficient modes (as supported by the TfNSW Future Transport Strategy).</p>



<p>I’ve open sourced the backend infrastructure so that others can incorporate the details into their web and phone maps (see <a href="https://github.com/jakecoppinger/osm2streets-vector-tileserver" target="_blank" rel="noopener" title="">osm2streets-vector-tileserver</a> or read below). This builds upon the incredible work of <a href="https://dabreegster.github.io/" target="_blank" rel="noreferrer noopener">Dustin Carlino</a> who leads the <a href="https://github.com/a-b-street/abstreet#ab-street" target="_blank" rel="noreferrer noopener">A/B Street traffic simulation project</a>.</p>



<p>I wrote the initial vector tileserver from scratch in one afternoon in Typescript, calling the JS bindings for the Rust osm2streets code compiled to wasm. It generates GeoJSON which is then returned by Koa as a protobuf. I’ve spent some more hours improving performance, but there is much that could be improved.</p>



<p>The TfNSW Future Transport Strategy states “We will focus on getting more out of our existing investments, by reallocating road space to more efficient modes of transport like buses, walking, cycling and micromobility devices.”</p>



<p>This blog post explains how and why I built it.</p>



<h3>Existing detailed street maps</h3>



<p>Most street maps just use a line for each street:</p>



<figure><img loading="lazy" width="1024" height="1005" src="https://jakecoppinger.com/wp-content/uploads/2023/01/straight_line_google-1024x1005.png" alt="" srcset="https://jakecoppinger.com/wp-content/uploads/2023/01/straight_line_google-1024x1005.png 1024w, https://jakecoppinger.com/wp-content/uploads/2023/01/straight_line_google-300x294.png 300w, https://jakecoppinger.com/wp-content/uploads/2023/01/straight_line_google-768x754.png 768w, https://jakecoppinger.com/wp-content/uploads/2023/01/straight_line_google-1536x1507.png 1536w, https://jakecoppinger.com/wp-content/uploads/2023/01/straight_line_google-2048x2010.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>Usually the colour of this line denotes how large or important the road is. If your city doesn’t have much dedicated bicycle infrastructure, picking a safe road can be a challenge.</p>



<p>In 2020 Google announced that it would be implementing more detailed street maps in selected cities:</p>



<blockquote><p>Soon, you’ll be able to see highly detailed street information that shows the accurate shape and width of a road to scale. You can also see exactly where sidewalks, crosswalks, and pedestrian islands are located… We’ll start rolling out detailed street maps in London, New York, and San Francisco in the coming months, with plans to expand to more cities over time.</p><cite><a href="https://blog.google/products/maps/more-detailed-colorful-map/">A more detailed, colorful map, Aug 18th 2020, Google.</a></cite></blockquote>



<p>Justin O’Beirne, a prolific writer on the consumer maps competitive landscape, <a href="https://www.justinobeirne.com/google-maps-detailed-street-maps-release-3" target="_blank" rel="noopener" title="">wrote in April 2022</a> that Google has released detailed street maps in 40 cities so far. No cities in Australia make up this list.</p>



<figure>
<figure><img loading="lazy" width="1024" height="1005" data-id="479" src="https://jakecoppinger.com/wp-content/uploads/2023/01/google_detailed-1024x1005.png" alt="" srcset="https://jakecoppinger.com/wp-content/uploads/2023/01/google_detailed-1024x1005.png 1024w, https://jakecoppinger.com/wp-content/uploads/2023/01/google_detailed-300x294.png 300w, https://jakecoppinger.com/wp-content/uploads/2023/01/google_detailed-768x754.png 768w, https://jakecoppinger.com/wp-content/uploads/2023/01/google_detailed-1536x1507.png 1536w, https://jakecoppinger.com/wp-content/uploads/2023/01/google_detailed-2048x2010.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>
</figure>



<h3>Open source competition</h3>



<p>OpenStreetMap (OSM) is a free, editable map of the whole world that is being built by volunteers largely from scratch and released with an open-content license. Because of the license it has grown quickly and now rivals (and often exceeds) the detail of commercial map providers. OSM data is used in Instagram, Wikipedia, Strava, Snapchat, Uber and many others.</p>



<p>An project using this data has been quietly generating highly detailed street maps. <a href="https://dabreegster.github.io/" target="_blank" rel="noreferrer noopener">Dustin Carlino</a> started building the <a href="https://github.com/a-b-street/abstreet#ab-street" target="_blank" rel="noreferrer noopener">A/B Street traffic simulation app</a> <a href="https://a-b-street.github.io/docs/project/history/year2.html" target="_blank" rel="noreferrer noopener">since around 2019</a>, and as part of this released the <a href="https://github.com/a-b-street/osm2streets" target="_blank" rel="noopener" title="">osm2streets</a> project. osm2streets takes OSM data and draws detailed shapes of streets – though didn’t yet support rendering into generic web or phone “slippy” maps as detailed on this <a href="https://github.com/a-b-street/osm2streets/issues/12" target="_blank" rel="noopener" title="">Github issue</a>.</p>



<figure><img loading="lazy" width="1024" height="706" src="https://jakecoppinger.com/wp-content/uploads/2023/01/brunswick-1024x706.png" alt="" srcset="https://jakecoppinger.com/wp-content/uploads/2023/01/brunswick-1024x706.png 1024w, https://jakecoppinger.com/wp-content/uploads/2023/01/brunswick-300x207.png 300w, https://jakecoppinger.com/wp-content/uploads/2023/01/brunswick-768x530.png 768w, https://jakecoppinger.com/wp-content/uploads/2023/01/brunswick-1536x1059.png 1536w, https://jakecoppinger.com/wp-content/uploads/2023/01/brunswick-2048x1413.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Brunswick, Melbourne rendered in A/B Street</figcaption></figure>



<p>I wrote an open source vector tileserver <a href="https://github.com/jakecoppinger/osm2streets-vector-tileserver" target="_blank" rel="noopener" title="">osm2streets-vector-tileserver</a> to enable “slippy” web and phone maps to load the detailed car and bicycle lane information that osm2streets generates.</p>



<p>As a proof of concept, I’ve built <a href="https://safecyclingmap.com/" target="_blank" rel="noopener" title="">safecyclingmap.com</a> to consume the tiles produced by <a href="https://github.com/jakecoppinger/osm2streets-vector-tileserver" target="_blank" rel="noopener" title="">osm2streets-vector-tileserver</a>. It is a visualisation of this detailed street data to assist cyclists with picking safe routes in cities with little dedicated cycling infrastructure.</p>



<h2>Technical details</h2>



<p><em>Bear in mind: I initially wrote the tileserver in one afternoon, and I haven’t put much effort into reliably hosting the infrastructure yet, so this could be improved.</em></p>



<p>The backend works by taking vector tile requests from a frontend (with a url like https://api.safecyclingmap.com/tile/18/241180/157318).</p>



<p>Once a request is received, the tile at zoom level 15 that contains the requested tile as a subset is calculated.</p>



<p>The OSM XML is then fetched from a local Overpass Turbo instance for that superset tile, and the osm2streets street network output for this tile is generated (using the JS to wasm (Rust) bindings at https://www.npmjs.com/package/osm2streets-js).</p>



<p>Requested subset tiles are then generated using the street network object that covers the superset tile.</p>



<p>The geojson layers are then generated and combined, and returned to the client as a Protobuf.</p>



<p>If you have any questions or are interested in contributing, come and join the Matrix room at <a href="https://matrix.to/#/#osm2streets-vector-tileserver:matrix.org" target="_blank" rel="noreferrer noopener">#osm2streets-vector-tileserver:matrix.org</a> or raise a PR at <a href="https://github.com/jakecoppinger/osm2streets-vector-tileserver" target="_blank" rel="noreferrer noopener">https://github.com/jakecoppinger/osm2streets-vector-tileserver</a>.</p>



<h3>Caching</h3>



<p>I’ve used two least-recently-used caches to cache the osm2streets network output, as well as the final individual vector tiles. Vector tiles requested that fit within the bounds of an in-progress zoom level 15 Overpass Turbo download (and associated network generation) busy-wait for the cache to become available (with a timeout if there is an error).</p>



<p>Currently it works in all of Australia, as downloading all map data for the entire world needs a larger hard drive! I needed 8GB of swap space to set up the docker image without a failure.</p>



<p>The frontend is currently hosted on Github pages (behind Cloudflare) because haven’t yet configured SSL config on AWS S3 for this domain.</p>



<p>The backend currently runs on a Vultr VPS, using Cloudflare Tunnel to send requests to <code>localhost:3000</code>.</p>



<h2>Further work</h2>



<p>Further features that I think would be useful:</p>



<ul><li>Making it work worldwide by passing requests outside Australia to a public Overpass instance from <a href="https://wiki.openstreetmap.org/wiki/Overpass_API#Public_Overpass_API_instances">https://wiki.openstreetmap.org/wiki/Overpass_API#Public_Overpass_API_instances</a> – with the new caching there shouldn’t too much traffic</li><li>Contributing to osm2streets to pass extra attributes in the vector tiles returned, such as:<ul><li>Speed of the street, to be able to colour code streets</li><li>Level of the street, to hide underground roads</li></ul></li></ul>









</div></div>
  </body>
</html>
