<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://djharper.dev/post/2023/01/29/intercepting-t.co-links-using-dns-rewrites/">Original</a>
    <h1>Intercepting t.co links using DNS rewrites</h1>
    
    <div id="readability-page-1" class="page"><div>
<article>

<p>
<time datetime="2023-01-29">Sunday, January 29, 2023</time>
</p>
<p>When someone links to something on twitter, either by embedding something or just pasting a URL, twitter will front it with its own <code>t.co</code> link. This means that you cannot verify what the URL is until you click it and your browser goes to the end result via <code>t.co</code>. I only really noticed this properly when my DNS sinkholing server (<a href="https://adguard.com/en/adguard-home/overview.html">Adguard home</a>) started blocking <code>t.co</code> links and I was getting an error when say, clicking a linked news article.</p>
<p>The obvious fix for this would be to just add <code>t.co</code> to my DNS allow list so these requests can go through. However, the fact that you cannot <em>see</em> the URL until you‚Äôve already navigated through to it irks me a lot, I‚Äôd rather verify the link I‚Äôm navigating to is something I want to visit.</p>
<p>There are browser extensions that solve this problem by modifying the DOM to uncloak the links (e.g. <a href="https://github.com/theAlinP/twitter-link-deobfuscator">twitter-link-deobfuscator</a>) which works pretty well, but this solution is limited to the browser and does not work on the Twitter app on Android. Other options are to copy the <code>t.co</code> link into a <a href="https://linkexpander.com/">link uncloaking website</a>, but this is fiddly and annoying, or install an <a href="https://github.com/Dakwamine/link-intercept">app on your phone</a></p>
<p>So I was looking for a more general solution that works across devices, what if there was a way of ‚Äúintercepting‚Äù when you click on <code>t.co</code> links, unwrapping where it eventually leads to and presenting the user an interstitial page detailing this, with an option to continue forward.</p>
<p>Enter <a href="https://github.com/djhworld/theunwrapper"><em>the unwrapper</em></a>, a small service I wrote this weekend that does exactly this, but it abuses a lot of safeguards we have in place for the web so comes at a high price.</p>
<figure>
<a href="https://djharper.dev/img/theunwrapper.png"><img src="https://djharper.dev/img/theunwrapper.png" title="Screenshot displaying the unwrapper service, displaying its features like unwrapping a link from t.co into its underlying form"/></a>
</figure>
<h2 id="the-unwrapper">The Unwrapper</h2>
<p>The service is just a go server that, when receiving a request for <code>t.co</code>, makes a HEAD request to the shortened link and extracts the <code>Location</code> header <em>before</em> the redirect is followed. If this is found, the value in the header is returned and rendered on a simple interstitial page.</p>
<p>But how do you intercept the calls to <code>t.co</code>? The magic comes in by using (abusing?) the DNS rewriting feature on Adguard home to intercept DNS requests for <code>t.co</code> and return the IP of my reverse proxy, and then adding a proxy rule to forward all requests for the host <code>t.co</code> to the go service.</p>
<figure>
<a href="https://djharper.dev/img/arch.excalidraw.png"><img src="https://djharper.dev/img/arch.excalidraw.png" title="Screenshot displaying the architecture of how the components fit together. The client makes a DNS request to Adguard Home, which rewrites t.co to return the IP of the reverse proxy, which then forwards requests to &#39;the unwrapper&#39; go service"/></a>
</figure>
<p>Surprisingly this worked pretty well, although with a huge caveat - this is your run of the mill Man in the Middle (MitM) attack. Browsers will, quite rightfully, complain that the certificate being presented from my reverse proxy is not valid for <code>t.co</code> so the user should not continue, or proceed with extreme caution.</p>
<p>To mitigate this I did something bad. Well, I‚Äôm already doing something bad, I run my own self-signed Certificate Authority (CA) and my reverse proxy uses certs signed by this CA. This root CA is trusted on my devices so I can access various internal services that run on my network when I‚Äôm connected to it, or via VPN when I‚Äôm remote.</p>
<p>With the badness in place, I figured why not add to it by adding <code>t.co</code> to the <code>Subject Alternative Name</code> on the cert for my reverse proxy? Now the browser has no problem and doesn‚Äôt complain anymore.</p>
<figure>
<a href="https://djharper.dev/img/secure.png"><img src="https://djharper.dev/img/secure.png" title="Screenshot displaying chrome trusting my self-signed certificate for t.co"/></a>
</figure>
<p>This is obviously a terrible solution and not recommended, but it works, and works on all my things, including the Twitter app on my phone. It‚Äôs bad though, I‚Äôm probably looking past a lot of other security issues that I‚Äôve just opened myself up to.</p>
<p>During my testing, another interesting issue quickly arose, a lot of the links cloaked under <code>t.co</code> tend to be links to <em>other</em> link shortening services like bit.ly, buff.ly, trib.al (as it turns out‚Ä¶.the list is endless) meaning the obfuscated link issue still remains.</p>
<h2 id="going-deeper">Going deeper</h2>
<p>So to get around this I extended the service to work with multiple ‚Äúknown‚Äù URL shortening services and ‚Äúfollow‚Äù the trail until you reach the end. Most of them work the same way, a simple redirect and <code>Location</code> header, so following the trail is really just finding where the chain stops, and throw an error if a cycle is detected.</p>
<p>It‚Äôs actually quite funny to see how many hops some of these links can take you on, the deepest I‚Äôve ever seen is a link from NYTimes taking you on a 9 hop voyage around various link shortening services. I‚Äôm guessing people are pasting short URLs to other short URLs into social media distribution platforms which just adds to the chain.</p>
<figure>
<a href="https://djharper.dev/img/nytime-unwrapped.png"><img src="https://djharper.dev/img/nytime-unwrapped.png" title="Screenshot displaying the unwrapper service for a link from the NY times, it shows one link jumping between 9 different short URLs to reach the actual underlying URL"/></a>
</figure>
<h2 id="bonus-feature">Bonus feature</h2>
<p>With the ‚Äúreal‚Äù link URL now avaialble it‚Äôs often polluted with various query parameters used for tracking or affiliate descriptors, so the service also strips these out and presents a ‚Äúcleaned‚Äù version of the link alongside the original which I can then choose to click on or copy to send to others.</p>
<h2 id="lessons-learned">Lessons learned</h2>
<p>I‚Äôm not sure whether I‚Äôm going to run this system full time as the obvious security safeguards put in place have just been overridden with hacky self signed certificates, DNS rewriting and other bad things, but it‚Äôs been a useful exercise in exploring what‚Äôs possible, even if it is absolutely awful. Probably should just unblock <code>t.co</code> on my adblocker and put the cowboy hacks aside for the time being ü§†</p>
</article>
</div></div>
  </body>
</html>
