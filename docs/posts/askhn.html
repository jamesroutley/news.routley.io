<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.patterns.app/blog/2023/02/19/ask-hn-gpt-embeddings-question-answering/">Original</a>
    <h1>Show HN: AskHN</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content" itemprop="articleBody"><p>(fyi, here’s <a href="https://github.com/patterns-app/patterns-components/tree/master/patterns_templates/Featured/AskHN" target="_blank" rel="noopener noreferrer">the code</a> for everything I built below, you can <a href="https://studio.patterns.app/graph/x3yklboqd95ouhpf60og/ask-hn-bot-public" target="_blank" rel="noopener noreferrer">clone and deploy the full app here</a> as well.)</p><p>“AskHN” is a GPT-3 bot I trained on a corpus of over 6.5 million Hacker News comments to represent the collective wisdom of the HN community in a single bot. You can query it <a href="https://discord.gg/patterns" target="_blank" rel="noopener noreferrer">here in our discord</a> using the <code>/askhn</code> command if you want to play around (I’ve rate-limited the bot for now to keep my OpenAI bill from bankrupting me, so you might have to wait around for your spot).</p><p>More details on how I built it below, but I found the LLM-embedded embodiment of HN’s wisdom to be an impressive and genuinely useful resource. Thousands of the sharpest minds in technology have volunteered up their expertise, wisdom, and occasional flame over the years. There are very few topics Ask HN Bot does not have a solid answer to, even the question of finding love!</p><p>It does well with job advice:</p><p><img loading="lazy" alt="google" src="https://www.patterns.app/assets/images/google-0bca67c9282ca312fc2cd6863362c057.png" width="601" height="1007"/></p><p>...classic flame wars:</p><p><img loading="lazy" alt="ds" src="https://www.patterns.app/assets/images/ds-5f8224fa6254648ee36061a3d039d4bb.png" width="588" height="795"/></p><p>...the important questions:</p><p><img loading="lazy" alt="love" src="https://www.patterns.app/assets/images/love-c15f8770cc130bba62720aad65d56050.png" width="590" height="993"/></p><p>...and unanswerable questions:</p><p><img loading="lazy" alt="bi" src="https://www.patterns.app/assets/images/bi-db5a0b54b872f8f8fb32a01dcd09989f.png" width="625" height="952"/></p><p>The GPT-3 prompted summaries are pretty good! And the linked articles are all very relevant -- the 1500 dimensions of the OpenAI GPT embeddings are enough to slice the semantic space for this use case.</p><p>It&#39;s main failure mode is summarizing contradictory / irrelevant comments into one response, which can lead to incoherence.</p><p>I built it in <a href="http://www.patterns.app" target="_blank" rel="noopener noreferrer">Patterns Studio</a> over the course of a few days. Here was my rough plan at the start:</p><ol><li>Ingest the entire HN corpus (bulk or API) - <strong>34.8 million stories and comments</strong> as of this writing</li><li>Play around with filtering to get the right set of content (top articles, top comments)</li><li>Bundle article title and top comment snippets into a document and fetch the OpenAI embedding via text-ada-embedding-002</li><li>Index the embeddings in a database</li><li>Accept questions via Discord bot (as well as manual input for testing)</li><li>Look-up closest embeddings</li><li>Put top matching content into a prompt and ask GPT-3 to summarize</li><li>Return summary along with direct links to comments back to Discord user</li></ol><p>This plan went ok, but results tended to be a bit to generic — I didn’t have enough of the specific relevant comment content in the prompt to give technical and specific answers. Embedding <em>every single one of the 6.5 eligible comments</em> was prohibitively time-consuming and expensive (12 hours and ~$2,000). So I ended up with this extension for step 6:</p><ol start="6"><li>Look-up closest embeddings (stories)<ol><li><em>With list of top N matching stories, get embeddings for all top comments on the stories at question-answering time</em></li><li><em>compute embeddings and similarity and choose top K comments closest to question</em></li><li><em>Put top matching comments into a prompt and ask GPT-3 to answer the question using the context</em></li></ol></li></ol><p>Let&#39;s dive into details for each of the steps above.</p><h3 id="ingesting-and-filtering-hn-corpus">Ingesting and filtering HN corpus<a href="#ingesting-and-filtering-hn-corpus" aria-label="Direct link to Ingesting and filtering HN corpus" title="Direct link to Ingesting and filtering HN corpus">​</a></h3><p>Using the <a href="https://github.com/HackerNews/API" target="_blank" rel="noopener noreferrer">firebase API</a>, downloaded the entire ~35m item database of HN comments and stories in parallel. This took about 30 minutes and left us with 4.8m stories and 30m comments. I filtered the stories to just those with more than 20 upvotes and at least 3 comments, this left me with 400k stories over the entire 17 year history of HN. I then further filtered to stories from the last 5 years, leaving us with a final number of 160k stories. For eligible comments, I filtered to those on an eligible story with at least 200 characters, for ~6.5 million comments total.</p><h3 id="gpt-embeddings">GPT embeddings<a href="#gpt-embeddings" aria-label="Direct link to GPT embeddings" title="Direct link to GPT embeddings">​</a></h3><p>To index these stories, I loaded up to 2000 tokens worth of comment text (ordered by score, max 2000 characters per comment) and the title of the article for each story and sent them to OpenAI&#39;s embedding endpoint, using the standard <code>text-embedding-ada-002</code> model, this endpoint accepts bulk uploads and is fast but all 160k+ documents still took over two hours to create embeddings. Total cost for this part was around $70.</p><p>The embeddings were then indexed with Pinecone.</p><h3 id="discord-bot">Discord bot<a href="#discord-bot" aria-label="Direct link to Discord bot" title="Direct link to Discord bot">​</a></h3><p>For a user interface, I decided to implement AskHN as a <a href="https://discord.gg/patterns" target="_blank" rel="noopener noreferrer">Discord bot</a>. Given that I needed to rate limit responses, having a Discord bot (over a dedicated web app, for instance) would allow for a more fun and collaborative experience of folks sharing questions and answers, even if any given individual did not get a chance to ask a question.</p><h3 id="answering-the-question">Answering the question<a href="#answering-the-question" aria-label="Direct link to Answering the question" title="Direct link to Answering the question">​</a></h3><p>With the embeddings indexed, and our bot live, responding to a given question involved the following steps:</p><ol><li>Give an immediate reply telling the user if we are working on the question or if the user has been rate limited.</li><li>Compute the embedding of the question and query Pinecone for top three most similar stories</li><li>Collect all top comments from all three stories, compute embeddings for all of these comments, and then rank by similarity to the question&#39;s embedding</li><li>Concatenate most similar comments (up to max 1000 tokens per comment) until max tokens limit reached (3500)</li><li>Build prompt with comments as context and send to GPT-3 to produce an answer</li></ol><p>There are often dozens or even hundreds of relevant comments that we get the embeddings for, luckily embeddings are cheap and fast, so the cost of this is much less than even the single call to GPT-3 for the completion.</p><p>With the top comments text in hand we build the final prompt for GPT-3 as:</p><div><div><pre tabindex="0"><code><span><span>prompt </span><span>=</span><span> </span><span>f&#34;&#34;&#34;</span><span>{</span><span>top_comments</span><span>}</span><span></span><br/></span><span><span></span><br/></span><span><span>Answer the following question by summarizing the above comments (where relevant),</span><br/></span><span><span>be specific and opinionated when warranted by the content:</span><br/></span><span><span></span><br/></span><span><span>Question: &#34;</span><span>{</span><span>question</span><span>}</span><span>&#34;</span><br/></span><span><span></span><br/></span><span><span>Answer: &#34;&#34;&#34;</span><br/></span></code></pre></div></div><p>I played around with a number of prompts, but the main thing is to get GPT-3 to break out of its &#34;Generic Helpful Internet Article&#34; voice and take a more opinionated stance when warranted. So I told it to do that, and it did :)</p><p>The methodology I used here is a generic, scalable solution for distilling a knowledge corpus into an embodied intelligence. Would I use a bot like this over <a href="https://hn.algolia.com" target="_blank" rel="noopener noreferrer">hn.algolia.com</a>? Maybe, maybe not. Would I appreciate this service added onto Algolia results page? Absolutely 100%.</p><p>Just shoot me an email Algolia, <a href="mailto:kvh@patterns.app" target="_blank" rel="noopener noreferrer">kvh@patterns.app</a>, happy to help!</p><p>This same architecture and flow would work well for almost any text corpus and question-answering bot. If you have such a use case, please feel free to reach out to me <a href="mailto:kvh@patterns.app" target="_blank" rel="noopener noreferrer">kvh@patterns.app</a> anytime to discuss my learnings or apply for <a href="https://www.patterns.app/docs/codev" target="_blank" rel="noopener noreferrer">our CoDev program</a> at Patterns. You can get started by cloning <a href="https://studio.patterns.app/graph/x3yklboqd95ouhpf60og/ask-hn-bot-public" target="_blank" rel="noopener noreferrer">the template for this bot</a>.</p></div></div>
  </body>
</html>
