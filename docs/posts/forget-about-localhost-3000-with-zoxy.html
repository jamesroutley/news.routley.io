<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://amedee.me/2022/11/06/zoxy/">Original</a>
    <h1>Forget about localhost:3000 with zoxy</h1>
    
    <div id="readability-page-1" class="page"><section>
			<p>Zoxy is an app that lets you type <code>hugo.z</code>, <code>next.z</code>, <code>jupyter.z</code>, or <code>kibana.z</code> instead of remembering <code>localhost:1313</code>, <code>localhost:3000</code>, <code>localhost:8888</code>, or <code>localhost:5601</code>.</p>
<p>Here‚Äôs me going to the local version of this blog by typing <code>http://hugo.z</code></p>
<p><img src="https://v5.chriskrycho.com/img/Screen%20Shot%202022-10-10%20at%204.25.23%20PM.png" alt="A screenshot of Firefox with hugo.z in the URL showing the local version of this website"/></p>
<p>Convinced? Skip down to <a href="#zoxy">here</a> to download and use it.</p>
<p>What is the point of this, you ask? Why save a couple seconds typing out a port number?
the thing is, each trick saves a lot more than the 2s it takes to type out something longer: it keeps your mind from overheating and makes interacting with the computer less like talking to a screeching alien, and more like expressing your creative intent.</p>
<p>For example, I really liked learning from a coworker you can toggle between two git branches with <code>git switch -</code> (or <code>git checkout -</code> if you‚Äôre like me and still haven‚Äôt learned the new git command names), the <code>-</code> is a shortcut for the last branch you were on.</p>
<h3 id="the-problem-localhostwxyz-got-tiring">The problem: <code>localhost:wxyz</code> got tiring</h3>
<p>Another example of cognitive friction is remembering <code>localhost:1234</code>-type port numbers.
At work we had to remember <code>localhost:4000</code> for our API server and <code>localhost:3000</code> for the SPA frontend <sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>,  then we added lots of smaller apps maintained by different teams: one on <code>:3001</code>, another on <code>:3030</code>. There were also new web dashboards to check like Kibana on <code>:5601</code>.</p>
<p>At work there are better ways to fix the port sprawl problem <sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>, but even at home this comes up with apps that spin up their own localhost servers like Hugo (<code>:1313</code>) or Jupyter Notebook (<code>:8888</code>).
Sometimes I‚Äôll leave Hugo open a while writing a blog post and forget which port it came from, even if it printed its port at startup. I don‚Äôt want to have to context-switch to the terminal or a README to find what port to use.</p>
<p>This seems like an easy problem to fix too. Shouldn‚Äôt you be able to do this already, maybe with the hosts file?</p>
<h3 id="can-you-fix-this-with-a-hosts-file">Can you fix this with a hosts file?</h3>
<p>For those unfamiliar, the <code>/etc/hosts</code> file on Unix systems is a place you can ‚Äúhardcode‚Äù DNS answers.
Sometimes a website‚Äôs DNS will be down but their actuall app will still be up, so you can hardcode its IP into the hosts file and <code>website.com</code> will still work in your browser.
You can also use it to block a website from your computer by adding eg <code>127.0.0.1 instagram.com</code> , which will make all instagram requests go to localhost üòõ.</p>
<p>The hosts file doesn‚Äôt help here because it only affects <strong>DNS</strong> resolution, that is it maps domain names to IPs, but not port numbers.
You can add <code>z 127.0.0.1</code> in there to alias <code>localhost</code> to a single letter, but you‚Äôd still have to type the port numbers, eg <code>z:8888</code> into your browser. I really didn‚Äôt want to have to remember the port numbers.</p>
<h3 id="can-you-fix-this-with-the-local-or-lan-domain">Can you fix this with the .local or .lan domain?</h3>
<p>On your local network, you can ssh, curl, and generally access other machines using their hostnames , like <code>ping hostname.lan</code> . Can we do something where you get eg <code>jupyter.amedee.lan</code> ?</p>
<p>Turns out you can‚Äôt.
The way that hostnames get resolved into port numbers is called <a href="https://en.wikipedia.org/wiki/Multicast_DNS">mDNS</a> (afaict when you look up <code>some-hostname.lan</code> a DNS packet gets passed around the network until the right machine gets it), but since it‚Äôs still DNS it would only give you an IP and not let you add a port number.
We‚Äôre going to need a server that proxies requests from port 80 to eg :3030 or :8080 based on the URL it‚Äôs given. <sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup></p>
<p>I wanted the <code>.z</code> tld because it‚Äôs really short to type and it feels cognitively ‚Äúeasy‚Äù to remember as the last letter in the alphabet. The solution needed to let me type <code>next.z</code> into my browser and have it redirect/proxy to <code>localhost:3000</code>.</p>
<p>I came up with a small 200LOC Go program called <a href="https://gitlab.com/amedeedabo/zoxy">zoxy</a> that does this.</p>
<h2 id="zoxy">Zoxy</h2>
<p>Zoxy proxies from <code>localhost:xyz</code> to <code>myapp.z</code> URLs and comes with a pre-built list of popular dev servers ports
like <code>webpack.z-&gt;:8080</code> and <code>jupyter.z:8888</code>.</p>
<p>On Mac<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup> you can install it with:</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>brew install amedeedaboville/tap/zoxy
</span></span><span><span>
</span></span><span><span><span># Tell your computer to use zoxy as the DNS resolver for .z</span>
</span></span><span><span>sudo tee <span>`</span>127.0.0.1<span>`</span> &gt;&gt; /etc/resolvers/z
</span></span><span><span>
</span></span><span><span>brew services start zoxy
</span></span></code></pre></div><p>Then you can go to any of the default configured apps by browsing to <code>http://name.z</code></p>
<p>Here‚Äôs another example going to <code>next.z</code> :</p>
<p><img src="https://v5.chriskrycho.com/img/Screen%20Shot%202022-10-10%20at%206.09.39%20PM.png" alt="A screenshot of Firefox with next.z in the URL bar, showing the Nextjs welcome screen."/></p>
<p>I quickly made a list of popular apps/local dev servers and their ports <a href="https://gitlab.com/amedeedabo/zoxy/-/blob/main/config.go#L61">here</a>. If you see a popular app that‚Äôs missing that you think should be added, please file an issue/submit a PR!</p>
<h3 id="how-do-i-add-my-own-mappings">How do I add my own mappings?</h3>
<p>Say you want want to map your own custom app from <code>localhost:7000</code> to <code>myapp.z</code>.</p>
<p>You can add your own mappings to <code>~/Library/Application Support/zoxy/config.json</code>. (You can print this path with <code>zoxy config path</code>):</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>{
</span></span><span><span>	&#34;ports&#34;: {
</span></span><span><span>		&#34;myapp&#34;: 7000,
</span></span><span><span>		&#34;app1&#34;: 3000,
</span></span><span><span>		&#34;app2&#34;: 3001,
</span></span><span><span>		&#34;app3&#34;: 3030,
</span></span><span><span>		&#34;kibana&#34;: 5892
</span></span><span><span>		&#34;backoffice-node&#34;: 3333,
</span></span><span><span>	},
</span></span><span><span>	&#34;aliases&#34;: {
</span></span><span><span>        &#34;b&#34;: &#34;backoffice-node&#34;
</span></span><span><span>	}
</span></span><span><span>}
</span></span></code></pre></div><p>Personally, this helps a lot with all the individual apps at my work.</p>
<p>I also added a level of aliasing to get shorter names: if the name of an app like <code>backoffice-node.z</code> feels long, you can also add an alias like <code>b.z</code> that will map to the same port.</p>
<p>Just one note that people have given is that the browser often ‚Äúhelpfully‚Äù searches the .z URL instead of going to it. To get around this in the majority of browsers you can add a trailing / to the URL, like <code>website.z/</code> and Chrome/FF/Safari will go directly to that URL.</p>
<p>Try it out and let me know how it works! The majority of it was written on an airplane in Go because it was the only language that had offline/preinstalled docs (<code>go doc</code>) off the top of my head.<sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup>
Go is also the perfect language to make little servers like this because of the built-in net/http package in its standard library, but I hadn‚Äôt used it in a few years and have completely forgotten the idioms.
If you work in Go, I‚Äôd appreciate some feedback on the <a href="https://gitlab.com/amedeedabo/zoxy/-/tree/main/">code</a>.</p>
<h3 id="how-does-it-work">How does it work?</h3>
<p>When you type <code>jupyter.z</code>, your browser uses DNS to look up the IP address it should connect to.</p>
<ol>
<li>zoxy hosts the simplest possible DNS server on port 53, which replies to every DNS single request with:</li>
</ol>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>whateveryouaskedfor.z A 127.0.0.1
</span></span></code></pre></div><p>With that answer in hand, your browser makes a request to <code>127.0.0.1</code> on port 80 with the <code>Host</code> header set to what‚Äôs in the URL bar:</p>
<div><pre tabindex="0"><code data-lang="fallback"><span><span>GET / HTTP/1.1
</span></span><span><span>Host: jupyter.z
</span></span><span><span>Accept-Encoding: gzip, deflate
</span></span><span><span>... # a bunch of stuff
</span></span></code></pre></div><ol start="2">
<li>zoxy hosts a server on port 80 so it also gets this request.
It reads the <code>Host</code> header, and sees if it has a matching port mapping for <code>jupyter.z</code>.</li>
</ol>
<p>It also does a couple tricks like mapping <code>eight.z</code> to <code>:8000</code>, and <code>1234.z</code> to <code>:1234</code> in case you know the port but don‚Äôt want to type out all 9 characters that spell out <code>localhost</code>.</p>
<p>Once zoxy has figured out what port to map your request to, it changes the <code>Host</code> header to have the correct port, like <code>localhost:8888</code> , and then proxies the request there as well with a Go <a href="https://go.dev/src/net/http/httputil/reverseproxy.go">ReverseProxy</a> instance.</p>
<h3 id="what-about-tlsother-features">What about TLS/other features?</h3>
<p>For now zoxy is HTTP only, but I plan on adding TLS on port 443 later.
I know some people use local proxies to connect to their apps with HTTPS and test out browser features that require a <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts">Secure Context</a> (which requires a <code>https://</code> scheme), but I‚Äôve never done it before.</p>
<p>At first I thought it might be cool to <a href="https://caddyserver.com/docs/extending-caddy">embed Caddy Server</a> to do the reverse proxying. Caddy has TLS out of the box and a ton more features, but I‚Äôm going to hold off for now unless some other cool use cases come up, because I like how small the code is.</p>
<p>My next feature is going to be implementing file watching to avoid needing to restart the server when you edit the config file.</p>
<h3 id="why-not-use-puma-dev">Why not use puma-dev?</h3>
<p>After building this a coworker showed me <a href="https://github.com/puma/puma-dev">puma-dev</a>, which is the closest thing to what I wanted!
It‚Äôs also written in Go, so I‚Äôl be going and reading that code to improve zoxy.
Although <code>puma-dev</code> has more features, it also has more configuration and is more Rails-centered, which makes me prefer
my little tool that works out of the box.</p>
<h2 id="conclusion">Conclusion</h2>
<p><a href="https://gitlab.com/amedeedabo/zoxy#Installing">Try it out</a>, <a href="https://gitlab.com/amedeedabo/zoxy/-/blob/main/main.go">read the source</a>, recommend new port maps, tell me what you think! I like this little tool and I like the feeling of using something I built in my every day.</p>



			
				<hr/>
				


<a href="https://disqus.com">comments powered by </a>
			

			<hr/>
			


<ul>
	
	<li><a href="https://v5.chriskrycho.com/2022/08/22/7-powers-programming-languages/">The 7 Powers in Programming Language Adoption</a></li>
	
	<li><a href="https://v5.chriskrycho.com/2021/02/13/pdq-emscripten-4/">Compiling LibPDQ to JS with Emscripten Part 4: Writing Docs &amp; Emitting Typescript</a></li>
	
	<li><a href="https://v5.chriskrycho.com/2021/01/28/emscripten-libpdq-3/">Compiling LibPDQ to JS with Emscripten Part 3: All in JS ‚Üí Pushing to NPM</a></li>
	
	<li><a href="https://v5.chriskrycho.com/2020/12/28/emscripten-libpdq-2/">Compiling LibPDQ to JS with Emscripten Part 2: Using C functions in JS</a></li>
	
	<li><a href="https://v5.chriskrycho.com/2020/12/13/emscripten-libpdq/">Compiling LibPDQ to JS with Emscripten: First steps</a></li>
	
</ul>

		</section></div>
  </body>
</html>
