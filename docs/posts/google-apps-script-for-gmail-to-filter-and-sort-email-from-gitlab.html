<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/mattst88/gmail-gitlab-filtering">Original</a>
    <h1>Google Apps Script for Gmail to filter and sort email from Gitlab</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text">
<p dir="auto"><code>gmail-gitlab-filtering.gs</code> is a <a href="https://developers.google.com/apps-script" rel="nofollow">Google Apps Script</a> for Gmail to sort and filter email from <a href="https://about.gitlab.com/" rel="nofollow">GitLab</a>.</p>
<p dir="auto"><a href="https://github.com/mattst88/gmail-gitlab-filtering/blob/master/LICENSE"><img src="https://camo.githubusercontent.com/50dde604f429bb4ecbb7c4c2178566883626b3a6fa188bd9b8c04586cdf84541/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d425344322d626c75652e737667" alt="BSD-2 license" data-canonical-src="https://img.shields.io/badge/License-BSD2-blue.svg"/></a></p>

<p dir="auto">Receiving all messages from a mailing list and filtering by whether I am a direct recipient (in <code>To:</code> or <code>Cc:</code>) has been an effective strategy for me to both</p>
<ol dir="auto">
<li>follow development at large</li>
<li>not miss requests for my input</li>
</ol>
<p dir="auto">With mailing lists, I accomplish this with a combination of Gmail filters:</p>
<div data-snippet-clipboard-copy-content="Matches: to:(mattst88@gmail.com)
Do this: Apply label &#34;mattst88&#34;"><pre><code>Matches: to:(mattst88@gmail.com)
Do this: Apply label &#34;mattst88&#34;
</code></pre></div>
<div data-snippet-clipboard-copy-content="Matches: list:mesa-dev.lists.freedesktop.org
Do this: Apply label &#34;mesa-dev&#34;"><pre><code>Matches: list:mesa-dev.lists.freedesktop.org
Do this: Apply label &#34;mesa-dev&#34;
</code></pre></div>
<div data-snippet-clipboard-copy-content="Matches: -{to:mattst88@gmail.com}
Do this: Skip Inbox"><pre><code>Matches: -{to:mattst88@gmail.com}
Do this: Skip Inbox
</code></pre></div>
<p dir="auto">Thus, mail from mailing lists is labeled appropriately and doesn&#39;t clutter my inbox. Any messages with me in <code>To:</code> or <code>Cc:</code> cause the thread to be labeled with a personal <code>mattst88</code> label and appear in the inbox.</p>
<p dir="auto">I have not been able to replicate this with GitLab and Gmail, given the limitations of each.</p>
<p dir="auto">Emails from GitLab contain <a href="https://docs.gitlab.com/ee/user/profile/notifications.html#email-headers-you-can-use-to-filter-email" rel="nofollow">many headers</a> that can be used to filter the message. Of the headers GitLab uses, Gmail&#39;s filtering system can only filter on <code>List-Id</code>.</p>
<p dir="auto">GitLab can be configured to email updates under different circumstances: any activity, only for threads you&#39;ve participated in, only for comments that mention you, etc.</p>
<p dir="auto">This leaves me with a choice of receiving notifications only for threads I&#39;m involved in or for all threads but without the ability to easily find requests directed to me.</p>

<p dir="auto">Google Apps Script provides a method of automating many operations on a Gmail account (sending email, searching, labeling, etc.) via the <a href="https://developers.google.com/apps-script/reference/gmail" rel="nofollow">GmailApp</a> class. The <code>gmail-gitlab-filtering.gs</code> script is run every 10 minutes via a trigger on scripts.google.com and performs filtering and labeling based on the <code>X-GitLab</code> headers.</p>
<p dir="auto">This allows me to appropriately label notifications that are directed to me, as well as dynamically create labels for notifications received from new projects.</p>
<h2 dir="auto"><a id="user-content-how" aria-hidden="true" href="#how"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How</h2>
<p dir="auto">Email from GitLab is labeled using Gmail&#39;s default filtering with a top-level label and skips the inbox. In my case, all mail from <code>gitlab@gitlab.freedesktop.org</code> is given the <code>freedesktop</code> label:</p>
<div data-snippet-clipboard-copy-content="Matches: from:(gitlab@gitlab.freedesktop.org)
Do this: Skip Inbox, Apply label &#34;freedesktop&#34;"><pre><code>Matches: from:(gitlab@gitlab.freedesktop.org)
Do this: Skip Inbox, Apply label &#34;freedesktop&#34;
</code></pre></div>
<p dir="auto">Threads with this label are considered unprocessed.</p>
<p dir="auto">The <code>gmail-gitlab-filtering.gs</code> script searches for threads with that label, and inspects the headers of each message using the <a href="https://developers.google.com/apps-script/reference/gmail/gmail-message#getHeader(String)" rel="nofollow">GmailMessage.getHeader()</a> function.</p>
<p dir="auto">The script records the value of all <code>X-GitLab-Project-Path</code> headers and whether any message in the thread contained a <code>X-GitLab-NotificationReason</code> header.</p>
<p dir="auto">Threads containing a <code>X-GitLab-NotificationReason</code> header retain the personal label and are moved to the inbox. Threads without <code>X-GitLab-NotificationReason</code> header remain archived and the personal label is removed. All threads are labeled with <code>${unprocessedLabel}/${X-GitLab-Project-Path}</code>, and the label is dynamically created if needed. The unprocessed label is always removed as the final step, in case the script&#39;s runtime exceeds the allowed timelimit (see below).</p>
<p dir="auto">For example, if I were to receive a notification of a merge request in the <a href="https://gitlab.freedesktop.org/mesa/shader-db/" rel="nofollow">mesa/shader-db</a> project that mentioned me, the script would move the thread to the inbox, leave the <code>mattst88</code> label intact, label the mail <code>freedesktop/mesa/shader-db</code> (creating the label if needed), and remove the <code>freedesktop</code> label.</p>
<h2 dir="auto"><a id="user-content-implementation-notes-and-limitations" aria-hidden="true" href="#implementation-notes-and-limitations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Implementation notes and limitations</h2>
<p dir="auto">None of the limitations cause problems for my usage. I receive a few hundred GitLab notifications per day.</p>
<h3 dir="auto"><a id="user-content-google-apps-scripts-are-subject-to-quotas" aria-hidden="true" href="#google-apps-scripts-are-subject-to-quotas"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Google Apps Scripts are <a href="https://developers.google.com/apps-script/guides/services/quotas" rel="nofollow">subject to quotas</a>.</h3>
<p dir="auto">While developing this script, I hit two quotas:</p>
<ul dir="auto">
<li>Script runtime: 6 min / execution</li>
<li>Email read/write (excluding send): 20,000 / day</li>
</ul>
<p dir="auto">To fit into the 6 minutes / execution limit, the script operates on a maximum of 240 threads per execution. See the <code>maxThreads</code> variable. I arrived at the 240 number empirically; it&#39;s not definitive.</p>
<p dir="auto">I reached the 20,000 / day email read/write quota during development and expect to never reach it again now that the script functions.</p>
<p dir="auto">To improve efficiency (and perhaps avoid hitting quotas), the script creates lists of <a href="https://developers.google.com/apps-script/reference/gmail/gmail-thread" rel="nofollow">GmailThread</a>s so they can be passed in batches to <a href="https://developers.google.com/apps-script/reference/gmail/gmail-app#moveThreadsToInbox(GmailThread)" rel="nofollow">GmailApp.moveThreadsToInbox</a>, <a href="https://github.com/mattst88/gmail-gitlab-filtering/blob/master/addToThreads">GmailLabel.addToThreads</a>, and <a href="https://developers.google.com/apps-script/reference/gmail/gmail-label#removeFromThreads(GmailThread)" rel="nofollow">GmailLabel.removeFromThreads</a>  †. It&#39;s unclear to me which functions use quota and how much they use.</p>
<p dir="auto">† These functions accept only 100 threads per call, so the script calls them multiple times on <code>.slice()</code>s of the lists.</p>
<h3 dir="auto"><a id="user-content-google-apps-scripts-dont-support-asyncawait" aria-hidden="true" href="#google-apps-scripts-dont-support-asyncawait"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Google Apps Scripts don&#39;t support async/await</h3>
<p dir="auto">I initially though I would be able to improve performance of the script by using <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Async_await" rel="nofollow">async/await</a>. While the V8 Runtime <a href="https://developers.google.com/apps-script/guides/v8-runtime?hl=en#improved_function_detection" rel="nofollow">recognizes the keywords</a> it does not make use of them. An upstream bug is filed <a href="https://issuetracker.google.com/issues/149937257" rel="nofollow">here</a>.</p>
<p dir="auto">I found an interesting work-around: <a href="https://gist.github.com/sdesalas/2972f8647897d5481fd8e01f03122805">Async.gs</a>. It works by scheduling a script execution in the future. I did not experiment with it.</p>

<ol dir="auto">
<li>Create a project on <a href="https://script.google.com/" rel="nofollow">script.google.com</a></li>
<li>Paste <code>gmail-gitlab-filtering.gs</code> into the default <code>Code.gs</code> file</li>
<li>Modify as needed for your particular filtering rules</li>
<li>Set up a trigger to run the script periodically. I followed the instructions from <a href="https://mjasion.pl/" rel="nofollow">Marcin Jasion</a>&#39;s <a href="https://mjasion.pl/label-gitlab-notifications/" rel="nofollow">How to label GitLab notification in Gmail by headers?</a> article.</li>
</ol>

<p dir="auto">I muddled through writing the script with the help of the <a href="https://developers.google.com/apps-script/overview" rel="nofollow">Apps Script documentation</a> and the Mozilla Web Docs <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" rel="nofollow">JavaScript Reference</a>. Improvements to the code are welcome.</p>
</article>
        </div></div>
  </body>
</html>
