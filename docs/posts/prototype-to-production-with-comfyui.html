<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://modal.com/blog/comfyui-prototype-to-production">Original</a>
    <h1>Prototype to production with ComfyUI</h1>
    
    <div id="readability-page-1" class="page"><div>
      <a href="https://modal.com/blog"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        <span>Back</span></a>
      <p>Technology</p>
      <p><span>April 2, 2024</span><span>•</span><span>7 minute read</span></p></div><div>




<div><p><a rel="nofollow" href="https://github.com/comfyanonymous/ComfyUI">ComfyUI</a> is a popular no-code,
visual editor for building complex image generation workflows. Because of its
ease of use and customizability, the community of ComfyUI users has built an
impressive collection of workflows in a relatively short period of time, such
as:</p>
<ul><li><a rel="nofollow" href="https://x.com/BennyKokMusic/status/1764110674295493074?s=20">Sketch to image</a></li>
<li><a rel="nofollow" href="https://openart.ai/workflows/akihungac/hybrid-upscaler-workflow-just-having-it-is-enough/Q6XNUZpVmarUkDAEIZN4">Image upscaling</a></li>
<li><a rel="nofollow" href="https://github.com/comfyanonymous/ComfyUI_examples/tree/master/inpaint">Inpainting</a>
i.e. filling in an image based on a prompt</li></ul>
<p>Prototyping with ComfyUI is fun and easy, but there isn’t a lot of guidance
today on how to “productionize” your workflow, or serve it as part of a larger
application. In this blog post, I’m going to show you how you can use Modal to
manage your ComfyUI development process from prototype to production as a
scalable API endpoint.</p>
<h2 id="example-serve-comfyui-inpainting-as-an-api-endpoint">Example: Serve ComfyUI inpainting as an API endpoint</h2>
<p>Check out our
<a rel="nofollow" href="https://github.com/modal-labs/modal-examples/blob/main/06_gpu_and_ml/comfyui/workflow_api.py">ComfyUI API example</a>,
which stands up a web endpoint that takes a prompt and input image via http
request, runs the ComfyUI inpainting example, and writes the generated image to
a <a rel="nofollow" href="https://modal.com/docs/guide/volumes">volume</a>.</p>
<p><img src="https://modal.com/_app/immutable/assets/comfyui-inpainting-example.c7eb7096.png" alt="ComfyUI inpainting workflow screenshot"/>



</p><p>
Source: https://github.com/comfyanonymous/ComfyUI_examples/tree/master/inpaint

</p><p>To run this example, first <a rel="nofollow" href="https://modal.com/">sign up for an account</a> and
clone our <a rel="nofollow" href="https://github.com/modal-labs/modal-examples/">examples repo</a>. To
stand up the web endpoint, run:</p>


<p>Then, pass a prompt and input image via HTTP. This triggers a ComfyUI workflow
run and saves the generated image to a volume:</p>


<p>This diagram illustrates how you can turn your own ComfyUI workflow into a
production-ready endpoint:</p>
<p><img src="https://modal.com/_app/immutable/assets/comfy-ui-diagram.ece91934.jpg" alt="ComfyUI workflow daigram"/>



</p>
<ol><li>Spin up a ComfyUI development instance</li>
<li>Export your workflow as JSON</li>
<li>Run our
<a rel="nofollow" href="https://github.com/modal-labs/modal-examples/blob/main/06_gpu_and_ml/comfyui/comfy_api.py#L158">helper function</a>
to eject from JSON into a Python-based ComfyUI workflow</li>
<li>Serve your workflow as a
<a rel="nofollow" href="https://modal.com/docs/guide/webhooks#web-endpoints">web endpoint</a></li></ol>
<p>Read on for more detail in each step, or watch this walkthrough video:</p>
<p><iframe src="https://www.youtube.com/embed/julgiZqWLHc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
</p>
<h2 id="1-spin-up-a-comfyui-development-instance">1) Spin up a ComfyUI development instance</h2>
<p>Run our <a rel="nofollow" href="https://modal.com/docs/examples/comfy_ui#run-comfyui">ComfyUI example</a>
to spin up your own ComfyUI development instance where you can build your
workflow:</p>


<p>This spins up a container running ComfyUI that you can access at a url like
<code>https://&lt;your-workspace-name&gt;--example-comfy-ui-web-dev.modal.run</code></p>
<p>You can further customize this ComfyUI instance by adding custom checkpoints to
<code>CHECKPOINTS</code> and custom plugins to <code>PLUGINS</code> in the <code>comfy_ui.py</code> script. This
will rebuild the image and you may need to refresh your browser.</p>
<p>When you are done with your session, remember to Ctrl+C out of the container to
spin down the instance so you aren’t charged for inactivity.</p>
<h2 id="2-export-your-workflow-as-json">2) Export your workflow as JSON</h2>
<p>After you’ve designed your workflow in the UI, the first step to productionizing
it is to export the workflow as an API-compatible JSON object.</p>
<p>To do so, first click the gear icon in the top right of the menu box:</p>
<p><img src="https://modal.com/_app/immutable/assets/comfyui-menu-box.d2d833e3.jpeg" alt="ComfyUI menu box with gear circled"/>



</p>
<p>Then, check Enable Dev mode Options:</p>
<p><img src="https://modal.com/_app/immutable/assets/comfyui-dev-options-box.f7cce374.jpeg" alt="ComfyUI enable dev options selection"/>



</p>
<p>Now you should see a Save (API Format) option in your menu:</p>
<p><img src="https://modal.com/_app/immutable/assets/comfyui-api-json-button.2f5bbafb.jpeg" alt="ComfyUI menu with api json cirlced"/>



</p>
<p>Copy the contents of that file into the <code>workflow_api.json</code> file within the
<code>comfyui</code> folder in our examples repo.</p>
<h2 id="3-eject-out-of-json-into-python">3) Eject out of JSON into Python</h2>
<p>This JSON can be used directly in an
<a rel="nofollow" href="https://github.com/comfyanonymous/ComfyUI/blob/master/script_examples/basic_api_example.py">API request</a>
to a running ComfyUI instance. However, this approach has some drawbacks:</p>
<ul><li>You need to spin up a separate ComfyUI server to receive requests</li>
<li>You have to parameterize a complex JSON object to handle user input</li></ul>
<p>We recommend using this
<a rel="nofollow" href="https://github.com/modal-labs/modal-examples/blob/main/06_gpu_and_ml/comfyui/comfy_api.py#L154">get_python_workflow</a>
helper function that calls a
<a rel="nofollow" href="https://github.com/pydn/ComfyUI-to-Python-Extension">ComfyUI-to-Python extension</a>
to turn this JSON into a Python script called <code>_generated_workflow_api.py</code>.</p>


<p>This script is not immediately runnable out of the box, and we’ll show how to
reference it in step 4. At a high level, the script makes the connection between
a JSON-defined node and its corresponding Python object. For example, a node
defined like this in JSON:</p>


<p>Maps to this in Python:</p>


<p>We are now effectively treating ComfyUI as an importable Python package. We no
longer need to spin up a separate ComfyUI server that is always listening for
requests, and the workflow is much easier to parameterize.</p>
<h2 id="4-serve-your-workflow-as-a-modal-endpoint">4) Serve your workflow as a Modal endpoint</h2>
<p>Our goal is to stand up a web endpoint that accepts inputs as POST requests,
runs a ComfyUI workflow, and writes the generated images to a Volume.</p>
<p>First, we create a new file called <code>worfklow_api.py</code> with the usual Modal
scaffolding:</p>


<p>Next, we copy over the relevant portions of <code>_generated_workflow_api.py</code> ,
namely the <code>main()</code> function which we’ll adapt into a new function called
<code>run_python_workflow</code> :</p>


<p>Next, we stand up a web endpoint:</p>


<p>Lastly, we handle the inputs <code>prompt</code> and <code>image</code> in our <code>run_python_workflow</code>
function:</p>


<p>Now you can stand up the web endpoint by running:</p>


<p>Query the endpoint:</p>


<p>And download the image from the volume:</p>


<p><img src="https://modal.com/_app/immutable/assets/heron_at_yosemite.320824b7.jpeg" alt="ComfyUI output"/>



</p>
<p>The full example is
<a rel="nofollow" href="https://github.com/modal-labs/modal-examples/blob/main/06_gpu_and_ml/comfyui/workflow_api.py">here</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>With Modal, ComfyUI users can define a standard development instance in code and
then migrate to a Python-based workflow when ready to scale. The result is a
pipeline that can leverage Modal’s
<a rel="nofollow" href="https://modal.com/docs/guide/concurrent-inputs#how-does-autoscaling-work-on-modal">autoscaling</a>
to meet spikes in demand and spin down to save cost during periods of
inactivity.</p>
<p>With this framework, developers can effectively combine ComfyUI’s ease of use
with Modal’s developer experience, giving them the best of both worlds.</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>Thanks to the Fable team for their guidance, and check out how they’re building
on top of Modal to modernize creative software at
<a rel="nofollow" href="https://www.fable.app/">fable.app</a>. And special thanks to comfyanonymous
(whoever you may be…) for building the stable diffusion platform that
everyone’s talking about!</p>
</div></div></div>
  </body>
</html>
