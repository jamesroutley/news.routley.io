<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://bernsteinbear.com/blog/jit-perf-map/?utm_source=rss">Original</a>
    <h1>How to annotate JITed code for perf/samply</h1>
    
    <div id="readability-page-1" class="page"><div>
        

        
        
        <p><i>December 18, 2025</i></p>
        
        
        <div>
            <p>Brief one today. I got asked “does YJIT/ZJIT have support for [Linux] perf?”</p>

<p>The answer is yes, and it also works with <a href="https://github.com/mstange/samply">samply</a> (including on macOS!),
because both understand the <a href="https://github.com/torvalds/linux/blob/516471569089749163be24b973ea928b56ac20d9/tools/perf/Documentation/jit-interface.txt">perf map interface</a>.</p>

<p>This is the entirety of the implementation in ZJIT<sup id="fnref:hex" role="doc-noteref"><a href="#fn:hex" rel="footnote">1</a></sup>:</p>

<div><div><pre><code><span>fn</span> <span>register_with_perf</span><span>(</span><span>iseq_name</span><span>:</span> <span>String</span><span>,</span> <span>start_ptr</span><span>:</span> <span>usize</span><span>,</span> <span>code_size</span><span>:</span> <span>usize</span><span>)</span> <span>{</span>
    <span>use</span> <span>std</span><span>::</span><span>io</span><span>::</span><span>Write</span><span>;</span>
    <span>let</span> <span>perf_map</span> <span>=</span> <span>format!</span><span>(</span><span>&#34;/tmp/perf-{}.map&#34;</span><span>,</span> <span>std</span><span>::</span><span>process</span><span>::</span><span>id</span><span>());</span>
    <span>let</span> <span>Ok</span><span>(</span><span>file</span><span>)</span> <span>=</span> <span>std</span><span>::</span><span>fs</span><span>::</span><span>OpenOptions</span><span>::</span><span>new</span><span>()</span><span>.create</span><span>(</span><span>true</span><span>)</span><span>.append</span><span>(</span><span>true</span><span>)</span><span>.open</span><span>(</span><span>&amp;</span><span>perf_map</span><span>)</span> <span>else</span> <span>{</span>
        <span>debug!</span><span>(</span><span>&#34;Failed to open perf map file: {perf_map}&#34;</span><span>);</span>
        <span>return</span><span>;</span>
    <span>};</span>
    <span>let</span> <span>mut</span> <span>file</span> <span>=</span> <span>std</span><span>::</span><span>io</span><span>::</span><span>BufWriter</span><span>::</span><span>new</span><span>(</span><span>file</span><span>);</span>
    <span>let</span> <span>Ok</span><span>(</span><span>_</span><span>)</span> <span>=</span> <span>writeln!</span><span>(</span><span>file</span><span>,</span> <span>&#34;{start_ptr:x} {code_size:x} zjit::{iseq_name}&#34;</span><span>)</span> <span>else</span> <span>{</span>
        <span>debug!</span><span>(</span><span>&#34;Failed to write {iseq_name} to perf map file: {perf_map}&#34;</span><span>);</span>
        <span>return</span><span>;</span>
    <span>};</span>
<span>}</span>
</code></pre></div></div>

<p>Whenever you generate a function, append a one-line entry consisting of</p>



<p>to <code>/tmp/perf-{PID}.map</code>. Per the Linux docs linked above,</p>

<blockquote>
  <p>START and SIZE are hex numbers without 0x.</p>

  <p>symbolname is the rest of the line, so it could contain special characters.</p>
</blockquote>

<p>You can now happily run <code>perf record your_jit [...]</code> or <code>samply record your_jit
[...]</code> and have JIT frames be named in the output. We hide this behind
the <code>--zjit-perf</code> flag to avoid file I/O overhead when we don’t need it.</p>

<h2 id="there-is-also-the-jit-dump-interface">There is also the JIT dump interface</h2>

<p>Perf map is the older way to interact with perf: a newer, more complicated way
involves <a href="https://theunixzoo.co.uk/blog/2025-09-14-linux-perf-jit.html">generating a “dump” file</a> and then <code>perf inject</code>ing it.</p>

<!--

## There is also the JIT gdb interface

This is not strictly related but I want to figure it out

-->


        </div>
            
    <!-- Workaround for FB MITM -->
    <!-- Google tag (gtag.js) -->







    </div></div>
  </body>
</html>
