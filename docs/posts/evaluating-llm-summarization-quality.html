<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mattambrogi.com/posts/summary-evals/">Original</a>
    <h1>Evaluating LLM Summarization Quality</h1>
    
    <div id="readability-page-1" class="page"><div>
                    
<div>
    <h2>Evaluating LLM Summarization Quality</h2>
    

<p><strong>Using LLMs for summarization</strong></p>

<ul>
	<li>Summarization is one of the most valuable and practical use cases of LLMs</li>
	<li>In the simple case, it’s as easy as passing a block of text to the LLM and prompting it to return a summary</li>
	<li>But in production, things become more complicated</li>
	<li>For example, <strong>how should you summarize large documents?</strong> Imagine you want to provide summaries of 20+ page documents for users.</li>
	<li>There’s a few common ways to go about this
	<ul>
		<li><strong>“Stuff”</strong>: just use an LLM with a large context window and stuff all the content in there.</li>
		<li><strong>“Map Reduce”:</strong> break the large document into pieces, summarize each piece separately, and then have the model combine the summaries.</li>
		<li><strong>“Refine”:</strong> break the document into pieces. Summarize the first chunk. Then summarize the summary so far plus the next chunk. Continue until you’ve iteratively built a summary of the whole document.</li>
	</ul>
	</li>
	<li><strong>But how do you know which method is best?</strong> I was surprised to find that there is no agreed upon best practice. I couldn’t even find any research evaluating the relative performance of these strategies on large documents.</li>
	<li>Not to mention:
	<ul>
		<li>Does the model matter? For example, does GPT-4 produce meaningfully better summaries than GPT-3.5?</li>
		<li>How large of documents can the model handle before the summary quality starts to deteriorate?</li>
		<li>Is the model good at summarizing the type of content I need to work with anyways?</li>
	</ul>
	</li>
</ul>



<p><strong>How do we evaluate summary quality?</strong></p>

<ul>
	<li>We want to be able to test different approaches and compare their results. This leads to more general question: how should you evaluate the quality of an LLM generated summary?</li>
	<li>Historically, there have been two common ways of evaluating summarization tasks.</li>
</ul>



<p><strong>ROUGE</strong></p>

<ul>
	<li>ROUGE is a scoring method which evaluates overlap between an AI generated summary and a source of truth summary.</li>
	<li>Looks for presence of exact words / sequences of words.</li>
	<li>Intuitively, this does not align very well with human judgment.</li>
</ul>



<p><strong>BERTScore</strong></p>

<ul>
	<li>Evaluates similarity of generated summary and source of truth using embeddings.</li>
	<li>Improvement over ROUGE by enabling evaluation of semantic similarity.</li>
</ul>



<p><strong>Using the model</strong></p>

<ul>
	<li>But it seems there’s a better way… Just use the model on itself</li>
	<li>Seems hacky on first impression, but intuitively it makes sense that this might work well. LLM uses embeddings but also has huge amount of knowledge about the world encoded in itself.</li>
</ul>



<p><strong>G-Eval</strong></p>

<ul>
	<li><a href="https://arxiv.org/pdf/2303.16634.pdf">G-Eval paper</a> shows that LLM powered evaluations have higher correlation with human judgement than all previous methods</li>
	<li><a href="https://cookbook.openai.com/examples/evaluation/how_to_eval_abstractive_summarization">This OpenAI cookbook</a> shares prompt you can use to get model to evaluate
	<ul>
		<li>Relevance (1-5): Inclusion of important info from the source</li>
		<li>Coherence (1-5): Overall quality of sentences and structure</li>
		<li>Consistency (1-5): Factual alignment of summary and source</li>
		<li>Fluency (1-3): Quality in terms of word choice, grammar, spelling, etc.</li>
	</ul>
	</li>
</ul>

<p>Here’s a fragment of that prompt:</p>

<div><p># Metric 1: Relevance</p></div>



<p><strong>Using G-Eval Pat 1: Dataset</strong></p>

<ul>
	<li>Given the example from OpenAI above, it’s easy enough to set up some code and run G-Eval on a given datapoint. But for any sort of useful testing, you’re going to need more than that. Step one is to set up a dataset</li>
	<li>Unique thing about G-Eval is that is does not require a source of truth summary. Instead of needing a dataset of Text / Text Summary pairs, you can simply use a dataset of Text you’d like to summarize. You simply generate the summary using the method you want to test, and then pass the original body of text + your generated summary to the eval.</li>
	<li>That being said, I think it’s still better to use a test set with source of truth summaries if you can find one that is similar enough to your use case. Between Kaggle, Hugging Face, and Google there are some great summarization datasets out there, typically used for fine-tuning models. I was able to find one which had documents that I felt were similar in content and structure to my use case. So I adjusted the system to generate a summary and then compare that to the source of truth summary.</li>
	<li>There are many ways you could go about getting a test set. You probably don’t need more than ~20 datapoints to start. The evaluation process takes a long time given dependence on API calls and requires some manual review, so smaller but higher quality may be better.</li>
</ul>



<p><strong>Using G-Eval Part 2: Testing loop</strong></p>

<ul>
	<li>I had an evaluation method and a dataset, but no further guidance on process. So I set mine up as follows:</li>
	<li>I defined a few different combinations of model and summary method (i.e. stuff) that I wanted to test. Then for each combination, I looped through my test set, generated a summary, and ran evals using the base summary and generated result.</li>
	<li>More specifically, my code did the following
	<ul>
		<li>Go through each test doc, generate a summary</li>
		<li>Use generated summary and source of trust to get the following metrics
		<ul>
			<li>G-Eval Scores
			<ul>
				<li>Relevance, Coherence, Consistency, Fluency</li>
			</ul>
			</li>
			<li>Time to completion</li>
			<li>Total tokens used</li>
			<li>Input length</li>
			<li>Output length</li>
		</ul>
		</li>
		<li>Append each result to a data-frame which I then saved as a csv.</li>
	</ul>
	</li>
</ul>

<p>This outputs a table where each row is a summary with the following columns:</p>

<p>Relevance (1-5) | Coherence (1-5)<!-- notionvc: d0ea838d-680c-4395-9440-0e1b7e1c523d --> | Consistency (1-5)<!-- notionvc: 39db3ab6-c05b-4bbc-96d3-8fa461719da1 --> | Fluency (1-3)<!-- notionvc: c3e5757d-ed53-46ae-baac-0b3413f8f2fa --> | Duration<!-- notionvc: c58167d4-0c7a-471e-b780-d0cd81bcb55b --> (s) | Total Tokens<!-- notionvc: de7d56ad-7a99-4996-9312-c44b55bb510a --> | Input Characters | Output Characters | Summary Content<!-- notionvc: bb04ff31-5ec7-4dd1-b69f-c0cb79f21b2e --></p>



<p><strong>How this is useful: insights</strong></p>

<p>This type of analysis helps provide concrete insights before launching a product</p>

<p>On the <u>technical side</u> you can figure out:</p>

<ul>
	<li>Which summary approach works best</li>
	<li>Which model works best</li>
	<li>What is latency like for your use case. Is streaming critical?</li>
</ul>

<p>On the <u>product side:</u></p>

<ul>
	<li>How do you need to adjust the prompt to get the style you want?</li>
	<li>The the response the right level of information density for your use case?</li>
	<li>Does quality hold for the size docs you expect to summarize?</li>
</ul>

<p>Putting this information together leads to insights which should effect your configuration for production. Maybe you find GPT-3.5 works just fine for your use case and you can save money by not using GPT-4. Maybe you find the quality of your summaries is consistently low and your use-case requires fine-tuning. Or maybe you realize the summaries are too sparse, and you choose to use something like a chain of density prompt.</p>



<p><strong>Human in the loop</strong></p>

<p>The last and most important part of the process, is to have a human simply read through some of the summaries and compare them with the original docs or source of truth summaries.</p>

<p>Automatic evaluations are directionally useful. They can be very helpful in giving you a quick read on whether a change makes any different in your system, or to help you pick out certain types of docs which are not summarizing well. But they are infinitely more valuable when combined with just taking the time to read and analyze yourself.</p>

<p>In this process you may find that you actually like a certain type of summary that doesn’t score as well better. Or you may notice the model often includes some additional chat content along with the summary.</p>



<p><strong>Ship it</strong></p>

<p>All of the data gathered in this process ultimately has little value when compared to user feedback. This process is useful for ensuring your product doesn’t totally suck before shipping it. But shipping it, talking to users, adding a feedback mechanism, storing outputs, etc. - these are the things that will really tell you what you need to change. Then you can try out a new solution (model, prompt, algorithm), use your evals as a quick gut check, ship again, and repeat.<!-- notionvc: d241a163-b1b4-4f50-980b-e7c0a0d7ab50 --></p>







<p><strong>References</strong></p>

<p><strong>- </strong>Main source of inspiration: <a href="https://cookbook.openai.com/examples/evaluation/how_to_eval_abstractive_summarization">OpenAI Eval Cookbook</a></p>


</div>

                </div></div>
  </body>
</html>
