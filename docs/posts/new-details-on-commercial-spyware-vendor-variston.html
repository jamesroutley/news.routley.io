<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.google/threat-analysis-group/new-details-on-commercial-spyware-vendor-variston/">Original</a>
    <h1>New details on commercial spyware vendor Variston</h1>
    
    <div id="readability-page-1" class="page"><article ng-init="drawerToggle = {&#39;open&#39;: true}">

    
    

<section>
  
</section>


    

    
      



<div>
  <div>
    <div>
      
      
        <p>
          Heliconia exploitation frameworks capable of deploying spyware
        </p>
      
    </div>
  </div>
  <div>
    <div>
      
        
  
    
  

  
    <div aria-label="Benoit Sevens, Threat Analysis Group">
      
  

<div>
  <p>Benoit Sevens</p>
  
    <p>
      Threat Analysis Group
    </p>
    
  
</div>

    </div>
  


      
    </div>
    
  </div>
</div>


    

    
      

    

    
      






    

    
    <section>
      <div>
        
        <div data-reading-time="true" data-component="uni-drop-cap|uni-tombstone">
          
          
<!--article text-->

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="o4fqa">Threat Analysis Group (TAG) has been tracking the activities of commercial spyware vendors for years, using our research to improve the safety and security of Google’s products and share intelligence with our industry peers. TAG’s research underscores that the commercial surveillance industry is thriving and has expanded significantly in recent years, creating risk for Internet users around the globe. Commercial spyware puts advanced surveillance capabilities in the hands of governments who use them to spy on journalists, human rights activists, political opposition and dissidents. Google and TAG are committed to disrupting these threats, protecting users, and raising awareness of the risks posed by the growing commercial spyware industry.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="o4fqa">Continuing this work, today, we’re sharing findings on an exploitation framework with likely ties to Variston IT, a company in Barcelona, Spain that claims to be a provider of custom security solutions. Their Heliconia framework exploits n-day vulnerabilities in Chrome, Firefox and Microsoft Defender and provides all the tools necessary to deploy a payload to a target device. Google, Microsoft and Mozilla fixed the affected vulnerabilities in 2021 and early 2022. While we have not detected active exploitation, based on the research below, it appears likely these were utilized as zero-days in the wild. TAG has created detections in Safe Browsing to warn users when they attempt to navigate to dangerous sites or download dangerous files. To ensure full protection against Heliconia and other exploits, it’s essential to keep Chrome and other software fully up-to-date.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="o4fqa">TAG became aware of the Heliconia framework when Google received an anonymous submission to the Chrome bug reporting program. The submitter filed three bugs, each with instructions and an archive that contained source code. They used unique names in the bug reports including, “Heliconia Noise,” “Heliconia Soft” and “Files.” TAG analyzed the submissions and found they contained frameworks for deploying exploits in the wild and a script in the source code included clues pointing to the possible developer of the exploitation frameworks, Variston IT.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="o4fqa">The exploitation frameworks, listed below, included mature source code capable of deploying exploits for Chrome, Windows Defender and Firefox. Although the vulnerabilities are now patched, we assess it is likely the exploits were used as 0-days before they were fixed.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><ul><li data-block-key="o4fqa"><b>Heliconia Noise:</b> a web framework for deploying an exploit for a Chrome renderer bug followed by a sandbox escape</li><li data-block-key="br06b"><b>Heliconia Soft:</b> a web framework that deploys a PDF containing a Windows Defender exploit</li><li data-block-key="e13bt"><b>Files:</b> a set of Firefox exploits for Linux and Windows.</li></ul></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="o4fqa">Below, we share our findings on the exploitation frameworks and how they work. This analysis was done in collaboration with our colleagues, Ivan Fratric and Maddie Stone from Project Zero, and Stephen Röttger from the V8 Security Team.</p>
        </div>
      </div>
    </div>
  

  
    
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="o4fqa">Heliconia Noise is a web framework for deploying a Chrome renderer exploit, followed by a Chrome sandbox escape and agent installation. A manifest file in the source code provides a product description:</p>
        </div>
      </div>
    </div>
  

  
    







  
      <div>
  

  <p><a>
        
          <img tabindex="0" alt="image of a manifest file in source code" src=" https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Windows_10...Medium_Integrity.max-100x100.png " loading="lazy" data-loading="{
                &#34;mobile&#34;: &#34;https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Windows_10...Medium_Integrity.max-500x500.png&#34;,
                &#34;desktop&#34;: &#34;https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Windows_10...Medium_Integrity.max-1000x1000.png&#34;
              }"/>
        
      </a>
    
    </p>
    
  
    </div>
  



  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The Chrome renderer exploit supports Chrome versions 90.0.4430.72 (April 2021) to 91.0.4472.106 (June 2021). It takes advantage of a V8 deoptimizer bug <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1228036">fixed</a> in August 2021. As is currently normal for internally found Chrome bugs, no CVE was assigned.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The source code contains references to a sandbox escape called chrome-sbx-gen. This component was maintained in a separate Git submodule, and was not present in the obtained source code.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">To obfuscate the JavaScript code, the framework uses minobf, likely a custom tool that was also not included in the source code.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">Heliconia Noise includes a pre-commit cleaning script that leaks the name of the company that likely develops this project, Variston IT. The script, shown below, checks that binaries produced by the framework do not contain sensitive strings such as “Variston,” developer aliases or server names. Variston Information Technology is a small company based in Barcelona that describes itself as offering “tailor made Information Security Solutions.”</p>
        </div>
      </div>
    </div>
  

  
    







  
      <div>
  

  <p><a>
        
          <img tabindex="0" alt="image of code" src=" https://storage.googleapis.com/gweb-uniblog-publish-prod/images/6DG5bkHnJTZxuWX.max-100x100.png " loading="lazy" data-loading="{
                &#34;mobile&#34;: &#34;https://storage.googleapis.com/gweb-uniblog-publish-prod/images/6DG5bkHnJTZxuWX.max-500x500.png&#34;,
                &#34;desktop&#34;: &#34;https://storage.googleapis.com/gweb-uniblog-publish-prod/images/6DG5bkHnJTZxuWX.max-1000x1000.png&#34;
              }"/>
        
      </a>
    
    </p>
    
      <figcaption><p data-block-key="gacly">Pre-commit cleaning script commented with &#34;project name,&#34; &#34;developer names,&#34; and &#34;company name.&#34;</p></figcaption>
    
  
    </div>
  



  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="77rdd">Heliconia Noise is configurable using a JSON file that enables customers to set various parameters, including:</p><ul><li data-block-key="1s3ah">attackExecution: maximum number of times to serve the exploit</li><li data-block-key="5eij">expiration: server does not work after this date</li><li data-block-key="8nv56">redirectUrl: redirect URL in case of a failed exploit or disallowed visitor</li><li data-block-key="dkdr0">targetValidator: custom rules specifying when visitors are considered valid targets</li><li data-block-key="990sd">dnsMirrors: mirrors where the iframe is fetched from</li></ul></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The framework runs a Flask web server to host the exploit chain. A full infection performs requests to six different web endpoints during the different stages of the exploit chain:</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="psxxo"><b>Stage 1: Remote code execution (RCE)</b></p><ul><li data-block-key="fjl0">index.py: the landing page</li><li data-block-key="4e9c3">iframe.py: the iframe that runs the RCE exploit</li><li data-block-key="6tggs">wasm.py: a dummy WebAssembly (Wasm) module</li></ul></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="zoqrn"><b>Stage 2: Sandbox escape</b></p><ul><li data-block-key="234di">sbx.py: the sandbox escape shellcode</li></ul></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="26fl5"><b>Stage 3: Post-exploitation</b></p><ul><li data-block-key="4mgsq">launcher.py: the agent launcher</li><li data-block-key="2858k">agent.py: the agent</li></ul></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The file names for each endpoint are randomized during server deployment, except for the first endpoint, which is served by a URL specified in the configuration file.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The framework allows setting parameters to validate visitors of the web server. Customers can configure target validations based on user agent, client country, client IP, and a client identifier used to track individual visitors. If any of the validation checks fail, the user is redirected to the preconfigured redirect URL.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p><h3 data-block-key="77rdd">Heliconia Noise Infection Chain</h3></p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="77rdd"><b>Stage 1: Remote code execution</b></p><p data-block-key="4jb1l">The infection chain starts with a client visiting the landing page URL defined in the configuration file. If the validation checks succeed, the landing page is served and 2 cookies are set:</p><ul><li data-block-key="fnips">A cookie with name wp_blog and value 1 to detect and redirect recurring visitors.</li><li data-block-key="5458t">A “client identifier” cookie with:<ul><li data-block-key="45pvt">A name that is randomly generated during server deployment and is constant for the entire deployment (referred to as cookie_client_identifier and formatted [A-Za-z]{16})</li><li data-block-key="blnkd">A value that is uniquely generated per visitor (referred to as cid and in <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier#Format">UUID format</a>).</li></ul></li></ul><p data-block-key="cs07q">The JavaScript in the landing page then creates an iframe for every mirror configured in the configuration file. The iframe URLs have the following format:</p><p data-block-key="2n677">&lt;url&gt;/&lt;iframe_url&gt;?&lt;cookie_client_identifier&gt;=&lt;cid&gt;</p><p data-block-key="51a7n">The &lt;iframe_url&gt; string is a random path formatted [a-f0-9]{16}.</p><p data-block-key="csda9">The main script communicates with the iframes through messages using the postMessage method.</p><p data-block-key="6pbvr">The iframes in their turn launch web workers that run exploit code. Communication with the workers happens again through messages.</p><p data-block-key="ffju4">Once the exploit obtains an arbitrary read and write primitive, a dummy Wasm module is fetched as a method for creating a memory area with read-write-execute permissions. The URL format is similar to the iframe URL above.</p><p data-block-key="2a8sn">The Wasm area is then overwritten with the stage 1 shellcode. This shellcode is executed via a call from JavaScript to the exported Wasm function hello().</p><p data-block-key="bg410">The first time the stage 1 shellcode is called it resolves the address of chrome.dll, VirtualAlloc, NdrServerCall2 and the ntdll timestamp. It also allocates memory for the upcoming sandbox escape shellcode. The resulting information is returned to the JavaScript.</p></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="77rdd"><b>Stage 2: Sandbox escape</b></p><p data-block-key="2mhfa">The JavaScript then fetches the sandbox escape shellcode from a URL with a format similar to the iframe and Wasm URL, but with 5 extra GET parameters which are used by the server to prepare the sandbox escape shellcode:</p><ul><li data-block-key="5o74c">address of VirtualAlloc function</li><li data-block-key="2dcvu">address of NdrServerCall2 function</li><li data-block-key="1h6p0">address of chrome.dll</li><li data-block-key="2tv5k">address of the allocated memory for the sandbox escape</li><li data-block-key="585lk">timestamp of ntdll</li></ul><p data-block-key="7hdi4">The fetched sandbox escape is written to the previously allocated memory. It is executed via a second call to the stage 1 shellcode, which now calls into the sandbox escape shellcode.</p><p data-block-key="aeemf">Since TAG did not have access to the chrome-sbx-gen module, we do not have specific details on how the sandbox escape works.</p></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="77rdd"><b>Stage 3: Post-exploitation</b></p><p data-block-key="67hki">After a successful sandbox escape, the launcher is executed. The goal of the launcher is to launch the (final) agent. The launcher is served as a DLL that is prepended with a PE loader shellcode.</p><p data-block-key="bc02k">The launcher has its own configuration, which contains following fields of interest:</p><ul><li data-block-key="ahikq">URL to retrieve the agent</li><li data-block-key="76d5q">Path on the system to store data</li><li data-block-key="3mhv7">If the agent should be dropped to disk</li><li data-block-key="ccaav">Filename of the agent on disk</li></ul><p data-block-key="5rqtn">The configuration is stored as an RC4 encrypted tar archive in the binary. The launcher fetches and runs the agent, and based on the exit code of the agent, it can uninstall the agent, upgrade it, run it again or exit.</p><p data-block-key="dqsle">The agent_simple provided in this archive is a dummy agent and it randomly selects the exit code. In a real deployment, we believe the customer using the framework may provide their own agent, or the agent may be part of a different project.</p></div>
        </div>
      </div>
    </div>
  

  
    
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">Heliconia Soft is a web framework that deploys a PDF containing a Windows Defender exploit. It exploits CVE-2021-42298, a bug in the JavaScript engine of Microsoft Defender Malware Protection that was fixed in November 2021. The manifest in the source code describes Heliconia Soft as:</p>
        </div>
      </div>
    </div>
  

  
    







  
      <div>
  

  <p><a>
        
          <img tabindex="0" alt="A description of Heliconia Soft in the manifest in the source code." src=" https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Windows_Chrome...SYSTEM_integrity.max-100x100.png " loading="lazy" data-loading="{
                &#34;mobile&#34;: &#34;https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Windows_Chrome...SYSTEM_integrity.max-500x500.png&#34;,
                &#34;desktop&#34;: &#34;https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Windows_Chrome...SYSTEM_integrity.max-1000x1000.png&#34;
              }"/>
        
      </a>
    
    </p>
    
  
    </div>
  



  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The exploit achieves SYSTEM privileges with a single vulnerability and the only action required by the user is to download a PDF, which triggers a scan by Windows Defender.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <div><p data-block-key="77rdd">The Heliconia Soft framework sets up an infection chain with two endpoints on the web server:</p><ul><li data-block-key="qmis">index.py: the weaponized PDF file</li><li data-block-key="fn5fi">agent.py: the agent</li></ul></div>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">In the first stage, a PDF is served when a user visits the attack URL. The PDF contains some decoy content, plus JavaScript that contains the exploit. Like Heliconia Noise, it uses the custom JavaScript obfuscator minobf. The framework code performs checks to confirm that common exploit strings (“spray”, “leak”, “addr”, etc.) are not present in the obfuscated JavaScript. The framework inserts the PE loader shellcode and the launcher DLL as strings in the exploit JavaScript.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The PE loader is similar to the one described above for Heliconia Noise. The launcher also has the same functionality, with a few notable differences. The launcher tries to “defuse” the exploit PDF by replacing the JavaScript in the PDF with spaces, likely to protect the exploit code from forensics. Similar to Heliconia Noise, the launcher retrieves the agent from a configured URL, runs it and acts based on its exit code.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">A dummy agent agent_simple is provided in the archive. As with Heliconia Noise, we believe the framework is likely designed for the customer to replace the dummy agent with their own agent.</p>
        </div>
      </div>
    </div>
  

  
    
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The “Files” package contained a fully documented Firefox exploit chain for Windows and Linux. For remote code execution it exploits <a href="https://www.mozilla.org/en-US/security/advisories/mfsa2022-09/#CVE-2022-26485">CVE-2022-26485</a>, a use after free vulnerability in the XSLT processor that was reported in March 2022 as being exploited in the wild. TAG assesses that the Heliconia Files package likely exploited this RCE vulnerability since at least 2019, well before the bug was publicly known and patched. The Heliconia exploit is effective against Firefox versions 64 to 68, suggesting it may have been in use as early as December 2018 when version 64 was first released. Additionally, when Mozilla patched the vulnerability, the exploit code in their <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1758062">bug report</a> shared striking similarities with the Heliconia exploit, including the same variable names and markers. These overlaps suggest the exploit author is the same for both the Heliconia exploit and the sample exploit code Mozilla shared when they patched the bug.</p>
        </div>
      </div>
    </div>
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">The sandbox escape is specific to the Windows version of Firefox and was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1530709">fixed</a> without a CVE in September 2019. The vulnerability abused the fact that user-controlled CSS values can be rendered inside the privileged content process using the Forms:ShowDropDown IPC. Code execution is achieved by injecting <a href="https://en.wikipedia.org/wiki/XBL">XBL bindings</a> to resolve Windows APIs and call WinExec. The exploit code spawns a new calculator, and unlike the other Heliconia frameworks, does not include a launcher capability or dummy agent.</p>
        </div>
      </div>
    </div>
  

  
    
  

  
    <div>
      <div>
        <div data-component="uni-article-paragraph">
          <p data-block-key="77rdd">TAG&#39;s research has shown the proliferation of commercial surveillance and the extent to which commercial spyware vendors have developed capabilities that were previously only available to governments with deep pockets and technical expertise. The growth of the spyware industry puts users at risk and makes the Internet less safe, and while surveillance technology may be legal under national or international laws, they are often used in harmful ways to conduct digital espionage against a range of groups. These abuses represent a serious risk to online safety which is why Google and TAG will continue to take action against, and publish research about, the commercial spyware industry.</p>
        </div>
      </div>
    </div>
  


          
          

          
            




          
        </div>
      </div>
    </section>
  </article></div>
  </body>
</html>
