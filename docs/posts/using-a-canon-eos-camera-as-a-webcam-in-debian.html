<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.schlachter.xyz/projects/debian-dslr-webcam-with-secure-boot">Original</a>
    <h1>Using a Canon EOS camera as a webcam in Debian</h1>
    
    <div id="readability-page-1" class="page"><article>
        <header>
            
            <p>
                <time pubdate="pubdate">18 September 2022</time>
            </p>
        </header>

        <p>I recently started using my Canon EOS Rebel T6 DSLR camera as a webcam; Canon offers a utility for Windows and MacOS that allows this but not for Linux, so I needed to find a solution that would work when I’m using Debian.</p>
        <p>Using a camera as a webcam in Debian is very straightforward, but if you want to have secure boot enabled then there are a few extra steps that you might need to take. The extra complexity comes from needing to sign the kernel modules for v4l2loopback, which is used to make the camera’s video stream available to webcams.</p>
        <p>Most of the tutorials and posts I found online either didn’t mention having to sign the kernel module, or said to disable secure boot outright. This wasn’t an acceptable solution to me so I made this tutorial to provide a solution that lets the camera be used as a webcam while still keeping secure boot enabled. I was able to accomplish this on my ThinkPad X1 Extreme gen 3 running Debian GNU/Linux 11 (bullseye).</p>
        <p>This solution should work for any camera <a href="http://gphoto.org/proj/libgphoto2/support.php" target="_blank" rel="noopener">compatible with gphoto2</a>, including many cameras by Canon, Fuji, HP, Kodak, Nikon, Pentax, Sanyo, Sony, and many others.</p>
        <h2>Contents</h2>
        <ol>
        <li><a href="#installing-dependencies">Installing dependencies</a></li>
        <li><a href="#sign-the-v4l2loopback-kernel-module">Sign the v4l2loopback kernel module</a></li>
        <ol type="a">
            <li><a href="#generating-a-machine-owner-key">Generating a Machine Owner Key</a></li>
            <li><a href="#enrolling-your-key">Enrolling your key</a></li>
            <li><a href="#signing-the-module">Signing the module</a></li>
        </ol>
        <li><a href="#connecting-the-camera">Connecting the camera</a></li>
        <li><a href="#using-the-camera-in-applications">Using the camera in applications</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
        <li><a href="#references-">References</a></li>
        </ol>
        <h2 id="installing-dependencies">Installing dependencies</h2>
        <p>To start off, you will need to install a few dependencies:</p>
        <ul>
            <li><code>gphoto2</code> gets the camera’s video stream</li>
            <li><code>ffmpeg</code> converts the camera’s video stream into a usable format</li>
            <li><code>v4l2loopback-dkms</code> makes the video stream available to applications as a virtual webcam</li>
            <li><code>v4l2loopback-utils</code> (optional) adds a commandline utility for managing v4l2loopback</li>
            <li><code>linux-headers-$(uname -r)</code> provides the infrastrucure we need for signing the v4l2 kernel modules</li>
            <li><code>vlc</code> (optional) gives us an easy way to preview the camera stream</li>
        </ul>
        <p>You can install all of these at once using:</p>
        <pre><code>sudo apt install gphoto2 ffmpeg v4l2loopback-dkms v4l2loopback-utils linux-headers-$(uname -r) vlc</code></pre>
        <h2 id="sign-the-v4l2loopback-kernel-module">Sign the v4l2loopback kernel module</h2>
        <p>This step might be optional for you; you can check first by trying to setup the loopback device using:</p>
        <pre><code>sudo modprobe v4l2loopback card_label=&#34;Virtual Camera&#34;</code></pre>
        <p>If the command runs with no errors then congratulations! You can skip this step and go directly to the next step to begin using the camera. If you get an error like <code>modprobe: ERROR: could not insert &#39;v4l2loopback&#39;: Operation not permitted</code> then you will need to sign the kernel module for <code>v4l2loopback</code> so that it will be allowed to run.</p>
        <p>The Debian documentation provides a <a href="”https://wiki.debian.org/SecureBoot#MOK_-_Machine_Owner_Key”" target="_blank" rel="noopener">guide for signing kernel modules</a>, which we will follow to sign our v4l2loopback module.</p>
        <h3 id="generating-a-machine-owner-key">Generating a Machine Owner Key</h3>
        <p>The first step is to generate a Machine Owner Key to allow you to sign modules. You can check whether a key already exists by running:</p>
        <pre><code>ls /var/lib/shim-signed/mok</code></pre>
        <p>A key consists of the files <code>MOK.der</code>, <code>MOK.pem</code>, and <code>MOK.priv</code> and if you see them there then you can skip this step and use the existing key.</p>
        <p>To generate a new key run the following commands from a root shell (using <code>su</code> or similar):</p>
        <pre><code>mkdir -p /var/lib/shim-signed/mok/  # Ensures that the key directory exists
cd /var/lib/shim-signed/mok/  # Switches to the key directory
openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -days 36500 -subj &#34;/CN=Your Name/&#34;  # Generates the private key and a public key in the DER format
openssl x509 -inform der -in MOK.der -out MOK.pem  # Converts the public key to PEM format</code></pre>
        <h3 id="enrolling-your-key">Enrolling your key</h3>
        <p>From the <code>/var/lib/shim-signed/mok</code> directory, use the following commands to enroll your key with the EFI:</p>
        <pre><code>sudo mokutil --import MOK.der # prompts for one-time password
sudo mokutil --list-new # recheck your key will be prompted on next boot</code></pre>
        <p>Reboot the machine, which will enter the MOK manager EFI utility. From there select the option to enroll MOK, continue, enter password, and reboot. You can then confirm whether your key is successfully loaded using:</p>
        <pre><code>sudo dmesg | grep cert # verify your key is loaded</code></pre>
        <h3 id="signing-the-module">Signing the module</h3>
        <p>First set up environment variables that we will use for the signing with:</p>
        <pre><code>VERSION=&#34;$(uname -r)&#34;
SHORT_VERSION=&#34;$(uname -r | cut -d . -f 1-2)&#34;
MODULES_DIR=/lib/modules/$VERSION
KBUILD_DIR=/usr/lib/linux-kbuild-$SHORT_VERSION</code></pre>
        <p>Then sign the mv4l2loopback module with:</p>
        <pre><code>cd &#34;$MODULES_DIR/updates/dkms&#34;  # Change to the directory where the module is stored
echo -n &#34;Passphrase for the private key: &#34;  # Give us a friendly password prompt
read -s KBUILD_SIGN_PIN  # Store the passphrase for the private key
export KBUILD_SIGN_PIN  # Export the variable containing the password
sudo --preserve-env=KBUILD_SIGN_PIN &#34;$KBUILD_DIR&#34;/scripts/sign-file sha256 /var/lib/shim-signed/mok/MOK.priv /var/lib/shim-signed/mok/MOK.der v4l2loopback.ko</code></pre>
        <p>You can then verify that the module is signed using:</p>
        <pre><code>sudo modinfo v4l2loopback</code></pre>
        <p>which should show a signature now attached to the module. You may need to repeat the signing step if <code>v4l2loopback</code> is updated (e.g. through an <code>apt upgrade</code>) so I would recommend saving these instructions somewhere easy to find or bookmarking this page so you can reference it later if needed.</p>
        <h2 id="connecting-the-camera">Connecting the camera</h2>
        <p>Connect your camera to your computer using the USB cable, turn the camera on, and then run the following command to ensure it connected successfully:</p>
        <pre><code>LANG=C gphoto2 --summary</code></pre>
        <p>This should show you output similar to this, confirming that your camera is connected and available:</p>
        <pre><code>Camera summary:
Manufacturer: Canon Inc.
Model: Canon EOS Rebel T6
Version: 3-1.2.0
Serial Number: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Vendor Extension ID: 0xb (1.0)
Vendor Extension Description:

Capture Formats: JPEG
Display Formats: Association/Directory, Script, DPOF, MS AVI, MS Wave, JPEG, CRW, Unknown(b103), Unknown(bf02)
, Defined Type, Unknown(b104), Unknown(b105)

Device Capabilities:
    File Download, File Deletion, File Upload
    No Image Capture, No Open Capture, Canon EOS Capture, Canon EOS Capture 2
    Canon Wifi support

Storage Devices Summary:
store_00020001:
    StorageDescription: SD
    VolumeLabel:
    Storage Type: Removable RAM (memory card)
    Filesystemtype: Digital Camera Layout (DCIM)
    Access Capability: Read-Write
    Maximum Capability: 31902400512 (30424 MB)
    Free Space (Bytes): 2837151744 (2705 MB)
    Free Space (Images): -1

Device Property Summary:
Property 0xd402:(read only) (type=0xffff) &#39;Canon EOS Rebel T6&#39;
Property 0xd407:(read only) (type=0x6) 1
Property 0xd406:(readwrite) (type=0xffff) &#39;Unknown Initiator&#39;
Property 0xd303:(read only) (type=0x2) 1
Battery Level(0x5001):(read only) (type=0x2) Enumeration [100,0,75,0,50] value: 100% (100)</code></pre>
        <p>If you instead get a message saying <code>*** Error: No camera found. ***</code>, make sure your camera is connected and that wifi/bluetooth is disabled in your camera’s settings. You may also need to unmount the camera so that <code>gphoto2</code> can claim the connection if the camera’s storage was mounted automatically.</p>
        <p>You will now need to setup the virtual camera, which you will need to do exactly once each time that you boot your computer:</p>
        <pre><code>sudo modprobe v4l2loopback card_label=&#34;Virtual Camera&#34;</code></pre>
        <p>Next get the name of the virtual camera using <code>ls /dev/video*</code>, the virtual camera should be the one with the largest number, in my case it is <code>/dev/video4</code>, which I will be using for the rest of the instructions. You can also manually set the number of the camera when you setup the virtual camera using:</p>
        <pre><code>sudo modprobe v4l2loopback card_label=&#34;Virtual Camera&#34; video_nr=4</code></pre>
        <p>Finally, connect to the camera’s video stream using:</p>
        <pre><code>gphoto2 --stdout --capture-movie | ffmpeg -i - -vcodec rawvideo -pix_fmt yuv420p -threads 0 -f v4l2 /dev/video4</code></pre>
        <p>This will use <code>gphoto2</code> to capture the camera’s video stream, forward it to <code>ffmpeg</code> which will convert it to a usable format, and finally pass it into our virtual camera which will make it available to any applications that use the webcam.</p>
        <p>You can easily check whether this is all working properly by opening a new shell prompt (our current one will be busy handling the video stream) and using it to open vlc connected to our virtual camera:</p>
        <pre><code>vlc v4l2:///dev/video4</code></pre>
        <h2 id="using-the-camera-in-applications">Using the camera in applications</h2>
        <p>Now that your camera is connected and streaming through the virtual camera, you should be able to use it in any application that supports webcams simply by selecting it. For example, I am able to use it in Zoom and Firefox.</p>
        <figure>
             <picture>
            <source srcset="https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector.webp 788w, https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector-medium.webp 464w, https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector-small.webp 232w" type="image/webp" sizes="(max-width: 598px) calc((100vw - 4em - 4px) * 0.9 - 1em), (min-width: 599px) 464px"/>
            <source srcset="https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector.jpg 788w, https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector-medium.jpg 464w, https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector-small.jpg 232w" type="image/jpeg" sizes="(max-width: 598px) calc((100vw - 4em - 4px) * 0.9 - 1em), (min-width: 599px) 464px"/>
        <img src="https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector-medium.jpg" alt="Dropdown labeled &#39;Camera&#39; with the options &#39;Integrated Camera: Integrated C&#39;, &#39;Integrated Camera: Integrated I&#39;, and &#39;Virtual Camera&#39;" width="464" height="184" data-width="788" data-height="312" data-full="https://www.schlachter.xyz/images/projects/debian-dslr-webcam-with-secure-boot/zoom-camera-selector.jpg"/>
</picture>
 
            <figcaption>Example of the virtual camera in the settings of the Zoom videoconferencing application</figcaption>
        </figure>
        
        <p>We have gone through how to use a Canon EOS camera as a webcam in Debian Linux using <code>gphoto</code>, <code>ffmpeg</code>, and <code>v4l2loopback</code>, while keeping secure boot enabled.</p>
        <p>You can easily save the commands that you will need to repeat by adding aliases to your <code>~/.bashrc</code> file. For instance, I have the following in mine to let me easily manage the webcam (keep in mind that my virtual camera is at <code>/dev/video4</code> and you may need to substitute the <code>4</code> for another number on your machine):</p>
        <pre><code># For connecting DSLR as webcam
alias setup_camera=&#39;if [ -e &#34;/dev/video4&#34; ]; then echo &#34;Camera is already setup&#34;; else sudo modprobe v4l2loopback card_label=&#34;Virtual Camera&#34; video_nr=4; fi&#39;
alias test_camera=&#34;LANG=C gphoto2 --summary&#34;
alias connect_camera=&#34;gphoto2 --stdout --capture-movie | ffmpeg -i - -vcodec rawvideo -pix_fmt yuv420p -threads 0 -f v4l2 /dev/video4&#34;
alias preview_camera=&#34;vlc v4l2:///dev/video4&#34;</code></pre>
        <p>You can also setup the virtual camera to be created at boot by creating the following 2 files:</p>
        <p><code>/etc/modules-load.d/v4l2loopback.conf</code></p>
        <pre><code>v4l2loopback</code></pre>
        <p><code>/etc/modprobe.d/v4l2loopback.conf</code></p>
        <pre><code>options v4l2loopback video_nr=4
options v4l2loopback card_label=&#34;Virtual Camera&#34;</code></pre>
        <p>If you run into issues with your camera not working, ensure that it is plugged in and turned on, that wifi is disabled in the settings, and that the <code>gphoto2</code> command is running. Also double-check that the <code>v4l2loopback</code> kernel module is correctly signed and that the virtual camera exists.</p>
        <h2 id="references-">References</h2>
        <ul>
            <li><a href="https://maximevaillancourt.com/blog/canon-dslr-webcam-debian-ubuntu" target="_blank" rel="noopener">https://maximevaillancourt.com/blog/canon-dslr-webcam-debian-ubuntu</a></li>
            <li><a href="https://askubuntu.com/questions/856460/using-a-digital-camera-canon-as-webcam" target="_blank" rel="noopener">https://askubuntu.com/questions/856460/using-a-digital-camera-canon-as-webcam</a></li>
            <li><a href="https://github.com/alievk/avatarify-python/issues/43" target="_blank" rel="noopener">https://github.com/alievk/avatarify-python/issues/43</a></li>
            <li><a href="https://wiki.debian.org/SecureBoot#MOK_-_Machine_Owner_Key" target="_blank" rel="noopener">https://wiki.debian.org/SecureBoot#MOK_-_Machine_Owner_Key</a></li>
            <li><a href="https://github.com/umlaeute/v4l2loopback">https://github.com/umlaeute/v4l2loopback</a></li>
        </ul>
    </article></div>
  </body>
</html>
