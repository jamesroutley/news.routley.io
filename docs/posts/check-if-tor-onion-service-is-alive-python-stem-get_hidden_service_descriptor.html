<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.michaelaltfield.net/2025/11/05/onion-service-alive-dead/">Original</a>
    <h1>Check if Tor Onion Service is alive (python stem get_hidden_service_descriptor)</h1>
    
    <div id="readability-page-1" class="page"><div><p>This article will show how to check if a given Onion Service (ie some <code>.onion</code> address) is alive or dead.</p>
<p><a href="https://tech.michaelaltfield.net/onion-service-alive-dead"><img fetchpriority="high" decoding="async" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1.jpg.pagespeed.ic.5zjl2JqE1A.jpg" alt="Check If Tor .onion is Alive or Dead" width="1200" height="628" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1.jpg.pagespeed.ic.5zjl2JqE1A.jpg 1200w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1-300x157.jpg.pagespeed.ic.yXZPJKIyU4.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1-1024x536.jpg.pagespeed.ic.ZGYdJu2pRr.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1-768x402.jpg.pagespeed.ic.6tz-NYFVVA.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1-150x79.jpg.pagespeed.ic.d05sDfCe2W.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xonion-service-alive-dead_featuredImage1-400x209.jpg.pagespeed.ic.uPSk8tBzQn.jpg 400w" sizes="(max-width: 1200px) 100vw, 1200px"/></a></p>

<p>Lots of Onion Services are “here today, gone tomorrow”. If you encountered a large list of Onion Services and want to quickly check to see which are still alive, the best way to do that is by querying the Tor network’s <a href="https://spec.torproject.org/rend-spec/overview.html">Hidden Service Directory (HSDir)</a>.</p>

<p>Of course, you <em>could</em> just paste the <code>.onion</code> into your trusty <a href="https://www.torproject.org/download/">Tor Browser</a> and press <code>&lt;enter&gt;</code> — but that’s only going to work for Onion Services hosting <a href="https://en.wikipedia.org/wiki/HTTP">HTTP servers</a> on port 80 or 443. It won’t, for example, tell you if the Onion Service is alive if it runs an XMPP server. Or an IMAP server. Or an SSH server.</p>
<p>No. Rather than trying to query the Onion Service on all possible ports, it’s best to query the <a href="https://spec.torproject.org/rend-spec/overview.html">Tor Hidden Service Directory (HSDir)</a>.</p>
<h2>HS What?</h2>
<p>Onion Services (by default) publish a “<a href="https://spec.torproject.org/rend-spec/hsdesc-outer.html">Hidden Service Descriptor</a>” to the Tor network’s distributed Hidden Service Directory (HDir) <a href="https://spec.torproject.org/rend-spec/deriving-keys.html#EXPIRE-DESC">every 3 hours</a>.</p>
<p>The Hidden Service Descriptor returned by the HDir contains the metadata necessary for a client to connect to the Onion Service.</p>
<p>If a given Onion Service’s Hidden Service Descriptor cannot be found, then the Onion Service is likely dead.</p>

<p>At the time of writing, this guide was tested against the following software and versions:</p>
<ol>
<li>Debian 12</li>
<li>Tor 0.4.7.16</li>
<li>Python 3.11.2</li>
<li>python3-stem 1.8.1-2.1</li>
</ol>
<blockquote><p>
ⓘ Note that v2 Onion Services (22-characters long) were <a href="https://support.torproject.org/onionservices/v2-deprecation/">deprecated by the Tor Project</a> in Jun 2021. They no longer work.</p>
<p><a href="https://lists.torproject.org/pipermail/tor-dev/2017-January/011816.html">v3 Onion Services</a> (62-characters long) have replaced them.</p>
<p>To query Hidden Service Descriptors for v3 Onion Services, you’ll need stem &gt;= v1.8, which <a href="https://stem.torproject.org/change_log.html#version-1-8-december-29th-2019">added HiddenServiceDescriptorV3()</a> support
</p></blockquote>
<p>If you’re using a different OS or software versions, then adaptations to the below commands may be necessary.</p>

<p>This section will show how you can check to see if a given Onion Service is alive.</p>
<h2>Prereqs</h2>
<p>Before you can query the Tor network, you first must install Tor and start the Tor daemon.</p>
<p>Execute the following commands to install (and start) Tor.</p>
<pre title=""># install Tor
sudo apt-get install tor

# star the Tor daemon
sudo systemctl start tor
</pre>
<p>Before you can use the stem (Tor) python module to query the Tor network, you first must install python and the stem python module.</p>
<p>Execute the following commands to install python and the required stem python module:</p>
<pre title=""># install python
sudo apt-get install python3

# install the stem python module
sudo apt-get install python3-stem
</pre>
<p>Before you can use stem to query the Tor network, you must modify the tor config to enable a <a href="https://tor.stackexchange.com/questions/12627/whats-the-difference-between-controlport-and-socksport">Control Port</a> — where stem will be able to interact directly (and “control”) the tor daemon (as opposed to simply use Tor to make Internet connections).</p>
<p>Execute the followig commands to uncomment the line “#ControlPort 9051” from the ‘<code>/etc/tor/torrc</code>‘ config file (just delete the leading hash character [#] and save the file):</p>
<pre title=""># make a backup of the tor config file
sudo cp /etc/tor/torrc /etc/tor/torrc.bak

# uncomment the line &#34;ControlPort 9051&#34;
sudo vim /etc/tor/torrc
</pre>
<p>After editing the ‘<code>/etc/tor/torrc</code>‘ config file (eg in ‘<code>vim</code>‘), you should see the following difference</p>
<pre title="">user@disp6307:~$ sudo diff /etc/tor/torrc.bak /etc/tor/torrc
56c56
&lt; #ControlPort 9051
---
&gt; ControlPort 9051
user@disp6307:~$ 
</pre>
<p>Finally, restart the tor daemon to apply the change:</p>
<pre title=""># restart the tor daemon
sudo systemctl restart tor
</pre>
<h2>The python</h2>
<p>Execute ‘<code>sudo python3</code>‘ to open a python interpreter shell as root</p>
<pre title="">user@disp6307:~$ sudo python3
Python 3.11.2 (main, Nov 30 2024, 21:22:50) [GCC 12.2.0] on linux
Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
&gt;&gt;&gt; 
</pre>
<p>At the prompt, import our required ‘<code>Controller</code>‘ object from the ‘<code>stem</code>‘ python module</p>
<pre title="">&gt;&gt;&gt; from stem.control import Controller
&gt;&gt;&gt; 
</pre>
<p>At the prompt, create a new instance of the ‘<code>Controller</code>‘ object. Make sure the port number here (eg ‘<code>9051</code>‘) matches the number following ‘<code>ControlPort</code>‘ in the ‘<code>/etc/tor/torrc</code>‘ file that you uncommented above.</p>
<pre title="">&gt;&gt;&gt; controller = Controller.from_port(port=9051)
&gt;&gt;&gt; 
</pre>
<p>At the prompt, tell the new controller to connect to your local Tor daemon using the ‘<code>authenticate()</code>‘ method:</p>
<pre title="">&gt;&gt;&gt; controller.authenticate()
&gt;&gt;&gt; 
</pre>
<p>At the prompt, confirm that the controller’s connection to the Tor daemon is working using the ‘<code>is_alive()</code>‘ method:</p>
<pre title="">&gt;&gt;&gt; controller.is_alive()
True
&gt;&gt;&gt; 
</pre>
<p>Now you can ask the controller to get the Hidden Service Descriptor for a given Onion Service — just strip-off the ‘<code>.onion</code>‘ at the end of your Onion Service. In this example, we’ll use the DuckDuckGo Onion Serivce <a href="http://duckduckgogg42xjoc72x3sjasowoarfbgcmvfimaftt6twagswzczad.onion">duckduckgogg42xjoc72x3sjasowoarfbgcmvfimaftt6twagswzczad.onion</a>:</p>
<pre title="">&gt;&gt;&gt; controller.get_hidden_service_descriptor( &#39;duckduckgogg42xjoc72x3sjasowoarfbgcmvfimaftt6twagswzczad&#39; )
&lt;stem.descriptor.hidden_service.HiddenServiceDescriptorV2 object at 0x7b3ddf115710&gt;
&gt;&gt;&gt; 
</pre>
<p>If you didn’t get an error, then the Onion Service is alive!</p>
<p>For comparison, here’s a nonsense Onion Service that does *not* exist (and returns a ProtocolError Exception):</p>
<pre title="">&gt;&gt;&gt; controller.get_hidden_service_descriptor( &#39;thisverylikelydoesnotexistandihopeitdoesnotexistfortestd&#39; )
Traceback (most recent call last):
  File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;
  File &#34;/usr/lib/python3/dist-packages/stem/control.py&#34;, line 489, in wrapped
    return func(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &#34;/usr/lib/python3/dist-packages/stem/control.py&#34;, line 2188, in get_hidden_service_descriptor
    raise stem.ProtocolError(&#39;HSFETCH returned unexpected response code: %s&#39; % response.code)
stem.ProtocolError: HSFETCH returned unexpected response code: 513
&gt;&gt;&gt; 
</pre>
<h2>Scripted Example</h2>
<p>Recently I was <a href="https://forums.whonix.org/t/xmpp-onion-service-only-no-clearnet/21379/7">searching for</a> an <a href="https://tor.stackexchange.com/questions/24097/how-to-test-if-onion-service-is-still-alive-hidden-service-descriptor-query">XMPP server</a> that was hosted on an Onion Service. Unfortunately, the majority of the <a href="https://xmpp.404.city/#tor">XMPP server lists</a> that I <a href="https://gist.github.com/dllud/a46d4a555e31dfeff6ad41dcf20729ac">found</a> were very <a href="https://github.com/coyim/coyim/blob/main/servers/known.go">out-of-date</a>, and I needed a way to check a list of dozens of Onion Services to see which were still operational and which were dead.</p>
<p>So I wrote the following python script, and saved it as ‘<code>get_hidden_service_descriptor.py</code>‘</p>
<pre title="get_hidden_service_descriptor.py">from stem.control import Controller
from stem.descriptor.hidden_service import HiddenServiceDescriptorV3

onions = [&#39;2n3tvihf4n27pqyqdtcqywl33kbjuv2kj3eeq6qvbtud57jwiaextmid.onion&#39;, &#39;32qywqnlnqzbry42nmotr47ebts3k6lhiwfob6xniosmepz2tsnsx7ad.onion&#39;, &#39;4colmnerbjz3xtsjmqogehtpbt5upjzef57huilibbq3wfgpsylub7yd.onion&#39;, &#39;6voaf7iamjpufgwoulypzwwecsm2nu7j5jpgadav2rfqixmpl4d65kid.onion&#39;, &#39;6w5iasklrbr2kw53zqrsjktgjapvjebxodoki3gjnmvb4dvcbmz7n3qd.onion&#39;, &#39;7drfpncjeom3svqkyjitif26ezb3xvmtgyhgplcvqa7wwbb4qdbsjead.onion&#39;, &#39;ae3w7fkzr3elfwsk6mhittjj7e7whme2tumdrhw3dfumy2hsiwomc3yd.onion&#39;, &#39;chillingguw3yu2rmrkqsog4554egiry6fmy264l5wblyadds3c2lnyd.onion&#39;, &#39;fzdx522fvinbaqgwxdet45wryluchpplrkkzkry33um5tufkjd3wdaqd.onion&#39;, &#39;gku6irp4e65ikfkbrdx576zz6biapv37vv2cmklo2qyrtobugwz5iaad.onion&#39;, &#39;gois4b6fahhrlsieupl56xd6ya226m33abzuv26vgfpuvv44wf6vbdad.onion&#39;, &#39;j4dhkkxfcsvzvh3p5djkmuehhgd6t6l7wmzih6b4ss744hegwkiae7ad.onion&#39;, &#39;jabjabdea2eewo3gzfurscj2sjqgddptwumlxi3wur57rzf5itje2rid.onion&#39;, &#39;jaswtrycaot3jzkr7znje4ebazzvbxtzkyyox67frgvgemwfbzzi6uqd.onion&#39;, &#39;jeirlvruhz22jqduzixi6li4xyoweytqglwjons4mbuif76fgslg5uad.onion&#39;, &#39;jukrlvyhgguiedqswc5lehrag2fjunfktouuhi4wozxhb6heyzvshuyd.onion&#39;, &#39;mrbenqxl345o4u7yaln25ayzz5ut6ab3kteulzqusinjdx6oh7obdlad.onion&#39;, &#39;nixnet54icmeh25qsmcsereuoareofzevjqjnw3kki6oxxey3jonwwyd.onion&#39;, &#39;qawb5xl3mxiixobjsw2d45dffngyyacp4yd3wjpmhdrazwvt4ytxvayd.onion&#39;, &#39;qwikoouqore6hxczat3gwbe2ixjpllh3yuhaecixyenprbn6r54mglqd.onion&#39;, &#39;qwikxxeiw4kgmml6vjw2bsxtviuwjce735dunai2djhu6q7qbacq73id.onion&#39;, &#39;razpihro3mgydaiykvxwa44l57opvktqeqfrsg3vvwtmvr2srbkcihyd.onion&#39;, &#39;rurcblzhmdk22kttfkel2zduhyu3r6to7knyc7wiorzrx5gw4c3lftad.onion&#39;, &#39;szd7r26dbcrrrn4jthercrdypxfdmzzrysusyjohn4mpv2zbwcgmeqqd.onion&#39;, &#39;xdkriz6cn2avvcr2vks5lvvtmfojz2ohjzj4fhyuka55mvljeso2ztqd.onion&#39;, &#39;xiynxwxxpw7olq76uhrbvx2ts3i7jagqnqix7arfbknmleuoiwsmt5yd.onion&#39;, &#39;xmppccwrohw3lmfap6e3quep2yzx3thewkfhw4vptb5gwgnkttlq2vyd.onion&#39;, &#39;ynnuxkbbiy5gicdydekpihmpbqd4frruax2mqhpc35xqjxp5ayvrjuqd.onion&#39;, &#39;yxkc2uu3rlwzzhxf2thtnzd7obsdd76vtv7n34zwald76g5ogbvjbbqd.onion&#39;]

controller = Controller.from_port(port=9051)
controller.authenticate()
if controller.is_alive():
  print( &#34;INFO: Confirmed that Tor is working.&#34; )

print( &#34;INFO: Trying get_hidden_service_descriptor()&#34; )
for onion in onions:
    print( onion )
    try:
        desc = controller.get_hidden_service_descriptor(onion)
        print( &#34;\tOK&#34; )
    except Exception as e:
        print( &#34;\tNo Descriptor Found&#34; )
</pre>
<p>Here’s an example execution, which shows that 7 out of 29 of the Onion Services are dead.</p>
<pre title="">user@disp6307:~$ time sudo python3 get_hidden_service_descriptor.py 
INFO: Confirmed that Tor is working.
INFO: Trying get_hidden_service_descriptor()
2n3tvihf4n27pqyqdtcqywl33kbjuv2kj3eeq6qvbtud57jwiaextmid.onion
	OK
32qywqnlnqzbry42nmotr47ebts3k6lhiwfob6xniosmepz2tsnsx7ad.onion
	OK
4colmnerbjz3xtsjmqogehtpbt5upjzef57huilibbq3wfgpsylub7yd.onion
	OK
6voaf7iamjpufgwoulypzwwecsm2nu7j5jpgadav2rfqixmpl4d65kid.onion
	OK
6w5iasklrbr2kw53zqrsjktgjapvjebxodoki3gjnmvb4dvcbmz7n3qd.onion
	No Descriptor Found
7drfpncjeom3svqkyjitif26ezb3xvmtgyhgplcvqa7wwbb4qdbsjead.onion
	No Descriptor Found
ae3w7fkzr3elfwsk6mhittjj7e7whme2tumdrhw3dfumy2hsiwomc3yd.onion
	OK
chillingguw3yu2rmrkqsog4554egiry6fmy264l5wblyadds3c2lnyd.onion
	OK
fzdx522fvinbaqgwxdet45wryluchpplrkkzkry33um5tufkjd3wdaqd.onion
	OK
gku6irp4e65ikfkbrdx576zz6biapv37vv2cmklo2qyrtobugwz5iaad.onion
	OK
gois4b6fahhrlsieupl56xd6ya226m33abzuv26vgfpuvv44wf6vbdad.onion
	OK
j4dhkkxfcsvzvh3p5djkmuehhgd6t6l7wmzih6b4ss744hegwkiae7ad.onion
	OK
jabjabdea2eewo3gzfurscj2sjqgddptwumlxi3wur57rzf5itje2rid.onion
	OK
jaswtrycaot3jzkr7znje4ebazzvbxtzkyyox67frgvgemwfbzzi6uqd.onion
	OK
jeirlvruhz22jqduzixi6li4xyoweytqglwjons4mbuif76fgslg5uad.onion
	OK
jukrlvyhgguiedqswc5lehrag2fjunfktouuhi4wozxhb6heyzvshuyd.onion
	No Descriptor Found
mrbenqxl345o4u7yaln25ayzz5ut6ab3kteulzqusinjdx6oh7obdlad.onion
	No Descriptor Found
nixnet54icmeh25qsmcsereuoareofzevjqjnw3kki6oxxey3jonwwyd.onion
	OK
qawb5xl3mxiixobjsw2d45dffngyyacp4yd3wjpmhdrazwvt4ytxvayd.onion
	No Descriptor Found
qwikoouqore6hxczat3gwbe2ixjpllh3yuhaecixyenprbn6r54mglqd.onion
	OK
qwikxxeiw4kgmml6vjw2bsxtviuwjce735dunai2djhu6q7qbacq73id.onion
	OK
razpihro3mgydaiykvxwa44l57opvktqeqfrsg3vvwtmvr2srbkcihyd.onion
	No Descriptor Found
rurcblzhmdk22kttfkel2zduhyu3r6to7knyc7wiorzrx5gw4c3lftad.onion
	OK
szd7r26dbcrrrn4jthercrdypxfdmzzrysusyjohn4mpv2zbwcgmeqqd.onion
	OK
xdkriz6cn2avvcr2vks5lvvtmfojz2ohjzj4fhyuka55mvljeso2ztqd.onion
	OK
xiynxwxxpw7olq76uhrbvx2ts3i7jagqnqix7arfbknmleuoiwsmt5yd.onion
	OK
xmppccwrohw3lmfap6e3quep2yzx3thewkfhw4vptb5gwgnkttlq2vyd.onion
	OK
ynnuxkbbiy5gicdydekpihmpbqd4frruax2mqhpc35xqjxp5ayvrjuqd.onion
	No Descriptor Found
yxkc2uu3rlwzzhxf2thtnzd7obsdd76vtv7n34zwald76g5ogbvjbbqd.onion
	OK

real	0m53.311s
user	0m0.005s
sys	0m0.006s
user@disp6307:~$ 
</pre>

<p>This section will explain limitations to the information outlined in this article, as well as suggest potential improvements.</p>
<h2>PublishHidServDescriptors</h2>
<p>This method won’t work if the Onion Service has set ‘<code><a href="https://manpages.debian.org/jessie/tor/torrc.5.en.html#HIDDEN_SERVICE_OPTIONS">PublishHidServDescriptors</a></code>‘ to ‘<code>0</code>‘.</p>
<p>But if an Onion Service doesn’t publish its Hidden Service Descriptors, then it’s not alive anyway — since clients won’t be able to obtain the necessary metadata from the Tor network to connect to it.</p>

<ol>
<li><a href="https://www.torproject.org/">torproject.org</a><a> Official Tor Project Website</a></li><a>
</a><li><a></a><a href="https://stem.torproject.org/">stem.torproject.org</a><a> Official Stem Project Website</a></li><a>
</a><li><a></a><a href="https://forum.torproject.org/">forum.torproject.org</a><a> Official Tor Project Support Forums</a></li><a>
</a><li><a></a><a href="https://stem.torproject.org/tutorials/over_the_river.html">stem.torproject.org/tutorials/over_the_river.html</a> Stem Tutorial for Hidden Services</li>
<li><a href="https://github.com/torproject/stem/issues/96">https://github.com/torproject/stem/issues/96</a> Bug in stem where get_hidden_service_descriptor() returns a v2 descriptor</li>
</ol>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img loading="lazy" decoding="async" src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/2019/04/100x100xavatar_square_150.jpg.pagespeed.ic.3b2Y7Ghd_z.jpg" width="100" height="100" alt="headshot of Michael Altfield" itemprop="image"/></p><div><div itemprop="description"><p>Hi, I’m Michael Altfield. I write articles about opsec, privacy, and devops <a href="https://michaelaltfield.net/biography/">➡</a></p>
<p><a href="https://michaelaltfield.net/biography/">About Michael</a></p>
</div></div></div></div></div></div>
  </body>
</html>
