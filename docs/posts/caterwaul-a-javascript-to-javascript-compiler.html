<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/spencertipping/caterwaul">Original</a>
    <h1>Caterwaul: A JavaScript-to-JavaScript Compiler</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
          <article itemprop="text">
<p dir="auto">Caterwaul is two different things. First, and most importantly, it is a powerful low-level Javascript code manipulation library with a Javascript parser, AST, in-process compiler, and
replication. Second, it is a programming language implementation that uses this library to transform your code in various arcane ways that I happen to find useful.</p>
<p dir="auto">The whole project is MIT-licensed, and in the unlikely event that you want to use it you are free to <a href="mailto:spencer@spencertipping.com">email me</a> with any questions/issues.</p>
<p dir="auto">What follows is a ten-minute introduction to caterwaul&#39;s core concepts. It covers about 5% of what caterwaul does.</p>
<h2 dir="auto"><a id="user-content-heads-up-before-you-use-this" aria-hidden="true" href="#heads-up-before-you-use-this"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Heads up: before you use this</h2>
<p dir="auto">It has a few defects. One relates to stuff like <code>if (x) switch (y) {} else z();</code>, which gets rewritten to broken code. This is a parse-level problem and I haven&#39;t had time to fix it yet.</p>
<p dir="auto">Second, various ES5/6 features aren&#39;t entirely supported; for example functions-in-objects (<code>let x = {f() {}};</code>). There&#39;s probably more; the ES5 support was hacked on last-minute.</p>
<p dir="auto">Third, Caterwaul parses non-JS. <code>let @x = 100</code> is fine, <code>let x\y\z = @foo[\]</code> works, etc. Not a defect exactly, but something to be aware of.</p>
<h2 dir="auto"><a id="user-content-caterwaul-as-a-library" aria-hidden="true" href="#caterwaul-as-a-library"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Caterwaul as a library</h2>
<p dir="auto">Caterwaul is implemented in pure Javascript, so you can use it to live-compile your code in a browser, or you can use the <code>waul</code> precompiler to compile your code up-front. You can see the
live compiler in action by going to <a href="http://caterwauljs.org" rel="nofollow">the caterwaul website</a>. This site embeds a caterwaul compiler configured to use the standard macro library; this causes it to
compile what I refer to as the caterwaul programming language. The website documents this language in some detail, as does <a href="http://caterwauljs.org/doc/caterwaul-by-example.pdf" rel="nofollow">Caterwaul by
Example</a> - though some of the examples will fail since Caterwaul 1.2.3, which introduces <a href="https://github.com/spencertipping/caterwaul/commit/05a5e317336e751cbf90a7f574070d3eca4f69a4">a breaking
change</a> to the <code>seq</code> library.</p>
<p dir="auto">If you&#39;re interested in using caterwaul as a compiler library, I recommend reading the <a href="http://caterwauljs.org/doc/caterwaul-reference-manual.pdf" rel="nofollow">caterwaul reference manual</a>, which covers
its core API in significantly more detail than this readme. You can also read through the caterwaul source code, which contains copious documentation, some of which is up to date.</p>
<h3 dir="auto"><a id="user-content-parsing-things" aria-hidden="true" href="#parsing-things"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Parsing things</h3>
<p dir="auto">Caterwaul&#39;s Javascript parser takes anything with a valid <code>toString()</code> method as input, including Javascript functions.</p>
<div data-snippet-clipboard-copy-content="var tree = caterwaul.parse(&#39;3 + 4&#39;);
tree.toString()           // &#39;3 + 4&#39;
tree.data                 // &#39;+&#39;
tree.length               // 2
tree[0].data              // &#39;3&#39;
tree[1].data              // &#39;4&#39;"><pre><code>var tree = caterwaul.parse(&#39;3 + 4&#39;);
tree.toString()           // &#39;3 + 4&#39;
tree.data                 // &#39;+&#39;
tree.length               // 2
tree[0].data              // &#39;3&#39;
tree[1].data              // &#39;4&#39;
</code></pre></div>
<h3 dir="auto"><a id="user-content-detecting-patterns" aria-hidden="true" href="#detecting-patterns"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Detecting patterns</h3>
<p dir="auto">If you&#39;re serious about this stuff, I recommend writing this code in the caterwaul programming language. It supports a lot of advanced features that make syntax trees much easier to work
with; in particular, preparsed quoted constructs (similar to the &#39; operator in Lisp). These will give you a significant performance advantage and better notation.</p>
<div data-snippet-clipboard-copy-content="var pattern = caterwaul.parse(&#39;_x + _y&#39;);
var match   = pattern.match(tree);
match._x.data             // &#39;3&#39;
match._y.data             // &#39;4&#39;
var template = caterwaul.parse(&#39;f(_x, _y)&#39;);
var new_tree = template.replace(match);
new_tree.toString()       // &#39;f(3, 4)&#39;"><pre><code>var pattern = caterwaul.parse(&#39;_x + _y&#39;);
var match   = pattern.match(tree);
match._x.data             // &#39;3&#39;
match._y.data             // &#39;4&#39;
var template = caterwaul.parse(&#39;f(_x, _y)&#39;);
var new_tree = template.replace(match);
new_tree.toString()       // &#39;f(3, 4)&#39;
</code></pre></div>
<h3 dir="auto"><a id="user-content-compiling-things" aria-hidden="true" href="#compiling-things"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Compiling things</h3>
<p dir="auto">Caterwaul&#39;s compiler does a lot, but the basic case works like <code>eval</code>:</p>
<div data-snippet-clipboard-copy-content="var f = function (x, y) {return x * y};
caterwaul.compile(new_tree)       // 12"><pre><code>var f = function (x, y) {return x * y};
caterwaul.compile(new_tree)       // 12
</code></pre></div>
<p dir="auto">You can also bind variables from the compiling environment:</p>
<div data-snippet-clipboard-copy-content="var new_f = function (x, y) {return x + y};
caterwaul.compile(new_tree, {f: new_f})   // 7"><pre><code>var new_f = function (x, y) {return x + y};
caterwaul.compile(new_tree, {f: new_f})   // 7
</code></pre></div>
<p dir="auto">You can only compile things that return values (technically, things which are expressions; the litmus test is whether you could legally wrap it in parentheses), so stuff like <code>var x = 10</code>
won&#39;t work. This is different from Javascript&#39;s <code>eval</code> function. If you want to execute imperative code, you should wrap it in a function:</p>
<div data-snippet-clipboard-copy-content="var function_wrapper = caterwaul.parse(&#39;(function() {_body})&#39;);
var code = caterwaul.parse(&#39;if (x) {console.log(x)}&#39;);
var new_function = caterwaul.compile(function_wrapper.replace({_body: code}));
new_function();"><pre><code>var function_wrapper = caterwaul.parse(&#39;(function() {_body})&#39;);
var code = caterwaul.parse(&#39;if (x) {console.log(x)}&#39;);
var new_function = caterwaul.compile(function_wrapper.replace({_body: code}));
new_function();
</code></pre></div>
<h2 dir="auto"><a id="user-content-caterwaul-as-a-programming-language" aria-hidden="true" href="#caterwaul-as-a-programming-language"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Caterwaul as a programming language</h2>
<p dir="auto">I wrote a set of macros that use the above API to modify Javascript code; this macro set has been refined over the past year to become a programming language that I find useful. You can
learn this language on the caterwaul website, which goes through it by example and provides an interactive shell so you can see what the compilation process looks like.</p>
<h3 dir="auto"><a id="user-content-using-caterwaul-this-way" aria-hidden="true" href="#using-caterwaul-this-way"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Using caterwaul this way</h3>
<p dir="auto">There are two ways to use caterwaul as a programming language. You can compile code from inside another Javascript process, which works because all caterwaul code is syntactically valid
Javascript code as well (note that the following example will work only if you&#39;ve loaded <code>caterwaul.std.js</code> from the <code>build/</code> directory):</p>
<div data-snippet-clipboard-copy-content="var compiler = caterwaul(&#39;:all&#39;);         // :all means &#39;every macro you know about&#39;
var compiled = compiler(function () {
  console.log(x) -where [x = 10];
});
compiled();               // logs 10"><pre><code>var compiler = caterwaul(&#39;:all&#39;);         // :all means &#39;every macro you know about&#39;
var compiled = compiler(function () {
  console.log(x) -where [x = 10];
});
compiled();               // logs 10
</code></pre></div>
<p dir="auto">The other way to use the programming language is by using the <code>waul</code> precompiler. This compiles your code to straight Javascript, eliminating the runtime overhead imposed by caterwaul&#39;s
parser, macroexpander, and compiler. Waul files typically end in <code>.waul</code> or <code>.waul.sdoc</code> (if you&#39;re using <a href="http://github.com/spencertipping/sdoc">SDoc</a>, which waul will transparently
parse) and contain code like this:</p>
<div data-snippet-clipboard-copy-content="caterwaul(&#39;:all&#39;)(function () {
  n[10] *console.log -seq;
  console.log(&#39;done #{message}&#39;)
    -where [message = &#39;iterating through numbers&#39;];
})();"><pre><code>caterwaul(&#39;:all&#39;)(function () {
  n[10] *console.log -seq;
  console.log(&#39;done #{message}&#39;)
    -where [message = &#39;iterating through numbers&#39;];
})();
</code></pre></div>
<p dir="auto">You can compile this by running <code>waul file.waul</code>, which will generate <code>file.js</code>. <code>file.js</code> may contain references to the <code>caterwaul</code> global if you use certain macros, but there will be no
compilation overhead.</p>
<h2 dir="auto"><a id="user-content-caterwaul-as-a-self-replicating-monstrosity" aria-hidden="true" href="#caterwaul-as-a-self-replicating-monstrosity"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Caterwaul as a self-replicating monstrosity</h2>
<p dir="auto">This is the coolest part of caterwaul in my opinion. Both <code>caterwaul</code> as a Javascript object and <code>waul</code> can give you string expressions that reproduce them. This is very useful for library
bundling; for example:</p>
<div data-snippet-clipboard-copy-content="var r = caterwaul.replicator();
var code = r.toString();"><pre><code>var r = caterwaul.replicator();
var code = r.toString();
</code></pre></div>
<p dir="auto">If you do this, someone else can <code>eval</code> &#39;code&#39; and they will end up with a global called <code>caterwaul</code> that is configured exactly as your <code>caterwaul</code> is configured. The only requirement is
that configurations be declared as modules, which is done like this:</p>
<div data-snippet-clipboard-copy-content="// caterwaul.module(name, [compiler_configuration], function)
caterwaul.module(&#39;my-configuration&#39;, &#39;:all&#39;, function ($) {
  // $ is the global caterwaul object
  $.foo = &#39;bar&#39;;
});"><pre><code>// caterwaul.module(name, [compiler_configuration], function)
caterwaul.module(&#39;my-configuration&#39;, &#39;:all&#39;, function ($) {
  // $ is the global caterwaul object
  $.foo = &#39;bar&#39;;
});
</code></pre></div>
<p dir="auto">The output of <code>replicator</code> is a function that recreates all modules by re-running their initializers. Note that <code>replicator</code> rewrites the module functions into their post-compilation
equivalents; in other words, the body of each function has already been compiled into normal Javascript. This reduces total compilation overhead.</p>
<h3 dir="auto"><a id="user-content-waul-replication" aria-hidden="true" href="#waul-replication"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Waul replication</h3>
<p dir="auto">Suppose you write a custom caterwaul module and want a new version of <code>waul</code> that contains it. You can ask <code>waul</code> to replicate itself with an extension like this:</p>
<div data-snippet-clipboard-copy-content="$ ./waul -r -e extension.waul &gt; new-waul
$ chmod u+x new-waul
$ ./new-waul my-file.waul"><pre><code>$ ./waul -r -e extension.waul &gt; new-waul
$ chmod u+x new-waul
$ ./new-waul my-file.waul
</code></pre></div>
<p dir="auto">This is especially useful for setting up shebang lines for scripts that require custom waul extensions:</p>
<div data-snippet-clipboard-copy-content="#!./new-waul
caterwaul(&#39;:all&#39;)(function () {
  // custom code
})();"><pre><code>#!./new-waul
caterwaul(&#39;:all&#39;)(function () {
  // custom code
})();
</code></pre></div>
<p dir="auto">The <code>waul</code> in caterwaul&#39;s root directory is preloaded with <code>build/caterwaul.std.js</code> and <code>build/caterwaul.ui.js</code>. As you might guess, <code>waul</code> wasn&#39;t written specially to contain these;
rather, it was generated by <code>waul-core</code> (which doesn&#39;t have any libraries built-in) by this process:</p>
<div data-snippet-clipboard-copy-content="$ ./waul-core --replicate -e build/caterwaul.std.min.js -e build/caterwaul.ui.min.js &gt; waul
$ chmod 0700 waul"><pre><code>$ ./waul-core --replicate -e build/caterwaul.std.min.js -e build/caterwaul.ui.min.js &gt; waul
$ chmod 0700 waul
</code></pre></div>
</article>
        </div></div>
  </body>
</html>
