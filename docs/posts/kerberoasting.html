<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.cryptographyengineering.com/2025/09/10/kerberoasting/">Original</a>
    <h1>Kerberoasting</h1>
    
    <div id="readability-page-1" class="page"><article id="post-8655">
	
	<div>
		
<p>I learn about cryptographic vulnerabilities all the time, and they generally fill me with some combination of jealousy (“oh, why didn’t I think of that”) or else they impress me with the brilliance of their inventors. But there’s also another class of vulnerabilities: these are the ones <em>that can’t possibly exist</em> in important production software, because <em>there’s no way anyone could still do that in 2025.</em></p>



<p>Today I want to talk about one of those ridiculous ones, something Microsoft calls “low tech, high-impact”. This vulnerability isn’t particularly new; in fact the worst part about it is that it’s <em><a href="https://www.redsiege.com/wp-content/uploads/2020/08/Kerberoastv4.pdf">had a name</a></em> for over a decade, and it’s existed for longer than that. I’ll bet most Windows people already know this stuff, but I only happened to learn about it today, after seeing a <a href="https://www.bloomberg.com/news/newsletters/2025-09-10/wyden-says-microsoft-flaws-led-to-hack-of-us-hospital-system-mfdt6mkb">letter from Senator Wyden to Microsoft</a>, describing how this vulnerability was used in the May 2024 <a href="https://www.hipaajournal.com/ascension-cyberattack-2024/">ransomware attack on the Ascension Health hospital system</a>.</p>



<p>The vulnerability is called <a href="https://www.irongeek.com/i.php?page=videos%2Fderbycon4%2Ft120-attacking-microsoft-kerberos-kicking-the-guard-dog-of-hades-tim-medin">Kerberoasting</a>, and TL;DR it relies on the fact that Microsoft’s Active Directory is <em>very, very old</em>. And also: RC4. If you don’t already know where I’m going with this, please read on.</p>



<p><strong>A couple of updates: </strong><em>The <a href="https://news.ycombinator.com/item?id=45196437">folks on HN</a> pointed out that I was using some incorrect terms in here (sorry!) and added some good notes, so I’m updating below.</em></p>



<h3>What’s Kerberos, and what’s Active Directory?</h3>



<p>Microsoft’s Active Directory (AD) is a many-tentacled octopus that controls access to almost every network that runs Windows machines. The system uses centralized authentication servers to determine who gets access to which network resources. If an employee’s computer needs to access some network Service (a file server, say), an Active Directory server authenticates the user and helps them get securely connected to the Service.</p>



<p>This means that AD is also the main barrier ensuring that attackers can’t extend their reach deeper into a corporate network. If an attacker somehow gets a toehold inside an enterprise (for example, because <a href="https://www.audacy.com/wwjnewsradio/news/local/worker-who-clicked-bogus-link-led-to-ascension-cyber-attack">an employee clicks on a malicious Bing link</a>), they should <span>absolutely not</span> be able to move laterally and access critical network services. That’s because any such access would require the employee’s machine to have access to specialized accounts (called “Service accounts”) with privileges to fully control those machines. A well-managed network obviously won’t allow this. This means that AD is the “guardian” that stands between most companies and total disaster.</p>



<p>Unfortunately, Active Directory is a monster dragged from the depths of time. It uses the Kerberos protocol, which was first introduced in early 1989. <a href="https://en.wikipedia.org/wiki/Fall_of_the_Berlin_Wall">A lot of things have happened since 1989!</a> In fairness to Microsoft, Active Directory itself didn’t actually debut until about 1999; but (in less fairness), large portions of its legacy cryptography from that time period appear to still be supported in AD. This is very bad, because the cryptography is exceptionally terrible. </p>



<p>Let me get specific.</p>



<p>When you want to obtain access to some network resource (a “Service” in AD parlance), you first contact an AD server (called a KDC) to obtain a “<a href="https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview">ticket</a>” that you can send to the Service to authenticate. This ticket is encrypted using a long-term Service “password” established at the KDC and the Service itself, and it’s handed to the user making the call.</p>



<p>Now, ideally, this Service password is not really a password at all: it’s actually a randomly-generated cryptographic key. Microsoft even has systems in place to generate and rotate these keys regularly. This means the encrypted ticket will be completely inscrutable to the user who receives it, even if they’re malicious. But occasionally network administrators will make mistakes, and one (apparently) somewhat common mistake is to set up a Service that’s connected to an ordinary <em>user</em> account, complete with a human-generated password.</p>



<p>Since human passwords probably <em>are not</em> cryptographically strong, the tickets encrypted using them are extremely vulnerable to cracking. This is very bad, since any random user — including our hypothetical laptop malware hacker — can now obtain a copy of such a ticket, and attempt to crack the Service’s password offline by trying many candidate passwords using a <a href="https://en.wikipedia.org/wiki/Dictionary_attack">dictionary attack</a>.</p>



<p>Isn’t that cute?</p>



<h3>That doesn’t actually seem very cute?</h3>



<p>Of course, it’s not. It’s actually a terrible design that should have been done away with decades ago. We should not build systems where any random attacker who compromises a single employee laptop can ask for a message encrypted under a critical password! This basically invites offline cracking attacks, which do not need even to be executed on the compromised laptop — they can be exported out of the network to another location and performed using GPUs and other hardware.</p>



<p>There are a few things that can stop this attack in practice. As we noted above, if the account has a long enough (random!) password, then cracking it should be virtually impossible. Microsoft could prevent users from configuring services with weak human-generated passwords, but apparently they don’t — at least because this is something that’s happened many times (including at Ascension Health.) </p>



<p>So let’s say you did not use a strong cryptographic key as your Service’s password. Where are you?</p>



<p>Your best hope in this case is that the encrypted tickets are <em>extremely challenging</em> for an attacker to crack. That’s because at this point, the only thing preventing the attacker from accessing your Service is computing power. But — and this is a very weak “but” — computing power can still be a deterrent! In the “standard” authentication mode, tickets are encrypted with AES, using a key derived using 4,096 iterations of <a href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2 hashing</a>, based on the Service password and a per-account salt (<strong>Update</strong>: which is not truly random salt, it’s a combination of domain and principal name.) The salt means an attacker cannot easily pre-compute a dictionary of hashed passwords, and while the <a href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> (plus AES) isn’t an <em>amazing</em> defense, it puts some limits on the number of passwords that can be hashed in a given unit of time.</p>



<p><a href="https://gist.github.com/Chick3nman/09bac0775e6393468c2925c1e1363d5c">This page</a> by <a href="https://gist.github.com/Chick3nman">Chick3nman</a> gives some excellent password cracking statistics computed using an <a href="https://www.nvidia.com/en-us/geforce/graphics-cards/50-series/rtx-5090/">RTX 5090</a>. It implies that a hacker can crack 6.8 million passwords per second using AES-128 and PBKDF2.</p>



<h3>So that’s not great. But also not terrible, right?</h3>



<p>This isn’t the end of the story. <em>In fact it’s self-evident</em> that this is not the end of the story, because Active Directory was invented in 1999, which means at some point <em>we’ll have to deal with RC4.</em></p>



<p>Here’s the thing. Anytime you see cryptography born in the 1990s and yet using AES, you cannot be dealing with the original. What you’re looking at is the modernized, “upgraded” version of the original. The original probably used an abacus and witchcraft, or (failing that) at least some combination of unsalted hash functions and <a href="https://blog.cryptographyengineering.com/2011/12/15/whats-deal-with-rc4/">RC4</a>. And here’s the worst part: it turns out that in Active Directory, when a user does not configure a Service account to use a more recent mode, then Kerberos will indeed fall back to RC4, combined with unsalted NT hashes (basically, one iteration of <a href="https://en.wikipedia.org/wiki/MD4">MD4</a>.)</p>



<p>The main implication of using RC4 (and NT hashing) is that tickets encrypted this way become hilariously, absurdly fast to crack. According to our friend <a href="https://gist.github.com/Chick3nman/09bac0775e6393468c2925c1e1363d5c">Chick3nman</a>, the same RTX 5090 can crack 4.18 <span><em>billion</em></span> (with a “b”) of these hashes every second. That’s roughly 1000x faster than the AES variant.</p>



<p>As an aside, the NT hashes are not salted, which means they’re vulnerable to pre-computation attacks that involve <a href="http://project-rainbowcrack.com/table.htm">rainbow tables</a>. I had been meaning to write about rainbow tables recently on this blog, but had convinced myself that they mostly don’t matter, given that these ancient unsalted hash functions are going away. I guess maybe I spoke too soon?</p>



<h3>So what is Microsoft doing about this?</h3>



<p>Clearly not enough. These “Kerberoasting” attacks have been around for ages: the technique and name is credited to <a href="https://www.irongeek.com/i.php?page=videos%2Fderbycon4%2Ft120-attacking-microsoft-kerberos-kicking-the-guard-dog-of-hades-tim-medin">Tim Medin</a> who presented it in 2014 (and many popular <a href="https://malicious.link/posts/2016/kerberoast-pt1/?utm_source=chatgpt.com">blogs</a> followed up on it) but the vulnerabilities themselves are much older. The fact that there are practical ransomware attacks using these ideas in 2024 indicates that (1) system administrators aren’t hardening things enough, but <span>more importantly</span>, (2) Microsoft is still not turning off the unsafe options that make these attacks possible.</p>



<figure><a href="https://blog.cryptographyengineering.com/wp-content/uploads/2025/09/image.png"><img data-attachment-id="8674" data-permalink="https://blog.cryptographyengineering.com/2025/09/10/kerberoasting/image-90/" data-orig-file="https://blog.cryptographyengineering.com/wp-content/uploads/2025/09/image.png" data-orig-size="2400,482" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://blog.cryptographyengineering.com/wp-content/uploads/2025/09/image.png?w=300" data-large-file="https://blog.cryptographyengineering.com/wp-content/uploads/2025/09/image.png?w=700" width="1024" height="205" src="https://blog.cryptographyengineering.com/wp-content/uploads/2025/09/image.png?w=1024" alt=""/></a></figure>



<p>To give some sense of where we are, in October 2024, Microsoft <a href="https://www.microsoft.com/en-us/security/blog/2024/10/11/microsofts-guidance-to-help-mitigate-kerberoasting/">published a blog post on how to avoid Kerberos-based attacks</a> (<em>NB: I</em> <em>cannot say Kerberoasting again and take myself seriously)</em>. </p>



<p>The recommendations are all kind of dismal. They recommend that administrators should use proper automated key assignment, and if they can’t do that, then to try to pick “really good long passwords”, and if they can’t do that, to <em>pretty please </em>shut off RC4. But Microsoft doesn’t seem to do anything proactive, like <em>absolutely banning obsolete legacy stuff</em>, or being completely obnoxious and forcing admins to upgrade their weird and bad legacy configurations. Instead this all seems much more like a reluctant and half-baked bit of vulnerability management.</p>



<p>I’m sure there are some reasons why this is, but I refuse to believe they’re good reasons, and Microsoft should probably try a lot harder to make sure these obsolete services go away. It isn’t 1999 anymore, and it isn’t even 2014.</p>



<p>If you don’t believe me on these points, go ask Ascension Health.</p>
	</div><!-- .entry-content -->

			<!-- .entry-footer -->
	</article></div>
  </body>
</html>
