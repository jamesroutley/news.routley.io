<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rachelbythebay.com/w/2024/10/01/lldp/">Original</a>
    <h1>Let the network tell you where you are: a nerd snipe story</h1>
    
    
<p>
I was successfully nerd-sniped a few days ago and figured I&#39;d share my 
proposed solution with everyone just in case they could benefit from it.
I&#39;ve added a few of my own constraints based on expections for how 
things could go wrong.  So, if this seems familiar, maybe it is, but 
I&#39;ve made it a little more complicated.
</p>
<p>
The situation is basically this: there&#39;s a large space with a bunch of 
dumb Linux boxes which are attached to displays of some sort.  Different 
things are displayed depending on where it is in the space.  This means 
the Linux boxes need some sense of identity to be able to tell the 
server &#34;I need this particular set of stuff&#34;.  They&#39;re &#34;hands off&#34; - 
nobody wants to log in to them to manage them.
</p>
<p>
So now let me present some of the issues:
</p>
<p>
Problem: relying on IP assignments is no good, since the DHCP  
mechanisms for that network can&#39;t be trusted.  Things are sufficiently 
flaky to where you can&#39;t rely on it, and part of this is from the next 
item.
</p>
<p>
Problem: the hardware is wonky enough to where it gets replaced 
sometimes, so the MAC addresses also end up changing.  This means any 
other on-board identifier (board id, cpuid, whatever) would also change.  
It would be nice if someone didn&#39;t have to keep updating mappings on the 
server every time the hardware got shuffled around.
</p>
<p>
Problem: it&#39;s a PITA to stamp out unique images for these things.  The 
goal is to be able to stamp out a single image that&#39;s identical for all 
of them, and then have them all boot from that and figure out their 
identities some other way.  (The same goes for netbooting, if you&#39;re 
thinking of that already.)
</p>
<p>
Problem: any other &#34;ID marker&#34; type solution that involves twiddling the 
set of installed hardware somehow means that you have to be sure each 
one ends up in a specific spot.  If you have relatively unskilled people 
running around installing these things, this might not be what you want.
It&#39;s easier to just say &#34;make sure there&#39;s one plugged in at every 
space on this list&#34; without worrying about matching specific units to 
specific spots, in other words.
</p>
<p>
Wouldn&#39;t it be cool if you could just grab a box, plug it in a given 
spot, and it would somehow start displaying the right set of media?  
That&#39;s what I was thinking when I came up with this idea.
</p>
<p>
So, how do you do it?  My &#34;solution&#34; (which has its own caveats) comes 
in the form of 
<a href="https://en.wikipedia.org/wiki/Link_Layer_Discovery_Protocol">LLDP</a>.
</p>
<p>
For those who haven&#39;t encountered it yet, here&#39;s the scoop: certain 
higher-end Ethernet switches have the potential to _multi_cast 
identifying frames every so often.  Any given station on such a switch 
might get a LLDP frame from it a couple of times per minute.
</p>
<p>
In that frame, you can see interesting things, like the MAC address(es) 
of the switch, its name, what OS it might be running (!), the management 
IP addresses (!!), and, finally, what the name of YOUR PORT is.
</p>
<pre class="terminal">	Port Description TLV (4), length 4: eth2
</pre>
<pre class="terminal">        Port Description TLV (4), length 8: Gi1/0/24
          0x0000:  4769 312f 302f 3234
</pre>
<p>
Yep, that&#39;s right, if you&#39;re on such a switch, you might well have 
something arriving on your interface every so often that says &#34;oh by the 
way, you are connected to me on my Gi1/0/24&#34;.  Another device on that 
same switch would get nearly the same announcement, but it might say 
&#34;Gi1/0/48&#34; or whatever else.
</p>
<p>
The point is: if you&#39;re that derpy little display machine, you now have 
a way to tell yourself apart from your &#34;coworkers&#34;.  You could build a 
tuple of (switch name, switch port) and kick that at the display server, 
and let it figure out what set of images/videos you&#39;re supposed to run.
</p>
<p>
Now, there&#39;s always a catch, and here it is: this assumes that you&#39;re 
not changing the mapping between ports on the switch and the actual 
RJ45s in the space.  I&#39;m assuming that port 23 on your switch will 
always be over there by the front door, port 24 will always be next to 
the bathrooms, and 25 will be by the patio door.  You get the idea.
</p>
<p>
If those change, then yeah, you get to reconfigure everything, but at 
least it&#39;s still only on the server, and you don&#39;t have to deal with the 
dumb little display machines.
</p>
<p>
How do you see this?  Well, tcpdump would be a start.  A filter of 
&#34;ether proto 0x88cc&#34; will do the job, but make sure you stick a -v on 
there to make it actually expand the details (or it&#39;ll be pretty dull).
</p>
<p>
Some other things: a relatively low-end switch won&#39;t do anything in this 
space.  It won&#39;t generate it, and it won&#39;t &#34;absorb&#34; it from other  
sources.  So, if your listening post running tcpdump is plugged into 
such a beast, it might hear LLDP stuff coming from multiple other 
sources but it won&#39;t see anything from the switch itself.  Yep, it&#39;s 
more than switches which potentially send these out.  &#34;Server class&#34; 
systems with their own little management device (&#34;BMC&#34;) glued onto them 
tend to do this, too.
</p>
<p>
Normally, such traffic would not cross the switch, but that requires a 
switch that actually &#34;gets&#34; it and knows to not forward it.  Ordinary 
dumb switches will treat it just like any other bit of traffic and will 
send it on down the line.
</p>
<p>
I should also note that other protocols exist which serve similar 
purposes and it depends a lot on which switch vendor you&#39;ve chosen.  
It might not be LLDP but it might be something else which ends in &#34;DP&#34;.  
</p>
<p>
If in doubt, sniff the network and find out!
</p>

  </body>
</html>
