<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ryleealanza.org/posts/hither-ii/">Original</a>
    <h1>Stacks, heaps and garbage collectors—oh my!</h1>
    
    <div id="readability-page-1" class="page"><div id="outline-text-headline-1"><p>the basic players in the hither virtual machine are the <em>stack</em>
(of which there are really two)
and the <em>cell.</em>
The stacks hold cells, and the cells are the data.</p><p>Here’s how cells are defined.</p><div><div><pre tabindex="0"><code data-lang="zig"><span><span><span>  </span><span>pub</span><span> </span><span>const</span><span> </span><span>Cell</span><span> </span><span>=</span><span> </span><span>struct</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>      </span><span>pub</span><span> </span><span>const</span><span> </span><span>Tag</span><span> </span><span>=</span><span> </span><span>enum</span><span>(</span><span>u2</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>          </span><span>slice</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>integer</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>number</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>builtin</span><span>,</span><span>
</span></span></span><span><span><span>      </span><span>};</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>      </span><span>tag</span><span>:</span><span> </span><span>Tag</span><span>,</span><span>
</span></span></span><span><span><span>      </span><span>slice_is</span><span>:</span><span> </span><span>enum</span><span>(</span><span>u2</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>          </span><span>string</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>word</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>definition</span><span>,</span><span>
</span></span></span><span><span><span>      </span><span>}</span><span> </span><span>=</span><span> </span><span>.</span><span>string</span><span>,</span><span>
</span></span></span><span><span><span>      </span><span>data</span><span>:</span><span> </span><span>packed</span><span> </span><span>union</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>          </span><span>slice</span><span>:</span><span> </span><span>packed</span><span> </span><span>struct</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>              </span><span>address</span><span>:</span><span> </span><span>u32</span><span>,</span><span>
</span></span></span><span><span><span>              </span><span>length</span><span>:</span><span> </span><span>u32</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>},</span><span>
</span></span></span><span><span><span>          </span><span>integer</span><span>:</span><span> </span><span>i64</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>number</span><span>:</span><span> </span><span>f64</span><span>,</span><span>
</span></span></span><span><span><span>          </span><span>builtin</span><span>:</span><span> </span><span>*</span><span>const</span><span> </span><span>fn</span><span> </span><span>(</span><span>*</span><span>Hither</span><span>)</span><span> </span><span>Error</span><span>!</span><span>void</span><span>,</span><span>
</span></span></span><span><span><span>      </span><span>},</span><span>
</span></span></span><span><span><span>  </span><span>};</span></span></span></code></pre></div></div><p>Zig has “tagged” unions, so in theory the <code>tag</code> field could be replaced
by writing something like <code>Cell = union(enum) {…};</code>
but that ends up wasting a lot of space on the tag.
“Packed” unions, however, do not have a tag,
letting us sneak in the <code>slice_is</code> enum into some of the tag’s space.</p><p>(By the way, I think Rust and/or Typescript uses the word “enum”
for what is more or less what Zig and C would call a “union”,
and reserves “enum” for a type which “enumrates” a list of constant values.)</p><p>Anyway, the <code>data</code> field takes up 8 bytes
(well, assuming pointers aren’t any bigger than that lol),
which can either be a function pointer,
a floating point number, an integer, or a “slice”
pointing to some data that exists on hither’s “heap”, more about which later.</p><p>Ah, this is a good place to mention something:
hither doesn’t have a “bytecode” layer.
Maybe it should?
Who knows, certainly not me.
All of this is to say—the builtins are functionally the only “actual code” that hither can run.
The hither interpreter looks up words in a hash table
and pushes the result of that lookup onto the stack.</p><p>The stack, by the way,
is a Zig off-the-shelf special,
a <code>std.MultiArrayList(Cell)</code>.
In Zig, <code>MultiArrayList</code> is a neat generic data structure
that performs a “struct of arrays” transform on data automatically.
That is, under the hood,
a <code>std.MultiArrayList(Cell)</code> has <em>three</em> lists,
one for <code>tag</code>, <code>slice_is</code> and <code>data</code>.
This saves a little memory and is just conceptually really cool.</p></div></div>
  </body>
</html>
