<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/losfair/mvsqlite">Original</a>
    <h1>Show HN: Distributed SQLite on FoundationDB</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">Distributed, MVCC SQLite that runs on top of <a href="https://github.com/apple/foundationdb">FoundationDB</a>.</p>
<p dir="auto"><strong>This is alpha software and has not received enough testing. On-disk format may change in future versions. Please do not use it in production.</strong></p>
<ul dir="auto">
<li><a href="#mvsqlite">mvsqlite</a>
<ul dir="auto">
<li><a href="#features">Features</a>
<ul dir="auto">
<li><a href="#upcoming-features">Upcoming features</a></li>
</ul>
</li>
<li><a href="#comparison-with-dqlite-and-rqlite">Comparison with dqlite and rqlite</a></li>
<li><a href="#demo">Demo</a></li>
<li><a href="#try-it">Try it</a></li>
<li><a href="#limits">Limits</a>
<ul dir="auto">
<li><a href="#read-latency">Read latency</a></li>
<li><a href="#not-yet-implemented-garbage-collection">Not yet implemented: garbage collection</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 dir="auto"><a id="user-content-features" aria-hidden="true" href="#features"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Features</h2>
<ul dir="auto">
<li><strong>Full feature-set from SQLite</strong>: mvsqlite integrates with SQLite using a custom <a href="https://www.sqlite.org/vfs.html" rel="nofollow">VFS</a> layer.</li>
<li><strong>Time travel</strong>: Checkout the snapshot of your database at any point of time in the past.</li>
<li><strong>Get the nice properties from FoundationDB, without its limits</strong>: <a href="https://apple.github.io/foundationdb/testing.html" rel="nofollow">Correctness</a>, <a href="https://apple.github.io/foundationdb/performance.html" rel="nofollow">really fast and scalable</a> distributed transactions, synchronous and asynchronous replication, integrated backup and restore. Meanwhile, there&#39;s no <a href="https://apple.github.io/foundationdb/known-limitations.html" rel="nofollow">five-second transaction limit</a> any more, and a SQLite transaction can be 50x larger than FDB&#39;s native one.</li>
<li><strong>Drop-in replacement</strong>: Set the <code>LD_PRELOAD=libmvsqlite_preload.so</code> environment variable and your existing apps will work out of the box.</li>
</ul>
<h3 dir="auto"><a id="user-content-upcoming-features" aria-hidden="true" href="#upcoming-features"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Upcoming features</h3>
<ul dir="auto">
<li><strong>Branching</strong>: Create a writable snapshot from a past version of your database.</li>
<li><strong>Zero-overhead cross-database transactions</strong>: While each SQLite database remains single-writer, you can horizontally scale your application with cross-database serializable transactions without additional overhead.</li>
</ul>
<h2 dir="auto"><a id="user-content-comparison-with-dqlite-and-rqlite" aria-hidden="true" href="#comparison-with-dqlite-and-rqlite"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Comparison with dqlite and rqlite</h2>
<p dir="auto"><a href="https://github.com/canonical/dqlite">dqlite</a> and <a href="https://github.com/rqlite/rqlite">rqlite</a> are two other distributed databases built on SQLite. Some of the key differences between mvsqlite and those two systems:</p>
<ul dir="auto">
<li><strong>(+)</strong>: mvsqlite is a drop-in replacement. To run existing applications with mvsqlite, setting <code>LD_PRELOAD</code> is enough.</li>
<li><strong>(+)</strong>: mvsqlite runs on a production-grade distributed key-value store, FoundationDB, instead of implementing its own consensus subsystem.</li>
<li><strong>(+)</strong>: mvsqlite has advanced multi-version features like snapshot reads without time limit, and reading the DB snapshot from a past point in time.</li>
<li><strong>(+)</strong>: mvsqlite supports multi-database transactions. So you can scale your writes horizontally, with the right data model.</li>
<li><strong>(-)</strong>: Reads in mvsqlite are sensitive to network latency. The client is stateless, and data needs to be fetched from FDB on demand.
<ul dir="auto">
<li>Maybe this will be improved in a future version with a better prefetch strategy.</li>
</ul>
</li>
<li><strong>(-)</strong>: mvsqlite is a little more complex to deploy than the alternative.
<ul dir="auto">
<li>Three moving parts: FoundationDB, <code>mvstore</code>, and <code>libmvsqlite_preload.so</code>, instead of a single library.</li>
</ul>
</li>
<li><strong>(-)</strong>: mvsqlite is new. Really new. And has not received as much testing as the alternatives.
<ul dir="auto">
<li>But you can rely on FDB&#39;s continuous backup to ensure your data integrity in case an unknown bug in mvsqlite corrupted your database.</li>
</ul>
</li>
</ul>
<h2 dir="auto"><a id="user-content-demo" aria-hidden="true" href="#demo"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Demo</h2>
<p dir="auto"><strong>Time travel: checkout past snapshots</strong></p>
<p dir="auto">Use the format <code>namespace@version</code> for the database name passed to SQLite:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/e28bbf2d9d9aca0862b30b4a01026c0998b7dd08c32f6784607f10836d375077/68747470733a2f2f696d672e706c616e65742e696e6b2f7a68792f323032322d30372d32372d3135346665663133653834642d32303765613439343536333762303534623938626537313133393661646339342e706e67"><img src="https://camo.githubusercontent.com/e28bbf2d9d9aca0862b30b4a01026c0998b7dd08c32f6784607f10836d375077/68747470733a2f2f696d672e706c616e65742e696e6b2f7a68792f323032322d30372d32372d3135346665663133653834642d32303765613439343536333762303534623938626537313133393661646339342e706e67" alt="time travel" data-canonical-src="https://img.planet.ink/zhy/2022-07-27-154fef13e84d-207ea4945637b054b98be711396adc94.png"/></a></p>
<p dir="auto"><strong>Optimistic MVCC transactions</strong></p>
<p dir="auto">SQLite is a single-writer database - this isn&#39;t going to change easily, due to its fundamental design choices.</p>
<p dir="auto">But a group of N sqlite databases is an N-writer database. And mvsqlite provides the necessary mechanisms to do serializable cross-database transactions without additional overhead.</p>
<p dir="auto">The logic for cross-database transactions isn&#39;t there yet, so here&#39;s a demo that shows how MVCC works (and how it can break things) in mvsqlite when there are more than one concurrent writers to the same database.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/d3b460b3542d2d8739bb7ea85242f26a38def0a1e46d6f32d7d1aadecf22e6e5/68747470733a2f2f696d672e706c616e65742e696e6b2f7a68792f323032322d30372d32372d3135346637343264313664302d35626231386535633833646638346132396638393866303230363766626462322e706e67"><img src="https://camo.githubusercontent.com/d3b460b3542d2d8739bb7ea85242f26a38def0a1e46d6f32d7d1aadecf22e6e5/68747470733a2f2f696d672e706c616e65742e696e6b2f7a68792f323032322d30372d32372d3135346637343264313664302d35626231386535633833646638346132396638393866303230363766626462322e706e67" alt="mvcc" data-canonical-src="https://img.planet.ink/zhy/2022-07-27-154f742d16d0-5bb18e5c83df84a29f898f02067fbdb2.png"/></a></p>
<h2 dir="auto"><a id="user-content-try-it" aria-hidden="true" href="#try-it"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Try it</h2>
<p dir="auto">Install FoundationDB:</p>
<div data-snippet-clipboard-copy-content="wget https://github.com/apple/foundationdb/releases/download/7.1.15/foundationdb-clients_7.1.15-1_amd64.deb
sudo dpkg -i foundationdb-clients_7.1.15-1_amd64.deb
wget https://github.com/apple/foundationdb/releases/download/7.1.15/foundationdb-server_7.1.15-1_amd64.deb
sudo dpkg -i foundationdb-server_7.1.15-1_amd64.deb"><pre>wget https://github.com/apple/foundationdb/releases/download/7.1.15/foundationdb-clients_7.1.15-1_amd64.deb
sudo dpkg -i foundationdb-clients_7.1.15-1_amd64.deb
wget https://github.com/apple/foundationdb/releases/download/7.1.15/foundationdb-server_7.1.15-1_amd64.deb
sudo dpkg -i foundationdb-server_7.1.15-1_amd64.deb</pre></div>
<p dir="auto">Build and run <code>mvstore</code>, the server-side half that should be colocated with the FoundationDB cluster in production:</p>
<div data-snippet-clipboard-copy-content="cargo build --release -p mvstore
RUST_LOG=info ./target/release/mvstore \
  --data-plane 127.0.0.1:7000 \
  --admin-api 127.0.0.1:7001 \
  --metadata-prefix mvstore-test \
  --raw-data-prefix m"><pre>cargo build --release -p mvstore
RUST_LOG=info ./target/release/mvstore \
  --data-plane 127.0.0.1:7000 \
  --admin-api 127.0.0.1:7001 \
  --metadata-prefix mvstore-test \
  --raw-data-prefix m</pre></div>
<p dir="auto">Create a namespace with the admin API:</p>
<div data-snippet-clipboard-copy-content="curl http://localhost:7001/api/create_namespace -i -d &#39;{&#34;key&#34;:&#34;test&#34;,&#34;metadata&#34;:&#34;&#34;}&#39;"><pre>curl http://localhost:7001/api/create_namespace -i -d <span><span>&#39;</span>{&#34;key&#34;:&#34;test&#34;,&#34;metadata&#34;:&#34;&#34;}<span>&#39;</span></span></pre></div>
<p dir="auto">Build the client library:</p>
<div data-snippet-clipboard-copy-content="cargo build --release -p mvsqlite
make -C ./mvsqlite-preload"><pre>cargo build --release -p mvsqlite
make -C ./mvsqlite-preload</pre></div>
<p dir="auto">Build <code>libsqlite3</code> and the <code>sqlite3</code> CLI: (note that a custom build is only needed here because the <code>sqlite3</code> binary shipped on most systems are statically linked to <code>libsqlite3</code> and <code>LD_PRELOAD</code> don&#39;t work)</p>
<div data-snippet-clipboard-copy-content="wget https://www.sqlite.org/2022/sqlite-amalgamation-3390200.zip
unzip sqlite-amalgamation-3390200.zip
cd sqlite-amalgamation-3390200
gcc -O2 -fPIC --shared -o libsqlite3.so ./sqlite3.c -lpthread -ldl -lm
gcc -O2 -o sqlite3 ./shell.c -L. -lsqlite3"><pre>wget https://www.sqlite.org/2022/sqlite-amalgamation-3390200.zip
unzip sqlite-amalgamation-3390200.zip
<span>cd</span> sqlite-amalgamation-3390200
gcc -O2 -fPIC --shared -o libsqlite3.so ./sqlite3.c -lpthread -ldl -lm
gcc -O2 -o sqlite3 ./shell.c -L. -lsqlite3</pre></div>
<p dir="auto">Set environment variables, and run the shell:</p>
<div data-snippet-clipboard-copy-content="export RUST_LOG=info MVSQLITE_DATA_PLANE=&#34;http://localhost:7000&#34;

# &#34;test&#34; is the key of the namespace we created earlier
LD_PRELOAD=../mvsqlite-preload/libmvsqlite_preload.so LD_LIBRARY_PATH=. ./sqlite3 test"><pre><span>export</span> RUST_LOG=info MVSQLITE_DATA_PLANE=<span><span>&#34;</span>http://localhost:7000<span>&#34;</span></span>

<span><span>#</span> &#34;test&#34; is the key of the namespace we created earlier</span>
LD_PRELOAD=../mvsqlite-preload/libmvsqlite_preload.so LD_LIBRARY_PATH=. ./sqlite3 <span>test</span></pre></div>
<p dir="auto">You should see the sqlite shell now :) Try creating a table and play with it.</p>
<h2 dir="auto"><a id="user-content-limits" aria-hidden="true" href="#limits"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Limits</h2>
<h3 dir="auto"><a id="user-content-read-latency" aria-hidden="true" href="#read-latency"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Read latency</h3>
<p dir="auto">SQLite does synchronous &#34;disk&#34; I/O. While we can (and do) concurrently execute write operations, reads from FoundationDB block the SQLite thread.</p>
<p dir="auto">This is probably fine if you don&#39;t expect to get very I/O intensive on a single database, but you may want to enable <code>coroutine</code> in the <code>IoEngine</code> config if you have an event loop outside, so that network I/O won&#39;t block the thread.</p>
<h3 dir="auto"><a id="user-content-not-yet-implemented-garbage-collection" aria-hidden="true" href="#not-yet-implemented-garbage-collection"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Not yet implemented: garbage collection</h3>
<p dir="auto">Currently history versions will be kept in the database forever. There is no garbage collection yet. In a future version this will be fixed.</p>
</article>
          </div></div>
  </body>
</html>
