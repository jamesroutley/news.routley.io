<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/chrisbra/csv.vim">Original</a>
    <h1>Csv.vim: A Filetype plugin for CSV files</h1>
    
    <div id="readability-page-1" class="page"><div>
            <p><em>This is part five of my series on SNES development. You may want to start with the <a href="https://blog.wesleyac.com/posts/snes-dev-1-getting-started">first post</a>.</em></p>

<p>In <a href="https://blog.wesleyac.com/posts/snes-dev-3-background-graphics">part three</a>, I mentioned that in the future, we&#39;d switch from using a loop to copy data into VRAM to using DMA. Well, the future is now!</p>

<p>Using DMA is much faster than using a loop, which makes it easier to load large amounts of data from ROM to memory, whether that&#39;s graphics, sprite data, palettes, levels, or anything else your heart desires. It&#39;ll be useful in the next part, where we&#39;ll want to quickly send the sprite data to the SNES.</p>

<p>As usual, I recommend watching the Retro Game Mechanics Explained video on <a href="https://www.youtube.com/watch?v=K7gWmdgXPgk">DMA &amp; HDMA</a> first. You can stop watching once you get to the HDMA part if you&#39;d like — only the DMA section is needed to understand this part.</p>

<p>The code for this part might seem a little scary, but once you have a solid understanding of what DMA is and how it works, it&#39;s not too bad. You can find the <a href="https://github.com/WesleyAC/snes-dev/tree/main/part5">code</a> and <a href="https://github.com/WesleyAC/snes-dev/compare/part5-base..part5">diff</a> on GitHub as usual. This time, we&#39;ll walk through each step of the diff, since it&#39;s small but dense.</p>

<p>This sets the DMA flags. The first bit is a zero, to indicate that we&#39;re transferring from the CPU memory to the PPU memory. The next two bits are unused. The next two bits are zero to indicate that we want the address we&#39;re writing to to auto-increment (we could instead choose to auto decrement, or use a fixed address). The final three bits, <code>001</code>, indicate that we want to transfer two bytes at a time.</p>

<p>This tells the SNES that we want this DMA to write to the <code>VMDATAL</code> register, and since we set the mode to <code>001</code>, it&#39;ll also write to <code>VMDATAL + 1</code>, which is <code>VMDATAH</code>.</p>
<div><pre><code data-lang="">ldx #.loword(charset)
stx A1T0L
lda #^charset
sta A1B0
</code></pre></div>
<p>These lines set the starting address to <code>charset</code>, which is our label for the location of the charset data. The <code>.loword</code> and <code>^</code> are our way of telling the assembler to just pull the bits that we want — you can read more about them in the <a href="https://cc65.github.io/doc/ca65.html">ca65 manual</a> if you&#39;d like. Note that we write to <code>A1T0L</code> with the X register since it&#39;s in 16 bit mode — this lets us write to the <code>A1T0L</code> and <code>A1T0H</code> registers at the same time.</p>
<div><pre><code data-lang="">ldx #(charset_end - charset)
stx DAS0L
</code></pre></div>
<p>Here, we set the amount of data we want to transfer.</p>

<p>And finally, we kick off the DMA!</p>

<p>This has been some more anticlimactic infrastructure work — as with the previous time we did this, everything will look exactly the same when you run it, but if you look in the Mesen-S event viewer, you should be able to see the change :)</p>

<p>This time, though, there&#39;s some stuff you can do on your own:</p>

<ul>
<li>Write a macro to set up and run a DMA transfer</li>
<li>Use your shiny new DMA transfer to write some tiles to <code>VRAM_BG1</code></li>
<li>Replace your manual palette setting code with DMA</li>
</ul>

<p>Once you&#39;ve done all that, it&#39;s time to move on to making some sprites in <a href="https://blog.wesleyac.com/posts/snes-dev-6-sprites">part six</a>!</p>

<!--
next posts:

* sprites
* scrolling
-->

          </div></div>
  </body>
</html>
