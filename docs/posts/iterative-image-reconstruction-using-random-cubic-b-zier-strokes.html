<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tangled.org/luthenwald.tngl.sh/splined">Original</a>
    <h1>Iterative image reconstruction using random cubic bézier strokes</h1>
    
    <div id="readability-page-1" class="page"><section>
        <article>
<p>iterative image reconstruction using random cubic bézier strokes, accelerated on <a href="https://en.wikipedia.org/wiki/Metal_(API)" rel="nofollow">metal</a></p>
<h2 id="showcase">showcase<a href="#showcase" rel="nofollow">#</a></h2>
<details data-callout="NOTE" open="">
<summary>
NOTE
</summary>
<p>images used here are all under open access by <a href="https://www.metmuseum.org/hubs/open-access" rel="nofollow">The Met</a></p>
</details>

<p>same input &amp; different seeds → different reconstructions → simple animation:</p>
<p>
   <img src="https://camo.tangled.sh/a3c9a2f40604411eeabc4925165948145acbbbe23fd95ab578edb05acc2fa333/68747470733a2f2f6b6e6f74312e74616e676c65642e73682f787270632f73682e74616e676c65642e7265706f2e626c6f623f7265706f3d646964253341706c632533413771676274776b7073786265616e67347a3365637674757125324673706c696e6564267265663d7072696d6126706174683d6173736574732f30322e676966267261773d74727565" width="720"/>
</p>
<h2 id="build">build<a href="#build" rel="nofollow">#</a></h2>
<pre><code><span><span>cargo build -r
</span></span></code></pre><h2 id="usage">usage<a href="#usage" rel="nofollow">#</a></h2>
<pre><code><span><span>splined: iterative image reconstruction with random cubic bézier strokes <span>(</span>metal-accelerated<span>)</span>
</span></span><span><span>
</span></span><span><span>usage: splined &lt;input&gt; <span>[</span>args<span>]</span>
</span></span><span><span>
</span></span><span><span>args:
</span></span><span><span>   -n, --number                 &lt;u32&gt;         max splines to draw <span>(</span>default: <span>(</span>w*h<span>)</span>^0.7<span>)</span>
</span></span><span><span>   -b, --batch                  &lt;u32&gt;         batch size per gpu step <span>(</span>default: 32<span>)</span>
</span></span><span><span>   -s, --seed                   &lt;u64&gt;         rng seed <span>(</span>default: 0<span>)</span>
</span></span><span><span>       --max-gpu                &lt;f32&gt;         max gpu usage in <span>(</span>0, 1<span>]</span> <span>(</span>default: 1.0<span>)</span>
</span></span><span><span>   -l, --log                    &lt;0..3&gt;        logging level <span>(</span>default: 1<span>)</span>
</span></span><span><span>   -o, --output                 &lt;path&gt;        output file or dir <span>(</span>default: output.png<span>)</span>
</span></span><span><span>   -c, --current                &lt;path&gt;        current canvas image to resume from <span>(</span>single-file only<span>)</span>
</span></span><span><span>       --nth                    &lt;u32&gt;         save every nth accepted stroke <span>(</span>uses -o as dir<span>)</span>
</span></span><span><span>       --bg                     &lt;avg<span>|</span>r,g,b&gt;   initial canvas color <span>(</span>default: avg<span>)</span>
</span></span><span><span>   -a, --alpha                  &lt;f32&gt;         stroke alpha in <span>[</span>0, 1<span>]</span> <span>(</span>default: 1<span>)</span>
</span></span><span><span>       --min-accept-ratio       &lt;f32&gt;         stagnant <span>if</span> accepted &lt; batch*ratio <span>(</span>default: 0.02<span>)</span>
</span></span><span><span>       --max-stagnant-batches   &lt;u32&gt;         stop after this many stagnant batches <span>(</span>default: 10<span>)</span>
</span></span><span><span>
</span></span><span><span>input:
</span></span><span><span>   - file: writes one image to -o/--output <span>(</span>default: output.png<span>)</span>
</span></span><span><span>   - dir:  -o/--output must be a dir<span>;</span> mirrors input tree under it
</span></span><span><span>   - --nth: saves frames to output dir every nth accepted stroke<span>;</span> also writes final.png
</span></span><span><span>
</span></span><span><span>examples:
</span></span><span><span>   splined in.png -o out.png
</span></span><span><span>   splined in.png -n <span>5000</span> -b <span>64</span> -s <span>42</span> -o out.png
</span></span><span><span>   splined in.png --nth <span>50</span> -o frames/
</span></span><span><span>   splined images/ -o results/ -n <span>5000</span> -b <span>64</span> -s <span>42</span> --nth <span>50</span>
</span></span></code></pre><h2 id="algorithm">algorithm<a href="#algorithm" rel="nofollow">#</a></h2>
<ul>
<li>convert input to <a href="https://en.wikipedia.org/wiki/Oklab_color_space" rel="nofollow">oklab</a> color space</li>
<li>initialize canvas to image average (or <code>--bg</code>)</li>
<li>repeat until target stroke count or convergence:
<ul>
<li>sample batch of random cubic béziers (4 control points, uniform over image)</li>
<li>rasterize each curve to coverage mask</li>
<li>set stroke color to coverage-weighted mean of target pixels</li>
<li>accept curves that strictly reduce squared oklab error (Δε² &lt; 0)</li>
<li>commit accepted strokes to canvas</li>
</ul>
</li>
<li>export final canvas</li>
</ul>
<h2 id="reference">reference<a href="#reference" rel="nofollow">#</a></h2>
<ul>
<li><a href="https://github.com/Tw1ddle/geometrize" rel="nofollow">Geometrize</a>: a desktop app that geometrizes images into geometric primitives</li>
</ul>
<h2 id="todo">todo<a href="#todo" rel="nofollow">#</a></h2>
<ul>
<li>(better) antialiasing algorithm for drawing cubic bézier strokes</li>
<li>support other gpu backends (e.g., wasm)</li>
</ul>
</article>
    </section></div>
  </body>
</html>
