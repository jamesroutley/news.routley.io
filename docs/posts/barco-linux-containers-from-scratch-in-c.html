<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/lucavallin/barco">Original</a>
    <h1>Barco: Linux Containers from Scratch in C</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto"><code>barco</code> is a project I worked on to learn more about Linux containers and the Linux kernel, based on other guides on the internet.
<code>barco</code> enforces a minimal set of restrictions to run untrusted code, which is not recommended for production use, where a more robust solution should be used. Some permissions however are absolutely not safe, and those are enforced by <code>barco</code>.</p>
<p dir="auto">Linux containers are made up by a set of Linux kernel features:</p>
<ul dir="auto">
<li><code>namespaces</code>: are used to group kernel objects into different sets that can be accessed by specific process trees. There are different types of <code>namespaces</code>, for example,the <code>PID</code> namespace is used to isolate the process tree, while the <code>network</code> namespace is used to isolate the network stack.</li>
<li><code>seccomp</code>: is used to limit the system calls that a process can make (handled via syscalls)</li>
<li><code>capabilities</code>: are used to set limits on what uid 0 (root) can do (handled via syscalls)</li>
<li><code>cgroups</code>: are used to limit the resources (e.g. memory, disk I/O, CPU-tme) that a process can use (handled via cgroupfs)</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-usage" aria-hidden="true" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Usage</h2>
<p dir="auto"><code>barco</code> can be used to run <code>bin/sh . </code> from the <code>/</code> directory as <code>root</code> with verbose output with the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ sudo ./bin/barco -u 0 -m / -c /usr/bin/sh -a . [-v]

22:08:41 INFO  ./src/barco.c:96: initializing socket pair...
22:08:41 INFO  ./src/barco.c:103: setting socket flags...
22:08:41 INFO  ./src/barco.c:112: initializing container stack...
22:08:41 INFO  ./src/barco.c:120: initializing container...
22:08:41 INFO  ./src/barco.c:131: initializing cgroups...
22:08:41 INFO  ./src/cgroups.c:73: setting memory.max to 1G...
22:08:41 INFO  ./src/cgroups.c:73: setting cpu.weight to 256...
22:08:41 INFO  ./src/cgroups.c:73: setting pids.max to 64...
22:08:41 INFO  ./src/cgroups.c:73: setting cgroup.procs to 1458...
22:08:41 INFO  ./src/barco.c:139: configuring user namespace...
22:08:41 INFO  ./src/barco.c:147: waiting for container to exit...
22:08:41 INFO  ./src/container.c:43: ### BARCONTAINER STARTING - type &#39;exit&#39; to quit ###

# ls
bin         home                lib32       media       root        sys         vmlinuz
boot        initrd.img          lib64       mnt         run         tmp         vmlinuz.old
dev         initrd.img.old      libx32      opt         sbin        usr
etc         lib                 lost+found  proc        srv         var
# echo &#34;i am a container&#34;
i am a container
# exit

22:08:55 INFO  ./src/barco.c:153: freeing resources...
22:08:55 INFO  ./src/barco.c:168: so long and thanks for all the fish"><pre>$ sudo ./bin/barco -u 0 -m / -c /usr/bin/sh -a <span>.</span> [-v]

22:08:41 INFO  ./src/barco.c:96: initializing socket pair...
22:08:41 INFO  ./src/barco.c:103: setting socket flags...
22:08:41 INFO  ./src/barco.c:112: initializing container stack...
22:08:41 INFO  ./src/barco.c:120: initializing container...
22:08:41 INFO  ./src/barco.c:131: initializing cgroups...
22:08:41 INFO  ./src/cgroups.c:73: setting memory.max to 1G...
22:08:41 INFO  ./src/cgroups.c:73: setting cpu.weight to 256...
22:08:41 INFO  ./src/cgroups.c:73: setting pids.max to 64...
22:08:41 INFO  ./src/cgroups.c:73: setting cgroup.procs to 1458...
22:08:41 INFO  ./src/barco.c:139: configuring user namespace...
22:08:41 INFO  ./src/barco.c:147: waiting <span>for</span> container to exit...
22:08:41 INFO  ./src/container.c:43: <span><span>#</span>## BARCONTAINER STARTING - type &#39;exit&#39; to quit ###</span>

<span><span>#</span> ls</span>
bin         home                lib32       media       root        sys         vmlinuz
boot        initrd.img          lib64       mnt         run         tmp         vmlinuz.old
dev         initrd.img.old      libx32      opt         sbin        usr
etc         lib                 lost+found  proc        srv         var
<span><span>#</span> echo &#34;i am a container&#34;</span>
i am a container
<span><span>#</span> exit</span>

22:08:55 INFO  ./src/barco.c:153: freeing resources...
22:08:55 INFO  ./src/barco.c:168: so long and thanks <span>for</span> all the fish</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-setup" aria-hidden="true" href="#setup"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Setup</h2>
<p dir="auto"><code>barco</code> requires a number of tools and libraries to be installed to build the project and for development.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Install all required tooling and dependencies
$ sudo apt install -y make
$ make setup"><pre><span><span>#</span> Install all required tooling and dependencies</span>
$ sudo apt install -y make
$ make setup</pre></div>
<h3 tabindex="-1" dir="auto"><a id="user-content-dependencies" aria-hidden="true" href="#dependencies"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Dependencies</h3>
<p dir="auto"><code>barco</code> depends on the following &#34;non-standard&#34; libraries:</p>
<ul dir="auto">
<li><code>libseccomp</code>: used to set up seccomp filters</li>
<li><code>libcap</code>: used to set container capabilities</li>
<li><code>libbsd</code>: used for <code>strlcpy</code></li>
<li><code>libcuni1</code>: used for testing with CUnit</li>
<li><a href="http://argtable.org/" rel="nofollow">argtable</a>: used to parse command line arguments</li>
<li><a href="https://github.com/rxi/log.c">rxi/log.c</a>: used for logging</li>
</ul>
<p dir="auto"><code>barco</code> uses a number of LLVM-18-based tools for development, linting, formatting, debugging and checking for memory leaks.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-build" aria-hidden="true" href="#build"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Build</h2>
<p dir="auto">The included <code>Makefile</code> provides a few targets to build <code>barco</code>.
The variable <code>debug=1</code> can be set to run any of the targets in &#34;debug&#34; mode, which builds the project with the with debug symbols and without optimizations. The debug build is especially useful for the debugger and valgrind.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Build barco (executable is in bin/)
# The default target also runs, &#34;make lint&#34; and &#34;make format&#34; to lint and format the code
$ make


# Build barco with debug flags
$ make debug=1"><pre><span><span>#</span> Build barco (executable is in bin/)</span>
<span><span>#</span> The default target also runs, &#34;make lint&#34; and &#34;make format&#34; to lint and format the code</span>
$ make


<span><span>#</span> Build barco with debug flags</span>
$ make debug=1</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-development" aria-hidden="true" href="#development"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Development</h2>
<p dir="auto"><code>barco</code> is developed using <a href="https://code.visualstudio.com/" rel="nofollow">Visual Studio Code</a> and <a href="https://github.com/codespaces">GitHub Codespaces</a>. The repository contains all the necessary configuration files to use these tools effectively.
<code>barco</code> relies on low-level Linux features, so it must be run on a Linux system. <a href="https://github.com/codespaces">GitHub Codespaces</a> acts weird at times when tweaking low-level container settings: I found <a href="https://getutm.app" rel="nofollow">getutm.app</a> to work well with <a href="http://debian.org" rel="nofollow">Debian</a> on my Mac when in doubt.</p>
<p dir="auto">The included <code>Makefile</code> provides a few targets useful for development:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Run tests
$ make test

# Run linter
$ make lint

# Run formatter
$ make format

# Run valgrind
$ make check

# Clean the build
$ make clean"><pre><span><span>#</span> Run tests</span>
$ make <span>test</span>

<span><span>#</span> Run linter</span>
$ make lint

<span><span>#</span> Run formatter</span>
$ make format

<span><span>#</span> Run valgrind</span>
$ make check

<span><span>#</span> Clean the build</span>
$ make clean</pre></div>
<p dir="auto">Furthermore, the project includes a <a href="https://code.visualstudio.com/" rel="nofollow">Visual Studio Code</a> configuration in <code>.vscode/</code> that can be used to run the built-in debugger (at this moment it is &#34;disabled&#34; since <code>barco</code> should be run as <code>root</code> and <a href="https://code.visualstudio.com/" rel="nofollow">Visual Studio Code</a> does not have that option).</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-structure" aria-hidden="true" href="#structure"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Structure</h2>
<p dir="auto">The project is structured as follows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="├── .devcontainer       configuration for GitHub Codespaces
├── .github             configuration GitHub Actions and other GitHub features
├── .vscode             configuration for Visual Studio Code
├── bin                 the executable (created by make)
├── build               intermediate build files e.g. *.o (created by make)
├── docs                documentation
├── include             header files
├── lib                 third-party libraries
├── scripts             scripts for setup and other tasks
├── src                 C source files
│   ├── barco.c         (main)
│   └── *.c
├── tests               contains tests
├── .clang-format       configuration for clang-format
├── .cang-tidy          configuration for clang-tidy
├── .gitignore
├── .clang.cfg          configuration for the compiler
├── LICENSE
├── Makefile
└── README.md"><pre>├── .devcontainer       configuration for GitHub Codespaces
├── .github             configuration GitHub Actions and other GitHub features
├── .vscode             configuration for Visual Studio Code
├── bin                 the executable (created by make)
├── build               intermediate build files e.g. <span>*</span>.o (created by make)
├── docs                documentation
├── include             header files
├── lib                 third-party libraries
├── scripts             scripts for setup and other tasks
├── src                 C source files
│   ├── barco.c         (main)
│   └── <span>*</span>.c
├── tests               contains tests
├── .clang-format       configuration for clang-format
├── .cang-tidy          configuration for clang-tidy
├── .gitignore
├── .clang.cfg          configuration for the compiler
├── LICENSE
├── Makefile
└── README.md</pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-testing-and-documentation" aria-hidden="true" href="#testing-and-documentation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Testing and documentation</h2>
<p dir="auto">At the moment, the project does not contain any automated tests or tools to document the code.
In the future, suitable tools for automated testing and documentation might be added.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-limitations" aria-hidden="true" href="#limitations"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Limitations</h2>
<p dir="auto"><code>barco</code> assumes that the host system is running a Linux kernel at version 6.0.x or higher and with user namespaces and cgroupsv2 enabled. The project has been tested on Debian 13.</p>
<p dir="auto"><code>barco</code> does not handle network namespaces, so the container cannot access the network. Networking can roughly be setup as follows:</p>
<ul dir="auto">
<li>create a new network namespace</li>
<li>create a virtual ethernet pair</li>
<li>move one end of the pair to the new network namespace</li>
<li>assign an IP address to the interface in the new network namespace</li>
<li>setup routing and NAT</li>
</ul>
<p dir="auto">In C this is usually done via the <code>rtnetlink</code> interface. Furthermore, network usage can be limited with the <code>net_prio</code> cgroup controller.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-improvements" aria-hidden="true" href="#improvements"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Improvements</h2>
<ul dir="auto">
<li>Investigate further, document and refactor: user and mount and cgroup namespaces, syscalls and capabilities</li>
<li>The functions in <code>cgroups.c</code>, <code>mount.c</code>, <code>sec.c</code>, <code>userns.c</code> are specific to <code>barco</code> and should be made more generic</li>
<li>CMake and Conan are industry standards, so they should be used eventually instead of Make and the current build system. Unfortunately, CMake and Conan also add a lot of complexity which is not needed at this time.</li>
</ul>
</article>
          </div></div>
  </body>
</html>
