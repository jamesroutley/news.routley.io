<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/OpenSSHPerSourcePenaltiesThings">Original</a>
    <h1>Some thoughts on OpenSSH 9.8&#39;s PerSourcePenalties feature</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Some thoughts on OpenSSH 9.8&#39;s PerSourcePenalties feature</h2>

	<p><small>August 13, 2024</small></p>
</div><div><p>One of the features added in <a href="https://www.openssh.com/txt/release-9.8">OpenSSH 9.8</a> is a new SSH server
security feature to slow down certain sorts of attacks. To quote
the release notes:</p>

<blockquote><p>[T]he server will now block client addresses that repeatedly
fail authentication, repeatedly connect without ever completing
authentication or that crash the server. [...]</p>
</blockquote>

<p>This is the <a href="https://man.openbsd.org/sshd_config.5#PerSourcePenalties"><code>PerSourcePenalties</code></a> configuration
setting and its defaults, and also see <a href="https://man.openbsd.org/sshd_config.5#PerSourcePenaltyExemptList"><code>PerSourcePenaltyExemptList</code></a>
and <a href="https://man.openbsd.org/sshd_config.5#PerSourceNetBlockSize"><code>PerSourceNetBlockSize</code></a>.
OpenSSH 9.8 isn&#39;t yet in anything <a href="https://support.cs.toronto.edu/">we</a>
can use at work, but it will be in the next OpenBSD release (and then I&#39;ll
get it on Fedora).</p>

<p>On the one hand, this new option is exciting to me because for the
first time it lets us block only rapidly repeating SSH sources that
fail to authenticate, as opposed to rapidly repeating SSH sources
that are successfully logging in to do a whole succession of tiny
little commands. Right now our perimeter firewall is blind to whether
a brief SSH connection was successful or not, so all it can do is
block on total volume, and this means we need to be conservative
in its settings. This is a single machine block (instead of the
global block our perimeter firewall can do), but a lot of SSH
attackers do seem to target single machines with their attacks (for
a single external source IP, at least).</p>

<p>(It&#39;s also going to be a standard OpenSSH feature that won&#39;t require
any configuration, firewall or otherwise, and will slow down rapid
attackers.)</p>

<p>On the other hand, this is potentially an issue for anything that
makes health checks like &#39;is this machine responding with a SSH
banner&#39; (used in <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/PrometheusGrafanaSetup-2019">our Prometheus setup</a>)
or &#39;does this machine have the SSH host key we expect&#39; (used in
<a href="https://utcc.utoronto.ca/~cks/space/blog/linux/CustomMountAuthorizationII">our NFS mount authentication system</a>). Both of these cases will
stop before authentication and so fall into the &#39;noauth&#39; category
of PerSourcePenalties. The good news is that the default refusal
duration for this penalty is only one second, which is usually not
very long and you&#39;re probably not going to run into in health checks.
The exception is if you&#39;re trying to verify multiple types of SSH
host keys for a server, because <a href="https://utcc.utoronto.ca/~cks/space/blog/tech/SSHHostKeyVerificationNotes">you can only verify one host key
in a given connection</a>, so if
you need to verify both a RSA host key and an Ed25519 host key, you
need two connections.</p>

<p>(Even then, the OpenSSH 9.8 default is that only you only get blocked
once you&#39;ve built up 15 seconds of penalties. At the default settings,
this would be hard with even repeated host key checks, unless the
server has multiple IPs and you&#39;re checking all of them.)</p>

<p>It&#39;s going to be interesting to read practical experience reports
with this feature as OpenSSH 9.8 rolls out to more and more people.
And on that note I&#39;m certainly going to wait for people&#39;s reports
before doing things like increasing the &#39;authfail&#39; penalty duration,
as tempting as it is right now (especially since it&#39;s not clear
from the current documentation how unenforced penalty times
accumulate).</p>
</div></div>
  </body>
</html>
