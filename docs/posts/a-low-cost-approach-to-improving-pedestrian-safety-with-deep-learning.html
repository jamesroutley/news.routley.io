<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/">Original</a>
    <h1>A Low Cost Approach to Improving Pedestrian Safety with Deep Learning</h1>
    
    <div id="readability-page-1" class="page"><p><strong>TL;DR</strong> - Using TensorFlow and a Raspberry Pi, I developed a cheap and accurate way of counting both pedestrians and vehicle traffic.</p><div><p><b>POST UPDATE</b>: Since posting this, I&#39;ve received a considerable amount of interest from individuals and local city governments from across the U.S. looking to get a better grasp on pedestrian data. Because of this, I spent some time building out a better algorithm and packaging it for easy use. I&#39;m terrible with names, so for now it&#39;s simply &#34;urban mobility tracker&#34;. If you can think of a better name, please let me know! Additionally, to generate detections for the urban-mobility-tracker, I performed a full model retraining of MobileNetV1 SSD using data I collected and annotated. I&#39;m calling this new pedestrian/vehicle/bicyclist optimized object detector &#34;PedNet&#34;. As time goes on and more people use these two tools, I&#39;m hoping that people will contribute more training data (especially in adverse lighting and weather conditions) so that PedNet can be retrained and improved. Lastly, this new version continues to use TensorFlow but with the addition of the <a target="_blank" href="https://coral.ai/products/accelerator/">Coral USB accelerator</a> which leverages Google&#39;s TPU technology so now it achieves an update frequency of ~10Hz!!! (old version was ~2Hz)</p><h2>Introduction</h2><p>As someone who <a target="_blank" href="https://nathanrooy.github.io/posts/2018-01-11/one-year-of-bike-commuting/">bikes to work everyday</a>, I’m acutely aware of how important good urban design and planning is and its impact on pedestrian safety as well as the overall well-being of a neighborhood. I’m also aware of how difficult it is to convince car dependent, suburban commuters that we need to invest our money into bike lanes and <a target="_blank" href="https://en.wikipedia.org/wiki/Curb_extension">curb extensions</a> rather than lane extensions and parking lots. Because of this, I’m always a bit bummed when I see unfounded internet shouting matches over why the city should/should not implement bike and pedestrian safety measures. We should let the data decide what happens, not ideology or personal bias. Unfortunately, it’s this data that’s hard to come by.</p><p>I remember when shortly after the <a target="_blank" href="https://www.cincinnati-oh.gov/bikes/news/central-parkway-bikeway/">bike lanes on Central Pkwy</a> were installed, they were looking for volunteers to stand out in the baking sun all day and manually count cyclists as they rode by. This struck me as comically old-fashioned but also a bit sad because this was apparently the only way to get the data at the time. Fast forward almost five years and the situation appears to not have improved much. Below is a picture I took recently of some pneumatic tubes used to count traffic.</p><p><img alt="pneumatic tube traffic counter" title="pneumatic tube traffic counter" src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/pneumatic-tubes.jpg"/></p><center>Figure 1: Pneumatic tube based traffic counting</center><p>These are great for temporarily counting cars and other large vehicles. Counting bikes, and pedestrians, not so much… When I rode over them that morning on my bike, I was indistinguishable from a motorcycle. I’m an invisible cyclist, so why should the city prioritize this road for a bike lane? Additionally, this setup was in place for less than a day because those tubes are held in place using nails pounded into the road surface and reinforced with a couple strips of Kentucky chrome. Definitely not ideal.</p><center><table><thead><tr><th><strong>System</strong></th><th><strong>Type</strong></th><th><strong>Cost</strong></th></tr></thead><tbody><tr><td>SenSource</td><td>pneumatic</td><td>$695</td></tr><tr><td>RoadPod</td><td>pneumatic</td><td>$1,150</td></tr><tr><td>JAMAR TRAX I Plus</td><td>pneumatic</td><td>$2,600</td></tr><tr><td>Wavetronix SmartSensor HD</td><td>radar</td><td>$6,700</td></tr><tr><td>Miovision Technologies VCU</td><td>video</td><td>$3,700</td></tr></tbody></table></center><center>Table 1: Selection of traffic counting systems</center><p>Although other counting systems exist, they tend to be overly expensive, invasive, and unable to simultaneously count both pedestrians and vehicle traffic.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> Cincinnati is full of bikers, I see them every day. But if they’re not being counted, we’ll never be able to overcome the suburban bias in Cincinnati’s urban design and planning. With a better counting system in place we can get the necessary data to make informed decisions that reflect reality, resulting in a fairer and more equitable city. If only there was a low-cost, non-invasive solution that could passively count all types of traffic simultaneously in any weather condition 24/7/365 and seamlessly push that information to the cloud on a minute by minute basis…</p><h2>My Solution</h2><p>After thinking about this for a while, I decided that I could probably do a better job than what currently exists. Given that low-cost and high accuracy are my two primary goals, I went with a <a target="_blank" href="https://en.wikipedia.org/wiki/Raspberry_Pi">Raspberry Pi Zero</a> which is the smallest/cheapest of the Raspberry Pi models with the 8-megapixel v2 NoIR (infrared) camera and a rechargeable usb battery pack. Since my system is vision based it needs a clear line of sight to the street but also somehow remain hidden from people who might tamper with it. Given these two contradictory constraints of being hidden yet visible, I went with a stealth approach. This was accomplished by buying a plastic weatherproof electrical box and cutting a hole on the front for the camera. The camera hole was sealed with a clear lens filter. Lastly, I mounted six stupidly strong <a target="_blank" href="https://en.wikipedia.org/wiki/Neodymium_magnet">neodymium magnets</a> on the back so I could attach it to street lights, sign posts, etc.</p><p><img alt="deep learning raspberry pi traffic tracker" title="deep learning raspberry pi traffic tracker" src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/traffic-tracker-close-up.jpg"/></p><center>Figure 2: My deep learning, raspberry pi based traffic tracker</center><p>To actually count pedestrians and vehicle traffic I built out a <a target="_blank" href="https://en.wikipedia.org/wiki/Convolutional_neural_network">convolutional neural network</a> (CNN) with a secondary region proposal network (R-CNN) using <a target="_blank" href="https://www.tensorflow.org/">TensorFlow</a> and <a target="_blank" href="https://www.python.org/">Python</a>. This allows for both the detection and localization of objects within the frame. Actual object tracking was accomplished using a light weight temporal clustering scheme using <a target="_blank" href="http://www.numpy.org/">NumPy</a> and <a target="_blank" href="http://scikit-learn.org">scikit-learn</a>. For a more in-depth look, click [<a href="#technical-notes">here</a>] to read the technical notes section.</p><p><img alt="deep learning raspberry pi traffic tracker in the wild" title="deep learning raspberry pi traffic tracker in the wild" src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/in-the-field-03.jpg"/></p><center>Figure 3: Hidden in plain sight - my baby out in the wild!</center><p>After a week or so of casual coding I had a finished system. Given that the tracking algorithm is built on top of open-source software, the only costs associated with this system arise from the hardware side.</p><center><table><thead><tr><th><strong>Item</strong></th><th><strong>Cost</strong></th></tr></thead><tbody><tr><td>Raspberry Pi Zero</td><td>$10</td></tr><tr><td>Plastic electrical box</td><td>$14</td></tr><tr><td>Magnets</td><td>$18</td></tr><tr><td>128GB usb storage</td><td>$28</td></tr><tr><td>USB Battery pack</td><td>$40</td></tr><tr><td><strong>Total</strong></td><td><strong>$110</strong></td></tr></tbody></table></center><center>Table 2: Cost breakdown of my Raspberry Pi based system</center><p>As an example of what all this looks like in action, below is a gif showing the tracking algorithm when it was placed at random spots throughout Cincinnati.</p><p><img alt="deep learning raspberry pi traffic tracker in the wild" title="deep learning raspberry pi traffic tracker in the wild" src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/traffic-tracker.gif"/></p><center>Figure 4: Tracking traffic</center><h2>Results</h2><p>To test my system out, I placed it at few areas throughout the city. I started out by leaving it out in the field for 24 hours at a time. After I got comfortable with its performance I extended that duration to a full week (usually Sunday night to Sunday night).</p><p><img src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/central-pkwy-location-90.jpg"/></p><center>Figure 5: Central Pkwy location</center><p>As an example of the data that this system produces, below are the results for when it was placed on the Colerain Ave. bridge right as it passes over Central Pkwy during August 23, 2018.</p><center>Figure 6: Vehicle counts on Central Pkwy</center><p>Because the system generates a time stamp for each object as it passes over an imaginary “start/finish”, I binned all these data points into five-minute blocks. Additionally, even though vehicle traffic can be further broken down by vehicle type, it was easier to just group all vehicles into a single class. Above in figure 6, we can see the influx of southbound commuters coming into the city during the morning rush as well as when they leave in the evening rush headed north. Vehicle traffic peaked at 88 northbound vehicles per five minutes around 5:20pm. The day ended up with a total of 6982 southbound and 7092 northbound vehicles travelling on this particular segment of Central Pkwy.</p><center>Figure 7: Bicycle counts on Central Pkwy</center><p>Because the frequency of bicycle and pedestrian traffic was so much smaller relative to vehicle traffic, it was easier to display this data from a cumulative perspective. Above in figure 7, the bicycle count on Central Pkwy can be seen. Even with the cumulative form, we can see a large amount of growth during the southbound morning rush into the city, but compared to vehicle traffic, the evening bicycle rush is more diffused. Total bicycle traffic for the day capped out at 56 and 57 for the northbound and southbound directions respectively.</p><center>Figure 8: Pedestrian counts on Central Pkwy</center><p>Lastly, the pedestrian traffic can be seen above in figure 8. Unlike both vehicle and bicycle traffic, pedestrian traffic on Central Pkwy doesn’t have large spikes during the morning / evening rushes. Instead, pedestrian traffic is diffused fairly evenly throughout the entire day.</p><h2 id="learnings">Learnings and Future Improvements</h2><p>Over the span of this project I was able to fully test the limits of this first prototype and came away with a few key points.</p><p><strong id="algo-improvements">Algorithm Improvements</strong> — Although the current two-part solution works, it is far from elegant and definitely not the most efficient solution. I am actively building out several new deep learning based solutions that combine the detection, localization, and tracking into a single operation within <a target="_blank" href="https://www.tensorflow.org/mobile/tflite/">TensorFlow Lite</a> using a MobileNets<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup> style framework. My hope is that these new versions will improve performance during heavy occlusion or low light while reducing computational overhead. In theory, if this were ever implemented with permission from a city (and thus solar-powered), I could potentially use something more energy intensive such as an NVIDIA Jetson or similar IoT board. The combination of the increased horsepower, and reduced computational load would hopefully allow for a frame rate closer to 10Hz rather than the current 2Hz.</p><p><strong>Energy Storage and Connectivity</strong> — Because I was flying under the radar during this project, I was limited in two areas; energy consumption and connectivity. Ideally I would have paired the 30,000mAh battery pack with a solar panel mounted on top. The solar panel would then power the Raspberry Pi and charge the battery pack during the day, while the battery pack alone would power it during the night and through overcast days.</p><p>The issue of connectivity would become the next obstacle in long-term deployment. As it currently stands, I use a 128GB usb memory card to store all the trajectory data. I could have paid for a Raspberry Pi cellular data plan, but I completely expected my prototype to get stolen. Given the ideal situation of being able to connect to an ethernet line, indefinite deployment becomes an actual possibility.</p><p><strong>Camera Placement</strong> — After a little trial and error, I discovered that the best position is ideally high over the center of the street with at least 100 yards of visibility. The hundred yards requirement was function of the slow frame rate of 2Hz. Presumably if I had faster hardware, I could increase the frame rate and reduce the required field of view. The elevation requirement is important because it reduces the occlusion, especially when there are multiple lanes of traffic. Lastly, I always tried to position the camera in a loosely northward facing direction and in close proximity to a street light. This allowed me to count traffic at night but also reduce the chances of incurring any glare or direct sun light which could wash out the images during the day.</p><p><strong>Thermal Management</strong> — The current version relies on passive cooling because weather sealing had the highest priority. Because of this limitation, I conservatively placed it in areas that were always shaded. This prevented me from measuring several road segments I was interested in but also forced me to get creative for others. If this were ever implemented with permission from a city, I would definitely build in a solar-powered fan for reducing mid-day heat buildup.</p><h2>Conclusion</h2><p>Overall I was really happy with the final results and I learned a lot about deploying a self-contained system into the wild. It would be nice to let this system harvest data for an extended period of time so that long-term trends could be accurately measured. With a system like this, a measurable impact of bike infrastructure investment could be generated. It could also provide the underlying data needed to justify new infrastructure proposals.</p><p><img alt="deep learning raspberry pi traffic tracker in the wild" title="deep learning raspberry pi traffic tracker in the wild" src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/VineSt-2018-07-25-17-34-59-25.jpg"/></p><center>Figure 9: Me taking a picture of a Raspberry Pi taking a picture of me</center><p>Cincinnati government/department of transportation get at me. I want to help!</p><h2 id="technical-notes">Technical Notes</h2><p>Within this section, I’ll cover the technical details in-depth. There are only a couple key components to my system, mainly the algorithm, training data, and hardware.</p><p><strong>Data</strong> — Using <a target="_blank" href="https://github.com/tzutalin/labelImg">labelImg</a><sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup>, I manually annotated examples of each class. This was fairly time-consuming, but it gave me good chuck of time to catchup on podcasts so it really wasn’t too bad. I could have been substituted this manual data annotation with existing datasets such as the <a target="_blank" href="http://www.vision.caltech.edu/Image_Datasets/CaltechPedestrians/">Caltech Pedestrian Detection Benchmark</a> or one of the <a terget="_blank" href="http://www.gavrila.net/Datasets/Daimler_Pedestrian_Benchmark_D/daimler_pedestrian_benchmark_d.html">Daimler Pedestrian Benchmark Data Sets</a> but one of my primary goals with this project was to start at zero and finish with a solid working solution. I was also concerned with the discrepancy of training on full color data but operating with the infrared data coming from the v2 NoIR image sensor. Lastly, I was also curious as to whether my dataset could help overcome some known shortcomings in regards to Faster R-CNN.<sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup><sup>,</sup><sup id="fnref:5"><a href="#fn:5" role="doc-noteref">5</a></sup> Below are the results from my manual annotation. Note that images are captured and analyzed at 1280x720 resolution.</p><center><table><thead><tr><th><strong>Label</strong></th><th><strong>Annotations (#)</strong></th></tr></thead><tbody><tr><td>Pedestrians</td><td>59</td></tr><tr><td>Bicycles</td><td>259</td></tr><tr><td>Cars</td><td>593</td></tr><tr><td>SUVs</td><td>217</td></tr><tr><td>Pickup Trucks</td><td>137</td></tr><tr><td>Trucks</td><td>229</td></tr><tr><td><strong>All annotations</strong></td><td><strong>1494</strong></td></tr></tbody></table></center><center>Table 3: Manual annotations (based off 529 images)</center><p><strong>Machine Learning</strong> — There are two primary parts to the tracking algorithm. The first is the <a target="_blank" href="https://en.wikipedia.org/wiki/Deep_learning">deep learning</a> based object detection and localization. For this I utilized a TensorFlow based implementation of Faster R-CNN<sup id="fnref:6"><a href="#fn:6" role="doc-noteref">6</a></sup>, which is the new and improved version of Fast R-CNN<sup id="fnref:7"><a href="#fn:7" role="doc-noteref">7</a></sup>, which is the new and improved version of R-CNN<sup id="fnref:8"><a href="#fn:8" role="doc-noteref">8</a></sup>. This particular implementation of Faster R-CNN was built on top of Res-Net101<sup id="fnref:9"><a href="#fn:9" role="doc-noteref">9</a></sup> which had been trained on the COCO<sup id="fnref:10"><a href="#fn:10" role="doc-noteref">10</a></sup> data set. I could have went with a faster single shot detection (SSD) framework such as YOLO/YOLOv3<sup id="fnref:11"><a href="#fn:11" role="doc-noteref">11</a></sup>, but I was more concerned with positional accuracy<sup id="fnref:12"><a href="#fn:12" role="doc-noteref">12</a></sup> because at the time my secondary goal was to measure vehicle/pedestrian speed. Training was carried out using the GeForce GTX 1050 GPU on my laptop which ended up taking roughly three hours.</p><p>The second component is the tracking aspect of the algorithm. Once the objects in the current time frame have been detected and localized, they are clustered using <a target="_blank" href="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/means_clustering">k-means</a> over a time window of three frames. At an image capture rate of 2Hz, this translates to one second. This worked decently well for this initial prototype, but definitely has its limitations. I touch on several ways in which this can be improved [<a href="#algo-improvements">here</a>]. Below I made a general flow chart depicting the tracking process.</p><p><img alt="temporal clustering" title="temporal clustering" src="https://nathanrooy.github.io/posts/2019-02-06/raspberry-pi-deep-learning-traffic-tracker/clustering.jpg"/></p><center>Figure 10: Tracking system</center><p><strong>Hardware</strong> — This initial version uses the v2 Pi NoIR 8-megapixel/1080p30 (Sony IMX219 sensor) camera paired with the Raspberry Pi Zero. The lack of computing power resulted in the tracking algorithm unable to exceed a frame rate of 2Hz. All of this was powered by a 30,000mAh USB battery pack. In hindsight, I should have probably just gotten the Raspberry Pi 3 B+ with some kind of small industrial battery pack.</p></div></div>
  </body>
</html>
