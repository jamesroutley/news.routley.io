<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mptcp.dev/">Original</a>
    <h1>Multipath TCP for Linux (2022)</h1>
    
    <div id="readability-page-1" class="page"><div> <div id="main-content"> <main> <p>Multipath TCP or <a href="https://en.wikipedia.org/wiki/Multipath_TCP">MPTCP</a> is an extension to the standard <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> and is described in <a href="https://www.rfc-editor.org/rfc/rfc8684.html">RFC 8684</a>. It allows a device to make use of multiple interfaces at once to send and receive TCP packets over a single MPTCP connection. MPTCP can aggregate the bandwidth of multiple interfaces or prefer the one with lowest latency, it also allows a fail-over if one path is down, and the traffic is seamlessly reinjected on other paths.</p><pre><code>graph TD;
    subgraph MPTCP
        direction LR
        C_1(&lt;div style=&#34;display: inline-block; min-width: 32px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-mobile&lt;/font&gt;&lt;/div&gt;)
        S_1((&lt;div style=&#34;display: inline-block; min-width: 55px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-cloud&lt;/font&gt;&lt;/div&gt;))
    end

    subgraph TCP
        direction LR
        C_2(&lt;div style=&#34;display: inline-block; min-width: 32px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-mobile&lt;/font&gt;&lt;/div&gt;)
        S_2((&lt;div style=&#34;display: inline-block; min-width: 55px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-cloud&lt;/font&gt;&lt;/div&gt;))
    end

    C_1 &lt;== &#34;5G&#34; ==&gt; S_1
    C_1 &lt;== &#34;Wi-Fi&lt;br /&gt;&lt;br /&gt;Multiple paths (&lt;i&gt;subflows&lt;/i&gt;)&lt;br /&gt;at the same time&#34; ==&gt; S_1

    C_2 x-. &#34;5G&#34; .-x S_2
    C_2 &lt;== &#34;Wi-Fi&lt;br /&gt;&lt;br /&gt;One path at a time&#34; ==&gt; S_2

    linkStyle 0 stroke:green;
    linkStyle 1 stroke:green;
    linkStyle 2 stroke:red;
    linkStyle 3 stroke:green;
</code></pre><p>Technically, when a new socket is created with the <code>IPPROTO_MPTCP</code> protocol (Linux-specific), a <em>subflow</em> (or <em>path</em>) is created. This <em>subflow</em> consists of a regular TCP connection that is used to transmit data through one interface. Additional <em>subflows</em> can be negotiated later between the hosts. For the remote host to be able to detect the use of MPTCP, a new field is added to the TCP <em>option</em> field of the underlying TCP <em>subflow</em>. This field contains, amongst other things, a <code>MP_CAPABLE</code> option that tells the other host to use MPTCP if it is supported. If the remote host or any <a href="https://en.wikipedia.org/wiki/Middlebox">middlebox</a> in between does not support it, the returned <code>SYN+ACK</code> packet will not contain MPTCP options in the TCP <em>option</em> field. In that case, the connection will be “downgraded” to plain TCP, and it will continue with a single path.</p> <p>This behavior is made possible by two internal components:</p> <ul> <li> <p><strong>Path Manager</strong>: Manages <em>subflows</em> from creation to deletion, and also address announcements. Typically, it is the client side that initiates subflows, and the server side that announces additional addresses via the <code>ADD_ADDR</code> and <code>REMOVE_ADDR</code> options.</p><pre><code>graph LR;
    C_1(&lt;div style=&#34;display: inline-block; min-width: 35px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-mobile&lt;/font&gt;&lt;/div&gt;)
    S_1((&lt;div style=&#34;display: inline-block; min-width: 60px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-cloud&lt;/font&gt;&lt;/div&gt;))

    C_1 -. &#34;Potential subflow&#34; -.- S_1
    C_1 &lt;== &#34;Initial subflow&#34; ==&gt; S_1
    C_1 ~~~|&#34;Subflows creation&#34;| C_1
    S_1 ~~~|&#34;Addresses announcement&#34;| S_1

    linkStyle 0 stroke:orange;
    linkStyle 1 stroke:green;
</code></pre></li> </ul> <p>As of Linux v5.19, there are two path managers, controlled by the <code>net.mptcp.pm_type</code> sysctl knob: the in-kernel one (type <code>0</code>) where the same rules are applied for all the connections (see: <code>ip mptcp</code>) ; and the userspace one (type <code>1</code>), controlled by a userspace daemon (i.e. <a href="https://mptcpd.mptcp.dev/"><code>mptcpd</code></a>) where different rules can be applied for each connection.</p> <ul> <li> <p><strong>Packet Scheduler</strong>: In charge of selecting which available <em>subflow(s)</em> to use to send the next data packet. It can decide to maximize the use of the available bandwidth, only to pick the path with the lower latency, or any other policy depending on the configuration.</p><pre><code>graph LR;
    A_2(&lt;div style=&#34;display: inline-block; min-width: 40px&#34;&gt;&lt;font size=&#34;7&#34;&gt;fa:fa-user&lt;/font&gt;&lt;/div&gt;)

    PS{Packet&lt;br /&gt;Scheduler}

    I_21(subflow 1)
    I_22(subflow 2)

    A_2 == &#34;&lt;div style=&#39;display: inline-block; min-width: 50px&#39;&gt;fa:fa-box fa:fa-box fa:fa-box&lt;/div&gt;&#34; ==&gt; PS
    PS -- &#34;&lt;div style=&#39;display: inline-block; min-width: 32px&#39;&gt;fa:fa-box fa:fa-box&lt;/div&gt;&#34; --&gt; I_21
    PS -- &#34;&lt;div style=&#39;display: inline-block; min-width: 14px&#39;&gt;fa:fa-box&lt;/div&gt;&#34; --&gt; I_22
    PS ~~~|&#34;Packets distribution between subflows&#34;| PS
</code></pre></li> </ul> <p>As of Linux v6.8, there is only one packet scheduler, controlled by sysctl knobs in <code>net.mptcp</code>.</p> <h2 id="features"> <a href="#features" aria-labelledby="features"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Features </h2> <p>As of Linux v6.10, major features of MPTCP include:</p> <ul> <li>Support of the <a href="https://www.mptcp.dev/implementation.html"><code>IPPROTO_MPTCP</code></a> protocol in <code>socket()</code> system calls.</li> <li>Fallback from MPTCP to TCP if the peer or a middlebox do not support MPTCP.</li> <li>Path management using either an in-kernel or userspace path manager.</li> <li>Socket options that are commonly used with TCP sockets.</li> <li>Debug features including MIB counters, diag support (used by the <code>ss</code> command), and tracepoints.</li> </ul> <p>See the <a href="https://github.com/multipath-tcp/mptcp_net-next/wiki/#changelog">ChangeLog</a> for more details.</p> <h2 id="communication"> <a href="#communication" aria-labelledby="communication"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Communication </h2> <ul> <li>Mailing List: <a href="mailto:mptcp@lists.linux.dev">mptcp@lists.linux.dev</a> (and <a href="https://lore.kernel.org/mptcp">archives</a>)</li> <li>IRC: <a href="https://web.libera.chat/?nick=mptcp-dev-guest?#mptcp">#mptcp</a> on libera.chat</li> <li>Online <a href="https://github.com/multipath-tcp/mptcp_net-next/wiki/Meetings">Meetings</a></li> <li><a href="https://blog.mptcp.dev">Blog</a></li> <li><a href="https://social.kernel.org/mptcp">Fediverse <i></i></a></li> </ul> <h2 id="projects"> <a href="#projects" aria-labelledby="projects"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Projects </h2> <ul> <li>Maintained by MPTCP community members <ul> <li><a href="https://github.com/multipath-tcp/mptcp_net-next/">Kernel development on GitHub</a></li> <li><a href="https://github.com/multipath-tcp/mptcpd">Multipath TCP Daemon</a> <ul> <li>The <a href="https://www.mankier.com/8/mptcpd"><code>mptcpd</code></a> daemon can do full userspace path management or control the in-kernel path manager.</li> <li>Includes the <a href="https://www.mankier.com/8/mptcpize"><code>mptcpize</code></a> utility to allow legacy TCP binaries to use MPTCP.</li> </ul> </li> <li><a href="https://github.com/multipath-tcp/packetdrill">Packetdrill with MPTCP support</a></li> </ul> </li> <li>Projects with MPTCP-related enhancements <ul> <li><a href="https://wiki.linuxfoundation.org/networking/iproute2">iproute2</a> (for the <a href="https://www.mankier.com/8/ip-mptcp"><code>ip mptcp</code></a> command)</li> <li><a href="https://networkmanager.dev">Network Manager</a>: MPTCP features are included starting with v1.40.</li> <li><a href="https://github.com/mptcp-apps/">Multipath TCP applications</a>: A project to coordinate MPTCP updates for popular TCP applications.</li> </ul> </li> </ul> <h2 id="kernel-development"> <a href="#kernel-development" aria-labelledby="kernel-development"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Kernel Development </h2> <ul> <li><a href="https://github.com/multipath-tcp/mptcp_net-next.git">Git Repository</a> (<a href="https://github.com/multipath-tcp/mptcp_net-next/wiki/Git-Branches">branch descriptions</a>)</li> <li><a href="https://patchwork.kernel.org/project/mptcp/">Patchwork</a></li> <li><a href="https://github.com/multipath-tcp/mptcp_net-next/wiki/CI">Continuous Integration</a></li> <li><a href="https://github.com/multipath-tcp/mptcp_net-next/wiki/Testing">Testing</a></li> <li><a href="https://github.com/multipath-tcp/mptcp_net-next/issues">Issue tracker</a></li> </ul> </main> <hr/>  </div> </div></div>
  </body>
</html>
