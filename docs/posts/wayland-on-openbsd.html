<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xenocara.org/Wayland_on_OpenBSD.html">Original</a>
    <h1>Wayland on OpenBSD</h1>
    
    <div id="readability-page-1" class="page"><div id="doc"><h2 id="introduction"><a href="#introduction" title="introduction"><i></i></a>Introduction</h2><p>These are my notes from experimenting with building Wayland bits on OpenBSD during g2k23 in Tallinn… Thanks to the OpenBSD foundation for organizing this event.</p><p>This is still far from a complete running system as there are many issues on the road, but it’s a good start and it shows that it’s definatly not impossible to get Wayland running on OpenBSD.</p><h3 id="disclaimers"><a href="#disclaimers" title="disclaimers"><i></i></a>Disclaimers</h3><ul>
<li>
<p>I don’t know much about Wayland internals, I’m discovering that on the way, so some stuff here may look naive or totally wrong to experimented Wayland developers…</p>
</li>
<li>
<p>I’m not discussing here on why Wayland ? You may find some answers in <a href="https://homepages.laas.fr/matthieu/talks/app-sec-article.pdf" target="_blank" rel="noopener">this paper</a> I wrote in 2017 (in french).</p>
</li>
<li>
<p>The build instructions below will probably break your system. Use a separate machine for this</p>
</li>
</ul><h2 id="general-ideas"><a href="#general-ideas" title="general-ideas"><i></i></a>General ideas</h2><ul>
<li>I’m using the wlroots library and will focus on compositors (sway, tinywl+…) and applications that use it
<ul>
<li>Gnome (GTK+) based or Qt-based application will wait until someone else builds Wayland support for those toolkits on OpenBSD</li>
</ul>
</li>
<li>The output path is more or less ready with the DRI and Mesa porting efforts (mostly jsg and kettenis)
<ul>
<li>jsg’s github fork of mesa is being used to build it using meson. This may not be needed, but I haven’t checked</li>
</ul>
</li>
<li>“Seat” management is going to be minimal, as OpenBSD doesn’t support this:
<ul>
<li>seatd and libseat provide support for non-systemd based systems. A basic port to OpenBSD/wscons is needed.</li>
</ul>
</li>
<li>Input is more complex to get working since Wayland applications expect Linux input model with udev, evdev and libinput.
<ul>
<li>udev is used to probe available device and handle hot-plugging on Linux. OpenBSD doesn’t have it and the current state of hotplugd(8) doesn’t make it possible to really emulate udev. There is a <code>libudev-openbsd</code> port already that can be used.</li>
<li>evdev is the input event layer of the Linux kernel, similar to wscons_events in OpenBSD. It’s mostly hidden by libinput, but event name translation need the libevdev library for some reason.</li>
<li>libinput is the library that permits reading evdev events from the Linux kernel and  handling many of the higher level interpretation of the events (getting the keyboard mapping, mouse gestures or multi-touch)… It also handles device configuration. mpi did a simple libinput port back in 2015, and rsadowski improved it a bit in 2022. More work is needed.</li>
</ul>
</li>
</ul><p>All this was done on the top of <a href="https://md.tetaneutral.net/xenoports" target="_blank" rel="noopener">xenoports</a>. I’m not sure how well it works on a regular system with <code>/usr/X11R6</code> installed from xenocara.</p><h2 id="detailed-instructions"><a href="#detailed-instructions" title="detailed-instructions"><i></i></a>Detailed instructions</h2><h3 id="mesa"><a href="#mesa" title="mesa"><i></i></a>Mesa</h3><pre><code>git clone -b 22.3-fixes-notls https://github.com/jonathangray/mesa.git
cd mesa
meson setup build -Dgallium-drivers=swrast,iris -Dvulkan-drivers=amd,intel -Ddri-drivers-path=/usr/X11R6/lib/modules/dri -Dcpp_rtti=false -Dprefix=/usr/X11R6
ninja -C build
doas ninja -C build install
</code></pre><h3 id="wayland-ports"><a href="#wayland-ports" title="wayland-ports"><i></i></a>Wayland ports</h3><pre><code>pkg_add wayland wayland-protocols wayland-utils scdoc
</code></pre><p><code>scdoc</code> is not a wayland port, but it’s used to generate manual pages for many projects below</p><p>I’ve a patch to the wayland port to try to fix the search path for system cursors and themes to include <code>/usr/local/share/icons</code> and <code>/usr/X11R6/lib/X11/icons</code> It doesn’t seem to work correctly.</p><h3 id="seatd"><a href="#seatd" title="seatd"><i></i></a>Seatd</h3><p>The original project in on <a href="https://git.sr.ht/~kennylevinsen/seatd" target="_blank" rel="noopener">Source Hut</a></p><p>The OpenBSD port below is very minimal but enough for now. TODO: make it more complete WRT VT switching, using fbtab and some sort of session management.</p><pre><code>git clone -b obsd https://gitlab.tetaneutral.net/mherrb/seatd
cd seatd
meson setup build -Dlibseat-logind=disabled -Dlibseat-builtin=enabled
ninja -C build
doas ninja -C build install
</code></pre><h3 id="libudev-openbsd"><a href="#libudev-openbsd" title="libudev-openbsd"><i></i></a>libudev-openbsd</h3><pre><code>pkg_add libudev-openbsd
</code></pre><h3 id="libinput-openbsd"><a href="#libinput-openbsd" title="libinput-openbsd"><i></i></a>libinput-openbsd</h3><p>This is the version from mpi@, patched@ by radowski, plus extra udev code from me.</p><pre><code>git clone https://github.com/mherrb/libinput.git
cd libinput-openbsd
make
doas make install
</code></pre><h3 id="libevdev-openbsd"><a href="#libevdev-openbsd" title="libevdev-openbsd"><i></i></a>libevdev-openbsd</h3><p>This is a stripped-down version of libevdev, providing just the few functions to handle name to symbol conversions that are used by most Wayland applications.</p><pre><code>git clone https://gitlab.tetaneutral.net/mherrb/libevdev-openbsd.git
cd libevdev-openbsd
make
doas make install
</code></pre><h3 id="libdisplay-info-and-libliftoff"><a href="#libdisplay-info-and-libliftoff" title="libdisplay-info-and-libliftoff"><i></i></a>libdisplay-info and libliftoff</h3><p>Those two small helper libraries build of of the box on OpenBSD. I’ve made ports for them in my xenoports tree, or they can be built from gitlab:</p><ul>
<li><a href="https://gitlab.freedesktop.org/emersion/libdisplay-info" target="_blank" rel="noopener">https://gitlab.freedesktop.org/emersion/libdisplay-info</a> (<a href="https://cgit.xenocara.org/xenoports/tree/sysutils/libdisplay-info" target="_blank" rel="noopener">port</a>)</li>
<li><a href="https://gitlab.freedesktop.org/emersion/libliftoff" target="_blank" rel="noopener">https://gitlab.freedesktop.org/emersion/libliftoff</a> (<a href="https://cgit.xenocara.org/xenoports/tree/graphics/libliftoff" target="_blank" rel="noopener">port</a>)</li>
</ul><h3 id="wlroots"><a href="#wlroots" title="wlroots"><i></i></a>wlroots</h3><p>A version of wlroots patched for OpenBSD. The wscons backend code can dropped for now. I’m not sure if it will ever be possible to have Wayland applications running without libinput (but that’s the goal of this backend).</p><pre><code>git clone -b obsd https://gitlab.freedesktop.org/mherrb/wlroots.git
cd wlroot
meson setup build
ninja -C build
doas ninja -C build install
</code></pre><h3 id="havoc"><a href="#havoc" title="havoc"><i></i></a>havoc</h3><p>The simplest terminal emulator application for Wayland that I could find and that builds on OpenBSD with minimal changes.</p><pre><code>git clone -b obsd https://github.com/mherrb/havoc.git
cd havoc
meson setup build
ninja -C build
doas ninja -C build install
</code></pre><h3 id="swayimg"><a href="#swayimg" title="swayimg"><i></i></a>swayimg</h3><p>An image viewer for Wayland that builds on OpenBSD without patches \o/</p><pre><code>git clone https://github.com/artemsen/swayimg.git
cd swayimg 
meson setup build
ninja -C build
doas -C build ninja install
</code></pre><h3 id="sway"><a href="#sway" title="sway"><i></i></a>sway</h3><p>A real compositor, compatible with i3</p><pre><code>git clone -b obsd https://github.com/mherrb/sway.git
cd sway
meson setup build
ninja -C build
doas -C build ninja install
</code></pre><h3 id="default-cursor-theme"><a href="#default-cursor-theme" title="default-cursor-theme"><i></i></a>Default cursor theme</h3><p>Wayland doesn’t provide cursors by itself. So one needs to install the <code>gnome-default-theme</code> package or any other package providing a default theme.</p><p>Note: swaybar will segfault if it’s missing a cursor…</p><h3 id="fonts"><a href="#fonts" title="fonts"><i></i></a>Fonts</h3><p>Wayland is using <code>fontconfig</code>. So it can use any fonts installed via <code>pkg_add</code> swaybar expects the terminus font to be available.</p><h3 id="running-wayland"><a href="#running-wayland" title="running-wayland"><i></i></a>Running Wayland</h3><p>One needs to set a number of environment variables. The following script (<code>runwl</code>) helps:</p><pre><code>#! /bin/ksh
export XDG_RUNTIME_DIR=/tmp 
export WAYLAND_DISPLAY=wayland-0
exec $*
</code></pre><ul>
<li>
<p>Start seatd</p>
<p>This gives the /var/run/seatd.sock to my user, so that the applications will be run as my uid, not root.</p>
<pre><code> doas seatd -u $(whoami) -l debug
</code></pre>
</li>
<li>
<p>Start sway:</p>
<pre><code> export XDG_RUNTIME_DIR=/tmp 
 export WLR_DRM_DEVICES=/dev/dri/card0
 sway
</code></pre>
</li>
<li>
<p>start an application (here havoc)</p>
<pre><code> runwl havoc
</code></pre>
</li>
</ul><h3 id="xwayland"><a href="#xwayland" title="xwayland"><i></i></a>Xwayland</h3><p>A port is available in xenoports: <a href="https://cgit.xenocara.org/xenoports/tree/wayland/xwayland" target="_blank" rel="noopener">here</a></p><p>Sway starts Xwayland automatically if an application needs X</p><p>It can also be started manually, but not in rootless mode (this is a Wayland security feature). X applications work in the Xwaylan in windowed mode, but OpenGL X applications crash (probably because of mismatched Mesa versions in my builds FIXME</p><h2 id="more-work-to-do"><a href="#more-work-to-do" title="more-work-to-do"><i></i></a>More work to do</h2><h3 id="gtk-applications"><a href="#gtk-applications" title="gtk-applications"><i></i></a>Gtk applications</h3><p>Simple patches allows to build gtk+3 and gtk+4 with wayland support enabled. gtk3-demo works, built against the patched version.</p><p>Note that both emacs and mozilla-firefox work, but still use Xwayland. The ports need some plist and lib-depends patches once wayland support is enabled in gtk+3/4.</p><p>So far gtk4-demos fails to start, it still tries to connect to an X serer and segfault. FIXME</p><h3 id="qt-applications"><a href="#qt-applications" title="qt-applications"><i></i></a>Qt applications</h3><p>Qt 5 and 6 are normally built with Wayland support. I tried keepassxc(1) (Qt5) which could’nt connect to the compositor. qt6/qtbase doesn’t build on my system from some reason. FIXME</p><h3 id="ltucharhgt-and-char32_t"><a href="#ltucharhgt-and-char32_t" title="ltucharhgt-and-char32_t"><i></i></a>&lt;uchar.h&gt; and char32_t</h3><p>A number of Wayland applications use UTF-32 internally and require support for the above that it not (yet) available on OpenBSD. TODO: one implementation exists in DragonFlyBSD.</p><h3 id="swaylock"><a href="#swaylock" title="swaylock"><i></i></a>swaylock</h3><p>To get a screen locker, swaylock needs to be tought about BSD auth to replace PAM.</p><h3 id="pledge-and-unveil"><a href="#pledge-and-unveil" title="pledge-and-unveil"><i></i></a>Pledge and Unveil</h3><p>None of the above currenty implement pledge() or unveil() support, nor any other from of sandboxing afaict. This could be looked at at some point.</p><h2 id="known-issues"><a href="#known-issues" title="known-issues"><i></i></a>Known issues</h2><p>Sway will crash the kernel during startup from time to time. I don’t know if it’s a problem specific to the dri driver for the Intel iris (12th gen) GPU in my test laptop or a general bug. TODO: test on a machine with a serial console to get a backtrace if possible.</p><hr/><p>Last modified: 2023-07-09T07:06:00</p></div></div>
  </body>
</html>
