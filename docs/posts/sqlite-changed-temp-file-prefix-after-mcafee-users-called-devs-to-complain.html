<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/sqlite/sqlite/blob/e8346d0a889c89ec8a78e65abc33257a6c6fb81a/src/os.h">Original</a>
    <h1>SQLite changed temp file prefix after McAfee users called devs to complain</h1>
    
    <div id="readability-page-1" class="page"><div><section aria-labelledby="file-name-id-wide file-name-id-mobile"><div><div id="highlighted-line-menu-positioner"><div id="copilot-button-positioner"><div><div role="presentation" aria-hidden="true" data-tab-size="8" data-paste-markdown-skip="true" data-hpc="true"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p></div><div><div><div><p><span>** The author disclaims copyright to this source code.  In place of</span></p></div></div><div><div><p><span>** a legal notice, here is a blessing:</span></p></div></div><div><div><p><span>**    May you do good and not evil.</span></p></div></div><div><div><p><span>**    May you find forgiveness for yourself and forgive others.</span></p></div></div><div><div><p><span>**    May you share freely, never taking more than you give.</span></p></div></div><div><div><p><span>******************************************************************************</span></p></div></div><div><div><p><span>** This header file (together with is companion C source-code file</span></p></div></div><div><div><p><span>** &#34;os.c&#34;) attempt to abstract the underlying operating system so that</span></p></div></div><div><div><p><span>** the SQLite library will work on both POSIX and windows systems.</span></p></div></div><div><div><p><span>** This header file is #include-ed by sqliteInt.h and thus ends up</span></p></div></div><div><div><p><span>** being included by every source file.</span></p></div></div><div><div><p><span>** Attempt to automatically detect the operating system and setup the</span></p></div></div><div><div><p><span>** necessary pre-processor macros for it.</span></p></div></div><div><div><p><span>/* If the SET_FULLSYNC macro is not defined above, then make it</span></p></div></div><div><div><p><span># define</span> <span>SET_FULLSYNC</span>(<span>x</span>,<span>y</span>)</p></div></div><div><div><p><span>/* Maximum pathname length.  Note: FILENAME_MAX defined by stdio.h</span></p></div></div><div><div><p><span>#ifndef</span> <span>SQLITE_MAX_PATHLEN</span></p></div></div><div><div><p><span># define</span> <span>SQLITE_MAX_PATHLEN</span> FILENAME_MAX</p></div></div><div><div><p><span>/* Maximum number of symlinks that will be resolved while trying to</span></p></div></div><div><div><p><span>** expand a filename in xFullPathname() in the VFS.</span></p></div></div><div><div><p><span>#ifndef</span> <span>SQLITE_MAX_SYMLINK</span></p></div></div><div><div><p><span># define</span> <span>SQLITE_MAX_SYMLINK</span> 200</p></div></div><div><div><p><span>** The default size of a disk sector</span></p></div></div><div><div><p><span>#ifndef</span> <span>SQLITE_DEFAULT_SECTOR_SIZE</span></p></div></div><div><div><p><span># define</span> <span>SQLITE_DEFAULT_SECTOR_SIZE</span> 4096</p></div></div><div><div><p><span>** Temporary files are named starting with this prefix followed by 16 random</span></p></div></div><div><div><p><span>** alphanumeric characters, and no file extension. They are stored in the</span></p></div></div><div><div><p><span>** OS&#39;s standard temporary file directory, and are deleted prior to exit.</span></p></div></div><div><div><p><span>** If sqlite is being embedded in another program, you may wish to change the</span></p></div></div><div><div><p><span>** prefix to reflect your program&#39;s name, so that if your program exits</span></p></div></div><div><div><p><span>** prematurely, old temporary files can be easily identified. This can be done</span></p></div></div><div><div><p><span>** using -DSQLITE_TEMP_FILE_PREFIX=myprefix_ on the compiler command line.</span></p></div></div><div><div><p><span>** 2006-10-31:  The default prefix used to be &#34;sqlite_&#34;.  But then</span></p></div></div><div><div><p><span>** Mcafee started using SQLite in their anti-virus product and it</span></p></div></div><div><div><p><span>** started putting files with the &#34;sqlite&#34; name in the c:/temp folder.</span></p></div></div><div><div><p><span>** This annoyed many windows users.  Those users would then do a </span></p></div></div><div><div><p><span>** Google search for &#34;sqlite&#34;, find the telephone numbers of the</span></p></div></div><div><div><p><span>** developers and call to wake them up at night and complain.</span></p></div></div><div><div><p><span>** For this reason, the default name prefix is changed to be &#34;sqlite&#34; </span></p></div></div><div><div><p><span>** spelled backwards.  So the temp files are still identified, but</span></p></div></div><div><div><p><span>** anybody smart enough to figure out the code is also likely smart</span></p></div></div><div><div><p><span>** enough to know that calling the developer will not help get rid</span></p></div></div><div><div><p><span>#ifndef</span> <span>SQLITE_TEMP_FILE_PREFIX</span></p></div></div><div><div><p><span># define</span> <span>SQLITE_TEMP_FILE_PREFIX</span> &#34;etilqs_&#34;</p></div></div><div><div><p><span>** The following values may be passed as the second argument to</span></p></div></div><div><div><p><span>** sqlite3OsLock(). The various locks exhibit the following semantics:</span></p></div></div><div><div><p><span>** SHARED:    Any number of processes may hold a SHARED lock simultaneously.</span></p></div></div><div><div><p><span>** RESERVED:  A single process may hold a RESERVED lock on a file at</span></p></div></div><div><div><p><span>**            any time. Other processes may hold and obtain new SHARED locks.</span></p></div></div><div><div><p><span>** PENDING:   A single process may hold a PENDING lock on a file at</span></p></div></div><div><div><p><span>**            any one time. Existing SHARED locks may persist, but no new</span></p></div></div><div><div><p><span>**            SHARED locks may be obtained by other processes.</span></p></div></div><div><div><p><span>** EXCLUSIVE: An EXCLUSIVE lock precludes all other locks.</span></p></div></div><div><div><p><span>** PENDING_LOCK may not be passed directly to sqlite3OsLock(). Instead, a</span></p></div></div><div><div><p><span>** process that requests an EXCLUSIVE lock may actually obtain a PENDING</span></p></div></div><div><div><p><span>** lock. This can be upgraded to an EXCLUSIVE lock by a subsequent call to</span></p></div></div><div><div><p><span>** File Locking Notes:  (Mostly about windows but also some info for Unix)</span></p></div></div><div><div><p><span>** We cannot use LockFileEx() or UnlockFileEx() on Win95/98/ME because</span></p></div></div><div><div><p><span>** those functions are not available.  So we use only LockFile() and</span></p></div></div><div><div><p><span>** LockFile() prevents not just writing but also reading by other processes.</span></p></div></div><div><div><p><span>** A SHARED_LOCK is obtained by locking a single randomly-chosen </span></p></div></div><div><div><p><span>** byte out of a specific range of bytes. The lock byte is obtained at </span></p></div></div><div><div><p><span>** random so two separate readers can probably access the file at the </span></p></div></div><div><div><p><span>** same time, unless they are unlucky and choose the same lock byte.</span></p></div></div><div><div><p><span>** An EXCLUSIVE_LOCK is obtained by locking all bytes in the range.</span></p></div></div><div><div><p><span>** There can only be one writer.  A RESERVED_LOCK is obtained by locking</span></p></div></div><div><div><p><span>** a single byte of the file that is designated as the reserved lock byte.</span></p></div></div><div><div><p><span>** A PENDING_LOCK is obtained by locking a designated byte different from</span></p></div></div><div><div><p><span>** the RESERVED_LOCK byte.</span></p></div></div><div><div><p><span>** On WinNT/2K/XP systems, LockFileEx() and UnlockFileEx() are available,</span></p></div></div><div><div><p><span>** which means we can use reader/writer locks.  When reader/writer locks</span></p></div></div><div><div><p><span>** are used, the lock is placed on the same range of bytes that is used</span></p></div></div><div><div><p><span>** for probabilistic locking in Win95/98/ME.  Hence, the locking scheme</span></p></div></div><div><div><p><span>** will support two or more Win95 readers or two or more WinNT readers.</span></p></div></div><div><div><p><span>** But a single Win95 reader will lock out all WinNT readers and a single</span></p></div></div><div><div><p><span>** WinNT reader will lock out all other Win95 readers.</span></p></div></div><div><div><p><span>** The following #defines specify the range of bytes used for locking.</span></p></div></div><div><div><p><span>** SHARED_SIZE is the number of bytes available in the pool from which</span></p></div></div><div><div><p><span>** a random byte is selected for a shared lock.  The pool of bytes for</span></p></div></div><div><div><p><span>** shared locks begins at SHARED_FIRST. </span></p></div></div><div><div><p><span>** The same locking strategy and</span></p></div></div><div><div><p><span>** byte ranges are used for Unix.  This leaves open the possibility of having</span></p></div></div><div><div><p><span>** clients on win95, winNT, and unix all talking to the same shared file</span></p></div></div><div><div><p><span>** and all locking correctly.  To do so would require that samba (or whatever</span></p></div></div><div><div><p><span>** tool is being used for file sharing) implements locks correctly between</span></p></div></div><div><div><p><span>** windows and unix.  I&#39;m guessing that isn&#39;t likely to happen, but by</span></p></div></div><div><div><p><span>** using the same locking range we are at least open to the possibility.</span></p></div></div><div><div><p><span>** Locking in windows is manditory.  For this reason, we cannot store</span></p></div></div><div><div><p><span>** actual data in the bytes used for locking.  The pager never allocates</span></p></div></div><div><div><p><span>** the pages involved in locking therefore.  SHARED_SIZE is selected so</span></p></div></div><div><div><p><span>** that all locks will fit on a single page even at the minimum page size.</span></p></div></div><div><div><p><span>** PENDING_BYTE defines the beginning of the locks.  By default PENDING_BYTE</span></p></div></div><div><div><p><span>** is set high so that we don&#39;t have to allocate an unused page except</span></p></div></div><div><div><p><span>** for very large databases.  But one should test the page skipping logic </span></p></div></div><div><div><p><span>** by setting PENDING_BYTE low and running the entire regression suite.</span></p></div></div><div><div><p><span>** Changing the value of PENDING_BYTE results in a subtly incompatible</span></p></div></div><div><div><p><span>** file format.  Depending on how it is changed, you might not notice</span></p></div></div><div><div><p><span>** the incompatibility right away, even running a full regression test.</span></p></div></div><div><div><p><span>** The default location of PENDING_BYTE is the first byte past the</span></p></div></div><div><div><p><span># define</span> <span>PENDING_BYTE</span>     (0x40000000)</p></div></div><div><div><p><span># define</span> <span>PENDING_BYTE</span>      sqlite3PendingByte</p></div></div><div><div><p><span>#define</span> <span>RESERVED_BYTE</span>     (PENDING_BYTE+1)</p></div></div><div><div><p><span>#define</span> <span>SHARED_FIRST</span>      (PENDING_BYTE+2)</p></div></div><div><div><p><span>** Wrapper around OS specific sqlite3_os_init() function.</span></p></div></div><div><div><p><span>** Functions for accessing sqlite3_file methods </span></p></div></div><div><div><p><span>void</span> <span>sqlite3OsClose</span>(<span>sqlite3_file</span><span>*</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsRead</span>(<span>sqlite3_file</span><span>*</span>, <span>void</span><span>*</span>, <span>int</span> <span>amt</span>, <span>i64</span> <span>offset</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsWrite</span>(<span>sqlite3_file</span><span>*</span>, <span>const</span> <span>void</span><span>*</span>, <span>int</span> <span>amt</span>, <span>i64</span> <span>offset</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsTruncate</span>(<span>sqlite3_file</span><span>*</span>, <span>i64</span> <span>size</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsSync</span>(<span>sqlite3_file</span><span>*</span>, <span>int</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsFileSize</span>(<span>sqlite3_file</span><span>*</span>, <span>i64</span> <span>*</span><span>pSize</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsLock</span>(<span>sqlite3_file</span><span>*</span>, <span>int</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsUnlock</span>(<span>sqlite3_file</span><span>*</span>, <span>int</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsCheckReservedLock</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>, <span>int</span> <span>*</span><span>pResOut</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsFileControl</span>(<span>sqlite3_file</span><span>*</span>,<span>int</span>,<span>void</span><span>*</span>);</p></div></div><div><div><p><span>void</span> <span>sqlite3OsFileControlHint</span>(<span>sqlite3_file</span><span>*</span>,<span>int</span>,<span>void</span><span>*</span>);</p></div></div><div><div><p><span>#define</span> <span>SQLITE_FCNTL_DB_UNCHANGED</span> 0xca093fa0</p></div></div><div><div><p><span>int</span> <span>sqlite3OsSectorSize</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsDeviceCharacteristics</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsShmMap</span>(<span>sqlite3_file</span> <span>*</span>,<span>int</span>,<span>int</span>,<span>int</span>,<span>void</span> <span>volatile</span> <span>*</span><span>*</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsShmLock</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>, <span>int</span>, <span>int</span>, <span>int</span>);</p></div></div><div><div><p><span>void</span> <span>sqlite3OsShmBarrier</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsShmUnmap</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>, <span>int</span>);</p></div></div><div><div><p><span>#endif</span> <span>/* SQLITE_OMIT_WAL */</span></p></div></div><div><div><p><span>int</span> <span>sqlite3OsFetch</span>(<span>sqlite3_file</span> <span>*</span><span>id</span>, <span>i64</span>, <span>int</span>, <span>void</span> <span>*</span><span>*</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsUnfetch</span>(<span>sqlite3_file</span> <span>*</span>, <span>i64</span>, <span>void</span> <span>*</span>);</p></div></div><div><div><p><span>** Functions for accessing sqlite3_vfs methods </span></p></div></div><div><div><p><span>int</span> <span>sqlite3OsOpen</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>, <span>sqlite3_file</span><span>*</span>, <span>int</span>, <span>int</span> <span>*</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsDelete</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>, <span>int</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsAccess</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>, <span>int</span>, <span>int</span> <span>*</span><span>pResOut</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsFullPathname</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>, <span>int</span>, <span>char</span> <span>*</span>);</p></div></div><div><div><p><span>#ifndef</span> <span>SQLITE_OMIT_LOAD_EXTENSION</span></p></div></div><div><div><p><span>void</span> <span>*</span><span>sqlite3OsDlOpen</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>);</p></div></div><div><div><p><span>void</span> <span>sqlite3OsDlError</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>int</span>, <span>char</span> <span>*</span>);</p></div></div><div><div><p><span>void</span> (<span>*</span><span>sqlite3OsDlSym</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>void</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>))(<span>void</span>);</p></div></div><div><div><p><span>void</span> <span>sqlite3OsDlClose</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>void</span> <span>*</span>);</p></div></div><div><div><p><span>#endif</span> <span>/* SQLITE_OMIT_LOAD_EXTENSION */</span></p></div></div><div><div><p><span>int</span> <span>sqlite3OsRandomness</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>int</span>, <span>char</span> <span>*</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsSleep</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>int</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsGetLastError</span>(<span>sqlite3_vfs</span><span>*</span>);</p></div></div><div><div><p><span>int</span> <span>sqlite3OsCurrentTimeInt64</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>sqlite3_int64</span><span>*</span>);</p></div></div><div><div><p><span>** Convenience functions for opening and closing files using </span></p></div></div><div><div><p><span>** sqlite3_malloc() to obtain space for the file-handle structure.</span></p></div></div><div><div><p><span>int</span> <span>sqlite3OsOpenMalloc</span>(<span>sqlite3_vfs</span> <span>*</span>, <span>const</span> <span>char</span> <span>*</span>, <span>sqlite3_file</span> <span>*</span><span>*</span>, <span>int</span>,<span>int</span><span>*</span>);</p></div></div><div><div><p><span>void</span> <span>sqlite3OsCloseFree</span>(<span>sqlite3_file</span> <span>*</span>);</p></div></div><div><div><p><span>#endif</span> <span>/* _SQLITE_OS_H_ */</span></p></div></div></div></div></div></div></div></div></section></div></div>
  </body>
</html>
