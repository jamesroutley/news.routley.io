<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tech.michaelaltfield.net/2021/11/22/bidi-unicode-github-defense/">Original</a>
    <h1>Detecting (Malicious) Unicode in GitHub PRs</h1>
    
    <div id="readability-page-1" class="page"><div><p>This article will describe how you can utilize GitHub Actions to scan user-contributed PRs for unicode and automatically warn you if such commits contain (potentially invisible &amp; malicious) unicode characters.</p>
<p><a href="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/bidi-unicode-github-defense_featuredImage2.jpg"><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2.jpg.pagespeed.ic.5hBxo22xgS.jpg" alt="Detecting Malicious Unicode in GitHub Pull Requests" width="1200" height="628" srcset="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2.jpg.pagespeed.ic.5hBxo22xgS.jpg 1200w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2-300x157.jpg.pagespeed.ic.ujREhmPE8F.jpg 300w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2-1024x536.jpg.pagespeed.ic.GEyDE6sruy.jpg 1024w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2-768x402.jpg.pagespeed.ic.Qy-RHjdb7c.jpg 768w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2-150x79.jpg.pagespeed.ic.g2jcEE0hvq.jpg 150w, https://tech.michaelaltfield.net/wp-content/uploads/sites/5/xbidi-unicode-github-defense_featuredImage2-400x209.jpg.pagespeed.ic.x3C6QZpwFk.jpg 400w" sizes="(max-width: 1200px) 100vw, 1200px"/></a></p>
<h2>Why</h2>
<p>Last month <a href="https://trojansource.codes/">Trojan Source</a> was published --- which described how malicious unicode characters could make source code appear benign, yet compile to something quite malicious.</p>

<p>Consider one novel example presented by the Trojan Source paper: using bidirectional (bidi) unicode characters in combination with a comment to do something nasty:</p>
<blockquote><p>
	<span id="bidi-0">/* </span><span id="bidi-1"> begin admins only */ </span><span id="bidi-2"> if (isAdmin) { </span></p></blockquote>

<p>The animation above demonstrates an attack when unterminated bidirectional unicode characters span across comments and code.</p>
<p>While <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-3376">malicious use of bidirectional unicode characters has been well-known since at least 2009</a>, this is the first publication that acknowledged the threat of unterminated bidi characters spanning between code and comments. And, indeed, the researches point-out that they&#39;ve found numerous cases of bidi characters  used to obfuscate code on GitHub spanning at least Ruby and JavaScript in the wild.</p>
<h2>Assumptions</h2>
<p>I designed this solution for an Open Source <a href="https://github.com/buskill/buskill-app">project</a> that I maintain on GitHub. Therefore:</p>
<ol>
<li>It&#39;s assumed the reader is using GitHub</li>
<li>My code &amp; comments are written in English (so there&#39;s very few places where unicode characters are &#34;normal&#34;)</li>
<li>This article was written in 2021</li>
</ol>
<h2>The Solution</h2>
<p>Since <a href="https://github.blog/2019-11-13-universe-day-one/">2019</a>, <a href="https://docs.github.com/en/actions">GitHub Actions</a> gave open source projects the ability to run CI pipelines on Microsoft&#39;s shared runners for free.</p>
<p>To use GitHub Actions, simply add a yaml file to your GitHub repo&#39;s <code>.github/workflows/</code> directory, as described <a href="https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions">here</a>.</p>
<p>In this case, we create a workflow file named <code>unicode_warn.yml</code>.</p>
<pre title=".github/workflows/unicode_warn.yml">################################################################################
# File:    .github/workflows/unicode_warn.yml
# Version: 0.1
# Purpose: Detects Unicode in PRs and comments the results of findings in PR
#           * https://tech.michaelaltfield.net/bidi-unicode-github-defense/
# Authors: Michael Altfield &lt;michael@michaelaltfield.net&gt;
# Created: 2021-11-20
# Updated: 2021-11-20
################################################################################
name: malicious_sanity_checks

# execute this workflow automatically on all PRs
on: [pull_request]

jobs:

  unicode_warn:

    runs-on: ubuntu-latest
    container: debian:bullseye-slim

    steps:

    - name: Prereqs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        apt-get update
        apt-get install -y git bsdmainutils
        git clone &#34;https://token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git&#34; .
      shell: bash

    - name: Check diff for unicode
      id: unicode_diff
      run: |
        set -x
        diff=`git diff --unified=0 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E &#34;^[+]&#34; | grep -Ev &#39;^(--- a/|\+\+\+ b/)&#39;`
        unicode_diff=`echo -n &#34;${diff}&#34; | grep -oP &#34;[^\x00-\x7F]*&#34;`
        unicode_grep_exit_code=$?
        echo &#34;${unicode_diff}&#34;

        unicode_diff_hexdump=`echo -n &#34;${unicode_diff}&#34; | hd`
        echo &#34;${unicode_diff_hexdump}&#34;

        # did we select any unicode characters?
        if [[ &#34;${unicode_diff_hexdump}&#34; == &#34;&#34; ]]; then
          # we didn&#39;t find any unicode characters
          human_result=&#34;INFO: No unicode characters found in PR&#39;s commits&#34;
          echo &#34;${human_result}&#34;

        else
          # we found at least 1 unicode character
          human_result=&#34;^^ WARNING: Unicode characters found in diff!&#34;
          echo &#34;${human_result}&#34;
          echo &#34;${diff}&#34;

        fi

        echo &#34;UNICODE_HUMAN_RESULT=${human_result}&#34; &gt;&gt; $GITHUB_ENV

      shell: bash {0}

    # leave a comment on the PR. See also
    #  * https://stackoverflow.com/a/64126737
    # make sure this doesn&#39;t open command injection risks
    #  * https://github.com/victoriadrake/github-guestbook/issues/1#issuecomment-657121754
    - name: Leave comment on PR
      uses: actions/github-script@v5
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: &#34;${{ env.UNICODE_HUMAN_RESULT }}&#34;
          })
</pre>
<p>The above file defines a workflow named <code>malicious_sanity_checks</code> with job named <code>unicode_warn</code>. This job contains multiple steps that will execute every time a new PR is created in your repo:</p>
<ol>
<li><strong>Prereqs</strong> - First, basic depends like <code>git</code> and <code>hd</code> are installed</li>
<li><strong>Check diff for unicode</strong> - A simple BASH script uses <code>grep</code> to detect non-ascii characters in a diff across the PR&#39;s commits-to-be-merged</li>
<li><strong>Leave comment on PR</strong> - Adds a comment on the PR indicating if the commits include unicode characters or not</li>
</ol>
<h2>Example</h2>
<p>I created an example <a href="https://github.com/maltfield/detect-malicious-unicode">detect-malicious-unicode repo on GitHub</a> to demonstrate the above GitHub Actions workflow.</p>

<p>You can see this in-action with the two example Pull Requests of the repo.</p>
<ol>
<li><a href="https://github.com/maltfield/detect-malicious-unicode/pull/1">Malicious Bidi PR</a></li>
<li><a href="https://github.com/maltfield/detect-malicious-unicode/pull/2">Malicious Homoglyph PR</a></li>
</ol>
<p>The first demonstrates a PR attempting to merge malicious bidirectional unicode characters. The second demonstrates a PR attempting to merge malicious homoglypgh unicode characters.</p>
<h2>Improvements</h2>
<p>This section will outline some ways that this article&#39;s solution can be improved</p>
<h3>Too broad of unicode match</h3>
<p>The solution presented here broadly detects all non-ascii characters. It adds a comment to a PR whenever said PR&#39;s commits include unicode characters, and it logs a hexdump of these characters -- alerting a code reviewer to potential issues and permitting them to investigate further.</p>
<p>This could further be improved by narrowing the scope of the characters matched to only detect certain types of potential attacks, such as by detecting only:</p>
<ol>
<li>text directionality control characters</li>
<li>unterminaed bidi override characters within string literals and comments</li>
</ol>
<blockquote><p>ⓘ Note: In response to Trojan Source, <a href="https://github.blog/changelog/2021-10-31-warning-about-bidirectional-unicode-text/">GitHub started displaying warnings</a> when viewing source code that contains bidirectional unicode characters (<a href="https://github.com/nickboucher/trojan-source/blob/eaca01d01bfd588d805fbc711c39a1b3679ac484/Python/commenting-out.py">example</a>) in their WUI.</p>
<p>While this works great for reviewing code containing bidi-type attacks, it does not alert for code containing unicode homoglyph attacks (<a href="https://github.com/nickboucher/trojan-source/blob/eaca01d01bfd588d805fbc711c39a1b3679ac484/Python/homoglyph-function.py">example</a>).
</p></blockquote>
<h3>Non-Failing Action</h3>
<p>This workflow could be improved by actually exiting non-zero in a subsequent step (after the comment is made) to make it more obvious to the PR reviewer that the code should not be merged.</p>
<h2>Further Reading</h2>
<p>For more information about Trojan Source and its defenses, see:</p>
<ol>
<li>The <a href="https://www.trojansource.codes/trojan-source.pdf">Trojan Source research paper</a></li>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-42574">CVE-2021-42574</a> (bidi)</li>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-42694">CVE-2021-42694</a> (homoglyph)</li>
<li>The <a href="https://github.com/nickboucher/trojan-source">Trojan Source GitHub repo</a></li>
</ol>
<div itemtype="http://schema.org/Person" itemscope="" itemprop="author"><div><p><img src="https://tech.michaelaltfield.net/wp-content/uploads/sites/5/2019/04/100x100xavatar_square_150.jpg.pagespeed.ic.lvLST4AWRQ.jpg" width="100" height="100" alt="headshot of Michael Altfield" itemprop="image"/></p><div><div itemprop="description"><p>Hi, I’m Michael Altfield. I write articles about opsec, privacy, and devops <a href="https://michaelaltfield.net/biography/">➡</a></p>
<p><a href="https://michaelaltfield.net/biography/">About Michael</a></p>
</div></div></div></div></div></div>
  </body>
</html>
