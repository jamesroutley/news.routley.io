<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mediocregopher.com/posts/git-proxy">Original</a>
    <h1>Serving a website from a Git repo without cloning it</h1>
    
    <div id="readability-page-1" class="page">

    <header>

      <pre>                .%*.                                                        .-.
               .%@@@+.                                                .--=%@@@-
               =@@@@@@-                                         :--+@@@@@@@@@*
               *@%@@@@@%:                               :--=#@@@@@@@@@@@@#@@+
               @@::%@@@@@@-:                   :::-=%@@@@@@@@@@@@@@%#*-  :@*
              .@@   =@@@@@@@@@+-:::::::-=*@@@@@@@@@@@@@@@@@@@%##-        @@:
              #@#     +%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#*:              -@@
              #@-        *%@@@@@@@@@@@@@@@@@%%%#=                       %@=
              @@:             -=+++==     ..                            @@:
              @@        .               -@@@                           +@@
             #@%     =@@@@-            +@@@@#              *+          %@#
             #@-   -@@@@@@@.          +@@@@@%           .%@@@@=        @@:
             @@:  +@@@@@@@@@         +@+ +@@@         %@@@@@@@@@      -@@
             @@  *@%@*  :@@@        *@+  -@@@       %@@@@@@@@@@@#     @@@
            #@% %@ @%    %@@       *@*   .@@@     =@@@*@@   :@@@@     @@:
            %@:## *@+    :@@      :@@     @@@    %@@: @#     .@@@    .@@
            @@:.  @@:    .@@      @@      @@@   %@:  @@       @@%    @@%
            @@   -@@.    =@@     @@.      @@@  %@.  #@-       @@#    @@.
           %@%   +@@.    @@.    %@-       @@@ #@    @@.      :@@    -@@
           %@:   +@@+   .@%    #@=        @@@.@    *@@       +@+    @@*
           @@:   +@@%. .%%    *@+         @@@      %@@      -@#     @@
           @@    :@@@@@@%    :@@          @@%      %@@      @#     *@@
          %@@     #@@@@*     @@           @@%      %@@.    %@.     @@:
          @@:      ===:     @@.           @@%      %@@:  =@%.     .@@
          @@.              #@=            @@%      %@@%+%@#.      @@%
          @@              +@*             @@#      -@@@@@*       .@@
         %@@             :@@              @@#       %@@#:        =@@
         @@:            .@@               @@#        :           @@=
         @@.            @@.               @@#                   :@@
         @@            #@=                @@%                   %@%
        #@@           +@+                 #@%                  .@@
        @@:          =@#                  +@%                  =@%
        @@          :@%                   -@@                  @@+
        @@         .@@                    -@:                 -@@
       -@@         @%                     .:                  *@#
       @@*         #                                          @@.
       @@                                                    =@@
      .@@                                                    @@*
      .@@                                                   .@@
      *@@                                                   =@#
      @@*                                                   @@*
      @@                                                   -@@
     .@@                                                   +@*
     .@@                                                   @@-
     -@@                                                  =@@
     %@%                                                  #@*
     @@                                                   @@:
     @@                                                  +@@
    .@@                                                  %@+
    :@%                                                  @@.
    :@%                                                 *@%
    -@.                                                 %@=
    %@                                                  @@.
    @@                                                 *@%
    @@                                                 %@=
    @%                                                 @@:
   :@%                                                +@@
   :@*                =+-                             #@+
   :@:              .%@@@.                            @@-
   -@              =@@@@@#                           :@@
   =@             *@#.=@@%                           #@%
   *@            #@-  -@@%                           %@-
   @@           #@:   :@@%                           @@:
   @@          #%     .@@%               .#@@*      -@@
   @%         #%      .@@%              +@@@@@-     %@%
   @#        %@       :@@%            .@@@@@@@@     %@:
   @#       %@        :@@%           +@@% .@@@@     @@:
   @#      %@         :@@%          #@@:   :@@@    -@@
   @#     @@.         .@@@        .@@%     .@@@=   %@%
   @#    @@.          .@@@:      %@@-       @@@%   %@:
   @#   @@             @@@@    %@@@         *@@@   @@:
   @# .@@              @@@@@@@@@@=          :@@@   @@
   * @@@               :@@@@@@@@.           :@@@  *@@
.@@@@@%                 -@@@@@.             .@@@  @@=
@@@@@:                    ..                 @@@  @@.
-@%:                                         @@@  @@.
                                             @@@  @@
                                             -@@ =@@
                                             .@@ @@+
                                             .@@:@@.
                                              @@#@-
                                              @@@.
                                              +@-
                                               -
      </pre>

      <strong>mediocregopher</strong>&#39;s lil web corner
      </header>

    





<hr/>

<p>It&#39;s fairly common to use git repositories as a vehicle for serving websites. The webdev pushes their changes to some branch of a publicly available git repository, and some web server somewhere serves the current tip of that branch as the website. Github Pages would be the most famous example of this.</p>

<p>The domani reverse proxy also supports serving a website from a git repository. It previously did so by automatically cloning the repository locally, and periodically pulling changes down. This worked fine enough, but I figured it could be simplified further such that no local state is required except the current hash of the desired branch. This post is going to explain how this can be done by first guiding you through git&#39;s internals a bit.</p>

<p><a href="https://code.betamike.com/micropelago/domani" target="_blank">Domani</a></p>

<h2 id="git-branches-what-are-they">Git Branches: What Are They?</h2>

<p>The first thing to understand is what git branches actually are; they are a kind of &#34;ref&#34; (reference). Git tags are another kind of ref. A ref is nothing more than a name which points to an object hash, most likely a commit hash. You can easily inspect the refs of a git project, even without the git tool itself. For example, the current tip of the <code>main</code> branch can be found in the <code>.git/refs/heads/main</code> file:</p>

<pre><code># cat .git/refs/heads/main 
3651fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a
</code></pre>

<p>Ref files, and therefore branch files, are just plaintext files containing a single object hash. When the current tip of a branch is changed the only real change which takes place on the filesystem is to change the content of its ref file. At its core, git is actually quite a simple tool.</p>

<h2 id="git-objects-friend-or-foe">Git Objects: Friend or Foe?</h2>

<p>We&#39;ve established that a git branch points to a git object via the hash of that object, but what does that really mean?</p>

<p>There are four kinds of git object: blob, tree, commit, and tag. Regardless of the object&#39;s kind, it is stored in a file named after the SHA1 of the object within the <code>.git/objects</code> directory. Objects are always stored compressed using zlib, but it is their uncompressed form which is used for hashing.</p>

<p>This example computes the hash of the object pointed to from our previous example. You can see the output SHA1 is the same as the object&#39;s file name (with the first two characters used for a directory name, otherwise the <code>objects</code> directory would get too big.) Note the usage of <code>pigz -d</code>, which does the zlib decompression.</p>

<pre><code># cat .git/objects/36/51fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a | pigz -d | sha1sum 
3651fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a  -
</code></pre>

<p>The body of a git commit object is more or less plaintext, save for a single null byte which separates a header string from the object&#39;s contents, so we can just look at it directly:</p>

<pre><code># cat .git/objects/36/51fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a | pigz -d | tr &#39;\0&#39; &#39;\n&#39;
commit 264
tree 15b9b5c79989caee0ee45748e699c470b934ebc5
parent 498a33533f1a1cf00639e99cabcc11c25c330fd7
author Brian Picciano &lt;me@mediocregopher.com&gt; 1708196552 +0100
committer Brian Picciano &lt;me@mediocregopher.com&gt; 1708196552 +0100

Remove full gix project as a dependency
</code></pre>

<p>As we can see from the header, the object in question is a commit (but we knew that). The <code>264</code> denotes the size of the rest of the file after the header. Following the <code>264</code> would be a null byte, except that the null byte was replaced with a newline by the <code>tr &#39;\0&#39; &#39;\n&#39;</code>.</p>

<p>Most of the rest of the file should be familiar. The author is listed, along with the commit&#39;s description which makes up the tail of the file. The parent refers to the previous commit in the chain by its object hash. The tree is perhaps unfamiliar, unless you&#39;ve dove into git&#39;s internals before, but it is the most interesting bit for our purposes.</p>

<p>Contrary to how git usually presents commits to its users, git commits do not actually contain a diff from the previous to the current state of the repository. Each commit instead contains a reference to a tree, where each tree fully describes the state of the repository&#39;s files at that commit. What you see when you do something like <code>git show</code> is actually a diff generated in real-time between the previous and current trees.</p>

<p>As mentioned, trees are themselves another kind of git object, and so are referenced and queried just like commits. Let&#39;s look at the tree for our commit:</p>

<pre><code># cat .git/objects/15/b9b5c79989caee0ee45748e699c470b934ebc5 | pigz -d | tr &#39;\0&#39; &#39;\n&#39;
tree 535
100644 .gitignore
�_���/�j���jS$��
                �100644 Cargo.lock
��&#34;��AJ���?��100644 Cargo.toml

...(plus more garbage)
</code></pre>

<p>Welp, it looks like trees aren&#39;t so simple to look at as commits. Luckily git ships with a handy utility, <code>cat-file</code>, for directly viewing objects and pretty-printing their contents:</p>

<pre><code># git cat-file -p 15b9b5c79989caee0ee45748e699c470b934ebc5
100644 blob a45fb6cad22fb76a9ae0e3bb6a5324a90f800cf2    .gitignore
100644 blob 771896770dfaf8227fb0e1414ae5a5edd43fe6fc    Cargo.lock
100644 blob 8e3a31cf00a4a91661adc400afaf7c1d2abe5e39    Cargo.toml
100644 blob be3f7b28e564e7dd05eaf59d64adba1a4065ac0e    LICENSE.txt
100644 blob 0a39e5d12a2040e764b13924dd1955a61d10ff5f    README.md
100644 blob d161f2e1298586fd01e000cad6788f01e8ec446e    config-dev.yml.tpl
100644 blob 9dcb733174c2b7a8842062eeeeb204efb4f6d5b4    config.yml
100644 blob 39bacff615979221b0d50c43eca260b647f6fdd1    default.nix
100644 blob 0ce9e7605a533667693385bbee6fadacbad4a242    flake.lock
100644 blob 26134bf04deed36bcd3e61a24eb01f44cbdd405f    flake.nix
100644 blob e01adca51af5f42b438f0ff184070a7eebe32241    rust-toolchain.toml
100644 blob 77db547fb0079adc2f160af8f0ff50acfae98157    shell.nix
040000 tree 7dca9943ec53acb19678ac753b5ea6b8ae9b07aa    src
040000 tree df6d134b7c8ad6638a14db1d0e23b6686e34680e    static
</code></pre>

<p>Much better. We can see that the tree contains a list of entries, where each entry denotes a file (blob) or sub-directory (tree), along with the permissions and name of the file/sub-directory. Looking at the contents of the <code>static</code> sub-directory&#39;s object we find yet another tree:</p>

<pre><code># git cat-file -p df6d134b7c8ad6638a14db1d0e23b6686e34680e
100644 blob 3417794e08925a6a8164297575430f3a67a24c98    foo.gmi
100644 blob 96a73f5d009a32c50b3980117907808d51076082    foo.html
100644 blob a10841a0b027398ed8ebd79f3d81f7146f7613ad    index.gmi
100644 blob a4317bb1bf03636bf7c3ce1c22942e98576ad922    index.html
100644 blob e67581f93fbdcf2157773ea4b3e8cdb47810c172    penguin.jpg
040000 tree ad8bbea913647a1392cb3073259cc2638516c4c1    subdir
</code></pre>

<p>We can see from this how git trees are used to describe the full contents of a repository from just a single hash. If any file in the repository were to change then the hash of its associated blob object would change, which would change the associated entry in the tree the file falls in, which changes the hash of the tree&#39;s object, which changes the entry for the tree in the tree&#39;s parent directory, and so on. The change propagates all the way upward to the root tree object and its hash. This hash is then stored in a commit, which allows each commit to easily denote the entire state of the repository.</p>

<p>(This pattern of using a recursively hashed tree to uniquely identify an arbitrarily large amount of hierarchical data is called a Merkle tree.)</p>

<p>Anyway, let&#39;s get to the goods: how do we view the files themselves? Each file stored as a blob object. Let&#39;s check out the <code>foo.html</code> blob we found in our last example:</p>

<pre><code># cat .git/objects/34/17794e08925a6a8164297575430f3a67a24c98 | pigz -d | tr &#39;\0&#39; &#39;\n&#39;
blob 19
# FOO

This is foo
</code></pre>

<p>Blob objects are like commit objects, nice and easy to parse; just a header, a null byte, and then the content of the file as-is.</p>

<p>That&#39;s all there really is to git objects (ignoring tags, we don&#39;t need them today). Armed with this knowledge we can continue on towards our ultimate goal.</p>

<h2 id="remote-repositories">Remote Repositories</h2>

<p>When cloning a git repository you&#39;ve probably done something like:</p>

<pre><code>git clone https://code.betamike.com/micropelago/domani.git
</code></pre>

<p>Git then went and did a bunch of magical stuff, and afterwards the repo was fully cloned locally. But how did your git tool do that, given just a URL?</p>

<p>The answer is: it&#39;s complicated. There are actually two different protocols with which git might clone a repo over HTTPS: the smart protocol and the dumb protocol. The smart protocol is fast but requires a special purpose HTTP client in order to work. The dumb protocol is slower than the smart one, but it does not require a special HTTP client; it just serves files as they are without any special logic.</p>

<p>We&#39;re going to use the dumb protocol.</p>

<p>Let&#39;s return to the beginning and remember our actual goal here: we want to serve a website using the contents of a git repository, and specifically the contents of the tip of a specific branch of a git repository. To do this we need to know which commit is currently being pointed to by that branch. We can discover this by making a simple GET request:</p>

<pre><code># curl -sS &#39;https://code.betamike.com/micropelago/domani.git/info/refs&#39;
3651fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a        refs/heads/main
</code></pre>

<p>This repo only has a single branch (and no tags), so only a single line is returned. And would you look at that, it&#39;s the same commit hash as we saw in our local copy! Let&#39;s now query that commit object, and see how objects are queried in general:</p>

<pre><code># curl -sS &#39;https://code.betamike.com/micropelago/domani.git/objects/36/51fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a&#39; | pigz -d | tr &#39;\0&#39; &#39;\n&#39;
commit 264
tree 15b9b5c79989caee0ee45748e699c470b934ebc5
parent 498a33533f1a1cf00639e99cabcc11c25c330fd7
author Brian Picciano &lt;me@mediocregopher.com&gt; 1708196552 +0100
committer Brian Picciano &lt;me@mediocregopher.com&gt; 1708196552 +0100

Remove full gix project as a dependency
</code></pre>

<p>As you can see objects are returned in the exact same way they are stored locally. No surprises. While trees are difficult to look at without the <code>git cat-file</code> tool (which won&#39;t work for remote objects), blobs are still easy:</p>

<pre><code># curl -sS &#39;https://code.betamike.com/micropelago/domani.git/objects/34/17794e08925a6a8164297575430f3a67a24c98&#39; | pigz -d | tr &#39;\0&#39; &#39;\n&#39;
blob 19
# FOO

This is foo
</code></pre>

<p>It works exactly like the local git repo.</p>

<h2 id="putting-it-all-together">Putting It All Together</h2>

<p>Given all this, how would my special reverse proxy handle a request for <code>/static/foo.html</code>? Well, first it would need to query the repository server for the commit (using <code>/info/refs</code>), and then fetch the commit object in order to pull out the root tree hash, and then fetch the root tree object.</p>

<p>From there the server would need to look in the root tree object and check that it sees a tree entry called <code>static</code>, and fetch its tree object. The server would then check <code>static</code>&#39;s tree object for a blob entry called <code>foo.html</code>, and finally it would fetch that blob, passing its contents back as the response to the original request (after stripping off the git object header).</p>

<p>This sounds like a lot of steps to serve a single file, but there&#39;s two key optimizations which can be made. The first is to cache the root tree&#39;s hash in memory, which skips two lookups right at the beginning. The root tree&#39;s hash will only change when the latest commit of the branch changes, so it&#39;s enough to cache it in memory and have a separate background process periodically re-check the latest commit.</p>

<p>The second optimization is to cache tree objects in-memory using their hash as a key. The object identified by a hash never changes, so this cache is easy to manage, and by caching the tree objects in memory (perhaps with an LRU cache if memory usage is a concern) all round-trips to the remote server can be eliminated, save for the final round-trip for the file itself.</p>

<p>If you&#39;d like to see an example implementation of this idea you can check out my rust implementation for Domani:</p>

<p><a href="https://code.betamike.com/micropelago/domani/src/commit/e416a766682af3b78538854da09eee62baaf3762/src/origin/git.rs" target="_blank">git.rs</a></p>

<p>Note that I was able to take advantage of the excellent gix crate to help me with decoding git objects. If your language of choice doesn&#39;t have a git object parsing library available you&#39;ll have to parse the objects manually, but honestly it shouldn&#39;t be too difficult anyway.</p>

<p>Finally, here&#39;s a sample website being served using this technique:</p>

<p><a href="https://test.domani.micropelago.net/" target="_blank">Link</a></p>

<p>That&#39;s it! Even if this is a pretty niche use-case and doesn&#39;t change the world, I hope you still found it useful as an introduction to git&#39;s internals, and perhaps as a jumping off point for your own ideas of how git can be abused to do interesting things.</p>


<p><em>
  Published 2024-02-17
</em></p>



<hr/>

<p>
  This site can also be accessed via the gemini protocol:
  <a href="gemini://mediocregopher.com/">
    gemini://mediocregopher.com/
  </a>
</p>
<p>
  <a href="http://harihareswara.net/posts/gemspace-tour">What is gemini?</a>
</p>





  

  

  

  



</div>
  </body>
</html>
