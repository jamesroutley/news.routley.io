<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/maxwellpeterson/kafka-worker">Original</a>
    <h1>Show HN: Kafka 0.8.0 on Cloudflare Workers</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">A Kafka 0.8.0 broker implementation on top of Cloudflare Workers and Durable Objects. This broker supports 4 client-facing APIs:</p>
<ol dir="auto">
<li><a href="https://kafka.apache.org/protocol.html#The_Messages_Produce" rel="nofollow">Produce API</a> (Version: 0)</li>
<li><a href="https://kafka.apache.org/protocol.html#The_Messages_Fetch" rel="nofollow">Fetch API</a> (Version: 0)</li>
<li><a href="https://kafka.apache.org/protocol.html#The_Messages_ListOffsets" rel="nofollow">ListOffsets API</a> (Version: 0)</li>
<li><a href="https://kafka.apache.org/protocol.html#The_Messages_Metadata" rel="nofollow">Metadata API</a> (Version: 0)</li>
</ol>
<p dir="auto">No other APIs (such as internal APIs used for administrative purposes) or API versions are supported. This project is a relatively simple proof of concept, and not intended to be used for anything serious.</p>
<h2 dir="auto"><a id="user-content-local-demo" aria-hidden="true" href="#local-demo"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Local Demo</h2>
<p dir="auto">For a fully local demo, no Cloudflare account required, check out the <a href="https://github.com/maxwellpeterson/kafka-worker-demo"><code>kafka-worker-demo</code></a> project.</p>
<h2 dir="auto"><a id="user-content-websocket-shim" aria-hidden="true" href="#websocket-shim"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WebSocket Shim</h2>
<p dir="auto">The Kafka protocol uses TCP. Cloudflare Workers does not support plain TCP connections (at least until <a href="https://blog.cloudflare.com/introducing-socket-workers/" rel="nofollow">Socket Workers</a> is available), but it does support WebSocket connections. To make this work, we need to frame Kafka protocol messages sent over TCP into WebSocket messages. The <a href="https://github.com/maxwellpeterson/kafka-websocket-shim"><code>kafka-websocket-shim</code></a> project implements this functionality, and must be used to connect to this broker.</p>
<h2 dir="auto"><a id="user-content-design" aria-hidden="true" href="#design"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Design</h2>
<p dir="auto">If you are unfamiliar with Kafka&#39;s design philosophy, I would recommend reading <a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying" rel="nofollow">this article by Jay Kreps</a> first.</p>
<p dir="auto">Kafka 0.8.0 dates all the way back to 2013, which was a much simpler era. There are only 2 types of state that we need to keep track of: records stored in partitions, and information about which topics and partitions exist. In this design, a Durable Object is created for each partition, and a single Durable Object is created for topic and partition information (this is referred to as the &#34;global cluster DO&#34;). Just like normal Kafka, writes to separate partitions are independent operations, and records within each partition are guaranteed to be read in the same order they were written.</p>
<p dir="auto">Each client connection is handled by a &#34;gateway worker&#34; that runs in the Cloudflare data center (also referred to as &#34;colo&#34;) closest to the client&#39;s location. The gateway worker handles requests from the client, and makes internal subrequests to partition DOs and the global cluster DO as needed. Each DO contacted by the gateway worker may be located in the same data center as the gateway worker instance (the ideal case), or may be located somewhere else.</p>
<h3 dir="auto"><a id="user-content-what-about-replication-what-about-leadership-election" aria-hidden="true" href="#what-about-replication-what-about-leadership-election"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What about replication? What about leadership election?</h3>
<p dir="auto">There is none, at least not in the application code. The point of using Durable Objects here is that we can offload these complexities onto the infrastructure layer, and keep our application code focused and minimal. As described in the <a href="https://blog.cloudflare.com/introducing-workers-durable-objects/" rel="nofollow">initial blog post</a>, this is the serverless philosophy applied to persistent state. Replication and strong consistency mechanisms are implemented internally, and all we need to do is use the Durable Object API to reap these benefits. Building a Kafka broker without implementing replication and leadership election feels like cheating, but also makes this a much more tractable project.</p>
<p dir="auto">In this design, each deployment has one logical broker that spans Cloudflare&#39;s entire network. The hostname and port of this broker is the hostname and port of the gateway worker. Translated to the traditional Kafka model, this broker is the leader node for all partitions, and all partitions have zero replica nodes and zero ISR nodes. Again, there is still replication happening, it&#39;s just not visible to the broker implementation.</p>
<h2 dir="auto"><a id="user-content-map" aria-hidden="true" href="#map"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Map</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/maxwellpeterson/kafka-worker/blob/main/map.png"><img src="https://github.com/maxwellpeterson/kafka-worker/raw/main/map.png" alt="kafka worker map"/></a></p>
</article>
          </div></div>
  </body>
</html>
