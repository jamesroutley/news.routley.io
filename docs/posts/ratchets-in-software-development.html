<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://qntm.org/ratchet">Original</a>
    <h1>Ratchets in Software Development</h1>
    
    <div id="readability-page-1" class="page">
    <div>
      <div>
        <div>
          <!-- <h1 class="page__h1">
            <a href="/">
              Things Of Interest            </a>
          </h1> -->

          

          <h2>
            Ratchets in software development             
          </h2>

           
            
           
        </div>
      </div>
    </div>

     

    <div>
      <div>
         

        <div>
          <p>So there&#39;s a thing we use at work which I call a <i>ratchet</i>.</p>
<p>In our codebase, there are &#34;patterns&#34; which we used to use all the time, but we decided to stop using them, but removing all of the existing instances at once is too much work. We want to remove all of these instances eventually, and in the meantime we want to make absolutely sure that they don&#39;t proliferate via copy-and-paste. So what we have is a ratchet, a script which runs at source code linting time and counts all of these &#34;pattern&#34; instances across the codebase. If the script counts too many instances, it raises an error, explaining why we don&#39;t want more of that &#34;pattern&#34;. If it counts too few, it also raises an error, this time congratulating you and prompting you to lower the expected number.</p>
<p>This script is intentionally extremely simple. The expected numbers are hard-coded in the script itself. The &#34;patterns&#34; for which it scans our code are not advanced, abstract Gang of Four-style <a href="https://en.wikipedia.org/wiki/Software_design_pattern">software design patterns</a> but plain text strings.</p>
<p>At the time of writing, the strings are mostly the names of methods whose usage we frown upon. The methods in question aren&#39;t our own. They are public methods of first- and third-party libraries we use. We can&#39;t apply deprecation warnings upstream. Nor would we. These are perfectly acceptable and normal methods for people in general to use. It&#39;s only within the scope of our own specific codebase that we&#39;ve decided to try to quit using them.</p>
<p>The script carries out <em>extremely</em> basic string matching. There is no source code parsing. So there are some obvious edge cases. What if someone wants to talk about <var>THE FORBIDDEN METHOD</var> in a comment, say? What if it shows up in a string literal? Answer:</p>
<ol>
<li>[shrug]</li>
<li>It hasn&#39;t come up</li>
<li>I guess we&#39;d just raise the ratchet by 1</li>
<li>Oh, but make sure the scanning script doesn&#39;t scan itself</li>
</ol>
<p>One important observation is that this technique does nothing to actively encourage the removal of these old &#34;patterns&#34;. Those remaining 67 or so calls to <var>THE FORBIDDEN METHOD</var> have been kind of lingering. But perhaps that&#39;s a different problem.</p>
<p>Sometimes, due to extenuating circumstances, we have had to manually raise the count again. This is something we try to avoid, though.</p>
<p>In the very near future I plan to upgrade the script to support regular expression matches as well as simple string matches. It currently isn&#39;t very good at raising sensible error messages — you have to read the explanatory comments in the script&#39;s source code — and it might be nice if it could ratchet the expected counts downwards automatically instead of demanding that the developer do it. In theory, this ratchet script is not a long walk from a conventional source code linter, and it might be nice if it had a more consistent, flexible interface for adding new heuristics, configuring which source files to inspect or ignore, automatically suggesting fixed code, and so on, and so on...</p>
<p>But on the other hand, I am as conscious as anybody that it would be incredibly easy to divert a huge amount of pointless time and energy into maintaining and improving a &#34;simple&#34; tool of this kind. I think the specifics of our ratchet script (whose content, no, I will not be sharing) are less important here than the generic technique of using basic text scans at linting time to prevent the proliferation of deprecated practices through a codebase.</p>
<p>In general, I dislike having bad practice left over in our codebase. This can be difficult to avoid, but is very misleading for newcomers, and for interlopers — that is, experienced developers from other teams who open pull requests with the best of intentions. &#34;Ah, I see you have diligently followed the example set by your predecessors. Well done, and bad luck. Changes requested.&#34; What this technique does is automate what was previously a manual process of me saying &#34;don&#39;t do this, we&#39;ve stopped doing this&#34; in code review. Or forgetting to say it. Or missing the changes entirely, due to the newcomer having the audacity to request their review from someone else.</p>
<p>Another pitfall which I&#39;ve spotted is that it would be easy to abuse this technique to enforce unnecessarily strict &#34;standards&#34; on a development team who really ought to be allowed some creative freedom. Sometimes it&#39;s okay to say &#34;No&#34; to adding a new rule.</p>
<h4>*</h4>
<p>This felt like a really basic technique when we first adopted it, but on the other hand it&#39;s not a standard practice I&#39;ve heard discussed elsewhere in the same way that, say, linting, unit testing, code coverage measurement and other techniques are. When I asked people about this online, quite a few people found the idea to be novel and expressed an interest in adopting it. Meanwhile, an equal number of people said that they already do something almost exactly like this, or applied a similar technique to the domains of code coverage or performance.</p>
<p>Anyway, it seems to work okay.</p>        </div>

         
          
         
      </div>
    </div>

          <div>
        

        

        <div>
          <h3>Discussion (14)</h3>

                      <div id="komment6199bd453b524">
              <h4>
                <a href="#komment6199bd453b524">2021-11-21 03:30:13</a>
                by Josh:
              </h4>

              <div>What are the methods in question? (Interested in what kinds of purposes this gets applied to.)</div>

               
            </div>
                      <div id="komment6199bd4be06bf">
              <h4>
                <a href="#komment6199bd4be06bf">2021-11-21 03:30:19</a>
                by Max:
              </h4>

              <div>What&#39;s the advantage of counting instances over simply forbidding to add new usages of the pattern (by looking at `git diff` output or equivalent)</div>

               
            </div>
                      <div id="komment6199cb8665a4f">
              <h4>
                <a href="#komment6199cb8665a4f">2021-11-21 04:31:02</a>
                by Emily:
              </h4>

              <div>Max:

&gt; What this technique does is automate what was previously a manual process of me saying &#34;don&#39;t do this, we&#39;ve stopped doing this&#34; in code review.

Or, more likely, the &#34;eh, that&#39;s ugly, but I guess it works&#34; that you&#39;d probably get from me and most of the teams I&#39;ve worked with unless you did something *really* egregious.</div>

               
            </div>
                      <div id="komment619a08d22926a">
              <h4>
                <a href="#komment619a08d22926a">2021-11-21 08:52:34</a>
                by skztr:
              </h4>

              <div>I don&#39;t recall the specifics, but I do recall at one job we ended up adding a hook that would reject commits which added code in a particularly often-used-but-disliked manner. The hook could be bypassed by including a line in the commit message saying &#34;I understand that &lt;the thing we were discouraging&gt; is frowned upon, but I have a very good reason in this case:&#34;

This was done with an exact match in the commit message, so sorry to anyone who had already explained, but using sightly different introductory phrasing.</div>

               
            </div>
                      <div id="komment619a47a18eb7b">
              <h4>
                <a href="#komment619a47a18eb7b">2021-11-21 13:20:33</a>
                by Tim McCormack:
              </h4>

              <div>Max: Diff linting is more complex and fragile. We used to use it at work, and switched to amnesty linting: Every existing instance was given a line-end comment saying &#34;this is OK for now&#34;, and after that any unannotated instance was considered a lint failure.

We had to write that annotation tool, though: https://github.com/edx/edx-lint#using-lint-amnesty</div>

               
            </div>
                      <div id="komment619b715b41dad">
              <h4>
                <a href="#komment619b715b41dad">2021-11-22 10:30:51</a>
                by Spwack:
              </h4>

              <div>When I saw the name of this post, and read the first few lines, I thought this was going to go in the exact opposite direction. At my workplace, we have format standards that sometimes conflict, are half-finished, have been changed at some point in the past, or are just generally rubbish. And the production of format standards only ever &#34;ratchets&#34; in one direction. Nobody wants to be the architect to promote *less* rules, what kind of cowboy would that make them look like!? No, the only &#34;safe&#34; option is to keep all of the existing rules, and occasionally add more. Never remove. It breaks my brain.

Anyway, you&#39;ve been complained at now about something tangentially (at best) to the post. Congratulations!

((Is there an equivalent to &#34;tangentially&#34; for the other trig functions?))</div>

               
            </div>
                      <div id="komment619e08419078e">
              <h4>
                <a href="#komment619e08419078e">2021-11-24 09:39:13</a>
                by LiterallyMechanical:
              </h4>

              <div>@Spwack

&gt; ((Is there an equivalent to &#34;tangentially&#34; for the other trig functions?))

Hyperbolically?</div>

               
            </div>
                      <div id="komment61a302e4ad521">
              <h4>
                <a href="#komment61a302e4ad521">2021-11-28 04:17:40</a>
                by Jake:
              </h4>

              <div>Bikeshedding: There&#39;s a language I haven&#39;t really tried, which is specifically for the concept of matching code patterns in a language - semgrep https://github.com/returntocorp/semgrep.

Instead of Sam&#39;s amnesty count, it has the feature skztr mentioned - the ability to exclude individual lines from the linting process.

OTOH, it&#39;s not familiar tech, and anything you write in it will remain obscure juju to anyone unfamiliar with it. I side with a well-understood/well-understandable custom tool over an unfamiliar rules engine any day.</div>

               
            </div>
                      <div id="komment61a4415d4974f">
              <h4>
                <a href="#komment61a4415d4974f">2021-11-29 02:56:29</a>
                by g:
              </h4>

              <div>Spwack, &#34;tangentially&#34; is only (ahahaha) tangentially related to the trigonometric function called tangent. A line is tangent to a curve if it meets it while going in the same direction. This typically means that (1) it doesn&#39;t then go _inside_ whatever region is bounded by the curve, and (2) after meeting it it then diverges again. Something is &#34;tangential&#34; when it metaphorically behaves in this way.

I think the tangent _function_ is called that because it answers the following question: if you start at some point on a unit circle, and proceed along a tangent from there until the line segment you&#39;ve drawn subtends a given angle at the centre of the circle, how long is that line segment?</div>

               
            </div>
                      <div id="komment61bc20539c699">
              <h4>
                <a href="#komment61bc20539c699">2021-12-17 05:29:55</a>
                by FeepingCreature:
              </h4>

              <div>We use D at work. D has a way of annotating a symbol (function, class...) as deprecated. Deprecated means you can still use it, but the compiler will print a warning. There&#39;s a switch to turn those warnings into errors. That switch is usually turned on on newer projects.

Whenever we need to urgently upgrade a project, and something gets deprecated but we can&#39;t fix it, we can just turn that switch off and accept the warnings. But that&#39;s kind of a mark of shame.</div>

               
            </div>
                      <div id="komment61bc3cde1cb4c">
              <h4>
                <a href="#komment61bc3cde1cb4c">2021-12-17 07:31:42</a>
                by Ingvar:
              </h4>

              <div>In a pretty substantial code (well, technically config) base ata previous job, it had started as a free-for-all and we&#39;d all talked about &#34;would it not be nice if this was all lint-clean and enforced at PR time?&#34;. But, the problem with that was that almost all existing code failed.

So, I wrote a small lint script that always ran the linter (so you could get reports), but checked the  file name against a list of regular expressions and if it matched, it simply didn&#39;t trigger the &#34;nope, you can&#39;t do this&#34; failure in the PR review tool.

Then, as we cleaned up subdirectory by subdirectory, we could just refine the list of regexps, so that any changes in an already clean part would need to also be clean.

Now, this works on a granularity down to &#34;file-sized&#34;, but no smaller. So the applicability certainly would vary from individual to individual.</div>

               
            </div>
                      <div id="komment61d8e6bddf7e9">
              <h4>
                <a href="#komment61d8e6bddf7e9">2022-01-08 01:19:57</a>
                by callmesalticidae:
              </h4>

              <div>I was a little more than halfway through before I realized this post was exactly what it appeared to be, and wasn&#39;t a stealth horror story.</div>

               
            </div>
                      <div id="komment62302b7c6f48c">
              <h4>
                <a href="#komment62302b7c6f48c">2022-03-15 06:00:28</a>
                by Curt J. Sampson:
              </h4>

              <div>This is a great idea, and well written up. The particularly good points are that it&#39;s properly seen as an assist to help the developers do the right thing that they already want (and know, at least as a community if not always as individuals) to do, that it&#39;s not taken too far, and in particular that there&#39;s an understanding of the potential for abuse.

I&#39;ve seen far too many good guidelines that turn into terrible rules that make the code worse, with developers seemingly helpless in the face of them. Formatting rules are particularly prone to this, with the original goal (make the code more readable to other developers) often completely lost to, &#34;it&#39;s better to have it consistent to whatever a limited degree an automated code formatter is capable, regardless of readability.&#34;</div>

               
            </div>
                      <div id="komment64837d758dab2">
              <h4>
                <a href="#komment64837d758dab2">2023-06-09 20:28:53</a>
                by J:
              </h4>

              <div>I&#39;ve found this extremely late and in the context of the recent &#34;someone bumped the counter by one&#34; tweet, but I&#39;ve had something similar in a project for a long time but it works by checking the count in the current branch is no greater than the count in the merge target. Less chance for misuse, also for the rare person who really does get to skip CI to break it for everyone else.</div>

               
            </div>
           

                      

            

            <!-- comment -->
           
        </div><!-- comments -->
      </div>
     

    
  
</div>
  </body>
</html>
