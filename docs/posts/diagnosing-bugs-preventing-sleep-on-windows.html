<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://peteronprogramming.wordpress.com/2025/04/02/diagnosing-bugs-preventing-sleep-on-windows/">Original</a>
    <h1>Diagnosing bugs preventing sleep on Windows</h1>
    
    <div id="readability-page-1" class="page"><article id="post-1021">
	<!-- .entry-header -->

	
	
	<div>
		<p><em>TL;DR: Diagnosing programs causing insomnia is quite straightforward on Windows.</em></p>
<p>My employer has a policy set for Windows machines which locks each computer automatically after some inactivity. One of my colleagues noticed that if they have recent builds of our product running in the background, this auto-locking does not take effect. I was asked to investigate.</p>

<p>The bug itself got pretty low priority, as at first glance the phenomenon does not seem to cause that much trouble. I did not know anything about how all this works on Windows, but I had a hunch that if the lock screen is being prevented, chances are that the computer going to sleep gets the same treatment. This is a much bigger issue, as it might have a huge impact on the battery life of notebooks.</p>
<h2>Breakpoints</h2>
<p>The repro was pretty straightforward (launch the program, then wait <em>X</em> minutes, and note how the lock screen did not appear), and I also had the source code for the software being investigated, so my first intuition was to put a breakpoint on the functions or function that lets you interact with this functionality of Windows. The first search result was a function named <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setthreadexecutionstate" target="_blank"><span>SetThreadExecutionState</span></a>: </p>
<blockquote><p>Enables an application to inform the system that it is in use, thereby preventing the system from entering sleep or turning off the display while the application is running.</p></blockquote>
<p>I placed a breakpoint at this function, but there were no hits at all.</p>
<p>Okay, the next search result pointed me to <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-powercreaterequest" target="_blank"><span>PowerCreateRequest</span></a> and <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-powersetrequest" target="_blank"><span>PowerSetRequest</span></a>. The basic idea of this API is that you create a power request object, and increment/decrement a reference count for a given type of request, as required by your specific use case.</p>
<p>Placing breakpoints at these functions revealed the following sequence of events:</p>
<ol>
<li><span>PowerCreateRequest</span> was called when the application launched, and the UI is displayed</li>
<li>Shortly after, <span>PowerSetRequest</span> was called with <span>PowerRequestDisplayRequired</span></li>
<li>There were no further calls to any of these functions during the regular operation of the program</li>
<li>When exiting, <span>PowerClearRequest</span> was called</li>
</ol>
<p>So in summary, someone is requesting that the display should <em>not</em> be turned off, and clings on to this request up until the program is exited. The call stack for the power request creation looked like this (highly simplified):</p>

<p>The presence of the <span>libcef.dll</span> module narrowed this down greatly, as it meant that some sort of web content was to blame (the product makes use of <a href="https://en.wikipedia.org/wiki/Chromium_Embedded_Framework" target="_blank">CEF</a>). At this point, this bug seemed like an easy one: recently, a new onboarding feature was merged into the codebase, which displays a little floating “what’s new in the software” type of dialog, including a small video snippet for demonstration purposes.</p>
<p><em>Ah, maybe the colleague overlooked this detail when entering the bug. I should close this dialog, surely the issue will go away then</em> – I thought. To my surprise, even when I closed this dialog, the issue did <em>not</em> go away.</p>
<h2>Sometimes, what you don’t see is what you (still) get</h2>
<p>At this point, my PTSD started to kick in: maybe this is one of those super-exotic CEF bugs that practically no one encountered other than you before, takes ages to debug, and then randomly disappears when you upgrade to a future version (been there, done that). Fortunately, I had a lucky hunch: what if the code – for whatever reason – does not actually close this dialog, but rather, simply hides it?</p>
<p>For reasons I’ll not detail here, in this specific case it was easier to test this theory with <a href="https://learn.microsoft.com/en-us/visualstudio/debugger/introducing-spy-increment?view=vs-2022" target="_blank">Spy++</a> (even though I had full access to the source code):</p>
<ol>
<li>I located the window in question with the <em>Find Window</em> tool</li>
<li>I “closed” the target window</li>
<li>In Spy++, I hit the <em>Refresh</em> button</li>
</ol>
<p>Instead of Spy++ saying <em>Invalid window</em>, the window still existed, confirming my theory. I notified the team which introduced this onboarding feature, and they fixed this bug shortly.</p>
<h2>Other tools</h2>
<p>Even though for this relatively simple case breakpoints were more than adequate, there could be situations where the number of power requests would make this kind of approach unfeasible. Fortunately, there are some alternatives.</p>
<p><a href="https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/powercfg-command-line-options" target="_blank">powercfg</a> is included in Windows out-of-the-box, and can give you a glance at which programs have active power requests (this, however, is only a snapshot):</p>
<div id="gist136932049">
    <div translate="no" data-color-mode="light" data-light-theme="light">
      <div>
        <div>
  <div id="file-powercfg-txt">
    
    <div itemprop="text" tabindex="0" role="region" aria-label="powercfg.txt content, created by Donpedro13 on 09:04AM on March 19.">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span></template>

  <table data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-path="powercfg.txt">
        <tbody><tr>
          <td id="file-powercfg-txt-L1" data-line-number="1"></td>
          <td id="file-powercfg-txt-LC1">&gt; powercfg /requests</td>
        </tr>
        <tr>
          <td id="file-powercfg-txt-L2" data-line-number="2"></td>
          <td id="file-powercfg-txt-LC2">
</td>
        </tr>
        <tr>
          <td id="file-powercfg-txt-L3" data-line-number="3"></td>
          <td id="file-powercfg-txt-LC3">DISPLAY:</td>
        </tr>
        <tr>
          <td id="file-powercfg-txt-L4" data-line-number="4"></td>
          <td id="file-powercfg-txt-LC4">[PROCESS] \Device\HarddiskVolume2\Product.exe</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>If you install the <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk" target="_blank">WDK</a>, there is a useful utility called <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/pwrtest" target="_blank">pwrtest</a>. With the “requests scenario” you can monitor the lifecycle of power requests live (still no call stacks, though):</p>
<div id="gist136932039">
    <div translate="no" data-color-mode="light" data-light-theme="light">
      <div>
        <div>
  <div id="file-pwrtest-txt">
    
    <div itemprop="text" tabindex="0" role="region" aria-label="pwrtest.txt content, created by Donpedro13 on 09:03AM on March 19.">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span></template>

  <table data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-path="pwrtest.txt">
        <tbody><tr>
          <td id="file-pwrtest-txt-L1" data-line-number="1"></td>
          <td id="file-pwrtest-txt-LC1">&gt; pwrtest.exe /requests</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L2" data-line-number="2"></td>
          <td id="file-pwrtest-txt-LC2">
</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L3" data-line-number="3"></td>
          <td id="file-pwrtest-txt-LC3">15:52:56 Create: \Device\HarddiskVolume2\Product.exe</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L4" data-line-number="4"></td>
          <td id="file-pwrtest-txt-LC4">  Type:Application  ProcessID:34712  SessionID:14</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L5" data-line-number="5"></td>
          <td id="file-pwrtest-txt-LC5">  Allow: System Display AwayMode PerfBoost ExecutionRequired FullScreenVideo</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L6" data-line-number="6"></td>
          <td id="file-pwrtest-txt-LC6">  Count: System:0  Display:0  AwayMode:0  PerfBoost:0</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L7" data-line-number="7"></td>
          <td id="file-pwrtest-txt-LC7">         ExecutionRequired:0  FullScreenVideo:0</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L8" data-line-number="8"></td>
          <td id="file-pwrtest-txt-LC8">-------------------------------------------------------------------------------</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L9" data-line-number="9"></td>
          <td id="file-pwrtest-txt-LC9">15:52:56 Change: \Device\HarddiskVolume2\Product.exe</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L10" data-line-number="10"></td>
          <td id="file-pwrtest-txt-LC10">  Count: System:0  *Display:1  AwayMode:0  PerfBoost:0</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L11" data-line-number="11"></td>
          <td id="file-pwrtest-txt-LC11">         ExecutionRequired:0  FullScreenVideo:0</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L12" data-line-number="12"></td>
          <td id="file-pwrtest-txt-LC12">-------------------------------------------------------------------------------</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L13" data-line-number="13"></td>
          <td id="file-pwrtest-txt-LC13">15:53:24 Change: \Device\HarddiskVolume2\Product.exe</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L14" data-line-number="14"></td>
          <td id="file-pwrtest-txt-LC14">  Count: System:0  Display:0  AwayMode:0  PerfBoost:0</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L15" data-line-number="15"></td>
          <td id="file-pwrtest-txt-LC15">         ExecutionRequired:0  FullScreenVideo:0</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L16" data-line-number="16"></td>
          <td id="file-pwrtest-txt-LC16">-------------------------------------------------------------------------------</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L17" data-line-number="17"></td>
          <td id="file-pwrtest-txt-LC17">15:53:24 Close:  \Device\HarddiskVolume2\Product.exe</td>
        </tr>
        <tr>
          <td id="file-pwrtest-txt-L18" data-line-number="18"></td>
          <td id="file-pwrtest-txt-LC18">-------------------------------------------------------------------------------</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<p>And last but not least, you can use ETW and the <span>Microsoft-Windows-Kernel-Power</span> provider to get all the data you need with call stacks:</p>
<div id="gist137098579">
    <div translate="no" data-color-mode="light" data-light-theme="light">
      <div>
        <div>
  <div id="file-power_etw-bat">
    
    <div itemprop="text" tabindex="0" role="region" aria-label="power_etw.bat content, created by Donpedro13 on 02:46PM on March 28.">

        
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path>
</svg>
</span></template>

  <table data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-path="power_etw.bat">
        <tbody><tr>
          <td id="file-power_etw-bat-L1" data-line-number="1"></td>
          <td id="file-power_etw-bat-LC1">xperf -on PROC_THREAD+LOADER -start user -on Microsoft-Windows-Kernel-Power:::&#39;stack&#39;</td>
        </tr>
        <tr>
          <td id="file-power_etw-bat-L2" data-line-number="2"></td>
          <td id="file-power_etw-bat-LC2">@rem Repro the problem here</td>
        </tr>
        <tr>
          <td id="file-power_etw-bat-L3" data-line-number="3"></td>
          <td id="file-power_etw-bat-LC3">xperf -d k.etl</td>
        </tr>
        <tr>
          <td id="file-power_etw-bat-L4" data-line-number="4"></td>
          <td id="file-power_etw-bat-LC4">xperf -stop user</td>
        </tr>
        <tr>
          <td id="file-power_etw-bat-L5" data-line-number="5"></td>
          <td id="file-power_etw-bat-LC5">xperf -merge k.etl C:\user.etl merged.etl</td>
        </tr>
  </tbody></table>
</div>


    </div>

  </div>
</div>

      </div>
      
    </div>
</div>

<figure><img src="https://poprcdn.blob.core.windows.net/cdn/br/power_etw.png"/><figcaption>Call stacks!</figcaption></figure>

<div>
	<p><img alt="" src="https://2.gravatar.com/avatar/bebb7f4d5430f4884d23b5f1eb150797f2cf162636d91df4487858d0bf2dafa5?s=42&amp;d=identicon&amp;r=G" srcset="https://2.gravatar.com/avatar/bebb7f4d5430f4884d23b5f1eb150797f2cf162636d91df4487858d0bf2dafa5?s=42&amp;d=identicon&amp;r=G 1x, https://2.gravatar.com/avatar/bebb7f4d5430f4884d23b5f1eb150797f2cf162636d91df4487858d0bf2dafa5?s=63&amp;d=identicon&amp;r=G 1.5x, https://2.gravatar.com/avatar/bebb7f4d5430f4884d23b5f1eb150797f2cf162636d91df4487858d0bf2dafa5?s=84&amp;d=identicon&amp;r=G 2x, https://2.gravatar.com/avatar/bebb7f4d5430f4884d23b5f1eb150797f2cf162636d91df4487858d0bf2dafa5?s=126&amp;d=identicon&amp;r=G 3x, https://2.gravatar.com/avatar/bebb7f4d5430f4884d23b5f1eb150797f2cf162636d91df4487858d0bf2dafa5?s=168&amp;d=identicon&amp;r=G 4x" height="42" width="42" loading="lazy" decoding="async"/>	</p><!-- .author-avatar -->

	<!-- .author-description -->
</div><!-- .author-info -->
	</div><!-- .entry-content -->

	<!-- .entry-footer -->
</article></div>
  </body>
</html>
