<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/gojue/ecapture">Original</a>
    <h1>Capturing Linux SSL/TLS plaintext without a CA certificate using eBPF</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://interjectedfuture.com/gojue/ecapture/blob/master/images/ecapture-logo-400x400.png"><img src="https://interjectedfuture.com/gojue/ecapture/raw/master/images/ecapture-logo-400x400.png" alt=""/></a></p>
<p dir="auto"><a href="https://interjectedfuture.com/gojue/ecapture/blob/master/README_CN.md">中文介绍</a> | English | <a href="https://interjectedfuture.com/gojue/ecapture/blob/master/README_JA.md">日本語</a></p>
<p dir="auto"><a href="https://github.com/gojue/ecapture"><img src="https://camo.githubusercontent.com/270192c3bdf7383aaf60e58e1257325923ad8a10e93ce348b011438b31e0e7b9/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f73746172732f676f6a75652f65636170747572652e7376673f6c6162656c3d5374617273266c6f676f3d676974687562" alt="GitHub stars" data-canonical-src="https://img.shields.io/github/stars/gojue/ecapture.svg?label=Stars&amp;logo=github"/></a>
<a href="https://github.com/gojue/ecapture"><img src="https://camo.githubusercontent.com/2a1ba577b9b9d6298b29c621597f4adf0705ef187c20677eb75d246494aa1cd5/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f666f726b732f676f6a75652f65636170747572653f6c6162656c3d466f726b73266c6f676f3d676974687562" alt="GitHub forks" data-canonical-src="https://img.shields.io/github/forks/gojue/ecapture?label=Forks&amp;logo=github"/></a>
<a href="https://github.com/gojue/ecapture/actions/workflows/code-analysis.yml"><img src="https://github.com/gojue/ecapture/actions/workflows/codeql-analysis.yml/badge.svg" alt="CI"/></a>
<a href="https://github.com/gojue/ecapture/releases"><img src="https://camo.githubusercontent.com/9441198ce3414f84ecb7fca20a61c221fe44be49f1b2b1acff425972a88a2486/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f762f72656c656173652f676f6a75652f65636170747572653f646973706c61795f6e616d653d74616726696e636c7564655f70726572656c656173657326736f72743d73656d766572" alt="Github Version" data-canonical-src="https://img.shields.io/github/v/release/gojue/ecapture?display_name=tag&amp;include_prereleases&amp;sort=semver"/></a></p>
<div dir="auto"><h3 tabindex="-1" dir="auto">eCapture(旁观者): capture SSL/TLS text content without a CA certificate using eBPF.</h3><a id="user-content-ecapture旁观者-capture-ssltls-text-content-without-a-ca-certificate-using-ebpf" aria-label="Permalink: eCapture(旁观者): capture SSL/TLS text content without a CA certificate using eBPF." href="#ecapture旁观者-capture-ssltls-text-content-without-a-ca-certificate-using-ebpf"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<blockquote>
<p dir="auto"><strong>Note</strong></p>
<p dir="auto">Supports Linux/Android kernel versions x86_64 4.18 and above, <strong>aarch64 5.5</strong> and above.
Does not support Windows and macOS system.</p>
</blockquote>
<hr/>

<ul dir="auto">
<li><a href="#how-ecapture-works">How eCapture works</a></li>
<li><a href="#ecapture-user-manual">eCapture User Manual</a></li>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#ecapture-architecture">eCapture Architecture</a></li>
<li><a href="#whats-ebpf">What&#39;s eBPF</a></li>
<li><a href="#how-to-compile">How to compile</a></li>
<li><a href="#contributing">Contributing</a></li>
</ul>

<hr/>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://interjectedfuture.com/gojue/ecapture/blob/master/images/how-ecapture-works.png"><img src="https://interjectedfuture.com/gojue/ecapture/raw/master/images/how-ecapture-works.png" alt=""/></a></p>
<ul dir="auto">
<li>SSL/TLS plaintext capture, support openssl\libressl\boringssl\gnutls\nspr(nss) libraries.</li>
<li>GoTLS plaintext support go tls library, which refers to encrypted communication in https/tls programs written in the golang language.</li>
<li>bash audit, capture bash command for Host Security Audit.</li>
<li>mysql query SQL audit, support mysqld 5.6\5.7\8.0, and mariadDB.</li>
</ul>

<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://interjectedfuture.com/gojue/ecapture/blob/master/images/ecapture-help-v0.7.4.png"><img src="https://interjectedfuture.com/gojue/ecapture/raw/master/images/ecapture-help-v0.7.4.png" alt=""/></a></p>
<p dir="auto">Youtube video: <a href="https://www.youtube.com/watch?v=CoDIjEQCvvA" title="eCapture User Manual" rel="nofollow">How to use eCapture v0.1.0</a></p>


<p dir="auto">Download ELF zip file <a href="https://github.com/gojue/ecapture/releases">release</a> , unzip and use by
command <code>./ecapture --help</code>.</p>
<ul dir="auto">
<li>Linux kernel version &gt;= 4.18 is required.</li>
<li>Enable BTF <a href="https://www.kernel.org/doc/html/latest/bpf/btf.html" rel="nofollow">BPF Type Format (BTF)</a>  (Optional, 2022-04-17)</li>
</ul>

<div dir="auto" data-snippet-clipboard-copy-content="# pull docker image
docker pull gojue/ecapture:latest
# run
docker run --rm --privileged=true --net=host -v ${HOST_PATH}:${CONTAINER_PATH} gojue/ecapture ARGS"><pre><span><span>#</span> pull docker image</span>
docker pull gojue/ecapture:latest
<span><span>#</span> run</span>
docker run --rm --privileged=true --net=host -v <span>${HOST_PATH}</span>:<span>${CONTAINER_PATH}</span> gojue/ecapture ARGS</pre></div>

<blockquote>
<p dir="auto"><strong>Note</strong></p>
<p dir="auto">Need ROOT permission.</p>
</blockquote>
<p dir="auto">eCapture search <code>/etc/ld.so.conf</code> file default, to search load directories of  <code>SO</code> file, and search <code>openssl</code> shard
libraries location. or you can use <code>--libssl</code>
flag to set shard library path.</p>
<p dir="auto">If target program is compile statically, you can set program path as <code>--libssl</code> flag value directly。</p>

<p dir="auto">The eCapture tool comprises 8 modules that respectively support plaintext capture for TLS/SSL encryption libraries like OpenSSL, GnuTLS, NSPR, BoringSSL, and GoTLS. Additionally, it facilitates software audits for Bash, MySQL, and PostgreSQL applications.</p>
<ul dir="auto">
<li>bash		capture bash command</li>
<li>gnutls	capture gnutls text content without CA cert for gnutls libraries.</li>
<li>gotls		Capturing plaintext communication from Golang programs encrypted with TLS/HTTPS.</li>
<li>mysqld	capture sql queries from mysqld 5.6/5.7/8.0 .</li>
<li>nss		capture nss/nspr encrypted text content without CA cert for nss/nspr libraries.</li>
<li>postgres	capture sql queries from postgres 10+.</li>
<li>tls		use to capture tls/ssl text content without CA cert. (Support openssl 1.0.x/1.1.x/3.0.x or newer).
You can use <code>ecapture -h</code> to view the list of subcommands.</li>
</ul>

<p dir="auto">The OpenSSL module supports three capture modes:</p>
<ul dir="auto">
<li><code>pcap</code>/<code>pcapng</code> mode stores captured plaintext data in pcap-NG format.</li>
<li><code>keylog</code>/<code>key</code> mode saves the TLS handshake keys to a file.</li>
<li><code>text</code> mode directly captures plaintext data, either outputting to a specified file or printing to the command line.</li>
</ul>

<p dir="auto">You can specify <code>-m pcap</code> or <code>-m pcapng</code> and use it in conjunction with <code>--pcapfile</code> and <code>-i</code> parameters. The default value for <code>--pcapfile</code> is <code>ecapture_openssl.pcapng</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="./ecapture tls -m pcap -i eth0 --pcapfile=ecapture.pcapng tcp port 443"><pre>./ecapture tls -m pcap -i eth0 --pcapfile=ecapture.pcapng tcp port 443</pre></div>
<p dir="auto">This command saves captured plaintext data packets as a pcapng file, which can be viewed using <code>Wireshark</code>.</p>

<p dir="auto">You can specify <code>-m keylog</code> or <code>-m key</code> and use it in conjunction with the <code>--keylogfile</code> parameter, which defaults to <code>ecapture_masterkey.log</code>.</p>
<p dir="auto">The captured OpenSSL TLS <code>Master Secret</code> information is saved to <code>--keylogfile</code>. You can also enable <code>tcpdump</code> packet capture and then use <code>Wireshark</code> to open the file and set the <code>Master Secret</code> path to view plaintext data packets.</p>
<div dir="auto" data-snippet-clipboard-copy-content="./ecapture tls -m keylog -keylogfile=openssl_keylog.log"><pre>./ecapture tls -m keylog -keylogfile=openssl_keylog.log</pre></div>
<p dir="auto">You can also directly use the <code>tshark</code> software for real-time decryption and display:</p>
<div dir="auto" data-snippet-clipboard-copy-content="tshark -o tls.keylog_file:ecapture_masterkey.log -Y http -T fields -e http.file_data -f &#34;port 443&#34; -i eth0"><pre>tshark -o tls.keylog_file:ecapture_masterkey.log -Y http -T fields -e http.file_data -f <span><span>&#34;</span>port 443<span>&#34;</span></span> -i eth0</pre></div>

<p dir="auto"><code>./ecapture tls -m text</code> will output all plaintext data packets. (Starting from v0.7.0, it no longer captures SSLKEYLOG information.)</p>

<p dir="auto">Similar to the OpenSSL module.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">check your server BTF config：</h3><a id="user-content-check-your-server-btf-config" aria-label="Permalink: check your server BTF config：" href="#check-your-server-btf-config"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="cfc4n@vm-server:~$# uname -r
4.18.0-305.3.1.el8.x86_64
cfc4n@vm-server:~$# cat /boot/config-`uname -r` | grep CONFIG_DEBUG_INFO_BTF
CONFIG_DEBUG_INFO_BTF=y"><pre>cfc4n@vm-server:<span>~</span><span>$#</span> uname -r
4.18.0-305.3.1.el8.x86_64
cfc4n@vm-server:<span>~</span><span>$#</span> cat /boot/config-<span><span>`</span>uname -r<span>`</span></span> <span>|</span> grep CONFIG_DEBUG_INFO_BTF
CONFIG_DEBUG_INFO_BTF=y</pre></div>

<p dir="auto">capture tls text context.</p>
<p dir="auto">Step 1:</p>
<div dir="auto" data-snippet-clipboard-copy-content="./ecapture gotls --elfpath=/home/cfc4n/go_https_client --hex"><pre>./ecapture gotls --elfpath=/home/cfc4n/go_https_client --hex</pre></div>
<p dir="auto">Step 2:</p>
<div dir="auto" data-snippet-clipboard-copy-content="/home/cfc4n/go_https_client"><pre>/home/cfc4n/go_https_client</pre></div>



<p dir="auto">capture bash command : <code>ecapture bash</code></p>


<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://interjectedfuture.com/gojue/ecapture/blob/master/images/ecapture-architecture.png"><img src="https://interjectedfuture.com/gojue/ecapture/raw/master/images/ecapture-architecture.png" alt=""/></a></p>

<p dir="auto"><a href="https://ebpf.io" rel="nofollow">eBPF</a></p>

<p dir="auto">Linux Kernel: &gt;= 4.18.</p>

<ul dir="auto">
<li>golang 1.21 or newer</li>
<li>clang 9.0 or newer</li>
<li>cmake 3.18.4 or newer</li>
<li>clang backend: llvm 9.0 or newer</li>
<li>kernel config:CONFIG_DEBUG_INFO_BTF=y (Optional, 2022-04-17)</li>
</ul>


<p dir="auto">If you are using Ubuntu 20.04 or later versions, you can use a single command to complete the initialization of the compilation environment.</p>
<div dir="auto" data-snippet-clipboard-copy-content="/bin/bash -c &#34;$(curl -fsSL https://raw.githubusercontent.com/gojue/ecapture/master/builder/init_env.sh)&#34;"><pre>/bin/bash -c <span><span>&#34;</span><span><span>$(</span>curl -fsSL https://raw.githubusercontent.com/gojue/ecapture/master/builder/init_env.sh<span>)</span></span><span>&#34;</span></span></pre></div>

<p dir="auto">In addition to the software listed in the &#39;Toolchain Version&#39; section above, the following software is also required for the compilation environment. Please install it yourself.</p>
<ul dir="auto">
<li>linux-tools-common</li>
<li>linux-tools-generic</li>
<li>pkgconf</li>
<li>libelf-dev</li>
</ul>
<p dir="auto"><strong>Clone the repository code and compile it</strong></p>
<p dir="auto">Caution: The following <code>make</code> command will install libpcap into the system
directory if <code>libpcap.a</code> does not exist under <code>/usr/local/lib</code>. If you have
installed libpcap in system without <code>libpcap.a</code>, it maybe break your libpcap&#39;s
headers.</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone --recurse-submodules git@github.com:gojue/ecapture.git
cd ecapture
make
bin/ecapture"><pre>git clone --recurse-submodules git@github.com:gojue/ecapture.git
<span>cd</span> ecapture
make
bin/ecapture</pre></div>

<p dir="auto">eCapture support BTF disabled with command <code>make nocore</code> to compile at 2022/04/17. It can work normally even on Linux systems that do not support BTF.</p>
<div dir="auto" data-snippet-clipboard-copy-content="make nocore
bin/ecapture --help"><pre>make nocore
bin/ecapture --help</pre></div>


<p dir="auto">To cross-compile the eCapture tool, you need to install the kernel header files for the target architecture. you need to install the <code>linux-source</code> package.</p>
<div dir="auto" data-snippet-clipboard-copy-content="kernel_ver=`uname -r | cut -d&#39;-&#39; -f 1`
sudo apt-get install -y linux-source-$kernel_ver
cd /usr/src
sudo tar -xf linux-source-${kernel_ver}.tar.bz2
cd /usr/src/linux-source-${kernel_ver}
test -f .config || yes &#34;&#34; | sudo make oldconfig"><pre>kernel_ver=<span><span>`</span>uname -r <span>|</span> cut -d<span><span>&#39;</span>-<span>&#39;</span></span> -f 1<span>`</span></span>
sudo apt-get install -y linux-source-<span>$kernel_ver</span>
<span>cd</span> /usr/src
sudo tar -xf linux-source-<span>${kernel_ver}</span>.tar.bz2
<span>cd</span> /usr/src/linux-source-<span>${kernel_ver}</span>
<span>test</span> -f .config <span>||</span> yes <span><span>&#34;</span><span>&#34;</span></span> <span>|</span> sudo make oldconfig</pre></div>

<p dir="auto">To cross-compile binary files for the aarch64 architecture on an amd64 architecture system, you need to install the gcc-aarch64-linux-gnu toolchain. Similarly, to cross-compile binary files for the amd64 architecture on an aarch64 system, you need to install the gcc-x86-64-linux-gnu toolchain.</p>
<ul dir="auto">
<li>amd64 arch: gcc-aarch64-linux-gnu</li>
<li>arm64 arch: gcc-x86-64-linux-gnu</li>
</ul>

<p dir="auto">To build an <code>arm64</code> artifact on an ubuntu <code>amd64</code> system, you can set the <code>CROSS_ARCH</code> environment variable to achieve cross-compilation.</p>


<p dir="auto"><a href="https://starchart.cc/gojue/ecapture" rel="nofollow"><img src="https://camo.githubusercontent.com/82f9137fa72bb9a2660aa993e601d83c1c661035ee4b8cfbabbad9160e1334a6/68747470733a2f2f7374617263686172742e63632f676f6a75652f65636170747572652e737667" alt="Stargazers over time" data-canonical-src="https://starchart.cc/gojue/ecapture.svg"/></a></p>

<p dir="auto">See <a href="https://interjectedfuture.com/gojue/ecapture/blob/master/CONTRIBUTING.md">CONTRIBUTING</a> for details on submitting patches and the contribution workflow.</p>
</article></div></div>
  </body>
</html>
