<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://rgoswami.me/posts/handling-legacy-fortran-code/">Original</a>
    <h1>Handling Legacy Fortran Code</h1>
    
    <div id="readability-page-1" class="page"><div><blockquote><p>A short pseudo-tutorial post on working with inherited Fortran.</p></blockquote><h2 id="background">Background</h2><p>In-spite of the many claims by upper management (e.g. <a href="https://fortran-lang.discourse.group/t/an-evaluation-of-risks-associated-with-relying-on-fortran-for-mission-critical-codes-for-the-next-15-years/5644?u=rgoswami">at
LANL</a>)
regarding the death of Fortran, most people with even a passing interest
in academic research within STEM fields will interact with Fortran code,
and the community has only been improving with time Kedward et al.
(<a href="#ref-kedwardStateFortran2022">2022</a>). Rewriting <strong>is not</strong> typically
an option, or a good use of time. This set of posts should be applicable
to any blackbox legacy fortran code, though the specific example here is
one from my own field (computational chemistry).</p><h3 id="series">Series</h3><p>This is a series of posts centered around “things to do with old fortran
code”. To be very exact, there’s only this post, but related articles
are:</p><ol><li><strong>Handling Legacy Fortran Code</strong> &lt;– You are here</li><li>MATLAB bindings for Fortran Libraries through <code>C</code></li><li><code>cibuildwheel</code> for C++ libraries with thin Python wrappers</li></ol><p>The third post lays out design guidelines and build practicalities for
C++ libraries which may have embedded Fortran code.</p><h2 id="the-code">The Code</h2><p>As an exemplary example, we will consider an implicitly typed Fortran-77
program for generating the potential energy surface (and forces) of a
system containing Copper and Hydrogen atoms. The group I’m associated
with has a rather nice Embedded Atom Model parameterized for this
particular system <sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>. The source can be obtained from here:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>git clone https://github.com/TheochemUI/fortran_cuh2_src
</span></span></code></pre></div><p>Since it was initially meant to work with <code>con</code> files, the salient
points of the implementation are:</p><ul><li><code>main.f90</code> uses file I/O to read <code>tmp.con</code> and write to <code>energy.out</code>
and <code>forces.out</code>, and signals that it is ready by writing \(1\) to
<code>eam.tmp</code></li><li><code>eamroutines.f90</code> reads in <code>pot.par</code>, which has parameters used in a
space separated file:</li></ul><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span> 6.10000   6.30000
</span></span><span><span>2</span><span>  .000000E+00  .000000E+00  .000000E+00
</span></span><span><span>3</span><span> 2862.30      79.5013      86.1495
</span></span><span><span>4</span><span> 3.51236      2.47961      4.21154
</span></span><span><span>5</span><span>-109.107     -107.555      15355.5
</span></span><span><span>6</span><span>....
</span></span></code></pre></div><p>Additionally the code is in FORTRAN 77, and uses features no longer in
vogue including implicit typing and <code>common</code> blocks.</p><h3 id="initial-cleanup">Initial Cleanup</h3><p>Rather than hard-coding a path (<code>pot.par</code>) it is best to store these
values in the source code itself.</p><div><pre tabindex="0"><code data-lang="python"><span><span>1</span><span><span>potpar</span> <span>=</span> <span>np</span><span>.</span><span>loadtxt</span><span>(</span><span>&#34;pot.par&#34;</span><span>,</span> <span>skiprows</span><span>=</span><span>1</span><span>)</span> <span># first row has 2 values</span>
</span></span><span><span>2</span><span><span>for</span> <span>idx</span><span>,</span> <span>val</span> <span>in</span> <span>enumerate</span><span>(</span><span>aa</span><span>,</span> <span>start</span><span>=</span><span>1</span><span>):</span>
</span></span><span><span>3</span><span>    <span>print</span><span>(</span><span>f</span><span>&#34;potpar(</span><span>{</span><span>idx</span><span>}</span><span>, 1) = </span><span>{</span><span>val</span><span>[</span><span>0</span><span>]</span><span>}</span><span>\n</span><span>potpar(</span><span>{</span><span>idx</span><span>}</span><span>, 2) = </span><span>{</span><span>val</span><span>[</span><span>1</span><span>]</span><span>}</span><span>\n</span><span>potpar(</span><span>{</span><span>idx</span><span>}</span><span>, 3) = </span><span>{</span><span>val</span><span>[</span><span>2</span><span>]</span><span>}</span><span>&#34;</span><span>)</span>
</span></span></code></pre></div><p>There are many more possible optimizations which can be done on the
Fortran side, but this is the bare minimum we need to move on. The state
of the project can be seen in
<a href="https://github.com/TheochemUI/fortran_cuh2_src/commit/1461cdf927f69f2da75a5da75e566faa66b88267">1461cdf</a>.
The <code>main.f90</code> issues regarding the file I/O can be handled from
different languages.</p><h2 id="python-usage">Python Usage</h2><p>When confronted by a Fortran 77 code, or any Fortran code in general, it
is never a bad idea to start out with <code>f2py</code>. In this instance, we would
like to call the <code>force_eam</code> function without all the file I/O:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>1</span><span>f2py -c -m cuh2 eamroutines.f90
</span></span></code></pre></div><p>Now we can use this from Python:</p><div><pre tabindex="0"><code data-lang="python"><span><span> 1</span><span><span>import</span> <span>numpy</span> <span>as</span> <span>np</span>
</span></span><span><span> 2</span><span><span>import</span> <span>cuh2</span> <span># Compiled module</span>
</span></span><span><span> 3</span><span><span>R</span> <span>=</span> <span>[</span><span>0.63940268750835</span><span>,</span> <span>0.90484742551374</span><span>,</span> <span>6.97516498544584</span><span>,</span> <span>3.19652040936288</span><span>,</span> <span>0.90417430354811</span><span>,</span> <span>6.97547796369474</span><span>,</span> <span>8.98363230369760</span><span>,</span> <span>9.94703496017833</span><span>,</span> <span>7.83556854923689</span><span>,</span> <span>7.64080177576300</span><span>,</span> <span>9.94703114803832</span><span>,</span> <span>7.83556986121272</span><span>]</span>
</span></span><span><span> 4</span><span><span>box</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>([</span><span>15.34</span><span>,</span> <span>21.702</span><span>,</span> <span>100</span><span>])</span>
</span></span><span><span> 5</span><span><span>natms</span> <span>=</span> <span>np</span><span>.</span><span>array</span><span>([</span><span>2</span><span>,</span> <span>2</span><span>])</span>
</span></span><span><span> 6</span><span><span>u</span> <span>=</span> <span>np</span><span>.</span><span>zeros</span><span>(</span><span>1</span><span>)</span>
</span></span><span><span> 7</span><span><span>F</span> <span>=</span> <span>np</span><span>.</span><span>zeros_like</span><span>(</span><span>R</span><span>)</span>
</span></span><span><span> 8</span><span><span>cuh2</span><span>.</span><span>force_eam</span><span>(</span><span>natms</span><span>,</span> <span>box</span><span>,</span> <span>R</span><span>.</span><span>ravel</span><span>(),</span> <span>F</span><span>.</span><span>ravel</span><span>(),</span> <span>u</span><span>)</span> <span># Call!</span>
</span></span><span><span> 9</span><span><span>print</span><span>(</span><span>u</span><span>)</span>
</span></span><span><span>10</span><span><span>[</span><span>-</span><span>2.71140933</span><span>]</span>
</span></span></code></pre></div><p>This works very well, and in-fact, if this use case (flexibly calling a
function) is all that is needed, then nothing more needs to be done.
<code>f2py</code> also generates correct signatures, and doc-strings:</p><div><pre tabindex="0"><code data-lang="python"><span><span> 1</span><span><span>??</span><span>cuh2</span><span>.</span><span>force_eam</span>
</span></span><span><span> 2</span><span><span>force_eam</span><span>(</span><span>natms</span><span>,</span><span>box</span><span>,</span><span>r</span><span>,</span><span>f</span><span>,</span><span>u</span><span>,[</span><span>ndim</span><span>])</span>
</span></span><span><span> 3</span><span>
</span></span><span><span> 4</span><span><span>Wrapper</span> <span>for</span> <span>``</span><span>force_eam</span><span>``</span><span>.</span>
</span></span><span><span> 5</span><span>
</span></span><span><span> 6</span><span><span>Parameters</span>
</span></span><span><span> 7</span><span><span>----------</span>
</span></span><span><span> 8</span><span><span>natms</span> <span>:</span> <span>input</span> <span>rank</span><span>-</span><span>1</span> <span>array</span><span>(</span><span>&#39;i&#39;</span><span>)</span> <span>with</span> <span>bounds</span> <span>(</span><span>2</span><span>)</span>
</span></span><span><span> 9</span><span><span>box</span> <span>:</span> <span>input</span> <span>rank</span><span>-</span><span>1</span> <span>array</span><span>(</span><span>&#39;d&#39;</span><span>)</span> <span>with</span> <span>bounds</span> <span>(</span><span>3</span><span>)</span>
</span></span><span><span>10</span><span><span>r</span> <span>:</span> <span>input</span> <span>rank</span><span>-</span><span>1</span> <span>array</span><span>(</span><span>&#39;d&#39;</span><span>)</span> <span>with</span> <span>bounds</span> <span>(</span><span>ndim</span><span>)</span>
</span></span><span><span>11</span><span><span>f</span> <span>:</span> <span>input</span> <span>rank</span><span>-</span><span>1</span> <span>array</span><span>(</span><span>&#39;d&#39;</span><span>)</span> <span>with</span> <span>bounds</span> <span>(</span><span>ndim</span><span>)</span>
</span></span><span><span>12</span><span><span>u</span> <span>:</span> <span>input</span> <span>rank</span><span>-</span><span>1</span> <span>array</span><span>(</span><span>&#39;d&#39;</span><span>)</span> <span>with</span> <span>bounds</span> <span>(</span><span>1</span><span>)</span>
</span></span><span><span>13</span><span>
</span></span><span><span>14</span><span><span>Other</span> <span>Parameters</span>
</span></span><span><span>15</span><span><span>----------------</span>
</span></span><span><span>16</span><span><span>ndim</span> <span>:</span> <span>input</span> <span>int</span><span>,</span> <span>optional</span>
</span></span><span><span>17</span><span>    <span>Default</span><span>:</span> <span>shape</span><span>(</span><span>r</span><span>,</span> <span>0</span><span>)</span>
</span></span></code></pre></div><p>The resulting compiled extensions can also be published to PyPI as SciPy
does.</p><h2 id="iso-c-binding-s-for-c-plus-plus-and-c"><code>ISO_C_BINDING~s for ~C++</code> and <code>C</code></h2><p>An <code>iso_c_binding</code> is essential for rational interfacing to C++ or other
languages with a well-defined C-API. Since here there is only one
function which needs to be called it can be as simple as:</p><div><pre tabindex="0"><code data-lang="fortran"><span><span> 1</span><span><span>module</span><span> </span><span>eam_wrap</span><span>
</span></span></span><span><span> 2</span><span><span>  </span><span>use</span><span> </span><span>iso_c_binding</span><span>,</span><span> </span><span>only</span><span>:</span><span> </span><span>c_double</span><span>,</span><span> </span><span>c_int</span><span>
</span></span></span><span><span> 3</span><span><span>    </span><span>implicit</span><span> </span><span>none</span><span>
</span></span></span><span><span> 4</span><span><span></span><span>contains</span><span>
</span></span></span><span><span> 5</span><span><span>  </span><span>subroutine</span><span> </span><span>c_force_eam</span><span> </span><span>(</span><span>natms</span><span>,</span><span> </span><span>ndim</span><span>,</span><span> </span><span>box</span><span>,</span><span> </span><span>R</span><span>,</span><span> </span><span>F</span><span>,</span><span> </span><span>U</span><span>)</span><span> </span><span>bind</span><span>(</span><span>c</span><span>)</span><span>
</span></span></span><span><span> 6</span><span><span>    </span><span>integer</span><span>(</span><span>c_int</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>natms</span><span>(</span><span>2</span><span>)</span><span>
</span></span></span><span><span> 7</span><span><span>    </span><span>integer</span><span>(</span><span>c_int</span><span>),</span><span> </span><span>value</span><span>,</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>ndim</span><span>
</span></span></span><span><span> 8</span><span><span>    </span><span>real</span><span>(</span><span>c_double</span><span>),</span><span> </span><span>intent</span><span>(</span><span>in</span><span>)</span><span> </span><span>::</span><span> </span><span>box</span><span>(</span><span>3</span><span>)</span><span>
</span></span></span><span><span> 9</span><span><span>    </span><span>real</span><span>(</span><span>c_double</span><span>),</span><span> </span><span>intent</span><span>(</span><span>inout</span><span>)</span><span> </span><span>::</span><span> </span><span>U</span><span>(</span><span>1</span><span>),</span><span> </span><span>R</span><span>(</span><span>ndim</span><span>),</span><span> </span><span>F</span><span>(</span><span>ndim</span><span>)</span><span>
</span></span></span><span><span>10</span><span><span>    </span><span>call</span><span> </span><span>force_eam</span><span>(</span><span>natms</span><span>,</span><span> </span><span>ndim</span><span>,</span><span> </span><span>box</span><span>,</span><span> </span><span>R</span><span>,</span><span> </span><span>F</span><span>,</span><span> </span><span>U</span><span>)</span><span>
</span></span></span><span><span>11</span><span><span>  </span><span>end</span><span> </span><span>subroutine</span><span> </span><span>c_force_eam</span><span>
</span></span></span><span><span>12</span><span><span></span><span>end</span><span> </span><span>module</span><span> </span><span>eam_wrap</span><span>
</span></span></span></code></pre></div><p>Which, can be mapped to the following function in any <code>C</code> header file:</p><div><pre tabindex="0"><code data-lang="c"><span><span>1</span><span><span>extern</span> <span>void</span> <span>c_force_eam</span><span>(</span><span>int</span> <span>*</span><span>natms</span><span>,</span> <span>int</span> <span>ndim</span><span>,</span>
</span></span><span><span>2</span><span>                        <span>double</span> <span>*</span><span>box</span><span>,</span> <span>double</span> <span>*</span><span>R</span><span>,</span>
</span></span><span><span>3</span><span>                        <span>double</span> <span>*</span><span>F</span><span>,</span> <span>double</span> <span>*</span><span>U</span><span>);</span>
</span></span></code></pre></div><p>We can always check that the right functions are where they should be:</p><div><pre tabindex="0"><code data-lang="bash"><span><span> 1</span><span>gfortran -c eam_isoc.f90 eamroutines.f90
</span></span><span><span> 2</span><span>nm eam_isoc.o
</span></span><span><span> 3</span><span><span>0000000000000000</span> T c_force_eam
</span></span><span><span> 4</span><span>                 U force_eam_
</span></span><span><span> 5</span><span>nm eamroutines.o
</span></span><span><span> 6</span><span>000000000000000c C counters_
</span></span><span><span> 7</span><span><span>0000000000000050</span> C cutoff_values_
</span></span><span><span> 8</span><span>00000000000065c8 C eam_
</span></span><span><span> 9</span><span><span>0000000000000130</span> C eamdblexp_
</span></span><span><span>10</span><span>00000000000025e8 T eamfcu_
</span></span><span><span>11</span><span>000000000000249b T eamfh_
</span></span><span><span>12</span><span><span>0000000000000000</span> T eamh2cu_
</span></span><span><span>13</span><span>00000000000029ef T eamphicucu_
</span></span><span><span>14</span><span>00000000000028f8 T eamphihcu_
</span></span><span><span>15</span><span><span>0000000000002801</span> T eamphihh_
</span></span><span><span>16</span><span><span>0000000000002331</span> T eamrhocu_
</span></span><span><span>17</span><span>00000000000021c7 T eamrhoh_
</span></span><span><span>18</span><span>                 U exp
</span></span><span><span>19</span><span><span>0000000000003210</span> T force_eam_
</span></span><span><span>20</span><span>                 U _gfortran_stop_string
</span></span><span><span>21</span><span>                 U _gfortran_st_write
</span></span><span><span>22</span><span>                 U _gfortran_st_write_done
</span></span><span><span>23</span><span>                 U _gfortran_transfer_character_write
</span></span><span><span>24</span><span>                 U _gfortran_transfer_integer_write
</span></span><span><span>25</span><span>                 U _gfortran_transfer_real_write
</span></span><span><span>26</span><span>0000000000002ae6 T potinit_
</span></span><span><span>27</span><span>                 U __powidf2
</span></span><span><span>28</span><span>                 U __stack_chk_fail
</span></span></code></pre></div><h3 id="matlab-interfaces">MATLAB Interfaces</h3><p>Nominally, MATLAB has a <a href="https://www.mathworks.com/help/matlab/call-mex-fortran.html">Fortran
API</a>.
However, it isn’t great. The <code>C++</code> API is “modern” to the <a href="https://www.mathworks.com/help/matlab/matlab_external/c-mex-functions.html">extent of of
C++11</a>,
which is practically useless. So the <code>C</code> <a href="https://www.mathworks.com/help/matlab/cc-mx-matrix-library.html">MEX
API</a> is
the best way forward here, though <strong>input arrays need to be transposed</strong>
if they are passed to Fortran routines.</p><h2 id="conclusions">Conclusions</h2><p>This was a first pass at what to do when confronted with Fortran code,
short of running away, or rewriting entirely. Follow up posts handle
integrating into larger C++ codes, or distributing said libraries with
<code>pip</code> <sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>.</p><h2 id="references">References</h2><div id="refs"><p>Kedward, Laurence J., Bálint Aradi, Ondřej Čertík, Milan Curcic,
Sebastian Ehlert, Philipp Engel, Rohit Goswami, et al. 2022. “The State
of Fortran.” <em>Computing in Science &amp; Engineering</em> 24 (2): 63–72.
<a href="https://doi.org/10.1109/MCSE.2022.3159862">https://doi.org/10.1109/MCSE.2022.3159862</a>.</p></div></div></div>
  </body>
</html>
