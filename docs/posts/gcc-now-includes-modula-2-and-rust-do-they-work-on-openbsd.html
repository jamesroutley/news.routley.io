<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://briancallahan.net/blog/20221219.html">Original</a>
    <h1>GCC now includes Modula-2 and Rust. Do they work on OpenBSD?</h1>
    
    <div id="readability-page-1" class="page">
	<a name="top"></a>
	<div id="main">
	    
	    <p>academic, developer, with an eye towards a brighter techno-social life</p>
	    <hr/>
		
	    <hr/>
	</div>
<h5 id="prev"><a href="https://briancallahan.net/blog/20221113.html">[prev]</a></h5>
<h5 id="next">[next]</h5>
    <h2 id="title">2022-12-19</h2>
<p>Two new language frontends have been added to <a href="https://gcc.gnu.org/">GCC</a>: <a href="https://en.wikipedia.org/wiki/Modula-2">Modula-2</a> and <a href="https://en.wikipedia.org/wiki/Rust_(programming_language)">Rust</a>. I think this is great news on both accounts: having a <a href="https://en.wikipedia.org/wiki/Niklaus_Wirth">Wirth</a> language in GCC fills my childhood heart with joy (though I do wish <a href="https://www.gnu-pascal.de/gpc/h-index.html">GNU Pascal</a> can one day be revived and mainlined, as <a href="https://en.wikipedia.org/wiki/Pascal_(programming_language)">Pascal</a> was the first non-<a href="https://en.wikipedia.org/wiki/BASIC">BASIC</a> language I learned). And Rust appears here to stay, so having more than just the one official compiler seemed all but inevitable. I think both languages make sense for GCC and am glad to see that they will be making the upcoming GCC 13.1.</p>
<p>Let&#39;s see how they fare on <a href="https://www.openbsd.org/">OpenBSD</a>.</p>
<h4>Building GNU Modula-2</h4>
<p>I maintain a vanilla repository of GCC that I build daily on one of my OpenBSD machines. This is because I occasionally do <a href="https://github.com/dlang/dmd/commits?author=ibara">development</a> <a href="https://github.com/dlang/phobos/commits?author=ibara">for</a> <a href="https://dconf.org/2021/online/index.html#brian">and</a> <a href="https://dconf.org/2022/online/index.html#brianc">in</a> <a href="https://dlang.org/">D</a> and <a href="https://wiki.dlang.org/GDC">GDC</a> is my preferred D compiler.</p>
<p>Now that Modula-2 and Rust are mainlined, all I had to do was run <code>git pull</code> and my repo was updated with the new languages. I added <code>m2,rust</code> to the <code>--enable-languages</code> configure option, so now it looks like <code>--enable-languages=c,c++,d,fortran,lto,m2,objc,obj-c++,rust</code> and I was ready to go.</p>
<p>During the build, I did have one issue when building Modula-2: there is a plugin called <code>m2rte.so</code> and if you try to build it with GCC&#39;s internal <a href="https://www.gnu.org/software/gnulib/manual/html_node/libintl_002eh.html"><code>libintl</code></a>, you get a build error because the GCC build system cannot find the internal <code>libintl.h</code>. This was easily fixed with this patch, which I have <a href="https://lists.nongnu.org/archive/html/gm2/2022-12/msg00016.html">sent</a> to the <a href="https://www.nongnu.org/gm2/homepage.html">GNU Modula-2</a> developer:</p>
<pre>diff --git a/gcc/m2/Make-lang.in b/gcc/m2/Make-lang.in
index a8bd7fe4d19..c9aacb09f02 100644
--- a/gcc/m2/Make-lang.in
+++ b/gcc/m2/Make-lang.in
@@ -409,7 +409,7 @@ m2.install-plugin: installdirs
 plugin/m2rte$(exeext).so: $(srcdir)/m2/plugin/m2rte.cc $(GCC_HEADER_DEPENDENCIES_FOR_M2) \
         insn-attr-common.h insn-flags.h $(generated_files)
        test -d plugin || mkdir plugin
-       $(PLUGINCC) $(PLUGINCFLAGS) -fno-rtti -I. -I$(srcdir) -I$(srcdir)/m2 -I$(srcdir)/m2/gm2-gcc -I$(srcdir)/../include -I$(srcdir)/../libcpp/include -Wall $(GMPINC) -Wno-literal-suffix -fPIC -c -o plugin/m2rte.o $(srcdir)/m2/plugin/m2rte.cc
+       $(PLUGINCC) $(PLUGINCFLAGS) -fno-rtti -I. -I$(srcdir) -I$(srcdir)/m2 -I$(srcdir)/m2/gm2-gcc -I$(srcdir)/../include -I$(srcdir)/../libcpp/include -I$(objdir)/../intl -Wall $(GMPINC) -Wno-literal-suffix -fPIC -c -o plugin/m2rte.o $(srcdir)/m2/plugin/m2rte.cc
        $(PLUGINCC) $(PLUGINCFLAGS) $(PLUGINLIBS) -fno-rtti plugin/m2rte.o -shared -o $@


</pre>
<p>And that&#39;s all you need to build GNU Modula-2. Hopefully that fix gets integrated into GCC so there will be no patches needed.</p>
<h4>Building GNU Rust</h4>
<p><a href="https://rust-gcc.github.io/">GNU Rust</a> built out-of-the-box with no patches needed.</p>
<h4>Running GNU Modula-2</h4>
<p>I have to admit that I already knew that GNU Modula-2 would work fine. Long-time readers might remember that I <a href="https://briancallahan.net/blog/20210403.html">reported</a> about a year and a half ago that I had gotten GM2 working on OpenBSD. I&#39;ve been hanging around the GM2 community and the mailing list ever since.</p>
<p>Things have gotten easier since then. Let&#39;s take a simple <a href="https://en.wikipedia.org/wiki/%22Hello,_World!%22_program">Hello world</a> example:</p>
<pre>MODULE hello ;

FROM StrIO IMPORT WriteString, WriteLn ;

BEGIN
   WriteString(&#39;Hello world from M2!&#39;) ; WriteLn
END hello.
</pre>
<p>All I had to do was run:</p>
<pre>$ gm2 hello.mod
$ ./a.out
Hello world from M2!
</pre>
<p>GNU Modula-2 just works on OpenBSD and that&#39;s awesome!</p>
<h4>Running GNU Rust</h4>
<p>I had already been in contact with the GNU Rust people when I first heard about it just to let them know that I had tried building it and it built fine on OpenBSD. I know, and the team is clear to state, that GNU Rust is still in its alpha stages. Knowing that, I chose to disregard those warnings and tried to build some Rust code anyway.</p>
<p>I used the Hello world program that you can find on the <a href="https://doc.rust-lang.org/rust-by-example/hello.html">Rust By Example</a> site:</p>
<pre>fn main() {
    println!(&#34;Hello World!&#34;);
}
</pre>
<p>I then tried to compile it with:</p>
<pre>$ gccrs hello.rs
</pre>
<p>And I got back a very large warning message:</p>
<pre>rust1: fatal error: gccrs is not yet able to compile Rust code properly. Most of the errors produced will be gccrs&#39; fault and not the crate you are trying to compile. Because of this, please reports issues to us directly instead of opening issues on said crate&#39;s repository.

Our github repository: https://github.com/rust-gcc/gccrs
Our bugzilla tracker: https://gcc.gnu.org/bugzilla/buglist.cgi?bug_status=__open__&amp;component=rust&amp;product=gcc

If you understand this, and understand that the binaries produced might not behave accordingly, you may attempt to use gccrs in an experimental manner by passing the following flag:

`-frust-incomplete-and-experimental-compiler-do-not-use`

or by defining the following environment variable (any value will do)

GCCRS_INCOMPLETE_AND_EXPERIMENTAL_COMPILER_DO_NOT_USE

Forcargo-gccrs, this means passing

GCCRS_EXTRA_FLAGS=&#34;-frust-incomplete-and-experimental-compiler-do-not-use&#34;

as an environment variable.
compilation terminated.
</pre>
<p>So I did the obviously correct thing to do and attempted to recompile with:</p>
<pre>$ gccrs -frust-incomplete-and-experimental-compiler-do-not-use hello.rs
</pre>
<p>And then I got back this error:</p>
<pre>hello.rs:2:5: error: unknown macro: [println]
    2 |     println!(&#34;Hello World!&#34;);
      |     ^
</pre>
<p>Which I guess I can&#39;t be too disappointed about. They did say things will be broken. We will just need to keep it on our radar and try again from time to time. Or, if you know why I got this error and know how to fix it, let me know and I will update this post to include the correct steps.</p>
<p>I then made a more compilable program:</p>
<pre>fn main() -&gt; i32 {
    return 42;
}
</pre>
<p>I was able to successfully compile this program:</p>
<pre>$ gccrs -frust-incomplete-and-experimental-compiler-do-not-use hello.rs
$ ./a.out
$ echo $?
42
</pre>
<p>I also noticed that in addition to the expected <code>a.out</code> file, GNU Rust also left behind a 29-byte <code>hello.rox</code> file that contains this data:</p>
<pre>$ hexdump -C hello.rox
00000000  47 52 53 54 d4 1d 8c d9  8f 00 b2 04 e9 80 09 98  |GRST............|
00000010  ec f8 42 7e 24 68 65 6c  6c 6f 24 30 24           |..B~$hello$0$|
0000001d
</pre>
<p>I&#39;m not sure what this is but I am including it for completeness. If you know what this is, let me know!</p>
<p><span>Update:</span> I have been <a href="https://floss.social/@bugaevc/109541483163104805">told</a> that the rox file has to do with crates. It is written about <a href="https://github.com/Rust-GCC/Reporting/blob/main/2022-07-18-report.org#linking-crates">here</a>.</p>
<p>I also got a working Hello world:</p>
<pre>extern &#34;C&#34; {
    fn printf(s: *const i8, ...);
}

unsafe fn main() {
    let a = &#34;Hello world from Rust!\n\0&#34;;
    let b = a as *const str;
    let c = b as *const i8;

    printf(c);
}
</pre>
<p>This indeed works:</p>
<pre>$ gccrs -frust-incomplete-and-experimental-compiler-do-not-use hello.rs
$ ./a.out
Hello world from Rust!
</pre>
<h4>Get a pre-built package</h4>
<p>If you&#39;d like a pre-built package of GCC including compilers for <a href="https://en.wikipedia.org/wiki/C_(programming_language)">C</a>, <a href="https://en.wikipedia.org/wiki/C%2B%2B">C++</a>, D, <a href="https://en.wikipedia.org/wiki/Fortran">Fortran</a>, Modula-2, <a href="https://en.wikipedia.org/wiki/Objective-C">Objective-C</a>, <a href="https://en.wikipedia.org/wiki/Objective-C#Objective-C++">Objective-C++</a>, and Rust, I have one available for <a href="https://www.openbsd.org/amd64.html">OpenBSD/amd64</a> -current on GitHub:</p>
<pre>$ doas pkg_add -Dunsigned https://github.com/ibara/openbsd-gcc/releases/download/amd64/gcc-devel-13.0.0pl20221218.tgz
</pre>
<p>This package will install GCC into <code>/usr/local/gnu</code> so that it will not conflict with any other installation of GCC you might have on your system.</p>
<h4>Conclusion</h4>
<p>I am very excited to see Modula-2 and Rust added to GCC. The fact that they are both ready to go on OpenBSD is a positive reminder of the importance of portability across platforms. I am excited to see the new life breathed into Modula-2 and the continued success of Rust, now that both languages have another open source implementation available to all. I am also excited to see more usage of both languages on the BSDs.</p>
<p>Now if we can only get Pascal added to GCC, my life will be complete!</p>
<p><a href="#top"><img alt="Top" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAICAYAAADJEc7MAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wkWDyUKJxzXegAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAUklEQVQY02Ocd/j/fwY0kGjDwMhACPz//5/h////DPMO//8PYxODWXAZOP8Iw39k22F8uBg2G7Gx0cWYGMgEWJ2aaMPAiO5UDOcTGxjogUe2UwHwdJDZUucW5QAAAABJRU5ErkJggg=="/></a></p>
<a href="https://briancallahan.net/blog/feed.xml"><img alt="RSS" src="https://briancallahan.net/blog/media/pic_rss.gif"/></a>
	</div>
  </body>
</html>
