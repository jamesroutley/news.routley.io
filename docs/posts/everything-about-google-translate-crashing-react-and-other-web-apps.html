<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://martijnhols.nl/blog/everything-about-google-translate-crashing-react">Original</a>
    <h1>Everything about Google Translate crashing React (and other web apps)</h1>
    
    <div id="readability-page-1" class="page"><div><p>Google Translate, the built-in extension of Google Chrome, is a<!-- --> <i>machine translator</i> that provides users with an easy way of translating webpages from within their browser tab. This allows webpages to be used by users from all over the world, regardless of their native language.</p><p><img alt="" loading="lazy" width="200" height="150" decoding="async" data-nimg="1" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-react-clashing.fedd8c6b.png&amp;w=256&amp;q=75 1x, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-react-clashing.fedd8c6b.png&amp;w=640&amp;q=75 2x" src="https://www.fractalkitty.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-react-clashing.fedd8c6b.png&amp;w=640&amp;q=75"/></p><p>But this convenience comes at a cost, as it interferes with the workings of many modern sites. This is because<!-- --> <strong>Google Translate manipulates the DOM in such a way that it breaks the base apps.</strong> <!-- -->This interference often manifest as crashes caused by the DOM element&#39;s native <span aria-hidden="true">`</span><code translate="no">removeChild</code><span aria-hidden="true">`</span> method, resulting in errors like<!-- --> <span aria-hidden="true">`</span><code translate="no">NotFoundError: Failed to execute &#39;removeChild&#39; on &#39;Node&#39;: The node to be removed is not a child of this node.</code><span aria-hidden="true">`</span>, but it affects a lot more.<!-- --> <strong>Not all issues are as obvious as a crash.</strong></p><p>The focus of this article will be on Google Translate&#39;s interference of React, but it&#39;s important to note that these issues are not unique to React; they affect most machine translators and can disrupt any large and complex web app.</p><p>In this article, we will explore:</p><ul><li>How Google Translate works</li><li>Google Translate&#39;s interference</li><li>The interference of browser extensions in general</li><li>The impact on regular JavaScript code</li><li>Possible workarounds and alternatives</li></ul><p>Additionally, at the end of the article you will find an<!-- --> <a href="https://www.fractalkitty.com/blog/everything-about-google-translate-crashing-react#addendum">addendum</a> in which I share my views on whether web apps should even claim full and exclusive control of the DOM.</p><p>But first, let&#39;s take a look at how Google Translate works.</p><h2 id="how-google-translate-works">How Google Translate works</h2><p>To understand what Google Translate does, we need to take a close look at the DOM structure before and after translation.</p><p>All HTML that is rendered in the browser is represented by the<!-- --> <abbr title="Document Object Model" role="button" tabindex="0" aria-expanded="false">DOM</abbr> in JavaScript. This is a tree-like structure where each element is a node. HTML elements are represented by <span aria-hidden="true">`</span><code translate="no">Element</code><span aria-hidden="true">`</span>-nodes and text is represented by a <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>.</p><p>Let&#39;s take a simple piece of HTML:</p><p><span aria-hidden="true">```<br/></span><code translate="no"><div><pre><p><span>&lt;</span><span>p</span><span>&gt;</span><span>There are 4 lights!</span><span>&lt;/</span><span>p</span><span>&gt;</span></p></pre></div></code><span aria-hidden="true">```</span></p><p>In JavaScript, this is represented in the DOM by a structure like this:</p><div><p>Mounted DOM (English)</p><p><small>Hover or tap the TextNode to see its contents.</small></p></div><p>When Google Translate activates, it looks for <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s to translate. These nodes are then replaced with <span aria-hidden="true">`</span><code translate="no">FontElement</code><span aria-hidden="true">`</span> <!-- -->elements with the new, translated, strings inside. This results in the following HTML (assuming we&#39;re translating to Dutch):</p><p><span aria-hidden="true">```<br/></span><code translate="no"><div><pre><p><span>&lt;</span><span>p</span><span>&gt;</span><span>&lt;</span><span>font</span><span>&gt;</span><span>Er zijn 4 lampen!</span><span>&lt;/</span><span>font</span><span>&gt;</span><span>&lt;/</span><span>p</span><span>&gt;</span></p></pre></div></code><span aria-hidden="true">```</span></p><p>More importantly, the DOM structure becomes this:</p><div><div><div><p>Mounted DOM (now translated)</p></div><div><p>Unmounted (the original English node)</p></div></div><p><small>Hover or tap the TextNode to see its contents.</small></p></div><p>What this shows is that<!-- --> <strong>the original <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> is<!-- --> <span role="button" tabindex="0" aria-expanded="false">unmounted</span> <!-- -->and replaced with a new <span aria-hidden="true">`</span><code translate="no">FontElement</code><span aria-hidden="true">`</span></strong> <!-- -->with the translated text inside.</p><p>This is the gist of how Google Translate impacts the DOM and an important piece of why Google Translate causes problems (i.e. interferes) with JavaScript apps doing DOM manipulation.</p><h3 id="simulating-google-translate">Simulating Google Translate</h3><p>Now that we know how Google Translate works, we can simulate it being applied to a part of a page. This will allow us to reproduce the issues caused by Google Translate more easily.</p><p>The snippet below will search for an element with the id &#34;translateme&#34; and replace all direct <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> children with<!-- --> <span aria-hidden="true">`</span><code translate="no">FontElement</code><span aria-hidden="true">`</span>s similar to how Google Translate operates. To make it more obvious which text has the Google Translate simulation applied, any text affected is surrounded with square brackets (“There are 4 lights!” becomes “[There are 4 lights!]”).</p><p><span aria-hidden="true">```<br/></span><code translate="no"><div><pre><p><span>useEffect</span><span>(</span><span>(</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>  </span><span>document</span><span>.</span><span>getElementById</span><span>(</span><span>&#39;translateme&#39;</span><span>)</span><span>.</span><span>childNodes</span><span>.</span><span>forEach</span><span>(</span><span>(</span><span>child</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span></span></p><p><span>    </span><span>if</span><span> </span><span>(</span><span>child</span><span>.</span><span>nodeType</span><span> </span><span>===</span><span> </span><span>Node</span><span>.</span><span>TEXT_NODE</span><span>)</span><span> </span><span>{</span><span></span></p><p><span>      </span><span>const</span><span> fontElem </span><span>=</span><span> </span><span>document</span><span>.</span><span>createElement</span><span>(</span><span>&#39;font&#39;</span><span>)</span><span></span></p><p><span>      fontElem</span><span>.</span><span>textContent</span><span> </span><span>=</span><span> </span><span>`</span><span>[</span><span>${</span><span>child</span><span>.</span><span>textContent</span><span>}</span><span>]</span><span>`</span><span></span></p><p><span>      child</span><span>.</span><span>parentElement</span><span>.</span><span>insertBefore</span><span>(</span><span>fontElem</span><span>,</span><span> child</span><span>)</span><span></span></p><p><span>      child</span><span>.</span><span>parentElement</span><span>.</span><span>removeChild</span><span>(</span><span>child</span><span>)</span><span></span></p><p><span>    </span><span>}</span><span></span></p><p><span>  </span><span>}</span><span>)</span><span></span></p><p><span></span><span>}</span><span>)</span></p></pre></div></code><span aria-hidden="true">```</span></p><p>The reproduction examples below all use this method to simulate Google Translate.</p><h3 id="manually-testing-google-translate">Manually testing Google Translate</h3><p>If you want to validate the issues caused by Google Translate yourself, you can do so by manually testing it. This will help you understand the impact of Google Translate on your app.</p><p>The easiest way I found to test Google Translate, is to translate English to some other language. To get Google Chrome to do this, you will need to change your <i>Preferred languages</i> in the settings like so:</p><figure><span aria-hidden="true">Picture: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-language-setup.746e5db3.gif"><img alt="An animated GIF showing Chrome &#34;Preferred language&#34; settings. The Dutch language is added, and all other languages are removed afterwards." loading="lazy" width="500" height="261" decoding="async" data-nimg="1" sizes="(min-width: 768px) 500px, 100vw" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=3840&amp;q=75 3840w" src="https://www.fractalkitty.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-language-setup.746e5db3.gif&amp;w=3840&amp;q=75"/></a><figcaption><span aria-hidden="true">Caption: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-language-setup.746e5db3.gif">Replace all preferred languages in the settings</a><span aria-hidden="true"></span></figcaption></figure><p>Next, go to the webpage you want to test. If the webpage is set up correctly (and it&#39;s in English), it should have <span aria-hidden="true">`</span><code translate="no">lang=&#34;en&#34;</code><span aria-hidden="true">`</span> in its <span aria-hidden="true">`</span><code translate="no">html</code><span aria-hidden="true">`</span> tag. This allows Google Translate to reliably detect its language and translate it. If it doesn&#39;t suggest it by itself, click the translation icon in the address bar.</p><figure><span aria-hidden="true">Picture: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-activate.09bbe59f.gif"><img alt="An animated GIF showing how Google Translate activation in Chrome." loading="lazy" width="500" height="329" decoding="async" data-nimg="1" sizes="(min-width: 768px) 500px, 100vw" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=3840&amp;q=75 3840w" src="https://www.fractalkitty.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-activate.09bbe59f.gif&amp;w=3840&amp;q=75"/></a><figcaption><span aria-hidden="true">Caption: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-activate.09bbe59f.gif">Google Translate will immediately translate the page</a><span aria-hidden="true"></span></figcaption></figure><h2 id="the-interference-issues">The interference issues</h2><p>Now that we know how Google Translate manipulates the DOM, we can explore the interference issues it causes. The most common issues are:</p><h3 id="issue-translated-text-not-updating">Issue: Translated text not updating</h3><p>When Google Translate unmounts DOM nodes and places its own new ones in their place, the original DOM nodes will continue to exist in-memory. Any changes then made to the original DOM nodes will not show up in the user&#39;s browser in any way. The changes will remain in-memory.</p><p>This is an issue for systems like React that work with a Virtual DOM. One of the main reasons behind using the Virtual DOM is performance, and a key part of that is, whenever possible, updating the values of DOM nodes instead of replacing them. Replacing DOM nodes is more computationally expensive.</p><p>The consequence of this is that, in React, any text or number that might change alongside another string is affected.<!-- --> <strong>When Google Translate is applied, values shown on your page may never update again.</strong></p><p>This is a big problem for any app that shows users important data, which probably means every big React app. Showing the wrong data could be misleading and even dangerous. A dashboard showing the wrong number could lead to users making the wrong decisions, your app showing invalid prices could be a legal issue, while showing a user the wrong dosage of medicine could have much more dire consequences. How big of a risk this is, depends on your app and your business.</p><p>This issue is hard to discover since it doesn&#39;t lead to a crash or any error.</p><h4 id="issue-translated-text-not-updating-reproduction">Reproduction</h4><p>In the below reproduction, we have a simple counter tracking the number of lights (a number in a <span aria-hidden="true">`</span><code translate="no">useState</code><span aria-hidden="true">`</span>). The button increments the number of lights by one every time it&#39;s pressed. The marked label directly next to it is no more than <span aria-hidden="true">`</span><code translate="no">There are {lights} lights!</code><span aria-hidden="true">`</span> - no conditions or anything.</p><p>We simulate Google Translate using the method<!-- --> <a href="https://www.fractalkitty.com/blog/everything-about-google-translate-crashing-react#simulating-google-translate">described above</a>. The Google Translate simulation adds square brackets around the text to indicate it&#39;s active. The value shown in green underneath the button is the actual value, which is unaffected by Google Translate.</p><div><p>Reproduction</p><div><p><label> <!-- -->Simulate Google Translate</label></p></div></div><p>When you click the button a few times, you will see the state is updating and the component is rerendering, but the translated text is never updated to reflect the new value.</p><figure><span aria-hidden="true">Picture: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-lights-meme.bc1b3c90.gif"><img alt="An animated GIF of Jean-Luc Picard (Star Trek) yelling &#34;There are four lights!&#34;." loading="lazy" width="400" height="315" decoding="async" data-nimg="1" sizes="(min-width: 768px) 400px, 100vw" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=3840&amp;q=75 3840w" src="https://www.fractalkitty.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-lights-meme.bc1b3c90.gif&amp;w=3840&amp;q=75"/></a><figcaption><span aria-hidden="true">Caption: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-lights-meme.bc1b3c90.gif">There are 4 lights!</a><span aria-hidden="true"></span></figcaption></figure><div><p>Aside</p><p><span aria-hidden="true">&gt; <!-- -->Aside<!-- -->: </span>The reproduction shows three sets of brackets around the text. This is because React makes a separate <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> for each variable in a string. The real Google Translate would<!-- --> <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/normalize">normalize</a> <!-- -->the text nodes, merging them together, but our simulation doesn&#39;t do this to keep it simpler. This makes the reproduction slightly different from Google Translate, but the result is the same.</p></div><h3 id="issue-crashes">Issue: Crashes</h3><p>If you&#39;re running an error monitoring tool like Sentry or tried manually testing Google Translate, you&#39;ve probably seen these before. In React, the following errors are common due to interference from Google Translate:</p><ul><li><span aria-hidden="true">`</span><code translate="no">NotFoundError: Failed to execute &#39;removeChild&#39; on &#39;Node&#39;: The node to be removed is not a child of this node.</code><span aria-hidden="true">`</span></li><li><span aria-hidden="true">`</span><code translate="no">Failed to execute &#39;insertBefore&#39; on &#39;Node&#39;: The node before which the new node is to be inserted is not a child of this node.</code><span aria-hidden="true">`</span></li></ul><p>When one of those errors occurs, React will unmount your tree to the closest error boundary. But if you have no error boundary (which is common on websites), <strong>your entire app will crash</strong>.</p><p>The <span aria-hidden="true">`</span><code translate="no">removeChild</code><span aria-hidden="true">`</span> error usually happens because your app was trying to remove a conditionally rendered <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> from the DOM that Google Translate unmounted. The <span aria-hidden="true">`</span><code translate="no">insertBefore</code><span aria-hidden="true">`</span> error is less common; this usually occurs because something conditionally rendered is trying to appear <em>before</em> a <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> that was unmounted by Google Translate.</p><p>I think in many cases these crashes might be less important than the<!-- --> <a href="https://www.fractalkitty.com/blog/everything-about-google-translate-crashing-react#issue-translated-text-not-updating">translated text not updating</a>. Text not updating is less predictable than not showing anything at all. It may mislead users, which would be a worse outcome than not showing anything at all.</p><h4 id="issue-crashes-reproduction">Reproduction</h4><p>The button below toggles whether the lights are on by simply flipping a boolean in a <span aria-hidden="true">`</span><code translate="no">useState</code><span aria-hidden="true">`</span>. When the lights are turned off, the “There are 4 lights!” text will no longer be rendered through the conditional expression<!-- --> <span aria-hidden="true">`</span><code translate="no">{lightsOn &amp;&amp; &#39;There are 4 lights!&#39;}</code><span aria-hidden="true">`</span>. React tries to reconsolidate this render by removing the <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> from the parent that it added it to. When it does this with Google Translate active, the <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> is no longer a child of the parent, which results in a crash.</p><div><p>Reproduction</p><div><p><label> <!-- -->Simulate Google Translate</label></p><p>There are 4 lights!</p></div></div><p>To reproduce it, the conditional <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> needs to have a sibling of any kind. In React nearly every node that&#39;s conditionally rendered will have a sibling, so this is a common situation.</p><p>Another way of reproducing this crash is by rendering a different amount of <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s within a ternary. The reproduction below also toggles the lights, but instead of rendering nothing when the lights are off, it tries to render the text &#34;The lights are off&#34; through a ternary:<!-- --> <span aria-hidden="true">`</span><code translate="no">{lightsOn ? &lt;&gt;There are {lights} lights!&lt;/&gt; : &lt;&gt;The lights are off&lt;/&gt;}</code><span aria-hidden="true">`</span>.</p><div><p>Reproduction</p><div><p><label> <!-- -->Simulate Google Translate</label></p></div></div><p>The important part of this reproduction is that the sides of the ternary have a different amount of <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s. While it might not be obvious, this is the case here, as React produces three<!-- --> <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s for the<!-- --> <span aria-hidden="true">`</span><code translate="no">&lt;&gt;There are {lights} lights!&lt;/&gt;</code><span aria-hidden="true">`</span> expression.</p><p>This reproduction is a simplified version of what you might have in your app. In the example code, we could have used a single template string for both sides of the ternary. In the real world, these expressions tend to be more complex, making it hard to turn it into a template string.</p><p>As there are more ways to vary the amount of <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s rendered, I&#39;m sure there are more ways of reproducing this crash. This makes it hard to find a workaround that solves all cases.</p><h4 id="workarounds">Workarounds</h4><p>React&#39;s crashes have been reported in<!-- --> <a href="https://github.com/facebook/react/issues/11538">this issue</a> on GitHub. Several workarounds have been posted, but unfortunately, none of the workarounds provide a quick fix. Some just make things worse.</p><p>The below workarounds only focus on the crashes and have absolutely no impact on translated text not updating.</p><h5 id="monkey-patching-removechild-and-insertbefore">1. Monkey patching removeChild and insertBefore</h5><p><i>Gaearon</i>, a member of the React Core team, posted<!-- --> <a href="https://github.com/facebook/react/issues/11538#issuecomment-417504600">a workaround</a> <!-- -->that monkey patches <span aria-hidden="true">`</span><code translate="no">removeChild</code><span aria-hidden="true">`</span> and <span aria-hidden="true">`</span><code translate="no">insertBefore</code><span aria-hidden="true">`</span> <!-- -->to fail silently when they&#39;re called with invalid arguments.</p><p>While this monkey patch succeeds at preventing the crashes, it doesn&#39;t solve the underlying issue at all. Instead of React crashing when it tries to remove a <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> through <span aria-hidden="true">`</span><code translate="no">removeChild</code><span aria-hidden="true">`</span>, it does nothing and<!-- --> <strong>the translated text will remain in the DOM</strong> until its parent is removed. And when the <span aria-hidden="true">`</span><code translate="no">insertBefore</code><span aria-hidden="true">`</span> error is triggered, the <strong>newly rendered text won&#39;t appear</strong> for your user.</p><p>Unless the user is aware of the behavior, both issues make an app almost as unusable as when it would crash.</p><p>Watch this monkey patch in action:</p><div><p>Reproduction</p><div><p><label> <!-- -->Simulate Google Translate</label></p><p>There are 4 lights!</p></div></div><p>You can toggle the Google Translate simulation to see how the component behaves with and without its interference. It also serves as a great way of resetting the component to its initial state.</p><h5 id="surrounding-textnodes-with-spans">2. Surrounding TextNodes with spans</h5><p>GitHub user <i>Shuhei</i> proposed<!-- --> <a href="https://github.com/facebook/react/issues/11538#issuecomment-390386520">a workaround</a> <!-- -->of surrounding all conditionally rendered and adjacent text in<!-- --> <span aria-hidden="true">`</span><code translate="no">span</code><span aria-hidden="true">`</span> elements. This avoids the crashes by ensuring React doesn&#39;t try to remove or insert a <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span> directly.</p><p><strong>This fixes some of the most common crashes, but not all of them.</strong> <!-- -->The crashes caused by conditionally rendered <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s like the <span aria-hidden="true">`</span><code translate="no">{lightsOn &amp;&amp; &#39;There are 4 lights!&#39;}</code><span aria-hidden="true">`</span> expression in the first reproduction above, can be fixed by this workaround. But crashes caused by other conditionally rendered <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s, like those in the ternary expression reproduction, are not.</p><p>Implementing this workaround does require mangling a lot of existing, regular, code. Without an ESLint rule to enforce this, it is going take a lot of pleading in PRs to get your entire team to consistently apply this workaround. And for many the honest truth is that it&#39;s not worth the effort and code quality sacrifice for them.</p><div><p>Aside</p><p><span aria-hidden="true">&gt; <!-- -->Aside<!-- -->: </span>The ESLint plugin<!-- --> <a href="https://github.com/sayari-analytics/eslint-plugin-sayari">eslint-plugin-sayari</a> <!-- -->has a rule that<!-- --> <i>requires <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s that share a common parent with other elements to be wrapped in a <span aria-hidden="true">`</span><code translate="no">&lt;span&gt;</code><span aria-hidden="true">`</span> tag</i>. While this probably catches the problematic expressions, this rule has an extremely high false-positive rate and will require you to wrap nearly all <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s in your app. The ternary crashes are also not solved by this rule.</p></div><h5 id="self-re-rendering-error-boundaries">3. Self re-rendering error boundaries</h5><p>An error boundary that just renders the same children again when it runs into an error is<!-- --> <a href="https://github.com/facebook/react/issues/11538#issuecomment-2052692225">a good idea by GitHub user Sorahn</a>, but unfortunately, any components in the subtree will lose their state in the process. While this could work for some of the instances, it&#39;s not a general solution and if you&#39;re going to be adapting your code anyway, you&#39;re probably better off surrounding your <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s with spans.</p><h3 id="issue-inconsistent-event-target">Issue: Inconsistent <span aria-hidden="true">`</span><code translate="no">event.target</code><span aria-hidden="true">`</span></h3><p>When Google Translate is active, the value of <span aria-hidden="true">`</span><code translate="no">event.target</code><span aria-hidden="true">`</span> <!-- -->becomes unpredictable, as users are likely to click on one of Google Translate&#39;s <span aria-hidden="true">`</span><code translate="no">font</code><span aria-hidden="true">`</span> elements instead of the underlying element that you, as the developer, created and could reasonably expect. In some instances, such as inside overlays, this could lead to click events not working correctly.</p><p>While this issue is very specific and can be worked around with relative ease, very few developers will even be aware of the issue or think to test it.</p><h4 id="issue-inconsistent-event-target-reproduction">Reproduction</h4><p>In the reproduction below, the text of the button gets translated by the Google Translate simulator. When you click anywhere within the reproduction, the element type of the <span aria-hidden="true">`</span><code translate="no">event.target</code><span aria-hidden="true">`</span> (the element you clicked on) will appear in the text underneath the button. Normally when you click the button, <span aria-hidden="true">`</span><code translate="no">event.target</code><span aria-hidden="true">`</span> would refer to the <span aria-hidden="true">`</span><code translate="no">button</code><span aria-hidden="true">`</span>, but with Google Translate, it will be a<!-- --> <span aria-hidden="true">`</span><code translate="no">font</code><span aria-hidden="true">`</span> element instead.</p><p>Click the button. Toggle Google Translate simulation. Click again. Compare results.</p><div><p>Reproduction</p><div><p><label> <!-- -->Simulate Google Translate</label></p></div></div><h2 id="not-just-react">Not just React</h2><p><strong>Google Translate&#39;s interference affects not just React apps.</strong></p><p>Any JavaScript code that manipulates the DOM in a similar fasion is affected. This includes operations such as updating a value of a<!-- --> <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>, adding or removing children, or using<!-- --> <span aria-hidden="true">`</span><code translate="no">event.target</code><span aria-hidden="true">`</span>. These operations are not specific to React.</p><p>However, these issues are more commonly observed in React applications since React is a prominent user of the “<a href="https://reactjs.org/docs/faq-internals.html">Virtual DOM</a>”. The Virtual DOM keeps references to all DOM nodes so it only has to update parts of the DOM that are actually changed (through a process called<!-- --> <a href="https://reactjs.org/docs/reconciliation.html">reconciliation</a>). This allows for high-performance apps, as it&#39;s more efficient than replacing DOM nodes. Because of this, React&#39;s use of a Virtual DOM to reuse and update nodes rather than constantly replacing them is a natural evolution for frameworks.</p><h2 id="not-just-google-translate">Not just Google Translate</h2><p>Most machine translators work pretty much the same way as Google Translate, so the issue is not just limited to it. But the issue is even bigger than that:<!-- --> <strong>any browser extensions that manipulate the DOM can interfere</strong>. Some other examples are:</p><ul><li>Password managers manipulating forms to show prefill dropdowns</li><li>Extensions that inject alternative prices on competing webshops<!-- --> <span role="button" tabindex="0" aria-expanded="false">(*)</span></li><li>An adblocker removing an element</li><li><a href="https://chromewebstore.google.com/detail/eobkhgkgoejnjaiofdmphhkemmomfabg">AutocardAnywhere</a>: Displays card image popups for collectible card games<!-- --> <span role="button" tabindex="0" aria-expanded="false">(*)</span></li></ul><figure><span aria-hidden="true">Picture: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-autocardanywhere.fe3d11d2.png"><img alt="A screenshot of WoWAnalyzer, showing a Magic: the Gathering card popup added by AutocardAnywhere for a random, but matching piece of text." loading="lazy" width="800" height="334" decoding="async" data-nimg="1" sizes="(min-width: 768px) 800px, 100vw" srcset="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=3840&amp;q=75 3840w" src="https://www.fractalkitty.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fgoogle-translate-autocardanywhere.fe3d11d2.png&amp;w=3840&amp;q=75"/></a><figcaption><span aria-hidden="true">Caption: </span><a href="https://www.fractalkitty.com/_next/static/media/google-translate-autocardanywhere.fe3d11d2.png">AutocardAnywhere showing a Magic: the Gathering card for a random piece of text on<!-- --> <span role="button" tabindex="0" aria-expanded="false">WoWAnalyzer</span></a><span aria-hidden="true"></span></figcaption></figure><p>I want to stress that I do not think the team behind Google Translate deserves any blame for the issues. It&#39;s a great tool that helps people worldwide and makes the web usable for many more people. Google Translate was originally architected at a time when the web was very different from what it is today. The issues are a result of the web evolving; websites aren&#39;t almost exclusively static websites anymore as many of the popular websites today are actually large and complex web apps.</p><p>Fixing the issues is also not trivial. For many translations, Google Translate needs to be able to restructure sentences to make them work in the target language. That&#39;s nearly impossible to do without interfering with the DOM.</p><h2 id="there-is-no-real-solution-yet">There is no real solution (yet)</h2><p>At the time of writing, there is, unfortunately, no solution yet that can make Google Translate work well enough with React for a large React app. As mentioned above, the workarounds for the crashes introduce a new set of issues, and they still leave any complex app barely usable after translation by Google Translate.</p><p>There are a couple of things you <em>can</em> do, but I don&#39;t think you&#39;re gonna like them.</p><h3 id="the-regrettable-fix">The regrettable “fix”</h3><p>When I first ran into this issue back in 2017, I posted in the React issue tracker that I had<!-- --> <a href="https://github.com/facebook/react/issues/11538#issuecomment-350110297">”fixed” my app by blocking translation entirely</a>. Now, 7 years later, I am sad to have to report that this still appears to be the only quick way of avoiding all of the issues caused by Google Translate.</p><p>I don&#39;t like solving it this way. It makes apps less accessible to people worldwide. But for some complex apps, it beats serving Google Translate users a broken app that barely works.</p><p>If you&#39;re willing to put in the time and effort,<!-- --> <a href="https://www.fractalkitty.com/blog/everything-about-google-translate-crashing-react#surrounding-textnodes-with-spans">wrapping</a> conditional<!-- --> <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s in <span aria-hidden="true">`</span><code translate="no">span</code><span aria-hidden="true">`</span>s will solve a large chunk of the crashes (but not the other issues). This will usually be good enough for a simple website like this as a typical website isn&#39;t very reactive, has a small codebase, has few developers working on it, and doesn&#39;t show any computed numbers that are critical.</p><p>You will have to carefully consider which of these solutions is the right fit for your app. Leaving Google Translate available will be a big help for some of your users, but it will take some debugging to get it to work well enough and ensure you&#39;re not showing users incorrect data.</p><h3 id="alternatives">Alternatives</h3><p>The only alternative solution that I can think of, is to<!-- --> <strong>implement your own localization within your app</strong> (i.e. internationalization). This makes machine translation unnecessary and provides international users with the best possible experience. But this has a couple of downsides:</p><ul><li>It takes a lot of effort to do at all</li><li>It&#39;s hard to get right</li><li>It slows down development</li><li>Good translators are expensive</li><li>It&#39;s infeasible to cover as many languages as Google Translate covers</li></ul><p>All things considered, this isn&#39;t the most practical solution for most apps. Do you know of any other alternatives?</p><div><p>Aside</p><p><span aria-hidden="true">&gt; <!-- -->Aside<!-- -->: </span>There might be a possible (external) workaround in React that uses a similar mechanic to React Dev Tools&#39;s “render highlighting” to trigger remounting (by React) of the entire parent of <span aria-hidden="true">`</span><code translate="no">TextNode</code><span aria-hidden="true">`</span>s that are changed. However, I looked into the feature&#39;s code and that is part of a &gt;4500 LOC file so it seemed more involved than I bargained for. Maybe someone else can take a look at it.</p></div><h2 id="conclusion">Conclusion</h2><p>That&#39;s everything about Google Translate crashing React apps (and other web apps). Or, as we&#39;ve discovered, everything about third-party browser extension DOM manipulation interfering with complex JavaScript app reactivity, often leading to crashes and other issues.</p><p>I hope this article will help you understand the issues and help you choose the right way to deal with them in your app.</p><p>Please help bring attention to this issue by upvoting its bug report on the Chromium project:<!-- --> <a href="https://issues.chromium.org/issues/41407169">https://issues.chromium.org/issues/41407169</a>. The increased attention can help the chances of the issues being addressed.</p><p>So what do you think? Can you think of any other workarounds? Or do you know a machine translator that doesn&#39;t have these issues? Please share your insights through the links below.</p><p>ps. In the <a href="https://www.fractalkitty.com/blog/everything-about-google-translate-crashing-react#addendum">addendum</a> below, I discuss whether it is reasonable for an app to claim full and exclusive control of the DOM, as React does with its Virtual DOM.</p></div></div>
  </body>
</html>
