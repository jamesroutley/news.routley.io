<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://weblog.antranigv.am/posts/2022/11/running-arm64-aarch64-freebsd-on-qemu-utm-app-on-apple-silicon/">Original</a>
    <h1>Running Arm64.aarch64 FreeBSD on QEMU/UTM.app on Apple Silicon</h1>
    
    <div id="readability-page-1" class="page"><article id="post-347">
				<!-- .entry-header -->

				<div>
			
<p>Around a year ago I got an M1 MacBook Air for work. At this point, a lot of people that I know use these Apple Silicon machines.</p>



<p>While my personal machine is running FreeBSD, many times I’ve been in a situation where I need to run FreeBSD on my M1 MacBook Air, at least as a Virtual Machine.</p>



<p>For 9 months I’ve been running the AMD64 version of FreeBSD on QEMU/UTM.app using emulation. It gets the job done.</p>



<p>But whenever I want to do FreeBSD development, I need a fast machine. While M1 is pretty fast, VM emulation is still slow.</p>



<p>The problem is that whenever I booted the arm64.aarch64 FreeBSD on QEMU, it would use so much CPU on the host, that my battery would die in an hour or so.</p>



<figure><img width="1024" height="755" src="https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM-1024x755.png" alt="" srcset="https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM-1024x755.png 1024w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM-300x221.png 300w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM-768x567.png 768w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM-1536x1133.png 1536w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM-624x460.png 624w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.34.06-PM.png 1578w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>







<p>After a lot of searching, I finally found <a rel="noreferrer noopener" href="https://gitlab.com/qemu-project/qemu/-/issues/959#note_958638627" target="_blank">this</a>, <a rel="noreferrer noopener" href="https://forums.freebsd.org/threads/kern-hz-what-is-it-and-why-is-it-needed-on-a-vm.43427/" target="_blank">this</a> and <a rel="noreferrer noopener" href="https://www.neelc.org/posts/freebsd-dummynet-kernhz/" target="_blank">this</a>, which eventually got me to <a href="https://docs.freebsd.org/en/books/handbook/virtualization/#virtualization-guest-parallelsdesktop" target="_blank" rel="noreferrer noopener">this page on the handbook</a></p>



<blockquote><p>1. Set Boot Loader Variables</p><p><code>kern.hz=100</code></p><p>Without this setting, an idle FreeBSD Parallels guest will use roughly 15% of the CPU of a single processor iMac®. After this change the usage will be closer to 5%.</p><cite><a href="https://docs.freebsd.org/en/books/handbook/virtualization/#virtualization-guest-parallels-configure" target="_blank" rel="noreferrer noopener">Configuring FreeBSD on Parallels</a></cite></blockquote>



<p>So I tried that, and here you go!</p>



<figure><img loading="lazy" width="1024" height="641" src="https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM-1024x641.png" alt="" srcset="https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM-1024x641.png 1024w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM-300x188.png 300w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM-768x480.png 768w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM-1536x961.png 1536w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM-624x390.png 624w, https://weblog.antranigv.am/wp-content/uploads/2022/11/Screen-Shot-2022-11-20-at-12.35.54-PM.png 1608w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>







<p>Ahh, finally, I can <a rel="noreferrer noopener" href="https://reviews.freebsd.org/D37383" target="_blank">do some work</a>.</p>



<p><em>That’s all folks…</em></p>
					</div><!-- .entry-content -->
		
		<!-- .entry-meta -->
	</article></div>
  </body>
</html>
