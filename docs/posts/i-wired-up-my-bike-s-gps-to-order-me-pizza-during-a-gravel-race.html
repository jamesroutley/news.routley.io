<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://steele.blue/geofence-pizza-ordering/">Original</a>
    <h1>I wired up my bike&#39;s GPS to order me pizza during a gravel race</h1>
    
    <div id="readability-page-1" class="page"><div><p>As harvest season begins here in the Midwest, I once again celebrate by grinding Nebraska gravel at the <a href="https://www.gravel-worlds.com/the-long-voyage">Gravel Worlds Long Voyage</a> bike race.
As in previous years (<a href="https://www.moderndescartes.com/gravel-worlds">2021</a>) (<a href="https://www.moderndescartes.com/serverless-bike-gps">2022</a>), I spent more time writing code for a marginally-useful project than I did training. But hey, I finished!</p>
<p><span>
      <a href="https://www.moderndescartes.com/static/9edd5fd38a7e5307edffcc6c56066780/b4e28/matt-gw.jpg" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/9edd5fd38a7e5307edffcc6c56066780/3e828/matt-gw.webp 192w,
/static/9edd5fd38a7e5307edffcc6c56066780/e6f2f/matt-gw.webp 384w,
/static/9edd5fd38a7e5307edffcc6c56066780/8b983/matt-gw.webp 768w,
/static/9edd5fd38a7e5307edffcc6c56066780/b2d4b/matt-gw.webp 1152w,
/static/9edd5fd38a7e5307edffcc6c56066780/0abaa/matt-gw.webp 1536w,
/static/9edd5fd38a7e5307edffcc6c56066780/11d0e/matt-gw.webp 4005w" sizes="(max-width: 768px) 100vw, 768px" type="image/webp"/>
          <source srcset="/static/9edd5fd38a7e5307edffcc6c56066780/7809d/matt-gw.jpg 192w,
/static/9edd5fd38a7e5307edffcc6c56066780/4ecad/matt-gw.jpg 384w,
/static/9edd5fd38a7e5307edffcc6c56066780/212bf/matt-gw.jpg 768w,
/static/9edd5fd38a7e5307edffcc6c56066780/5ef17/matt-gw.jpg 1152w,
/static/9edd5fd38a7e5307edffcc6c56066780/ac99c/matt-gw.jpg 1536w,
/static/9edd5fd38a7e5307edffcc6c56066780/b4e28/matt-gw.jpg 4005w" sizes="(max-width: 768px) 100vw, 768px" type="image/jpeg"/>
          <img src="https://www.moderndescartes.com/static/9edd5fd38a7e5307edffcc6c56066780/212bf/matt-gw.jpg" alt="Matt riding on Gravel Worlds" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<h2>Fueled by Pizza</h2>
<p>My goal this year involved optimizing my food choices during the race: pizza from <a href="https://www.caseys.com/">Casey&#39;s General Store</a>.
These convenience stores are S-Tier options when out in the middle of nowhere.
In addition to snacks and drinks, most Casey&#39;s have a kitchen, and have pretty decent grab &#39;n go slices of pizza.</p>
<p><span>
      <a href="https://www.moderndescartes.com/static/7a9200edb092ed758a6ad507f4287d98/6aca1/self-serve-pizza.jpg" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/7a9200edb092ed758a6ad507f4287d98/3e828/self-serve-pizza.webp 192w,
/static/7a9200edb092ed758a6ad507f4287d98/e6f2f/self-serve-pizza.webp 384w,
/static/7a9200edb092ed758a6ad507f4287d98/c1dc5/self-serve-pizza.webp 650w" sizes="(max-width: 650px) 100vw, 650px" type="image/webp"/>
          <source srcset="/static/7a9200edb092ed758a6ad507f4287d98/7809d/self-serve-pizza.jpg 192w,
/static/7a9200edb092ed758a6ad507f4287d98/4ecad/self-serve-pizza.jpg 384w,
/static/7a9200edb092ed758a6ad507f4287d98/6aca1/self-serve-pizza.jpg 650w" sizes="(max-width: 650px) 100vw, 650px" type="image/jpeg"/>
          <img src="https://www.moderndescartes.com/static/7a9200edb092ed758a6ad507f4287d98/6aca1/self-serve-pizza.jpg" alt="A sample of the pizza on offer at a Casey&#39;s" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>My problem: last year, there were so many faster riders ahead of me, that <strong>all the pizza was taken by the time I made it to the stops.</strong> This is an outrage!</p>
<p>This year, I knew I had to do better. But with time winding down on improving my fitness, I had to resort to the latent superpower of software hackery.
My thought: <strong>why not have a fresh pizza ordered ahead of time, scheduled precisely for when I arrived?</strong></p>
<p>More precisely, I could write a script that ordered a pizza for me, GPS-triggered by my bike leaving a geofence about an hour from the stop. Building this <a href="https://www.moderndescartes.com/serverless-bike-gps">on top of the serverless GPS tracker I made last year</a> should fit into the architecture pretty well.</p>
<h2>Casey&#39;s Pizza API When</h2>
<p><span>
      <a href="https://www.moderndescartes.com/static/f1fdd6640cd5211fda59075e28ff7c6e/e185b/pizza-diagram.png" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/f1fdd6640cd5211fda59075e28ff7c6e/3e828/pizza-diagram.webp 192w,
/static/f1fdd6640cd5211fda59075e28ff7c6e/e6f2f/pizza-diagram.webp 384w,
/static/f1fdd6640cd5211fda59075e28ff7c6e/c0989/pizza-diagram.webp 691w" sizes="(max-width: 691px) 100vw, 691px" type="image/webp"/>
          <source srcset="/static/f1fdd6640cd5211fda59075e28ff7c6e/8514f/pizza-diagram.png 192w,
/static/f1fdd6640cd5211fda59075e28ff7c6e/804b2/pizza-diagram.png 384w,
/static/f1fdd6640cd5211fda59075e28ff7c6e/e185b/pizza-diagram.png 691w" sizes="(max-width: 691px) 100vw, 691px" type="image/png"/>
          <img src="https://www.moderndescartes.com/static/f1fdd6640cd5211fda59075e28ff7c6e/e185b/pizza-diagram.png" alt="Architecture diagram" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>The overall design: I setup a geofence within the AWS Location service, which was monitoring my GPS tracker.
When my tracker exited the geofence, it would trigger a Lambda function that calculates an ETA for my next stop, and orders the pizza.</p>
<p>The problem: Casey&#39;s doesn&#39;t have a public API for online ordering.
So I had to resort to alternate approaches. More specifically, I fell back to <strong>screen scraping the website</strong>, everyone&#39;s favorite hack.
I&#39;ve had to screen-scrape for other projects (such as <a href="https://www.moderndescartes.com/secret-strava">updating privacy on Strava activities</a>), but since Casey&#39;s website was a complex React app that rendered everything on the client, I had to use a more powerful scraper; this time powered by <a href="https://playwright.dev/">Playwright</a>.</p>
<p>Getting Playwright to run in a Lambda was An Experience. Full writeup <a href="https://www.moderndescartes.com/playwright-on-lambda">here</a>.</p>
<p>To keep track of the status, I also setup a push notification to be delivered to my phone (and watch) on a success or failure. Configuring Web Push to work on iOS devices is probably worthy of its own post.</p>
<h2>Pizza False Positive</h2>
<p>I had the triggering geofence configured around mile 180 of the race, with the pizza setup to be delivered at mile 200.</p>
<p><span>
      <a href="https://www.moderndescartes.com/static/e1196b964a5d4a318c649926731f0d76/b17f8/pizza-watch.jpg" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/e1196b964a5d4a318c649926731f0d76/3e828/pizza-watch.webp 192w,
/static/e1196b964a5d4a318c649926731f0d76/e6f2f/pizza-watch.webp 384w,
/static/e1196b964a5d4a318c649926731f0d76/8b983/pizza-watch.webp 768w,
/static/e1196b964a5d4a318c649926731f0d76/b2d4b/pizza-watch.webp 1152w,
/static/e1196b964a5d4a318c649926731f0d76/0abaa/pizza-watch.webp 1536w,
/static/e1196b964a5d4a318c649926731f0d76/fad48/pizza-watch.webp 1600w" sizes="(max-width: 768px) 100vw, 768px" type="image/webp"/>
          <source srcset="/static/e1196b964a5d4a318c649926731f0d76/7809d/pizza-watch.jpg 192w,
/static/e1196b964a5d4a318c649926731f0d76/4ecad/pizza-watch.jpg 384w,
/static/e1196b964a5d4a318c649926731f0d76/212bf/pizza-watch.jpg 768w,
/static/e1196b964a5d4a318c649926731f0d76/5ef17/pizza-watch.jpg 1152w,
/static/e1196b964a5d4a318c649926731f0d76/ac99c/pizza-watch.jpg 1536w,
/static/e1196b964a5d4a318c649926731f0d76/b17f8/pizza-watch.jpg 1600w" sizes="(max-width: 768px) 100vw, 768px" type="image/jpeg"/>
          <img src="https://www.moderndescartes.com/static/e1196b964a5d4a318c649926731f0d76/212bf/pizza-watch.jpg" alt="A push notification indicating pizza was delivered" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>As I left the geofence, I got a push notification on my watch saying that the pizza had been successfully ordered.</p>
<p>But when I made it to the stop, <strong>there was nothing at the counter, and they had no record of an order</strong>. And sure enough, I checked my account, and no order had been placed.
<strong>False positive.</strong></p>
<p>There were a few pre-made slices available, so I picked those up. They left a bitter taste in my mouth, not just because they weren&#39;t especially fresh. Through the rest of the 300-mile race, all I could think about was what might have went wrong with my function.</p>
<p><span>
      <a href="https://www.moderndescartes.com/static/dc526fd97ae4db5306832ed8945751be/b17f8/pizza-slices.jpg" target="_blank" rel="noopener">
    <span></span>
  <picture>
          <source srcset="/static/dc526fd97ae4db5306832ed8945751be/3e828/pizza-slices.webp 192w,
/static/dc526fd97ae4db5306832ed8945751be/e6f2f/pizza-slices.webp 384w,
/static/dc526fd97ae4db5306832ed8945751be/8b983/pizza-slices.webp 768w,
/static/dc526fd97ae4db5306832ed8945751be/b2d4b/pizza-slices.webp 1152w,
/static/dc526fd97ae4db5306832ed8945751be/0abaa/pizza-slices.webp 1536w,
/static/dc526fd97ae4db5306832ed8945751be/fad48/pizza-slices.webp 1600w" sizes="(max-width: 768px) 100vw, 768px" type="image/webp"/>
          <source srcset="/static/dc526fd97ae4db5306832ed8945751be/7809d/pizza-slices.jpg 192w,
/static/dc526fd97ae4db5306832ed8945751be/4ecad/pizza-slices.jpg 384w,
/static/dc526fd97ae4db5306832ed8945751be/212bf/pizza-slices.jpg 768w,
/static/dc526fd97ae4db5306832ed8945751be/5ef17/pizza-slices.jpg 1152w,
/static/dc526fd97ae4db5306832ed8945751be/ac99c/pizza-slices.jpg 1536w,
/static/dc526fd97ae4db5306832ed8945751be/b17f8/pizza-slices.jpg 1600w" sizes="(max-width: 768px) 100vw, 768px" type="image/jpeg"/>
          <img src="https://www.moderndescartes.com/static/dc526fd97ae4db5306832ed8945751be/212bf/pizza-slices.jpg" alt="A pair of dirty legs, eating slices of pre-made pizza" title="" loading="lazy" decoding="async"/>
        </picture>
  </a>
    </span></p>
<p>After finishing the race, I made it to a computer and quickly checked the logs to see what had gone wrong. But to my chagrin, there was nothing in the logs indicating what caused the failure; it was just a silent success. I had nothing to go on to try and debug.</p>
<p>A few days later, I enhanced the Lambda to capture a video of the browser in action and upload it to an S3 bucket for analysis. Running a test of the updated behavior, <strong>it finally worked</strong>. I picked up a fresh Hawaiian pizza, and we enjoyed the pie from the comfort of our home.</p>
<p>I&#39;m still not entirely sure why it worked. My going theory is that the Lambda had terminated processing as soon as the final <code>form.submit()</code> went through in the embedded Playwright browser. It&#39;s quite possible that the online ordering website saw that the browser never received a Success response, and didn&#39;t fully process the order.
My guess is that the additional time spent processing and uploading the video gave the browser sufficient time to clean up properly, with serendipity in timing.</p>
<h2>Pizza Lessons</h2>
<p>While I was bummed the pizza ordering functionality didn&#39;t run, I think it&#39;s in a good spot to try again in upcoming races.
I also learned a lot while building this out:</p>
<ul>
<li>Consistently screen-scraping a React client-side app with a browser running in the cloud: possible, but boy howdy is it finicky. If I were to redo project, I may opt for reverse engineering one of their native apps, focusing on triggering their APIs directly</li>
<li>Having a good workflow to simulate geospatial behavior is necessary. At first, I setup a geofence around my house for testing, but having to leave for a walk at 11pm gets pretty old, pretty fast</li>
<li>That said, don&#39;t skimp on real-world testing. Prior to the race, I was mostly testing the function by running it on my local workstation, not in a Lambda. The successes of the local functions gave me false confidence that everything was working as expected</li>
<li>If you&#39;re worried about running out of Casey&#39;s pizza during a gravel race, another option is to just let the groups ahead of you get more than 30 minutes ahead, so they have plenty of time to make more slices</li>
</ul>
<p>The code is available on GitHub: <a href="https://github.com/mattdsteele/spot-tracker-tracker/tree/main/pizza-function">https://github.com/mattdsteele/spot-tracker-tracker/tree/main/pizza-function</a></p></div></div>
  </body>
</html>
