<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://devenv.sh/blog/2025/08/22/closing-the-nix-gap-from-environments-to-packaged-applications-for-rust/">Original</a>
    <h1>Closing the Nix gap: From environments to packaged applications for rust</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="container">
      
      
        
      
      <main data-md-component="main">
        <div>
          
            
              
                
              
              
            
            
              
                
              
              
            
          
          
  <div data-md-component="content">
    
    <article>
      
        

  
    <a href="https://github.com/cachix/devenv/edit/main/docs/blog/posts/closing-the-nix-gap-from-tools-to-packaged-applications.md" title="Edit this page">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"></path></svg>
    </a>
  
  



<blockquote><p lang="en" dir="ltr">Should I use crate2nix, cargo2nix, or naersk for packaging my Rust application?</p>— (@jvmncs) <a href="https://twitter.com/jvmncs/status/1927120951918891508">January 21, 2025</a></blockquote>


<p>This tweet shows a common problem in Nix: &#34;Should I use crate2nix, cargo2nix, or naersk for packaging my Rust application?&#34;</p>
<p>devenv solved this for development environments differently: instead of making developers package everything with Nix, we provide tools through a simple <code>languages.rust.enable</code>. You get <code>cargo</code>, <code>rustc</code>, and <code>rust-analyzer</code> in your shell without understanding Nix packaging.</p>
<p>But when you&#39;re ready to deploy, you face the same problem: which lang2nix tool should you use? Developers don&#39;t want to compare <code>crate2nix</code> vs <code>cargo2nix</code> vs <code>naersk</code> vs <code>crane</code>—they want a tested solution that works.</p>
<p>devenv now provides <code>languages.rust.import</code>, which packages Rust applications using <a href="https://github.com/nix-community/crate2nix">crate2nix</a>. We evaluated the available tools and chose crate2nix, so you don&#39;t have to.</p>
<p>We&#39;ve done this before. In <a href="https://github.com/cachix/devenv/pull/1500">PR #1500</a>, we replaced <a href="https://github.com/nix-community/fenix">fenix</a> with <a href="https://github.com/oxalica/rust-overlay">rust-overlay</a> for Rust toolchains because rust-overlay was better maintained. Users didn&#39;t need to change anything—devenv handled the transition while keeping the same <code>languages.rust.enable = true</code> interface.</p>
<h2 id="one-interface-for-all-languages">One Interface for All Languages</h2>
<p>The typical workflow:</p>
<ol>
<li><strong>Development</strong>: Enable the language (<code>languages.rust.enable = true</code>) to get tools like <code>cargo</code>, <code>rustc</code>, and <code>rust-analyzer</code>.</li>
<li><strong>Packaging</strong>: When ready to deploy, use <code>languages.rust.import</code> to package with Nix.</li>
</ol>
<p>The same pattern works for all languages:</p>
<div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span>{</span> config<span>,</span> <span>...</span> <span>}:</span> <span>{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  <span># https://devenv.sh/languages</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  <span>languages</span> <span>=</span> <span>{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    rust<span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    python<span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    go<span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  <span>};</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  <span># https://devenv.sh/outputs</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  <span>outputs</span> <span>=</span> <span>{</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span>rust-app</span> <span>=</span> config<span>.</span>languages<span>.</span>rust<span>.</span><span>import</span> <span>./rust-app</span> <span>{};</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span>python-app</span> <span>=</span> config<span>.</span>languages<span>.</span>python<span>.</span><span>import</span> <span>./python-app</span> <span>{};</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span>go-app</span> <span>=</span> config<span>.</span>languages<span>.</span>go<span>.</span><span>import</span> <span>./go-app</span> <span>{};</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>  <span>};</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span>}</span>
</code></pre></div>
<h2 id="starting-with-rust">Starting with Rust</h2>
<p><code>languages.rust.import</code> automatically generates Nix expressions from <code>Cargo.toml</code> and <code>Cargo.lock</code>.</p>
<p>Add the crate2nix input:</p>
<div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span>$ </span>devenv<span> </span>inputs<span> </span>add<span> </span>crate2nix<span> </span>github:nix-community/crate2nix<span> </span>--follows<span> </span>nixpkgs
</code></pre></div>
<p>Import your Rust application:</p>
<div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span>{</span> config<span>,</span> <span>...</span> <span>}:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span>let</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>  <span># ./app is the directory containing your Rust project&#39;s Cargo.toml</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>  <span>myapp</span> <span>=</span> config<span>.</span>languages<span>.</span>rust<span>.</span><span>import</span> <span>./app</span> <span>{};</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span>in</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span>{</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>  <span># Provide developer environment</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>  languages<span>.</span>rust<span>.</span><span>enable</span> <span>=</span> <span>true</span><span>;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>  <span># Expose our application inside the environment</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>  <span>packages</span> <span>=</span> <span>[</span> myapp <span>];</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>  <span># https://devenv.sh/outputs</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>  <span>outputs</span> <span>=</span> <span>{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span>inherit</span> myapp<span>;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>  <span>};</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span>}</span>
</code></pre></div>
<p>Build your application:</p>
<div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span>$ </span>devenv<span> </span>build<span> </span>outputs.myapp
</code></pre></div>
<h2 id="other-languages">Other Languages</h2>
<p>This API extends to other languages, each using the best packaging tool:</p>
<p>We&#39;ve also started using <a href="https://github.com/pyproject-nix/uv2nix">uv2nix</a> to provide a similar interface for Python in <a href="https://github.com/cachix/devenv/pull/2115">PR #2115</a>.</p>
<h2 id="thats-it">That&#39;s it</h2>
<p>For feedback, join our <a href="https://discord.gg/naMgvexb6q">Discord community</a>.</p>
<p>Domen</p>







  
  




  



      
    </article>
  </div>

          
  


        </div>
        
          
        
      </main>
      


    </div></div>
  </body>
</html>
