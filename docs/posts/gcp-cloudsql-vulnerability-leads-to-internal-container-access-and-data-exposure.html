<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.dig.security/post/gcp-cloudsql-vulnerability-leads-to-internal-container-access-and-data-exposure">Original</a>
    <h1>GCP CloudSQL Vulnerability Leads to Internal Container Access and Data Exposure</h1>
    
    <div id="readability-page-1" class="page"><div><p>One of the top three cloud providers is Google Cloud Platform (GCP), which offers a range of services including a managed database service called CloudSQL. CloudSQL is capable of supporting three different database engines: MySQL, PostgreSQL, and SQL Server.</p><p>By their nature, databases tend to contain large amounts of information, and often contain sensitive information such as <a href="https://www.dig.security/glossary/pii">PII</a>, Developer Secrets, and even financial data like bank accounts or credit cards. In our research, we chose to focus on CloudSQL because of its potential impact on customer data.</p><p>Many vulnerabilities have been disclosed in MySQL and PostgreSQL hosted in all 3 major cloud environments (<a href="https://www.dig.security/dig-for-gcp">GCP</a>, <a href="https://www.dig.security/aws">AWS</a> and <a href="https://www.dig.security/dig-for-azure">Azure</a>). The integration of database engines to native CSP services required significant changes to be made which exposed new risks and vulnerabilities. Unlike the other two, SQL Server is not an open-source DB, which means that it could not be modified by the cloud providers. To integrate SQL Server to their environments, cloud providers built their own security layer on top of the database engine. </p><p>In this blog, we reveal a new critical vulnerability in GCP CloudSQL service that was discovered by our Dig research team.</p><h2>SQL Server Basics</h2><p>SQL server has 4 system databases: </p><div><table>
<tbody>
<tr>
<td>
<p><strong>Database Name</strong></p>
</td>
<td>
<p><strong>Description</strong></p>
</td>
</tr>
<tr>
<td>
<p>Master </p>
</td>
<td>
<p>contains all the system objects, and information about the SQL Server instance</p>
</td>
</tr>
<tr>
<td>
<p>MSDB</p>
</td>
<td>
<p>used by SQL Server Agent for scheduling alerts and jobs</p>
</td>
</tr>
<tr>
<td>
<p>Model</p>
</td>
<td>
<p>used as a template, for every new database created on the SQL Server instance</p>
</td>
</tr>
<tr>
<td>
<p>Temp</p>
</td>
<td>
<p> used to hold temporary objects and result sets for sorting, aggregation etc.</p>
</td>
</tr>
</tbody>
</table></div><h3>Understanding SQL Server permissions: server permissions vs. database permissions</h3><p>To gain a better understanding of this new vulnerability and its impact, it’s important to understand how permissions are structured in SQL server.</p><p><strong>Server permissions</strong> contain operations that are done on the instance level, for example CREATE / ALTER / DROP database (or other objects like logins, audit etc.)</p><p><strong>Database permissions</strong> contain CREATE / ALTER / DROP on objects inside the database (like tables, triggers, users etc.).<br/></p><p>`CONTROL DATABASE` is the most powerful permission a user can be granted on the database level.</p><h3>Default permissions on GCP SQL server</h3><p>The default permissions that are granted to a user define the starting point to our research as described below:</p><ul role="list"><li>The default login and user for SQL Server on GCP is `sqlserver`, and is granted with the GCP role `CustomerDbRootRole`.</li><li>This role does not allow the default `sqlserver` user to create/alter anything on the server level.</li><li>The default user has no permissions on sys objects, which means that the user cannot create objects in any system database.</li></ul><h2>Vulnerability discovery: escalating from a basic CloudSQL user to full-fledged sysadmin on the container</h2><p>Following are the steps in which this vulnerability was uncovered:</p><h3>First hop: privilege escalation to DbRootRole</h3><p>Our research began when we identified a gap in GCP’s security layer that was created for SQL Server. This vulnerability enabled us to escalate our initial privilege and add our user to the DbRootRole role, a GCP admin role.</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e3744706bc7d19dffab87_4207564b.png" alt=""/></p></figure><p>The screenshot below shows that the principal `sqlserver` is a member of both `DbRootRole` and `CustomerDbRootRole`:</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e3744666056406b34d720_f1ac97dc.png" alt=""/></p></figure><h3>Second hop: Gaining control on the host container</h3><p>With the role `DbRootRole` we were able to do many things that we didn’t have permission to do before. Still, the `DbRootRole` is not a sysadmin role and doesn’t have full permissions on the SQL Server instance.</p><p>As our research progressed, we found another critical misconfiguration in the roles permissions architecture, which enabled us to further escalate our privilege, and this time we could grant our user the `sysadmin` role.</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e374557fb1cd2ed9bf5e6_e0f511ce.png" alt=""/></p></figure><p>At this point we bypassed the barrier and got full control on the SQL Server.</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e3744f05d0d5acffc249d_94f0aa5d.png" alt=""/></p><figcaption> `sqlserver` user default privileges</figcaption></figure><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e3745ac95ad31a09a32e2_d5409a86.png" alt=""/></p><figcaption>`sqlserver` user privileges after second privilege escalation</figcaption></figure><h3>The Impact: Gaining access to all the data</h3><p>By assuming complete control on the database engine, our user was granted access to the operating system hosting the database. At this point <strong>we could access sensitive files in the host OS, list files and sensitive paths, read passwords, and extract secrets from the machine.</strong></p><p>In addition, the host has access to the underlying <a href="https://cloud.google.com/iam/docs/service-agents" target="_blank">service agents</a> which could potentially lead to further escalation to other environments.</p><p>Gaining access to internal data like secrets, URLs, and passwords can lead to exposure of cloud providers’ data and customers’ sensitive data which is a major security incident.</p><p>With access to the operating system, we managed to find some internal Google URLs related to the docker image repository. We could also access the internal repo which later was fixed and the access from non internal IPs was blocked. </p><p>Google’s internal docker image repository URL:</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e374457fb1cd2ed9bf5c6_6ab4162f.png" alt=""/></p></figure><p>‍</p><p>Reading /etc/passwd:</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e3746b867ad036c58d273_2e8a2819.png" alt=""/></p></figure><p>‍</p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e374457fb1cd2ed9bf5d6_b0ea1023.png" alt=""/></p></figure><h3>The disclosure process: Collaborating with Google VRP Program</h3><p><strong>The professional team at Google identified our research activity</strong> within 8 days of our initial vulnerability discovery. The team reached to us with the following email:<br/></p><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image"><p><img src="https://global-uploads.webflow.com/626906cc9bbea5926711ae5c/646e3744b867ad036c58d163_0d520def.png" alt=""/></p></figure><p>The following weeks were dedicated to collaborating with the Google team to address the newly discovered security vulnerability, resolve it, and handle the necessary formalities related to the finding.</p><p>Needless to say that if you tried to follow the hops described above - <strong>it is no longer possible.</strong></p><h3>Research Timelines </h3><ul role="list"><li><strong>February 5th 2023 </strong>- GCP CloudSQL vulnerability discovered by Dig’s research team.</li><li><strong>February 13th 2023</strong> - Google’s vulnerability reward program identified activity and reached out to Dig’s research team.</li><li><strong>During April 2023</strong> -The vulnerability was successfully addressed and resolved. </li><li><strong>April 25 2023</strong> - We were rewarded by GCP VRP program.</li></ul><p>‍</p><h3>Dig Security: Helping organizations protect their sensitive data with DSPM and DDR</h3><p>Dig is an agentless multi-cloud data security platform that discovers, classifies and protects sensitive data. Using Dig’s data classification engine, you can quickly locate your most critical data and organizational “crown jewels” in structured and unstructured data assets. </p><p>Dig prevents exposure of sensitive data with full data security posture management (<a href="https://www.dig.security/post/the-big-guide-to-data-security-posture-management-dspm">DSPM</a>) capabilities, highlighting data misconfigurations, access anomalies and data vulnerabilities that increase the risk of a data breach. Dig is the first to provide real-time data detection and response (<a href="https://www.dig.security/post/an-introduction-to-data-detection-and-response-ddr">DDR</a>) engine to ensure an immediate handling of newly discovered data related incidents by integrating with existing security solutions. </p><p>Get your free <a href="https://www.dig.security/pages/data-risk-assessment">data risk assessment</a> today.</p></div></div>
  </body>
</html>
