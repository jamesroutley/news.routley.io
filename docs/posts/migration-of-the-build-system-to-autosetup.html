<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sqlite.org/forum/forumpost/b7e2d83c0bcfae1e">Original</a>
    <h1>Migration of the build system to autosetup</h1>
    
    <div id="readability-page-1" class="page"><div><div id="forum48135">

<h3>(1)
By Stephan Beal (stephan) on 2024-10-21 18:53:13
[source]
</h3>
<div>
<div>

<p>Good evening, folks,</p>

<p>As Richard just posted in the &#34;announce&#34; list for the 3.47.0 release:</p>

<blockquote>
<p>During the next release cycle, we are planning to do an overhaul of the &#34;configure; make&#34; system for SQLite.  This is intended to be an improvement.  We will try really, really hard not to break anything.  But because we don&#39;t know all the creative ways that people are currently using &#34;configure; make&#34; now, our changes will be impossible to test thoroughly.  We would appreciate your help in trying out the new &#34;configure; make&#34; found in periodic pre-release snapshots that we will make available.  Please do not wait until the next official release to discover that we have accidentally broken your particular build, and then complain.  Better to find these problems early.</p>
</blockquote>

<p>To elaborate on that...</p>

<p>That work is currently going on in <a href="https://sqlite.org/src/timeline?r=autosetup">the autosetup branch</a>, and ‚Üê that link has a description of the motivation for this migration, as well as the perceived benefits and down-sides.</p>

<p>For those of you who simply run &#34;./configure &amp;&amp; make&#34;, very little, if anything, will change.  The parts of the build which most folks use day-to-day are already migrated to the newer system, but there are the obligatory pending TODOs and FIXMEs, mostly summarized at the top of <code>Makefile.in</code>.</p>

<p>This change <em>will</em> require some adaptation on <em>some</em> folks&#39; automated build processes. i.e. some build-level breakage is unavoidable.  We are making every effort to avoid gratuitous breakage, though.</p>

<p>Please alert us to any new breakage here in the forum.</p>

<p>Sidebar: these changes only apply to platforms which use the &#34;configure&#34; process, i.e. Unix-like environments. Vanilla Windows builds are unaffected and we will continue to provide static makefiles for Windows.</p>

</div>

</div>

</div>
<div id="forum48149">
<h3>(2)
By Roger Binns (rogerbinns) on 2024-10-21 21:54:38
in reply to 1
[link]
[source]
</h3>
<div>
<div>

<p>I need to know the various <code>-DHAVE_</code> values because I am compiling SQLite with Python&#39;s build system not SQLite&#39;s.  Currently I do it by running configure and parsing the generated Makefile and looking for the <code>DEFS =</code> line.</p>

<p>Please include a way of getting them. I&#39;m happy to change my code.</p>

</div>

</div>

</div>
<div id="forum48150">
<h3>(3)
By Stephan Beal (stephan) on 2024-10-21 22:08:39
in reply to 2
[link]
[source]
</h3>
<div>
<div>

<blockquote>
<p>Currently I do it by running configure and parsing the generated Makefile and looking for the DEFS = line.</p>
</blockquote>

<p>FWIW, we&#39;re currently doing something similar in the ext/wasm build and i hate that ;).</p>

<p>In the off chance that you don&#39;t already know this: more reliable than parsing the makefile is using GNU make&#39;s <code>-n</code> and <code>-p</code> flags, like so:</p>
<pre><code>$ make -pn | grep -e &#39;^SHELL_OPT&#39;
SHELL_OPT = -DSQLITE_DQS=0 -DSQLITE_ENABLE_FTS4 -DSQLITE_ENABLE_RTREE -DSQLITE_ENABLE_EXPLAIN_COMMENTS -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION -DSQLITE_ENABLE_STMTVTAB -DSQLITE_ENABLE_DBPAGE_VTAB -DSQLITE_ENABLE_DBSTAT_VTAB -DSQLITE_ENABLE_BYTECODE_VTAB -DSQLITE_ENABLE_OFFSET_SQL_FUNC -DSQLITE_STRICT_SUBTYPE=1
</code></pre>
<ul>
<li><code>-p</code> = print the make &#34;database&#34;</li>
<li><code>-n</code> = don&#39;t build anything</li>
</ul>

<p>BSD make has <code>-n</code> but not <code>-p</code>, but i only this moment learned that BSD make has something arguably more interesting than <code>-p</code>:</p>
<pre><code>$ bmake -V SHELL_OPT
-DSQLITE_DQS=0 -DSQLITE_ENABLE_FTS4 -DSQLITE_ENABLE_RTREE -DSQLITE_ENABLE_EXPLAIN_COMMENTS -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION -DSQLITE_ENABLE_STMTVTAB -DSQLITE_ENABLE_DBPAGE_VTAB -DSQLITE_ENABLE_DBSTAT_VTAB -DSQLITE_ENABLE_BYTECODE_VTAB -DSQLITE_ENABLE_OFFSET_SQL_FUNC -DSQLITE_STRICT_SUBTYPE=1
</code></pre>
<blockquote>
<p>Please include a way of getting them.</p>
</blockquote>

<p>Which var(s) are you looking for? We don&#39;t have any named &#34;DEFS&#34; (unless they&#39;re part of the Windows build, but those aren&#39;t affected by these changes).</p>

</div>

</div>

</div>
<div id="forum48152">
<h3>(4)
By Roger Binns (rogerbinns) on 2024-10-21 22:23:53
in reply to 3
[link]
[source]
</h3>
<div>
<div>

<blockquote>
<p>... is using GNU make&#39;s ...</p>
</blockquote>

<p>I don&#39;t run make at any point, nor do I know or have any control over what make is present.  My stuff is packaged by third parties on many different Linuxes, BSD, Android etc, although I only do this when SQLite is directly bundled into my library.</p>

<p>I do the extraction using Python code.</p>

<blockquote>
<p>We don&#39;t have any named &#34;DEFS&#34;</p>
</blockquote>

<p>You do, and I&#39;ve been using them for over a decade!  Here is what is in <code>Makefile</code> after running configure on Linux</p>
<pre><code>DEFS = -DPACKAGE_NAME=\&#34;sqlite\&#34; -DPACKAGE_TARNAME=\&#34;sqlite\&#34; -DPACKAGE_VERSION=\&#34;3.47.0\&#34; -DPACKAGE_STRING=\&#34;sqlite\ 3.47.0\&#34; -DPACKAGE_BUGREPORT=\&#34;http://www.sqlite.org\&#34; -DPACKAGE_URL=\&#34;\&#34; -DPACKAGE=\&#34;sqlite\&#34; -DVERSION=\&#34;3.47.0\&#34; -DHAVE_STDIO_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_STRINGS_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_UNISTD_H=1 -DSTDC_HEADERS=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\&#34;.libs/\&#34; -DHAVE_FDATASYNC=1 -DHAVE_USLEEP=1 -DHAVE_LOCALTIME_R=1 -DHAVE_GMTIME_R=1 -DHAVE_DECL_STRERROR_R=1 -DHAVE_STRERROR_R=1 -DHAVE_READLINE_READLINE_H=1 -DHAVE_READLINE=1 -DHAVE_POSIX_FALLOCATE=1 -DHAVE_ZLIB_H=1
</code></pre>
<p>I create a file in the same directory as sqlite3 named <code>sqlite3config.h</code> and then <code>#include</code> that in the build before <code>#include &#34;sqlite3.c&#34;</code>.  The above turns into this:</p>
<pre><code>
    /* This file was generated by parsing how configure altered the Makefile
    which isn&#39;t used when building python extensions.  It is specific to the
    machine and developer components on which it was run. */
    
#define HAVE_STDIO_H 1
#define HAVE_STDLIB_H 1
#define HAVE_STRING_H 1
#define HAVE_INTTYPES_H 1
#define HAVE_STDINT_H 1
#define HAVE_STRINGS_H 1
#define HAVE_SYS_STAT_H 1
#define HAVE_SYS_TYPES_H 1
#define HAVE_UNISTD_H 1
#define HAVE_DLFCN_H 1
#define HAVE_FDATASYNC 1
#define HAVE_USLEEP 1
#define HAVE_LOCALTIME_R 1
#define HAVE_GMTIME_R 1
#define HAVE_DECL_STRERROR_R 1
#define HAVE_STRERROR_R 1
#define HAVE_READLINE_READLINE_H 1
#define HAVE_READLINE 1
#define HAVE_POSIX_FALLOCATE 1
#define HAVE_ZLIB_H 1
</code></pre>
</div>

</div>

</div>
<div id="forum48153">
<h3>(5)
By Stephan Beal (stephan) on 2024-10-21 22:43:39
in reply to 4
[link]
[source]
</h3>
<div>
<div>

<blockquote>
<p>You do, and I&#39;ve been using them for over a decade! Here is what is in Makefile after running configure on Linux</p>
</blockquote>

<p>That&#39;s not what i&#39;m seeing from the current trunk:</p>
<pre><code>$ uname -a
Linux nuc 6.8.0-41-generic ...

$ ./configure --enable-all
...

$ grep -w DEFS Makefile
&lt;no output&gt;

$ grep -w DEFS * 2&gt;/dev/null
config.log:DEFS=&#39;-DHAVE_CONFIG_H&#39;
config.status:S[&#34;DEFS&#34;]=&#34;-DHAVE_CONFIG_H&#34;
configure:DEFS
configure:# confdefs.h avoids OS command line length limits that DEFS can exceed.
configure:DEFS=-DHAVE_CONFIG_H
</code></pre>
</div>

</div>

</div>
<div id="forum48154">
<h3>(6)
By Roger Binns (rogerbinns) on 2024-10-21 22:50:20
in reply to 5
[link]
[source]
</h3>
<div>
<div>

<blockquote>
<p>That&#39;s not what i&#39;m seeing from the current trunk:</p>
</blockquote>

<p>Correct.  It is what you get from the release downloads like <a href="https://sqlite.org/2024/sqlite-autoconf-3470000.tar.gz">3.47.0</a> which matters in this case.</p>

<p>During development when I work with fossil I keep a copy of the generated file around.</p>

</div>

</div>

</div>
<div id="forum48155">
<h3>(7)
By Stephan Beal (stephan) on 2024-10-21 22:58:53
in reply to 6
[link]
[source]
</h3>
<div>
<div>

<blockquote>
<p>Correct. It is what you get from the release downloads like 3.47.0 which matters in this case.</p>
</blockquote>

<p>Those artifacts are generated by the autotools, so will de facto be lost in this port, but i have noted a TODO for some way to extract those or, similarly, specifically emit them to their own file(s) as part of the configure step, perhaps even as python/tcl/shell/json/whatever code.</p>

</div>

</div>

</div>
<div id="forum48156">
<h3>(8)
By Roger Binns (rogerbinns) on 2024-10-21 23:07:51
in reply to 7
[link]
[source]
</h3>
<div>
<p>That works for me.  JSON preferred.  Other formats like <code>KEY = VALUE</code> are rife with problems such as determining what are numbers, what are strings, unintentionally converting <code>no</code> to a boolean etc.</p>

</div>

</div>
<div id="forum48190">
<h3>(9)
By anonymous on 2024-10-23 04:52:09
in reply to 4
[link]
[source]
</h3>
<div>
<div>

<p>Steve Bennett here (author of autosetup)</p>

<p>make-config-header can generate a nice easy-to parse header file that can be used independently of the make-based build.</p>

</div>

</div>

</div>
<div id="forum48191">
<h3>(10)
By Stephan Beal (stephan) on 2024-10-23 05:23:09
in reply to 9
[link]
[source]
</h3>
<div>
<div>

<blockquote>
<p>make-config-header can generate a nice easy-to parse header file that can be used independently of the make-based build.</p>
</blockquote>

<p>We&#39;re using that to generate sqlite_cfg.h and a debug-only dump of all of the build defines, so it would not be a far stretch for us to do the same to cover Roger&#39;s case. Ideally i&#39;d rather emit that as something portable, so will probably fork a copy of make-config-header and dump that all out as JSON (and maybe other formats, like tcl, shell, and python, simply because it would be trivial to do at that point).</p>

</div>

</div>

</div>

</div></div>
  </body>
</html>
