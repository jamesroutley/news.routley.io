<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://elijer.github.io/garden/Projects/3D-Annotation">Original</a>
    <h1>3D Annotation</h1>
    
    <div id="readability-page-1" class="page"><article>
<p><img src="https://elijer.github.io/garden/Projects/attachments/backpack.png" width="auto" height="auto" alt=""/></p>
<blockquote>
<p>This is a screenshot of this project - you can see a video of it below</p>
</blockquote>
<p>I met a backpack designer named David Eisenberg this week. I’m someone who carries a backpack with me whenever I venture farther than a couple of blocks from home, so I had a lot of questions. I am also someone who has sewed together enough bike frame bags (2!) to imagine how much I didn’t know on the subject.</p>
<p>David told me about sending design documents to factories overseas, mostly in Vietnam, and the extensive back-and-forth involved. Following my human urge to insert myself in someone else’s business in any way possible, I asked him, “if you could buy/build any technology, what would help the process go more smoothly?”</p>
<p>David related emphatically that if both he and the sample designers he talked to could wear a VR headset, see the other point at things, and annotate parts of a 3D design in front of them, that would save a lot of time - maybe weeks on the month.</p>
<p>As a software engineer, this immediately sounded thrilling. Real-time interaction, 3D models.</p>
<p>But it <em>also</em> sounded like a problem for which tools already existed, so I did a short search. I found something being heavily marketed to me called <a href="https://spline.design/">Spline<svg viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>, which looked feature-rich, and <em>did</em> seem to have live collaboration capabilities. After trying it out, it seemed likely that after sitting down with David we might be able to find a way to use it. In any case, the first step was creating a 3D model, so I downloaded <a href="https://poly.cam/">Polycam<svg viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> onto my phone, one of many free Photogrammetry tools out there, and got to work snapping photos.</p>
<p><img src="https://elijer.github.io/garden/Projects/attachments/spline.png" width="auto" height="auto" alt=""/></p>
<blockquote>
<p>A live view of a photogrammetry-generated model in Spline’s web app</p>
</blockquote>
<blockquote>
<p>“<strong>Photogrammetry</strong> is the science and technology of obtaining reliable information about physical objects and the environment through the process of recording, measuring and interpreting photographic images and patterns of electromagnetic radiant imagery and other phenomena” - Wikipedia.</p>
</blockquote>
<p>When I refer to photogrammetry, I mean something slightly more specific than the Wikipedia definition above. I am referring to a process in which an object is photographed many times from many angles. The aggregated visual information across these pictures is then used to generate a 3D model with a mesh and textures.</p>
<p>I’m impressed by the lighting in Spline, and the fidelity of the model I created with Polycam in less than five minutes. Because Polycam is a free service, they cap the amount of photos they will analyze (150), and those photos were taken by a humble iPhone SE held by an amateur photogrammetrist. A professional photogrammetry model could be much more detailed.</p>
<p>I was <em>less</em> impressed by Spline’s comment system, which didn’t seem to allow me to make notes that were anchored in space or clearly referring to points on a model.</p>
<p>With the model in front of me, the idea felt much more tangible, so I opened up my IDE and starting writing some code to see if I could at least render some pixels on a screen. I started with a simple file uploader that could take the 3D GLB files that Polycam creates.</p>
<hr/>

<p><img src="https://elijer.github.io/garden/Projects/attachments/upload_form.png" width="auto" height="auto" alt=""/></p>
<p>It sent off the uploaded files to a middleware package I installed with <code>npm</code> called <code>multer</code>, allowing me to serve some file storage directory from the server:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="javascript" data-theme="github-light github-dark"><code data-language="javascript" data-theme="github-light github-dark"><span data-line=""><span>app.</span><span>use</span><span>(</span><span>&#39;/uploads&#39;</span><span>, express.</span><span>static</span><span>(path.</span><span>join</span><span>(__dirname, </span><span>&#39;uploads&#39;</span><span>)));</span></span>
<span data-line=""> </span>
<span data-line=""> </span>
<span data-line=""><span>const</span><span> storage</span><span> =</span><span> multer.</span><span>diskStorage</span><span>({</span></span>
<span data-line=""><span>	destination</span><span>: (</span><span>req</span><span>, </span><span>file</span><span>, </span><span>cb</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span data-line=""><span>		cb</span><span>(</span><span>null</span><span>, </span><span>&#39;uploads/&#39;</span><span>);</span></span>
<span data-line=""><span>	},</span></span>
<span data-line=""><span>	filename</span><span>: (</span><span>req</span><span>, </span><span>file</span><span>, </span><span>cb</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span data-line=""><span>		cb</span><span>(</span><span>null</span><span>, Date.</span><span>now</span><span>() </span><span>+</span><span> path.</span><span>extname</span><span>(file.originalname));</span></span>
<span data-line=""><span>	}</span></span>
<span data-line=""> </span>
<span data-line=""><span>});</span></span></code></pre></figure>
<p>Next, I created a post route that would take an upload and used websockets to broadcast the location of the newly uploaded file to all connected clients.</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="javascript" data-theme="github-light github-dark"><code data-language="javascript" data-theme="github-light github-dark"><span data-line=""><span>app.</span><span>post</span><span>(</span><span>&#39;/upload-3d-model&#39;</span><span>, upload.</span><span>single</span><span>(</span><span>&#39;file&#39;</span><span>), (</span><span>req</span><span>, </span><span>res</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span data-line=""> </span>
<span data-line=""><span>	if</span><span> (</span><span>!</span><span>req.file)</span><span>return</span><span> res.</span><span>status</span><span>(</span><span>400</span><span>).</span><span>json</span><span>({ error: </span><span>&#39;No file uploaded&#39;</span><span> });</span></span>
<span data-line=""> </span>
<span data-line=""><span>	const</span><span> fileExtension</span><span> =</span><span> path.</span><span>extname</span><span>(req.file.originalname).</span><span>toLowerCase</span><span>();</span></span>
<span data-line=""><span>	</span></span>
<span data-line=""><span>	if</span><span> (fileExtension </span><span>!==</span><span> &#39;.gltf&#39;</span><span> &amp;&amp;</span><span> fileExtension </span><span>!==</span><span> &#39;.glb&#39;</span><span>){</span></span>
<span data-line=""><span>		return</span><span> res.</span><span>status</span><span>(</span><span>400</span><span>).</span><span>json</span><span>({</span></span>
<span data-line=""><span>			error: </span><span>&#39;Invalid file type. Only GLTF and GLB files are allowed.&#39;</span></span>
<span data-line=""><span>		});</span></span>
<span data-line=""><span>	}</span></span>
<span data-line=""><span>	</span></span>
<span data-line=""><span>	res.</span><span>json</span><span>({</span></span>
<span data-line=""><span>		message: </span><span>&#39;3D model file uploaded successfully&#39;</span><span>,</span></span>
<span data-line=""><span>		fileUrl: </span><span>`http://localhost:3000/uploads/${</span><span>req</span><span>.</span><span>file</span><span>.</span><span>filename</span><span>}`</span><span>;</span></span>
<span data-line=""><span>	});</span></span>
<span data-line=""> </span>
<span data-line=""><span>	io.</span><span>emit</span><span>(</span><span>&#39;modelUploaded&#39;</span><span>, { fileUrl });</span></span>
<span data-line=""> </span>
<span data-line=""><span>});</span></span></code></pre></figure>
<p>Finally on the client, I used ThreeJS to render the file on the frontend:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="javascript" data-theme="github-light github-dark"><code data-language="javascript" data-theme="github-light github-dark"><span data-line=""><span>async</span><span> function</span><span> renderGLB</span><span>(</span><span>fileUrl</span><span>) {</span></span>
<span data-line=""><span>	const</span><span> loader</span><span> =</span><span> new</span><span> GLTFLoader</span><span>();</span></span>
<span data-line=""><span>	loader.</span><span>load</span><span>(fileUrl, (</span><span>gltf</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span data-line=""><span>		scene.</span><span>add</span><span>(gltf.scene);</span></span>
<span data-line=""><span>		camera.position.</span><span>set</span><span>(</span><span>0.08</span><span>, </span><span>1.2</span><span>, </span><span>.7</span><span>);</span></span>
<span data-line=""> </span>
<span data-line=""><span>		// Raycaster for detecting cursor position on the model</span></span>
<span data-line=""><span>		const</span><span> raycaster</span><span> =</span><span> new</span><span> THREE</span><span>.</span><span>Raycaster</span><span>();</span></span>
<span data-line=""><span>		const</span><span> mouse</span><span> =</span><span> new</span><span> THREE</span><span>.</span><span>Vector2</span><span>();</span></span>
<span data-line=""> </span>
<span data-line=""><span>		let</span><span> lastEmitTime </span><span>=</span><span> 0</span><span>;</span></span>
<span data-line=""><span>		const</span><span> emitInterval</span><span> =</span><span> 10</span></span>
<span data-line=""> </span>
<span data-line=""><span>		function</span><span> onMouseMove</span><span>(</span><span>event</span><span>) {</span></span>
<span data-line=""><span>		</span></span>
<span data-line=""><span>			mouse.x </span><span>=</span><span> (event.clientX </span><span>/</span><span> window.innerWidth) </span><span>*</span><span> 2</span><span> -</span><span> 1</span><span>;</span></span>
<span data-line=""><span>			mouse.y </span><span>=</span><span> -</span><span>(event.clientY </span><span>/</span><span> window.innerHeight) </span><span>*</span><span> 2</span><span> +</span><span> 1</span><span>;</span></span>
<span data-line=""><span>			raycaster.</span><span>setFromCamera</span><span>(mouse, camera);</span></span>
<span data-line=""><span>		</span></span>
<span data-line=""><span>			const</span><span> intersects</span><span> =</span><span> raycaster.</span><span>intersectObject</span><span>(gltf.scene, </span><span>true</span><span>);</span></span>
<span data-line=""> </span>
<span data-line=""><span>			if</span><span> (intersects.</span><span>length</span><span> &gt;</span><span> 0</span><span>) {</span></span>
<span data-line=""><span>				const</span><span> intersect</span><span> =</span><span> intersects[</span><span>0</span><span>];</span></span>
<span data-line=""><span>				const</span><span> currentTime</span><span> =</span><span> Date.</span><span>now</span><span>();</span></span>
<span data-line=""> </span>
<span data-line=""><span>			if</span><span> (currentTime </span><span>-</span><span> lastEmitTime </span><span>&gt;=</span><span> emitInterval){</span></span>
<span data-line=""><span>				socket.</span><span>emit</span><span>(</span><span>&#39;cursorPosition&#39;</span><span>, {</span></span>
<span data-line=""><span>					playerId: playerId,</span></span>
<span data-line=""><span>					x: intersect.point.x,</span></span>
<span data-line=""><span>					y: intersect.point.y,</span></span>
<span data-line=""><span>					z: intersect.point.z</span></span>
<span data-line=""><span>				});</span></span>
<span data-line=""> </span>
<span data-line=""><span>				lastEmitTime </span><span>=</span><span> currentTime;</span></span>
<span data-line=""><span>			}</span></span>
<span data-line=""><span>		}</span></span>
<span data-line=""><span>	}</span></span>
<span data-line=""> </span>
<span data-line=""> </span>
<span data-line=""><span>	window.</span><span>addEventListener</span><span>(</span><span>&#39;mousemove&#39;</span><span>, onMouseMove, </span><span>false</span><span>);</span></span>
<span data-line=""> </span>
<span data-line=""><span>  </span></span>
<span data-line=""> </span>
<span data-line=""><span>	const</span><span> animate</span><span> =</span><span> function</span><span> () {</span></span>
<span data-line=""><span>		requestAnimationFrame</span><span>(animate);</span></span>
<span data-line=""><span>		controls.</span><span>update</span><span>(); </span><span>// Update controls</span></span>
<span data-line=""><span>		renderer.</span><span>render</span><span>(scene, camera);</span></span>
<span data-line=""><span>	};</span></span>
<span data-line=""><span>	</span></span>
<span data-line=""><span>	animate</span><span>();</span></span>
<span data-line=""> </span>
<span data-line=""><span>}</span></span></code></pre></figure>
<blockquote>
<p>There is much more code than these three examples, but hopefully these tell most of the story</p>
</blockquote>
<hr/>

<p>It’s miles from the fully realized vision, but for a day’s work I’m happy with this is a prototype!</p>
<p> <video controls=""> <source src="https://thornberry-garden.s3.us-east-2.amazonaws.com/backpack.mov" type="video/mp4"/> Your browser does not support the video tag. </video> </p>
<p>In the JavaScript above, I calculate the intersection between the user’s mouse and the model. Then I send those coordinates to the server. What isn’t clear from the video above is that on the server, those mouse updates are getting saved to an object of mouse updates associated with players, allowing players, in theory, to see the live cursor location of another user:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="javascript" data-theme="github-light github-dark"><code data-language="javascript" data-theme="github-light github-dark"><span data-line=""><span>socket.</span><span>on</span><span>(</span><span>&#39;cursorPosition&#39;</span><span>, (</span><span>data</span><span>) </span><span>=&gt;</span><span> {</span></span>
<span data-line=""><span>	clients[data.playerId] </span><span>=</span><span> {</span><span>...</span><span>clients[data.playerId], </span><span>...</span><span>data}</span></span>
<span data-line=""><span>	socket.</span><span>emit</span><span>(</span><span>&#39;cursors&#39;</span><span>, clients)</span></span>
<span data-line=""><span>});</span></span></code></pre></figure>
<p>This…sort of worked. When I opened up two tabs of the project, it seemed like the javascript execution was paused until that window was active. This made it hard to tell how it would behave if two people opened it on separate machines.</p>
<blockquote>
<p>This behavior isn’t consistent with another <a href="https://elijer.github.io/garden/Projects/Eco-Mog" data-slug="Projects/Eco-Mog">websocket project of mine</a>, making me wonder if there’s an issue with my websocket logic.</p>
</blockquote>
<p>I went ahead and deployed it so I could try to test this functionality between my computer and my phone.</p>
<hr/>

<p>Once I deployed, I realized that for my server’s file server to work, I needed to configure a Docker volume. This should be pretty easy in theory, but I also realized that I was so excited to jump into the project, I hadn’t really thought about the best file storage solution. When I considered this, I discovered some pretty basic questions about what architecture to go with:</p>
<ul>
<li>Save the files on the server, or use a file storage platform like S3?</li>
<li>How should I direct users to various files? Should I start with one global file, since it’s just a prototype? Or create a route for each new file? If so, is it necessary to display a directory of uploaded files, or just let users save the URL somewhere for now?</li>
</ul>
<p>Much of the Sunday was gone at this point. Like it often does, it seemed twenty minutes past the ideal moment to pause and go on a bike ride, so I closed my laptop and left these questions for a later time.</p>
<hr/>

<p>With websockets and careful spatial math, I could build this into a useful object annotation tool. While working on it, I realized that the things I would like to improve are:</p>
<ul>
<li>Use routing so that links can be created for multiple 3D objects</li>
<li>persist those objects in storage</li>
<li>persist the comments about them, too, in a database</li>
<li>Route socket activity into distinct “rooms” so that different conversations can happen about different objects simultaneously</li>
</ul>
<p><strong>Next.JS</strong> paired with <strong>Firebase Storage</strong> and <strong>Supabase</strong> or <strong>Firestore</strong> would be a good stack to get V2 up and running.</p>
<p>As far as solving the problem I set out to solve, I would like to spend more time with existing tools. But if I find an existing tool that works for David, it will still be tempting to create this because of how fun the challenge of working with multiplayer data is!</p>
<p>I had a conversation with a pair of entrepreneurs the other day, and one of them brought up a good question that’s worth pondering for any project in danger of taking longer than a Sunday:</p>
<p>“Did this exist two years ago? If not, why?”</p>
<p>Thanks for reading!</p></article></div>
  </body>
</html>
