<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jerpint.io/blog/diffusion-gol/">Original</a>
    <h1>ControlNet Game of Life</h1>
    
    <div id="readability-page-1" class="page"><div>
      
        <header>
          
          

  <p>
    

    

    
      
      

      <span>
        <i aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section itemprop="text">
        
        <h2 id="tldr">TL;DR</h2>

<p>In this post, we we will be using <a href="https://huggingface.co/docs/diffusers/en/using-diffusers/controlnet">ControlNet</a> to animate the <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Game of Life</a>.</p>







<blockquote>
  <p>Skip to the next section to get to the explanation of how it works.</p>
</blockquote>

<p>You can try running it on the <a href="https://huggingface.co/spaces/jerpint/game-of-life-controlnet">HuggingFace ü§ó space</a>, or on the <a href="https://colab.research.google.com/github/jerpint/jerpint.github.io/blob/master/colabs/gol_diffusion.ipynb">Colab link</a>.
They both have GPU usage limits, so you can play around with both and see what works for you.</p>







<h2 id="controlnet">ControlNet</h2>

<p>Fundamentally, we are using <a href="https://en.wikipedia.org/wiki/Stable_Diffusion">stable diffusion</a> to generate the images.
However, vanilla stable diffusion doesn‚Äôt allow for the preservation of the grid of cells, especially not as we iterate through the game.</p>

<p>Instead, we use a variant of stable diffusion called <a href="https://huggingface.co/docs/diffusers/en/using-diffusers/controlnet">ControlNet</a>.
ControlNet has the nice property that you can feed it both a start image as well as a ‚Äúcontrol image‚Äù, which encodes the general outlines of the shape you want to preserve.</p>

<p>In practice, this can be done using segmentation maps, canny edges, etc. With it, we can preserve the shapes while letting the model generate the fill.
Here, ControlNet is used to map a painting to another painting while preserving the original structure.</p>

<p><img src="https://www.jerpint.io/assets/images/controlnet-text2img-demo.png" alt="image"/>
<a href="https://huggingface.co/docs/diffusers/en/using-diffusers/controlnet">source</a></p>

<h2 id="qr-code-controlnet">QR Code ControlNet</h2>

<p>Shortly after ControlNet, a fun use-case people thought of was to <a href="https://huggingface.co/DionTimmer/controlnet_qrcode">finetune ControlNet</a> to preserve the semantics of QR Codes. Think of it; if you can preserve the shapes of the tiles enough, you can generate actually fun QR codes, it‚Äôs so simple yet powerful:</p>

<p><img src="https://www.jerpint.io/assets/images/qr_code_controlnet.png" alt="image"/>
<a href="https://huggingface.co/DionTimmer/controlnet_qrcode/blob/main/README.md">source</a></p>

<h2 id="connecting-the-dots">Connecting the Dots</h2>

<p>Inspired by this idea, I thought it would be fun to connect the dots: after all, the game of life can easily be thought of as a QR Code grid, as I wrote about in a <a href="https://www.jerpint.io/blog/conways-qr-code/">previous post</a>.</p>

<p>We pretty much just need to generate a control image from each game of life state, and use it to guide our ControlNet model. For example:</p>

<p><img src="https://www.jerpint.io/assets/images/gol_frame_with_guide.png" alt="image"/></p>

<p>Now we can iterate on each cell of the game, and for each one generate an image. Note that there is nothing guaranteeing temporal consistency, we are just hoping for the best by controlling the seeds. Here is the overall pseudo-code that we then need to implement:</p>

<div><div><pre><code><span># Pseudo-code for generating a gif
</span>
<span>controlnet</span> <span>=</span> <span>ControlNet</span><span>()</span>  <span># Load the model
</span><span>game_of_life</span> <span>=</span> <span>GameOfLife</span><span>(</span><span>seed</span><span>=</span><span>42</span><span>)</span>  <span># Initialize the game of life
</span><span>source_image</span> <span>=</span> <span>load_image</span><span>(</span><span>IMAGE_URL</span><span>)</span>  <span># Load a source image (e.g. a volcano)
</span><span>num_steps</span> <span>=</span> <span>50</span>  <span># Number of steps to iterate through the game
</span><span>frames</span> <span>=</span> <span>[]</span>  <span># Collect all generated frames here
</span>
<span>for</span> <span>step</span> <span>in</span> <span>range</span><span>(</span><span>num_steps</span><span>):</span>
    <span>game_of_life</span><span>.</span><span>step</span><span>()</span>  <span># Play a step in the game of life
</span>    <span>grid_image</span> <span>=</span> <span>game_of_life</span><span>.</span><span>grids</span><span>[</span><span>-</span><span>1</span><span>].</span><span>to_image</span><span>()</span>  <span># Generate an image from the latest grid
</span>    <span>frame</span> <span>=</span> <span>controlnet</span><span>.</span><span>generate</span><span>(</span><span>source_image</span><span>=</span><span>source_image</span><span>,</span> <span>control_image</span><span>=</span><span>grid_image</span><span>,</span> <span>**</span><span>controlnet_kwargs</span><span>)</span>  <span># Generate the controlnet frame
</span>    <span>frames</span><span>.</span><span>append</span><span>(</span><span>frame</span><span>)</span>

<span>render_gif</span><span>(</span><span>frames</span><span>)</span>
</code></pre></div></div>

<p>We can start with plenty of different types of images, for example, here is one with the famous ‚ÄúTsunami by hokusai‚Äù theme:</p>

<p><img src="https://www.jerpint.io/assets/images/gol_resize_2.gif" alt="image"/></p>

        
      </section>

      

      


      
  

    </div></div>
  </body>
</html>
