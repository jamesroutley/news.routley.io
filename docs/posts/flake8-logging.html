<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://adamj.eu/tech/2023/09/07/introducing-flake8-logging/">Original</a>
    <h1>Flake8-Logging</h1>
    
    <div id="readability-page-1" class="page"><article><time datetime="2023-09-07">2023-09-07</time><img alt="Obvious visual pun." title="Obvious visual pun." src="https://loeber.substack.com/tech/assets/2023-09-07-log.jpeg"/><p>The Python standard library’s <a href="https://docs.python.org/3/library/logging.html"><code>logging</code> module</a> is a go-to for adding observability to applications. Many tools also integrated with it or enhance its capabilities, such as <a href="https://pypi.org/project/structlog/">structlog</a> and <a href="https://sentry.io/">Sentry</a>.</p><p>But the design of <code>logging</code> also has some sharp corners that make it unnecessarily difficult to use. On top of this, writing logging messages is often secondary to feature development, and testing them is an even lower priority. These effects can mean that logging calls don’t always work as expected, especially in oft-untested error-handling paths. When that happens, you can end up with a lack of information for debugging.</p><p>To help guard against misuse of <code>logging</code>, I have created a new Flake8 plugin to detect issues, called <a href="https://github.com/adamchainz/flake8-logging">flake8-logging</a>. It currently has 12 rules—let’s look at a couple in depth here, leaving the hopefully comprehensive docs to cover the rest.</p><div id="log001-use-logging-getlogger-to-instantiate-loggers"><h2>LOG001 use <code>logging.getLogger()</code> to instantiate loggers<a title="Permalink to this headline" href="#log001-use-logging-getlogger-to-instantiate-loggers"></a></h2><p>It’s possible to construct a logger directly:</p><div><pre><span></span><span>import</span> <span>logging</span>

<span>logger</span> <span>=</span> <span>logging</span><span>.</span><span>Logger</span><span>(</span><span>__name__</span><span>)</span>
</pre></div><p>When doing so, you may be unaware that <a href="https://docs.python.org/3/library/logging.html#logger-objects">the documentation</a> says:</p><blockquote>Note that Loggers should NEVER be instantiated directly, but always through the module-level function <code>logging.getLogger(name)</code>.</blockquote><p>This edict is because a directly-instantiated logger is not hooked into the “logging tree”. It will bypass all configured levels, filters, formatters, and handlers. Instead, its messages will only be sent to the <a href="https://docs.python.org/3/library/logging.html#logging.lastResort">last resort handler</a>, which normally means appearing on <code>stderr</code> with minimal formatting. Potentially, such messages will not end up in your logging destination, and so you won’t be alerted to issues.</p><p>So yeah, use <a href="https://docs.python.org/3/library/logging.html#logging.getLogger"><code>getLogger()</code></a> to correctly instantiate loggers:</p><div><pre><span></span><span> </span>import logging

<span>-logger = logging.Logger(__name__)</span>
<span>+logger = logging.getLogger(__name__)</span>
</pre></div><p>flake8-logging’s <a href="https://github.com/adamchainz/flake8-logging#log001-use-logginggetlogger-to-instantiate-loggers">LOG001 rule</a> detects direct instantiation of <code>Logger</code> at the module level:</p><div><pre><span></span><span>$ </span>flake8<span> </span>example.py
<span>example.py:3:10: LOG001 use logging.getLogger() to instantiate loggers</span>
</pre></div></div><div id="log005-use-exception-within-an-exception-handler"><h2>LOG005 use <code>exception()</code> within an exception handler<a title="Permalink to this headline" href="#log005-use-exception-within-an-exception-handler"></a></h2><p>I’ve often seen a plain <code>logging.error()</code> call inside exception handlers:</p><div><pre><span></span><span>import</span> <span>logging</span>
<span>from</span> <span>dancing</span> <span>import</span> <span>salsa</span>

<span>try</span><span>:</span>
    <span>salsa</span><span>()</span>
<span>except</span> <span>Exception</span><span>:</span>
    <span>logging</span><span>.</span><span>error</span><span>(</span><span>&#34;Doing the Salsa failed&#34;</span><span>)</span>
</pre></div><p>Failures then show only the message:</p><div><pre><span></span><span>$ </span>python<span> </span>example.py
<span>ERROR:root:Doing the Salsa failed</span>
</pre></div><p>There’s no exception information, making future debugging attempts harder.</p><p>You can add exception information by either adding <code>exc_info=True</code>, or by switching to the <a href="https://docs.python.org/3/library/logging.html#logging.Logger.exception"><code>exception()</code> method</a> which automatically sets that:</p><div><pre><span></span><span> </span>try:
<span> </span>    salsa()
<span> </span>except Exception:
<span>-    logging.error(&#34;Doing the Salsa failed&#34;)</span>
<span>+    logging.exception(&#34;Doing the Salsa failed&#34;)</span>
</pre></div><p>Failures then capture the exception information:</p><div><pre><span></span><span>$ </span>python<span> </span>example.py
<span>ERROR:root:Doing the Salsa failed</span>
<span>Traceback (most recent call last):</span>
<span>  File &#34;/..../example.py&#34;, line 5, in &lt;module&gt;</span>
<span>    salsa()</span>
<span>  File &#34;/..../dancing.py&#34;, line 22, in salsa</span>
<span>    data = dance_data[&#34;salsa&#34;]</span>
<span>           ~~~~~~~~~~^^^^^^^^^</span>
<span>KeyError: &#39;salsa&#39;</span>
</pre></div><p>Error aggregation tools like <a href="https://sentry.io">Sentry</a> often hook into the logging system to capture this information.</p><p>flake8-logging’s <a href="https://github.com/adamchainz/flake8-logging#log005-use-exception-within-an-exception-handler">LOG005 rule</a> detects use of <code>error()</code> within exception handlers, recommending <code>exception()</code> instead:</p><div><pre><span></span><span>$ </span>flake8<span> </span>example.py
<span>example.py:7:5: LOG005 use exception() within an exception handler</span>
</pre></div></div><div id="log011-avoid-pre-formatting-log-messages"><h2>LOG011 avoid pre-formatting log messages<a title="Permalink to this headline" href="#log011-avoid-pre-formatting-log-messages"></a></h2><p>f-strings are very convenient and it’s natural to use them for formatting log messages:</p><div><pre><span></span><span>logging</span><span>.</span><span>error</span><span>(</span><span>f</span><span>&#34;Couldn’t chop </span><span>{</span><span>vegetable</span><span>}</span><span>&#34;</span><span>)</span>
</pre></div><p>This bypasses one of <code>logging</code>’s features though, its delayed message formatting. This can use several styles, but it defaults to Python’s older <code>%</code>-style string formatting:</p><div><pre><span></span><span>logging</span><span>.</span><span>error</span><span>(</span><span>&#34;Couldn’t chop </span><span>%s</span><span>&#34;</span><span>,</span> <span>vegetable</span><span>)</span>
</pre></div><p>The <code>logging</code> module’s delayed message formatting is designed to avoid the cost of formatting when the message won’t be logged. Using an f-string or similar to pre-format the message avoids that optimization.</p><p>The runtime cost of formatting is rarely a large concern, but it can add up in a tight loop. It can also be sizeable if you have a lot of debug-level messages that are rarely enabled.</p><p>Additionally, pre-formatting log messages presents an extra challenge to aggregation tools. They cannot use the log message template to group messages, so may have to rely on other heuristics.</p><p>flake8-logging’s <a href="https://github.com/adamchainz/flake8-logging#log011-avoid-pre-formatting-log-messages">LOG011 rule</a> detects pre-formatted log messages using f-strings, <code>str.format()</code>, and vanilla <code>%</code> formatting:</p><div><pre><span></span><span>$ </span>flake8<span> </span>example.py
<span>example.py:5:17: LOG011 avoid pre-formatting log messages</span>
</pre></div></div><div id="development"><h2>Development<a title="Permalink to this headline" href="#development"></a></h2><p>I worked on flake8-logging whilst working on my client Silvr’s project. I noticed some antipatterns recurring from projects I’ve seen in the past, so decided that a new Flake8 plugin would be the best thing to help stop them for good. Thanks to Anna Bierońska, Pascal Fouque, Rémy Hubscher for reviewing flake8-logging and my changes on Silvr.</p><p>I looked at some prior plugins before creating flake8-logging:</p><ul><li><a href="https://pypi.org/project/flake8-logging-format/">flake8-logging-format</a> which was initially created for what LOG011 covers. It has since been expanded to a couple of other logging-related rules.</li><li><a href="https://pypi.org/project/flake8-logging-arg-count/">flake8-logging-arg-count</a> which has one rule, now covered by <a href="https://github.com/adamchainz/flake8-logging/issues">LOG012</a>.</li></ul><p>These didn’t cover everything that I wanted to check for, but they served as good inspiration.</p></div><div id="fin"><h2>Fin<a title="Permalink to this headline" href="#fin"></a></h2><p>Charlie Marsh, if you’re reading this, you’re welcome to copy flake8-logging into <a href="https://astral.sh/ruff">Ruff</a>.</p><p>I hope to continue working on new rules and improvements, all documented in <a href="https://github.com/adamchainz/flake8-logging/issues">the issue tracker</a>.</p><p>May your logging be ever smoother,</p><p>—Adam</p></div><hr/><p>If your Django project’s long test runs bore you, I wrote <a href="https://adamchainz.gumroad.com/l/suydt">a book</a> that can help.</p><hr/><p><small>One summary email a week, no spam, I pinky promise.</small></p><p><strong>Related posts:</strong></p><ul><li><a href="https://adamj.eu/tech/2022/10/20/pre-commit-various-ways-to-run-hooks/">pre-commit: Various Ways to Run Hooks</a></li><li><a href="https://adamj.eu/tech/2023/03/02/django-profile-and-improve-import-time/">Django: How to profile and improve startup time</a></li><li><a href="https://adamj.eu/tech/2022/11/14/unittest-context-methods-python-3-11-backports/">unittest’s new context methods in Python 3.11 (with backports)</a></li></ul><p><strong>Tags:</strong> <a href="https://adamj.eu/tech/tag/python/" rel="tag">python</a></p></article></div>
  </body>
</html>
