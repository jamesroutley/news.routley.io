<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://aschmelyun.com/blog/i-invited-strangers-to-message-me-through-a-receipt-printer/">Original</a>
    <h1>I invited strangers to message me through a receipt printer</h1>
    
    <div id="readability-page-1" class="page"><div>
        <div>
            <p>My friend <a href="https://samwho.dev">Sam</a> has a feature on his website where you can send him an anonymous message and it&#39;ll be delivered to his phone. I liked the concept and wanted something similar on <em>my</em> site, but a bit more <em>physical</em> than just a push notification.</p>
<p>Situated at the corner of my desk is a receipt printer that I&#39;ve used for <a href="https://aschmelyun.com/blog/i-built-a-receipt-printer-for-github-issues/">other projects</a>, so I figured that would make the perfect platform for short-form messages.</p>
<p>So I built it! ➡️ <a href="https://ping.aschmelyun.com">ping.aschmelyun.com</a></p>
<p>A page on my personal website where you can type up a message, and as soon as you hit send it&#39;s delivered and printed out right on my desk.</p>
<video controls="">
    <source src="/storage/videos/receipt-example.mp4" type="video/mp4"/>
    Your browser does not support the video tag.
</video>
<p>Here I&#39;ll go over how I set it up, how I&#39;m communicating with this printer, some of the limitations I hit, and honestly just how <strong>surprisingly cool</strong> everyone was with the responses I&#39;ve gotten so far.</p>
<blockquote>
<p>If you want to watch this as a video instead, you can find it <a href="https://www.youtube.com/watch?v=7KtyekivpRM">here</a> on my YouTube channel.</p>
</blockquote>
<h2>The hardware</h2>
<p>Let&#39;s talk first about the printer, and what I have it hooked up to.</p>
<p>This is my Epson TM-T88IV thermal receipt printer, and I got it off of eBay for about $50 USD. If you don&#39;t know how these work, it&#39;s pretty fascinating. Receipt paper is coated in a substance that reacts to heat. So instead of using ink to print, the print head heats up small areas of this paper line-by-line. This basically means that as long as the print head is functional, you&#39;ll never have to replace ink cartridges or ribbons.</p>
<p><img src="https://aschmelyun.com/storage/images/blog/receipt-printer.jpg" alt="a photo of a receipt printer with a no deploys on fridays sticker"/></p>
<p>In order to communicate with the printer, I need to send it commands in a specific format known as <a href="https://en.wikipedia.org/wiki/ESC/P">ESC/POS</a>, a proprietary language that all (or, most?) Epson printers can understand.</p>
<p>Now unfortunately because of this printer&#39;s age, I can&#39;t get driver files for it. If I plug it in to my daily driver (a Mac Mini), the device itself is just totally unrecognized by my computer.</p>
<p>I can instead use some kind of intermediary hardware to handle communication that&#39;s more lax with peripherals. I chose a Raspberry Pi 4 that I had laying around, and the receipt printer is just plugged directly into an open USB port on it.</p>
<p>This makes the device available through the special file <code>/dev/usb/lp0</code>. You can write data directly to this file, and it&#39;ll be interpreted by the printer. I used this method for my <a href="https://aschmelyun.com/blog/getting-my-daily-news-from-a-dot-matrix-printer/">dot matrix newspaper</a> project last year.</p>
<p>But, I can&#39;t just write <em>plain</em> data to it, if I run something like this:</p>
<pre><code data-theme="material-theme-palenight" data-lang="text"><!-- Syntax highlighted by torchlight.dev --><p><span>echo &#34;Hello, world!&#34; &gt; /dev/usb/lp0</span></p></code></pre>
<p>The printer writes out that line, but that&#39;s <em>all</em> it does. The paper isn&#39;t advanced (even if I supply newline characters) and it actually won&#39;t respond to any follow-up writes either. I need to find a way to easily create and send ESC/POS commands.</p>
<p>I&#39;ve used PHP in the past for this because I enjoy the language, and there&#39;s a <a href="https://github.com/mike42/escpos-php">great package</a> that exists for this specific purpose, so I&#39;m reaching for both of these again.</p>
<p>In fact, I just built the whole site in PHP using the Laravel framework. It&#39;s definitely a bit of overkill, but I wanted some redundency by saving the messages to a database as well in case the printer went offline or ran out of paper. It was just easier to start this with a full-stack framework.</p>
<h2>The website</h2>
<p>So I created a new Laravel project, and put together a basic frontend view for the ping page. There&#39;s no JavaScript, all validation and requests happen server-side, the good ol&#39; fashioned way.</p>
<p>After a user submits their message, it goes through a few steps to make sure that it&#39;s within the character count, contains some random transaction number, and <strong>doesn&#39;t contain any special characters</strong>.</p>
<pre><code data-theme="material-theme-palenight" data-lang="php"><!-- Syntax highlighted by torchlight.dev --><p><span>$</span><span>message </span><span>=</span><span> </span><span>str_replace</span><span>([</span><span>&#39;</span><span>&#34;</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>“</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>”</span><span>&#39;</span><span>,</span><span> </span><span>&#34;</span><span>&#39;</span><span>&#34;</span><span>,</span><span> </span><span>&#39;</span><span>‘</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>’</span><span>&#39;</span><span>],</span><span> </span><span>[</span><span>&#39;</span><span>&#34;</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>&#34;</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>&#34;</span><span>&#39;</span><span>,</span><span> </span><span>&#34;</span><span>&#39;</span><span>&#34;</span><span>,</span><span> </span><span>&#34;</span><span>&#39;</span><span>&#34;</span><span>,</span><span> </span><span>&#34;</span><span>&#39;</span><span>&#34;</span><span>],</span><span> </span><span>$</span><span>request</span><span>-&gt;</span><span>message</span><span>);</span></p><p><span>$</span><span>request</span><span>-&gt;</span><span>merge</span><span>([</span><span>&#39;</span><span>message</span><span>&#39;</span><span> </span><span>=&gt;</span><span> </span><span>$</span><span>message</span><span>]);</span></p><p><span>$</span><span>request</span><span>-&gt;</span><span>validate</span><span>([</span></p><p><span>    </span><span>&#39;</span><span>message</span><span>&#39;</span><span> </span><span>=&gt;</span><span> </span><span>&#39;</span><span>required|max:1024|regex:/^[\x00-\x7F</span><span>\&#39;</span><span>]*$/</span><span>&#39;</span><span>,</span></p><p><span>    </span><span>&#39;</span><span>transaction</span><span>&#39;</span><span> </span><span>=&gt;</span><span> </span><span>&#39;</span><span>required|max:5|min:5</span><span>&#39;</span></p><p><span>]);</span></p></code></pre>
<p>Why? Well, because the printer I have kind of sucks with them. It has a <em>pretty limited</em> character set.</p>
<p>Out of the box using the built-in font that it comes with, it can print your standard alphabet and numbers, and the run-of-the-mill characters you&#39;d find on a regular keyboard like dashes, dollar signs, and parentheses.</p>
<p>The more &#34;fun&#34; characters you&#39;d find in ASCII art like box-drawing characters, symbols, shade and braille characters, and even emojis, don&#39;t have a valid character on this printer and just show up as an invalid symbol represented by a question mark (?).</p>
<p>So yeah, it&#39;s limited, but I figured I&#39;d add that validation to make sure the message you&#39;re intending to send me is what shows up printed at my desk.</p>
<blockquote>
<p>Note: I believe this printer does have multiple character <em>sheets</em> which have to be switched out via specific ESC/POS commands. The regular default sheet doesn&#39;t contain these characters, and I didn&#39;t feel like parsing incoming text, switching to a potentially supported sheet, running the command, and returning back. Maybe in version 2!</p>
</blockquote>
<p>I also tried to match the width of the text box to the actual width used when printing (42 characters).</p>
<p>Now it was just a matter of sending a message in ESC/POS to the printer, which using this package was pretty straightforward. I start off with a basic header at the top, some date and transaction info, and then just put the entire message from the request into the payload.</p>
<pre><code data-theme="material-theme-palenight" data-lang="php"><!-- Syntax highlighted by torchlight.dev --><p><span>$</span><span>connector </span><span>=</span><span> </span><span>new</span><span> </span><span>FilePrintConnector</span><span>(</span><span>&#39;</span><span>/dev/usb/lp0</span><span>&#39;</span><span>);</span></p><p><span>$</span><span>printer </span><span>=</span><span> </span><span>new</span><span> </span><span>Printer</span><span>($</span><span>connector</span><span>);</span></p><p><span>// header</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>feed</span><span>(</span><span>2</span><span>);</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>text</span><span>(</span><span>&#39;</span><span>TIMESTAMP:</span><span>&#39;</span><span> </span><span>.</span><span> </span><span>str_repeat</span><span>(</span><span>&#39;</span><span> </span><span>&#39;</span><span>,</span><span> </span><span>15</span><span>)</span><span> </span><span>.</span><span> </span><span>now</span><span>()-&gt;</span><span>format</span><span>(</span><span>&#39;</span><span>m/d/y h:i A</span><span>&#39;</span><span>));</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>feed</span><span>(</span><span>1</span><span>);</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>text</span><span>(</span><span>&#39;</span><span>TRANSACTION #:</span><span>&#39;</span><span> </span><span>.</span><span> </span><span>str_repeat</span><span>(</span><span>&#39;</span><span> </span><span>&#39;</span><span>,</span><span> </span><span>23</span><span>)</span><span> </span><span>.</span><span> </span><span>$</span><span>request</span><span>-&gt;</span><span>transaction</span><span>);</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>feed</span><span>(</span><span>4</span><span>);</span></p><p><span>// message</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>text</span><span>($</span><span>request</span><span>-&gt;</span><span>message</span><span>);</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>cut</span><span>();</span></p><p><span>$</span><span>printer</span><span>-&gt;</span><span>close</span><span>();</span></p><p><span>$</span><span>request</span><span>-&gt;</span><span>session</span><span>()-&gt;</span><span>flash</span><span>(</span><span>&#39;</span><span>success</span><span>&#39;</span><span>,</span><span> </span><span>&#39;</span><span>Your message was sent successfully, woohoo!</span><span>&#39;</span><span>);</span></p></code></pre>
<p>It gets delivered directly to the printer through <code>/dev/usb/lp0</code> and winds up at my desk! A little notice is flashed to the session and the page reloaded so the user knows their message was delivered successfully.</p>
<p>Now you may have noticed a small hiccup. This site is accessing the printer directly through the <code>/dev/usb/lp0</code> file. If that&#39;s the case, <em>how can I deploy this out to a server?</em></p>
<p>Spoiler alert: <strong>I didn&#39;t.</strong></p>
<h2>How I handled hosting</h2>
<p>Originally I was going to handle this similarly to how I handled my previous receipt printer project. The main site would be hosted on a separate VPS and make secured calls to a thin client that would be running on whatever hardware I had the actual printer hooked up to.</p>
<p>This time, I decided to just skip the middle man. The site is hosted entirely on the Raspberry Pi that the printer is plugged in to.</p>
<p>Here&#39;s how I set it up and (hopefully, lol) secured it.</p>
<p>I packaged all of the site code into a Docker image, and am running it on the Pi exposing the <code>:8000</code> port and binding the <code>/dev/usb/lp0</code> file from the Pi to the container.</p>
<p>So now I can make a request in my local network to my Pi&#39;s IP address at the <code>:8000</code> port, and I can see the site and print out a receipt.</p>
<p>For exposing it to the internet at large, I decided to go with <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/">Cloudflare Tunnels</a>.</p>
<p>I already have this domain name set up with Cloudflare, so it kind of just made sense considering it&#39;s a free option that&#39;s just right there in front of me.</p>
<p>I had to install a daemon on the Raspberry Pi that runs in the background, and then it was just a matter of mapping what port I wanted to what subdomain on the existing domain it should connect to. Https and DNS was included and kicked off almost instantaneously.</p>
<p>That was it! Now I can visit <a href="https://ping.aschmelyun.com">ping.aschmelyun.com</a>, and the Docker container running on my Raspberry Pi at my desk is what&#39;s serving the actual website.</p>
<h2>Messages I&#39;ve received</h2>
<p>Since pushing this live and talking about it on Twitter, TikTok, and Bluesky, I&#39;ve had an absolute outpouring of messages come through.</p>
<p>It&#39;s been about a month, and I&#39;ve received well over a <em>thousand</em> different pings from people all around the world.</p>
<p><img src="https://aschmelyun.com/storage/images/blog/receipts-on-ground.jpg" alt="a pile of receipts on my office ground that I woke up to one morning"/></p>
<p>Now, most people would probably be a little hesitant about opening up a form on the internet and letting them leave completely anonymous messages with no filtering or regulation.</p>
<p>But I like the thrill of danger I guess, and imagine my surprise that the majority of responses have been <strong>overwhelmingly cool</strong> throughout this project.</p>
<p>Some of these messages include dope ASCII art, funny poems, recipes, memes and copypastas, and fake receipts.</p>
<p><img src="https://aschmelyun.com/storage/images/blog/receipt-collage.jpg" alt="a grid of 4 different receipts with ascii art, fake items, and memes"/></p>
<p>A large portion of them included some kind of location, like &#34;Hello from (state/country)&#34;. This prompted me to buy a large world map and pin each of their unique transaction numbers to the location mentioned in the message. So far I have about 200 pins from 40 different countries!</p>
<p><img src="https://aschmelyun.com/storage/images/blog/receipts-map.jpg" alt="a photo of a world map with different small numbers pinned to various cities"/></p>
<p>By far the biggest section of messages came from people who were telling me how much they enjoyed this simple act of anonymous connection through some kind of physical medium.</p>
<p>There&#39;s no real need for me to do this, it was fun and whimsical. It&#39;s the kind of stuff I wanted to see in the world, and so I made it a point to try and inject more of it.</p>
<p>That&#39;s about all there is to it.</p>
<p>I hope you enjoyed me talking about this project, if you want to take a look at the source code, it&#39;s all up on <a href="https://github.com/aschmelyun/ping-receipt">my GitHub</a>.</p>
<p>If you want to tell me your thoughts, feel free to <a href="https://ping.aschmelyun.com">send me a message</a>!.</p>


            <div>
                
                <p>Subscribe using the form below and about 1-2 times a month you&#39;ll receive an email containing helpful hints, new packages, and interesting articles I&#39;ve found on PHP, JavaScript, Docker and more.</p>
                
            </div>
        </div>
    </div></div>
  </body>
</html>
