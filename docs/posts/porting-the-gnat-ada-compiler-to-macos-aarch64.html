<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://briancallahan.net/blog/20250112.html">Original</a>
    <h1>Porting the GNAT Ada compiler to macOS/aarch64</h1>
    
    <div id="readability-page-1" class="page">
	<a name="top"></a>
	<div id="main">
	    
	    <p>academic, developer, with an eye towards a brighter techno-social life</p>
	    <hr/>
		
	    <hr/>
	</div>
<h5 id="prev"><a href="https://briancallahan.net/blog/20241216.html">[prev]</a></h5>
<h5 id="next">[next]</h5>
    <h2 id="title">2025-01-12</h2>
<p>After getting a <a href="https://briancallahan.net/blog/20241212.html" target="_blank">port</a> of <a href="https://wiki.dlang.org/GDC" target="_blank">GDC</a> working on my new MacBook Pro, there are still two languages left in the <a href="https://gcc.gnu.org/" target="_blank">GCC</a> suite that I don&#39;t have: <a href="https://en.wikipedia.org/wiki/Ada_(programming_language)" target="_blank">Ada</a> and <a href="https://en.wikipedia.org/wiki/Go_(programming_language)" target="_blank">Go</a>. Some <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=46986#c48" target="_blank">searching</a> <a href="https://github.com/golang/go/issues/463#issuecomment-66049850" target="_blank">around</a> makes it seem pretty clear that Gccgo is not yet really on the table to macOS. But there should not be any reason we can&#39;t add Ada to our GCC suite, seeing as there is already <a href="https://gcc.gnu.org/git/?p=gcc.git;a=blob;f=gcc/ada/libgnat/system-darwin-arm.ads;h=f4a14279a51e34fd7e934a41025e52106427ccc0;hb=HEAD" target="_blank">support for macos/aarch64</a> in the repository. I wanted to get a macOS/aarch64 native Ada through the GNAT compiler in GCC.</p>
<p>But try as I might, I could not find any precompiled packages for it. I guess part of the issue is that macOS/aarch64 support is not fully upstreamed into GCC propre; instead, Iain Sandoe has a <a href="https://github.com/iains/gcc-darwin-arm64" target="_blank">GitHub repository</a> that includes the necessary changes for full support. I used his <a href="https://github.com/iains/gcc-14-branch" target="_blank">gcc-14-branch</a> repository to build GDC.</p>
<p>So let&#39;s get to work.</p>
<h4>Virtualizing macOS</h4>
<p>I don&#39;t have <a href="https://en.wikipedia.org/wiki/Rosetta_(software)" target="_blank">Rosetta</a> on my machine. I know it takes all of two seconds to install it, but I also wanted an excuse to play around with Apple&#39;s virtualization framework. After some googling around, I settled on using <a href="https://github.com/insidegui/VirtualBuddy" target="_blank">VirtualBuddy</a> as my virtualization manager. It made installing a virtualized copy of Sequoia 15.2 incredibly easy; just say you want to install from the Internet, choose the version you want to install, and away you go. I gave my virtualized machine 4 CPUs and 16 GB of RAM and a 128 GB hard disk, and it felt just as snappy as the host (the host is a MacBook Pro M4 Max with 64 GB of RAM). I installed the command line tools, Rosetta, and some <a href="https://brew.sh/" target="_blank">Homebrew</a> packages on this virtualized machine and I was ready to go.</p>
<h4>Step 1: Finding a binary of GNAT</h4>
<p>So why did I install Rosetta? My suspicion was that someone had a binary package of GNAT for macOS/x86_64. But I looked in the usual places: Homebrew, <a href="https://pkgsrc.org/" target="_blank">pkgsrc</a>, <a href="https://www.macports.org/" target="_blank">MacPorts</a>, and <a href="https://www.finkproject.org/" target="_blank">Fink</a>, and none of them had a package. I was beginning to wonder if our project was going to end before it began. Because GNAT is written in Ada, you need an Ada compiler to compile it.</p>
<p>I eventually stumbled upon <a href="https://alire.ada.dev/" target="_blank">Alire</a> which bills itself as Ada&#39;s version of Rust&#39;s cargo or OCaml&#39;s opam. The Alire homepage directly states that they have a recent Ada package for macOS/x86_64. This was our way in. I followed the <a href="https://alire.ada.dev/docs/#first-steps" target="_blank">tutorial</a> to get the <code>alr</code> binary installed on the virtual machine and got a copy of the GNAT compiler, which happened to be version 14.2.0. That&#39;s great, because that&#39;s the same version we built with our GDC compiler, and what we will be building from the gcc-14-branch repository.</p>
<p>The compiler was built for a <code>x86_64-apple-darwin21.6.0</code> target. We will use this to get to a <code>aarch64-apple-darwin24.2.0</code> target.</p>
<h4>Step 2: Building a Stage 1 GNAT cross compiler</h4>
<p>I added this Alire-provided GNAT to my <code>PATH</code> and set up the gcc-14-branch repository to prepare to build. Make sure it goes at the front of your <code>PATH</code> so that clang doesn&#39;t get picked up instead. I did run the <code>contrib/download_prerequisites</code> script so that GMP, MPFR, MPC, and ISL would be built statically into GCC; that way I don&#39;t have to deal with any shared libraries and they&#39;re not that big so it won&#39;t take long to build them.</p>
<p>This first pass we need to build a compiler that is built (effectively) from macOS/x86_64, will run on (effectively) macOS/x86_64, but produces code that runs on macOS/aarch64. We also need to remember that all the build tools understand both x86_64 and aarch64; that will be a big help for us. To start, we can run a <code>configure</code> invocation that looks like this:</p>
<pre>env OTOOL=otool AS=as AR=ar RANLIB=ranlib LIPO=lipo NM=nm DSYMUTIL=dsymutil ../gcc-14-branch-gcc-14.2-darwin-r2/configure --prefix=/opt/gcc14 --enable-languages=ada,c,c++ --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX15.sdk --build=x86_64-apple-darwin21.6.0 --host=x86_64-apple-darwin21.6.0 --target=aarch64-apple-darwin24.2.0 --disable-nls --with-ld=/usr/bin/ld --with-as=/usr/bin/as
</pre>
<p>Then we can run our build with:</p>
<pre>gmake V=1 -j4
</pre>
<p>I installed <a href="https://www.gnu.org/software/make/" target="_blank">GNU make</a> from Homebrew since that is much newer than what I got from the command line tools.</p>
<p>For now, I am only going to worry about getting GNAT up and running; once we have it then I can worry about combining GNAT and GDC together into one suite.</p>
<p>I did encounter a few build failures but these all seemed to revolve around autotools wanting prefixed versions of the tools; I would just edit <code>Makefile</code>s and re-run <code>gmake</code> when that happened. Eventually it did succeed and so I installed it into a fake directory, tarred it up, and then installed it on the virtual machine.</p>
<h4>Step 3: Building a Stage 2 GNAT native compiler</h4>
<p>Now we can use this new compiler to build another new compiler. This new compiler will be built with the compiler we just built: because the compiler we just built produces code for <code>aarch64-apple-darwin24.2.0</code>, even though it runs on <code>x86_64-apple-darwin21.6.0</code>, once it is finished compiling GCC, <span>that</span> GCC will be a native macOS/aarch64 compiler.</p>
<p>We&#39;ll need to reset our <code>PATH</code> to get rid of the Alire-provided compiler. We don&#39;t need it any more. We do need to add the compiler we just built to our <code>PATH</code> as that will be used to create our native compiler.</p>
<p>Let&#39;s create a new build directory and run our <code>configure</code> invocation as follows:</p>
<pre>env OTOOL=otool AS=as AR=ar RANLIB=ranlib LIPO=lipo NM=nm DSYMUTIL=dsymutil ../gcc-14-branch-gcc-14.2-darwin-r2/configure --prefix=/opt/gcc14 --enable-languages=ada,c,c++ --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX15.sdk --build=x86_64-apple-darwin21.6.0 --host=aarch64-apple-darwin24.2.0 --target=aarch64-apple-darwin24.2.0 --disable-nls --with-ld=/usr/bin/ld --with-as=/usr/bin/as
</pre>
<p>So what we are saying here is that our build machine is (effectively) macOS/x86_64 but we would like to build a compiler that runs on macOS/aarch64 <span>and</span> produces code for macOS/aarch64. A compiler that produces code for the platform it runs on is a native compiler.</p>
<p>This failed very quickly. Turns out the stage 1 <code>collect2</code> binary was miscompiled and segfaults when it is used. What I did to overcome this was copy the native <code>collect2</code> binary from my GDC compiler to the GNAT compiler. Everything was happy after that.</p>
<p>Now, we can compile with:</p>
<pre>gmake V=1 -j4
</pre>
<p>Like with the stage 1 compiler, there are some intermittent build failures. But none of these are catastrophic; it is a matter of just editing the <code>Makefile</code>s in question and re-running <code>gmake</code>. The most difficult error was that when linking <code>libstdc++.dylib</code>, there was a linker error that you were linking the library with a library of the same name. The problem is that the infrastructure incorrectly wanted to link with <code>g++</code> instead of <code>gcc</code>. There is a comment in the right place in the <code>Makefile</code> so it&#39;s relatively clear that you just need to replace <code>g++</code> with <code>gcc</code> and it will work. I&#39;ve never had that problem before so perhaps it is something with cross compiling.</p>
<p>Eventually it will complete successfully, and then same thing: I installed to a fake directory, removed the stage 1 compiler, then tarred and installed the stage 2 compiler.</p>
<h4>Step 4: Putting it all together</h4>
<p>Now that I have a native GNAT for macOS/aarch64, I want one single GCC package that will have all the languages that are available: Ada, C, C++, <a href="https://dlang.org/" target="_blank">D</a>, Fortran, <a href="https://en.wikipedia.org/wiki/Modula-2" target="_blank">Modula-2</a>, Objective-C, and Objective-C++. I moved the tarball of the stage 2 GNAT compiler to my host machine, shutdown the virtual machine, and installed the stage 2 compiler. I then put the stage 2 compiler in front of the GDC compiler in my <code>PATH</code> and built the gcc-14-branch compiler one last time:</p>
<pre>../gcc-14-branch-gcc-14.2-darwin-r2/configure --prefix=/opt/gcc14 --enable-languages=ada,c,c++,d,fortran,m2,objc,obj-c++ --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX15.sdk
</pre>
<p>That&#39;s all we need now. All of build, host, and target are <code>aarch64-apple-darwin24.2.0</code>, a fully native compiler. And GCC will detect that automatically and create a new native compiler.</p>
<p>One last time to build GCC, but let&#39;s go a little faster now that we have more CPU cores:</p>
<pre>gmake V=1 -j10
</pre>
<p>This built without any problems. Then for one last time, install to a fake directory, tar it up, remove the old stage 2 compiler and old GDC compiler, and install this new complete GCC suite.</p>
<h4>Conclusion</h4>
<p>I&#39;ve uploaded the tarball <a href="https://github.com/ibara/aarch64-apple-darwin24.2.0-gcc-14.2.0/releases/tag/20250112" target="_blank">here</a> for those that want it. You will need to have the command line tools installed. If someone knows how to get GCC to autoselect between Xcode and the command line tools, please let me know. You&#39;ll also need to put <code>/opt/gcc14/bin</code> at the front of your <code>PATH</code> to use it.</p>
<p>Even better, now no one will ever have to go through the hassle of bringing up Ada support on macOS/aarch64 again. We now have a compiler that can be used as a bootstrap for future releases of GCC. Maybe we&#39;ll even have some package managers provide GNAT compilers since the hard work has been done.</p>
<p><a href="#top"><img alt="Top" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAICAYAAADJEc7MAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wkWDyUKJxzXegAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAUklEQVQY02Ocd/j/fwY0kGjDwMhACPz//5/h////DPMO//8PYxODWXAZOP8Iw39k22F8uBg2G7Gx0cWYGMgEWJ2aaMPAiO5UDOcTGxjogUe2UwHwdJDZUucW5QAAAABJRU5ErkJggg=="/></a></p>
<a href="https://briancallahan.net/blog/feed.xml"><img alt="RSS" src="https://briancallahan.net/blog/media/pic_rss.gif"/></a>
	</div>
  </body>
</html>
