<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://paulbutler.org/2022/what-does-it-mean-to-listen-on-a-port/">Original</a>
    <h1>What does it mean to listen on a port?</h1>
    
    <div id="readability-page-1" class="page"><div><p><em>This story explores some concepts in computer networking, inspired by Michael Nielsen’s idea of <a href="https://cognitivemedium.com/srs-mathematics">discovery fiction</a>. Code samples can also be found in <a href="https://github.com/paulgb/wdimtloap">this repo</a>. Excerpts use openbsd-flavoured netcat on Debian Linux; behviour and IPv6 support may vary by version.</em></p>
<hr/>
<p>In the corner of the student union building there is a coffee shop, and in the corner of the coffee shop are two students. Liz taps away at the keyboard of the battered hand-me-down MacBook her brother gave her when she moved away to college. To her left on the bench seat, Tim scrawls equations on a coil-bound notebook. Between them is a half-empty cup of room temperature coffee that Liz sporadically sips from to stay awake.</p>
<p>Across the room, the barista looks up from his phone to glance around the shop. He has one headphone in, the other dangling, while his phone plays the assigned viewing for his film class. It’s an unwritten rule at the student-run shop that employees on the overnight shift can use the long gaps between customers to catch up on homework. Besides Tim and Liz, two other male students sit alone, staring intently at their laptops, as they have for hours. Otherwise, the shop is empty.</p>
<p>Tim stops writing in the middle of a pencil stroke, rips the sheet out of his notebook, crumples it, and puts it next to a small collection of other crumpled up sheets.</p>
<p>“Shit, what time is it?” he asks.</p>
<p>Liz peers at the clock on her laptop. “Just after two”</p>
<p>Tim yawns and starts scrawling again at the top of a new page, but Liz interrupts him.</p>
<p>“Tim”</p>
<p>“What?”, replies Tim, exaggerating his irritation at being interrupted just as he was starting to write.</p>
<p>“What does it mean to listen on a port?”</p>
<p>“Huh”</p>
<p>“I have to write this web server thing for <em>net</em>”, abbreviating <em>Computer Networks 201</em>, a class that Tim had taken the prior semester.</p>
<p>“Yeah, I remember that one”</p>
<p>“So I listen for connections on a port”</p>
<p>“Port 80”, Tim confidently replies, hoping to cut the conversation short by preempting her question.</p>
<p>“Actually, we’re supposed to listen on 8080 so it can run without root, but that’s not the point.”</p>
<p>“Oh right. Then what is?”</p>
<p>“Well, what does it <em>mean</em> to listen on a port?”</p>
<p>“It means that other processes can connect to it on that port.” Tim looks confused at the question.</p>
<p>“Yeah, I know <em>that</em>, but <em>how</em>?”</p>
<p>Tim considers it for a few seconds before replying.</p>
<p>“I guess the operating system has a big table of ports and the process listening on them. When you bind to a port, it puts a pointer to your socket in that table.”</p>
<p>“Yeah, I guess.” says Liz, with a hesitant, dissatisfied tone.</p>
<p>The pair return to their independent work. After some time in silence, Tim mutters a triumphant “yes!” under his breath and crosses off a number on a printed piece of paper. He had finally found a proof he’d been struggling with for his calculus assignment.</p>
<p>Liz takes the opportunity to get his attention again.</p>
<p>“Hey Tim, look, I’m running two processes bound to the same port at the same time.”</p>
<p>She resizes two windows containing Python code:</p>
<div><pre tabindex="0"><code data-lang="python"><span># server1.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>bind((<span>&#39;127.0.0.1&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>And next to it:</p>
<div><pre tabindex="0"><code data-lang="python"><span># server2.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET, socket<span>.</span>SOCK_DGRAM)
sock<span>.</span>bind((<span>&#39;127.0.0.1&#39;</span>, <span>8080</span>))
print(sock<span>.</span>recv(<span>1024</span>))
</code></pre></div><p>Then she shows him both programs running in their own terminal windows, through a shell connection to the university’s <code>cslab3</code> Debian server.</p>
<p>Tim pivots the laptop towards himself. He opens a third terminal, pauses for a moment to search his tired brain, and types <code>netcat 127.0.0.1 8080</code>.</p>
<p><code>netcat</code> runs and immediately exits. In another terminal window, the running <code>python server1.py</code> program exits, printing:</p>
<pre><code>(&lt;socket.socket fd=4, family=AddressFamily.AF_INET,
type=SocketKind.SOCK_STREAM, proto=0, laddr=(&#39;127.0.0.1&#39;, 8080),
raddr=(&#39;127.0.0.1&#39;, 59558)&gt;, (&#39;127.0.0.1&#39;, 59558))
</code></pre><p>He studies the <code>server1.py</code> code, thinking aloud.</p>
<p>“Ok, the server binds to a port, accepts the first socket to connect to it, and then exits. I see, so the tuple it printed was the result of the <code>accept</code> call, and then it immediately exits. But now…”, moving the mouse cursor over the editor displaying <code>server2.py</code> “…is this one even listening?”</p>
<p>He runs <code>netcat 127.0.0.1 8080 -v</code> again in the same terminal as before, and it prints out:</p>
<pre><code>netcat: connect to 127.0.0.1 port 8080 (tcp) failed: Connection refused
</code></pre><p>“See”, he says, “there’s a bug in your code. <code>server2</code> is still running, but you never call <code>listen</code>. It’s not actually doing anything with port 8080.”</p>
<p>“Sure it is, watch”, Liz says, snatching back her laptop.</p>
<p>She adds a <code>-u</code> at the end of the <code>netcat</code> command and hits enter. This time, it doesn’t give an error or exit immediately, but waits for keyboard input. Annoyed that Tim had been so quick to assume her code was buggy, she taps out <code>timmy</code>, knowing the nickname bugs him.</p>
<p>The <code>netcat</code> session ends silently, and simultaneously, the <code>python server2.py</code> program exits printing:</p>
<pre><code>b&#39;timmy\n&#39;
</code></pre><p>Tim recognizes Liz’s attempt to antagonize him but ignores it, not wanting to give her the satisfaction of getting a rise out of him. He gestures towards the keyboard. Liz twists the laptop in his direction and he types out <code>man netcat</code> to bring up the <a href="http://manpages.ubuntu.com/manpages/impish/man1/nc.traditional.1.html">manual</a> for <code>netcat</code>, which describes the tool as the “TCP/IP swiss army knife”. He scrolls down to the <code>-u</code> flag, which is tersely described by the documentation as “UDP mode”.</p>
<p>“Ah”, he says as a flash of recollection hits him. “I get it. server1 is listening over TCP, and server2 is listening over UDP. That must be what <code>SOCK_DGRAM</code> means. So they’re different protocols. I guess the operating system has a separate table of ports for each one. I didn’t think <em>net</em> covered UDP until later.”</p>
<p>“Yeah. I read ahead.”</p>
<p>“Natch. How is it that you have time to read ahead but not have time to get these assignments done before the morning they’re due?”</p>
<p>“I could ask you the same about Counter Strike”, Liz counters.</p>
<p>Tim grumbles.</p>
<p>They go back to working in silence for several more minutes before Liz breaks the silence.</p>
<p>“Hey Tim, look at this. I can listen on the same port with two processes, <em>even if they’re both TCP</em>.”</p>
<p>Tim looks up from his work. This time Liz has just one Python program on the screen, and is running it in two terminals:</p>
<div><pre tabindex="0"><code data-lang="python"><span># server3.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>setsockopt(socket<span>.</span>SOL_SOCKET, socket<span>.</span>SO_REUSEPORT, <span>1</span>)
sock<span>.</span>bind((<span>&#39;127.0.0.1&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>Liz explains “See, this command shows what process is listening on a port”. She types out <code>lsof -i:8080</code> and hits return.</p>
<p>The program prints:</p>
<pre><code>&gt; lsof -i:8080
COMMAND    PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
python3 174265 liz     3u  IPv4 23850797      0t0  TCP localhost:http-alt (LISTEN)
python3 174337 liz     3u  IPv4 23853188      0t0  TCP localhost:http-alt (LISTEN)
</code></pre><p>“What happens when you connect to it?”, asks Tim, this time with a bit of genuine curiosity in his voice.</p>
<p>“Watch.”</p>
<p>Liz runs <code>netcat localhost 8080</code> once, and one of the server processes exits while the other stays running. Then she runs it again, and the other process exits.</p>
<p>Tim’s attention turns to the code, and he puts his finger near the screen to read over it. Liz, who hates a smudged screen, says “easy there!” and pushes his hand back. “I wouldn’t touch it”, he protests. Making an exaggerated show of keeping his hand a safe distance back, he points to the <code>setsockopt</code> line and asks “Hey, what is this sorcery?”</p>
<p>“That’s setting a socket option to allow the port to be reused”</p>
<p>“Huh, that’s in the textbook?”</p>
<p>“Donno, I found it on Stack Overflow.”</p>
<p>“I didn’t know you could reuse a port like that.”</p>
<p>“I didn’t either” She pauses to consider. “So the operating system can’t just have a table of ports to sockets, it has to be a table of ports to a <em>list</em> of sockets. And then a second one for UDP. Maybe more for other protocols.”</p>
<p>“Yeah, that sounds right”, Tim agrees.</p>
<p>“Hmm”, says Liz, suddenly sounding less sure.</p>
<p>“What?”</p>
<p>“Uh, never mind”, she says, as she starts tapping away intently.</p>
<p>Tim returns to his assignment, and after a few minutes passes, he crosses another question off. He is getting close to done, and relaxes his stance a bit. Liz tilts her laptop towards him and says “check this out”. She shows him two programs.</p>
<div><pre tabindex="0"><code data-lang="python"><span># server4.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>bind((<span>&#39;127.0.0.2&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>and next to it,</p>
<div><pre tabindex="0"><code data-lang="python"><span># server5.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>bind((<span>&#39;127.0.0.3&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>“Aren’t these the same”, Tim asks, studying them.</p>
<p>“Look at the bind IP”</p>
<p>“Oh, so you’re listening on the same port but two different IPs. And that works?”</p>
<p>“Seems to. And I can connect to both of them.”</p>
<p>Liz runs <code>netcat 127.0.0.2</code> and then <code>netcat 127.0.0.3</code> to show him.</p>
<p>Tim ponders. “So let’s see. The operating system must have a table from each port and IP combination, to a socket. Well actually, two: one for TCP and another for UDP.”</p>
<p>“Yeah”, Liz nods. “And instead of just one socket, it can be multiple. But watch this.” She changes the IP in the server code to <code>0.0.0.0</code>.</p>
<div><pre tabindex="0"><code data-lang="python"><span># server6.py</span>
<span>import</span> socket

sock socket<span>.</span>socket(socket<span>.</span>AF_INET, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>bind((<span>&#39;0.0.0.0&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>“Now, when I run the server that binds to <code>127.0.0.2</code>, I get this”, she continues.</p>
<pre><code>Traceback (most recent call last):
  File &#34;server5.py&#34;, line 4, in &lt;module&gt;
    s.bind((&#39;127.0.0.2&#39;, 8080))
OSError: [Errno 99] Cannot assign requested address
</code></pre><p>“But” she concludes, “if I run <code>netcat 127.0.0.2 8080</code>, it connects to the server on <code>0.0.0.0</code>”, and shows him.</p>
<p>“Right, <code>0.0.0.0</code> means ‘bind to all local IPs’, didn’t lecture cover that? And addresses that start with <code>127.</code> are local loopback IPs, so it makes sense that they’d be bound by it.”</p>
<p>“Yeah, but how does it work? There are about 16 million IPs that start with <code>127.</code>. It’s not making a big table with all of them, right?”</p>
<p>“I guess not.” He doesn’t have an answer, and changes the subject. “So anyway, how’s the HTTP server going?” It’s rhetorical, he knows she hadn’t written a line of actual assignment code.</p>
<p>“Yeah, yeah” she replies, already diving into another experiment.</p>
<p>More time passes. Tim, having just completed his assignment, idly checks the time on his phone. He considers going home to his lumpy dorm mattress. He assesses that the bench is just about as comfortable, and tilts his head back against its tall cushion seat-back.</p>
<p>He is staring at the ceiling, half-asleep, when Liz pokes him saying “Tim, look at this”</p>
<p>She shows him another program:</p>
<div><pre tabindex="0"><code data-lang="python"><span># server7.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET6, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>bind((<span>&#39;::&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>“Check this out. It’s an IPv6 server”</p>
<p>Tim yawns and leans in. By now, the morning sun is starting to appear through the window behind the bench they sit on. The two other students had quietly left in the early hours of the morning, and the shop’s first customer of the day has arrived and is waiting for her to-go coffee.</p>
<p>“What are the colons, again?” Tim asks.</p>
<p>“It’s a short form for eight zeros in IPv6, it has the same meaning as <code>0.0.0.0</code> in IPv4”</p>
<p>“So this is saying to listen on all local IPv6 IPs? Is that how IPv6 works?”</p>
<p>“Yeah, basically.”</p>
<p>She types <code>netcat &#34;::1&#34; 8080 -v</code>, explaining “<code>::1</code> is a loopback address in IPv6. It’s like ‘home’.”</p>
<p>“So like <code>127.0.0.1</code> in, uh, regular IPs”</p>
<p>“IPv4. Yeah, exactly. But watch this. According to <code>lsof</code>, I’m only listening on IPv6, see?” Liz runs <code>lsof -i :8080</code>, which prints one row.</p>
<pre><code>COMMAND    PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
python3 455017 liz     3u  IPv6 25152485      0t0  TCP *:http-alt (LISTEN)
</code></pre><p>“But”, Liz continues, “I can connect to it through an IPv4 IP.”</p>
<pre><code>netcat 127.0.0.1 8080 -v
</code></pre><p>“Huh”, Tim murmurs. “What about the other way? Can you connect to an IPv4 server from an IPv6 IP?”</p>
<p>“No, watch this.”</p>
<p>She runs <code>python3 server6.py</code>, and then <code>netcat &#34;::1&#34; 8080 -v</code>, which prints</p>
<pre><code>netcat: connect to ::1 port 8080 (tcp) failed: Connection refused
</code></pre><p>Tim asks “What happens if you try to start listening on 8080 on IPv6 when that IPv4 server is still running?”</p>
<p>Liz shows him, running <code>python server7.py</code>.</p>
<pre><code>Traceback (most recent call last):
  File &#34;server7.py&#34;, line 4, in &lt;module&gt;
    s.bind((&#39;::&#39;, 8080))
OSError: [Errno 98] Address already in use
</code></pre><p>“But look at this”, she says, pulling up another code listing.</p>
<div><pre tabindex="0"><code data-lang="python"><span># server8.py</span>
<span>import</span> socket

sock <span>=</span> socket<span>.</span>socket(socket<span>.</span>AF_INET6, socket<span>.</span>SOCK_STREAM)
sock<span>.</span>setsockopt(socket<span>.</span>IPPROTO_IPV6, socket<span>.</span>IPV6_V6ONLY, <span>1</span>)
sock<span>.</span>bind((<span>&#39;::&#39;</span>, <span>8080</span>))
sock<span>.</span>listen()
print(sock<span>.</span>accept())
</code></pre></div><p>She points to the <code>setsockopt</code> line, explaining “When I add this, I <em>can</em> listen on IPv6 and IPv4 on the same port, from different processes.”</p>
<p>She runs <code>python server8.py</code>, and then <code>lsof -i :8080</code>.</p>
<pre><code>COMMAND    PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
python3 460409 liz     3u  IPv6 25188010      0t0  TCP *:http-alt (LISTEN)
python3 460813 liz     3u  IPv4 25191765      0t0  TCP *:http-alt (LISTEN)
</code></pre><p>Tim takes inventory of what Liz has shown him. “So when you listen on a port, you’re really listening on a combination of a port, an IP, a protocol, <em>and an IP version?</em>”</p>
<p>“Yeah, unless you listen on <em>all</em> local IPs. And if you listen on all IPv6 IPs, you also listen on all IPv4 IPs, unless you specifically ask not to before you call bind.”</p>
<p>“Right. So the operating system must have, like, a hash map from a port and IP pair to a socket, for each combination of TCP or UDP, IPv4 or IPv6.”</p>
<p>“To a list of sockets”, Liz corrects. “Remember how I could listen on more than one?”</p>
<p>“Oh yeah.”</p>
<p>“But it also has to handle listening on all ‘home’ IPs, and to be able to find a socket listening on IPv6 from an IPv4 IP.”</p>
<p>“Anyway, I have to hand this in”, Tim says says, gesturing to the loose collection of papers in his hand. “Are you going to finish that HTTP server before it’s due?”</p>
<p>Liz shrugs “I have a spare late day to use.”</p>
<p>Tim shakes his head in mock paternal disapproval.</p>
<p>Liz rolls her eyes and says “run along, Tim”</p>
<p>“Same time next week?”</p>
<p>“Yeah.”</p>
</div></div>
  </body>
</html>
