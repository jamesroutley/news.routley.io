<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://statisticallyrelevant.com/decision-trees-in-python-predicting-diabetes/">Original</a>
    <h1>Decision Trees in Python: Predicting Diabetes ‚Äì Statistically Relevant</h1>
    
    <div id="readability-page-1" class="page"><div>

        				<!--themify_builder_content-->

<!--/themify_builder_content-->


<p>In this post, we‚Äôll be learning about decision trees, how they work and what the benefits are for using them. We‚Äôll also use this algorithm in a real-world data to predict diabetes.</p>



<p>So, what are decision trees? Decision trees are a machine learning method for classification or regression. It works by segmenting the dataset through if-else control statements applied to the features.</p>



<p>There are few algorithms that can be used to implement decision trees and you may have heard of some of them. The most popular algorithms are ID3, C4.5 and CART. However, the <a href="https://scikit-learn.org/stable/modules/tree.html">Scikit-learn python library</a> only supports the CART algorithm which stands for Classification and Regression Trees. This article is entirely based on the CART algorithm.</p>



<h2>Benefits of Decision Trees</h2>



<p>Decision trees are known as ‚Äòwhite box‚Äô models which means that you can easily find and interpret their decisions. This is in contrast to ‚Äòblack box‚Äô neural networks where it is extremely difficult to figure out exactly how final predictions were made. Fortunately, decision tree models are easy to explain in simple terms, along with why and how the predictions were made by the model. Since decision trees are just if-else control statements at heart, you can even apply their rules and make predictions by hand.</p>



<p>Decision trees can be easily visualised in a tree-like plot that makes it even easier to understand and interpret the model. Have a look at this simplified decision tree below based on the data we‚Äôll be analysing later on in this article. We can actually take a single data point and trace the path it would take to reach the final prediction for it.</p>



<figure><img decoding="async" data-tf-not-load="1" width="1165" height="617" alt="" data-srcset="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=1280%2C678&amp;ssl=1 1280w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=300%2C159&amp;ssl=1 300w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=838%2C444&amp;ssl=1 838w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=768%2C407&amp;ssl=1 768w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=1536%2C814&amp;ssl=1 1536w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=2048%2C1085&amp;ssl=1 2048w" data-recalc-dims="1" data-src="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-demo-model.png?resize=1165%2C617&amp;ssl=1" data-sizes="(max-width: 1165px) 100vw, 1165px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/><figcaption>Decision Tree Simple Model Visualisation</figcaption></figure>



<p>The Scikit-learn python library together with the CART algorithm supports binary, categorical, and numerical target variables. However, for the feature variables, only binary and numerical features are supported at this time. This means that each node in the decision tree can only have up to 2 branches leading out the node and so features must either be true or false.</p>



<p>The good news is that decision trees require very little data preparation and so you don‚Äôt need to worry about centering or normalising the numerical features first. Having said that, there are still a couple of best practices to follow when fitting a decision tree to your data and we‚Äôll chat about them a bit more towards the end of this article.</p>



<p>It‚Äôs also good to keep in mind that decision trees are pretty sensitive to even small changes in the data and tend to learn the data like a parrot. This means that it is easy for the model to overfit to the data and can even be biased if the target variable classes are unbalanced. For this reason, decision trees must be closely controlled and optimised to prevent these problems (also more on this later).</p>



<h2>How Does it Work?</h2>



<p>Without getting all technical, let‚Äôs go over how the decision tree CART algorithm works. The main goal is to divide the data into distinct regions and to then make predictions based on those regions.</p>



<p>Starting at the top of the tree, the first question the algorithm must answer is ‚Äúwhich feature should be chosen at the root?‚Äù To answer this question, the algorithm needs a way of evaluating each feature and choosing the ‚Äòbest‚Äô feature to start with. Thereafter, the algorithm needs to keep asking a similar question at each node: ‚Äúwhich feature should be used to split this node?‚Äù It does this by calculating and optimising a metric against each of the available features.</p>



<p>There are a couple of metrics that can be used depending on the problem at hand. For example, if we‚Äôre dealing with a regression problem then we can seek to find the feature with the lowest RSS (residual sum of squares). However, if we have a classification problem then we can choose the feature with the lowest entropy (or highest information gain) or the lowest gini impurity.</p>



<p>If you‚Äôre wondering whether to choose entropy or gini impurity for classification problems, don‚Äôt waste too much time on it as there isn‚Äôt a hell of a lot of difference between the resulting decision trees. So toss a (balanced) coin and pick one.</p>



<p>Sklearn uses the gini impurity by default so we‚Äôll briefly go over this metric. The gini impurity is a metric that measures the purity of a node. That is, it measures how similar the observations are to each other. If all observations belong to the same class then the gini impurity would be 0 and the node would be considered ‚Äòpure‚Äô.</p>



<p>The decision tree algorithm is in constant pursuit of pure nodes and it will continue to split the data into deeper and deeper trees until it finally reaches pure leaf nodes (or it runs out of data or features). In addition, the data is split in a greedy fashion using recursive binary splitting. It‚Äôs called greedy because the algorithm will make a split based on what is optimal for the step it is currently dealing with and will not choose a split that can result in a more optimal tree further down the line. This also means there are no backsies ‚Äì the algorithm won‚Äôt backtrack and change its mind for a previous split.</p>



<p>We mentioned ‚Äòleaf‚Äô nodes. These are nodes that do not get any further splits and any observation that takes a route to a leaf node will get the resulting predicted class. At each leaf node, the class that has more than 50% of its samples belonging to it will serve as the prediction for that node. For classes with a tie, the non-event class is automatically chosen.</p>



<h2>Predicting Diabetes with Decision Trees in Python</h2>



<p>The data in this project contains biographical and medical information that is used to predict whether or not a patient has diabetes. You can find the data on <a href="https://www.kaggle.com/datasets/uciml/pima-indians-diabetes-database">Kaggle</a>.</p>



<p>These are the goals for this project:</p>



<ul><li>Explore the data ‚Äì determine if it requires any cleaning and if there are any correlations in the data</li><li>Apply the decision tree classification algorithm (using sklearn)</li><li>Visualise the decision tree</li><li>Evaluate the accuracy of the model</li><li>Optimise the model to improve accuracy</li></ul>



<h3>Setup</h3>



<pre data-enlighter-language="python" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">import numpy as np
import pandas as pd

from sklearn import tree
from sklearn.model_selection import train_test_split
from sklearn import metrics

import graphviz

import matplotlib.pyplot as plt
import seaborn as sns

sns.set()
custom_params = {&#34;axes.spines.right&#34;: False, &#34;axes.spines.top&#34;: False}
sns.set_theme(style=&#34;ticks&#34;, rc=custom_params)
sns.set_palette(sns.dark_palette(&#34;seagreen&#34;, reverse=True))</pre>



<h3>Explore</h3>



<p>These are the feature variables in our data:</p>



<ul><li>Number of pregnancies</li><li>Glucose</li><li>Blood pressure</li><li>Skin thickness</li><li>Insulin</li><li>BMI</li><li>Diabetes Pedigree Function</li><li>Age</li></ul>



<p>The most confusing feature here is the diabetes pedigree function. To understand it, I read the <a href="(https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2245318/pdf/procascamc00018-0276.pdf">recommended research paper</a> for this dataset and made these notes:</p>



<ul><li>The criteria for a diabetes diagnosis is if the ‚Äò2 hour post-load plasma glucose was at least 200 mg/dl‚Äô.</li><li>This dataset specifically contains women over the age of 21.</li><li>The Diabetes Pedigree Function provides ‚Äòa synthesis of the diabetes mellitus history in relatives and the genetic relationship of these relatives to the subject‚Äô. In other words, this score is higher if there is a family history of diabetes and it‚Äôs lower if not.</li></ul>



<p>To start our data exploration, let‚Äôs have a look at some summary statistics of our data:</p>



<figure><img decoding="async" loading="lazy" width="1165" height="255" alt="" data-srcset="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-summary-stats.png?resize=1280%2C280&amp;ssl=1 1280w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-summary-stats.png?resize=300%2C66&amp;ssl=1 300w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-summary-stats.png?resize=768%2C168&amp;ssl=1 768w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-summary-stats.png?resize=1536%2C335&amp;ssl=1 1536w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-summary-stats.png?resize=2048%2C447&amp;ssl=1 2048w" data-recalc-dims="1" data-src="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-summary-stats.png?resize=1165%2C255&amp;ssl=1" data-sizes="(max-width: 1165px) 100vw, 1165px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></figure>



<p>These are a few points we can note about the data:</p>



<ul><li>All our features are numerical</li><li>We have a total sample size of 768</li><li>There are no missing values to deal with right now</li><li>A few features have a minimum value of 0 which is suspicious for (living) humans:<ul><li>Min glucose = 0</li><li>Min blood pressure = 0</li><li>Min skin thickness = 0</li><li>Min insulin = 0</li><li>Min BMI = 0</li></ul></li></ul>



<p>To clean this up, we will convert these zeros to nulls and remove them from our dataset. This takes our dataset down from 768 to 392 (that was painful!).</p>



<p>Next, let‚Äôs have a look at a correlation matrix between all the variables in our data.</p>



<figure><img decoding="async" loading="lazy" width="917" height="701" alt="" data-srcset="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/predicting-diabetes-decision-trees-correlation.png?w=917&amp;ssl=1 917w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/predicting-diabetes-decision-trees-correlation.png?resize=300%2C229&amp;ssl=1 300w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/predicting-diabetes-decision-trees-correlation.png?resize=581%2C444&amp;ssl=1 581w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/predicting-diabetes-decision-trees-correlation.png?resize=768%2C587&amp;ssl=1 768w" data-recalc-dims="1" data-src="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/predicting-diabetes-decision-trees-correlation.png?resize=917%2C701&amp;ssl=1" data-sizes="(max-width: 917px) 100vw, 917px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></figure>



<ul><li>The outcome is positively correlated with all features which is a good sign for modelling</li><li>The outcome is most strongly correlated with Glucose (which makes sense since this is about Diabetes) and then Age</li><li>There is a strong correlation between Age and Pregnancies ‚Äì older women = more pregnancies?</li><li>Insulin and Glucose are correlated ‚Äì higher insulin = higher glucose?</li><li>SkinThickness and BMI are correlated ‚Äì higher BMI = higher skin thickness?</li></ul>



<p>An additional note to make is that decision trees tend to be sensitive to unbalanced classes. So, we‚Äôre also going to take note of how many observations fall into each outcome class from the original dataset:</p>



<figure><table><thead><tr><th> Not Diabetes   </th><th> Diabetes    </th></tr></thead><tbody><tr><td> 500</td><td> 268</td></tr></tbody></table></figure>



<p>From this table, we can see that the outcome classes are unbalanced ‚Äì there are twice as many non-events as there are events. This could make it difficult for the model to correctly predict when someone has diabetes. We may need to balance out the classes during the optimisation phase to see if it improves the accuracy of the model.</p>



<h3>Model</h3>



<p>The is the modelling process we‚Äôll follow to fit a decision tree model to the data:</p>



<ol><li>Separate the features and target into 2 separate dataframes</li><li>Split the data into training and testing sets (80/20) ‚Äì using <code>train_test_split</code> from <code>sklearn</code></li><li>Apply the decision tree classifier ‚Äì using <code>DecisionTreeClassifier</code> from <code>sklearn</code></li><li>Predict the target for the test set</li><li>Evaluate model accuracy ‚Äì using <code>metrics</code> from <code>sklearn</code></li><li>Visualise the decision trees ‚Äì using <code>graphviz</code></li><li>Optimise the decision tree ‚Äì using various parameters such as <code>max_depth</code>, <code>min_samples_split</code>, etc.</li></ol>



<pre data-enlighter-language="python" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group=""># Separate features and target
target = df_reduced[&#34;Outcome&#34;]
features = df_reduced.drop(&#34;Outcome&#34;, axis = 1)

# Split into train and test sets
features_train, features_test, target_train, target_test = train_test_split(features, target, test_size = 0.2, random_state = 42)

# Fit the decision tree model
decisiontree = tree.DecisionTreeClassifier(random_state = 42)
decisiontree = decisiontree.fit(features_train, target_train)

# Predict the target for the test set
target_pred = decisiontree.predict(features_test)</pre>



<p>This fit gives an accuracy score of 72.15%. Not too bad, but I‚Äôm sure we can improve it.</p>



<p>Visualising this tree, we can see it is a bit of a mess. Some nodes have just 1 sample in them and since we don‚Äôt have much data we will need to control the number of samples in each node and also the max depth as this can lead to overfitting and poor performance on unseen data.</p>



<figure><img decoding="async" loading="lazy" width="1165" height="500" alt="" data-srcset="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?resize=1280%2C549&amp;ssl=1 1280w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?resize=300%2C129&amp;ssl=1 300w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?resize=1036%2C444&amp;ssl=1 1036w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?resize=768%2C329&amp;ssl=1 768w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?w=2330&amp;ssl=1 2330w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?w=3495&amp;ssl=1 3495w" data-recalc-dims="1" data-src="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-1.png?resize=1165%2C500&amp;ssl=1" data-sizes="(max-width: 1165px) 100vw, 1165px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></figure>



<h3>Optimise</h3>



<p>We‚Äôll try a couple of strategies to optimise this model:</p>



<ul><li><code>max_depth</code> = 3, <code>min_samples_leaf</code> = 2 ‚Äî this produced an accuracy of <strong>74.68%</strong></li><li><code>max_depth</code> = 4, <code>min_samples_leaf</code> = 2 ‚Äî this produced as accuracy of <strong>73.42%</strong></li><li><code>max_depth</code> = 5, <code>min_samples_leaf</code> = 2 ‚Äî this produced an accuracy of <strong>75.95%</strong></li></ul>



<p>Increasing the depth any further results in declining performance. A max depth of 5 gave the highest accuracy.</p>



<p>Next, we will balance the dataset by randomly selecting only 130 rows from a total of 262 where the outcome = 0 (ie. class = Not Diabetic). Balancing the dataset produces an accuracy of <strong>78.85%</strong>, in addition to setting <code>max_depth</code> = 5 and <code>min_samples_leaf</code> = 2.</p>



<p>Looks like we‚Äôve found a winner üôÇ</p>



<p>Here is a visualisation of this optimised tree:</p>



<figure><img decoding="async" loading="lazy" width="1165" height="329" alt="" data-srcset="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?resize=1280%2C362&amp;ssl=1 1280w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?resize=300%2C85&amp;ssl=1 300w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?resize=768%2C217&amp;ssl=1 768w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?resize=1536%2C435&amp;ssl=1 1536w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?resize=2048%2C580&amp;ssl=1 2048w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?w=2330&amp;ssl=1 2330w, https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?w=3495&amp;ssl=1 3495w" data-recalc-dims="1" data-src="https://i0.wp.com/statisticallyrelevant.com/wp-content/uploads/2022/09/Screenshot-predicting-diabetes-decision-tree-model-2.png?resize=1165%2C329&amp;ssl=1" data-sizes="(max-width: 1165px) 100vw, 1165px" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></figure>



<p>I hope you found this post helpful. If you have any questions don‚Äôt hesitate to drop a comment or reach out to me on <a href="https://twitter.com/joleenbothma">Twitter</a>!</p>

	    
	</div></div>
  </body>
</html>
