<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.stevegattuso.me/2024/07/19/love-fennel.html">Original</a>
    <h1>LÖVE, Fennel, and the Conjure REPL</h1>
    
    <div id="readability-page-1" class="page"><p>
    Published on Jul 19th, 2024.
    
  </p><div>
    
    

    <p>I ran a quick experiment tonight that I think had some results worth sharing. Open up <a href="https://git.sr.ht/~vesto/fennel-love2d-conjure-repl/tree">this here repository</a> and let’s go on a little adventure.</p>

<p>I’ve been curious about playing with <a href="https://love2d.org/">LÖVE</a> for a game idea that’s been sloshing around in my head. While I love lua as a programming language, I can’t seem to shake the bliss of REPL-driven development that I can get from Lisps. Enter <a href="https://fennel-lang.org/">Fennel</a>, a small Lisp that compiles down to Lua.</p>

<p>I’m far from the first person who has tried combining LÖVE with Fennel, but <a href="https://sr.ht/~benthor/absolutely-minimal-love2d-fennel/">this minimal setup</a> for pairing the two up caught my eye. The only issue: the REPL provided is just a barebones CLI. My blissful Lisp REPL setup involves my preferred editor, neovim, and <a href="https://github.com/Olical/conjure">Conjure</a>, a plugin that provides a powerful REPL integration.</p>

<p>The tools are all here, but I need some glue to get this minimal LÖVE/Fennel setup connected to Conjure’s REPL inside Neovim. Conjure supports Fennel out-of-the-box, but by default uses a special Fennel REPL (Aniseed) that doesn’t help us. Thankfully there happens to be <a href="https://github.com/Olical/conjure/wiki/Quick-start:-Fennel-(stdio)">Fennel stdio client</a> that looks like it’s <em>allllmost</em> what I want. It can start fennel via the <code>fennel</code> command, but we really need it to start Fennel using the <code>love .</code> command. Let’s change that by setting a config var in neovim’s <code>init.lua</code></p>

<div><div><pre><code>let g:conjure#client#fennel#stdio#command = &#34;love .&#34;
</code></pre></div></div>

<p>Now if we open <code>main.fnl</code> we’ll also see our LÖVE game boot up and display a window- nice! The only issue is that executing forms via Conjure doesn’t seem to yield an output. The culprit? The <code>fennel-stdio</code> client looks for a pattern in the output to determine if the REPL is ready for the next command! This behavior is <a href="https://github.com/Olical/conjure/blob/master/doc/conjure-client-fennel-stdio.txt#L75-L80">hidden away</a> in the vim help doc for the client. We can patch this up by modifying the code that runs in the thread watching for input:</p>

<div><div><pre><code>(global thread-code
     (.. &#34;require(&#39;love.event&#39;)\n&#34;
         &#34;io.write(&#39;&gt;&gt; &#39;)\n&#34;
         &#34;io.flush()&#34;
         &#34;while 1 do\n&#34;
         &#34;love.event.push(&#39;stdin&#39;, io.read(&#39;*line&#39;))\n&#34;
         &#34;os.execute(&#39;sleep 0.15&#39;)\n&#34;
         &#34;io.write(&#39;&gt;&gt; &#39;)\n&#34;
         &#34;io.flush()&#34;
         &#34;end&#34;))

(fn love.load []
  ;; start a thread listening on stdin
  (: (love.thread.newThread thread-code) :start))
</code></pre></div></div>

<p>Now if we open up <code>main.fnl</code> again we’ll see our game <em>and</em> we can successfully execute forms in the Conjure REPL. We can even update functions like <code>love.draw</code> on the fly and see the results in the game window. Yeehaw!</p>

<p>There’s still a catch though: our barebones REPL uses a newline as the signal to start evaluating the input. This means that if you try to eval a multi-line form you’ll get a syntax error. Kind of a dealbreaker, but I’m sure there’s a solution to this one.</p>

<p>Unfortunately it’s late at night as I’m writing this and I wanted to get <em>something</em> out before I went to bed, knowing that there is a non-zero chance I won’t be able to come back to this soon. Regardless, this felt like an interesting enough adventure to share even if half-baked. I’ll provide an update if I figure out this last bit, but hopefully this is enough information to help someone else get inspired or unstuck with a similar problem.</p>

<hr/>

<p><strong>Update from the next day:</strong> I managed to get a hacky solution to this newline problem fixed in <a href="https://git.sr.ht/~vesto/fennel-love2d-conjure-repl/commit/20e75adcd04858f89ea05fd2e79602bf0c90171c#main.fnl">this commit</a>. It consists of moving the REPL implementation out to a separate file and waiting until the number of open/close parens balances before submitting code to the <code>stdin</code> event. This works, but unfortunately breaks if you have parenthesis in a string. I’ll see if I can find a sturdier technique in the future, but for now this has unblocked me for playing around. Suggestions welcome!</p>

  </div></div>
  </body>
</html>
