<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://luke8086.dev/netbsd-on-thinkpad-380z.html">Original</a>
    <h1>Running NetBSD on IBM ThinkPad 380Z</h1>
    
    <div id="readability-page-1" class="page">

<p>
  Launched in 1998, the 380Z was one very fine ThinkPad.

  It was the last ThinkPad to come in the classic bulky and rectangular form factor.

  It was also one of the first to feature a huge 13.3&#34; TFT display, powerful 233MHz Pentium II, and whopping 160 megs of RAM.
</p>

<p>
  I recently stumbled upon one in perfect condition on eBay, and immediately thought it&#39;d be a cool vintage gadget to put on the desk.

  I only wondered if I could still use it for some slow-paced, distraction-free coding, using reasonably modern software.
</p>

<p>
  I evaluated a bunch of contemporary operating systems, including different variants of BSD and Linux.

  Usually, the experience was underwhelming in terms of performance, hardware support and stability.

  Well... except for NetBSD, which gave me such perfectly smooth ride, that I thought it was worth sharing.
</p>

<img src="https://luke8086.dev/images/netbsd-photo-380z.jpg" alt="ThinkPad 380Z booting NetBSD"/>

<h2>Upgrading hard drive</h2>

<p>
  First things first, to improve performance, I&#39;ve replaced the original HDD with a 16GB mSATA.

  The 380Z comes with a standard 44-pin PATA interface, so I plugged it in through a generic mSATA-to-PATA adapter.

  It works <i>almost</i> seamlessly.
</p>

<p>
  One minor issue is that the BIOS-reported size is limited to 8GB.

  It doesn&#39;t matter to operating systems, but confuses some bootloaders.

  In general it&#39;s safer to use a smaller root partition and a separate one for <code>/home</code>. 

  However, NetBSD worked just fine off a single full-disk partition.
</p>

<h2>Connecting to network</h2>

<p>
  The 380Z doesn&#39;t have a built-in network card.

  Fortunately it has both CardBus and USB slots, so there are plenty of options.
</p>

<p>
  One that worked for me was Edimax EW-7108PCg — a WiFi CardBus card based on a RT2561S chipset.

  Another one was a generic no-name USB-to-LAN adapter based on RTL8153.
</p>

<h2>Booting the installer</h2>

<p>
  Despite having a USB port, the 380Z doesn&#39;t support USB boot.

  My CD drive was also erratic and practically unusable - a common issue in vintage laptops.

  Fortunately, the 380Z supports yet another, rather unusual boot option — using a CardBus disk.
</p>

<p>
  So I grabbed the <code>NetBSD-10.0-i386-install.img</code> image and wrote to a Compact Flash card.

  Then, plugged it in using a generic CF-to-CardBus adapter, and off it went.

  For NetBSD, booting from CardBus is business as usual, no questions asked.
</p>

<p>
  To be fair, with other systems it&#39;s also doable, but usually requires some tinkering to mount the root filesystem.
</p>


<h2>Installation</h2>

<p>
  NetBSD comes with a lightweight, friendly, text-mode installer.

  Step by step, it guides you through setting the keyboard layout, partitioning, selecting distribution sets, setting up the network, timezone, root shell and password, enabling the package manager, choosing optional daemons, and adding a user account.
</p>

<p>
  Unless you go for automatic full-disk mode, the trickiest part may be partitioning, since NetBSD uses its own custom scheme on top of MBR partitions.

  Fortunately, the whole process is <a href="https://www.netbsd.org/docs/guide/en/" target="_blank">well documented</a>.
</p>

<p>
  In my case, when prompted for distribution sets, I selected &#34;custom installation&#34;, and selected all sets except for source and debug ones.

  The resulting installation took about 1.6GB of disk space, and included the entire X11 environment.
</p>

<img src="https://luke8086.dev/images/netbsd-shot-install.png" alt="NetBSD installer"/>

  
<h2>Enabling framebuffer</h2>

<p>
  NetBSD supports VESA console framebuffer, though it&#39;s not enabled by default, and not particularly advertised in the docs.

  Turning it on is as simple as adding <code>vesa on; vesa 1024x768;</code> commands to a menu item in <code>/boot.cfg</code>.
</p>

<p>
  By the way, it&#39;s too bad that NetBSD&#39;s console doesn&#39;t support unicode, so it&#39;s not very usable without X.

  I think this could be a killer feature for hardware with even less RAM.
</p>

<h2>Saving RAM</h2>

<p>
  Even NetBSD comes with some bloatware ;-)

  To save as much RAM as possible, you can turn it off by adding to <code>/etc/rc.conf</code>:
</p>

<pre><code>inetd=NO
postfix=NO
cron=NO
virecover=NO
makemandb=NO
powerd=NO
syslogd=NO
</code></pre>

<p>
  You can also reduce the amount of consoles by commenting them out in <code>/etc/ttys</code>.
</p>

<p>
  After reboot, you&#39;ll have a pretty clean slate:
</p>


<pre><code>t380z# ps auxc
USER PID %CPU %MEM   VSZ   RSS TTY   STAT STARTED    TIME COMMAND
root   0  0.0 18.6     0 30300 ?     DKl   3:45PM 0:00.08 system
root   1  0.0  0.9  5836  1504 ?     Ss    3:45PM 0:00.08 init
root 345  0.0  2.0 12724  3292 ?     Ss    3:45PM 0:00.09 wpa_supplicant
root 707  0.0  1.0  6104  1544 ttyE0 O+    3:45PM 0:00.03 ps
root 711  0.0  3.1 12848  4988 ttyE0 Ss    3:45PM 0:00.54 login
root 712  0.0  1.4  6576  2216 ttyE0 S     3:45PM 0:00.24 sh
root 709  0.0  1.0  5744  1556 ttyE1 Ss+   3:45PM 0:00.03 getty

t380z# cat /proc/meminfo
        total:    used:    free:  shared: buffers: cached:
Mem:  139943936 32768000 107175936        0  8208384 18546688
Swap: 167759872        0 167759872
MemTotal:    136664 kB
MemFree:     104664 kB
MemShared:        0 kB
Buffers:     104664 kB
Cached:       18112 kB
SwapTotal:   163828 kB
SwapFree:    163828 kB
</code></pre>

<h2>WireGuard</h2>

<p>
  In case you&#39;d like to use WireGuard, NetBSD&#39;s got you covered.

  It supports it out of the box, with no extra dependencies.
  
  The entire documentation is a single man page and it&#39;s very straighforward.

  However, it only shows commands to manually execute, there&#39;s no dedicated config file.

  To make your setup persistent, you can simply add it to <code>/etc/rc.local</code>:
</p>

<pre><code>echo -n &#39;Setting up wireguard: &#39;

ifconfig wg0 create
ifconfig wg0 inet [ip/prefix]
wgconfig wg0 set private-key /etc/wg/key
wgconfig wg0 add peer [peer-name] \
        [public-key]
        --allowed-ips=[ip/prefix] \
        --endpoint=[endpoint]
ifconfig wg0 up

echo &#39;done.&#39;
</code></pre>

<h2>Setting locale</h2>

<p>
  The default locale in NetBSD is C.

  The installer doesn&#39;t prompt you to change it, and there isn&#39;t any dedicated config file.

  Instead, you need to set it manually, for example in <code>/etc/profile</code> or <code>~/.profile</code>:
</p>

<pre><code>export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LC_COLLATE=en_US.UTF-8
</code></pre>

<h2>The X server</h2>

<p>
  The GPU on 380Z is a NeoMagic MagicMedia 256AV and it has a dedicated driver in Xorg, called <code>neomagic</code>.

  However, only in NetBSD it worked out of the box without any tinkering, just by running <code>startx</code>.

  On other systems I tried, it required some adjustments or even resorting to plain VESA/FB drivers.
</p>


<h2>Window manager</h2>

<p>
  The default desktop environment of NetBSD, as included in the basesystem, consists of CTWM, XClock and XTerm.

  It looks <a href="https://luke8086.dev/images/netbsd-shot-ctwm.jpg" target="_blank">like this</a>.

  It&#39;s as minimal as it gets, it&#39;s not too ugly, and it&#39;s somewhat usable.
</p>

<p>
  I tried it for a bit, but couldn&#39;t get to like CTWM.

  Instead I&#39;ve replaced it with <a href="https://fastestcode.org/emwm.html" target="_blank">EMWM</a> (Enhanced Motif Window Manager), which is similarly lightweight.
</p>

<img src="https://luke8086.dev/images/netbsd-shot-emwm.png" alt="NetBSD running EMWM"/>

<h2>Terminal emulator</h2>

<p>
  I haven&#39;t found a terminal with a smaller memory footprint than XTerm.

  Even urxvt or st were larger.

  However, for me XTerm is actually good enough, so I didn&#39;t spent much time looking for alternatives.

  I only adjusted some colors, changed the font to Terminus, and added shortcuts for copy-pasting:
</p>

<pre><code>XTerm*VT100.background: black
XTerm*VT100.foreground: grey90
XTerm*VT100.faceName: Terminus
XTerm*VT100.faceSize: 12
XTerm*VT100.allowBoldFonts: false
XTerm*VT100.translations: #override \
      Ctrl Shift <key>V:    insert-selection(CLIPBOARD) \n\
      Ctrl Shift <key>C:    copy-selection(CLIPBOARD)
</key></key></code></pre>

<h2>The shell</h2>

<p>
  In the basesystem, NetBSD comes with sh, csh and ksh.

  I&#39;ve never bothered learning csh, but sh is fine for basic administrative tasks, and ksh is somewhere in between sh and bash in terms of functionality.

  I tried using ksh for a while but I kept missing features.

  Eventually I gave up on it and installed bash from packages.
</p>

<h2>Browsing web</h2>

<p>
  The most reasonable web browser for the 380Z is <a href="https://dillo-browser.github.io" target="_blank">Dillo</a>.

  It lacks support for JavaScript and modern CSS layouts, so many pages render all over the place, but it&#39;s still useful for reading docs and static pages.

  To my surprise, Google seems to work, and doesn&#39;t block it with captcha.
</p>

<p>
  One could argue Dillo is <i>exactly</i> what a web browser is supposed to be — a productivity tool for browsing nicely-formatted hypertext documents.

  I only wish I had some time to contribute to its development.

  Well, maybe when I retire...
</p>

<img src="https://luke8086.dev/images/netbsd-shot-web.png" alt="NetBSD running Dillo browser"/>

<h2>Playing music</h2>

<p>
  NetBSD was the only system I tried that properly supported the built-in Crystal CS4237B soundcard.

  In fact, it detected it twice, with two different drivers, <code>wss</code> and <code>sb</code>.

  Unfortunately this caused a conflict and they both emited garbage noise.

  I was able to fix it by adding <code>usermod disable wss</code> to the bootloader line.
</p>

<p>
  The most viable player is mpg123.

  It manages to play an online low-fi radio stream with only slight stuttering when other CPU-heavy tasks are running.

  Itself it seems to take around 10-20% of the CPU time.

  The audio quality of the soundcard is also just adequate for low-fi music, so for sure it won&#39;t be too distracting.
</p>

<h2>Once set up, what&#39;s it good for?</h2>

<p>
  The 380Z has a very comfortable, high-profile, classic ThinkPad keyboard, as well as a crispy 4:3 display.

  It&#39;s not as snappy as your latest MacBook, but it&#39;s fine for many terminal-based tasks, for example:
</p>

<ul>
  <li>any kind of work over SSH, even through WireGuard</li>
  <li>tinkering with UNIX and learning its internals</li>
  <li>low-level coding in C, assembly, etc.</li>
  <li>developing TUI and even lightweight GUI apps</li>
  <li>taking notes, writing blog posts</li>
  <li>developing a modern web browser (building dillo only takes ~20min) ;-)</li>
  <li>learning how to solve problems in a resource constrained environment</li>
  <li><span><a href="https://luke8086.dev/retronews.html" target="_blank">wasting time</a> on social media</span> practicing patience and mindfulness</li>
</ul>

<h2>Final thoughts on NetBSD</h2>

<p>
  NetBSD is a lightweight, compact, finely engineered system.

  It doesn&#39;t get as much attention as its BSD cousins, not to mention Linux, but I just cannot overstate how <i>pleasant</i> it is to use.
</p>

<p>
  It doesn&#39;t overwhelm you with thousands of packages and dozens of boot services right in a fresh install.

  On the contrary, it does only what you tell it to do.

  It puts you in charge and makes you feel like you can understand it top to bottom.
</p>

<p>
  It happily boots on a 25-year old machine, like you moved back in time, but still provides you with a full repository of the latest software.
</p>

<p>
  It may not be mainstream enough for a daily driver, but I think it&#39;s the ultimate UNIX to put on a spare, underpowered machine.
</p>

<p><em>~luke, 2024-12-16</em></p>


</div>
  </body>
</html>
