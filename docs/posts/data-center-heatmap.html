<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://barry.blog/2022/07/28/data-center-heatmap/">Original</a>
    <h1>Data Center Heatmap</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>At Automattic, our <a href="https://automattic.com/work-with-us/job/senior-systems-engineer/">systems team</a> manages over 10,000 physical servers located across 30 data centers on 6 continents.  As our compute density has increased from 24 CPU threads/<a href="https://en.wikipedia.org/wiki/Rack_unit">RU</a> in 2013 to 128 CPU threads/RU in 2022 the maximum thermal thresholds have decreased.  Older, less powerful servers could operate with inlet air temperatures up to 42C (107.6F) while newer servers trigger CPU throttling at much lower temperatures of 35C-37C (95F â€“ 98.6F).  Normal data center operating temperatures tend to be between 20F-25C, but cooling failures are somewhat common (<a href="https://status.cloud.google.com/incidents/XVq5om2XEDSqLtJZUvcH">they even affect Google</a>), so we have to monitor temperatures carefully.  </p>



<p>We are big fans of Prometheus and Grafana and for a few years we have had temperature graphs that look like this.   </p>



<figure><img loading="lazy" width="3440" height="1456" data-attachment-id="2199" data-permalink="https://barry.blog/2022/07/28/data-center-heatmap/temp-jnb/" data-orig-file="https://barry.files.wordpress.com/2022/07/temp-jnb.jpg" data-orig-size="3440,1456" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="temp-jnb" data-image-description="" data-image-caption="" data-medium-file="https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=300" data-large-file="https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=450" src="https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=450" alt="" srcset="https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=450 450w, https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=898 898w, https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=128 128w, https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=300 300w, https://barry.files.wordpress.com/2022/07/temp-jnb.jpg?w=768 768w" sizes="(max-width: 450px) 100vw, 450px"/></figure>



<p>This graph shows the temperatures of some servers located in our data center in Johannesburg, South Africa over one week. The colored lines represent individual servers and the bold, red line is the average temperature in the rack.</p>



<p>We get this data from our servers inlet temperature sensor using <a href="https://linux.die.net/man/1/ipmitool">ipmitool</a>.  I thought it would be interesting to see this data visualized a bit differently, and Grafana has a <a href="https://grafana.com/docs/grafana/latest/visualizations/heatmap/">Heatmap</a> graph type that made it pretty easy.</p>



<p>First, we simply want to graph the temperature by location for a given datacenter.  In PromQL this looks like</p>



<pre><code>avg by (location) (ipmi_inlet_temp{dc=&#34;$DC&#34;})</code></pre>



<p><code>location</code> includes the rack identifier and the location in the rack.  For example a location of <code>101-10</code> would mean Rack 101, RU 10.    We store this information is our data center asset management system (which is a <a href="https://github.com/Automattic/g4-gm-servermattic/blob/master/etc/servers.dat">colon separated file</a>) and it gets added as labels to all Prometheus metrics.  By choosing the <code>Heatmap (New)</code> graph type and configuring some basic graph options, Grafana allows us to create a graph which shows the same data as our original graph, but in a different, and more useful way.    We can easily see that the top of the rack is warmer than the bottom which is to be expected since the cold air in this facility comes from the floor.  We can also see that temperatures have increased slightly over the past week, which is not ideal, but they are not at dangerous levels. </p>



<figure><img loading="lazy" data-attachment-id="2223" data-permalink="https://barry.blog/2022/07/28/data-center-heatmap/jnb/" data-orig-file="https://barry.files.wordpress.com/2022/07/jnb.jpg" data-orig-size="664,1704" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="jnb" data-image-description="" data-image-caption="" data-medium-file="https://barry.files.wordpress.com/2022/07/jnb.jpg?w=117" data-large-file="https://barry.files.wordpress.com/2022/07/jnb.jpg?w=399" src="https://barry.files.wordpress.com/2022/07/jnb.jpg?w=399" alt="" width="332" height="852" srcset="https://barry.files.wordpress.com/2022/07/jnb.jpg?w=399 399w, https://barry.files.wordpress.com/2022/07/jnb.jpg?w=332 332w, https://barry.files.wordpress.com/2022/07/jnb.jpg 664w, https://barry.files.wordpress.com/2022/07/jnb.jpg?w=37 37w, https://barry.files.wordpress.com/2022/07/jnb.jpg?w=117 117w" sizes="(max-width: 332px) 100vw, 332px"/><figcaption>JNB</figcaption></figure>



<p>We can contrast this with a rack in Milan, Italy where there was a cooling outage which caused the servers operate beyond their intended temperature threshold for a period of time:</p>



<figure><img loading="lazy" data-attachment-id="2215" data-permalink="https://barry.blog/2022/07/28/data-center-heatmap/mxp/" data-orig-file="https://barry.files.wordpress.com/2022/07/mxp.jpg" data-orig-size="648,1668" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="mxp" data-image-description="" data-image-caption="" data-medium-file="https://barry.files.wordpress.com/2022/07/mxp.jpg?w=117" data-large-file="https://barry.files.wordpress.com/2022/07/mxp.jpg?w=398" src="https://barry.files.wordpress.com/2022/07/mxp.jpg" alt="" width="324" height="834" srcset="https://barry.files.wordpress.com/2022/07/mxp.jpg?w=324&amp;h=834 324w, https://barry.files.wordpress.com/2022/07/mxp.jpg?w=37&amp;h=96 37w, https://barry.files.wordpress.com/2022/07/mxp.jpg?w=117&amp;h=300 117w, https://barry.files.wordpress.com/2022/07/mxp.jpg?w=398&amp;h=1024 398w, https://barry.files.wordpress.com/2022/07/mxp.jpg 648w" sizes="(max-width: 324px) 100vw, 324px"/><figcaption>Milan, Italy</figcaption></figure>



<p>Using the same data and graph options, we are also able to easily create heat maps of entire rows of racks to visualize airflow management and identify areas for potential improvement.  Here is a row of racks in a data center in Los Angeles with poor airflow management.  We can see the racks at the end of the row suffer from increased temperatures due to air leakage from the hot aisle to the cold aisle.</p>



<figure><img loading="lazy" width="3448" height="1868" data-attachment-id="2212" data-permalink="https://barry.blog/2022/07/28/data-center-heatmap/la-row4/" data-orig-file="https://barry.files.wordpress.com/2022/07/la-row4.jpg" data-orig-size="3448,1868" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="la-row4" data-image-description="" data-image-caption="" data-medium-file="https://barry.files.wordpress.com/2022/07/la-row4.jpg?w=300" data-large-file="https://barry.files.wordpress.com/2022/07/la-row4.jpg?w=450" src="https://barry.files.wordpress.com/2022/07/la-row4.jpg" alt=""/><figcaption>Los Angeles</figcaption></figure>



<p>When can contrast this with data from a set of racks in Amsterdam which have much better airflow management</p>



<figure><img loading="lazy" width="3422" height="1872" data-attachment-id="2213" data-permalink="https://barry.blog/2022/07/28/data-center-heatmap/ams/" data-orig-file="https://barry.files.wordpress.com/2022/07/ams.jpg" data-orig-size="3422,1872" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="ams" data-image-description="" data-image-caption="" data-medium-file="https://barry.files.wordpress.com/2022/07/ams.jpg?w=300" data-large-file="https://barry.files.wordpress.com/2022/07/ams.jpg?w=450" src="https://barry.files.wordpress.com/2022/07/ams.jpg" alt=""/><figcaption>Amsterdam</figcaption></figure>



<p>I hope this post shows how easy it is to create cool(!!) and useful heat maps using Grafana, Prometheus, and a little bit of time. </p>
</div></div>
  </body>
</html>
