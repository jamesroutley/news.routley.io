<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://glandium.org/blog/?p=4346">Original</a>
    <h1>I kind of killed Mercurial at Mozilla</h1>
    
    <div id="readability-page-1" class="page"><div>
				<p>Did you hear the news? <a href="https://groups.google.com/a/mozilla.org/g/firefox-dev/c/QnfydsDj48o/m/8WadV0_dBQAJ">Firefox development is moving from Mercurial to Git</a>. While the decision is far from being mine, and I was barely involved in the small incremental changes that ultimately led to this decision, I feel I have to take at least some responsibility. And if you are one of those who would rather use Mercurial than Git, you may direct all your ire at me.</p>
<p>But let&#39;s take a step back and review the past 25 years leading to this decision. You&#39;ll forgive me for skipping some details and any possible inaccuracies. This is already a long post, while I could have been more thorough, even I think that would have been too much. This is also not an official Mozilla position, only my personal perception and recollection as someone who was involved at times, but mostly an observer from a distance.</p>
<h2>From CVS to DVCS</h2>
<p>From its <a href="https://www.youtube.com/watch?v=4Q7FTjhvZ7Y">release in 1998</a>, the Mozilla source code was kept in a CVS repository. If you&#39;re too young to know what <a href="https://cvs.nongnu.org/">CVS</a> is, let&#39;s just say it&#39;s an old school version control system, with its set of problems. Back then, it was mostly ubiquitous in the Open Source world, as far as I remember.</p>
<p>In the early 2000s, the <a href="https://subversion.apache.org/">Subversion</a> version control system gained some traction, solving some of the problems that came with CVS. Incidentally, Subversion was created by Jim Blandy, who now works at Mozilla on completely unrelated matters. In the same period, the Linux kernel development moved from CVS to <a href="https://www.bitkeeper.org/">Bitkeeper</a>, which was more suitable to the distributed nature of the Linux community. BitKeeper had its own problem, though: it was the opposite of Open Source, but for most pragmatic people, it wasn&#39;t a real concern because free access was provided. Until it became a problem: someone at <a href="https://en.wikipedia.org/wiki/Open_Source_Development_Labs">OSDL</a> developed an alternative client to BitKeeper, and licenses of BitKeeper were rescinded for OSDL members, including Linus Torvalds (they were even prohibited from purchasing one).</p>
<p>Following this fiasco, in April 2005, two weeks from each other, both Git and Mercurial were born. The former was created by Linus Torvalds himself, while the latter was developed by Olivia Mackall, who was a Linux kernel developer back then. And because they both came out of the same community for the same needs, and the same shared experience with BitKeeper, they both were similar distributed version control systems.</p>
<p>Interestingly enough, several other DVCSes existed:</p>
<ul>
<li><a href="https://github.com/bestpractical/svk">SVK</a>, a DVCS built on top of Subversion, allowing users to create local (offline) branches of remote Subversion repositories. It was also known for its powerful merging capabilities. I <a href="https://glandium.org/blog/?p=56">picked it at some point</a> for my <a href="https://www.debian.org/">Debian</a> work, mainly because I needed to interact with Subversion repositories.</li>
<li>Arch (tla), later known as <a href="https://www.gnu.org/software/gnu-arch/">GNU arch</a>. From what I remember, it was awful to use. You think Git is complex or confusing? Arch was way worse. It was forked as &#34;Bazaar&#34;, but the fork was abandoned in favor of &#34;Bazaar-NG&#34;, now known as <a href="https://bazaar.canonical.com/">&#34;Bazaar&#34; or &#34;bzr&#34;</a>, a much more user-friendly DVCS. The first release of Bzr actually precedes Git&#39;s by two weeks. I guess it was too new to be considered by Linus Torvalds for the Linux kernel needs.</li>
<li><a href="https://www.monotone.ca/">Monotone</a>, which I don&#39;t know much about, but it was <a href="https://lkml.org/lkml/2005/4/6/121">mentioned by Linus Torvalds</a> two days before the <a href="https://github.com/git/git/commit/e83c5163316f89bfbde7d9ab23ca2e25604af290">initial Git commit of Git</a>. As far as I know, it was too slow for the Linux kernel&#39;s needs. I&#39;ll note in passing that Monotone is the creation of Graydon Hoare, who also created Rust.</li>
<li><a href="https://darcs.net/">Darcs</a>, with its patch-based model, rather than the common snapshot-based model, allowed more flexible management of changes. This approach came, however, at the expense of performance.</li>
</ul>
<p>In this landscape, the major difference Git was making at the time was that it was blazing fast. Almost incredibly so, at least on Linux systems. That was less true on other platforms (especially Windows). It was a game-changer for handling large codebases in a smooth manner.</p>
<p>Anyways, two years later, in 2007, Mozilla decided to move its source code not to Bzr, not to Git, not to Subversion (which, yes, was a contender), but to Mercurial. The decision &#34;process&#34; was laid down in two rather <a href="https://soberbuildengineer.com/blog/2006/11/version-control-system-shootout-redux/index.html">colorful</a> blog <a href="https://soberbuildengineer.com/blog/2007/04/version-control-system-shootout-redux-redux/index.html">posts</a>. My memory is a bit fuzzy, but I don&#39;t recall that it was a particularly controversial choice. All of those DVCSes were still young, and there was no definite &#34;winner&#34; yet (GitHub hadn&#39;t even been founded). It made the most sense for Mozilla back then, mainly because the Git experience on Windows still wasn&#39;t there, and that mattered a lot for Mozilla, with its diverse platform support. As a contributor, I didn&#39;t think much of it, although to be fair, at the time, I was mostly consuming the source tarballs.</p>
<h2>Personal preferences</h2>
<p>Digging through my archives, I&#39;ve unearthed a forgotten chapter: I did end up setting up both a Mercurial and a Git mirror of the Firefox source repository on alioth.debian.org. Alioth.debian.org was a <a href="https://fusionforge.org/">FusionForge</a>-based collaboration system for Debian developers, similar to <a href="https://sourceforge.net/">SourceForge</a>. It was the ancestor of <a href="https://salsa.debian.org/">salsa.debian.org</a>. I used those mirrors for the Debian packaging of Firefox (<em>cough</em> <em>cough</em> <a href="https://glandium.org/blog/?p=4251">Iceweasel</a>). The Git mirror was created with <a href="https://repo.or.cz/w/fast-export.git">hg-fast-export</a>, and the Mercurial mirror was only a necessary step in the process. By that time, I had converted my Subversion repositories to Git, and switched off SVK. Incidentally, I started contributing to Git around that time as well.</p>
<p>I apparently did this not too long after Mozilla switched to Mercurial. As a Linux user, I think I just wanted the speed that Mercurial was not providing. Not that Mercurial was <em>that</em> slow, but the difference between a couple seconds and a couple hundred milliseconds was a significant enough difference in user experience for me to prefer Git (and Firefox was not the only thing I was using version control for)</p>
<p>Other people had also similarly created <a href="https://repo.or.cz/w/mozilla-central.git">their own mirror</a>, or with <a href="https://github.com/neonux/mozilla-all">other tools</a>. But none of them were &#34;compatible&#34;: their commit hashes were different. Hg-git, used by the latter, was putting extra information in commit messages that would make the conversion differ, and hg-fast-export would just not be consistent with itself! My mirror is long gone, and those have not been updated in more than a decade.</p>
<p>I did end up using Mercurial, when I got <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555979">commit access to the Firefox source repository</a> in April 2010. I still kept using Git for my Debian activities, but I now was also using Mercurial to push to the Mozilla servers. I joined Mozilla as a contractor a few months after that, and kept using Mercurial for a while, but as a, by then, long time Git user, it never really clicked for me. It turns out, the sentiment was shared by several at Mozilla.</p>
<h2>Git incursion</h2>
<p>In the early 2010s, GitHub was becoming ubiquitous, and the Git mindshare was getting large. Multiple projects at Mozilla were already entirely hosted on GitHub. As for the Firefox source code base, Mozilla back then was kind of a Wild West, and engineers being engineers, multiple people had been using Git, with their own inconvenient workflows involving a local Mercurial clone. The most popular set of scripts was <a href="https://github.com/mozilla/moz-git-tools/">moz-git-tools</a>, to incorporate changes in a local Git repository into the local Mercurial copy, to then send to Mozilla servers. In terms of the number of people doing that, though, I don&#39;t think it was a lot of people, probably a few handfuls. On my end, I was still keeping up with Mercurial.</p>
<p>I think at that time several engineers had their own unofficial Git mirrors on GitHub, and later on Ehsan Akhgari provided <a href="https://groups.google.com/g/mozilla.dev.platform/c/BwFWAoifPvk/m/llcvcaBVF_IJ">another mirror, with a twist</a>: it also contained the full CVS history, which the canonical Mercurial repository didn&#39;t have. This was particularly interesting for engineers who needed to do some code archeology and couldn&#39;t get past the 2007 cutoff of the Mercurial repository. I think that mirror ultimately became the official-looking, but really unofficial, <a href="https://github.com/mozilla/mozilla-central">mozilla-central repository on GitHub</a>. On a side note, a Mercurial repository containing the CVS history was also <a href="https://gregoryszorc.com/blog/2015/05/18/firefox-mercurial-repository-with-cvs-history/">later set up</a>, but that didn&#39;t lead to something officially supported on the Mercurial side.</p>
<p>Some time around 2011~2012, I started to more seriously consider using Git for work myself, but wasn&#39;t satisfied with the workflows others had set up for themselves. I really didn&#39;t like the idea of wasting extra disk space keeping a Mercurial clone around while using a Git mirror. I wrote a Python script that would use Mercurial as a library to access a remote repository and produce a <a href="https://git-scm.com/docs/git-fast-import">git-fast-import</a> stream. That would allow the creation of a git repository without a local Mercurial clone. It worked quite well, but it was not able to incrementally update. Other, more complete tools existed already, some of which I mentioned above. But as time was passing and the size and depth of the Mercurial repository was growing, these tools were showing their limits and were too slow for my taste, especially for the initial clone.</p>
<h2>Boot to Git</h2>
<p>In the same time frame, Mozilla <a href="https://en.wikipedia.org/wiki/Firefox_OS">ventured in the Mobile OS sphere with Boot to Gecko</a>, later known as Firefox OS. What does that have to do with version control? The needs of third party collaborators in the mobile space led to the creation of what is now the <a href="https://github.com/mozilla/gecko-dev/">gecko-dev repository on GitHub</a>. As I remember it, it was challenging to create, but once it was there, Git users could just clone it and have a working, up-to-date local copy of the Firefox source code and its history... which they could already have, but this was the first officially supported way of doing so. Coincidentally, Ehsan&#39;s unofficial mirror was having trouble (to the point of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=943132#c8">GitHub closing the repository</a>) and was <a href="https://groups.google.com/g/mozilla.dev.planning/c/rkyKnCMQmYg/m/YykH5Ad1ZzEJ">ultimately shut down</a> in December 2013. </p>
<p>You&#39;ll often find comments on the interwebs about how GitHub has become unreliable since the Microsoft acquisition. I can&#39;t really comment on that, but if you think GitHub is unreliable now, rest assured that it was worse in its beginning. And its sustainability as a platform also wasn&#39;t a given, being a rather new player. So on top of having this official mirror on GitHub, Mozilla also ventured in setting up its own <a href="https://git.mozilla.org">Git server</a> for greater control and reliability.</p>
<p>But the canonical repository was still the Mercurial one, and while Git users now had a supported mirror to pull from, they still had to somehow interact with Mercurial repositories, most notably for the <a href="https://wiki.mozilla.org/ReleaseEngineering/TryServer">Try server</a>.</p>
<h2>Git slowly creeping in Firefox build tooling</h2>
<p>Still in the same time frame, tooling around building Firefox <a href="https://gregoryszorc.com/blog/2012/09/26/mach-has-landed/">was improving drastically</a>. For obvious reasons, when version control integration was needed in the tooling, Mercurial support was always a no-brainer.</p>
<p>The first explicit acknowledgement of a Git repository for the Firefox source code, other than the addition of the <code>.gitignore</code> file, was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=774109">bug 774109</a>. It added a script to install the prerequisites to build Firefox on macOS (still called OSX back then), and that would print a message inviting people to obtain a copy of the source code with either Mercurial or Git. That was a precursor to current <a href="https://hg.mozilla.org/mozilla-central/file/default/python/mozboot/bin/bootstrap.py"><code>bootstrap.py</code></a>, from September 2012.</p>
<p>Following that, as far as I can tell, the first real incursion of Git in the Firefox source tree tooling happened in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=965120">bug 965120</a>. A few days earlier, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=952379">bug 952379</a> had added a <code>mach clang-format</code> command that would apply <code>clang-format-diff</code> to the output from <code>hg diff</code>. Obviously, running <code>hg diff</code> on a Git working tree didn&#39;t work, and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=965120">bug 965120</a> was filed, and support for Git was added there. That was in January 2014.</p>
<p>A year later, when the initial implementation of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1162191"><code>mach artifact</code></a> was added (which ultimately led to <a href="https://firefox-source-docs.mozilla.org/contributing/build/artifact_builds.html">artifact builds</a>), Git users were an immediate thought. But while they were considered, it was not to support them, but to avoid actively breaking their workflows. Git support for <code>mach artifact</code> was eventually added <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1234913">14 months later</a>, in March 2016.</p>
<h2>From gecko-dev to git-cinnabar</h2>
<p>Let&#39;s step back a little here, back to the end of 2014. My user experience with Mercurial had reached a level of dissatisfaction that was enough for me to decide to take that script from a couple years prior and make it work for incremental updates. That meant finding a way to store enough information locally to be able to reconstruct whatever the incremental updates would be relying on (guess why other tools hid a local Mercurial clone under hood). I got something working rather quickly, and after talking to a few people about this side project at the <a href="https://wiki.mozilla.org/All_Hands/2014_Portland">Mozilla Portland All Hands</a> and seeing their excitement, I published a <a href="https://github.com/glandium/git-remote-hg/commit/b74ed6a4d3dd8331c9b879656b61284a62393351">git-remote-hg initial prototype</a> on the last day of the All Hands.</p>
<p>Within weeks, the prototype gained the ability to <a href="https://glandium.org/blog/?p=3405">directly push to Mercurial repositories</a>, and a couple months later, was renamed to <a href="https://github.com/glandium/git-cinnabar/">git-cinnabar</a>. At that point, as a Git user, instead of cloning the gecko-dev repository from GitHub and switching to a local Mercurial repository whenever you needed to push to a Mercurial repository (i.e. the aforementioned Try server, or, at the time, for reviews), you could just clone and push directly from/to Mercurial, all within Git. And it was fast too. You could get a full clone of mozilla-central in less than half an hour, when at the time, other similar tools would take more than 10 hours (needless to say, it&#39;s even worse now).</p>
<p>Another couple months later (we&#39;re now at the end of April 2015), git-cinnabar became able to start off a local clone of the gecko-dev repository, rather than clone from scratch, which could be time consuming. But because git-cinnabar and the tool that was updating gecko-dev weren&#39;t producing the same commits, this setup was cumbersome and not really recommended. For instance, if you pushed something to mozilla-central with git-cinnabar from a gecko-dev clone, it would come back with a different commit hash in gecko-dev, and you&#39;d have to deal with the divergence.</p>
<p>Eventually, in April 2020, the scripts updating <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1629115">gecko-dev were switched to git-cinnabar</a>, making the use of gecko-dev alongside git-cinnabar a more viable option. Ironically(?), the switch occurred to ease collaboration with <a href="https://www.kaiostech.com/">KaiOS</a> (you know, the mobile OS born from the ashes of Firefox OS). Well, okay, in all honesty, when the need of syncing in both directions between Git and Mercurial (we only had ever synced from Mercurial to Git) came up, I nudged Mozilla in the direction of git-cinnabar, which, in my (biased but still honest) opinion, was the more reliable option for two-way synchronization (we did have regular conversion problems with hg-git, nothing of the sort has happened since the switch).</p>
<h2>One Firefox repository to rule them all</h2>
<p>For reasons I don&#39;t know, Mozilla decided to use separate Mercurial repositories as &#34;branches&#34;. With the switch to the <a href="https://mozilla.github.io/process-releases/draft/development_overview/">rapid release process</a> in 2011, that meant one repository for nightly (mozilla-central), one for aurora, one for beta, and one for release. And with the addition of <a href="https://blog.mozilla.org/en/mozilla/delivering-a-mozilla-firefox-extended-support-release/">Extended Support Releases</a> in 2012, we now add a new ESR repository every year. Boot to Gecko also had its own branches, and so did Fennec (Firefox for Mobile, before Android). There are a <a href="https://hg.mozilla.org/releases/">lot of them</a>.</p>
<p>And then there are also <a href="https://hg.mozilla.org/integration/">integration branches</a>, where developer&#39;s work lands before being merged in mozilla-central (or backed out if it breaks things), always leaving mozilla-central in a (hopefully) good state. Only one of them remains in use today, though.</p>
<p>I can only suppose that the way Mercurial branches work was not deemed practical. It is worth noting, though, that Mercurial branches <em>are</em> used in some cases, to branch off a dot-release when the next major release process has already started, so it&#39;s not a matter of not knowing the feature exists or some such.</p>
<p>In 2016, Gregory Szorc set up a <a href="https://groups.google.com/g/firefox-dev/c/u-4MdqlAHo0/m/0EonLH8RMQAJ">new repository</a> that would contain them all (or at least most of them), which <a href="https://groups.google.com/g/firefox-dev/c/u-4MdqlAHo0/m/-fkfzNm9AAAJ">eventually became</a> what is now the <a href="https://hg.mozilla.org/mozilla-unified">mozilla-unified repository</a>. This would e.g. simplify switching between branches when necessary.</p>
<p>7 years later, for some reason, the other &#34;branches&#34; still exist, but most developers are expected to be using mozilla-unified. Mozilla&#39;s CI also <a href="https://hg.mozilla.org/mozilla-central/rev/e325fb428095">switched to using mozilla-unified as base repository</a>.</p>
<p>Honestly, I&#39;m not sure why the separate repositories are still the main entry point for pushes, rather than going directly to mozilla-unified, but it probably comes down to switching being work, and not being a top priority. Also, it probably doesn&#39;t help that working with multiple heads in Mercurial, even (especially?) with bookmarks, can be a source of confusion. To give an example, if you aren&#39;t careful, and do a plain clone of the mozilla-unified repository, you may not end up on the latest mozilla-central changeset, but rather, e.g. one from beta, or some other branch, depending which one was last updated.</p>
<h2>Hosting is simple, right?</h2>
<p>Put your repository on a server, install hgweb or gitweb, and that&#39;s it? Maybe that works for... <a href="https://repo.mercurial-scm.org/hg/">Mercurial itself</a>, but that repository &#34;only&#34; has slightly over 50k changesets and less than 4k files. Mozilla-central has more than an order of magnitude more changesets (close to 700k) and two orders of magnitude more files (more than 700k if you count the deleted or moved files, 350k if you count the currently existing ones).</p>
<p>And remember, there are a lot of &#34;duplicates&#34; of this repository. And I didn&#39;t even mention <a href="https://mozilla-version-control-tools.readthedocs.io/en/latest/hgmo/managing-repos.html#creating-a-user-repository">user repositories</a> and <a href="https://wiki.mozilla.org/ReleaseEngineering/DisposableProjectRepositories">project branches</a>.</p>
<p>Sure, it&#39;s a self-inflicted pain, and you&#39;d think it could probably(?) be mitigated with <a href="https://wiki.mercurial-scm.org/SharedRepository">shared repositories</a>. But consider the simple case of two repositories: mozilla-central and autoland. You make autoland use mozilla-central as a shared repository. Now, you push something new to autoland, it&#39;s stored in the autoland datastore. Eventually, you merge to mozilla-central. Congratulations, it&#39;s now in both datastores, and you&#39;d need to clean-up autoland if you wanted to avoid the duplication.</p>
<p>Now, you&#39;d think mozilla-unified would solve these issues, and it would... to some extent. Because that wouldn&#39;t cover user repositories and project branches briefly mentioned above, which in GitHub parlance would be considered as Forks. So you&#39;d want a mega global datastore shared by all repositories, and repositories would need to only expose what they really contain. Does Mercurial support that? I don&#39;t think so (okay, I&#39;ll give you that: even if it doesn&#39;t, it could, but that&#39;s extra work). And since we&#39;re talking about a transition to Git, does Git support that? You may have read about how you can <a href="https://github.com/torvalds/linux/tree/5895e21f3c744ed9829e3afe9691e3eb1b1932ae#linux-kernel">link to a commit from a fork and make-pretend that it comes from the main repository on GitHub</a>? At least, it shows a warning, now. That&#39;s essentially the architectural reason why. So the actual answer is that Git doesn&#39;t support it out of the box, but GitHub has some backend magic to handle it somehow (and hopefully, other things like Gitea, Girocco, Gitlab, etc. have something similar).</p>
<p>Now, to come back to the size of the repository. A repository is not a static file. It&#39;s a server with which you negotiate what you have against what it has that you want. Then the server bundles what you asked for based on what you said you have. Or in the opposite direction, you negotiate what you have that it doesn&#39;t, you send it, and the server incorporates what you sent it. Fortunately the latter is less frequent and requires authentication. But the former is more frequent and CPU intensive. Especially when pulling a large number of changesets, which, incidentally, cloning is.</p>
<p>&#34;But there is a solution for clones&#34; you might say, which is true. That&#39;s <a href="https://wiki.mercurial-scm.org/ClonebundlesExtension">clonebundles</a>, which offload the CPU intensive part of cloning to a single job scheduled regularly. Guess who implemented it? <a href="https://gregoryszorc.com/blog/2018/07/27/benefits-of-clone-offload-on-version-control-hosting/">Mozilla</a>. But that only covers the cloning part. We actually had laid the ground to support <a href="https://repo.mercurial-scm.org/hg/rev/149fc8a44184fbeddd9d9602e3860455e92c1301">offloading large incremental updates and split clones</a>, but that never materialized. Even with all that, that still leaves you with a server that can display file contents, diffs, blames, provide zip archives of a revision, and more, all of which are CPU intensive in their own way.</p>
<p>And these endpoints are regularly abused, and cause extra load to your servers, yes plural, because of course a single server won&#39;t handle the load for the number of users of your big repositories. And because your endpoints are abused, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1596135">you have to close some of them</a>. And I&#39;m not mentioning the Try repository with its tens of thousands of heads, which brings its own sets of problems (and it would have even more heads if we didn&#39;t fake-merge them once in a while).</p>
<p>Of course, all the above applies to Git (and it only gained <a href="https://git-scm.com/docs/bundle-uri">support for something akin to clonebundles</a> last year). So, when the Firefox OS project was stopped, there wasn&#39;t much motivation to continue supporting our own Git server, Mercurial still being the official point of entry, and <a href="https://groups.google.com/g/mozilla.dev.version-control/c/H6_TWlWPQGk/m/abchYZWgNQAJ">git.mozilla.org was shut down</a> in 2016.</p>
<h2>The growing difficulty of maintaining the status quo</h2>
<p>Slowly, but steadily in more recent years, as new tooling was added that needed some input from the source code manager, support for Git was more and more consistently added. But at the same time, as people left for other endeavors and weren&#39;t necessarily replaced, or more recently with <a href="https://blog.mozilla.org/en/mozilla/changing-world-changing-mozilla/">layoffs</a>, resources allocated to such tooling have been spread thin.</p>
<p>Meanwhile, the repository growth didn&#39;t take a break, and the Try repository was becoming an increasing pain, with push times quite often exceeding 10 minutes. The ongoing work to <a href="https://groups.google.com/a/mozilla.org/g/dev-platform/c/jfR4V4Sa3lw/m/z9P0wJsRAgAJ">move Try pushes to Lando</a> will hide the problem under the rug, but the underlying problem will still exist (although the last version of Mercurial seems to have improved things).</p>
<p>On the flip side, more and more people have been relying on Git for Firefox development, to my own surprise, as I didn&#39;t really push for that to happen. It just happened organically, by ways of git-cinnabar existing, providing a compelling experience to those who prefer Git, and, I guess, word of mouth. I was genuinely surprised when I recently heard the use of Git among <a href="https://github.com/mozilla-conduit/review/blob/main/README.md">moz-phab</a> users had surpassed a third. I did, however, occasionally orient people who struggled with Mercurial and said they were more familiar with Git, towards git-cinnabar. I suspect there&#39;s a somewhat large number of people who never realized Git was a viable option.</p>
<p>But that, on its own, can come with its own challenges: if you use git-cinnabar without being backed by gecko-dev, you&#39;ll have a hard time sharing your branches on GitHub, because you can&#39;t push to a fork of gecko-dev without pushing your entire local repository, as they have different commit histories. And switching to gecko-dev when you weren&#39;t already using it requires some extra work to rebase all your local branches from the old commit history to the new one.</p>
<p>Clone times with git-cinnabar have also started to go a little out of hand in the past few years, but this was mitigated in a similar manner as with the Mercurial cloning problem: with static files that are refreshed regularly. Ironically, that made <a href="https://glandium.org/blog/?p=3913">cloning with git-cinnabar faster than cloning with Mercurial</a>. But generating those static files is increasingly time-consuming. As of writing, generating those for mozilla-unified takes close to 7 hours. I was predicting clone times over 10 hours &#34;in 5 years&#34; in a <a href="https://glandium.org/blog/?p=3964">post from 4 years ago</a>, I wasn&#39;t too far off. With exponential growth, it could still happen, although to be fair, CPUs have improved since. I will explore the performance aspect in a subsequent blog post, alongside the upcoming release of git-cinnabar 0.7.0.beta.1. I don&#39;t even want to check how long it now takes with hg-git or git-remote-hg (they were already taking more than a day when git-cinnabar was taking a couple hours).</p>
<p>I suppose it&#39;s about time that I clarify that git-cinnabar has always been a side-project. It hasn&#39;t been part of my duties at Mozilla, and the extent to which Mozilla supports git-cinnabar is in the form of <a href="https://taskcluster.net/">taskcluster</a> workers on the <a href="https://community-tc.services.mozilla.com/">community instance</a> for both git-cinnabar CI and generating those clone bundles. Consequently, that makes the above git-cinnabar specific issues a Me problem, rather than a Mozilla problem.</p>
<h2>Taking the leap</h2>
<p>I can&#39;t talk for the people who made the proposal to move to Git, nor for the people who put a green light on it. But I can at least give my perspective.</p>
<p>Developers have regularly asked why Mozilla was still using Mercurial, but I think it was the first time that a formal proposal was laid out. And it came from the Engineering Workflow team, responsible for issue tracking, code reviews, source control, build and more.</p>
<p>It&#39;s easy to say &#34;Mozilla should have chosen Git in the first place&#34;, but back in 2007, GitHub wasn&#39;t there, Bitbucket wasn&#39;t there, and all the available options were rather new (especially compared to the then 21 years-old CVS). I think Mozilla made the right choice, all things considered. Had they waited a couple years, the story might have been different.</p>
<p>You might say that Mozilla stayed with Mercurial for so long because of the <a href="https://en.wikipedia.org/wiki/Sunk_cost#Fallacy_effect">sunk cost fallacy</a>. I don&#39;t think that&#39;s true either. But after the <a href="https://bitbucket.org/blog/sunsetting-mercurial-support-in-bitbucket">biggest Mercurial repository hosting service turned off Mercurial support</a>, and the <a href="https://github.com/facebook/sapling">main contributor to Mercurial going their own way</a>, it&#39;s hard to ignore that the landscape has evolved.</p>
<p>And the problems that we regularly encounter with the Mercurial servers are not going to get any better as the repository continues to grow. As far as I know, all the Mercurial repositories bigger than Mozilla&#39;s are... not using Mercurial. Google has its own closed-source server, and Facebook has another of its own, and <a href="https://github.com/facebook/sapling/blob/main/eden/mononoke/README.md">it&#39;s not really public either</a>. With resources spread thin, I don&#39;t expect Mozilla to be able to continue supporting a Mercurial server indefinitely (although I guess <a href="https://octobus.net/">Octobus</a> could be contracted to give a hand, but is that sustainable?).</p>
<p>Mozilla, being a champion of Open Source, also doesn&#39;t live in a silo. At some point, you have to meet your contributors where they are. And the Open Source world is now majoritarily using Git. I&#39;m sure the vast majority of new hires at Mozilla in the past, say, 5 years, know Git and have had to learn Mercurial (although they arguably didn&#39;t need to). Even within Mozilla, with thousands(!) of repositories on GitHub, Firefox is now actually the exception rather than the norm. I should even actually say Desktop Firefox, because even Mobile Firefox lives on GitHub (although <a href="https://github.com/mozilla-mobile/firefox-android">Fenix</a> is moving back in together with Desktop Firefox, and the timing is such that that will probably happen before Firefox moves to Git).</p>
<p>Heck, even <a href="https://devblogs.microsoft.com/bharry/the-largest-git-repo-on-the-planet/">Microsoft moved to Git</a>!</p>
<p>With a significant developer base already using Git thanks to git-cinnabar, and all the constraints and problems I mentioned previously, it actually seems natural that a transition (finally) happens. However, had git-cinnabar or something similarly viable not existed, I don&#39;t think Mozilla would be in a position to take this decision. On one hand, it probably wouldn&#39;t be in the current situation of having to support both Git and Mercurial in the tooling around Firefox, nor the resource constraints related to that. But on the other hand, it would be farther from supporting Git and being able to make the switch in order to address all the other problems.</p>
<h2>But... GitHub?</h2>
<p>I hope I made a compelling case that hosting is not as simple as it can seem, at the scale of the Firefox repository. It&#39;s also not Mozilla&#39;s main focus. Mozilla has enough on its plate with the migration of existing infrastructure that does rely on Mercurial to understandably not want to figure out the hosting part, especially with limited resources, and with the mixed experience hosting both Mercurial and git has been so far.</p>
<p>After all, GitHub couldn&#39;t even display things like the <a href="https://github.com/mozilla/gecko-dev/graphs/contributors">contributors&#39; graph on gecko-dev</a> until recently, and hosting is literally their job! They still drop the ball on large blames (thankfully we have <a href="https://searchfox.org/">searchfox</a> for those).</p>
<p>Where does that leave us? <a href="https://about.gitlab.com/">Gitlab</a>? For those criticizing GitHub for being proprietary, that&#39;s probably not open enough. <a href="https://source.cloud.google.com/">Cloud Source Repositories</a>? &#34;But GitHub is Microsoft&#34; is a complaint I&#39;ve read a lot after the announcement. Do you think Google hosting would have appealed to these people? <a href="https://bitbucket.org/">Bitbucket</a>? I&#39;m kind of surprised it wasn&#39;t in the list of providers that were considered, but I&#39;m also kind of glad it wasn&#39;t (and I&#39;ll leave it at that).</p>
<p>I think the only relatively big hosting provider that could have made the people criticizing the choice of GitHub happy is <a href="https://codeberg.org/">Codeberg</a>, but I hadn&#39;t even heard of it before it was mentioned in response to Mozilla&#39;s announcement. But really, with literal thousands of Mozilla repositories already on GitHub, with literal <a href="https://github.blog/2018-11-08-100m-repos/">tens of millions repositories</a> on the platform overall, the pragmatic in me can&#39;t deny that it&#39;s an attractive option (and I can&#39;t stress enough that I wasn&#39;t remotely close to the room where the discussion about what choice to make happened).</p>
<p>&#34;But it&#39;s a slippery slope&#34;. I can see that being a real concern. LLVM also <a href="https://blog.llvm.org/2019/08/the-llvm-project-is-moving-to-github.html">moved its repository to GitHub</a> (from a (I think) self-hosted Subversion server), and ended up <a href="https://discourse.llvm.org/t/pull-request-migration-reminder-sept-1-oct-1/73043">moving off Bugzilla and Phabricator to GitHub issues and PRs</a> four years later. As an occasional contributor to LLVM, I hate this move. I hate the GitHub review UI with a passion.</p>
<p>At least, right now, GitHub PRs are not a viable option for Mozilla, for their lack of support for security related PRs, and the more general shortcomings in the review UI. That doesn&#39;t mean things won&#39;t change in the future, but let&#39;s not get too far ahead of ourselves. The move to Git has just been announced, and the migration has not even begun yet. Just because Mozilla is moving the Firefox repository to GitHub doesn&#39;t mean it&#39;s locked in forever or that all the eggs are going to be thrown into one basket. If bridges need to be crossed in the future, we&#39;ll see then.</p>
<h2>So, what&#39;s next?</h2>
<p>The <a href="https://groups.google.com/a/mozilla.org/g/firefox-dev/c/QnfydsDj48o/m/8WadV0_dBQAJ">official announcement</a> said we&#39;re not expecting the migration to really begin until six months from now. I&#39;ll swim against the current here, and say this: the earlier you can switch to git, the earlier you&#39;ll find out what works and what doesn&#39;t work for you, whether you already know Git or not.</p>
<p>While there is not one unique workflow, here&#39;s what I would recommend anyone who wants to take the leap off Mercurial right now:</p>
<ul>
<li>
<p>Make sure git is installed. Chances are you already have it.</p>
</li>
<li>
<p>Install <code>git-cinnabar</code> where <code>mach bootstrap</code> would install it.</p>
<pre><code>$ mkdir -p ~/.mozbuild/git-cinnabar
$ cd ~/.mozbuild/git-cinnabar
$ curl -sOL https://raw.githubusercontent.com/glandium/git-cinnabar/master/download.py
$ python3 download.py &amp;&amp; rm download.py</code></pre>
</li>
<li>
<p>Add <code>git-cinnabar</code> to your <code>PATH</code>. Make sure to also set that wherever you keep your <code>PATH</code> up-to-date (<code>.bashrc</code> or wherever else).</p>
<pre><code>$ PATH=$PATH:$HOME/.mozbuild/git-cinnabar</code></pre>
</li>
<li>
<p>Enter your mozilla-central or mozilla-unified Mercurial working copy, we&#39;ll do an in-place conversion, so that you don&#39;t need to move your mozconfigs, objdirs and what not.</p>
</li>
<li>
<p>Initialize the git repository from GitHub.</p>
<pre><code>$ git init
$ git remote add origin https://github.com/mozilla/gecko-dev
$ git remote update origin</code></pre>
</li>
<li>
<p>Switch to a Mercurial remote.</p>
<pre><code>$ git remote set-url origin hg::https://hg.mozilla.org/mozilla-unified
$ git config --local remote.origin.cinnabar-refs bookmarks
$ git remote update origin --prune</code></pre>
</li>
<li>
<p>Fetch your local Mercurial heads.</p>
<pre><code>$ git -c cinnabar.refs=heads fetch hg::$PWD refs/heads/default/*:refs/heads/hg/*</code></pre>
<p>This will create a bunch of <code>hg/&lt;sha1&gt;</code> local branches, not all relevant to you (some come from old branches on mozilla-central). Note that if you&#39;re using <a href="https://wiki.mercurial-scm.org/MqExtension">Mercurial MQ</a>, this will not pull your queues, as they don&#39;t exist as heads in the Mercurial repo. You&#39;d need to apply your queues one by one and run the command above for each of them.</p>
<pre><code>$ git -c cinnabar.refs=bookmarks fetch hg::$PWD refs/heads/*:refs/heads/hg/*</code></pre>
<p>This will create <code>hg/&lt;bookmark_name&gt;</code> branches.</p>
</li>
<li>
<p>Now, make git know what commit your working tree is on.</p>
<pre><code>$ git reset $(git cinnabar hg2git $(hg log -r . -T &#39;{node}&#39;))</code></pre>
<p>This will take a little moment because Git is going to scan all the files in the tree for the first time. On the other hand, it won&#39;t touch their content or timestamps, so if you had a build around, it will still be valid, and <code>mach build</code> won&#39;t rebuild anything it doesn&#39;t have to.</p>
</li>
</ul>
<p>As there is no one-size-fits-all workflow, I won&#39;t tell you how to organize yourself from there. I&#39;ll just say this: if you know the Mercurial sha1s of your previous local work, you can create branches for them with:</p>
<pre><code>$ git branch &lt;branch_name&gt; $(git cinnabar hg2git &lt;hg_sha1&gt;)</code></pre>
<p>At this point, you should have everything available on the Git side, and you can remove the <code>.hg</code> directory. Or move it into some empty directory somewhere else, just in case. But don&#39;t leave it here, it will only confuse the tooling. Artifact builds WILL be confused, though, and you&#39;ll have to <code>./mach configure</code> before being able to do anything. You may also hit <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1865299">bug 1865299</a> if your working tree is older than this post.</p>
<p>If you have any problem or question, you can ping me on <a href="https://matrix.to/#/#git-cinnabar:mozilla.org">#git-cinnabar</a> or <a href="https://matrix.to/#/#git:mozilla.org">#git</a> on Matrix. I&#39;ll put the instructions above somewhere on wiki.mozilla.org, and we can collaboratively iterate on them.</p>
<p>Now, what the announcement didn&#39;t say is that the Git repository WILL NOT be gecko-dev, doesn&#39;t exist yet, and WON&#39;T BE COMPATIBLE (trust me, it&#39;ll be for the better). Why did I make you do all the above, you ask? Because that won&#39;t be a problem. I&#39;ll have you covered, I promise. The upcoming release of git-cinnabar 0.7.0.beta.1 will have a way to smoothly switch between gecko-dev and the future repository (incidentally, that will also allow to switch from a pure git-cinnabar clone to a gecko-dev one, for the git-cinnabar users who have kept reading this far).</p>
<h2>What about git-cinnabar?</h2>
<p>With Mercurial going the way of the dodo at Mozilla, my own need for git-cinnabar will vanish. Legitimately, this begs the question whether it will still be maintained.</p>
<p>I can&#39;t answer for sure. I don&#39;t have a crystal ball. However, the needs of the transition itself will motivate me to finish some long-standing things (like finalizing the support for pushing merges, which is currently behind an experimental flag) or implement some missing features (support for creating Mercurial branches).</p>
<p>Git-cinnabar started as a Python script, it grew a sidekick implemented in C, which then incorporated some Rust, which then cannibalized the Python script and took its place. It is now close to 90% Rust, and 10% C (if you don&#39;t count the code from Git that is statically linked to it), and has sort of become my Rust playground (it&#39;s also, I must admit, a mess, because of its history, but it&#39;s getting better). So the day to day use with Mercurial is not my sole motivation to keep developing it. If it were, it would stay stagnant, because all the features I need are there, and the speed is not all that bad, although I know it could be better. Arguably, though, git-cinnabar has been relatively stagnant feature-wise, because all the features I need are there.</p>
<p>So, no, I don&#39;t expect git-cinnabar to die along Mercurial use at Mozilla, but I can&#39;t really promise anything either.</p>
<h2>Final words</h2>
<p>That was a long post. But there was a lot of ground to cover. And I still skipped over a bunch of things. I hope I didn&#39;t bore you to death. If I did and you&#39;re still reading... what&#39;s wrong with you? ;)</p>
<p>So this is the end of Mercurial at Mozilla. <a href="https://en.wikipedia.org/wiki/So_Long,_and_Thanks_for_All_the_Fish">So long, and thanks for all the fish</a>. But this is also the beginning of a transition that is not easy, and that will not be without hiccups, I&#39;m sure. So fasten your seatbelts (plural), and welcome the change.</p>
<p>To circle back to the clickbait title, did I really kill Mercurial at Mozilla? Of course not. But it&#39;s like I stumbled upon a few sparks and tossed a can of gasoline on them. I didn&#39;t start the fire, but I sure made it into a proper bonfire... and now it has turned into a wildfire.</p>
<p>And who knows? 15 years from now, someone else might be looking back at how Mozilla picked Git at the wrong time, and that, had we waited a little longer, we would have picked some yet to come new horse. But hey, that&#39;s the tech cycle for you.</p>
	
					
				<p>2023-11-22 04:49:47+0900</p>
				<p><a href="https://glandium.org/blog/?cat=25" rel="category">p.m.o</a> </p>
						
													<p>You can <a href="#respond">leave a response</a>, or <a href="https://glandium.org/blog/wp-trackback.php?p=4346" rel="trackback">trackback</a> from your own site.</p>
						
												
			</div></div>
  </body>
</html>
