<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vuyisile.com/pypi-in-a-box-using-a-raspberry-pi-as-a-portable-pypi-server/">Original</a>
    <h1>PyPI in a Box (2020)</h1>
    
    <div id="readability-page-1" class="page"><article id="post-1745">
    
    		<section>
		    <p>A conversation was started after in the <a href="https://africa.pycon.org/" rel="noopener noreferrer" target="_blank">PyCon Africa</a> slack group after the conference discussing solutions to problems common in our communities and projects we can collaborate on and the biggest problem that came to my mind was the state of Internet connectivity in Africa. </p>
<p>Internet access is poor in many parts of the continent and the costs are prohibitive in the countries that have good connections. This makes it difficult for developers on the continent to get access to all the resources they need when they need them.</p>
<p>This isn’t a problem I can solve and I’m sure it will take some time before Internet access is evenly distributed and made affordable for everyone.</p>
<p>One approach to overcoming this problem is to make Web content available for offline use. To this end, I thought of the web content that I and many other software developers consume on a regular basis. I wanted to find a way to make the content of websites such as Stack Overflow, Wikipedia and PyPI(Python Package Index) available offline.</p>
<p>I did research on this and found that it is possible. At the time of writing, I have successfully cloned <a href="http://stackoverflow.com/" rel="noopener noreferrer" target="_blank">Stack OverFlow</a> and <a href="http://pypi.org/" rel="noopener noreferrer" target="_blank">PyPI</a>. In this post I will discuss how to clone the PyPI repository to a Raspberry Pi and serve up the content in order to allow connected devices to <code>pip install</code> packages without an active Internet connection.</p>
<h2>Goals</h2>
<p>There are a number of ways to go about creating your own PyPI mirror and the way I did it might now work for everyone. My goals for this project project were:</p>
<ul>
<li>The hardware to do this must be affordable (&lt;=US$100)</li>
<li>There must be little or no setup required on the client computers.</li>
</ul>
<p>I decided to use a Raspberry Pi 4 running on Raspian with a 200Gb SD Card for storage. I used <code>minirepo</code> to clone PyPI, <code>pypiserver</code> to serve up the packages and <code>nginx</code> to create a reverse proxy.</p>

<p>There are four steps involved in creating a local PyPI server:</p>
<ol>
<li>Download and install Operating System and system utilities</li>
<li>Configure Raspberry Pi to act as a WiFi hotspot, DHCP and DNS server</li>
<li>Clone/Download PyPI packages</li>
<li>Configure a webserver to deliver the downloaded packages to connected clients</li>
</ol>
<p>I’ll explain the steps above in more detail below.</p>
<h2>1. Download and install Operating System and system utilities</h2>
<p>The Raspberry Pi is a small credit card sized computer that sells for at least US $35. For this project I used the Raspberry Pi 4 but other models should also work. Raspberry Pi models 3 and 4 have built in WiFi adapters which make the job of setting up the Pi as a WiFi hotspot or access point simpler than when using an external wireless adapter.</p>
<p>To get started, <a href="https://projects.raspberrypi.org/en/projects/raspberry-pi-getting-started/2" rel="noopener noreferrer" target="_blank">download and install Raspbian</a>. Raspbian is a light-weight Debian based OS that is optimised for the Raspberry Pi. In order to work as an access point, the Raspberry Pi will need to have access point software installed, along with DHCP server software to provide connecting devices with a network address.</p>
<p>Next, download all the utilities and packages you will need before configuring the Raspberry Pi. I learned this the hard way after I messed up the network configurations on the Pi and ended up not being able to download anything afterwards.</p>
<p>You need the following software packages:</p>
<ul>
<li><strong>dnsmasq</strong> — DNS and DHCP Server software</li>
<li><strong>hostapd</strong> — Access Point software</li>
<li><strong>minirepo</strong> — Used to clone PyPI for offline use</li>
<li><strong>pypiserver</strong> — Creates an index from cloned PyPI packages</li>
<li><strong>nginx</strong> — A web server</li>
</ul>
<p>To install these packages, run these two commands:</p>
<p><code>$ sudo apt install dnsmasq hostapd nginx</code></p>
<h2>2. Configure Raspberry Pi for WiFi hotspot, DHCP and DNS</h2>
<p>The goal in this step is to configure a stand alone network to act as a server so the Raspberry Pi needs to have a static IP Address assigned to the Wireless port. To configure the static IP, edit the <code>dhcpcd</code> configuration file:</p>
<p><code>$ sudo nano /etc/dhcpcd.conf</code></p>
<p>add the following:</p>
<pre title="">interface wlan0
    static ip_address=192.168.4.1/24
    nohook wpa_supplicant
</pre>
<h3>Configure DHCP</h3>
<p>A lot of the default settings in the <code>dnsmasq</code> settings are not necessary. Create a new configuration file:</p>
<p><code>$ sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig</code></p>
<p>Add the following configuration:</p>
<pre title="">interface=wlan0
listen-address=192.168.4.1
dhcp-range=192.168.4.2,192.168.4.30,255.255.255.0,24h
address=/raspberrypi.local/192.168.4.1
</pre>
<p>This sets up DHCP for clients connecting through the wireless interface <code>wlan0</code>.</p>
<h3>Create an Access Point</h3>
<p>Next, configure the access point software(<code>hostapd</code>):</p>
<p><code>$ sudo nano /etc/hostapd/hostapd.conf</code></p>
<p>Add the following:</p>
<pre title=""># /etc/hostapd/hostapd.conf                          

interface=wlan0
driver=nl80211
ssid=NameOfNetwork
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
wpa_passphrase=YourNetworkPassword
</pre>
<p>Add your own network name and network password where it says<code>ssid</code> and <code>wpa_passphrase</code>,respectively.</p>
<p>Tell the system where to find this file, open the <code>hostapd</code> config file:</p>
<p>Find the line with <code>#DAEMON_CONF</code>, and replace it with this:</p>
<p><code>DAEMON_CONF=&#34;/etc/hostapd/hostapd.conf&#34;</code></p>
<h3>Add routing and masquerade</h3>
<p>Edit <code>/etc/sysctl.conf</code> and uncomment the line that says:</p>
<p>Add a masquerade for outbound traffic on <code>eth0</code>:</p>
<p>Save the new rule:</p>
<p>Edit<code> /etc/rc.local</code> and add the following above “<code>exit 0</code>” to install the rules at boot:</p>
<p><code>iptables-restore &lt; /etc/iptables.ipv4.nat</code></p>
<p>This is important if you decide to share an internet connection or setup a bridge on the Raspberry Pi later.</p>
<p>The Raspberry Pi should be ready to work as an access point. If you&#39;re connected to it directly, now would be a good time <a href="https://itsfoss.com/ssh-into-raspberry/" rel="noopener noreferrer" target="_blank">to enable SSH.</a> Reboot the Raspberry Pi and test if everything works.</p>
<p>Using a different WiFi enabled device like a phone or laptop, scan for new wireless networks. If everything went smoothly, you should see the WiFi network you created above. Try connecting to it.</p>
<h2>3.Clone PyPI </h2>
<p>In this section, you will see how to clone PyPI and configure the following packages:</p>
<ul>
<li>minirepo</li>
<li>pypiserver</li>
<li>nginx</li>
</ul>
<h3>Minirepo</h3>
<p><a href="https://pypi.org/project/minirepo/" rel="noopener noreferrer" target="_blank">Minirepo</a> is a commandline program that downloads packages from <a href="http://pypi.org/" rel="noopener noreferrer" target="_blank">PyPI.org</a> so you can use <code>pip</code> without Internet. The easiest way to install it is to use pip:</p>
<p><code>$ pip install minirepo</code></p>
<p>The first time it’s executed, <code>minirepo</code> will ask you for the local repository path(where it should save downloaded packages to), which defaults to <code>~/minirepo</code> in Linux. A JSON configuration file is created and saved as <code>~/.minirepo</code>, that you can edit to your preferences. </p>
<p>There are a number of alternatives out there for cloning PyPI, but I used <code>minirepo</code> because it allows you to download a selective mirror, only downloading all sources for Python 3, for example. At the time of writing this post, the entire PyPI repository is somewhere in the neighbourhood of 1TB but, by using a selective download, I was able to get it down to 120GB or so. Here&#39;s the configuration I used for this project:</p>
<pre title="">{
  &#34;processes&#34;: 10, 
  &#34;package_types&#34;: [
    &#34;bdist_egg&#34;, 
    &#34;bdist_wheel&#34;, 
    &#34;sdist&#34;
  ], 
  &#34;extensions&#34;: [
    &#34;bz2&#34;, 
    &#34;egg&#34;, 
    &#34;gz&#34;, 
    &#34;tgz&#34;, 
    &#34;whl&#34;, 
    &#34;zip&#34;
  ], 
  &#34;python_versions&#34;: [
    &#34;3.0&#34;,
    &#34;3.1&#34;,
    &#34;3.2&#34;,
    &#34;3.3&#34;,
    &#34;3.4.10&#34;,
    &#34;3.5.7&#34;,
    &#34;3.6.9&#34;,
    &#34;3.7.2&#34;,
    &#34;3.7.3&#34;,
    &#34;3.7.4&#34;, 
    &#34;any&#34;, 
    &#34;cp27&#34;, 
    &#34;py2&#34;, 
    &#34;py2.py3&#34;, 
    &#34;py27&#34;, 
    &#34;source&#34;
  ], 
  &#34;repository&#34;: &#34;/home/pi/minirepo&#34;
}
</pre>
<p>The configuration above downloads sources for Python 3 and limits the package types to <code>sdist</code>,<code> bdist_wheel</code> and <code>bdist_egg</code> packages. The downside of using this approach is that some packages that don&#39;t meet the filter criteria will not get downloaded.</p>
<p>Cloning PyPI takes a long time, so you&#39;ll want to leave it running in the background, while you watch a movie or ten depending on your Internet connection speed.</p>
<h3>Pypiserver</h3>
<p>At this point, you should have PyPI mirrored to your computer. My local PyPI mirror has 200000+ packages.</p>
<p><code>Pip</code> is the most popular tool for installing Python packages, and the one included with modern versions of Python. It provides the essential core features for finding, downloading, and installing packages from PyPI and other Python package indexes, and can be incorporated into a wide range of development workflows via its command-line interface (CLI).</p>
<p><code>Pip</code> supports installing packages from:</p>
<ul>
<li>PyPI (and other indexes) using requirement specifiers.</li>
<li>VCS project urls.</li>
<li>Local project directories</li>
<li>Local or remote source archives</li>
</ul>
<p>Since you have cloned the PyPi packages to a local repository, <code>pip</code> can install those packages directly from the local PyPI mirror you just downloaded. That is not the purpose of this article however. The goal here is to allow remote clients to connect to the Raspberry Pi and download packages over the network. This is where <code>pypiserver</code> comes in.</p>
<p><code>pypiserver</code>, will serve up the local package index that will allow <code>pip</code> to find packages in your repository over the network.</p>
<p>First, test to see if it works:</p>
<p><code>$ pypi-server -p 8080 ~/minirepo &amp;      # Will listen to all IPs.</code></p>
<p>Notice that when running it, the command to run it is <code>pypi-server</code> and not <code>pypyserver</code>.</p>
<p>Here, you&#39;re starting <code>pypiserver</code> and running it on port 8080. It will find packages in the <code>minirepo</code> folder. This process will keep running in the background until you either kill it or shutdown the Raspberry Pi. I will show you how to start it a boot later.</p>
<p>If you visit the static IP you set for the Raspberry Pi at port <code>8080</code> in your browser you should see a message similar to the one below:</p>
<p><img loading="lazy" src="https://i2.wp.com/vuyisile.com/wp-content/uploads/2020/02/pypi-server-screenshot-1.jpeg?resize=632%2C394&amp;ssl=1" alt="" width="632" height="394" srcset="https://i2.wp.com/vuyisile.com/wp-content/uploads/2020/02/pypi-server-screenshot-1.jpeg?resize=632%2C394&amp;ssl=1 632w, https://i2.wp.com/vuyisile.com/wp-content/uploads/2020/02/pypi-server-screenshot-1.jpeg?w=742&amp;ssl=1 742w" sizes="(max-width: 632px) 100vw, 632px" data-recalc-dims="1"/></p>
<p>You can install from the local packages repository now:</p>
<p><code>pip install --index-url http://localhost:8080/simple/ <package> </package></code></p>
<p>OR, from a client computer:</p>
<p><code>pip install --index-url http://192.168.4.1:8080/ <package> </package></code></p>
<p>If you have installed <code>pypiserver</code> on a remote URL without HTTPS you will receive an “untrusted” warning from pip, urging you to append the <code>--trusted-host</code> option:</p>
<p><code>pip --trusted-host 192.168.4.1 install --index-url http://192.168.4.1:8080/ <package></package></code></p>
<p>An even shorter way:</p>
<p>Always specifying the local pypi URL and the trusted host flags on the commandline can be cumbersome.</p>
<pre title="">[global]
trusted-host = 192.168.4.1

[install]
index-url = http://192.168.4.1:8080
</pre>
<p><strong>Home directory</strong></p>
<ul>
<li>On Unix and macOS the home directory file is: <code>$HOME/.pip/pip.conf</code></li>
<li>On Windows the file is: <code>%HOME%\pip\pip.ini</code></li>
</ul>
<p><strong>In a virtual environment:</strong></p>
<ul>
<li>On Unix and macOS the file is <code>$VIRTUAL_ENV/pip.conf</code></li>
<li>On Windows the file is: <code>%VIRTUAL_ENV%\pip.ini</code></li>
</ul>
<p>I recommend placing this config file in a virtual environment.</p>
<h2> 4. Setup a Web server to deliver the packages.</h2>
<p>By default, <code>pypiserver</code> scans the entire packages directory each time an incoming HTTP request occurs. This can cause significant slow downs when serving a large number of packages like we are in this instance.</p>
<p>One way to serve the files up faster is to put <code>pypiserver</code> behind a reverse proxy and enabling your web server&#39;s built in caching functionality. I&#39;ll use <code>nginx</code> in this article but you&#39;re free to use any webserver you prefer. </p>
<h3>Setup a new virtual host in <code>nginx</code>.</h3>
<p>Create a file  <code>/etc/nginx/sites-available/cheeseshop.com</code>. For the purposes of this article I&#39;ll refer to the new virtual host as <em>cheeseshop.com</em>.</p>
<p>Run <code>$ sudo nano /etc/nginx/sites-available/cheeseshop.com</code> and add the following content:</p>
<pre title="">

proxy_cache_path /data/nginx/cache
                 levels=1:2
                 keys_zone=pypiserver_cache:10m
                 max_size=10g
                 inactive=120m
                 use_temp_path=off;


upstream pypi {
        server 127.0.0.1:8080;
}

server {
        listen 80;
        server_name cheeseshop.com;
        autoindex on;
        location / {
          proxy_set_header Host $host:$server_port;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_cache pypiserver_cache;
          proxy_pass       http://pypi;
        }
}

</pre>
<p>The first part of the config instructs <code>nginx</code> to create a 10GB cache that will remain active for 2 hours.</p>
<p>The <code>server</code> section specifies that port 80 will be used for incoming HTTP connections and that those requests get forwarded to the pypi server.</p>
<p>I don&#39;t own the <em>cheeseshop.com</em> domain but I can use it since we are creating a stand alone network without access to the internet. In order for client computers to be able to connect to <em>cheeseshop.com</em>, you&#39;ll want to tell the DNS server how to resolve it. More on that in a bit.</p>
<p>To enable this new virtual host, you want to create a symbolic link to the config file you just created in the <code> /etc/nginx/sites-enabled/</code> folder:</p>
<p><code>$ sudo ln -s /etc/nginx/sites-available/cheeseshop.com /etc/nginx-sites-enabled/</code></p>
<p>Doing this will enable the new virtual host. Check that everything works by running</p>
<p>Open <code>/etc/hosts</code> and add an entry for the newly created cheeseshop.com domain:</p>
<pre title="">192.168.4.1     cheeseshop.com
</pre>
<p>The hosts file contains domain to IP address mappings that help the computer serve you the right content. Dnsmasq will check this file whenever it starts up so it is a good idea to restart it:</p>
<p><code>sudo service dnsmasq restart</code></p>
<p>Restart nginx too for good measure:</p>
<p><code>sudo service nginx restart</code></p>
<p>Assuming everything went smoothly, you should be able to install Python packages from client computers using a hostname as opposed to using an IP now.</p>
<h2>Using the server</h2>
<p>To test this out, connect to the Raspberry Pi&#39;s WiFi network and create a new virtual environment on a <strong>client computer</strong> and run the following command inside the virtual environment:</p>
<p><code>pip --trusted-host cheeseshop.com install -i http://cheeseshop.com django </code></p>
<p>Running that command produces the following output:</p>
<pre title="">pip --trusted-host cheeseshop.com install -i http://cheeseshop.com django 
Looking in indexes: http://cheeseshop.com
Collecting django
  Downloading http://cheeseshop.com:80/packages/Django-3.0.1.tar.gz (9.0 MB)
     |████████████████████████████████| 9.0 MB 1.1 MB/s 
Collecting pytz
  Downloading http://cheeseshop.com:80/packages/pytz-2019.3-py2.py3-none-any.whl (509 kB)
     |████████████████████████████████| 509 kB 1.3 MB/s 
Collecting sqlparse&gt;=0.2.2
  Downloading http://cheeseshop.com:80/packages/sqlparse-0.3.0-py2.py3-none-any.whl (39 kB)
Collecting asgiref~=3.2
  Downloading http://cheeseshop.com:80/packages/asgiref-3.2.3-py2.py3-none-any.whl (18 kB)
Building wheels for collected packages: django
  Building wheel for django (setup.py) ... done
  Created wheel for django: filename=Django-3.0.1-py3-none-any.whl size=7428296 sha256=b31336b1249afbdbb2374912f6983179f4715127d7e6b842a8455a94a1518ce5
  Stored in directory: /home/terra/.cache/pip/wheels/6f/55/5c/aca7917f1899fbb7430677d9d6ef7c6be748c412dec3e63c04
Successfully built django
Installing collected packages: pytz, sqlparse, asgiref, django
Successfully installed asgiref-3.2.3 django-3.0.1 pytz-2019.3 sqlparse-0.3.0
</pre>
<h3>Starting pypiserver at boot(Optional)</h3>
<p>To ensure that pypiserver software starts up automatically at boot, create a new Linux service and use <code>systemd</code> to manage it.</p>
<p>1. Create a start up script that the service will manage, call it <code>start-pypi-server.sh</code>. Add the following content to it:</p>
<pre title="">                 
#! /bin/bash
/home/pi/.local/bin/pypi-server -p 8080 /home/pi/minirepo/ &amp;

</pre>
<p>2. Copy the script to <code>/usr/bin</code> and make it executable:</p>
<p>3. Create a unit file to define a systemd service. Name it pypiserver.service:</p>
<pre title=""> GNU nano 3.2         /lib/systemd/system/pypiserver.service                   

[Unit]
Description=A minimal PyPI server for use with pip/easy_install.

[Service]
Type=forking
ExecStart=/bin/bash /usr/bin/start-pypi-server.sh
User=pi

[Install]
WantedBy=multi-user.target


</pre>
<p>This defines a basic service. The <code>ExecStart</code> directive specifies the command that will be run to start the service.</p>
<p>4. Copy the unit file to /etc/systemd/system and give it permissions:</p>
<p><code>sudo chmod 644 /etc/systemd/system/pypiserver.service</code></p>
<h4>Start and Enable the Service</h4>
<p>Once you have created a unit file, you can test the service:</p>
<p><code>sudo systemctl start pypiserver</code></p>
<p>2. Check the status of the pypiserver service:</p>
<pre title="">$ sudo systemctl status pypiserver
● pypiserver.service - A minimal PyPI server for use with pip/easy_install.
   Loaded: loaded (/etc/systemd/system/pypiserver.service; enabled; vendor prese
   Active: active (running) since Fri 2020-02-07 19:17:05 CAT; 2h 19min ago
  Process: 420 ExecStart=/bin/bash /usr/bin/start-pypi-server.sh (code=exited, s
 Main PID: 441 (pypi-server)
    Tasks: 4 (limit: 4915)
   Memory: 408.0M
   CGroup: /system.slice/pypiserver.service
           └─441 /usr/bin/python /home/pi/.local/bin/pypi-server -p 8080 /home/p

Feb 07 19:17:05 raspberrypi systemd[1]: Starting A minimal PyPI server for use w
Feb 07 19:17:05 raspberrypi systemd[1]: Started A minimal PyPI server for use wi

</pre>
<p>3. To stop or restart the service:</p>
<p>4. Finally, use the <code>enable</code> command to ensure that the service starts whenever the system boots:</p>
<p><code>sudo systemctl enable pypiserver</code></p>
<h2>Conclusion</h2>
<p>You have seen how to create your own local PyPI clone on a Raspberry Pi. You learned how to</p>
<ul>
<li>Setup a Raspberry Pi as an access point</li>
<li>Setup the Raspberry Pi as a DHCP and DNS server</li>
<li>Clone PyPi</li>
<li>Use a web server to serve up the cloned packages.</li>
</ul>
<p>I did this as a proof of concept to show that it is possible to run something like PyPI offline. I am sure there are a better or more efficient ways I could have done this. Please leave a comment below with any suggestions or criticism. Thanks for reading.</p>
<p>References:</p>
<ul>
<li><a href="https://www.linode.com/docs/applications/project-management/how-to-create-a-private-python-package-repository/" rel="noopener noreferrer" target="_blank">https://www.linode.com/docs/applications/project-management/how-to-create-a-private-python-package-repository/</a></li>
<li><a href="https://www.linode.com/docs/quick-answers/linux/start-service-at-boot/" rel="noopener noreferrer" target="_blank">https://www.linode.com/docs/quick-answers/linux/start-service-at-boot/</a></li>
<li><a href="https://pypi.org/project/pypiserver/" rel="noopener noreferrer" target="_blank">https://pypi.org/project/pypiserver/</a></li>
<li><a href="https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md" rel="noopener noreferrer" target="_blank">https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-server-blocks-virtual-hosts-on-ubuntu-16-04" rel="noopener noreferrer" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-server-blocks-virtual-hosts-on-ubuntu-16-04</a></li>
<li><a href="https://serverfault.com/questions/136332/setting-up-dnsmasq-for-a-local-network" rel="noopener noreferrer" target="_blank">https://serverfault.com/questions/136332/setting-up-dnsmasq-for-a-local-network</a></li>
</ul>
		    			
		</section>
	
	
</article></div>
  </body>
</html>
