<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.copetti.org/writings/consoles/game-boy/">Original</a>
    <h1>Game Boy / Color Architecture</h1>
    
    <div id="readability-page-1" class="page"><article><h2 id="imagery">Supporting imagery</h2><section><ul><li><a href="#cover-model">Model</a></li><li><a href="#cover-motherboard">Motherboard</a></li><li><a href="#cover-diagram">Diagram</a></li></ul><div><h3>Model</h3><div id="cover-model"><ul><li><a href="#cover-model-original">Original</a></li><li><a href="#cover-model-color">Color</a></li></ul><figure id="cover-model-original"><a href="https://www.copetti.org/images/consoles/gameboy/international.073b2e0822d4b12492c46995f658e11eec17f424ce7f483b331c6f1294082246.png"><picture><img alt="Image" width="371" height="451" src="https://www.copetti.org/images/consoles/gameboy/international.073b2e0822d4b12492c46995f658e11eec17f424ce7f483b331c6f1294082246.png"/></picture></a><figcaption>The original Game Boy.</figcaption></figure><figure id="cover-model-color"><a href="https://www.copetti.org/images/consoles/gameboy/color.9605c9bf98baba4d271a73157cd2d5b18bb64b93241a3927a1024704e21d18d4.png"><picture><source type="image/webp" srcset="https://www.copetti.org/images/consoles/gameboy/_huc3a7c8ad71e690e5244678946103d6c1_77700_bed46204b26505b83591fef64303de97.webp 435w"/><img alt="Image" width="435" height="600" src="https://www.copetti.org/images/consoles/gameboy/color.9605c9bf98baba4d271a73157cd2d5b18bb64b93241a3927a1024704e21d18d4.png" loading="lazy"/></picture></a><figcaption>The next-generation successor called Game Boy Color.</figcaption></figure></div><h3>Motherboard</h3><figure id="cover-motherboard"></figure><h3>Diagram</h3><figure id="cover-diagram"><a href="https://www.copetti.org/images/consoles/gameboy/diagram.cf373ca5a4af6dfbfa0f5f829a4ab2cee15120bd66cf58843c93965d2d10f900.png"><picture><source type="image/webp" srcset="https://www.copetti.org/images/consoles/gameboy/_hu05662e9582b538ada21b1313ba043bdc_267_4919a28ebd604254ee1eac45722dd8b3.webp 500w,
https://www.copetti.org/images/consoles/gameboy/_hu05662e9582b538ada21b1313ba043bdc_267_ed8d851b3f30530bccddd0c6849107cc.webp 800w,
https://www.copetti.org/images/consoles/gameboy/_hu05662e9582b538ada21b1313ba043bdc_267_e750b01053bc05058c7565b97abe66d4.webp 1197w"/><img alt="Image" width="1197" height="989" src="https://www.copetti.org/images/consoles/gameboy/diagram.cf373ca5a4af6dfbfa0f5f829a4ab2cee15120bd66cf58843c93965d2d10f900.png" loading="lazy"/></picture></a><figcaption>Main architecture diagram</figcaption></figure></div></section><hr/><h2 id="a-quick-introduction">A quick introduction</h2><p>The Game Boy can be imagined as a portable version of the NES with limited power, but you’ll see that it included very interesting new functionality.</p><h3 id="the-rainbow-analysis">The rainbow analysis</h3><p>The immense popularity of this console resulted in a variety of revisions (i.e. Game Boy Pocket, Light, and even in the form of <a href="https://www.copetti.org/writings/consoles/super-nintendo/">Super Nintendo</a> cartridges). As a matter of fact, the Game Boy brand covers two generations. Within the 4th generation we find the monochrome Game Boy and its revisions, and in the next generation resides the Game Boy Color (shipped after the demise of the <a href="https://www.copetti.org/writings/consoles/virtual-boy/">Virtual Boy</a>). The good news is that this article covers both ends. So, in the end, you’ll get a good understanding of how the Game Boy works and how its technology subsequently evolved to become the Game Boy Color.</p><hr/><h2 id="cpu">CPU</h2><p>Instead of placing many off-the-shelf chips on the motherboard, Nintendo opted for a <strong>single-chip design</strong> to house (and hide) most of the components, including the CPU. This type of chip is called <strong>System On Chip</strong> (SoC) and, in this case, it’s been specifically crafted for this console, enabling Nintendo to tailor it to their needs (power efficiency, anti-piracy and extra I/O, among other things). At the same time, this chip can’t be found in any retail catalog, meaning competitors back then had a harder time cloning it.</p><p>That being said, the SoC found on the Game Boy is referred to as <strong>DMG-CPU</strong> or <strong>Sharp LR35902</strong> <sup id="bibref:1"><a href="#bib:cpu-realboy" role="doc-biblioref">[1]</a></sup> and, as the name indicates, it’s manufactured by <strong>Sharp Corporation</strong>. This company, along with Ricoh (the <a href="https://www.copetti.org/writings/consoles/nes/#a-bit-of-context">NES’ CPU supplier</a>), enjoyed a close relationship with Nintendo.</p><h3 id="the-cpu-core">The CPU core</h3><p>Within DMG-CPU, the main processor is a <strong>Sharp SM83</strong> <sup id="bibref:2"><a href="#bib:cpu-gekkio" role="doc-biblioref">[2]</a></sup> and it’s a mix between the Z80 (the same CPU used on the <a href="https://www.copetti.org/writings/consoles/master-system/#cpu">Sega Master System</a>) and the Intel 8080. It runs at <strong>~4.19 MHz</strong>, which is faster than the average 1-MHz CPU, but remember clock speeds <a href="https://www.copetti.org/writings/consoles/master-system/#relative-comparison">can be deceiving</a>.</p><figure><a href="https://www.copetti.org/images/consoles/gameboy/dmg_cpu.018e810ee7d690ab8ff9978bd7853a2b348121ca85d64214c259c5875026524e.png"><picture><img alt="Image" width="300" height="238" src="https://www.copetti.org/images/consoles/gameboy/dmg_cpu.018e810ee7d690ab8ff9978bd7853a2b348121ca85d64214c259c5875026524e.png" loading="lazy"/></picture></a><figcaption>The DMG-CPU, found on the Game Boy’s motherboard.</figcaption></figure><p>Now, back when I did the <a href="https://www.copetti.org/writings/consoles/master-system/">analysis of the Master system</a>, I explained the Z80 is itself a superset of the 8080. So, what does the SM83 actually have and lack from those two? <sup id="bibref:3"><a href="#bib:cpu-steil" role="doc-biblioref">[3]</a></sup></p><ul><li>Neither the Z80’s <code>IX</code> or <code>IY</code> registers nor the 8080’s <code>IN</code> or <code>OUT</code> instructions are included. This means that <a href="https://www.copetti.org/writings/consoles/master-system/#accessing-the-rest-of-the-components">I/O ports</a> are not available. I’m not certain if that’s just a measure to reduce costs, but one thing for sure is that components will have to be <strong>completely memory-mapped</strong> <sup id="bibref:4"><a href="#bib:cpu-fayzullin" role="doc-biblioref">[4]</a></sup>.</li><li>Only Intel 8080’s set of registers are implemented. Consequently, there are <strong>only eight general-purpose registers</strong>, unlike the Z80 with its 16 registers (due to the addition of an ‘alternative’ set).</li><li>Includes some of the Z80’s extended instruction set (only bit manipulation instructions).</li></ul><p>Furthermore, Sharp also added a <strong>few new instructions</strong> that are not present in either Z80 or 8080. They optimise certain operations related to the way Nintendo/Sharp arranged the hardware. One example is the new <code>LDH</code> instruction (meaning ‘load from high RAM’ <sup id="bibref:5"><a href="#bib:cpu-ldh" role="doc-biblioref">[5]</a></sup>), which has been specifically included to operate the second half of the memory map (where addresses start at <code>$ff</code>) and, most importantly, fits in a single byte (instead of requiring two or more).</p><h4 id="the-color-effect">The Color effect</h4><p>Almost 10 years later, after the abandonment of the <a href="https://www.copetti.org/writings/consoles/virtual-boy/">Virtual Boy</a> and its <a href="https://www.copetti.org/writings/consoles/virtual-boy/#cpu">cutting-edge hardware</a>, a humble successor arrived: the <strong>Game Boy Color</strong>. Inside it, there’s a new SoC named <strong>CPU CGB</strong> that carries a few additions. However, its SM83 CPU core remains the same, except for its doubled clock speed (now running at <strong>~8.38 MHz</strong>).</p><p>It’s hard to think that after a decade Nintendo would still bundle the same CPU, but such decision does come with the following advantages:</p><ul><li>Developers can re-use their current skills to program the new console.</li><li>There’s a cost saving by not having to re-design their system to work for a new architecture.</li><li>Backwards compatibility becomes possible without considerable effort. In fact, Nintendo implemented it by programming two modes of operation on CPU CGB:<ul><li><strong>Normal mode</strong>: The SM83 operates at <strong>~4.19 MHz</strong>.</li><li><strong>Dual-speed mode</strong>: The SM83 operates at <strong>~8.38 MHz</strong>.</li></ul></li></ul><p>Albeit, this comes at the cost of adopting outdated technology by late-90s standards. You only have to look at the <a href="https://www.copetti.org/writings/consoles/playstation/##tab-1-1-a-bit-of-history">state of the CPU market</a> to notice the capabilities Nintendo was missing out (to be fair, Nintendo did try with the <a href="https://www.copetti.org/writings/consoles/virtual-boy/">Virtual Boy</a>).</p><h3 id="hardware-access">Hardware access</h3><p>The SM83 maintains an <strong>8-bit data bus</strong> and a <strong>16-bit address bus</strong>, so up to <strong>64 KB of memory</strong> can be addressed. The memory map is mainly composed of the following endpoints <sup id="bibref:7"><a href="#bib:cpu-mongenel" role="doc-biblioref">[7]</a></sup>:</p><ul><li>Game Pak (the game cartridge) space.</li><li>Work RAM (WRAM), High RAM (HRAM) and Display RAM (VRAM).</li><li>I/O (joypad, audio, graphics and LCD).</li><li>Interrupt controls.</li></ul><p>These will be explained throughout this article.</p><h3 id="memory-available">Memory available</h3><figure><a href="https://www.copetti.org/images/consoles/gameboy/dmg-ram.508559a884da32d397e33e09f7554778fcd28c322bca035924a19d9021debd43.png"><picture><img alt="Image" width="525" height="360" src="https://www.copetti.org/images/consoles/gameboy/dmg-ram.508559a884da32d397e33e09f7554778fcd28c322bca035924a19d9021debd43.png" loading="lazy"/></picture></a><figcaption>Memory architecture of the DMG (original Game Boy). The PPU arbitrates access to VRAM.</figcaption></figure><p>Nintendo fitted <strong>8 KB of RAM</strong> on the motherboard, this is for general purpose use (which they call <strong>Work RAM</strong> or ‘WRAM’) <sup id="bibref:8"><a href="#bib:cpu-nintendo" role="doc-biblioref">[8]</a></sup>. Notice that this is four times larger than what the <a href="https://www.copetti.org/writings/consoles/nes/">NES</a> included.</p><p>There’s an additional <strong>127 B</strong> of RAM housed in the SoC. It goes by many names (‘H’, ‘High’, ‘Working’ and ‘Stack’ RAM) but the purpose is the same: provide a small space for data that must be accessed instantly, such as the stack. It’s not technically faster to access than general RAM, but it’s an area prioritised for the CPU. You’ll see what this means when you reach the ‘Graphics’ section, where I discuss the DMA component.</p><figure><a href="https://www.copetti.org/images/consoles/gameboy/cgb-ram.d8debd194bbc6a0b64ea7ec1b2bc3a7c38a28551e75b4d2c0ede5f3690a152b9.png"><picture><img alt="Image" width="527" height="344" src="https://www.copetti.org/images/consoles/gameboy/cgb-ram.d8debd194bbc6a0b64ea7ec1b2bc3a7c38a28551e75b4d2c0ede5f3690a152b9.png" loading="lazy"/></picture></a><figcaption>Expanded memory architecture of the CGB (Game Boy Color). Again, the PPU arbitrates access to VRAM.</figcaption></figure><p>Later on, with the Color variant, Nintendo enlarged WRAM to <strong>32 KB</strong>. However, since the CPU remained unchanged (particularly its addressing capabilities), it’s not possible to connect all the new memory without first overflowing the available address space. To tackle this, Nintendo’s engineers implemented <a href="https://www.copetti.org/writings/consoles/nes/#going-beyond-existing-capabilities">bank switching</a>. Originally found in <a href="https://www.copetti.org/writings/consoles/nes/#cartridgegame-data">NES cartridges</a>, the Game Boy Color uses the same principle to access those 32 KB only using 8 KB of memory space. The trick is simple: the last 4 KB can be swapped using eight different banks. Consequently, the CPU bundles an extra register (called <code>SVBK</code>) acting as the bank switcher, this is what developers must use to examine the extended memory.</p><hr/><h2 id="graphics">Graphics</h2><p>All graphics calculations are done by the CPU, and then the <strong>Picture Processing Unit</strong> or ‘PPU’ renders them. This is another component found inside DMG-CPU and it’s based on the <a href="https://www.copetti.org/writings/consoles/nes/#graphics">predecessor’s graphics chip</a> (of the same name).</p><p>The picture is displayed on an integrated LCD screen, it has a resolution of <strong>160×144 pixels</strong> and, in the case of the monochrome Game Boy, shows <strong>4 shades of grey</strong> (white, light grey, dark grey and black). Since the original Game Boy has a green LCD, the picture will look <em>greenish</em>.</p><p>If you’ve read the NES article before, you may remember that the PPU was designed to follow the CRT beam. However (and for obvious reasons), we got an LCD screen in the Game Boy. Well, the new PPU also follows that methodology as LCDs require to be refreshed too. In doing so, this console will enjoy <a href="https://www.copetti.org/writings/consoles/nes/##tab-5-4-background-split">CRT-based effects</a> that previously enabled NES developers to come up with imaginative content.</p><h3 id="organising-the-content">Organising the content</h3><figure><a href="https://www.copetti.org/images/consoles/gameboy/ppu.0adaeb84d076416fb4cbeb3f70d69c81ec850b2ed5ca17b6873d80e6eda47542.png"><picture><img alt="Image" width="644" height="332" src="https://www.copetti.org/images/consoles/gameboy/ppu.0adaeb84d076416fb4cbeb3f70d69c81ec850b2ed5ca17b6873d80e6eda47542.png" loading="lazy"/></picture></a><figcaption>Memory architecture of the PPU.</figcaption></figure><p>The PPU is connected to <strong>8 KB of VRAM</strong> or ‘Display RAM’. In doing so, it also provides arbitrated access to the CPU. Those 8 KB will contain most of the data the PPU will need to render graphics. The remaining materials will instead be stored inside the PPU, as they require faster access rates.</p><p>The game is in charge of populating the different areas with the correct type of data. Moreover, the PPU exposes registers so the game can instruct the PPU on how that data is organised. Nevertheless, there are many rules to follow (you’ll see it in the following sections).</p><h3 id="constructing-the-frame">Constructing the frame</h3><p>Let’s see how the PPU manages to draw stuff on the screen. For demonstration purposes, <em>Super Mario Land 2</em> will be used as an example.</p><div><ul><li id="tab-3-1-tiles-link"><a href="#tab-3-1-tiles">Tiles</a></li><li id="tab-3-2-background-layer-link"><a href="#tab-3-2-background-layer">Background Layer</a></li><li id="tab-3-3-window-link"><a href="#tab-3-3-window">Window</a></li><li id="tab-3-4-sprites-link"><a href="#tab-3-4-sprites">Sprites</a></li><li id="tab-3-5-result-link"><a href="#tab-3-5-result">Result</a></li></ul><div><div id="tab-3-1-tiles"><h4 id="tab-3-1-tiles">Tiles</h4><figure><ul><li id="tab-2-1-all-link"><a href="#tab-2-1-all">All</a></li><li id="tab-2-2-grid-link"><a href="#tab-2-2-grid">Grid</a></li><li id="tab-2-3-single-link"><a href="#tab-2-3-single">Single</a></li></ul><figure id="tab-2-1-all"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/tiles.19fc6654215059522e83d3f2cbc6dfd8eacf611c9e8cc0e46adf435d34aa083a.png"><picture><img alt="Image" width="128" height="192" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/tiles.19fc6654215059522e83d3f2cbc6dfd8eacf611c9e8cc0e46adf435d34aa083a.png" loading="lazy"/></picture></a><figcaption>Multiple tiles.</figcaption></figure><figure id="tab-2-2-grid"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/tiles_grid.eee37193c7783dc522d777cf4fad864c8a17880e76de6f6b1096f7b6a5b08cd7.png"><picture><img alt="Image" width="144" height="215" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/tiles_grid.eee37193c7783dc522d777cf4fad864c8a17880e76de6f6b1096f7b6a5b08cd7.png" loading="lazy"/></picture></a><figcaption>Multiple tiles separated with a grid.</figcaption></figure><figure id="tab-2-3-single"><picture><img alt="Image" width="8" height="8" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/tiles_single.fee59803538369b2e39204066f654d8334577039dac965ce129243b7d862dace.png" loading="eager"/></picture><figcaption>A single tile.</figcaption></figure><figcaption>Tiles found in the Pattern Table.</figcaption></figure><p>The PPU uses <strong>tiles</strong> as a basic ingredient for rendering graphics, specifically, <strong>sprites and backgrounds</strong> <sup id="bibref:9"><a href="#bib:graphics-emu" role="doc-biblioref">[9]</a></sup>.</p><p>Tiles are just <strong>8x8 bitmaps</strong> stored in VRAM in a region called <strong>Tile set</strong> or ‘Tile pattern table’, each pixel corresponds to one of the four shades of grey available. In practice, however, the shades of grey are selected through a ‘colour’ palette. The monochrome Game Boys contain registers that define these palettes. As explained before, there’re only four colours/shades of greys to choose from, so a single 8-bit register can fit a palette of four shades without issue. That being said, the system provides three registers (thus, <strong>three programmable palettes</strong>) with <strong>restricted use</strong> (more about this explained later).</p><p>Furthermore, tiles are grouped into <strong>two pattern tables</strong>.</p><p>To build the picture, tiles are referenced in another type of table called a <strong>Tile map</strong>. This information will tell the PPU where to render the tiles. Two maps are stored to construct different layers of the frame.</p><p>The next sections explain how tile maps are used to construct the layers.</p></div><div id="tab-3-2-background-layer"><h4 id="tab-3-2-background-layer">Background Layer</h4><figure><ul><li id="tab-4-1-full-link"><a href="#tab-4-1-full">Full</a></li><li id="tab-4-2-selected-link"><a href="#tab-4-2-selected">Selected</a></li><li id="tab-4-3-rendered-link"><a href="#tab-4-3-rendered">Rendered</a></li></ul><figure id="tab-4-1-full"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/background.fd3915f484f3d46b0710d267cea7081d62fec8b0514ce2b7e3e1944a66dc0867.png"><picture><img alt="Image" width="255" height="255" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/background.fd3915f484f3d46b0710d267cea7081d62fec8b0514ce2b7e3e1944a66dc0867.png" loading="lazy"/></picture></a><figcaption>Allocated Background map in VRAM.</figcaption></figure><figure id="tab-4-2-selected"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/background_selected.de6c8c2b87b96a28b3d7f090ccd30456ff28e5d8da1dece1fd974bf41e0c5793.png"><picture><img alt="Image" width="255" height="255" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/background_selected.de6c8c2b87b96a28b3d7f090ccd30456ff28e5d8da1dece1fd974bf41e0c5793.png" loading="lazy"/></picture></a><figcaption>Selected area of the Background map. Notice the selected part includes one portion of the top, this will be overlapped by the <em>Window</em> layer.</figcaption></figure><figure id="tab-4-3-rendered"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/background_rendered.26f8895e32fb46e8f3dc983b636a4d14eedcbe955f07335129fe6d1ff0447380.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/background_rendered.26f8895e32fb46e8f3dc983b636a4d14eedcbe955f07335129fe6d1ff0447380.png" loading="lazy"/></picture></a><figcaption>Displayed Background map.</figcaption></figure><figcaption>Background map rendering process.</figcaption></figure><p>The Background layer is a <strong>256x256 pixel</strong> (32x32 tiles) map containing <strong>static tiles</strong>. However, remember that only 160x144 is viewable on the screen, so the game decides which part is selected for display. Games can also move the viewable area during gameplay, that’s how the <strong>Scrolling Effect</strong> is accomplished.</p><p>One of the two tile maps can be used to build the background layer. Also, there’s only <strong>one palette</strong> available for this layer.</p></div><div id="tab-3-3-window"><h4 id="tab-3-3-window">Window</h4><figure><ul><li id="tab-5-1-full-link"><a href="#tab-5-1-full">Full</a></li><li id="tab-5-2-selected-link"><a href="#tab-5-2-selected">Selected</a></li></ul><figure id="tab-5-1-full"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/window.9ac66109e0ed3edcd3b98a3500726e0fd01b95034994fbce69e983a08ca0772c.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/window.9ac66109e0ed3edcd3b98a3500726e0fd01b95034994fbce69e983a08ca0772c.png" loading="lazy"/></picture></a><figcaption>Allocated Window map.</figcaption></figure><figure id="tab-5-2-selected"><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/window_rendered.ba9056990bcdd50c780a489c6e7ba847524c86a7d028212ec91dc85a49ce1df3.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/window_rendered.ba9056990bcdd50c780a489c6e7ba847524c86a7d028212ec91dc85a49ce1df3.png" loading="lazy"/></picture></a><figcaption>Displayed Window map. The game activates it during the last scan-lines. Hence, only the first rows are rendered at the bottom of the screen.</figcaption></figure><figcaption>Window map rendering process.</figcaption></figure><p>The Window is a <strong>160x144 pixel</strong> layer containing tiles displayed on top of the background and sprites. This layer <strong>doesn’t scroll</strong>.</p><p>The remaining tile map can be assigned to the Window layer, it also shares the same palette with the Background layer.</p><p>All in all, this may sound like a silly feature. In theory, the Window layer overlaps every other layer, so what is it useful for? Well, both Background and Window can be used <strong>concurrently</strong> at different parts of the screen. This is accomplished by changing the <code>LCDCONT</code> register during specific scan lines.</p><p>Thus, games normally use it to display player stats, scores and other ‘always-on’ information.</p></div><div id="tab-3-4-sprites"><h4 id="tab-3-4-sprites">Sprites</h4><figure><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/sprite.bca34c94b876ff47fbc94dbef084cd087e404831d4eb37d065f6a4b6a78cf8d8.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/sprite.bca34c94b876ff47fbc94dbef084cd087e404831d4eb37d065f6a4b6a78cf8d8.png" loading="lazy"/></picture></a><figcaption>Rendered Sprite layer.</figcaption></figure><p>Sprites are tiles that can move independently around the screen. They can also overlap each other and appear behind the background, the viewable graphic will be decided based on a priority attribute.</p><p>This layer also has an extra colour available/required: <strong>Transparent</strong>. Initially, this means they can only display three different greys instead of four. Luckily, this layer in particular is provided with <strong>two dedicated palettes</strong> to choose from.</p><p>The <strong>Object Attribute Memory</strong> or ‘OAM’ is a map stored inside the PPU that specifies the tiles that will be used as sprites. Instead of using a tile map, <strong>sprites are defined in OAM</strong>. Games fill this region by calling the <strong>DMA unit</strong> found inside the chip, the DMA fetches data from main RAM or game ROM and send it to OAM. Now, whilst DMA is at work, the CPU can’t access external RAM (hence the importance of using HRAM during that period).</p><p>Apart from the tile index, each entry contains the following attributes: X-Y position, chosen palette, priority and flip flags (allowing to rotate the tile vertically and horizontally).</p><p>The PPU is limited to rendering up to <strong>ten sprites per scan-line</strong> and <strong>up to 40 per frame</strong>, overflowing this will result in sprites not being drawn.</p></div><div id="tab-3-5-result"><h4 id="tab-3-5-result">Result</h4><figure><a href="https://www.copetti.org/images/consoles/gameboy/ppu_mario/result.300b8ad1b603cf0e0af6d8fd194141f7d6fc9ca74d1eb57909cf6f92daeaaec6.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_mario/result.300b8ad1b603cf0e0af6d8fd194141f7d6fc9ca74d1eb57909cf6f92daeaaec6.png" loading="lazy"/></picture></a><figcaption>Final result. <em>Tada!</em></figcaption></figure><p>Once the frame is finished, it’s time to move on to the next one! However, the CPU can’t modify the tables while the PPU is reading from VRAM, so the system provides a set of interrupts triggered when the PPU is idle. You can recall this behaviour from the times of the NES.</p><p>When a single scan line is complete, the <strong>Horizontal Blank</strong> interrupt is called. This allows to fiddle with the part of the frame that has not yet been drawn.</p><p>When all scan lines are complete, the <strong>Vertical Blank</strong> interrupt is called. The game can now update the graphics for the next frame.</p><p>There’s an extra state called <strong>OAM search</strong> that is triggered at the start of the scan-line, at this point the PPU is processing which sprites will be displayed in that scan-line, so the game can update any region except OAM.</p></div></div></div><h3 id="secrets-and-limitations">Secrets and Limitations</h3><p>The inclusion of the Window layer and extra interrupts allowed for new types of content and effects.</p><div><ul><li id="tab-6-1-wobble-effect-link"><a href="#tab-6-1-wobble-effect">Wobble effect</a></li></ul><div><div id="tab-6-1-wobble-effect"><h4 id="tab-6-1-wobble-effect">Wobble effect</h4><figure><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/zelda.a3d6874d3e350b643cf06b924599eee374797b75615d711ede81e55d4456f855.jpg" preload="none" width="898" height="720" src="https://www.copetti.org/videos/consoles/gameboy/zelda.dc3d178cfc686f6c824fe116ffeb29d4934e537178a0af52ee3ea12605dbaf3c.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>The Legend of Zelda: Link’s Awakening (1993). <em>Spoilers!</em></figcaption></figure><p>Horizontal interrupts allowed to alter the frame before being finished. This means that a different scrolling value could be applied at each line, resulting in each row of the frame being shifted at different paces.</p><p>This achieved an interesting <em>Wobbling effect</em> (I’m not sure that’s the official name of it).</p></div></div></div><h3 id="the-color-additions">The Color additions</h3><p>The Game Boy Color’s PPU behaves as a superset of the original. You will see now what are the additions of the so-called ‘Color’ model of this brand.</p><h4 id="modes-of-operation">Modes of operation</h4><div><figure><a href="https://www.copetti.org/images/consoles/gameboy/ppu_color/zelda.8e1e42d3c2b11a648ed1e7a49f41afd0afea5003f425b90cf96f7ecff92feffa.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_color/zelda.8e1e42d3c2b11a648ed1e7a49f41afd0afea5003f425b90cf96f7ecff92feffa.png" loading="lazy"/></picture></a><figcaption>The Legend of Zelda: Link’s Awakening DX (1998).</figcaption></figure><figure><a href="https://www.copetti.org/images/consoles/gameboy/ppu_color/dmg_mario.641ceb6be21d5f03f42c524d35fee4234aae338a3c447d13697a8abfa1ed545f.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/ppu_color/dmg_mario.641ceb6be21d5f03f42c524d35fee4234aae338a3c447d13697a8abfa1ed545f.png" loading="lazy"/></picture></a><figcaption>Super Mario Land 2, as seen from a Game Boy Color. The latter adds a colourised palette and runs in DMG mode.</figcaption></figure></div><p>To begin with, for compatibility reasons, the new PPU has <strong>two modes of operation</strong>. Yet, Nintendo wanted Color users to see enhancements even with the monochrome-only games. Consequently, the two modes of operation are as follows:</p><ul><li><strong>CGB mode</strong>: Extended PPU mode with all the visual improvements that comprise the new Game Boy Color games.</li><li><strong>DMG mode</strong>: Traditional mode with all the extras disabled. However, you’ll see in the ‘Operating System’ section that monochrome games are nonetheless enhanced with colour palettes.</li></ul><h4 id="organising-the-new-content">Organising the (new) content</h4><p>The CGB motherboard now houses <strong>16 KB of VRAM</strong> instead, which is double the original VRAM amount. Due to the CPU’s addressing limitations, this new arrangement is implemented in the form of <strong>two 8 KB banks</strong>, with a new register (called <code>VBK</code>) acting as a switcher. On the other side, the PPU can access the two banks at the same time. At the end of the day, this means programmers only need to fill the VRAM banks with the help of <code>VBK</code>, and then specify in the tile map the bank where the tile is found, so the PPU can take care of the rest.</p><p>That being said, what can you do with the extra VRAM? Many things:</p><ul><li>Store more tiles.</li><li>Store more palettes, especially <em>coloured</em> ones.</li><li>Extend the tile metadata space to encode more effects and address extra palettes.</li></ul><h5 id="the-visuals">The visuals</h5><p>Thanks to the new PPU, programmers can now define colour palettes with <strong>32,768 colors</strong> to choose from.</p><p>Firstly, developers must now populate a new area called <strong>Palette Memory</strong>, which stores up to <strong>eight colour palettes</strong> that encode <strong>four colours</strong> <sup id="bibref:10"><a href="#bib:cpu-nintendo" role="doc-biblioref">[10]</a></sup>. Each entry fits in a 16-bit value (2 bytes) and only 15 bits are used. Palette Memory is not addressed by the CPU, however, a new register is used as a buffer to write over this memory. This is what the CPU follows to define the palettes.</p><p>Having said that, Background and Window tiles can reference any of those eight palettes. The same happens with Sprite tiles, except they are constrained to three-colour palettes, as one entry is reserved for the ‘transparent’ colour.</p><p>Moving on, <strong>Tile sets are now twice as big</strong>. Thus, programmers can store double the amount of tiles in VRAM. <strong>Background/Window Tile maps have been extended</strong> as well, resulting in extra meta-data being encoded. Consequently, expanding the capabilities of these layers. For instance, their tiles can now be <strong>horizontally and vertically flipped</strong>, saving the game from storing duplicated graphics in VRAM (which, in turn, can be exploited to draw more unique content).</p><p>Furthermore, CPU CGB also bundles <strong>two extra DMA units</strong>, both can copy the contents of the Game Pak or WRAM to VRAM, but their timings differ <sup id="bibref:11"><a href="#bib:cpu-nintendo" role="doc-biblioref">[11]</a></sup>:</p><ul><li><strong>General-purpose DMA</strong>: The transfer will happen at any time and the DMA will get priority over any other memory access. So, programmers need to be careful about when to use this component (i.e. during or outside scanning) and how (the amount of data to copy), as misuse can lead to screen tearing (VRAM access will be blocked during the transfer).</li><li><strong>Horizontal Blank (H-Blank) DMA</strong>: The transfer will only happen during H-Blank periods. This avoids screen artifacts, but can only transfer content in batches of 16 Bytes, and pauses during LCD scanning.</li></ul><p>Once more, these units offer programmers new possibilities to provide richer content, as they take advantage of periods originally left for idling.</p><hr/><h2 id="audio">Audio</h2><p>The audio system is carried out by the <strong>Audio Processing Unit</strong> (APU), a <a href="https://www.copetti.org/writings/consoles/master-system/#audio">PSG chip</a> with four channels <sup id="bibref:12"><a href="#bib:audio-wiki" role="doc-biblioref">[12]</a></sup>.</p><p>Curiously enough, this is one of the few sections that hasn’t evolved on either model. In fact, it can’t even be sped up, since if you change the speed of the oscillators, you won’t hear ‘better’ sounds, but a higher pitch.</p><h3 id="functionality">Functionality</h3><p>Each channel of the four channels is reserved for a single type of waveform:</p><div><ul><li id="tab-8-1-pulse-link"><a href="#tab-8-1-pulse">Pulse</a></li><li id="tab-8-2-noise-link"><a href="#tab-8-2-noise">Noise</a></li><li id="tab-8-3-wave-link"><a href="#tab-8-3-wave">Wave</a></li></ul><div><div id="tab-8-1-pulse"><h4 id="tab-8-1-pulse">Pulse</h4><figure><ul><li id="tab-7-1-pulse-1-link"><a href="#tab-7-1-pulse-1">Pulse 1</a></li><li id="tab-7-2-pulse-2-link"><a href="#tab-7-2-pulse-2">Pulse 2</a></li><li id="tab-7-3-complete-link"><a href="#tab-7-3-complete">Complete</a></li></ul><figure id="tab-7-1-pulse-1"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/pulse_single_1.bcedec1ca73a56b4ad1ce64b15f5914a1231d66247d161054a9fc1cdcf45317f.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/pulse_single_1.7f5b0856f9c366c37c4349d6cbf08a11136e172103bc9d543a5a26a00d86e678.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of the pulse 1 channel.</figcaption></figure><figure id="tab-7-2-pulse-2"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/pulse_single_2.e06b48f4b4c268de5dd90b9631c18ca11ce00faa6667a08b53e2a5d2e6971094.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/pulse_single_2.db4b3e5950c1b80e1aa26305fe11c6a09905a392b70e84bf2bbeed52ed505032.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of the pulse 2 channel.</figcaption></figure><figure id="tab-7-3-complete"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/pulse_full.9cb8f7982eb46df6baa88d9426c4c0dc4a228bba19364d92f203d1d30576d897.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/pulse_full.ae3e453cd3250f4d1fb8d99e1b4102400c5e74e6a3101c3b3664f32dbc44fef5.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of all audio channels.</figcaption></figure><figcaption>Pokemon Red/Blue (1996).</figcaption></figure><p>Pulse waves have a very distinct <em>beep</em> sound that is mainly used for <strong>melody or sound effects</strong>.</p><p>The APU reserves two channels for one pulse wave each. These use one of four different tones constructed by varying their pulse width. The first channel has an exclusive <strong>Sweep control</strong> available.</p><p>Due to the limited number of channels, the melody will often be interrupted when effects have to be played as part of the gameplay. This is very noticeable in games like Pokemon Red/Blue when, during a battle, the Pokemon’s cry will overlap all the channels used for music.</p></div><div id="tab-8-2-noise"><h4 id="tab-8-2-noise">Noise</h4><figure><ul><li id="tab-9-1-noise-link"><a href="#tab-9-1-noise">Noise</a></li><li id="tab-9-2-complete-link"><a href="#tab-9-2-complete">Complete</a></li></ul><figure id="tab-9-1-noise"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/noise_single.5ce33691afe1a39abb27d1d84a44579cd6598f75072c27f658bec35f99a56b92.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/noise_single.3c9f0418c7bfbf0de4c7e4852a58baeded6085ebc70ee3cfd9212f26e941c6c4.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of the noise channel.</figcaption></figure><figure id="tab-9-2-complete"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/noise_full.e783c6bc51c53724915910c96dd767962c76ec42bd71e88539fb25c54b1246e2.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/noise_full.b8b01eca475e3ba7aefc9653ca83274718b74c5aad32da8e02b2695f1fbcf1c9.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of all audio channels.</figcaption></figure><figcaption>Pokemon Red/Blue (1996).</figcaption></figure><p>Noise is basically a set of random waveforms that sound like white static. One channel is allocated for it.</p><p>Games use it for percussion or <em>ambient</em> effects.</p><p>This channel has only 2 tones available to use, one produces <em>clean static</em> and the other produces <em>robotic static</em>. Its frequency can also be controlled.</p></div><div id="tab-8-3-wave"><h4 id="tab-8-3-wave">Wave</h4><figure><ul><li id="tab-10-1-wave-link"><a href="#tab-10-1-wave">Wave</a></li><li id="tab-10-2-complete-link"><a href="#tab-10-2-complete">Complete</a></li></ul><figure id="tab-10-1-wave"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/wave_single.42b29f59d886403c166846a6b5b9be012b1b7209fb79001cc35658d4b283991a.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/wave_single.fe6e304aecc1bb92f3806c4414f3f2f3df6d2e992f5a1689b45abdfe728b3ce9.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of the wave channel.</figcaption></figure><figure id="tab-10-2-complete"><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/wave_full.50b182b5d5b4bc71f361224da1bcbd2bf385f543add0e8f404104fb8858b73f9.jpg" preload="none" width="1024" height="768" src="https://www.copetti.org/videos/consoles/gameboy/wave_full.b5ab6479962334197064e31836e76372f52bcef33f65adade3437282ade04dd8.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>Oscilloscope view of all channels.</figcaption></figure><figcaption>Pokemon Red/Blue (1996).</figcaption></figure><p>The APU allows defining a <strong>custom waveform</strong> to be heard from its fourth channel. The wave is composed of 32 4-bit samples which are stored in a wavetable.</p><p>This channel also allows controlling its frequency (enabling it to produce different musical notes from the same entry) and volume.</p></div></div></div><h3 id="secrets-and-limitations-1">Secrets and Limitations</h3><p>The mixer outputs stereo sound, so the channels can be assigned to the left side or on the right one, this is only possible to hear from the headphones though! The speaker is mono.</p><p>Furthermore, the mixer chip is also connected to a dedicated pin on the cartridge, allowing it to stream an <strong>extra channel</strong> with the condition that the cartridge outputs the analogue sound (only possible with extra hardware). Nevertheless, no game in the market ended up using this feature.</p><hr/><h2 id="operating-system">Operating System</h2><p>Unlike the NES, which booted straight into the game, the Game Boy was designed to always boot from an internal <strong>256 Byte ROM</strong>, and only then jump into the game code. The boot process is as follows <sup id="bibref:13"><a href="#bib:operating_system-boot" role="doc-biblioref">[13]</a></sup>:</p><ol><li>After the console is switched on, the CPU starts reading at address <strong>0x00</strong> (Game Boy’s ROM location).</li><li>RAM and APU are initialised.</li><li>The Nintendo logo is copied from the cartridge ROM to Display RAM, and then it’s drawn at the top edge of the screen. If there is no cartridge inserted, the logo will contain garbage tiles. The same may happen if it’s improperly inserted.</li><li>The logo is scrolled down and the famous <em>po-ling</em> sound is played.</li><li>The game’s Nintendo logo is matched against the one stored in the console’s ROM. Afterwards, a quick <strong>checksum</strong> is done on the cartridge’s ROM header to make sure the cartridge is correctly inserted. If any of these checks fail, the console freezes.</li><li>The console’s ROM is removed from the memory map.</li><li>CPU starts executing the game.</li></ol><p>Interestingly enough, the <em>Nintendo</em> logo displayed on the screen is not cleared from VRAM, so games can apply some animation and effects to introduce their own logo.</p><figure><video poster="https://www.copetti.org/images/consoles/gameboy/video_posters/20y.3152b28acb13cc7e16058475f84e6cc3c8b7c8850431e59bdbad9ad32dcdc660.jpg" preload="none" width="712" height="640" src="https://www.copetti.org/videos/consoles/gameboy/20y.212a70626b37b48e7c6f76c193c2ecccdbe4d9519a42bb09c2d63ed13b4e77fe.mp4" controls="" controllist="nodownload">
No support for video.</video><figcaption>The Game Boy’s boot screen along with 20y, a homebrew demo that fiddles with the logo.</figcaption></figure><h3 id="the-revised-sequence">The revised sequence</h3><figure><a href="https://www.copetti.org/images/consoles/gameboy/boot_cgb.f85916184ec754239e316e23e42c69a95ea813fcefaadcb75bf45414034cc2c8.png"><picture><img alt="Image" width="160" height="144" src="https://www.copetti.org/images/consoles/gameboy/boot_cgb.f85916184ec754239e316e23e42c69a95ea813fcefaadcb75bf45414034cc2c8.png" loading="lazy"/></picture></a><figcaption>The Game Boy Color’s boot screen, the logo doesn’t slide anymore but it features a rainbow effect.</figcaption></figure><p>Once again, in the case of the Game Boy Color, we find drastic changes in the contents of the ROM. For instance, the size of the ROM is now <strong>2 KB</strong> <sup id="bibref:14"><a href="#bib:operating_system-boot_cgb" role="doc-biblioref">[14]</a></sup> and the routines exhibit new behaviour:</p><ul><li>The boot sequence will now check if it’s got a Game Boy-only or Game Boy Color game inserted, and then set the corresponding registers to activate DMG or CGB mode. The boot code checks for specific game metadata (within the cartridge’s ROM) that is structured differently for CGB games.</li><li>In the case a DMG game is inserted, the boot program will also fill Palette RAM with calculated palettes, these are based on a simple but clever algorithm that also relies on the game’s metadata. This is what makes monochrome games look coloured when running on the next-gen console.<ul><li>At this stage, the user may press a button combination that will alter the boot code’s palette of choice.</li></ul></li><li>The Nintendo logo check now makes use of HRAM as well.</li></ul><hr/><h2 id="games">Games</h2><p>Games are written in assembly and they have a maximum size of <strong>32 KB</strong>, this is due to the limited address space available. However, with the use of a <strong>Memory Bank Controller</strong> (<a href="https://www.copetti.org/writings/consoles/nes/#going-beyond-existing-capabilities">mapper</a>), games can reach bigger sizes. The biggest Game Pak (cartridge) found in the market has a 1 MB ROM (or 8 MB, in the case of the Game Boy Color).</p><p>Game Paks can include a real-time clock and an external battery along with SRAM to hold saves, although all of these are optional.</p><h3 id="types-of-cartridges">Types of cartridges</h3><p>Due to the two modes of operation the Game Boy Color supported, Nintendo listed <strong>three different types</strong> of Game Boy games:</p><ul><li><strong>Game Boy</strong>: A type fully compatible with all Game Boy models. It always runs in DMG mode.</li><li><strong>Game Boy Color enhanced</strong>: A hybrid that runs differently depending on the host console. While fully compatible with the monochrome model, it will be visually enhanced (due to running in CGB mode) when running on the Game Boy Color. However, the overall functionality will still be constrained to maintain compatibility with the Game Boy.</li><li><strong>Game Boy Color exclusive</strong>: Only compatible with the Game Boy Color, but it takes full advantage of its hardware.</li></ul><h3 id="external-communications">External communications</h3><figure><a href="https://www.copetti.org/images/consoles/gameboy/link_cable.d2ae4a87f294e933a348fb9b3d9c31da93389b13ab24ae2910972dd5b0d5d6c1.png"><picture><img alt="Image" width="600" height="353" src="https://www.copetti.org/images/consoles/gameboy/link_cable.d2ae4a87f294e933a348fb9b3d9c31da93389b13ab24ae2910972dd5b0d5d6c1.png" loading="lazy"/></picture></a><figcaption>Game Boy Link cable for multiple variants of the console <sup id="bibref:15"><a href="#bib:photography-amos" role="doc-biblioref">[15]</a></sup>. Since the release of the original console, subsequent revisions miniaturised the socket while keeping the same number of pins.</figcaption></figure><p>For the first time, games can communicate with other Game Boys using a <strong>Game Boy Link</strong> cable, which provides multiplayer functionality, for instance. The interface relies on a very primitive type of <strong>serial connection</strong>.</p><p>The original Game Boy transfers information at 8 Kbit/second (1 KB/sec), while the Color variant may reach up to 512 Kbit/second (64 KB/sec), the latter speed was known as ‘high speed’ mode.</p><p>The latter variant is also bundled with an <strong>Infrared emitter and receiver</strong> (made of an LED and a phototransistor, respectively) <sup id="bibref:16"><a href="#bib:cpu-nintendo" role="doc-biblioref">[16]</a></sup>. This made it possible to exchange data wirelessly between Game Boy Colors, as seen in games like Pokemon Gold and similar. However, you will find that the system doesn’t implement any communication protocol, only a single register (<code>RP</code>) that encodes the IR sensor’s action (emit or receive), the single bit (<code>0</code> or <code>1</code>) being transferred and the last bit received. Nevertheless, to alleviate things for developers, Nintendo did include a reference implementation in the official Game Boy Developer manual <sup id="bibref:17"><a href="#bib:cpu-nintendo" role="doc-biblioref">[17]</a></sup>.</p><hr/><h2 id="anti-piracy">Anti-piracy</h2><p>As you’ve seen in the ‘Operating System’ section, the console will never run a game right away, it first executes a series of checks that <strong>prevent the execution of unauthorised cartridges</strong> and also makes sure the cartridge is <strong>correctly inserted</strong>.</p><p>To be able to pass these checks, games had to include a copy of Nintendo’s logo (in the form of tiles) in its ROM header <sup id="bibref:18"><a href="#bib:games-dhole" role="doc-biblioref">[18]</a></sup>, this way Nintendo could make use of <strong>Copyright and Trademark</strong> laws to control the distribution, <em>Clever huh?</em>.</p><p>That being said, more anti-piracy measures can be implemented inside games, like checking the SRAM size (it’s normally bigger in Bootlegs) and checksumming the ROM at random points of the game.</p><hr/><h2 id="thats-all-folks">That’s all folks</h2></article></div>
  </body>
</html>
