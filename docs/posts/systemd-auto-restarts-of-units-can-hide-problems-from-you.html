<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/SystemdRestartHidesProblems">Original</a>
    <h1>Systemd auto-restarts of units can hide problems from you</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Systemd auto-restarts of units can hide problems from you</h2>

	<p><small>July 31, 2023</small></p>
</div><div><p>Today, more or less by coincidence, I discovered that <a href="https://github.com/prometheus/node_exporter">the Prometheus
host agent</a> on our
Linux machines was periodically crashing with an internal Go runtime
error (which had already been noticed by other people and filed as
<a href="https://github.com/prometheus/node_exporter/issues/2705">issue #2705</a>).
You might wonder how we could not notice the host agent for <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/PrometheusGrafanaSetup-2019">our
monitoring, metrics, and alerting system</a> doing this, and part of the
answer is that the systemd service has a setting of &#39;<a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#Restart="><code>Restart=always</code></a>&#39;.</p>

<p>(We inherited this setting from <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/SystemdRestartUseDelay">the Ubuntu package&#39;s .service
unit, which got it from the Debian package</a>.
We don&#39;t use the Ubuntu package any more, but we used its .service
file as the starting point for ours, and it&#39;s broadly sensible to
automatically restart the host agent if something goes wrong.)</p>

<p>There are a surprisingly large number of things that you probably
won&#39;t notice going away briefly. If you don&#39;t look into the situation,
it might seem like a short connectivity blip, or even be hidden
from you by programs automatically retrying connections or operations.
Telling systemd to auto-restart these things will thus tend to hide
their crashes from you, which may be surprising. Still, auto-restarting
and hiding crashes is likely better than having the service be down
until you can restart it by hand. We certainly would rather have
intermittent, crash-interrupted monitoring of our machines than not
have monitoring for (potentially) some time.</p>

<p>Whether you want to monitor for this sort of thing (and how) is an
open question. It&#39;s certainly possible that this is <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/AlertsNeverComprehensive">one of the
times where your monitoring isn&#39;t going to be comprehensive</a>, because it&#39;s infrequent
enough, low impact enough, and hard enough to craft a specific
alert.</p>

<p>(I&#39;m not certain if I&#39;m going to bother trying to craft an alert
for this, partly because there&#39;s not quite enough information exposed
in the Prometheus host agent&#39;s systemd metrics to make it easy, or
at least for me to be confident that it&#39;s easy. You do get the
node_systemd_service_restart_total metric, which counts how
many times a Restart= is triggered, but that doesn&#39;t necessarily
say why and some things are restarted normally, such as &#39;getty&#39;
services.)</p>

<p>Even if we don&#39;t add a specific alert, in the future I&#39;m going to
want to remember to check for this when we&#39;re doing things like
rolling out a new version of a program (such as the Prometheus host
agent). It wouldn&#39;t hurt to look at the logs or the metrics, just
in case. Of course there&#39;s a near endless number of things you can
look at just in case, but <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/SysadminAphorism">having stubbed my toe on this once</a> I may be more twitchy here for a while.</p>
</div></div>
  </body>
</html>
