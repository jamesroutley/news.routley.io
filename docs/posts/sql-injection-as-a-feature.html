<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://idiallo.com/blog/sql-injection-as-a-feature">Original</a>
    <h1>SQL Injection as a Feature</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody" id="articleBody">
	

<p>Looking at old applications, we always wonder who in their right mind thought of building them so badly. But every repository has its story and every effort has noble origins. I encountered such an application in my career, and I was lucky enough that they had used version control to preserve its history. Let me describe how the application looked in its latest state.</p>

<p>This was a website that managed logs for millions of devices around the world. In the report page, you could query the most prevalent type of error that occurred in the wild and track it through time to see when it was introduced and when it was resolved. A pretty useful report.</p>

<p>The problem was, in the UI, you didn&#39;t have a button or a link to get to the report. Instead, you were presented with a text box where you could write the SQL queries yourself. In other words, this was a SIAAS, most commonly known as SQL Injection As A Service. The entire database was exposed for anyone who had access to the service.</p>

<p><img src="https://cdn.idiallo.com/images/assets/483/sqlbox.png" alt="Text box for sql entries"/></p>

<p>Traveling through time and CSV (version control), I discovered the initial commit when the report was first started more than a decade earlier. The page was a typical report page where you could enter a date range, some keywords, and click a &#34;Generate&#34; button. Through time, it transformed into its final form, a pure text field where you could type your raw SQL.</p>

<p><img src="https://cdn.idiallo.com/images/assets/483/report.png" alt="regular report filter"/></p>

<p>How did it happen? Well, with one request at a time over the span of 10 years.</p>

<p><strong>1. Add just one more field</strong></p>

<p>The first request was to add an additional field to the report. The developer added the field in the hard-coded SQL string inside the application, then updated the UI to read this new field. Easy enough. Everyone was happy.</p>

<p>But then there was a second request. This one was a bit harder. The requested field was in a different table. When the developer joined the new table, some of the results were incorrect or incomplete. Others complained that they were not seeing the data anymore. It took some restructuring to fix the report.</p>

<p>But then, someone complained that they didn&#39;t want that field in the report. It was messing with their VLOOKUP. After a long discussion, it was agreed that all new fields should be appended at the end of the table. Of course, this was weird since there were now some fields appearing after the creation date field.</p>

<p><strong>2. New Features requested</strong></p>

<p>But the developers didn&#39;t give up. They created a dropdown where you could select the type of report you wanted to generate. This was a neat feature. You could get the exact report you wanted without having to disrupt your own workflow. But with this feature came an invitation to create new report types. It might have started with 2 reports, but now there were dozens of them. Some were the same reports with fields slightly rearranged.</p>

<p>New complaints came in that the names of the reports didn&#39;t reflect what they were for. And the naming convention was confusing. So naturally, the developers switched from hardcoded names in the code to database-driven report names. You could now edit the report name... but what about creating your own report?</p>

<p><strong>3. Everyone gets their own Report</strong></p>

<p>This idea was rejected. Giving users the ability to create their own report was too hard. Instead, developers would discuss with analysts what they wanted to see in their report and write the appropriate query for it. Now, the dozen reports shot up to 2 dozen. After the developer created them, analysts had the ability to rename them. And of course, they renamed the reports.</p>

<p>Someone ended up renaming a report to an empty string. Chaos followed shortly after. The solution was to limit report editing to admins only.</p>

<p><strong>4. I can write my own query</strong></p>

<p>Somewhere along the line, a charismatic employee convinced developers to create a secret page where they could write their own queries. This page was created but never linked directly from anywhere in the application. On the page, the sidebar had some prewritten queries that you could click on, and they ran directly on the server. This was for some super admin users only.</p>

<p><strong>5. Protect yourself</strong></p>

<p>But then something funny happened. In the code, someone added a string search for <code>INSERT</code>, <code>UPDATE</code>, and <code>CREATE</code>. If any of these strings were detected, the page returned an unauthorized response. What this tells me is that someone had started inserting and updating data in the database.</p>

<p>With this &#34;robust&#34; security measure in place, this new super admin SQL textbox replaced the old report page.</p>

<p><strong>6. Slow queries</strong></p>

<p>It didn&#39;t take long before another commit was added to the code. This one added a 30-second timeout to the request. Almost immediately, a 30-minute timeout was added. What this tells me is that the queries were already taking a long time to run. Links to the old report page were removed. Some informational text was added to the SQL report page, warning users not to run just any random queries.</p>

<p>The next commit added text to warn users to always use a <code>LIMIT X</code> at the end of the query. In the code, a string search for <code>LIMIT</code> was added. If <code>LIMIT</code> was not present, it was inserted at the end of the string. Later, it was added that the <code>LIMIT</code> string should be before the last semicolon.</p>

<p>The company went from a report page to a fully open SQL text box. Several warnings were added to the page not to use JOINs unless you know what you&#39;re doing. Then, &#34;Don&#39;t run queries at night while the backup system is running.&#34;</p>

<p><strong>7. I inherited this website</strong></p>

<p>When I joined the company, I was entirely in charge of the tool. I made several requested changes, then I decided it was time to build a proper reporting tool. I pictured a page with a fiew components. Date range, input text, and some filtering box. Something like this:</p>

<p><img src="https://cdn.idiallo.com/images/assets/483/report.png" alt="regular report filter"/></p>

<p>But before I started, I looked through the source code history and old JIRA requests. I decided it was best to leave it as is. It didn&#39;t take long before someone decided to run a <code>DELETE</code> command, removing a single entry and throwing the whole system out of whack. Apparently, there were two tables that were commonly joined, but there were no foreign keys or relation between the tables. It took me a long while to figure out that the join was as follows:</p>

<pre><code>INNER JOIN table2 t2 ON 
    DATE(t1.entry_date) = DATE(t2.entry_date)
</code></pre>

<p>To fix it, I inserted a dummy entry with the correct date to replace the deleted one. Then I added <code>DELETE</code> as one of the forbidden commands.</p>

<p>I saved the day. I wish I could tell you that I ended up improving this tool and making it more secure, but I never had the chance. </p>

<blockquote>
  <p>After lunch, two people appeared at my desk. One was a familiar long face that seemed to avoid making direct eye contact. It was Jose and his fellow security guard. He cordially informed me that he was to escort me out of the building.</p>
</blockquote>

<p>Well, <a href="https://idiallo.com/blog/when-a-machine-fired-me">you know how the story goes</a>.</p>

	<hr/>



	
	</div></div>
  </body>
</html>
