<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/tembo-io/pg_vectorize">Original</a>
    <h1>Pg_vectorize: Vector search and RAG on Postgres</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">

<p dir="auto">A Postgres extension that automates the transformation and orchestration of text to embeddings and provides hooks into the most popular LLMs. This allows you to do vector search and build LLM applications on existing data with as little as two function calls.</p>
<p dir="auto">This project relies heavily on the work by <a href="https://github.com/pgvector/pgvector">pgvector</a> for vector similarity search, <a href="https://github.com/tembo-io/pgmq">pgmq</a> for orchestration in background workers, and <a href="https://huggingface.co/sentence-transformers" rel="nofollow">SentenceTransformers</a>.</p>
<hr/>
<p dir="auto"><a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-277pu7chi-NHtvHWvLhHwyK0Y5Y6vTPw" rel="nofollow"><img src="https://camo.githubusercontent.com/503899b9c81b00cb3eb72ac40b042daad8fcd5aec105d593c763646fdb04bc5b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f25343074656d626f2d636f6d6d756e6974793f6c6f676f3d736c61636b266c6162656c3d736c61636b" alt="Static Badge" data-canonical-src="https://img.shields.io/badge/%40tembo-community?logo=slack&amp;label=slack"/></a>
<a href="https://pgxn.org/dist/vectorize/" rel="nofollow"><img src="https://camo.githubusercontent.com/ea436684f6beb26a8cc5ea1cd46044990fe359e3f60bc91eda163feb4c4b5672/68747470733a2f2f62616467652e667572792e696f2f70672f766563746f72697a652e737667" alt="PGXN version" data-canonical-src="https://badge.fury.io/pg/vectorize.svg"/></a>
<a href="https://ossrank.com/p/3815" rel="nofollow"><img src="https://camo.githubusercontent.com/3c42348f4c8375f58183a0d0196a77a1aae334d02695c35f38ceff59b36ba490/68747470733a2f2f736869656c64732e696f2f656e64706f696e743f75726c3d68747470733a2f2f6f737372616e6b2e636f6d2f736869656c642f33383135" alt="OSSRank" data-canonical-src="https://shields.io/endpoint?url=https://ossrank.com/shield/3815"/></a></p>
<p dir="auto"><strong>API Documentation</strong>: <a href="https://tembo-io.github.io/pg_vectorize/" rel="nofollow">https://tembo-io.github.io/pg_vectorize/</a></p>
<p dir="auto"><strong>Source</strong>: <a href="https://github.com/tembo-io/pg_vectorize">https://github.com/tembo-io/pg_vectorize</a></p>

<ul dir="auto">
<li>Workflows for both vector search and RAG</li>
<li>Integrations with OpenAI&#39;s <a href="https://platform.openai.com/docs/guides/embeddings" rel="nofollow">embeddings</a> and <a href="https://platform.openai.com/docs/guides/text-generation" rel="nofollow">chat-completion</a> endpoints and a self-hosted container for running <a href="https://huggingface.co/sentence-transformers" rel="nofollow">Hugging Face Sentence-Transformers</a></li>
<li>Automated creation of Postgres triggers to keep your embeddings up to date</li>
<li>High level API - one function to initialize embeddings transformations, and another function to search</li>
</ul>

<ul dir="auto">
<li><a href="#features">Features</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#vector-search-example">Vector Search Example</a></li>
<li><a href="#rag-example">RAG Example</a></li>
<li><a href="#trigger-based-updates">Trigger based updates</a></li>
<li><a href="#try-it-on-tembo-cloud">Try it on Tembo Cloud</a></li>
</ul>

<p dir="auto">The fastest way to get started is by running the Tembo docker container and the vector server with docker compose:</p>

<p dir="auto">Then connect to Postgres:</p>
<div data-snippet-clipboard-copy-content="docker compose exec -it postgres psql"><pre lang="text"><code>docker compose exec -it postgres psql
</code></pre></div>
<p dir="auto">Enable the extension and its dependencies</p>
<div dir="auto" data-snippet-clipboard-copy-content="CREATE EXTENSION vectorize CASCADE;"><pre>CREATE EXTENSION vectorize CASCADE;</pre></div>
<details>
<summary>Install into an existing Postgres instance</summary>
<p dir="auto">If you&#39;re installing in an existing Postgres instance, you will need the following dependencies:</p>
<p dir="auto">Rust:</p>
<ul dir="auto">
<li><a href="https://github.com/pgcentralfoundation/pgrx">pgrx toolchain</a></li>
</ul>
<p dir="auto">Postgres Extensions:</p>
<ul dir="auto">
<li><a href="https://github.com/citusdata/pg_cron">pg_cron</a> ^1.5</li>
<li><a href="https://github.com/tembo-io/pgmq">pgmq</a> ^1</li>
<li><a href="https://github.com/pgvector/pgvector">pgvector</a> ^0.5.0</li>
</ul>
<p dir="auto">Then set the following either in postgresql.conf or as a configuration parameter:</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- requires restart of Postgres
alter system set shared_preload_libraries = &#39;vectorize,pg_cron&#39;;
alter system set cron.database_name = &#39;postgres&#39;"><pre><span><span>--</span> requires restart of Postgres</span>
alter system <span>set</span> shared_preload_libraries <span>=</span> <span><span>&#39;</span>vectorize,pg_cron<span>&#39;</span></span>;
alter system <span>set</span> <span>cron</span>.<span>database_name</span> <span>=</span> <span><span>&#39;</span>postgres<span>&#39;</span></span></pre></div>
<p dir="auto">And if you&#39;re running the vector-serve container, set the following url as a configuration parameter in Postgres.
The host may need to change from <code>localhost</code> to something else depending on where you are running the container.</p>
<div dir="auto" data-snippet-clipboard-copy-content="alter system set vectorize.embedding_service_url = &#39;http://localhost:3000/v1/embeddings&#39;

SELECT pg_reload_conf();"><pre>alter system <span>set</span> <span>vectorize</span>.<span>embedding_service_url</span> <span>=</span> <span><span>&#39;</span>http://localhost:3000/v1/embeddings<span>&#39;</span></span>

<span>SELECT</span> pg_reload_conf();</pre></div>
</details>

<p dir="auto">Text-to-embedding transformation can be done with either Hugging Face&#39;s Sentence-Transformers or OpenAI&#39;s embeddings. The following examples use Hugging Face&#39;s Sentence-Transformers. See the project <a href="https://tembo-io.github.io/pg_vectorize/" rel="nofollow">documentation</a> for OpenAI examples.</p>
<p dir="auto">Follow the <a href="#installation">installation</a> steps if you haven&#39;t already.</p>
<p dir="auto">Setup a products table. Copy from the example data provided by the extension.</p>
<div dir="auto" data-snippet-clipboard-copy-content="CREATE TABLE products (LIKE vectorize.example_products INCLUDING ALL);
INSERT INTO products SELECT * FROM vectorize.example_products;"><pre><span>CREATE</span> <span>TABLE</span> <span>products</span> (<span>LIKE</span> <span>vectorize</span>.<span>example_products</span> INCLUDING ALL);
<span>INSERT INTO</span> products <span>SELECT</span> <span>*</span> <span>FROM</span> <span>vectorize</span>.<span>example_products</span>;</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT * FROM products limit 2;"><pre><span>SELECT</span> <span>*</span> <span>FROM</span> products <span>limit</span> <span>2</span>;</pre></div>
<div data-snippet-clipboard-copy-content=" product_id | product_name |                      description                       |        last_updated_at        
------------+--------------+--------------------------------------------------------+-------------------------------
          1 | Pencil       | Utensil used for writing and often works best on paper | 2023-07-26 17:20:43.639351-05
          2 | Laptop Stand | Elevated platform for laptops, enhancing ergonomics    | 2023-07-26 17:20:43.639351-05"><pre lang="text"><code> product_id | product_name |                      description                       |        last_updated_at        
------------+--------------+--------------------------------------------------------+-------------------------------
          1 | Pencil       | Utensil used for writing and often works best on paper | 2023-07-26 17:20:43.639351-05
          2 | Laptop Stand | Elevated platform for laptops, enhancing ergonomics    | 2023-07-26 17:20:43.639351-05
</code></pre></div>
<p dir="auto">Create a job to vectorize the products table. We&#39;ll specify the tables primary key (product_id) and the columns that we want to search (product_name and description).</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT vectorize.table(
    job_name =&gt; &#39;product_search_hf&#39;,
    &#34;table&#34; =&gt; &#39;products&#39;,
    primary_key =&gt; &#39;product_id&#39;,
    columns =&gt; ARRAY[&#39;product_name&#39;, &#39;description&#39;],
    transformer =&gt; &#39;sentence-transformers/multi-qa-MiniLM-L6-dot-v1&#39;
);"><pre><span>SELECT</span> <span>vectorize</span>.<span>table</span>(
    job_name <span>=&gt;</span> <span><span>&#39;</span>product_search_hf<span>&#39;</span></span>,
    <span><span>&#34;</span>table<span>&#34;</span></span> <span>=&gt;</span> <span><span>&#39;</span>products<span>&#39;</span></span>,
    primary_key <span>=&gt;</span> <span><span>&#39;</span>product_id<span>&#39;</span></span>,
    columns <span>=&gt;</span> ARRAY[<span><span>&#39;</span>product_name<span>&#39;</span></span>, <span><span>&#39;</span>description<span>&#39;</span></span>],
    transformer <span>=&gt;</span> <span><span>&#39;</span>sentence-transformers/multi-qa-MiniLM-L6-dot-v1<span>&#39;</span></span>
);</pre></div>
<p dir="auto">This adds a new column to your table, in our case it is named <code>product_search_embeddings</code>, then populates that data with the transformed embeddings from the <code>product_name</code> and <code>description</code> columns.</p>
<p dir="auto">Then search,</p>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT * FROM vectorize.search(
    job_name =&gt; &#39;product_search_hf&#39;,
    query =&gt; &#39;accessories for mobile devices&#39;,
    return_columns =&gt; ARRAY[&#39;product_id&#39;, &#39;product_name&#39;],
    num_results =&gt; 3
);

                                       search_results                                        
---------------------------------------------------------------------------------------------
 {&#34;product_id&#34;: 13, &#34;product_name&#34;: &#34;Phone Charger&#34;, &#34;similarity_score&#34;: 0.8147814132322894}
 {&#34;product_id&#34;: 6, &#34;product_name&#34;: &#34;Backpack&#34;, &#34;similarity_score&#34;: 0.7743061352550308}
 {&#34;product_id&#34;: 11, &#34;product_name&#34;: &#34;Stylus Pen&#34;, &#34;similarity_score&#34;: 0.7709902653575383}"><pre><span>SELECT</span> <span>*</span> <span>FROM</span> <span>vectorize</span>.<span>search</span>(
    job_name <span>=&gt;</span> <span><span>&#39;</span>product_search_hf<span>&#39;</span></span>,
    query <span>=&gt;</span> <span><span>&#39;</span>accessories for mobile devices<span>&#39;</span></span>,
    return_columns <span>=&gt;</span> ARRAY[<span><span>&#39;</span>product_id<span>&#39;</span></span>, <span><span>&#39;</span>product_name<span>&#39;</span></span>],
    num_results <span>=&gt;</span> <span>3</span>
);

                                       search_results                                        
<span><span>--</span>-------------------------------------------------------------------------------------------</span>
 {<span><span>&#34;</span>product_id<span>&#34;</span></span>: <span>13</span>, <span><span>&#34;</span>product_name<span>&#34;</span></span>: <span><span>&#34;</span>Phone Charger<span>&#34;</span></span>, <span><span>&#34;</span>similarity_score<span>&#34;</span></span>: <span>0</span>.<span>8147814132322894</span>}
 {<span><span>&#34;</span>product_id<span>&#34;</span></span>: <span>6</span>, <span><span>&#34;</span>product_name<span>&#34;</span></span>: <span><span>&#34;</span>Backpack<span>&#34;</span></span>, <span><span>&#34;</span>similarity_score<span>&#34;</span></span>: <span>0</span>.<span>7743061352550308</span>}
 {<span><span>&#34;</span>product_id<span>&#34;</span></span>: <span>11</span>, <span><span>&#34;</span>product_name<span>&#34;</span></span>: <span><span>&#34;</span>Stylus Pen<span>&#34;</span></span>, <span><span>&#34;</span>similarity_score<span>&#34;</span></span>: <span>0</span>.<span>7709902653575383</span>}</pre></div>

<p dir="auto">Ask raw text questions of the example  <code>products</code> dataset and get chat responses from an OpenAI LLM.</p>
<p dir="auto">Follow the <a href="#installation">installation</a> steps if you haven&#39;t already.</p>
<p dir="auto">Set the <a href="https://platform.openai.com/docs/guides/embeddings" rel="nofollow">OpenAI API key</a>, this is required to for use with OpenAI&#39;s chat-completion models.</p>
<div dir="auto" data-snippet-clipboard-copy-content="ALTER SYSTEM SET vectorize.openai_key TO &#39;&lt;your api key&gt;&#39;;
SELECT pg_reload_conf();"><pre>ALTER SYSTEM <span>SET</span> <span>vectorize</span>.<span>openai_key</span> TO <span><span>&#39;</span>&lt;your api key&gt;<span>&#39;</span></span>;
<span>SELECT</span> pg_reload_conf();</pre></div>
<p dir="auto">Create an example table if it does not already exist.</p>
<div dir="auto" data-snippet-clipboard-copy-content="CREATE TABLE products (LIKE vectorize.example_products INCLUDING ALL);
INSERT INTO products SELECT * FROM vectorize.example_products;"><pre><span>CREATE</span> <span>TABLE</span> <span>products</span> (<span>LIKE</span> <span>vectorize</span>.<span>example_products</span> INCLUDING ALL);
<span>INSERT INTO</span> products <span>SELECT</span> <span>*</span> <span>FROM</span> <span>vectorize</span>.<span>example_products</span>;</pre></div>
<p dir="auto">Initialize a table for RAG. We&#39;ll use an open source Sentence Transformer to generate embeddings.</p>
<p dir="auto">Create a new column that we want to use as the context. In this case, we&#39;ll concatenate both <code>product_name</code> and <code>description</code>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="ALTER TABLE products
ADD COLUMN context TEXT GENERATED ALWAYS AS (product_name || &#39;: &#39; || description) STORED;"><pre><span>ALTER</span> <span>TABLE</span> products
ADD COLUMN context <span>TEXT</span> GENERATED ALWAYS <span>AS</span> (product_name <span>||</span> <span><span>&#39;</span>: <span>&#39;</span></span> <span>||</span> description) STORED;</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT vectorize.init_rag(
    agent_name =&gt; &#39;product_chat&#39;,
    table_name =&gt; &#39;products&#39;,
    &#34;column&#34; =&gt; &#39;context&#39;,
    unique_record_id =&gt; &#39;product_id&#39;,
    transformer =&gt; &#39;sentence-transformers/all-MiniLM-L12-v2&#39;
);"><pre><span>SELECT</span> <span>vectorize</span>.<span>init_rag</span>(
    agent_name <span>=&gt;</span> <span><span>&#39;</span>product_chat<span>&#39;</span></span>,
    table_name <span>=&gt;</span> <span><span>&#39;</span>products<span>&#39;</span></span>,
    <span><span>&#34;</span>column<span>&#34;</span></span> <span>=&gt;</span> <span><span>&#39;</span>context<span>&#39;</span></span>,
    unique_record_id <span>=&gt;</span> <span><span>&#39;</span>product_id<span>&#39;</span></span>,
    transformer <span>=&gt;</span> <span><span>&#39;</span>sentence-transformers/all-MiniLM-L12-v2<span>&#39;</span></span>
);</pre></div>
<div dir="auto" data-snippet-clipboard-copy-content="SELECT vectorize.rag(
    agent_name =&gt; &#39;product_chat&#39;,
    query =&gt; &#39;What is a pencil?&#39;
) -&gt; &#39;chat_response&#39;;"><pre><span>SELECT</span> <span>vectorize</span>.<span>rag</span>(
    agent_name <span>=&gt;</span> <span><span>&#39;</span>product_chat<span>&#39;</span></span>,
    query <span>=&gt;</span> <span><span>&#39;</span>What is a pencil?<span>&#39;</span></span>
) <span>-</span><span>&gt;</span> <span><span>&#39;</span>chat_response<span>&#39;</span></span>;</pre></div>
<div data-snippet-clipboard-copy-content="&#34;A pencil is an item that is commonly used for writing and is known to be most effective on paper.&#34;"><pre lang="text"><code>&#34;A pencil is an item that is commonly used for writing and is known to be most effective on paper.&#34;
</code></pre></div>

<p dir="auto">When vectorize job is set up as <code>realtime</code> (the default behavior, via <code>vectorize.table(..., schedule =&gt; &#39;realtime&#39;)</code>), vectorize will create triggers on your table that will keep your embeddings up to date. When the text inputs are updated or if new rows are inserted, the triggers handle creating a background job that updates the embeddings. Since the transformation is executed in a background job and the transformer model is invoked in a separate container, there is minimal impact on the performance of the update or insert statement.</p>
<div dir="auto" data-snippet-clipboard-copy-content="INSERT INTO products (product_id, product_name, description)
VALUES (12345, &#39;pizza&#39;, &#39;dish of Italian origin consisting of a flattened disk of bread&#39;);

UPDATE products
SET description = &#39;sling made of fabric, rope, or netting, suspended between two or more points, used for swinging, sleeping, or resting&#39;
WHERE product_name = &#39;Hammock&#39;;"><pre><span>INSERT INTO</span> products (product_id, product_name, description)
<span>VALUES</span> (<span>12345</span>, <span><span>&#39;</span>pizza<span>&#39;</span></span>, <span><span>&#39;</span>dish of Italian origin consisting of a flattened disk of bread<span>&#39;</span></span>);

<span>UPDATE</span> products
<span>SET</span> description <span>=</span> <span><span>&#39;</span>sling made of fabric, rope, or netting, suspended between two or more points, used for swinging, sleeping, or resting<span>&#39;</span></span>
<span>WHERE</span> product_name <span>=</span> <span><span>&#39;</span>Hammock<span>&#39;</span></span>;</pre></div>

<p dir="auto">Try it for yourself! Install with a single click on a Vector DB Stack (or any other instance) in <a href="https://cloud.tembo.io/" rel="nofollow">Tembo Cloud</a> today.</p>
</article></div></div>
  </body>
</html>
