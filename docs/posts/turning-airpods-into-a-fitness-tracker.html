<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://richarddas.com/blog/turning-airpods-into-fitness-trackers-to-fight-cancer/">Original</a>
    <h1>Turning AirPods into a fitness tracker</h1>
    
    <div id="readability-page-1" class="page"><div>
<h3>A fun side project for a great cause featuring Core Motion, SwiftUI, a little help from AI, and a pair of AirPods to count 100 push-ups a day.</h3>



<hr/>



<h4>The Inspiration</h4>



<p>In April 2024, Cancer Research UK hosted a “<a href="https://www.cancerresearchuk.org/get-involved/find-an-event/100-push-ups-a-day-challenge" target="_blank" rel="noopener" title="">100 Push-Ups a Day Challenge</a>“, to raise awareness for cancer.</p>



<p>Cancer Research UK (CRUK) is the world’s largest independent cancer research organisation. It conducts research and provides information about cancer, running campaigns aimed at raising awareness and influencing public policy.</p>



<p>The organisation’s work is almost entirely funded by the public. It raises money through donations, legacies, community fundraising, events, retail and corporate partnerships.</p>



<p>Like many people today, I know people affected by cancer, which gave me motivation to participate. Additionally, with King Charles recently undergoing treatment, and Princess Catherine of Wales announcing her diagnosis, it’s certainly a cause at the front of many people’s minds.</p>



<p><a href="https://richarddas.com/about/" target="_blank" rel="noopener" title="About">Given my history</a>, it shouldn’t come as a surprise that my first thought when signing up for the challenge was to look for an app that would help me stay on track, and to count the pushups I would be doing daily.</p>



<p>However, as is all too common these days, scrolling through the App Store I felt nothing but App Fatigue. App after app promised to “change my body in 90 days!”, be my personal fitness coach! Answer all my prayers! Instead, I just wanted something fun that would count pushups.</p>



<p>Fun for me means building something useful. So I set about to see if that was possible.</p>



<hr/>



<h4>Exploring Core Motion</h4>



<p>My first thought was how could I use sensor data? I came across plenty of examples of apps that worked by strapping your phone to you, or placing your phone somewhere strategically so that you could poke it with your nose on the way down. Or apps that used the camera or LiDAR to watch you rep it out.</p>



<p>I know that the Core Motion framework provides access to sensor data streams, and thanks to my quiet hobby of learning about esoteric Apple APIs (hello, <a href="https://developer.apple.com/documentation/contacts/cnlabelcontactrelationyoungercousinmotherssiblingsdaughterorfatherssistersdaughter" target="_blank" rel="noopener" title="">CNLabelContactRelationYoungerCousinMothersSiblingsDaughterOrFathersSistersDaughter</a>), I remembered the potentially useful <a href="https://developer.apple.com/documentation/coremotion/cmheadphonemotionmanager" target="_blank" rel="noopener" title="CMHeadphoneMotionManager">CMHeadphoneMotionManager</a> introduced in iOS14, back in 2020 when we were all trapped inside during the pandemic wondering if we’d ever be allowed to do push ups together again. And lastly, since it’s 2024 I naturally asked myself “Can I somehow use AI to solve this problem?”</p>



<p><a href="https://developer.apple.com/documentation/coremotion/" target="_blank" rel="noopener" title="">Core Motion</a> is an iOS framework that captures motion data from integrated device sensors, such as accelerometers, gyroscopes, and magnetometers. It’s used in fitness tracking, health monitoring, augmented reality (for precise positioning), and interactive gaming, among other things. It provides developers with essential data on acceleration, rotation, and fusion. Fusion data, which merges inputs from multiple sensors, offers a detailed interpretation of device motion. This enhances the accuracy and reliability of movement and orientation measurements, particularly useful for creating responsive and engaging user experiences.</p>



<p>Core Motion has been part of iOS since the operating system was renamed from “iPhone OS” back in 2010 at the release of iPad. To think, the latest and greatest iPhone back then was the<a href="https://www.apple.com/newsroom/2010/06/07Apple-Presents-iPhone-4/" target="_blank" rel="noopener" title=""> iPhone 4</a> and the origin of the <a href="https://knowyourmeme.com/memes/events/iphone-4-death-grip" target="_blank" rel="noopener" title="">“you’re holding it wrong”</a> meme.</p>



<p>And of course, because how you hold your phone is personal to you, the framework is privacy focused, and users must <a href="https://developer.apple.com/documentation/bundleresources/information_property_list/nsmotionusagedescription" target="_blank" rel="noopener" title="">grant access</a> to that data before it can be used in your app.</p>



<hr/>



<h4>Applying AI</h4>



<p>On to the next question of whether AI could help. First of all, <a href="https://www.theguardian.com/uk-news/2022/sep/10/intelligent-toaster-and-a-nappy-fullness-sensor-among-uk-inventions-in-2021" target="_blank" rel="noopener" title="">of course it can</a>. The real question is how.</p>



<p>There are plenty of apps on the App Store that use the AI embedded in frameworks like ARKit, which uses image processing to identify your body in the frame, analyse it, and determine whether you are using the correct posture or technique. While flexible, they also require you to position your phone camera at you. I didn’t want to go down that rabbit hole, and since these options already exist, they do not tick the box of “building something fun and useful”.</p>



<p>Instead, I wondered if instead an AI could help me build the idea that was starting to form in my mind. So I decided to train one. (As a matter of fact, <a href="https://gptsfordevs.com" target="_blank" rel="noopener" title="">I’ve trained several</a>, which you are welcome to use!)</p>



<p>I started by training a custom GPT on Core Motion, and created a prompt to instruct it what to do with the information: how to reference, to be helpful, specific, concise and share its reasoning.</p>



<p>This enabled me to ask the GPT questions using natural language, and have it help me come up with solutions or specific API references, rather than trying to find a needle in a haystack.</p>



<hr/>



<h4>Dancing About Architecture</h4>



<p>The proposed architecture of the app forming in my mind was straightforward, yet effective:</p>



<figure><img decoding="async" width="1024" height="469" src="https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_architecture-1024x469.jpeg" alt="" srcset="https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_architecture-1024x469.jpeg 1024w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_architecture-300x138.jpeg 300w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_architecture-768x352.jpeg 768w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_architecture-50x23.jpeg 50w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_architecture.jpeg 1200w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>







<ul>
<li><strong>Motion Manager</strong>: Streams sensor data and handles device sensor updates.</li>



<li><strong>Pushups Detector</strong>: Analyzes the streamed data to detect and count push-ups based on predefined thresholds.</li>



<li><strong>SwiftUI View</strong>: Provides a reactive UI that updates in real time as the user performs push-ups.</li>
</ul>



<p>While simple, this architecture illustrates a separation of concerns that makes it easy to test, and easier to modify. Sure I could have wired everything together into a single .swift file but we aren’t savages.</p>



<hr/>



<h4>Building the Motion Manager</h4>



<p>The Motion Manager would be responsible for streaming sensor data. It would have to be able to start and stop sensor updates, handle initialisation failures, and provide updates to the values we’re interested in: pitch (for the user’s head) and acceleration along the y-axis (to detect dips and pushes).</p>



<p>Let’s see what that looks like, starting with a good old delegate pattern to access the updating values. With all the new hotness around new programming languages, it’s nice to know our old friends are still around:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>import</span><span> CoreMotion</span></span>
<span></span>
<span><span>protocol</span><span> MotionManagerDelegate</span><span>:</span><span> </span><span>AnyObject </span><span>{</span></span>
<span><span>  </span><span>func</span><span> </span><span>didUpdateAccelerationY</span><span>(</span><span>_</span><span> </span><span>accelerationY</span><span>: </span><span>Double</span><span>)</span></span>
<span><span>  fund </span><span>didUpdatePitch</span><span>(</span><span>_ pitch</span><span>:</span><span> </span><span>Double</span><span>)</span></span>
<span><span>}</span></span></code></pre></div>



<p>Next up, the class itself:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>class</span><span> </span><span>MotionManager</span><span> </span><span>{</span></span>
<span><span>   </span></span>
<span><span>    </span><span>private</span><span> </span><span>var</span><span> motionManager </span><span>=</span><span> </span><span>CMHeadphoneMotionManager</span><span>()</span></span>
<span><span>    </span><span>weak</span><span> </span><span>var</span><span> delegate: MotionManagerDelegate</span><span>?</span></span>
<span><span>    </span></span>
<span><span>    </span><span>var</span><span> isActive: </span><span>Bool</span><span> </span><span>{</span></span>
<span><span>        motionManager.</span><span>isDeviceMotionActive</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>var</span><span> pitch: </span><span>Double</span><span> </span><span>=</span><span> </span><span>0.0</span></span>
<span><span>    </span></span>
<span><span>    </span><span>var</span><span> accelerationY: </span><span>Double</span><span> </span><span>=</span><span> </span><span>0.0</span></span>
<span><span>    </span></span>
<span><span>    </span><span>deinit</span><span> </span><span>{</span></span>
<span><span>        </span><span>stopUpdates</span><span>()</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>startUpdates</span><span>()</span><span> </span><span>{</span></span>
<span><span>        </span><span>guard</span><span> motionManager.isDeviceMotionAvailable </span><span>else</span><span> </span><span>{</span></span>
<span><span>            </span><span>print</span><span>(</span><span>&#34;</span><span>Device motion is not available</span><span>&#34;</span><span>)</span></span>
<span><span>            </span><span>return</span></span>
<span><span>        </span><span>}</span></span>
<span></span>
<span><span>        </span><span>if</span><span> motionManager.isDeviceMotionActive </span><span>{</span></span>
<span><span>            </span><span>print</span><span>(</span><span>&#34;</span><span>Device motion is already active</span><span>&#34;</span><span>)</span></span>
<span><span>            </span><span>return</span></span>
<span><span>        </span><span>}</span></span>
<span><span>        </span></span>
<span><span>        </span><span>print</span><span>(</span><span>&#34;</span><span>[Motion Manager] Starting updates.</span><span>&#34;</span><span>)</span></span>
<span><span>        </span></span>
<span><span>        motionManager.</span><span>startDeviceMotionUpdates</span><span>(</span><span>to</span><span>:</span><span> .</span><span>main</span><span>)</span><span> </span><span>{</span><span> motion, error </span><span>in</span></span>
<span><span>            </span><span>guard</span><span> </span><span>let</span><span> motion </span><span>=</span><span> motion, error </span><span>==</span><span> </span><span>nil</span><span> </span><span>else</span><span> </span><span>{</span></span>
<span><span>                </span><span>print</span><span>(</span><span>&#34;</span><span>An error occurred: </span><span>\(</span><span>error</span><span>!</span><span>.</span><span>localizedDescription</span><span>)</span><span>&#34;</span><span>)</span></span>
<span><span>                </span><span>return</span></span>
<span><span>            </span><span>}</span></span>
<span><span>             </span></span>
<span><span>            DispatchQueue.</span><span>main</span><span>.</span><span>async</span><span> </span><span>{</span></span>
<span><span>                </span><span>self</span><span>.</span><span>pitch</span><span> </span><span>=</span><span> motion.</span><span>attitude</span><span>.</span><span>pitch</span><span>        </span></span>
<span><span>                </span><span>self</span><span>.</span><span>accelerationY</span><span> </span><span>=</span><span> motion.</span><span>userAcceleration</span><span>.</span><span>y</span></span>
<span><span>            </span><span>}</span></span>
<span><span>        </span><span>}</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>stopUpdates</span><span>()</span><span> </span><span>{</span></span>
<span><span>        </span><span>guard</span><span> motionManager.isDeviceMotionActive </span><span>else</span><span> </span><span>{</span></span>
<span><span>            </span><span>print</span><span>(</span><span>&#34;</span><span>Device motion is already stopped.</span><span>&#34;</span><span>)</span></span>
<span><span>            </span><span>return</span></span>
<span><span>        </span><span>}</span></span>
<span><span>        </span></span>
<span><span>        motionManager.</span><span>stopDeviceMotionUpdates</span><span>()</span></span>
<span><span>        </span></span>
<span><span>        </span><span>print</span><span>(</span><span>&#34;</span><span>[Motion Manager] Stopped updating.</span><span>&#34;</span><span>)</span></span>
<span><span>    </span><span>}</span></span>
<span><span>}</span></span></code></pre></div>



<p>It’s not going to win any awards, but the key responsibilities are there. If you spotted any errors, congratulations you are a senior developer.</p>



<p>Oh yeah, here’s a little trick we can add: use didSet to notify the delegate of updates:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>var</span><span> pitch: </span><span>Double</span><span> </span><span>=</span><span> </span><span>0.0</span><span> </span><span>{</span></span>
<span><span>  </span><span>didSet</span><span> </span><span>{</span></span>
<span><span>    delegate</span><span>?</span><span>.</span><span>didUpdatePitch</span><span>(</span><span>pitch</span><span>)</span></span>
<span><span>  </span><span>}</span></span>
<span><span>}</span></span>
<span><span>    </span></span>
<span><span>var</span><span> accelerationY: </span><span>Double</span><span> </span><span>=</span><span> </span><span>0.0</span><span> </span><span>{</span></span>
<span><span>  </span><span>didSet</span><span> </span><span>{</span></span>
<span><span>    delegate</span><span>?</span><span>.</span><span>didUpdateAccelerationY</span><span>(</span><span>accelerationY</span><span>)</span></span>
<span><span>  </span><span>}</span></span>
<span><span>}</span></span></code></pre></div>



<hr/>



<h4>Building the Pushup Detector</h4>



<blockquote>
<p>There are 2 hard problems in computer science: cache invalidation, naming things, and off-by-1 errors.</p>
<cite><a href="https://twitter.com/secretGeek/status/7269997868" target="_blank" rel="noopener" title="">Leon Bambrick</a></cite></blockquote>



<p>The Pushups Detector is responsible for… I probably spent more time than necessary thinking about what to name the components of the app, and I’ve gotten pretty good at this. But I’ve found it to be true that once you decide what to call something, all the follow-up decisions about what it should and shouldn’t be responsible for tend to answer themselves.</p>



<p>So the Pushups Detector introduces the concept of a “session” that can start and stop. This doesn’t relate to a workout, but rather a session of analysing the data stream provided by the Motion Manager.</p>



<p>Being a detector, it’s also responsible for interpreting the raw data from the Motion Manager, such as whether the person is in the prone position or not (this is useful for determining whether we should be counting pushups or not, for example if they are standing or vertical).</p>



<p>We’ll use some basic data science techniques like thresholding to detect dips and pushes, and to evaluate whether or not to increment the count. The Pushups Detector also manages the count. If you think that belongs in a separate object, be my guest. There are no wrong answers in shipping apps.</p>



<hr/>



<h4>The Code</h4>



<p>Let’s look at some code, starting with some new <a href="https://developer.apple.com/documentation/swiftui/migrating-from-the-observable-object-protocol-to-the-observable-macro/" target="_blank" rel="noopener" title="">Observable</a> SwiftUI hotness:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>import</span><span> SwiftUI</span></span>
<span></span>
<span></span>
<span><span>@</span><span>Observable</span><span> </span><span>class</span><span> </span><span>PushupsDetector</span><span> </span><span>{</span></span>
<span><span>    </span></span>
<span><span>    </span><span>private</span><span> </span><span>let</span><span> motionManager: MotionManager</span></span>
<span></span>
<span><span>    </span><span>/// Whether or not there is an active session.</span></span>
<span><span>    </span><span>var</span><span> isActive: </span><span>Bool</span><span> </span><span>=</span><span> </span><span>false</span></span>
<span><span>    </span></span>
<span><span>    </span><span>/// The number of pushups counted in the active session.</span></span>
<span><span>    </span><span>var</span><span> count </span><span>=</span><span> </span><span>0</span></span>
<span><span>    </span></span>
<span><span>    </span><span>/// The athelete is in the correct position for a pushup</span></span>
<span><span>    </span><span>var</span><span> isValidPosition: </span><span>Bool</span><span> </span><span>=</span><span> </span><span>false</span></span>
<span></span>
<span><span>    </span></span>
<span><span>    </span><span>init</span><span>()</span><span> </span><span>{</span></span>
<span><span>        </span><span>self</span><span>.</span><span>motionManager</span><span> </span><span>=</span><span> </span><span>MotionManager</span><span>()</span></span>
<span><span>        motionManager.</span><span>delegate</span><span> </span><span>=</span><span> </span><span>self</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>deinit</span><span> </span><span>{</span></span>
<span><span>        </span><span>endSession</span><span>()</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>startSession</span><span>()</span><span> </span><span>{</span></span>
<span><span>        </span><span>print</span><span>(</span><span>&#34;</span><span>Starting session…</span><span>&#34;</span><span>)</span></span>
<span><span>        motionManager.</span><span>startUpdates</span><span>()</span></span>
<span><span>        isActive </span><span>=</span><span> </span><span>true</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>endSession</span><span>()</span><span> </span><span>{</span></span>
<span><span>        motionManager.</span><span>stopUpdates</span><span>()</span></span>
<span><span>        isActive </span><span>=</span><span> </span><span>false</span></span>
<span><span>        </span><span>print</span><span>(</span><span>&#34;</span><span>Session ended.</span><span>&#34;</span><span>)</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>incrementCount</span><span>()</span><span> </span><span>{</span></span>
<span><span>        count </span><span>+=</span><span> </span><span>1</span></span>
<span><span>    </span><span>}</span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>resetCount</span><span>()</span><span> </span><span>{</span></span>
<span><span>        count </span><span>=</span><span> </span><span>0</span></span>
<span><span>    </span><span>}</span></span>
<span><span>}</span></span></code></pre></div>



<p>There’s really not too much to talk about that isn’t pretty self-explanatory here.</p>



<p>The Pushups Detector inits a Motion Manager when it’s created. Starting and ending a session essentially starts and stops the Motion Manager updates.</p>



<p>We can add some properties for our thresholds, and whether we think the user is actively performing a pushup. For now, we’ll just put in some guesstimates, and see what happens later:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>private</span><span> </span><span>var</span><span> isPushupPhase </span><span>=</span><span> </span><span>false</span></span>
<span></span>
<span><span>private</span><span> </span><span>let</span><span> downThreshold </span><span>=</span><span> </span><span>-0.5</span></span>
<span><span>private</span><span> </span><span>let</span><span> upThreshold </span><span>=</span><span> </span><span>0.5</span></span>
<span></span>
<span><span>private</span><span> </span><span>let</span><span> proneThreshold </span><span>=</span><span> </span><span>-1</span></span></code></pre></div>



<hr/>



<h4>The Delegate</h4>



<p>The real magic of the whole app is in the delegate handlers:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>extension</span><span> PushupsDetector</span><span>:</span><span> </span><span>MotionManagerDelegate </span><span>{</span></span>
<span><span>    </span></span>
<span><span>    </span><span>func</span><span> </span><span>didUpdateAccelerationY</span><span>(</span><span>_</span><span> </span><span>accelerationY</span><span>: </span><span>Double</span><span>)</span><span> </span><span>{</span></span>
<span><span>        </span><span>if</span><span> accelerationY </span><span>&lt;</span><span> downThreshold </span><span>&amp;&amp;</span><span> </span><span>!</span><span>isPushupPhase </span><span>{</span></span>
<span><span>            </span><span>/// The user is moving downward in a push-up</span></span>
<span><span>            isPushupPhase </span><span>=</span><span> </span><span>true</span></span>
<span></span>
<span><span>        </span><span>}</span><span> </span><span>else</span><span> </span><span>if</span><span> accelerationY </span><span>&gt;</span><span> upThreshold </span><span>&amp;&amp;</span><span> isPushupPhase </span><span>{</span></span>
<span><span>            </span><span>/// The user has moved back up</span></span>
<span><span>            </span><span>incrementCount</span><span>()</span></span>
<span><span>            isPushupPhase </span><span>=</span><span> </span><span>false</span><span>  </span><span>// Reset the phase to detect the next push-up</span></span>
<span><span>        </span><span>}</span></span>
<span><span>    </span><span>}</span></span>
<span></span>
<span><span>    </span><span>func</span><span> </span><span>didUpdatePitch</span><span>(</span><span>_</span><span> </span><span>pitch</span><span>: </span><span>Double</span><span>)</span><span> </span><span>{</span></span>
<span><span>        isValidPosition </span><span>=</span><span> pitch </span><span>&lt;</span><span> proneThreshold</span></span>
<span><span>    </span><span>}</span></span>
<span><span>}</span></span></code></pre></div>



<p>As acceleration data streams in, it crosses a threshold on the way down, and again on the way back up.</p>



<p>We can also check for the user being in the prone position (lying flat, facing downwards) by seeing if the pitch value is lower than our threshold.</p>



<p>A little trial and error shows us that CMHeadphoneMotionManager is calibrated pretty logically, giving you pitch = 0 when you’re wearing AirPods and looking forwards, -1 if you are facing the ground, and +1 if you are lying down facing the sky. Standing and looking up is +0.5 to +0.7 depending on how attached your head is.</p>



<hr/>



<h4>Building the View</h4>



<p>The last piece of the puzzle is the UI. We don’t even know if this is going to work yet. Let’s spend our energy on figuring that out, instead of getting excited about how awesome it’s going to look. More on that later, because it turns out you don’t really need to look at anything to do a pushup…</p>



<p>For now, we probably want to provide the person doing pushups a way to start and stop motion detection. And displaying a count as a nice big number probably makes sense. Lastly, since we have it, we can provide some kind of indication whether they are in the prone position or not — although they are probably aware of that without looking at a screen. We hope.</p>



<p>The point is: keep it simple.</p>



<figure><img decoding="async" width="1024" height="1024" src="https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app-1024x1024.jpeg" alt="" srcset="https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app-1024x1024.jpeg 1024w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app-300x300.jpeg 300w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app-150x150.jpeg 150w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app-768x768.jpeg 768w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app-50x50.jpeg 50w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_app.jpeg 1200w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Simple.</figcaption></figure>



<p>And now for some code:</p>



<div data-code-block-pro-font-family="Code-Pro-JetBrains-Mono"><pre tabindex="0"><code><span><span>import</span><span> SwiftUI</span></span>
<span></span>
<span><span>struct</span><span> ContentView</span><span>:</span><span> </span><span>View </span><span>{</span></span>
<span><span>    </span><span>@</span><span>Environment</span><span>(</span><span>PushupsDetector.</span><span>self</span><span>)</span><span> </span><span>private</span><span> </span><span>var</span><span> pushupsDetector</span></span>
<span><span>    </span></span>
<span><span>    </span><span>var</span><span> body: </span><span>some</span><span> View </span><span>{</span></span>
<span><span>        </span><span>VStack</span><span>(</span><span>spacing</span><span>:</span><span> </span><span>40</span><span>)</span><span> </span><span>{</span></span>
<span><span>            </span><span>Text</span><span>(</span><span>&#34;</span><span>\(</span><span>pushupsDetector.count</span><span>)</span><span>&#34;</span><span>)</span></span>
<span><span>                .</span><span>font</span><span>(</span><span>.</span><span>title</span><span>)</span></span>
<span><span>            </span></span>
<span><span>            </span><span>Button</span><span>(</span><span>action</span><span>:</span><span> </span><span>{</span></span>
<span><span>                </span><span>if</span><span> pushupsDetector.isActive </span><span>{</span></span>
<span><span>                    pushupsDetector.</span><span>endSession</span><span>()</span></span>
<span><span>                </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span></span>
<span><span>                    pushupsDetector.</span><span>startSession</span><span>()</span></span>
<span><span>                </span><span>}</span></span>
<span><span>            </span><span>})</span><span> </span><span>{</span></span>
<span><span>                </span><span>Group</span><span> </span><span>{</span></span>
<span><span>                    </span><span>if</span><span> pushupsDetector.isActive </span><span>{</span></span>
<span><span>                        </span><span>Label</span><span>(</span><span>&#34;</span><span>End Session</span><span>&#34;</span><span>,</span></span>
<span><span>                              </span><span>systemImage</span><span>:</span><span> </span><span>&#34;</span><span>stop.circle.fill</span><span>&#34;</span><span>)</span></span>
<span><span>                            .</span><span>foregroundStyle</span><span>(</span><span>.</span><span>white</span><span>)</span></span>
<span><span>                    </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span></span>
<span><span>                        </span><span>Label</span><span>(</span><span>&#34;</span><span>Start Session</span><span>&#34;</span><span>,</span></span>
<span><span>                              </span><span>systemImage</span><span>:</span><span> </span><span>&#34;</span><span>play.circle.fill</span><span>&#34;</span><span>)</span></span>
<span><span>                            .</span><span>foregroundStyle</span><span>(</span><span>.</span><span>white</span><span>)</span></span>
<span><span>                    </span><span>}</span></span>
<span><span>                </span><span>}</span></span>
<span><span>            </span><span>}</span></span>
<span><span>            .</span><span>padding</span><span>(</span><span>22</span><span>)</span></span>
<span><span>            .</span><span>background</span><span>(</span><span>.</span><span>tint</span><span>)</span></span>
<span><span>            .</span><span>clipShape</span><span>(</span><span>.</span><span>buttonBorder</span><span>)</span></span>
<span><span>            </span></span>
<span><span>            </span><span>if</span><span> pushupsDetector.isActive </span><span>&amp;&amp;</span><span> pushupsDetector.isValidPosition </span><span>{</span></span>
<span><span>                </span><span>Text</span><span>(</span><span>&#34;</span><span>Good position!</span><span>&#34;</span><span>)</span></span>
<span><span>            </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span></span>
<span><span>                </span><span>Text</span><span>(</span><span>&#34;</span><span>Get into position!</span><span>&#34;</span><span>)</span></span>
<span><span>            </span><span>}</span></span>
<span><span>        </span><span>}</span></span>
<span><span>        .</span><span>padding</span><span>()</span></span>
<span><span>    </span><span>}</span></span>
<span><span>}</span></span></code></pre></div>



<p>Apparently this is better than UIKit.</p>



<hr/>



<h4>Diving Into Data</h4>



<p>Once all of that was figured out, it was time to build and run! And do some pushups!</p>



<p>Adapting the sensor data for push-up detection posed several challenges. The key was in fine-tuning the data interpretation algorithms to recognize the specific movements of push-ups accurately. Using Swift Charts, I visualized the raw sensor data to identify patterns and adjust thresholds for detection precision.</p>



<p>Sorry I didn’t keep the code for this, but essentially it involved buffering 100-300 data points into an array, then just feeding that to a Swift Chart. Maybe a dozen lines of code in total:</p>



<figure><img loading="lazy" decoding="async" width="1024" height="1024" src="https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large-1024x1024.jpeg" alt="" srcset="https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large-1024x1024.jpeg 1024w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large-300x300.jpeg 300w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large-150x150.jpeg 150w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large-768x768.jpeg 768w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large-50x50.jpeg 50w, https://richarddas.com/wp-content/uploads/2024/05/airpods_pushup_app_data-Large.jpeg 1200w" sizes="(max-width: 1024px) 100vw, 1024px"/><figcaption>Imagine my relief to see a clear pattern after all that.</figcaption></figure>



<p>I was relieved to see a clear pattern in acceleration along the y-axis. The spikes downward to -1.0 are the dip of the pushup, and when I came back up, acceleration would spike to roughly +0.5. It’s this pattern that we’ll use to define a rep, and discount anything else.</p>



<hr/>



<h4>Fine-Tuning</h4>



<p>The next step in basic data science is adjusting the initial thresholds based on observed data, so a -1 negative y-acceleration followed by a positive +0.5.</p>



<p>Of course, the only way to validate this is to do some real-world testing, and further adjustments.</p>



<p>Many, many… many… push ups later, I settled on some fine tuned values of +0.4 and -0.7 to improve accuracy. The original values proved too specific to hit, and I ended up doing many reps that weren’t counted. Since we’re observing acceleration, each rep needed to have a bit of enthusiasm to it — moving too slowly would not count the rep. Sorry, Rooster.</p>



<hr/>



<h4>The Magic of Real-Time Tracking</h4>



<p>Bringing it all together for the moment of truth:</p>



<figure><p>
<iframe loading="lazy" title="Turning AirPods into Fitness Trackers to Fight Cancer" width="500" height="281" src="https://www.youtube.com/embed/CVLS75NEpC8?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
</p><figcaption>The working app in action!</figcaption></figure>



<p>You use the whole thing by just putting in a set of AirPods, tapping start and pumping some reps. There’s zero interaction needed, and as you can see from the video above, you don’t even need your phone near you.</p>



<p>Real-time tracking feels like magic. The app, while simple in design, allows users to perform push-ups while the app monitored their movements through AirPods, updating counts automatically without any manual input.</p>



<hr/>



<h4>Reflections</h4>



<p>This project not only reinforced the importance of early validation and <a href="https://richarddas.com/services/app-design-accelerator/" target="_blank" rel="noopener" title="App Design Accelerator">iterative improvement</a> but also highlighted the personal satisfaction and fun in building something meaningful.</p>



<p>There are plenty of rough edges: I haven’t even covered counting 100 pushups per day over multiple days, or improvements to the user interface.</p>



<p>One addition to the UI that I did implement was audio feedback. With AirPods in your ears, and your phone out of sight while you face the ground, an audible confirmation was an obvious addition — and a reminder that not all user interfaces are visual.</p>



<hr/>



<h4>Conclusion</h4>



<p>By combining Core Motion, SwiftUI, and AI, I developed an app in under 24 hours that brought a new dimension to fitness tracking. This experience was a great reminder of the potential of technology to transform everyday activities.</p>



<p>While it seems like there are amazing new technologies being created every day, the challenge will always be how we can apply them to the problems we face.</p>



<hr/>



<p>If you enjoyed this post, consider donating to Cancer Research UK and help them make a difference. While the push up challenge is over, the fight against cancer is not: <a href="https://fundraise.cancerresearchuk.org/page/richards-giving-page-2917" target="_blank" rel="noopener" title="">click here to make a contribution</a>.</p>
</div></div>
  </body>
</html>
