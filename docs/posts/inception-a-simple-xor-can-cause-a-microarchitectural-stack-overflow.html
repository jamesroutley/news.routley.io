<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://comsec.ethz.ch/research/microarch/inception/">Original</a>
    <h1>Inception: A simple XOR can cause a Microarchitectural Stack Overflow</h1>
    
    <div id="readability-page-1" class="page"><div id="content">
			<!-- If has sidebar start -->
	<main id="main">
		<div>
			<!-- If has sidebar end -->
							<article id="post-1131" class="page">
										<!-- .entry-header -->
					<div>
						
<p>Over the past one and a half years, we have studied two phenomena that enable an unprivileged attacker to leak arbitrary information on all modern AMD CPUs:</p>



<ul>
<li><strong>Phantom speculation: </strong>We can trigger misprediction without any branch at the source of the misprediction.</li>



<li><strong>Training in Transient Execution: </strong>We can manipulate future mispredictions through a previous misprediction that we trigger.</li>
</ul>



<p>Putting the two together gives rise to a new type of attack called <strong>Inception</strong>: we can inject future mispredictions through a previous misprediction that we trigger — in the absence of branches. You can see a demo of Inception and find more information about the issues below:</p>



<figure><p>
<iframe title="Inception: leaking the root hash from /etc/shadow on AMD Zen 4" width="780" height="439" src="https://www.youtube.com/embed/2wCjU8iJ9G4?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
</p></figure>



<hr/>



<h2>Inception</h2>



<p>Inception (<a href="https://www.cve.org/CVERecord?id=CVE-2023-20569">CVE-2023-20569</a>) is a novel transient execution attack that leaks arbitrary data on all AMD Zen CPUs in the presence of all previously deployed software- and hardware mitigations. As in the movie of the same name, Inception plants an “idea” in the CPU while it is in a sense “dreaming”, to make it take wrong actions based on supposedly self conceived experiences. Using this approach, Inception hijacks the transient control-flow of return instructions on all AMD Zen CPUs.</p>



<h2>Training in Transient Execution (TTE)</h2>



<p>Inception is an instance of a new class of transient execution attacks that do their Training in Transient Execution (TTE). Instead of attempting to leak data in a transient window, TTE attacks abuse the transient window to insert new predictions into the branch predictor instead. These newly inserted predictions trigger future transient windows which can be more powerful than the initial one. TTE attacks thus turn supposedly harmless transient windows into dangerous ones, by abusing the victim as a confused deputy that trains itself in a transient window.</p>



<h2>Phantom speculation</h2>



<p>Although TTE attacks are interesting, they are not necessarily trivial to pull off, due to the need for specific gadgets in the victim code. Instead of these hard-to-find gadgets, what if there was an easier way to achieve a transient window for training? This is where <strong>Phantom speculation</strong> comes in. Phantom (<a href="https://www.cve.org/CVERecord?id=CVE-2022-23825">CVE-2022-23825</a>) enables an attacker to create a transient window at <em>arbitrary instructions</em>. Suddenly, a seemingly harmless XOR instruction can behave like a call instruction, and allow the attacker to create a transient window.</p>



<h2>Inception: A Combination of TTE and Phantom</h2>



<p>During our research, we found that merely a prediction for a specific instruction already manipulates the branch predictor. This enables us to insert new predictions in the branch predictor using only predictions of branches, even if they do not match reality, i.e. using a non-existing Phantom control flow. With Phantom, we can thus enable TTE by turning the CPU into a confused deputy that trains itself while running the victim.  The result of this insight is Inception, an attack that leaks arbitrary data from an unprivileged process on all AMD Zen CPUs. Inception makes the CPU believe that a XOR instruction is a recursive call instruction which overflows the return stack buffer with an attacker-controlled target.</p>



<h2>Mitigations</h2>



<p>To fully mitigate Inception, the branch predictor state has to be fully flushed while switching between distrusting contexts. We found that on Zen 1(+) and Zen 2, this comes with a hefty overhead between 93.1% and 216.9%, depending on the specific microarchitecture. On Zen 3 and Zen 4, we did not find proper hardware support to flush the entire branch predictor state. AMD have released microcode to enable this feature.</p>



<h2>Resources</h2>



<p>A <a href="https://comsec.ethz.ch/wp-content/files/inception_sec23.pdf">paper</a> about Inception is going to be presented at <a href="https://comsec.ethz.ch/wp-content/files/inception_sec22.pdf">USENIX Security 2023</a> and a <a href="https://comsec.ethz.ch/wp-content/files/phantom_micro23.pdf">paper</a> about Phantom speculation is going to be presented at<a href="https://microarch.org/micro56/"> MICRO 2023</a>. You can find the source code of Inception on our <a href="https://github.com/comsec-group/inception">Github</a>. We will publish the source code of Phantom at a later date.</p>



<h2>FAQ</h2>



<ul>
<li><strong><strong>Is my machine affected?</strong></strong></li>



<li><strong>What is the difference between Inception and Phantom?</strong></li>



<li><strong>Does Inception affect CPUs other than AMD?</strong></li>



<li><strong>Does Phantom affect CPUs other than AMD?</strong></li>



<li><strong>Are only Linux systems affected?</strong></li>



<li><strong>What should I do?</strong></li>
</ul>
					</div><!-- .entry-content -->
				</article><!-- #post -->
							<!-- If has sidebar start -->
		</div>
				<!-- If has sidebar end -->
		</main><!-- .site-main -->
	</div></div>
  </body>
</html>
