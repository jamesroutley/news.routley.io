<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://curl.se/docs/CVE-2023-38545.html">Original</a>
    <h1>curl - SOCKS5 heap buffer overflow - CVE-2023-38545</h1>
    
    <div id="readability-page-1" class="page"><div>

<div>


<h2>CVE-2023-38545</h2>

<p>Project curl Security Advisory, October 11 2023 - <a href="https://curl.se/docs/CVE-2023-38545.html">Permalink</a></p>
<h2 id="vulnerability">VULNERABILITY</h2>
<p>This flaw makes curl overflow a heap based buffer in the SOCKS5 proxy handshake.</p>
<p>When curl is asked to pass along the hostname to the SOCKS5 proxy to allow that to resolve the address instead of it getting done by curl itself, the maximum length that hostname can be is 255 bytes.</p>
<p>If the hostname is detected to be longer than 255 bytes, curl switches to local name resolving and instead passes on the resolved address only to the proxy. Due to a bug, the local variable that means &#34;let the host resolve the name&#34; could get the wrong value during a slow SOCKS5 handshake, and contrary to the intention, copy the too long hostname to the target buffer instead of copying just the resolved address there.</p>
<h2 id="terminology">TERMINOLOGY</h2>
<p>The curl library is known as libcurl and the command line tool that uses the library is known as the curl tool. Either or both may be referred to as just curl. The distinctive names are used in this document when necessary.</p>
<h2 id="info">INFO</h2>
<p>The hostname comes from the URL that curl has been told to operate with.</p>
<p>The target buffer is the heap-based download buffer in libcurl that is reused for SOCKS negotiation before the transfer has started. The size of the buffer is 16kB by default, but can be set to different sizes by the application. The curl tool sets it to 102400 bytes by default - but it sets the buffer size to a smaller size if <code>--limit-rate</code> is set lower than 102400 bytes per second.</p>
<p>libcurl provides the <code><a href="https://curl.se/libcurl/c/CURLOPT_BUFFERSIZE.html">CURLOPT_BUFFERSIZE</a></code> option to change the size of the download buffer.</p>
<p>libcurl accepts hostnames up to 65535 bytes in the URL.</p>
<p>If the used hostname is longer than the target buffer, there is a <code>memcpy()</code> that overwrites the buffer into the heap. The URL parser and possibly an IDN library (if curl is built with one) have to accept the hostname, which somewhat limits the set of available byte sequences that can be used in the copy.</p>
<p>For an overflow to happen it needs a slow enough SOCKS5 handshake to trigger the local variable bug, and the client using a hostname longer than the download buffer. Perhaps with a malicious HTTPS server doing a redirect to an especially crafted URL.</p>
<p>Typical server latency is likely &#34;slow&#34; enough to trigger this bug without an attacker needing to influence it by DoS or SOCKS server control.</p>
<p>An overflow is only possible in applications that do not set <code><a href="https://curl.se/libcurl/c/CURLOPT_BUFFERSIZE.html">CURLOPT_BUFFERSIZE</a></code> or set it smaller than 65541. Since the curl tool sets <code><a href="https://curl.se/libcurl/c/CURLOPT_BUFFERSIZE.html">CURLOPT_BUFFERSIZE</a></code> to 100kB by default it is not vulnerable unless rate limiting was set by the user to a rate smaller than 65541 bytes/second.</p>
<p>The options that cause SOCKS5 with remote hostname to be used in libcurl:</p>
<ul>
<li><code><a href="https://curl.se/libcurl/c/CURLOPT_PROXYTYPE.html">CURLOPT_PROXYTYPE</a></code> set to type <code>CURLPROXY_SOCKS5_HOSTNAME</code>, or:</li>
<li><code><a href="https://curl.se/libcurl/c/CURLOPT_PROXY.html">CURLOPT_PROXY</a></code> or <code><a href="https://curl.se/libcurl/c/CURLOPT_PRE_PROXY.html">CURLOPT_PRE_PROXY</a></code> set to use the scheme <code>socks5h://</code></li>
<li>One of the proxy environment variables can be set to use the <code>socks5h://</code> scheme. For example <code>http_proxy</code>, <code>HTTPS_PROXY</code> or <code>ALL_PROXY</code>.</li>
</ul>
<p>The options that cause SOCKS5 with remote hostname to be used in the curl tool:</p>
<ul>
<li><code>--socks5-hostname</code>, or:</li>
<li><code>--proxy</code> or <code>--preproxy</code> set to use the scheme <code>socks5h://</code></li>
<li>Environment variables as described in the libcurl section.</li>
</ul>
<p>This bug was introduced when the SOCKS5 handshake code was converted from a blocking function into a non-blocking state machine.</p>
<p><strong>The analysis in this section is specific to curl version 8.</strong> Some older versions of curl version 7 have less restriction on hostname length and/or a smaller SOCKS negotiation buffer size that cannot be overridden by <a href="https://curl.se/libcurl/c/CURLOPT_BUFFERSIZE.html">CURLOPT_BUFFERSIZE</a>.</p>
<p>The Common Vulnerabilities and Exposures (CVE) project has assigned the name CVE-2023-38545 to this issue.</p>
<p>CWE-122: Heap-based Buffer Overflow</p>
<p>Severity: High</p>
<p>HackerOne: <a href="https://hackerone.com/reports/2187833">https://hackerone.com/reports/2187833</a></p>
<h2 id="affected-versions">AFFECTED VERSIONS</h2>
<ul>
<li>Affected versions: libcurl <a href="https://curl.se/docs/vuln-7.69.0.html">7.69.0</a> to and including <a href="https://curl.se/docs/vuln-8.3.0.html">8.3.0</a></li>
<li>Not affected versions: libcurl &lt; <a href="https://curl.se/docs/vuln-7.69.0.html">7.69.0</a> and &gt;= <a href="https://curl.se/docs/vuln-8.4.0.html">8.4.0</a></li>
<li>Introduced-in: <a href="https://github.com/curl/curl/commit/4a4b63daaa">https://github.com/curl/curl/commit/4a4b63daaa</a></li>
</ul>
<p>libcurl is used by many applications, but not always advertised as such!</p>
<h2 id="solution">SOLUTION</h2>
<p>Starting in curl <a href="https://curl.se/docs/vuln-8.4.0.html">8.4.0</a>, curl no longer switches to local resolve mode if the name is too long but is instead rightfully returning an error.</p>
<ul>
<li>Fixed-in: <a href="https://github.com/curl/curl/commit/fb4415d8aee6c1">https://github.com/curl/curl/commit/fb4415d8aee6c1</a></li>
</ul>
<p><a href="https://curl.se/docs/CVE-2023-38545_patches.zip">Patch collection for older versions</a></p>
<h2 id="recommendations">RECOMMENDATIONS</h2>
<p>A - Upgrade curl to version <a href="https://curl.se/docs/vuln-8.4.0.html">8.4.0</a></p>
<p>B - Apply the patch to your local version</p>
<p>C - Do not use <code>CURLPROXY_SOCKS5_HOSTNAME</code> proxies with curl</p>
<p>D - Do not set a proxy environment variable to socks5h://</p>
<h2 id="timeline">TIMELINE</h2>
<p>This issue was reported to the curl project on September 30, 2023. We contacted distros@openwall on October 3, 2023.</p>
<p>libcurl <a href="https://curl.se/docs/vuln-8.4.0.html">8.4.0</a> was released on October 11 2023, coordinated with the publication of this advisory.</p>
<h2 id="credits">CREDITS</h2>
<ul>
<li>Reported-by: Jay Satiro</li>
<li>Patched-by: Jay Satiro</li>
</ul>
<p>Thanks a lot!</p>
</div>
</div></div>
  </body>
</html>
