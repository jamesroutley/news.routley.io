<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://peps.python.org/pep-0686/">Original</a>
    <h1>PEP 686 – Make UTF-8 mode default</h1>
    
    <div id="readability-page-1" class="page"><section id="pep-content">

<dl>
<dt>Author<span>:</span></dt>
<dd>Inada Naoki &lt;songofacandy at gmail.com&gt;</dd>
<dt>Discussions-To<span>:</span></dt>
<dd><a href="https://discuss.python.org/t/14737">Discourse thread</a></dd>
<dt>Status<span>:</span></dt>
<dd><abbr title="Normative proposal accepted for implementation">Accepted</abbr></dd>
<dt>Type<span>:</span></dt>
<dd><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt>Created<span>:</span></dt>
<dd>18-Mar-2022</dd>
<dt>Python-Version<span>:</span></dt>
<dd>3.15</dd>
<dt>Post-History<span>:</span></dt>
<dd><a href="https://discuss.python.org/t/14435" title="Discourse thread">18-Mar-2022</a>,
<a href="https://discuss.python.org/t/14737" title="Discourse thread">31-Mar-2022</a></dd>
<dt>Resolution<span>:</span></dt>
<dd><a href="https://discuss.python.org/t/14737/9">Discourse message</a></dd>
</dl>
<hr/>
<section id="contents">
<details><summary>Table of Contents</summary><ul>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#specification">Specification</a><ul>
<li><a href="#enable-utf-8-mode-by-default">Enable UTF-8 mode by default</a></li>
<li><a href="#locale-getencoding"><code><span>locale.getencoding()</span></code></a></li>
<li><a href="#fixing-encoding-locale-option">Fixing <code><span>encoding=&#34;locale&#34;</span></code> option</a></li>
</ul>
</li>
<li><a href="#backward-compatibility">Backward Compatibility</a></li>
<li><a href="#preceding-examples">Preceding examples</a></li>
<li><a href="#rejected-alternative">Rejected Alternative</a><ul>
<li><a href="#deprecate-implicit-encoding">Deprecate implicit encoding</a></li>
<li><a href="#use-pythonioencoding-for-pipes">Use <code><span>PYTHONIOENCODING</span></code> for PIPEs</a></li>
</ul>
</li>
<li><a href="#how-to-teach-this">How to teach this</a></li>
<li><a href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP proposes enabling <a href="https://peps.python.org/pep-0540/" title="PEP 540 – Add a new UTF-8 Mode">UTF-8 mode</a> by default.</p>
<p>With this change, Python consistently uses UTF-8 for default encoding of
files, stdio, and pipes.</p>
</section>
<section id="motivation">
<h2><a href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>UTF-8 becomes de facto standard text encoding.</p>
<ul>
<li>The default encoding of Python source files is UTF-8.</li>
<li>JSON, TOML, YAML use UTF-8.</li>
<li>Most text editors, including Visual Studio Code and Windows Notepad use
UTF-8 by default.</li>
<li>Most websites and text data on the internet use UTF-8.</li>
<li>And many other popular programming languages, including Node.js, Go, Rust,
and Java uses UTF-8 by default.</li>
</ul>
<p>Changing the default encoding to UTF-8 makes it easier for Python to
interoperate with them.</p>
<p>Additionally, many Python developers using Unix forget that the default
encoding is platform dependent.
They omit to specify <code><span>encoding=&#34;utf-8&#34;</span></code> when they read text files encoded
in UTF-8 (e.g. JSON, TOML, Markdown, and Python source files).
Inconsistent default encoding causes many bugs.</p>
</section>
<section id="specification">
<h2><a href="#specification" role="doc-backlink">Specification</a></h2>
<section id="enable-utf-8-mode-by-default">
<h3><a href="#enable-utf-8-mode-by-default" role="doc-backlink">Enable UTF-8 mode by default</a></h3>
<p>Python will enable UTF-8 mode by default from Python 3.15.</p>
<p>Users can still disable UTF-8 mode by setting <code><span>PYTHONUTF8=0</span></code> or
<code><span>-X</span> <span>utf8=0</span></code>.</p>
</section>
<section id="locale-getencoding">
<h3><a href="#locale-getencoding" role="doc-backlink"><code><span>locale.getencoding()</span></code></a></h3>
<p>Since UTF-8 mode affects <code><span>locale.getpreferredencoding(False)</span></code>,
we need an API to get locale encoding regardless of UTF-8 mode.</p>
<p><code><span>locale.getencoding()</span></code> will be added for this purpose.
It returns locale encoding too, but ignores UTF-8 mode.</p>
<p>When <code><span>warn_default_encoding</span></code> option is specified,
<code><span>locale.getpreferredencoding()</span></code> will emit <code><span>EncodingWarning</span></code> like
<code><span>open()</span></code> (see also <a href="https://peps.python.org/pep-0597/" title="PEP 597 – Add optional EncodingWarning">PEP 597</a>).</p>
<p>This API was added in Python 3.11.</p>
</section>
<section id="fixing-encoding-locale-option">
<h3><a href="#fixing-encoding-locale-option" role="doc-backlink">Fixing <code><span>encoding=&#34;locale&#34;</span></code> option</a></h3>
<p><a href="https://peps.python.org/pep-0597/" title="PEP 597 – Add optional EncodingWarning">PEP 597</a> added the <code><span>encoding=&#34;locale&#34;</span></code> option to the <code><span>TextIOWrapper</span></code>.
This option is used to specify the locale encoding explicitly.
<code><span>TextIOWrapper</span></code> should use locale encoding when the option is specified,
regardless of default text encoding.</p>
<p>But <code><span>TextIOWrapper</span></code> uses <code><span>&#34;UTF-8&#34;</span></code> in UTF-8 mode even if
<code><span>encoding=&#34;locale&#34;</span></code> is specified for now.
This behavior is inconsistent with the <a href="https://peps.python.org/pep-0597/" title="PEP 597 – Add optional EncodingWarning">PEP 597</a> motivation.
It is because we didn’t expect making UTF-8 mode default when Python
changes its default text encoding.</p>
<p>This inconsistency should be fixed before making UTF-8 mode default.
<code><span>TextIOWrapper</span></code> should use locale encoding when <code><span>encoding=&#34;locale&#34;</span></code> is
passed even in UTF-8 mode.</p>
<p>This issue was fixed in Python 3.11.</p>
</section>
</section>
<section id="backward-compatibility">
<h2><a href="#backward-compatibility" role="doc-backlink">Backward Compatibility</a></h2>
<p>Most Unix systems use UTF-8 locale and Python enables UTF-8 mode when its
locale is C or POSIX.
So this change mostly affects Windows users.</p>
<p>When a Python program depends on the default encoding, this change may cause
<code><span>UnicodeError</span></code>, mojibake, or even silent data corruption.
So this change should be announced loudly.</p>
<p>This is the guideline to fix this backward compatibility issue:</p>
<ol>
<li>Disable UTF-8 mode.</li>
<li>Use <code><span>EncodingWarning</span></code> (<a href="https://peps.python.org/pep-0597/" title="PEP 597 – Add optional EncodingWarning">PEP 597</a>) to find every places UTF-8 mode
affects.<ul>
<li>If <code><span>encoding</span></code> option is omitted, consider using <code><span>encoding=&#34;utf-8&#34;</span></code>
or <code><span>encoding=&#34;locale&#34;</span></code>.</li>
<li>If <code><span>locale.getpreferredencoding()</span></code> is used, consider using
<code><span>&#34;utf-8&#34;</span></code> or <code><span>locale.getencoding()</span></code>.</li>
</ul>
</li>
<li>Test the application with UTF-8 mode.</li>
</ol>
</section>
<section id="preceding-examples">
<h2><a href="#preceding-examples" role="doc-backlink">Preceding examples</a></h2>
<ul>
<li>Ruby <a href="https://bugs.ruby-lang.org/issues/16604">changed</a> the default <code><span>external_encoding</span></code>
to UTF-8 on Windows in Ruby 3.0 (2020).</li>
<li>Java <a href="https://openjdk.java.net/jeps/400">changed</a> the default text encoding
to UTF-8 in JDK 18. (2022).</li>
</ul>
<p>Both Ruby and Java have an option for backward compatibility.
They don’t provide any warning like <a href="https://peps.python.org/pep-0597/" title="PEP 597 – Add optional EncodingWarning">PEP 597</a>’s <code><span>EncodingWarning</span></code>
in Python for use of the default encoding.</p>
</section>
<section id="rejected-alternative">
<h2><a href="#rejected-alternative" role="doc-backlink">Rejected Alternative</a></h2>
<section id="deprecate-implicit-encoding">
<h3><a href="#deprecate-implicit-encoding" role="doc-backlink">Deprecate implicit encoding</a></h3>
<p>Deprecating the use of the default encoding is considered.</p>
<p>But there are many cases that the default encoding is used for reading/writing
only ASCII text.
Additionally, such warnings are not useful for non-cross platform applications
run on Unix.</p>
<p>So forcing users to specify the <code><span>encoding</span></code> everywhere is too painful.
Emitting a lot of <code><span>DeprecationWarning</span></code> will lead users ignore warnings.</p>
<p><a href="https://peps.python.org/pep-0387/" title="PEP 387 – Backwards Compatibility Policy">PEP 387</a> requires adding a warning for backward incompatible changes.
But it doesn’t require using <code><span>DeprecationWarning</span></code>.
So using optional <code><span>EncodingWarning</span></code> doesn’t violate the <a href="https://peps.python.org/pep-0387/" title="PEP 387 – Backwards Compatibility Policy">PEP 387</a>.</p>
<p>Java also rejected this idea in <a href="https://openjdk.java.net/jeps/400">JEP 400</a>.</p>
</section>
<section id="use-pythonioencoding-for-pipes">
<h3><a href="#use-pythonioencoding-for-pipes" role="doc-backlink">Use <code><span>PYTHONIOENCODING</span></code> for PIPEs</a></h3>
<p>To ease backward compatibility issue, using <code><span>PYTHONIOENCODING</span></code> as the
default encoding of PIPEs in the <code><span>subprocess</span></code> module is considered.</p>
<p>With this idea, users can use legacy encoding for
<code><span>subprocess.Popen(text=True)</span></code> even in UTF-8 mode.</p>
<p>But this idea makes “default encoding” complicated.
And this idea is also backward incompatible.</p>
<p>So this idea is rejected. Users can disable UTF-8 mode until they replace
<code><span>text=True</span></code> with <code><span>encoding=&#34;utf-8&#34;</span></code> or <code><span>encoding=&#34;locale&#34;</span></code>.</p>
</section>
</section>
<section id="how-to-teach-this">
<h2><a href="#how-to-teach-this" role="doc-backlink">How to teach this</a></h2>
<p>For new users, this change reduces things that need to teach.
Users don’t need to learn about text encoding in their first year.
They should learn it when they need to use non-UTF-8 text files.</p>
<p>For existing users, see the <a href="#backward-compatibility">Backward compatibility</a> section.</p>
</section>
<section id="copyright">
<h2><a href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section></div>
  </body>
</html>
