<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jeffgeerling.com/blog/2021/check-your-driver-faster-linux-25g-networking-realtek-rtl8125b">Original</a>
    <h1>Faster Linux 2.5G Networking with Realtek RTL8125B</h1>
    
    <div id="readability-page-1" class="page"><div><p>Since the Raspberry Pi Compute Module 4 was introduced last year, I&#39;ve been testing a <a href="https://pipci.jeffgeerling.com/#network-cards-nics-and-wifi-adapters">variety of PCI Express NICs</a> with it. One of the main types of NIC I&#39;m interested in is cheap 2.5 Gigabit Ethernet adapters.</p>

<p>2.5 Gigabits is about the highest reasonable bandwidth you can get through the PCI Express Gen 2.0 x1 lane on the Raspberry Pi, and it&#39;s also a lot more accessible than 10 Gigabit networking, especially for home users who might already have Cat5e runs that they are loathe to swap out for Cat6 or better cabling.</p>

<p>In my testing, <a href="https://www.jeffgeerling.com/blog/2021/ethernet-was-slower-only-one-direction-on-one-device">besides discovering that not all 10 Gbps SFP+ transceivers are created equal</a>, I found out that when it comes to performance, the Linux driver you&#39;re using matters—a <em>lot</em>.</p>

<p>And as a stark illustration of this point, I recently pitted an <a href="https://github.com/geerlingguy/raspberry-pi-pcie-devices/issues/268">ASUSTOR Drivestor 4 Pro NAS against a Raspberry Pi &#39;Taco&#39; NAS</a>. Both of these devices use the popular <a href="https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-pci-express-software">Realtek RTL8125B</a> chip, and <em>both</em> of them were reporting underwhelming <code>iperf3</code> bandwidth results:</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/iperf3-bandwidth-kernel-driver.jpg" alt="iperf3 bandwidth - kernel driver" width="700" height="394"/></p>

<p>The maximum throughput was eerily similar, just under 1.9 Gbps. And worse, I noticed when using devices through a PCI Express switch on the Pi, like a SATA RAID array, the network throughput took a hit, down to 1.51 Gbps on the Pi.</p>

<p>I wondered if the driver might&#39;ve seen some improvements in later revisions of the Linux kernel, so I recompiled the kernel using the 5.15.x source:</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/realtek-ethernet-driver-menuconfig.png" alt="menuconfig - Realtek 2.5G network driver in Linux kernel source tree" width="600" height="316"/></p>

<p>That made no difference—in fact, the results started to have more jitter in them, so I decided that avenue wasn&#39;t worth pursuing further.</p>

<p>So next, I downloaded the driver directly from Realtek&#39;s website, and installed version <code>9.007.01</code>:</p>

<pre><code>$ sudo apt-get install -y raspberrypi-kernel-headers
$ tar vjxf r8125-9.007.01.tar.bz2
$ cd r8125-9.007.01/
$ sudo ./autorun.sh
</code></pre>

<p>I re-ran my benchmarks, and wouldn&#39;t you know? I&#39;m able to get the full 2.35 Gbps of real-world throughput through the card—regardless of other traffic on the PCIe bus!</p>

<p><img src="https://www.jeffgeerling.com/sites/default/files/images/iperf3-bandwidth-realtek-driver.jpg" alt="iperf3 bandwidth - realtek driver" width="700" height="394"/></p>

<p>So the moral of the story seems to be: if you&#39;re not seeing the performance you expect, see if the vendor&#39;s driver is better than what&#39;s in the kernel tree.</p>

<p><em>Many</em> vendors take an upstream-first approach, where they make sure any driver optimizations make their way to the kernel quickly... but not all. I&#39;m not sure how the discrepancy is so big, though, in this case. It looks like <a href="https://github.com/torvalds/linux/commit/0439297be95111cf9ef5ece2091af16d140ce2ef#diff-3a9fe109aabf89a54957b2b641cfc3b5604150bfd486a04cc1aee43b0b3da5e1"><code>8125B</code> support was only added a year and a half ago</a>, and only a few chip-specific commits have been added since.</p>

<p>I have to wonder if maybe since far fewer Linux users have 2.5G-capable networks, these kinds of performance issues aren&#39;t discussed as much?</p>

<p>I confirmed with ASUSTOR that their current Drivestor 4 Pro software is running the driver from the kernel, and not the Realtek vendor driver. No word yet on if that could change—but if so, it may be able to unlock more performance from their value-lineup of 2.5G NASes!</p>

<p>For all my debugging details, check out my GitHub issue <a href="https://github.com/geerlingguy/raspberry-pi-pcie-devices/issues/162">NAS Comparison - ASUSTOR Drivestor 4 Pro vs Pi CM4</a>.</p>
</div></div>
  </body>
</html>
