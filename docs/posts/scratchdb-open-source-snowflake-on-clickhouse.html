<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/scratchdata/ScratchDB">Original</a>
    <h1>Show HN: ScratchDB – Open-Source Snowflake on ClickHouse</h1>
    
    <div id="readability-page-1" class="page"><div><p>Over the past few days, I encountered the task of embedding a database file into a Kotlin Multiplatform (KMP) application I was working on. Fortunately, I stumbled upon <a href="https://stackoverflow.com/questions/76382380/pre-populate-database-in-kmm-on-ios-side-using-sqldelight">a relevant question</a> on StackOverflow that provided a working implementation for the Android platform, but an equivalent iOS implementation was missing. This article will only delve into the iOS implementation, as the Android solution has been provided referenced StackOverflow discussion.</p><p>Before we get started, I used <a href="https://github.com/icerockdev/moko-resources">Moko Resources</a> to share the external database file across both platforms. Also, the app I’m building has a Share Extension that needs to tap into the same database as the main application. From Apple’s docs:</p><blockquote><p>Extensions are designed to be isolated from each other, from their containing apps, and from the apps that use them. They are sandboxed like any other third-party app and have a container separate from the containing app’s container.</p></blockquote><p>I had to set up an App Group in order to get past the sandboxing. This article won’t delve into app group creation but Apple has great <a href="https://developer.apple.com/documentation/xcode/configuring-app-groups">documentation</a> on how to set one up in Xcode.</p><h2 id="lets-dive-in">Let’s dive in</h2><p>The code snippet below demonstrates how to implement a shared database on iOS:</p><div><pre tabindex="0"><code data-lang="kotlin"><span><span><span>actual</span> <span>fun</span> <span>createDbDriver</span><span>():</span> <span>SqlDriver</span> <span>{</span>
</span></span><span><span>	<span>val</span> <span>basePath</span> <span>=</span> <span>NSFileManager</span>  
</span></span><span><span>    <span>.</span><span>defaultManager</span>  
</span></span><span><span>    <span>// Replace &#34;group.com.app&#34; with your actual app group
</span></span></span><span><span><span></span>    <span>.</span><span>containerURLForSecurityApplicationGroupIdentifier</span><span>(</span><span>&#34;group.com.app&#34;</span><span>)</span>  
</span></span><span><span>    <span>?.</span><span>path</span>  
</span></span><span><span>  
</span></span><span><span>	<span>return</span> <span>NativeSqliteDriver</span><span>(</span>  
</span></span><span><span>	    <span>YourDatabase</span><span>.</span><span>Schema</span><span>,</span>  <span>// Replace YourDatabase with your actual database
</span></span></span><span><span><span></span>	    <span>name</span> <span>=</span> <span>&#34;databaseName.db&#34;</span><span>,</span>  
</span></span><span><span>	    <span>onConfiguration</span> <span>=</span> <span>{</span> <span>config</span> <span>-&gt;</span>  
</span></span><span><span>	        <span>config</span><span>.</span><span>copy</span><span>(</span>  
</span></span><span><span>			    <span>extendedConfig</span> <span>=</span> <span>config</span><span>.</span><span>extendedConfig</span><span>.</span><span>copy</span><span>(</span><span>basePath</span> <span>=</span> <span>basePath</span><span>)</span>
</span></span><span><span>			<span>)</span>
</span></span><span><span>	    <span>}</span>
</span></span><span><span>	<span>)</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>The most important piece of code is in the <code>onConfiguration</code> callback; we need that to update the location of the <code>.sq</code> file that SQLDelight would create to Apple’s designated location for shared containers. You can completely ignore it if you’re don’t intend to share the database with an app extension.</p><p>The code snippet above is a good start but does not cover how to embed an existing database file. Here’s the pseudocode I came up with for solving the problem:</p><ol><li>Grab the location of the external database in the assets folder</li><li>Define the target iOS directory to put the asset file</li><li>Check if the database has already been created in the target directory, if yes, skip to step 5</li><li>If the file doesn’t exist in the target, create the file inside the target directory</li><li>Initialize <code>NativeSqliteDriver</code> with the target directory as the <code>basePath</code></li></ol><p>Following these instructions, let’s define the path for the source and target directories:</p><div><pre tabindex="0"><code data-lang="kotlin"><span><span><span>val</span> <span>fileManager</span> <span>=</span> <span>NSFileManager</span><span>.</span><span>defaultManager</span>  <span>// 1
</span></span></span><span><span><span></span><span>val</span> <span>basePath</span> <span>=</span> <span>fileManager</span> 
</span></span><span><span>	<span>.</span><span>containerURLForSecurityApplicationGroupIdentifier</span><span>(</span><span>&#34;group.com.app&#34;</span><span>)</span>
</span></span><span><span>	<span>?.</span><span>path</span> <span>// 2
</span></span></span><span><span><span></span>  
</span></span><span><span><span>val</span> <span>targetDbFolderPath</span> <span>=</span> <span>&#34;</span><span>$basePath</span><span>/databases&#34;</span>  <span>// 3
</span></span></span><span><span><span></span><span>val</span> <span>targetDatabasePath</span> <span>=</span> <span>&#34;</span><span>$targetDbFolderPath</span><span>/</span><span>${DB_NAME}</span><span>.db&#34;</span> <span>// 4
</span></span></span><span><span><span></span>
</span></span><span><span><span>// Using Moko-Resources
</span></span></span><span><span><span></span><span>val</span> <span>source</span> <span>=</span> <span>MR</span><span>.</span><span>files</span><span>.</span><span>dbAsset</span><span>.</span><span>path</span> 
</span></span></code></pre></div><p>From the above we:</p><ol><li>Grabbed a reference to the FileManager singleton</li><li>Use the file manager to get the path for app group’s folder and store in <code>basePath</code> variable</li><li>Append “databases”(could be anything) to <code>basePath</code> to define the <code>targetDbFolderPath</code></li><li>Append our database filename to <code>targetDbFolderPath</code>. Ensure the <code>.db</code> extension is appended.</li><li>Uses moko-resources to retrieve the path of the external database we want to embed</li></ol><p>Next, we implement steps 3 to 5 from our pseudocode:</p><div><pre tabindex="0"><code data-lang="Kotlin"><span><span>
</span></span><span><span><span>// just for readability sake
</span></span></span><span><span><span></span><span>val</span> <span>databaseExists</span> <span>=</span> <span>fileManager</span><span>.</span><span>fileExistsAtPath</span><span>(</span><span>targetDatabasePath</span><span>)</span> 
</span></span><span><span>
</span></span><span><span><span>if</span> <span>(!</span><span>databaseExists</span><span>)</span> <span>{</span> <span>// if database file DOES NOT exist
</span></span></span><span><span><span></span>	<span>val</span> <span>folderExists</span> <span>=</span> <span>fileManager</span><span>.</span><span>fileExistsAtPath</span><span>(</span><span>targetDbFolderPath</span><span>)</span>
</span></span><span><span>
</span></span><span><span>	<span>if</span> <span>(!</span><span>folderExists</span><span>)</span> <span>{</span>  <span>// if database directory does not exist, create it
</span></span></span><span><span><span></span>		<span>fileManager</span><span>.</span><span>createDirectoryAtPath</span><span>(</span> <span>// 3
</span></span></span><span><span><span></span>			<span>path</span> <span>=</span> <span>targetDbFolderPath</span><span>,</span> 
</span></span><span><span>			<span>withIntermediateDirectories</span> <span>=</span> <span>true</span><span>,</span> 
</span></span><span><span>			<span>attributes</span> <span>=</span> <span>null</span><span>,</span> 
</span></span><span><span>			<span>error</span> <span>=</span> <span>null</span>
</span></span><span><span>		<span>)</span>
</span></span><span><span>	<span>}</span> <span>// end of inner if-statement
</span></span></span><span><span><span></span>
</span></span><span><span>	<span>// copies the database file we want to embed from assets to the 
</span></span></span><span><span><span></span>	<span>// target directory 
</span></span></span><span><span><span></span>	<span>fileManager</span><span>.</span><span>copyItemAtPath</span><span>(</span>
</span></span><span><span>		<span>srcPath</span> <span>=</span> <span>source</span><span>,</span> 
</span></span><span><span>		<span>toPath</span> <span>=</span> <span>targetDatabasePath</span><span>,</span> 
</span></span><span><span>		<span>error</span> <span>=</span> <span>null</span>
</span></span><span><span>	<span>)</span>
</span></span><span><span><span>}</span> <span>// outside if-statement
</span></span></span><span><span><span></span>
</span></span><span><span><span>return</span> <span>NativeSqliteDriver</span><span>(</span>  
</span></span><span><span>	<span>YourDatabase</span><span>.</span><span>Schema</span><span>,</span>  <span>// Replace YourDatabase with your actual database
</span></span></span><span><span><span></span>		<span>name</span> <span>=</span> <span>&#34;databaseName.db&#34;</span><span>,</span>  
</span></span><span><span>	    <span>onConfiguration</span> <span>=</span> <span>{</span> <span>config</span> <span>-&gt;</span>  
</span></span><span><span>	        <span>config</span><span>.</span><span>copy</span><span>(</span>  
</span></span><span><span>			    <span>extendedConfig</span> <span>=</span> <span>config</span>
</span></span><span><span>					    <span>.</span><span>extendedConfig</span>
</span></span><span><span>					    <span>.</span><span>copy</span><span>(</span><span>basePath</span> <span>=</span> <span>targetDbFolderPath</span><span>)</span> <span>// 5
</span></span></span><span><span><span></span>		<span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>)</span>
</span></span></code></pre></div><p>Notably, the functions <code>fileManager.createDirectoryAtPath()</code> and <code>fileManager.copyItemAtPath()</code> return a Boolean value indicating the success or failure of the operation. Additionally, in the <code>onConfiguration</code> callback, the <code>basePath</code> property of the <code>extendedConfig</code> parameter is set to <code>targetDbFolderPath</code>. Without this adjustment, SQLDelight would default to a different operational path and your application might not behave as expected.</p><p>Lastly, for SQLDelight integration, ensure the external database tables are registered. Here’s how:</p><div><pre tabindex="0"><code data-lang="SQL"><span><span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>IF</span><span> </span><span>NOT</span><span> </span><span>EXISTS</span><span> </span><span>users</span><span>(</span><span>  </span><span>//</span><span> </span><span>1</span><span>
</span></span></span><span><span><span>    </span><span>id</span><span> </span><span>INTEGER</span><span> </span><span>PRIMARY</span><span> </span><span>KEY</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span><span>  
</span></span></span><span><span><span>    </span><span>firstName</span><span> </span><span>TEXT</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span><span>  
</span></span></span><span><span><span>    </span><span>lastName</span><span> </span><span>TEXT</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>,</span><span>  
</span></span></span><span><span><span>    </span><span>bio</span><span> </span><span>TEXT</span><span> </span><span>NOT</span><span> </span><span>NULL</span><span>
</span></span></span><span><span><span></span><span>);</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span> </span><span>-- Write your queries here
</span></span></span><span><span><span></span><span>getUsers</span><span>:</span><span> 
</span></span></span><span><span><span></span><span>SELECT</span><span> </span><span>*</span><span> </span><span>FROM</span><span> </span><span>users</span><span> </span><span>LIMIT</span><span> </span><span>10</span><span>;</span><span>  </span><span>//</span><span> </span><span>2</span><span>
</span></span></span></code></pre></div><p>In the SQL snippet above:</p><ol><li>We create the table if absent. The <code>IF NOT EXISTS</code> is vital since the table’s initial creation happened during the copy process. Also, ensure the table and column names align with those in the external database.</li><li>With the table now recognized by SQLDelight, we can now write queries to interact with its columns.</li></ol><p>That wraps up this brief guide. Reach out to me if you have any questions or feedback. Thanks for reading!</p></div></div>
  </body>
</html>
