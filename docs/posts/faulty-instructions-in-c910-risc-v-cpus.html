<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ghostwriteattack.com">Original</a>
    <h1>Faulty instructions in C910 RISC-V CPUs</h1>
    
    <div id="readability-page-1" class="page"><div><nav><div><div><p><img src="https://ghostwriteattack.com/ghostwrite-no-text.svg"/></p></div><ul><li id="homelink" data-block="home">Home</li><li data-block="details">Details</li><li data-block="demo">Demo</li><li data-block="implications">Implications</li><li data-block="how-we-found-it">How we found it</li><li data-block="who-found-it">People</li><li data-block="faq">FAQ</li></ul></div></nav><section id="home"><div><p><img src="https://ghostwriteattack.com/ghostwrite.svg"/></p><div><div id="innerhomecontainer"><p>The GhostWrite vulnerability affects the T-Head XuanTie C910 and C920 RISC-V CPUs.
This vulnerability allows unprivileged attackers, even those with limited access, to read and write any part of the computer’s memory and to control peripheral devices like network cards.
GhostWrite renders the CPU’s security features ineffective and cannot be fixed without disabling around half of the CPU’s functionality.</p></div></div></div></section><section id="fundamentals"><div><div width="100%"><h2>Fundamentals.</h2><h3>Process Isolation and Assembly Instructions.</h3><p>Modern operating systems work together with the CPU to keep each process running on your system isolated from the others.
To do this, the operating system divides the <em>physical</em> memory into separate <em>virtual</em> memory spaces, one for each process.
This ensures that each process can only access its own <em>virtual</em> memory and cannot interfere with other processes.</p><p>Your computer runs programs by executing instructions on the CPU.
These instructions can range from very simple tasks, such as adding two numbers, to more complex operations.
Usually, these instructions and their behaviors are thoroughly documented in the CPU vendor’s manuals.
However, CPUs sometimes also contain undocumented instructions.</p></div></div></section><section id="riscv"><div><div><p><img src="https://ghostwriteattack.com/riscv.svg" alt="RISC-V logo"/></p><div><h2>RISC-V.</h2><h3>A New CPU Architecture.</h3><p>A CPU’s behavior is defined by an instruction set architecture (ISA), which specifies the valid assembly instructions.
If two CPUs follow the same ISA, they can run the same programs.</p><p>Today, the CPU market is mostly dominated by two ISA specifications: x86 and ARM.
These are controlled by a few companies, which limits how freely other companies can design their products.
Using or modifying these ISAs requires expensive licenses and is restricted to a selected group of partners.</p><p><a href="https://riscv.org/">RISC-V</a> is a new, open ISA that anyone can use and contribute to without restrictions.
This openness has led to a thriving ecosystem, with continuous software improvements and new RISC-V-based hardware frequently emerging.
You can even find RISC-V-based bare-metal servers <a href="https://labs.scaleway.com/en/em-rv1/">in the cloud</a>.</p></div></div></div></section><section id="details"><div><div><p><img src="https://ghostwriteattack.com/ghostwrite-ram.svg" alt="GhostWrite Illustration"/></p><div><h2>GhostWrite.</h2><h3>Writing Arbitrary Physical Memory.</h3><p>GhostWrite is a bug in the T-Head XuanTie C910, one of the fastest RISC-V CPUs available.
Unlike side-channel attacks or <a href="https://transient.fail/">transient-execution attacks</a>, GhostWrite is a direct CPU bug.
This CPU has faulty instructions in its vector extension, an add-on to the RISC-V ISA designed to handle larger data values than the base ISA.</p><p>These faulty instructions work directly with <em>physical</em> memory instead of <em>virtual</em> memory, bypassing the process isolation normally enforced by the operating system and hardware.
This bug is embedded in the hardware, meaning it cannot be fixed with software updates.</p><p>An unprivileged attacker, for example, a normal user, can use these instructions to write to any memory location.
This completely bypasses security and isolation features, giving the attacker full, unrestricted access to the device.
The attack is 100% reliable, deterministic, and takes only microseconds to execute.
Even security measures like Docker containerization or sandboxing cannot stop this attack.
Additionally, the attacker can hijack hardware devices that use memory-mapped input/output (MMIO), allowing them to send any commands to these devices.</p><p>The only way to mitigate this issue is to disable the entire vector functionality, which disables roughly 50% of the instruction set, severely impacting the CPU’s performance and capabilities.</p></div></div></div></section><section id="demo"><div><h2>Demo</h2><p>We show what GhostWrite can do with two proof-of-concept exploits.</p><p>In the first exploit, we use GhostWrite to modify the kernel’s <code>getuid</code> syscall.
This function checks a user’s ID to decide what <code>sudo</code> should do.
If <code>getuid</code> returns <code>0</code>, which is the special ID for the privileged root user, <code>sudo</code> gives root access without asking for a password.</p><p><video width="100%" controls="">
<source src="/kernel-getuid-sudo-attack.mp4" type="video/mp4"/>A video demonstrating how GhostWrite can be used to patch the kernel getuid syscall to gain root on affected systems.</video></p><p>On its own, GhostWrite can only <em>write</em> to memory.
However, it can be used to create a read function by modifying the page tables in memory.
These tables translate <em>virtual</em> memory addresses to <em>physical</em> ones.
Consequently, modifying them allows an attacker to get an accessible <em>virtual</em> address for any <em>physical</em> address, allowing reading <em>and</em> writing.</p><p>The second exploit shows how this GhostWrite-based read function can leak any memory content from a machine.
To demonstrate this, we assume an administrator types a secret password into a trusted password prompt to update the system (left).</p><p>The exploit (right) starts by filling the <em>physical</em> memory with page tables.
Given that the victim system has 8GB of memory, this process takes a few seconds.
The exploit then attempts to modify one of these page tables using GhostWrite.
Once successful, the exploit can read the secret password directly from physical memory.</p><p><video width="100%" controls="">
<source src="/page-table-physical-read-attack.mp4" type="video/mp4"/>A video demonstrating how GhostWrite can be used to alter page tables and by that transform GhostWrite into a read-write primitive.</video></p></div></section><section id="implications"><div><h2>Security Implications</h2><p>To the best of our knowledge, only the T-Head XuanTie C910 CPU in the TH1520 SoC and the T-Head XuanTie C920 CPU in the SOPHON SG2042 are affected by GhostWrite.
Still, this vulnerability impacts a wide range of devices, including personal computers, laptops, containers, and virtual machines in cloud servers.
Therefore, any customers or vendors using machines with these processors are at risk.</p><p>Vulnerable devices include:</p><ul><li><a href="https://labs.scaleway.com/en/em-rv1/">Scaleway Elastic Metal RV1</a>, bare-metal C910 cloud instances</li><li><a href="https://milkv.io/pioneer">Milk-V Pioneer</a>, 64-core desktop/server</li><li><a href="https://sipeed.com/licheepi4a">Lichee Cluster 4A</a>, compute cluster</li><li><a href="https://sipeed.com/licheepi4a">Lichee Book 4A</a>, laptop</li><li><a href="https://sipeed.com/licheepi4a">Lichee Console 4A</a>, tiny laptop</li><li><a href="https://www.tomshardware.com/pc-components/cpus/risc-v-handheld-gaming-system-announced-linux-as-the-basis-for-a-retro-gaming-platform">Lichee Pocket 4A</a>, gaming console</li><li><a href="https://sipeed.com/licheepi4a">Sipeed Lichee Pi 4A</a>, single-board computer (SBC)</li><li><a href="https://milkv.io/meles">Milk-V Meles</a>, SBC</li><li><a href="https://www.beagleboard.org/boards/beaglev-ahead">BeagleV-Ahead</a>, SBC</li></ul><p>To protect against this vulnerability, you can disable the vulnerable vector extension entirely.</p></div></section><section id="how-we-found-it"><div><div><p><img src="https://ghostwriteattack.com/differential-fuzzing.svg" alt="An overview of differential CPU fuzzing."/></p><div><h2>Automatic Bug Discovery.</h2><h3>Differential CPU Fuzz Testing.</h3><p>We discovered GhostWrite by analyzing both documented and undocumented instructions using a method called differential fuzz-testing for CPUs.
The concept is intuitive: generate small programs, run them on different CPUs, and compare the results.
Since every RISC-V CPU should follow the <a href="https://riscv.org/technical/specifications/">RISC-V specification</a>, they should produce the same results for the same inputs.
When results differ between CPUs, it suggests that one of the CPUs might have an issue.</p><p>We identified GhostWrite when the T-Head XuanTie C910 CPU showed unusual behavior with an illegally-encoded vector-store instruction.
While other CPUs generated page fault exceptions or refused to execute the instruction, the C910 did execute it.</p><p>Upon further investigation, we discovered that the illegally-encoded instruction allows a process to write directly to <em>physical</em> memory instead of <em>virtual</em> memory, revealing a severe security vulnerability.</p></div></div></div></section><section id="who-found-it"><div><p><h2 id="who-found-it">Who found it?</h2></p><p><img id="people" src="https://ghostwriteattack.com/who.jpg"/></p></div></section><section id="acknowledgements"><div><h2>Acknowledgements</h2><p>This work was supported in part by Semiconductor Research Corporation (SRC) Hardware Security Program (HWS) and by a Google Research Scholar award.
Any opinions, findings, conclusions, or recommendations expressed in this paper are those of the authors and do not necessarily reflect the views of the funding parties.</p></div></section><section id="faq"><div><h2>FAQ</h2><div><div><p>Am I affected by this vulnerability?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>Most likely, you are not affected directly.
Only individuals that use vulnerable RISC-V hardware, such as C910-based or C920-based single-board computers (SBCs), cloud deployments, or other multi-party computing solutions are directly affected.
Even though you might not be affected directly, the chance is high that you might already or in the future interact with vulnerable devices.</p></div><div><div><p>How do I know if my device uses the T-Head XuanTie C910 or C920 CPU?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>Most consumer devices list their CPU specifications in their technical details or documentation.
You can check the manufacturer’s website, user manual, or device settings for this information.</p></div><div><div><p>Can software updates or patches fix this vulnerability?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>No, software updates or patches cannot fix this vulnerability because it is a hardware bug.
The only mitigation is to disable the vector extension in the CPU, which unfortunately impacts the CPU’s performance.</p></div><div><div><p>How to mitigate GhostWrite? How do I protect devices against this vulnerability?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>Luckily, the vulnerable instructions lie in the vector extension, which can be disabled by the operating system.
This fully mitigates GhostWrite, but also fully disables vector instructions on the CPU.</p></div><div><div><p>What should cloud service providers do to protect their users?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>Cloud service providers should disable the vector extension on any vulnerable CPUs and inform their customers about the potential impact on performance.</p></div><div><div><p>What are the performance impacts of disabling the vector extension?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>Disabling the vector extension significantly reduces the CPU’s performance, especially for tasks that benefit from parallel processing and handling large data sets.
Applications relying heavily on these features may experience slower performance or reduced functionality.
In our benchmark using <a href="https://github.com/camel-cdr/rvv-bench">rvv-bench</a>, we see up to 33% overhead when disabling the vector extension.</p></div><div><div><p>Is this a side-channel or transient-execution attack?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>No, GhostWrite is an <em>architectural</em> bug and does not fall into the category of transient-execution attacks like Meltdown or Spectre.
It is also not a side-channel attack.</p></div><div><div><p>Is there any evidence of this vulnerability being exploited in the wild?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>To exploit the vulnerability an attacker needs to execute unprivileged code on the vulnerable CPU.
This is a threat on multi-user and cloud systems or when untrusted code is executed, even in containers or virtual machines.
As of now we haven’t heard of any occurrences where this vulnerability has been exploited in the wild.</p></div><div><div><p>What is the official statement of T-Head?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>We reported the bug to T-Head.
They acknowledged and reproduced it.
However, we are unware of any planned public comments or mitigations.</p></div><div><div><p>Can GhostWrite be detected or monitored in some way?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>As of now, there are no specific tools or methods to detect if GhostWrite is being exploited.</p></div><div><div><p>Does this mean that RISC-V is bad?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>GhostWrite is not a problem with the RISC-V ISA.
Only the T-Head XuanTie C910 and C920 CPUs, implementations of RISC-V, are vulnerable to GhostWrite due to a bug in their design.</p></div><div><div><p>Are there any alternative RISC-V CPUs that do not have this vulnerability?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div><p>Yes, many other RISC-V CPUs are not affected by GhostWrite.
The vulnerability is specific to the T-Head XuanTie C910 and C920 CPUs.</p></div><div><div><p>Can I use the logo?</p><p><img src="https://ghostwriteattack.com/chevron-arrow.svg"/></p></div></div></div></section></div></div>
  </body>
</html>
