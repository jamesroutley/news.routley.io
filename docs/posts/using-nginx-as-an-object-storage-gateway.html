<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.nginx.com/blog/using-nginx-as-object-storage-gateway/">Original</a>
    <h1>Using Nginx as an Object Storage Gateway</h1>
    
    <div id="readability-page-1" class="page"><div>
		<p>Have you ever accidentally posted a link to file on an object store like Amazon S3 instead of your CDN and seen it go viral? Were you surprised by how high your cloud services bill shot up or did your cloud provider block access? If so, this blog is for you. We describe how you can front a private S3 <a target="_blank" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html" rel="noopener noreferrer">bucket</a> with NGINX as a caching gateway to put a layer of protection between your private bucket and the public Internet. There are two benefits: NGINX caches requests to your object store and prevents public discovery of its contents.</p>
<h2>About Amazon S3 and Compatible Storage Products</h2>
<p>Although proprietary to AWS, the <a target="_blank" href="https://aws.amazon.com/pm/serv-s3/" rel="noopener noreferrer">Amazon S3</a> API has become the de facto standard interface for <a target="_blank" href="https://en.wikipedia.org/wiki/Object_storage" rel="noopener noreferrer">object storage</a> systems, with many vendors offering compatible storage products – <a target="_blank" href="https://www.backblaze.com/b2/docs/s3_compatible_api.html" rel="noopener noreferrer">Backblaze</a>, <a target="_blank" href="https://www.digitalocean.com/products/spaces/" rel="noopener noreferrer">Digital Ocean</a>, <a target="_blank" href="https://cloud.google.com/storage/docs/interoperability" rel="noopener noreferrer">Google Storage</a>, <a target="_blank" href="https://min.io/" rel="noopener noreferrer">Minio</a>, <a target="_blank" href="https://www.netapp.com/us/products/data-management-software/object-storage-grid-sds.aspx" rel="noopener noreferrer">NetApp</a>, <a target="_blank" href="https://www.nutanix.com/products/objects" rel="noopener noreferrer">Nutanix</a>, <a target="_blank" href="https://intl.cloud.tencent.com/product/cos" rel="noopener noreferrer">Tencent Cloud</a>, <a target="_blank" href="https://blogs.vmware.com/cloudprovider/2019/06/announcing-s3-compatible-object-storage-for-vmware-cloud-providers.html" rel="noopener noreferrer">VMware</a>, and <a target="_blank" href="https://wasabi.com/" rel="noopener noreferrer">Wasabi</a> among them. Despite the broad support for the S3 API, specific S3 API implementations are often not well suited to non‑storage operations such as serving high‑volume public Internet traffic. As such, there is a common need for a layer in front of the S3 API to bridge the storage interface to another application or user‑specific interface. NGINX can act as this bridge and provide additional value because of its module ecosystem and configurability.</p>
<p>In this blog we show how to configure NGINX Open Source and NGINX Plus as a read‑only gateway to an S3‑compatible object store by exploring <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/" rel="noopener noreferrer">a fully functioning Docker‑based implementation</a> hosted in GitHub (an example of a stand‑alone <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/blob/master/examples/ubuntu_install/ubuntu_setup.sh" rel="noopener noreferrer">Ubuntu installation</a> is also available). Although we are only covering NGINX as a gateway for an S3‑compatible service, you can extend the approach to any service that uses <a target="_blank" href="https://docs.aws.amazon.com/general/latest/gr/signing_aws_api_requests.html" rel="noopener noreferrer">AWS API Request Signing</a>.</p>
<h2>Use Cases</h2>
<p>You might be wondering, “My object store already serves files at massive scale. Why would I want to put another layer in front of it?”</p>
<p>The answer is simple: object stores like S3 do one thing well – store and retrieve objects. NGINX, on the other hand, is a highly configurable reverse proxy which provides additional functionality on top of the basic object storage gateway. As such, it can be a good solution for a diverse set of use cases, including the following.</p>
<h3>Caching</h3>
<p>Object storage systems are designed for the storage of massive amounts of data and aren’t optimized for the repeated retrieval of the same objects (such as files or binary data). It is generally considered a best practice to have a caching layer in front of an object store to prevent unnecessary read operations. Using NGINX as a cache lowers latency of object delivery, protects against outages, and reduces usage costs.</p>
<h3>Security Control</h3>
<p>Although S3 has its own authentication and policy‑based access system, it doesn’t necessarily accommodate your specific authentication needs. NGINX supports <a target="_blank" href="https://docs.nginx.com/nginx/admin-guide/security-controls/" rel="noopener noreferrer">many different security controls</a>, so as a gateway it can provide authentication and access control that meets those needs. You can even create signed links with the <a target="_blank" href="https://nginx.org/en/docs/http/ngx_http_secure_link_module.html" rel="noopener noreferrer">Secure Link</a> module!</p>
<h3>Access for Internal Applications</h3>
<p>Implementing AWS signature‑based authentication is tricky, and many applications and platforms do not have client libraries that allow for easy communication with S3. With NGINX as a gateway for internal services accessing S3, those applications become able to access S3 resources easily, without having to generate AWS signatures.</p>
<h3>Compression and Content Optimization</h3>
<p>You may want to compress the data in your object store to save on storage costs, but still serve content to clients that do not support compression. In this case, you can configure NGINX to <a target="_blank" href="https://docs.nginx.com/nginx/admin-guide/web-server/compression/" rel="noopener noreferrer">decompress data in real time</a> before sending it.</p>
<p>Alternatively, you might store content on the object store uncompressed and want to reduce delivery time by compressing data before transmission. In that case, configure the built‑in <a target="_blank" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" rel="noopener noreferrer">Gzip</a> module or <a target="_blank" href="https://docs.nginx.com/nginx/admin-guide/dynamic-modules/brotli/" rel="noopener noreferrer">Brotli</a> dynamic module to reduce transfer time to end users.</p>
<p>NGINX also supports other types of real‑time modifications to content, like the <span><a target="_blank" href="https://docs.nginx.com/nginx/admin-guide/dynamic-modules/image-filter/" rel="noopener noreferrer">Image-Filter</a></span> dynamic module for transforming GIF, JPEG, and PNG images, and tools like <a target="_blank" href="https://www.modpagespeed.com/" rel="noopener noreferrer">PageSpeed</a> for reducing page load time by automatically applying web performance best practices to pages and associated assets. (at the time of writing, the Pagespeed site says that Pagespeed is “undergoing incubation at The Apache Software Foundation”. It is in fact the same mature code developed by Google and referenced in <a href="https://www.nginx.com/blog/optimize-website-google-pagespeed-dynamic-module-nginx-plus/">Optimizing Your Website with the Google PageSpeed Dynamic Module for NGINX Plus</a> on our blog.)</p>
<h3>Security</h3>
<p>With NGINX you can build another layer of security in front of the S3 API, for example to <a target="_blank" href="https://docs.nginx.com/nginx/admin-guide/security-controls/controlling-access-proxied-http/#limit_req" rel="noopener noreferrer">rate limit</a> users who are making excessive download requests and to limit which object paths are accessible within a <a target="_blank" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html" rel="noopener noreferrer">bucket</a>. You can further protect the S3 API with an integrated web application firewall (WAF) like <a href="https://www.nginx.com/products/nginx-app-protect/web-application-firewall">F5 NGINX App Protect WAF</a> or <a target="_blank" href="https://docs.nginx.com/nginx-waf/" rel="noopener noreferrer">NGINX ModSecurity WAF</a>.</p>
<h3>Application Gateway</h3>
<p>It is common when serving content from a site to use the same domain name for all resources to satisfy security, branding, consistency, and portability requirements. As such, serving static content and dynamic content together from the same host is a common need. While serving static files from an object store in its role as an S3 API gateway, NGINX can also proxy and load balance requests for dynamic content originating in application servers.</p>
<h2>Features and Limitations</h2>
<p>The <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway" rel="noopener noreferrer">NGINX S3 gateway</a> implementation discussed in this blog has the following features and limitations: </p>
<ul>
<li>Supports AWS Signature <a target="_blank" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/auth-request-sig-v2.html" rel="noopener noreferrer">Version 2</a> and <a target="_blank" href="https://docs.aws.amazon.com/AmazonS3/latest/API/sig-v4-authenticating-requests.html" rel="noopener noreferrer">Version 4</a></li>
<li>Supports <code>GET</code> and <code>HEAD</code> requests only</li>
<li>Supports NGINX Open Source and NGINX Plus</li>
<li>Supports a single bucket</li>
<li>Caches content for 1 hour</li>
<li>Not configured with SSL/TLS</li>
<li>No WAF is installed by default</li>
<li>Compression (for example, Gzip or Brotli) is not enabled by default</li>
<li>Proxy buffering settings are set to default values (you may want to modify these settings based on your workload and object size)</li>
</ul>
<h2>Configuring and Running the Gateway in Docker</h2>
<p>You can use both NGINX Open Source and NGINX Plus as the gateway to S3 or a compatible object store. </p>
<p>To use NGINX Open Source, start with the <a target="_blank" href="https://registry.hub.docker.com/_/nginx/" rel="noopener noreferrer">official NGINX image</a> from Docker Hub and the <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/blob/master/Dockerfile.oss" rel="noopener noreferrer"><strong>Dockerfile</strong></a> we provide on GitHub. Proceed to <a href="#nginx-configuration-file">Creating the NGINX Configuration File</a>.</p>
<p>Using <a href="https://www.nginx.com/products/nginx/">NGINX Plus</a> as the S3 API gateway has some compelling benefits:</p>
<ul>
<li><strong>Dynamic DNS resolution of upstreams using the NGINX Plus API</strong> – Whenever your S3 API domain changes its backing IP addresses, <a href="https://www.nginx.com/products/nginx/load-balancing/#load-balancing-api">NGINX reconfigures automatically</a> to use the new addresses. This is an important feature because Amazon S3 and other S3‑compatible APIs sometimes add or remove load balancers to better scale their system. When the NGINX configuration for upstreams is not reloaded after DNS changes, a service outage can result if all the backing IP address records are no longer valid.</li>
<li><strong>Reduced time and resource consumption using the key‑value store</strong> – When generating AWS Version 4 authentication signatures, a portion of the cryptographic signature (signing key) is valid and cacheable for up to 24 hours. By storing that part of the signature in the <a target="_blank" href="https://nginx.org/en/docs/http/ngx_http_keyval_module.html" rel="noopener noreferrer">key‑value store</a>, the overall time and CPU resources needed to compute an authentication request is reduced. This is a useful performance enhancement for use cases with a high volume of requests. For sample configuration of a related use case, see <a target="_blank" href="https://www.nginx.com/blog/nginx-plus-key-value-store-to-secure-ephemeral-ssl-keys-from-hashicorp-vault/#Configuring-the-NGINX-Plus-Key-Value-Store-for-SSL-Storage" rel="noopener noreferrer">Configuring the NGINX Plus Key‑Value Store for SSL Storage</a> on our blog.</li>
</ul>
<p>We do not distribute a Docker image for NGINX Plus, because the image needs to incorporate your NGINX Plus credentials.  Follow the instructions in the next section to build an NGINX Plus Docker image with the <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/blob/master/Dockerfile.plus" rel="noopener noreferrer"><strong>Dockerfile</strong></a> we provide, which includes settings for downloading the NGINX Plus binary. </p>
<h3>Building the NGINX Plus Gateway Docker Image</h3>
<p>To build the NGINX Plus Docker image, perform these steps:</p>
<ol>
<li>
<p>Clone the <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway" rel="noopener noreferrer">NGINX S3 Gateway project</a> from our GitHub repo:</p>
<pre><code><strong>git clone https://github.com/nginxinc/nginx-s3-gateway.git</strong></code></pre>
</li>
<li>
<p>Change directory to <span>nginx-s3-gateway</span>:</p>
<pre><code><strong>cd nginx-s3-gateway</strong></code></pre>
</li>
<li>
<p>Copy your NGINX Plus certificate and key (<span>nginx-repo.crt</span> and <span>nginx-repo.key</span>) to the <strong>plus/etc/ssl/nginx</strong> subdirectory. NGINX Plus customers can find them at the <a target="_blank" href="https://account.f5.com/myf5" rel="noopener noreferrer">F5 customer portal</a>; if you are doing a free trial of NGINX Plus, they were provided with your trial package.</p>
</li>
<li>
<p>Build the container image. We recommend using <a target="_blank" href="https://docs.docker.com/develop/develop-images/build_enhancements/" rel="noopener noreferrer">Docker BuildKit</a>, as it enables you to pass your NGINX Plus license files to the Docker build context without risk of exposing the data or having the data persist between Docker build layers.</p>
<ul>
<li>
<p>To build using BuildKit, run this command:</p>
<pre><code><strong>DOCKER_BUILDKIT=1 docker build -f Dockerfile.buildkit.plus -t nginx-plus-s3-gateway --secret id=nginx-crt,src=plus/etc/ssl/nginx/nginx-repo.crt --secret id=nginx-key,src=plus/etc/ssl/nginx/nginx-repo.key --squash .</strong></code></pre>
</li>
<li>
<p> To build without BuildKit, run this command:</p>
<pre><code><strong>docker build -f Dockerfile.plus -t nginx-plus-s3-gateway .</strong></code></pre>
</li>
</ul>
</li>
<li>
<p>Continue to <a href="#nginx-configuration-file&#34;">Creating the NGINX Configuration File</a>.</p>
</li>
</ol>
<h3 id="nginx-configuration-file">Creating the NGINX Configuration File</h3>
<p>To get started with running the gateway (either NGINX Open Source or NGINX Plus), you first need to create a configuration file with the settings for connecting NGINX with an S3 API upstream. You can find a <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/blob/master/settings.example" rel="noopener noreferrer">sample configuration file</a> in our GitHub repository. Let’s look at some sample configurations for different S3 API backends.</p>
<h4>Amazon S3</h4>
<p>Here is the configuration for using <a target="_blank" href="https://aws.amazon.com/pm/serv-s3/" rel="noopener noreferrer">Amazon S3</a> as the backend. We’re using AWS Signature Version 4  because AWS is deprecating Version 2.</p>
<pre><code>S3_BUCKET_NAME=my-bucket-name
S3_ACCESS_KEY_ID=PUBLICACCESSKEY4TEXT
S3_SECRET_KEY=ProtectThisPrivateKeyBecauseItIsASecret!
S3_SERVER=s3-us-west-2.amazonaws.com 
S3_SERVER_PORT=443 
S3_SERVER_PROTO=https 
S3_REGION=us-west-2
AWS_SIGS_VERSION=4
ALLOW_DIRECTORY_LIST=true</code></pre>
<h4>Wasabi</h4>
<p>Here is the configuration for using <a target="_blank" href="https://wasabi.com/" rel="noopener noreferrer">Wasabi</a> as the S3‑compliant backend. Here we are using AWS Signature Version 2 because Wasabi maintains support for that authentication method, and it generally performs better.</p>
<pre><code>S3_BUCKET_NAME=my-bucket-name
S3_ACCESS_KEY_ID=PUBLICACCESSKEY4TEXT
S3_SECRET_KEY=ProtectThisPrivateKeyBecauseItIsASecret!
S3_SERVER=s3.us-west-1.wasabisys.com
S3_SERVER_PORT=443
S3_SERVER_PROTO=https
S3_REGION=us-west-1
AWS_SIGS_VERSION=2
ALLOW_DIRECTORY_LIST=true</code></pre>
<h3>Starting Up the Gateway</h3>
<p>Once you have saved your configuration to a file (here it is <span>s3-settings.env</span> in the current directory), you are ready to start the gateway using Docker. </p>
<ul>
<li>
<p>To start the NGINX Open Source gateway in the foreground, run:</p>
<pre><code><strong>docker run -it --env-file ./s3-settings.env -p8080:80 nginxinc/nginx-s3-gateway</strong></code></pre>
</li>
<li>
<p>To start the NGINX Plus gateway in the foreground, run:</p>
<pre><code><strong>docker run -it --env-file ./s3-settings.env -p8080:80 nginx-plus-s3-gateway</strong></code></pre>
</li>
</ul>
<p>Once you have verified that the image is working as expected, you may want to push it to your organization’s private Docker repository so that it can be used more widely. But:</p>
<p><strong><em>Never upload your NGINX Plus images to a public repository such as Docker Hub. Doing so violates your license agreement.</em></strong></p>
<p>After NGINX starts up, you can access the gateway at <strong>http://localhost:8080</strong>.</p>
<h3>Customizing the Gateway</h3>
<p>After becoming comfortable with running the NGINX S3 gateway in the default configuration, you can explore extending its configuration for your specific needs. The base NGINX Docker image is configured to automatically load any <strong>*.conf</strong> files found in the <strong>/etc/nginx/conf.d</strong> directory, making it relatively easy to add configuration for additional features.</p>
<p>For example, you can store your configuration for the <a target="_blank" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" rel="noopener noreferrer">Gzip compression</a> module in a local directory under the path <strong>etc/nginx/conf.d/gzip_compression.conf</strong>. We provide a working example of customizing the NGINX S3 Gateway to work with Gzip compression in our <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/tree/master/examples/gzip-compression" rel="noopener noreferrer">GitHub repository</a>.</p>
<p>To add configuration of additional features:</p>
<ol>
<li>
<p>Create a configuration file for the feature you want to support, for example <strong>gzip_compression.conf</strong> in the local <strong>etc/nginx/conf.d/</strong> directory.</p>
</li>
<li>
<p>Add these lines to your <strong>Dockerfile</strong>, to automatically load any files with the <strong>.conf </strong>extension from the local <strong>etc/nginx/conf.d</strong> directory.</p>
<pre><code>FROM nginxinc/nginx-s3-gateway
COPY etc/nginx/conf.d /etc/nginx/conf.d</code></pre>
</li>
</ol>
<h3>Summary</h3>
<p>We have shown how to use NGINX as a caching gateway in front of a private bucket in Amazon S3 or another compatible object store. This not only reduces traffic to your object store, but also puts a layer of protection between it and the public Internet, preventing unwanted public discovery of its contents.</p>
<p>To get started with NGINX Open Source, download the <a target="_blank" href="https://registry.hub.docker.com/_/nginx/" rel="noopener noreferrer">official NGINX image</a> from Docker Hub and the <a target="_blank" href="https://github.com/nginxinc/nginx-s3-gateway/blob/master/Dockerfile.oss" rel="noopener noreferrer"><strong>Dockerfile</strong></a> we provide on GitHub.</p>
<p>To upgrade to NGINX Plus, start your <span><a href="https://www.nginx.com/free-trial-request">free 30-day trial</a></span> today or <a href="https://www.nginx.com/contact-sales/">contact us to discuss your use cases</a>.</p>
	</div></div>
  </body>
</html>
