<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/">Original</a>
    <h1>Can GPT optimize my taxes? An experiment in letting the LLM be the UX</h1>
    
    <div id="readability-page-1" class="page"><article>

    

    
      

    

    

    
<figure>
    
    
    
    
        <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/gilded-robot-accountant.webp" alt=""/>
        <figcaption><p>Generated using DALL-E.</p></figcaption>
    
</figure>

<p><strong><code>TL;DR</code></strong> We made a GPT interface to an open-source US tax scenarios library,
and it is at times pretty good, but asks a lot of the user.</p>
<hr/>
<p>Apparently this blog will be about working out implications of observations by
Andrej Karpathy. This time we‚Äôre thinking about <a href="https://www.youtube.com/watch?v=zjkBMFhNj_g&amp;t=2552s">his
comment</a> that LLMs may come
to be thought of as a kind of higher-order operating system: not omnicapable
themselves, but rather the glue that links together other components, such as
data stores, domain-specific libraries and user interfaces. Cam Pedersen wrote a
nice <a href="https://campedersen.com/llm-os/">post</a> spelling out the ideas more fully.</p>
<p>I thought it would be fun to build some concrete data product to explore this
LLM-as-OS idea, and contrast it with the existing state of the art. The idea: a
ways back I‚Äôd written a python library called
<a href="https://github.com/mmacpherson/tenforty"><code>tenforty</code></a>, that in turn uses a
wonderful open source package called <a href="https://opentaxsolver.sourceforge.net/">Open Tax
Solver</a>, to explore some tax scenarios
we were dealing with. I‚Äôd never written it up, and thought someday I‚Äôd make a
webapp from it to share. This seemed like a nice opportunity to try building
something as a newfangled LLM-OS app: an AI tax advisor.</p>
<p><code>tenforty</code> turns tax form calculations into python function calls, which makes
it easy to evaluate one return, or many hypothetical returns. This latter
<em>what-if</em> aspect was the main itch I was aiming to scratch with the library:
What if we sold this stock over two years rather than one? What would happen to
our tax bracket if we maxed out our 401Ks? To answer questions like this in
TurboTax felt Sisyphean; write down tax amount, back-back-back, tweak input,
forward-forward-forward, write down tax amount‚Ä¶<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> (There‚Äôs more about
<code>tenforty</code> <em>per se</em> in an <a href="#appendix-about-tenforty">appendix</a>.)</p>
<p>Before LLMs appeared, to build a webapp for these what-ifs, I might have
researched common tax scenarios beyond our own that <code>tenforty</code> could help with,
and built a kind of calculator app to anticipate those cases, perhaps like
<a href="https://smartasset.com/taxes">SmartAsset‚Äôs</a> tax overview page.</p>
<p>In 2024, if we let the LLM be the UX, then building the app becomes less, and
different, work. In some sense the user will just bring their own scenario, and
the app doesn‚Äôt need to anticipate it. These were the steps:</p>
<ol>
<li>Build a tiny web service that exposes the main functions from <code>tenforty</code> as
endpoints. We used <a href="https://fastapi.tiangolo.com/">FastAPI</a>.</li>
<li>Configure the custom GPT on OpenAI:
<ul>
<li>Come up with a name: <em>Tax Driver</em><sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup></li>
<li>Write the GPT‚Äôs prompt. We link a copy of it <a href="

  /posts/2024-03-10-tax-scenarios-with-ai/tax-driver-gpt-prompt.txt

">here</a>.</li>
<li>Configure a GPT ‚ÄúAction‚Äù that provides the details of the endpoints. Since
FastAPI autogenerates OpenAPI specifications
(<a href="https://tax-server.finedataproducts.com/openapi.json">ref</a>), this was
mainly pasting in that spec.</li>
<li>Write a few example prompts to illustrate the kinds of things it can do.</li>
<li>(Revise the GPT prompt to address unexpected behavior‚Ä¶ ü§¶üèº‚Äç‚ôÇÔ∏è)</li>
</ul>
</li>
</ol>
<p>If you have a paid ChatGPT+ account you can try out Tax Driver <a href="https://chat.openai.com/g/g-jkF9Et8tT-tax-driver">right
here</a>.  The privacy policy is
linked from the GPT, and also
<a href="https://tax-server.finedataproducts.com/privacy">here</a>; the upshot is that the
backing web service is set up as a pure calculator, and logs only which endpoint
was called, and when it was called by OpenAI‚Äôs servers. Note that independently
of ChatGPT+, you can also play with <code>tenforty</code> directly using the included
<a href="https://colab.research.google.com/github/mmacpherson/tenforty/blob/main/notebooks/tenforty_Package_Demo.ipynb">Colab
notebook</a>.</p>





<a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-start.png" data-lightbox="gallery" data-title="A robot tax advisor.">
    <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-start.png" alt="A robot tax advisor."/>
</a>



<h2 id="what-did-we-learn">What Did We Learn?</h2>
<p>Tax Driver does a bunch of things well:</p>
<ul>
<li>
<p>From minimal input, as in the example screenshot here, it reliably defers to
the Action to evaluate the scenario. We‚Äôve gotten used to GPT-4‚Äôs
natural-language abilities over the past year or so, but they really are
stunning. (<em>Note: images enlarge if clicked/tapped.</em>)</p>

  
  
  
  
  <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-short-term-long-term.png" data-lightbox="gallery" data-title="Tax Driver Example: Short-Term v Long-Term Capital Gains">
      <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-short-term-long-term.png" alt="Tax Driver Example: Short-Term v Long-Term Capital Gains"/>
  </a>
  

</li>
<li>
<p>It is game to at least try to evaluate essentially any tax scenario you might
find yourself faced with, combining its knowledge base with the specific
calculations enabled by <code>tenforty</code>. I would never have been able to match that
breadth with a set of canned scenario calculators. Here‚Äôs another example
that‚Äôs gone reasonably well, if one thinks of AMT as ‚Äúthe excess tax over the
regular tax due to the AMT calculation‚Äù as it‚Äôs sometimes <a href="https://www.investopedia.com/terms/a/alternativeminimumtax.asp">discussed
informally</a>.</p>
</li>
</ul>

 
 
 
 
 <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-iso-gain.png" data-lightbox="gallery" data-title="Tax Driver Example: Incentive Stock Option Gains">
     <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-iso-gain.png" alt="Tax Driver Example: Incentive Stock Option Gains"/>
 </a>
 

<ul>
<li>It can produce tables/graphics that summarize the results well:</li>
</ul>

 
 
 
 
 <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-area-proportion-plot.png" data-lightbox="gallery" data-title="Tax Driver Example: Incentive Stock Option Gains">
     <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-area-proportion-plot.png" alt="Tax Driver Example: Incentive Stock Option Gains"/>
 </a>
 

<ul>
<li>
<p>If asked, it will reliably produce apt python code using <code>tenforty</code> that you
can drop into a notebook and take from there.</p>

  
  
  
  
  <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-generate-python.png" data-lightbox="gallery" data-title="Tax Driver Example: Write Python Code">
      <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-generate-python.png" alt="Tax Driver Example: Write Python Code"/>
  </a>
  

</li>
</ul>
<p>Some of those capabilities are simply from the future, and some might have been
achievable by me or a team, only with much more work. And building this ‚Äúapp‚Äù
took a tiny fraction of the time it would have taken me to build its pre-LLM
analog.</p>
<p>But it can also be frustrating:</p>
<ul>
<li>
<p>It can just miss the point of a given scenario request, in that cheerfully
confident way GPT-4 has, like a politician not-answering a question at a town
hall. In this example, we‚Äôve asked for it to look at the tax burden if
everything was exercised in one year vs spread out over two or three years,
and Tax Driver misses the mark widely:</p>

  
  
  
  
  <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-missed-the-point.png" data-lightbox="gallery" data-title="Tax Driver Example: Missed The Point">
      <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-missed-the-point.png" alt="Tax Driver Example: Missed The Point"/>
  </a>
  

</li>
<li>
<p>It has a set of specific instructions to follow from its prompt, and it often
follows them, but also sometimes defies them, especially those having to do
with figure generation. For example, here‚Äôs a case in which we‚Äôve explicitly
asked for a <a href="https://en.wikipedia.org/wiki/Area_chart">shaded area chart</a>, in
addition to the instruction to prefer shaded area charts for plots like this
in its <a href="

  /posts/2024-03-10-tax-scenarios-with-ai/tax-driver-gpt-prompt.txt

">prompt</a>, and it claims
that it‚Äôs drawn one, but hasn‚Äôt:</p>

  
  
  
  
  <a href="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-fed-state-range-ny.png" data-lightbox="gallery" data-title="Tax Driver Example: Tax Table Plot">
      <img src="https://finedataproducts.com/posts/2024-03-10-tax-scenarios-with-ai/tax-driver-eg-fed-state-range-ny.png" alt="Tax Driver Example: Tax Table Plot"/>
  </a>
  

</li>
<li>
<p>It can be erratic. Run the same prompt twice, and once you will get reasonable
output, and the second time it will fail to successfully run an Action or
process the Action‚Äôs results. <em>No example shown.</em></p>
</li>
<li>
<p>It occasionally mixes up the Action calls, i.e. web requests, with python
calls to <code>tenforty</code>. <em>No example shown‚Äìthe output is generated python code,
when it ‚Äúshould‚Äù have called out to the Action and done something with the
response.</em></p>
</li>
</ul>
<p>These limitations are familiar to us by now. This lack of meta-cognition is a
big reason why this first generation of LLM-based products ‚Äì ChatGPT, Stable
Diffusion, GitHub Copilot ‚Äì are expressed as copilots, as opposed to say
autonomous assistants that can be relied upon to perform a task correctly. We
encountered the same issue in our <a href="https://finedataproducts.com/posts/2023-12-31-llm-based-metaanalysis/">previous
post</a>
about doing scientific literature meta-analysis with LLMs.</p>
<p>More broadly, as easy as it is to create this app, the universal chat interface
is the proverbial jack of all trades, master of none. It places a lot of the
burden on the user to know what they want, write out their requests carefully,
and exercise care in interpreting the results and iterating upon them. Simon
Willison made a connected point in a recent <a href="https://youtu.be/mOzxhcc1I8A?t=1108">podcast with
Outerbounds</a>: the generic chat interface
leaves much to be desired in terms of discoverability, and runs a high risk of
scaring off non-enthusiast prospective users.</p>
<p>The upshot: Tax Driver is a capable if mercurial assistant. At least playing
with our own actual tax scenarios, with a little patience and some coaching, it
produced solid analyses. I found it particularly helpful to ask it to generate
<code>tenforty</code> code that I could play with myself at the end of one of these chats.
That seems useful, compared to having to do that all oneself, but it requires a
fairly tolerant user, and is less surefooted that one ideally would hope for
from a tax advisor.</p>
<h2 id="acknowledgments">Acknowledgments</h2>
<p>Thanks kindly to Sarah Laskey for improving an earlier draft. All errors are
mine!</p>

<h2 id="appendix-about-tenforty">Appendix: About <code>tenforty</code></h2>
<p><a href="https://opentaxsolver.sourceforge.net/">Open Tax Solver</a> (OTS), the package
that <code>tenforty</code> relies on, is one of these gems of the internet. The OTS team
has published their software for more than twenty consecutive years now. It
provides implementations of the US 1040 form calculations, and the forms for
many states, including California and New York.</p>
<p>You can prepare your tax return either using OTS‚Äô provided GUI, or via a simple
text file format. In either case, OTS outputs the resulting return to another
text file, and can insert the output into the official tax form PDFs. It‚Äôs thus
a DIY, open source TurboTax that improves upon doing the calculations by hand.
Very cool.</p>
<p><code>tenforty</code> works by amalgamating the C language source code from OTS releases
into a single big source file, and then wrapping that source file as a cython
extension. Because OTS is fundamentally designed around reading and writing text
files (that contain tax return information), <code>tenforty</code> actually writes and
reads back text files in temporary directories behind the scenes, although only
python dicts and pandas dataframes are presented to the library user.</p>
<p>OTS‚Äôs text-file interface works in terms of tax line numbers, e.g. W-2 income
gets reported on Line 1 of the US 1040. Since only accountants and the very
determined will know the line numbers, OTS annotates them with their natural
names like ‚ÄúW-2 Income‚Äù in their GUI. To solve the same problem, I added a
higher-level interface to <code>tenforty</code>, that offers natural names for the familiar
tax-form quantities, e.g. <code>w2_income</code>. All available options are listed out in
the repo‚Äôs
<a href="https://github.com/mmacpherson/tenforty/blob/main/README.md">README</a>.</p>
<p>This higher-level interface will be limiting for some, because I only did the
fairly common quantities. For example, if you‚Äôve got a small business, there
will be some missing inputs. There are two ways around this:</p>
<ol>
<li>There‚Äôs a lower-level interface in <code>tenforty</code> as it stands, where you can
provide any of the line-level inputs as a python dictionary, the return will
be evaluated, and you‚Äôll get back a dictionary with all the line-level
outputs.</li>
<li><code>tenforty</code> is open-source, and people are encouraged to contribute PRs with
their improvements.</li>
</ol>
<p>The document
<a href="https://github.com/mmacpherson/tenforty/blob/main/DEVELOP.md"><code>DEVELOP.md</code></a>
goes into more detail about how the package works.</p>
<h3 id="limitations">Limitations</h3>
<p>Even though OTS goes back to the Bush II administration, I have only included
from 2017 through 2023 tax years into <code>tenforty</code>, and I‚Äôve only wrapped up
California (where we live), Massachusetts, and New York, although OTS supports
more states. More years/states/etc. can be added by PR.</p>
<h3 id="testing">Testing</h3>
<p>There are some basic unit tests in place, and then some property-based tests
using the <a href="https://hypothesis.readthedocs.io">hypothesis</a> library, that exercise
<code>tenforty</code>/OTS by generating a wide variety of inputs and checking that certain
properties hold, e.g. ‚ÄúIf your W-2 income goes up, and nothing else changes,
your total tax must always be the same or higher.‚Äù</p>
<p>I further verified that our own externally-prepared returns from the past few
years give the same answers through <code>tenforty</code>. Not a big $n$, but in principle
a larger test set of reference return calculations might be built up.</p>
<p>This is to say, there‚Äôs a good-faith effort to test the package, but the testing
game could certainly be improved. PRs welcome. :)</p>


    
      

    

</article></div>
  </body>
</html>
