<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://du.nkel.dev/blog/2024-02-10_keycloak-docker-compose-nginx/">Original</a>
    <h1>Keycloak SSO with Docker Compose and Nginx</h1>
    
    <div id="readability-page-1" class="page"><div role="main">




<p>Published: 2024-02-11, Revised: 2024-02-11</p>
<hr/>


<p><img alt="nextcloud_bg" src="https://du.nkel.dev/blog/img/keycloak_fog_sf.webp"/></p>
<hr/>
<p><strong><abbr title="Too long; didn&#39;t read.">TL;DR</abbr></strong> I always hesitated to deploy an extra tool for user management and <abbr title="Single Sign-On">SSO</abbr>, but the current state of the web makes it very difficult to keep up with security, CVEs etc. Why not trust one of the longest standing solutions for identity and access management? Keycloak is open source, interoperable with major SSO protocols (<code>OpenID Connect (OIDC), OAuth 2.0, SAML</code>), and robust. The setup with docker compose is not complicated, but it was not straight forward either. This is why I provide a summary of the process below. </p>
<div>
<p>Info</p>
<p>This is currently a stub. I thought I would share my <code>docker-compose.yml</code> and <code>nginx.conf</code> quickly and update the post later to add steps for theming and integration.</p>
</div>
<h2 id="concept">Concept<a href="#concept" title="Permanent link">#</a></h2>
<p>You may have seen the concept below already in my <a href="https://du.nkel.dev/blog/2023-12-12_mastodon-docker-rootless/">previous post</a> about Mastodon. We will use a standard setup of nginx as a central reverse proxy that forwards traffic through localhost to individual services, all running in their own rootless docker namespaces. I consider this the typical economical setup, by sharing resources of a single host but with maximally isolated environments. Adapt where this does not fit your usecase.</p>
<pre>

                                                      Web
                                                       |
                                                       |
                                                  0.0.0.0:80
                                                  0.0.0.0:443
+------------------------------------------------------+-----------------------------------------------------+
|                                                      |                                                     |
|                                                      v                                                     |
|                +------------------------------- nginx/acme -----------------------------+                  |
|                |                                     |                                  |                  |
|        http://127.0.0.1:3000                         |                                  |                  |
|        http://127.0.0.1:4000                http://127.0.0.1:8080              http://127.0.0.1:9999       |
| +--------------+---------------+      +--------------+---------------+    +-------------+----------------+ |
| |              |               |      |              |               |    |             |                | |
| |   Rootless Docker Service    |      |   Rootless Docker Service    |    |   Rootless Docker Service    | |
| |    +---------+----------+    |      |    +---------+----------+    |    |    +--------+-----------+    | |
| |    |         |          |    |      |    |         |          |    |    |    |        |           |    | |
| |    |         v          |    |      |    |         v          |    |    |    |        v           |    | |
| |    |  Mastdon Docker    |    |      |    |  Keycloak Docker   |    |    |    |  Nextcloud Docker  |    | |
| |    |                    |    |      |    |                    |    |    |    |                    |    | |
| |    |                    |    |      |    |                    |    |    |    |                    |    | |
| |    +--------------------+    |      |    +--------------------+    |    |    +--------------------+    | |
| |                              |      |                              |    |                              | |
| +------------------------------+      +------------------------------+    +------------------------------+ |
|                                                                                                            |
+------------------------------------------------------------------------------------------------------------+

</pre>

<h2 id="preparations">Preparations<a href="#preparations" title="Permanent link">#</a></h2>
<p>You will need some basic tools:</p>
<ul>
<li>SSH</li>
<li>A <abbr title="Virtual Machine">VM</abbr> with Linux (Ubuntu; Debian etc.)</li>
<li>A domain or subdomain where you can add an <code>A</code> (and optionally <code>AAAA</code>) record for your service</li>
</ul>
<p>Follow the <a href="https://du.nkel.dev/blog/2023-12-12_mastodon-docker-rootless/#docker-rootless-setup">Mastodon post</a> for basic setup of docker rootless to:</p>
<ul>
<li>create a new non-root user named <code>keycloak</code>, without password, with its home directory set to <code>/srv/keycloak</code></li>
<li>update <code>/etc/subuid</code> and <code>/etc/subgid</code> ranges with user <code>keycloak</code> (because e.g. the postgres container will need these to create a nested non-root user itself)</li>
<li>install docker rootless through <code>dockerd-rootless-setuptool.sh</code> and configure automatic service start for the <code>keycloak</code> user</li>
</ul>
<h2 id="keycloak-setup">Keycloak Setup<a href="#keycloak-setup" title="Permanent link">#</a></h2>
<p>Login to the newly created <code>keycloak</code> user.</p>
<div><pre><span></span><code>machinectl<span> </span>shell<span> </span>keycloak@
</code></pre></div>
<div>
<p>Warning</p>
<p>We need to use <code>machinectl</code> to login, otherwise 
<code>XDG_RUNTIME_DIR</code> environment variables will not be available.
Do not use (e.g.) <code>sudo -u keycloak -H bash</code>. </p>
</div>
<p>Create directories for persistent data (<code>data/postgres16</code>) and the docker files.
</p><div><pre><span></span><code><span>cd</span><span> </span>~<span> </span><span>\</span>
<span>  </span><span>&amp;&amp;</span><span> </span>mkdir<span> </span>-p<span> </span>data/postgres16<span> </span><span>\</span>
<span>  </span><span>&amp;&amp;</span><span> </span>mkdir<span> </span>docker<span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span>docker
</code></pre></div>

<h3 id="docker-composeyml">docker-compose.yml<a href="#docker-composeyml" title="Permanent link">#</a></h3>
<p>The official docs provide some information here <sup id="fnref:1"><a href="#fn:1">1</a></sup>. But they use <code>docker run</code>, which would be unusual in production.</p>
<p>Going to a compose file is not complicated and allows us to have a more reproducable setup. There are some example <code>docker-compose.yml</code>s available, such as <sup id="fnref:2"><a href="#fn:2">2</a></sup>, <sup id="fnref:3"><a href="#fn:3">3</a></sup> or <sup id="fnref:4"><a href="#fn:4">4</a></sup>.</p>
<p>We will start with a <code>docker-compose.yml</code> that directly uses <a href="https://quay.io/repository/keycloak/keycloak?tab=tags&amp;tag=latest">the official keycloak image</a>. This can be changed later.</p>
<div><pre><span></span><code>version:<span> </span><span>&#39;3&#39;</span>

services:
<span>  </span>postgres_db:
<span>      </span>image:<span> </span>postgres:16
<span>      </span>volumes:
<span>        </span>-<span> </span>/srv/keycloak/data/postgres16:/var/lib/postgresql/data
<span>      </span>environment:
<span>        </span>POSTGRES_DB:<span> </span>keycloak
<span>        </span>POSTGRES_USER:<span> </span><span>${</span><span>POSTGRES_USER</span><span>:-</span><span>keycloak</span><span>}</span>
<span>        </span>POSTGRES_PASSWORD:<span> </span><span>${</span><span>POSTGRES_PASSWORD</span><span>:-</span><span>eX4mP13p455w0Rd</span><span>}</span>

<span>  </span>keycloak:
<span>      </span>#<span> </span>build:<span> </span>.
<span>      </span>image:<span> </span>quay.io/keycloak/keycloak:23.0.6
<span>      </span>environment:
<span>        </span>KC_LOG_LEVEL:<span> </span>debug
<span>        </span>KC_DB:<span> </span>postgres
<span>        </span>KC_DB_URL:<span> </span><span>&#39;jdbc:postgresql://postgres_db/keycloak&#39;</span>
<span>        </span>KC_DB_USERNAME:<span> </span><span>${</span><span>POSTGRES_USER</span><span>:-</span><span>keycloak</span><span>}</span>
<span>        </span>KC_DB_PASSWORD:<span> </span><span>${</span><span>POSTGRES_PASSWORD</span><span>:-</span><span>eX4mP13p455w0Rd</span><span>}</span>
<span>        </span>KC_DB_SCHEMA:<span> </span>public
<span>        </span>KC_HOSTNAME:<span> </span><span>${</span><span>KC_HOSTNAME</span><span>:-</span><span>your</span><span>.tld.com</span><span>}</span>
<span>        </span>KC_HOSTNAME_STRICT_HTTPS:<span> </span>true
<span>        </span>KC_HOSTNAME_STRICT:<span> </span>true
<span>        </span>KC_PROXY:<span> </span>edge
<span>        </span>HTTP_ADDRESS_FORWARDING:<span> </span>true
<span>        </span>KEYCLOAK_ADMIN:<span> </span>admin
<span>        </span>KEYCLOAK_ADMIN_PASSWORD:<span> </span><span>${</span><span>KEYCLOAK_ADMIN_PASSWORD</span><span>:-</span><span>eX4mP13p455w0Rd</span><span>}</span>
<span>      </span>#<span> </span>command:<span> </span>start<span> </span>--optimized
<span>      </span>ports:
<span>        </span>-<span> </span><span>&#39;127.0.0.1:8080:8080&#39;</span>
<span>      </span>depends_on:
<span>        </span>-<span> </span>postgres_db
</code></pre></div>
<p>Create an <code>.env</code> file with your sensitive and variable information:</p>

<p>Contents (change passwords):</p>
<div><pre><span></span><code><span># DB Password</span>
<span>POSTGRES_PASSWORD</span><span>=</span>eX4mP13p455w0Rd

<span># admin password</span>
<span>KEYCLOAK_ADMIN_PASSWORD</span><span>=</span>eX4mP13p455w0Rd

<span># domain</span>
<span>KC_HOSTNAME</span><span>=</span>your.tld.com
</code></pre></div>
<p>The relevant documentation of all these variables can be found here <sup id="fnref:5"><a href="#fn:5">5</a></sup>.</p>
<div>
<p>Note</p>
<p>Optionally initialize a <code>.git</code> repository in <code>~/docker</code> now, create a <code>.gitignore</code> and add <code>.env</code> to it, and commit the <code>docker-compose.yml</code>, for tracking changes.</p>
</div>
<details>
<summary>Some explanations for the <code>docker-compose.yml</code> above</summary>
<ul>
<li><code>&#39;127.0.0.1:8080:8080&#39;</code> and <code>KC_PROXY: edge</code> will make keycloak listen on localhost</li>
<li>the syntax for env variables (<code>${KC_HOSTNAME:-your.tld.com}</code>) means:</li>
<li>note (e.g.) that we do not set <code>KC_DB_USERNAME</code>, which means: <em>use the default</em>  </li>
<li><code>image: quay.io/keycloak/keycloak:23.0.6</code> references a specific  image tag, as is     suggested for production (only use <code>:latest</code> for development).</li>
<li><code>KC_LOG_LEVEL: debug</code> can be commented out once we are done with development</li>
<li>bind-mount the persistent postgres data from the subfolder created earlier in the     user&#39;s home directory:
  <div><pre><span></span><code>services:
<span>  </span>postgres_db:
<span>    </span>image:<span> </span>postgres:16
<span>    </span>volumes:
<span>      </span>-<span> </span>/srv/keycloak/data/postgres16:/var/lib/postgresql/data
</code></pre></div></li>
<li>if you want to start over from scratch, simply delete this postgres folder and it     will be re-initialized on next startup:
  <div><pre><span></span><code>CTRL+D
sudo<span> </span>rm<span> </span>-rf<span> </span>/srv/keycloak/data/postgres16
sudo<span> </span>machinectl<span> </span>shell<span> </span>keycloak@
<span>cd</span><span> </span>~<span> </span><span>&amp;&amp;</span><span> </span>mkdir<span> </span>-p<span> </span>data/postgres16
</code></pre></div></li>
<li><code>/srv/keycloak/data/postgres16</code> holds the persistent data that would need periodic     backups</li>
</ul>
</details>
<h2 id="test-locally">Test locally<a href="#test-locally" title="Permanent link">#</a></h2>
<p>At this stage, we can test the docker compose stack:
</p><div><pre><span></span><code>docker<span> </span>compose<span> </span>up<span> </span>-d<span> </span><span>&amp;&amp;</span><span> </span>docker<span> </span>compose<span> </span>logs<span> </span>--follow
</code></pre></div>
<p>Afterwards, create a reverse SSH tunnel to your VM and the keycloak local port.
</p><div><pre><span></span><code>ssh<span> </span>you@111.11.11.11<span> </span>-L<span> </span>:8080:127.0.0.1:8080<span> </span>-p<span> </span><span>22</span><span> </span>-N<span> </span>-v
</code></pre></div>
<p>Open <code>127.0.0.1:8080</code> in your browser and you should be greeted with the keycloak welcome screen:
<img alt="keycloak_local" src="https://du.nkel.dev/blog/img/keycloak_local.webp"/></p>
<h2 id="nginx">nginx<a href="#nginx" title="Permanent link">#</a></h2>
<p>Logout from the keycloak user with <kbd>CTRL+D</kbd>.</p>
<p>Follow the <a href="https://du.nkel.dev/blog/2023-12-12_mastodon-docker-rootless/#nginx-reverse-proxy-setup">Mastodon post</a> for setup of nginx as a system reverse proxy.</p>
<p>Create a new nginx <code>.conf</code> for the keycloak service.</p>
<div>
<p>Note</p>
<p>From here on, wherever you see <code>your.tld.com</code>: replace with your actual domain.</p>
</div>
<div>
<p>Note</p>
<p>At this stage, you should head to your domain registrar and add an <code>A</code> record to forward DNS queries to your VM&#39;s IP.</p>
</div>
<div><pre><span></span><code>nano<span> </span>/etc/nginx/sites-available/your.tld.com.conf
ln<span> </span>-s<span> </span>/etc/nginx/sites-available/your.tld.com.conf<span> </span>/etc/nginx/sites-enabled/
</code></pre></div>
<p>We can find some relevant information in the keycloak docs <sup id="fnref:6"><a href="#fn:6">6</a></sup>.</p>
<div>
<p>Info</p>
<p>I recommend to use the Mozilla SSL configurator to generate best practice defaults for nginx <sup id="fnref:7"><a href="#fn:7">7</a></sup>. Make sure to update with your nginx version (<code>nginx -v</code>).</p>
</div>
<div><pre><span></span><code><span>server</span><span> </span><span>{</span>
<span>    </span><span>if</span><span> </span><span>(</span><span>$host</span><span> </span><span>=</span><span> </span><span>your.tld.com)</span><span> </span><span>{</span>
<span>        </span><span>return</span><span> </span><span>301</span><span> </span><span>https://</span><span>$host$request_uri</span><span>;</span>
<span>    </span><span>}</span><span> </span><span># managed by Certbot</span>


<span>    </span><span>listen</span><span> </span><span>80</span><span>;</span>
<span>    </span><span>listen</span><span> </span><span>[::]:80</span><span>;</span>
<span>    </span><span>server_name</span><span> </span><span>your.tld.com</span><span>;</span>
<span>    </span><span>location</span><span> </span><span>/</span><span> </span><span>{</span><span> </span><span>return</span><span> </span><span>301</span><span> </span><span>https://</span><span>$host$request_uri</span><span>;</span><span> </span><span>}</span>
<span>}</span>

<span>server</span><span> </span><span>{</span>
<span>    </span><span>listen</span><span> </span><span>443</span><span> </span><span>ssl</span><span> </span><span>http2</span><span>;</span>
<span>    </span><span>listen</span><span> </span><span>[::]:443</span><span> </span><span>ssl</span><span> </span><span>http2</span><span>;</span>
<span>    </span><span>server_name</span><span> </span><span>your.tld.com</span><span>;</span>

<span>    </span><span>ssl_session_timeout</span><span> </span><span>1d</span><span>;</span>
<span>    </span><span>ssl_session_cache</span><span> </span><span>shared:MozSSL:10m</span><span>;</span><span>  </span><span># about 40000 sessions</span>
<span>    </span><span>ssl_session_tickets</span><span> </span><span>off</span><span>;</span>

<span>    </span><span># curl https://ssl-config.mozilla.org/ffdhe2048.txt &gt; /path/to/dhparam</span>
<span>    </span><span>ssl_dhparam</span><span> </span><span>/etc/nginx/dhparam/dhparam</span><span>;</span>

<span>    </span><span># intermediate configuration</span>
<span>    </span><span>ssl_protocols</span><span> </span><span>TLSv1.2</span><span> </span><span>TLSv1.3</span><span>;</span>
<span>    </span><span>ssl_ciphers</span><span> </span><span>ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305</span><span>;</span>
<span>    </span><span>ssl_prefer_server_ciphers</span><span> </span><span>off</span><span>;</span>

<span>    </span><span># HSTS (ngx_http_headers_module is required) (63072000 seconds)</span>
<span>    </span><span>add_header</span><span> </span><span>Strict-Transport-Security</span><span> </span><span>&#34;max-age=63072000&#34;</span><span> </span><span>always</span><span>;</span>

<span>    </span><span># OCSP stapling</span>
<span>    </span><span>ssl_stapling</span><span> </span><span>on</span><span>;</span>
<span>    </span><span>ssl_stapling_verify</span><span> </span><span>on</span><span>;</span>

<span>    </span><span># verify chain of trust of OCSP response using Root CA and Intermediate certs</span>
<span>    </span><span># ssl_trusted_certificate /etc/letsencrypt/live/your.tld.com/chain.pem;</span>

<span>    </span><span>access_log</span><span> </span><span>/var/log/nginx/your.tld.com-access.log</span><span>;</span>
<span>    </span><span>error_log</span><span> </span><span>/var/log/nginx/your.tld.com-error.log</span><span>;</span>

<span>    </span><span>location</span><span> </span><span>/</span><span> </span><span>{</span>

<span>        </span><span>proxy_set_header</span><span> </span><span>Host</span><span> </span><span>$host</span><span>;</span>
<span>        </span><span>proxy_set_header</span><span> </span><span>X-Real-IP</span><span> </span><span>$remote_addr</span><span>;</span>
<span>        </span><span>proxy_set_header</span><span> </span><span>X-Forwarded-For</span><span> </span><span>$proxy_add_x_forwarded_for</span><span>;</span>
<span>        </span><span>proxy_set_header</span><span> </span><span>X-Forwarded-Proto</span><span> </span><span>$scheme</span><span>;</span>
<span>        </span><span>proxy_pass</span><span> </span><span>http://127.0.0.1:8080</span><span>;</span>

<span>        </span><span># the following headers are needed, if your application uses redirection flow to authenticate with Keycloak.</span>
<span>        </span><span># replace http://127.0.0.1:8080 with the application server url</span>
<span>        </span><span># add_header Content-Security-Policy &#34;frame-src *; frame-ancestors *; object-src *;&#34;;</span>
<span>        </span><span># add_header Access-Control-Allow-Origin &#39;http://127.0.0.1:8080&#39;; </span>
<span>        </span><span># add_header Access-Control-Allow-Credentials true;</span>

<span>    </span><span>}</span>


<span>    </span><span># ssl_certificate /etc/letsencrypt/live/your.tld.com/fullchain.pem; # managed by Certbot</span>
<span>    </span><span># ssl_certificate_key /etc/letsencrypt/live/your.tld.com/privkey.pem; # managed by Certbot</span>
<span>}</span>
</code></pre></div>
<p>Test the configuration and reload nginx.</p>
<div><pre><span></span><code>nginx<span> </span>-t
systemctl<span> </span>reload<span> </span>nginx
</code></pre></div>
<p>Use <code>certbot</code> to request SSL certificates for your service.</p>
<div><pre><span></span><code>certbot<span> </span>--nginx<span> </span>-d<span> </span>your.tld.com
</code></pre></div>
<p>This will automatically update necessary lines in <code>your.tld.com.conf</code>.</p>
<p>Edit <code>your.tld.com.conf</code> and uncomment <code>ssl_trusted_certificate</code>.</p>
<div><pre><span></span><code><span># verify chain of trust of OCSP response using Root CA and Intermediate certs</span>
ssl_trusted_certificate<span> </span>/etc/letsencrypt/live/your.tld.com/chain.pem<span>;</span>
</code></pre></div>
<p>Reload nginx</p>

<h2 id="debug">Debug<a href="#debug" title="Permanent link">#</a></h2>
<p>You can now open <code>your.tld.com</code> and login to keycloak using the <code>admin</code> user with the password from the <code>.env</code> file.</p>
<p>For debugging, the first stop are the docker compose logs.</p>
<div><pre><span></span><code>docker<span> </span>compose<span> </span>logs<span> </span>--follow
</code></pre></div>
<p>For nginx, follow the access and error logs.</p>
<div><pre><span></span><code>tail<span> </span>-f<span> </span>/var/log/nginx/your.tld.com-access.log<span>;</span>
tail<span> </span>-f<span> </span>/var/log/nginx/your.tld.com-error.log<span>;</span>
</code></pre></div>
<p>If you need to have a look at the keycloak database.</p>
<div><pre><span></span><code>machinectl<span> </span>shell<span> </span>keycloak@
<span>cd</span><span> </span>~/docker
docker<span> </span>compose<span> </span><span>exec</span><span> </span>postgres_db<span> </span>/bin/bash
psql<span> </span>-h<span> </span>localhost<span> </span>-p<span> </span><span>5432</span><span> </span>-U<span> </span>keycloak<span> </span>keycloak
SELECT<span> </span>...<span>;</span>
</code></pre></div>
<h2 id="custom-build-with-dockerfile">Custom build with Dockerfile<a href="#custom-build-with-dockerfile" title="Permanent link">#</a></h2>
<p>So far, we are using the prebuild image from quay.io.</p>
<p>For any customization, e.g. in order to use themes and run the keycloak container in <code>--optimized</code> mode <sup id="fnref:8"><a href="#fn:8">8</a></sup>, we need to build our own image.</p>
<p>We will utilize a multi-stage docker build <sup id="fnref:9"><a href="#fn:9">9</a></sup> starting with the official quay.io image.</p>
<p>Add a Dockerfile</p>
<div><pre><span></span><code><span>cd</span><span> </span>~/docker
nano<span> </span>Dockerfile
</code></pre></div>
<p>.. with the following content.</p>
<div><pre><span></span><code><span>FROM</span><span> </span><span>quay.io/keycloak/keycloak:23.0.6</span><span> </span><span>as</span><span> </span><span>builder</span>

<span># Configure a database vendor</span>
<span>ENV</span><span> </span><span>KC_DB</span><span>=</span>postgres

<span>WORKDIR</span><span> </span><span>/opt/keycloak</span>
<span># COPY --from=keycloakify_jar_builder /opt/app/build_keycloak/target/ keycloakify-starter-keycloak-theme-5.1.3.jar /opt/keycloak/providers/</span>
<span>RUN</span><span> </span>/opt/keycloak/bin/kc.sh<span> </span>build

<span>FROM</span><span> </span><span>quay.io/keycloak/keycloak:23.0.6</span>
<span>COPY</span><span> </span>--from<span>=</span>builder<span> </span>/opt/keycloak/<span> </span>/opt/keycloak/

<span># Add ENTRYPOINT</span>
<span>ENTRYPOINT</span><span> </span><span>[</span><span>&#34;/opt/keycloak/bin/kc.sh&#34;</span><span>]</span>
</code></pre></div>
<p>Afterwards, edit the <code>docker-compose.yml</code>:  </p>
<ul>
<li>remove or comment out the <code>image:</code> line  </li>
<li>uncomment <code>build: .</code>  </li>
<li>add <code>command: start --optimized</code>  </li>
</ul>
<details>
<summary>Final <code>docker-compose.yml</code></summary>
<div><pre><span></span><code>version:<span> </span><span>&#39;3&#39;</span>
<span>
</span><span>services:
</span><span>  </span>postgres_db:
<span>      </span>image:<span> </span>postgres:16
<span>      </span>volumes:
<span>        </span>-<span> </span>/srv/keycloak/data/postgres16:/var/lib/postgresql/data
<span>      </span>environment:
<span>        </span>POSTGRES_DB:<span> </span>keycloak
<span>        </span>POSTGRES_USER:<span> </span><span>${</span><span>POSTGRES_USER</span><span>:-</span><span>keycloak</span><span>}</span>
<span>        </span>POSTGRES_PASSWORD:<span> </span><span>${</span><span>POSTGRES_PASSWORD</span><span>:-</span><span>eX4mP13p455w0Rd</span><span>}</span>

<span>  </span>keycloak:
<span>      </span>build:<span> </span>.
<span>      </span>environment:
<span>        </span>KC_LOG_LEVEL:<span> </span>debug
<span>        </span>KC_DB:<span> </span>postgres
<span>        </span>KC_DB_URL:<span> </span><span>&#39;jdbc:postgresql://postgres_db/keycloak&#39;</span>
<span>        </span>KC_DB_USERNAME:<span> </span><span>${</span><span>POSTGRES_USER</span><span>:-</span><span>keycloak</span><span>}</span>
<span>        </span>KC_DB_PASSWORD:<span> </span><span>${</span><span>POSTGRES_PASSWORD</span><span>:-</span><span>eX4mP13p455w0Rd</span><span>}</span>
<span>        </span>KC_DB_SCHEMA:<span> </span>public
<span>        </span>KC_HOSTNAME:<span> </span><span>${</span><span>KC_HOSTNAME</span><span>:-</span><span>your</span><span>.tld.com</span><span>}</span>
<span>        </span>KC_HOSTNAME_STRICT_HTTPS:<span> </span>true
<span>        </span>KC_HOSTNAME_STRICT:<span> </span>true
<span>        </span>KC_PROXY:<span> </span>edge
<span>        </span>HTTP_ADDRESS_FORWARDING:<span> </span>true
<span>        </span>KEYCLOAK_ADMIN:<span> </span>admin
<span>        </span>KEYCLOAK_ADMIN_PASSWORD:<span> </span><span>${</span><span>KEYCLOAK_ADMIN_PASSWORD</span><span>:-</span><span>eX4mP13p455w0Rd</span><span>}</span>
<span>      </span>command:<span> </span>start<span> </span>--optimized
<span>      </span>ports:
<span>        </span>-<span> </span><span>&#39;127.0.0.1:8080:8080&#39;</span>
<span>      </span>depends_on:
<span>        </span>-<span> </span>postgres_db
</code></pre></div>
</details>
<p>Restart the docker stack afterwards with</p>
<div><pre><span></span><code>docker<span> </span>compose<span> </span>down
<span># optional explicit build step</span>
docker<span> </span>compose<span> </span>build
docker<span> </span>compose<span> </span>up<span> </span>-d<span> </span><span>&amp;&amp;</span><span> </span>docker<span> </span>compose<span> </span>logs<span> </span>--follow
</code></pre></div>
<p>This will build the image and start the service.</p>
<h2 id="conclusions">Conclusions<a href="#conclusions" title="Permanent link">#</a></h2>
<p>We are now running a keycloak service in rootless docker behind our system nginx reverse proxy, which does the SSL termination for us.</p>
<p>For automatic updates of the docker container, see the <a href="https://du.nkel.dev/blog/2023-12-12_mastodon-docker-rootless/#automatic-updates">Mastodon post</a>.</p>
<p>The next step would be logging in to the keycloak services and adding
an email under <code>https://your.tld.com/admin/master/console/#/master/realm-settings/email</code>.</p>
<p>Next comes (e.g.) adding a realm. Then theming, which can be done with keycloakify <sup id="fnref:10"><a href="#fn:10">10</a></sup>.</p>
<p>You can see that I already added the necessary lines to the Dockerfile:
</p><div><pre><span></span><code><span># COPY --from=keycloakify_jar_builder /opt/app/build_keycloak/target/ keycloakify-starter-keycloak-theme-5.1.3.jar /opt/keycloak/providers/</span>
</code></pre></div>
<p>If you find improvements to the instructions above, please add in the comments section!</p>



<hr/>

</div></div>
  </body>
</html>
