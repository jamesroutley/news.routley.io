<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://aaaa.sh/creatures/dda-algorithm-interactive">Original</a>
    <h1>The DDA Algorithm, explained interactively</h1>
    
    <div id="readability-page-1" class="page"><article>
            
            <p>I&#39;ve written a number of voxel raytracers, and all of them (all the good ones, at least) use the <a href="https://en.wikipedia.org/wiki/Digital_differential_analyzer_(graphics_algorithm)">Digital Differential Analyzer Algorithm</a> for raycasting. I&#39;ve only ever &#34;implemented&#34; this algorithm once, by copying a reference somewhere. Since then, I&#39;ve used and re-used that code. But I have something to admit: I&#39;ve never really understood how it works. I&#39;ve seen it <a href="https://lodev.org/cgtutor/raycasting.html" target="_blank">explained well</a>, <a href="https://www.geeksforgeeks.org/dda-line-generation-algorithm-computer-graphics/" target="_blank">explained poorly</a>, <a href="https://youtu.be/NbSee-XM7WA" target="_blank">explained on video</a>, and still, I just don&#39;t get it. It&#39;s one of those geometric algorithms that&#39;s hard to wrap your head around, at least for me. But recently, I ran into some issues with a raytracer, and I decided to try to fully understand it. And I made this blog post, for others like me.</p>
            <p><i>All code in this article is editable. Examples will update as you modify them.</i></p>
            <p>DDA, in 2D, is an algorithm that iterates over all of the grid squares intersected by a ray. For those who haven&#39;t seen the algorithm, it looks like this:</p>
            
            <p>If you understand the above, have a nice day :) If not, this article has an explanation.</p>
            <p><a target="_blank" href="https://www.youtube.com/c/3blue1brown">3Blue1Brown</a> teaches us that a good way to to explain something is to derive it from scratch. So how would you derive this line drawing algorithm? First, we&#39;ve got our arguments: the <strong>Ray Origin <code>ro</code></strong>, and <strong>Ray Direction <code>rd</code></strong>. RD has to be normalized. In this article, we calculate it using an angle, like this:</p>
            
            <p>Let&#39;s plot those on a grid.</p>
            

            <p>The first grid space we need to fill in is pretty simple–it&#39;s the grid space that <code>ro</code> is in. We can floor ro to get the exact integer space.</p>
            
            <p>Not super exciting, but an <span onclick="window.open(&#39;https://youtu.be/NRNiOpoZHV4&amp;t=16/&#39;)">important step</span>.</p>
            <p>Now, we have to figure out what the <i>next</i> grid space is. See if you can guess the answer: move the point and the arrow above and guess where the next grid space would be.</p>

            <p>At first glance, you might think it has something to do with <code>rdAngle</code>, like if the angle is facing up, then the grid space above the dot should be filled in, if the angle is facing to the right, the one to the right should be filled in, etc.</p>
            
            
            <p>
            But if you , you&#39;ll notice that this quickly falls apart.
            </p>
            <p>
            We need to take into account the distance from the origin point to the different grid squares. If you&#39;ve spent some time recently with geometry or a graphing calculator, you might already have figured out that this is actually a <i>line intersection</i> problem. If you , you can see that the ro-&gt;rd vector intersects with the lines x = 1 and y = 1. (In this article, we are assuming the center of the grid is the origin.) Let&#39;s put those intersections on the screen:
            </p>
            
            
            <p>The yellow dot is the intersection between ro-&gt;rd and y = 1, and the green dot is the intersection between ro-&gt;rd and x = 1.</p>
            <p>
                Now, let&#39;s call the <i>distance</i> between ro and the yellow dot lengthY.
            </p>
            
            <p>Similarly, we can call the distance between ro and green dot lengthX.</p>
            
            <p>Now see that when lengthX is <i>less</i> than lengthY, the raycasting line intersects x = 1 <i>before</i> it intersects y = 1, so the next grid space is the one to the right. Similarly, when lengthY is less than lengthX, the raycasting line intersects y = 1 before it intersects x = 1, so the next grid space is the one above.</p>
            
            <p>Great! We&#39;ve taken our <span onclick="window.open(&#39;https://www.youtube.com/watch?v=YehZRWg14HA&#39;)">first steps</span>. Before we move to three squares (can you imagine?!), let&#39;s talk about that intersection code.</p>
            <p>Importantly, we don&#39;t actually need to calculate the intersection points. We only need lengthX and lengthY, which are both distances. For those, we can consult Pythagoras. If we imagine the yellow line above as the diagonal of a right triangle, we can calculate its length using its legs, drawn below as pink and blue.</p>
            <p>Also note that we&#39;re going to be using ro = {0,0} for a little while, for simplicity&#39;s sake :&#39;)</p>
            
            
            <p>The length of the pink line is just 1.</p>
            
            <p>We can calculate the color of the blue line with some basic algebra. We want to find the point where the yellow line (presented in <a href="https://en.wikipedia.org/wiki/Linear_equation#Slope%E2%80%93intercept_form_or_Gradient-intercept_form">Slope-intercept form mx+b</a>) intersects y = 1.</p>
            <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>m</mi><mi>x</mi><mo>+</mo><mi>b</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>1</mn></mrow></mstyle></mtd><mtd></mtd><mtd></mtd></mtr><mtr><mtd></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi>r</mi><msub><mi>d</mi><mi>y</mi></msub></mrow><mrow><mi>r</mi><msub><mi>d</mi><mi>x</mi></msub></mrow></mfrac><mi>x</mi><mo>+</mo><mi>b</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>1</mn></mrow></mstyle></mtd><mtd></mtd><mtd></mtd></mtr><mtr><mtd></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi>r</mi><msub><mi>d</mi><mi>y</mi></msub></mrow><mrow><mi>r</mi><msub><mi>d</mi><mi>x</mi></msub></mrow></mfrac><mi>x</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>1</mn></mrow></mstyle></mtd><mtd></mtd><mtd></mtd></mtr><mtr><mtd></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>x</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>r</mi><msub><mi>d</mi><mi>x</mi></msub></mrow><mrow><mi>r</mi><msub><mi>d</mi><mi>y</mi></msub></mrow></mfrac></mrow></mstyle></mtd><mtd></mtd><mtd></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
mx + b &amp;= 1\\
{\frac{rd_y}{rd_x}}x + b &amp;= 1\\
{\frac{rd_y}{rd_x}}x &amp;= 1\\
x &amp;= \frac{rd_x}{rd_y}
\end{align}
</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span><span><span><span><span></span><span><span>m</span><span>x</span><span></span><span>+</span><span></span><span>b</span></span></span><span><span></span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span>x</span><span></span><span>+</span><span></span><span>b</span></span></span><span><span></span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span>x</span></span></span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>1</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>1</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span>1</span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span></span><span><span><span><span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span><span><span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span><span><span></span><span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span>
            
            <div>
                <div id="interactive-triangle-inputs">
                    <div>
                        <p><label for="rdAngle">rdAngle (RO is stuck at {0,0}, for now.)</label>  </p>
                    </div>

                    
                </div>
                
            </div>
            <p>Using the pythagorean theorem, we can then calculate the length of the line.</p>
            <span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>dist</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msqrt><mrow><msup><mtext>pinkDist</mtext><mn>2</mn></msup><mo>+</mo><msup><mtext>blueDist</mtext><mn>2</mn></msup></mrow></msqrt></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>dist</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msqrt><mrow><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><msup><mfrac><mrow><mi>r</mi><msub><mi>d</mi><mi>x</mi></msub></mrow><mrow><mi>r</mi><msub><mi>d</mi><mi>y</mi></msub></mrow></mfrac><mn>2</mn></msup></mrow></msqrt></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>dist</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msqrt><mrow><mn>1</mn><mo>+</mo><msup><mfrac><mrow><mi>r</mi><msub><mi>d</mi><mi>x</mi></msub></mrow><mrow><mi>r</mi><msub><mi>d</mi><mi>y</mi></msub></mrow></mfrac><mn>2</mn></msup></mrow></msqrt></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\text{dist} &amp;= \sqrt{\text{pinkDist}^2 + \text{blueDist}^2}\\
\text{dist} &amp;= \sqrt{1^2 + {\frac{rd_x}{rd_y}}^2}\\
\text{dist} &amp;= \sqrt{1 + {\frac{rd_x}{rd_y}}^2}
\end{align*}
</annotation></semantics></math></span><span aria-hidden="true"><span><span></span><span><span><span><span><span><span><span><span></span><span><span><span>dist</span></span></span></span><span><span></span><span><span><span>dist</span></span></span></span><span><span></span><span><span><span>dist</span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span><span><span><span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span><span><span>pinkDist</span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span>blueDist</span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"></path></svg></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span><span>1</span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span><span></span><span>+</span><span></span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.08em" viewBox="0 0 400000 3240" preserveAspectRatio="xMinYMin slice"><path d="M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z"></path></svg></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span><span><span></span><span><span></span><span></span><span>=</span><span></span><span><span><span><span><span><span></span><span><span>1</span><span></span><span>+</span><span></span><span><span><span><span></span><span><span><span><span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>y</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span><span></span><span></span></span><span><span></span><span><span>r</span><span><span>d</span><span><span><span><span><span><span></span><span><span>x</span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span><span></span></span></span><span><span><span><span><span><span></span><span><span>2</span></span></span></span></span></span></span></span></span></span><span><span></span><span><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.08em" viewBox="0 0 400000 3240" preserveAspectRatio="xMinYMin slice"><path d="M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z"></path></svg></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span><span>​</span></span><span><span><span></span></span></span></span></span></span></span></span></span></span></span>
            
            <p>Similarly,</p>
            
            <p>We can verify that these values are correct by multiplying them by rd and drawing the resulting vector on the screen:</p>
            
            <p>And now all we have to do is use the comparison trick we had earlier.</p>
            
            <p>Great! Now let&#39;s get to space three. If we move to the right, we want to start measuring the distance to the <i>next</i> line, x = 2. The distance to this line is double the distance to x = 1. On the other hand, if we move up, we want to measure the distance to y = 2, which is just double the distance to y = 1. Let&#39;s try doubling our distances depending on the branch.</p>
            
            <p>At each step, we want to increase the distToX if we move right, and we want to increase the distToY if we move up. And we want to increase yDist by the distance between rows along rd, and xDist by the distance between columns along rd. The distance between columns is just the distance from {0,0} to x = 1, which is the value we calculated earlier. Same for the distance between rows.</p>
            
            
            <p>We still have to deal with cases where ro != {0,0}. The initial distToX &amp; distToY change depending on where the ro is <i>inside</i> the grid square. Let&#39;s call that value roFract, since it represents the fractional portion of ro.</p>
            
            <p>When y = 0, the intial distToY is distBetweenColumns, as shown above. When y = 0.5, the intial distToY is half distBetweenColumns. In the general case, to calculate the initial distToY, we can just multiply the distBetweenColumns by 1 - roFract.y. We can do the same for distToX.</p>
            <div>
                <div id="proper-init-dist-inputs">
                    <div>
                        <p><label for="rox">ro.x (RO IS BACK!)</label>
                            
                        </p>
                        <p><label for="roy">ro.y (&amp; BETTER THAN EVER)</label>
                            
                        </p>
                    </div>
                    
                    
                </div>
                
            </div>
            <p>We&#39;re almost done–we just have to make sure that we&#39;re calculating the right distance when rd.x &lt; 0 or rd.y &lt; 0. When rd.x &lt; 0, we&#39;re measuring the distance to x = 0 instead of x = 1, so distToX = roFract.x * distBetweenColumns: we don&#39;t have to subtract roFract from one. Similarly, when rd.y &lt; 0, distToY = roFract.y * distBetweenRows.</p>
            <p>Also, if rd.y &lt; 0, instead of increasing gridSpace.y, we need to decrease gridSpace.y. We generalize for both cases by simply adding sign(rd.y) instead of increasing by the constant 1. We do the same for rd.x and gridSpace.x.</p>
            
            <p>And that&#39;s it! Some modifications are used in the real world:</p>
            <ul>
                <li>distBetweenRows &amp; distBetweenColumns are combined into a single variable, sometimes called rayUnitStepSize.</li>
                <li>sign(rd.x) &amp; sign(rd.y) are combined into a single variable, sometimes called step.</li>
                <li>To avoid the comparison in the loop, you can use a <a href="https://www.researchgate.net/publication/233899848_Efficient_implementation_of_the_3D-DDA_ray_traversal_algorithm_on_GPU_and_its_application_in_radiation_dose_calculation" target="_blank">boolean vector.</a></li>
            </ul>
            
        </article></div>
  </body>
</html>
