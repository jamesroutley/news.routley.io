<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/">Original</a>
    <h1>I Hacked My Car Guides: Creating Custom Firmware</h1>
    
    <div id="readability-page-1" class="page"><div><div>
        
<p><strong>I take no responsibility for any damages due to the information or steps provided on this site. The content is for educational purposes only.</strong></p>
<p><strong>You modify your own car’s firmware at your own risk.</strong></p>
<p><strong>None of this process is approved by Hyundai, Kia, or Hyundai Mobis.</strong></p>

<p>If you want to see how I got this far, check out the rest of my <a href="https://programmingwithstyle.com/tags/howihackedmycar/">“How I Hacked my Car”</a> series.</p>

<p>The non-navigation D-Audio 2V head units found in Hyundai and Kia vehicles run a fairly barebones version of Linux. Through my research and reverse engineering, I’ve been able to figure out the firmware update process down to a point where custom firmware can be developed for these systems.</p>
<p>In order for you to create your own firmware modifications, you need to verify a couple of things.</p>
<ol>
<li>Your vehicle’s head unit is running D-Audio. Specifically Display Audio Gen2V. In order to verify that your head unit is running the correct version, compare the images on <a href="https://update.hyundai.com/US/EN/updateNoticeView/556">Hyundai’s Site</a>.</li>
<li>A firmware update for your vehicle’s head unit should be available. The updates for Hyundai vehicles can be found <a href="https://update.hyundai.com/US/EN/updateNoticeList">here</a> and the updates for Kia vehichle can be found <a href="https://update.kia.com/US/EN/updateNoticeList">here</a>. Updates for D-Audio 2 system can be found under “Display Audio Software Update”. <img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/DisplayAudioUpdates.png" alt="Display Audio Software Update"/></li>
<li>Access to a Linux computer.</li>
</ol>
<p>You then need to download the firmware update for your vehicle which can be found under the update sites above. The update file should be a zip file which contains another zip file which is named “enc_system_package_{version}.zip”. Extract this inner zip file onto a Linux computer.</p>
<p>I have created a set of scripts which help automate the extraction and modification of these updates.</p>
<p><a href="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/uploads/DAudioFirmwareScripts.zip">Download these scripts</a> and extract them into an empty folder and copy your firmware file into the same folder.</p>
<p>The folder should look like this:
<img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/FirmwareScriptSteps1.png" alt="Firmware Scripts"/></p>

<p>Now the settings.sh file can be optionally edited if you want to change what folders the scripts use. The directories will be automatically created so there is no need to make them yourself.
<img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/settings.png" alt="settings.sh"/>
The available settings are as follows:</p>
<ul>
<li>ZIP_PASSWORD_FILE
<ul>
<li>The location of the text file which contains the ZIP password for the firmware update.</li>
</ul>
</li>
<li>ENCRYPTION_KEY_FILE
<ul>
<li>The location of the text file which contains the AES key which is used to unencrypt the encrypted files.</li>
</ul>
</li>
<li>ENCRYPTION_IV_FILE
<ul>
<li>The location of the text file which contains the AES IV which is used to unencrypt the encrypted files.</li>
</ul>
</li>
<li>RSA_PRIVATE_SIGNING_KEY_FILE=keys/rsa_private.pri
<ul>
<li>The location of the RSA private key used to sign the firmware update.</li>
</ul>
</li>
<li>SYSTEM_IMAGE_MOUNT_DIR
<ul>
<li>The directory to mount the system image to.</li>
</ul>
</li>
<li>UPDATE_EXTRACT_TEMP_DIR
<ul>
<li>The directory which holds the firmware files while they are being edited.</li>
</ul>
</li>
<li>KEYS_DIR
<ul>
<li>The directory which contains the Zip Password and encryption/signing files.</li>
</ul>
</li>
</ul>
<p>All of the file locations in the settings file should be relative to the settings.sh file.</p>

<p>Now run “./setupEnvironment.sh”, this will create the folders and file specified in the settings.sh file.</p>
<p>After this file is run your setup should look something like this:
<img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/FirmwareScriptSteps2.png" alt="Files after running setupEnvironment.sh"/></p>
<p>Now the keys in the KEY_DIR directory have to be filled. When entering these values make sure there is only one line in the file and that the file contains no extra spaces.</p>
<ul>
<li>zipPassword.txt should contain: “<a href="https://programmingwithstyle.com/cdn-cgi/l/email-protection" data-cfemail="f3929b829f879ea798819b98c1c3c2cbb3">[email protected]</a>@” (Without Quotes)

</li>
<li>aes_key.txt should contain: “2b7e151628aed2a6abf7158809cf4f3c”</li>
<li>aes_iv.txt should contain: “000102030405060708090a0b0c0d0e0f”
<ul>
<li>These values are from the same “linuxenvsetup.sh” file that the zip was from, they can be found in the generate_aes128_encryption function.</li>
<li>These values are actually the first AES 128bit CBC example key/iv listed in the <a href="https://csrc.nist.gov/publications/detail/sp/800-38a/final">NIST document SP800-38A</a>. <img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/exampleAESKey.png" alt="First Example AES 128bit CBC Encryption Key from NIST document SP800-38A"/></li>
</ul>
</li>
<li>rsa_private.pri can be downloaded <a href="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/uploads/rsa_private.zip">here</a>
<ul>
<li>I got this by decompiling and reverse engineering the updateAgent application from my head unit’s recovery image, then searching the public key on Google.</li>
<li>The public/private key Hyundai Mobis used is a very common test key :/ and can be <a href="https://gist.github.com/irbull/08339ddcd5686f509e9826964b17bb59">found</a> in <a href="http://hayageek.com/rsa-encryption-decryption-openssl-c/">many</a> <a href="https://dspace.rpi.edu/bitstream/handle/20.500.13015/1429/175856_Blackthorne_rpi_0185N_10591.pdf?sequence=3">places</a></li>
</ul>
</li>
</ul>

<p>Once all of the keys and passwords are filled in the update file can be extracted by running ./extract_update.sh {Path to your update file}.
<img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/FirmwareScriptSteps3.png" alt="Running extract_update.sh"/></p>
<p>This script will:</p>
<ol>
<li>Clean up the UPDATE_EXTRACT_TEMP_DIR if it isn’t cleaned already.</li>
<li>Extract the update file using the zip password file.</li>
<li>Mount the system.img file to the SYSTEM_IMAGE_MOUNT_DIR (This requires sudo/Entering your password)</li>
</ol>

<p>Now the system image is mounted (By default to the system_image directory) and can be modified to your heart’s desire.</p>
<p>You can see the backdoors I added to my system in <a href="https://programmingwithstyle.com/posts/howihackedmycarpart2/#the-backdoors">Part 2</a></p>

<p>Another easy backdoor that can be added is enabling the adbd (Android Debug Bridge Daemon) TCP server by adding it as a systemd service. The Android Debug Bridge is a common way to debug android devices and allows for pulling and pushing files to the device as well was launching interactive shells. A version of the Android Debug Bridge Daemon is located on these non-Android head units and was probably used for debugging during development.</p>
<p>To enable the Android Debug Bridge you can download <a href="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/uploads/adbdBackdoor.zip">this</a> zip file and extract it to where your settings.sh file is located. Then you can simply run: “sudo ./createADBDBackdoor.sh”.</p>
<p>Note: The script requires sudo to access the systemd path inside the mounted system image. The added service will run the ADB server on port 5555 on the head unit on startup which can be connected to using Google’s adb command line utility while on the head unit’s network.
<img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/createADBDBackdoorScriptResults.png" alt="Running createADBDBackdoor Script"/></p>
<p>For information on how to use the ADB backdoor once it is installed check out the <a href="#additional-information-about-adb">Additional Information about ADB</a> section.</p>

<p>Once you have modified your system image, you can compile it using the ./compile_update.sh script
<img src="https://programmingwithstyle.com/posts/howihackedmycarguidescreatingcustomfirmware/images/compile_updateResults.png" alt="Running compile_update Script"/></p>
<p>This script can take a little bit to run due to the hashing involved.
The script goes through the following steps:</p>
<ol>
<li>Runs sync to verify changes are saved to the mounted system image.</li>
<li>Unmounts the system image.</li>
<li>Calculates the new update file list for the update and generates a new hash for the modified system.img file.</li>
<li>Signs the update file list with the RSA private key.</li>
<li>Generates the update zip file.</li>
</ol>
<p>The file created will be named “enc_system_package_PUT_VERSION_HERE.zip” since I was too lazy to make it actually name correctly.</p>
<p>All you have to do is rename the created zip file to have the same name as the original firmware update zip and put it in the root of a FAT formatted flash drive.</p>
<p>Then the flash drive can be inserted into your car and the <a href="https://update.hyundai.com/US/EN/updateNoticeView/556/pop2">normal installation steps</a> can be followed.</p>
<p>Note: The update process can take a while.</p>
<p>Then Bingo! Your modified firmware has been installed in your car.</p>

<p>Once the ADBD TCP server service is running on your head unit you can connect to it.</p>
<p>In order to connect to it you must have a computer on your head unit’s network. There are a two ways to do this:</p>
<ul>
<li>If your head unit has a Wi-Fi hotspot, connect to the W-Fi</li>
<li>If your head unit has wireless Android Auto/Apple CarPlay you can dump the Wi-Fi password by following these steps:

</li>
<li>Use an RTL8152/8153 usb to ethernet adapter to connect to the head unit
<ul>
<li>The driver for RTL8152/8153 ethernet adapters is preinstalled. Adapters with USB hubs will not work. <a href="https://www.amazon.com/gp/product/B087QFQW6F/">This adapter</a> worked for me.</li>
<li>Your computer will not be assigned an IPv4 address, so you will have to use a tool like <a href="https://www.wireshark.org/">Wireshark</a> to find the head unit’s <a href="https://en.wikipedia.org/wiki/Link-local_address">link-local IPv6 address</a>.</li>
</ul>
</li>
</ul>
<p>Once you are connected:
Download the adb command line tool and connect to the head unit by running this:
</p>
<p>If you are using the ethernet adapter you have to replace the 192.168.0.1 with the head unit’s IPv6 address.</p>
<p>Then you can launch a shell by using the command:
</p>

      </div></div></div>
  </body>
</html>
