<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://go101.org/blog/2022-10-01-three-way-string-comparison.html">Original</a>
    <h1>No safe efficient ways to do three-way string comparisons in Go</h1>
    
    <div id="readability-page-1" class="page"><div>

		<div>
	<p><small>Go HowTo 101</small></p>
	
	<p><small>Go Practices 101</small></p>
	
	<p><small>Go Agg 101</small></p><p><small>Theme: dark/light</small></p>

</div>

<div><p><small>
Three new books, <a href="https://go101.org/optimizations/101.html">Go Optimizations 101</a>,
<a href="https://go101.org/details-and-tips/101.html">Go Details &amp; Tips 101</a>
and <a href="https://go101.org/generics/101.html">Go Generics 101</a>
are published now.
It is most cost-effective to buy all of them through <a href="https://leanpub.com/b/go-optimizations-details-generics">this book bundle</a>
in the Leanpub book store.
</small></p></div>








<p>Three-way string comparison is <a href="https://sourcegraph.com/search?q=context:global+switch+strings.Compare+lang:Go+&amp;patternType=literal">widely used</a> in programming.
But up to now (Go 1.19), the <a href="https://github.com/golang/go/blob/go1.19/src/strings/compare.go#L7-L28">strings.Compare</a> function in the standard library
is (intentionally) implemented with a non-opitimized way:</p>

<pre><code>func Compare(a, b string) int {
	// NOTE(rsc): This function does NOT call the runtime cmpstring function,
	// because we do not want to provide any performance justification for
	// using strings.Compare. Basically no one should use strings.Compare.
	// As the comment above says, it is here only for symmetry with package bytes.
	// If performance is important, the compiler should be changed to recognize
	// the pattern so that all code doing three-way comparisons, not just code
	// using strings.Compare, can benefit.
	if a == b {
		return 0
	}
	if a &lt; b {
		return -1
	}
	return +1
}
</code></pre>

<p>When comparing two unequal strings, the implementation will perform two comparison operations.
Whereas a perfect implementation only needs one,
just like the implementation of <a href="https://github.com/golang/go/blob/go1.19/src/bytes/bytes.go#L23-L28">bytes.Compare</a> shown below,
in which <a href="https://github.com/golang/go/blob/go1.19/src/internal/bytealg/compare_native.go#L12">bytealg.Compare</a> is impplemented using assembly code
on most architectures.</p>

<pre><code>func Compare(a, b []byte) int {
	return bytealg.Compare(a, b)
}
</code></pre>

<p>The <code>strings.Compare</code> implementation is comparatively inefficent for the cases
in which the two operand strings are unequal and they share a common non-blank prefix.
Such cases are not rare.</p>

<p>Benchmark code constantly shows <code>strings.Compare</code> uses 2x CPU time of <code>bytes.Compare</code>
for any two unequal byte sequences which share a common prefix.</p>

<p>The internal comment for the current <code>strings.Compare</code> implementation
is some interesting. The comment suggests that we should not use
<code>strings.Compare</code> in Go at all, but no alternative efficient ways are available now yet.
It mentions that the compiler should make sppecial optimizations to automatically
convert the code using comparision operators into internal three-way comparisons if possible.
However, such compiler optimizations have never been made, and are not even planned to make yet.
Personally, I doubt such optimizations are feasible to make for any use case.
So I think the <code>strings.Compare</code> should be implemented efficiently,
to avoid breaking user expectations.</p>
<hr/>





<hr/>

<p><small>

<p>
The <b><i>Go 101</i></b> project is hosted on
<a href="https://github.com/go101/go101">Github</a>.
Welcome to improve <b><i>Go 101</i></b> articles
by submitting corrections for all kinds of mistakes,
such as typos, grammar errors, wording inaccuracies,
description flaws, code bugs and broken links.
</p>

<p>
If you would like to learn some Go details and facts every serveral days,
please follow Go 101&#39;s official Twitter account <a href="https://twitter.com/go100and1">@go100and1</a>
or join <a href="https://join.slack.com/t/go-101/shared_invite/zt-y2pvwg00-Oz7lDDJu44l~hZsFRUApiA">Go 101 slack channels</a>.
</p>

</small></p>

<p><small>



<div><p>

Tapir, the author of Go 101, has been on writing the Go 101 series books
and maintaining the go101.org website since 2016 July.
New contents will be continually added to the book and the website from time to time.
Tapir is also an indie game developer.
You can also support Go 101 by playing <a href="https://www.tapirgames.com">Tapir&#39;s games</a>
(made for both Android and iPhone/iPad):
</p><ul>
<li>
	<a href="https://www.tapirgames.com/App/Color-Infection">Color Infection</a> (★★★★★), a physics based original casual puzzle game. 140+ levels. 
</li>
<li>
	<a href="https://www.tapirgames.com/App/Rectangle-Pushers">Rectangle Pushers</a> (★★★★★), an original casual puzzle game. Two modes, 104+ levels. 
</li>
<li>
	<a href="https://www.tapirgames.com/App/Let-Us-Play-With-Particles">Let&#39;s Play With Particles</a>, a casual action original game. Three mini games are included.
</li>
</ul>
</div>

Individual donations <a href="https://paypal.me/tapirliu">via PayPal</a> are also welcome.</small></p>

<hr/><p>
Index:


</p><ul>
<li>
	<b id="i-2022-10-01-three-way-string-comparison.html" data-tag="optimization, string, compare" data-date="2022-10-24">No safe efficient ways to do three-way string comparisons in Go</b>
</li>
<li>
	<a href="https://go101.org/blog/2022-08-22-some-undocumented-changes-in-go-1.18-and-1.19.html" data-tag="update" data-date="2022-08-31">Some undocumented changes in Go 1.18 and 1.19</a>
</li>
<li>
	<a href="https://go101.org/blog/2022-02-22-history.html" data-tag="update" data-date="2022-02-22">Update Histories of Go 101 Books</a>
</li>
</ul>








		</div></div>
  </body>
</html>
