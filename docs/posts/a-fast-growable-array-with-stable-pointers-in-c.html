<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://danielchasehooper.com/posts/segment_array/">Original</a>
    <h1>A fast, growable array with stable pointers in C</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>August 5, 2025・7 minute read</p><div><p>My last article about <a href="https://danielchasehooper.com/posts/typechecked-generic-c-data-structures/">generic data structures in C</a> was written to set the stage for today’s topic: A data structure that can be used in place of dynamic arrays, has stable pointers, and works well with <a href="https://www.rfleury.com/p/untangling-lifetimes-the-arena-allocator" target="_blank" rel="noopener">arena allocators</a>. It’s been independently discovered by different programmers over the years and so goes by different names. A <a href="https://duckduckgo.com/?q=%22Experiences+with+the+design+and+implementation+of+space-efficient+deques%22" target="_blank" rel="noopener">2001 paper</a> called it a “levelwise-allocated pile” (bleh). Zig calls it a “<a href="https://github.com/ziglang/zig/blob/e17a050bc695f7d117b89adb1d258813593ca111/lib/std/segmented_list.zig" target="_blank" rel="noopener">Segmented List</a>”. Then theres C++ with <code>std::deque</code>, which is only somewhat similar. I like the name that <a href="https://mastodon.social/@pervognsen" target="_blank" rel="noopener">Per Vognsen</a> uses: “<a href="https://gist.github.com/pervognsen/c9d18e8012ce497e7a92d3f86c112337" target="_blank" rel="noopener">Segment Array</a>”.</p><p>You can download my single-header C implementation, segment_array.h, by joining my newsletter:</p><p>The core concept is straight forward: the structure contains a fixed sized array of pointers to segments. Each segment contains double the number of items of its predecessor. New segments are allocated only when needed. Here’s how that looks:</p><svg width="100%" height="429" viewBox="0 0 588 429" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path d="M0 0H588V429H0V0z" id="path-1"></path><path d="M0 0H184V246H0V0z" id="path-2"></path><path d="M0 0H184V38H0V0z" id="path-3"></path><path d="M0 0H92V38H0V0z" id="path-4"></path><path d="M0 0H46V38H0V0z" id="path-5"></path></defs><g id="Frame" stroke="none" fill="none" xlink:href="#path-1"><use fill="#161616" fill-rule="evenodd" xlink:href="#path-1"></use><g id="Group" stroke-width="1" fill-rule="evenodd" transform="translate(143, -47)" fill="#013c4e" stroke="#979797"><rect id="Rectangle-Copy-6" x=".5" y="118.5" width="59" height="59"></rect><rect id="Rectangle-Copy-7" x=".5" y="178.5" width="59" height="59"></rect><rect id="Rectangle-Copy-8" x=".5" y="238.5" width="59" height="59"></rect><rect id="Rectangle-Copy-9" x=".5" y="298.5" width="59" height="59"></rect><rect id="Rectangle-Copy-13" x=".5" y="358.5" width="59" height="59"></rect></g><g id="Stack" transform="translate(271, 74)" xlink:href="#path-2" fill="#013c4e" fill-rule="evenodd" stroke="#979797" stroke-width="1"><g id="Stack-Copy-2" transform="translate(0, 125.9998)" xlink:href="#path-3"><rect id="Rectangle-Copy-17" x="161.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-14" x="138.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-16" x="115.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-13" x="92.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-15" x="69.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-11" x="46.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-12" x="23.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-10" x=".5" y=".5" width="22" height="37"></rect></g><g id="Stack-Copy" transform="translate(0, 62.9999)" xlink:href="#path-4"><rect id="Rectangle-Copy-14" x="69.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-13" x="46.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-11" x="23.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-10" x=".5" y=".5" width="22" height="37"></rect></g><g xlink:href="#path-5"><rect id="Rectangle-Copy-13" x="23.5" y=".5" width="22" height="37"></rect><rect id="Rectangle-Copy-10" x=".5" y=".5" width="22" height="37"></rect></g></g><text id="NULL-Copy" font-family="Helvetica" font-size="12" font-weight="normal" fill="#fff"><tspan x="157.160156" y="344.0001">NULL</tspan></text><text id="NULL-Copy-2" font-family="Helvetica" font-size="12" font-weight="normal" fill="#fff"><tspan x="157.160156" y="285.0001">NULL</tspan></text><text id="segments-array" font-family="Helvetica" font-size="12" font-weight="normal" fill="#fff"><tspan x="143.150391" y="62">segments array</tspan></text><text id="segment-0" font-family="Helvetica" font-size="12" font-weight="normal" fill="#fff"><tspan x="271.483398" y="69">segment 0</tspan></text><text id="segment-1" font-family="Helvetica" font-size="12" font-weight="normal" fill="#fff"><tspan x="271.483398" y="133">segment 1</tspan></text><text id="segment-2" font-family="Helvetica" font-size="12" font-weight="normal" fill="#fff"><tspan x="271.483398" y="196">segment 2</tspan></text><path id="Line" d="M263 95l9 4.5-9 4.5v-4L176.972457 100.000707C176.723414 102.250342 174.816034 104 172.5 104 170.014719 104 168 101.985281 168 99.5 168 97.0147186 170.014719 95 172.5 95 174.816379 95 176.723981 96.7501788 176.972568 99.000297L263 99V95z" fill="#fff" fill-rule="nonzero"></path><path id="Line-Copy" d="M263 155l9 4.5-9 4.5v-4L176.972457 160.000707C176.723414 162.250342 174.816034 164 172.5 164 170.014719 164 168 161.985281 168 159.5S170.014719 155 172.5 155C174.816379 155 176.723981 156.750179 176.972568 159.000297L263 159v-4z" fill="#fff" fill-rule="nonzero"></path><path id="Line-Copy-2" d="M263 215l9 4.5-9 4.5v-4L176.972457 220.000707C176.723414 222.250342 174.816034 224 172.5 224 170.014719 224 168 221.985281 168 219.5S170.014719 215 172.5 215C174.816379 215 176.723981 216.750179 176.972568 219.000297L263 219v-4z" fill="#fff" fill-rule="nonzero"></path></g></svg></div><p>❖</p><div><p>Get notified about my next article:</p></div></div></div></div>
  </body>
</html>
