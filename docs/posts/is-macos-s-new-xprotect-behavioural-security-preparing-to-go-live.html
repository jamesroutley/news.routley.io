<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2023/09/04/is-macoss-new-xprotect-behavioural-security-preparing-to-go-live/">Original</a>
    <h1>Is macOS’s new XProtect behavioural security preparing to go live?</h1>
    
    <div id="readability-page-1" class="page"><article id="post-74065">
	
	<!-- .entry-header -->

	
		<div data-first_letter="U">
		<p>Until early last year, there was <a href="https://eclecticlight.co/2020/10/27/xprotect-what-do-we-know-about-it/">one XProtect</a>, sets of rules that among other things tried to detect known malware during Gatekeeper checks on apps and other code. Then in March 2022, Ventura silently added a second XProtect, this time a set of scanning modules run at least once a day to detect known malware and remove it. Since June last year, that XProtect Remediator has <a href="https://eclecticlight.co/2023/06/12/malware-detection-and-remediation-by-xprotect-remediator/">rapidly matured</a>, to the point where it now looks for 19 different types of malware on macOS 10.15 and later, and is updated at least once a month.</p>
<p>A third XProtect <a href="https://eclecticlight.co/2023/06/10/bastion-in-defence-of-sonoma-security/">was discovered</a> in Ventura, this time observing potentially malicious behaviour such as attempts to access private data for browsers and messaging apps. This XProtect Behaviour Service (XBS) has used a set of Bastion rules embedded in the strings in <code>syspolicyd</code> to record behaviours in a new database, but so far has been an observer and hasn’t blocked such behaviours. Security researchers have already been able to discover its records of <a href="https://www.mandiant.com/resources/blog/north-korea-supply-chain" target="_blank">novel malicious code</a>, and Chris Long <a href="https://clo.ng/blog/osquery-xpdb/" target="_blank">has documented</a> how to access its database, but so far <code>syspolicyd</code> has only watched and recorded.</p>
<p><a href="https://www.picussecurity.com/resource/blog/securing-macos-a-closer-look-at-built-in-macos-application-security" target="_blank">Recent descriptions</a> of Bastion rules have identified four, last updated in <code>syspolicyd</code> in macOS 13.5 on 24 July 2023. Those changed on 8 August, when Apple released its first update to the Bastion rules, and again a month later on 1 September, when they changed again. There’s now a fifth Bastion rule, and XBS appears to be getting ready to fly for the first time.</p>
<h4>XProtect Remediator updates</h4>
<p>Updates provided to XProtect Remediator versions 108 (8 August 2023) and 109 (1 September 2023) contained two additional files not seen in previous updates:</p>
<ul>
<li>bastion.sb, a text file containing the latest Bastion SystemPolicyConfiguration, its rules;</li>
<li>BastionMeta.plist, a property list defining behaviour dictionaries for XBS and Bastion.</li>
</ul>
<h4>Bastion rules</h4>
<p>Although each recent version of these rules is prefaced by the line</p>
<p>Each defines four groups of processes: <em>usual-offenders,</em> which are common exceptions to several rules; then separate groups of exceptions to each of rules 1, 2 and 3. For example, com.apple.mds and other Spotlight indexing processes are <em>usual-offenders,</em> while com.apple.Finder is only a <em>rule-one-offender.</em></p>
<p>Using those lists of exceptions, five Bastion rules are built as filters:</p>
<ol>
<li>excludes other processes from accessing private data for Google Chrome, Firefox and Safari;</li>
<li>excludes other processes from accessing private data for Messages, Microsoft Teams, Slack and WhatsApp;</li>
<li>excludes other processes from accessing the QuarantineEvents database;</li>
<li>controls access to two socket ioctl commands SIOCIFCREATE and SIOCGIFDESC;</li>
<li>controls access to writing within Library/PrivilegedHelperTools/ directories.</li>
</ol>
<p>The updated bastion.sb file supplied in recent XProtect Remediator updates is explicitly referenced by <code>syspolicyd</code>, presumably to replace the version embedded in its own code. However, it’s unclear how updates are recognised by <code>syspolicyd</code> so that they can take effect without macOS being restarted.</p>
<h4>BastionMeta.plist</h4>
<p>This property list, identical in both versions, contains a dictionary of five behaviours. Each has a Signature Name, such as macOS.NetworkSniffer.Generic, a Boolean value indicating the need for immediate reporting, and a binary flag ranging from 1 to 16. The behaviours are named:</p>
<ul>
<li>Browser</li>
<li>Messages</li>
<li>QntDb</li>
<li>NetworkSniffer</li>
<li>HiddenPrivilegedHelpers</li>
</ul>
<p>and correlate with the five Bastion rules, for which this file appears to provide the metadata. Thus rule 1 protects browser data, rule 2 messaging data, rule 3 quarantine records, rule 4 network packet sniffing, and rule 5 hidden privileged helper apps.</p>
<h4>Future</h4>
<p>Without a mechanism for updating Bastion rules outside macOS updates, XBS would lack the ability to accommodate changes in response to changing threat. These first updates are an important milestone in the development of XBS as effective security protection, but until <code>syspolicyd</code> is switched from observation to intervention, its role is severely limited.</p>
<p>While they’re bundled in XProtect Remediator updates, Bastion rule updates are installed on all Macs running macOS 10.15 Catalina or later. Unlike XProtect Remediator, which is essentially a self-contained security tool, Bastion updates are only effective for macOS with a version of <code>syspolicyd</code> that supports behavioural protection, which almost certainly excludes macOS before Ventura. As Ventura has now entered its first year of security-only updates, it looks unlikely that its <code>syspolicyd</code> will support intervention, and it’s most likely that it will be left as an observer.</p>
<p>The timing of these updates is consistent with the intended release of fully functional intervention in Sonoma, perhaps in macOS 14.3 early next year, or possibly sooner. As long as bastion.sb and BastionMeta.plist files remain in plain text, it should be straightforward to watch this evolution. Now might also be a good time to prepare test tools to confirm how Bastion rules are applied by <code>syspolicyd</code>. These are interesting times indeed.</p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
