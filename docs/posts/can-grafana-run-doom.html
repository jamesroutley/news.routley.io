<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://grafana.com/blog/2022/03/31/can-grafana-run-doom/">Original</a>
    <h1>Can Grafana run Doom?</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>It started as all good projects do … with Rick Astley. </p>
<p>After seeing the project about <a href="https://grafana.com/blog/2021/07/30/how-to-use-grafana-and-prometheus-to-rickroll-your-friends-or-enemies/?pg=blog&amp;plcmt=body-txt">how to Rickroll your friends with Grafana</a> — in which a seemingly innocent hyperlink surprises users with the music video for Astley’s classic “Never Gonna Give You Up” rendered with Prometheus and Grafana — a question arose: Can Grafana run Doom?</p>
<p>As the latest company-wide hackathon at Grafana Labs approached in March, the three of us decided why not take on that challenge? We could answer a question that is tied to almost any tech device/platform out there; we would push the time series streaming to the limit; and we can also try live streaming data sources.</p>
<p>Now, on the 25th anniversary of the <a href="https://doom.fandom.com/wiki/Doom_64" target="_blank" rel="noopener noreferrer">Doom 64</a> release, we’re excited to say that not only can <a href="https://grafana.com/oss/?pg=blog&amp;plcmt=body-txt">Grafana</a> query, visualize, alert on, and understand your data no matter where it’s stored. It can also run Doom!</p>
<p>If you want to give it a try, you can enjoy “Doomfana” in <a href="https://play.grafana.org/d/pcRk_9Lnz/doom-full-resolution" target="_blank" rel="noopener noreferrer">full resolution</a> or <a href="https://play.grafana.org/d/ePolu9Lnk/doom-half-resolution" target="_blank" rel="noopener noreferrer">half resolution</a>.</p>
<div x-data="{ vimeo_is_up: false, responded: false }" x-init="fetch(`https://vimeo.com/api/oembed.json?url=https://vimeo.com/694160226`)
      .then(response =&gt; {
        responded = true;
        response &amp;&amp; response.status === 200 ? vimeo_is_up = true : vimeo_is_up = false;
      })
      .catch(error =&gt; {
        responded = true;
      })" x-cloak="">
<template x-if="vimeo_is_up">
<p>
<iframe src="https://player.vimeo.com/video/694160226?transparent=0" title="vimeo video" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
</p>
</template>
<template x-if="responded &amp;&amp; !vimeo_is_up">
<p>There’s supposed to be a video here, but for some reason there isn’t. Either we entered the id wrong (oops!), or Vimeo is down. If it’s the latter, we’d expect they’ll be back up and running soon. In the meantime, <a href="https://grafana.com/blog/">check out our blog</a>!</p>
</template>
</div>
<h2 id="meet-the-doom-players">Meet the Doom players</h2>
<p><strong>Name</strong> Bogdan Matei</p>
<figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="https://grafana.com/static/assets/img/blog/doom-grafana-bogdan.png" itemprop="contentUrl"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="/static/assets/img/blog/doom-grafana-bogdan.png" alt="Doom in Grafana: Bogdan Matei" width="" height="" title="Doom in Grafana: Bogdan Matei"/>
</a>
</figure>
<p><strong>Name</strong> Kostas Pelelis</p>
<figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="https://grafana.com/static/assets/img/blog/doom-grafana-kostas.png" itemprop="contentUrl"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="/static/assets/img/blog/doom-grafana-kostas.png" alt="Doom in Grafana: Kostas Pelelis" width="" height="" title="Doom in Grafana: Kostas Pelelis"/>
</a>
</figure>
<p><strong>Name</strong> Domas Lapinskas</p>
<figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="https://grafana.com/static/assets/img/blog/doom-grafana-domas.png" itemprop="contentUrl"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="/static/assets/img/blog/doom-grafana-domas.png" alt="Doom in Grafana: Domas Lapinskas" width="" height="" title="Doom in Grafana: Domas Lapinskas"/>
</a>
</figure>
<h2 id="map03-main-engineering">MAP03: Main engineering</h2>
<p>For running Doom, we had two possibilities: Either run it server side and send the data through WebSockets, or use <a href="https://github.com/cloudflare/doom-wasm" target="_blank" rel="noopener noreferrer">Doom WASM</a> to run Doom in the browser and fetch the data from it. Here were the pros and cons for both options. </p>
<h3 id="websockets">WebSockets</h3>
<ul>
<li>This implementation required a lot of C code so that the frames could be safely transported to WebSocket clients. With some optimizations, we could stream the game in 640x400 @ 35 fps.</li>
<li>Exporting game stats from Prometheus would require an HTTP exporter in C, which would be troublesome.</li>
</ul>
<h3 id="webassembly">WebAssembly </h3>
<ul>
<li>In this option, we compile Doom to WebAssembly (WASM) via Emscripten, paint everything into a canvas element using WebGL, capture the output pixel by pixel, and expose it as metrics.</li>
<li>Using SDL C-library to capture the output instead of canvas resulted in out of memory since WASM has some serious memory constraints. </li>
<li>In order to expose the health info and others, a special hook was added to Doom so it calls a JS function that receives the data and exposes it as metrics.</li>
</ul>
<p>In the end, we decided to go the WebAssembly route.</p>
<h2 id="map08-final-output">MAP08: Final output</h2>
<p>You can now try “Doomfana” at <a href="https://play.grafana.org/d/pcRk_9Lnz/doom-full-resolution" target="_blank" rel="noopener noreferrer">full resolution</a> or <a href="https://play.grafana.org/d/ePolu9Lnk/doom-half-resolution" target="_blank" rel="noopener noreferrer">half resolution</a>. In the half resolution mode (100x160) alone, there are 256 active time series (one per color) and 16k data points rendered at ~30 frames per second. </p>
<figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
<a href="https://grafana.com/static/assets/img/blog/doom-grafana-meta.png" itemprop="contentUrl"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="/static/assets/img/blog/doom-grafana-meta.png" alt="" width="" height="" title=""/>
</a>
</figure>
<p><em>Above: Doomfana (and a monster) at full resolution in Grafana.</em></p>
<p>In running this project, we learned some great tips to optimize live streaming time series panel performance in Grafana:</p>
<ul>
<li>Keep the list of fields constant; only update. Mutating fields only causes expensive configuration updates.</li>
<li>When assembling data frames, initializing a fixed length array and then assigning items by index is faster than using Array.push.</li>
<li>Configure explicit min and max Y-axis values instead of letting Grafana decide them. This is one of the performance improvements we found during the hackathon. </li>
<li>Push new frames on window.requestAnimationsFrame tick.</li>
<li>If using Chrome, make sure “Canvas 2d out of process rasterization” is enabled. See chrome://gpu</li>
</ul>
<p>And the mission is still not done! There are a lot of improvements that we want to implement: bring all the Doom stats to Grafana panels, improve the frame rate, fix some minor graphic glitches, use the new <a href="https://grafana.com/docs/grafana/latest/visualizations/heatmap/?pg=blog&amp;plcmt=body-txt">heatmap panel</a> as an alternative to the time series panel, and more.</p>
<p>We have already considered building more starts, a recording feature, and other cool capabilities into Doomfana; and the recent <a href="https://grafana.com/blog/2022/03/30/announcing-grafana-mimir/?pg=blog&amp;plcmt=body-txt">Grafana Mimir news</a> will only help us achieve that. We will make our code public next week and will update this blog post with it.</p>
<h2 id="map27-playground">MAP27: Playground</h2>
<p>The <a href="https://grafana.com/blog/2022/01/14/all-about-the-grafana-labs-hackathon-2.0/?pg=blog&amp;plcmt=body-txt">Grafana Labs hackathon</a> itself was the best part of this project. It allowed us to focus on something that was not necessarily work-related, but we found a couple of improvements that can be implemented in Grafana, we had a lot of fun, and we tried technologies that we don’t actively use. For the record, <a href="https://grafana.com/docs/grafana/latest/live/?pg=blog&amp;plcmt=body-txt">Grafana’s live streaming feature</a> is awesome!</p>
<p>We’ve seen a lot of reactions that made us smile since we shared our Doomfana project, but the one that made us feel great appeared during a presentation when someone from another team commented: “This is a true hackathon project.&#34; </p>
<p><em>If you want to play with cool technology, have some fun while doing it, and participate in Grafana Labs&#39; hackathons, we’re hiring! Find out how you can become an official Grafanista by visiting our <a href="https://grafana.com/about/careers/?pg=blog&amp;plcmt=body-txt">careers page</a>.</em></p>
</div></div>
  </body>
</html>
