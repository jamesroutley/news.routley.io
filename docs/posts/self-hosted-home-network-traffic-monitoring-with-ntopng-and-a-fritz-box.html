<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://davquar.it/post/self-hosting/ntopng-fritzbox-monitoring/">Original</a>
    <h1>Self-hosted home network traffic monitoring with ntopng and a Fritz Box</h1>
    
    <div id="readability-page-1" class="page"><div><main><div><div><ul><li><em></em>
<span>28/12/2022</span></li><li><em></em>
<span>5-minute read</span></li><li><span><a href="https://davquar.it/categories/self-hosting/">Self-Hosting</a></span>
<span><a href="https://davquar.it/tags/sysadmin/">sysadmin</a><a href="https://davquar.it/tags/docker/">docker</a><a href="https://davquar.it/tags/security/">security</a><a href="https://davquar.it/tags/network/">network</a></span></li></ul><p>This post shows how I set up an home network traffic monitoring system in an unconventional way.</p><p>One day I have decided that I wanted to monitor the traffic of my home network.</p><p>For the services I self-host in my home, I had recently upgraded from a Raspberry Pi 3B+ to a refurbished Dell WYSE 5070 <em>thin client</em> and I was looking for other things to self-host.</p><p>Then I came across <a href="https://github.com/ntop/ntopng">ntopng</a>, which is an open-source <strong>network traffic monitoring</strong> and analysis tool, and I said to myself that I wanted it.</p><p>The <strong>ideal setup</strong> would be installing it on a dedicated machine to use as router, but I wasn’t planning on that. The less ideal but still cool setup would be using a <strong>mirrored port</strong> on a switch, to forward all the traffic to the monitoring machine.</p><p>The problem was that <strong>neither</strong> my main ISP-provided router and Fritz!Box router (that I’m currently using just as a switch) had the possibility to set one port as mirrored.</p><p><em>So how could I monitor my homenet’s traffic without even having the physical <strong>prerequisites</strong> to do it?</em></p><p>Actually I could, because after some quick searches I discovered that every Fritz!Box router has some <strong>obscure undocumented pages</strong>, including <code>http://fritzbox/html/capture.html</code>, which allows to freely <strong>capture the traffic</strong> of all the available network interfaces.</p><p><img src="https://davquar.it/images/post/self-hosting/ntopng-fritzbox-monitoring/fritzbox-hidden-capture-page.png" alt="The undocumented packet capture page in Fritz!Box routers"/></p><p>When you start capturing, the stream of packets in the <strong>Libpcap</strong> format starts downloading, and you can read it with <strong>Wireshark</strong> or tshark.</p><p>Now back to <strong>ntopng</strong>: can it <strong>read pcap files</strong>? The answer is yes! Quoting the docs:</p><div><pre tabindex="0"><code data-lang="fallback"><span><span>[--interface|-i] &lt;interface|pcap&gt;   | Input interface name (numeric/symbolic),
</span></span><span><span>                                    | view or pcap file path
</span></span></code></pre></div><p>Now I suddenly had all the “physical prerequisites” that were missing before.</p><h2 id="the-plan">The plan</h2><p>The plan was easy; I needed to:</p><ol><li>Write a script to authenticate to the Fritz!Box and start the packet captures.</li><li>Tell ntopng to listen on the downloaded pcap files.</li></ol><p>Actually, an <a href="https://github.com/ntop/ntopng/blob/dev/tools/fritzdump.sh">example script</a> is already provided in the ntopng’s GitHub repository, so I only needed to change it according to my needs and preferences.</p><p>To be more specific, I wanted to build this:</p><ul><li>A <strong>fritzpcap</strong> Docker container to:<ul><li>Authenticate to the Fritz!Box.</li><li>Start capturing traffic to some FIFO pipes, one per interface.</li></ul></li><li>A <strong>ntopng</strong> Docker container to listen from the pipes containing the pcaps.</li></ul><p><img src="https://davquar.it/images/post/self-hosting/ntopng-fritzbox-monitoring/fritzpcap-ntopng-fritzbox-diagram.png" alt="A diagram of the system to build, in which an object called fritzpcap communicates to the Fritz!Box by first authenticating, then starting and downloading the packet capture streams, and then passing the streams to some pipes, which are read/consumed by ntopng"/></p><h2 id="the-execution">The execution</h2><p>To explain the execution I’ll follow a top-down approach.</p><h3 id="docker-compose-file">Docker Compose file</h3><p>My <code>docker-compose.yml</code> looks like this:</p><div><pre tabindex="0"><code data-lang="yml"><span><span><span>version</span><span>:</span><span> </span><span>&#39;3&#39;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>services</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>app</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>container_name</span><span>:</span><span> </span><span>ntopng</span><span>
</span></span></span><span><span><span>    </span><span>image</span><span>:</span><span> </span><span>ntop/ntopng</span><span>
</span></span></span><span><span><span>    </span><span>volumes</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>data:/var/lib/ntopng</span><span>
</span></span></span><span><span><span>      </span>- <span>./pcap:/pcap</span><span>
</span></span></span><span><span><span>      </span>- <span>./ntopng.conf:/ntopng.conf:ro</span><span>
</span></span></span><span><span><span>      </span>- <span>/etc/timezone:/etc/timezone:ro</span><span>
</span></span></span><span><span><span>      </span>- <span>/etc/localtime:/etc/localtime:ro</span><span>
</span></span></span><span><span><span>    </span><span>environment</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>TZ=Europe/Rome</span><span>
</span></span></span><span><span><span>    </span><span>command</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>&#34;/ntopng.conf&#34;</span><span>
</span></span></span><span><span><span>    </span><span>ports</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>3000</span><span>
</span></span></span><span><span><span>    </span><span>networks</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>proxy</span><span>
</span></span></span><span><span><span>    </span><span>restart</span><span>:</span><span> </span><span>unless-stopped</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>  </span><span>fritzpcap</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>build</span><span>:</span><span> </span><span>./fritzpcap</span><span>
</span></span></span><span><span><span>    </span><span>environment</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>FRITZIP=http://fritzbox</span><span>
</span></span></span><span><span><span>      </span>- <span>FRITZUSER={{ fritz.username }}</span><span>
</span></span></span><span><span><span>      </span>- <span>FRITZPWD={{ fritz.password }}</span><span>
</span></span></span><span><span><span>    </span><span>volumes</span><span>:</span><span>
</span></span></span><span><span><span>      </span>- <span>./pcap:/pcap</span><span>
</span></span></span><span><span><span>    </span><span>restart</span><span>:</span><span> </span><span>unless-stopped</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>volumes</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>data</span><span>:</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>networks</span><span>:</span><span>
</span></span></span><span><span><span>  </span><span>proxy</span><span>:</span><span>
</span></span></span><span><span><span>    </span><span>external</span><span>:</span><span> </span><span>true</span><span>
</span></span></span></code></pre></div><p>Some notable things:</p><ul><li>Both containers have the <code>./pcap:/pcap</code> bind mount:<ul><li>We want fritzpcap to place here the pcap pipes.</li><li>We want ntopng to read from there.</li></ul></li><li><code>ntopng.conf</code> is the configuration file, and it is given in input when ntopng’s container starts.</li><li>fritzpcap’s image must be built from <code>./fritzpcap</code>.</li><li>The environment variables prefixed with <code>FRITZ</code> must obviously be changed properly.</li></ul><h3 id="fritzpcap">fritzpcap</h3><p>Now in the <code>./fritzpcap</code> directory I put both the script and the image definition.</p><p>As introduced before, the <code>pcap.sh</code> is a slight modification of the one provided by ntopng authors (<a href="https://www.gnu.org/licenses/gpl-3.0.html">GNU GPLv3.0</a>):</p><div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span>
</span></span><span><span><span>SIDFILE</span><span>=</span><span>&#34;/tmp/fritz.sid&#34;</span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>[</span> -z <span>&#34;</span><span>$FRITZIP</span><span>&#34;</span> <span>]</span> <span>||</span> <span>[</span> -z <span>&#34;</span><span>$FRITZPWD</span><span>&#34;</span> <span>]</span> <span>||</span> <span>[</span> -z <span>&#34;</span><span>$FRITZUSER</span><span>&#34;</span> <span>]</span> <span>;</span> <span>then</span> <span>echo</span> <span>&#34;FRITZUSER, FRITZPWD, FRITZIP must all be set&#34;</span> <span>;</span> <span>exit</span> 1<span>;</span> <span>fi</span>
</span></span><span><span>
</span></span><span><span><span>echo</span> <span>&#34;Logging in as </span><span>$FRITZUSER</span><span> into Fritz!Box </span><span>$FRITZIP</span><span>&#34;</span>
</span></span><span><span>
</span></span><span><span><span>if</span> <span>[</span> ! -f <span>$SIDFILE</span> <span>]</span><span>;</span> <span>then</span>
</span></span><span><span>  touch <span>$SIDFILE</span>
</span></span><span><span><span>fi</span>
</span></span><span><span>
</span></span><span><span><span>SID</span><span>=</span><span>$(</span>cat <span>$SIDFILE</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span># Request challenge token from Fritz!Box</span>
</span></span><span><span><span>CHALLENGE</span><span>=</span><span>$(</span>curl -k -s <span>$FRITZIP</span>/login_sid.lua <span>|</span> grep -o <span>&#34;&lt;Challenge&gt;[a-z0-9]\{8\}&#34;</span> <span>|</span> cut -d<span>&#39;&gt;&#39;</span> -f 2<span>)</span>
</span></span><span><span>
</span></span><span><span><span># Very proprietary way of AVM: create an authentication token by hashing the challenge token with the password</span>
</span></span><span><span><span>HASH</span><span>=</span><span>$(</span>perl -MPOSIX -e <span>&#39;
</span></span></span><span><span><span>    use Digest::MD5 &#34;md5_hex&#34;;
</span></span></span><span><span><span>    my $ch_Pw = &#34;$ARGV[0]-$ARGV[1]&#34;;
</span></span></span><span><span><span>    $ch_Pw =~ s/(.)/$1 . chr(0)/eg;
</span></span></span><span><span><span>    my $md5 = lc(md5_hex($ch_Pw));
</span></span></span><span><span><span>    print $md5;
</span></span></span><span><span><span>  &#39;</span> -- <span>&#34;</span><span>$CHALLENGE</span><span>&#34;</span> <span>&#34;</span><span>$FRITZPWD</span><span>&#34;</span><span>)</span>
</span></span><span><span>  curl -k -s <span>&#34;</span><span>$FRITZIP</span><span>/login_sid.lua&#34;</span> -d <span>&#34;response=</span><span>$CHALLENGE</span><span>-</span><span>$HASH</span><span>&#34;</span> -d <span>&#39;username=&#39;</span><span>${</span><span>FRITZUSER</span><span>}</span> <span>|</span> grep -o <span>&#34;&lt;SID&gt;[a-z0-9]\{16\}&#34;</span> <span>|</span> cut -d<span>&#39;&gt;&#39;</span> -f <span>2</span> &gt; <span>$SIDFILE</span>
</span></span><span><span>
</span></span><span><span><span>SID</span><span>=</span><span>$(</span>cat <span>$SIDFILE</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span># Check for successfull authentication</span>
</span></span><span><span><span>if</span> <span>[[</span> <span>$SID</span> <span>=</span>~ ^0+$ <span>]]</span> <span>;</span> <span>then</span> <span>echo</span> <span>&#34;Login failed. Did you create &amp; use explicit Fritz!Box users?&#34;</span> <span>;</span> <span>exit</span> <span>1</span> <span>;</span> <span>fi</span>
</span></span><span><span>
</span></span><span><span><span>echo</span> <span>&#34;Login successful&#34;</span>
</span></span><span><span>
</span></span><span><span><span>echo</span> <span>&#34;Creating pipes&#34;</span>
</span></span><span><span>rm -f pcap/*
</span></span><span><span>mkfifo pcap/eth0 pcap/eth2 pcap/eth3 pcap/ath0 pcap/ath1
</span></span><span><span>
</span></span><span><span><span>echo</span> <span>&#34;Starting packet capture on the pipes: </span><span>$(</span>ls pcap <span>|</span> xargs <span>echo</span><span>)</span><span>&#34;</span>
</span></span><span><span>wget --no-check-certificate -qO- <span>$FRITZIP</span>/cgi-bin/capture_notimeout?ifaceorminor<span>=</span>1-eth0<span>\&amp;</span><span>snaplen</span><span>=</span><span>\&amp;</span><span>capture</span><span>=</span>Start<span>\&amp;</span><span>sid</span><span>=</span><span>$SID</span> &gt; pcap/eth0 <span>&amp;</span>
</span></span><span><span>wget --no-check-certificate -qO- <span>$FRITZIP</span>/cgi-bin/capture_notimeout?ifaceorminor<span>=</span>1-eth2<span>\&amp;</span><span>snaplen</span><span>=</span><span>\&amp;</span><span>capture</span><span>=</span>Start<span>\&amp;</span><span>sid</span><span>=</span><span>$SID</span> &gt; pcap/eth2 <span>&amp;</span>
</span></span><span><span>wget --no-check-certificate -qO- <span>$FRITZIP</span>/cgi-bin/capture_notimeout?ifaceorminor<span>=</span>1-eth3<span>\&amp;</span><span>snaplen</span><span>=</span><span>\&amp;</span><span>capture</span><span>=</span>Start<span>\&amp;</span><span>sid</span><span>=</span><span>$SID</span> &gt; pcap/eth3 <span>&amp;</span>
</span></span><span><span>wget --no-check-certificate -qO- <span>$FRITZIP</span>/cgi-bin/capture_notimeout?ifaceorminor<span>=</span>4-133<span>\&amp;</span><span>snaplen</span><span>=</span><span>\&amp;</span><span>capture</span><span>=</span>Start<span>\&amp;</span><span>sid</span><span>=</span><span>$SID</span> &gt; pcap/ath0 <span>&amp;</span>
</span></span><span><span>wget --no-check-certificate -qO- <span>$FRITZIP</span>/cgi-bin/capture_notimeout?ifaceorminor<span>=</span>4-135<span>\&amp;</span><span>snaplen</span><span>=</span><span>\&amp;</span><span>capture</span><span>=</span>Start<span>\&amp;</span><span>sid</span><span>=</span><span>$SID</span> &gt; pcap/ath1 <span>&amp;</span>
</span></span><span><span>
</span></span><span><span><span>echo</span> <span>&#34;Capturing... (barrier reached)&#34;</span>
</span></span><span><span>
</span></span><span><span><span>wait</span> <span>$(</span><span>jobs</span> -p<span>)</span>
</span></span><span><span><span>echo</span> <span>&#34;All packet capture jobs have been interrupted&#34;</span>
</span></span></code></pre></div><p>Some notable things:</p><ul><li>The authentication result will be saved in a so called “<strong>SID file</strong>”.</li><li>The content of the SID file must be given as query string to <strong>authenticate</strong> the HTTP calls.</li><li>If the login is successful, <strong>FIFO pipes</strong> will be created in the <code>pcap</code> directory, for each interface to monitor.</li><li>The interface identifiers to use are not the same for every model, and can be known by inspecting the Fritz!Box’s capture page.</li><li>If all jobs finish, the container will restart.</li></ul><h3 id="dockerfile">Dockerfile</h3><p>The <code>Dockerfile</code> to build fritzpcap is very tiny and looks like this:</p><div><pre tabindex="0"><code data-lang="dockerfile"><span><span><span>FROM</span><span> alpine:3.17</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>RUN</span> apk add wget curl perl bash <span>&amp;&amp;</span> <span>\
</span></span></span><span><span><span></span>    mkdir /pcap<span>
</span></span></span><span><span><span></span><span>COPY</span> pcap.sh /pcap.sh<span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>ENTRYPOINT</span> <span>[</span><span>&#34;bash&#34;</span><span>,</span> <span>&#34;/pcap.sh&#34;</span><span>]</span><span>
</span></span></span></code></pre></div><h3 id="ntopngs-configuration">ntopng’s configuration</h3><p>Finally, the <code>ntopng.conf</code> file contains:</p><div><pre tabindex="0"><code data-lang="bash"><span><span>-i<span>=</span>/pcap/eth0
</span></span><span><span>-i<span>=</span>/pcap/eth2
</span></span><span><span>-i<span>=</span>/pcap/eth3
</span></span><span><span>-i<span>=</span>/pcap/ath0
</span></span><span><span>-i<span>=</span>/pcap/ath1
</span></span><span><span>--local-networks<span>=</span><span>&#34;192.168.1.0/24&#34;</span>
</span></span><span><span>--community
</span></span></code></pre></div><p>Where the options are pretty much self-explanatory. Further information on <a href="https://www.ntop.org/guides/ntopng/cli_options/cli_options.html">ntopng’s documentation</a>.</p><h3 id="ansible-playbook">Ansible playbook</h3><p>Since while doing this project I have also been learning <strong>Ansible</strong>, I wrapped everything in this playbook:</p><div><pre tabindex="0"><code data-lang="yml"><span><span><span>---</span><span>
</span></span></span><span><span><span></span>- <span>name</span><span>:</span><span> </span><span>ntopng network monitor</span><span>
</span></span></span><span><span><span>  </span><span>hosts</span><span>:</span><span> </span><span>wyse</span><span>
</span></span></span><span><span><span>  </span><span>vars_files</span><span>:</span><span>
</span></span></span><span><span><span>    </span>- <span>../../vault.yml</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>  </span><span>tasks</span><span>:</span><span>
</span></span></span><span><span><span>    </span>- <span>name</span><span>:</span><span> </span><span>Ensure path exists</span><span>
</span></span></span><span><span><span>      </span><span>file</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>path</span><span>:</span><span> </span><span>&#34;~/ntopng/pcap&#34;</span><span>
</span></span></span><span><span><span>        </span><span>owner</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>group</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>state</span><span>:</span><span> </span><span>directory</span><span>
</span></span></span><span><span><span>        </span><span>mode</span><span>:</span><span> </span><span>0755</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span>- <span>name</span><span>:</span><span> </span><span>Docker-Compose file</span><span>
</span></span></span><span><span><span>      </span><span>ansible.builtin.template</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>src</span><span>:</span><span> </span><span>templates/docker-compose.yml</span><span>
</span></span></span><span><span><span>        </span><span>dest</span><span>:</span><span> </span><span>&#34;~/ntopng/docker-compose.yml&#34;</span><span>
</span></span></span><span><span><span>        </span><span>owner</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>group</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>mode</span><span>:</span><span> </span><span>preserve</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span>- <span>name</span><span>:</span><span> </span><span>ntopng.conf</span><span>
</span></span></span><span><span><span>      </span><span>ansible.builtin.template</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>src</span><span>:</span><span> </span><span>templates/ntopng.conf</span><span>
</span></span></span><span><span><span>        </span><span>dest</span><span>:</span><span> </span><span>&#34;~/ntopng/ntopng.conf&#34;</span><span>
</span></span></span><span><span><span>        </span><span>owner</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>group</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>mode</span><span>:</span><span> </span><span>preserve</span><span>
</span></span></span><span><span><span>        
</span></span></span><span><span><span>    </span>- <span>name</span><span>:</span><span> </span><span>fritzpcap</span><span>
</span></span></span><span><span><span>      </span><span>ansible.builtin.copy</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>src</span><span>:</span><span> </span><span>templates/fritzpcap</span><span>
</span></span></span><span><span><span>        </span><span>dest</span><span>:</span><span> </span><span>~/ntopng/</span><span>
</span></span></span><span><span><span>        </span><span>owner</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>group</span><span>:</span><span> </span><span>&#34;{{ ansible_user_id }}&#34;</span><span>
</span></span></span><span><span><span>        </span><span>mode</span><span>:</span><span> </span><span>preserve</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span>- <span>name</span><span>:</span><span> </span><span>up</span><span>
</span></span></span><span><span><span>      </span><span>community.docker.docker_compose</span><span>:</span><span>
</span></span></span><span><span><span>        </span><span>project_src</span><span>:</span><span> </span><span>~/ntopng</span><span>
</span></span></span><span><span><span>        </span><span>build</span><span>:</span><span> </span><span>true</span><span>
</span></span></span><span><span><span>        </span><span>recreate</span><span>:</span><span> </span><span>always</span><span>
</span></span></span></code></pre></div><h2 id="conclusion">Conclusion</h2><p>After these steps, my homenet’s network monitor system was up and running.</p><p>It allowed me to discover <strong>interesting behaviors</strong> and patterns that I could have never discovered otherwise.</p><p>Something funny was discovering that the geo-location of some contacted IPs in Milan was this:</p><p><img src="https://davquar.it/images/post/self-hosting/ntopng-fritzbox-monitoring/funny-ip-geolocation-milan.png" alt="A funny disposition of some geolocated servers in Milan, in which a spiral shape is formed"/></p><p>Maybe someone there is an avid Debian fan; or perhaps a big Fibonacci fan :-D</p><h3>Related Posts</h3><ul><li><a href="https://davquar.it/post/self-hosting/umami-docker/">Self-hosting Umami with Docker Compose</a></li><li><a href="https://davquar.it/post/self-hosting/matomo-docker/">Self-hosting Matomo with Docker</a></li><li><a href="https://davquar.it/post/linux/i3-impressions/">Using i3 for two months: my impressions</a></li></ul></div></div></main></div></div>
  </body>
</html>
