<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.agical.se/en/posts/java-bitset-performance-mystery">Original</a>
    <h1>Java BitSet performance-flicker mystery</h1>
    
    <div id="readability-page-1" class="page"><div>

    <article>
      
      <div>
  
    
      
      
      <div>
        
          
            
          
          
          <p><a href="https://blog.agical.se/en/authors/peter-stromberg">
              <img src="https://blog.agical.se/images/Peter_Stromberg_aka_PEZ.jpeg"/>
            
          </a>
        </p>
      </div>
        
      
</div>

      <p>I am currently chasing a Java <code>BitSet</code> performance-eating ghost. Can’t say I am particularly close to catching it, but I have just managed to <a href="https://github.com/PEZ/ghost-chase-condition">minimize the reproduction substantially</a>. Even if it is not yet particularly minimal, it will have to do for now.</p>
<h2 id="the-problem">The Problem</h2>
<p>When writing implementations of the <a href="https://github.com/PEZ/on-the-code-again-eratosthenes/">Eratosthenes sieve in Clojure</a> I started to notice strange performance behaviour:</p>
<blockquote><p lang="en" dir="ltr">Today I am investigating why my Clojure solution runs so fast on my Macs (an x64 and an M1), but so slow on the some of the benchmarking machines running Dave&#39;s drag-racing competition. It has brought me to <a href="https://twitter.com/_bsless?ref_src=twsrc%5Etfw">@_bsless</a>&#39;s Clojure Goes Fast profiler: <a href="https://t.co/rQUAMpWHPS">https://t.co/rQUAMpWHPS</a></p>— Peter Strömberg aka PEZ (@pappapez) <a href="https://twitter.com/pappapez/status/1486339518902984707?ref_src=twsrc%5Etfw">January 26, 2022</a></blockquote>


<p>There are several strangeties, but one is easier to investigate than the others. A ”flicker” in the performance of the sieve when using Java’s BitSet. It manifests itself when it is run in Docker on som Linux Machines. Like when it is run in the <a href="https://github.com/PlummersSoftwareLLC/Primes">Programming Languages drag-racing</a>, as set up by Dave Plummer. Some of the times (more than half of the times) the sieve performs at only half of the performance it ”should” have.</p>
<p>I started to suspect it was not about <a href="https://clojure.org">Clojure</a>, and decided to implement the sieve in Java in hopes of being able to reproduce it there. Which, a bit to my surprise, I actually could. I have created <a href="https://github.com/PEZ/ghost-chase-condition">a repository</a> for it.</p>
<p>The strange behaviour is not new, it is there also with Java 8 (actually a bit more pronounced, see below).</p>
<h2 id="reproduction">Reproduction</h2>
<p>The repository contains a folder <code>experiments/java-bitset-perf-flicker</code> with these three files:</p>
<ul>
<li><code>PrimeSieve.java</code>, a program that sieves <code>limit</code> numbers of numbers for primes, defaulting to 1 million
<ul>
<li>The program starts with sieving the numbers as many times as it can for 5 seconds as a warmup.</li>
<li>Then sieves the numbers for 5 seconds counting the number of passes.</li>
<li>Then prints the number of passes, along with a sanity check that the sieve is correctly updated.</li>
<li>The BitSet is recreated each pass.</li>
</ul></li>
<li><code>run.sh</code>, a script that will compile <code>PrimeSieve.java</code> and run it X times. X defaults to 10.</li>
<li><code>Dockerfile</code>, a docker image definition based on <code>openjdk:17</code> that when run will run <code>run.sh</code> then exit.</li>
</ul>
<p>This is the code being run over and over again in the benchmark:</p>
<div><pre tabindex="0"><code data-lang="java">  <span>public</span> <span>PrimeSieve</span><span>(</span><span>int</span> <span>n</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>n</span> <span>=</span> <span>n</span><span>;</span>
    <span>int</span> <span>half_n</span> <span>=</span> <span>(</span><span>n</span> <span>+</span> <span>1</span><span>)</span> <span>&gt;&gt;</span> <span>1</span><span>;</span>
    <span>this</span><span>.</span><span>sieve</span> <span>=</span> <span>new</span> <span>BitSet</span><span>(</span><span>half_n</span><span>);</span>
    <span>this</span><span>.</span><span>sieve</span><span>.</span><span>set</span><span>(</span><span>0</span><span>,</span> <span>half_n</span><span>);</span>
  <span>}</span>

  <span>public</span> <span>void</span> <span>run</span><span>()</span> <span>{</span>
    <span>int</span> <span>q</span> <span>=</span> <span>(</span><span>int</span><span>)</span> <span>Math</span><span>.</span><span>ceil</span><span>(</span><span>Math</span><span>.</span><span>sqrt</span><span>(</span><span>n</span><span>));</span>
    <span>for</span> <span>(</span><span>int</span> <span>p</span> <span>=</span> <span>3</span><span>;</span> <span>p</span> <span>&lt;</span> <span>q</span><span>;</span> <span>p</span> <span>+=</span> <span>2</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>sieve</span><span>.</span><span>get</span><span>(</span><span>p</span> <span>&gt;&gt;</span> <span>1</span><span>))</span> <span>{</span>
        <span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>(</span><span>p</span> <span>*</span> <span>p</span><span>)</span> <span>&gt;&gt;</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;</span> <span>n</span> <span>&gt;&gt;</span> <span>1</span><span>;</span> <span>i</span> <span>+=</span> <span>p</span><span>)</span> <span>{</span>
          <span>sieve</span><span>.</span><span>clear</span><span>(</span><span>i</span><span>);</span>
        <span>}</span>
      <span>}</span>
    <span>}</span>
  <span>}</span></code></pre></div>
<p>To run the reproduction:</p>
<div id="cb1"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>$ <span>cd</span> experiments/java-bitset-perf-flicker</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>$ <span>docker</span> build -t primes-java-bitset  . <span>&amp;&amp;</span> <span>docker</span> run --rm -it primes-java-bitset</span></code></pre></div>
<h3 id="sample-output-from-my-mac-m1">Sample output from my Mac M1:</h3>
<pre><code>  0: Passes: 3659, count: 78498, Valid: true
  1: Passes: 3623, count: 78498, Valid: true
  2: Passes: 3678, count: 78498, Valid: true
  3: Passes: 3684, count: 78498, Valid: true
  4: Passes: 3653, count: 78498, Valid: true
  5: Passes: 3663, count: 78498, Valid: true
  6: Passes: 3666, count: 78498, Valid: true
  7: Passes: 3651, count: 78498, Valid: true
  8: Passes: 3672, count: 78498, Valid: true
  9: Passes: 3682, count: 78498, Valid: true</code></pre>
<p>Very stable performance, albeit not stellar.</p>
<h3 id="sample-output-from-a-linux-x64-machine-i-have">Sample output from a Linux x64 machine I have:</h3>
<pre><code>  0: Passes: 6077, count: 78498, Valid: true
  1: Passes: 6059, count: 78498, Valid: true
  2: Passes: 2758, count: 78498, Valid: true
  3: Passes: 2751, count: 78498, Valid: true
  4: Passes: 2752, count: 78498, Valid: true
  5: Passes: 2768, count: 78498, Valid: true
  6: Passes: 2758, count: 78498, Valid: true
  7: Passes: 2760, count: 78498, Valid: true
  8: Passes: 6070, count: 78498, Valid: true
  9: Passes: 2759, count: 78498, Valid: true</code></pre>
<p>It either performs very well, or it performs at 0.5X of very well. When running this 100 times or more, the variance among the 1X runs is low, as is the variance among the 0.5X runs.</p>
<h3 id="also-on-jdk8-just-even-more-crazy">Also on JDK8, just even more crazy</h3>
<p>On JDK8 the program has better ”normal” performance, while the runs hit with the drop is at the same level as with newer JDKs.</p>
<pre><code>  0: Passes: 6431, count: 78498, Valid: true
  1: Passes: 6421, count: 78498, Valid: true
  2: Passes: 2749, count: 78498, Valid: true
  3: Passes: 6381, count: 78498, Valid: true
  4: Passes: 2741, count: 78498, Valid: true
  5: Passes: 2749, count: 78498, Valid: true
  6: Passes: 6397, count: 78498, Valid: true
  7: Passes: 6415, count: 78498, Valid: true
  8: Passes: 2742, count: 78498, Valid: true
  9: Passes: 2745, count: 78498, Valid: true</code></pre>
<h3 id="on-jdk7-all-runs-suffer-the-performance-drop">On JDK7 all runs suffer the performance drop</h3>
<pre><code>0 - Passes: 2743, count: 78498, Valid: true
1 - Passes: 2743, count: 78498, Valid: true
2 - Passes: 2735, count: 78498, Valid: true
3 - Passes: 2748, count: 78498, Valid: true
4 - Passes: 2747, count: 78498, Valid: true
5 - Passes: 2746, count: 78498, Valid: true
6 - Passes: 2734, count: 78498, Valid: true
7 - Passes: 2745, count: 78498, Valid: true
8 - Passes: 2746, count: 78498, Valid: true
9 - Passes: 2751, count: 78498, Valid: true
10 - Passes: 2746, count: 78498, Valid: true
11 - Passes: 2732, count: 78498, Valid: true
12 - Passes: 2750, count: 78498, Valid: true
13 - Passes: 2753, count: 78498, Valid: true
14 - Passes: 2742, count: 78498, Valid: true
15 - Passes: 2747, count: 78498, Valid: true
16 - Passes: 2746, count: 78498, Valid: true
17 - Passes: 2746, count: 78498, Valid: true
18 - Passes: 2744, count: 78498, Valid: true
19 - Passes: 2750, count: 78498, Valid: true
20 - Passes: 2748, count: 78498, Valid: true
21 - Passes: 2743, count: 78498, Valid: true
22 - Passes: 2742, count: 78498, Valid: true
23 - Passes: 2746, count: 78498, Valid: true
24 - Passes: 2746, count: 78498, Valid: true
25 - Passes: 2747, count: 78498, Valid: true
26 - Passes: 2736, count: 78498, Valid: true
27 - Passes: 2738, count: 78498, Valid: true
28 - Passes: 2742, count: 78498, Valid: true
29 - Passes: 2742, count: 78498, Valid: true
30 - Passes: 2735, count: 78498, Valid: true
31 - Passes: 2745, count: 78498, Valid: true
32 - Passes: 2740, count: 78498, Valid: true
33 - Passes: 2737, count: 78498, Valid: true
34 - Passes: 2733, count: 78498, Valid: true
35 - Passes: 2748, count: 78498, Valid: true
36 - Passes: 2742, count: 78498, Valid: true
37 - Passes: 2745, count: 78498, Valid: true
38 - Passes: 2742, count: 78498, Valid: true
39 - Passes: 2749, count: 78498, Valid: true
40 - Passes: 2743, count: 78498, Valid: true
41 - Passes: 2743, count: 78498, Valid: true
42 - Passes: 2736, count: 78498, Valid: true
43 - Passes: 2744, count: 78498, Valid: true
... (snip, same picture with the remaining 56 runs)</code></pre>
<h2 id="is-it-really-about-the-bitset">Is it really about the BitSet?</h2>
<p>Actually, I really don’t have enough information to know this. In fact so far I have seen other strange performance numbers using a regular array of <code>boolean</code>s for the sieve storage. It started with that a Clojure version of this performed much better on my M1 Mac than on this Linux machine. (Both running in Docker). I have on my todo list to summarize the clues as I have seen so far. I’ll update the repository with reproductions of these other setups as I can make them minimal enough.</p>
<p>This one might, or might not, be related:</p>
<blockquote><p lang="en" dir="ltr">On some machines, this code runs 20% slower than the out-commented version, when repeatedly run for 5 secs with n=1M. n and sqrtN are instance variables, and the instance is freshly created each run. I have a theory for the performance diff. Do you? <a href="https://t.co/V1z9wXFl8h">pic.twitter.com/V1z9wXFl8h</a></p>— Peter Strömberg aka PEZ (@pappapez) <a href="https://twitter.com/pappapez/status/1489912784733278209?ref_src=twsrc%5Etfw">February 5, 2022</a></blockquote>


<p>I’ve also speculated around that it might have to do with that the JIT compiler does something different between the two types of performance runs. There’s a commented line in <code>run.sh</code> that runs the sieve program with <code>-XX:+PrintCompilation</code> to print out JIT compiler logs. However, I am not savvy enough to make sense of the output. Which brings me to …</p>
<h2 id="help-wanted">Help wanted</h2>
<p>This mystery is haunting me. I’d love me some help how to minimize the reproduction further.</p>
<p>Please consider sending pull requests with repros, etcetera, and also feel encourage to use the <a href="https://github.com/PEZ/ghost-chase-condition/discussions">Discussions forum</a> on the repository.</p>

      
      
          <hr/>
          <h3><a href="https://blog.agical.se/en/authors/peter-stromberg/">Peter Strömberg</a> <a href="https://blog.agical.se/en/authors/peter-stromberg/index.xml"></a></h3>
          <div>
  <p><a href="https://blog.agical.se/en/authors/peter-stromberg/">
      <img src="https://blog.agical.se/images/Peter_Stromberg_aka_PEZ.jpeg"/>
    </a>
  </p>
  <div><p>Peter Strömberg is an autodidact programming nerd living in Stockholm, Sweden. He has been all over the (coder) place for a long time. After some 20 years in the profession he made an attempt to leave it for another passion of his: Product. That attempt ended when Peter was introduced to Clojure and he felt how it gave him back all the joy of programming, and then some.</p>
<p>You can contract Peter for remote Clojure/ClojureScript gigs up to 80% of an FTE. The other 20% Agical pays him to spend doing open source work. Most often this is about maintaining <a href="https://calva.io">Calva</a>, a popular <a href="https://code.visualstudio.com">Visual Studio Code</a> Clojure IDE extension which Peter created 2018.</p>
<ul>
<li>E-mail: <a href="mail:peter.stromberg@agical.se">peter.stromberg@agical.se</a></li>
<li>Twitter: <span data-cites="pappapez">[@pappapez]</span>(https://twitter.com/pappapez)</li>
</ul>
</div>
</div>
        
      
    </article>


  </div></div>
  </body>
</html>
