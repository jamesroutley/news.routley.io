<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lmstudio.ai/blog/venvstacks">Original</a>
    <h1>Venvstacks: Virtual Environment Stacks for Python</h1>
    
    <div id="readability-page-1" class="page"><div><p>In our recent <a href="https://lmstudio.ai/blog/lmstudio-v0.3.4" node="[object Object]" target="_blank" rel="noopener noreferrer">announcement of Apple MLX support in LM Studio 0.3.4</a>, we <a href="https://lmstudio.ai/blog/lmstudio-v0.3.4#mlx-in-lm-studio-using-python" node="[object Object]" target="_blank" rel="noopener noreferrer">alluded</a> to a Python utility for creating an &#34;... integrated set of independently downloadable Python application environments&#34;.</p>
<p>Today we&#39;re excited to open source this utility: introducing <code node="[object Object]" dir="ltr">venvstacks</code>! [<a href="https://github.com/lmstudio-ai/venvstacks" node="[object Object]" target="_blank" rel="noopener noreferrer">Github repo</a>]</p>
<p><code node="[object Object]" dir="ltr">venvstacks</code> enabled us to ship our <a href="https://github.com/lmstudio-ai/mlx-engine/" node="[object Object]" target="_blank" rel="noopener noreferrer">MLX engine</a>, which is a Python application, within LM Studio without requiring the end user to install any Python depedencies.</p>
<div><p><img src="https://lmstudio.ai/assets/blog/venvstacks-pypi.png" alt="venvstacks on pypi" data-caption="venvstacks is live on PyPi: `$ pip install --user venvstacks`" caption="venvstacks is live on PyPi: `$ pip install --user venvstacks`"/></p><div><p>venvstacks is live on PyPi: <code node="[object Object]" dir="ltr">$ pip install --user venvstacks</code></p></div></div>
<hr node="[object Object]"/>
<h2 id="meet-venvstacks" node="[object Object]"><span>Meet <code node="[object Object]" dir="ltr">venvstacks</code></span><a href="#meet-venvstacks" aria-label="Link to this section" title="Link to &#39;Meet ,[object Object]&#39;"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><i>
<blockquote>
<p>Machine learning and AI libraries for Python are big. Really big.</p>
<p><span>â€” not Douglas Adams</span></p>
</blockquote>
</i></p><p><a href="https://github.com/lmstudio-ai/venvstacks/" node="[object Object]" target="_blank" rel="noopener noreferrer"><code node="[object Object]" dir="ltr">venvstacks</code></a> is a new <code node="[object Object]" dir="ltr">venv</code> based Python project which uses Python&#39;s <code node="[object Object]" dir="ltr">sitecustomize.py</code> environment setup feature to chain together three layers of Python virtual environments:</p>
<ul node="[object Object]">
<li><strong>&#34;Runtime&#34; layers</strong>: environments containing the desired version of a specific Python interpreter</li>
<li><strong>&#34;Framework&#34; layers</strong>: environments containing desired versions of key Python frameworks</li>
<li><strong>&#34;Application&#34; layers</strong>: environments containing components to be launched directly</li>
</ul>
<p>While the layers are archived and published separately, their dependency locking is integrated, allowing the application layers to share dependencies installed in the framework layers, and the framework layers to share dependencies installed in the runtime layers.</p>
<h2 id="using-venvstacks-to-build-and-publish-python-environments" node="[object Object]"><span>Using <code node="[object Object]" dir="ltr">venvstacks</code> to build and publish Python environments</span><a href="#using-venvstacks-to-build-and-publish-python-environments" aria-label="Link to this section" title="Link to &#39;Using ,[object Object], to build and publish Python environments&#39;"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="defining-environment-stacks" node="[object Object]"><span>Defining environment stacks</span><a href="#defining-environment-stacks" aria-label="Link to this section"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>The environment layers to be published are defined in a <code node="[object Object]" dir="ltr">venvstacks.toml</code> stack specification, with a separate array of tables for each kind of layer definition.</p>
<p>For example, the following specification defines a pair of applications which use <a href="https://scikit-learn.org/" node="[object Object]" target="_blank" rel="noopener noreferrer"><code node="[object Object]" dir="ltr">scikit-learn</code></a> as a shared framework layer with <a href="https://numpy.org/" node="[object Object]" target="_blank" rel="noopener noreferrer"><code node="[object Object]" dir="ltr">numpy</code></a> preinstalled in the runtime layer, all running in a controlled Python 3.11 base runtime:</p>

<h3 id="locking-environment-stacks" node="[object Object]"><span>Locking environment stacks</span><a href="#locking-environment-stacks" aria-label="Link to this section"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>

<p>The <code node="[object Object]" dir="ltr">lock</code> subcommand takes the defined layer requirements from the specification, and uses them to perform a complete resolution of all of the environment stacks together that ensures the different layers can be published separately, but still work as expected when deployed to a target system. The locking mechanism is defined such that only changes to modules a given layer uses in lower layers affect them, rather than upper layers needing to be rebuilt for <em>every</em> change to a lower layer.</p>
<h3 id="building-environment-stacks" node="[object Object]"><span>Building environment stacks</span><a href="#building-environment-stacks" aria-label="Link to this section"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>

<p>The <code node="[object Object]" dir="ltr">build</code> subcommand performs the step of converting the layer specifications and their locked requirements into a working Python environment (either a base runtime environment, or a layered virtual environment based on one of the defined runtime environments). If the environments have not already been explicitly locked, the build step will lock them as necessary.</p>
<p>This command is also a &#34;build pipeline&#34; command that allows locking, building, and publishing to be performed in a single step (see the command line help for details).</p>
<h3 id="publishing-environment-layer-archives" node="[object Object]"><span>Publishing environment layer archives</span><a href="#publishing-environment-layer-archives" aria-label="Link to this section"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>

<p>Once the environments have been successfully built, the <code node="[object Object]" dir="ltr">publish</code> command allows each layer to be converted to a separate <a href="https://reproducible-builds.org/" node="[object Object]" target="_blank" rel="noopener noreferrer">reproducible</a> binary archive suitable for transferring to another system, unpacking, and using the unpacked environments to run the included applications (needing only a small post-installation step using a Python script embedded in the built layer archives to correctly relink the deployed environments with each other in their deployed location on the target system).</p>
<p>Metadata regarding the layer definitions and the published artifacts is published alongside the published archives (to <code node="[object Object]" dir="ltr">demo_artifacts/__venvstacks__/</code> in the given example) . This metadata captures both input details (such as the hashes of the locked requirements and the included launch modules) and output details (such as the exact size and exact hash of the built layer archive).</p>
<h3 id="locally-exporting-environment-stacks" node="[object Object]"><span>Locally exporting environment stacks</span><a href="#locally-exporting-environment-stacks" aria-label="Link to this section"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>

<p>Given that even considering the use of <code node="[object Object]" dir="ltr">venvstacks</code> implies that some layer archives may be of significant size (a fully built PyTorch archive weighs in at multiple gigabytes, for example), packing and unpacking the layer archives can take a substantial amount of time.</p>
<p>To avoid that overhead when iterating on layer definitions and launch module details, the <code node="[object Object]" dir="ltr">local-export</code> subcommand allows the built environments to be copied to a different location on the same system, with most of the same filtering steps applied as would be applied when performing the archive pack-and-unpack steps (the omissions are details related to reproducible builds, like clamping the maximum file modification times to known values).</p>
<p>Locally exporting environments produces much of the same metadata as publishing layer archives, but the details related specifically to the published archive (such as its size and expected contents hash) are necessarily omitted.</p>
<h2 id="venvstacks-in-lm-studio" node="[object Object]"><span><code node="[object Object]" dir="ltr">venvstacks</code> in LM Studio</span><a href="#venvstacks-in-lm-studio" aria-label="Link to this section" title="Link to &#39;[object Object], in LM Studio&#39;"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The open source <a href="https://github.com/lmstudio-ai/mlx-engine/" node="[object Object]" target="_blank" rel="noopener noreferrer"><code node="[object Object]" dir="ltr">mlx-engine</code></a> is deployed in the LM Studio desktop application as a launch module in an application layer environment that declares the required runtime package dependencies, running atop an MLX framework layer and a CPython 3.11 base runtime layer.</p>
<p>The use of <code node="[object Object]" dir="ltr">venvstacks</code> then allows LM Studio to introduce additional MLX based features without needing to duplicate the MLX framework layer, and additional Python based features without needing to duplicate the Python runtime layer.</p>
<p>Over time, the ability to distribute multiple application, framework, and even base runtime layers in parallel allows for graceful migrations to newer component versions without any disruption to LM Studio users.</p>
<h2 id="trying-venvstacks-for-yourself" node="[object Object]"><span>Trying <code node="[object Object]" dir="ltr">venvstacks</code> for yourself</span><a href="#trying-venvstacks-for-yourself" aria-label="Link to this section" title="Link to &#39;Trying ,[object Object], for yourself&#39;"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The initial release of <code node="[object Object]" dir="ltr">venvstacks</code> is available from the <a href="https://pypi.org/project/venvstacks/" node="[object Object]" target="_blank" rel="noopener noreferrer">Python Package Index</a>, and can be installed with <code node="[object Object]" dir="ltr">pipx</code> (and similar tools):</p>

<p>For additional usage information, consult the <code node="[object Object]" dir="ltr">venvstacks</code> <a href="https://venvstacks.lmstudio.ai" node="[object Object]" target="_blank" rel="noopener noreferrer">project documentation</a>, and the command line help:</p>

<h2 id="contributing-to-venvstacks-development" node="[object Object]"><span>Contributing to <code node="[object Object]" dir="ltr">venvstacks</code> development</span><a href="#contributing-to-venvstacks-development" aria-label="Link to this section" title="Link to &#39;Contributing to ,[object Object], development&#39;"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><code node="[object Object]" dir="ltr">venvstacks</code> is MIT Licensed and is developed on GitHub:</p>
<ul node="[object Object]">
<li><a href="https://github.com/lmstudio-ai/venvstacks" node="[object Object]" target="_blank" rel="noopener noreferrer">https://github.com/lmstudio-ai/venvstacks</a></li>
</ul>
<p>If you have a suitable use case, the easiest way to contribute to <code node="[object Object]" dir="ltr">venvstacks</code> development is just to try it out, and let us know how that goes. What did you like, what did you dislike, what just plain broke?</p>
<p>If anything does break, then please <a href="https://github.com/lmstudio-ai/venvstacks/issues" node="[object Object]" target="_blank" rel="noopener noreferrer">open an issue</a> (if the problem hasn&#39;t already been reported). If you&#39;re not sure if some behaviour is a bug or not, or would just like to provide general feedback rather than file specific issues or suggestions, the Discord channels mentioned below are the best way to get directly in touch with the developers. The <a href="https://discuss.python.org/c/packaging/14" node="[object Object]" target="_blank" rel="noopener noreferrer">&#34;Packaging&#34; category</a> on <a href="https://discuss.python.org/" node="[object Object]" target="_blank" rel="noopener noreferrer">https://discuss.python.org/</a> is also a reasonable place to provide feedback.</p>
<p>We also already have a <em>lot</em> of ideas for ways in which <code node="[object Object]" dir="ltr">venvstacks</code> <a href="https://github.com/lmstudio-ai/venvstacks/issues?q=is%3Aopen+is%3Aissue+label%3A%22Category%3A+Enhancement%22" node="[object Object]" target="_blank" rel="noopener noreferrer">could be improved</a>.</p>
<p>While we&#39;ve recorded many of those ideas because we plan to implement them ourselves, there are also others where we recorded them because we think they&#39;re interesting and would be open to seeing them included, but don&#39;t have any immediate need for them.</p>
<p>For additional information, consult the <code node="[object Object]" dir="ltr">venvstacks</code> <a href="https://venvstacks.lmstudio.ai/development" node="[object Object]" target="_blank" rel="noopener noreferrer">developer documentation</a>.</p>
<hr node="[object Object]"/>
<p>Discuss <code node="[object Object]" dir="ltr">venvstacks</code> in general in the new <code node="[object Object]" dir="ltr">#venvstacks</code> channel on the <a href="https://discord.com/invite/pypa" node="[object Object]" target="_blank" rel="noopener noreferrer">Python Packaging Discord Server</a>.</p>
<p>Discuss the use of <code node="[object Object]" dir="ltr">mlx-engine</code> and <code node="[object Object]" dir="ltr">venvstacks</code> in LM Studio in the <code node="[object Object]" dir="ltr">#dev-chat</code> channel on the <a href="https://discord.gg/aPQfnNkxGC" node="[object Object]" target="_blank" rel="noopener noreferrer">LM Studio Discord Server</a>.</p>
<p>Download LM Studio for Mac / Windows / Linux from <a href="https://lmstudio.ai/download" node="[object Object]" target="_blank" rel="noopener noreferrer">https://lmstudio.ai/download</a>.</p></div></div>
  </body>
</html>
