<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://razberry.substack.com/p/btree-factorio">Original</a>
    <h1>B-trees in Factorio</h1>
    
    <div id="readability-page-1" class="page"><div class=""><div><div dir="auto"><p>i&#39;ve been reading Database Internals with a book club, and this week was chapter 2, about B-Trees. </p><p><span>but first, </span><strong>binary search trees</strong></p><p>Each node contains a key, and a left node (with a lower key value) and right node (with a higher key value). </p><p>For example, the first node has the key 8, a left node 3, and right node 10. </p><p><span>Note: only works when keys are </span><em>sortable</em><span>, ie you can easily check if value is higher or lower.</span></p><pre><code><code>        8       
       / \      
      3   10     
     / \    \    
    1   6    14       
       / \   /       
      4   7 13</code></code></pre><p>BSTs can get off balanced if too many values are added to only one side, which reduces the effectiveness of the tree. </p><p>the worst case tree: </p><pre><code><code>    8     
      \
      10
        \
         14</code></code></pre><p>which basically becomes the same as a linear sorted list: </p><pre><code><code>8 -&gt; 10 -&gt; 14</code></code></pre><p>BSTs that are unbalanced can be fixed with a lil bit of pivoting, so:</p><pre><code><code>    8     
      \
      10
        \
         14</code></code></pre><pre><code><span>becomes: </span><code>    
  10   
 /  \  
8    14</code></code></pre><p>BSTs however are not good for disk based storage.</p><p>- constantly rebalancing requires updating disk &amp; pointers frequently</p><p>- neighboring nodes might be stored in different pages, meaning reading multiple pages for one search</p><p><strong>B-Trees </strong><span>are basically thicc binary trees.</span></p><p><span>instead of each node having one key, each node can have multiple keys, and </span><em>multiple plus one</em><span> pointers to other nodes. </span></p><pre><code><code>           [ 17 | 24 ]         
         /      |       \      
      [2|5]  [19|20]  [25|30]     
     /  |  \ /  |   \ /  |  \       
   [1] [3]   </code></code></pre><p>in this example, each node has two keys (17 and 24), and three pointers - one to a node with keys that are less than 17, one to a node with keys in between 17 and 24, and one to a node with keys greater than 24. </p><p>now this is normally when i would try to implement a B-tree in some language or the other. and so of course, i decided to try doing so in Factorio. </p><p>(for the uninitiated, Factorio is a factory building game)</p><p>first, a simple binary search tree. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png" data-component-name="Image2ToDOM" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png" width="728" height="520" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;normal&#34;,&#34;height&#34;:1040,&#34;width&#34;:1456,&#34;resizeWidth&#34;:728,&#34;bytes&#34;:5645240,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F730bf45f-0ec4-44b0-b53c-c11939f22c71_1870x1336.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>each “node” has a wooden chest that contains a singular type (the key), and then two paths (the pointers) to other nodes. </p><p>since there’s so inherent way to compare the value of different materials, I gave them an arbitrary order (wood, coal, stone, brick, copper, iron, steel - in that order). Each purple filter arm is comparison check. in the first node, for example, the firs arm  first checks if the item is “equal to” brick, the second arm checks if the item is “less than” (ie is either wood, coal, or stone), and the third checks if item is “greater than” (ie equal to copper, iron, steel). </p><p>(there’s also a “garbage collector” at the top right, which picks up any faulty items that might have made their way to the conveyer belt.)</p><p>Creating the B-tree was slightly more complicated. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png" data-component-name="Image2ToDOM" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_5760,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:false,&#34;imageSize&#34;:&#34;full&#34;,&#34;height&#34;:594,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:6506321,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5d52ee21-d576-4c71-b236-c9f526035c24_2686x1096.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p><span>here, the tree is expanded, so each node contains </span><em>three</em><span> keys, with three filter arms and three wooden chests, along with </span><em>four</em><span> pointers to child nodes. as you can already see, the B-tree holds a-lot more information. In just the second level, the BST holds 2 keys, while the B-tree holds 12, with that number increasing to 48 in level 3. </span></p><p>I didn’t want to manually pick and sort 48 items in factorio, so for now I’ve left the tree empty, until i can come up with a better way to represent values. </p><p>here are both, side by side: </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png" data-component-name="Image2ToDOM" rel="nofollow ugc noopener"><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png" width="1456" height="949" data-attrs="{&#34;src&#34;:&#34;https://substack-post-media.s3.amazonaws.com/public/images/0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png&#34;,&#34;srcNoWatermark&#34;:null,&#34;fullscreen&#34;:null,&#34;imageSize&#34;:null,&#34;height&#34;:949,&#34;width&#34;:1456,&#34;resizeWidth&#34;:null,&#34;bytes&#34;:6686938,&#34;alt&#34;:null,&#34;title&#34;:null,&#34;type&#34;:&#34;image/png&#34;,&#34;href&#34;:null,&#34;belowTheFold&#34;:true,&#34;topImage&#34;:false,&#34;internalRedirect&#34;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0b78f245-2c1b-45ec-af23-7865a9f7ec8c_2142x1396.png 1456w" sizes="100vw" loading="lazy"/></picture></div></a></figure></div><p>here’s the yt video: </p><div id="youtube2-2oRCUNnofDA" data-attrs="{&#34;videoId&#34;:&#34;2oRCUNnofDA&#34;,&#34;startTime&#34;:null,&#34;endTime&#34;:null}" data-component-name="Youtube2ToDOM"><p><iframe src="https://www.youtube-nocookie.com/embed/2oRCUNnofDA?rel=0&amp;autoplay=0&amp;showinfo=0&amp;enablejsapi=0" frameborder="0" loading="lazy" gesture="media" allow="autoplay; fullscreen" allowautoplay="true" allowfullscreen="true" width="728" height="409"></iframe></p></div><p>if you have any ideas on how to improve the factory, pls hit me up! </p><p>&lt;3</p></div></div></div></div>
  </body>
</html>
