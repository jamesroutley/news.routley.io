<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jlongster.com/why-chromaticity-shape">Original</a>
    <h1>Why does the chromaticity diagram look like that?</h1>
    
    <div id="readability-page-1" class="page"><div><a id="block-30b920"></a><p>I&#39;ve always wanted to understand color theory, so I started reading about the XYZ color space which looked like it was the mother of all color spaces. I had no idea what that meant, but it was created in 1931 so studying 93-year old research seemed like a good place to start.</p><p>When reading about the XYZ color space, this cursed image keeps popping up:</p><figure>
<img src="https://static.jlongster.com/20240103/CIE1931xy_blank.svg"/>
<figcaption>
By BenRG - Own work based on: CIExy1931.svg, Public Domain, https://commons.wikimedia.org/w/index.php?curid=7889658
</figcaption>
</figure><p>I say &#34;cursed&#34; because I have no idea what that means. <strong>What the heck is that shape??</strong></p><p>I couldn&#39;t find any reasonably clear answer to my question. It&#39;s obviously not a formula like <code>x = func(y)</code>. Why is it that shape, and where did the colors come from? Obviously the edges are wavelengths which have a specific color, but how did the image above compute every pixel?</p><p>I became obsessed with this question. Below is the path I took to try to answer it.</p><p>I&#39;ll spoil the answer but it might not make sense until you read this article: the shape comes from how our eyes perceive red, green, and blue relative to each other. Skip to the <a href="#more-shape-explorations">last section</a> if you want to see some direct examples.</p><p>The fill colors inside the shape are another story, but a simple explanation is there is some math to calculate the mixture of colors and we can draw the above by sampling millions of points in the space and rendering them onto the 2d image.</p><p>Let&#39;s dig in more.</p><a id="block-f0af28"></a><a id="block-82e29b"></a><h2 id="color-matching-functions"><a href="#color-matching-functions">Color matching functions</a></h2><p>The first place to start is color matching functions. These functions determine the strength of specific wavelengths (color) to contribute so that our eyes perceive a target wavelength (color). We have 3 color matching functions for red, green, and blue (at wavelengths 700, 546, and 435 respectively), and these functions specify how to mix RGB to so that we visually see a <a href="https://en.wikipedia.org/wiki/Spectral_color">spectral color</a>.</p><p>More simply put: imagine that you have red, green, and blue light sources. What is the intensity of each one so that the resulting light matches a specific color on the spectrum?</p><p>Note that these are <em>spectral</em> colors: monochromatic light with a single wavelength. Think of colors on the rainbow. Many colors are not spectral, and are a mix of many spectral colors.</p><p>The CIE 1931 color space defines these RGB color matching functions. The red, green, and blue lines represent the intensity of each RGB light source:</p><a id="block-4f5638"></a><p><em>Note: this plot uses the table from the original study. This raw data must not be used anymore because I couldn&#39;t find it anywhere. I had to extract it myself from an appendix in the <a href="https://ia802802.us.archive.org/23/items/gov.law.cie.15.2004/cie.15.2004.pdf">original report</a>.</em></p><p>Given a wavelength on the X axis, you can see how to &#34;mix&#34; the RGB wavelengths to produce the target color.</p><p>How did they come up with these? They scientifically studied how our eyes mix RGB colors by sitting people down in a room with multiple light sources. One light source was the target color, and the other side had red, green, and blue light sources. People had to adjust the strength of the RGB sources until it matched the target color. They literally had people manually adjust lights and recorded the values! There&#39;s a <a href="https://medium.com/hipster-color-science/a-beginners-guide-to-colorimetry-401f1830b65a">great article</a> that explains the experiments in more detail.</p><p>There&#39;s a <strong>big problem</strong> with the above functions. Can you see it? What do you think a <em>negative</em> red light source means?</p><p>It&#39;s nonsense! That means with this model, given pure RGB lights, there are certain spectral colors that are impossible to recreate. However, this data is still incredibly useful and we can transform it into something meaningful.</p><p>Introducing the XYZ color matching functions. The XYZ color space is simply the RGB color space, but multiplied with a matrix to transform it a bit. The important part is this is a linear transform: it&#39;s literally the same thing, just reshaped a little.</p><p>I found a raw table for the XYZ color matching functions <a href="https://files.cie.co.at/CIE_xyz_1931_2deg.csv">here</a> and this is what it looks like. The CIE 1931 XYZ color matching functions:</p><a id="block-2dad83"></a><p><a href="https://en.wikipedia.org/wiki/CIE_1931_color_space#Construction_of_the_CIE_XYZ_color_space_from_the_Wright%E2%80%93Guild_data">Wikipedia</a> defines the RGB matrix transform as this:</p><pre><code>matrix = [
  <span>2.364613</span>,  -<span>0.89654</span>, -<span>0.468073</span>,
 -<span>0.515166</span>,  <span>1.426408</span>, <span>0.088758</span>,
  <span>0.005203</span>, -<span>0.014408</span>, <span>1.009204</span>
]

[R, G, B] = matrix * [X, Y, Z]</code></pre><p>We can take the XYZ table and transform it with the above matrix, and doing so produces this graph. Look familiar? This is exactly what the RGB graph above looks like (plotted directly from the data table)!</p><a id="block-6de61f"></a><p>Wikipedia also documents an <a href="https://en.wikipedia.org/wiki/CIE_1931_color_space#Analytical_approximation">analytical approximation</a> of this data, which means we can use mathematical functions to generate the data instead of using tables. Press &#34;view source&#34; to see the algorithm:</p><a id="block-bcc10d"></a><h3 id="how-is-this-useful"><a href="#how-is-this-useful">How is this useful?</a></h3><p>Ok, so we have these color matching functions. When displaying these colors with RGB lights though, we can&#39;t even show all of the spectral colors. Transforming it into XYZ space, where everything is positive, fixes the numbers but what&#39;s the point if we still can&#39;t physically show them?</p><p>The XYZ space <em>describes</em> all colors, even colors that are impossible to display. It&#39;s become a standard space to encode colors in a device-independent way, and it&#39;s up to a specific device to interpret them into a space that it can physically produce. This is nice because we have a standard way to encode color information without restricting the possibilities of the future -- as devices become better at displaying more and more colors, they can automatically start displaying them without requiring any infrastructure changes.</p><h2 id="chromaticity"><a href="#chromaticity">Chromaticity</a></h2><p>Now let&#39;s get back to that cursed shape. That&#39;s actually a <a href="https://en.wikipedia.org/wiki/Chromaticity">chromaticity</a> diagram, which is &#34;objective specification of the quality of a color regardless of its luminance&#34;.</p><p>We can derive the chromaticity for a color by taking the XYZ values for it dividing each by the total:</p><pre><code><span>const</span> x = X / (X + Y + Z)
<span>const</span> y = Y / (X + Y + Z)
<span>const</span> z = Z / (X + Y + Z) = <span>1</span> - x - y</code></pre><p>We don&#39;t actually need <code>z</code> because we can derive it given <code>x</code> and <code>y</code>. Hence we have the &#34;xy chromaticity diagram&#34;. Remember how I said it&#39;s a 3d curve projected onto a 2d space? We&#39;ve done that by just dropping <code>z</code>.</p><p>If we want to go back to XYZ from <code>xy</code>, we need the <code>Y</code> value. This is called the <code>xyY</code> color space and is another way to encode colors.</p><p>Alright, let&#39;s try this out. Let&#39;s take the RGB table we rendered above, and plot the chromaticity. We do this by using the above functions, and plotting the <code>x</code> and <code>y</code> points (the colors are a basic estimation):</p><a id="block-58d0f7"></a><p>Hey! Look at that! That looks familiar. Why is it so <em>slanted</em> though? If you look at the x axis, it actually goes into negative! That&#39;s because the RGB data is representing impossible colors.</p><p>Let&#39;s use an RGB to XYZ matrix to transform it into XYZ space (the opposite of what we did before, where we transformed XYZ into RGB) space. If we render the same data but transformed, it looks like this:</p><a id="block-d7d4da"></a><p>Now that&#39;s looking <em>really</em> familiar!</p><p>Just to double-check, let&#39;s render the chromaticity of the XYZ table data. Note that we have more granular data here, so there are more points, but it matches:</p><a id="block-c7a085"></a><p>Ok, so what about colors? How do we fill the middle part with all the colors? Note: this is where I really start to get out my league, but here&#39;s my best attempt.</p><p>What if we iterate over every single pixel in the canvas and try to plot a color for it? The question is given x and y, how do we get a color?</p><p>Here are some steps:</p><p>We scale each x and y point in the canvas to a value between 0 and 1</p><p>Remember above I said we need the <code>Y</code> value to transform back into XYZ space? Turns out that the XYZ space intentionally made <code>Y</code> map to the luminance value of a color, so that means we can... make it up?</p><p>What if we just try to use a luminance value of 1?</p><p>That lets us generate XYZ values, which we then translate into sRGB space (don&#39;t worry about the <code>s</code> there, it&#39;s just RGB space with some gamma correction)</p><p>One immediate problem you hit this produces many invalid colors. We also want to experiment with different values of <code>Y</code>. The demo below has controls to customize its behavior: change <code>Y</code> from 0 to 1, and hide colors with elements below 0 or 255.</p><a id="block-31f373"></a><a id="block-fba881"></a><a id="block-4e7753"></a><inspect-code disabled="false" data-block-id="4e7753"><div>
<p>Y:  <span id="y-slider-value">1</span></p>
<p> <label for="clip-low">Clip colors low (less than 0)</label></p>
<p> <label for="clip-high">Clip colors max (greater than 255)</label></p>
</div></inspect-code><p>That&#39;s neat! We&#39;re getting somewhere, and are obviously constrained by the RGB space. By default, it clips colors with negative values and that produces this triangle. Feels like the dots are starting to connect: the above image is clearly showing connections between XYZ/RGB and limitations of representable colors.</p><p>Even more interesting is if you turn on &#34;clip colors max&#34;. You only see a small slice of color, and you need to move the <code>Y</code> slider morph the shape to &#34;fill&#34; the triangle. Almost like we&#39;re moving through 3d space.</p><p>For each point, there must be a different <code>Y</code> value that is the most optimal representation of that color. For example, blues are rich when <code>Y</code> is low, but greens are only rich when <code>Y</code> is higher.</p><h2 id="taking-a-break-spectrums"><a href="#taking-a-break-spectrums">Taking a break: spectrums</a></h2><p>I&#39;m still confused how to fill that space within the chromaticity diagram, so let&#39;s take a break.</p><p>Let&#39;s create a spectrum. Take the original color matching function. Since that is telling us the XYZ values needed to create a spectral color, shouldn&#39;t we be able to iterate over the wavelengths of visible colors (400-720), get the XYZ values for each one, and convert them to RGB and render a spectrum?</p><a id="block-3222ac"></a><a id="block-0ffafa"></a><p>This looks pretty bad, but why? I found a <a href="https://aty.sdsu.edu/explain/optics/rendering.html">nice article</a> about rendering spectra which seems like another deep hole. My problems aren&#39;t even close to that kind of accuracy; the above isn&#39;t remotely close.</p><p>Turn out I need to convert XYZ to sRGB because that&#39;s what the <code>rgb()</code> color function is assuming when rendering to canvas. The main difference is <em>gamma correction</em> which is another topic.</p><a id="block-5cabf2"></a><p>We&#39;ve learned that sRGB can only render a subset of all colors, and turns out there are other color spaces we can use to tell browsers to render more colors. The <a href="https://en.wikipedia.org/wiki/DCI-P3">p3</a> wide gamut color space is larger than sRGB, and many browsers and displays support it now, so let&#39;s test it.</p><p>You specify this color space by using the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/color_value/color"><code>color</code></a> function in CSS, for example: <code>color(display-p3 r, g, b)</code>. I ran into the same problems where the colors were all wrong, which was surprising because everything I read implied it was linear. Turns out the p3 color space in browsers has the same gamma correction as sRGB, so I needed to include that to get it to work:</p><a id="block-808408"></a><p>If you are seeing this on a wide gamut compatible browser and display, you will see more intense colors. I love that this is a thing, and the idea that so many users are using apps that could be more richly displayed if they supported p3.</p><p>I started having an existential crisis around this point. What are my eyes actually seeing? How do displays... actually work? Looking at the wide gamut spectrum above, what happens if I take a screenshot of it in macOS and send it to a user using a display that doesn&#39;t support p3?</p><p>To test this I started a zoom chat with a friend and shared my screen and showed them the wide gamut spectrum and asked if they could see a difference (the top and bottom should look different). Turns out they could! I have no idea if macOS, zoom, or something else is translating it into sRGB (thus &#34;downgrading&#34; the colors) or actually transmitting p3. (Also, PNG supports p3, but what do monitors that don&#39;t support it do?)</p><p>The sheer complexity of abstractions between my eyes and pixels is overwhelming. There are so many layers which handle reading and writing the individual pixels on my screen, and making it all work across zoom chats, screenshots, and everything is making my mind melt.</p><p>Let&#39;s move on.</p><p><em><strong>A little question:</strong> why does printing use the CMY color system with the primaries of cyan, magenta, and yellow, while digital displays build pixels with the primaries of reg, green, and blue? If cyan, magenta, and yellow allow a wider range of colors via mixing why is RGB better digitally? Answer: because RGB is an additive color system and CMY is a subtractive color system. Materials absorb light, while digital displays emit light.</em></p><h2 id="back-to-the-grind"><a href="#back-to-the-grind">Back to the grind</a></h2><p>We&#39;re not giving up on figuring out the colors of the chromaticity diagram yet.</p><p>I found <a href="https://clarkvision.com/articles/color-cie-chromaticity-and-perception/">this incredible article</a> about how to populate chromaticity diagrams. I still have no idea if this is how the original ones were generated. After all, the colors shown are just an approximation (your screen can&#39;t actually display the true colors near the edges), so maybe there&#39;s some other kind of formula.</p><p>So that I can get back to my daily life and be present with my family, I&#39;m accepting that this is how those images are generated. Let&#39;s try do it ourselves.</p><p>There&#39;s no way to go from an <code>x, y</code> point in the canvas to a color. There&#39;s no formula tells us if it&#39;s a valid point in space or how to approximate a color for it.</p><p>We need to do the opposite: start with an value in the XYZ color space, compute an approximate color, and plot it at the right point by converting it into xy space. But how do we even find valid XYZ values? Not all points are valid inside that space (between 0 and 1 on all three axes). To do <em>that</em> we have to take another step back.</p><p>I got this technique from the <a href="https://clarkvision.com/articles/color-cie-chromaticity-and-perception/">incredible article</a> linked above. What we&#39;re trying to is <strong>render all colors in existence</strong>. Obviously we can&#39;t actually do that, so we need an approximation. Here&#39;s the approach we&#39;ll take:</p><p>First, we need to generate an arbitrary color. The only way to do this is to generate a <a href="https://en.wikipedia.org/wiki/Spectral_line_shape">spectral line shape</a>. Basically it&#39;s a line across all wavelengths (the X axis) that defines how much each wavelength contributes to the color.</p><p>To get the xy, coordinate on the canvas, we need to get the XYZ values for the color. To do that, we multiply the XYZ color matching functions with the spectral line, and then take the integral of each line to get the final XYZ values.</p><p>We do the same for the RGB color. We multiply the RGB color matching functions with the spectral line and take the integral of each one for the final RGB color. (We&#39;ll talk about the colors more later)</p><p>I don&#39;t know if that made any sense, but here&#39;s a demo which might help. The graph in the bottom left is the spectral line we are generating. This represents a specific color, which is shown in the top left. Finally, on the right we plot the color on the chromaticity diagram by summing up the area of the spectral line multiplied by the XYZ color matching functions.</p><p>We generated the spectral line graph with two simple sine curves with a specific width and offset. You can change the offset of each curve with the sliders below. You can see that moving those curves, which generates a different spectral line (and thus color) which plots different points on the diagram.</p><p><strong>By adjusting the sliders, you are basically painting the chromaticity diagram!</strong></p><a id="block-60d1c4"></a><inspect-code disabled="false" data-block-id="60d1c4"></inspect-code><a id="block-ec88e9"></a><a id="block-73d5bc"></a><p>You can see how all of this works but pressing &#34;view source&#34; to see the code.</p><p>Obviously this is a very poor representation of the chromaticity diagram. It&#39;s difficult to cover the whole area; adjusting the offset of the curves only allows you to walk through a subset of the entire space. We would need to change how we are generating spectral lines to fully walk through the space.</p><p>Here&#39;s a demo which attempts to automate this. It&#39;s using the same code as above, except it&#39;s changing both offset and width of the curves and walking through the space better:</p><a id="block-554867"></a><a id="block-bba249"></a><p>I created an <a href="https://codepen.io/jlongster/pen/QWoEwXr?editors=0010">isolated codepen</a> if you want to play with this yourself. If you let this run for a while, you&#39;ll end up with a shape like this:</p><figure>
<img src="https://static.jlongster.com/20240105/ScreenShot2024-01-05e.png"/>
<figcaption>Our rendering of the chromaticity diagram. I&#39;ll take it?
</figcaption></figure><p>We&#39;re still not walking through the full space, but it&#39;s not bad! It at least... vaguely resembles the original diagram?</p><figure>
<img src="https://static.jlongster.com/20240103/CIE1931xy_blank.svg"/>
<figcaption>By BenRG - Own work based on: CIExy1931.svg, Public Domain, https://commons.wikimedia.org/w/index.php?curid=7889658</figcaption>
</figure><h3 id="what-s-going-on-with-the-colors"><a href="#what-s-going-on-with-the-colors">What&#39;s going on with the colors?</a></h3><p>Our coloring isn&#39;t quite right. It&#39;s missing the white spot in the middle and it&#39;s too dark in certain places. Let me explain a little more how we generated these colors.</p><p>After all, didn&#39;t we generate RGB colors? If so, why weren&#39;t they clipped and showing a triangle like before? Or at least we should see more &#34;maxing out&#34; of colors near the edges.</p><p>My first attempts at the above <em>did</em> show this. Here&#39;s a picture where I only took the integral to find the XYZ values, and then took those values and used <code>XYZ_to_sRGB</code> to transform them into RGB colors:</p><figure>
<img src="https://static.jlongster.com/20240105/ScreenShot2024-01-05.png"/>
<figcaption>Way too many &#34;maxed out&#34; colors</figcaption>
</figure><p>We do get more of the bright white spot in the middle, but the colors are far too saturated. It&#39;s clear that many of these colors are actually invalid (they are not in between 0 and 255).</p><p>Another technique I learned from the <a href="https://clarkvision.com/articles/color-cie-chromaticity-and-perception/">incredible article</a> is to avoid using the XYZ points to find the color, and instead do the same integration over the RGB color mapping functions. So we take our spectral line, multiple by each of the RGB functions, and then take the sum of each result to find the individual RGB values.</p><p>Even though this still produces invalid colors, intuitively I can see how it more directly maps onto the RGB space and provides a better interpolation.</p><p>That&#39;s about as far as I got. I wish I had a better answer for how to generate the colors here, and maybe you know? If so, <a href="https://twitter.com/jlongster">give me a shout!</a> I&#39;m satisfied with how far I got, and I bet the final answer uses slightly different color matching functions or something, but it doesn&#39;t feel far off.</p><p>If you have ideas to improve this, please do so <a href="https://codepen.io/jlongster/pen/QWoEwXr?editors=0010">in this demo</a>! I&#39;d love to see any improvements.</p><p>I want to drive home that my above implementation <em>is</em> still generating invalid colors. For example, if I add clipping and avoid rendering any colors with elements outside of the 0-255 range, I get the familiar sRGB triangle:</p><figure>
<img src="https://static.jlongster.com/20240105/ScreenShot2024-01-05d.png"/>
<figcaption>Same image above but only showing valid RGB colors</figcaption>
</figure><p>It turns out that even though colors outside the triangle aren&#39;t rendering accurately, we&#39;re still able to represent a change of color because only 1 or 2 of the RGB channels have maxed out. If green maxes out, changes in the red and blue channels will still show up.</p><h3 id="more-shape-explorations"><a href="#more-shape-explorations">More shape explorations</a></h3><p>But really, <em>why</em> that specific shape? I know it derives from how we perceive red, green, and blue relative to each other. Let&#39;s look at the XYZ color matching functions again:</p><a id="block-140cd2"></a><p>The shape is derived from <em>these</em> shapes. To render chromaticity, you walk through each wavelength above and calculate the percentage of each XYZ value of the total. So there&#39;s a direct relationship.</p><p>Let&#39;s drive this home by generating our own random color matching functions. We generate them with some simple sine waves (view source to see the code):</p><a id="block-7d34e3"></a><p>Now let&#39;s render the chromaticity according to our nonsensical color matching functions:</p><a id="block-6bf276"></a><p>The shape is very different! So that&#39;s it: the shape is due to the XYZ color matching functions, which were derived from experiments that studied how our eyes perceive red, green, and blue light. That&#39;s why the chromaticity diagram represents something meaningful: it&#39;s how our eyes perceive color.</p><p>Resources:</p><ul>
<li><a href="https://en.wikipedia.org/wiki/CIE_1931_color_space#CIE_RGB_color_space">The CIE RGB color space</a></li>
<li><a href="https://medium.com/hipster-color-science/a-beginners-guide-to-colorimetry-401f1830b65a">A Beginner’s Guide to (CIE) Colorimetry</a></li>
<li><a href="https://clarkvision.com/articles/color-cie-chromaticity-and-perception/">CIE Chromaticity and Perception</a></li>
</ul></div></div>
  </body>
</html>
