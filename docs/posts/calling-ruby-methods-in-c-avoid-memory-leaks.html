<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.appsignal.com/2023/01/25/calling-ruby-methods-in-c-avoid-memory-leaks.html">Original</a>
    <h1>Calling Ruby Methods in C: Avoid Memory Leaks</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Memory leaks are a pain for gem users. They are hard to track and can lead to expensive infrastructure costs.</p>
<p>Memory leaks within a C extension are even worse. You&#39;ll see a lot of tools and
articles about finding leaks in Ruby. However, you don&#39;t have the same access to internals in C.</p>
<p>A naive usage of <code>rb_funcall</code> can cause memory leaks: it&#39;s much better to use <code>rb_protect</code> instead. So, if you are a C extension
writer, please read on for the sake of developers who will use your gem.</p>
<p>Let&#39;s get started!</p>
<h2 id="the-issue-with-rb_funcall-and-c">The Issue with <code>rb_funcall</code> and C</h2>
<p><code>rb_funcall</code> can be a great tool when you need to interact between Ruby and the C parts
of your library but only need to write a little C.</p>
<p>However, when you run <code>rb_funcall</code>, you are no longer in C where everything is
straightforward. You can be left in muddy waters if the called function:</p>
<ol>
<li>Completely changes its definition
during runtime</li>
<li>Raises a call</li>
</ol>
<p>Number 1 is the easiest one to catch. You&#39;ll likely end up with a segfault, and
if your test suite is complete enough, you should catch that before publishing.</p>
<p>However, the latter can cause memory leaks and make your codebase way harder
to read. Let&#39;s take a look at that now.</p>
<h2 id="raise-in-ruby-causing-c-memory-leaks">Raise in Ruby Causing C Memory Leaks</h2>
<p>Ruby&#39;s raising mechanism jumps between parts of the code from one scope to the
first parent that catches an error. This is implemented in the MRI using <code>longjmp</code>
and <code>setjmp</code>.</p>
<p>If you are interested in how this is built, read the
<a href="https://rubyhackingguide.ulysse.md/evaluator#raise">Evaluator chapter in the Ruby Hacking Guide</a>. In a nutshell, when
you use a <code>begin..ensure</code> block, you <code>setjmp()</code>, and when you raise within
this block, you <code>longjmp()</code> to the saved position.</p>
<p>So if a function is raised with <code>rb_funcall</code>, the C code called after it
never executes.</p>
<p>The example below illustrates a potential leak. If <code>json_parse</code> raises, it will
leak.</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>VALUE </span><span>rb_create_geometry_hash</span><span>(VALUE </span><span>self</span><span>, VALUE </span><span>wkt</span><span>) {</span></span>
<span><span>    </span><span>// Alloc</span></span>
<span><span>    GEOSWKTReader</span><span>*</span><span> reader </span><span>=</span><span> </span><span>GEOSWKTReader_create</span><span>();</span></span>
<span><span>    GEOSGeoJSONWriter</span><span>*</span><span> writer </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_create</span><span>();</span></span>
<span> </span>
<span><span>    </span><span>// C processing</span></span>
<span><span>    GEOSGeometry</span><span>*</span><span> geom </span><span>=</span><span> </span><span>GEOSWKTReader_read</span><span>(reader, </span><span>StringValuePtr</span><span>(wkt));</span></span>
<span><span>    </span><span>char*</span><span> geojson </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_writeGeometry</span><span>(writer, geom, </span><span>-</span><span>1</span><span>);</span></span>
<span> </span>
<span><span>    </span><span>// Ruby processing</span></span>
<span><span>    VALUE rb_geojson </span><span>=</span><span> </span><span>rb_str_new_cstr</span><span>(geojson);</span></span>
<span><span>    VALUE result </span><span>=</span><span> </span><span>rb_funcall</span><span>(self, </span><span>rb_intern</span><span>(</span><span>&#34;json_parse&#34;</span><span>), </span><span>1</span><span>, rb_geojson);</span></span>
<span> </span>
<span><span>    </span><span>// Free</span></span>
<span><span>    </span><span>GEOSWKTReader_destroy</span><span>(reader);</span></span>
<span><span>    </span><span>GEOSGeom_destroy</span><span>(geom);</span></span>
<span><span>    </span><span>GEOSGeoJSONWriter_destroy</span><span>(writer);</span></span>
<span><span>    </span><span>GEOSFree</span><span>(geojson);</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> result;</span></span>
<span><span>}</span></span></code></pre></div>
<p>Of course, the example above is a bit silly â€” you could invert the freeing
and Ruby processing parts. However, this is not always possible, and
longer function bodies can become more intertwined.</p>
<h2 id="using-beginensure-in-ruby">Using <code>begin..ensure</code> in Ruby</h2>
<p>If you&#39;re using Ruby, you could instead write the above example using
<code>begin..ensure</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="ruby" data-theme="default"><code data-language="ruby" data-theme="default"><span><span>def</span><span> </span><span>create_geometry_hash</span><span>(wkt)</span></span>
<span><span>    reader </span><span>=</span><span> </span><span>GEOSWKTReader</span><span>.</span><span>new</span></span>
<span><span>    writer </span><span>=</span><span> </span><span>GEOSGeoJSONWriter</span><span>.</span><span>new</span></span>
<span> </span>
<span><span>    </span><span>begin</span></span>
<span><span>        json_parse(writer.write(reader.read(wkt)))</span></span>
<span><span>    </span><span>ensure</span></span>
<span><span>        reader.close</span></span>
<span><span>        writer.close</span></span>
<span><span>    </span><span>end</span></span>
<span><span>end</span></span></code></pre></div>
<p>This API is also available in C with <code>rb_rescue</code> and <code>rb_ensure</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>static</span><span> VALUE </span><span>try_ruby_processing</span><span>(VALUE </span><span>args</span><span>) {</span></span>
<span><span>    </span><span>char*</span><span> geojson </span><span>=</span><span> (</span><span>char*</span><span>)args;</span></span>
<span><span>    </span><span>// Ruby processing</span></span>
<span><span>    VALUE rb_geojson </span><span>=</span><span> </span><span>rb_str_new_cstr</span><span>(geojson);</span></span>
<span><span>    VALUE result </span><span>=</span><span> </span><span>rb_funcall</span><span>(self, </span><span>rb_intern</span><span>(</span><span>&#34;json_parse&#34;</span><span>), </span><span>1</span><span>, rb_geojson);</span></span>
<span><span>}</span></span>
<span> </span>
<span><span>struct</span><span> to_free {</span></span>
<span><span>    GEOSWKTReader</span><span>*</span><span> reader;</span></span>
<span><span>    GEOSGeoJSONWriter</span><span>*</span><span> writer;</span></span>
<span><span>    GEOSGeometry</span><span>*</span><span> geom;</span></span>
<span><span>    </span><span>char*</span><span> geojson;</span></span>
<span><span>};</span></span>
<span> </span>
<span><span>static</span><span> VALUE </span><span>ensure_free</span><span>(VALUE </span><span>args</span><span>) {</span></span>
<span><span>    </span><span>struct</span><span> to_free data </span><span>=</span><span> (</span><span>struct</span><span> to_free)args</span></span>
<span><span>    </span><span>GEOSWKTReader_destroy</span><span>(data.reader);</span></span>
<span><span>    </span><span>GEOSGeom_destroy</span><span>(data.geom);</span></span>
<span><span>    </span><span>GEOSGeoJSONWriter_destroy</span><span>(data.writer);</span></span>
<span><span>    </span><span>GEOSFree</span><span>(data.geojson);</span></span>
<span> </span>
<span><span>}</span></span>
<span> </span>
<span><span>VALUE </span><span>rb_create_geometry_hash</span><span>(VALUE </span><span>self</span><span>, VALUE </span><span>wkt</span><span>) {</span></span>
<span><span>    </span><span>// Alloc</span></span>
<span><span>    GEOSWKTReader</span><span>*</span><span> reader </span><span>=</span><span> </span><span>GEOSWKTReader_create</span><span>();</span></span>
<span><span>    GEOSGeoJSONWriter</span><span>*</span><span> writer </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_create</span><span>();</span></span>
<span> </span>
<span><span>    </span><span>// C processing</span></span>
<span><span>    GEOSGeometry</span><span>*</span><span> geom </span><span>=</span><span> </span><span>GEOSWKTReader_read</span><span>(reader, </span><span>StringValuePtr</span><span>(wkt));</span></span>
<span><span>    </span><span>char*</span><span> geojson </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_writeGeometry</span><span>(writer, geom, </span><span>-</span><span>1</span><span>);</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> </span><span>rb_ensure</span><span>(</span></span>
<span><span>        try_ruby_processing, (VALUE)geojson</span></span>
<span><span>        ensure_free, (</span><span>struct</span><span> to_free){ reader, writer, geom, geojson }</span></span>
<span><span>    );</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> result;</span></span>
<span><span>}</span></span></code></pre></div>
<p>However, this is a bit cumbersome, and if you want to add a <code>rescue</code> block to
the party, it gets way less readable. I suggest reading <a href="https://blog.peterzhu.ca/ruby-c-ext-part-8/">Peter Zhu&#39;s &#39;A Rubyist&#39;s Walk Along the C-side (Part 8): Exceptions &amp; Error Handling&#39;</a>
if you want to use the <code>begin..rescue..ensure..end</code> API in C.</p>
<h2 id="using-rb_protect-for-c">Using <code>rb_protect</code> for C</h2>
<p>There is another option. First, let&#39;s see how it could look in Ruby:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="ruby" data-theme="default"><code data-language="ruby" data-theme="default"><span><span>def</span><span> </span><span>create_geometry_hash</span><span>(wkt)</span></span>
<span><span>    reader </span><span>=</span><span> </span><span>GEOSWKTReader</span><span>.</span><span>new</span></span>
<span><span>    writer </span><span>=</span><span> </span><span>GEOSGeoJSONWriter</span><span>.</span><span>new</span></span>
<span> </span>
<span><span>    err </span><span>=</span><span> </span><span>nil</span></span>
<span><span>    result </span><span>=</span><span> </span><span>nil</span></span>
<span><span>    </span><span>begin</span></span>
<span><span>        result </span><span>=</span><span> json_parse(writer.write(reader.read(wkt)))</span></span>
<span><span>    </span><span>rescue</span><span> =&gt; e</span></span>
<span><span>        err </span><span>=</span><span> e</span></span>
<span><span>    </span><span>end</span></span>
<span> </span>
<span><span>    reader.close</span></span>
<span><span>    writer.close</span></span>
<span> </span>
<span><span>    </span><span>raise</span><span> err </span><span>if</span><span> err</span></span>
<span> </span>
<span><span>    result</span></span>
<span><span>end</span></span></code></pre></div>
<p>This looks strange in Ruby, but is a workflow very well
suited to C. The MRI has an API for that, <code>rb_protect</code>, and the C function looks like this:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>VALUE </span><span>ruby_call</span><span>(VALUE </span><span>rb_geojson</span><span>) {</span></span>
<span><span>    </span><span>return</span><span> </span><span>rb_funcall</span><span>(self, </span><span>rb_intern</span><span>(</span><span>&#34;json_parse&#34;</span><span>), </span><span>1</span><span>, rb_geojson);</span></span>
<span><span>}</span></span>
<span> </span>
<span><span>VALUE </span><span>rb_create_geometry_hash</span><span>(VALUE </span><span>self</span><span>, VALUE </span><span>wkt</span><span>) {</span></span>
<span><span>    </span><span>int</span><span> state;</span></span>
<span> </span>
<span><span>    </span><span>// Alloc</span></span>
<span><span>    GEOSWKTReader</span><span>*</span><span> reader </span><span>=</span><span> </span><span>GEOSWKTReader_create</span><span>();</span></span>
<span><span>    GEOSGeoJSONWriter</span><span>*</span><span> writer </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_create</span><span>();</span></span>
<span> </span>
<span><span>    </span><span>// C processing</span></span>
<span><span>    GEOSGeometry</span><span>*</span><span> geom </span><span>=</span><span> </span><span>GEOSWKTReader_read</span><span>(reader, </span><span>StringValuePtr</span><span>(wkt));</span></span>
<span><span>    </span><span>char*</span><span> geojson </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_writeGeometry</span><span>(writer, geom, </span><span>-</span><span>1</span><span>);</span></span>
<span> </span>
<span><span>    </span><span>// Ruby processing</span></span>
<span><span>    VALUE rb_geojson </span><span>=</span><span> </span><span>rb_str_new_cstr</span><span>(geojson);</span></span>
<span><span>    </span><span>rb_protect</span><span>(ruby_call, rb_geojson, </span><span>&amp;</span><span>state);</span></span>
<span> </span>
<span><span>    </span><span>// Free</span></span>
<span><span>    </span><span>GEOSWKTReader_destroy</span><span>(reader);</span></span>
<span><span>    </span><span>GEOSGeom_destroy</span><span>(geom);</span></span>
<span><span>    </span><span>GEOSGeoJSONWriter_destroy</span><span>(writer);</span></span>
<span><span>    </span><span>GEOSFree</span><span>(geojson);</span></span>
<span> </span>
<span><span>    </span><span>if</span><span> (state) </span><span>rb_jump_tag</span><span>(state);</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> result;</span></span>
<span><span>}</span></span></code></pre></div>
<p>The above method will re-raise a Ruby error after having freed
everything.</p>
<p>Note that we could also choose to ignore the error by using an
empty <code>rescue</code> block in Ruby:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>    ...</span></span>
<span> </span>
<span><span>    </span><span>if</span><span> (state) </span><span>rb_set_errinfo</span><span>(Qnil);</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> result;</span><span> // =&gt; nil</span></span>
<span><span>}</span></span></code></pre></div>
<p><em><strong>Warning:</strong> If you do not raise the error, the <code>rb_set_errinfo(Qnil)</code> step is
important so you don&#39;t keep information available about an error that users should not know
about.</em></p>
<p>Or, you can conditionally choose to raise an error, like <code>rescue My::Error</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>    ...</span></span>
<span> </span>
<span><span>    </span><span>if</span><span> (state) {</span></span>
<span><span>        </span><span>if</span><span> (</span><span>rb_obj_is_kind_of</span><span>(</span><span>rb_errinfo</span><span>(), </span><span>rb_define_class_under</span><span>(rb_mMy, </span><span>&#34;Error&#34;</span><span>, rb_eStandardError))) {</span></span>
<span><span>            </span><span>rb_jump_tag</span><span>(state);</span></span>
<span><span>        } </span><span>else</span><span> {</span></span>
<span><span>            </span><span>rb_set_errinfo</span><span>(Qnil);</span></span>
<span><span>        }</span></span>
<span><span>    }</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> result;</span></span>
<span><span>}</span></span></code></pre></div>
<p>You can actually consider <code>rb_errinfo()</code> as the same as the <code>$!</code> global
variable.</p>
<p>This is all great, but when it boils down to one <code>rb_funcall</code> only, we can simplify that API.</p>
<p>The overall idea behind using the <code>rb_protect</code> API when there is a function
to raise is to enhance readability. You don&#39;t need to check if the
function can raise or not, you assume it can, and use the state to work with
that.</p>
<h2 id="the-rb_protect_funcall-proposal">The <code>rb_protect_funcall</code> Proposal</h2>
<p>Let&#39;s isolate <code>rb_funcall</code>, as it&#39;s the only <em>dangerous</em> method to use. Here&#39;s an API that will do that:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>VALUE </span><span>rb_protect_funcall</span><span>(VALUE </span><span>recv</span><span>, ID </span><span>mid</span><span>, </span><span>int*</span><span> </span><span>state</span><span>, </span><span>int</span><span> </span><span>n</span><span>, ...);</span></span></code></pre></div>
<p>This API is the same as <code>rb_funcall</code>, with a <code>state</code> from <code>rb_protect</code>. Hence the
usage is pretty straightforward:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="c" data-theme="default"><code data-language="c" data-theme="default"><span><span>VALUE </span><span>rb_create_geometry_hash</span><span>(VALUE </span><span>self</span><span>, VALUE </span><span>wkt</span><span>) {</span></span>
<span><span>    </span><span>int</span><span> state;</span></span>
<span> </span>
<span><span>    </span><span>// Alloc</span></span>
<span><span>    GEOSWKTReader</span><span>*</span><span> reader </span><span>=</span><span> </span><span>GEOSWKTReader_create</span><span>();</span></span>
<span><span>    GEOSGeoJSONWriter</span><span>*</span><span> writer </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_create</span><span>();</span></span>
<span> </span>
<span><span>    </span><span>// C processing</span></span>
<span><span>    GEOSGeometry</span><span>*</span><span> geom </span><span>=</span><span> </span><span>GEOSWKTReader_read</span><span>(reader, </span><span>StringValuePtr</span><span>(wkt));</span></span>
<span><span>    </span><span>char*</span><span> geojson </span><span>=</span><span> </span><span>GEOSGeoJSONWriter_writeGeometry</span><span>(writer, geom, </span><span>-</span><span>1</span><span>);</span></span>
<span> </span>
<span><span>    </span><span>// Ruby processing</span></span>
<span><span>    VALUE rb_geojson </span><span>=</span><span> </span><span>rb_str_new_cstr</span><span>(geojson);</span></span>
<span><span>    </span><span>rb_protect_funcall</span><span>(self, </span><span>rb_intern</span><span>(</span><span>&#34;json_parse&#34;</span><span>), </span><span>&amp;</span><span>state, </span><span>1</span><span>,  rb_geojson);</span></span>
<span> </span>
<span><span>    </span><span>// Free</span></span>
<span><span>    </span><span>GEOSWKTReader_destroy</span><span>(reader);</span></span>
<span><span>    </span><span>GEOSGeom_destroy</span><span>(geom);</span></span>
<span><span>    </span><span>GEOSGeoJSONWriter_destroy</span><span>(writer);</span></span>
<span><span>    </span><span>GEOSFree</span><span>(geojson);</span></span>
<span> </span>
<span><span>    </span><span>if</span><span> (state) </span><span>rb_jump_tag</span><span>(state);</span></span>
<span> </span>
<span><span>    </span><span>return</span><span> result;</span></span>
<span><span>}</span></span></code></pre></div>
<p>This API is not yet available in Ruby, and may never be. You can take it from
<a href="https://github.com/rgeo/rgeo/blob/893371229adcaf0f84c59e433db494304823990a/ext/geos_c_impl/ruby_more.c#L31-L56">RGeo</a> (MIT LICENSE).</p>
<h2 id="a-real-world-example">A Real-World Example</h2>
<p>If you want to see a real-world example, I encourage you to read the <a href="https://github.com/rgeo/rgeo">RGeo</a>
codebase as we recently switched to going full <code>rb_protect</code>. We even
have some functions, such as <code>rgeo_convert_to_geos_geometry</code>, that propagate
this state for simpler usage. This function is a good place to start digging
around.</p>
<p>Feel free to <a href="https://github.com/rgeo/rgeo">open an issue on RGeo</a> to
discuss the choices we made further.</p>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>In this post, we warned against using <code>rb_funcall</code> with C as it can cause memory leaks. We explored using <code>begin..ensure</code> or <code>rb_protect</code> instead.</p>
<p>Happy coding!</p>
<p><strong>P.S. If you&#39;d like to read Ruby Magic posts as soon as they get off the press, <a href="https://blog.appsignal.com/ruby-magic">subscribe to our Ruby Magic newsletter and never miss a single post</a>!</strong></p></div></div></div>
  </body>
</html>
