<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.psdn.io/posts/systemd-shutdown-unit/">Original</a>
    <h1>Writing systemd units that stop gracefully before shutdown</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div>
    <div>
      <div>
        <div><p>Designing a system to shutdown gracefully can be tricky. In an ideal world, every service would be managed by a systemd unit. <code>ExecStart</code> would start a process that handles SIGTERM by stopping itself and an <code>ExecStop</code> would inform the process and block to gracefully stop the process and its resources.</p>
<p>But not all software stops gracefully or does a full teardown of what it set up. In this post, we‚Äôll look at systemd‚Äôs shutdown behavior and strategies for writing systemd units that perform custom cleanup tasks before shutdown.</p>
<h2 id="systemd">systemd</h2>
<p>As the init system, systemd manages services from start to stop (among many other duties). It‚Äôs the first process to start on boot and the last process to stop on shutdown. Unlike the <strong>sequential</strong> scripts that came before, systemd services are oriented around systemd <em>units</em> with <em>dependency</em> and <em>ordering</em> relationships that allow many services to start (or stop) in <strong>parallel</strong>. These design details will loom large in our discussion:</p>
<ul>
<li>Services start (and stop) in parallel (unless otherwise ordered)</li>
<li>Processes are terminated via SIGTERM, or SIGKILL after a timeout (unless otherwise configured)</li>
<li>On shutdown, services with an ordering dependency stop in the inverse start-up order</li>
</ul>
<h3 id="shutdown">Shutdown</h3>
<p>Let‚Äôs review what happens on shutdown. Several <code>systemctl</code> subcommands (below) can shutdown a system by activating <a href="https://www.freedesktop.org/software/systemd/man/systemd.special.html">special</a> systemd units <code>reboot.target</code>, <code>poweroff.target</code>, and <code>halt.target</code>..</p>
<div><pre tabindex="0"><code data-lang="shell"><span><span>systemctl halt      <span># Shut down and halt the system</span>
</span></span><span><span>systemctl poweroff  <span># Shut down and power-off the system</span>
</span></span><span><span>systemctl reboot    <span># Shut down and reboot the system</span>
</span></span></code></pre></div><p>These target units‚Äô <code>Requires</code> pull in dependencies like <a href="https://www.freedesktop.org/software/systemd/man/systemd-reboot.service.html"><code>systemd-reboot.service</code></a>, <a href="https://www.freedesktop.org/software/systemd/man/systemd-poweroff.service.html"><code>systemd-poweroff.service</code></a>, and <a href="https://www.freedesktop.org/software/systemd/man/systemd-halt.service.html"><code>systemd-halt.service</code></a> (respectively), which all recursively require <a href="https://www.freedesktop.org/software/systemd/man/systemd.special.html#shutdown.target"><code>shutdown.target</code></a>.</p>
<div><pre tabindex="0"><code data-lang="systemd"><span><span><span># reboot.target</span>
</span></span><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>System Reboot</span>
</span></span><span><span><span>Documentation</span><span>=</span><span>man:systemd.special(7)</span>
</span></span><span><span><span>DefaultDependencies</span><span>=</span><span>no</span>
</span></span><span><span><span>Requires</span><span>=</span><span>systemd-reboot.service</span>
</span></span><span><span><span>After</span><span>=</span><span>systemd-reboot.service</span>
</span></span><span><span><span>AllowIsolate</span><span>=</span><span>yes</span>
</span></span><span><span><span>JobTimeoutSec</span><span>=</span><span>30min</span>
</span></span><span><span><span>JobTimeoutAction</span><span>=</span><span>reboot-force</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>Alias</span><span>=</span><span>ctrl-alt-del.target</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="shell"><span><span>sudo systemctl list-dependencies --all --recursive reboot.target
</span></span><span><span>reboot.target
</span></span><span><span>‚óã ‚îî‚îÄsystemd-reboot.service
</span></span><span><span>‚óè   ‚îú‚îÄsystem.slice
</span></span><span><span>‚óè   ‚îÇ ‚îî‚îÄ-.slice
</span></span><span><span>‚óã   ‚îú‚îÄfinal.target
</span></span><span><span>‚óã   ‚îú‚îÄshutdown.target
</span></span><span><span>‚óã   ‚îî‚îÄumount.target
</span></span></code></pre></div><p>By default, all units and scopes have <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#DefaultDependencies="><code>DefaultDependencies=yes</code></a>, which implicitly <a href="https://www.freedesktop.org/software/systemd/man/systemd.special.html#shutdown.target">adds</a> Before=shutdown.target and Conflicts=shutdown.target to them. <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#Conflicts=">Conflicts</a> means starting shutdown.target stops conflicting units. Starting shutdown.target will stop all conflicting units in parallel (unless otherwise ordered).</p>
<p>When stopped, systemd units should gracefully stop running processes, free resources, and wait until that completes. A load balancer might stop accepting new connections and disable its readiness endpoint. A database might flush to disk. An agent might inform a cluster it‚Äôs leaving the group. Any processes remaining after ExecStop runs will be non-gracefully (i.e. violently) SIGKILL‚Äôed by systemd (unless otherwise <a href="https://www.freedesktop.org/software/systemd/man/systemd.kill.html#KillMode=">configured</a>).</p>
<p>Not all software stops gracefully or does a full teardown of what it setup. Some ‚Äúmanager‚Äù services deviate from the systemd‚Äôs model. Some teardown tasks require coodination with a cluster system. Tools like <a href="https://www.freedesktop.org/software/systemd/man/systemd-analyze.html">systemd-analyze</a> don‚Äôt help with shutdowns. And many services may not even be your own software. In these cases, cleanup actions in early shutdown units can help. Let‚Äôs look at some strategies for writing systemd units that perform custom cleanup actions before shutdown.</p>
<h2 id="cleanup-script">Cleanup Script</h2>
<p>Start with a simple <code>cleanup</code> script that simulates a cleanup task. <code>echo</code> logs messages, the loop shows progress, and the <code>sleep</code> ensures it runs long enough to confirm subsequent actions wait. Notice, this script has no reliance on networking, containers, or other system components.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span>
</span></span><span><span>echo <span>&#34;cleaning...&#34;</span>
</span></span><span><span><span>for</span> i in <span>{</span>1..3<span>}</span>; <span>do</span>
</span></span><span><span>  sleep 5s
</span></span><span><span>  echo <span>&#34;waiting...&#34;</span>
</span></span><span><span><span>done</span>
</span></span><span><span>
</span></span><span><span>echo <span>&#34;done&#34;</span>
</span></span></code></pre></div><p>Put this script in <code>/usr/local/bin/cleanup</code> and make it executable. If you later see a systemd 203/EXEC error, revisit this section.</p>



<h2 id="execstart-script">ExecStart Script</h2>
<p>Now consider a systemd oneshot unit that runs <code>cleanup</code> as an ExecStart script. Its a first attempt, but as we‚Äôll see it‚Äôs incorrect.</p>
<div><pre tabindex="0"><code data-lang="systemd"><span><span><span># /etc/systemd/system/clean.service</span>
</span></span><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Clean on shutdown</span>
</span></span><span><span><span>Before</span><span>=</span><span>shutdown.target    # implicit</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Type</span><span>=</span><span>oneshot</span>
</span></span><span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span><span><span><span>ExecStart</span><span>=</span><span>/usr/local/bin/cleanup</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>shutdown.target</span>
</span></span></code></pre></div><p>This unit makes shutdown.target depend on clean.service, uses Before=shutdown.target to order clean.service before shutdown.target and uses <a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#Type=">Type=oneshot</a> so the serivce will be considered started when the script exits (to delay shutdown until cleanup finishes). RemainAfterExit is used to keep the service active even after the script has exited.</p>



<p>Enable the clean.service, <code>systemctl reboot</code>, and check the journal logs later‚Ä¶</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Sep 28 23:55:01 ip-10-0-13-150 systemd[1]: Starting clean.service - Clean on shutdown...
</span></span><span><span>Sep 28 23:55:01 ip-10-0-13-150 cleanup[6796]: cleaning...
</span></span><span><span>-- Boot 8e4734a82c754e549c9a9292ca5988fb --
</span></span></code></pre></div><p>This approach isn‚Äôt right. You may not even see logs. The clean service may start, but it won‚Äôt delay shutdown. shutdown.target conflicts with all units, so clean.service gets stopped before it can finish. You might think of adding DefaultDependencies=no, but <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#Before=">systemd.unit man pages</a> tell us it won‚Äôt delay shutdown - ‚ÄúGiven two units with any ordering dependency between them, if one unit is shut down and the other is started up, the shutdown is ordered before the start-up‚Äù</p>
<h2 id="execstop-script">ExecStop Script</h2>
<p>Next, consider a systemd oneshot unit that runs cleanup as an ExecStop script.</p>
<div><pre tabindex="0"><code data-lang="systemd"><span><span><span># /etc/systemd/system/clean.service</span>
</span></span><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Clean on shutdown</span>
</span></span><span><span><span>After</span><span>=</span><span>multi-user.target</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Type</span><span>=</span><span>oneshot</span>
</span></span><span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span><span><span><span>ExecStart</span><span>=</span><span>/bin/true</span>
</span></span><span><span><span>ExecStop</span><span>=</span><span>/usr/local/bin/cleanup</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>multi-user.target</span>
</span></span></code></pre></div><p>This unit is pulled in by multi-user.target, but ordered to start After=multi-user.target, fairly late in startup. Since ordered units are stopped in reverse start order, clean should <em>begin</em> stopping before other units.</p>
<p>Enable and start <code>clean.service</code>. Confirm it‚Äôs <code>active</code> (but exited).</p>
<div><pre tabindex="0"><code data-lang="shell"><span><span>‚óè .service - Clean on shutdown
</span></span><span><span>     Loaded: loaded <span>(</span>/etc/systemd/system/clean.service; enabled; vendor preset: disabled<span>)</span>
</span></span><span><span>     Active: active <span>(</span>exited<span>)</span> since Thu 2022-09-29 20:21:17 UTC; 2min 49s ago
</span></span><span><span>    Process: <span>1383</span> ExecStart<span>=</span>/bin/true <span>(</span>code<span>=</span>exited, status<span>=</span>0/SUCCESS<span>)</span>
</span></span><span><span>   Main PID: <span>1383</span> <span>(</span>code<span>=</span>exited, status<span>=</span>0/SUCCESS<span>)</span>
</span></span><span><span>        CPU: 2ms
</span></span><span><span>
</span></span><span><span>Sep <span>29</span> 20:21:17 ip-10-0-13-150 systemd<span>[</span>1<span>]</span>: Starting clean.service - Clean on shutdown...
</span></span><span><span>Sep <span>29</span> 20:21:17 ip-10-0-13-150 systemd<span>[</span>1<span>]</span>: Finished clean.service - Clean on shutdown.
</span></span></code></pre></div><p>Note the Boot ID in journal logs and then run systemctl reboot.</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>...
</span></span><span><span>-- Boot 0e40d519972b4cd7bc09374b3072788d --
</span></span><span><span>Sep 28 20:18:24 ip-10-0-13-150 systemd[1]: Starting clean.service - Clean on shutdown...
</span></span><span><span>Sep 28 20:18:24 ip-10-0-13-150 systemd[1]: Finished clean.service - Clean on shutdown.
</span></span></code></pre></div><p>After reboot, check the logs. I‚Äôve annotated when systemctl reboot was run üîÅ.</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>...
</span></span><span><span>Sep 28 20:18:24 ip-10-0-13-150 systemd[1]: Finished clean.service - Clean on shutdown.
</span></span><span><span>üîÅ
</span></span><span><span>Sep 29 20:20:38 ip-10-0-13-150 systemd[1]: Stopping clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 20:20:38 ip-10-0-13-150 cleanup[367051]: cleaning...
</span></span><span><span>Sep 29 20:20:43 ip-10-0-13-150 cleanup[367077]: waiting...
</span></span><span><span>Sep 29 20:20:48 ip-10-0-13-150 cleanup[367080]: waiting...
</span></span><span><span>Sep 29 20:20:53 ip-10-0-13-150 cleanup[367132]: waiting...
</span></span><span><span>Sep 29 20:20:53 ip-10-0-13-150 cleanup[367134]: done
</span></span><span><span>Sep 29 20:20:53 ip-10-0-13-150 systemd[1]: clean.service: Deactivated successfully.
</span></span><span><span>Sep 29 20:20:53 ip-10-0-13-150 systemd[1]: Stopped clean.service - Clean on shutdown.
</span></span><span><span>-- Boot 8e97b43271024c64b0775c43dc519c5b --
</span></span><span><span>Sep 29 20:21:17 ip-10-0-13-150 systemd[1]: Starting clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 20:21:17 ip-10-0-13-150 systemd[1]: Finished clean.service - Clean on shutdown.
</span></span></code></pre></div><p>When the unit stops, the cleanup script runs to completion, delaying shutdown. Then the reboot occurs. On the next boot, the unit starts (<code>/bin/true</code>) and finishes.</p>
<p>It works as expected here, but there‚Äôs a caveat. Ordered units are stopped in reverse start order, but remember that many services are stopped concurrently. <code>cleanup</code> has no guarantee what services will be up when it‚Äôs running as ExecStop. <code>cleanup</code> only works because it doesn‚Äôt depend on other system components. For example, if our script used networking, we‚Äôd need to add After=network.target to ensure that on shutdown, clean stops before networking stops.</p>
<p>Let‚Äôs move on to a containerized cleanup task, a common case these days.</p>
<h2 id="execstop-container">ExecStop container</h2>
<p>Consider a systemd unit that runs a container process as its <code>ExecStop</code> before shutdown. Unlike the minimal script used earlier, starting a container requires many system components. And <code>ExecStop</code> <em>begins</em> concurrently with other stopping units. This won‚Äôt go well.</p>
<div><pre tabindex="0"><code data-lang="systemd"><span><span><span># /etc/systemd/system/clean.service</span>
</span></span><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Clean on shutdown</span>
</span></span><span><span><span>After</span><span>=</span><span>multi-user.target</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Type</span><span>=</span><span>oneshot</span>
</span></span><span><span><span>RemainAfterExit</span><span>=</span><span>yes</span>
</span></span><span><span><span>ExecStart</span><span>=</span><span>/bin/true</span>
</span></span><span><span><span>ExecStopPre</span><span>=</span><span>-/usr/bin/podman rm clean</span>
</span></span><span><span><span>ExecStop</span><span>=</span><span>/usr/bin/podman run </span>\
</span></span><span><span><span>  --name clean </span>\
</span></span><span><span><span>  --log-driver=k8s-file </span>\
</span></span><span><span><span>  --rm </span>\
</span></span><span><span><span>  -v /usr/local/bin:/scripts </span>\
</span></span><span><span><span>  --stop-timeout=60 </span>\
</span></span><span><span><span>  --entrypoint /scripts/cleanup </span>\
</span></span><span><span><span>  docker.io/fedora:36</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>multi-user.target</span>
</span></span></code></pre></div><p>Enable and start clean.service. When clean.service is stopped manually, <code>ExecStop</code> will create a container, mount <code>/usr/local/bin</code>, and run the same <code>cleanup</code> script fine.</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Sep 29 21:36:41 ip-10-0-13-150 systemd[1]: Starting clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 21:36:41 ip-10-0-13-150 systemd[1]: Finished clean.service - Clean on shutdown.
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 systemd[1]: Stopping clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 podman[10701]: 2022-09-29 21:37:35.32232541 +0000 UTC m=+0.076846159 container create 2e0a21b085113ad6b5eab83a1f4b85081045727b711c89909dc7d204abb25e61 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 podman[10701]: 2022-09-29 21:37:35.292987568 +0000 UTC m=+0.047508358 image pull  docker.io/fedora:36
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 podman[10701]: 2022-09-29 21:37:35.516155501 +0000 UTC m=+0.270676209 container init 2e0a21b085113ad6b5eab83a1f4b85081045727b711c89909dc7d204abb25e61 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 podman[10701]: 2022-09-29 21:37:35.5276157 +0000 UTC m=+0.282136425 container start 2e0a21b085113ad6b5eab83a1f4b85081045727b711c89909dc7d204abb25e61 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 podman[10701]: 2022-09-29 21:37:35.527985526 +0000 UTC m=+0.282506267 container attach 2e0a21b085113ad6b5eab83a1f4b85081045727b711c89909dc7d204abb25e61 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:37:35 ip-10-0-13-150 podman[10701]: cleaning...
</span></span><span><span>Sep 29 21:37:40 ip-10-0-13-150 podman[10701]: waiting...
</span></span><span><span>Sep 29 21:37:45 ip-10-0-13-150 podman[10701]: waiting...
</span></span><span><span>Sep 29 21:37:50 ip-10-0-13-150 podman[10701]: waiting...
</span></span><span><span>Sep 29 21:37:50 ip-10-0-13-150 podman[10701]: done
</span></span><span><span>Sep 29 21:37:50 ip-10-0-13-150 podman[10701]: 2022-09-29 21:37:50.536310798 +0000 UTC m=+15.290831522 container died 2e0a21b085113ad6b5eab83a1f4b85081045727b711c89909dc7d204abb25e61 (image=docker.io/library/fedora:36, name=clean, health_status=)
</span></span><span><span>Sep 29 21:37:50 ip-10-0-13-150 podman[10873]: 2022-09-29 21:37:50.707597051 +0000 UTC m=+0.115808702 container remove 2e0a21b085113ad6b5eab83a1f4b85081045727b711c89909dc7d204abb25e61 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:37:50 ip-10-0-13-150 systemd[1]: clean.service: Deactivated successfully.
</span></span><span><span>Sep 29 21:37:50 ip-10-0-13-150 systemd[1]: Stopped clean.service - Clean on shutdown.
</span></span></code></pre></div><p>But during a real shutdown, ExecStop won‚Äôt be able to create a container.</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Sep 29 21:41:21 ip-10-0-13-150 systemd[1]: Stopping clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 podman[12002]: 2022-09-29 21:41:21.263765577 +0000 UTC m=+0.192250288 container create 214a91497691b33a2ee77a0ad6dc3b3894e102abf84d641f5df2abfc842d1cd0 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 podman[12002]: 2022-09-29 21:41:21.190543212 +0000 UTC m=+0.119027932 image pull  docker.io/fedora:36
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 podman[12002]: time=&#34;2022-09-29T21:41:21Z&#34; level=error msg=&#34;Unable to clean up network for container 214a91497691b33a2ee77a0ad6dc3b3894e102abf84d641f5df2abfc842d1cd0: \&#34;error tearing down network namespace configuration for container 214a91497691b33a2ee77a0ad6dc3b3894e102abf84d641f5df2abfc842d1cd0: netavark: failed to delete if podman0: Received a netlink error message Operation not supported (os error 95)\&#34;&#34;
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 podman[12072]: 2022-09-29 21:41:21.689689685 +0000 UTC m=+0.185177533 container remove 214a91497691b33a2ee77a0ad6dc3b3894e102abf84d641f5df2abfc842d1cd0 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 podman[12002]: Error: OCI runtime error: crun: sd-bus call: Transaction for libpod-214a91497691b33a2ee77a0ad6dc3b3894e102abf84d641f5df2abfc842d1cd0.scope/start is destructive (shutdown.target has &#39;start&#39; job queued, but &#39;stop&#39; is included in transaction).: Resource deadlock avoided
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 systemd[1]: clean.service: Control process exited, code=exited, status=126/n/a
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 systemd[1]: clean.service: Failed with result &#39;exit-code&#39;.
</span></span><span><span>Sep 29 21:41:21 ip-10-0-13-150 systemd[1]: Stopped clean.service - Clean on shutdown.
</span></span><span><span>-- Boot 332c28360e38479c91f5cab4898413b4 --
</span></span><span><span>Sep 29 21:41:45 ip-10-0-13-150 systemd[1]: Starting clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 21:41:45 ip-10-0-13-150 systemd[1]: Finished clean.service - Clean on shutdown.
</span></span></code></pre></div><p>I‚Äôve made this mistake myself and seen users struggle with it without recognizing it. With today‚Äôs daemonless container runners, it‚Äôs difficult to define ordering dependencies to ensure a container can reliably <em>start</em> as part of <em>shutdown</em>. This is an open problem area that depends on the container runner.</p>
<h2 id="execstop-an-existing-container">ExecStop an existing container</h2>
<p>Let‚Äôs be more clever. If we can‚Äôt easily <em>start</em> a container during shutdown, let‚Äôs have the container running, but awaiting a signal. Create a new script called <code>await</code> to reflect the new approach. Run this script directly to verify it waits, then prints messages when you <code>Ctrl-C</code>.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span>
</span></span><span><span>cleanup<span>()</span> <span>{</span>
</span></span><span><span>  echo <span>&#34;cleaning...&#34;</span>
</span></span><span><span>  <span>for</span> i in <span>{</span>1..3<span>}</span>; <span>do</span>
</span></span><span><span>    sleep 5s
</span></span><span><span>    echo <span>&#34;waiting...&#34;</span>
</span></span><span><span>  <span>done</span>
</span></span><span><span>
</span></span><span><span>  echo <span>&#34;done&#34;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span>trap cleanup SIGINT SIGTERM
</span></span><span><span>
</span></span><span><span>echo <span>&#34;Awaiting signals&#34;</span>
</span></span><span><span>sleep infinity &amp; wait $!
</span></span></code></pre></div><p>We take care that the await bash script will run as process 1 in the container and handle signals. Non-builtin commands (like sleep) can defer <a href="https://www.gnu.org/software/bash/manual/html_node/Signals.html#Signals">signals</a> in non-interactive contexts, so it‚Äôs critical we background sleep and use the builtin <code>wait</code> (interruptible) to wait for the previous command.</p>
<p>Create, enable, and start a new clean.service systemd unit.</p>
<div><pre tabindex="0"><code data-lang="systemd"><span><span><span># /etc/systemd/system/clean.service</span>
</span></span><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Clean on shutdown</span>
</span></span><span><span><span>After</span><span>=</span><span>multi-user.target</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Type</span><span>=</span><span>simple</span>
</span></span><span><span><span>ExecStartPre</span><span>=</span><span>-/usr/bin/podman rm clean</span>
</span></span><span><span><span>ExecStart</span><span>=</span><span>/usr/bin/podman run </span>\
</span></span><span><span><span>  --name clean </span>\
</span></span><span><span><span>  --log-driver=k8s-file </span>\
</span></span><span><span><span>  --rm </span>\
</span></span><span><span><span>  -v /usr/local/bin:/scripts </span>\
</span></span><span><span><span>  --stop-timeout=60 </span>\
</span></span><span><span><span>  --entrypoint /scripts/await </span>\
</span></span><span><span><span>  docker.io/fedora:36</span>
</span></span><span><span><span>ExecStop</span><span>=</span><span>/usr/bin/podman stop clean</span>
</span></span><span><span><span>TimeoutStopSec</span><span>=</span><span>0</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>multi-user.target</span>
</span></span></code></pre></div><p>This unit is a typical long-running service with <code>Type=simple</code>. Podman starts a container and proxies signals (like <code>SIGTERM</code> on shutdown) to the container‚Äôs first process. When the unit stops, podman stop sends a <code>SIGTERM</code> to the container‚Äôs first process too (and a <code>SIGKILL</code> after <code>--stop-timeout</code>, which defaults to 10s).</p>
<p>As before, the unit is pulled in by multi-user.target, but ordered to start <code>After</code> multi-user.target, fairly late in startup. Ordered units are stopped in reverse start order, so clean should <em>begin</em> stopping before other units. The service <code>TimeoutStopSec</code> determines how long systemd should wait for ExecStop.</p>
<p>Confirm that the unit is active and the container is running, awaiting a signal.</p>
<div><pre tabindex="0"><code data-lang="shell"><span><span>systemctl status clean.service
</span></span><span><span>‚óè clean.service - Clean on shutdown
</span></span><span><span>     Loaded: loaded <span>(</span>/etc/systemd/system/clean.service; enabled; vendor preset: disabled<span>)</span>
</span></span><span><span>     Active: active <span>(</span>running<span>)</span> since Fri 2022-10-21 16:34:41 UTC; 1min 12s ago
</span></span><span><span>   Main PID: <span>239609</span> <span>(</span>podman<span>)</span>
</span></span><span><span>      Tasks: <span>9</span> <span>(</span>limit: 4427<span>)</span>
</span></span><span><span>     Memory: 18.6M
</span></span><span><span>        CPU: 275ms
</span></span><span><span>     CGroup: /system.slice/clean.service
</span></span><span><span>             ‚îú‚îÄ <span>239609</span> /usr/bin/podman run --name clean --log-driver<span>=</span>k8s-file --rm -v /usr/local/bin:/scripts --stop-timeout<span>=</span><span>60</span> --entrypoint /scripts/await docker.io/fedora:36
</span></span><span><span>             ‚îî‚îÄ <span>239680</span> /usr/bin/conmon --api-version <span>1</span> -c 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 -u 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70/userdata -p /run/containers/storage/overlay-containers/21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70/userdata/pidfile -n clean --exit-dir /run/libpod/exits --full-attach -s -l k8s-file:/var/lib/containers/storage/overlay-containers/21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70/userdata/ctr.log --log-level warning --runtime-arg --log-format<span>=</span>json --runtime-arg --log --runtime-arg<span>=</span>/run/containers/storage/overlay-containers/21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70/userdata/oci-log --conmon-pidfile /run/containers/storage/overlay-containers/21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg <span>&#34;&#34;</span> --exit-command-arg --network-backend --exit-command-arg netavark --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt<span>=</span>nodev,metacopy<span>=</span>on --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg --rm --exit-command-arg 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70
</span></span><span><span>
</span></span><span><span>Sep <span>29</span> 16:34:41 ip-10-0-0-27 systemd<span>[</span>1<span>]</span>: Started clean.service - Clean on shutdown.
</span></span><span><span>Sep <span>29</span> 16:34:42 ip-10-0-0-27 podman<span>[</span>239609<span>]</span>: 2022-10-21 16:34:42.02827346 +0000 UTC m<span>=</span>+0.073162795 container create 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 <span>(</span>image<span>=</span>docker.io/library/fedora:36, name<span>=</span>clean, health_status<span>=</span>, maintainer<span>=</span>Clement Verna &lt;cverna@fedoraproject.org&gt;<span>)</span>
</span></span><span><span>Sep <span>29</span> 16:34:42 ip-10-0-0-27 podman<span>[</span>239609<span>]</span>: 2022-10-21 16:34:41.999309821 +0000 UTC m<span>=</span>+0.044199164 image pull  docker.io/fedora:36
</span></span><span><span>Sep <span>29</span> 16:34:42 ip-10-0-0-27 podman<span>[</span>239609<span>]</span>: 2022-10-21 16:34:42.253726035 +0000 UTC m<span>=</span>+0.298615370 container init 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 <span>(</span>image<span>=</span>docker.io/library/fedora:36, name<span>=</span>clean, health_status<span>=</span>, maintainer<span>=</span>Clement Verna &lt;cverna@fedoraproject.org&gt;<span>)</span>
</span></span><span><span>Sep <span>29</span> 16:34:42 ip-10-0-0-27 podman<span>[</span>239609<span>]</span>: 2022-10-21 16:34:42.263454996 +0000 UTC m<span>=</span>+0.308344331 container start 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 <span>(</span>image<span>=</span>docker.io/library/fedora:36, name<span>=</span>clean, health_status<span>=</span>, maintainer<span>=</span>Clement Verna &lt;cverna@fedoraproject.org&gt;<span>)</span>
</span></span><span><span>Sep <span>29</span> 16:34:42 ip-10-0-0-27 podman<span>[</span>239609<span>]</span>: 2022-10-21 16:34:42.263872042 +0000 UTC m<span>=</span>+0.308761624 container attach 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 <span>(</span>image<span>=</span>docker.io/library/fedora:36, name<span>=</span>clean, health_status<span>=</span>, maintainer<span>=</span>Clement Verna &lt;cverna@fedoraproject.org&gt;<span>)</span>
</span></span><span><span>Sep <span>29</span> 16:34:42 ip-10-0-0-27 podman<span>[</span>239609<span>]</span>: Awaiting signals
</span></span></code></pre></div>


<p>Note the boot id and run systemctl reboot (annotated üîÅ). After reboot, check the logs.</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Sep 29 16:34:42 ip-10-0-0-27 podman[239609]: Awaiting signals
</span></span><span><span>üîÅ
</span></span><span><span>Sep 29 16:42:06 ip-10-0-0-27 podman[239609]: cleaning...
</span></span><span><span>Sep 29 16:42:06 ip-10-0-0-27 podman[239609]: Terminated
</span></span><span><span>Sep 29 16:42:06 ip-10-0-0-27 systemd[1]: Stopping clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 16:42:11 ip-10-0-0-27 podman[239609]: cleaning...
</span></span><span><span>Sep 29 16:42:16 ip-10-0-0-27 podman[239609]: waiting...
</span></span><span><span>Sep 29 16:42:21 ip-10-0-0-27 podman[239609]: waiting...
</span></span><span><span>Sep 29 16:42:26 ip-10-0-0-27 podman[239609]: waiting...
</span></span><span><span>Sep 29 16:42:26 ip-10-0-0-27 podman[239609]: done
</span></span><span><span>Sep 29 16:42:26 ip-10-0-0-27 podman[239609]: waiting...
</span></span><span><span>Sep 29 16:42:31 ip-10-0-0-27 podman[239609]: waiting...
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[239609]: waiting...
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[239609]: done
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[239609]: 2022-10-21 16:42:36.44559863 +0000 UTC m=+474.490487974 container died 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 (image=docker.io/library/fedora:36, name=clean, health_status=)
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[241961]: 2022-10-21 16:42:36.80223871 +0000 UTC m=+30.342432111 container cleanup 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[241961]: clean
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[239609]: 2022-10-21 16:42:36.907856847 +0000 UTC m=+474.952746174 container remove 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 podman[239609]: time=&#34;2022-10-21T16:42:36Z&#34; level=error msg=&#34;forwarding signal 15 to container 21009bcf34c2fbd3810f7301d1693dba084d9d098cdcbd9e3b15d5dc22e3bd70: container has already been removed&#34;
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 systemd[1]: clean.service: Deactivated successfully.
</span></span><span><span>Sep 29 16:42:36 ip-10-0-0-27 systemd[1]: Stopped clean.service - Clean on shutdown.
</span></span><span><span>-- Boot d0b5eba20ebd452aae5dbffaee19eff8 --
</span></span></code></pre></div><p>The cleanup task runs and delays shutdown, but it runs twice. The running container process receives the <code>SIGTERM</code> <em>and</em> podman stop also sends a <code>SIGTERM</code>. Reproduce this by running the await script directly. Hit Ctrl-C multiple times and see cleanup invoked multiple times.</p>
<p>There are a few ways to address this. One is to remove the podman stop call in ExecStop - a drawback is that normal systemctl operations like systemctl stop clean.service won‚Äôt work and we need to SIGTERM the container ourselves when debugging.</p>
<p>Instead, let‚Äôs clear/reset the trap. It‚Äôs icky to handle signals and concurrency in shell scripts and would be much nicer with Go, but it‚Äôll suffice for a blog post.</p>
<div><pre tabindex="0"><code data-lang="bash"><span><span>cleanup<span>()</span> <span>{</span>
</span></span><span><span>  trap - SIGINT SIGTERM
</span></span><span><span>  echo <span>&#34;cleaning...&#34;</span>
</span></span><span><span>  ...
</span></span><span><span><span>}</span>
</span></span><span><span>...
</span></span></code></pre></div><p>Reload and restart clean.service, note the boot id, and try rebooting again (annotated üîÅ).</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Sep 29 17:01:04 ip-10-0-0-27 podman[3688]: Awaiting signals
</span></span><span><span>üîÅ
</span></span><span><span>Sep 29 17:02:20 ip-10-0-0-27 podman[3688]: cleaning...
</span></span><span><span>Sep 29 17:02:20 ip-10-0-0-27 podman[3688]: Terminated
</span></span><span><span>Sep 29 17:02:20 ip-10-0-0-27 systemd[1]: Stopping clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 17:02:25 ip-10-0-0-27 podman[3688]: waiting...
</span></span><span><span>Sep 29 17:02:30 ip-10-0-0-27 podman[3688]: waiting...
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 podman[3688]: waiting...
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 podman[3688]: done
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 podman[3688]: 2022-10-21 17:02:35.391304416 +0000 UTC m=+91.032365358 container died 75079c6a180f82d398bb33e1e22a45bf4b281e84912e780842dd167658e6179f (image=docker.io/library/fedora:36, name=clean, health_status=)
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 podman[4229]: 2022-10-21 17:02:35.740391215 +0000 UTC m=+0.325653570 container remove 75079c6a180f82d398bb33e1e22a45bf4b281e84912e780842dd167658e6179f (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 podman[4090]: clean
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 systemd[1]: clean.service: Main process exited, code=exited, status=143/n/a
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 systemd[1]: clean.service: Failed with result &#39;exit-code&#39;.
</span></span><span><span>Sep 29 17:02:35 ip-10-0-0-27 systemd[1]: Stopped clean.service - Clean on shutdown.
</span></span><span><span>-- Boot f8b835d07c7f497c83487bdf3bd3e319 --
</span></span></code></pre></div><p>Verify <code>cleanup</code> only ran once (3 <code>waiting...</code> messages) and that it delayed shutdown.</p>
<p>There‚Äôs one more fix. Exit code 143 indicates the container exited due to a SIGTERM graceful shutdown request. systemd marks this as an error, but we‚Äôd call it a success. Set the service‚Äôs <a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#SuccessExitStatus=">SuccessExitStatus</a>.</p>
<div><pre tabindex="0"><code data-lang="text"><span><span>Sep 29 17:09:56 ip-10-0-0-27 podman[4981]: Awaiting signals
</span></span><span><span>üîÅ
</span></span><span><span>Sep 29 17:16:03 ip-10-0-0-27 podman[4981]: cleaning...
</span></span><span><span>Sep 29 17:16:03 ip-10-0-0-27 podman[4981]: Terminated
</span></span><span><span>Sep 29 17:16:03 ip-10-0-0-27 systemd[1]: Stopping clean.service - Clean on shutdown...
</span></span><span><span>Sep 29 17:16:08 ip-10-0-0-27 podman[4981]: waiting...
</span></span><span><span>Sep 29 17:16:13 ip-10-0-0-27 podman[4981]: waiting...
</span></span><span><span>Sep 29 17:16:18 ip-10-0-0-27 podman[4981]: waiting...
</span></span><span><span>Sep 29 17:16:18 ip-10-0-0-27 podman[4981]: done
</span></span><span><span>Sep 29 17:16:18 ip-10-0-0-27 podman[4981]: 2022-10-21 17:16:18.636792684 +0000 UTC m=+382.160266981 container died 91888ef150ea54a9831736a966302d1811028ce3216afb4368bf0a266e61ee52 (image=docker.io/library/fedora:36, name=clean, health_status=)
</span></span><span><span>Sep 29 17:16:18 ip-10-0-0-27 podman[7028]: 2022-10-21 17:16:18.968155309 +0000 UTC m=+15.157225407 container cleanup 91888ef150ea54a9831736a966302d1811028ce3216afb4368bf0a266e61ee52 (image=docker.io/library/fedora:36, name=clean, health_status=, maintainer=Clement Verna &lt;cverna@fedoraproject.org&gt;)
</span></span><span><span>Sep 29 17:16:18 ip-10-0-0-27 podman[7028]: clean
</span></span><span><span>Sep 29 17:16:19 ip-10-0-0-27 systemd[1]: clean.service: Deactivated successfully.
</span></span><span><span>Sep 29 17:16:19 ip-10-0-0-27 systemd[1]: Stopped clean.service - Clean on shutdown.
</span></span><span><span>-- Boot 3517a0a13b3e4885be9901666c0fd173 --
</span></span></code></pre></div><h2 id="next-steps">Next Steps</h2>
<p>We‚Äôve seen that systemd unit shutdown can be subtle. And we‚Äôve only focused on early shutdown - as opposed to services (or actions) that should stop as late as possble (e.g. loggers). Still, we‚Äôve looked at several strategies.</p>
<p>In the <a href="https://blog.plover.com/posts/kubelet-graceful-shutdown/">next post</a>, we‚Äôll apply these strategies to the Kubernetes Kubelet. The Kubelet service registers itself with a Kubernetes cluster and starts containers via a container runtime, with features like preStop hooks, terminationGracePeriod, and disruption budgets. But stopping the Kubelet service doesn‚Äôt inform the cluster or stop containers and (until recently) neither would shutdown.</p>
<p>Want to see more content like this?</p>
<ul>
<li>Follow <a href="https://twitter.com/poseidonlabs">@poseidonlabs</a> for future blog posts</li>
<li>Consider supporting Poseidon‚Äôs open-source work by joining our amazing <a href="https://github.com/sponsors/poseidon">sponsors</a></li>
<li>Partner with us by emailing <a href="mailto:tech@psdn.io">tech@psdn.io</a></li>
</ul>
<h2 id="source">Source</h2>
<p>Examples from this post are available in <a href="https://github.com/poseidon/blog-bits">blog-bits</a> under the MPL 2.0 license. They were tested on Fedora CoreOS 36.20221001.3.0 (systemd 250.8).</p>
<div><pre tabindex="0"><code data-lang="systemd"><span><span><span>[Unit]</span>
</span></span><span><span><span>Description</span><span>=</span><span>Clean on shutdown</span>
</span></span><span><span><span>After</span><span>=</span><span>multi-user.target</span>
</span></span><span><span>
</span></span><span><span><span>[Service]</span>
</span></span><span><span><span>Type</span><span>=</span><span>simple</span>
</span></span><span><span><span>ExecStartPre</span><span>=</span><span>-/usr/bin/podman rm clean</span>
</span></span><span><span><span>ExecStart</span><span>=</span><span>/usr/bin/podman run </span>\
</span></span><span><span><span>  --name clean </span>\
</span></span><span><span><span>  --log-driver=k8s-file </span>\
</span></span><span><span><span>  --rm </span>\
</span></span><span><span><span>  -v /usr/local/bin:/scripts </span>\
</span></span><span><span><span>  --stop-timeout=60 </span>\
</span></span><span><span><span>  --entrypoint /scripts/await </span>\
</span></span><span><span><span>  docker.io/fedora:36</span>
</span></span><span><span><span>ExecStop</span><span>=</span><span>/usr/bin/podman stop clean</span>
</span></span><span><span><span>TimeoutStopSec</span><span>=</span><span>0</span>
</span></span><span><span><span>SuccessExitStatus</span><span>=</span><span>143</span>
</span></span><span><span>
</span></span><span><span><span>[Install]</span>
</span></span><span><span><span>WantedBy</span><span>=</span><span>multi-user.target</span>
</span></span></code></pre></div><div><pre tabindex="0"><code data-lang="bash"><span><span><span>#!/bin/bash
</span></span></span><span><span><span></span>
</span></span><span><span>cleanup<span>()</span> <span>{</span>
</span></span><span><span>  trap - SIGINT SIGTERM
</span></span><span><span>  echo <span>&#34;cleaning...&#34;</span>
</span></span><span><span>  <span>for</span> i in <span>{</span>1..3<span>}</span>; <span>do</span>
</span></span><span><span>    sleep 5s
</span></span><span><span>    echo <span>&#34;waiting...&#34;</span>
</span></span><span><span>  <span>done</span>
</span></span><span><span>
</span></span><span><span>  echo <span>&#34;done&#34;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span>trap cleanup SIGINT SIGTERM
</span></span><span><span>
</span></span><span><span>echo <span>&#34;Awaiting signals&#34;</span>
</span></span><span><span>sleep infinity &amp; wait $!
</span></span></code></pre></div><p>If you find a bug, please send a fix and I‚Äôll try to get it updated.</p>
<h2 id="resources">Resources</h2>
<ul>
<li>man <a href="https://www.freedesktop.org/software/systemd/man/systemd.html">systemd</a> <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">systemd.unit</a></li>
<li>man <a href="ihttps://www.freedesktop.org/software/systemd/man/systemd.service.html">systemd.service</a>, <a href="https://www.freedesktop.org/software/systemd/man/systemd.scope.html">systemd.scope</a></li>
<li>man <a href="https://www.freedesktop.org/software/systemd/man/systemd.kill.html">systemd.kill</a> <a href="https://www.freedesktop.org/software/systemd/man/systemd.special.html">systemd.special</a></li>
<li><a href="https://github.com/containers/podman/issues/105">https://github.com/containers/podman/issues/105</a></li>
<li><a href="https://github.com/containers/podman/issues/7821">https://github.com/containers/podman/issues/7821</a></li>
<li><a href="http://mywiki.wooledge.org/SignalTrap#When_is_the_signal_handled.3F">http://mywiki.wooledge.org/SignalTrap#When_is_the_signal_handled.3F</a></li>
</ul>
</div>
      </div>
    </div>
  </div>
</div></div>
  </body>
</html>
