<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://buttondown.email/hillelwayne/archive/creatively-misusing-tla/">Original</a>
    <h1>Creatively Misusing TLA&#43;</h1>
    
    <div id="readability-page-1" class="page"><div>

                

                
                    
                        <p>I spent the past few weeks thinking about complexity and poking dead birds and stuff, but now that the <a href="https://www.eventbrite.com/e/software-modeling-with-tla-workshop-tickets-520033412937?aff=newsletter" target="_blank">March TLA+ workshop is available</a> (use <code>C0MPUT3RTHINGS</code> for 15% off!),  I’m back in teacher mode and making workshop improvements.<sup id="fnref:workshops"><a href="#fn:workshops">1</a></sup> TLA+ is intended for finding flaws in software designs. But what else can we do with it?</p>
<p><strong>Creative Misuse</strong> is the use of a tool in an unintended way. For example, if you use a screwdriver to pry something open, or a book as a monitor stand. Creative misuse in software includes making games in Excel spreadsheets and using <code>yes</code> to <a href="https://www.zdnet.com/article/test-for-macbook-random-shutdown-syndrome-rss/" target="_blank">test for broken hardware</a>. Creative misuse is 1) very fun, and 2) expands the space of how useful the tool is. I love finding creative misuses for tools. Here’s a few of them for TLA+.</p>
<h2>Data Generation</h2>
<p>In most programming languages, we construct values step-by-step. In most formal specification languages, we instead take a big set of all possible values and then winnow them down with predicates. This is less efficient, which is why programming languages don’t do it, but it’s also a lot more expressive.</p>
<p>This is useful for generating things like initial system configurations like “all nodes start with a different priority”:</p>
<div><pre><span></span><code>{ priority \in [Node -&gt; 1..NumNodes]:
  \A n1, n2 \in Node:
    n1 /= n2 =&gt; priority[n1] /= priority[n2]
}
</code></pre></div>

<p>But I occasionally flip it around and use it to get values for other purposes, like “give me two sets where every set operation gives something different and interesting”.</p>
<div><pre><span></span><code>LET set == SUBSET (1..5) IN
{
&lt;&lt;s1, s2&gt;&gt; \in set \X set:
  AllDistinct(&lt;&lt;s1, s2, 
      s1 \union s2, s1 \intersect s2,
      s1 \ s2, s2 \ s1&gt;&gt;)
}
</code></pre></div>

<p>(Here’s a good TLA+ exercise: implement <code>AllDistinct</code>!)</p>
<p>Some subclasses of data generation:</p>
<h4>Constraint Solving</h4>
<p>One exercise I like a lot:</p>
<blockquote>
<p>Solve for x: <code>x³ - 20x² + 7x = 14,388</code>. <code>x</code> is a natural number below 100.</p>
</blockquote>
<p>The TLA+ Way:</p>
<div><pre><span></span><code>CHOOSE x \in 0..100: x^3 - 20*x^2 + 7*x = 14388
</code></pre></div>

<p>Okay cool, but now imagine a problem with multiple solutions, where we want to find solution with the lowest cost function. In TLA+:</p>
<div><pre><span></span><code>MaximalChoice(pred(_), cost(_), set) ==
  CHOOSE x \in set:
    /\ pred(x) 
    /\ \A y \in set:
      pred(y) =&gt; cost(x) &lt;= cost(y)
</code></pre></div>

<p>This is using TLA+ as a <strong>constraint solver</strong>. It’s a pretty slow one, since it works by enumerating all possibilities (and it don’t do floats). That’s why it’s a creative misuse!</p>
<p>Dedicated constraint solvers like <a href="https://www.minizinc.org/" target="_blank">MiniZinc</a> use all sorts of heuristics to speed things up (and do floats). But unlike TLA+, they don’t have collection types. If you want to constraint solve on a nested data structure you have to find some way of encoding it as an array of numbers. In TLA+ you can directly solve with complex data types. For that reason I still reach for it occasionally for small-but-intricate problems.</p>
<p>(For some problems I like <a href="https://www.hillelwayne.com/post/knights-knaves/" target="_blank">using Alloy</a>, for the same reasons. Alloy tends to be better with subtypes and graphs. One of these days I should turn my attention back to Alloy, it’s quite nice.)</p>
<h4>Truth Tables</h4>
<p>For what values are <code>P &amp;&amp; !(Q || R)</code> true?</p>
<div><pre><span></span><code>[P, Q, R \in BOOLEAN |-&gt; P /\ ~(Q \/ R)]
</code></pre></div>

<h4>Synthesis</h4>
<p><a href="https://gist.github.com/hwayne/2fe25993b62b69ddb1901c969f93fed7" target="_blank">Here’s code that generates simple digital circuits</a>, like half-adders. It’s in Alloy but the principles are the same. </p>
<h2>Finding Solutions</h2>
<p>This the same principle as data generation, lifted to the level of specification. TLA+ does worst-case model checking, so it fails if it finds <em>any</em> path to an error. This opens a famous trick: if you want to find the set of steps that solve a problem, write a property saying “the problem <em>isn’t</em> solved” and make that an invariant. Then any behavior that finds the solution also breaks the invariant, and the model checker will dutifully spit out the set of steps in that behavior.</p>
<p>Leslie Lamport himself used this trick to <a href="https://github.com/tlaplus/Examples/blob/master/specifications/DieHard/DieHard.tla" target="_blank">solve the diehard water jug puzzle</a>. I’ve also demoed this trick in learntla, using it to <a href="https://learntla.com/core/nondeterminism.html#example-a-calculator" target="_blank">find sequences of operations that add up to a given number</a>.</p>
<p>Even with the pedigree, this is still an unintended use of TLA+: the model checker can’t give you more than one solution, at least not without a little bit of cleverness, and it can’t constraint-solve on all possible solutions, at least not without a whole lot of cleverness.</p>
<h2>Visualizing State Spaces</h2>
<p>TLC has a <a href="https://learntla.com/topics/toolbox.html#additional-tlc-options" target="_blank">generate graphviz output</a> button, so you can see the state space for a given model.</p>
<p><img alt="A state space of 17 states, in graphviz" src="https://buttondown-attachments.s3.us-west-2.amazonaws.com/images/d27c0989-e652-44f6-98cb-5366e685a97d.png"/> </p>
<p>For tiny state spaces it’s a pretty great teaching tool, but past just 100 distinct states it breaks down. Fortunately there are other tools you can use! <a href="https://learntla.com/topics/cli.html#tlc-options" target="_blank">You can dump the graphviz to a file</a>, and then import it with something like <a href="https://gephi.org/" target="_blank">Gephi</a>.</p>
<p><img alt="A state space with 130 states, in Gephi" src="https://buttondown-attachments.s3.us-west-2.amazonaws.com/images/7fd13970-e695-4d58-8e6e-4d7f9c37b1af.png"/> </p>
<p>This is a different spec that’s about 10 times larger than the graphviz output earlier. I highlighted the one starting state and the 26 terminal states.</p>
<p>I haven’t done much with graph analysis, but I’m sure there’s also sorts of fun tricks this opens up.</p>
<h2>Counting</h2>
<p>Imagine we have m workers w₁, w₂, … wₘ. The first one takes N₁ steps to complete, the second N₂, etc. Each worker can run between any two steps of another worker. How many possible interleavings are there total?</p>
<p>This many:</p>
<div><pre><span></span><code>(N₁+N₂+...+Nₘ)!
--------------
N₁!*N₂!*...*Nₘ!
</code></pre></div>

<p>You can reason out the equation from first principles, but I found it a lot easier to first put a few combinations of values into TLA+, see how big the corresponding state spaces were, and then figure out the formula from that.</p>
<h2>Generating Test Cases</h2>
<p>Can we use TLA+ to directly verify our code? …sort of. In <a href="https://arxiv.org/abs/2006.00915" target="_blank">eXtreme modeling in practice</a>, a team at MongoDB<sup id="fnref:mongo"><a href="#fn:mongo">2</a></sup> investigated two possible ways:</p>
<ol>
<li>Taking traces of the real system behavior and seeing if they match a valid TLA+ behavior</li>
<li>Taking behaviors from TLA+ simulations and generating corresponding tests </li>
</ol>
<p>According to their experience, (1) is too inefficient to do at scale. They were more successful with (2):</p>
<blockquote>
<p>We found [system traces] to be impractical for testing that the Server conformed to a highly abstract specification. [Test generation] was highly successful for Realm Sync, however.</p>
</blockquote>
<p>Note the constraints on their system: they used TLA+ to generate possible inputs to a complex, but deterministic, function. They speculate it would be more difficult to do for nondeterministic or concurrent systems, which also matches my experience. It’s a lot easier if all the processes are modeled as communicating state machines, though, an idea that <a href="https://github.com/p-org/P" target="_blank">P</a> explores in more detail.</p>
<hr/>
<p>I like using tools in weird ways. Most of these creative misuses won’t be covered in the workshop because I’ll already have my hands full teaching the <em>actual</em> uses of TLA+, verifying properties of software designs.</p>
<hr/>
<h3>Update for the Internets</h3>
<p>This was sent as part of an email newsletter; you can subscribe <a href="https://buttondown.email/hillelwayne/" target="_blank">here</a>. Common topics are <a href="https://buttondown.email/hillelwayne/archive/why-uml-really-died/" target="_blank">software history</a>, <a href="https://buttondown.email/hillelwayne/archive/10-misconceptions-about-formal-methods/" target="_blank">formal methods</a>, the <a href="https://buttondown.email/hillelwayne/archive/reject-simplicity-embrace-complexity/" target="_blank">theory of software engineering</a>, and <a href="https://buttondown.email/hillelwayne/archive/whats-the-most-expensive-software-per-byte/" target="_blank">silly research dives</a>. Updates are 6x a month. I also have a <a href="https://www.hillelwayne.com/" target="_blank">website</a> where I put my polished writing (the newsletter is more for off-the-cuff stuff).</p>

                    
                
            </div></div>
  </body>
</html>
