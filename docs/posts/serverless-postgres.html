<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/kiwicopple/serverless-postgres">Original</a>
    <h1>Show HN: Serverless Postgres</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Serverless Postgres using Oriole, Fly Machines, and Tigris for S3 Storage.</p>

<p dir="auto">This is a MVP for Serverless Postgres.</p>
<p dir="auto">1/ It uses <a href="https://fly.io" rel="nofollow">Fly.io</a>, which can automatically pause your database after all connections are released (and start it again when new connections join).</p>
<p dir="auto">2/ It uses <a href="https://www.orioledb.com" rel="nofollow">Oriole</a>, a Postgres extension with <a href="https://www.orioledb.com/docs/usage/decoupled-storage" rel="nofollow">experimental support for S3 / Decoupled Storage</a>.</p>
<p dir="auto">3/ It uses <a href="https://www.tigrisdata.com/" rel="nofollow">Tigris</a>, Globally Distributed S3-Compatible Object Storage. Oriole will automatically backup the data to Tigris using background workers.</p>

<p dir="auto">Make sure you already have an account with <a href="https://fly.io" rel="nofollow">Fly.io</a>.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Step 1: initialize your S3 store</h3><a id="user-content-step-1-initialize-your-s3-store" aria-label="Permalink: Step 1: initialize your S3 store" href="#step-1-initialize-your-s3-store"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto" data-snippet-clipboard-copy-content="fly storage create # Keep the credentials, you&#39;ll need them in the next step"><pre>fly storage create <span><span>#</span> Keep the credentials, you&#39;ll need them in the next step</span></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Step 2: set up credentials</h3><a id="user-content-step-2-set-up-credentials" aria-label="Permalink: Step 2: set up credentials" href="#step-2-set-up-credentials"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Copy the sample env file and add your Tigris credentials from above:</p>

<div dir="auto"><h3 tabindex="-1" dir="auto">Step 3: Running Postgres locally</h3><a id="user-content-step-3-running-postgres-locally" aria-label="Permalink: Step 3: Running Postgres locally" href="#step-3-running-postgres-locally"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Start Postgres locally using <code>docker compose up</code>.</p>
<p dir="auto">(You may need to change the execute permissions on <code>./oriole/entrypoint-s3.sh</code>.)</p>

<p dir="auto">Enable the Oriole extension:</p>
<div dir="auto" data-snippet-clipboard-copy-content="CREATE extension orioledb;"><pre>CREATE extension orioledb;</pre></div>
<p dir="auto">Create a table and insert data:</p>
<div dir="auto" data-snippet-clipboard-copy-content="-- Create a table to store blog posts
CREATE TABLE blog_post (
    id int8 NOT NULL,
    title text NOT NULL COLLATE &#34;C&#34;
) USING orioledb;

-- Insert 1 million blog posts
INSERT INTO blog_post (select id, &#39;value&#39; || id from generate_series (1,1000000) id);"><pre><span><span>--</span> Create a table to store blog posts</span>
<span>CREATE</span> <span>TABLE</span> <span>blog_post</span> (
    id int8 <span>NOT NULL</span>,
    title <span>text</span> <span>NOT NULL</span> COLLATE <span><span>&#34;</span>C<span>&#34;</span></span>
) USING orioledb;

<span><span>--</span> Insert 1 million blog posts</span>
<span>INSERT INTO</span> blog_post (<span>select</span> id, <span><span>&#39;</span>value<span>&#39;</span></span> <span>||</span> id <span>from</span> generate_series (<span>1</span>,<span>1000000</span>) id);</pre></div>
<p dir="auto">After this, you the Oriole background workers will store the data in Tigris. You can login to Tigris using <code>fly storage dashboard</code> to view the data:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/kiwicopple/serverless-postgres/blob/main/docs/tigris-data.png"><img src="https://github.com/kiwicopple/serverless-postgres/raw/main/docs/tigris-data.png" alt="Serverless Postgres"/></a></p>

<p dir="auto">TBD</p>

<p dir="auto">I wouldn&#39;t recommend using this in production just yet. The goal of this repo is to showcase Oriole and start gathering feedback from anyone who wants to test it out. Please submit any Oriole bug reports to the <a href="https://github.com/orioledb/orioledb">Oriole GitHub repo</a>.</p>
<ul>
<li> <strong>Deploy to Fly</strong>. I still need to document the secure deployment steps for Fly.io (PRs welcome).</li>
<li> <strong>Distributed read replicas</strong>. Oriole can have many read-replicas reading from the same S3 bucket. This is a good pairing with Fly.io that makes it simple to launch servers around the world. Not that if you do this it&#39;s <em>very important</em> that the read replicas do not write to the same bucket as your primary or the data will become corrupted.</li>
<li> <strong>Distributed data, without Postgres replication</strong>. <del>Tigris will globally replicate objects that are less that 128 bytes. We would need to support global replication of all objects in this bucket if we want to create fast read replicas without Postgres replication.</del>
<ul dir="auto">
<li>Tigris replicates any object that requires fast access regardless of the size. It is possible to <a href="https://www.tigrisdata.com/docs/objects/object_regions/" rel="nofollow">control this per object</a>. I need to test this implementation but it should work &#34;in theory&#34;.</li>
</ul>
</li>
<li> <strong>Non-forked Postgres</strong>. Oriole currently requires some <a href="https://www.orioledb.com/docs#patch-set" rel="nofollow">patches</a> to the Postgres TAM API. The goal is to make them available in Postgres core.</li>
</ul>

<p dir="auto">Oriole has <a href="https://www.orioledb.com/docs/usage/decoupled-storage" rel="nofollow">experimental support</a> for S3.</p>
<p dir="auto">Oriole is a table storage extension for Postgres. It is designed to be a drop-in replacement for Postgres&#39; existing storage engine. The Oriole storage engine&#39;s reduction in disk IO is significant enough that it unlocks performant databases backed by S3 compatible blob storage.</p>
<p dir="auto">Data most-often accessed is cached in local storage for performance. The data is synced with S3 asynchronously:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/kiwicopple/serverless-postgres/blob/main/docs/oriole-logs.png"><img src="https://github.com/kiwicopple/serverless-postgres/raw/main/docs/oriole-logs.png" alt="S3 Workers"/></a></p>
<p dir="auto">Read more in the <a href="https://www.orioledb.com/docs/usage/decoupled-storage" rel="nofollow">Oriole docs</a>.</p>
</article></div></div>
  </body>
</html>
