<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://determinate.systems/posts/nix-on-the-steam-deck">Original</a>
    <h1>Nix on the Steam Deck</h1>
    
    <div id="readability-page-1" class="page"><div data-block-type="23" id="block-yui_3_17_2_1_1670863911624_9233"><div><p>When I first started using Linux in 2006 I remember dreaming of a Linux Console. The idea maybe wasn&#39;t so far fetched at the time, the PlayStation 3 had just been released with OtherOS support which allowed users to install Linux (or BSD). Still, it seemed that a Linux-first console would only ever be a dream. Now in 2022, Valve&#39;s Steam Deck is a hackable Linux-first portable console.</p>
<p>Today, we&#39;ll be putting Nix on it, because what&#39;s Linux without Nix?</p>
<blockquote>
<p>Just wanna try it? <a href="#enabling-an-install">Jump to the fun part.</a>  </p>
<p>Want NixOS instead? A different, spicier kind of fun can be found <a href="https://github.com/Jovian-Experiments/Jovian-NixOS">here</a>.</p>
</blockquote>
<p>The Steam Deck is a portable computer that has a Nintendo Switch-like form factor and touts an AMD x86_64 processor. It has WiFi, Bluetooth, and a USB-C port which you can plug a hub into, allowing the attachment of HDMI, mice, keyboards, power, or ethernet cables.</p>
<p>It runs a flavour of Arch Linux called SteamOS, and guides users to use <a href="https://flatpak.org/">Flatpak</a> and <a href="https://flathub.org/home">Flathub</a>. This is a fantastic solution and provides users access to a wide variety of software, but as a developer I tend to want more exotic stuff that exists in <a href="https://github.com/NixOS/nixpkgs"><code>nixpkgs</code></a>.</p>
<p>In case you&#39;d not seen one yet, here&#39;s a picture of mine:</p>
</div></div><div data-block-type="23" id="block-yui_3_17_2_1_1670871315585_6781"><div><p>Installing Nix on the Steam Deck has a few special steps. Let&#39;s review how a Nix install process looks, then how the Deck works, and finally we can explore a working approach to install Nix.</p>

<p>A normal Nix install process on Linux works roughly like this:</p>
<ul>
<li>Create a folder called <code>/nix</code></li>
<li>Unpack the Nix distribution tarball into <code>/nix</code></li>
<li>Create some Nix daemon users and a group (affecting <code>/etc</code>)</li>
<li>Call <code>systemctl link</code> on some systemd units from <code>/nix</code> (affecting <code>/etc</code>)</li>
<li>Sprinkle some magic in the detected shell profiles (in <code>/etc</code>) to ensure <code>nix</code> is on <code>$PATH</code></li>
</ul>
<p>On Mac, where creating a <code>/nix</code> is forbidden (by the creators, Apple), we can modify <a href="https://keith.github.io/xcode-man-pages/synthetic.conf.5.html"><code>/etc/synthetic.conf</code></a> to create a stub which we can mount an APFS volume to. The installation otherwise proceeds as normal.</p>
<p>On the Steam Deck, creating <code>/nix</code> also requires special steps. Unfortunately, there is no feature similar to <code>/etc/synthetic.conf</code>. </p>
<p>Why does the Deck need these special steps? Let&#39;s take a look at the Steam Deck itself and figure out why we can&#39;t just run the familiar Nix installer.</p>

<p>The Steam Deck ships with an <a href="https://archlinux.org/">Arch Linux</a> based distribution called <a href="https://store.steampowered.com/steamos">SteamOS</a> -- a <a href="https://help.steampowered.com/en/faqs/view/1b71-edf2-eb6d-2bb3">special image</a> of it to be even more precise. Normally Arch Linux is a perfectly fine target for Nix, but there are a couple particularities around this distribution that impact how we can install Nix.</p>
<h2 id="disk-topology">Disk Topology</h2>
<p>The Deck uses an A/B boot system <a href="https://source.android.com/docs/core/ota/ab">(like some Android phones)</a>, which means it has two parallel installations, booting into one and updating the other. This means, if it ever fails after an update it can safely roll back to a known good state.</p>
<blockquote>
<p><strong>NixOS user?</strong> Sound familiar? It&#39;s like the generation selector in your bootloader, but instead of pointing your boot to different Nix store paths, it points to entirely different partitions!</p>
</blockquote>
<pre><code>(deck@steamdeck ~)$ sudo gdisk /dev/nvme0n1 -l
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048          133119   64.0 MiB    EF00  esp
   2          133120          198655   32.0 MiB    0700  efi-A
   3          198656          264191   32.0 MiB    0700  efi-B
   4          264192        10749951   5.0 GiB     8304  rootfs-A
   5        10749952        21235711   5.0 GiB     8304  rootfs-B
   6        21235712        21759999   256.0 MiB   8310  var-A
   7        21760000        22284287   256.0 MiB   8310  var-B
   8        22284288      1000215175   466.3 GiB   8302  home
</code></pre>
<p>See how there is <code>A</code> and <code>B</code> copies of most partitions?</p>
<p>This looks a heck of a lot different than my development machine:</p>
<pre><code>Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         2099199   1024.0 MiB  EF00  efi
   2         2099200      3907029134   1.8 TiB     8309  encrypt
</code></pre>
<p>Checking for encryption with <code>blkid | grep crypto_LUKS</code> showed all partitions were unencrypted, this makes sense since the Deck never asks for a password, even for <code>sudo</code>, until you set one. It&#39;s a bit unfortunate Valve did not opt to protect their user&#39;s data in the event this portable device was stolen, but it&#39;s room to improve.</p>
<p>This A/B boot system means even if <code>rootfs</code> partitions get modified, those changes may get wiped out at any time. The system may update or choose to boot into the other &#39;letter&#39; for some other reason. We want something that is update-proof and will survive a change of &#39;letter&#39;.</p>
<p>One partition that persists across reboots and has enough space to contain a thick, chunky Nix store is the <code>home</code> partition. Our Nix install can keep persistent data there.</p>
<h2 id="read-only-filesystem">Read-Only Filesystem</h2>
<p>Reviewing the <code>mount</code> output is a bit misleading. While the <code>/</code> mount says it is <code>rw</code>, it is normally not.</p>
<pre><code>(deck@steamdeck ~)$ mount | grep /dev/nvme
/dev/nvme0n1p4 on / type btrfs (rw,relatime,ssd,space_cache=v2,subvolid=5,subvol=/)
/dev/nvme0n1p6 on /var type ext4 (rw,relatime)
/dev/nvme0n1p8 on /home type ext4 (rw,relatime,x-systemd.growfs)
/dev/nvme0n1p8 on /opt type ext4 (rw,relatime)
/dev/nvme0n1p8 on /root type ext4 (rw,relatime)
/dev/nvme0n1p8 on /srv type ext4 (rw,relatime)
/dev/nvme0n1p8 on /var/cache/pacman type ext4 (rw,relatime)
/dev/nvme0n1p8 on /var/lib/docker type ext4 (rw,relatime)
/dev/nvme0n1p8 on /var/lib/flatpak type ext4 (rw,relatime)
/dev/nvme0n1p8 on /var/lib/systemd/coredump type ext4 (rw,relatime)
/dev/nvme0n1p8 on /var/log type ext4 (rw,relatime)
/dev/nvme0n1p8 on /var/tmp type ext4 (rw,relatime)

(deck@steamdeck ~)$ sudo touch /boop
touch: cannot touch &#39;/boop&#39;: Read-only file system
</code></pre>
<p>This isn&#39;t a scary vendor lockdown security feature or anything, it&#39;s mostly to prevent the user from being surprised when the A/B boot happens. SteamOS comes with a <code>steamos-readonly</code> executable we can use to toggle this read-only feature at any time, this can allow us to make small changes to the root filesystem as long as we don&#39;t expect them to persist across boots.</p>
<p>Because of this, if we wanted, we could create a <code>/nix</code> path on the <code>rootfs</code> each boot by making the root momentarily writable.</p>
<p>Not all of the device is read-only though! We can write to places like <code>/etc/</code>, but not to <code>/lib</code>, <code>/usr</code>, or <code>/bin</code>.</p>
<pre><code>(deck@steamdeck ~)$ sudo touch /etc/boop
(deck@steamdeck ~)$ sudo rm /etc/boop
(1)(deck@steamdeck ~)$ sudo touch /lib/boop
touch: cannot touch &#39;/lib/boop&#39;: Read-only file system
(1)(deck@steamdeck ~)$ sudo touch /bin/boop
touch: cannot touch &#39;/bin/boop&#39;: Read-only file system
(1)(deck@steamdeck ~)$ sudo touch /usr/boop
touch: cannot touch &#39;/usr/boop&#39;: Read-only file system
</code></pre>
<p>Recalling the rough steps from the install process, this isn&#39;t a problem! So long as we work out the machinery to ensure <code>/nix</code> is available, the Steam Deck looks otherwise like a normal system to Nix.</p>

<p>As we discovered, creating the <code>/nix</code> directory in a safe way that persists will be our primary challenge.</p>
<p>Since it wouldn&#39;t be a great idea to store the Nix Store on the <code>rootfs</code> partitions, we must decide somewhere else. The most immediately obvious answer is <code>/home/nix</code>, since that is a large, persistent location.</p>
<p>With an existing <code>/home/nix</code>, we can use a <a href="https://www.baeldung.com/linux/bind-mounts">bind mount</a> to mount that to <code>/nix</code>. First, a <code>/nix</code> path needs be created somehow!</p>
<p>Luckly, with <code>/etc</code> writable, we can drop systemd units into <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html"><code>/etc/systemd/system</code></a> that will set up <code>/nix</code> for us.</p>
<p>We&#39;ll create a <code>nix-directory.service</code> unit which creates the <code>/nix</code> path, and a <code>nix.mount</code> unit which depends on that.</p>
<p>Sadly, that&#39;s not quite enough to enable a full install though. Since the Nix install process involves <code>systemctl link $UNIT</code>, some of the systemd units are not available during systemd&#39;s startup. Therefore we must reload the systemd daemon itself after the <code>nix.mount</code> unit is started. In order to do that, we follow the same method as <a href="https://www.flatcar.org/">Flatcar Linux</a> does <a href="https://github.com/flatcar/init/blob/flatcar-master/systemd/system/ensure-sysext.service">here</a>.</p>
<p>Let&#39;s cover what these units look like then test them out with the Nix installer! If you&#39;re feeling brave <a href="#an-invitation-to-experiment">I invite you</a> to help us test an experimental Nix installer we&#39;ve been working on which has a special codepath just for the Steam Deck. Otherwise, follow along below to try the traditional install script.</p>
<p>But first, just in case:</p>
<ul>
<li><strong>Not sure how to get to &#39;Desktop mode&#39;?</strong> Hit the Steam button, go to &#39;Power&#39;, go to &#39;Switch to Desktop&#39;</li>
<li><strong>Not sure how to get a terminal?</strong> In &#39;Desktop Mode&#39; hit the logo in the bottom left corner, in the search bar type &#34;Terminal&#34;, select &#39;Konsole&#39;</li>
<li><strong>Not sure how to edit files?</strong> You can use <code>vim</code> if you are familiar, otherwise try <code>nano</code> from the terminal.</li>
</ul>
<h2 id="putting-it-all-together">Putting it all together</h2>
<blockquote>
<p><strong>Want to follow along without a Deck?</strong> Learn how to set up a Deck VM with <a href="https://blogs.igalia.com/berto/2022/07/05/running-the-steam-decks-os-in-a-virtual-machine-using-qemu/">this article</a>.</p>
</blockquote>
<p>There are only four Steam Deck specific steps, three are to create the following systemd units. The final one is to enable one of those units.</p>
<p>Create the following systemd units at the noted paths, I suggest using a keyboard plugged into the Deck if you can, or enable SSH via <code>sudo systemctl start sshd</code>, reviewing the IP address via <code>ip a</code>, and setting a password. If those options are unavailable, hit the <a href="https://help.steampowered.com/en/faqs/view/671A-4453-E8D2-323C"><strong>Steam and X</strong></a> buttons to summon the keyboard.</p>
<pre><code># /etc/systemd/system/nix-directory.service
[Unit]
Description=Create a `/nix` directory to be used for bind mounting
PropagatesStopTo=nix-daemon.service
PropagatesStopTo=nix.mount
DefaultDependencies=no

[Service]
Type=oneshot
ExecStart=steamos-readonly disable
ExecStart=mkdir -vp /nix
ExecStart=chmod -v 0755 /nix
ExecStart=chown -v root /nix
ExecStart=chgrp -v root /nix
ExecStart=steamos-readonly enable
ExecStop=steamos-readonly disable
ExecStop=rmdir /nix
ExecStop=steamos-readonly enable
RemainAfterExit=true
</code></pre>
<p>The above unit is the first in our chain of units, it checks if a <code>/nix</code> folder exists, and if necessary, calls <code>steamos-readonly disable</code>, creates <code>/nix</code>, then calls <code>steamos-readonly enable</code> again. It also attempts to do some cleanup as it stops, but that part is unnecessary.</p>
<pre><code># /etc/systemd/system/nix.mount
[Unit]
Description=Mount `/home/nix` on `/nix`
PropagatesStopTo=nix-daemon.service
PropagatesStopTo=nix-directory.service
After=nix-directory.service
Requires=nix-directory.service
ConditionPathIsDirectory=/nix
DefaultDependencies=no

[Mount]
What=/home/nix
Where=/nix
Type=none
DirectoryMode=0755
Options=bind
</code></pre>
<p>This mount unit performs a bind mount from <code>/home/nix</code> to <code>/nix</code>. It&#39;ll create <code>/home/nix</code> for us, but sadly it cannot create <code>/nix</code>, relying on the <code>nix-directory.service</code> before it.</p>
<pre><code># /etc/systemd/system/ensure-symlinked-units-resolve.service
[Unit]
Description=Ensure Nix related units which are symlinked resolve
After=nix.mount
Requires=nix-directory.service
Requires=nix.mount
PropagatesStopTo=nix-directory.service
PropagatesStopTo=nix.mount
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/systemctl daemon-reload
ExecStart=/usr/bin/systemctl restart --no-block sockets.target timers.target multi-user.target

[Install]
WantedBy=sysinit.target
</code></pre>
<p>This final unit in the chain restarts the systemd daemon, allowing it to properly resolve any previously broken symlinks during the boot, before starting or enabling them if necessary.</p>
<blockquote>
<p><strong>Tailscale user?</strong> A similar strategy can be used after performing <code>systemd-sysext merge</code> if you happen to also use <a href="https://tailscale.com/blog/steam-deck/">Tailscale on your Steam Deck</a> to make sure it starts at boot.</p>
</blockquote>
<p>After creating the units, we need to enable (and start) the last, causing the ones it requires to also start:</p>
<pre><code>sudo systemctl enable --now ensure-symlinked-units-resolve.service
</code></pre>
<p>Now we can just run the <a href="https://nixos.org/manual/nix/stable/quick-start.html">Nix installer</a> like normal:</p>
<pre><code>sh &lt;(curl -L https://nixos.org/nix/install) --daemon
</code></pre>
<p>Follow the prompts, call <code>exec $SHELL</code> (or open a new shell, or reboot) and Nix should work on command line!</p>
<pre><code>(deck@steamdeck ~)$ nix-instantiate --eval -E &#39;1 + 1&#39;
2
(deck@steamdeck ~)$ nix-build &#39;&lt;nixpkgs&gt;&#39; -A hello
these 4 paths will be fetched (6.73 MiB download, 31.05 MiB unpacked):
  /nix/store/34xlpp3j3vy7ksn09zh44f1c04w77khf-libunistring-1.0
  /nix/store/4nlgxhb09sdr51nc9hdm8az5b08vzkgx-glibc-2.35-163
  /nix/store/5mh5019jigj0k14rdnjam1xwk5avn1id-libidn2-2.3.2
  /nix/store/g2m8kfw7kpgpph05v2fxcx4d5an09hl3-hello-2.12.1
copying path &#39;/nix/store/34xlpp3j3vy7ksn09zh44f1c04w77khf-libunistring-1.0&#39; from &#39;https://cache.nixos.org&#39;...
copying path &#39;/nix/store/5mh5019jigj0k14rdnjam1xwk5avn1id-libidn2-2.3.2&#39; from &#39;https://cache.nixos.org&#39;...
copying path &#39;/nix/store/4nlgxhb09sdr51nc9hdm8az5b08vzkgx-glibc-2.35-163&#39; from &#39;https://cache.nixos.org&#39;...
copying path &#39;/nix/store/g2m8kfw7kpgpph05v2fxcx4d5an09hl3-hello-2.12.1&#39; from &#39;https://cache.nixos.org&#39;...
/nix/store/g2m8kfw7kpgpph05v2fxcx4d5an09hl3-hello-2.12.1
(deck@steamdeck ~)$ ./result/bin/hello 
Hello, world!
</code></pre>
<p>Feel free to reboot a few times, or even update your Steam Deck. As far as I&#39;ve experimented, it should keep working!</p>
<p>If you cause a instant, hard, full power loss (such as Ctrl+C&#39;ing the VM) before it can properly <code>fsync()</code>, you may see an error like <code>error: expected string &#39;Derive([&#39;</code>. To resolve this error, run <code>nix store gc</code>. You can avoid this by running <code>sync</code> before killing the device.</p>
<h2 id="an-invitation-to-experiment">An invitation to experiment</h2>
<p>Part of the reason we wanted to explore Nix on the Steam Deck is that we&#39;re currently experimenting with a new Nix installer, and we were curious what we could learn from adding support for a specific device which had special requirements, such as the Steam Deck.</p>
<p>If you feel like experimenting <strong>(and don&#39;t mind things breaking)</strong> feel encouraged to try out our prototype! Don&#39;t worry, if you don&#39;t like it, it includes an uninstaller so you can roll back and do your install with the traditional scripts.</p>
<p>You can run it like so:</p>
<pre><code>curl -L https://install.determinate.systems/nix | sh -s -- install steam-deck
</code></pre>
<p>If you don&#39;t feel like being experimental, this is what it looks like:</p>
<pre><code>(deck@steamdeck ~)$ curl -L https://install.determinate.systems/nix | sh -s -- install steam-deck
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100 15739  100 15739    0     0  22981      0 --:--:-- --:--:-- --:--:-- 22981
info: downloading installer https://install.determinate.systems/nix/nix-installer-x86_64-linux
./nix-installer install steam-deck
`nix-installer` needs to run as `root`, attempting to escalate now via `sudo`...
Nix install plan (v0.0.0-unreleased)

Planner: steam-deck

Planner settings:

* persistence: &#34;/home/nix&#34;
* channels: [&#34;nixpkgs=https://nixos.org/channels/nixpkgs-unstable&#34;]
* nix_build_user_id_base: 3000
* extra_conf: []
* modify_profile: true
* force: false
* daemon_user_count: 32
* nix_build_group_name: &#34;nixbld&#34;
* nix_build_user_prefix: &#34;nixbld&#34;
* nix_package_url: &#34;https://releases.nixos.org/nix/nix-2.12.0/nix-2.12.0-x86_64-linux.tar.xz&#34;
* nix_build_group_id: 3000

The following actions will be taken (`--explain` for more context):

* Create directory `/home/nix`
* Create or overwrite file `/etc/systemd/system/nix-directory.service`
* Create or overwrite file `/etc/systemd/system/nix.mount`
* Create or overwrite file `/etc/systemd/system/ensure-symlinked-units-resolve.service`
* Enable (and start) the systemd unit ensure-symlinked-units-resolve.service
* Fetch `https://releases.nixos.org/nix/nix-2.12.0/nix-2.12.0-x86_64-linux.tar.xz` to `/nix/temp-install-dir`
* Create build users (UID 3000-3032) and group (GID 3000)
* Create a directory tree in `/nix`
* Move the downloaded Nix into `/nix`
* Setup the default Nix profile
* Configure Nix daemon related settings with systemd
* Place the Nix configuration in `/etc/nix/nix.conf`
* Place channel configuration at `/root/.nix-channels`
* Configure the shell profiles
* Enable (and start) the systemd unit nix-daemon.socket


Proceed? (y/N): y
 INFO Step: Create directory `/home/nix`
 INFO Step: Create or overwrite file `/etc/systemd/system/nix-directory.service`
 INFO Step: Create or overwrite file `/etc/systemd/system/nix.mount`
 INFO Step: Create or overwrite file `/etc/systemd/system/ensure-symlinked-units-resolve.service`
 INFO Step: Enable (and start) the systemd unit ensure-symlinked-units-resolve.service
 INFO Step: Provision Nix
 INFO Step: Configure Nix
 INFO Step: Enable (and start) the systemd unit nix-daemon.socket
(deck@steamdeck ~)$ . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
(deck@steamdeck ~)$ nix run nixpkgs#hello
Hello, world!
</code></pre>
<p>Hate it? Uninstall it:</p>
<pre><code>(deck@steamdeck ~)$ /nix/nix-installer uninstall
</code></pre>
<p>Our prototype has the working name of <code>nix-installer</code>. It supports different installation &#39;planners&#39; (such as the <code>steam-deck</code>), can be used as a Rust library, has fine grained logging, and can uninstall a Nix it installed.</p>
<p>It has no runtime dependencies (though it will try to <code>sudo</code> itself if you forget) or build time dependencies (other than Rust/C compilers) and should build trivially inside or outside Nix for x86_64 and aarch64, Linux (<code>glibc</code> or <code>musl</code> based) and Mac.</p>
<p>We are currently distributing fully reproducible and hermetic <code>nix</code> based <strong>experimental</strong> builds for all supported platforms. The installer is Open Source (LGPL) and written in entirely in Rust. (Nix is still not in Rust -- sorry!)</p>
<p>You are welcome to explore the code <a href="https://github.com/DeterminateSystems/nix-installer">here</a>. Don&#39;t worry, we&#39;re very excited to talk about it at length in a future article. Stay tuned for more!</p>
<blockquote>
<p>We&#39;ve been working with other installer working group contributors like (alphabetical) <a href="https://github.com/colemickens">Cole</a>, <a href="https://github.com/mkenigs">Michael</a>, <a href="https://dataswamp.org/~solene/index.html">Solène</a>, <a href="https://github.com/thufschmitt">Théophane</a>, <a href="https://t-ravis.com/">Travis</a>, and others to build <code>nix-installer</code> and better understand what a next-generation Nix installer would look like, thank you so much for all your help, hard work, and advice.</p>
</blockquote>

<p>We explored how the Steam Deck takes certain measures to protect users from accidently losing changes when the system updates and swaps due to its A/B booting, we also explored how we can use persistent systemd units to create a <code>/nix</code> path on the Steam Deck which bind mounts to a persistent <code>/home/nix</code> directory. In order to ensure that the units linked from the <code>/nix</code> path are loaded, we also learnt we can have a unit which reloads the systemd daemon, and how this resolves the issue.</p>
<p>Using these techniques, we successfully installed Nix on the Steam Deck using both the traditional installer, as well as a prototype that we&#39;ve been working on.</p>
</div></div></div>
  </body>
</html>
