<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://adhoc.team/2022/01/18/covidtests-usps-aws-managed-services/">Original</a>
    <h1>Examining the covidtests.gov architecture</h1>
    
    <div id="readability-page-1" class="page"><div id="top">  <main id="js--content"> <article> <div> <div> <header>   </header> <section> <p>A day early, the Biden Administration has quietly launched <a href="https://www.covidtests.gov">the new website</a> that allows households to order four COVID-19 rapid antigen tests.</p> <p><a href="https://www.fcw.com/digital-government/2022/01/usps-usds-collaborate-new-covid-19-test-website/360791/">The reporting from last Friday</a>, when details of the website were first made available, indicated the U.S. Digital Service (<abbr title="U.S. Digital Service">USDS</abbr>) and the U.S. Postal Service (<abbr title="U.S. Postal Service">USPS</abbr>) were involved, and that the site would use <abbr title="U.S. Postal Service">USPS</abbr>’s existing web properties and facilities to process orders and deliver the tests.</p> <p>Now that the site is live and accepting orders, let’s look at the outside indicators to see how it was constructed.</p> <h2 id="the-landing-page">The landing page</h2> <p>The www. domain name is a CNAME record that ultimately resolves to Akamai. This isn’t surprising, as Akamai has performed as a <abbr title="Content Delivery Network">CDN</abbr> for U.S. government properties before.</p> <figure> <img data-src="/covidtest-lookup-1-900.8400d8d6.jpg" loading="lazy" alt="Lookup of DNS information of www.covidtests.gov on command line." role="img"/> </figure> <p>The A record for the naked top-level covidtests.gov name are <abbr title="Internet Protocol">IP</abbr> addresses in the Akamai network.</p> <figure> <img data-src="/covidtest-lookup-2-900.e58ff1d1.jpg" loading="lazy" alt="Lookup of DNS information of covidtests.gov and an IP address on command line." role="img"/> </figure> <p>So the landing page and its <abbr title="Cascading Style Sheets">CSS</abbr> and <abbr title="JavaScript">JS</abbr> dependencies are likely objects in Akamai’s NetStorage product fronted by its <abbr title="Content Delivery Network">CDN</abbr> product.</p> <p>The call to action button “Order Free At-Home Tests” takes the user to a <abbr title="U.S. Postal Service">USPS</abbr> web property, <a href="https://special.usps.com/testkits">https://special.usps.com/testkits</a>, which is the actual order form.</p> <h2 id="the-order-page">The order page</h2> <p>This domain name resolves to <abbr title="Amazon Web Services">AWS</abbr> CloudFront, its <abbr title="Content Delivery Network">CDN</abbr> offering. The authority section of the <abbr title="nameserver">NS</abbr> record for special.usps.com is ns-418.awsdns-52.com, which indicates <a href="https://special.usps.com">special.usps.com</a> is managed by <abbr title="Amazon Web Services">AWS</abbr>’s Route53 <abbr title="Domain Name System">DNS</abbr> hosting product.</p> <figure> <img data-src="/covidtest-lookup-3-900.51c6b1f9.jpg" loading="lazy" alt="Lookup of DNS information of special.usps.com on command line." role="img"/> </figure> <p>The order page itself is an object in <abbr title="Amazon Web Services">AWS</abbr> S3 object store as an origin server, fronted by the <abbr title="Content Delivery Network">CDN</abbr>.</p> <figure> <img data-src="/covidtest-lookup-4-900.5d80d994.jpg" loading="lazy" alt="Lookup of HTTP header information about special.usps.com on command line." role="img"/> </figure> <p>Submitting the order form is an <abbr title="Hypertext Transfer Protocol">HTTP</abbr> POST to yet another new domain, special-api.usps.com:</p> <figure> <img data-src="/covidtest-lookup-5-900.028f28dd.jpg" loading="lazy" alt="HTTP request/response details on special.usps.com in web browser dev tools." role="img"/> </figure> <p>This domain name appears to map to <abbr title="Amazon Web Services">AWS</abbr> <abbr title="application programming interface">API</abbr> Gateway.</p> <figure> <img data-src="/covidtest-lookup-6-900.50a58be2.jpg" loading="lazy" alt="Lookup of DNS information of special-api.usps.com on command line." role="img"/> </figure> <p>The form POSTs a <abbr title="JavaScript Object Notation">JSON</abbr> blob to the <abbr title="application programming interface">API</abbr> endpoint (just the root path in this case), and returns confirmation data to the user. That is the entirety of the order transaction.</p> <div><div><pre><code><span>async</span> <span>function</span> <span>confirmOrder</span><span>(</span>
  <span>recipient</span><span>:</span> <span>KitRecipient</span><span>,</span>
  <span>sender</span><span>:</span> <span>KitSender</span>
<span>):</span> <span>Promise</span><span>&lt;</span><span>Response</span><span>&gt;</span> <span>{</span>
  <span>store</span><span>.</span><span>dispatch</span><span>(</span><span>setIsActionPending</span><span>(</span><span>true</span><span>));</span>
  <span>const</span> <span>backendHost</span> <span>=</span> <span>APIEndpoints</span><span>().</span><span>API_BASE</span><span>;</span>
  <span>const</span> <span>body</span> <span>=</span> <span>{</span>
    <span>firstName</span><span>:</span> <span>recipient</span><span>.</span><span>firstName</span><span>,</span>
    <span>lastName</span><span>:</span> <span>recipient</span><span>.</span><span>lastName</span><span>,</span>
    <span>address1</span><span>:</span> <span>recipient</span><span>.</span><span>address1</span><span>,</span>
    <span>address2</span><span>:</span> <span>recipient</span><span>.</span><span>address2</span><span>,</span>
    <span>city</span><span>:</span> <span>recipient</span><span>.</span><span>city</span><span>,</span>
    <span>state</span><span>:</span> <span>recipient</span><span>.</span><span>state</span><span>,</span>
    <span>zip</span><span>:</span> <span>recipient</span><span>.</span><span>zipCode</span><span>,</span>
    <span>email</span><span>:</span> <span>sender</span><span>.</span><span>email</span><span>,</span>
    <span>uCode</span><span>:</span> <span>recipient</span><span>.</span><span>uCode</span><span>,</span>
  <span>};</span>

  <span>const</span> <span>res</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>`</span><span>${</span><span>backendHost</span><span>}</span><span>/`</span><span>,</span> <span>{</span>
    <span>method</span><span>:</span> <span>&#34;</span><span>POST</span><span>&#34;</span><span>,</span>
    <span>mode</span><span>:</span> <span>&#34;</span><span>cors</span><span>&#34;</span><span>,</span>
    <span>headers</span><span>:</span> <span>{</span>
      <span>&#34;</span><span>Content-Type</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>application/json</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>X-Api-Key</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>V2FrZSB1cCwgTmVvLi4u</span><span>&#34;</span><span>,</span>
    <span>},</span>
    <span>body</span><span>:</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>body</span><span>),</span>
  <span>});</span>

  <span>store</span><span>.</span><span>dispatch</span><span>(</span><span>setIsActionPending</span><span>(</span><span>false</span><span>));</span>
  <span>showError</span><span>(</span><span>res</span><span>.</span><span>status</span><span>);</span>
  <span>return</span> <span>res</span><span>;</span>
<span>}</span>
</code></pre></div></div> <p>This is the extent of what we can tell about the implementation and internals of the site from outside signals. I suspect what’s happening from here is that <abbr title="application programming interface">API</abbr> Gateway is in front of a Lambda function (indeed, this is a <a href="https://docs.aws.amazon.com/lambda/latest/dg/services-apigateway.html">common design pattern that AWS documents</a>) that does minimal-to-no processing of the <abbr title="JavaScript Object Notation">JSON</abbr> blob and puts it in a database, likely DynamoDB given the overall managed services flavor of this implementation. At that point, backend processes can take over, likely kicking off notifications, enqueuing business tasks, and talking (via some peer/<abbr title="virtual private network">VPN</abbr>) to the <abbr title="U.S. Postal Service">USPS</abbr> enterprise network.</p> <h2 id="building-the-frontend-of-government">Building the frontend of government</h2> <p>What’s interesting about <a href="https://www.covidtests.gov/">covidtests.gov</a> is that, in spite of the reporting of the use of existing <abbr title="U.S. Postal Service">USPS</abbr> web properties to aid in fulfillment, this appears to be a new custom implementation of the order form. It seems to bring together a set of <abbr title="Amazon Web Services">AWS</abbr>-managed services (again, speculating on the degree to which this is true all the way down into the stack) using largely statically-rendered content served from object stores and <abbr title="Content Delivery Network">CDN</abbr>s. There is a single point of transaction from the user’s perspective, the simple POST of a small amount of <abbr title="JavaScript Object Notation">JSON</abbr> data to the <abbr title="application programming interface">API</abbr> endpoint.</p> <p>This is a very common overall design in the modern web services stack; nothing out of the ordinary here. Indeed, the relative “boringness” of the architecture and seeking managed services from <abbr title="internet service provider">ISP</abbr>s like <abbr title="Amazon Web Services">AWS</abbr> and Akamai, who are proven at the largest scales, was likely a desired aspect of this implementation.</p> <p>I’m not aware if the <abbr title="U.S. Postal Service">USPS</abbr> is typically a big cloud user. In fact, I would be surprised if they had this architecture laying around to be picked up by the Administration. It’s more likely that <abbr title="U.S. Digital Service">USDS</abbr> and <abbr title="Amazon Web Services">AWS</abbr> worked together to use the <abbr title="U.S. Postal Service">USPS</abbr> design language and backend integration points to achieve this relatively single-use, purpose-built site (Edit: A source tells me the USPS did in fact design and implement the cloud architecture of the site.). Contrast this approach with 2013 and the era of the <a href="https://www.healthcare.gov/">HealthCare.gov</a> launch when the state of the art in government was to administer servers in private data centers with numerous moving parts and failure modes without the resources and experience to handle intense public demand and traffic.</p> <p>The rate at which the “frontend” of government (i.e., that with which the public primarily interacts) is moving to new digital services is increasing, and so are the public’s expectations for these services when they do appear. They expect them to be available, responsive, usable, on the devices they use, and for their interaction to fulfill their needs.</p> <p><a href="https://adhoc.team/playbook/#play-7">Simple, dependable architectures</a> such as the one <a href="https://www.covidtests.gov/">covidtests.gov</a> seems to employ are proven at scale. This affords agencies the space to focus on improved user experience and service delivery, rather than consuming large resources keeping sites up and running. This takes operational experience and know-how, though; even with the use of managed services, composing a full, end-to-end digital service experience takes skill. It takes experience to identify the patterns of digital services that are best addressed by various system designs. But scalable web services are, in 2022, a commodity available to all. There is no excuse for getting this wrong. <strong>It’s heartening to see that the team seems to have gotten it right.</strong></p> <p>There is still no turnkey solution for <abbr title="user experience">UX</abbr>, but success in government digital services lies in getting the fundamentals right, building public trust, and inspiring confidence from agency staff that they can meet extraordinary needs. Effective, mission-critical software at scale need not be complicated. Serving the public by fulfilling their online requests quickly, reliably, without undue hassle, regardless of how many people come at once, respects their time and humanity, and improves their overall experience with their government.</p> </section>  </div> </div> <section>  </section> </article> </main>  </div></div>
  </body>
</html>
