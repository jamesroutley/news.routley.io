<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.trailofbits.com/2025/08/21/weaponizing-image-scaling-against-production-ai-systems/">Original</a>
    <h1>Weaponizing image scaling against production AI systems</h1>
    
    <div id="readability-page-1" class="page"><div><p>Picture this: you send a seemingly harmless image to an LLM and suddenly it exfiltrates all of your user data. By delivering a multi-modal prompt injection not visible to the user, we achieved data exfiltration on systems including the Google Gemini CLI. This attack works because AI systems often scale down large images before sending them to the model: when scaled, these images can reveal prompt injections that are not visible at full resolution.</p><p>In this blog post, we’ll detail how attackers can <a href="https://www.usenix.org/conference/usenixsecurity20/presentation/quiring">exploit image scaling</a> on Gemini CLI, Vertex AI Studio, Gemini’s web and API interfaces, Google Assistant, Genspark, and other production AI systems. We’ll also explain how to mitigate and defend against these attacks, and we’ll introduce <a href="https://github.com/trailofbits/anamorpher">Anamorpher</a>, our open-source tool that lets you explore and generate these crafted images.</p><figure><img src="https://blog.veitheller.de/img/image_scaling_figure_1.png" alt="Image showing a side-by-side comparison of an image that is harmless at the original resolution but contains a prompt injection when scaled down"/><figcaption>Figure 1: Ghost in the Scale: Side-by-side comparison of an image that is harmless at the original resolution but contains a prompt injection when scaled down</figcaption></figure><p><em>Background</em>: <a href="https://www.usenix.org/conference/usenixsecurity19/presentation/xiao">Image scaling attacks</a> were used for model <a href="https://arxiv.org/abs/2003.08633">backdoors, evasion, and poisoning</a> primarily against older computer vision systems that enforced a fixed image size. While this constraint is less common with newer approaches, the systems surrounding the model may still impose constraints calling for image scaling. This establishes an underexposed, yet widespread vulnerability that we’ve weaponized for <a href="https://developer.nvidia.com/blog/how-hackers-exploit-ais-problem-solving-instincts/">multi-modal prompt injection</a>.</p><h2 id="data-exfiltration-on-the-gemini-cli">Data exfiltration on the Gemini CLI</h2><figure><img src="https://blog.veitheller.de/img/image_scaling_figure_2.gif" alt="Scale to fail in the Gemini CLI"/><figcaption>Figure 2: Scale to fail in the Gemini CLI</figcaption></figure><p>To set up our data exfiltration exploit on the Gemini CLI through an image-scaling attack, we applied the default configuration for the Zapier MCP server. This automatically approves all MCP tool calls without user confirmation, <a href="https://github.com/google-gemini/gemini-cli/issues/5598">as it sets <code>trust=True</code> in the <code>settings.json</code> of the Gemini CLI</a>. This provides an important primitive for the attacker.</p><p>Figure 2 showcases a video of the attack. First, the user uploads a seemingly benign image to the CLI. With no preview available, the user cannot see the transformed, malicious image processed by the model. This image and its prompt-ergeist triggers actions from Zapier that exfiltrates user data stored in Google Calendar to an attacker’s email without confirmation.</p><p>This attack is one of many prompt injection attacks already demonstrated on agentic coding tools (including Claude Code and OpenAI Codex). Prior attacks have achieved data exfiltration and remote code execution by <a href="https://embracethered.com/blog/posts/2025/claude-code-exfiltration-via-dns-requests/">exploiting unsafe actions contained in sandboxes</a>, <a href="https://embracethered.com/blog/posts/2025/chatgpt-codex-remote-control-zombai/">utilizing overly permissive domains contained in network allowlists</a>, and <a href="https://embracethered.com/blog/posts/2025/github-copilot-remote-code-execution-via-prompt-injection/">bypassing user confirmation by changing environment configurations</a>. Evidently, these agentic coding tools continue to lack sufficiently secure defaults, design patterns, or systematic defenses that minimize the possibility of impactful prompt injection.</p><h2 id="even-more-attacks">Even more attacks</h2><figure><img src="https://blog.veitheller.de/img/image_scaling_figure_3.gif" alt="Honey, I shrunk the payload on Genspark"/><figcaption>Figure 3: Honey, I shrunk the payload on Genspark</figcaption></figure><figure><img src="https://blog.veitheller.de/img/image_scaling_figure_4.gif" alt="Injection through the looking glass on Vertex AI Studio"/><figcaption>Figure 4: Injection through the looking glass on Vertex AI Studio</figcaption></figure><p>We also successfully demonstrated image scaling attacks on the following:</p><ul><li>Vertex AI with a Gemini back end</li><li>Gemini’s web interface</li><li>Gemini’s API via the <code>llm</code> CLI</li><li>Google Assistant on an Android phone</li><li>Genspark</li></ul><p>Notice the persistent mismatch between user perception and model inputs in figures 3 and 4. The exploit is particularly impactful on Vertex AI Studio because the front-end UI shows the high-resolution image instead of the downscaled image perceived by the model.</p><p>Our testing confirmed that this attack vector is widespread, extending far beyond the applications and systems documented here.</p><h2 id="sharpening-the-attack-surface">Sharpening the attack surface</h2><p>These image scaling attacks exploit downscaling algorithms (or <a href="https://guide.encode.moe/encoding/resampling.html">image resampling algorithms</a>), which perform interpolation to turn multiple high resolution pixel values into a single low resolution pixel value.</p><p>There are three major downscaling algorithms: <a href="https://en.wikipedia.org/wiki/Nearest-neighbor_interpolation">nearest neighbor interpolation</a>, <a href="https://en.wikipedia.org/wiki/Bilinear_interpolation">bilinear interpolation</a>, and <a href="https://en.wikipedia.org/wiki/Bicubic_interpolation">bicubic interpolation</a>. Each algorithm requires a different approach to perform an image scaling attack. Furthermore, these algorithms are implemented differently across libraries (e.g., Pillow, PyTorch, OpenCV, TensorFlow), with varying anti-aliasing, alignment, and kernel phases (in addition to <a href="https://bartwronski.com/2021/02/15/bilinear-down-upsampling-pixel-grids-and-that-half-pixel-offset/">distinct bugs</a> that historically have <a href="https://arxiv.org/abs/2104.11222">plagued model performance</a>). These differences also impact the techniques necessary for an image scaling attack. Therefore, exploiting production systems required us to fingerprint each system’s algorithm and implementation.</p><p>We developed a custom test suite and methodology to fingerprint downscaling algorithms across different implementations. Core components of this test suite include images with <a href="https://nicola.asuni.xyz/papers/20140923_STAG_ASUNI_TESTIMAGES.pdf">checkerboard patterns, concentric circles, vertical and horizontal bands</a>, <a href="https://en.wikipedia.org/wiki/Moir%C3%A9_pattern">Moiré patterns</a>, and <a href="https://www.imatest.com/imaging/sharpness/">slanted edges</a>. These would reveal <a href="https://guide.encode.moe/encoding/video-artifacts.html">artifacts</a> such as <a href="https://en.wikipedia.org/wiki/Ringing_artifacts">ringing</a>, blurring, edge handling, <a href="https://en.wikipedia.org/wiki/Aliasing">aliasing</a>, and <a href="https://www.imatest.com/docs/nyquist-aliasing/">inconsistencies in color</a> caused by the underlying downscaling algorithm. This typically provided a sufficient amount of information to determine the algorithm and implementation, enabling us to choose from one of our crafted attacks.</p><h2 id="nyquists-nightmares">Nyquist’s nightmares</h2><p>To understand why image downscaling attacks are possible, imagine that you have a long ribbon with an intricate yet regular pattern on it. As this ribbon is pulled past you, you’re trying to recreate the pattern by grabbing samples of the ribbon at regular intervals. If the pattern changes rapidly, you need to grab samples very frequently to capture all the details. If you’re too slow, you’ll miss crucial parts between grabs, and when you try to reconstruct the pattern from your samples, it looks completely different from the original.</p><p>In this analogy, your hand is the sampler, and if the sampling rate falls below a certain threshold (i.e., your hand isn’t fast enough), you cannot unambiguously reconstruct the pattern. <a href="https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem">This aliasing effect is a consequence of the Nyquist–Shannon sampling theorem</a>. Exploiting this ambiguity by manipulating specific pixels such that a target pattern emerges is exactly what image scaling attacks do. Refer to <a href="https://www.usenix.org/system/files/sec20fall_quiring_prepub.pdf">Quiring et al.</a> for a more detailed explanation.</p><h2 id="anamorpher-and-the-attackers-darkroom">Anamorpher and the attacker’s darkroom</h2><p>Currently, Anamorpher (named after <a href="https://en.wikipedia.org/wiki/Anamorphosis">anamorphosis</a>) can develop crafted images for the aforementioned three major methods. Let’s explore how Anamorpher exploits bicubic interpolation frame by frame.</p><p>Bicubic interpolation considers the 16 pixels (from 4x4 sampling) around each target pixel, using cubic polynomials to calculate smooth transitions between pixel values. This method creates a predictable mathematical relationship that can be exploited. Specifically, the algorithm assigns different weights to pixels in the neighborhood, creating pixels that contribute more to the final output, which are known as high-importance pixels. Therefore, the total <a href="https://en.wikipedia.org/wiki/Luma_(video)">luma</a> (brightness) of dark areas of an image will increase if specific high-importance pixels are higher luma than their surroundings.</p><p>Therefore, to exploit this, we can carefully craft high-resolution pixels and solve the inverse problem. First, we select a decoy image with large dark areas to hide our payload. Then, we adjust pixels in dark regions and push the downsampled result toward a red background using least-squares optimization. These adjustments in the dark areas cause the background to turn red while text areas remain largely unmodified and appear black, creating much stronger contrast than visible at full resolution. While this approach is most effective on bicubic downscaling, it also works on specific implementations of bilinear downscaling.</p><figure><img src="https://blog.veitheller.de/img/image_scaling_figure_5.png" alt="How Anamorpher applies this technique on OpenCV’s implementation of bicubic interpolation"/><figcaption>Figure 5: How Anamorpher applies this technique on OpenCV’s implementation of bicubic interpolation</figcaption></figure><p>Anamorpher provides users with the ability to visualize and craft image scaling attacks against specific algorithms and implementations through a front-end interface and Python API. In addition, it comes with a modular back end, which enables users to customize their own downscaling algorithm.</p><h2 id="mitigation-and-defense">Mitigation and defense</h2><p>While some downscaling algorithms are more vulnerable than others, attempting to identify the least vulnerable algorithm and implementation is <a href="https://arxiv.org/abs/2104.08690">not a robust approach</a>. This is especially true since image scaling attacks are not restricted to the aforementioned three algorithms.</p><p>For a secure system, we recommend not using image downscaling and simply limiting the upload dimensions. For any transformation, but especially if downscaling is necessary, the end user should always be provided with a preview of the input that the model is actually seeing, even in CLI and API tools.</p><p>The strongest defense, however, is to implement <a href="https://arxiv.org/abs/2506.08837">secure design patterns and systematic</a> defenses that mitigate impactful prompt injection beyond multi-modal prompt injection. Inputs, but especially text within an image, should not be able to initiate sensitive tool calls without explicit user confirmation. Refer to our <a href="https://blog.trailofbits.com/2025/07/31/hijacking-multi-agent-systems-in-your-pajamas/#building-secure-mass">prior guidance on securing agentic systems</a>.</p><h2 id="now-what">Now what?</h2><p>Image scaling attacks may be even more impactful on mobile and edge devices where fixed image sizes are more frequently enforced and suboptimal downscaling algorithms are readily available within the <a href="https://developer.android.com/reference/android/graphics/Bitmap#createScaledBitmap(android.graphics.Bitmap,%20int,%20int,%20boolean)">default frameworks and tools</a>. Future work should examine the impact on these devices as well as the <a href="https://arxiv.org/abs/2507.06256">additional attack surface introduced by voice AI</a>. It would also be useful to explore more effective fingerprinting approaches, <a href="https://developer.nvidia.com/blog/securing-agentic-ai-how-semantic-prompt-injections-bypass-ai-guardrails/">semantic prompt injection</a>, <a href="https://arxiv.org/abs/2404.11615">factorized diffusion</a>, <a href="https://blog.trailofbits.com/2019/11/01/two-new-tools-that-tame-the-treachery-of-files/">polyglots</a>, and additional artifact exploitation, especially any typically chained with upscaling (such as <a href="https://en.wikipedia.org/wiki/Dither">dithering</a>).</p><p><a href="https://github.com/trailofbits/anamorpher">Anamorpher</a> is currently in beta, so feel free to reach out with feedback and suggestions as we continue to improve this tool. Stay tuned for more work on the security of multi-modal, agentic, and multi-agentic AI systems!</p></div></div>
  </body>
</html>
