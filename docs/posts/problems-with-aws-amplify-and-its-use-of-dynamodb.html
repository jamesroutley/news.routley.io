<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://samthor.au/2023/aws-amplify-is-a-grift/">Original</a>
    <h1>Problems with AWS Amplify and its use of DynamoDB</h1>
    
    <div id="readability-page-1" class="page"><div>
<article>
<p>Yes, this is a punchy headline, but if you&#39;ll join me on this journey, you&#39;ll see how. ðŸ‘€</p>
<p>So, here&#39;s the context.
For the past year or so, I was at a renewable energy startup.
It was a great experience, but I recently resigned: I&#39;m having another child, and I just don&#39;t need to work full-timeâ€”so I&#39;m not going to.
To be clear, this post is entirely my opinion: as of writing, I&#39;m only employed <a href="https://samthor.au/about/consulting/">by myself</a>.</p>
<p>The startup heavily used Amplifyâ€”I inherited that decisionâ€”but one of my major initatives was removing as much of it as possible.
This took hundreds of engineering hours away from <em>actual work</em>.</p>
<p>So, let me be as clear as possible, and you can quote me personally on this: &#34;AWS Amplify is <em>actively harmful</em>&#34;, primarily because of its database choice.</p>
<p>Consider using just a normal databaseâ€”personally for me that would be Firestore (Google-hosted) or MongoDB (basically self-hotsed), because I strongly prefer scalable NoSQL databases.
But for most people, it&#39;s probably going to literally just be Postgres.
You don&#39;t need more than Postgres.</p>
<h2 id="how-can-a-framework-be-actively-harmful%3F">How can a framework be actively harmful?</h2>
<p>A core idea of cloud providers is that you can build your infra and not have to worry about scale.
AWS Amplify makes promises that it will be:</p>
<blockquote>
<p>Easy to start, easy to scale</p>
</blockquote>
<p>But herein lies the grift: it&#39;s useless for anything except toy applications with trivial amounts of <em>data</em>.
And these toy apps are conveniently easy to demo.</p>
<p>And data is the key here; there&#39;s a lot of AWS Amplify which is just fine and <em>boring</em>, like its user authentication libraries.
The issue lies with GraphQL and the way it stores data.</p>
<p>The challenge, of course, is that you don&#39;t know that it&#39;s terrible going in: that&#39;s why I&#39;m writing this post. The issue is that it it&#39;s built by the world&#39;s biggest cloud provider, who is completely happy to pay US$200k/yrs to DevRels to push this unusable bit of softwareâ€”so you might think, sure, it&#39;s fine.</p>
<p>But it&#39;s not. ðŸ’¥</p>
<h2 id="the-boring-stuff">The Boring Stuff</h2>
<p>Let&#39;s get the boring stuff out of the way.
By that, I mean the parts of AWS Amplify that are innocuous, indifferent, and are plainly things that are hard to mess up <em>or</em> be particularly amazing at.</p>
<ul>
<li>
<p><strong>Cognito</strong>: Amplify sets up an auth stack.
It&#39;s got its own problems (including poor SSO integration that actively leaks all configured integrations), but if all you want is basic email/password login, it&#39;s fine.
I&#39;ve heard on the grapevine that Amplify&#39;s client-side JS is actually the best way to interact with Cognito.</p>
</li>
<li>
<p><strong>Hosting</strong>: There&#39;s a YAML-based config language which sets up some basic CI/CD to deploy your website.
It&#39;s fine.</p>
</li>
<li>
<p><strong>Analytics</strong>: It&#39;s broken.
If the same user signs in on a large number of different browsers (you&#39;d never do that while debugging, in multiple Incognito windowsâ€”never!) then you generate too many IDs for that user and events can no longer be logged.</p>
</li>
<li>
<p><strong>Some AI stuff</strong>: I haven&#39;t used this.
It seems like it&#39;s just AWS wrapping up its more complex services withâ€¦ exactly the same level of complexity, but now it has a ðŸŒˆ brand ðŸŒˆ.</p>
</li>
</ul>
<p>Again, this is fine.
Any provider pitched at the same levelâ€”Firebase, Supabase, Azure probably has oneâ€”has this kind of &#34;app-builder&#34; stack.</p>
<h2 id="data%2C-it&#39;s-what-apps-crave">Data, It&#39;s What Apps Crave</h2>
<p>AWS Amplify allows you to specify GraphQL models that turn into database rows.
To be fair, this is an annoying problem: let&#39;s say you&#39;re DIYing it, and writing a GraphQL server and database integration yourself.</p>
<ul>
<li>If you&#39;re using a traditional SQL database you&#39;ll have to write both the GraphQL schema and the table schema.</li>
<li>If you&#39;re using NoSQL, you may have to massage your GraphQL types before storing themâ€”since GraphQL&#39;s type system is needlessly restrictive.</li>
</ul>
<p>However, the fundamental mistake that&#39;s made here is that <em>AWS Amplify puts your data into DynamoDB</em>, which is not a general-purpose database.</p>
<p>Amplify&#39;s approach in using DynamoDB is literally called out <a href="https://aws.amazon.com/blogs/database/single-table-vs-multi-table-design-in-amazon-dynamodb/">as something you should avoid by AWS</a>, because it uses a single table per resource.
Additionally, you cannot filter or sort by arbitrary columnsâ€”DynamoDB is a high-performance, low-level database, that doesn&#39;t let you do arbitrary queries.
That&#39;s the point.</p>
<p>Yes, Amplify awkwardly describes the way you <a href="https://docs.amplify.aws/cli/graphql/data-modeling/">can create secondary indexes</a>, but it&#39;s often not what you need (everything needs primary AND secondary keys, etc), and you can&#39;t index on any sort of ACLs.</p>
<p>So using it is literally an anti-pattern.
And part of the problem is, once you&#39;re in production using a databaseâ€”whatever database, not just DynamoDBâ€”it&#39;s hard to get out.</p>
<h3 id="but-dynamodb-scales%3F">But DynamoDB Scales?</h3>
<p>But Sam, you sayâ€”DynamoDB is a fast, scalable database.
Surely these tradeoffs are worth it?</p>
<p>Yes, in some cases.
But you should only use it when a traditional database won&#39;t cut it (and if you think you know what that threshold is, go and double the number and come back to me), and you can confidently design your queries up-front.</p>
<p>Amplify, which is literally pitched at startups, isn&#39;t suitable because you&#39;re going to pivot.
Your CEO is going to ask you for some weird data &#39;shape&#39; that just isn&#39;t possible because Dynamo plainly cannot answer your arbitrary queries.
Yes, no data is ever in a perfect table, but this makes it worse.</p>
<p>There is a flipside, which is that Dynamo is fairly fast at a &#34;scan&#34;, which is a fancy term for &#34;load every row and filter it at runtime&#34;.
And yes, if you don&#39;t have much dataâ€”again, think of a number and add an order of magnitude to itâ€”you can just do that, but then why are you using DynamoDB?
Dynamo scales by shardingâ€”your primary key space is divided ito partitions.
But a partition <a href="https://www.google.com/search?q=dynamo+partition+size">is literally 10gb</a> of data.</p>
<ul>
<li>If you&#39;re storing that much plain text data, good for youâ€”maybe DynamoDB can help you!</li>
<li>If you&#39;ve only hit 10gb since you&#39;re putting large binary data into your database, you should rethink your choices.</li>
</ul>
<p>So if your company doesn&#39;t have that much data (even 100gb might be a good target), but chooses to use Dynamo, your effective option to do arbitrary queries is just toâ€¦ scan all the data.</p>
<p>So why are you using Dynamo, a hyper-performant and extremely limited database, again? ðŸ¤”</p>
<h3 id="but-dynamodb-is-fast%3F">But DynamoDB Is Fast?</h3>
<p>Ah, well, here&#39;s the real killer.</p>
<p>If you put access controls on your data, and say, a user wants to retrieve their &#34;Foos&#34;â€¦ AWS Amplify literally has to fetch matching data and then filter it down.</p>
<p><strong>Let me say that again.</strong>
If you have 1,000 users, and each privately owns one row of data, Amplify&#39;s default pagination of 100 items per fetch will takeâ€”in the worst caseâ€”<code>O(users/100)</code> pages to retrieve the user&#39;s item.
For 1,000, that&#39;s 10 pages.
For 100,000, that&#39;s 100 pagesâ€”100 round trips from your user&#39;s web browser back to the database.</p>
<p>The VTL, a language used by AppSync, which is Amplify&#39;s underlying provider, looks like the following (a tiny bit snipped for brevity).
And note that the &#39;data source&#39; items are in <code>$ctx.result.items</code>â€”that&#39;s the page we have to scan to see if a user can see their own data.</p>
<pre><code>#set( $items = [] )
#foreach( $item in $ctx.result.items )
  ## [Start] Dynamic Group Authorization Checks **
  #set( $isLocalDynamicGroupAuthorized = false )
  ## Authorization rule: { allow: groups, groupsField: &#34;groupsWithRead&#34;, groupClaim: &#34;cognito:groups&#34; } **
  #set( $allowedGroups = $util.defaultIfNull($item.groupsWithRead, []) )
  #set( $userGroups = $util.defaultIfNull($ctx.identity.claims.get(&#34;cognito:groups&#34;), []) )
  #foreach( $userGroup in $userGroups )
    #if( $allowedGroups.contains($userGroup) )
      #set( $isLocalDynamicGroupAuthorized = true )
    #end
  #end
  ## [End] Dynamic Group Authorization Checks **

  #if( ($isLocalDynamicGroupAuthorized == true) )
    $util.qr($items.add($item))
  #end
#end
#set( $ctx.result.items = $items )
</code></pre>
<p>Yes.
It&#39;s really that bad.
Of course, Amazon&#39;s <a href="https://docs.aws.amazon.com/appsync/latest/devguide/configuring-resolvers.html">sample resolvers</a> (not that you write VTL directly with AWS Amplify) don&#39;t include thisâ€”they have a single line saying, &#34;oh, you&#39;ll just pass all the data back to the client&#34;.</p>
<h2 id="what-else-is-wrong%3F">What Else Is Wrong?</h2>
<p>The above criticism, the run-time filtering of user data, is by far the most egregious failure of AWS Amplify.
There&#39;s a number of other poor areas, too.</p>
<p>Firstly, GraphQL subscriptions are basically useless.
There&#39;s a <a href="https://blog.purple-technology.com/lessons-learned-aws-appsync-subscriptions/">great blog post here</a> which covers this far better than I can.</p>
<p>And Amplify&#39;s <a href="https://docs.amplify.aws/lib/datastore/getting-started/q/platform/js/">DataStore</a> fails fundamentally <em>because</em> it relies on GraphQL subscriptions and Amplify&#39;s view on that.
It doesn&#39;t support dynamic ACLs (which is <em>technically listed in the docs</em> but not at all clear), so you can only listen to public items, which is bizzare.
And it falls into the traps above.
There are <a href="https://github.com/aws-amplify/amplify-cli/issues/4794">so</a> <a href="https://github.com/aws-amplify/amplify-js/issues/7069">many</a> <a href="https://github.com/aws-amplify/amplify-js/issues/7989">issues</a> about how it&#39;s unusable and how the people filing didn&#39;t realize until they were already knee-deep in Amplify&#39;s grift.</p>
<p>Additionally, the JS used by AWS Amplify allows for race conditions in listening to changes.
What do you do when you want a list of &#34;live&#34; objects?
You&#39;d imagine something like:</p>
<ul>
<li>You request the complete list of objects</li>
<li>You listen for changes to those objects</li>
</ul>
<p>And that&#39;s what Amplify does, â€¦ but here&#39;s the kicker, in a diagram:</p>
<figure>
  <img loading="lazy" src="https://storage.googleapis.com/hwhistlr.appspot.com/assets/subscription.png" alt="Diagram of traditional subscription model" width="950" height="384"/>
  <figcaption>The red line is &#39;danger&#39;â€”what happened there?</figcaption>
</figure>
<p>So you&#39;re going to risk losing changes.
And for most usersâ€”sure, that&#39;s fine.
What are the odds of something happening in that red area?
But it&#39;s poor design.</p>
<p>I know there&#39;s a slightly tweaked approach that has revision numbers and so on, but it&#39;s not commonly understood.</p>
<p>I cannot stress how much Google&#39;s Firestore just solves the &#39;real-time&#39; problem.
Instead, for days and days, I&#39;ve had to work around Amplify&#39;s limitations.</p>
<h2 id="what-should-aws-do%3F">What Should AWS Do?</h2>
<p>So, you say: Sam, you&#39;ve complained a lot.
But Amplify has some redeeming characteristics.
How could you make it better?</p>
<p>If I was AWS, I wouldâ€¦</p>
<ul>
<li><strong>provide Postgres or similar as a database choice</strong>: This allows a developer&#39;s database schemas to include fairly arbitrary indexes (because you&#39;re not limited by DynamoDB)</li>
<li><strong>incorporate ACLs into that database&#39;s indexes</strong>: ACL-ed queries are &#39;slow&#39; because they take the dumbest approach</li>
<li><strong>rebuild subscriptions without GraphQL</strong>: Implement a log-based solution which lets users catch up on a single table they&#39;re interested in, but trade off &#34;nested&#34; queries (it&#39;s not GraphQL anymore)</li>
<li><strong>rethink whether GraphQL is actually fit for purpose</strong>: It&#39;s just not very good, <em>aside</em> from nested queries. That&#39;s a whole different post, though.</li>
</ul>
<h2 id="what-should-you-do%3F">What Should You Do?</h2>
<p>If you&#39;re already commited to AWS Amplify, then I&#39;m sorry.
The auth and non-database worldâ€”that&#39;s fine.
I even enjoy or think that the JWT-based approach to auth is actually fairly good, and you can write alternative backends which use a user&#39;s claims to enforce ACLs.</p>
<p>I think the thing I&#39;d do isâ€¦ if you&#39;re somewhat &#34;successfully&#34; using Amplify right now, I believe that your model and data won&#39;t actually be that largeâ€”because it actually breaks down at big numbers.
Therefore it is the right time to rethink.</p>
<p>Look at your queries which are particularly awkwardâ€”what does your app or company have the most of?
Can that be refactored into its own system, potentially wrapping up a database that&#39;s <em>more</em> fit for purpose?</p>
<p>Remember too that most applications will have a notion of login, user, settingsâ€”fairly boring stuff.
If that&#39;s in Amplify, fine.
A lot of it is probably ID-based, which Dynamo actually <em>does excel at</em>â€”you&#39;re not listing every user to get to your own.
So that can remain.</p>
<h2 id="thanks-for-reading">Thanks For Reading</h2>
<p>This space isn&#39;t perfect, but I honestly believe Amplify has too many potholes to justify its use, and those are wrapped up in poor documentation that hides a lot of nuances that <em>aren&#39;t obvious</em> when you start and only hit you when you&#39;re actually trying to scale.</p>
<p>Best of luck. ðŸ˜¬</p>
<p>Hit me up <a href="https://twitter.com/samthor">on the hellbird site</a>, or <a href="https://mastodon.social/@samthor">with the elephants</a>.
I&#39;m also available <a href="https://samthor.au/about/consulting/">for consulting</a>.</p>
</article>
</div></div>
  </body>
</html>
