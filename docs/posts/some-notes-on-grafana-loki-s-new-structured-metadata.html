<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiStructuredMetadata">Original</a>
    <h1>Some notes on Grafana Loki&#39;s new &#34;structured metadata&#34;</h1>
    
    <div id="readability-page-1" class="page"><div><h2>Some notes on Grafana Loki&#39;s new &#34;structured metadata&#34; (as of 3.0.x)</h2>

	<p><small>May 27, 2024</small></p>
</div><div><p>Grafana Loki somewhat bills itself as &#34;Prometheus for logs&#34;, and
so it&#39;s unsurprising that it started with a data model much like
Prometheus. Log lines in Loki are stored with some amount of metadata
in labels, just as Prometheus metrics values have labels (including
the name of the metric, which is sort of a label). Unfortunately
Loki made implementation choices that caused this data model to be
relatively catastrophic for system logs (either syslog logs or the
systemd journal). Unlike Prometheus, <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiCardinalityProblem">Loki stores each set of label
values separately</a> and <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiNoChunkCompaction">it never
compacts its log storage</a>. Your choices
are to either throw away a great deal of valuable system log metadata
in order to keep label cardinality down, <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiAvoidingJSON">contaminate your log
lines with metadata, making them hard to use</a>,
or <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiStartupWALReplayIssue">run Loki in a way that causes periodic explosions</a> and is in general very far outside
the configurations that Grafana Inc develops Loki for.</p>

<p>Eventually Grafana Inc worked out that this was less than ideal and
sort of did something about it, by introducing <a href="https://grafana.com/docs/loki/next/get-started/labels/structured-metadata/">&#34;structured metadata&#34;</a>.
The simple way to describe Loki&#39;s structured metadata is that it
is labels (and label values) that are not used to separate out log
line storage. In theory this is just what I&#39;ve wanted for some time,
but in practice as of Loki 3.0.0, structured metadata is undercooked
and not something we can use. However, you probably want to use it
in a new greenfield development to ingest system logs (<a href="https://grafana.com/docs/loki/next/send-data/promtail/stages/structured_metadata/">via
promtail&#39;s somewhat underdocumented support for it</a>),
although <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiSimpleNotRecommended">I can&#39;t recommend that you use Loki at all, at least in
simple configurations</a>.</p>

<p>The first problem is that structured metadata labels are not actual
labels as Loki treats them. If you have a structured metadata label
&#39;<code>fred</code>&#39;, you cannot write a <a href="https://grafana.com/docs/loki/latest/query/">LogQL</a> query of
&#39;{...,fred=&#34;value&#34;}&#39;. Instead you must write this as &#39;{....} |
fred=&#34;value&#34;&#39;. This means that all of your queries care deeply about
whether a particular thing is a Loki label or merely a structured
metadata label. I feel strongly that your queries should not depend
on the details of your database schema, partly because it makes
changing your database schema harder. Loki tools are inconsistent
about this distinction; for example &#39;logcli query&#39; will mostly
print structured metadata labels as if they were real labels.</p>

<p>Speaking of changing your database schema, that is the large other
piece of bad news about structured metadata. If you have an existing
Loki environment from before structured metadata, complete with
<a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/GrafanaLokiStartupWALReplayIssue">lots of real labels because that&#39;s how you had to capture log
metadata</a>, there is no obvious
way to switch over to using structured metadata for that log metadata.
There are some interesting ways to fail to do so, because the current
Loki will accept a client submitting &#39;structured metadata&#39; that the
Loki server thinks should be actual labels. If you add some new,
higher cardinality structured metadata along side the labels you&#39;d
like to convert, I&#39;ve seen this add that high cardinality structured
metadata as actual labels (the result wasn&#39;t pretty). If you want to
switch, the easiest way is to stop Loki, delete all of your existing
log data, and start from scratch with all clients sending all of the
log metadata you care about as structured metadata instead of labels.</p>

<p>I haven&#39;t tested what happens in a greenfield configuration if
most clients send some client-side labels as structured metadata
but one client fumbles things and sends them as labels. I would
like to think that Loki rejects this, rather than accepts it and
silently converts the structured metadata labels from other clients
into real labels (possibly high cardinality ones). Unfortunately
this isn&#39;t a theoretical mistake, because of an implementation
choice in the current (3.0.x) version of <a href="https://grafana.com/docs/loki/next/send-data/promtail/">Promtail</a>. In Promtail,
in order to send syslog or systemd journal fields as structured
metadata, you must first materialize them as regular labels (via
<a href="https://grafana.com/docs/loki/next/send-data/promtail/configuration/#relabel_configs">relabeling</a>)
and then converted to structured metadata in the structured metadata
stage. If you do the first but not the second, your Promtail
configuration will send that metadata to Loki as actual labels,
possibly to your deep regret.</p>

<p>I was initially hopeful that structured metadata would let us change
our Loki configuration to something closer to a mainstream one.
Unfortunately, my investigation has ruled this out for now; we would
need to change too many existing queries and there are too many
uncertainties over whether we would be able to do it without deleting
all of our existing log data (and then living in fear of a cardinality
explosion due to an outdated or mis-configured client).  Maybe in
Loki 4.0.</p>
</div></div>
  </body>
</html>
