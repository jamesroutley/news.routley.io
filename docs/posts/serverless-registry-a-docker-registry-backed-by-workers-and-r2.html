<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/cloudflare/serverless-registry">Original</a>
    <h1>serverless-registry: A Docker registry backed by Workers and R2</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">This repository contains a container registry implementation in Workers that uses R2.</p>
<p dir="auto">It supports all pushing and pulling workflows. It also supports
Username/Password and public key JWT based authentication.</p>

<p dir="auto">You have to install all the dependencies with <a href="https://pnpm.io/installation" rel="nofollow">pnpm</a> (other package managers may work, but only pnpm is supported.)</p>

<p dir="auto">After installation, there is a few steps to actually deploy the registry into production:</p>
<ol dir="auto">
<li>Have your own <code>wrangler</code> file.</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="$ cp wrangler.toml.example wrangler.toml"><pre>$ cp wrangler.toml.example wrangler.toml</pre></div>
<ol start="2" dir="auto">
<li>Setup the R2 Bucket for this registry</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="$ npx wrangler --env production r2 bucket create r2-registry"><pre>$ npx wrangler --env production r2 bucket create r2-registry</pre></div>
<p dir="auto">Add this to your <code>wrangler.toml</code></p>
<div data-snippet-clipboard-copy-content="r2_buckets = [
    { binding = &#34;REGISTRY&#34;, bucket_name = &#34;r2-registry&#34;}
]"><pre><code>r2_buckets = [
    { binding = &#34;REGISTRY&#34;, bucket_name = &#34;r2-registry&#34;}
]
</code></pre></div>
<ol start="3" dir="auto">
<li>Deploy your image registry</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="$ npx wrangler deploy --env production"><pre>$ npx wrangler deploy --env production</pre></div>
<p dir="auto">Your registry should be up and running. It will refuse any requests if you don&#39;t setup credentials.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Adding username password based authentication</h3><a id="user-content-adding-username-password-based-authentication" aria-label="Permalink: Adding username password based authentication" href="#adding-username-password-based-authentication"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Set the USERNAME and PASSWORD as secrets with <code>npx wrangler secret put USERNAME --env production</code> and <code>npx wrangler secret put PASSWORD --env production</code>.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Adding JWT authentication with public key</h3><a id="user-content-adding-jwt-authentication-with-public-key" aria-label="Permalink: Adding JWT authentication with public key" href="#adding-jwt-authentication-with-public-key"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">You can add a base64 encoded JWT public key to verify passwords (or token) that are signed by the private key.
<code>npx wrangler secret put JWT_REGISTRY_TOKENS_PUBLIC_KEY --env production</code></p>

<p dir="auto">You can use this registry with Docker to push and pull images.</p>
<p dir="auto">Example using <code>docker push</code> and <code>docker pull</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export REGISTRY_URL=your-url-here

# Replace $PASSWORD and $USERNAME with the actual credentials
echo $PASSWORD | docker login --username $USERNAME --password-stdin $REGISTRY_URL
docker pull ubuntu:latest
docker tag ubuntu:latest $REGISTRY_URL/ubuntu:latest
docker push $REGISTRY_URL/ubuntu:latest

# Check that pulls work
docker rmi ubuntu:latest $REGISTRY_URL/ubuntu:latest
docker pull $REGISTRY_URL/ubuntu:latest"><pre><span>export</span> REGISTRY_URL=your-url-here

<span><span>#</span> Replace $PASSWORD and $USERNAME with the actual credentials</span>
<span>echo</span> <span>$PASSWORD</span> <span>|</span> docker login --username <span>$USERNAME</span> --password-stdin <span>$REGISTRY_URL</span>
docker pull ubuntu:latest
docker tag ubuntu:latest <span>$REGISTRY_URL</span>/ubuntu:latest
docker push <span>$REGISTRY_URL</span>/ubuntu:latest

<span><span>#</span> Check that pulls work</span>
docker rmi ubuntu:latest <span>$REGISTRY_URL</span>/ubuntu:latest
docker pull <span>$REGISTRY_URL</span>/ubuntu:latest</pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Configuring Pull fallback</h3><a id="user-content-configuring-pull-fallback" aria-label="Permalink: Configuring Pull fallback" href="#configuring-pull-fallback"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">You can configure the R2 regitry to fallback to another registry if
it doesn&#39;t exist in your R2 bucket. It will download from the registry
and copy it into the R2 bucket. In the next pull it will be able to pull it directly from R2.</p>
<p dir="auto">This is very useful for migrating from one registry to <code>serverless-registry</code>.</p>
<p dir="auto">It supports both Basic and Bearer authentications as explained in the
<a href="https://distribution.github.io/distribution/spec/auth/token/" rel="nofollow">registry spec</a>.</p>
<p dir="auto">In the wrangler.toml file:</p>
<div data-snippet-clipboard-copy-content="[env.production]
REGISTRIES_JSON = &#34;[{ \&#34;registry\&#34;: \&#34;https://url-to-other-registry\&#34;, \&#34;password_env\&#34;: \&#34;REGISTRY_TOKEN\&#34;, \&#34;username\&#34;: \&#34;username-to-use\&#34; }]&#34;"><pre><code>[env.production]
REGISTRIES_JSON = &#34;[{ \&#34;registry\&#34;: \&#34;https://url-to-other-registry\&#34;, \&#34;password_env\&#34;: \&#34;REGISTRY_TOKEN\&#34;, \&#34;username\&#34;: \&#34;username-to-use\&#34; }]&#34;
</code></pre></div>
<p dir="auto">Set as a secret the registry token of the registry you want to setup
pull fallback in.</p>
<p dir="auto">For example <a href="https://cloud.google.com/artifact-registry/docs/reference/docker-api" rel="nofollow">gcr</a>:</p>
<div data-snippet-clipboard-copy-content="cat ./registry-service-credentials.json | base64 | wrangler --env production secrets put REGISTRY_TOKEN"><pre><code>cat ./registry-service-credentials.json | base64 | wrangler --env production secrets put REGISTRY_TOKEN
</code></pre></div>
<p dir="auto"><a href="https://github.com/settings/tokens">Github</a> for example uses a simple token that you can copy.</p>
<div data-snippet-clipboard-copy-content="echo $GITHUB_TOKEN | wrangler --env production secrets put REGISTRY_TOKEN"><pre><code>echo $GITHUB_TOKEN | wrangler --env production secrets put REGISTRY_TOKEN
</code></pre></div>
<p dir="auto">The trick is always looking for how you would login in Docker for
the target registry and setup the credentials.</p>
<p dir="auto"><strong>Never put a registry password/token inside the wrangler.toml, please always use <code>wrangler secrets put</code></strong></p>

<p dir="auto">Right now there is some limitations with this container registry.</p>
<ul dir="auto">
<li>Pushing with docker is limited to images that have layers of maximum size 500MB. Refer to maximum request body sizes in your Workers plan.</li>
<li>To circumvent that limitation, you can manually add the layer and the manifest into the R2 bucket or use a client that is able to chunk uploads in sizes less than 500MB (or the limit that you have in your Workers plan).</li>
<li>If you use <code>npx wrangler dev</code> and push to the R2 registry with docker, the R2 registry will have to buffer the request on the Worker.</li>
</ul>

<p dir="auto">The project is licensed under the <a href="https://opensource.org/licenses/apache-2.0/" rel="nofollow">Apache License</a>.</p>

<p dir="auto">See <code>CONTRIBUTING.md</code> for contributing to the project.</p>
</article></div></div>
  </body>
</html>
