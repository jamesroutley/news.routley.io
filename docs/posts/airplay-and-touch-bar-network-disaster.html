<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mnpn.github.io/blog/airplay-network-disaster">Original</a>
    <h1>AirPlay and Touch Bar = Network Disaster</h1>
    
    <div id="readability-page-1" class="page"><div>
			
			<p>2022-06-10</p>
			<p>Ever since about the time I upgraded my 2019 MacBook Pro to macOS Monterey in August of 2021 I had been unable to use <a href="https://parsec.app">Parsec</a> properly. I constantly encountered dips in performance every other second, with lots of rubber banding and pretty much constant audio lag (akin to what happens if you open the Wi-Fi dropdown on your menu bar and it starts scanning for networks). I figured this was simply because I had hopped on the upgrade train early and the program simply didn’t support the new version of macOS yet, so I didn’t care too much other than taking the time to look through some support channels (to no avail).</p>

<p>What caused this? An AirPlay button on my Touch Bar.</p>

<h3 id="troubleshooting-hell">Troubleshooting hell</h3>
<p>A while after thinking this was an issue with Parsec itself (despite no one mentioning it anywhere) I noticed that this also applied to other local streaming services, such as Valve’s Steam Play, and I instead excused it as some sort of new driver incompatibility. However, around New Years 2022 I ran some various network speed tests for unrelated reasons and noticed that I was consistently getting a speed of ~340/30, instead of the ~650/50 I was expecting. I ran the same test to the same server on my phone, and lo and behold, I saw the speeds I expected.</p>

<div>
	<div>
		<p><img src="https://mnpn.github.io/assets/airplay/speed-during.png" alt="Terminal displaying a network speed of 350 Mbps from a networkQuality test"/></p><p><em>Something&#39;s not quite right</em></p>
	</div>
	<div>
		<p><img src="https://mnpn.github.io/assets/airplay/speed-without.png" alt="Terminal displaying a network speed of 600 Mbps from a networkQuality test"/></p><p><em>It&#39;s supposed to look like this</em></p>
	</div>
</div>

<p>I was fairly certain this was a software problem since I initially blamed the upgrade to macOS Monterey, so my first step was to start my Mac in safe mode. This changed nothing.</p>

<p>I started holding frequent conversations with <a href="https://saagarjha.com/">Saagar Jha</a> on this matter in March as I documented my descent into madness. Saagar suggested several great things to try, and during my attempts to find the root cause I pinged my router, and the following was revealed:</p>

<p><img src="https://mnpn.github.io/assets/airplay/latency-terminal.png" alt="Terminal displaying an irregular ping pattern, often spiking from an average of 5 milliseconds to over 100"/></p>

<p>I noticed that these strange rhytmic ping waves/spikes happened on both 2.4GHz and 5GHz networks, but not when tethering to my iPhone’s mobile data. This issue also presented itself on my university’s network (hint, there are AirPlay devices available on both). I also discovered that this issue was not present on a new user account.</p>

<p>After hours of going through everything from running apps, Console logs, network tests via Instruments, launchctl processes, potential Bluetooth interference, to so-called “utun” devices, I decided to reinstall macOS (keeping my files intact). It didn’t do much of anything, unfortunately, as my Touch Bar preferences were saved (that’s not generally a bad thing, it should preserve customisations!).</p>

<p>I eventually bit the bullet and just made a new user account, and set everything up again. It worked! (Every now and then it would still occasionally decide to lag for a minute or two, but that seems unrelated). A few days later, however, the issue was back and didn’t want to go away.</p>

<h3 id="the-cause">The cause</h3>
<p>After having desperately achieved seemingly nothing over <strong>far too many</strong> hours of troubleshooting and feeling out of reasonable options, I decided to bring up Activity Monitor and just randomly start killing processes. I was convinced something was running on my user account that wasn’t on a fresh one. After doing this for a while, I killed two AirPlay processes, one of which–the culprit–was ”AirPlay (DFRExtra)”.</p>

<video title="AirPlay (DFRExtra) in action" width="100%" preload="metadata" controls="">
	<source src="/assets/external/airplay-disaster.mp4" type="video/mp4"/>
</video>


<p>The network problems vanished in a matter of seconds, and Saagar informed me that DFR stands for “Device Function Row”, the Touch Bar. It hit me, I had placed an AirPlay button on my Touch Bar, and every time I signed in–safe mode or not–macOS launched this process and presumably started to actively and constantly look for displays on my network.</p>

<p><img src="https://mnpn.github.io/assets/airplay/tb-button.png" alt="Screenshot of the AirPlay button"/></p>

<p>The problems do still occur while sharing displays via AirPlay, though they don’t seem to be as bad, but that is more reasonable to me than a background task ruining your day.</p>

<h3 id="conclusion">Conclusion</h3>
<p>Placing an AirPlay button on your MacBook’s Touch Bar makes it presumably scan for available displays(?) in the background (constantly), and this network scanning completely and utterly destroys your Mac’s network performance. Killing the process “AirPlay (DFRExtra)” unclogs the pipe almost instantly.</p>

<p>I’ve filed a Feedback with Apple, FB10166122. Honestly though, it seems to me that it’s one of those problems that will probably be solved in due time when people upgrade their devices to new (non-Touch Bar) Apple Silicon machines. In the meantime, however, please don’t put this button on your Touch Bar unless the only thing you wish to (Air)Play with is your own sanity.</p>

<p><img src="https://mnpn.github.io/assets/airplay/tb-button-delete.png" alt="AirPlay button about to be removed from a Touch Bar"/></p>

<p>Thank you for coming to my TED talk,</p>



		</div></div>
  </body>
</html>
