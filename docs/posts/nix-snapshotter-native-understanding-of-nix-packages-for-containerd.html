<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/pdtpartners/nix-snapshotter">Original</a>
    <h1>Show HN: Nix Snapshotter â€“ Native understanding of Nix packages for containerd</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<h2 tabindex="-1" dir="auto"><a id="user-content-key-features" aria-hidden="true" tabindex="-1" href="#key-features"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Key features</h2>
<ul dir="auto">
<li>Rather than download image layers, packages come directly from the Nix store.</li>
<li>Packages can be fetched from a binary cache or built on the fly if necessary.</li>
<li>Backwards compatible with existing non-Nix images.</li>
<li>Nix layers can be interleaved with normal layers.</li>
<li>Allows Kubernetes to resolve image manifests from Nix too.</li>
<li>Enables fully-declarative Kubernetes resources, including image
specification.</li>
<li>Run pure Nix images without a Docker Registry at all, if you wish.</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-getting-started" aria-hidden="true" tabindex="-1" href="#getting-started"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Getting started</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/pdtpartners/nix-snapshotter/blob/main/docs/demo.gif"><img src="https://github.com/pdtpartners/nix-snapshotter/raw/main/docs/demo.gif" alt="Demo" data-animated-image=""/></a></p>
<p dir="auto">The easiest way to try this out is run a NixOS VM with everything
pre-configured.</p>
<div dir="auto"><p dir="auto"><span><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span></p><details>
<summary>Trying without Nix installed</summary>
<p dir="auto">If you have <a href="https://www.docker.com/" rel="nofollow">docker</a> or another OCI runtime installed, you can run
<code>docker run --rm -it nixpkgs/nix-flakes</code>:</p>
<pre lang="sh"><code>nix run github:pdtpartners/nix-snapshotter#vm
</code></pre>
</details></div>
<div dir="auto" data-snippet-clipboard-copy-content="nix run &#34;github:pdtpartners/nix-snapshotter#vm&#34;
nixos login: root # (Ctrl-a then x to quit)
Password: root

# Running `pkgs.hello` image with nix-snapshotter
nerdctl run ghcr.io/pdtpartners/hello

# Running `pkgs.redis` image with kubernetes &amp; nix-snapshotter
kubectl apply -f /etc/kubernetes/redis/

# Wait a few seconds... 
watch kubectl get pods

# And a kubernetes service will be ready to forward port 30000 to the redis
# pod, so you can test it out with a `ping` command
redis-cli -p 30000 ping"><pre>nix run <span><span>&#34;</span>github:pdtpartners/nix-snapshotter#vm<span>&#34;</span></span>
nixos login: root <span><span>#</span> (Ctrl-a then x to quit)</span>
Password: root

<span><span>#</span> Running `pkgs.hello` image with nix-snapshotter</span>
nerdctl run ghcr.io/pdtpartners/hello

<span><span>#</span> Running `pkgs.redis` image with kubernetes &amp; nix-snapshotter</span>
kubectl apply -f /etc/kubernetes/redis/

<span><span>#</span> Wait a few seconds... </span>
watch kubectl get pods

<span><span>#</span> And a kubernetes service will be ready to forward port 30000 to the redis</span>
<span><span>#</span> pod, so you can test it out with a `ping` command</span>
redis-cli -p 30000 ping</pre></div>
<p dir="auto">Or you can try running in rootless mode:</p>
<div dir="auto" data-snippet-clipboard-copy-content="nix run &#34;.#vm&#34;
nixos login: rootless # (Ctrl-a then x to quit)
Password: rootless

# Running pkgs.hello image with nix-snapshotter
nerdctl run ghcr.io/pdtpartners/hello

# Rootless kubernetes not supported yet.
# See: https://github.com/k3s-io/k3s/pull/8279"><pre>nix run <span><span>&#34;</span>.#vm<span>&#34;</span></span>
nixos login: rootless <span><span>#</span> (Ctrl-a then x to quit)</span>
Password: rootless

<span><span>#</span> Running pkgs.hello image with nix-snapshotter</span>
nerdctl run ghcr.io/pdtpartners/hello

<span><span>#</span> Rootless kubernetes not supported yet.</span>
<span><span>#</span> See: https://github.com/k3s-io/k3s/pull/8279</span></pre></div>
<h2 tabindex="-1" dir="auto"><a id="user-content-installation" aria-hidden="true" tabindex="-1" href="#installation"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Installation</h2>
<p dir="auto"><a href="https://zero-to-nix.com/concepts/nixos" rel="nofollow">NixOS</a> and <a href="https://github.com/nix-community/home-manager">Home Manager</a> modules are provided for
easy installation.</p>
<p dir="auto"><span><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span></p>
<ul dir="auto">
<li>
<p dir="auto"><strong>Home Manager</strong></p>
<details>
<summary>Flake</summary>
<div dir="auto" data-snippet-clipboard-copy-content="{
  inputs = {
    nixpkgs.url = &#34;github:NixOS/nixpkgs/nixos-unstable&#34;;
    home-manager = {
      url = &#34;github:nix-community/home-manager&#34;;
      inputs.nixpkgs.follows = &#34;nixpkgs&#34;;
    };
    nix-snapshotter = {
      url = &#34;github:pdtpartners/nix-snapshotter&#34;;
      inputs.nixpkgs.follows = &#34;nixpkgs&#34;;
    };
  };

  outputs = { nixpkgs, home-manager, nix-snapshotter, ... }: {
    homeConfigurations.myuser = home-manager.lib.homeManagerConfiguration {
      pkgs = import nixpkgs { system = &#34;x86_64-linux&#34;; };
      };
      modules = [
        {
          home = {
            username = &#34;myuser&#34;;
            homeDirectory = &#34;/home/myuser&#34;;
            stateVersion = &#34;23.11&#34;;
          };

          programs.home-manager.enable = true;

          # Let home-manager automatically start systemd user services.
          # Will eventually become the new default.
          systemd.user.startServices = &#34;sd-switch&#34;;
        }
        ({ pkgs, ... }: {
          # (1) Import home-manager module.
          imports = [ nix-snapshotter-rootless ];

          # (2) Add overlay.
          nixpkgs.overlays = [ nix-snapshotter.overlays.default ];

          # (3) Enable service.
          services.nix-snapshotter.rootless = {
            enable = true;
            setContainerdSnapshotter = true;
          };

          # (4) Add a containerd CLI like nerdctl.
          home.packages = [ pkgs.nerdctl ];
        })
      ];
    };
  };
}"><pre><span>{</span>
  <span><span>inputs</span></span> <span>=</span> <span>{</span>
    <span><span>nixpkgs</span><span>.</span><span>url</span></span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixos-unstable&#34;</span><span>;</span>
    <span><span>home-manager</span></span> <span>=</span> <span>{</span>
      <span><span>url</span></span> <span>=</span> <span>&#34;github:nix-community/home-manager&#34;</span><span>;</span>
      <span><span>inputs</span><span>.</span><span>nixpkgs</span><span>.</span><span>follows</span></span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span>
    <span>}</span><span>;</span>
    <span><span>nix-snapshotter</span></span> <span>=</span> <span>{</span>
      <span><span>url</span></span> <span>=</span> <span>&#34;github:pdtpartners/nix-snapshotter&#34;</span><span>;</span>
      <span><span>inputs</span><span>.</span><span>nixpkgs</span><span>.</span><span>follows</span></span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span>
    <span>}</span><span>;</span>
  <span>}</span><span>;</span>

  <span><span>outputs</span></span> <span>=</span> <span>{</span> <span>nixpkgs</span><span>,</span> <span>home-manager</span><span>,</span> <span>nix-snapshotter</span><span>,</span> ... <span>}</span>: <span>{</span>
    <span><span>homeConfigurations</span><span>.</span><span>myuser</span></span> <span>=</span> <span>home-manager</span><span>.</span><span><span>lib</span><span>.</span><span>homeManagerConfiguration</span></span> <span>{</span>
      <span><span>pkgs</span></span> <span>=</span> <span><span>import</span></span> <span>nixpkgs</span> <span>{</span> <span><span>system</span></span> <span>=</span> <span>&#34;x86_64-linux&#34;</span><span>;</span> <span>}</span><span>;</span>
      <span>}</span><span>;</span>
      <span><span>modules</span></span> <span>=</span> <span>[</span>
        <span>{</span>
          <span><span>home</span></span> <span>=</span> <span>{</span>
            <span><span>username</span></span> <span>=</span> <span>&#34;myuser&#34;</span><span>;</span>
            <span><span>homeDirectory</span></span> <span>=</span> <span>&#34;/home/myuser&#34;</span><span>;</span>
            <span><span>stateVersion</span></span> <span>=</span> <span>&#34;23.11&#34;</span><span>;</span>
          <span>}</span><span>;</span>

          <span><span>programs</span><span>.</span><span>home-manager</span><span>.</span><span>enable</span></span> <span>=</span> <span>true</span><span>;</span>

          <span># Let home-manager automatically start systemd user services.</span>
          <span># Will eventually become the new default.</span>
          <span><span>systemd</span><span>.</span><span>user</span><span>.</span><span>startServices</span></span> <span>=</span> <span>&#34;sd-switch&#34;</span><span>;</span>
        <span>}</span>
        <span>(</span><span>{</span> <span>pkgs</span><span>,</span> ... <span>}</span>: <span>{</span>
          <span># (1) Import home-manager module.</span>
          <span><span>imports</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter-rootless</span> <span>]</span><span>;</span>

          <span># (2) Add overlay.</span>
          <span><span>nixpkgs</span><span>.</span><span>overlays</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter</span><span>.</span><span><span>overlays</span><span>.</span><span>default</span></span> <span>]</span><span>;</span>

          <span># (3) Enable service.</span>
          <span><span>services</span><span>.</span><span>nix-snapshotter</span><span>.</span><span>rootless</span></span> <span>=</span> <span>{</span>
            <span><span>enable</span></span> <span>=</span> <span>true</span><span>;</span>
            <span><span>setContainerdSnapshotter</span></span> <span>=</span> <span>true</span><span>;</span>
          <span>}</span><span>;</span>

          <span># (4) Add a containerd CLI like nerdctl.</span>
          <span><span>home</span><span>.</span><span>packages</span></span> <span>=</span> <span>[</span> <span>pkgs</span><span>.</span><span><span>nerdctl</span></span> <span>]</span><span>;</span>
        <span>}</span><span>)</span>
      <span>]</span><span>;</span>
    <span>}</span><span>;</span>
  <span>}</span><span>;</span>
<span>}</span></pre></div>
</details>
<details>
<summary>Non-flake</summary>
<div dir="auto" data-snippet-clipboard-copy-content="{ pkgs, ... }:
let
  nix-snapshotter = import (
    builtins.fetchTarball &#34;https://github.com/pdtpartners/nix-snapshotter/archive/main.tar.gz&#34;
  );

in {
  imports = [
    ./hardware-configuration.nix
    # (1) Import home-manager module.
    nix-snapshotter.nixosModules.default
  ];

  # (2) Add overlay.
  nixpkgs.overlays = [ nix-snapshotter.overlays.default ];

  # (3) Enable service.
  services.nix-snapshotter = {
    enable = true;
    setContainerdSnapshotter = true;
  };

  # (4) Add a containerd CLI like nerdctl.
  environment.systemPackages = [ pkgs.nerdctl ];
}"><pre><span>{</span> <span>pkgs</span><span>,</span> ... <span>}</span>:
<span>let</span>
  <span><span>nix-snapshotter</span></span> <span>=</span> <span><span>import</span></span> <span>(</span>
    <span>builtins</span><span>.</span><span><span><span>fetchTarball</span></span></span> <span>&#34;https://github.com/pdtpartners/nix-snapshotter/archive/main.tar.gz&#34;</span>
  <span>)</span><span>;</span>

<span>in</span> <span>{</span>
  <span><span>imports</span></span> <span>=</span> <span>[</span>
    <span>./hardware-configuration.nix</span>
    <span># (1) Import home-manager module.</span>
    <span>nix-snapshotter</span><span>.</span><span><span>nixosModules</span><span>.</span><span>default</span></span>
  <span>]</span><span>;</span>

  <span># (2) Add overlay.</span>
  <span><span>nixpkgs</span><span>.</span><span>overlays</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter</span><span>.</span><span><span>overlays</span><span>.</span><span>default</span></span> <span>]</span><span>;</span>

  <span># (3) Enable service.</span>
  <span><span>services</span><span>.</span><span>nix-snapshotter</span></span> <span>=</span> <span>{</span>
    <span><span>enable</span></span> <span>=</span> <span>true</span><span>;</span>
    <span><span>setContainerdSnapshotter</span></span> <span>=</span> <span>true</span><span>;</span>
  <span>}</span><span>;</span>

  <span># (4) Add a containerd CLI like nerdctl.</span>
  <span><span>environment</span><span>.</span><span>systemPackages</span></span> <span>=</span> <span>[</span> <span>pkgs</span><span>.</span><span><span>nerdctl</span></span> <span>]</span><span>;</span>
<span>}</span></pre></div>
</details>
</li>
<li>
<p dir="auto"><strong>NixOS</strong></p>
<details>
<summary>Flake</summary>
<div dir="auto" data-snippet-clipboard-copy-content="{
  inputs = {
    nixpkgs.url = &#34;github:NixOS/nixpkgs/nixos-unstable&#34;;
    nix-snapshotter = {
      url = &#34;github:pdtpartners/nix-snapshotter&#34;;
      inputs.nixpkgs.follows = &#34;nixpkgs&#34;;
    };
  };

  outputs = { nixpkgs, nix-snapshotter, ... }: {
    nixosConfigurations.myhost = nixpkgs.lib.nixosSystem {
      system = &#34;x86_64-linux&#34;;
      modules = [
        ./hardware-configuration.nix
        ({ pkgs, ... }: {
          # (1) Import nixos module.
          imports = [ nix-snapshotter.nixosModules.default ];

          # (2) Add overlay.
          nixpkgs.overlays = [ nix-snapshotter.overlays.default ];

          # (3) Enable service.
          services.nix-snapshotter = {
            enable = true;
            setContainerdSnapshotter = true;
          };

          # (4) Add a containerd CLI like nerdctl.
          environment.systemPackages = [ pkgs.nerdctl ];
        })
      ];
    };
  };
}"><pre><span>{</span>
  <span><span>inputs</span></span> <span>=</span> <span>{</span>
    <span><span>nixpkgs</span><span>.</span><span>url</span></span> <span>=</span> <span>&#34;github:NixOS/nixpkgs/nixos-unstable&#34;</span><span>;</span>
    <span><span>nix-snapshotter</span></span> <span>=</span> <span>{</span>
      <span><span>url</span></span> <span>=</span> <span>&#34;github:pdtpartners/nix-snapshotter&#34;</span><span>;</span>
      <span><span>inputs</span><span>.</span><span>nixpkgs</span><span>.</span><span>follows</span></span> <span>=</span> <span>&#34;nixpkgs&#34;</span><span>;</span>
    <span>}</span><span>;</span>
  <span>}</span><span>;</span>

  <span><span>outputs</span></span> <span>=</span> <span>{</span> <span>nixpkgs</span><span>,</span> <span>nix-snapshotter</span><span>,</span> ... <span>}</span>: <span>{</span>
    <span><span>nixosConfigurations</span><span>.</span><span>myhost</span></span> <span>=</span> <span>nixpkgs</span><span>.</span><span><span>lib</span><span>.</span><span>nixosSystem</span></span> <span>{</span>
      <span><span>system</span></span> <span>=</span> <span>&#34;x86_64-linux&#34;</span><span>;</span>
      <span><span>modules</span></span> <span>=</span> <span>[</span>
        <span>./hardware-configuration.nix</span>
        <span>(</span><span>{</span> <span>pkgs</span><span>,</span> ... <span>}</span>: <span>{</span>
          <span># (1) Import nixos module.</span>
          <span><span>imports</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter</span><span>.</span><span><span>nixosModules</span><span>.</span><span>default</span></span> <span>]</span><span>;</span>

          <span># (2) Add overlay.</span>
          <span><span>nixpkgs</span><span>.</span><span>overlays</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter</span><span>.</span><span><span>overlays</span><span>.</span><span>default</span></span> <span>]</span><span>;</span>

          <span># (3) Enable service.</span>
          <span><span>services</span><span>.</span><span>nix-snapshotter</span></span> <span>=</span> <span>{</span>
            <span><span>enable</span></span> <span>=</span> <span>true</span><span>;</span>
            <span><span>setContainerdSnapshotter</span></span> <span>=</span> <span>true</span><span>;</span>
          <span>}</span><span>;</span>

          <span># (4) Add a containerd CLI like nerdctl.</span>
          <span><span>environment</span><span>.</span><span>systemPackages</span></span> <span>=</span> <span>[</span> <span>pkgs</span><span>.</span><span><span>nerdctl</span></span> <span>]</span><span>;</span>
        <span>}</span><span>)</span>
      <span>]</span><span>;</span>
    <span>}</span><span>;</span>
  <span>}</span><span>;</span>
<span>}</span></pre></div>
</details>
<details>
<summary>Non-flake</summary>
<div dir="auto" data-snippet-clipboard-copy-content="{ pkgs, ... }:
let
  nix-snapshotter = import (
    builtins.fetchTarball &#34;https://github.com/pdtpartners/nix-snapshotter/archive/main.tar.gz&#34;
  );

in {
  imports = [
    ./hardware-configuration.nix
    # (1) Import home-manager module.
    nix-snapshotter.nixosModules.default
  ];

  # (2) Add overlay.
  nixpkgs.overlays = [ nix-snapshotter.overlays.default ];

  # (3) Enable service.
  services.nix-snapshotter = {
    enable = true;
    setContainerdSnapshotter = true;
  };

  # (4) Add a containerd CLI like nerdctl.
  environment.systemPackages = [ pkgs.nerdctl ];
}"><pre><span>{</span> <span>pkgs</span><span>,</span> ... <span>}</span>:
<span>let</span>
  <span><span>nix-snapshotter</span></span> <span>=</span> <span><span>import</span></span> <span>(</span>
    <span>builtins</span><span>.</span><span><span><span>fetchTarball</span></span></span> <span>&#34;https://github.com/pdtpartners/nix-snapshotter/archive/main.tar.gz&#34;</span>
  <span>)</span><span>;</span>

<span>in</span> <span>{</span>
  <span><span>imports</span></span> <span>=</span> <span>[</span>
    <span>./hardware-configuration.nix</span>
    <span># (1) Import home-manager module.</span>
    <span>nix-snapshotter</span><span>.</span><span><span>nixosModules</span><span>.</span><span>default</span></span>
  <span>]</span><span>;</span>

  <span># (2) Add overlay.</span>
  <span><span>nixpkgs</span><span>.</span><span>overlays</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter</span><span>.</span><span><span>overlays</span><span>.</span><span>default</span></span> <span>]</span><span>;</span>

  <span># (3) Enable service.</span>
  <span><span>services</span><span>.</span><span>nix-snapshotter</span></span> <span>=</span> <span>{</span>
    <span><span>enable</span></span> <span>=</span> <span>true</span><span>;</span>
    <span><span>setContainerdSnapshotter</span></span> <span>=</span> <span>true</span><span>;</span>
  <span>}</span><span>;</span>

  <span># (4) Add a containerd CLI like nerdctl.</span>
  <span><span>environment</span><span>.</span><span>systemPackages</span></span> <span>=</span> <span>[</span> <span>pkgs</span><span>.</span><span><span>nerdctl</span></span> <span>]</span><span>;</span>
<span>}</span></pre></div>
</details>
</li>
<li>
<p dir="auto"><strong>Manual</strong></p>
<p dir="auto">See the <a href="https://github.com/pdtpartners/nix-snapshotter/blob/main/docs/manual-install.md">manual installation docs</a>.</p>
</li>
</ul>
<h2 tabindex="-1" dir="auto"><a id="user-content-usage" aria-hidden="true" tabindex="-1" href="#usage"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Usage</h2>
<p dir="auto">See <a href="https://github.com/pdtpartners/nix-snapshotter/blob/main/package.nix">package.nix</a> for the Nix interface. You can also repeat the
asciinema demo above in
<a href="https://github.com/pdtpartners/nix-snapshotter/blob/main/examples/declarative-k8s.nix">examples/declarative-k8s.nix</a>.</p>
<div dir="auto" data-snippet-clipboard-copy-content="pkgs = import nixpkgs {
  overlays = [ nix-snapshotter.overlays.default ];
};

# Builds a native Nix image but intended for an OCI-compliant registry.
redis = pkgs.nix-snapshotter.buildImage {
  name = &#34;ghcr.io/pdtpartners/redis&#34;;
  tag = &#34;latest&#34;;
  config.entrypoint = [ &#34;${pkgs.redis}/bin/redis-server&#34; ];
};

# Running &#34;${redis.copyToRegistry {}}/bin/copy-to-registry&#34; will copy it to
# an OCI-compliant Registry. It will try to use your Docker credentials to push
# if the target is DockerHub.

# Builds a native Nix image with a special image reference. When running
# the kubelet with `--image-service-endpoint` pointing to nix-snapshotter, then
# it can resolve the image reference to this Nix package.
redis&#39; = pkgs.nix-snapshotter.buildImage {
  name = &#34;redis&#34;;
  resolvedByNix = true;
  config.entrypoint = [ &#34;${pkgs.redis}/bin/redis-server&#34; ];
};

# Fully declarative Kubernetes Pod, down to the image specification and its
# contents.
redisPod = pkgs.writeText &#34;redis-pod.json&#34; (builtins.toJSON {
  apiVersion = &#34;v1&#34;;
  kind = &#34;Pod&#34;;
  metadata = {
    name = &#34;redis&#34;;
    labels.name = &#34;redis&#34;;
  };
  spec.containers = [{
    name = &#34;redis&#34;;
    args = [ &#34;--protected-mode&#34; &#34;no&#34; ];
    image = &#34;nix:0${redis&#39;}&#34;;
    ports = [{
      name = &#34;client&#34;;
      containerPort = 6379;
    }];
  }];
});"><pre><span><span>pkgs</span></span> <span>=</span> <span>import</span> <span>nixpkgs</span> <span>{</span>
  <span><span>overlays</span></span> <span>=</span> <span>[</span> <span>nix-snapshotter</span><span>.</span><span><span>overlays</span><span>.</span><span>default</span></span> <span>]</span><span>;</span>
<span>}</span><span>;</span>

<span># Builds a native Nix image but intended for an OCI-compliant registry.</span>
<span>redis</span> <span>=</span> <span>pkgs</span><span>.</span><span><span>nix-snapshotter</span><span>.</span><span>buildImage</span></span> <span>{</span>
  <span><span>name</span></span> <span>=</span> <span>&#34;ghcr.io/pdtpartners/redis&#34;</span><span>;</span>
  <span><span>tag</span></span> <span>=</span> <span>&#34;latest&#34;</span><span>;</span>
  <span><span>config</span><span>.</span><span>entrypoint</span></span> <span>=</span> <span>[</span> <span>&#34;<span><span>${</span><span>pkgs</span><span>.</span><span><span>redis</span></span><span>}</span></span>/bin/redis-server&#34;</span> <span>]</span><span>;</span>
<span>}</span><span>;</span>

<span># Running &#34;${redis.copyToRegistry {}}/bin/copy-to-registry&#34; will copy it to</span>
<span># an OCI-compliant Registry. It will try to use your Docker credentials to push</span>
<span># if the target is DockerHub.</span>

<span># Builds a native Nix image with a special image reference. When running</span>
<span># the kubelet with `--image-service-endpoint` pointing to nix-snapshotter, then</span>
<span># it can resolve the image reference to this Nix package.</span>
<span>redis&#39;</span> <span>=</span> <span>pkgs</span><span>.</span><span><span>nix-snapshotter</span><span>.</span><span>buildImage</span></span> <span>{</span>
  <span><span>name</span></span> <span>=</span> <span>&#34;redis&#34;</span><span>;</span>
  <span><span>resolvedByNix</span></span> <span>=</span> <span>true</span><span>;</span>
  <span><span>config</span><span>.</span><span>entrypoint</span></span> <span>=</span> <span>[</span> <span>&#34;<span><span>${</span><span>pkgs</span><span>.</span><span><span>redis</span></span><span>}</span></span>/bin/redis-server&#34;</span> <span>]</span><span>;</span>
<span>}</span><span>;</span>

<span># Fully declarative Kubernetes Pod, down to the image specification and its</span>
<span># contents.</span>
<span>redisPod</span> <span>=</span> <span>pkgs</span><span>.</span><span><span>writeText</span></span> <span>&#34;redis-pod.json&#34;</span> <span>(</span><span>builtins</span><span>.</span><span><span>toJSON</span></span> <span>{</span>
  <span><span>apiVersion</span></span> <span>=</span> <span>&#34;v1&#34;</span><span>;</span>
  <span><span>kind</span></span> <span>=</span> <span>&#34;Pod&#34;</span><span>;</span>
  <span><span>metadata</span></span> <span>=</span> <span>{</span>
    <span><span>name</span></span> <span>=</span> <span>&#34;redis&#34;</span><span>;</span>
    <span><span>labels</span><span>.</span><span>name</span></span> <span>=</span> <span>&#34;redis&#34;</span><span>;</span>
  <span>}</span><span>;</span>
  <span><span>spec</span><span>.</span><span>containers</span></span> <span>=</span> <span>[</span><span>{</span>
    <span><span>name</span></span> <span>=</span> <span>&#34;redis&#34;</span><span>;</span>
    <span><span>args</span></span> <span>=</span> <span>[</span> <span>&#34;--protected-mode&#34;</span> <span>&#34;no&#34;</span> <span>]</span><span>;</span>
    <span><span>image</span></span> <span>=</span> <span>&#34;nix:0<span><span>${</span><span>redis&#39;</span><span>}</span></span>&#34;</span><span>;</span>
    <span><span>ports</span></span> <span>=</span> <span>[</span><span>{</span>
      <span><span>name</span></span> <span>=</span> <span>&#34;client&#34;</span><span>;</span>
      <span><span>containerPort</span></span> <span>=</span> <span>6379</span><span>;</span>
    <span>}</span><span>]</span><span>;</span>
  <span>}</span><span>]</span><span>;</span>
<span>}</span><span>)</span><span>;</span></pre></div>
<p dir="auto"><span><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</span></p>
<h2 tabindex="-1" dir="auto"><a id="user-content-contributing" aria-hidden="true" tabindex="-1" href="#contributing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Contributing</h2>
<p dir="auto">Pull requests are welcome for any changes. Consider opening an issue to discuss
larger changes first to get feedback on the idea.</p>
<p dir="auto">Please read <a href="https://github.com/pdtpartners/nix-snapshotter/blob/main/CONTRIBUTING.md">CONTRIBUTING</a> for development tips and
more details on contributing guidelines.</p>
<h2 tabindex="-1" dir="auto"><a id="user-content-faq" aria-hidden="true" tabindex="-1" href="#faq"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>FAQ</h2>
<p dir="auto"><span><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</span></p>
<ol dir="auto">
<li>What&#39;s the difference between this and <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-pkgs-dockerTools-buildImage" rel="nofollow">pkgs.dockerTools.buildImage</a>?</li>
</ol>
<details>
<summary>Answer</summary>
<p dir="auto">The upstream <code>buildImage</code> streams Nix packages into tarballs, compresses them
and pushes them to an OCI registry. Since there is a limit to number of layers
in an image, a heuristic is used to put popular packages together. There is
large amount of duplication between your Nix binary cache and the Docker
Registry tarballs, and even between images that share packages as the layers may
duplicate common packages due to the heuristic-based layering strategy.</p>
<p dir="auto">With <code>pkgs.nix-snapshotter.buildImage</code>, containerd natively understand Nix
packages, so everything is pulled at package granularity without the layer
limit. This means all the container content is either already in your host nix
store or fetched from your Nix binary cache.</p>
</details>
<ol start="2" dir="auto">
<li>What&#39;s the difference between this and <a href="https://nixery.dev/" rel="nofollow">Nixery</a>?</li>
</ol>
<details>
<summary>Answer</summary>
<p dir="auto">Nixery exposes an API (in the form of an OCI registry) to dynamically build
Nix-based images, but still uses the same layering strategy as upstream&#39;s
<code>pkgs.dockerTools.buildImage</code> (see above). So Nixery suffers from the same
inefficiency in duplication. However, Nixery can totally start building
nix-snapshotter images so we can have a Docker Registry that can dynamically
build native Nix images.</p>
</details>
<ol start="3" dir="auto">
<li>What&#39;s the difference between this and a nix-in-docker?</li>
</ol>
<details>
<summary>Answer</summary>
<p dir="auto">If you run nix inside a container (e.g. <code>nixos/nix</code> or <code>nixpkgs/nix-flake</code>)
then you are indeed fetching packages using the Nix store. However, each
container will have its own Nix store instead of de-duplicating at the host
level.</p>
<p dir="auto">nix-snapshotter is intended to live on the host system (sibling to containerd
and/or kubelet) so that multiple containers running different images can share
the underlying packages from the same Nix store.</p>
</details>
<ol start="4" dir="auto">
<li>What&#39;s the difference between this and <a href="https://github.com/nlewo/nix2container">nix2container</a>?</li>
</ol>
<details>
<summary>Answer</summary>
<p dir="auto">nix2container improves upon <code>pkgs.dockerTools.buildImage</code> in a few ways. First
it does something similar to <code>pkgs.dockerTools.streamLayeredImage</code> where it
avoids writing Nix layer tarballs to Nix store and builds them JIT when
exporting, like with it&#39;s passthru attribute <code>copyToRegistry</code>. This avoids
writing Nix layer tarballs into the Nix store unnecessarily.</p>
<p dir="auto">Secondly, it separates out image metadata and layer metadata. This means that
when updating the image config, layers don&#39;t need to be rebuilt. Thirdly, each
layer metadata is in its own Nix package, so only updated layers need to be
rebuilt.</p>
<p dir="auto">Lastly, the layer metadata is a JSON that contains the Nix store paths along
with the digest which is computed from the layer tarball which is thrown away.
This lets the tool <code>skopeo</code> to only copy non-existing layers, which then builds
the requested layer tarballs again JIT.</p>
<p dir="auto">nix2container is a great improvement, but still suffers same problems pointed
out in the <code>pkgs.dockerTools.buildImage</code> section. It duplicates data between
Nix binary cache and Docker Registry, and it duplicates packages between layers
due to using a similar heuristic-based strategy.</p>
<p dir="auto"><code>pkgs.nix-snapshotter.buildImage</code> has all the same improvements, except that
we do write the final image back to the Nix store since it&#39;s tiny and allows us
to resolve image manifests via a Nix package.</p>
</details>
<h2 tabindex="-1" dir="auto"><a id="user-content-license" aria-hidden="true" tabindex="-1" href="#license"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>License</h2>
<p dir="auto">The source code developed for nix-snapshotter is licensed under MIT License.</p>
<p dir="auto">This project also contains modified portions of other projects that are
licensed under the terms of Apache License 2.0. See <a href="https://github.com/pdtpartners/nix-snapshotter/blob/main/NOTICE">NOTICE</a> for more
details.</p>
</article>
          </div></div>
  </body>
</html>
