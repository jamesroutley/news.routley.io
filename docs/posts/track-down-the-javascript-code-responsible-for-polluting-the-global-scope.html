<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mmazzarolo.com/blog/2022-02-16-track-down-the-javascript-code-responsible-for-polluting-the-global-scope/">Original</a>
    <h1>Track down the JavaScript code responsible for polluting the global scope</h1>
    
    <div id="readability-page-1" class="page"><article><header><h3>Feb 16, 2022</h3></header><section><p>Following <a href="https://mmazzarolo.com/blog/2022-02-14-find-what-javascript-variables-are-leaking-into-the-global-scope/" target="_blank" rel="nofollow noopener noreferrer">‚ÄúFind what JavaScript variables are leaking into the global scope‚Äù</a>, here‚Äôs another post to help you solve issues with global scope pollution in JavaScript apps.</p>
<p>In the previous post, we learned a technique to discover the name of variables being added to the global scope by JavaScript code. Just knowing the global variable names is usually enough to determine 1) if it‚Äôs ok or not for the variable to live in the global scope and, if it‚Äôs not, 2) what line of JavaScript code is adding it to the global scope.</p>
<p>Still, sometimes tracking down the JavaScript code responsible for creating a global variable is not that straightforward ‚Äî for example, when the global variable name is extremely generic (e.g., <code>item</code>, <code>x</code>, etc.) or when the code that creates the global is deep into the dependency tree of your JavaScript app.</p>
<p>So, here‚Äôs how to build (from scratch) a JavaScript utility that can help us debugging <strong>where</strong> the global definitions are happening within out code.</p>
<blockquote>
<p><a href="https://github.com/brankosekulic/trimHtml/pull/12" target="_blank" rel="nofollow noopener noreferrer">Here‚Äôs a real-world example</a> where this utility has helped me track-down a global variable leak coming from third-party JavaScript code.</p>
</blockquote>
<h2>Global pollution example</h2>
<p>As an example, let‚Äôs focus again on the HTML document I shared in the previous post:</p>
<div data-language="html"><pre><code><span><span><span>&lt;</span>html</span><span>&gt;</span></span>
  <span><span><span>&lt;</span>body</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>h1</span><span>&gt;</span></span>Hello world!<span><span><span>&lt;/</span>h1</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>&#34;</span>https://unpkg.com/jquery@3.6.0/dist/jquery.js<span>&#34;</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
    <span><span><span>&lt;</span>script</span><span>&gt;</span></span><span><span>
      <span>function</span> <span>doSomethingTwice</span><span>(</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span>i <span>=</span> <span>0</span><span>;</span> i <span>&lt;=</span> <span>2</span><span>;</span> i<span>++</span><span>)</span> <span>{</span>
          <span>const</span> myString <span>=</span> <span><span>`</span><span>hello-world-</span><span><span>${</span>i<span>}</span></span><span>`</span></span><span>;</span>
          
        <span>}</span>
      <span>}</span>
      <span>doSomethingTwice</span><span>(</span><span>)</span><span>;</span>
    </span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
  <span><span><span>&lt;/</span>body</span><span>&gt;</span></span>
<span><span><span>&lt;/</span>html</span><span>&gt;</span></span></code></pre></div>
<p>The two scripts on the page (<code>jquery.js</code> and the inline one) add four different global variables: <code>$</code> and <code>jQuery</code> from <code>jquery.js</code>, and <code>doSomethingTwice</code> and <code>i</code> from the inline script.
Because of how popular jQuery is, the <code>$</code> and <code>jQuery</code> global names are pretty easy to associate with the library that creates them (and understand that they‚Äôre not global leaks).</p>
<ul>
<li><code>doSomethingTwice</code> is added to the global scope because it‚Äôs defined at the root scope (a cleaner approach would be to wrap it in a closure/IIFE). Finding the code responsible for creating this global shouldn‚Äôt be difficult with a search &amp; replace in the codebase because <code>doSomethingTwice</code> is quite a unique name. But what if the global name was more generic (e.g., <code>run</code>), or if the code was uglified/minified or if it comes from a dependency? That would make it way more difficult to track its declaration down just based on its name.</li>
<li><code>i</code> is (mistakenly) added to the global scope because we‚Äôre declaring it with no <code>var</code>/<code>let</code>/<code>const</code> while not being in <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode" target="_blank" rel="nofollow noopener noreferrer">strict mode</a>. In this small example, it‚Äôs rather obvious what line of code declares it. But good luck tracking it down with a search &amp; replace in a bigger app üòÖ.</li>
</ul>
<p>So, let‚Äôs see how we can make it easy to track down the line of codes responsible for setting global variables in our codebase.</p>
<h2>Step 1: inspecting the call stack</h2>
<p>Here‚Äôs a high-level overview of what we can do to help us track down these pesky global variables:</p>
<ol>
<li>Take note of the exact global variable name I want to track down (following <a href="https://mmazzarolo.com/blog/2022-02-14-find-what-javascript-variables-are-leaking-into-the-global-scope/" target="_blank" rel="nofollow noopener noreferrer">‚ÄúFind what JavaScript variables are leaking into the global scope‚Äù</a>).</li>
<li>Proxy the <code>set</code> instruction of such variable on the <code>window</code> object to trigger some custom code when the variable is set. The goal of this code is to point out ‚Äúwhat‚Äù is setting the global variable.</li>
</ol>
<p>I‚Äôve already covered the first step in the past, so let‚Äôs focus on the second one: proxying the <code>window</code> (or <code>globalThis</code>) object.</p>
<p>The idea here is that whenever an assignment like <code>window.i = 1</code> happens, we want to run some code that tells us the context of where that assignment happened. To be useful, this context should provide us some information about the code that is running it (e.g., tell us the line of code or file where the declaration happened).</p>
<ul>
<li>When the global declaration happens, halt the code execution with a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/debugger" target="_blank" rel="nofollow noopener noreferrer"><code>debugger;</code></a> statement to inspect the context ‚Äî this is exactly like adding a breakpoint in the script source, and it‚Äôs helpful for debugging the scope and closures.</li>
<li>When the global declaration happens, print the stack trace using <a href="https://developer.mozilla.org/en-US/docs/Web/API/console/trace" target="_blank" rel="nofollow noopener noreferrer"><code>console.trace()</code></a>. This is helpful to inspect the stack trace‚Äôs code even while the execution is running.</li>
</ul>
<p>We‚Äôll implement both solutions using an <code>onGlobalDeclaration</code> function:</p>
<div data-language="javascript"><pre><code><span>function</span> <span>onGlobalDeclaration</span><span>(</span><span>globalName</span><span>)</span> <span>{</span>
  
  console<span>.</span><span>trace</span><span>(</span><span>)</span><span>;</span>
  
  <span>debugger</span><span>;</span>
<span>}</span>

</code></pre></div>
<h2>Step 2: proxying <code>window</code> attributes</h2>
<p>Now that we can get some contextual information about the stack, how can we attach invoke <code>onGlobalDeclaration</code> when the global variable is set?</p>
<p>In the past, I tried a few different options, but to me the one that works better is to instantiate the global variable ourselves as a proxy <strong>before</strong> it gets set by the rest of our codebase.
Basically, <strong>before</strong> a <code>window.i = 1</code> statement runs, we want to instantiate <code>window.i</code> ourselves and override its setter function so that, whenever it‚Äôs invoked, we also invoke <code>onGlobalDeclaration</code>:</p>
<div data-language="js"><pre><code><span>function</span> <span>addGlobalToInspect</span><span>(</span><span>globalName</span><span>)</span> <span>{</span>
  <span>function</span> <span>onGlobalDeclaration</span><span>(</span><span>globalName</span><span>)</span> <span>{</span>
    
    console<span>.</span><span>trace</span><span>(</span><span>)</span><span>;</span>
    
    <span>debugger</span><span>;</span>
  <span>}</span>

  
  Object<span>.</span><span>defineProperty</span><span>(</span>window<span>,</span> globalName<span>,</span> <span>{</span>
    <span>set</span><span>:</span> <span>function</span> <span>(</span><span>value</span><span>)</span> <span>{</span>
      
      <span>onGlobalDeclaration</span><span>(</span>globalName<span>)</span><span>;</span>
      window<span>[</span><span><span>`</span><span>__globals-debugger-proxy-for-</span><span><span>${</span>globalName<span>}</span></span><span>__</span><span>`</span></span><span>]</span> <span>=</span> value<span>;</span>
    <span>}</span><span>,</span>
    <span>get</span><span>:</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>
      
      <span>return</span> window<span>[</span><span><span>`</span><span>__globals-debugger-proxy-for-</span><span><span>${</span>globalName<span>}</span></span><span>__</span><span>`</span></span><span>]</span><span>;</span>
    <span>}</span><span>,</span>
    configurable<span>:</span> <span>true</span><span>,</span>
  <span>}</span><span>)</span><span>;</span>
<span>}</span>


<span>addGlobalToInspect</span><span>(</span><span>&#34;i&#34;</span><span>)</span><span>;</span></code></pre></div>
<blockquote>
<p><strong>Note on ES6 proxies</strong>: ES6 introduced the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="nofollow noopener noreferrer"><code>Proxy</code></a> object to cover similar use-cases. If you‚Äôre not familiar with it, the <code>Proxy</code> object allows you to create an object that can be used in place of the original object, but which may redefine fundamental Object operations like getting, setting, and defining properties.</p>
</blockquote>
<p>Nice! Now our code is (kinda) ready to intercept globals declaration.
The next step is to ensure we run <code>addGlobalToInspect</code> <strong>before</strong> the global declarations statement.</p>
<h2>Step 3: integrating the global inspector</h2>
<p>We still need to do two things to finalize our debugging flow.</p>
<p>First of all, we must make sure to run <code>addGlobalToInspect</code> <strong>before</strong> setting the global we want to inspect. It‚Äôs up to you to decide how and when to do so, but my suggestion is to put the global inspector code in its own .js file (e.g., <code>globals-debugger.js</code>) and make sure to load it before all other scripts:</p>
<div data-language="diff"><pre><code><span><span> </span><span><span><span>&lt;</span>html</span><span>&gt;</span></span>
<span> </span>  <span><span><span>&lt;</span>body</span><span>&gt;</span></span>
<span> </span>    <span><span><span>&lt;</span>h1</span><span>&gt;</span></span>Hello world!<span><span><span>&lt;/</span>h1</span><span>&gt;</span></span>
</span><span><span>+</span>    
<span>+</span>    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>&#34;</span>./globals-debugger.js<span>&#34;</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
</span><span><span> </span>    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>&#34;</span>https://unpkg.com/jquery@3.6.0/dist/jquery.js<span>&#34;</span></span><span>&gt;</span></span><span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
<span> </span>    <span><span><span>&lt;</span>script</span><span>&gt;</span></span><span><span>
<span> </span>      <span>function</span> <span>doSomethingTwice</span><span>(</span><span>)</span> <span>{</span>
<span> </span>        <span>for</span> <span>(</span>i <span>=</span> <span>0</span><span>;</span> i <span>&lt;=</span> <span>2</span><span>;</span> i<span>++</span><span>)</span> <span>{</span>
<span> </span>          <span>const</span> myString <span>=</span> <span><span>`</span><span>hello-world-</span><span><span>${</span>i<span>}</span></span><span>`</span></span><span>;</span>
<span> </span>          
<span> </span>        <span>}</span>
<span> </span>      <span>}</span>
<span> </span>      <span>doSomethingTwice</span><span>(</span><span>)</span><span>;</span>
<span> </span>    </span></span><span><span><span>&lt;/</span>script</span><span>&gt;</span></span>
<span> </span>  <span><span><span>&lt;/</span>body</span><span>&gt;</span></span>
<span> </span><span><span><span>&lt;/</span>html</span><span>&gt;</span></span></span></code></pre></div>
<p>Then, it would be nice to pick the globals to inspect dynamically instead of hardcoding them in the code like we‚Äôre doing now (as we‚Äôre doing with <code>addGlobalToInspect(&#34;i&#34;)</code>).</p>
<div data-language="js"><pre><code>
<span>const</span> parsedUrl <span>=</span> <span>new</span> <span>URL</span><span>(</span>window<span>.</span>location<span>.</span>href<span>)</span><span>;</span>
<span>(</span>parsedUrl<span>.</span>searchParams<span>.</span><span>get</span><span>(</span><span>&#34;globalsToInspect&#34;</span><span>)</span> <span>||</span> <span>&#34;&#34;</span><span>)</span>
  <span>.</span><span>split</span><span>(</span><span>&#34;,&#34;</span><span>)</span>
  <span>.</span><span>filter</span><span>(</span>Boolean<span>)</span>
  <span>.</span><span>forEach</span><span>(</span><span>(</span><span>globalToInspect</span><span>)</span> <span>=&gt;</span> <span>addGlobalToInspect</span><span>(</span>globalToInspect<span>)</span><span>)</span><span>;</span></code></pre></div>
<h2>Complete solution: <code>globals-debugger.js</code></h2>
<p>Before finally trying the globals debugger, here‚Äôs the complete code (with comments and a couple of additional safety checks):</p>
<div id="gist114704328">
    <div translate="no">
      <div>
        <div>
  <div id="file-globals-debugger-js">
    
  <div itemprop="text">

      
<div>

  <template>
  <div data-view-component="true">
  <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
  
    <p><span>
      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
      <a href="https://github.co/hiddenchars" target="_blank">Learn more about bidirectional Unicode characters</a>
    </span></p>
</div></template>
<template>
  <span aria-label="This line has hidden Unicode characters" data-view-component="true">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path>
</svg>
</span></template>

  
</div>


  </div>

  </div>
</div>

      </div>
      
    </div>
</div>
<h2><code>globals-debugger.js</code> usage example</h2>
<p>Finally, here‚Äôs an example of using what we just built to track down the <code>i</code> global creation.</p>
<blockquote>
<p><strong>Note:</strong> This is just a simplified use-case to show you the <code>globals-debugger</code> use-flow. In a more realistic scenario you would probably use it to track down globals added in bigger codebases or from third-party libraries deep down the dependencies tree.</p>
</blockquote>
<p>Opening the HTML page above with the <code>?globalsToInspect=i</code> query parameter will immediately pause the code execution when the <code>i</code> variable is being set (notice that the <code>globalName</code> variable in the current closure is <code>i</code> in the right panel):</p>
<p><span>
      <span></span>
  <img alt="i 1" title="i 1" src="https://mmazzarolo.com/static/2239b19548f18adda13be1ce3bc63e9b/1e043/i-1.png" srcset="/static/2239b19548f18adda13be1ce3bc63e9b/991de/i-1.png 173w,
/static/2239b19548f18adda13be1ce3bc63e9b/e4d6b/i-1.png 345w,
/static/2239b19548f18adda13be1ce3bc63e9b/1e043/i-1.png 690w,
/static/2239b19548f18adda13be1ce3bc63e9b/e3189/i-1.png 1035w,
/static/2239b19548f18adda13be1ce3bc63e9b/b1001/i-1.png 1380w,
/static/2239b19548f18adda13be1ce3bc63e9b/3c2d4/i-1.png 2092w" sizes="(max-width: 690px) 100vw, 690px" loading="lazy" decoding="async"/>
    </span></p>
<p>Since the <code>debugger;</code> statement is in our own code, we need to step out of the current function (<kbd>Shift</kbd> + <kbd>F11</kbd>), to land on the exact line of code that is setting the <code>i</code> variable:</p>
<p><span>
      <span></span>
  <img alt="i 2" title="i 2" src="https://mmazzarolo.com/static/fb763f6857257582890d2d3416f96fd3/1e043/i-2.png" srcset="/static/fb763f6857257582890d2d3416f96fd3/991de/i-2.png 173w,
/static/fb763f6857257582890d2d3416f96fd3/e4d6b/i-2.png 345w,
/static/fb763f6857257582890d2d3416f96fd3/1e043/i-2.png 690w,
/static/fb763f6857257582890d2d3416f96fd3/e3189/i-2.png 1035w,
/static/fb763f6857257582890d2d3416f96fd3/b1001/i-2.png 1380w,
/static/fb763f6857257582890d2d3416f96fd3/3c2d4/i-2.png 2092w" sizes="(max-width: 690px) 100vw, 690px" loading="lazy" decoding="async"/>
    </span></p>
<p>Last but not least, if we check the DevTools console we‚Äôll see the logged stack trace, which is helpful to inspect the stack even while the script is running. Also, we can validate that, even if proxied, the global variables are still working correctly:</p>
<p><span>
      <span></span>
  <img alt="console" title="console" src="https://mmazzarolo.com/static/bdbc676352e66d7e5268cc52005c3bd2/1e043/console.png" srcset="/static/bdbc676352e66d7e5268cc52005c3bd2/991de/console.png 173w,
/static/bdbc676352e66d7e5268cc52005c3bd2/e4d6b/console.png 345w,
/static/bdbc676352e66d7e5268cc52005c3bd2/1e043/console.png 690w,
/static/bdbc676352e66d7e5268cc52005c3bd2/e3189/console.png 1035w,
/static/bdbc676352e66d7e5268cc52005c3bd2/b1001/console.png 1380w,
/static/bdbc676352e66d7e5268cc52005c3bd2/3c2d4/console.png 2092w" sizes="(max-width: 690px) 100vw, 690px" loading="lazy" decoding="async"/>
    </span></p></section></article></div>
  </body>
</html>
