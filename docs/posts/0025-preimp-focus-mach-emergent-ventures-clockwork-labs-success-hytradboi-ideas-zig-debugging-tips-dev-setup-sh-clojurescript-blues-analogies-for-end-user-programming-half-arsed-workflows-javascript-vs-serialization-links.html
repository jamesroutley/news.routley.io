<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://scattered-thoughts.net/log/0025/">Original</a>
    <h1>0025: preimp, focus &#43; mach, emergent ventures, clockwork labs, success, hytradboi ideas, zig debugging tips, dev-setup.sh, clojurescript blues, analogies for end-user programming, half-arsed workflows, javascript vs serialization, links</h1>
    
    <div id="readability-page-1" class="page"><article>
  <h2 id="preimp">Preimp</h2>
<p>I&#39;ve made a lot of progress on <a href="https://github.com/jamii/preimp">preimp</a>. Persistence, server/client sync and collaborative editing are all working. Values are nicely rendered as tables. Functions are rendered as forms, which you can fill out to call the function. Functions can call <code>edit!</code> to change the value of data cells. Metadata can be used to tweak the rendering of values.</p>
<p>Together these features allow quickly throwing together interactive apps. You just have to write the actual logic and you get (ugly) interactive ui, persistence and (coarse-grained) collaborative editing for free.</p>
<video controls="">
  <source src="/log/0025/preimp.mp4" type="video/mp4"/>
</video>
<p>I wrote an accounting app in preimp to share with my wife. Here&#39;s a sneak peek of one of the cells:</p>
<p><img src="https://scattered-thoughts.net/log/0025/preimp.png" alt=""/></p>
<p>It&#39;s <em>almost</em> usable - I just have to figure out how to improve the rendering performance for large values. I&#39;m seeing &gt;1000ms frames to display &lt;600 transactions, much of which is spent in opaque browser-land.</p>
<p><img src="https://scattered-thoughts.net/log/0025/profile.png" alt=""/></p>
<p>I also added a PUT endpoint to the server that allows setting the values of cells remotely, and wrote a little script that fetches transactions from my bank and adds them to the budgeting app:</p>
<pre data-lang="clj"><code data-lang="clj"><span>(ns </span><span>wise
</span><span>  (</span><span>:require </span><span>[clj-http.client </span><span>:as </span><span>client]
</span><span>            [clojure.data.json </span><span>:as </span><span>json]))
</span><span>
</span><span>(def </span><span>endpoints </span><span>{
</span><span>  </span><span>;; FILL ME IN
</span><span>})
</span><span>
</span><span>(defn </span><span>api-get </span><span>[user path]
</span><span>  (let [domain (get-in endpoints [user </span><span>:wise-domain</span><span>])
</span><span>        url (str domain </span><span>&#34;/&#34; </span><span>path)
</span><span>        response (client/get url {</span><span>:headers </span><span>{</span><span>&#34;Authorization&#34; </span><span>(str </span><span>&#34;Bearer &#34; </span><span>(get-in endpoints [user </span><span>:wise-token</span><span>]))}})]
</span><span>    (assert (= </span><span>200 </span><span>(</span><span>:status </span><span>response)))
</span><span>    (json/read-str (</span><span>:body </span><span>response))))
</span><span>
</span><span>(def </span><span>now </span><span>(java.time.Instant/now))
</span><span>
</span><span>(defn </span><span>get-transactions </span><span>[user]
</span><span>  (into []
</span><span>        (for [profile (api-get user </span><span>&#34;v2/profiles&#34;</span><span>)
</span><span>              </span><span>:let </span><span>[profile-id (get profile </span><span>&#34;id&#34;</span><span>)]
</span><span>              balance (api-get user (str </span><span>&#34;v4/profiles/&#34; </span><span>profile-id </span><span>&#34;/balances?types=STANDARD&#34;</span><span>))
</span><span>              </span><span>:let </span><span>[balance-id (get balance </span><span>&#34;id&#34;</span><span>)
</span><span>                    statement (api-get user (str </span><span>&#34;/v1/profiles/&#34; </span><span>profile-id </span><span>&#34;/balance-statements/&#34; </span><span>balance-id </span><span>&#34;/statement.json?intervalStart=2022-01-01T00:00:00.000Z&amp;intervalEnd=&#34; </span><span>now </span><span>&#34;&amp;type=COMPACT&#34;</span><span>))]
</span><span>              transaction (get statement </span><span>&#34;transactions&#34;</span><span>)]
</span><span>          transaction)))
</span><span>          
</span><span>(defn </span><span>update-preimp </span><span>[user]
</span><span>  (let [transactions (get-transactions user)
</span><span>        cell-name (symbol (str (name user) </span><span>&#34;-wise-transactions&#34;</span><span>))
</span><span>        cell-value (pr-str </span><span>`</span><span>(</span><span>~&#39;</span><span>defs </span><span>~</span><span>cell-name </span><span>~</span><span>transactions))
</span><span>        body (json/write-str
</span><span>              {</span><span>:cell-id </span><span>(get-in endpoints [user </span><span>:cell-id</span><span>])
</span><span>               </span><span>:value </span><span>cell-value})]
</span><span>    (client/put
</span><span>     (get-in endpoints [user </span><span>:preimp-domain</span><span>])
</span><span>     (merge (get-in endpoints [user </span><span>:preimp-headers</span><span>]) {</span><span>:body </span><span>body}))))
</span><span>
</span><span>(defn </span><span>update-preimp-dev </span><span>[_]
</span><span>  (update-preimp </span><span>:sandbox</span><span>))
</span><span>
</span><span>(defn </span><span>update-preimp-prod </span><span>[_]
</span><span>  (update-preimp </span><span>:jamie</span><span>)
</span><span>  (update-preimp </span><span>:cynthia</span><span>))
</span></code></pre>
<p>I&#39;m hoping in the next month or two to be able to turn this into an (interactive?) essay. </p>
<h2 id="focus">Focus</h2>
<p>I added language-specific completions, although still just tokenizer-driven with no understanding of scoping. Also some minor bug fixes.</p>
<p>I&#39;ve been eyeing up <a href="https://machengine.org/">mach</a> which aims to provide a platform for cross-compiling <a href="https://www.w3.org/TR/webgpu/">webgpu</a> apps for all major platforms (including wasm). </p>
<p>In the process they&#39;re producing a lot of from-source bindings and build scripts for various libraries. I&#39;ve already switched focus&#39; font rendering from sdl-ttf to <a href="https://github.com/hexops/mach-freetype">mach-freetype</a> and I plan to switch from sdl to <a href="https://github.com/hexops/mach-glfw">mach-glfw</a>. That would simplify cross-platform builds already.</p>
<p>But I&#39;m also considering building on top of <a href="https://github.com/hexops/mach/tree/main/src/platform">mach.platform</a> and webgpu (probably as a branch for now, until mach is less of a moving target). That would allow me to compile (a subset of) focus to run in the browser, making it easier to share demos like the <a href="https://scattered-thoughts.net/writing/imp-live-repl/">imp live repl</a> without having to maintain two separate implementations.</p>
<h2 id="emergent-ventures">Emergent Ventures</h2>
<p><a href="https://www.mercatus.org/emergent-ventures">Emergent Ventures</a> gave me a $50k grant to work on <a href="https://scattered-thoughts.net/#imp_v0">imp</a>. </p>
<p>They also recommended using some of that money to travel and meet more people. So far I&#39;m thinking about <a href="https://handmade-seattle.com/">Handmade Seattle</a> (90%), <a href="https://www.thestrangeloop.com/">Strange Loop</a> (60%) and Boston (60%). I&#39;d welcome additional suggestions for events or groups of people to visit.</p>
<h2 id="clockwork-labs">Clockwork Labs</h2>
<p>I&#39;ve started working with <a href="https://clockworklabs.io/">Clockwork Labs</a>, in the same 8-hours-per-month advisory role I have with <a href="https://xtdb.com/">XTDB</a>. </p>
<p>I&#39;m not sure yet about the business model, which is still in flux but has some risk of including the phrase &#34;cryptocurrency&#34;. But the core product is interesting:</p>
<blockquote>
<p>SpacetimeDB is a distributed relational database system which lets clients interact directly with the database by embedding application logic inside the database using wasm (like stored procedures, but with languages like rust/typescript/etc).</p>
</blockquote>
<p>They also asked me to mention that they are <a href="https://clockworklabs.io/join">hiring</a>, especially for <a href="https://apply.workable.com/clockwork-labs/j/746A0A6C0A/">database engineers</a>.</p>
<h2 id="success">Success</h2>
<p>In the first two years after leaving materialize I made a total of $20,171. </p>
<p>So it&#39;s a relief to realize that, between github sponsors, xtdb and clockwork labs, my wife and I are actually in the black this month. </p>
<p>On top of that, hytradboi and the emergent ventures grant gave us an 11 month runway to cover the inevitable gaps in consulting income.</p>
<p>So this is a real thing now. I&#39;m actually an independent researcher, not just unemployed.</p>
<h2 id="hytradboi-ideas">HYTRADBOI ideas</h2>
<p>I&#39;m still on the fence about whether I want to HYTRADBOI again in 2023. But I&#39;ve been throwing around some ideas:</p>
<ul>
<li>Instead of soliciting talk proposals, solicit recommendations for who I should ask. You can&#39;t recommend yourself.</li>
<li>Ask speakers to talk about a project that is not their own. So rather than self-promotion we&#39;d get people explaining some idea that they think is important.</li>
<li>After the conference, solicit essays / blog posts on attendees thoughts / reactions. Publish links to all the submisions below each talk.</li>
</ul>
<h2 id="zig-debugging-tips">Zig debugging tips</h2>
<p>(Thanks to <a href="https://isaacfreund.com/">Isaac Freund</a>)</p>
<p>Usually zig release builds don&#39;t emit stack traces on crashes. Compiling with <code>-fno-omit-frame-pointer</code> (or <code>exe.omit_frame_pointer = false;</code>) fixes this. </p>
<p>The release stack traces are still printed wrong because of an outstanding bug in the compiler but if you enable coredumps on linux (google instructions for your distro) you can <code>coredumpctl -r debug</code> to open the most recent crash in a debugger and see the correct trace.</p>
<h2 id="dev-setup-sh">dev-setup.sh</h2>
<p>For some projects it takes me a few minutes to setup my workflow. I&#39;ve been experimenting with scripting this process via the window manager:</p>
<pre data-lang="bash"><code data-lang="bash"><span>#!/usr/bin/env bash
</span><span>
</span><span>cd </span><span>&#34;$</span><span>(</span><span>dirname </span><span>&#34;$</span><span>(</span><span>readlink</span><span> -f </span><span>&#34;$</span><span>0</span><span>&#34;</span><span>)</span><span>&#34;</span><span>)</span><span>&#34;
</span><span>
</span><span>rm</span><span> -rf</span><span> ./out
</span><span>
</span><span>swaymsg</span><span> workspace 0
</span><span>alacritty</span><span> --working-directory</span><span> ./</span><span> -e</span><span> nix-shell</span><span> --run </span><span>&#39;clj -M --main cljs.main --watch src --compile preimp.core&#39; </span><span>&amp;
</span><span>alacritty</span><span> --working-directory</span><span> ./</span><span> -e</span><span> nix-shell</span><span> --run </span><span>&#39;clj -X preimp.server/-main&#39; </span><span>&amp;
</span><span>
</span><span>sleep</span><span> 1 </span><span># :(
</span><span>
</span><span>swaymsg</span><span> workspace 1
</span><span>$</span><span>EDITOR ./src/preimp/core.clj </span><span>&amp;
</span><span>
</span><span>sleep</span><span> 1 </span><span># :(
</span><span>
</span><span>swaymsg</span><span> workspace 2
</span><span>$</span><span>EDITOR ./src/preimp/core.cljs </span><span>&amp;
</span><span>$</span><span>BROWSER localhost:3000 </span><span>&amp;
</span></code></pre>
<p>It&#39;s not quite right yet - when one of those processes exits it takes the others with it. But it feels like a workable idea.</p>
<h2 id="clojurescript-blues">Clojurescript blues</h2>
<p>I haven&#39;t used clojurescript for a long time. I picked it for preimp because I had very specific needs for this prototype - I need a language that compiles to javascript, can run the compiler in the browser, has persistent data-structures, can roundtrip print-&gt;parse for most values, and is easy to parse. Eventually I&#39;ll have to implement all of that from scratch for imp, but in the meantime this is a nice way to test out some ideas.</p>
<p>But it&#39;s also been a reminder of all the reasons that I don&#39;t use clojure for other projects.</p>
<p>Dynamic typing and pervasive nil-punning massively increase the distance between making an error and seeing the effects, which makes debugging much more time-consuming. For example when using the self-hosted clojurescript compiler you can specify what namespace to evaluate the code in. I passed a namespace (<code>preimp.core</code>) instead of the symbol naming that namespace (<code>&#39;preimp.core</code>). In julia this likely would have been an immediate type error - something like <code>no method matching eval(::String, ::Namespace)</code>. But instead what happened is the compiler generated invalid javascript. Eg <code>(fn [] edit!)</code> compiled to <code>(function (){\nreturn .edit_BANG_;\n})</code>. </p>
<p>Debugging that mistake was made slower by the suspicion that this was a compiler bug. Because I already ran into multiple different miscompilations that week. Eg <code>(def zzz ^{:name &#34;add 1 to x&#34;} (fn inc [] (edit! &#39;x inc)))</code> compiled to <code>(function (x){ return cljs.core.with_meta(return (function preimp$core$inc(){ return preimp.core.edit_BANG_.call(null,new cljs.core.Symbol(null,&#34;x&#34;,&#34;x&#34;,(-555367584),null),preimp$core$inc);}); ,new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,&#34;name&#34;,&#34;name&#34;,(1843675177)),&#34;add 1 to x&#34;], null));})</code> which is, again, invalid javascript. </p>
<p>At one point I tried switching from reagent to rum. It took me an hour to rewrite my ui code and two days to get it to compile. The clojurescript version I started with <a href="https://github.com/tonsky/rum/issues/253">miscompiles rum</a>. Older clojurescript versions worked with debug builds but failed with optimizations enabled, claiming that <code>cljs.react</code> was not defined despite it being listed in rum&#39;s dependencies. I eventually ended up with a combination of versions where <a href="https://github.com/jamii/preimp/blob/rum/build.clj#L18-L22">compiling using cljs.build.api</a> works but passing the same arguments at the command line doesn&#39;t.</p>
<p>Having working debug builds and failing release builds has been a common problem too. It&#39;s pretty common for clojurescript workflows to have a lot of conditional compilation to enable repl-driven workflows. Release builds also use a different toolchain and module-loading mechanism. So I often can&#39;t debug in my debug builds because the bug only appears in release builds.</p>
<p>For a while I had a bug where clean builds compile succesfully but incremental builds would complain about missing imports that weren&#39;t actually missing. I don&#39;t know what caused it, and I don&#39;t know why it stopped. A clean build of preimp takes 2m30s. (A clean release build of <a href="https://scattered-thoughts.net/#imp_v2">imp2</a> takes 60s.)</p>
<p>All of this is frustrating because I really would like to use clojurescript more often. The data notation is really well thought out. The datastructure manipulation functions in the core library work together beautifully (nil-punning aside). There are some solid libraries for dealing with state and ui. But none of that saves me any time in the long run because the core tooling is so poor.</p>
<h2 id="analogies-for-end-user-programming">Analogies for end-user programming</h2>
<p>I&#39;ve been thinking about convivial vs industrial modes of production. There are some fields where convivial production is almost completely dead eg hardly anyone builds their own cars anymore and there is little to be gained by doing so. In other fields there is a smooth continuum eg most homes are professionally built and most furniture is mass-produced, but Home Depot still exists and basic carpentry skills are still useful. (I spent a chunk of last year sleeping on a hand-made bed in the back of Honda Odyssey. You can&#39;t buy those at Ikea.)</p>
<p>In terms of this analogy, a lot of objections to end-user programming sound to me like arguing that Home Depot is a waste of time because their customers will never be able to build their own skyscrapers. </p>
<p>And then on the other side are the people arguing that people <em>will</em> be able to build their own skyscrapers and it will change the world. </p>
<p>I just think it would be nice if people had the tools to put up their own shelves if they wanted to.</p>
<hr/>
<p>Another angle on this is that industry is pretty good at making things, so if you want to find a niche where you can add value outside of a large company you need to look for things that are not commercially attractive at scale.</p>
<p>One niche that might fit is <a href="https://www.inkandswitch.com/local-first/">local-first software</a>. From the point of view of a large software company local-first software adds complexity, is easier to pirate and easier to migrate away from. So all the advances in local-first software right now are driven by individuals or small companies who are more UX-driven.</p>
<h2 id="half-arsed-workflows">Half-arsed workflows</h2>
<p>Here is how I produce invoices and contracts for consulting:</p>
<ul>
<li>Open an old invoice/contract in firefox.</li>
<li>Use the inspector to change the values.</li>
<li>Hit &#39;save as new file&#39;.</li>
</ul>
<h2 id="javascript-vs-serialization">Javascript vs serialization</h2>
<p>In the browser it&#39;s common to want to take some work off the main thread to avoid blocking the UI. It&#39;s easy - just send the inputs to a webworker and send the output back.</p>
<p>What if the thing that you want to take off the main thread is serialization? Sending the object-to-be-to-serialized to a webworker recursively copies the whole object into the webworker memory space and then the result has to be copied back. This can end up blocking the main thread almost as long as the serialization itself would have.</p>
<p>Afaict the only solution for large objects is either SharedArrayBuffer + WebAssembly threads, or using async to break up the serialization into chunks.</p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://marijnhaverbeke.nl/blog/extensibility.html">Extensible Extension Mechanisms</a> and <a href="https://marijnhaverbeke.nl/blog/facets.html">Facets as Composable Extension Points</a>. Marijn Haverbeke (the author of codemirror/prosemirror) has been thinking on how to balance extensibility and stability, and especially how to ensure that arbitrary extensions work together.</li>
<li><a href="https://justinjaffray.com/join-the-ultimate-projection/">JOIN: The Ultimate Projection</a> explains the core intuition behind decorrelating subqueries. Everything else is just fiddly details.</li>
<li><a href="https://twitter.com/andy_matuschak/status/1532455848726761473">Andy Matuschak on being feral</a>. Resonates - my twitter/github bio has been &#39;feral man-ape&#39; for years because I don&#39;t want to present a polished self-image that I won&#39;t enjoy trying to live up to.</li>
<li><a href="https://blog.chiselstrike.com/my-other-database-is-a-compiler-10fd527a4d78">My other database is a compiler</a>. Using code analysis to convert typescript into mixed sql/typescript queries. They&#39;re still somewhat limited by the database interface being restricted sql - if they could run typescript functions directly inside the database in a V8 isolate then they could avoid the communication costs whenever they encounter a function that can&#39;t be translated to sql.</li>
<li><a href="https://www.youtube.com/watch?v=rNmZZLant9o">Let&#39;s Remix Distributed Database Design!</a>. Another TigerBeetle talk, mostly focused on how persistent distributed consensus can&#39;t be correctly handled by slapping raft on top of an existing storage engine, because storage faults can be <a href="https://en.wikipedia.org/wiki/Byzantine_fault">byzantine</a>.</li>
<li><a href="https://github.com/david-vanderson/gui#design">Design sketch for a gui library on top of mach</a>. There&#39;s a frustrating problem in gui where at the point you are creating a widget you don&#39;t yet know how big later widgets will be, so you don&#39;t know how big this widget will be, so you don&#39;t know if it&#39;s under the mouse pointer. So usually either you give up on complex layouts (eg dear imgui) or you wait until the end of the frame to handle events (eg html dom) which requires callbacks which complicate memory management in non-gced languages. This library instead delays layout by a frame, so you get both complex layout and immediate-mode-style events, at the expense of sometimes having one-frame layout glitches when content resizes. It&#39;s not a tradeoff I&#39;ve seen before.</li>
<li><a href="https://www.cidrdb.org/cidr2021/papers/cidr2021_paper16.pdf">New directions in cloud programming</a>. Announcing a research agenda following up on <a href="http://boom.cs.berkeley.edu/papers.html">prior work at the BOOM lab</a>. &#34;Key to our approach is a separation of distributed programs into a PACT of four facets: Program semantics, Availablity, Consistency and Targets of optimization.&#34;</li>
<li><a href="https://www.youtube.com/watch?v=r9eQth4Q5jg">Twenty Minutes of Reasons to Use the RemedyBG Debugger</a>. Windows-only, unfortunately. But it&#39;s impressive to see that a single motivated person can compete with the Visual Studio debugger and win over veteran developers. Also nice to see more real-world examples of <a href="https://github.com/ocornut/imgui">Dear ImGui</a>.</li>
<li><a href="https://nitor.com/en/articles/pitfalls-and-bumps-clojures-extensible-data-notation-edn">Pitfalls and bumps in Clojure&#39;s Extensible Data Notation</a>. Something of a counterpoint to <a href="https://scattered-thoughts.net/writing/the-shape-of-data">The shape of data</a> - edn isn&#39;t well-specified enough to have multiple compatible implementations, and the <code>pr</code> method doesn&#39;t always produce valid edn.</li>
<li><a href="http://web.mit.edu/jmorzins/www/C-H-speech.html">Selling out is usually more a matter of buying in. Sell out, and you&#39;re really buying into someone else&#39;s system of values, rules and rewards. The so-called &#34;opportunity&#34; I faced would have meant giving up my individual voice...</a></li>
</ul>

</article></div>
  </body>
</html>
