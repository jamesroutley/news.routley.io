<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/Kalinovcic/b4d9cc55a37f929cb62320763e8fbb47">Original</a>
    
    <div id="readability-page-1" class="page"><div data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="microsoft_craziness.h">
        <tbody><tr>
          <td id="file-microsoft_craziness-h-L1" data-line-number="1"></td>
          <td id="file-microsoft_craziness-h-LC1"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L2" data-line-number="2"></td>
          <td id="file-microsoft_craziness-h-LC2"><span><span>//</span> Author:   Jonathan Blow</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L3" data-line-number="3"></td>
          <td id="file-microsoft_craziness-h-LC3"><span><span>//</span> Version:  1</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L4" data-line-number="4"></td>
          <td id="file-microsoft_craziness-h-LC4"><span><span>//</span> Date:     31 August, 2018</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L5" data-line-number="5"></td>
          <td id="file-microsoft_craziness-h-LC5"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L6" data-line-number="6"></td>
          <td id="file-microsoft_craziness-h-LC6"><span><span>//</span> This code is released under the MIT license, which you can find at</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L7" data-line-number="7"></td>
          <td id="file-microsoft_craziness-h-LC7"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L8" data-line-number="8"></td>
          <td id="file-microsoft_craziness-h-LC8"><span><span>//</span>          https://opensource.org/licenses/MIT</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L9" data-line-number="9"></td>
          <td id="file-microsoft_craziness-h-LC9"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L10" data-line-number="10"></td>
          <td id="file-microsoft_craziness-h-LC10"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L11" data-line-number="11"></td>
          <td id="file-microsoft_craziness-h-LC11"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L12" data-line-number="12"></td>
          <td id="file-microsoft_craziness-h-LC12"><span><span>//</span> See the comments for how to use this library just below the includes.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L13" data-line-number="13"></td>
          <td id="file-microsoft_craziness-h-LC13"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L14" data-line-number="14"></td>
          <td id="file-microsoft_craziness-h-LC14">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L15" data-line-number="15"></td>
          <td id="file-microsoft_craziness-h-LC15">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L16" data-line-number="16"></td>
          <td id="file-microsoft_craziness-h-LC16"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L17" data-line-number="17"></td>
          <td id="file-microsoft_craziness-h-LC17"><span><span>//</span> NOTE(Kalinovcic): I have translated the original implementation to C,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L18" data-line-number="18"></td>
          <td id="file-microsoft_craziness-h-LC18"><span><span>//</span> and made a preprocessor define that enables people to include it without</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L19" data-line-number="19"></td>
          <td id="file-microsoft_craziness-h-LC19"><span><span>//</span> the implementation, just as a header.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L20" data-line-number="20"></td>
          <td id="file-microsoft_craziness-h-LC20"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L21" data-line-number="21"></td>
          <td id="file-microsoft_craziness-h-LC21"><span><span>//</span> I also fixed two bugs:</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L22" data-line-number="22"></td>
          <td id="file-microsoft_craziness-h-LC22"><span><span>//</span>   - If COM initialization for VS2017 fails, we actually properly continue</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L23" data-line-number="23"></td>
          <td id="file-microsoft_craziness-h-LC23"><span><span>//</span>     searching for earlier versions in the registry.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L24" data-line-number="24"></td>
          <td id="file-microsoft_craziness-h-LC24"><span><span>//</span>   - For earlier versions, the code now returns the &#34;bin\amd64&#34; VS directory.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L25" data-line-number="25"></td>
          <td id="file-microsoft_craziness-h-LC25"><span><span>//</span>     Previously it was returning the &#34;bin&#34; directory, which is for x86 stuff.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L26" data-line-number="26"></td>
          <td id="file-microsoft_craziness-h-LC26"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L27" data-line-number="27"></td>
          <td id="file-microsoft_craziness-h-LC27"><span><span>//</span> To include the implementation, before including microsoft_craziness.h, define:</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L28" data-line-number="28"></td>
          <td id="file-microsoft_craziness-h-LC28"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L29" data-line-number="29"></td>
          <td id="file-microsoft_craziness-h-LC29"><span><span>//</span>   #define MICROSOFT_CRAZINESS_IMPLEMENTATION</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L30" data-line-number="30"></td>
          <td id="file-microsoft_craziness-h-LC30"><span><span>//</span>   #include &#34;microsoft_craziness.h&#34;</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L31" data-line-number="31"></td>
          <td id="file-microsoft_craziness-h-LC31"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L32" data-line-number="32"></td>
          <td id="file-microsoft_craziness-h-LC32">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L33" data-line-number="33"></td>
          <td id="file-microsoft_craziness-h-LC33">#<span>ifdef</span> __cplusplus</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L34" data-line-number="34"></td>
          <td id="file-microsoft_craziness-h-LC34"><span>extern</span> <span><span>&#34;</span>C<span>&#34;</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L35" data-line-number="35"></td>
          <td id="file-microsoft_craziness-h-LC35">{</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L36" data-line-number="36"></td>
          <td id="file-microsoft_craziness-h-LC36">#endif</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L37" data-line-number="37"></td>
          <td id="file-microsoft_craziness-h-LC37">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L38" data-line-number="38"></td>
          <td id="file-microsoft_craziness-h-LC38">#<span>ifndef</span> MICROSOFT_CRAZINESS_HEADER_GUARD</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L39" data-line-number="39"></td>
          <td id="file-microsoft_craziness-h-LC39">#<span>define</span> <span>MICROSOFT_CRAZINESS_HEADER_GUARD</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L40" data-line-number="40"></td>
          <td id="file-microsoft_craziness-h-LC40">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L41" data-line-number="41"></td>
          <td id="file-microsoft_craziness-h-LC41">#<span>include</span> <span><span>&lt;</span>string.h<span>&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L42" data-line-number="42"></td>
          <td id="file-microsoft_craziness-h-LC42">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L43" data-line-number="43"></td>
          <td id="file-microsoft_craziness-h-LC43"><span>typedef</span> <span>struct</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L44" data-line-number="44"></td>
          <td id="file-microsoft_craziness-h-LC44">{</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L45" data-line-number="45"></td>
          <td id="file-microsoft_craziness-h-LC45">    <span>int</span> windows_sdk_version;   <span><span>//</span> Zero if no Windows SDK found.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L46" data-line-number="46"></td>
          <td id="file-microsoft_craziness-h-LC46">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L47" data-line-number="47"></td>
          <td id="file-microsoft_craziness-h-LC47">    <span>wchar_t</span> *windows_sdk_root;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L48" data-line-number="48"></td>
          <td id="file-microsoft_craziness-h-LC48">    <span>wchar_t</span> *windows_sdk_um_library_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L49" data-line-number="49"></td>
          <td id="file-microsoft_craziness-h-LC49">    <span>wchar_t</span> *windows_sdk_ucrt_library_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L50" data-line-number="50"></td>
          <td id="file-microsoft_craziness-h-LC50">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L51" data-line-number="51"></td>
          <td id="file-microsoft_craziness-h-LC51">    <span>wchar_t</span> *vs_exe_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L52" data-line-number="52"></td>
          <td id="file-microsoft_craziness-h-LC52">    <span>wchar_t</span> *vs_library_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L53" data-line-number="53"></td>
          <td id="file-microsoft_craziness-h-LC53">} Find_Result;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L54" data-line-number="54"></td>
          <td id="file-microsoft_craziness-h-LC54">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L55" data-line-number="55"></td>
          <td id="file-microsoft_craziness-h-LC55">Find_Result <span>find_visual_studio_and_windows_sdk</span>();</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L56" data-line-number="56"></td>
          <td id="file-microsoft_craziness-h-LC56"><span>void</span> <span>free_resources</span>(Find_Result *result);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L57" data-line-number="57"></td>
          <td id="file-microsoft_craziness-h-LC57">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L58" data-line-number="58"></td>
          <td id="file-microsoft_craziness-h-LC58">#<span>endif</span>  <span><span>//</span> MICROSOFT_CRAZINESS_HEADER_GUARD</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L59" data-line-number="59"></td>
          <td id="file-microsoft_craziness-h-LC59">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L60" data-line-number="60"></td>
          <td id="file-microsoft_craziness-h-LC60">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L61" data-line-number="61"></td>
          <td id="file-microsoft_craziness-h-LC61"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L62" data-line-number="62"></td>
          <td id="file-microsoft_craziness-h-LC62"><span><span>//</span> HOW TO USE THIS CODE</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L63" data-line-number="63"></td>
          <td id="file-microsoft_craziness-h-LC63"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L64" data-line-number="64"></td>
          <td id="file-microsoft_craziness-h-LC64"><span><span>//</span> The purpose of this file is to find the folders that contain libraries</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L65" data-line-number="65"></td>
          <td id="file-microsoft_craziness-h-LC65"><span><span>//</span> you may need to link against, on Windows, if you are linking with any</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L66" data-line-number="66"></td>
          <td id="file-microsoft_craziness-h-LC66"><span><span>//</span> compiled C or C++ code. This will be necessary for many non-C++ programming</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L67" data-line-number="67"></td>
          <td id="file-microsoft_craziness-h-LC67"><span><span>//</span> language environments that want to provide compatibility.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L68" data-line-number="68"></td>
          <td id="file-microsoft_craziness-h-LC68"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L69" data-line-number="69"></td>
          <td id="file-microsoft_craziness-h-LC69"><span><span>//</span> We find the place where the Visual Studio libraries live (for example,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L70" data-line-number="70"></td>
          <td id="file-microsoft_craziness-h-LC70"><span><span>//</span> libvcruntime.lib), where the linker and compiler executables live</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L71" data-line-number="71"></td>
          <td id="file-microsoft_craziness-h-LC71"><span><span>//</span> (for example, link.exe), and where the Windows SDK libraries reside</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L72" data-line-number="72"></td>
          <td id="file-microsoft_craziness-h-LC72"><span><span>//</span> (kernel32.lib, libucrt.lib).</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L73" data-line-number="73"></td>
          <td id="file-microsoft_craziness-h-LC73"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L74" data-line-number="74"></td>
          <td id="file-microsoft_craziness-h-LC74"><span><span>//</span> We all wish you didn&#39;t have to worry about so many weird dependencies,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L75" data-line-number="75"></td>
          <td id="file-microsoft_craziness-h-LC75"><span><span>//</span> but we don&#39;t really have a choice about this, sadly.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L76" data-line-number="76"></td>
          <td id="file-microsoft_craziness-h-LC76"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L77" data-line-number="77"></td>
          <td id="file-microsoft_craziness-h-LC77"><span><span>//</span> I don&#39;t claim that this is the absolute best way to solve this problem,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L78" data-line-number="78"></td>
          <td id="file-microsoft_craziness-h-LC78"><span><span>//</span> and so far we punt on things (if you have multiple versions of Visual Studio</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L79" data-line-number="79"></td>
          <td id="file-microsoft_craziness-h-LC79"><span><span>//</span> installed, we return the first one, rather than the newest). But it</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L80" data-line-number="80"></td>
          <td id="file-microsoft_craziness-h-LC80"><span><span>//</span> will solve the basic problem for you as simply as I know how to do it,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L81" data-line-number="81"></td>
          <td id="file-microsoft_craziness-h-LC81"><span><span>//</span> and because there isn&#39;t too much code here, it&#39;s easy to modify and expand.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L82" data-line-number="82"></td>
          <td id="file-microsoft_craziness-h-LC82"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L83" data-line-number="83"></td>
          <td id="file-microsoft_craziness-h-LC83"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L84" data-line-number="84"></td>
          <td id="file-microsoft_craziness-h-LC84"><span><span>//</span> Here is the API you need to know about:</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L85" data-line-number="85"></td>
          <td id="file-microsoft_craziness-h-LC85"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L86" data-line-number="86"></td>
          <td id="file-microsoft_craziness-h-LC86">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L87" data-line-number="87"></td>
          <td id="file-microsoft_craziness-h-LC87">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L88" data-line-number="88"></td>
          <td id="file-microsoft_craziness-h-LC88"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L89" data-line-number="89"></td>
          <td id="file-microsoft_craziness-h-LC89"><span><span>//</span> Call find_visual_studio_and_windows_sdk, look at the resulting</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L90" data-line-number="90"></td>
          <td id="file-microsoft_craziness-h-LC90"><span><span>//</span> paths, then call free_resources on the result.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L91" data-line-number="91"></td>
          <td id="file-microsoft_craziness-h-LC91"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L92" data-line-number="92"></td>
          <td id="file-microsoft_craziness-h-LC92"><span><span>//</span> Everything else in this file is implementation details that you</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L93" data-line-number="93"></td>
          <td id="file-microsoft_craziness-h-LC93"><span><span>//</span> don&#39;t need to care about.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L94" data-line-number="94"></td>
          <td id="file-microsoft_craziness-h-LC94"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L95" data-line-number="95"></td>
          <td id="file-microsoft_craziness-h-LC95">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L96" data-line-number="96"></td>
          <td id="file-microsoft_craziness-h-LC96"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L97" data-line-number="97"></td>
          <td id="file-microsoft_craziness-h-LC97"><span><span>//</span> This file was about 400 lines before we started adding these comments.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L98" data-line-number="98"></td>
          <td id="file-microsoft_craziness-h-LC98"><span><span>//</span> You might think that&#39;s way too much code to do something as simple</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L99" data-line-number="99"></td>
          <td id="file-microsoft_craziness-h-LC99"><span><span>//</span> as finding a few library and executable paths. I agree. However,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L100" data-line-number="100"></td>
          <td id="file-microsoft_craziness-h-LC100"><span><span>//</span> Microsoft&#39;s own solution to this problem, called &#34;vswhere&#34;, is a</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L101" data-line-number="101"></td>
          <td id="file-microsoft_craziness-h-LC101"><span><span>//</span> mere EIGHT THOUSAND LINE PROGRAM, spread across 70 files,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L102" data-line-number="102"></td>
          <td id="file-microsoft_craziness-h-LC102"><span><span>//</span> that they posted to github *unironically*.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L103" data-line-number="103"></td>
          <td id="file-microsoft_craziness-h-LC103"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L104" data-line-number="104"></td>
          <td id="file-microsoft_craziness-h-LC104"><span><span>//</span> I am not making this up: https://github.com/Microsoft/vswhere</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L105" data-line-number="105"></td>
          <td id="file-microsoft_craziness-h-LC105"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L106" data-line-number="106"></td>
          <td id="file-microsoft_craziness-h-LC106"><span><span>//</span> Several people have therefore found the need to solve this problem</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L107" data-line-number="107"></td>
          <td id="file-microsoft_craziness-h-LC107"><span><span>//</span> themselves. We referred to some of these other solutions when</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L108" data-line-number="108"></td>
          <td id="file-microsoft_craziness-h-LC108"><span><span>//</span> figuring out what to do, most prominently ziglang&#39;s version,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L109" data-line-number="109"></td>
          <td id="file-microsoft_craziness-h-LC109"><span><span>//</span> by Ryan Saunderson.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L110" data-line-number="110"></td>
          <td id="file-microsoft_craziness-h-LC110"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L111" data-line-number="111"></td>
          <td id="file-microsoft_craziness-h-LC111"><span><span>//</span> I hate this kind of code. The fact that we have to do this at all</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L112" data-line-number="112"></td>
          <td id="file-microsoft_craziness-h-LC112"><span><span>//</span> is stupid, and the actual maneuvers we need to go through</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L113" data-line-number="113"></td>
          <td id="file-microsoft_craziness-h-LC113"><span><span>//</span> are just painful. If programming were like this all the time,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L114" data-line-number="114"></td>
          <td id="file-microsoft_craziness-h-LC114"><span><span>//</span> I would quit.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L115" data-line-number="115"></td>
          <td id="file-microsoft_craziness-h-LC115"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L116" data-line-number="116"></td>
          <td id="file-microsoft_craziness-h-LC116"><span><span>//</span> Because this is such an absurd waste of time, I felt it would be</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L117" data-line-number="117"></td>
          <td id="file-microsoft_craziness-h-LC117"><span><span>//</span> useful to package the code in an easily-reusable way, in the</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L118" data-line-number="118"></td>
          <td id="file-microsoft_craziness-h-LC118"><span><span>//</span> style of the stb libraries. We haven&#39;t gone as all-out as some</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L119" data-line-number="119"></td>
          <td id="file-microsoft_craziness-h-LC119"><span><span>//</span> of the stb libraries do (which compile in C with no includes, often).</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L120" data-line-number="120"></td>
          <td id="file-microsoft_craziness-h-LC120"><span><span>//</span> For this version you need C++ and the headers at the top of the file.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L121" data-line-number="121"></td>
          <td id="file-microsoft_craziness-h-LC121"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L122" data-line-number="122"></td>
          <td id="file-microsoft_craziness-h-LC122"><span><span>//</span> We return the strings as Windows wide character strings. Aesthetically</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L123" data-line-number="123"></td>
          <td id="file-microsoft_craziness-h-LC123"><span><span>//</span> I don&#39;t like that (I think most sane programs are UTF-8 internally),</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L124" data-line-number="124"></td>
          <td id="file-microsoft_craziness-h-LC124"><span><span>//</span> but apparently, not all valid Windows file paths can even be converted</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L125" data-line-number="125"></td>
          <td id="file-microsoft_craziness-h-LC125"><span><span>//</span> correctly to UTF-8. So have fun with that. It felt safest and simplest</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L126" data-line-number="126"></td>
          <td id="file-microsoft_craziness-h-LC126"><span><span>//</span> to stay with wchar_t since all of this code is fully ensconced in</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L127" data-line-number="127"></td>
          <td id="file-microsoft_craziness-h-LC127"><span><span>//</span> Windows crazy-land.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L128" data-line-number="128"></td>
          <td id="file-microsoft_craziness-h-LC128"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L129" data-line-number="129"></td>
          <td id="file-microsoft_craziness-h-LC129"><span><span>//</span> One other shortcut I took is that this is hardcoded to return the</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L130" data-line-number="130"></td>
          <td id="file-microsoft_craziness-h-LC130"><span><span>//</span> folders for x64 libraries. If you want x86 or arm, you can make</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L131" data-line-number="131"></td>
          <td id="file-microsoft_craziness-h-LC131"><span><span>//</span> slight edits to the code below, or, if enough people want this,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L132" data-line-number="132"></td>
          <td id="file-microsoft_craziness-h-LC132"><span><span>//</span> I can work it in here.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L133" data-line-number="133"></td>
          <td id="file-microsoft_craziness-h-LC133"><span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L134" data-line-number="134"></td>
          <td id="file-microsoft_craziness-h-LC134">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L135" data-line-number="135"></td>
          <td id="file-microsoft_craziness-h-LC135">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L136" data-line-number="136"></td>
          <td id="file-microsoft_craziness-h-LC136">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L137" data-line-number="137"></td>
          <td id="file-microsoft_craziness-h-LC137">#<span>ifdef</span>  MICROSOFT_CRAZINESS_IMPLEMENTATION</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L138" data-line-number="138"></td>
          <td id="file-microsoft_craziness-h-LC138">#<span>ifndef</span> MICROSOFT_CRAZINESS_IMPLEMENTATION_GUARD</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L139" data-line-number="139"></td>
          <td id="file-microsoft_craziness-h-LC139">#<span>define</span> <span>MICROSOFT_CRAZINESS_IMPLEMENTATION_GUARD</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L140" data-line-number="140"></td>
          <td id="file-microsoft_craziness-h-LC140">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L141" data-line-number="141"></td>
          <td id="file-microsoft_craziness-h-LC141">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L142" data-line-number="142"></td>
          <td id="file-microsoft_craziness-h-LC142">#<span>include</span> <span><span>&lt;</span>windows.h<span>&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L143" data-line-number="143"></td>
          <td id="file-microsoft_craziness-h-LC143">#<span>include</span> <span><span>&lt;</span>stdio.h<span>&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L144" data-line-number="144"></td>
          <td id="file-microsoft_craziness-h-LC144">#<span>include</span> <span><span>&lt;</span>stdint.h<span>&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L145" data-line-number="145"></td>
          <td id="file-microsoft_craziness-h-LC145">#<span>include</span> <span><span>&lt;</span>stdbool.h<span>&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L146" data-line-number="146"></td>
          <td id="file-microsoft_craziness-h-LC146">#<span>include</span> <span><span>&lt;</span>io.h<span>&gt;</span></span>         <span><span>//</span> For _get_osfhandle</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L147" data-line-number="147"></td>
          <td id="file-microsoft_craziness-h-LC147">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L148" data-line-number="148"></td>
          <td id="file-microsoft_craziness-h-LC148">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L149" data-line-number="149"></td>
          <td id="file-microsoft_craziness-h-LC149"><span>void</span> <span>free_resources</span>(Find_Result *result) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L150" data-line-number="150"></td>
          <td id="file-microsoft_craziness-h-LC150">    <span>free</span>(result-&gt;<span>windows_sdk_root</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L151" data-line-number="151"></td>
          <td id="file-microsoft_craziness-h-LC151">    <span>free</span>(result-&gt;<span>windows_sdk_um_library_path</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L152" data-line-number="152"></td>
          <td id="file-microsoft_craziness-h-LC152">    <span>free</span>(result-&gt;<span>windows_sdk_ucrt_library_path</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L153" data-line-number="153"></td>
          <td id="file-microsoft_craziness-h-LC153">    <span>free</span>(result-&gt;<span>vs_exe_path</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L154" data-line-number="154"></td>
          <td id="file-microsoft_craziness-h-LC154">    <span>free</span>(result-&gt;<span>vs_library_path</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L155" data-line-number="155"></td>
          <td id="file-microsoft_craziness-h-LC155">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L156" data-line-number="156"></td>
          <td id="file-microsoft_craziness-h-LC156">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L157" data-line-number="157"></td>
          <td id="file-microsoft_craziness-h-LC157">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L158" data-line-number="158"></td>
          <td id="file-microsoft_craziness-h-LC158"><span><span>//</span> COM objects for the ridiculous Microsoft craziness.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L159" data-line-number="159"></td>
          <td id="file-microsoft_craziness-h-LC159">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L160" data-line-number="160"></td>
          <td id="file-microsoft_craziness-h-LC160">#<span>undef</span>  INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L161" data-line-number="161"></td>
          <td id="file-microsoft_craziness-h-LC161">#<span>define</span> <span>INTERFACE</span> ISetupInstance</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L162" data-line-number="162"></td>
          <td id="file-microsoft_craziness-h-LC162"><span>DECLARE_INTERFACE_</span> (ISetupInstance, IUnknown)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L163" data-line-number="163"></td>
          <td id="file-microsoft_craziness-h-LC163">{</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L164" data-line-number="164"></td>
          <td id="file-microsoft_craziness-h-LC164">    BEGIN_INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L165" data-line-number="165"></td>
          <td id="file-microsoft_craziness-h-LC165">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L166" data-line-number="166"></td>
          <td id="file-microsoft_craziness-h-LC166">    <span><span>//</span> IUnknown methods</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L167" data-line-number="167"></td>
          <td id="file-microsoft_craziness-h-LC167">    <span>STDMETHOD</span> (QueryInterface)   (THIS_  REFIID, <span>void</span> **) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L168" data-line-number="168"></td>
          <td id="file-microsoft_craziness-h-LC168">    <span>STDMETHOD_</span>(ULONG, AddRef)    (THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L169" data-line-number="169"></td>
          <td id="file-microsoft_craziness-h-LC169">    <span>STDMETHOD_</span>(ULONG, Release)   (THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L170" data-line-number="170"></td>
          <td id="file-microsoft_craziness-h-LC170">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L171" data-line-number="171"></td>
          <td id="file-microsoft_craziness-h-LC171">    <span><span>//</span> ISetupInstance methods</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L172" data-line-number="172"></td>
          <td id="file-microsoft_craziness-h-LC172">    <span>STDMETHOD</span>(GetInstanceId)(THIS_ _Out_ BSTR* pbstrInstanceId) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L173" data-line-number="173"></td>
          <td id="file-microsoft_craziness-h-LC173">    <span>STDMETHOD</span>(GetInstallDate)(THIS_ _Out_ LPFILETIME pInstallDate) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L174" data-line-number="174"></td>
          <td id="file-microsoft_craziness-h-LC174">    <span>STDMETHOD</span>(GetInstallationName)(THIS_ _Out_ BSTR* pbstrInstallationName) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L175" data-line-number="175"></td>
          <td id="file-microsoft_craziness-h-LC175">    <span>STDMETHOD</span>(GetInstallationPath)(THIS_ _Out_ BSTR* pbstrInstallationPath) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L176" data-line-number="176"></td>
          <td id="file-microsoft_craziness-h-LC176">    <span>STDMETHOD</span>(GetInstallationVersion)(THIS_ _Out_ BSTR* pbstrInstallationVersion) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L177" data-line-number="177"></td>
          <td id="file-microsoft_craziness-h-LC177">    <span>STDMETHOD</span>(GetDisplayName)(THIS_ _In_ LCID lcid, _Out_ BSTR* pbstrDisplayName) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L178" data-line-number="178"></td>
          <td id="file-microsoft_craziness-h-LC178">    <span>STDMETHOD</span>(GetDescription)(THIS_ _In_ LCID lcid, _Out_ BSTR* pbstrDescription) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L179" data-line-number="179"></td>
          <td id="file-microsoft_craziness-h-LC179">    <span>STDMETHOD</span>(ResolvePath)(THIS_ _In_opt_z_ LPCOLESTR pwszRelativePath, _Out_ BSTR* pbstrAbsolutePath) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L180" data-line-number="180"></td>
          <td id="file-microsoft_craziness-h-LC180">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L181" data-line-number="181"></td>
          <td id="file-microsoft_craziness-h-LC181">    END_INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L182" data-line-number="182"></td>
          <td id="file-microsoft_craziness-h-LC182">};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L183" data-line-number="183"></td>
          <td id="file-microsoft_craziness-h-LC183">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L184" data-line-number="184"></td>
          <td id="file-microsoft_craziness-h-LC184">#<span>undef</span>  INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L185" data-line-number="185"></td>
          <td id="file-microsoft_craziness-h-LC185">#<span>define</span> <span>INTERFACE</span> IEnumSetupInstances</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L186" data-line-number="186"></td>
          <td id="file-microsoft_craziness-h-LC186"><span>DECLARE_INTERFACE_</span> (IEnumSetupInstances, IUnknown)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L187" data-line-number="187"></td>
          <td id="file-microsoft_craziness-h-LC187">{</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L188" data-line-number="188"></td>
          <td id="file-microsoft_craziness-h-LC188">    BEGIN_INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L189" data-line-number="189"></td>
          <td id="file-microsoft_craziness-h-LC189">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L190" data-line-number="190"></td>
          <td id="file-microsoft_craziness-h-LC190">    <span><span>//</span> IUnknown methods</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L191" data-line-number="191"></td>
          <td id="file-microsoft_craziness-h-LC191">    <span>STDMETHOD</span> (QueryInterface)   (THIS_  REFIID, <span>void</span> **) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L192" data-line-number="192"></td>
          <td id="file-microsoft_craziness-h-LC192">    <span>STDMETHOD_</span>(ULONG, AddRef)    (THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L193" data-line-number="193"></td>
          <td id="file-microsoft_craziness-h-LC193">    <span>STDMETHOD_</span>(ULONG, Release)   (THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L194" data-line-number="194"></td>
          <td id="file-microsoft_craziness-h-LC194">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L195" data-line-number="195"></td>
          <td id="file-microsoft_craziness-h-LC195">    <span><span>//</span> IEnumSetupInstances methods</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L196" data-line-number="196"></td>
          <td id="file-microsoft_craziness-h-LC196">    <span>STDMETHOD</span>(Next)(THIS_ _In_ ULONG celt, <span>_Out_writes_to_</span>(celt, *pceltFetched) ISetupInstance** rgelt, _Out_opt_ <span>_Deref_out_range_</span>(<span>0</span>, celt) ULONG* pceltFetched) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L197" data-line-number="197"></td>
          <td id="file-microsoft_craziness-h-LC197">    <span>STDMETHOD</span>(Skip)(THIS_ _In_ ULONG celt) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L198" data-line-number="198"></td>
          <td id="file-microsoft_craziness-h-LC198">    <span>STDMETHOD</span>(Reset)(THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L199" data-line-number="199"></td>
          <td id="file-microsoft_craziness-h-LC199">    <span>STDMETHOD</span>(Clone)(THIS_ _Deref_out_opt_ IEnumSetupInstances** ppenum) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L200" data-line-number="200"></td>
          <td id="file-microsoft_craziness-h-LC200">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L201" data-line-number="201"></td>
          <td id="file-microsoft_craziness-h-LC201">    END_INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L202" data-line-number="202"></td>
          <td id="file-microsoft_craziness-h-LC202">};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L203" data-line-number="203"></td>
          <td id="file-microsoft_craziness-h-LC203">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L204" data-line-number="204"></td>
          <td id="file-microsoft_craziness-h-LC204">#<span>undef</span>  INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L205" data-line-number="205"></td>
          <td id="file-microsoft_craziness-h-LC205">#<span>define</span> <span>INTERFACE</span> ISetupConfiguration</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L206" data-line-number="206"></td>
          <td id="file-microsoft_craziness-h-LC206"><span>DECLARE_INTERFACE_</span> (ISetupConfiguration, IUnknown)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L207" data-line-number="207"></td>
          <td id="file-microsoft_craziness-h-LC207">{</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L208" data-line-number="208"></td>
          <td id="file-microsoft_craziness-h-LC208">    BEGIN_INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L209" data-line-number="209"></td>
          <td id="file-microsoft_craziness-h-LC209">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L210" data-line-number="210"></td>
          <td id="file-microsoft_craziness-h-LC210">    <span><span>//</span> IUnknown methods</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L211" data-line-number="211"></td>
          <td id="file-microsoft_craziness-h-LC211">    <span>STDMETHOD</span> (QueryInterface)   (THIS_  REFIID, <span>void</span> **) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L212" data-line-number="212"></td>
          <td id="file-microsoft_craziness-h-LC212">    <span>STDMETHOD_</span>(ULONG, AddRef)    (THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L213" data-line-number="213"></td>
          <td id="file-microsoft_craziness-h-LC213">    <span>STDMETHOD_</span>(ULONG, Release)   (THIS) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L214" data-line-number="214"></td>
          <td id="file-microsoft_craziness-h-LC214">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L215" data-line-number="215"></td>
          <td id="file-microsoft_craziness-h-LC215">    <span><span>//</span> ISetupConfiguration methods</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L216" data-line-number="216"></td>
          <td id="file-microsoft_craziness-h-LC216">    <span>STDMETHOD</span>(EnumInstances)(THIS_ _Out_ IEnumSetupInstances** ppEnumInstances) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L217" data-line-number="217"></td>
          <td id="file-microsoft_craziness-h-LC217">    <span>STDMETHOD</span>(GetInstanceForCurrentProcess)(THIS_ _Out_ ISetupInstance** ppInstance) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L218" data-line-number="218"></td>
          <td id="file-microsoft_craziness-h-LC218">    <span>STDMETHOD</span>(GetInstanceForPath)(THIS_ _In_z_ LPCWSTR wzPath, _Out_ ISetupInstance** ppInstance) PURE;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L219" data-line-number="219"></td>
          <td id="file-microsoft_craziness-h-LC219">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L220" data-line-number="220"></td>
          <td id="file-microsoft_craziness-h-LC220">    END_INTERFACE</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L221" data-line-number="221"></td>
          <td id="file-microsoft_craziness-h-LC221">};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L222" data-line-number="222"></td>
          <td id="file-microsoft_craziness-h-LC222">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L223" data-line-number="223"></td>
          <td id="file-microsoft_craziness-h-LC223">#<span>ifdef</span> __cplusplus</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L224" data-line-number="224"></td>
          <td id="file-microsoft_craziness-h-LC224">#<span>define</span> <span>CALL_STDMETHOD</span>(object, method, ...) object-&gt;<span>method</span>(__VA_ARGS__)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L225" data-line-number="225"></td>
          <td id="file-microsoft_craziness-h-LC225">#<span>define</span> <span>CALL_STDMETHOD_</span>(<span>object, method</span>) object-&gt;<span>method</span>()</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L226" data-line-number="226"></td>
          <td id="file-microsoft_craziness-h-LC226">#<span>else</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L227" data-line-number="227"></td>
          <td id="file-microsoft_craziness-h-LC227">#<span>define</span> <span>CALL_STDMETHOD</span>(object, method, ...) object-&gt;lpVtbl-&gt;<span>method</span>(object, __VA_ARGS__)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L228" data-line-number="228"></td>
          <td id="file-microsoft_craziness-h-LC228">#<span>define</span> <span>CALL_STDMETHOD_</span>(<span>object, method</span>) object-&gt;lpVtbl-&gt;<span>method</span>(object)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L229" data-line-number="229"></td>
          <td id="file-microsoft_craziness-h-LC229">#endif</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L230" data-line-number="230"></td>
          <td id="file-microsoft_craziness-h-LC230">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L231" data-line-number="231"></td>
          <td id="file-microsoft_craziness-h-LC231">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L232" data-line-number="232"></td>
          <td id="file-microsoft_craziness-h-LC232"><span><span>//</span> The beginning of the actual code that does things.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L233" data-line-number="233"></td>
          <td id="file-microsoft_craziness-h-LC233">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L234" data-line-number="234"></td>
          <td id="file-microsoft_craziness-h-LC234"><span>typedef</span> <span>struct</span> {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L235" data-line-number="235"></td>
          <td id="file-microsoft_craziness-h-LC235">    <span>int32_t</span> best_version[<span>4</span>];  <span><span>//</span> For Windows 8 versions, only two of these numbers are used.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L236" data-line-number="236"></td>
          <td id="file-microsoft_craziness-h-LC236">    <span>wchar_t</span> *best_name;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L237" data-line-number="237"></td>
          <td id="file-microsoft_craziness-h-LC237">} Version_Data;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L238" data-line-number="238"></td>
          <td id="file-microsoft_craziness-h-LC238">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L239" data-line-number="239"></td>
          <td id="file-microsoft_craziness-h-LC239"><span>bool</span> <span>os_file_exists</span>(<span>wchar_t</span> *name) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L240" data-line-number="240"></td>
          <td id="file-microsoft_craziness-h-LC240">    <span><span>//</span> @Robustness: What flags do we really want to check here?</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L241" data-line-number="241"></td>
          <td id="file-microsoft_craziness-h-LC241">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L242" data-line-number="242"></td>
          <td id="file-microsoft_craziness-h-LC242">    <span>auto</span> attrib = <span>GetFileAttributesW</span>(name);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L243" data-line-number="243"></td>
          <td id="file-microsoft_craziness-h-LC243">    <span>if</span> (attrib == INVALID_FILE_ATTRIBUTES) <span>return</span> <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L244" data-line-number="244"></td>
          <td id="file-microsoft_craziness-h-LC244">    <span>if</span> (attrib &amp; FILE_ATTRIBUTE_DIRECTORY) <span>return</span> <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L245" data-line-number="245"></td>
          <td id="file-microsoft_craziness-h-LC245">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L246" data-line-number="246"></td>
          <td id="file-microsoft_craziness-h-LC246">    <span>return</span> <span>true</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L247" data-line-number="247"></td>
          <td id="file-microsoft_craziness-h-LC247">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L248" data-line-number="248"></td>
          <td id="file-microsoft_craziness-h-LC248">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L249" data-line-number="249"></td>
          <td id="file-microsoft_craziness-h-LC249">#<span>define</span> <span>concat2</span>(<span>a, b</span>) concat(a, b, <span>NULL</span>, <span>NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L250" data-line-number="250"></td>
          <td id="file-microsoft_craziness-h-LC250">#<span>define</span> <span>concat3</span>(<span>a, b, c</span>) concat(a, b, c, <span>NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L251" data-line-number="251"></td>
          <td id="file-microsoft_craziness-h-LC251">#<span>define</span> <span>concat4</span>(<span>a, b, c, d</span>) concat(a, b, c, d)</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L252" data-line-number="252"></td>
          <td id="file-microsoft_craziness-h-LC252"><span>wchar_t</span> *<span>concat</span>(<span>wchar_t</span> *a, <span>wchar_t</span> *b, <span>wchar_t</span> *c, <span>wchar_t</span> *d) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L253" data-line-number="253"></td>
          <td id="file-microsoft_craziness-h-LC253">    <span><span>//</span> Concatenate up to 4 wide strings together. Allocated with malloc.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L254" data-line-number="254"></td>
          <td id="file-microsoft_craziness-h-LC254">    <span><span>//</span> If you don&#39;t like that, use a programming language that actually</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L255" data-line-number="255"></td>
          <td id="file-microsoft_craziness-h-LC255">    <span><span>//</span> helps you with using custom allocators. Or just edit the code.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L256" data-line-number="256"></td>
          <td id="file-microsoft_craziness-h-LC256">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L257" data-line-number="257"></td>
          <td id="file-microsoft_craziness-h-LC257">    <span>auto</span> len_a = <span>wcslen</span>(a);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L258" data-line-number="258"></td>
          <td id="file-microsoft_craziness-h-LC258">    <span>auto</span> len_b = <span>wcslen</span>(b);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L259" data-line-number="259"></td>
          <td id="file-microsoft_craziness-h-LC259">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L260" data-line-number="260"></td>
          <td id="file-microsoft_craziness-h-LC260">    <span>auto</span> len_c = <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L261" data-line-number="261"></td>
          <td id="file-microsoft_craziness-h-LC261">    <span>if</span> (c) len_c = <span>wcslen</span>(c);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L262" data-line-number="262"></td>
          <td id="file-microsoft_craziness-h-LC262">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L263" data-line-number="263"></td>
          <td id="file-microsoft_craziness-h-LC263">    <span>auto</span> len_d = <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L264" data-line-number="264"></td>
          <td id="file-microsoft_craziness-h-LC264">    <span>if</span> (d) len_d = <span>wcslen</span>(d);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L265" data-line-number="265"></td>
          <td id="file-microsoft_craziness-h-LC265">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L266" data-line-number="266"></td>
          <td id="file-microsoft_craziness-h-LC266">    <span>wchar_t</span> *result = (<span>wchar_t</span> *)<span>malloc</span>((len_a + len_b + len_c + len_d + <span>1</span>) * <span>2</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L267" data-line-number="267"></td>
          <td id="file-microsoft_craziness-h-LC267">    <span>memcpy</span>(result, a, len_a*<span>2</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L268" data-line-number="268"></td>
          <td id="file-microsoft_craziness-h-LC268">    <span>memcpy</span>(result + len_a, b, len_b*<span>2</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L269" data-line-number="269"></td>
          <td id="file-microsoft_craziness-h-LC269">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L270" data-line-number="270"></td>
          <td id="file-microsoft_craziness-h-LC270">    <span>if</span> (c) <span>memcpy</span>(result + len_a + len_b, c, len_c * <span>2</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L271" data-line-number="271"></td>
          <td id="file-microsoft_craziness-h-LC271">    <span>if</span> (d) <span>memcpy</span>(result + len_a + len_b + len_c, d, len_d * <span>2</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L272" data-line-number="272"></td>
          <td id="file-microsoft_craziness-h-LC272">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L273" data-line-number="273"></td>
          <td id="file-microsoft_craziness-h-LC273">    result[len_a + len_b + len_c + len_d] = <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L274" data-line-number="274"></td>
          <td id="file-microsoft_craziness-h-LC274">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L275" data-line-number="275"></td>
          <td id="file-microsoft_craziness-h-LC275">    <span>return</span> result;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L276" data-line-number="276"></td>
          <td id="file-microsoft_craziness-h-LC276">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L277" data-line-number="277"></td>
          <td id="file-microsoft_craziness-h-LC277">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L278" data-line-number="278"></td>
          <td id="file-microsoft_craziness-h-LC278"><span>typedef</span> <span>void</span> (*Visit_Proc_W)(<span>wchar_t</span> *short_name, <span>wchar_t</span> *full_name, Version_Data *data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L279" data-line-number="279"></td>
          <td id="file-microsoft_craziness-h-LC279"><span>bool</span> <span>visit_files_w</span>(<span>wchar_t</span> *dir_name, Version_Data *data, Visit_Proc_W proc) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L280" data-line-number="280"></td>
          <td id="file-microsoft_craziness-h-LC280">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L281" data-line-number="281"></td>
          <td id="file-microsoft_craziness-h-LC281">    <span><span>//</span> Visit everything in one folder (non-recursively). If it&#39;s a directory</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L282" data-line-number="282"></td>
          <td id="file-microsoft_craziness-h-LC282">    <span><span>//</span> that doesn&#39;t start with &#34;.&#34;, call the visit proc on it. The visit proc</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L283" data-line-number="283"></td>
          <td id="file-microsoft_craziness-h-LC283">    <span><span>//</span> will see if the filename conforms to the expected versioning pattern.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L284" data-line-number="284"></td>
          <td id="file-microsoft_craziness-h-LC284">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L285" data-line-number="285"></td>
          <td id="file-microsoft_craziness-h-LC285">    WIN32_FIND_DATAW find_data;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L286" data-line-number="286"></td>
          <td id="file-microsoft_craziness-h-LC286">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L287" data-line-number="287"></td>
          <td id="file-microsoft_craziness-h-LC287">    <span>wchar_t</span> *wildcard_name = <span>concat2</span>(dir_name, L<span><span>&#34;</span><span>\\</span>*<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L288" data-line-number="288"></td>
          <td id="file-microsoft_craziness-h-LC288">    HANDLE handle = <span>FindFirstFileW</span>(wildcard_name, &amp;find_data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L289" data-line-number="289"></td>
          <td id="file-microsoft_craziness-h-LC289">    <span>free</span>(wildcard_name);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L290" data-line-number="290"></td>
          <td id="file-microsoft_craziness-h-LC290">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L291" data-line-number="291"></td>
          <td id="file-microsoft_craziness-h-LC291">    <span>if</span> (handle == INVALID_HANDLE_VALUE) <span>return</span> <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L292" data-line-number="292"></td>
          <td id="file-microsoft_craziness-h-LC292">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L293" data-line-number="293"></td>
          <td id="file-microsoft_craziness-h-LC293">    <span>while</span> (<span>true</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L294" data-line-number="294"></td>
          <td id="file-microsoft_craziness-h-LC294">        <span>if</span> ((find_data.<span>dwFileAttributes</span> &amp; FILE_ATTRIBUTE_DIRECTORY) &amp;&amp; (find_data.<span>cFileName</span>[<span>0</span>] != <span><span>&#39;</span>.<span>&#39;</span></span>)) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L295" data-line-number="295"></td>
          <td id="file-microsoft_craziness-h-LC295">            <span>wchar_t</span> *full_name = <span>concat3</span>(dir_name, L<span><span>&#34;</span><span>\\</span><span>&#34;</span></span>, find_data.<span>cFileName</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L296" data-line-number="296"></td>
          <td id="file-microsoft_craziness-h-LC296">            <span>proc</span>(find_data.<span>cFileName</span>, full_name, data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L297" data-line-number="297"></td>
          <td id="file-microsoft_craziness-h-LC297">            <span>free</span>(full_name);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L298" data-line-number="298"></td>
          <td id="file-microsoft_craziness-h-LC298">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L299" data-line-number="299"></td>
          <td id="file-microsoft_craziness-h-LC299">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L300" data-line-number="300"></td>
          <td id="file-microsoft_craziness-h-LC300">        BOOL success = <span>FindNextFileW</span>(handle, &amp;find_data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L301" data-line-number="301"></td>
          <td id="file-microsoft_craziness-h-LC301">        <span>if</span> (!success) <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L302" data-line-number="302"></td>
          <td id="file-microsoft_craziness-h-LC302">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L303" data-line-number="303"></td>
          <td id="file-microsoft_craziness-h-LC303">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L304" data-line-number="304"></td>
          <td id="file-microsoft_craziness-h-LC304">    <span>FindClose</span>(handle);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L305" data-line-number="305"></td>
          <td id="file-microsoft_craziness-h-LC305">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L306" data-line-number="306"></td>
          <td id="file-microsoft_craziness-h-LC306">    <span>return</span> <span>true</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L307" data-line-number="307"></td>
          <td id="file-microsoft_craziness-h-LC307">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L308" data-line-number="308"></td>
          <td id="file-microsoft_craziness-h-LC308">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L309" data-line-number="309"></td>
          <td id="file-microsoft_craziness-h-LC309">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L310" data-line-number="310"></td>
          <td id="file-microsoft_craziness-h-LC310"><span>wchar_t</span> *<span>find_windows_kit_root_with_key</span>(HKEY key, <span>wchar_t</span> *version) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L311" data-line-number="311"></td>
          <td id="file-microsoft_craziness-h-LC311">    <span><span>//</span> Given a key to an already opened registry entry,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L312" data-line-number="312"></td>
          <td id="file-microsoft_craziness-h-LC312">    <span><span>//</span> get the value stored under the &#39;version&#39; subkey.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L313" data-line-number="313"></td>
          <td id="file-microsoft_craziness-h-LC313">    <span><span>//</span> If that&#39;s not the right terminology, hey, I never do registry stuff.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L314" data-line-number="314"></td>
          <td id="file-microsoft_craziness-h-LC314">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L315" data-line-number="315"></td>
          <td id="file-microsoft_craziness-h-LC315">    DWORD required_length;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L316" data-line-number="316"></td>
          <td id="file-microsoft_craziness-h-LC316">    <span>auto</span> rc = <span>RegQueryValueExW</span>(key, version, <span>NULL</span>, <span>NULL</span>, <span>NULL</span>, &amp;required_length);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L317" data-line-number="317"></td>
          <td id="file-microsoft_craziness-h-LC317">    <span>if</span> (rc != <span>0</span>)  <span>return</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L318" data-line-number="318"></td>
          <td id="file-microsoft_craziness-h-LC318">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L319" data-line-number="319"></td>
          <td id="file-microsoft_craziness-h-LC319">    DWORD length = required_length + <span>2</span>;  <span><span>//</span> The +2 is for the maybe optional zero later on. Probably we are over-allocating.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L320" data-line-number="320"></td>
          <td id="file-microsoft_craziness-h-LC320">    <span>wchar_t</span> *value = (<span>wchar_t</span> *)<span>malloc</span>(length);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L321" data-line-number="321"></td>
          <td id="file-microsoft_craziness-h-LC321">    <span>if</span> (!value) <span>return</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L322" data-line-number="322"></td>
          <td id="file-microsoft_craziness-h-LC322">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L323" data-line-number="323"></td>
          <td id="file-microsoft_craziness-h-LC323">    rc = <span>RegQueryValueExW</span>(key, version, <span>NULL</span>, <span>NULL</span>, (LPBYTE)value, &amp;length);  <span><span>//</span> We know that version is zero-terminated...</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L324" data-line-number="324"></td>
          <td id="file-microsoft_craziness-h-LC324">    <span>if</span> (rc != <span>0</span>)  <span>return</span> <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L325" data-line-number="325"></td>
          <td id="file-microsoft_craziness-h-LC325">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L326" data-line-number="326"></td>
          <td id="file-microsoft_craziness-h-LC326">    <span><span>//</span> The documentation says that if the string for some reason was not stored</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L327" data-line-number="327"></td>
          <td id="file-microsoft_craziness-h-LC327">    <span><span>//</span> with zero-termination, we need to manually terminate it. Sigh!!</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L328" data-line-number="328"></td>
          <td id="file-microsoft_craziness-h-LC328">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L329" data-line-number="329"></td>
          <td id="file-microsoft_craziness-h-LC329">    <span>if</span> (value[length]) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L330" data-line-number="330"></td>
          <td id="file-microsoft_craziness-h-LC330">        value[length+<span>1</span>] = <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L331" data-line-number="331"></td>
          <td id="file-microsoft_craziness-h-LC331">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L332" data-line-number="332"></td>
          <td id="file-microsoft_craziness-h-LC332">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L333" data-line-number="333"></td>
          <td id="file-microsoft_craziness-h-LC333">    <span>return</span> value;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L334" data-line-number="334"></td>
          <td id="file-microsoft_craziness-h-LC334">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L335" data-line-number="335"></td>
          <td id="file-microsoft_craziness-h-LC335">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L336" data-line-number="336"></td>
          <td id="file-microsoft_craziness-h-LC336"><span>void</span> <span>win10_best</span>(<span>wchar_t</span> *short_name, <span>wchar_t</span> *full_name, Version_Data *data) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L337" data-line-number="337"></td>
          <td id="file-microsoft_craziness-h-LC337">    <span><span>//</span> Find the Windows 10 subdirectory with the highest version number.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L338" data-line-number="338"></td>
          <td id="file-microsoft_craziness-h-LC338">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L339" data-line-number="339"></td>
          <td id="file-microsoft_craziness-h-LC339">    <span>int</span> i0, i1, i2, i3;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L340" data-line-number="340"></td>
          <td id="file-microsoft_craziness-h-LC340">    <span>auto</span> success = <span>swscanf_s</span>(short_name, L<span><span>&#34;</span><span>%d</span>.<span>%d</span>.<span>%d</span>.<span>%d</span><span>&#34;</span></span>, &amp;i0, &amp;i1, &amp;i2, &amp;i3);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L341" data-line-number="341"></td>
          <td id="file-microsoft_craziness-h-LC341">    <span>if</span> (success &lt; <span>4</span>) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L342" data-line-number="342"></td>
          <td id="file-microsoft_craziness-h-LC342">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L343" data-line-number="343"></td>
          <td id="file-microsoft_craziness-h-LC343">    <span>if</span> (i0 &lt; data-&gt;<span>best_version</span>[<span>0</span>]) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L344" data-line-number="344"></td>
          <td id="file-microsoft_craziness-h-LC344">    <span>else</span> <span>if</span> (i0 == data-&gt;<span>best_version</span>[<span>0</span>]) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L345" data-line-number="345"></td>
          <td id="file-microsoft_craziness-h-LC345">        <span>if</span> (i1 &lt; data-&gt;<span>best_version</span>[<span>1</span>]) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L346" data-line-number="346"></td>
          <td id="file-microsoft_craziness-h-LC346">        <span>else</span> <span>if</span> (i1 == data-&gt;<span>best_version</span>[<span>1</span>]) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L347" data-line-number="347"></td>
          <td id="file-microsoft_craziness-h-LC347">            <span>if</span> (i2 &lt; data-&gt;<span>best_version</span>[<span>2</span>]) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L348" data-line-number="348"></td>
          <td id="file-microsoft_craziness-h-LC348">            <span>else</span> <span>if</span> (i2 == data-&gt;<span>best_version</span>[<span>2</span>]) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L349" data-line-number="349"></td>
          <td id="file-microsoft_craziness-h-LC349">                <span>if</span> (i3 &lt; data-&gt;<span>best_version</span>[<span>3</span>]) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L350" data-line-number="350"></td>
          <td id="file-microsoft_craziness-h-LC350">            }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L351" data-line-number="351"></td>
          <td id="file-microsoft_craziness-h-LC351">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L352" data-line-number="352"></td>
          <td id="file-microsoft_craziness-h-LC352">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L353" data-line-number="353"></td>
          <td id="file-microsoft_craziness-h-LC353">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L354" data-line-number="354"></td>
          <td id="file-microsoft_craziness-h-LC354">    <span><span>//</span> we have to copy_string and free here because visit_files free&#39;s the full_name string</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L355" data-line-number="355"></td>
          <td id="file-microsoft_craziness-h-LC355">    <span><span>//</span> after we execute this function, so Win*_Data would contain an invalid pointer.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L356" data-line-number="356"></td>
          <td id="file-microsoft_craziness-h-LC356">    <span>if</span> (data-&gt;<span>best_name</span>) <span>free</span>(data-&gt;<span>best_name</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L357" data-line-number="357"></td>
          <td id="file-microsoft_craziness-h-LC357">    data-&gt;<span>best_name</span> = <span>_wcsdup</span>(full_name);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L358" data-line-number="358"></td>
          <td id="file-microsoft_craziness-h-LC358">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L359" data-line-number="359"></td>
          <td id="file-microsoft_craziness-h-LC359">    <span>if</span> (data-&gt;<span>best_name</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L360" data-line-number="360"></td>
          <td id="file-microsoft_craziness-h-LC360">        data-&gt;<span>best_version</span>[<span>0</span>] = i0;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L361" data-line-number="361"></td>
          <td id="file-microsoft_craziness-h-LC361">        data-&gt;<span>best_version</span>[<span>1</span>] = i1;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L362" data-line-number="362"></td>
          <td id="file-microsoft_craziness-h-LC362">        data-&gt;<span>best_version</span>[<span>2</span>] = i2;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L363" data-line-number="363"></td>
          <td id="file-microsoft_craziness-h-LC363">        data-&gt;<span>best_version</span>[<span>3</span>] = i3;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L364" data-line-number="364"></td>
          <td id="file-microsoft_craziness-h-LC364">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L365" data-line-number="365"></td>
          <td id="file-microsoft_craziness-h-LC365">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L366" data-line-number="366"></td>
          <td id="file-microsoft_craziness-h-LC366">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L367" data-line-number="367"></td>
          <td id="file-microsoft_craziness-h-LC367"><span>void</span> <span>win8_best</span>(<span>wchar_t</span> *short_name, <span>wchar_t</span> *full_name, Version_Data *data) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L368" data-line-number="368"></td>
          <td id="file-microsoft_craziness-h-LC368">    <span><span>//</span> Find the Windows 8 subdirectory with the highest version number.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L369" data-line-number="369"></td>
          <td id="file-microsoft_craziness-h-LC369">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L370" data-line-number="370"></td>
          <td id="file-microsoft_craziness-h-LC370">    <span>int</span> i0, i1;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L371" data-line-number="371"></td>
          <td id="file-microsoft_craziness-h-LC371">    <span>auto</span> success = <span>swscanf_s</span>(short_name, L<span><span>&#34;</span>winv<span>%d</span>.<span>%d</span><span>&#34;</span></span>, &amp;i0, &amp;i1);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L372" data-line-number="372"></td>
          <td id="file-microsoft_craziness-h-LC372">    <span>if</span> (success &lt; <span>2</span>) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L373" data-line-number="373"></td>
          <td id="file-microsoft_craziness-h-LC373">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L374" data-line-number="374"></td>
          <td id="file-microsoft_craziness-h-LC374">    <span>if</span> (i0 &lt; data-&gt;<span>best_version</span>[<span>0</span>]) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L375" data-line-number="375"></td>
          <td id="file-microsoft_craziness-h-LC375">    <span>else</span> <span>if</span> (i0 == data-&gt;<span>best_version</span>[<span>0</span>]) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L376" data-line-number="376"></td>
          <td id="file-microsoft_craziness-h-LC376">        <span>if</span> (i1 &lt; data-&gt;<span>best_version</span>[<span>1</span>]) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L377" data-line-number="377"></td>
          <td id="file-microsoft_craziness-h-LC377">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L378" data-line-number="378"></td>
          <td id="file-microsoft_craziness-h-LC378">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L379" data-line-number="379"></td>
          <td id="file-microsoft_craziness-h-LC379">    <span><span>//</span> we have to copy_string and free here because visit_files free&#39;s the full_name string</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L380" data-line-number="380"></td>
          <td id="file-microsoft_craziness-h-LC380">    <span><span>//</span> after we execute this function, so Win*_Data would contain an invalid pointer.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L381" data-line-number="381"></td>
          <td id="file-microsoft_craziness-h-LC381">    <span>if</span> (data-&gt;<span>best_name</span>) <span>free</span>(data-&gt;<span>best_name</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L382" data-line-number="382"></td>
          <td id="file-microsoft_craziness-h-LC382">    data-&gt;<span>best_name</span> = <span>_wcsdup</span>(full_name);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L383" data-line-number="383"></td>
          <td id="file-microsoft_craziness-h-LC383">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L384" data-line-number="384"></td>
          <td id="file-microsoft_craziness-h-LC384">    <span>if</span> (data-&gt;<span>best_name</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L385" data-line-number="385"></td>
          <td id="file-microsoft_craziness-h-LC385">        data-&gt;<span>best_version</span>[<span>0</span>] = i0;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L386" data-line-number="386"></td>
          <td id="file-microsoft_craziness-h-LC386">        data-&gt;<span>best_version</span>[<span>1</span>] = i1;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L387" data-line-number="387"></td>
          <td id="file-microsoft_craziness-h-LC387">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L388" data-line-number="388"></td>
          <td id="file-microsoft_craziness-h-LC388">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L389" data-line-number="389"></td>
          <td id="file-microsoft_craziness-h-LC389">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L390" data-line-number="390"></td>
          <td id="file-microsoft_craziness-h-LC390"><span>void</span> <span>find_windows_kit_root</span>(Find_Result *result) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L391" data-line-number="391"></td>
          <td id="file-microsoft_craziness-h-LC391">    <span><span>//</span> Information about the Windows 10 and Windows 8 development kits</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L392" data-line-number="392"></td>
          <td id="file-microsoft_craziness-h-LC392">    <span><span>//</span> is stored in the same place in the registry. We open a key</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L393" data-line-number="393"></td>
          <td id="file-microsoft_craziness-h-LC393">    <span><span>//</span> to that place, first checking preferntially for a Windows 10 kit,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L394" data-line-number="394"></td>
          <td id="file-microsoft_craziness-h-LC394">    <span><span>//</span> then, if that&#39;s not found, a Windows 8 kit.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L395" data-line-number="395"></td>
          <td id="file-microsoft_craziness-h-LC395">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L396" data-line-number="396"></td>
          <td id="file-microsoft_craziness-h-LC396">    HKEY main_key;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L397" data-line-number="397"></td>
          <td id="file-microsoft_craziness-h-LC397">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L398" data-line-number="398"></td>
          <td id="file-microsoft_craziness-h-LC398">    LSTATUS rc = <span>RegOpenKeyExA</span>(HKEY_LOCAL_MACHINE, <span><span>&#34;</span>SOFTWARE<span>\\</span>Microsoft<span>\\</span>Windows Kits<span>\\</span>Installed Roots<span>&#34;</span></span>,</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L399" data-line-number="399"></td>
          <td id="file-microsoft_craziness-h-LC399">                               <span>0</span>, KEY_QUERY_VALUE | KEY_WOW64_32KEY | KEY_ENUMERATE_SUB_KEYS, &amp;main_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L400" data-line-number="400"></td>
          <td id="file-microsoft_craziness-h-LC400">    <span>if</span> (rc != S_OK) <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L401" data-line-number="401"></td>
          <td id="file-microsoft_craziness-h-LC401">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L402" data-line-number="402"></td>
          <td id="file-microsoft_craziness-h-LC402">    <span><span>//</span> Look for a Windows 10 entry.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L403" data-line-number="403"></td>
          <td id="file-microsoft_craziness-h-LC403">    <span>wchar_t</span> *windows10_root = <span>find_windows_kit_root_with_key</span>(main_key, L<span><span>&#34;</span>KitsRoot10<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L404" data-line-number="404"></td>
          <td id="file-microsoft_craziness-h-LC404">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L405" data-line-number="405"></td>
          <td id="file-microsoft_craziness-h-LC405">    <span>if</span> (windows10_root) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L406" data-line-number="406"></td>
          <td id="file-microsoft_craziness-h-LC406">        <span>wchar_t</span> *windows10_lib = <span>concat2</span>(windows10_root, L<span><span>&#34;</span>Lib<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L407" data-line-number="407"></td>
          <td id="file-microsoft_craziness-h-LC407">        <span>free</span>(windows10_root);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L408" data-line-number="408"></td>
          <td id="file-microsoft_craziness-h-LC408">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L409" data-line-number="409"></td>
          <td id="file-microsoft_craziness-h-LC409">        Version_Data data = {<span>0</span>};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L410" data-line-number="410"></td>
          <td id="file-microsoft_craziness-h-LC410">        <span>visit_files_w</span>(windows10_lib, &amp;data, win10_best);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L411" data-line-number="411"></td>
          <td id="file-microsoft_craziness-h-LC411">        <span>free</span>(windows10_lib);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L412" data-line-number="412"></td>
          <td id="file-microsoft_craziness-h-LC412">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L413" data-line-number="413"></td>
          <td id="file-microsoft_craziness-h-LC413">        <span>if</span> (data.<span>best_name</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L414" data-line-number="414"></td>
          <td id="file-microsoft_craziness-h-LC414">            result-&gt;<span>windows_sdk_version</span> = <span>10</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L415" data-line-number="415"></td>
          <td id="file-microsoft_craziness-h-LC415">            result-&gt;<span>windows_sdk_root</span> = data.<span>best_name</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L416" data-line-number="416"></td>
          <td id="file-microsoft_craziness-h-LC416">            <span>RegCloseKey</span>(main_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L417" data-line-number="417"></td>
          <td id="file-microsoft_craziness-h-LC417">            <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L418" data-line-number="418"></td>
          <td id="file-microsoft_craziness-h-LC418">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L419" data-line-number="419"></td>
          <td id="file-microsoft_craziness-h-LC419">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L420" data-line-number="420"></td>
          <td id="file-microsoft_craziness-h-LC420">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L421" data-line-number="421"></td>
          <td id="file-microsoft_craziness-h-LC421">    <span><span>//</span> Look for a Windows 8 entry.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L422" data-line-number="422"></td>
          <td id="file-microsoft_craziness-h-LC422">    <span>wchar_t</span> *windows8_root = <span>find_windows_kit_root_with_key</span>(main_key, L<span><span>&#34;</span>KitsRoot81<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L423" data-line-number="423"></td>
          <td id="file-microsoft_craziness-h-LC423">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L424" data-line-number="424"></td>
          <td id="file-microsoft_craziness-h-LC424">    <span>if</span> (windows8_root) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L425" data-line-number="425"></td>
          <td id="file-microsoft_craziness-h-LC425">        <span>wchar_t</span> *windows8_lib = <span>concat2</span>(windows8_root, L<span><span>&#34;</span>Lib<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L426" data-line-number="426"></td>
          <td id="file-microsoft_craziness-h-LC426">        <span>free</span>(windows8_root);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L427" data-line-number="427"></td>
          <td id="file-microsoft_craziness-h-LC427">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L428" data-line-number="428"></td>
          <td id="file-microsoft_craziness-h-LC428">        Version_Data data = {<span>0</span>};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L429" data-line-number="429"></td>
          <td id="file-microsoft_craziness-h-LC429">        <span>visit_files_w</span>(windows8_lib, &amp;data, win8_best);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L430" data-line-number="430"></td>
          <td id="file-microsoft_craziness-h-LC430">        <span>free</span>(windows8_lib);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L431" data-line-number="431"></td>
          <td id="file-microsoft_craziness-h-LC431">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L432" data-line-number="432"></td>
          <td id="file-microsoft_craziness-h-LC432">        <span>if</span> (data.<span>best_name</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L433" data-line-number="433"></td>
          <td id="file-microsoft_craziness-h-LC433">            result-&gt;<span>windows_sdk_version</span> = <span>8</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L434" data-line-number="434"></td>
          <td id="file-microsoft_craziness-h-LC434">            result-&gt;<span>windows_sdk_root</span> = data.<span>best_name</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L435" data-line-number="435"></td>
          <td id="file-microsoft_craziness-h-LC435">            <span>RegCloseKey</span>(main_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L436" data-line-number="436"></td>
          <td id="file-microsoft_craziness-h-LC436">            <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L437" data-line-number="437"></td>
          <td id="file-microsoft_craziness-h-LC437">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L438" data-line-number="438"></td>
          <td id="file-microsoft_craziness-h-LC438">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L439" data-line-number="439"></td>
          <td id="file-microsoft_craziness-h-LC439">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L440" data-line-number="440"></td>
          <td id="file-microsoft_craziness-h-LC440">    <span><span>//</span> If we get here, we failed to find anything.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L441" data-line-number="441"></td>
          <td id="file-microsoft_craziness-h-LC441">    <span>RegCloseKey</span>(main_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L442" data-line-number="442"></td>
          <td id="file-microsoft_craziness-h-LC442">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L443" data-line-number="443"></td>
          <td id="file-microsoft_craziness-h-LC443">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L444" data-line-number="444"></td>
          <td id="file-microsoft_craziness-h-LC444"><span>bool</span> <span>find_visual_studio_2017_by_fighting_through_microsoft_craziness</span>(Find_Result *result) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L445" data-line-number="445"></td>
          <td id="file-microsoft_craziness-h-LC445">    HRESULT rc = <span>CoInitialize</span>(<span>NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L446" data-line-number="446"></td>
          <td id="file-microsoft_craziness-h-LC446">    <span><span>//</span> &#34;Subsequent valid calls return false.&#34; So ignore false.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L447" data-line-number="447"></td>
          <td id="file-microsoft_craziness-h-LC447">    <span><span>//</span> if rc != S_OK  return false;</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L448" data-line-number="448"></td>
          <td id="file-microsoft_craziness-h-LC448">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L449" data-line-number="449"></td>
          <td id="file-microsoft_craziness-h-LC449">    GUID my_uid                   = {<span>0x42843719</span>, <span>0xDB4C</span>, <span>0x46C2</span>, {<span>0x8E</span>, <span>0x7C</span>, <span>0x64</span>, <span>0xF1</span>, <span>0x81</span>, <span>0x6E</span>, <span>0xFD</span>, <span>0x5B</span>}};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L450" data-line-number="450"></td>
          <td id="file-microsoft_craziness-h-LC450">    GUID CLSID_SetupConfiguration = {<span>0x177F0C4A</span>, <span>0x1CD3</span>, <span>0x4DE7</span>, {<span>0xA3</span>, <span>0x2C</span>, <span>0x71</span>, <span>0xDB</span>, <span>0xBB</span>, <span>0x9F</span>, <span>0xA3</span>, <span>0x6D</span>}};</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L451" data-line-number="451"></td>
          <td id="file-microsoft_craziness-h-LC451">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L452" data-line-number="452"></td>
          <td id="file-microsoft_craziness-h-LC452">    ISetupConfiguration *config = <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L453" data-line-number="453"></td>
          <td id="file-microsoft_craziness-h-LC453">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L454" data-line-number="454"></td>
          <td id="file-microsoft_craziness-h-LC454">    <span><span>//</span> NOTE(Kalinovcic): This is so stupid... These functions take references, so the code is different for C and C++......</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L455" data-line-number="455"></td>
          <td id="file-microsoft_craziness-h-LC455">#<span>ifdef</span> __cplusplus</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L456" data-line-number="456"></td>
          <td id="file-microsoft_craziness-h-LC456">    HRESULT hr = <span>CoCreateInstance</span>(CLSID_SetupConfiguration, <span>NULL</span>, CLSCTX_INPROC_SERVER, my_uid, (<span>void</span> **)&amp;config);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L457" data-line-number="457"></td>
          <td id="file-microsoft_craziness-h-LC457">#<span>else</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L458" data-line-number="458"></td>
          <td id="file-microsoft_craziness-h-LC458">    HRESULT hr = <span>CoCreateInstance</span>(&amp;CLSID_SetupConfiguration, <span>NULL</span>, CLSCTX_INPROC_SERVER, &amp;my_uid, (<span>void</span> **)&amp;config);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L459" data-line-number="459"></td>
          <td id="file-microsoft_craziness-h-LC459">#<span>endif</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L460" data-line-number="460"></td>
          <td id="file-microsoft_craziness-h-LC460">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L461" data-line-number="461"></td>
          <td id="file-microsoft_craziness-h-LC461">    <span>if</span> (hr != <span>0</span>)  <span>return</span> <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L462" data-line-number="462"></td>
          <td id="file-microsoft_craziness-h-LC462">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L463" data-line-number="463"></td>
          <td id="file-microsoft_craziness-h-LC463">    IEnumSetupInstances *instances = <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L464" data-line-number="464"></td>
          <td id="file-microsoft_craziness-h-LC464">    hr = <span>CALL_STDMETHOD</span>(config, EnumInstances, &amp;instances);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L465" data-line-number="465"></td>
          <td id="file-microsoft_craziness-h-LC465">    <span>CALL_STDMETHOD_</span>(config, Release);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L466" data-line-number="466"></td>
          <td id="file-microsoft_craziness-h-LC466">    <span>if</span> (hr != <span>0</span>)     <span>return</span> <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L467" data-line-number="467"></td>
          <td id="file-microsoft_craziness-h-LC467">    <span>if</span> (!instances)  <span>return</span> <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L468" data-line-number="468"></td>
          <td id="file-microsoft_craziness-h-LC468">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L469" data-line-number="469"></td>
          <td id="file-microsoft_craziness-h-LC469">    <span>bool</span> found_visual_studio_2017 = <span>false</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L470" data-line-number="470"></td>
          <td id="file-microsoft_craziness-h-LC470">    <span>while</span> (<span>1</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L471" data-line-number="471"></td>
          <td id="file-microsoft_craziness-h-LC471">        ULONG found = <span>0</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L472" data-line-number="472"></td>
          <td id="file-microsoft_craziness-h-LC472">        ISetupInstance *instance = <span>NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L473" data-line-number="473"></td>
          <td id="file-microsoft_craziness-h-LC473">        HRESULT hr = <span>CALL_STDMETHOD</span>(instances, Next, <span>1</span>, &amp;instance, &amp;found);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L474" data-line-number="474"></td>
          <td id="file-microsoft_craziness-h-LC474">        <span>if</span> (hr != S_OK) <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L475" data-line-number="475"></td>
          <td id="file-microsoft_craziness-h-LC475">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L476" data-line-number="476"></td>
          <td id="file-microsoft_craziness-h-LC476">        BSTR bstr_inst_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L477" data-line-number="477"></td>
          <td id="file-microsoft_craziness-h-LC477">        hr = <span>CALL_STDMETHOD</span>(instance, GetInstallationPath, &amp;bstr_inst_path);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L478" data-line-number="478"></td>
          <td id="file-microsoft_craziness-h-LC478">        <span>CALL_STDMETHOD_</span>(instance, Release);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L479" data-line-number="479"></td>
          <td id="file-microsoft_craziness-h-LC479">        <span>if</span> (hr != S_OK)  <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L480" data-line-number="480"></td>
          <td id="file-microsoft_craziness-h-LC480">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L481" data-line-number="481"></td>
          <td id="file-microsoft_craziness-h-LC481">        <span>wchar_t</span> *tools_filename = <span>concat2</span>(bstr_inst_path, L<span><span>&#34;</span><span>\\</span>VC<span>\\</span>Auxiliary<span>\\</span>Build<span>\\</span>Microsoft.VCToolsVersion.default.txt<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L482" data-line-number="482"></td>
          <td id="file-microsoft_craziness-h-LC482">        <span>SysFreeString</span>(bstr_inst_path);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L483" data-line-number="483"></td>
          <td id="file-microsoft_craziness-h-LC483">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L484" data-line-number="484"></td>
          <td id="file-microsoft_craziness-h-LC484">        FILE *f;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L485" data-line-number="485"></td>
          <td id="file-microsoft_craziness-h-LC485">        <span>errno_t</span> open_result = <span>_wfopen_s</span>(&amp;f, tools_filename, L<span><span>&#34;</span>rt<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L486" data-line-number="486"></td>
          <td id="file-microsoft_craziness-h-LC486">        <span>free</span>(tools_filename);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L487" data-line-number="487"></td>
          <td id="file-microsoft_craziness-h-LC487">        <span>if</span> (open_result != <span>0</span>) <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L488" data-line-number="488"></td>
          <td id="file-microsoft_craziness-h-LC488">        <span>if</span> (!f) <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L489" data-line-number="489"></td>
          <td id="file-microsoft_craziness-h-LC489">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L490" data-line-number="490"></td>
          <td id="file-microsoft_craziness-h-LC490">        LARGE_INTEGER tools_file_size;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L491" data-line-number="491"></td>
          <td id="file-microsoft_craziness-h-LC491">        HANDLE file_handle = (HANDLE)<span>_get_osfhandle</span>(<span>_fileno</span>(f));</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L492" data-line-number="492"></td>
          <td id="file-microsoft_craziness-h-LC492">        BOOL success = <span>GetFileSizeEx</span>(file_handle, &amp;tools_file_size);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L493" data-line-number="493"></td>
          <td id="file-microsoft_craziness-h-LC493">        <span>if</span> (!success) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L494" data-line-number="494"></td>
          <td id="file-microsoft_craziness-h-LC494">            <span>fclose</span>(f);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L495" data-line-number="495"></td>
          <td id="file-microsoft_craziness-h-LC495">            <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L496" data-line-number="496"></td>
          <td id="file-microsoft_craziness-h-LC496">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L497" data-line-number="497"></td>
          <td id="file-microsoft_craziness-h-LC497">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L498" data-line-number="498"></td>
          <td id="file-microsoft_craziness-h-LC498">        <span>uint64_t</span> version_bytes = (tools_file_size.<span>QuadPart</span> + <span>1</span>) * <span>2</span>;  <span><span>//</span> Warning: This multiplication by 2 presumes there is no variable-length encoding in the wchars (wacky characters in the file could betray this expectation).</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L499" data-line-number="499"></td>
          <td id="file-microsoft_craziness-h-LC499">        <span>wchar_t</span> *version = (<span>wchar_t</span> *)<span>malloc</span>(version_bytes);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L500" data-line-number="500"></td>
          <td id="file-microsoft_craziness-h-LC500">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L501" data-line-number="501"></td>
          <td id="file-microsoft_craziness-h-LC501">        <span>wchar_t</span> *read_result = <span>fgetws</span>(version, version_bytes, f);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L502" data-line-number="502"></td>
          <td id="file-microsoft_craziness-h-LC502">        <span>fclose</span>(f);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L503" data-line-number="503"></td>
          <td id="file-microsoft_craziness-h-LC503">        <span>if</span> (!read_result) <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L504" data-line-number="504"></td>
          <td id="file-microsoft_craziness-h-LC504">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L505" data-line-number="505"></td>
          <td id="file-microsoft_craziness-h-LC505">        <span>wchar_t</span> *version_tail = <span>wcschr</span>(version, <span><span>&#39;</span><span>\n</span><span>&#39;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L506" data-line-number="506"></td>
          <td id="file-microsoft_craziness-h-LC506">        <span>if</span> (version_tail)  *version_tail = <span>0</span>;  <span><span>//</span> Stomp the data, because nobody cares about it.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L507" data-line-number="507"></td>
          <td id="file-microsoft_craziness-h-LC507">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L508" data-line-number="508"></td>
          <td id="file-microsoft_craziness-h-LC508">        <span>wchar_t</span> *library_path = <span>concat4</span>(bstr_inst_path, L<span><span>&#34;</span><span>\\</span>VC<span>\\</span>Tools<span>\\</span>MSVC<span>\\</span><span>&#34;</span></span>, version, L<span><span>&#34;</span><span>\\</span>lib<span>\\</span>x64<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L509" data-line-number="509"></td>
          <td id="file-microsoft_craziness-h-LC509">        <span>wchar_t</span> *library_file = <span>concat2</span>(library_path, L<span><span>&#34;</span><span>\\</span>vcruntime.lib<span>&#34;</span></span>);  <span><span>//</span> @Speed: Could have library_path point to this string, with a smaller count, to save on memory flailing!</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L510" data-line-number="510"></td>
          <td id="file-microsoft_craziness-h-LC510">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L511" data-line-number="511"></td>
          <td id="file-microsoft_craziness-h-LC511">        <span>if</span> (<span>os_file_exists</span>(library_file)) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L512" data-line-number="512"></td>
          <td id="file-microsoft_craziness-h-LC512">            <span>wchar_t</span> *link_exe_path = <span>concat4</span>(bstr_inst_path, L<span><span>&#34;</span><span>\\</span>VC<span>\\</span>Tools<span>\\</span>MSVC<span>\\</span><span>&#34;</span></span>, version, L<span><span>&#34;</span><span>\\</span>bin<span>\\</span>Hostx64<span>\\</span>x64<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L513" data-line-number="513"></td>
          <td id="file-microsoft_craziness-h-LC513">            <span>free</span>(version);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L514" data-line-number="514"></td>
          <td id="file-microsoft_craziness-h-LC514">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L515" data-line-number="515"></td>
          <td id="file-microsoft_craziness-h-LC515">            result-&gt;<span>vs_exe_path</span>     = link_exe_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L516" data-line-number="516"></td>
          <td id="file-microsoft_craziness-h-LC516">            result-&gt;<span>vs_library_path</span> = library_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L517" data-line-number="517"></td>
          <td id="file-microsoft_craziness-h-LC517">            found_visual_studio_2017 = <span>true</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L518" data-line-number="518"></td>
          <td id="file-microsoft_craziness-h-LC518">            <span>break</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L519" data-line-number="519"></td>
          <td id="file-microsoft_craziness-h-LC519">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L520" data-line-number="520"></td>
          <td id="file-microsoft_craziness-h-LC520">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L521" data-line-number="521"></td>
          <td id="file-microsoft_craziness-h-LC521">        <span>free</span>(version);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L522" data-line-number="522"></td>
          <td id="file-microsoft_craziness-h-LC522">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L523" data-line-number="523"></td>
          <td id="file-microsoft_craziness-h-LC523">        <span><span>/*</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L524" data-line-number="524"></td>
          <td id="file-microsoft_craziness-h-LC524"><span>           Ryan Saunderson said:</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L525" data-line-number="525"></td>
          <td id="file-microsoft_craziness-h-LC525"><span>           &#34;Clang uses the &#39;SetupInstance-&gt;GetInstallationVersion&#39; / ISetupHelper-&gt;ParseVersion to find the newest version</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L526" data-line-number="526"></td>
          <td id="file-microsoft_craziness-h-LC526"><span>           and then reads the tools file to define the tools path - which is definitely better than what i did.&#34;</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L527" data-line-number="527"></td>
          <td id="file-microsoft_craziness-h-LC527"><span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L528" data-line-number="528"></td>
          <td id="file-microsoft_craziness-h-LC528"><span>           So... @Incomplete: Should probably pick the newest version...</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L529" data-line-number="529"></td>
          <td id="file-microsoft_craziness-h-LC529"><span>        <span>*/</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L530" data-line-number="530"></td>
          <td id="file-microsoft_craziness-h-LC530">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L531" data-line-number="531"></td>
          <td id="file-microsoft_craziness-h-LC531">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L532" data-line-number="532"></td>
          <td id="file-microsoft_craziness-h-LC532">    <span>CALL_STDMETHOD_</span>(instances, Release);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L533" data-line-number="533"></td>
          <td id="file-microsoft_craziness-h-LC533">    <span>return</span> found_visual_studio_2017;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L534" data-line-number="534"></td>
          <td id="file-microsoft_craziness-h-LC534">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L535" data-line-number="535"></td>
          <td id="file-microsoft_craziness-h-LC535">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L536" data-line-number="536"></td>
          <td id="file-microsoft_craziness-h-LC536"><span>void</span> <span>find_visual_studio_by_fighting_through_microsoft_craziness</span>(Find_Result *result) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L537" data-line-number="537"></td>
          <td id="file-microsoft_craziness-h-LC537">    <span><span>//</span> The name of this procedure is kind of cryptic. Its purpose is</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L538" data-line-number="538"></td>
          <td id="file-microsoft_craziness-h-LC538">    <span><span>//</span> to fight through Microsoft craziness. The things that the fine</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L539" data-line-number="539"></td>
          <td id="file-microsoft_craziness-h-LC539">    <span><span>//</span> Visual Studio team want you to do, JUST TO FIND A SINGLE FOLDER</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L540" data-line-number="540"></td>
          <td id="file-microsoft_craziness-h-LC540">    <span><span>//</span> THAT EVERYONE NEEDS TO FIND, are ridiculous garbage.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L541" data-line-number="541"></td>
          <td id="file-microsoft_craziness-h-LC541">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L542" data-line-number="542"></td>
          <td id="file-microsoft_craziness-h-LC542">    <span><span>//</span> For earlier versions of Visual Studio, you&#39;d find this information in the registry,</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L543" data-line-number="543"></td>
          <td id="file-microsoft_craziness-h-LC543">    <span><span>//</span> similarly to the Windows Kits above. But no, now it&#39;s the future, so to ask the</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L544" data-line-number="544"></td>
          <td id="file-microsoft_craziness-h-LC544">    <span><span>//</span> question &#34;Where is the Visual Studio folder?&#34; you have to do a bunch of COM object</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L545" data-line-number="545"></td>
          <td id="file-microsoft_craziness-h-LC545">    <span><span>//</span> instantiation, enumeration, and querying. (For extra bonus points, try doing this in</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L546" data-line-number="546"></td>
          <td id="file-microsoft_craziness-h-LC546">    <span><span>//</span> a new, underdeveloped programming language where you don&#39;t have COM routines up</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L547" data-line-number="547"></td>
          <td id="file-microsoft_craziness-h-LC547">    <span><span>//</span> and running yet. So fun.)</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L548" data-line-number="548"></td>
          <td id="file-microsoft_craziness-h-LC548">    <span><span>//</span></span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L549" data-line-number="549"></td>
          <td id="file-microsoft_craziness-h-LC549">    <span><span>//</span> If all this COM object instantiation, enumeration, and querying doesn&#39;t give us</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L550" data-line-number="550"></td>
          <td id="file-microsoft_craziness-h-LC550">    <span><span>//</span> a useful result, we drop back to the registry-checking method.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L551" data-line-number="551"></td>
          <td id="file-microsoft_craziness-h-LC551">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L552" data-line-number="552"></td>
          <td id="file-microsoft_craziness-h-LC552">    <span>bool</span> found_visual_studio_2017 = <span>find_visual_studio_2017_by_fighting_through_microsoft_craziness</span>(result);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L553" data-line-number="553"></td>
          <td id="file-microsoft_craziness-h-LC553">    <span>if</span> (found_visual_studio_2017)  <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L554" data-line-number="554"></td>
          <td id="file-microsoft_craziness-h-LC554">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L555" data-line-number="555"></td>
          <td id="file-microsoft_craziness-h-LC555">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L556" data-line-number="556"></td>
          <td id="file-microsoft_craziness-h-LC556">    <span><span>//</span> If we get here, we didn&#39;t find Visual Studio 2017. Try earlier versions.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L557" data-line-number="557"></td>
          <td id="file-microsoft_craziness-h-LC557">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L558" data-line-number="558"></td>
          <td id="file-microsoft_craziness-h-LC558">    HKEY vs7_key;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L559" data-line-number="559"></td>
          <td id="file-microsoft_craziness-h-LC559">    HRESULT rc = <span>RegOpenKeyExA</span>(HKEY_LOCAL_MACHINE, <span><span>&#34;</span>SOFTWARE<span>\\</span>Microsoft<span>\\</span>VisualStudio<span>\\</span>SxS<span>\\</span>VS7<span>&#34;</span></span>, <span>0</span>, KEY_QUERY_VALUE | KEY_WOW64_32KEY, &amp;vs7_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L560" data-line-number="560"></td>
          <td id="file-microsoft_craziness-h-LC560">    <span>if</span> (rc != S_OK)  <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L561" data-line-number="561"></td>
          <td id="file-microsoft_craziness-h-LC561">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L562" data-line-number="562"></td>
          <td id="file-microsoft_craziness-h-LC562">    <span><span>//</span> Hardcoded search for 4 prior Visual Studio versions. Is there something better to do here?</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L563" data-line-number="563"></td>
          <td id="file-microsoft_craziness-h-LC563">    <span>wchar_t</span> *versions[] = { L<span><span>&#34;</span>14.0<span>&#34;</span></span>, L<span><span>&#34;</span>12.0<span>&#34;</span></span>, L<span><span>&#34;</span>11.0<span>&#34;</span></span>, L<span><span>&#34;</span>10.0<span>&#34;</span></span> };</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L564" data-line-number="564"></td>
          <td id="file-microsoft_craziness-h-LC564">    <span>const</span> <span>int</span> NUM_VERSIONS = <span>sizeof</span>(versions) / <span>sizeof</span>(versions[<span>0</span>]);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L565" data-line-number="565"></td>
          <td id="file-microsoft_craziness-h-LC565">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L566" data-line-number="566"></td>
          <td id="file-microsoft_craziness-h-LC566">    <span>for</span> (<span>int</span> i = <span>0</span>; i &lt; NUM_VERSIONS; i++) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L567" data-line-number="567"></td>
          <td id="file-microsoft_craziness-h-LC567">        <span>wchar_t</span> *v = versions[i];</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L568" data-line-number="568"></td>
          <td id="file-microsoft_craziness-h-LC568">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L569" data-line-number="569"></td>
          <td id="file-microsoft_craziness-h-LC569">        DWORD dw_type;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L570" data-line-number="570"></td>
          <td id="file-microsoft_craziness-h-LC570">        DWORD cb_data;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L571" data-line-number="571"></td>
          <td id="file-microsoft_craziness-h-LC571">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L572" data-line-number="572"></td>
          <td id="file-microsoft_craziness-h-LC572">        LSTATUS rc = <span>RegQueryValueExW</span>(vs7_key, v, <span>NULL</span>, &amp;dw_type, <span>NULL</span>, &amp;cb_data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L573" data-line-number="573"></td>
          <td id="file-microsoft_craziness-h-LC573">        <span>if</span> ((rc == ERROR_FILE_NOT_FOUND) || (dw_type != REG_SZ)) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L574" data-line-number="574"></td>
          <td id="file-microsoft_craziness-h-LC574">            <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L575" data-line-number="575"></td>
          <td id="file-microsoft_craziness-h-LC575">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L576" data-line-number="576"></td>
          <td id="file-microsoft_craziness-h-LC576">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L577" data-line-number="577"></td>
          <td id="file-microsoft_craziness-h-LC577">        <span>wchar_t</span> *buffer = (<span>wchar_t</span> *)<span>malloc</span>(cb_data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L578" data-line-number="578"></td>
          <td id="file-microsoft_craziness-h-LC578">        <span>if</span> (!buffer)  <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L579" data-line-number="579"></td>
          <td id="file-microsoft_craziness-h-LC579">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L580" data-line-number="580"></td>
          <td id="file-microsoft_craziness-h-LC580">        rc = <span>RegQueryValueExW</span>(vs7_key, v, <span>NULL</span>, <span>NULL</span>, (LPBYTE)buffer, &amp;cb_data);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L581" data-line-number="581"></td>
          <td id="file-microsoft_craziness-h-LC581">        <span>if</span> (rc != <span>0</span>)  <span>continue</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L582" data-line-number="582"></td>
          <td id="file-microsoft_craziness-h-LC582">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L583" data-line-number="583"></td>
          <td id="file-microsoft_craziness-h-LC583">        <span><span>//</span> @Robustness: Do the zero-termination thing suggested in the RegQueryValue docs?</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L584" data-line-number="584"></td>
          <td id="file-microsoft_craziness-h-LC584">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L585" data-line-number="585"></td>
          <td id="file-microsoft_craziness-h-LC585">        <span>wchar_t</span> *lib_path = <span>concat2</span>(buffer, L<span><span>&#34;</span>VC<span>\\</span>Lib<span>\\</span>amd64<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L586" data-line-number="586"></td>
          <td id="file-microsoft_craziness-h-LC586">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L587" data-line-number="587"></td>
          <td id="file-microsoft_craziness-h-LC587">        <span><span>//</span> Check to see whether a vcruntime.lib actually exists here.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L588" data-line-number="588"></td>
          <td id="file-microsoft_craziness-h-LC588">        <span>wchar_t</span> *vcruntime_filename = <span>concat2</span>(lib_path, L<span><span>&#34;</span><span>\\</span>vcruntime.lib<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L589" data-line-number="589"></td>
          <td id="file-microsoft_craziness-h-LC589">        <span>bool</span> vcruntime_exists = <span>os_file_exists</span>(vcruntime_filename);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L590" data-line-number="590"></td>
          <td id="file-microsoft_craziness-h-LC590">        <span>free</span>(vcruntime_filename);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L591" data-line-number="591"></td>
          <td id="file-microsoft_craziness-h-LC591">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L592" data-line-number="592"></td>
          <td id="file-microsoft_craziness-h-LC592">        <span>if</span> (vcruntime_exists) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L593" data-line-number="593"></td>
          <td id="file-microsoft_craziness-h-LC593">            result-&gt;<span>vs_exe_path</span>     = <span>concat2</span>(buffer, L<span><span>&#34;</span>VC<span>\\</span>bin<span>\\</span>amd64<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L594" data-line-number="594"></td>
          <td id="file-microsoft_craziness-h-LC594">            result-&gt;<span>vs_library_path</span> = lib_path;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L595" data-line-number="595"></td>
          <td id="file-microsoft_craziness-h-LC595">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L596" data-line-number="596"></td>
          <td id="file-microsoft_craziness-h-LC596">            <span>free</span>(buffer);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L597" data-line-number="597"></td>
          <td id="file-microsoft_craziness-h-LC597">            <span>RegCloseKey</span>(vs7_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L598" data-line-number="598"></td>
          <td id="file-microsoft_craziness-h-LC598">            <span>return</span>;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L599" data-line-number="599"></td>
          <td id="file-microsoft_craziness-h-LC599">        }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L600" data-line-number="600"></td>
          <td id="file-microsoft_craziness-h-LC600">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L601" data-line-number="601"></td>
          <td id="file-microsoft_craziness-h-LC601">        <span>free</span>(lib_path);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L602" data-line-number="602"></td>
          <td id="file-microsoft_craziness-h-LC602">        <span>free</span>(buffer);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L603" data-line-number="603"></td>
          <td id="file-microsoft_craziness-h-LC603">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L604" data-line-number="604"></td>
          <td id="file-microsoft_craziness-h-LC604">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L605" data-line-number="605"></td>
          <td id="file-microsoft_craziness-h-LC605">    <span>RegCloseKey</span>(vs7_key);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L606" data-line-number="606"></td>
          <td id="file-microsoft_craziness-h-LC606">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L607" data-line-number="607"></td>
          <td id="file-microsoft_craziness-h-LC607">    <span><span>//</span> If we get here, we failed to find anything.</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L608" data-line-number="608"></td>
          <td id="file-microsoft_craziness-h-LC608">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L609" data-line-number="609"></td>
          <td id="file-microsoft_craziness-h-LC609">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L610" data-line-number="610"></td>
          <td id="file-microsoft_craziness-h-LC610">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L611" data-line-number="611"></td>
          <td id="file-microsoft_craziness-h-LC611">Find_Result <span>find_visual_studio_and_windows_sdk</span>() {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L612" data-line-number="612"></td>
          <td id="file-microsoft_craziness-h-LC612">    Find_Result result;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L613" data-line-number="613"></td>
          <td id="file-microsoft_craziness-h-LC613">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L614" data-line-number="614"></td>
          <td id="file-microsoft_craziness-h-LC614">    <span>find_windows_kit_root</span>(&amp;result);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L615" data-line-number="615"></td>
          <td id="file-microsoft_craziness-h-LC615">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L616" data-line-number="616"></td>
          <td id="file-microsoft_craziness-h-LC616">    <span>if</span> (result.<span>windows_sdk_root</span>) {</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L617" data-line-number="617"></td>
          <td id="file-microsoft_craziness-h-LC617">        result.<span>windows_sdk_um_library_path</span>   = <span>concat2</span>(result.<span>windows_sdk_root</span>, L<span><span>&#34;</span><span>\\</span>um<span>\\</span>x64<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L618" data-line-number="618"></td>
          <td id="file-microsoft_craziness-h-LC618">        result.<span>windows_sdk_ucrt_library_path</span> = <span>concat2</span>(result.<span>windows_sdk_root</span>, L<span><span>&#34;</span><span>\\</span>ucrt<span>\\</span>x64<span>&#34;</span></span>);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L619" data-line-number="619"></td>
          <td id="file-microsoft_craziness-h-LC619">    }</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L620" data-line-number="620"></td>
          <td id="file-microsoft_craziness-h-LC620">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L621" data-line-number="621"></td>
          <td id="file-microsoft_craziness-h-LC621">    <span>find_visual_studio_by_fighting_through_microsoft_craziness</span>(&amp;result);</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L622" data-line-number="622"></td>
          <td id="file-microsoft_craziness-h-LC622">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L623" data-line-number="623"></td>
          <td id="file-microsoft_craziness-h-LC623">    <span>return</span> result;</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L624" data-line-number="624"></td>
          <td id="file-microsoft_craziness-h-LC624">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L625" data-line-number="625"></td>
          <td id="file-microsoft_craziness-h-LC625">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L626" data-line-number="626"></td>
          <td id="file-microsoft_craziness-h-LC626">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L627" data-line-number="627"></td>
          <td id="file-microsoft_craziness-h-LC627">#<span>endif</span>  <span><span>//</span> MICROSOFT_CRAZINESS_IMPLEMENTATION_GUARD</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L628" data-line-number="628"></td>
          <td id="file-microsoft_craziness-h-LC628">#<span>endif</span>  <span><span>//</span> MICROSOFT_CRAZINESS_IMPLEMENTATION</span></td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L629" data-line-number="629"></td>
          <td id="file-microsoft_craziness-h-LC629">
</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L630" data-line-number="630"></td>
          <td id="file-microsoft_craziness-h-LC630">#<span>ifdef</span> __cplusplus</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L631" data-line-number="631"></td>
          <td id="file-microsoft_craziness-h-LC631">}</td>
        </tr>
        <tr>
          <td id="file-microsoft_craziness-h-L632" data-line-number="632"></td>
          <td id="file-microsoft_craziness-h-LC632">#<span>endif</span></td>
        </tr>
  </tbody></div></div>
  </body>
</html>
