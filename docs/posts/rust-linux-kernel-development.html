<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.jackos.io/rust-kernel/rust-for-linux.html">Original</a>
    <h1>Rust Linux Kernel Development</h1>
    
    <div id="readability-page-1" class="page"><div><!--[--><!--]--><div><h2 id="introduction" tabindex="-1"><a href="#introduction" aria-hidden="true">#</a> Introduction</h2><p>This is following on from a <a href="https://www.youtube.com/watch?v=-l-8WrGHEGI" target="_blank" rel="noopener noreferrer">talk I really enjoyed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a> on how to create a linux kernel module using rust, but the presenter ran out of time. Please watch that video if you want more background on rust, why it&#39;s desirable in the kernel, and how a kernel module works differently from a normal binary.</p><p>We&#39;ll be working off <a href="https://github.com/jackos/linux" target="_blank" rel="noopener noreferrer">jackos/linux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a> which is a fork from <a href="https://github.com/Rust-for-Linux/linux" target="_blank" rel="noopener noreferrer">Rust-for-Linux/linux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a>, which itself forks from <a href="https://github.com/torvalds/linux" target="_blank" rel="noopener noreferrer">torvalds/linux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><p>Raise a <a href="https://github.com/jackos/jackos.io/compare" target="_blank" rel="noopener noreferrer">pull request<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a> or <a href="https://github.com/jackos/jackos.io/issues/new" target="_blank" rel="noopener noreferrer">issue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a> for any problems you have with this tutorial at: <a href="https://github.com/jackos/jackos.io" target="_blank" rel="noopener noreferrer">jackos/jackos.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a>.</p><h2 id="virtualization" tabindex="-1"><a href="#virtualization" aria-hidden="true">#</a> Virtualization</h2><p>You&#39;ll need to enable virtualization on your CPU in the bios, the steps to take are different depending on your motherboard and CPU, it may be called <code>SVM</code>, <code>AMD-V</code>, <code>Intel Virtualization</code> etc. Enable one of those options if you can find them, otherwise google something similar to <code>virtualization amd asus</code> or <code>virtualization intel gigabyte</code></p><h2 id="dependencies" tabindex="-1"><a href="#dependencies" aria-hidden="true">#</a> Dependencies</h2><p>Choose an option below and follow the steps, the docker containers are over <code>6gb</code>, so you may want to install everything natively if you have internet bandwidth limits. Alternatively you can create your own <code>Dockerfile</code> from the <a href="https://github.com/jackos/jackos.io/tree/main/rust-kernel/docker" target="_blank" rel="noopener noreferrer">examples here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><div><!--[--><div aria-selected="false"><!--[--><div><pre><code>
<span>docker</span> run -it jackosio/rust-linux:arch


<span>docker</span> run -it jackosio/rust-linux:latest

</code></pre></div><!--]--></div><div aria-selected="false"><!--[--><div><pre><code>
<span>sudo</span> pacman -Syuu --noconfirm <span>bc</span> bison <span>curl</span> clang diffutils flex <span>git</span> gcc llvm libelf lld ncurses <span>make</span> qemu-system-x86


<span>export</span> <span><span>PATH</span></span><span>=</span><span>&#34;/root/.cargo/bin:<span>${<span>PATH</span>}</span>&#34;</span>
<span>export</span> <span>MAKEFLAGS</span><span>=</span><span>&#34;-j16&#34;</span>
<span>export</span> <span>LLVM</span><span>=</span><span>&#34;1&#34;</span>


<span>curl</span> https://sh.rustup.rs -sSf <span>|</span> <span>bash</span> -s -- -y


<span>git</span> clone https://github.com/rust-lang/rust-bindgen -b v0.56.0 --depth<span>=</span><span>1</span>
cargo <span>install</span> --path rust-bindgen


<span>git</span> clone https://github.com/jackos/linux -b tutorial-start --depth<span>=</span><span>1</span>
<span>cd</span> linux


rustup override <span>set</span> <span><span>$(</span>scripts/min-tool-version.sh rustc<span>)</span></span>
rustup component <span>add</span> rust-src


<span>make</span> allnoconfig qemu-busybox-min.config rust.config
<span>make</span>

</code></pre></div><!--]--></div><div aria-selected="true"><!--[--><div><pre><code>
<span>sudo</span> <span>apt</span> update
<span>sudo</span> <span>apt</span> <span>install</span> -y <span>bc</span> bison <span>curl</span> clang fish flex <span>git</span> gcc libclang-dev libelf-dev lld llvm-dev libncurses-dev <span>make</span> neovim qemu-system-x86


<span>export</span> <span><span>PATH</span></span><span>=</span><span>&#34;/root/.cargo/bin:<span>${<span>PATH</span>}</span>&#34;</span>
<span>export</span> <span>MAKEFLAGS</span><span>=</span><span>&#34;-j16&#34;</span>
<span>export</span> <span>LLVM</span><span>=</span><span>&#34;1&#34;</span>


<span>curl</span> https://sh.rustup.rs -sSf <span>|</span> <span>bash</span> -s -- -y


<span>git</span> clone https://github.com/rust-lang/rust-bindgen -b v0.56.0 --depth<span>=</span><span>1</span>
cargo <span>install</span> --path rust-bindgen


<span>git</span> clone https://github.com/jackos/linux -b tutorial-start --depth<span>=</span><span>1</span>
<span>cd</span> linux


rustup override <span>set</span> <span><span>$(</span>scripts/min-tool-version.sh rustc<span>)</span></span>
rustup component <span>add</span> rust-src


<span>make</span> allnoconfig qemu-busybox-min.config rust.config
<span>make</span>
</code></pre></div><!--]--></div><!--]--></div><h2 id="ide" tabindex="-1"><a href="#ide" aria-hidden="true">#</a> IDE</h2><p>If you&#39;re using <code>vscode</code> and <code>docker</code> you can connect into the docker container using the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack" target="_blank" rel="noopener noreferrer">Remote Development<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a> extension, and install <code>rust-analyzer</code> after connecting to it. We&#39;ll add <code>rust-analyzer</code> support in a later step which will work with any editor supporting <code>lsp</code> such as <code>neovim</code> and <code>helix</code>.</p><h2 id="adding-the-rust-module" tabindex="-1"><a href="#adding-the-rust-module" aria-hidden="true">#</a> Adding the Rust module</h2><p>The module we&#39;ll be creating is called <code>VDev</code> short for <code>Virtual Device</code>, we&#39;ll add it to the <code>Kconfig</code>, so the <code>Makefile</code> configuration can find it:</p><h4 id="linux-samples-rust-kconfig" tabindex="-1"><a href="#linux-samples-rust-kconfig" aria-hidden="true">#</a> linux/samples/rust/Kconfig</h4><div><pre><code>config SAMPLE_RUST_VDEV
	tristate &#34;Virtual Device&#34;
	help
	  This option builds the Rust virtual device module sample.

	  To compile this as a module, choose M here:
	  the module will be called rust_vdev.

	  If unsure, say N.
</code></pre></div><p>We also to specify where the <code>Makefile</code> can find the object file:</p><h4 id="linux-samples-rust-makefile" tabindex="-1"><a href="#linux-samples-rust-makefile" aria-hidden="true">#</a> linux/samples/rust/Makefile</h4><div><pre><code>obj-$(CONFIG_SAMPLE_RUST_VDEV) 			+= rust_vdev.o
</code></pre></div><p>Now let&#39;s create a new file and write a minimal module:</p><h4 id="linux-samples-rust-rust-vdev-rs" tabindex="-1"><a href="#linux-samples-rust-rust-vdev-rs" aria-hidden="true">#</a> linux/samples/rust/rust_vdev.rs</h4><div><pre><code>
<span>use</span> <span>kernel<span>::</span>prelude<span>::</span></span><span>*</span><span>;</span>

<span>module!</span> <span>{</span>
    <span>type</span><span>:</span> <span>VDev</span><span>,</span>
    name<span>:</span> <span>b&#34;vdev&#34;</span><span>,</span>
    license<span>:</span> <span>b&#34;GPL&#34;</span><span>,</span>
<span>}</span>

<span>struct</span> <span>VDev</span><span>;</span>

<span>impl</span> <span>kernel<span>::</span></span><span>Module</span> <span>for</span> <span>VDev</span> <span>{</span>
    <span>fn</span> <span>init</span><span>(</span>_name<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>CStr</span><span>,</span> _module<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>ThisModule</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>Self</span><span>&gt;</span> <span>{</span>
        
        <span>pr_info!</span><span>(</span><span>&#34;------------------------\n&#34;</span><span>)</span><span>;</span>
        <span>pr_info!</span><span>(</span><span>&#34;starting virtual device!\n&#34;</span><span>)</span><span>;</span>
        <span>pr_info!</span><span>(</span><span>&#34;------------------------\n&#34;</span><span>)</span><span>;</span>
        <span>Ok</span><span>(</span><span>VDev</span><span>)</span>
    <span>}</span>
<span>}</span>
</code></pre></div><p>The <code>module!</code> macro takes care of all the boilerplate, we&#39;ll build and run the VM next to make sure everything is working.</p><p><a href="https://github.com/jackos/linux/commit/7551eb533fb45e9cacf2b9d1098ce9552d60b65a" target="_blank" rel="noopener noreferrer">2: module working - file changes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><h2 id="building-and-running-the-kernel" tabindex="-1"><a href="#building-and-running-the-kernel" aria-hidden="true">#</a> Building and running the Kernel</h2><p>The following command will bring up a <code>TUI</code> for setting the build configuration interactively, we need to enable our sample module:</p><p>Follow the menu items, checking any boxes as you go with <code>space</code>:</p><ul><li>Kernel Hacking: <code>enter</code></li><li>Sample kernel code: <code>space</code> + <code>enter</code></li><li>Rust Samples: <code>space</code> + <code>enter</code></li><li>Virtual Device: <code>space</code> + <code>enter</code></li><li>Press exit three times and save config</li></ul><p>Run <code>make</code> and start the kernel in a VM:</p><div><pre><code><span>make</span>
qemu-system-x86_64 -nographic -kernel vmlinux -initrd initrd.img -nic user,model<span>=</span>rtl8139,hostfwd<span>=</span>tcp::5555-:23
</code></pre></div><p>If all went well you should see:</p><div><pre><code>[0.623465] vdev: -----------------------
[0.623629] vdev: initialize vdev module!
[0.677356] vdev: -----------------------
</code></pre></div><p>Somewhere in the terminal</p><h2 id="restarting-the-kernel" tabindex="-1"><a href="#restarting-the-kernel" aria-hidden="true">#</a> Restarting the kernel</h2><p>If you want to reload on file changes you can initialize a &#34;hello world&#34; repo and run <code>cargo watch</code> with the <code>-s</code> flag:</p><div><pre><code>cargo init <span>.</span>
cargo <span>install</span> cargo-watch
cargo <span>watch</span> -w ./samples/rust/rust_vdev.rs -cs <span>&#39;make &amp;&amp; qemu-system-x86_64 -nographic -kernel vmlinux -initrd initrd.img -nic user,model=rtl8139,hostfwd=tcp::5555-:23&#39;</span>
</code></pre></div><p>If you just want to run commands normally without a file watch, in the terminal running the <code>qemu</code> virtualization you can turn it off and start it again by running:</p><div><pre><code>poweroff
<span>make</span>
qemu-system-x86_64 -nographic -kernel vmlinux -initrd initrd.img -nic user,model<span>=</span>rtl8139,hostfwd<span>=</span>tcp::5555-:23
</code></pre></div><p>We can add this to the <code>Makefile</code> to make it easier to run the command:</p><h4 id="linux-makefile" tabindex="-1"><a href="#linux-makefile" aria-hidden="true">#</a> linux/Makefile</h4><div><pre><code>PHONY += rustwatch
rustwatch:
	$(Q) cargo watch -w ./samples/rust/rust_vdev.rs -cs &#39;make &amp;&amp; qemu-system-x86_64 -nographic -kernel vmlinux -initrd initrd.img -nic user,model=rtl8139,hostfwd=tcp::5555-:23&#39;

PHONY += rustvm
rustvm:
	$(Q) make &amp;&amp; qemu-system-x86_64 -nographic -kernel vmlinux -initrd initrd.img -nic user,model=rtl8139,hostfwd=tcp::5555-:23
</code></pre></div><p>Now we can run the commands:</p><div><pre><code>
<span>make</span> rustvm

<span>make</span> rustwatch
</code></pre></div><p><a href="https://github.com/jackos/linux/commit/8cd8c7965e18f272d3cb50844d55b43c1960abdb" target="_blank" rel="noopener noreferrer">3: add watch - file changes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><h2 id="fix-rust-analyzer" tabindex="-1"><a href="#fix-rust-analyzer" aria-hidden="true">#</a> Fix Rust Analyzer</h2><p><code>rust-analyzer</code> is a <code>Language Sever Protocol (lsp)</code> implementation that provides features like <code>completions</code> and <code>go to definition</code>, to get it to work with our project run:</p><p>This produces a <code>rust-project.json</code> allowing <code>rust-anlyzer</code> to parse a project without a <code>Cargo.toml</code>, we need to do this because <code>rustc</code> is being invoked directly by the <code>Makefile</code>.</p><p>Now that we have Rust Analyzer working I highly recommend you make use of <code>Go to Definition</code> to see how everything has been implemented. We&#39;re not using the <code>std</code> for our core functionality, we&#39;re using custom kernel implementations that are suited to the <code>C</code> bindings. E.g. a mutex lock will not return a poison <code>Result</code> because we don&#39;t want the whole kernel to panic if a single thread panics.</p><h2 id="register-device" tabindex="-1"><a href="#register-device" aria-hidden="true">#</a> Register device</h2><p>All the below changes are on <code>linux/samples/rust/rust_vdev.rs</code></p><p>Add these imports:</p><div><pre><code><span>use</span> <span>kernel<span>::</span>file<span>::</span></span><span>{</span><span>File</span><span>,</span> <span>Operations</span><span>}</span><span>;</span>
<span>use</span> <span>kernel<span>::</span></span><span>{</span>miscdev<span>,</span> <span>Module</span><span>}</span><span>;</span>
</code></pre></div><p>Change the <code>VDev</code> struct to allow us to register a device into the <code>/dev/</code> folder</p><div><pre><code><span>struct</span> <span>VDev</span> <span>{</span>
    _dev<span>:</span> <span>Pin</span><span>&lt;</span><span>Box</span><span>&lt;</span><span>miscdev<span>::</span></span><span>Registration</span><span>&lt;</span><span>VDev</span><span>&gt;&gt;</span><span>&gt;</span><span>,</span>
<span>}</span>
</code></pre></div><p>Change our <code>Module</code> implementation for <code>VDev</code>, you can see that <code>miscdev::Registration</code> is being called with an argument of <code>vdev</code>, so the device will be named <code>/dev/vdev</code></p><div><pre><code><span>impl</span> <span>Module</span> <span>for</span> <span>VDev</span> <span>{</span>
    <span>fn</span> <span>init</span><span>(</span>_name<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>CStr</span><span>,</span> _module<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>ThisModule</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>Self</span><span>&gt;</span> <span>{</span>
        <span>pr_info!</span><span>(</span><span>&#34;-----------------------\n&#34;</span><span>)</span><span>;</span>
        <span>pr_info!</span><span>(</span><span>&#34;initialize vdev module!\n&#34;</span><span>)</span><span>;</span>
        <span>pr_info!</span><span>(</span><span>&#34;watching for changes...\n&#34;</span><span>)</span><span>;</span>
        <span>pr_info!</span><span>(</span><span>&#34;-----------------------\n&#34;</span><span>)</span><span>;</span>
        <span>Ok</span><span>(</span><span>VDev</span><span>)</span>
        <span>let</span> reg <span>=</span> <span>miscdev<span>::</span></span><span>Registration</span><span>::</span><span>new_pinned</span><span>(</span><span>fmt!</span><span>(</span><span>&#34;vdev&#34;</span><span>)</span><span>,</span> <span>(</span><span>)</span><span>)</span><span>?</span><span>;</span>
        <span>Ok</span><span>(</span><span>Self</span> <span>{</span> _dev<span>:</span> reg <span>}</span><span>)</span>
    <span>}</span>
<span>}</span>
</code></pre></div><p>Add the minimal implementation for a device which will print &#34;File was opened&#34; when we perform a <code>cat /dev/vdev</code></p><div><pre><code><span>#[vtable]</span>
<span>impl</span> <span>Operations</span> <span>for</span> <span>VDev</span> <span>{</span>
    <span>fn</span> <span>open</span><span>(</span>_context<span>:</span> <span>&amp;</span><span>(</span><span>)</span><span>,</span> _file<span>:</span> <span>&amp;</span><span>File</span><span>)</span> <span>-&gt;</span> <span>Result</span> <span>{</span>
        <span>pr_info!</span><span>(</span><span>&#34;File was opened\n&#34;</span><span>)</span><span>;</span>
        <span>Ok</span><span>(</span><span>(</span><span>)</span><span>)</span>
    <span>}</span>
<span>}</span>
</code></pre></div><p><a href="https://github.com/jackos/linux/commit/c5514d8d909c30cb756fb25126c13d1a771b0028" target="_blank" rel="noopener noreferrer">4: register device - file changes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><h2 id="implement-read-and-write" tabindex="-1"><a href="#implement-read-and-write" aria-hidden="true">#</a> Implement Read and Write</h2><p>We&#39;re going to allow multiple threads to read and write from a place in memory, so we need a <code>Mutex</code>, we&#39;ll use <code>smutext</code> short for <code>simple mutex</code>, a custom kernel mutex that doesn&#39;t return a poison <code>Result</code> on <code>lock()</code>.</p><p>Add the imports</p><div><pre><code><span>use</span> <span>kernel<span>::</span>io_buffer<span>::</span></span><span>{</span><span>IoBufferReader</span><span>,</span> <span>IoBufferWriter</span><span>}</span><span>;</span>
<span>use</span> <span>kernel<span>::</span>sync<span>::</span>smutex<span>::</span></span><span>Mutex</span><span>;</span>
<span>use</span> <span>kernel<span>::</span>sync<span>::</span></span><span>{</span><span>Ref</span><span>,</span> <span>RefBorrow</span><span>}</span><span>;</span>
</code></pre></div><p>Add a struct representing a <code>Device</code> to hold onto data and track its own number</p><div><pre><code><span>struct</span> <span>Device</span> <span>{</span>
    number<span>:</span> <span>usize</span><span>,</span>
    contents<span>:</span> <span>Mutex</span><span>&lt;</span><span>Vec</span><span>&lt;</span><span>u8</span><span>&gt;&gt;</span><span>,</span>
<span>}</span>
</code></pre></div><p>Now let&#39;s add the correct associated types to the <code>Operations</code> implementation and add the <code>read</code> and <code>write</code> methods:</p><div><pre><code><span>impl</span> <span>Operations</span> <span>for</span> <span>VDev</span> <span>{</span>
    
    <span>type</span> <span>OpenData</span> <span>=</span> <span>Ref</span><span>&lt;</span><span>Device</span><span>&gt;</span><span>;</span>
    
    <span>type</span> <span>Data</span> <span>=</span> <span>Ref</span><span>&lt;</span><span>Device</span><span>&gt;</span><span>;</span>

    <span>fn</span> <span>open</span><span>(</span>context<span>:</span> <span>&amp;</span><span>Ref</span><span>&lt;</span><span>Device</span><span>&gt;</span><span>,</span> _file<span>:</span> <span>&amp;</span><span>File</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>Ref</span><span>&lt;</span><span>Device</span><span>&gt;&gt;</span> <span>{</span>
        <span>pr_info!</span><span>(</span><span>&#34;File for device {} was opened\n&#34;</span><span>,</span> context<span>.</span>number<span>)</span><span>;</span>
        <span>Ok</span><span>(</span>context<span>.</span><span>clone</span><span>(</span><span>)</span><span>)</span>
    <span>}</span>

    
    <span>fn</span> <span>read</span><span>(</span>
        data<span>:</span> <span>RefBorrow</span><span>&lt;</span><span>&#39;_</span><span>,</span> <span>Device</span><span>&gt;</span><span>,</span>
        _file<span>:</span> <span>&amp;</span><span>File</span><span>,</span>
        writer<span>:</span> <span>&amp;</span><span>mut</span> <span>impl</span> <span>IoBufferWriter</span><span>,</span>
        offset<span>:</span> <span>u64</span><span>,</span>
    <span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>usize</span><span>&gt;</span> <span>{</span>
        <span>pr_info!</span><span>(</span><span>&#34;File for device {} was read\n&#34;</span><span>,</span> data<span>.</span>number<span>)</span><span>;</span>
        <span>let</span> offset <span>=</span> offset<span>.</span><span>try_into</span><span>(</span><span>)</span><span>?</span><span>;</span>
        <span>let</span> vec <span>=</span> data<span>.</span>contents<span>.</span><span>lock</span><span>(</span><span>)</span><span>;</span>
        <span>let</span> len <span>=</span> <span>core<span>::</span>cmp<span>::</span></span><span>min</span><span>(</span>writer<span>.</span><span>len</span><span>(</span><span>)</span><span>,</span> vec<span>.</span><span>len</span><span>(</span><span>)</span><span>.</span><span>saturating_sub</span><span>(</span>offset<span>)</span><span>)</span><span>;</span>
        writer<span>.</span><span>write_slice</span><span>(</span><span>&amp;</span>vec<span>[</span>offset<span>..</span><span>]</span><span>[</span><span>..</span>len<span>]</span><span>)</span><span>?</span><span>;</span>
        <span>Ok</span><span>(</span>len<span>)</span>
    <span>}</span>

    
    <span>fn</span> <span>write</span><span>(</span>
        data<span>:</span> <span>RefBorrow</span><span>&lt;</span><span>&#39;_</span><span>,</span> <span>Device</span><span>&gt;</span><span>,</span>
        _file<span>:</span> <span>&amp;</span><span>File</span><span>,</span>
        reader<span>:</span> <span>&amp;</span><span>mut</span> <span>impl</span> <span>IoBufferReader</span><span>,</span>
        _offset<span>:</span> <span>u64</span><span>,</span>
    <span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>usize</span><span>&gt;</span> <span>{</span>
        <span>pr_info!</span><span>(</span><span>&#34;File for device {} was written\n&#34;</span><span>,</span> data<span>.</span>number<span>)</span><span>;</span>
        <span>let</span> copy <span>=</span> reader<span>.</span><span>read_all</span><span>(</span><span>)</span><span>?</span><span>;</span>
        <span>let</span> len <span>=</span> copy<span>.</span><span>len</span><span>(</span><span>)</span><span>;</span>
        <span>*</span>data<span>.</span>contents<span>.</span><span>lock</span><span>(</span><span>)</span> <span>=</span> copy<span>;</span>
        <span>Ok</span><span>(</span>len<span>)</span>
    <span>}</span>
<span>}</span>
</code></pre></div><p><a href="https://github.com/jackos/linux/commit/eaa80f91cbcc2ddce334583bbfca15e500515fca" target="_blank" rel="noopener noreferrer">5: read and write - file changes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><p>Now this is all set up start the vm, if you set up the make command:</p><p>Or if you prefer to just run the commands:</p><div><pre><code><span>make</span>
qemu-system-x86_64 -nographic -kernel vmlinux -initrd initrd.img -nic user,model<span>=</span>rtl8139,hostfwd<span>=</span>tcp::5555-:23
</code></pre></div><p>In the terminal that has the VM runnning, run the commands:</p><div><pre><code><span>echo</span> <span>&#34;wow it works&#34;</span> <span>&gt;</span> /dev/vdev
<span>cat</span> /dev/vdev
</code></pre></div><p>If everything is working you should see:</p><div><pre><code>echo &#34;wow it works&#34; &gt; /dev/vdev
[41.498265] vdev: File for device 1 was opened
[41.498564] vdev: File for device 1 was written
cat /dev/vdev
[65.435708] vdev: File for device 1 was opened
[65.436339] vdev: File for device 1 was read
wow it works
[65.436712] vdev: File for device 1 was read
</code></pre></div><h2 id="using-kernel-parameters" tabindex="-1"><a href="#using-kernel-parameters" aria-hidden="true">#</a> Using kernel parameters</h2><p>We&#39;re now going to set up a kernel parameter which we can change when we start the VM to modify behavior, in this case it&#39;ll start more devices</p><p>Add the flags import:</p><div><pre><code><span>use</span> <span>kernel<span>::</span>file<span>::</span></span><span>{</span>flags<span>,</span> <span>File</span><span>,</span> <span>Operations</span><span>}</span><span>;</span>
</code></pre></div><p>Modify the <code>module!</code> macro so that it now contains a parameter, <code>devices</code> will be the name of the parameter which can be accessed from <code>vdev.devices</code>:</p><div><pre><code><span>module!</span> <span>{</span>
    <span>type</span><span>:</span> <span>VDev</span><span>,</span>
    name<span>:</span> <span>b&#34;vdev&#34;</span><span>,</span>
    license<span>:</span> <span>b&#34;GPL&#34;</span><span>,</span>
    params<span>:</span> <span>{</span>
        devices<span>:</span> <span>u32</span> <span>{</span>
            default<span>:</span> <span>1</span><span>,</span>
            permissions<span>:</span> <span>0o644</span><span>,</span>
            description<span>:</span> <span>b&#34;Number of virtual devices&#34;</span><span>,</span>
        <span>}</span><span>,</span>
    <span>}</span><span>,</span>
<span>}</span>
</code></pre></div><p>Let&#39;s change the structure of our devices so that it&#39;s a vec now:</p><div><pre><code><span>struct</span> <span>VDev</span> <span>{</span>
    _devs<span>:</span> <span>Vec</span><span>&lt;</span><span>Pin</span><span>&lt;</span><span>Box</span><span>&lt;</span><span>miscdev<span>::</span></span><span>Registration</span><span>&lt;</span><span>VDev</span><span>&gt;&gt;</span><span>&gt;&gt;</span><span>,</span>
<span>}</span>
</code></pre></div><p>Update the <code>open</code> method to clear the data if it&#39;s opened in <code>write only</code> mode</p><div><pre><code><span>fn</span> <span>open</span><span>(</span>context<span>:</span> <span>&amp;</span><span>Ref</span><span>&lt;</span><span>Device</span><span>&gt;</span><span>,</span> file<span>:</span> <span>&amp;</span><span>File</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>Ref</span><span>&lt;</span><span>Device</span><span>&gt;&gt;</span> <span>{</span>
    <span>pr_info!</span><span>(</span><span>&#34;File for device {} was opened\n&#34;</span><span>,</span> context<span>.</span>number<span>)</span><span>;</span>
    <span>if</span> file<span>.</span><span>flags</span><span>(</span><span>)</span> <span>&amp;</span> <span>flags<span>::</span></span><span>O_ACCMODE</span> <span>==</span> <span>flags<span>::</span></span><span>O_WRONLY</span> <span>{</span>
        context<span>.</span>contents<span>.</span><span>lock</span><span>(</span><span>)</span><span>.</span><span>clear</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>Ok</span><span>(</span>context<span>.</span><span>clone</span><span>(</span><span>)</span><span>)</span>
<span>}</span>
</code></pre></div><p>Update the write method to increase the size of the vec if required instead of allocating new memory</p><div><pre><code><span>fn</span> <span>write</span><span>(</span>
        data<span>:</span> <span>RefBorrow</span><span>&lt;</span><span>&#39;_</span><span>,</span> <span>Device</span><span>&gt;</span><span>,</span>
        _file<span>:</span> <span>&amp;</span><span>File</span><span>,</span>
        reader<span>:</span> <span>&amp;</span><span>mut</span> <span>impl</span> <span>IoBufferReader</span><span>,</span>
        _offset<span>:</span> <span>u64</span><span>,</span>
        offset<span>:</span> <span>u64</span><span>,</span>
    <span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>usize</span><span>&gt;</span> <span>{</span>
        <span>pr_info!</span><span>(</span><span>&#34;File for device {} was written\n&#34;</span><span>,</span> data<span>.</span>number<span>)</span><span>;</span>
        <span>let</span> copy <span>=</span> reader<span>.</span><span>read_all</span><span>(</span><span>)</span><span>?</span><span>;</span>
        <span>let</span> len <span>=</span> copy<span>.</span><span>len</span><span>(</span><span>)</span><span>;</span>
        <span>*</span>data<span>.</span>contents<span>.</span><span>lock</span><span>(</span><span>)</span> <span>=</span> copy<span>;</span>
        <span>let</span> offset <span>=</span> offset<span>.</span><span>try_into</span><span>(</span><span>)</span><span>?</span><span>;</span>
        <span>let</span> len <span>=</span> reader<span>.</span><span>len</span><span>(</span><span>)</span><span>;</span>
        <span>let</span> new_len <span>=</span> len<span>.</span><span>checked_add</span><span>(</span>offset<span>)</span><span>.</span><span>ok_or</span><span>(</span><span>EINVAL</span><span>)</span><span>?</span><span>;</span>
        <span>let</span> <span>mut</span> vec <span>=</span> data<span>.</span>contents<span>.</span><span>lock</span><span>(</span><span>)</span><span>;</span>
        <span>if</span> new_len <span>&gt;</span> vec<span>.</span><span>len</span><span>(</span><span>)</span> <span>{</span>
            vec<span>.</span><span>try_resize</span><span>(</span>new_len<span>,</span> <span>0</span><span>)</span><span>?</span><span>;</span>
        <span>}</span>
        reader<span>.</span><span>read_slice</span><span>(</span><span>&amp;</span><span>mut</span> vec<span>[</span>offset<span>..</span><span>]</span><span>[</span><span>..</span>len<span>]</span><span>)</span><span>?</span><span>;</span>
        <span>Ok</span><span>(</span>len<span>)</span>
    <span>}</span>
</code></pre></div><p>Update the <code>Module</code> impl for <code>VDev</code> so that the same amount of devices are registered as specified by the kernel param.</p><div><pre><code><span>impl</span> <span>Module</span> <span>for</span> <span>VDev</span> <span>{</span>
  <span>fn</span> <span>init</span><span>(</span>_name<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>CStr</span><span>,</span> module<span>:</span> <span>&amp;</span><span>&#39;static</span> <span>ThisModule</span><span>)</span> <span>-&gt;</span> <span>Result</span><span>&lt;</span><span>Self</span><span>&gt;</span> <span>{</span>
      <span>let</span> count <span>=</span> <span>{</span>
          <span>let</span> lock <span>=</span> module<span>.</span><span>kernel_param_lock</span><span>(</span><span>)</span><span>;</span>
          <span>(</span><span>*</span>devices<span>.</span><span>read</span><span>(</span><span>&amp;</span>lock<span>)</span><span>)</span><span>.</span><span>try_into</span><span>(</span><span>)</span><span>?</span>
      <span>}</span><span>;</span>
      <span>pr_info!</span><span>(</span><span>&#34;-----------------------\n&#34;</span><span>)</span><span>;</span>
      <span>pr_info!</span><span>(</span><span>&#34;starting {} vdevices!\n&#34;</span><span>,</span> count<span>)</span><span>;</span>
      <span>pr_info!</span><span>(</span><span>&#34;watching for changes...\n&#34;</span><span>)</span><span>;</span>
      <span>pr_info!</span><span>(</span><span>&#34;-----------------------\n&#34;</span><span>)</span><span>;</span>
      <span>let</span> <span>mut</span> devs <span>=</span> <span>Vec</span><span>::</span><span>try_with_capacity</span><span>(</span>count<span>)</span><span>?</span><span>;</span>
      <span>for</span> i <span>in</span> <span>0</span><span>..</span>count <span>{</span>
          <span>let</span> dev <span>=</span> <span>Ref</span><span>::</span><span>try_new</span><span>(</span><span>Device</span> <span>{</span>
              number<span>:</span> i<span>,</span>
              contents<span>:</span> <span>Mutex</span><span>::</span><span>new</span><span>(</span><span>Vec</span><span>::</span><span>new</span><span>(</span><span>)</span><span>)</span><span>,</span>
          <span>}</span><span>)</span><span>?</span><span>;</span>
          <span>let</span> reg <span>=</span> <span>miscdev<span>::</span></span><span>Registration</span><span>::</span><span>new_pinned</span><span>(</span><span>fmt!</span><span>(</span><span>&#34;vdev{i}&#34;</span><span>)</span><span>,</span> dev<span>)</span><span>?</span><span>;</span>
          devs<span>.</span><span>try_push</span><span>(</span>reg<span>)</span><span>?</span><span>;</span>
      <span>}</span>
      <span>Ok</span><span>(</span><span>Self</span> <span>{</span> _devs<span>:</span> devs <span>}</span><span>)</span>
    <span>}</span>
<span>}</span>
</code></pre></div><p>Now we can change the Makefile adding the argument: <code>-append &#34;vdev.devices=4&#34;</code></p><div><pre><code>PHONY += rustwatch
rustwatch:
	$(Q) cargo watch -w ./samples/rust/rust_vdev.rs -cs &#39;make &amp;&amp; qemu-system-x86_64 -append &#34;vdev.devices=4&#34; -nographic -kernel vmlinux -initrd initrd.img -nic user,model=rtl8139,hostfwd=tcp::5555-:23&#39;

PHONY += rustvm
rustvm:
	$(Q) make &amp;&amp; qemu-system-x86_64 -append &#34;vdev.devices=4&#34; -nographic -kernel vmlinux -initrd initrd.img -nic user,model=rtl8139,hostfwd=tcp::5555-:23
</code></pre></div><p>And then running <code>rustvm</code> or <code>rustwatch</code></p><p>Or if you want to run the commands directly:</p><div><pre><code><span>make</span>
qemu-system-x86_64 -append <span>&#34;vdev.devices=4&#34;</span> -nographic -kernel vmlinux -initrd initrd.img -nic user,model<span>=</span>rtl8139,hostfwd<span>=</span>tcp::5555-:23
</code></pre></div><p><a href="https://github.com/jackos/linux/blob/2c944f4bc399e07ba7bc6ec95925f503221bfa06/samples/rust/rust_vdev.rs" target="_blank" rel="noopener noreferrer">final file<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a></p><h2 id="repo-areas-of-interest" tabindex="-1"><a href="#repo-areas-of-interest" aria-hidden="true">#</a> Repo areas of interest</h2><p>Now that you have a general idea of how to write your own module, take a look around in the repo, some areas of interest are:</p><ul><li><code>linux/rust</code></li><li><code>linux/rust/kernel</code></li><li><code>linux/Documentation/rust</code></li></ul><p>And don&#39;t forget to have a look through all the samples and play around with them if you&#39;re interested:</p><ul><li><code>linux/samples/rust</code></li></ul><p>You can activate whichever ones you want with <code>make menuconfig</code> as before</p><p>That&#39;s it, thanks for reading, and please don&#39;t hesitate to raise an issue at: <a href="https://github.com/jackos/jackos.io" target="_blank" rel="noopener noreferrer">github:jackos/jackos.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span>open in new window</span></span></a> if you have any suggestions or problems with this content.</p><p>I look forward to seeing your pull requests in the linux kernel!</p></div><!--[--><!--]--></div></div>
  </body>
</html>
