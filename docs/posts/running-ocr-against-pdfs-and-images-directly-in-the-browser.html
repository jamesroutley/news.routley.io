<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://simonwillison.net/2024/Mar/30/ocr-pdfs-images/">Original</a>
    <h1>Running OCR against PDFs and images directly in the browser</h1>
    
    <div id="readability-page-1" class="page"><div>


<div data-permalink-context="/2024/Mar/30/ocr-pdfs-images/">
<h2>Running OCR against PDFs and images directly in your browser</h2>
<p>30th March 2024</p>

<p>I attended the <a href="https://biglocalnews.org/content/events/">Story Discovery At Scale</a> data journalism conference at Stanford this week. One of the perennial hot topics at any journalism conference concerns data extraction: how can we best get data out of PDFs and images?</p>
<p>I’ve been having some very promising results with Gemini Pro 1.5, Claude 3 and GPT-4 Vision recently—I’ll write more about that soon. But those tools are still inconvenient for most people to use.</p>
<p>Meanwhile, older tools like <a href="https://github.com/tesseract-ocr/tesseract">Tesseract OCR</a> are still extremely useful—if only they were easier to use as well.</p>
<p>Then I remembered that Tesseract runs happily in a browser these days thanks to the excellent <a href="https://tesseract.projectnaptha.com/">Tesseract.js</a> project. And PDFs can be processed using JavaScript too thanks to Mozilla’s extremely mature and well-tested <a href="https://mozilla.github.io/pdf.js/">PDF.js</a> library.</p>
<p>So I built a new tool!</p>
<p><strong><a href="https://tools.simonwillison.net/ocr">tools.simonwillison.net/ocr</a></strong> provides a single page web app that can run Tesseract OCR against images or PDFs that are opened in (or dragged and dropped onto) the app.</p>
<p>Crucially, everything runs in the browser. There is no server component here, and nothing is uploaded. Your images and documents never leave your computer or phone.</p>
<p>Here’s an animated demo:</p>
<p><img src="https://static.simonwillison.net/static/2024/ocr-demo.gif" alt="First an image file is dragged onto the page, which then shows that image and accompanying OCR text. Then the drop zone is clicked and a PDF file is selected - that PDF is rendered a page at a time down the page with OCR text displayed beneath each page."/></p>
<p>It’s not perfect: multi-column PDFs (thanks, academia) will be treated as a single column, illustrations or photos may result in garbled ASCII-art and there are plenty of other edge cases that will trip it up.</p>
<p>But... having Tesseract OCR available against PDFs in a web browser (including in Mobile Safari) is still a really useful thing.</p>
<h4 id="ocr-how-i-built-this">How I built this</h4>
<p><em>For more recent examples of projects I’ve built with the assistance of LLMs, see <a href="https://simonwillison.net/2024/Mar/23/building-c-extensions-for-sqlite-with-chatgpt-code-interpreter/">Building and testing C extensions for SQLite with ChatGPT Code Interpreter</a> and <a href="https://simonwillison.net/2024/Mar/22/claude-and-chatgpt-case-study/">Claude and ChatGPT for ad-hoc sidequests</a>.</em></p>
<p>I built the first version of this tool in just a few minutes, using Claude 3 Opus.</p>
<p>I already had my own JavaScript code lying around for the two most important tasks: running Tesseract.js against an images and using PDF.js to turn a PDF into a series of images.</p>
<p>The OCR code came from the system I built and explained in <a href="https://simonwillison.net/2023/Aug/6/annotated-presentations/">How I make annotated presentations</a> (built with the help of <a href="https://simonwillison.net/2023/Aug/6/annotated-presentations/#chatgpt-sessions">multiple ChatGPT sessions</a>). The PDF to images code was from an <a href="https://gist.github.com/simonw/e58796324abb0e729b2dcd351f46728a">unfinished experiment</a> which I wrote with the aid of Claude 3 Opus a week ago.</p>
<p>I composed the following prompt for Claude 3, where I pasted in both of my code examples and then added some instructions about what I wanted it to build at the end:</p>
<blockquote>
<p>This code shows how to open a PDF and turn it into an image per page:</p>
<div><pre><span>&lt;!DOCTYPE html<span>&gt;</span></span>
<span>&lt;</span><span>html</span><span>&gt;</span>
<span>&lt;</span><span>head</span><span>&gt;</span>
  <span>&lt;</span><span>title</span><span>&gt;</span>PDF to Images<span>&lt;/</span><span>title</span><span>&gt;</span>
  <span>&lt;</span><span>script</span> <span>src</span>=&#34;<span>https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js</span>&#34;<span>&gt;</span><span>&lt;/</span><span>script</span><span>&gt;</span>
  <span>&lt;</span><span>style</span><span>&gt;</span>
    .image-container img {
      margin-bottom: 10px;
    }
    .image-container p {
      margin: 0;
      font-size: 14px;
      color: #888;
    }
  <span>&lt;/</span><span>style</span><span>&gt;</span>
<span>&lt;/</span><span>head</span><span>&gt;</span>
<span>&lt;</span><span>body</span><span>&gt;</span>
  <span>&lt;</span><span>input</span> <span>type</span>=&#34;<span>file</span>&#34; <span>id</span>=&#34;<span>fileInput</span>&#34; <span>accept</span>=&#34;<span>.pdf</span>&#34; /&gt;
  <span>&lt;</span><span>div</span> <span>class</span>=&#34;<span>image-container</span>&#34;<span>&gt;</span><span>&lt;/</span><span>div</span><span>&gt;</span>

  <span>&lt;</span><span>script</span><span>&gt;</span>
  <span>const</span> <span>desiredWidth</span> <span>=</span> <span>800</span><span>;</span>
    <span>const</span> <span>fileInput</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>&#39;fileInput&#39;</span><span>)</span><span>;</span>
    <span>const</span> <span>imageContainer</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>&#39;.image-container&#39;</span><span>)</span><span>;</span>

    <span>fileInput</span><span>.</span><span>addEventListener</span><span>(</span><span>&#39;change&#39;</span><span>,</span> <span>handleFileUpload</span><span>)</span><span>;</span>

    <span>pdfjsLib</span><span>.</span><span>GlobalWorkerOptions</span><span>.</span><span>workerSrc</span> <span>=</span> <span>&#39;https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js&#39;</span><span>;</span>

    <span>async</span> <span>function</span> <span>handleFileUpload</span><span>(</span><span>event</span><span>)</span> <span>{</span>
      <span>const</span> <span>file</span> <span>=</span> <span>event</span><span>.</span><span>target</span><span>.</span><span>files</span><span>[</span><span>0</span><span>]</span><span>;</span>
      <span>const</span> <span>imageIterator</span> <span>=</span> <span>convertPDFToImages</span><span>(</span><span>file</span><span>)</span><span>;</span>

      <span>for</span> <span>await</span> <span>(</span><span>const</span> <span>{</span> imageURL<span>,</span> size <span>}</span> <span>of</span> <span>imageIterator</span><span>)</span> <span>{</span>
        <span>const</span> <span>imgElement</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>&#39;img&#39;</span><span>)</span><span>;</span>
        <span>imgElement</span><span>.</span><span>src</span> <span>=</span> <span>imageURL</span><span>;</span>
        <span>imageContainer</span><span>.</span><span>appendChild</span><span>(</span><span>imgElement</span><span>)</span><span>;</span>

        <span>const</span> <span>sizeElement</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>&#39;p&#39;</span><span>)</span><span>;</span>
        <span>sizeElement</span><span>.</span><span>textContent</span> <span>=</span> <span>`Size: <span><span>${</span><span>formatSize</span><span>(</span><span>size</span><span>)</span><span>}</span></span>`</span><span>;</span>
        <span>imageContainer</span><span>.</span><span>appendChild</span><span>(</span><span>sizeElement</span><span>)</span><span>;</span>
      <span>}</span>
    <span>}</span>

    <span>async</span> <span>function</span><span>*</span> <span>convertPDFToImages</span><span>(</span><span>file</span><span>)</span> <span>{</span>
      <span>try</span> <span>{</span>
        <span>const</span> <span>pdf</span> <span>=</span> <span>await</span> <span>pdfjsLib</span><span>.</span><span>getDocument</span><span>(</span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>file</span><span>)</span><span>)</span><span>.</span><span>promise</span><span>;</span>
        <span>const</span> <span>numPages</span> <span>=</span> <span>pdf</span><span>.</span><span>numPages</span><span>;</span>

        <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>numPages</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
          <span>const</span> <span>page</span> <span>=</span> <span>await</span> <span>pdf</span><span>.</span><span>getPage</span><span>(</span><span>i</span><span>)</span><span>;</span>
          <span>const</span> <span>viewport</span> <span>=</span> <span>page</span><span>.</span><span>getViewport</span><span>(</span><span>{</span> <span>scale</span>: <span>1</span> <span>}</span><span>)</span><span>;</span>
          <span>const</span> <span>canvas</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>&#39;canvas&#39;</span><span>)</span><span>;</span>
          <span>const</span> <span>context</span> <span>=</span> <span>canvas</span><span>.</span><span>getContext</span><span>(</span><span>&#39;2d&#39;</span><span>)</span><span>;</span>
          <span>canvas</span><span>.</span><span>width</span> <span>=</span> <span>desiredWidth</span><span>;</span>
          <span>canvas</span><span>.</span><span>height</span> <span>=</span> <span>(</span><span>desiredWidth</span> <span>/</span> <span>viewport</span><span>.</span><span>width</span><span>)</span> <span>*</span> <span>viewport</span><span>.</span><span>height</span><span>;</span>
          <span>const</span> <span>renderContext</span> <span>=</span> <span>{</span>
            <span>canvasContext</span>: <span>context</span><span>,</span>
            <span>viewport</span>: <span>page</span><span>.</span><span>getViewport</span><span>(</span><span>{</span> <span>scale</span>: <span>desiredWidth</span> <span>/</span> <span>viewport</span><span>.</span><span>width</span> <span>}</span><span>)</span><span>,</span>
          <span>}</span><span>;</span>
          <span>await</span> <span>page</span><span>.</span><span>render</span><span>(</span><span>renderContext</span><span>)</span><span>.</span><span>promise</span><span>;</span>
          <span>const</span> <span>imageURL</span> <span>=</span> <span>canvas</span><span>.</span><span>toDataURL</span><span>(</span><span>&#39;image/jpeg&#39;</span><span>,</span> <span>0.8</span><span>)</span><span>;</span>
          <span>const</span> <span>size</span> <span>=</span> <span>calculateSize</span><span>(</span><span>imageURL</span><span>)</span><span>;</span>
          <span>yield</span> <span>{</span> imageURL<span>,</span> size <span>}</span><span>;</span>
        <span>}</span>
      <span>}</span> <span>catch</span> <span>(</span><span>error</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>error</span><span>(</span><span>&#39;Error:&#39;</span><span>,</span> <span>error</span><span>)</span><span>;</span>
      <span>}</span>
    <span>}</span>

    <span>function</span> <span>calculateSize</span><span>(</span><span>imageURL</span><span>)</span> <span>{</span>
      <span>const</span> <span>base64Length</span> <span>=</span> <span>imageURL</span><span>.</span><span>length</span> <span>-</span> <span>&#39;data:image/jpeg;base64,&#39;</span><span>.</span><span>length</span><span>;</span>
      <span>const</span> <span>sizeInBytes</span> <span>=</span> <span>Math</span><span>.</span><span>ceil</span><span>(</span><span>base64Length</span> <span>*</span> <span>0.75</span><span>)</span><span>;</span>
      <span>return</span> <span>sizeInBytes</span><span>;</span>
    <span>}</span>

    <span>function</span> <span>formatSize</span><span>(</span><span>size</span><span>)</span> <span>{</span>
      <span>const</span> <span>sizeInKB</span> <span>=</span> <span>(</span><span>size</span> <span>/</span> <span>1024</span><span>)</span><span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span>
      <span>return</span> <span>`<span><span>${</span><span>sizeInKB</span><span>}</span></span> KB`</span><span>;</span>
    <span>}</span>
  <span>&lt;/</span><span>script</span><span>&gt;</span>
<span>&lt;/</span><span>body</span><span>&gt;</span>
<span>&lt;/</span><span>html</span><span>&gt;</span></pre></div>
<p>This code shows how to OCR an image:</p>
<div><pre><span>async</span> <span>function</span> <span>ocrMissingAltText</span><span>(</span><span>)</span> <span>{</span>
    <span>// Load Tesseract</span>
    <span>var</span> <span>s</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>&#34;script&#34;</span><span>)</span><span>;</span>
    <span>s</span><span>.</span><span>src</span> <span>=</span> <span>&#34;https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js&#34;</span><span>;</span>
    <span>document</span><span>.</span><span>head</span><span>.</span><span>appendChild</span><span>(</span><span>s</span><span>)</span><span>;</span>

    <span>s</span><span>.</span><span>onload</span> <span>=</span> <span>async</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>images</span> <span>=</span> <span>document</span><span>.</span><span>getElementsByTagName</span><span>(</span><span>&#34;img&#34;</span><span>)</span><span>;</span>
      <span>const</span> <span>worker</span> <span>=</span> <span>Tesseract</span><span>.</span><span>createWorker</span><span>(</span><span>)</span><span>;</span>
      <span>await</span> <span>worker</span><span>.</span><span>load</span><span>(</span><span>)</span><span>;</span>
      <span>await</span> <span>worker</span><span>.</span><span>loadLanguage</span><span>(</span><span>&#34;eng&#34;</span><span>)</span><span>;</span>
      <span>await</span> <span>worker</span><span>.</span><span>initialize</span><span>(</span><span>&#34;eng&#34;</span><span>)</span><span>;</span>
      <span>ocrButton</span><span>.</span><span>innerText</span> <span>=</span> <span>&#34;Running OCR...&#34;</span><span>;</span>

      <span>// Iterate through all the images in the output div</span>
      <span>for</span> <span>(</span><span>const</span> <span>img</span> <span>of</span> <span>images</span><span>)</span> <span>{</span>
        <span>const</span> <span>altTextarea</span> <span>=</span> <span>img</span><span>.</span><span>parentNode</span><span>.</span><span>querySelector</span><span>(</span><span>&#34;.textarea-alt&#34;</span><span>)</span><span>;</span>
        <span>// Check if the alt textarea is empty</span>
        <span>if</span> <span>(</span><span>altTextarea</span><span>.</span><span>value</span> <span>===</span> <span>&#34;&#34;</span><span>)</span> <span>{</span>
          <span>const</span> <span>imageUrl</span> <span>=</span> <span>img</span><span>.</span><span>src</span><span>;</span>
          <span>var</span> <span>{</span>
            <span>data</span>: <span>{</span> text <span>}</span><span>,</span>
          <span>}</span> <span>=</span> <span>await</span> <span>worker</span><span>.</span><span>recognize</span><span>(</span><span>imageUrl</span><span>)</span><span>;</span>
          <span>altTextarea</span><span>.</span><span>value</span> <span>=</span> <span>text</span><span>;</span> <span>// Set the OCR result to the alt textarea</span>
          <span>progressBar</span><span>.</span><span>value</span> <span>+=</span> <span>1</span><span>;</span>
        <span>}</span>
      <span>}</span>

      <span>await</span> <span>worker</span><span>.</span><span>terminate</span><span>(</span><span>)</span><span>;</span>
      <span>ocrButton</span><span>.</span><span>innerText</span> <span>=</span> <span>&#34;OCR complete&#34;</span><span>;</span>
    <span>}</span><span>;</span>
  <span>}</span></pre></div>
<p>Use these examples to put together a single HTML page with embedded HTML and CSS and JavaScript that provides a big square which users can drag and drop a PDF file onto and when they do that the PDF has every page converted to a JPEG and shown below on the page, then OCR is run with tesseract and the results are shown in textarea blocks below each image.</p>
</blockquote>
<p>I saved this prompt to a <code>prompt.txt</code> file and ran it using my <a href="https://github.com/simonw/llm-claude-3">llm-claude-3</a> plugin for <a href="https://llm.datasette.io/">LLM</a>:</p>
<div><pre>llm -m claude-3-opus <span>&lt;</span> prompt.txt</pre></div>
<p>It gave me <a href="https://static.simonwillison.net/static/2024/pdf-ocr-v1.html">a working initial version</a> on the first attempt!</p>
<p><img src="https://static.simonwillison.net/static/2024/ocr-v1.jpg" alt="A square dotted border around the text Drag and drop PDF file here"/></p>
<p><a href="https://gist.github.com/simonw/6a9f077bf8db616e44893a24ae1d36eb">Here’s the full transcript</a>, including my follow-up prompts and their responses. Iterating on software in this way is <em>so</em> much fun.</p>
<p>First follow-up:</p>
<blockquote>
<p>Modify this to also have a file input that can be used—dropping a file onto the drop area fills that input</p>
<p>make the drop zone 100% wide but have a 2em padding on the body. it should be 10em high. it should turn pink when an image is dragged over it.</p>
<p>Each textarea should be 100% wide and 10em high</p>
<p>At the very bottom of the page add a h2 that says Full document—then a 30em high textarea with all of the page text in it separated by two newlines</p>
</blockquote>
<p><a href="https://static.simonwillison.net/static/2024/pdf-ocr-v2.html">Here’s the interactive result</a>.</p>
<p><img src="https://static.simonwillison.net/static/2024/ocr-v2.jpg" alt="A PDF file is dragged over the box and it turned pink. The heading Full document displays below"/></p>
<p>And then:</p>
<blockquote>
<p>get rid of the code that shows image sizes. Set the placeholder on each textarea to be Processing... and clear that placeholder when the job is done.</p>
</blockquote>
<p><a href="https://static.simonwillison.net/static/2024/pdf-ocr-v3.html">Which gave me this</a>.</p>
<p>I noticed that it didn’t demo well on a phone, because you can’t drag and drop files in a mobile browser. So I fired up ChatGPT (for no reason other than curiosity to see how well it did) and got GPT-4 to add a file input feature for me. I <a href="https://chat.openai.com/share/665eca31-3b5d-4cd9-a3cb-85ab608169a6">pasted in the code so far and added</a>:</p>
<blockquote>
<p>Modify this so jpg and png and gif images can be dropped or opened too—they skip the PDF step and get appended to the page and OCRd directly. Also move the full document heading and textarea above the page preview and hide it u til there is data to be shown in it</p>
</blockquote>
<p>Then I spotted that the Tesseract worker was being created multiple times in a loop, which is inefficient—so I prompted:</p>
<blockquote>
<p>Create the worker once and use it for all OCR tasks and terminate it at the end</p>
</blockquote>
<p>I’d tweaked the HTML and CSS a little before feeding it to GPT-4, so now the site had a title and rendered in Helvetica.</p>
<p>Here’s <a href="https://static.simonwillison.net/static/2024/pdf-ocr-v4.html">the version GPT-4 produced for me</a>.</p>
<p><img src="https://static.simonwillison.net/static/2024/ocr-v4.jpg" alt="A heading reads OCR a PDF or Image - This tool runs entirely in your browser. No files are uploaded to a server. The dotted box now contains text that reads Drag and drop a PDF, JPG, PNG, or GIF file here or click to select a file"/></p>
<p>Rather delightfully it used the neater pattern where the file input itself is hidden but can be triggered by clicking on the large drop zone, and it updated the copy on the drop zone to reflect that—without me suggesting those requirements.</p>
<h4 id="ocr-finishing-touches">Manual finishing touches</h4>
<p>Fun though it was iterating on this project entirely through prompting, I decided it would be more productive to make the finishing touches myself. You can see those <a href="https://github.com/simonw/tools/commits/cc609194a0d0a54c2ae676dae962e14b3e3a9d22/">in the commit history</a>. They’re not particularly interesting:</p>
<ul>
<li>I added <a href="https://plausible.io/">Plausible</a> analytics (which I like because they use no cookies)</li>
<li>I moved the “full document” textarea to the top of the page, for convenience in copying out the full document when working with a PDF</li>
<li>I bumped up the width of the rendered PDF page images from 800 to 1000. This seemed to improve OCR quality—in particular, the <a href="https://www-cdn.anthropic.com/de8ba9b01c9ab7cbabf5c33b80b7bbc618857627/Model_Card_Claude_3.pdf">Claude 3 model card PDF</a> now has less OCR errors than it did before.</li>
<li>I upgraded both Tesseract.js and PDF.js to the most recent versions. Unsurprisingly, Claude 3 Opus had used older versions of both libraries.</li>
</ul>
<p>I’m really pleased with this project. I consider it <em>finished</em>—it does the job I designed it to do and I don’t see any need to keep on iterating on it. And because it’s all static JavaScript and WebAssembly I expect it to continue working effectively forever.</p>
</div>



</div></div>
  </body>
</html>
