<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.brendangregg.com/blog/2024-03-24/linux-crisis-tools.html">Original</a>
    <h1>Linux Crisis Tools</h1>
    
    <div id="readability-page-1" class="page"><div class="page">
	

	<div>
<!-- (this is for the blog) recent books: -->
<!-- <center><a href="https://informit.com/sale/booksgiving"><img border=0 width=180 src="/Images/booksgiving2021.jpg"></center><br><b>Book sale until Dec 1, 2021: 55% off for 2 or more</b></a><br><br> -->
<center><a href="https://www.brendangregg.com/systems-performance-2nd-edition-book.html"><img src="https://www.brendangregg.com/Images/sysperf2nd_bookcover_360.jpg" width="180"/></a></center><!--
<br><center><a href="https://www.portal.reinvent.awsevents.com/connect/search.ww?#loadSearch-searchPhrase=OPN303&searchType=session&tc=0&sortBy=abbreviationSort&p="><img src="/Images/Speaker/reInvent2019_200.jpg" width=180" border=0></a><br><font size=-2><i>I'm speaking at <a href="https://www.portal.reinvent.awsevents.com/connect/search.ww?#loadSearch-searchPhrase=OPN303&searchType=session&tc=0&sortBy=abbreviationSort&p=">AWS re:Invent 2019</a></i></font></center>
-->

	
	
	
	
<!--
	<br><center><a href="https://www.usenix.org/conference/lisa18"><img src="https://www.usenix.org/sites/default/files/lisa18_banner_join-me.png" width=180></a><br><font size=-2><i>I am program co-chair for LISA 2018</i></font></center>
-->
	</div>

        <div>
          

          <h2>Linux Crisis Tools</h2>
<p>24 Mar 2024</p>

<div>
<p>When you have an outage caused by a performance issue, you don&#39;t want to lose precious time just to install the tools needed to diagnose it. Here is a list of &#34;crisis tools&#34; I recommend installing on your Linux servers by default (if they aren&#39;t already), along with the (Ubuntu) package names that they come from:</p>

<ul><table>
<tbody><tr><th>Package</th><th>Provides</th><th>Notes</th></tr>
<tr><td>procps</td><td>ps(1), vmstat(8), uptime(1), top(1)</td><td>basic stats</td></tr>
<tr><td>util-linux</td><td>dmesg(1), lsblk(1), lscpu(1)</td><td>system log, device info</td></tr>
<tr><td>sysstat</td><td>iostat(1), mpstat(1), pidstat(1), sar(1)</td><td>device stats</td></tr>
<tr><td>iproute2</td><td>ip(8), ss(8), nstat(8), tc(8)</td><td>preferred net tools</td></tr>
<tr><td>numactl</td><td>numastat(8)</td><td>NUMA stats</td></tr>
<tr><td>tcpdump</td><td>tcpdump(8)</td><td>Network sniffer</td></tr>
<tr><td>linux-tools-common</td><td>perf(1), turbostat(8)</td><td>profiler and PMU stats</td></tr>
<tr><td>bpfcc-tools (bcc)</td><td>opensnoop(8), execsnoop(8), runqlat(8), softirqs(8),</td><td>canned eBPF tools[1]</td></tr>
<tr><td>bpftrace</td><td>bpftrace, basic versions of opensnoop(8),</td><td>eBPF scripting[1]</td></tr>
<tr><td>trace-cmd</td><td>trace-cmd(1)</td><td>Ftrace CLI</td></tr>
<tr><td>nicstat</td><td>nicstat(1)</td><td>net device stats</td></tr>
<tr><td>ethtool</td><td>ethtool(8)</td><td>net device info</td></tr>
<tr><td>tiptop</td><td>tiptop(1)</td><td>PMU/PMC top</td></tr>
<tr><td>cpuid</td><td>cpuid(1)</td><td>CPU details</td></tr>
<tr><td>msr-tools</td><td>rdmsr(8), wrmsr(8)</td><td>CPU digging</td></tr>
</tbody></table></ul>

<p>(This is based on Table 4.1 &#34;Linux Crisis Tools&#34; in <a href="https://www.brendangregg.com/systems-performance-2nd-edition-book.html">SysPerf 2</a>.)</p>

<ul><SPAN size="-1">Some longer notes: [1] bcc and bpftrace have many overlapping tools: the bcc ones are more capable (e.g., CLI options), and the bpftrace ones can be edited on the fly. But that&#39;s not to say that one is better or faster than the other: They emit the same BPF bytecode and are equally fast once running. Also note that bcc is evolving and migrating tools from Python to libbpf C (with CO-RE and BTF) but we haven&#39;t reworked the package yet. In the future &#34;bpfcc-tools&#34; should get replaced with a much smaller &#34;libbpf-tools&#34; package that&#39;s just tool binaries.</SPAN></ul>

<p>This list is a minimum. Some servers have accelerators and you&#39;ll want their analysis tools installed as well: e.g., on Intel GPU servers, the intel-gpu-tools package; on NVIDIA, nvidia-smi. Debugging tools, like gdb(1), can also be pre-installed for immediate use in a crisis.</p>

<p>Essential analysis tools like these don&#39;t change that often, so this list may only need updating every few years. If you think I missed a package that is important today, please let me know (e.g., in the comments).</p>

<p>The main downside of adding these packages is their on-disk size. On cloud instances, adding Mbytes to the base server image can add seconds, or fractions of a second, to instance deployment time. Fortunately the packages I&#39;ve listed are mostly quite small (and bcc will get smaller) and should cost little size and time. I have seen this size concern prevent debuginfo (totaling around 1 Gbyte) from being included by default.</p>

<h2>Can&#39;t I just install them later when needed?</h2>

<p>Many problems can occur when trying to install software during a production crisis. I&#39;ll step through a made-up example that combines some of the things I&#39;ve learned the hard way:</p>

<ul>
<li><strong>4:00pm</strong>: Alert! Your company&#39;s site goes down. No, some people say it&#39;s still up. Is it up? It&#39;s up but too slow to be usable.</li>
<li><strong>4:01pm</strong>: You look at your monitoring dashboards and a group of backend servers are abnormal. Is that high disk I/O? What&#39;s causing that?</li>
<li><strong>4:02pm</strong>: You SSH to one server to dig deeper, but SSH takes forever to login.</li>
<li><strong>4:03pm</strong>: You get a login prompt and type &#34;iostat -xz 1&#34; for basic disk stats to begin with. There is a long pause, and finally &#34;Command &#39;iostat&#39; not found...Try: sudo apt install sysstat&#34;. Ugh. Given how slow the system is, installing this package could take several minutes. You run the install command.</li>
<li><strong>4:07pm</strong>: The package install has failed as it can&#39;t resolve the repositories. Something is wrong with the /etc/apt configuration. Since the server owners are now in the SRE chatroom to help with the outage, you ask: &#34;how do you install system packages?&#34; They respond &#34;We never do. We only update our app.&#34; Ugh. You find a different server and copy its working /etc/apt config over.</li>
<li><strong>4:10pm</strong>: You need to run &#34;apt-get update&#34; first with the fixed config, but it&#39;s miserably slow.</li>
<li><strong>4:12pm</strong>: ...should it really be taking this long??</li>
<li><strong>4:13pm</strong>: apt returned &#34;failed: Connection timed out.&#34; Maybe this system is too slow with the performance issue? Or can&#39;t it connect to the repos? You begin network debugging and ask the server team: &#34;Do you use a firewall?&#34; They say they don&#39;t know, ask the network security team.</li>
<li><strong>4:17pm</strong>: The network security team have responded: Yes, they have blocked any unexpected traffic, including HTTP/HTTPS/FTP outbound apt requests. Gah. &#34;Can you edit the rules right now?&#34; &#34;It&#39;s not that easy.&#34; &#34;What about turning off the firewall completely?&#34; &#34;Uh, in an emergency, sure.&#34;</li>
<li><strong>4:20pm</strong>: The firewall is disabled. You run apt-get update again. It&#39;s slow, but works! Then apt-get install, and...permission errors. What!? I&#39;m root, this makes no sense. You share your error in the SRE chatroom and someone points out: Didn&#39;t the platform security team make the system <em>immutable</em>?</li>
<li><strong>4:24pm</strong>: The platform security team are now in the SRE chatroom explaining that some parts of the file system can be written to, but others, especially for executable binaries, are blocked. Gah! &#34;How do we disable this?&#34; &#34;You can&#39;t, that&#39;s the point. You&#39;d have to create new server images with it disabled.&#34; </li>
<li><strong>4:27pm</strong>: By now the SRE team has announced a major outage and informed the executive team, who want regular status updates and an ETA for when it will be fixed. Status: Haven&#39;t done much yet.</li>
<li><strong>4:30pm</strong>: You start running &#34;cat /proc/diskstats&#34; as a rudimentary iostat(1), but have to spend time reading the Linux source (admin-guide/iostats.rst) to make sense of it. It just confirms the disks are busy which you knew anyway from the monitoring dashboard. You really need the disk and file system tracing tools, like biosnoop(8), but you can&#39;t install them either. Unless you can hack up rudimentary tracing tools as well...You &#34;cd /sys/kernel/debug/tracing&#34; and start looking for the FTrace docs.</li>
<li><strong>4:55pm</strong>: New server images finally launch with all writable file systems. You login – gee it&#39;s fast – and &#34;apt-get install sysstat&#34;. Before you can even run iostat there are messages in the chatroom: &#34;Website&#39;s back up! Thanks! What did you do?&#34; &#34;We restarted the servers but we haven&#39;t fixed anything yet.&#34; You have the feeling that the outage will return exactly 10 minutes after you&#39;ve fallen asleep tonight.</li>
<li><strong>12:50am</strong>: Ping! I knew this would happen. You get out of bed and open your work laptop. The site is down – it&#39;s been hacked – someone disabled the firewall and file system security.</li>
</ul>

<p>I&#39;ve fortunately not experienced the 12:50am event, but the others are based on real world experiences. In my prior job this sequence can often take a different turn: a &#34;traffic team&#34; may initiate a cloud region failover by about the 15 minute mark, so I&#39;d eventually get iostat installed but then these systems would be idle.</p>

<h2>Default install</h2>

<p>The above scenario explains why you ideally want to pre-install crisis tools so you can start debugging a production issue quickly during an outage. Some companies already do this, and have OS teams that create custom server images with everything included. But there are many sites still running default versions of Linux that learn this the hard way. I&#39;d recommend Linux distros add these crisis tools to their enterprise Linux variants, so that companies large and small can hit the ground running when performance outages occur.</p>

</div>



</div>
</div></div>
  </body>
</html>
