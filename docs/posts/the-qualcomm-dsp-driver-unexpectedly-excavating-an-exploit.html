<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html">Original</a>
    <h1>The Qualcomm DSP Driver – Unexpectedly excavating an exploit</h1>
    
    <div id="readability-page-1" class="page"><div id="post-body-7918586333811798677" itemprop="description articleBody">
<meta content="text/html; charset=UTF-8" http-equiv="content-type"/><p><span>Posted by Seth Jenkins, Google Project Zero</span></p><p><span>This blog post provides a technical analysis of exploit artifacts provided to us by Google&#39;s Threat Analysis Group (TAG) from Amnesty International. Amnesty’s report on these exploits is available </span><span><a href="https://securitylab.amnesty.org/latest/2024/12/a-digital-prison-surveillance-and-the-suppression-of-civil-society-in-serbia/">here</a></span><span>. </span><span>Thanks to both Amnesty International and Google&#39;s Threat Analysis Group for providing the artifacts and collaborating on the subsequent technical analysis!</span></p><h2 id="h.9g2ubqaw4j4x"><span>Introduction</span></h2><p><span>Earlier this year, Google&#39;s TAG received some kernel panic logs generated by an In-the-Wild (ITW) exploit. Those logs kicked off a bug hunt that led to the discovery of 6 vulnerabilities in </span><span>one Qualcomm driver</span><span> over the course of 2.5 months, </span><span>including one issue that TAG reported as ITW</span><span>. This blog post covers the details of the original artifacts, each of the bugs discovered, and the hypothesized ITW exploit strategy gleaned from the logs.</span></p><h2 id="h.7paatm2vk7xg"><span>Artifacts</span></h2><p><span>Usually when successfully reverse-engineering an ITW exploit, Project Zero/</span><span>TAG</span><span> have had access to the exploit sample itself, making determining what vulnerability was exploited primarily a matter of time and effort. However, in this particular case, we received several kernel panic logs but unfortunately not the exploit sample. This meant we could not directly reproduce crashes or reverse engineer what bug was being exploited.</span></p><p><span>Accurately determining what vulnerability an exploit uses working only off of crash logs and without the exploit itself can range in difficulty from highly plausible to impossible. I decided to give it a try and see what I could learn. Out of the 6 panics we received, 4 panics in particular contained potentially useful information:</span></p><h5 id="h.cb4inbow4sw8"><span>Log 1:</span></h5><p><span></span><span>[</span><span>   </span><span>47.223480]</span><span> </span><span>adsprpc:</span><span> </span><span>fastrpc_init_process:</span><span> </span><span>untrusted</span><span> </span><span>app</span><span> </span><span>trying</span><span> </span><span>to</span><span> </span><span>attach</span><span> </span><span>to</span><span> </span><span>privileged</span><span> </span><span>DSP</span><span> </span><span>PD</span></p><p><span>[</span><span>   </span><span>47.254494]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xffffffff,</span><span> </span><span>va</span><span> </span><span>0xffffffffffffffff,</span><span> </span><span>len</span><span> </span><span>0xffffffff</span></p><p><span>[</span><span>   </span><span>47.254512]</span><span> </span><span>adsprpc:</span><span> </span><span>falcon:</span><span> </span><span>fastrpc_internal_mmap:</span><span> </span><span>ERROR:</span><span> </span><span>adding</span><span> </span><span>user</span><span> </span><span>allocated</span><span> </span><span>pages</span><span> </span><span>is</span><span> </span><span>not</span><span> </span><span>supported</span></p><p><span>[</span><span>   </span><span>47.261488]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xa,</span><span> </span><span>va</span><span> </span><span>0x0,</span><span> </span><span>len</span><span> </span><span>0x0</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>50.865579]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>NULL</span><span> </span><span>pointer</span><span> </span><span>dereference</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>0000000000000000</span></p><p><span>[</span><span>   </span><span>50.865586]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span>   </span><span>50.865590]</span><span>   </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000006</span></p><p><span>[</span><span>   </span><span>50.865593]</span><span>   </span><span>Exception</span><span> </span><span>class</span><span> </span><span>=</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[</span><span>   </span><span>50.865597]</span><span>   </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>50.865600]</span><span>   </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>50.865603]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span>   </span><span>50.865606]</span><span>   </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000006</span></p><p><span>[</span><span>   </span><span>50.865609]</span><span>   </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>50.865614]</span><span> </span><span>user</span><span> </span><span>pgtable:</span><span> </span><span>4k</span><span> </span><span>pages,</span><span> </span><span>39-bit</span><span> </span><span>VAs,</span><span> </span><span>pgdp</span><span> </span><span>=</span><span> </span><span>00000000f66703d3</span></p><p><span>[</span><span>   </span><span>50.865617]</span><span> </span><span>[0000000000000000]</span><span> </span><span>pgd=0000000213147003,</span><span> </span><span>pud=0000000213147003,</span><span> </span><span>pmd=0000000000000000</span></p><p><span>[</span><span>   </span><span>50.865624]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000006</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>50.865649]</span><span> </span><span>Process</span><span> </span><span>falcon</span><span> </span><span>(pid:</span><span> </span><span>8909,</span><span> </span><span>stack</span><span> </span><span>limit</span><span> </span><span>=</span><span> </span><span>0x000000000e91af69)</span></p><p><span>[</span><span>   </span><span>50.865654]</span><span> </span><span>CPU:</span><span> </span><span>5</span><span> </span><span>PID:</span><span> </span><span>8909</span><span> </span><span>Comm:</span><span> </span><span>falcon</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>      </span><span>W</span><span>  </span><span>O</span><span>      </span><span>4.19.157-perf-g8779875ad741</span><span> </span><span>#1</span></p><p><span>[</span><span>   </span><span>50.865657]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Qualcomm</span><span> </span><span>Technologies,</span><span> </span><span>Inc.</span><span> </span><span>xiaomi</span><span> </span><span>apollo</span><span> </span><span>(DT)</span></p><p><span>[</span><span>   </span><span>50.865661]</span><span> </span><span>pstate:</span><span> </span><span>00400005</span><span> </span><span>(nzcv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO)</span></p><p><span>[</span><span>   </span><span>50.865669]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>__list_del_entry_valid+0x34/0xd0</span></p><p><span>[</span><span>   </span><span>50.865672]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>dma_buf_detach+0x34/0xa0</span></p><p><span>[</span><span>   </span><span>50.865675]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffff802c7bb990</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>50.865735]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[</span><span>   </span><span>50.865739]</span><span>  </span><span>__list_del_entry_valid+0x34/0xd0</span></p><p><span>[</span><span>   </span><span>50.865742]</span><span>  </span><span>dma_buf_detach+0x34/0xa0</span></p><p><span>[</span><span>   </span><span>50.865746]</span><span>  </span><span>fastrpc_mmap_free+0x3e8/0x4d0</span></p><p><span>[</span><span>   </span><span>50.865749]</span><span>  </span><span>fastrpc_file_free+0x1a8/0x2e0</span></p><p><span>[</span><span>   </span><span>50.865753]</span><span>  </span><span>fastrpc_device_release+0x50/0x68</span></p><p><span>[</span><span>   </span><span>50.865757]</span><span>  </span><span>__fput+0xb8/0x1b0</span></p><p><span>[</span><span>   </span><span>50.865762]</span><span>  </span><span>____fput+0xc/0x18</span></p><p><span>[</span><span>   </span><span>50.865764]</span><span>  </span><span>task_work_run+0x8c/0xb0</span></p><p><span>[</span><span>   </span><span>50.865767]</span><span>  </span><span>do_exit+0x3fc/0xa10</span></p><p><span>[</span><span>   </span><span>50.865770]</span><span>  </span><span>do_group_exit+0x8c/0xa0</span></p><p><span>[</span><span>   </span><span>50.865773]</span><span>  </span><span>get_signal+0x7c8/0x958</span></p><p><span>[</span><span>   </span><span>50.865778]</span><span>  </span><span>do_notify_resume+0x148/0x23e8</span></p><p><span>[</span><span>   </span><span>50.865781]</span><span>  </span><span>work_pending+0x8/0x10</span></p><p><span>[</span><span>   </span><span>50.865785]</span><span> </span><span>Code:</span><span> </span><span>f9400669</span><span> </span><span>91040042</span><span> </span><span>eb02013f</span><span> </span><span>54000260</span><span> </span><span>(f9400122)</span></p><p><span>[</span><span>   </span><span>50.865789]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>42c589b65f43d4ee</span><span> </span><span>]---</span></p><p><span>[</span><span>   </span><span>50.865802]</span><span> </span><span>Kernel</span><span> </span><span>panic</span><span> </span><span>-</span><span> </span><span>not</span><span> </span><span>syncing:</span><span> </span><span>Fatal</span><span> </span><span>exception</span></p><p><span>We see right away from the first panic that the exploit appears to be targeting a driver called adsprpc. We also see from the stacktrace that the crash is happening when freeing a </span><span>fastrpc_mmap</span><span> struct - so it seems likely this is a heap exploit of some sort, and that a </span><span>fastrpc_mmap</span><span> struct is potentially involved.</span></p><h5 id="h.r5zalfh7d325"><span>Log 2:</span></h5><p><span></span><span>[</span><span>   </span><span>37.450199]</span><span> </span><span>adsprpc:</span><span> </span><span>fastrpc_init_process:</span><span> </span><span>untrusted</span><span> </span><span>app</span><span> </span><span>trying</span><span> </span><span>to</span><span> </span><span>attach</span><span> </span><span>to</span><span> </span><span>privileged</span><span> </span><span>DSP</span><span> </span><span>PD</span></p><p><span>[</span><span>   </span><span>37.482741]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xffffffff,</span><span> </span><span>va</span><span> </span><span>0xffffffffffffffff,</span><span> </span><span>len</span><span> </span><span>0xffffffff</span></p><p><span>[</span><span>   </span><span>37.482759]</span><span> </span><span>adsprpc:</span><span> </span><span>falcon:</span><span> </span><span>fastrpc_internal_mmap:</span><span> </span><span>ERROR:</span><span> </span><span>adding</span><span> </span><span>user</span><span> </span><span>allocated</span><span> </span><span>pages</span><span> </span><span>is</span><span> </span><span>not</span><span> </span><span>supported</span></p><p><span>[</span><span>   </span><span>37.486210]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xa,</span><span> </span><span>va</span><span> </span><span>0x0,</span><span> </span><span>len</span><span> </span><span>0x0</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>40.917577]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702834303,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>41.970037]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702834303,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>51.052781]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702834303,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>73.964765]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702834303,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>83.030394]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702834303,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>86.358103]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>paging</span><span> </span><span>request</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>0035fb968c5d536d</span></p><p><span>[</span><span>   </span><span>86.358118]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span>   </span><span>86.358122]</span><span>   </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000044</span></p><p><span>[</span><span>   </span><span>86.358127]</span><span>   </span><span>Exception</span><span> </span><span>class</span><span> </span><span>=</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[</span><span>   </span><span>86.358131]</span><span>   </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>86.358135]</span><span>   </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>86.358139]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span>   </span><span>86.358143]</span><span>   </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000044</span></p><p><span>[</span><span>   </span><span>86.358147]</span><span>   </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>1</span></p><p><span>[</span><span>   </span><span>86.358151]</span><span> </span><span>[0035fb968c5d536d]</span><span> </span><span>address</span><span> </span><span>between</span><span> </span><span>user</span><span> </span><span>and</span><span> </span><span>kernel</span><span> </span><span>address</span><span> </span><span>ranges</span></p><p><span>[</span><span>   </span><span>86.358159]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000044</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>86.358221]</span><span> </span><span>Process</span><span> </span><span>falcon</span><span> </span><span>(pid:</span><span> </span><span>7053,</span><span> </span><span>stack</span><span> </span><span>limit</span><span> </span><span>=</span><span> </span><span>0x00000000a7dfa97f)</span></p><p><span>[</span><span>   </span><span>86.358230]</span><span> </span><span>CPU:</span><span> </span><span>0</span><span> </span><span>PID:</span><span> </span><span>7053</span><span> </span><span>Comm:</span><span> </span><span>falcon</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>         </span><span>O</span><span>      </span><span>4.19.157-perf-g8779875ad741</span><span> </span><span>#1</span></p><p><span>[</span><span>   </span><span>86.358235]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Qualcomm</span><span> </span><span>Technologies,</span><span> </span><span>Inc.</span><span> </span><span>xiaomi</span><span> </span><span>apollo</span><span> </span><span>(DT)</span></p><p><span>[</span><span>   </span><span>86.358241]</span><span> </span><span>pstate:</span><span> </span><span>60400005</span><span> </span><span>(nZCv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO)</span></p><p><span>[</span><span>   </span><span>86.358259]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>fastrpc_file_free+0x1c4/0x2e0</span></p><p><span>[</span><span>   </span><span>86.358264]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>fastrpc_file_free+0x198/0x2e0</span></p><p><span>[</span><span>   </span><span>86.358268]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffff80264d3a50</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>86.358352]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[</span><span>   </span><span>86.358359]</span><span>  </span><span>fastrpc_file_free+0x1c4/0x2e0</span></p><p><span>[</span><span>   </span><span>86.358364]</span><span>  </span><span>fastrpc_device_release+0x50/0x68</span></p><p><span>[</span><span>   </span><span>86.358374]</span><span>  </span><span>__fput+0xb8/0x1b0</span></p><p><span>[</span><span>   </span><span>86.358380]</span><span>  </span><span>____fput+0xc/0x18</span></p><p><span>[</span><span>   </span><span>86.358387]</span><span>  </span><span>task_work_run+0x8c/0xb0</span></p><p><span>[</span><span>   </span><span>86.358394]</span><span>  </span><span>do_exit+0x3fc/0xa10</span></p><p><span>[</span><span>   </span><span>86.358399]</span><span>  </span><span>do_group_exit+0x8c/0xa0</span></p><p><span>[</span><span>   </span><span>86.358405]</span><span>  </span><span>get_signal+0x7c8/0x958</span></p><p><span>[</span><span>   </span><span>86.358412]</span><span>  </span><span>do_notify_resume+0x148/0x23e8</span></p><p><span>[</span><span>   </span><span>86.358418]</span><span>  </span><span>work_pending+0x8/0x10</span></p><p><span>[</span><span>   </span><span>86.358424]</span><span> </span><span>Code:</span><span> </span><span>b4ffff68</span><span> </span><span>f9400009</span><span> </span><span>f9000109</span><span> </span><span>b4fffee9</span><span> </span><span>(f9000528)</span></p><p><span>[</span><span>   </span><span>86.358430]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>9b01c55ca2d0bfea</span><span> </span><span>]---</span></p><p><span>[</span><span>   </span><span>86.358452]</span><span> </span><span>Kernel</span><span> </span><span>panic</span><span> </span><span>-</span><span> </span><span>not</span><span> </span><span>syncing:</span><span> </span><span>Fatal</span><span> </span><span>exception</span></p><p><span>Here’s another crash in the adsprpc driver, this time associated with a </span><span>fastrpc_file</span><span> struct which is associated with a </span><span>struct file</span><span> which itself is the backing object referenced by a file descriptor. We </span><span>also</span><span> see that the exploit appears to have gotten farther in the exploit process this time and was making multiple calls to </span><span>fastrpc_mmap_free</span><span>. Notably the channel id is set to this very large value: </span><span>1702834303</span><span>. Channel id’s can’t usually be set this high. While the maximum value varies from version to version, valid channel ids are in the range from 0 to about 6, so it’s clear that there is somehow memory corruption of the channel id (</span><span>cid</span><span>). It is also notable that the channel id value is set to a Unix epoch timestamp value - something Donncha of Amnesty noticed in the course of investigation. </span><span>1702834303</span><span> represents the date Sunday, December 17, 2023 5:31:43 PM </span><span>which is quite close to when the exploit was thrown…why could this be?</span></p><h5 id="h.yqzvddyah23d"><span>Log 3:</span></h5><p><span></span><span>[</span><span> </span><span>2244.639158]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:</span><span> </span><span>fastrpc_internal_mmap:</span><span> </span><span>user</span><span> </span><span>application</span><span> </span><span>falcon</span><span> </span><span>trying</span><span> </span><span>to</span><span> </span><span>map</span><span> </span><span>without</span><span> </span><span>initialization</span></p><p><span>...</span></p><p><span>[</span><span> </span><span>2244.641272]</span><span> </span><span>adsprpc:</span><span> </span><span>falcon:</span><span> </span><span>fastrpc_init_process:</span><span> </span><span>ERROR:</span><span> </span><span>donated</span><span> </span><span>memory</span><span> </span><span>allocated</span><span> </span><span>in</span><span> </span><span>userspace</span></p><p><span>[</span><span> </span><span>2244.683779]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xffffffff,</span><span> </span><span>va</span><span> </span><span>0xffffffffffffffff,</span><span> </span><span>len</span><span> </span><span>0xffffffff</span></p><p><span>[</span><span> </span><span>2244.683794]</span><span> </span><span>adsprpc:</span><span> </span><span>falcon:</span><span> </span><span>fastrpc_internal_mmap:</span><span> </span><span>ERROR:</span><span> </span><span>adding</span><span> </span><span>user</span><span> </span><span>allocated</span><span> </span><span>pages</span><span> </span><span>is</span><span> </span><span>not</span><span> </span><span>supported</span></p><p><span>[</span><span> </span><span>2244.689633]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0x9,</span><span> </span><span>va</span><span> </span><span>0x0,</span><span> </span><span>len</span><span> </span><span>0x0</span></p><p><span>[</span><span> </span><span>2247.159424]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>paging</span><span> </span><span>request</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>006f7778a9cf5b88</span></p><p><span>[</span><span> </span><span>2247.159442]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span> </span><span>2247.159446]</span><span>   </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000004</span></p><p><span>[</span><span> </span><span>2247.159453]</span><span>   </span><span>Exception</span><span> </span><span>class</span><span> </span><span>=</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[</span><span> </span><span>2247.159458]</span><span>   </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span> </span><span>2247.159462]</span><span>   </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span> </span><span>2247.159468]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span> </span><span>2247.159472]</span><span>   </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000004</span></p><p><span>[</span><span> </span><span>2247.159476]</span><span>   </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span> </span><span>2247.159481]</span><span> </span><span>[006f7778a9cf5b88]</span><span> </span><span>address</span><span> </span><span>between</span><span> </span><span>user</span><span> </span><span>and</span><span> </span><span>kernel</span><span> </span><span>address</span><span> </span><span>ranges</span></p><p><span>[</span><span> </span><span>2247.159489]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000004</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>...</span></p><p><span>[</span><span> </span><span>2247.159572]</span><span> </span><span>Process</span><span> </span><span>falcon</span><span> </span><span>(pid:</span><span> </span><span>17512,</span><span> </span><span>stack</span><span> </span><span>limit</span><span> </span><span>=</span><span> </span><span>0x00000000c911fea5)</span></p><p><span>[</span><span> </span><span>2247.159582]</span><span> </span><span>CPU:</span><span> </span><span>0</span><span> </span><span>PID:</span><span> </span><span>17512</span><span> </span><span>Comm:</span><span> </span><span>falcon</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>      </span><span>W</span><span>  </span><span>O</span><span>      </span><span>4.19.157-perf-g8779875ad741</span><span> </span><span>#1</span></p><p><span>[</span><span> </span><span>2247.159587]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Qualcomm</span><span> </span><span>Technologies,</span><span> </span><span>Inc.</span><span> </span><span>xiaomi</span><span> </span><span>apollo</span><span> </span><span>(DT)</span></p><p><span>[</span><span> </span><span>2247.159595]</span><span> </span><span>pstate:</span><span> </span><span>60400005</span><span> </span><span>(nZCv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO)</span></p><p><span>[</span><span> </span><span>2247.159614]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>__kmalloc+0x1c4/0x398</span></p><p><span>[</span><span> </span><span>2247.159619]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>__kmalloc+0x60/0x398</span></p><p><span>[</span><span> </span><span>2247.159623]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffff8029173b80</span></p><p><span>...</span></p><p><span>[</span><span> </span><span>2247.159719]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[</span><span> </span><span>2247.159727]</span><span>  </span><span>__kmalloc+0x1c4/0x398</span></p><p><span>[</span><span> </span><span>2247.159740]</span><span>  </span><span>inotify_handle_event+0xc8/0x1c8</span></p><p><span>[</span><span> </span><span>2247.159746]</span><span>  </span><span>fsnotify+0x270/0x378</span></p><p><span>[</span><span> </span><span>2247.159753]</span><span>  </span><span>__fsnotify_parent+0xdc/0x138</span></p><p><span>[</span><span> </span><span>2247.159763]</span><span>  </span><span>notify_change2+0x314/0x348</span></p><p><span>[</span><span> </span><span>2247.159771]</span><span>  </span><span>do_sys_ftruncate+0x190/0x1c0</span></p><p><span>[</span><span> </span><span>2247.159776]</span><span>  </span><span>__arm64_sys_ftruncate+0x1c/0x28</span></p><p><span>[</span><span> </span><span>2247.159786]</span><span>  </span><span>el0_svc_common+0x98/0x160</span></p><p><span>[</span><span> </span><span>2247.159792]</span><span>  </span><span>el0_svc_handler+0x68/0x80</span></p><p><span>[</span><span> </span><span>2247.159800]</span><span>  </span><span>el0_svc+0x8/0xc</span></p><p><span>[</span><span> </span><span>2247.159808]</span><span> </span><span>Code:</span><span> </span><span>b4000a77</span><span> </span><span>b940230a</span><span> </span><span>f940bf0b</span><span> </span><span>8b0a02ea</span><span> </span><span>(f940014c)</span></p><p><span>[</span><span> </span><span>2247.159815]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>3729c600fbf1ba28</span><span> </span><span>]---</span></p><p><span>[</span><span> </span><span>2247.159842]</span><span> </span><span>Kernel</span><span> </span><span>panic</span><span> </span><span>-</span><span> </span><span>not</span><span> </span><span>syncing:</span><span> </span><span>Fatal</span><span> </span><span>exception</span></p><p><span>Again we see adsprpc driver logs, but it culminates in a crash within the context of the exploit process in a different part of the code entirely - this time from the inotify subsystem. We will revisit the importance of this crash later.</span></p><h5 id="h.ntm9w7ryhnoi"><span>Log 4:</span></h5><p><span></span><span>[</span><span>   </span><span>67.167510]</span><span> </span><span>adsprpc:</span><span> </span><span>fastrpc_init_process:</span><span> </span><span>untrusted</span><span> </span><span>app</span><span> </span><span>trying</span><span> </span><span>to</span><span> </span><span>attach</span><span> </span><span>to</span><span> </span><span>privileged</span><span> </span><span>DSP</span><span> </span><span>PD</span></p><p><span>[</span><span>   </span><span>67.202061]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xffffffff,</span><span> </span><span>va</span><span> </span><span>0xffffffffffffffff,</span><span> </span><span>len</span><span> </span><span>0xffffffff</span></p><p><span>[</span><span>   </span><span>67.202084]</span><span> </span><span>adsprpc:</span><span> </span><span>falcon:</span><span> </span><span>fastrpc_internal_mmap:</span><span> </span><span>ERROR:</span><span> </span><span>adding</span><span> </span><span>user</span><span> </span><span>allocated</span><span> </span><span>pages</span><span> </span><span>is</span><span> </span><span>not</span><span> </span><span>supported</span></p><p><span>[</span><span>   </span><span>67.207916]</span><span> </span><span>adsprpc:</span><span> </span><span>mapping</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>to</span><span> </span><span>unmap</span><span> </span><span>fd</span><span> </span><span>0xa,</span><span> </span><span>va</span><span> </span><span>0x0,</span><span> </span><span>len</span><span> </span><span>0x0</span></p><p><span>[</span><span>   </span><span>69.577152]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702832054,</span><span> </span><span>err:-44</span></p><p><span>[</span><span>   </span><span>70.621863]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702832054,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>79.689300]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702832054,</span><span> </span><span>err:-44</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>97.574406]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>NULL</span><span> </span><span>pointer</span><span> </span><span>dereference</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>0000000000000009</span></p><p><span>[</span><span>   </span><span>97.574435]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span>   </span><span>97.574445]</span><span>   </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000006</span></p><p><span>[</span><span>   </span><span>97.574457]</span><span>   </span><span>Exception</span><span> </span><span>class</span><span> </span><span>=</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[</span><span>   </span><span>97.574467]</span><span>   </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>97.574476]</span><span>   </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>97.574485]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[</span><span>   </span><span>97.574495]</span><span>   </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000006</span></p><p><span>[</span><span>   </span><span>97.574504]</span><span>   </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[</span><span>   </span><span>97.574522]</span><span> </span><span>user</span><span> </span><span>pgtable:</span><span> </span><span>4k</span><span> </span><span>pages,</span><span> </span><span>39-bit</span><span> </span><span>VAs,</span><span> </span><span>pgdp</span><span> </span><span>=</span><span> </span><span>00000000ad40fd5a</span></p><p><span>[</span><span>   </span><span>97.574532]</span><span> </span><span>[0000000000000009]</span><span> </span><span>pgd=00000001cadcb003,</span><span> </span><span>pud=00000001cadcb003,</span><span> </span><span>pmd=0000000000000000</span></p><p><span>[</span><span>   </span><span>97.574554]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000006</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>97.574680]</span><span> </span><span>Process</span><span> </span><span>falcon</span><span> </span><span>(pid:</span><span> </span><span>10050,</span><span> </span><span>stack</span><span> </span><span>limit</span><span> </span><span>=</span><span> </span><span>0x00000000eac9e565)</span></p><p><span>[</span><span>   </span><span>97.574700]</span><span> </span><span>CPU:</span><span> </span><span>0</span><span> </span><span>PID:</span><span> </span><span>10050</span><span> </span><span>Comm:</span><span> </span><span>falcon</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>         </span><span>O</span><span>      </span><span>4.19.157-perf-g8779875ad741</span><span> </span><span>#1</span></p><p><span>[</span><span>   </span><span>97.574711]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Qualcomm</span><span> </span><span>Technologies,</span><span> </span><span>Inc.</span><span> </span><span>xiaomi</span><span> </span><span>apollo</span><span> </span><span>(DT)</span></p><p><span>[</span><span>   </span><span>97.574726]</span><span> </span><span>pstate:</span><span> </span><span>00400005</span><span> </span><span>(nzcv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO)</span></p><p><span>[</span><span>   </span><span>97.574756]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>pipe_read+0xac/0x308</span></p><p><span>[</span><span>   </span><span>97.574769]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>pipe_read+0x4c/0x308</span></p><p><span>[</span><span>   </span><span>97.574778]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffff802e43bc80</span></p><p><span>...</span></p><p><span>[</span><span>   </span><span>97.574982]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[</span><span>   </span><span>97.574996]</span><span>  </span><span>pipe_read+0xac/0x308</span></p><p><span>[</span><span>   </span><span>97.575014]</span><span>  </span><span>__vfs_read+0xf8/0x140</span></p><p><span>[</span><span>   </span><span>97.575027]</span><span>  </span><span>vfs_read+0xb8/0x150</span></p><p><span>[</span><span>   </span><span>97.575039]</span><span>  </span><span>ksys_read+0x6c/0xd0</span></p><p><span>[</span><span>   </span><span>97.575053]</span><span>  </span><span>__arm64_sys_read+0x18/0x20</span></p><p><span>[</span><span>   </span><span>97.575071]</span><span>  </span><span>el0_svc_common+0x98/0x160</span></p><p><span>[</span><span>   </span><span>97.575083]</span><span>  </span><span>el0_svc_handler+0x68/0x80</span></p><p><span>[</span><span>   </span><span>97.575097]</span><span>  </span><span>el0_svc+0x8/0xc</span></p><p><span>[</span><span>   </span><span>97.575114]</span><span> </span><span>Code:</span><span> </span><span>aa1c03fb</span><span> </span><span>aa1c03e1</span><span> </span><span>b840ce68</span><span> </span><span>f8410f69</span><span> </span><span>(f9400529)</span></p><p><span>[</span><span>   </span><span>97.575127]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>72c08623f6dedcd7</span><span> </span><span>]---</span></p><p><span>[</span><span>   </span><span>97.575174]</span><span> </span><span>Kernel</span><span> </span><span>panic</span><span> </span><span>-</span><span> </span><span>not</span><span> </span><span>syncing:</span><span> </span><span>Fatal</span><span> </span><span>exception</span></p><p><span>We see here a fourth type of crash, this time in the pipe subsystem. Pipe buffers are often used as a spray object for heap exploitation, and it wouldn’t be terribly surprising if that were the case here.</span></p><p><span>There are several valuable pieces of information to glean from the logs - the most meaningful being the usage of this adsprpc driver. We </span><span>also</span><span> see log lines from several adsprpc functions:</span></p><ul><li><span>fastrpc_init_process</span></li><li><span>fastrpc_internal_munmap_fd</span></li><li><span>fastrpc_internal_mmap</span></li><li><span>fastrpc_mmap_free</span></li></ul><p><span>It is likely the bug used by the attacker resides somewhere in the relationships between these functions, but exactly </span><span>where</span><span> is</span><span> not clear from the logs alone. The functions that are executed by the exploit only serve to complicate the investigation, as the exploit seems to constantly hit very early</span><span> bailouts</span><span> that shouldn’t cause any change in kernel state whatsoever.</span></p><p><span>Upon additional investigation (by Jann Horn in particular!) it became clear that this driver is accessible from a spectrum of unprivileged contexts. </span><span>untrusted_app</span><span> does not have the ability to directly open the driver device file, but at least on some devices it can obtain limited access by receiving a file descriptor to the device file from the </span><span>dspservice</span><span> process through the </span><span>IDspService</span><span> HAL interface, which is reachable through </span><span>hwbinder</span><span>.</span></p><p><span><a href="https://googleprojectzero.blogspot.com/2024/06/driving-forward-in-android-drivers.html">As we’ve seen before</a></span><span>, third-party </span><span>Android drivers</span><span> are appealingly buggy attack surfaces, regularly containing a reservoir of potential vulnerabilities for attackers. While it wasn’t immediately clear what vulnerability the attackers had exploited, it </span><span>was</span><span> clear that performing a more thorough audit of this driver was warranted.</span></p><h2 id="h.szhd4ck9ddkp"><span>The adsprpc Driver</span></h2><p><span>The </span><span><a href="https://pages.cs.wisc.edu/%257Edanav/pubs/qcom/hexagon_micro2014_v6.pdf">Application</a></span><span> Digital Signal Processor Remote Procedure Call driver (or adsprpc for short) is primarily used for offloading multimedia processing to a more efficient DSP co-processor core. The driver is primarily accessed through the </span><span>/dev/adsprpc-smd</span><span> character device file although historically it could be reached via a variety of device files including </span><span>cdsprpc-smd</span><span> and </span><span>mdsprpc-smd</span><span>. The driver’s architecture is helpfully thoroughly described in </span><span><a href="https://android.googlesource.com/kernel/msm/%2B/android-msm-flo-3.4-kitkat-mr1/Documentation/arm/msm/adsprpc-drv.txt">the kernel documentation</a></span><span>. Through this driver, co-processor routines are exposed to the application processor userland (including </span><span>untrusted_app</span><span> processes) via an RPC interface, providing an efficient abstraction methodology by which multimedia processing can be offloaded to the specialized hardware in the SoC. Through the use of DMA buffers that are mapped directly onto the DSP core, adsprpc looks to minimize the amount of data copied across the processor boundary. This featureset is necessarily complex, and that makes it a ripe target for in-depth security research.</span></p><h2 id="h.h2hp459hfm1a"><span>The Bughunt Begins</span></h2><p><span>Having given up on discovering the bug exploited in the ITW logs directly, it was time to start a broader code review process. This turned out to be a very productive research decision. Jann found the first bug quite quickly, and over the course of the next several months, I found 5 more. I’ve described each of the bugs below.</span></p><h4 id="h.ph2uuuphzaot"><span><a href="https://project-zero.issues.chromium.org/issues/42451711">CVE-2024-38402: refcount leak leading to UAF in fastrpc_get_process_gids</a></span></h4><p><span>T</span><span>he first discovered vulnerability in the driver is a refcount leak of the </span><span>group_info</span><span> struct associated with the task that leads to a UAF. In the function </span><span>fastrpc_get_process_gids</span><span>, </span><span>get_current_groups</span><span> is called which increments a refcount on the </span><span>group_info</span><span> struct, but that refcount is never dropped. Furthermore, this refcount is a non-saturating refcount which makes it possible to overflow if you execute </span><span>fastrpc_get_process_gids</span><span> approximately 2^32 times. This is a difficult bug to exploit in practice, taking at least 14 hours to trigger, but it’s nevertheless memory corruption with all the associated consequences.</span><span> An example crash from this issue is below:</span></p><p><span></span><span>[77306.174599]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>BUG:</span><span> </span><span>KFENCE:</span><span> </span><span>invalid</span><span> </span><span>read</span><span> </span><span>in</span><span> </span><span>groups_to_user+0x34/0x1a4</span><span>  </span></p><p><span>[77306.174606]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>Invalid</span><span> </span><span>read</span><span> </span><span>at</span><span> </span><span>0xffffff89572a0000:</span><span>  </span></p><p><span>[77306.174607]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>groups_to_user+0x34/0x1a4</span><span>  </span></p><p><span>[77306.174609]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>invoke_syscall+0x58/0x13c</span><span>  </span></p><p><span>[77306.174612]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0_svc_common+0xb4/0xf0</span><span>  </span></p><p><span>[77306.174614]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>do_el0_svc+0x24/0x90</span><span>  </span></p><p><span>[77306.174615]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0_svc+0x20/0x7c</span><span>  </span></p><p><span>[77306.174617]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0t_64_sync_handler+0x84/0xe4</span><span>  </span></p><p><span>[77306.174618]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0t_64_sync+0x1b8/0x1bc</span><span>  </span></p><p><span>[77306.174620]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>   </span></p><p><span>[77306.174621]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>CPU:</span><span> </span><span>7</span><span> </span><span>PID:</span><span> </span><span>5455</span><span> </span><span>Comm:</span><span> </span><span>adbd</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>      </span><span>W</span><span>  </span><span>OE</span><span>     </span><span>5.15.123-android13-8-28577312-abS911BXXU3CXD3</span><span> </span><span>#1</span><span>  </span></p><p><span>[77306.174623]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Samsung</span><span> </span><span>DM1Q</span><span> </span><span>PROJECT</span><span> </span><span>(board-id,13)</span><span> </span><span>(DT)</span><span>  </span></p><p><span>[77306.174624]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>pstate:</span><span> </span><span>22400005</span><span> </span><span>(nzCv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO</span><span> </span><span>+TCO</span><span> </span><span>-DIT</span><span> </span><span>-SSBS</span><span> </span><span>BTYPE=--)</span><span>  </span></p><p><span>[77306.174626]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>groups_to_user+0x34/0x1a4</span><span>  </span></p><p><span>[77306.174628]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>__arm64_sys_getgroups+0x4c/0x6c</span><span>  </span></p><p><span>[77306.174629]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffffc02a073e00</span><span>  </span></p><p><span>[77306.174630]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x29:</span><span> </span><span>ffffffc02a073e00</span><span> </span><span>x28:</span><span> </span><span>ffffff8868030040</span><span> </span><span>x27:</span><span> </span><span>0000000000000000</span><span>  </span></p><p><span>[77306.174633]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x26:</span><span> </span><span>0000000000000000</span><span> </span><span>x25:</span><span> </span><span>0000000000000000</span><span> </span><span>x24:</span><span> </span><span>0000000000000000</span><span>  </span></p><p><span>[77306.174635]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x23:</span><span> </span><span>0000000060001000</span><span> </span><span>x22:</span><span> </span><span>00000077219a4f2c</span><span> </span><span>x21:</span><span> </span><span>ffffff8868030040</span><span>  </span></p><p><span>[77306.174637]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x20:</span><span> </span><span>ffffffc0081bd46c</span><span> </span><span>x19:</span><span> </span><span>000000006b6b6b6b</span><span> </span><span>x18:</span><span> </span><span>ffffffc016089000</span><span>  </span></p><p><span>[77306.174638]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x17:</span><span> </span><span>000000000000fffe</span><span> </span><span>x16:</span><span> </span><span>b4000074e392f638</span><span> </span><span>x15:</span><span> </span><span>ffffff895729fff8</span><span>  </span></p><p><span>[77306.174640]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x14:</span><span> </span><span>00000000524e68f8</span><span> </span><span>x13:</span><span> </span><span>ffffff8868030040</span><span> </span><span>x12:</span><span> </span><span>ffffffc00ad82000</span><span>  </span></p><p><span>[77306.174641]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x11:</span><span> </span><span>0000007fffffffff</span><span> </span><span>x10:</span><span> </span><span>ffffffc00aa93000</span><span> </span><span>x9</span><span> </span><span>:</span><span> </span><span>0000000014939a3e</span><span>  </span></p><p><span>[77306.174643]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x8</span><span> </span><span>:</span><span> </span><span>000000006b6b6b6b</span><span> </span><span>x7</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span><span>x6</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span>  </span></p><p><span>[77306.174645]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x5</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span><span>x4</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span><span>x3</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span>  </span></p><p><span>[77306.174646]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>x2</span><span> </span><span>:</span><span> </span><span>0000000000000040</span><span> </span><span>x1</span><span> </span><span>:</span><span> </span><span>ffffff8904db9700</span><span> </span><span>x0</span><span> </span><span>:</span><span> </span><span>b400007491448d40</span><span>  </span></p><p><span>[77306.174648]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span> </span><span>Call</span><span> </span><span>trace:</span><span>  </span></p><p><span>[77306.174648]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>groups_to_user+0x34/0x1a4</span><span>  </span></p><p><span>[77306.174650]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>invoke_syscall+0x58/0x13c</span><span>  </span></p><p><span>[77306.174651]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0_svc_common+0xb4/0xf0</span><span>  </span></p><p><span>[77306.174653]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>do_el0_svc+0x24/0x90</span><span>  </span></p><p><span>[77306.174654]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0_svc+0x20/0x7c</span><span>  </span></p><p><span>[77306.174655]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0t_64_sync_handler+0x84/0xe4</span><span>  </span></p><p><span>[77306.174656]</span><span> </span><span>[7:</span><span>           </span><span>adbd:</span><span> </span><span>5455]</span><span>  </span><span>el0t_64_sync+0x1b8/0x1bc</span><span>  </span></p><h4 id="h.q4wmlexvys1"><span><a href="https://project-zero.issues.chromium.org/issues/42451710">CVE-2024-21455: is_compat flag leads to access of userland provided addresses as kernel pointers</a></span></h4><p><span>In order to support 32-bit userland processes, 64-bit kernels contain a “compatibility layer” that ioctls can support. This layer is responsible for marshaling over 32-bit structs into their 64-bit equivalents which involves upcasting 32-bit userland pointers into 64-bit pointers. The adsprpc driver handles this case in the </span><span>adsprpc_compat.c</span><span> file. It allocates kernel memory, copies and converts the 32-bit struct into that kernel memory as a 64-bit struct, and then calls the 64-bit ioctl interface. The 64-bit ioctl interface thus needs to handle calls coming from both the 32-bit kernel compatibility layer and from 64-bit userland. In order to provide this support, the 32-bit compatibility layer indicates to the broader adsprpc driver that the 32-bit compatibility layer is in use by setting a flag </span><span>is_compat</span><span> in the file-descriptor-bound </span><span>fl</span><span> struct.</span></p><p><span></span><span>long</span><span> </span><span>compat_fastrpc_device_ioctl(</span><span>struct</span><span> </span><span>file</span><span> </span><span>*filp,</span><span> </span><span>unsigned</span><span> </span><span>int</span><span> </span><span>cmd,</span></p><p><span>                                </span><span>unsigned</span><span> </span><span>long</span><span> </span><span>arg)</span></p><p><span>{</span></p><p><span>        </span><span>int</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>        </span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl</span><span> </span><span>=</span><span> </span><span>(</span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*)filp-&gt;private_data;</span></p><p><span>        </span><span>if</span><span> </span><span>(!filp-&gt;f_op</span><span> </span><span>||</span><span> </span><span>!filp-&gt;f_op-&gt;unlocked_ioctl)</span></p><p><span>                </span><span>return</span><span> </span><span>-ENOTTY;</span></p><p><span>        </span><span>fl-&gt;is_compat</span><span> </span><span>=</span><span> </span><span>true;</span></p><p><span>...</span></p><p><span>}</span></p><p><span>Later on, that </span><span>is_compat</span><span> flag is used in calls to </span><span>K_COPY_FROM_USER</span><span> to make decisions about whether to use </span><span>memmove</span><span> (32-bit compatibility layer or other kernel invocation) or </span><span>copy_from_user</span><span>.</span></p><p><span></span><span>#define</span><span> </span><span>K_COPY_FROM_USER(err,</span><span> </span><span>kernel,</span><span> </span><span>dst,</span><span> </span><span>src,</span><span> </span><span>size)</span><span> </span><span>\</span></p><p><span>        </span><span>do</span><span> </span><span>{\</span></p><p><span>                </span><span>if</span><span> </span><span>(!(kernel))\</span></p><p><span>                        </span><span>err</span><span> </span><span>=</span><span> </span><span>copy_from_user((dst),\</span></p><p><span>                        </span><span>(</span><span>void</span><span> </span><span>const</span><span> </span><span>__user</span><span> </span><span>*)(src),\</span></p><p><span>                        </span><span>(size));\</span></p><p><span>                </span><span>else</span><span>\</span></p><p><span>                        </span><span>memmove((dst),</span><span> </span><span>(src),</span><span> </span><span>(size));\</span></p><p><span>        </span><span>}</span><span> </span><span>while</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>...</span><span></span><span> </span><span>fastrpc_internal_invoke2(</span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl,</span></p><p><span>                                </span><span>struct</span><span> </span><span>fastrpc_ioctl_invoke2</span><span> </span><span>*inv2)</span></p><p><span>{</span></p><p><span>switch</span><span> </span><span>(inv2-&gt;req)</span><span> </span><span>{</span></p><p><span>        </span><span>case</span><span> </span><span>FASTRPC_INVOKE2_ASYNC:</span></p><p><span>                </span><span>...</span></p><p><span>                        </span><span>K_COPY_FROM_USER(err,</span><span> </span><span>fl-&gt;is_compat,</span><span> </span><span>&amp;p.inv3,</span><span> </span><span>(</span><span>void</span><span>*)inv2-&gt;invparam,</span><span> </span><span>sizeof</span><span>(</span><span>struct</span><span> </span><span>fastrpc_ioctl_invoke_async_no_perf));</span></p><p><span>...</span></p><p><span>}</span></p><p><span>However, this flag is set at a relatively global level in that any other ioctl calls on the same file descriptor will see that this flag is set. Furthermore, once the flag is set, it is never UNset. Consider the following scenario:</span></p><ol start="1"><li><span>A malicious 64-bit process A opens the </span><span>adsprpc-smd</span><span> file, creating a new adsprpc file descriptor</span></li><li><span>Process A forks and creates a new 32-bit process B (A and B share the adsprpc fd/</span><span>fl</span><span>)</span></li><li><span>Process B invokes the 32-bit ioctl interface (thusly setting the </span><span>is_compat</span><span> flag) and exits</span></li><li><span>Process A invokes the 64-bit ioctl interface</span></li></ol><p><span>In this circumstance, the driver incorrectly thinks that the request is coming from the 32-bit compatibility layer (since </span><span>is_compat</span><span> is set) and that it should access the struct as if it contained </span><span>kernel</span><span> pointers while it is in fact a request coming from 64-bit </span><span>userland</span><span> containing untrusted </span><span>userland-provided</span><span> pointers (which could in a malicious case be kernel pointers!). The kernel will subsequently use an unsafe </span><span>memmove</span><span> to access these pointers, leading to userland controlled reads of kernel addresses.</span></p><p><span></span><span>[49468.514358]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>paging</span><span> </span><span>request</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>ffffffff41414141</span></p><p><span>[49468.514397]</span><span> </span><span>PC</span><span> </span><span>Code:</span><span> </span><span>d65f03c0</span><span> </span><span>d503201f</span><span> </span><span>(a9401c26)</span><span> </span><span>a9412428</span></p><p><span>[49468.514407]</span><span> </span><span>LR</span><span> </span><span>Code:</span><span> </span><span>340003a8</span><span> </span><span>957474dd</span><span> </span><span>(f9401be8)</span><span> </span><span>f90023e8</span></p><p><span>[49468.514413]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[49468.514418]</span><span> </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000005</span></p><p><span>[49468.514426]</span><span> </span><span>EC</span><span> </span><span>=</span><span> </span><span>0x25:</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[49468.514433]</span><span> </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[49468.514440]</span><span> </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[49468.514445]</span><span> </span><span>FSC</span><span> </span><span>=</span><span> </span><span>0x05:</span><span> </span><span>level</span><span> </span><span>1</span><span> </span><span>translation</span><span> </span><span>fault</span></p><p><span>[49468.514452]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[49468.514456]</span><span> </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000005</span></p><p><span>[49468.514463]</span><span> </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[49468.514469]</span><span> </span><span>swapper</span><span> </span><span>pgtable:</span><span> </span><span>4k</span><span> </span><span>pages,</span><span> </span><span>39-bit</span><span> </span><span>VAs,</span><span> </span><span>pgdp=00000000aa728000</span></p><p><span>[49468.514479]</span><span> </span><span>[ffffffff41414141]</span><span> </span><span>pgd=0000000000000000,</span><span> </span><span>p4d=0000000000000000,</span><span> </span><span>pud=0000000000000000</span></p><p><span>[49468.514502]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000005</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>[49468.514780]</span><span> </span><span>sec_arm64_ap_context:sec_arm64_ap_context_on_die()</span><span> </span><span>context</span><span> </span><span>saved</span><span> </span><span>(CPU:6)</span></p><p><span>[49468.514788]</span><span> </span><span>Modules</span><span> </span><span>linked</span><span> </span><span>in:</span><span> </span><span>[...]</span></p><p><span>[49468.516301]</span><span> </span><span>CPU:</span><span> </span><span>6</span><span> </span><span>PID:</span><span> </span><span>17448</span><span> </span><span>Comm:</span><span> </span><span>poc_compat_pare</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>      </span><span>W</span><span>  </span><span>OE</span><span>     </span><span>5.15.123-android13-8-28577312-abS911BXXU3CXD3</span><span> </span><span>#1</span></p><p><span>[49468.516312]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Samsung</span><span> </span><span>DM1Q</span><span> </span><span>PROJECT</span><span> </span><span>(board-id,13)</span><span> </span><span>(DT)</span></p><p><span>[49468.516317]</span><span> </span><span>pstate:</span><span> </span><span>22400005</span><span> </span><span>(nzCv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO</span><span> </span><span>+TCO</span><span> </span><span>-DIT</span><span> </span><span>-SSBS</span><span> </span><span>BTYPE=--)</span></p><p><span>[49468.516326]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>__memcpy+0x90/0x250</span></p><p><span>[49468.516339]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>fastrpc_internal_invoke2+0x308/0x408</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[49468.516471]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffffc02fe33ba0</span></p><p><span>[49468.516475]</span><span> </span><span>x29:</span><span> </span><span>ffffffc02fe33cb0</span><span> </span><span>x28:</span><span> </span><span>ffffff894341bb80</span><span> </span><span>x27:</span><span> </span><span>0000000000000000</span></p><p><span>[49468.516489]</span><span> </span><span>x26:</span><span> </span><span>0000000000000000</span><span> </span><span>x25:</span><span> </span><span>0000000000000000</span><span> </span><span>x24:</span><span> </span><span>ffffff891fe6c5c0</span></p><p><span>[49468.516499]</span><span> </span><span>x23:</span><span> </span><span>00000000ffffffe7</span><span> </span><span>x22:</span><span> </span><span>ffffff8939eff010</span><span> </span><span>x21:</span><span> </span><span>00000000c0185212</span></p><p><span>[49468.516510]</span><span> </span><span>x20:</span><span> </span><span>0000007fe5890e40</span><span> </span><span>x19:</span><span> </span><span>ffffff8939eff000</span><span> </span><span>x18:</span><span> </span><span>ffffffc017b37010</span></p><p><span>[49468.516520]</span><span> </span><span>x17:</span><span> </span><span>0000000000000000</span><span> </span><span>x16:</span><span> </span><span>0000000000000000</span><span> </span><span>x15:</span><span> </span><span>0000007fe5890e40</span></p><p><span>[49468.516530]</span><span> </span><span>x14:</span><span> </span><span>ffffff80011f6480</span><span> </span><span>x13:</span><span> </span><span>0000000000000000</span><span> </span><span>x12:</span><span> </span><span>ffffff8034b27ce8</span></p><p><span>[49468.516540]</span><span> </span><span>x11:</span><span> </span><span>0000000000000010</span><span> </span><span>x10:</span><span> </span><span>ffffffc002443654</span><span> </span><span>x9</span><span> </span><span>:</span><span> </span><span>0000000000000008</span></p><p><span>[49468.516549]</span><span> </span><span>x8</span><span> </span><span>:</span><span> </span><span>0000000000000001</span><span> </span><span>x7</span><span> </span><span>:</span><span> </span><span>0000000000000001</span><span> </span><span>x6</span><span> </span><span>:</span><span> </span><span>ffffffc02fe33d30</span></p><p><span>[49468.516559]</span><span> </span><span>x5</span><span> </span><span>:</span><span> </span><span>ffffffc02fe33bd8</span><span> </span><span>x4</span><span> </span><span>:</span><span> </span><span>ffffffff41414171</span><span> </span><span>x3</span><span> </span><span>:</span><span> </span><span>0000000000000008</span></p><p><span>[49468.516568]</span><span> </span><span>x2</span><span> </span><span>:</span><span> </span><span>0000000000000030</span><span> </span><span>x1</span><span> </span><span>:</span><span> </span><span>ffffffff41414141</span><span> </span><span>x0</span><span> </span><span>:</span><span> </span><span>ffffffc02fe33ba8</span></p><p><span>[49468.516577]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[49468.516582]</span><span> </span><span>__memcpy+0x90/0x250</span></p><p><span>[49468.516593]</span><span> </span><span>fastrpc_device_ioctl+0x1b0/0x92c</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[49468.516716]</span><span> </span><span>__arm64_sys_ioctl+0x120/0x170</span></p><p><span>[49468.516734]</span><span> </span><span>invoke_syscall+0x58/0x13c</span></p><p><span>[49468.516745]</span><span> </span><span>el0_svc_common+0xb4/0xf0</span></p><p><span>[49468.516753]</span><span> </span><span>do_el0_svc+0x24/0x90</span></p><p><span>[49468.516760]</span><span> </span><span>el0_svc+0x20/0x7c</span></p><p><span>[49468.516771]</span><span> </span><span>el0t_64_sync_handler+0x84/0xe4</span></p><p><span>[49468.516778]</span><span> </span><span>el0t_64_sync+0x1b8/0x1bc</span></p><p><span>[49468.516790]</span><span> </span><span>Code:</span><span> </span><span>382e6808</span><span> </span><span>381ff0aa</span><span> </span><span>d65f03c0</span><span> </span><span>d503201f</span><span> </span><span>(a9401c26)</span></p><p><span>[49468.516799]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>9c87e0f40bf8f469</span><span> </span><span>]---</span></p><p><span>This could plausibly be elevated directly into an arbitrary kernel read primitive.</span></p><h3 id="h.9ttjgt27xbrk"><span>Understanding the </span><span>fastrpc_mmap</span><span> struct</span></h3><p><span>The adsprpc driver maintains some internal bookkeeping on what DMA buffers are mapped onto the co-processor via </span><span>fastrpc_mmap</span><span> structs. These structs are allocated and initialized in </span><span>fastrpc_mmap_create</span><span> and contain several characteristics that substantially complicate management of these objects. They can be on either an </span><span>fl</span><span> (associated with a </span><span>struct</span><span> </span><span>file</span><span>) local or global linked list, depending on the flags used on creation. They have two separate refcounts </span><span>refs</span><span> and </span><span>ctx_refs</span><span> and they can be referenced from multiple places at once, including a context (an object that tracks data associated with a single RPC call), the global or local map lists, and of course transient stack-based references when being created or destroyed. A reference on an existing map is taken when </span><span>fastrpc_mmap_create</span><span> is called with a set of parameters that are fulfilled by an existing mapping.</span></p><p><span>fastrpc_mmap</span><span> objects can be created via several different codepaths. This includes during context initialization, by accessing two different dedicated ioctl handlers, during DSP initialization and process creation, and even by a request from the DSP itself. </span><span>fastrpc_mmap</span><span> objects can be </span><span>freed</span><span> through a reciprocal set of codepaths such as context or </span><span>struct file</span><span> teardown, and via </span><span>three</span><span> different dedicated unmapping ioctls. We will examine several of these creation and destruction codepaths as I discuss three discovered bugs involving use-after-free of a </span><span>fastrpc_mmap_struct</span><span>.</span></p><h4 id="h.jvp9ayz9sab2"><span><a href="https://project-zero.issues.chromium.org/issues/42451715">CVE-2024-33060: UAF race of global maps in fastrpc_mmap_create (and epilogue functions)</a></span></h4><p><span>It is important to have a good understanding of the locking utilized for protecting these map lists from races in order to understand the first bug found:</span></p><p><span></span><span>int</span><span> </span><span>fastrpc_internal_mem_map(</span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl,</span></p><p><span>                                </span><span>struct</span><span> </span><span>fastrpc_ioctl_mem_map</span><span> </span><span>*ud)</span></p><p><span>{</span></p><p><span>        </span><span>int</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>        </span><span>struct</span><span> </span><span>fastrpc_mmap</span><span> </span><span>*map</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>        </span><span>mutex_lock(&amp;fl-&gt;internal_map_mutex);</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p><span>        </span><span>VERIFY(err,</span><span> </span><span>!(err</span><span> </span><span>=</span><span> </span><span>fastrpc_mmap_create(fl,</span><span> </span><span>ud-&gt;m.fd,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>ud-&gt;m.attrs,</span></p><p><span>                        </span><span>ud-&gt;m.vaddrin,</span><span> </span><span>ud-&gt;m.length,</span></p><p><span>                         </span><span>ud-&gt;m.flags,</span><span> </span><span>&amp;map)));</span></p><p><span>        </span><span>mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p><span>        </span><span>if</span><span> </span><span>(err)</span></p><p><span>                </span><span>goto</span><span> </span><span>bail;</span></p><p><span>...</span><span>//[1] map may already be globally visible</span></p><p><span>VERIFY(err,</span><span> </span><span>!(err</span><span> </span><span>=</span><span> </span><span>fastrpc_mem_map_to_dsp(fl,</span><span> </span><span>ud-&gt;m.fd,</span><span> </span><span>ud-&gt;m.offset,</span></p><p><span>                ud-&gt;m.flags, map-&gt;va, map-&gt;phys, map-&gt;size, &amp;map-&gt;raddr)));</span></p><p><span>if</span><span> (err)</span></p><p><span>        </span><span>goto</span><span> bail;</span></p><p><span>ud-&gt;m.vaddrout = map-&gt;raddr;</span></p><p><span>bail:</span></p><p><span>        </span><span>if</span><span> </span><span>(err)</span><span> </span><span>{</span></p><p><span>                </span><span>if</span><span> </span><span>(map)</span><span> </span><span>{</span></p><p><span>                        </span><span>mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p><span>                        </span><span>fastrpc_mmap_free(map,</span><span> </span><span>0</span><span>);</span></p><p><span>                        </span><span>mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p><span>                </span><span>}</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>mutex_unlock(&amp;fl-&gt;internal_map_mutex);</span></p><p><span>        </span><span>return</span><span> </span><span>err;</span></p><p><span>}</span></p><p><span>Two mutexes are held here, one of which is held throughout the lifetime of the function including in the error condition bailout: </span><span>fl-&gt;map_mutex</span><span> and </span><span>fl-&gt;internal_map_mutex</span><span>. Both of these mutexes are bound to the </span><span>fl</span><span> struct which is itself bound to the </span><span>struct file</span><span> associated with a file descriptor. These mutexes prevent concurrency for e.g. multiple </span><span>fastrpc_internal_mem_map</span><span> calls on the </span><span>same</span><span> file descriptor, but do </span><span>not</span><span> prevent concurrency with </span><span>other</span><span> </span><span>fl</span><span> structs (e.g. from a </span><span>second</span><span> open’d adsprpc-smd file descriptor) being utilized in the same ioctls. As these ioctls are often used to administer </span><span>fl</span><span> struct</span><span> </span><span>local</span><span> maps, global concurrency is often okay. However </span><span>fastrpc_mmap_create</span><span> and </span><span>fastrpc_internal_mem_map</span><span> can create </span><span>global</span><span> maps too. And for </span><span>global</span><span> maps that are added to </span><span>global</span><span> structures, global mutexing is only </span><span>briefly</span><span> taken in </span><span>fastrpc_internal_mem_map</span><span> -&gt; </span><span>fastrpc_mmap_create</span><span> -&gt; </span><span>fastrpc_mmap_add</span><span>:</span></p><p><span></span><span>static</span><span> </span><span>void</span><span> </span><span>fastrpc_mmap_add(</span><span>struct</span><span> </span><span>fastrpc_mmap</span><span> </span><span>*map)</span></p><p><span>{</span></p><p><span>        </span><span>if</span><span> </span><span>(map-&gt;flags</span><span> </span><span>==</span><span> </span><span>ADSP_MMAP_HEAP_ADDR</span><span> </span><span>||</span></p><p><span>                                </span><span>map-&gt;flags</span><span> </span><span>==</span><span> </span><span>ADSP_MMAP_REMOTE_HEAP_ADDR)</span><span> </span><span>{</span></p><p><span>                </span><span>struct</span><span> </span><span>fastrpc_apps</span><span> </span><span>*me</span><span> </span><span>=</span><span> </span><span>&amp;gfa; </span><span>//gfa is a global struct</span></p><p><span>                </span><span>unsigned</span><span> </span><span>long</span><span> </span><span>irq_flags</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>                </span><span>spin_lock_irqsave(&amp;me-&gt;hlock,</span><span> </span><span>irq_flags); </span><span>//Taken here</span></p><p><span>                </span><span>hlist_add_head(&amp;map-&gt;hn,</span><span> </span><span>&amp;me-&gt;maps);</span></p><p><span>                </span><span>spin_unlock_irqrestore(&amp;me-&gt;hlock,</span><span> </span><span>irq_flags); </span><span>//Dropped here</span></p><p><span>        </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span></p><p><span>                </span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl</span><span> </span><span>=</span><span> </span><span>map-&gt;fl;</span></p><p><span>                </span><span>hlist_add_head(&amp;map-&gt;hn,</span><span> </span><span>&amp;fl-&gt;maps);</span></p><p><span>        </span><span>}</span></p><p><span>}</span></p><p><span>This means that the global mutexing architecture is not enough to prevent two concurrent invocations of the fastrpc mapping ioctl calls, even if a global map is being created. This itself is not a bug, but even </span><span>after</span><span> insertion of a global map onto the global map list, </span><span>fastrpc_internal_mem_map</span><span> continues to access the map even though it should really be considering its reference to the global map “consumed”. Crucially, if a global map is created and added to the global list, it is immediately visible to concurrent callers - a thread calling </span><span>fastrpc_internal_munmap</span><span> with a different adsprpc fd / </span><span>fl struct</span><span> could destroy the global map while </span><span>fastrpc_internal_mem_map</span><span> </span><span>continues to use it</span><span> (see [1] in the above code sample from </span><span>fastrpc_internal_mem_map</span><span>). </span><span>This is an example of</span><span> continuing to use a transient reference after transferring that reference to a data structure where the lifetimes of the residing objects are userland-managed  - another example would be using  a </span><span>struct file</span><span> object after installing the only reference in a file descriptor table (via </span><span>fd_install</span><span>) at which point</span><span> userland can drop the reference using the </span><span>close</span><span>(2) syscall.</span></p><p><span>Triggering this bug generates the following kernel panic with </span><span>PAGE_POISON</span><span> enabled:</span></p><p><span></span><span>[ 2890.558370] [0:            poc:22189] Unable to handle kernel paging request at virtual address 006b6b6b6b6b6b83</span></p><p><span>[ 2890.558411] [0:            poc:22189] PC Code: 95ca6fb3 aa1703e0 2a1f03e1 97ffdbcc 2a1f03f6 14000008 f9400ae8 (f8418d09) f90002e9 b4000049 f9000537 f9000117 f90006e8 aa1403e0 95ca66a2 aa1303e0 95ca66a0 d5384108 f942f108 f94007e9</span></p><p><span>[ 2890.558618] [0:            poc:22189] LR Code: 94000075 2a0003f6 aa1403e0 95ca66ed f94003f7 340006f6 b4000937 aa1403e0 95ca6feb (b94026e8) 7100211f 54000060 7100111f 54000721 b00000f8 91038318 91008315 aa1503e0 95ca97d3 f9400308</span></p><p><span>[ 2890.558633] [0:            poc:22189] Mem abort info:</span></p><p><span>[ 2890.558641] [0:            poc:22189]   ESR = 0x96000004</span></p><p><span>[ 2890.558650] [0:            poc:22189]   EC = 0x25: DABT (current EL), IL = 32 bits</span></p><p><span>[ 2890.558661] [0:            poc:22189]   SET = 0, FnV = 0</span></p><p><span>[ 2890.558670] [0:            poc:22189]   EA = 0, S1PTW = 0</span></p><p><span>[ 2890.558678] [0:            poc:22189]   FSC = 0x04: level 0 translation fault</span></p><p><span>[ 2890.558688] [0:            poc:22189] Data abort info:</span></p><p><span>[ 2890.558696] [0:            poc:22189]   ISV = 0, ISS = 0x00000004</span></p><p><span>[ 2890.558704] [0:            poc:22189]   CM = 0, WnR = 0</span></p><p><span>[ 2890.558713] [0:            poc:22189] [006b6b6b6b6b6b83] address between user and kernel address ranges</span></p><p><span>[ 2890.558727] [0:            poc:22189] Internal error: Oops: 96000004 [#1] PREEMPT SMP</span></p><p><span>[ 2890.559162] [0:            poc:22189] sec_arm64_ap_context:sec_arm64_ap_context_on_die() context saved (CPU:0)</span></p><p><span>...</span></p><p><span>[ 2890.560996] [0:            poc:22189] CPU: 0 PID: 22189 Comm: poc Tainted: G S      W  OE     5.15.123-android13-8-28577312-abS911BXXU3CXD3 #1</span></p><p><span>[ 2890.561007] [0:            poc:22189] Hardware name: Samsung DM1Q PROJECT (board-id,13) (DT)</span></p><p><span>[ 2890.561014] [0:            poc:22189] pstate: 22400005 (nzCv daif +PAN -UAO +TCO -DIT -SSBS BTYPE=--)</span></p><p><span>[ 2890.561024] [0:            poc:22189] pc : fastrpc_internal_munmap+0x1ac/0x264 [frpc_adsprpc]</span></p><p><span>[ 2890.561202] [0:            poc:22189] lr : fastrpc_internal_munmap+0xb4/0x264 [frpc_adsprpc]</span></p><p><span>[ 2890.561376] [0:            poc:22189] sp : ffffffc025ee3cc0</span></p><p><span>[ 2890.561382] [0:            poc:22189] x29: ffffffc025ee3cd0 x28: ffffff88bf4fbb80 x27: 0000000000000000</span></p><p><span>[ 2890.561397] [0:            poc:22189] x26: 0000000000000000 x25: 0000000000000000 x24: ffffff8922ae4301</span></p><p><span>[ 2890.561411] [0:            poc:22189] x23: ffffff803bb30900 x22: 0000000080000448 x21: ffffff8928fb5800</span></p><p><span>[ 2890.561424] [0:            poc:22189] x20: ffffff8928fb5910 x19: ffffff8928fb5940 x18: ffffffc00b492010</span></p><p><span>[ 2890.561437] [0:            poc:22189] x17: 00000000000003e7 x16: 0000000000007e00 x15: 0000000000000600</span></p><p><span>[ 2890.561450] [0:            poc:22189] x14: ffffff891cc57e00 x13: dee89d8ccc1e57a7 x12: 088000400811164c</span></p><p><span>[ 2890.561463] [0:            poc:22189] x11: ffffff891cc51a00 x10: ffffff88bf4fbb80 x9 : 0000000000000000</span></p><p><span>[ 2890.561476] [0:            poc:22189] x8 : 6b6b6b6b6b6b6b6b x7 : bbbbbbbbbbbbbbbb x6 : 00000000000000c0</span></p><p><span>[ 2890.561489] [0:            poc:22189] x5 : 0000000000150009 x4 : ffffff891cc57400 x3 : 000000000015000a</span></p><p><span>[ 2890.561502] [0:            poc:22189] x2 : ffffff88bf4fbb80 x1 : 0000000000000000 x0 : 0000000000000000</span></p><p><span>[ 2890.561516] [0:            poc:22189] Call trace:</span></p><p><span>[ 2890.561523] [0:            poc:22189]  fastrpc_internal_munmap+0x1ac/0x264 [frpc_adsprpc]</span></p><p><span>[ 2890.561696] [0:            poc:22189]  fastrpc_device_ioctl+0x7e8/0x92c [frpc_adsprpc]</span></p><p><span>[ 2890.561867] [0:            poc:22189]  __arm64_sys_ioctl+0x120/0x170</span></p><p><span>[ 2890.561886] [0:            poc:22189]  invoke_syscall+0x58/0x13c</span></p><p><span>[ 2890.561899] [0:            poc:22189]  el0_svc_common+0xb4/0xf0</span></p><p><span>[ 2890.561908] [0:            poc:22189]  do_el0_svc+0x24/0x90</span></p><p><span>[ 2890.561917] [0:            poc:22189]  el0_svc+0x20/0x7c</span></p><p><span>[ 2890.561929] [0:            poc:22189]  el0t_64_sync_handler+0x84/0xe4</span></p><p><span>[ 2890.561937] [0:            poc:22189]  el0t_64_sync+0x1b8/0x1bc</span></p><p><span>[ 2890.561951] [0:            poc:22189] Code: 97ffdbcc 2a1f03f6 14000008 f9400ae8 (f8418d09)</span></p><p><span>[ 2890.561967] [0:            poc:22189] ---[ end trace af6bd4fc06724258 ]---</span></p><p><span>[ 2890.561978] [0:            poc:22189] Kernel panic - not syncing: Oops: Fatal exception</span></p><h4 id="h.74iu61pc8jz6"><span><a href="https://project-zero.issues.chromium.org/issues/42451713">PZ Issue 42451713 (fixed with CVE-2024-33060): Incorrect searching algorithm in fastrpc_mmap_find leads to kernel address space info leak</a></span></h4><p><span>The </span><span>fastrpc_mmap_create</span><span> function calls the function </span><span>fastrpc_mmap_find</span><span> with attacker controlled arguments in order to identify existing maps that already fulfill the map creation request and if an existing map fulfills the request, it simply takes a refcount on that map and returns (this is an important aspect of </span><span>CVE-2024-49848</span><span> too, as we’ll see in the next section!). In the case of </span><span>global</span><span> maps it performs the following:</span></p><p><span></span><span>hlist_for_each_entry_safe(map,</span><span> </span><span>n,</span><span> </span><span>&amp;me-&gt;maps,</span><span> </span><span>hn)</span><span> </span><span>{</span><span>  </span></p><p><span>    </span><span>if</span><span> </span><span>(va</span><span> </span><span>&gt;=</span><span> </span><span>map-&gt;va</span><span> </span><span>&amp;&amp;</span><span>  </span><span>//Is the userland provided va and len in the range of the map?</span></p><p><span>    </span><span>va</span><span> </span><span>+</span><span> </span><span>len</span><span> </span><span>&lt;=</span><span> </span><span>map-&gt;va</span><span> </span><span>+</span><span> </span><span>map-&gt;len</span><span> </span><span>&amp;&amp;</span><span>  </span></p><p><span>    </span><span>map-&gt;fd</span><span> </span><span>==</span><span> </span><span>fd)</span><span> </span><span>{ </span><span>//And is the fd the same?</span></p><p><span>        </span><span>if</span><span> </span><span>(refs)</span><span> </span><span>{</span><span>  </span></p><p><span>            </span><span>if</span><span> </span><span>(map-&gt;refs</span><span> </span><span>+</span><span> </span><span>1</span><span> </span><span>==</span><span> </span><span>INT_MAX)</span><span> </span><span>{</span><span>  </span></p><p><span>                 </span><span>spin_unlock_irqrestore(&amp;me-&gt;hlock,</span><span> </span><span>irq_flags);</span><span>  </span></p><p><span>                 </span><span>return</span><span> </span><span>-ETOOMANYREFS;</span><span>  </span></p><p><span>            </span><span>}</span><span>  </span></p><p><span>           </span><span>map-&gt;refs++;</span><span>  </span></p><p><span>        </span><span>}</span><span>  </span></p><p><span>        </span><span>match</span><span> </span><span>=</span><span> </span><span>map;</span><span>  </span></p><p><span>        </span><span>break</span><span>;</span><span>  </span></p><p><span>    </span><span>}</span><span>  </span></p><p><span>}</span></p><p><span>While this code makes sense for </span><span>fl</span><span> </span><span>local</span><span> maps where </span><span>map-&gt;va</span><span> is set to a userland provided value, in the case of </span><span>global</span><span> maps they are set to a </span><span>kernel</span><span> </span><span>struct page</span><span> pointer that serves as an opaque handle for the allocated memory. Consequently, via </span><span>fastrpc_internal_mem_map</span><span>, an attacker can cause a userland provided value to be compared to a kernel </span><span>struct page</span><span> pointer. Furthermore the ioctl return value can differ based on whether the comparison returns true or false, allowing an attacker to brute force page pointer addresses associated with a </span><span>fastrpc_map</span><span> object.</span></p><h4 id="h.jmnjfxzayael"><span><a href="https://project-zero.issues.chromium.org/issues/42451725">CVE-2024-49848: FASTRPC_ATTR_KEEP_MAP logic bug allows fastrpc_internal_munmap_fd to racily free in-use mappings leading to UAF</a></span></h4><p><span>One critically important aspect of the </span><span>fastrpc_internal_mem_unmap</span><span> and </span><span>fastrpc_internal_munmap</span><span> functions is their reliance on </span><span>fastrpc_mmap_remove</span><span> when trying to find a map to delete. This function contains a list of checks to attempt to ensure that it cannot free a map presently in use:</span></p><p><span></span><span>//Entered with fl mapping mutexes held</span></p><p><span>s</span><span>tatic </span><span>int</span><span> </span><span>fastrpc_mmap_remove(</span><span>struct </span><span>fastrpc_file</span><span> </span><span>*fl,</span><span> </span><span>int</span><span> </span><span>fd,</span><span> </span><span>uintptr_t</span><span> </span><span>va,</span></p><p><span>                               </span><span>size_t</span><span> </span><span>len,</span><span> struct </span><span>fastrpc_mmap</span><span> </span><span>**ppmap)</span></p><p><span>{</span></p><p><span>        struct </span><span>fastrpc_mmap</span><span> </span><span>*match</span><span> </span><span>=</span><span> NULL</span><span>,</span><span> </span><span>*map;</span></p><p><span>        struct </span><span>hlist_node</span><span> </span><span>*n;</span></p><p><span>        struct </span><span>fastrpc_apps</span><span> </span><span>*me</span><span> </span><span>=</span><span> </span><span>&amp;gfa;</span></p><p><span>        </span><span>unsigned</span><span> </span><span>long</span><span> </span><span>irq_flags</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>...</span></p><p><span>        </span><span>hlist_for_each_entry_safe(map,</span><span> </span><span>n,</span><span> </span><span>&amp;fl-&gt;maps,</span><span> </span><span>hn)</span><span> </span><span>{</span></p><p><span>                if </span><span>((fd</span><span> </span><span>&lt;</span><span> </span><span>0</span><span> </span><span>||</span><span> </span><span>map-&gt;fd</span><span> </span><span>==</span><span> </span><span>fd)</span><span> </span><span>&amp;&amp;</span><span> </span><span>map-&gt;raddr</span><span> </span><span>==</span><span> </span><span>va</span><span> </span><span>&amp;&amp;</span></p><p><span>                        </span><span>map-&gt;raddr</span><span> </span><span>+</span><span> </span><span>map-&gt;len</span><span> </span><span>==</span><span> </span><span>va</span><span> </span><span>+</span><span> </span><span>len</span><span> </span><span>&amp;&amp;</span></p><p><span>                        </span><span>map-&gt;refs</span><span> </span><span>==</span><span> </span><span>1</span><span> </span><span>&amp;&amp; </span><span>//verifies only 1 reference (from map creation)</span></p><p><span>                        </span><span>/*</span><span> </span><span>Remove</span><span> if </span><span>only</span><span> </span><span>one</span><span> </span><span>reference</span><span> </span><span>map</span><span> </span><span>and</span><span> </span><span>no</span><span> </span><span>context</span><span> </span><span>map</span><span> </span><span>*/</span></p><p><span>                        </span><span>!map-&gt;ctx_refs</span><span> </span><span>&amp;&amp; </span><span>//And that no context holds a reference (important because context creation can create maps as well)</span></p><p><span>                        </span><span>/*</span><span> </span><span>Skip</span><span> </span><span>unmap</span><span> if </span><span>it</span><span> </span><span>is</span><span> </span><span>fastrpc</span><span> </span><span>shell</span><span> </span><span>memory</span><span> </span><span>*/</span></p><p><span>                        </span><span>!map-&gt;is_filemap)</span><span> </span><span>{</span></p><p><span>                        </span><span>match</span><span> </span><span>=</span><span> </span><span>map;</span></p><p><span>                        </span><span>hlist_del_init(&amp;map-&gt;hn);</span></p><p><span>                        break</span><span>;</span></p><p><span>                </span><span>}</span></p><p><span>        </span><span>}</span></p><p><span>        if </span><span>(match)</span><span> </span><span>{</span></p><p><span>                </span><span>*ppmap</span><span> </span><span>=</span><span> </span><span>match;</span></p><p><span>                return </span><span>0</span><span>;</span></p><p><span>        </span><span>}</span></p><p><span>        return </span><span>-ETOOMANYREFS;</span></p><p><span>}</span></p><p><span>This function tries to ensure there can be no references to a map outside of the initial reference set upon creation of the map. </span><span>This works </span><span>as long as</span><span> there are never any references to the map unassociated with an explicit reference (</span><span>map-&gt;refs &gt; 1 || map-&gt;ctx_refs &gt; 0</span><span>) concurrent to this function. This is in fact, precisely the invariant violated by CVE-2024-33060! In that case, we have a transient stack-based reference (from map creation) that doesn’t take an explicit reference (</span><span>map-&gt;refs == 1</span><span>) that is concurrent to this function (since the transient reference was held beyond the global mutexing lock).</span></p><p><span>This invariant check is clearly a bit fragile to begin with, but there are at least two other paths to potential map destruction that don’t utilize this </span><span>fastrpc_mmap_remove</span><span> path and the guarantees it tries to provide. One of these paths is </span><span>fastrpc_internal_munmap_fd</span><span>:</span></p><p><span></span><span>/*</span></p><p><span> </span><span>*</span><span>        </span><span>fastrpc_internal_munmap_fd</span><span> </span><span>can</span><span> </span><span>only</span><span> </span><span>be</span><span> </span><span>used</span><span> </span><span>for</span><span> </span><span>buffers</span></p><p><span> </span><span>*</span><span>        </span><span>mapped</span><span> </span><span>with</span><span> </span><span>persist</span><span> </span><span>attributes.</span><span> </span><span>This</span><span> </span><span>can</span><span> </span><span>only</span><span> </span><span>be</span><span> </span><span>called</span></p><p><span> </span><span>*</span><span>        </span><span>once</span><span> </span><span>for</span><span> </span><span>any</span><span> </span><span>persist</span><span> </span><span>buffer</span></p><p><span> </span><span>*/</span></p><p><span>int</span><span> </span><span>fastrpc_internal_munmap_fd(</span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl,</span></p><p><span>                                </span><span>struct</span><span> </span><span>fastrpc_ioctl_munmap_fd</span><span> </span><span>*ud)</span></p><p><span>{</span></p><p><span>        </span><span>int</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>        </span><span>struct</span><span> </span><span>fastrpc_mmap</span><span> </span><span>*map</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>mutex_lock(&amp;fl-&gt;internal_map_mutex);</span></p><p><span>        </span><span>mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p><span>        </span><span>err</span><span> </span><span>=</span><span> </span><span>fastrpc_mmap_find(fl,</span><span> </span><span>ud-&gt;fd,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>ud-&gt;va,</span><span> </span><span>ud-&gt;len,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>&amp;map);</span></p><p><span>        </span><span>if</span><span> </span><span>(err)</span><span> </span><span>{</span></p><p><span>                </span><span>...</span></p><p><span>                </span><span>mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p><span>                </span><span>goto</span><span> </span><span>bail;</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>if</span><span> </span><span>(map</span><span> </span><span>&amp;&amp;</span><span> </span><span>(map-&gt;attr</span><span> </span><span>&amp;</span><span> </span><span>FASTRPC_ATTR_KEEP_MAP))</span><span> </span><span>{</span></p><p><span>                </span><span>map-&gt;attr</span><span> </span><span>=</span><span> </span><span>map-&gt;attr</span><span> </span><span>&amp;</span><span> </span><span>(~FASTRPC_ATTR_KEEP_MAP);</span></p><p><span>                </span><span>fastrpc_mmap_free(map,</span><span> </span><span>0</span><span>);</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p><span>bail:</span></p><p><span>        </span><span>mutex_unlock(&amp;fl-&gt;internal_map_mutex);</span></p><p><span>        </span><span>return</span><span> </span><span>err;</span></p><p><span>}</span></p><p><span>We can see that this function finds a map and calls </span><span>fastrpc_mmap_free</span><span> on that map if the flag </span><span>FASTRPC_ATTR_KEEP_MAP</span><span> is set. It also unsets this flag, so it’s impossible to call this function on the same map more than once.  Looking inside of </span><span>fastrpc_mmap_create</span><span> we see a corresponding line of code that adds an additional reference in the case where this flag is set:</span></p><p><span></span><span>static</span><span> </span><span>int</span><span> </span><span>fastrpc_mmap_create(</span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl,</span><span> </span><span>int</span><span> </span><span>fd,</span><span> </span><span>struct</span><span> </span><span>dma_buf</span><span> </span><span>*buf,</span></p><p><span>        </span><span>unsigned</span><span> </span><span>int</span><span> </span><span>attr,</span><span> </span><span>uintptr_t</span><span> </span><span>va,</span><span> </span><span>size_t</span><span> </span><span>len,</span><span> </span><span>int</span><span> </span><span>mflags,</span></p><p><span>        </span><span>struct</span><span> </span><span>fastrpc_mmap</span><span> </span><span>**ppmap)</span></p><p><span>{</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>map</span><span> </span><span>=</span><span> </span><span>kzalloc(</span><span>sizeof</span><span>(*map),</span><span> </span><span>GFP_KERNEL);</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>INIT_HLIST_NODE(&amp;map-&gt;hn);</span></p><p><span>        </span><span>map-&gt;flags</span><span> </span><span>=</span><span> </span><span>mflags;</span></p><p><span>        </span><span>map-&gt;refs</span><span> </span><span>=</span><span> </span><span>1</span><span>;</span></p><p><span>        </span><span>map-&gt;fl</span><span> </span><span>=</span><span> </span><span>fl;</span></p><p><span>        </span><span>map-&gt;fd</span><span> </span><span>=</span><span> </span><span>fd;</span></p><p><span>        </span><span>map-&gt;attr</span><span> </span><span>=</span><span> </span><span>attr;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>map-&gt;ctx_refs</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>        </span><span>ktime_get_real_ts64(&amp;map-&gt;map_start_time);</span></p><p><span>        </span><span>if</span><span> </span><span>(mflags</span><span> </span><span>==</span><span> </span><span>ADSP_MMAP_HEAP_ADDR</span><span> </span><span>||</span></p><p><span>                                </span><span>mflags</span><span> </span><span>==</span><span> </span><span>ADSP_MMAP_REMOTE_HEAP_ADDR)</span><span> </span><span>{</span></p><p><span>                </span><span>...</span></p><p><span>        </span><span>}</span><span> </span><span>else</span><span> </span><span>if</span><span> </span><span>(mflags</span><span> </span><span>==</span><span> </span><span>FASTRPC_MAP_FD_NOMAP)</span><span> </span><span>{</span></p><p><span>                </span><span>...</span></p><p><span>        </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span></p><p><span>                </span><span>if</span><span> </span><span>(map-&gt;attr</span><span> </span><span>&amp;&amp;</span><span> </span><span>(map-&gt;attr</span><span> </span><span>&amp;</span><span> </span><span>FASTRPC_ATTR_KEEP_MAP))</span><span> </span><span>{</span></p><p><span>                        </span><span>ADSPRPC_INFO(</span><span>&#34;buffer mapped with persist attr 0x%x\n&#34;</span><span>,</span></p><p><span>                                </span><span>(</span><span>unsigned</span><span> </span><span>int</span><span>)map-&gt;attr);</span></p><p><span>                        </span><span>map-&gt;refs</span><span> </span><span>=</span><span> </span><span>2</span><span>; </span><span>//References increases to 2</span></p><p><span>                </span><span>}</span></p><p><span>                </span><span>...</span></p><p><span>                </span><span>map-&gt;va</span><span> </span><span>=</span><span> </span><span>va;</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>map-&gt;len</span><span> </span><span>=</span><span> </span><span>len;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>fastrpc_mmap_add(map);</span></p><p><span>        </span><span>*ppmap</span><span> </span><span>=</span><span> </span><span>map;</span></p><p><span>bail:</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>return</span><span> </span><span>err;</span></p><p><span>}</span></p><p><span>However we can see that </span><span>map-&gt;refs</span><span> is </span><span>only</span><span> bumped in the default case where </span><span>mflags</span><span> isn’t equal to one of </span><span>ADSP_MMAP_HEAP_ADDR</span><span>, </span><span>ADSP_MMAP_REMOTE_HEAP_ADDR</span><span> or </span><span>FASTRPC_MAP_FD_NOMAP</span><span>. We can also see that </span><span>regardless</span><span> of the </span><span>mflags</span><span> value, it is possible to set </span><span>FASTRPC_ATTR_KEEP_MAP</span><span> - so it is still possible to create a </span><span>FASTRPC_ATTR_KEEP_MAP</span><span> map with </span><span>map-&gt;refs == 1</span><span>! This means that the map is visible to a </span><span>fastrpc_internal_munmap_fd</span><span> call which doesn’t guarantee the invariant provided by </span><span>fastrpc_mmap_remove</span><span> is unviolated when </span><span>fastrpc_mmap_free</span><span> gets called. This can be a problem for example, when a context takes a reference to a </span><span>FASTRPC_ATTR_KEEP_MAP</span><span>, </span><span>FASTRPC_MAP_FD_NOMAP </span><span>mapping in </span><span>get_args</span><span>:</span></p><p><span></span><span>static</span><span> </span><span>int</span><span> </span><span>get_args(uint32_t</span><span> </span><span>kernel,</span><span> </span><span>struct</span><span> </span><span>smq_invoke_ctx</span><span> </span><span>*ctx)</span></p><p><span>{</span></p><p><span>        </span><span>remote_arg64_t</span><span> </span><span>*rpra,</span><span> </span><span>*lrpra;</span></p><p><span>        </span><span>remote_arg_t</span><span> </span><span>*lpra</span><span> </span><span>=</span><span> </span><span>ctx-&gt;lpra;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>int</span><span> </span><span>mflags</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>for</span><span> </span><span>(i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>bufs;</span><span> </span><span>++i)</span><span> </span><span>{</span></p><p><span>                </span><span>uintptr_t</span><span> </span><span>buf</span><span> </span><span>=</span><span> </span><span>(uintptr_t)lpra[i].buf.pv;</span></p><p><span>                </span><span>size_t</span><span> </span><span>len</span><span> </span><span>=</span><span> </span><span>lpra[i].buf.len;</span></p><p><span>                </span><span>mutex_lock(&amp;ctx-&gt;fl-&gt;map_mutex);</span></p><p><span>                </span><span>if</span><span> </span><span>(ctx-&gt;fds</span><span> </span><span>&amp;&amp;</span><span> </span><span>(ctx-&gt;fds[i]</span><span> </span><span>!=</span><span> </span><span>-1</span><span>))</span></p><p><span>                        </span><span>err</span><span> </span><span>=</span><span> </span><span>fastrpc_mmap_create(ctx-&gt;fl,</span><span> </span><span>ctx-&gt;fds[i],</span><span> </span><span>NULL</span><span>,</span></p><p><span>                                        </span><span>ctx-&gt;attrs[i],</span><span> </span><span>buf,</span><span> </span><span>len,</span></p><p><span>                                        </span><span>mflags,</span><span> </span><span>&amp;ctx-&gt;maps[i]);</span><span>//Can take a reference to an existing mapping</span></p><p><span>                </span><span>if</span><span> </span><span>(ctx-&gt;maps[i])</span></p><p><span>                        </span><span>ctx-&gt;maps[i]-&gt;ctx_refs++;</span></p><p><span>                </span><span>mutex_unlock(&amp;ctx-&gt;fl-&gt;map_mutex);</span></p><p><span>...</span></p><p><span>        </span><span>}</span></p><p><span></span><span>map-&gt;ctx_refs</span><span> is set to greater than zero, but this does not stop </span><span>fastrpc_internal_munmap_fd</span><span>’s call to </span><span>fastrpc_mmap_free </span><span>from calling </span><span>kfree</span><span> on the map</span><span>:</span></p><p><span></span><span>static</span><span> </span><span>void</span><span> </span><span>fastrpc_mmap_free(</span><span>struct</span><span> </span><span>fastrpc_mmap</span><span> </span><span>*map,</span><span> </span><span>uint32_t</span><span> </span><span>flags)</span></p><p><span>{</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>if</span><span> </span><span>(map-&gt;flags</span><span> </span><span>==</span><span> </span><span>ADSP_MMAP_HEAP_ADDR</span><span> </span><span>||</span></p><p><span>                                </span><span>map-&gt;flags</span><span> </span><span>==</span><span> </span><span>ADSP_MMAP_REMOTE_HEAP_ADDR)</span><span> </span><span>{</span></p><p><span>                </span><span>...</span></p><p><span>        </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span></p><p><span>                </span><span>map-&gt;refs--;</span></p><p><span>                </span><span>if</span><span> </span><span>(!map-&gt;refs</span><span> </span><span>&amp;&amp;</span><span> </span><span>!map-&gt;ctx_refs)</span></p><p><span>                        </span><span>hlist_del_init(&amp;map-&gt;hn);</span></p><p><span>                </span><span>if</span><span> </span><span>(map-&gt;refs</span><span> </span><span>&gt;</span><span> </span><span>0</span><span> </span><span>&amp;&amp;</span><span> </span><span>!flags) </span><span>//This is the only relevant bailout to avoid freeing map - ctx_refs value does not influence free decision</span></p><p><span>                        </span><span>return</span><span>;</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>...</span></p><p><span>bail:</span></p><p><span>        </span><span>if</span><span> </span><span>(!map-&gt;is_persistent)</span></p><p><span>                </span><span>kfree(map); </span><span>//Map is destroyed here!</span></p><p><span>}</span></p><p><span>This means it’s theoretically possible to create a UAF mapping if a fastrpc context holds the </span><span>only</span><span> reference to a </span><span>FASTRPC_MAP_FD_NOMAP</span><span> mapping with the </span><span>FASTRPC_ATTR_KEEP_MAP</span><span> attribute set. This cocktail of flags and attributes is possible with </span><span>fastrpc_internal_mem_map</span><span>, however it’s not immediately apparent how to cause a context to hold the only reference. The only intended circumstance where a context holds the sole reference to a map is when context creation and initialization leads directly to map creation - but in that map creation path, it’s not possible to specify the flags and attributes necessary to create the needed edge case. We need to have </span><span>fastrpc_internal_mem_map</span><span> create the map, have a context take a reference, and then somehow drop the initial reference that map creation provides. We cannot do this with </span><span>fastrpc_internal_mem_unmap</span><span> (because of the guarantees provided by </span><span>fastrpc_mmap_remove</span><span>) but we CAN racily do this by taking the </span><span>fastrpc_internal_mem_map</span><span> bailout after the map is created and a context has taken a reference!</span></p><p><span></span><span>int</span><span> </span><span>fastrpc_internal_mem_map(</span><span>struct</span><span> </span><span>fastrpc_file</span><span> </span><span>*fl,</span></p><p><span>                                </span><span>struct</span><span> </span><span>fastrpc_ioctl_mem_map</span><span> </span><span>*ud)</span></p><p><span>{</span></p><p><span>        </span><span>int</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>        </span><span>struct</span><span> </span><span>fastrpc_mmap</span><span> </span><span>*map</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>        </span><span>mutex_lock(&amp;fl-&gt;internal_map_mutex);</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p><span>        </span><span>VERIFY(err,</span><span> </span><span>!(err</span><span> </span><span>=</span><span> </span><span>fastrpc_mmap_create(fl,</span><span> </span><span>ud-&gt;m.fd,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>ud-&gt;m.attrs,</span></p><p><span>                        </span><span>ud-&gt;m.vaddrin,</span><span> </span><span>ud-&gt;m.length,</span></p><p><span>                         </span><span>ud-&gt;m.flags,</span><span> </span><span>&amp;map))); </span><span>//Create the map here</span></p><p><span>        </span><span>mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p><span>        </span><span>... </span><span>//Have a context take a reference to the created map here</span></p><p><span>        </span><span>VERIFY(err,</span><span> </span><span>!(err</span><span> </span><span>=</span><span> </span><span>fastrpc_mem_map_to_dsp(fl,</span><span> </span><span>ud-&gt;m.fd,</span><span> </span><span>ud-&gt;m.offset,</span></p><p><span>                </span><span>ud-&gt;m.flags,</span><span> </span><span>map-&gt;va,</span><span> </span><span>map-&gt;phys,</span><span> </span><span>map-&gt;size,</span><span> </span><span>&amp;map-&gt;raddr))); </span><span>//Fail this</span></p><p><span>        </span><span>if</span><span> </span><span>(err)</span></p><p><span>                </span><span>goto</span><span> </span><span>bail; </span><span>//bailout</span></p><p><span>        </span><span>ud-&gt;m.vaddrout</span><span> </span><span>=</span><span> </span><span>map-&gt;raddr;</span></p><p><span>bail:</span></p><p><span>        </span><span>if</span><span> </span><span>(err)</span><span> </span><span>{</span></p><p><span>                </span><span>...</span></p><p><span>                </span><span>if</span><span> </span><span>(map)</span><span> </span><span>{</span></p><p><span>                        </span><span>mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p><span>                        </span><span>fastrpc_mmap_free(map,</span><span> </span><span>0</span><span>); </span><span>//Drop reference leaving the context as the only reference holder</span></p><p><span>                        </span><span>mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p><span>                </span><span>}</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>mutex_unlock(&amp;fl-&gt;internal_map_mutex);</span></p><p><span>        </span><span>return</span><span> </span><span>err;</span></p><p><span>}</span></p><p><span>Consider two concurrent processes (A and B) implementing the following sequence of events:</span></p><p><span>[A]: Completely fills the dsp address space with valid mappings using </span><span>fastrpc_internal_mem_map</span></p><p><span>[A]: Creates a </span><span>FASTRPC_MAP_FD_NOMAP</span><span> map with attribute </span><span>FASTRPC_ATTR_KEEP_MAP</span><span> using </span><span>fastrpc_internal_mem_map</span><span> and enters into </span><span>fastrpc_mem_map_to_dsp</span><span> (holding </span><span>internal_map_mutex</span><span>, dropped </span><span>map_mutex</span><span>)</span></p><p><span>map-&gt;refs == 1, map-&gt;ctx_refs == 0</span></p><p><span>[B]: Invokes a call using </span><span>FASTRPC_IOCTL_INVOKE2</span><span> and creates a context, </span><span>get_args</span><span> grabs the map mutex, finds and grabs a reference to map, drops the map mutex (not holding any mutexes)</span></p><p><span>map-&gt;refs == 2, map-&gt;ctx_refs == 1</span></p><p><span>[A]: </span><span>fastrpc_mem_map_to_dsp</span><span> fails as the dsp address space is completely full, </span><span>fastrpc_internal_mem_map</span><span> bails out and calls </span><span>fastrpc_mmap_free</span><span>, dropping the </span><span>internal_map_mutex</span><span> (not holding any mutexes)</span></p><p><span>map-&gt;refs == 1, map-&gt;ctx_refs == 1</span></p><p><span>[A]: Calls </span><span>fastrpc_internal_munmap_fd</span><span> grabs </span><span>internal_map_mutex</span><span>, and </span><span>map_mutex</span><span>, finds map with </span><span>fastrpc_mmap_find</span><span>, and calls </span><span>fastrpc_mmap_free</span><span> because the </span><span>FASTRPC_ATTR_KEEP_MAP</span><span> attribute is set</span></p><p><span>map-&gt;refs == 0, map-&gt;ctx_refs == 1</span><span>, mapping is kfree&#39;d</span></p><p><span>At the end of this sequence, an existing context still holds a reference to the freed map. An example crash from this bug is:</span></p><p><span></span><span>[42694.423088]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>paging</span><span> </span><span>request</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>006b6b6b6b6b6c27</span></p><p><span>[42694.423153]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>PC</span><span> </span><span>Code:</span><span> </span><span>b4000115</span><span> </span><span>7100111f</span><span> </span><span>540000c0</span><span> </span><span>7100211f</span><span> </span><span>54000080</span><span> </span><span>(b940beb4)</span><span> </span><span>71001e9f</span><span> </span><span>54001ba2</span><span> </span><span>7100211f</span><span> </span><span>54000060</span><span> </span><span>7100111f</span><span> </span><span>54000c21</span><span> </span><span>d0000120</span><span> </span><span>91040000</span><span> </span><span>95658fb7</span><span> </span><span>b9406a68</span><span> </span><span>aa0003e1</span><span> </span><span>71000508</span><span> </span><span>b9006a68</span><span> </span><span>54000181</span></p><p><span>[42694.423167]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>LR</span><span> </span><span>Code:</span><span> </span><span>2a1f03e1</span><span> </span><span>97ffeafe</span><span> </span><span>(91002294)</span><span> </span><span>eb1402bf</span></p><p><span>[42694.423229]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[42694.423236]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000004</span></p><p><span>[42694.423243]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>EC</span><span> </span><span>=</span><span> </span><span>0x25:</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[42694.423259]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[42694.423265]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[42694.423270]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>FSC</span><span> </span><span>=</span><span> </span><span>0x04:</span><span> </span><span>level</span><span> </span><span>0</span><span> </span><span>translation</span><span> </span><span>fault</span></p><p><span>[42694.423277]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[42694.423281]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000004</span></p><p><span>[42694.423288]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>   </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[42694.423294]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>[006b6b6b6b6b6c27]</span><span> </span><span>address</span><span> </span><span>between</span><span> </span><span>user</span><span> </span><span>and</span><span> </span><span>kernel</span><span> </span><span>address</span><span> </span><span>ranges</span></p><p><span>[42694.423304]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000004</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>...</span></p><p><span>[42694.424942]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Samsung</span><span> </span><span>DM1Q</span><span> </span><span>PROJECT</span><span> </span><span>(board-id,13)</span><span> </span><span>(DT)</span></p><p><span>[42694.424947]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>pstate:</span><span> </span><span>22400005</span><span> </span><span>(nzCv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO</span><span> </span><span>+TCO</span><span> </span><span>-DIT</span><span> </span><span>-SSBS</span><span> </span><span>BTYPE=--)</span></p><p><span>[42694.424954]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>fastrpc_mmap_free+0x58/0x734</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425067]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>context_free+0x130/0x2cc</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425173]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffffc036c4b8d0</span></p><p><span>[42694.425178]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x29:</span><span> </span><span>ffffffc036c4b920</span><span> </span><span>x28:</span><span> </span><span>0000000000000000</span><span> </span><span>x27:</span><span> </span><span>ffffffc036c4bba8</span></p><p><span>[42694.425190]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x26:</span><span> </span><span>0000000000000003</span><span> </span><span>x25:</span><span> </span><span>00000049216800d0</span><span> </span><span>x24:</span><span> </span><span>ffffffc003d62390</span></p><p><span>[42694.425198]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x23:</span><span> </span><span>ffffffc003d4ff88</span><span> </span><span>x22:</span><span> </span><span>0000000000000002</span><span> </span><span>x21:</span><span> </span><span>6b6b6b6b6b6b6b6b</span></p><p><span>[42694.425206]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x20:</span><span> </span><span>00000000ffffffff</span><span> </span><span>x19:</span><span> </span><span>ffffff88ef024d00</span><span> </span><span>x18:</span><span> </span><span>ffffffc01e79d028</span></p><p><span>[42694.425215]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x17:</span><span> </span><span>ffffffffffffffff</span><span> </span><span>x16:</span><span> </span><span>0000000000000004</span><span> </span><span>x15:</span><span> </span><span>0000000000000004</span></p><p><span>[42694.425222]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x14:</span><span> </span><span>ffffff8957f20000</span><span> </span><span>x13:</span><span> </span><span>0000000000001c4a</span><span> </span><span>x12:</span><span> </span><span>0000000000000003</span></p><p><span>[42694.425231]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x11:</span><span> </span><span>0000000100449c4a</span><span> </span><span>x10:</span><span> </span><span>ffffff8846550040</span><span> </span><span>x9</span><span> </span><span>:</span><span> </span><span>0000000000000000</span></p><p><span>[42694.425239]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x8</span><span> </span><span>:</span><span> </span><span>000000006b6b6b6b</span><span> </span><span>x7</span><span> </span><span>:</span><span> </span><span>2820637072707364</span><span> </span><span>x6</span><span> </span><span>:</span><span> </span><span>61203a726f727245</span></p><p><span>[42694.425247]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x5</span><span> </span><span>:</span><span> </span><span>ffffff88002ada57</span><span> </span><span>x4</span><span> </span><span>:</span><span> </span><span>6363346478302041</span><span> </span><span>x3</span><span> </span><span>:</span><span> </span><span>0000000000000000</span></p><p><span>[42694.425255]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>x2</span><span> </span><span>:</span><span> </span><span>ffffff8846550040</span><span> </span><span>x1</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span><span>x0</span><span> </span><span>:</span><span> </span><span>ffffff88ef024d00</span></p><p><span>[42694.425263]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[42694.425267]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>fastrpc_mmap_free+0x58/0x734</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425373]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>context_free+0x130/0x2cc</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425479]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>fastrpc_internal_invoke+0xb88/0x1ef4</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425584]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>fastrpc_internal_invoke2+0x320/0x408</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425689]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>fastrpc_device_ioctl+0x1b0/0x92c</span><span> </span><span>[frpc_adsprpc]</span></p><p><span>[42694.425795]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>__arm64_sys_ioctl+0x120/0x170</span></p><p><span>[42694.425805]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>invoke_syscall+0x58/0x13c</span></p><p><span>[42694.425811]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>el0_svc_common+0xb4/0xf0</span></p><p><span>[42694.425817]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>do_el0_svc+0x24/0x90</span></p><p><span>[42694.425823]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>el0_svc+0x20/0x7c</span></p><p><span>[42694.425828]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>el0t_64_sync_handler+0x84/0xe4</span></p><p><span>[42694.425833]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span>  </span><span>el0t_64_sync+0x1b8/0x1bc</span></p><p><span>[42694.425842]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Code:</span><span> </span><span>7100111f</span><span> </span><span>540000c0</span><span> </span><span>7100211f</span><span> </span><span>54000080</span><span> </span><span>(b940beb4)</span></p><p><span>[42694.425853]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>7349f07610aa0ad6</span><span> </span><span>]---</span></p><p><span>[42694.425862]</span><span> </span><span>[0:</span><span>            </span><span>poc:</span><span> </span><span>7171]</span><span> </span><span>Kernel</span><span> </span><span>panic</span><span> </span><span>-</span><span> </span><span>not</span><span> </span><span>syncing:</span><span> </span><span>Oops:</span><span> </span><span>Fatal</span><span> </span><span>exception</span></p><h4 id="h.c8nm4kjm3nmx"><span>CVE-2024-43047 (ITW): Map collision leads to UAF on 4.x kernels, and some 5.x kernel configurations</span></h4><p><span>At this point, it became apparent that two of these issues bear more than a passing resemblance to the exploit logs. The kernel panics (particularly the first one) strongly suggest that a </span><span>fastrpc_mmap</span><span> struct is involved in the initial memory corruption primitive, and the exploit makes calls to several ioctls that are responsible for the creation and administration of these structs. Additionally we previously saw memory corruption in the chain of structs/members </span><span>map-&gt;fl-&gt;cid</span><span>. The logs make a lot of sense in the context of a UAF of this </span><span>fastrpc_mmap</span><span> struct, meaning that CVE-2024-33060 and CVE-2024-49848 stand out as particularly plausible candidates to have been the ITW issue used by the attacker. However, if the exploit were triggering CVE-2024-33060, I would have expected it to generate some kernel log lines that we don’t see in the ITW artifacts. CVE-2024-49848 is disqualified on the basis of working upon strictly newer kernels than the ITW exploit was used against.</span></p><p><span>Complicating the identification of the ITW bug, the exploit repeatedly hits several early bailouts in the ioctl handlers - these bailouts have no discernible side effect and it’s unclear why the exploit exercises this code at all. It is difficult to know what log lines from the exploit are due to this behavior and what log lines are related to the exploit exercising the bug used. But the kernel panics themselves do not lie. They are indisputable records of memory corruption, and (particularly in cases where the crash came from the exploit program itself) their associated stack traces are strong indicators of proximity to the bug or to the exploit strategy. </span></p><p><span>A context treats references to a map differently depending on if the map is used as a buffer or as a handle. The context has a dynamically allocated array for map pointer references in </span><span>ctx-&gt;maps</span><span>, and both buffers and handles are referenced in this array.</span></p><p><span></span><span>static</span><span> </span><span>int</span><span> </span><span>get_args(uint32_t</span><span> </span><span>kernel,</span><span> </span><span>struct</span><span> </span><span>smq_invoke_ctx</span><span> </span><span>*ctx)</span></p><p><span>{</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>uint32_t</span><span> </span><span>sc</span><span> </span><span>=</span><span> </span><span>ctx-&gt;sc;</span></p><p><span>        </span><span>int</span><span> </span><span>inbufs</span><span> </span><span>=</span><span> </span><span>REMOTE_SCALARS_INBUFS(sc);</span></p><p><span>        </span><span>int</span><span> </span><span>outbufs</span><span> </span><span>=</span><span> </span><span>REMOTE_SCALARS_OUTBUFS(sc);</span></p><p><span>        </span><span>int</span><span> </span><span>handles,</span><span> </span><span>bufs</span><span> </span><span>=</span><span> </span><span>inbufs</span><span> </span><span>+</span><span> </span><span>outbufs;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>for</span><span> </span><span>(i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>bufs;</span><span> </span><span>++i)</span><span> </span><span>{ </span><span>//buffer references</span></p><p><span>                </span><span>...</span></p><p><span>                </span><span>if</span><span> </span><span>(ctx-&gt;fds</span><span> </span><span>&amp;&amp;</span><span> </span><span>(ctx-&gt;fds[i]</span><span> </span><span>!=</span><span> </span><span>-1</span><span>))</span></p><p><span>                        </span><span>err</span><span> </span><span>=</span><span> </span><span>fastrpc_mmap_create(ctx-&gt;fl,</span><span> </span><span>ctx-&gt;fds[i],</span><span> </span><span>NULL</span><span>,</span></p><p><span>                                        </span><span>ctx-&gt;attrs[i],</span><span> </span><span>buf,</span><span> </span><span>len,</span></p><p><span>                                        </span><span>mflags,</span><span> </span><span>&amp;ctx-&gt;maps[i]);</span></p><p><span>                </span><span>if</span><span> </span><span>(ctx-&gt;maps[i])</span></p><p><span>                        </span><span>ctx-&gt;maps[i]-&gt;ctx_refs++;</span></p><p><span>                </span><span>...</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>handles</span><span> </span><span>=</span><span> </span><span>REMOTE_SCALARS_INHANDLES(sc)</span><span> </span><span>+</span><span> </span><span>REMOTE_SCALARS_OUTHANDLES(sc);</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>for</span><span> </span><span>(i</span><span> </span><span>=</span><span> </span><span>bufs;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>bufs</span><span> </span><span>+</span><span> </span><span>handles;</span><span> </span><span>i++)</span><span> </span><span>{ </span><span>//handle references</span></p><p><span>                </span><span>...</span></p><p><span>                </span><span>if</span><span> </span><span>(!dsp_cap_ptr-&gt;dsp_attributes[DMA_HANDLE_REVERSE_RPC_CAP]</span><span> </span><span>&amp;&amp;</span></p><p><span>                                        </span><span>ctx-&gt;fds</span><span> </span><span>&amp;&amp;</span><span> </span><span>(ctx-&gt;fds[i]</span><span> </span><span>!=</span><span> </span><span>-1</span><span>))</span></p><p><span>                        </span><span>err</span><span> </span><span>=</span><span> </span><span>fastrpc_mmap_create(ctx-&gt;fl,</span><span> </span><span>ctx-&gt;fds[i],</span><span> </span><span>NULL</span><span>,</span></p><p><span>                                        </span><span>FASTRPC_ATTR_NOVA,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>dmaflags,</span></p><p><span>                                        </span><span>&amp;ctx-&gt;maps[i]);</span></p><p><span>                </span><span>if</span><span> </span><span>(!err</span><span> </span><span>&amp;&amp;</span><span> </span><span>ctx-&gt;maps[i])</span></p><p><span>                        </span><span>ctx-&gt;maps[i]-&gt;ctx_refs++;</span></p><p><span>                </span><span>if</span><span> </span><span>(err)</span><span> </span><span>{</span></p><p><span>                        </span><span>for</span><span> </span><span>(j</span><span> </span><span>=</span><span> </span><span>bufs;</span><span> </span><span>j</span><span> </span><span>&lt;</span><span> </span><span>i;</span><span> </span><span>j++)</span><span> </span><span>{</span></p><p><span>                                </span><span>if</span><span> </span><span>(ctx-&gt;maps[j]</span><span> </span><span>&amp;&amp;</span><span> </span><span>ctx-&gt;maps[j]-&gt;ctx_refs)</span></p><p><span>                                        </span><span>ctx-&gt;maps[j]-&gt;ctx_refs--;</span></p><p><span>                                </span><span>fastrpc_mmap_free(ctx-&gt;maps[j],</span><span> </span><span>0</span><span>);</span></p><p><span>                        </span><span>}</span></p><p><span>                        </span><span>...</span></p><p><span>                </span><span>}</span></p><p><span>                </span><span>...</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>mutex_unlock(&amp;ctx-&gt;fl-&gt;map_mutex);</span></p><p><span>However only buffers are freed using the pointer reference in </span><span>ctx-&gt;maps</span><span>. In fact, once handle maps are initialized without error, their reference in </span><span>ctx-&gt;maps</span><span> is never used again. Instead, the DSP is given a list of values associated with map file descriptors, and later passes these file descriptors back to the adsprpc driver in the AP once it is done using them. The AP then finds </span><span>a</span><span> map associable with the file descriptor returned by the DSP and drops a reference on it, potentially freeing it:</span></p><p><span></span><span>static </span><span>int</span><span> </span><span>put_args(uint32_t</span><span> </span><span>kernel,</span><span> struct </span><span>smq_invoke_ctx</span><span> </span><span>*ctx,</span></p><p><span>                    </span><span>remote_arg_t</span><span> </span><span>*upra)</span></p><p><span>{</span></p><p><span>for</span><span> </span><span>(i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>M_FDLIST;</span><span> </span><span>i++)</span><span> </span><span>{</span></p><p><span>                </span><span>if</span><span> </span><span>(!fdlist[i])</span></p><p><span>                        </span><span>break</span><span>;</span></p><p><span>        </span><span>if</span><span> </span><span>(!fastrpc_mmap_find(ctx-&gt;fl,</span><span> </span><span>(</span><span>int</span><span>)fdlist[i],</span><span> </span><span>NULL</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span></p><p><span>                                        </span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>&amp;mmap))</span><span> </span><span>{</span></p><p><span>                        </span><span>if</span><span> </span><span>(mmap</span><span> </span><span>&amp;&amp;</span><span> </span><span>mmap-&gt;ctx_refs)</span></p><p><span>                                </span><span>mmap-&gt;ctx_refs--;</span></p><p><span>                </span><span>fastrpc_mmap_free(mmap,</span><span> </span><span>0</span><span>);</span></p><p><span>                </span><span>}</span></p><p><span>}</span></p><p><span>This is wrong because there is </span><span>no</span><span> guarantee that the map found and de-refcounted in </span><span>put_args</span><span> will be the same map that </span><span>get_args</span><span> previously took a reference on and it in fact could be a map still referenced by another context as a buffer. I discovered that this can happen if there are map collisions (cases where two created maps would fulfill a </span><span>fastrpc_mmap_find</span><span> request). Since </span><span>fastrpc_mmap_find</span><span> will find any mapping that encompasses the searched virtual-address range, you can create a mapping B that collides with future searches for mapping A by comprising a superset of mapping A&#39;s virtual address range, e.g. by setting </span><span>mapB-&gt;va == mapA-&gt;va &amp;&amp; mapB-&gt;len &gt; mapA-&gt;len</span><span>.</span></p><ol start="1"><li><span>Create a small mapping A with </span><span>va == 0</span><span> using </span><span>fastrpc_internal_mmap</span></li><li><span>Create context 1, </span><span>get_args</span><span> gets a reference to mapping A as a </span><span>handle</span><span>.</span></li><li><span>Create a BIG second mapping B with </span><span>va == 0</span><span> using </span><span>fastrpc_internal_mmap</span><span> with the same fd as mapping A.</span></li><li><span>Create context 2, grab a reference to mapping B as a </span><span>buffer</span><span> (vs a handle) so that we use the </span><span>ctx-&gt;maps</span><span> pointer.</span></li><li><span>Complete context 1, causing </span><span>put_args</span><span> to be called. </span><span>We find and drop a refcount on mapping B since it collides with mapping A.</span><span> Mapping A’s refcount is permanently leaked.</span></li><li><span>We then unmap mapping B using </span><span>FASTRPC_IOCTL_MUNMAP</span></li></ol><p><span>Now there is a still valid context (context 2 in the above example) that still has a reference to mapping B even though mapping B was freed. Here’s an example kernel panic when triggering this bug:</span></p><p><span></span><span>[93168.108618]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>NULL</span><span> </span><span>pointer</span><span> </span><span>dereference</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>0000000000000018</span></p><p><span>[93168.108656]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Mem</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[93168.108675]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>   </span><span>ESR</span><span> </span><span>=</span><span> </span><span>0x96000006</span></p><p><span>[93168.108696]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>   </span><span>Exception</span><span> </span><span>class</span><span> </span><span>=</span><span> </span><span>DABT</span><span> </span><span>(current</span><span> </span><span>EL),</span><span> </span><span>IL</span><span> </span><span>=</span><span> </span><span>32</span><span> </span><span>bits</span></p><p><span>[93168.108716]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>   </span><span>SET</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>FnV</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[93168.108735]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>   </span><span>EA</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>S1PTW</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[93168.108754]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Data</span><span> </span><span>abort</span><span> </span><span>info:</span></p><p><span>[93168.108773]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>   </span><span>ISV</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>ISS</span><span> </span><span>=</span><span> </span><span>0x00000006</span></p><p><span>[93168.108792]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>   </span><span>CM</span><span> </span><span>=</span><span> </span><span>0,</span><span> </span><span>WnR</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>[93168.108816]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>user</span><span> </span><span>pgtable:</span><span> </span><span>4k</span><span> </span><span>pages,</span><span> </span><span>39-bit</span><span> </span><span>VAs,</span><span> </span><span>pgdp</span><span> </span><span>=</span><span> </span><span>00000000a5933260</span></p><p><span>[93168.108837]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>[0000000000000018]</span><span> </span><span>pgd=08000001926ef003,</span><span> </span><span>pud=08000001926ef003,</span><span> </span><span>pmd=0000000000000000</span></p><p><span>[93168.108905]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Internal</span><span> </span><span>error:</span><span> </span><span>Oops:</span><span> </span><span>96000006</span><span> </span><span>[#1]</span><span> </span><span>PREEMPT</span><span> </span><span>SMP</span></p><p><span>[93168.108928]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Modules</span><span> </span><span>linked</span><span> </span><span>in:</span></p><p><span>[93168.108951]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Process</span><span> </span><span>poc</span><span> </span><span>(pid:</span><span> </span><span>8227,</span><span> </span><span>stack</span><span> </span><span>limit</span><span> </span><span>=</span><span> </span><span>0x0000000041a3591e)</span></p><p><span>[93168.108979]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>CPU:</span><span> </span><span>3</span><span> </span><span>PID:</span><span> </span><span>8227</span><span> </span><span>Comm:</span><span> </span><span>poc</span><span> </span><span>FTT:</span><span> </span><span>0</span><span> </span><span>0</span><span> </span><span>Tainted:</span><span> </span><span>G</span><span> </span><span>S</span><span>      </span><span>W</span><span>         </span><span>4.19.113-27095354</span><span> </span><span>#1</span></p><p><span>[93168.109000]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Hardware</span><span> </span><span>name:</span><span> </span><span>Samsung</span><span> </span><span>X1Q</span><span> </span><span>PROJECT</span><span> </span><span>-</span><span> </span><span>SM-G981V_REV0.3_PV3</span><span> </span><span>(board-id,20)</span><span> </span><span>(DT)</span></p><p><span>[93168.109024]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>pstate:</span><span> </span><span>80400005</span><span> </span><span>(Nzcv</span><span> </span><span>daif</span><span> </span><span>+PAN</span><span> </span><span>-UAO)</span></p><p><span>[93168.109047]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>pc</span><span> </span><span>:</span><span> </span><span>dma_buf_unmap_attachment+0x20/0x58</span></p><p><span>[93168.109069]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>lr</span><span> </span><span>:</span><span> </span><span>fastrpc_mmap_free+0x3dc/0x4e8</span></p><p><span>[93168.109088]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>sp</span><span> </span><span>:</span><span> </span><span>ffffff80302239c0</span></p><p><span>[93168.109107]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x29:</span><span> </span><span>ffffff80302239c0</span><span> </span><span>x28:</span><span> </span><span>0000000000000002</span><span> </span></p><p><span>[93168.109131]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x27:</span><span> </span><span>0000000000010100</span><span> </span><span>x26:</span><span> </span><span>ffffff8030223bf0</span><span> </span></p><p><span>[93168.109154]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x25:</span><span> </span><span>ffffffc0c518f410</span><span> </span><span>x24:</span><span> </span><span>ffffffc09152ce00</span><span> </span></p><p><span>[93168.109177]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x23:</span><span> </span><span>ffffff800b48d0b0</span><span> </span><span>x22:</span><span> </span><span>0000000000010000</span><span> </span></p><p><span>[93168.109199]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x21:</span><span> </span><span>00000004f79e0000</span><span> </span><span>x20:</span><span> </span><span>0000000000000003</span><span> </span></p><p><span>[93168.109222]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x19:</span><span> </span><span>ffffffc0145d2e00</span><span> </span><span>x18:</span><span> </span><span>0000000000000000</span><span> </span></p><p><span>[93168.109244]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x17:</span><span> </span><span>0000000000000000</span><span> </span><span>x16:</span><span> </span><span>a70d810816bbf5af</span><span> </span></p><p><span>[93168.109267]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x15:</span><span> </span><span>0000000000000008</span><span> </span><span>x14:</span><span> </span><span>0000000080000000</span><span> </span></p><p><span>[93168.109289]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x13:</span><span> </span><span>0000000034155555</span><span> </span><span>x12:</span><span> </span><span>001d067cf6237800</span><span> </span></p><p><span>[93168.109312]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x11:</span><span> </span><span>0000000000000007</span><span> </span><span>x10:</span><span> </span><span>0000000000000003</span><span> </span></p><p><span>[93168.109334]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x9</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span><span>x8</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span></p><p><span>[93168.109357]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x7</span><span> </span><span>:</span><span> </span><span>0001010000000004</span><span> </span><span>x6</span><span> </span><span>:</span><span> </span><span>ffffff8030223c08</span><span> </span></p><p><span>[93168.109379]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x5</span><span> </span><span>:</span><span> </span><span>ffffff8030223c08</span><span> </span><span>x4</span><span> </span><span>:</span><span> </span><span>0000000000000004</span><span> </span></p><p><span>[93168.109401]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x3</span><span> </span><span>:</span><span> </span><span>0000000037c648b0</span><span> </span><span>x2</span><span> </span><span>:</span><span> </span><span>0000000000000000</span><span> </span></p><p><span>[93168.109423]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>x1</span><span> </span><span>:</span><span> </span><span>ffffffc111df9800</span><span> </span><span>x0</span><span> </span><span>:</span><span> </span><span>ffffffc111df9680</span><span> </span></p><p><span>[93168.114754]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[93168.114777]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>dma_buf_unmap_attachment+0x20/0x58</span></p><p><span>[93168.114799]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>fastrpc_mmap_free+0x3dc/0x4e8</span></p><p><span>[93168.114821]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>fastrpc_internal_invoke+0x1654/0x24b0</span></p><p><span>[93168.114843]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8^R27]</span><span>  </span><span>fastrpc_device_ioctl+0xcd4/0x1df8</span></p><p><span>[93168.114865]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>do_vfs_ioctl+0x6f0/0xac0</span></p><p><span>[93168.114887]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>__arm64_sys_ioctl+0x74/0xa8</span></p><p><span>[93168.114909]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>el0_svc_common+0xd8/0x188</span></p><p><span>[93168.114931]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>el0_svc_handler+0x6c/0x90</span></p><p><span>[93168.114952]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span>  </span><span>el0_svc+0x8/0x280</span></p><p><span>[93168.114977]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Code:</span><span> </span><span>b4000121</span><span> </span><span>f9400008</span><span> </span><span>b40000e8</span><span> </span><span>f9401108</span><span> </span><span>(f9400d08)</span><span> </span></p><p><span>[93168.115002]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>---[</span><span> </span><span>end</span><span> </span><span>trace</span><span> </span><span>2a2f45652740934f</span><span> </span><span>]---</span></p><p><span>[93168.197067]</span><span>  </span><span>[3:</span><span>            </span><span>poc:</span><span> </span><span>8227]</span><span> </span><span>Kernel</span><span> </span><span>panic</span><span> </span><span>-</span><span> </span><span>not</span><span> </span><span>syncing:</span><span> </span><span>Fatal</span><span> </span><span>exception</span></p><p><span>Another researcher, </span><span><a href="https://docs.qualcomm.com/product/publicresources/securitybulletin/october-2024-bulletin.html">Conghui Wang</a></span><span> </span><span>appears to have discovered </span><span><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/commit/c6e7698c0cf35551ab16d16ac5e21e2272644734">a different path</a></span><span> to reach the same bug that does not involve map collisions - since the code running on the DSP can be from an unsigned ELF binary uploaded by the attacker, it’s possible for an attacker to simply have the DSP send back bogus fd’s in an RPC response, causing the AP kernel to free mappings that are still referenced.</span></p><p><span>This bug retains a similarly high level of resemblance to the original In-The-Wild exploit as bugs CVE-2024-33060</span><span> and </span><span>CVE-2024-49848 did. It appears to be a UAF on the same object that was likely exploited given the ITW kernel logs (</span><span>struct fastrpc_mmap</span><span>), and unlike the other discovered bugs cannot be disqualified on the basis of non-intersecting version ranges or log messages. While we cannot prove beyond a doubt that this is the same bug used by the ITW attacker, after careful consideration TAG and Project Zero determined that this issue met the bar for being considered as exploited ITW. We </span><span>are</span><span> confident that this driver is under active exploitation by real-world attackers and that all the bugs resolved as part of this research had an outsized impact in preventing in-the-wild exploitation.</span></p><h2 id="h.7qtmn0ie3m4t"><span>Excavating an exploit</span></h2><p><span>After discovering these issues, I looked into potential ways to exploit a </span><span>fastrpc_mmap</span><span> struct vulnerability. Finding a compatible object to heap spray that would yield a meaningfully improved primitive (especially without an ASLR leak) is not a trivial task for this bug. While looking across the Linux kernel for useful objects to spray, my attention was once again drawn back to the ITW exploit logs, in particular the logs we saw previously involving an invalid channel id:<br/></span></p><p><span></span><span>[</span><span>   </span><span>40.917577]</span><span> </span><span>adsprpc:</span><span> </span><span>ERROR:fastrpc_mmap_free,</span><span> </span><span>Invalid</span><span> </span><span>channel</span><span> </span><span>id:</span><span> </span><span>1702834303,</span><span> </span><span>err:-44</span></p><p><span>This value is coming from </span><span>map-&gt;fl-&gt;cid</span><span> - so it seems exceedingly likely that whatever heap spray object the attacker used had a timestamp value at this offset location. Perhaps it would be possible to discover what object the attacker was heap spraying! After searching fruitlessly for cases of time-related members of variable-sized structs, my attention was drawn to kernel panic log 3:</span></p><p><span></span><span>[</span><span> </span><span>2247.159424]</span><span> </span><span>Unable</span><span> </span><span>to</span><span> </span><span>handle</span><span> </span><span>kernel</span><span> </span><span>paging</span><span> </span><span>request</span><span> </span><span>at</span><span> </span><span>virtual</span><span> </span><span>address</span><span> </span><span>006f7778a9cf5b88</span></p><p><span>...</span></p><p><span>[</span><span> </span><span>2247.159719]</span><span> </span><span>Call</span><span> </span><span>trace:</span></p><p><span>[</span><span> </span><span>2247.159727]</span><span>  </span><span>__kmalloc+0x1c4/0x398</span></p><p><span>[</span><span> </span><span>2247.159740]</span><span>  </span><span>inotify_handle_event+0xc8/0x1c8</span></p><p><span>[</span><span> </span><span>2247.159746]</span><span>  </span><span>fsnotify+0x270/0x378</span></p><p><span>We see here a crash that occurred in a heap allocation crucially </span><span>before</span><span> the invalid channel id messages typically appeared in the log. Looking at </span><span>inotify_handle_event</span><span> more closely we see the following </span><span>variable-sized</span><span> allocation:</span></p><p><span></span><span>int</span><span> </span><span>inotify_handle_event(</span><span>struct</span><span> </span><span>fsnotify_group</span><span> </span><span>*group,</span></p><p><span>                         </span><span>struct</span><span> </span><span>inode</span><span> </span><span>*inode,</span></p><p><span>                         </span><span>u32</span><span> </span><span>mask,</span><span> </span><span>const</span><span> </span><span>void</span><span> </span><span>*data,</span><span> </span><span>int</span><span> </span><span>data_type,</span></p><p><span>                         </span><span>const</span><span> </span><span>unsigned</span><span> </span><span>char</span><span> </span><span>*file_name,</span><span> </span><span>u32</span><span> </span><span>cookie,</span></p><p><span>                         </span><span>struct</span><span> </span><span>fsnotify_iter_info</span><span> </span><span>*iter_info)</span></p><p><span>{</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>struct</span><span> </span><span>inotify_event_info</span><span> </span><span>*event;</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>int</span><span> </span><span>alloc_len</span><span> </span><span>=</span><span> </span><span>sizeof</span><span>(</span><span>struct</span><span> </span><span>inotify_event_info);</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>if</span><span> </span><span>(file_name)</span><span> </span><span>{</span></p><p><span>                </span><span>len</span><span> </span><span>=</span><span> </span><span>strlen(file_name);</span></p><p><span>                </span><span>alloc_len</span><span> </span><span>+=</span><span> </span><span>len</span><span> </span><span>+</span><span> </span><span>1</span><span>;</span></p><p><span>        </span><span>}</span></p><p><span>        </span><span>...</span></p><p><span>        </span><span>event</span><span> </span><span>=</span><span> </span><span>kmalloc(alloc_len,</span><span> </span><span>GFP_KERNEL_ACCOUNT</span><span> </span><span>|</span><span> </span><span>__GFP_RETRY_MAYFAIL);</span></p><p><span></span><span>I then compared the struct offsets for</span><span> map-&gt;fl-&gt;cid</span><span> and superimposed them onto a struct </span><span>inotify_event_info</span><span> object. </span><span>We see that </span><span>map-&gt;fl-&gt;cid</span><span> aligns perfectly with </span><span>event-&gt;fse.inode-&gt;i_mtime</span><span> - the modification time for the file inode associated with the inotify event</span><span>!</span><span> Given that the cid is set to a timestamp value by the exploit, this makes perfect sense. It’s highly likely that part of the ITW exploit process involved spraying </span><span>inotify_event_info</span><span> objects in order to reclaim a UAF’d </span><span>fastrpc_mmap</span><span> struct (</span><span><a href="https://mcyoloswagham.github.io/linux/">perhaps as part of an ASLR leak</a></span><span>), and that the unrealistic channel id value is the modification time for whatever file the exploit used for the heap spray. Based on the pipe crash, it seems plausible it then reallocates the </span><span>fastrpc_mmap</span><span> struct with pipe buffers to gain full control of the underlying object. This, plus an info leak, would be more than enough to achieve code execution or arbitrary read/write.</span></p><h2 id="h.514dx1md8ils"><span>Conclusion</span></h2><p><span>It took less than 3 months of research to discover 6 separate bugs in the adsprpc driver, two of which (</span><span><a href="https://project-zero.issues.chromium.org/issues/42451725">CVE-2024-49848</a></span><span> and </span><span><a href="https://project-zero.issues.chromium.org/issues/42451710">CVE-2024-21455</a></span><span>) were not fixed by Qualcomm under the </span><span>industry standard 90-day deadline</span><span>. Furthermore, a</span><span>t the time of writing, CVE-2024-49848 remains unfixed 145 days after it was reported.</span><span> </span><span><a href="https://googleprojectzero.blogspot.com/2024/06/driving-forward-in-android-drivers.html">Past research</a></span><span> has shown</span><span> </span><span>that chipset drivers for </span><span>Android</span><span> are a promising target for attackers, and this ITW exploit represents a meaningful real-world example of the negative ramifications that the current third-party vendor driver security posture poses to end-users. A system’s cybersecurity is only as strong as its weakest link, and chipset/GPU drivers represent one of the weakest links for privilege separation on Android in 2024. Improving both the consistency and quality of code and the efficiency of the third-party vendor driver patch dissemination process are crucial next steps in order to increase the difficulty of privilege escalation on Android devices.</span></p>

</div></div>
  </body>
</html>
