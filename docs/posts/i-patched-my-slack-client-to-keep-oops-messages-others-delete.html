<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/SharonBrizinov/slack-anti-delete">Original</a>
    <h1>I patched my Slack client to keep ‚Äúoops‚Äù messages others delete</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<p dir="auto">TL;DR: I patched my Slack client to keep messages that others delete.</p>
<p dir="auto">Let&#39;s say someone sent me a message, immediately regretted it and tried to delete it. They will think the message got deleted on both ends (&#34;delete for everyone&#34;), but using this patch my client will keep the message anyway and notify me that someone tried to delete it <g-emoji alias="grimacing" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png">üò¨</g-emoji>. <a href="https://github.com/SharonBrizinov/slack-sounds">This is a follow-up research I did on how Slack is working internally</a>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188519530-346b73a3-91bb-48c7-8821-c2ad13b17155.png"><img src="https://user-images.githubusercontent.com/519424/188519530-346b73a3-91bb-48c7-8821-c2ad13b17155.png" alt="SharonBrizinov_slack-anti-delete"/></a></p>
<p dir="auto">As a bonus, you&#39;ll also get a nice notification telling you who tried to delete a message.</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188516989-223be9c4-e710-488b-9b6f-d59626abafdf.jpg"><img alt="image" src="https://user-images.githubusercontent.com/519424/188516989-223be9c4-e710-488b-9b6f-d59626abafdf.jpg"/></a>
</p>
<h2 dir="auto"><a id="user-content-demo" aria-hidden="true" href="#demo"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Demo</h2>
<details open="">
  <summary>
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true">
    <path fill-rule="evenodd" d="M16 3.75a.75.75 0 00-1.136-.643L11 5.425V4.75A1.75 1.75 0 009.25 3h-7.5A1.75 1.75 0 000 4.75v6.5C0 12.216.784 13 1.75 13h7.5A1.75 1.75 0 0011 11.25v-.675l3.864 2.318A.75.75 0 0016 12.25v-8.5zm-5 5.075l3.5 2.1v-5.85l-3.5 2.1v1.65zM9.5 6.75v-2a.25.25 0 00-.25-.25h-7.5a.25.25 0 00-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-4.5z"></path>
</svg>
    <span aria-label="Video description demo.mov">demo.mov</span>
    <span></span>
  </summary>

  <video src="https://user-images.githubusercontent.com/519424/188516996-d0c73281-32de-4f20-9317-6cba84d9050c.mov" data-canonical-src="https://user-images.githubusercontent.com/519424/188516996-d0c73281-32de-4f20-9317-6cba84d9050c.mov" controls="controls" muted="muted">

  </video>
</details>

<h2 dir="auto"><a id="user-content-instructions-mac-osx-only" aria-hidden="true" href="#instructions-mac-osx-only"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Instructions (Mac OSX only)</h2>
<p dir="auto">run <code>python3 slack_patch_delete.py</code>.</p>
<h2 dir="auto"><a id="user-content-backstory" aria-hidden="true" href="#backstory"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Backstory</h2>
<p dir="auto">The backstory is kind of funny - not so long ago my friend had a rant about his former boss. He told me a story of how his former boss accidently sent him a nasty message and then immediately deleted it. My friend wanted to confront him but had no proof because the message was gone too quickly..</p>
<h2 dir="auto"><a id="user-content-technical-details" aria-hidden="true" href="#technical-details"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Technical Details</h2>
<p dir="auto">After my previous research on <a href="https://github.com/SharonBrizinov/slack-sounds/edit/main/README.md">how Slack manages local cache media files</a>, I moved forward to research how the JS code files are stored. I opened Slack in debug mode and started to dig in. Turns out the JS files are also kept in special offline static cache files with proprietary binary format.</p>
<p dir="auto">The first stop is <code>SLACK_DIR/Code Cache/js</code>. (BTW on Mac OSX Slack dir can be <code>~/Library/Application Support/Slack</code> or <code>~/Library/Containers/com.tinyspeck.slackmacgap/Data/Library/Application Support/Slack</code>).</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188517504-b8a21bd8-40ff-4608-8b2e-2a055875f7d9.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188517504-b8a21bd8-40ff-4608-8b2e-2a055875f7d9.png"/></a>
</p>
<p dir="auto">These cache files contain binary formatted data of the requests and responses that Slack client is sending and receiving to/from the server. Slack devs probably wanted to create a balance between the statically offline Electron ASAR archive versus the overhead of sending online requests all the time - so they created a simple yet powerful trade-off. They are sending &#34;live&#34; HTTP requests but with heavy use of static cache files storing both the requests and the responses. Therefore, if a new request is fired, the request will never leave the machine; the entire loop will be closed locally offline and only static JS files will be read from the disk.</p>
<p dir="auto">But the journey to full JS execution is longer than I thought. The JS code cache files under the <code>Code Cache/js</code> directory are binary serialized JS files and this is the first stop when receiving new JS code from the server.</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188520069-a4a01a20-9952-4b76-a1c3-098ae2c3e226.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188520069-a4a01a20-9952-4b76-a1c3-098ae2c3e226.png"/></a>
</p>
<p dir="auto">Next, Slack unpacks the JS code and stores it in a different JS code cache directory under <code>SLACK_DIR/Service Worker/CacheStorage</code></p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188519927-7bfa1e56-b39a-4774-bad1-99d7a34e79a1.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188519927-7bfa1e56-b39a-4774-bad1-99d7a34e79a1.png"/></a>
</p>
<p dir="auto">Here, the JS code is unpacked and looks much like the regular obfuscated Slack code we are used to see while debugging it.</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188520016-fc399366-b3f3-4beb-bbe7-e979e05513d7.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188520016-fc399366-b3f3-4beb-bbe7-e979e05513d7.png"/></a>
</p>
<p dir="auto">Cool, so now we know where the actual code is found. But what do we need to patch in order to keep deleted messages? I used Chrome debugging tools to inspect all HTTP requests and WebSocket traffic. I quickly found out that most of the action takes place through WebSocket messages.</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188518006-7f9de2db-51f0-46fd-853f-9f734620cd04.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188518006-7f9de2db-51f0-46fd-853f-9f734620cd04.png"/></a>
</p>
<p dir="auto">The ongoing WebSocket session is very chatty and there are a lot of different message <code>subtypes</code>s but the most important one for us is <code>message_delete</code>.</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188518224-da7ccf20-a2bb-4114-b6c1-7c76b9686a2a.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188518224-da7ccf20-a2bb-4114-b6c1-7c76b9686a2a.png"/></a>
</p>
<p dir="auto">Cool. So all we need to do now is modify the JS flow so it will ignore this message type when received. We need to locate the main <code>switch</code> that handles incoming message types and modify the <code>message_delete</code> case.</p>
<p dir="auto">
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/519424/188518385-f1e319e4-16c6-499d-b153-e24891520e75.png"><img alt="image" src="https://user-images.githubusercontent.com/519424/188518385-f1e319e4-16c6-499d-b153-e24891520e75.png"/></a>
</p>
<p dir="auto">Bingo. Now we can patch the JS cache files and force our client to ignore &#39;delete message&#39; requests ;)</p>
</article>
          </div></div>
  </body>
</html>
