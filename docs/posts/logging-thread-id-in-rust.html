<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kaiwern.com/fragments/logging-thread-id-in-rust/">Original</a>
    <h1>Logging Thread ID in Rust</h1>
    
    <div id="readability-page-1" class="page"><article>
    <p>Recently, I am working on implementing concurrent operations for B+ Tree
index in Rust. Dealing with concurrency bugs can be pain in the ass and
and being able to print the thread ID along with by my debug message definitely
help me understand the interleaving operations better.</p>
<p>Here I’m going to share how I do it.</p>
<h3 id="env-logger">Env Logger</h3>
<p>I was using <a href="https://docs.rs/env_logger/latest/env_logger/"><code>env_logger</code></a> to
log my message. Upon realizing that <code>std::thread::current()</code> allow me to get
the information of the current thread executing my code, and it have the <code>id()</code>
method, I start to inject the info into my log as needed:</p>
<div><pre tabindex="0"><code data-lang="rust"><span>let</span><span> </span><span>thread_id</span><span> </span><span>=</span><span> </span><span>std</span>::<span>thread</span>::<span>current</span><span>().</span><span>id</span><span>();</span><span>
</span><span></span><span>info</span><span>!</span><span>(</span><span>&#34;{}: fetch page {page_id}&#34;</span><span>,</span><span> </span><span>thread_id</span><span>);</span><span>
</span></code></pre></div><p>Soon, I realize that I can format the log records by default
using the <code>Builder::format</code> method. So I ended up with this:</p>
<div><pre tabindex="0"><code data-lang="rust"><span>use</span><span> </span><span>std</span>::<span>io</span>::<span>Write</span><span>;</span><span>
</span><span>
</span><span></span><span>env_logger</span>::<span>builder</span><span>()</span><span>
</span><span>    </span><span>.</span><span>format</span><span>(</span><span>|</span><span>buf</span><span>,</span><span> </span><span>record</span><span>|</span><span> </span><span>{</span><span>
</span><span>        </span><span>let</span><span> </span><span>ts</span><span> </span><span>=</span><span> </span><span>buf</span><span>.</span><span>timestamp_micros</span><span>();</span><span>
</span><span>        </span><span>writeln!</span><span>(</span><span>
</span><span>            </span><span>buf</span><span>,</span><span>
</span><span>            </span><span>&#34;{}: {:?}: {}: {}&#34;</span><span>,</span><span>
</span><span>            </span><span>ts</span><span>,</span><span>
</span><span>            </span><span>std</span>::<span>thread</span>::<span>current</span><span>().</span><span>id</span><span>(),</span><span>
</span><span>            </span><span>buf</span><span>.</span><span>default_level_style</span><span>(</span><span>record</span><span>.</span><span>level</span><span>())</span><span>
</span><span>                </span><span>.</span><span>value</span><span>(</span><span>record</span><span>.</span><span>level</span><span>()),</span><span>
</span><span>            </span><span>record</span><span>.</span><span>args</span><span>()</span><span>
</span><span>        </span><span>)</span><span>
</span><span>    </span><span>})</span><span>
</span><span>    </span><span>.</span><span>init</span><span>();</span><span>
</span></code></pre></div><p>which will log my message in the following format:</p>
<pre tabindex="0"><code>2022-05-07T07:26:33.119900Z: ThreadId(7): INFO: fetch page 1
</code></pre><h3 id="tracing">Tracing</h3>
<p>Later on, I switch to using <a href="https://github.com/tokio-rs/tracing"><code>tracing</code></a>
and the setup is much simpler as follow:</p>
<div><pre tabindex="0"><code data-lang="rust"><span>let</span><span> </span><span>format</span><span> </span><span>=</span><span> </span><span>tracing_subscriber</span>::<span>fmt</span>::<span>format</span><span>().</span><span>with_thread_ids</span><span>(</span><span>true</span><span>);</span><span>
</span><span></span><span>tracing_subscriber</span>::<span>fmt</span><span>().</span><span>event_format</span><span>(</span><span>format</span><span>).</span><span>init</span><span>();</span><span>
</span></code></pre></div><p>It turns out <code>tracing_subscriber</code> formatter come with the <code>with_thread_ids</code>
method to include your thread id in your logs once set to <code>true</code>. Here’s
how the messsage look like:</p>
<pre tabindex="0"><code>May 07 15:38:42.197  INFO ThreadId(01) sqlite::table::test: fetch page 1
</code></pre><p>There are more configuration methods that might be useful for you such as <code>with_thread_names</code>,
so do have a look at the
<a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/fmt/struct.SubscriberBuilder.html">documentation</a>!</p>


    <p>(218 words)</p>
  </article></div>
  </body>
</html>
