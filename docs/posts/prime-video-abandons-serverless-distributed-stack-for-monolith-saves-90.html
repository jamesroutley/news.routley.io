<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.primevideotech.com/video-streaming/scaling-up-the-prime-video-audio-video-monitoring-service-and-reducing-costs-by-90">Original</a>
    <h1>Prime Video Abandons Serverless Distributed Stack for Monolith, saves 90%</h1>
    
    <div id="readability-page-1" class="page"><div>
                        

                            

                        
                            <div>
                                <p>At Prime Video, we offer thousands of live streams to our customers. To ensure that customers seamlessly receive content, Prime Video set up a tool to monitor every stream viewed by customers. This tool allows us to automatically identify perceptual quality issues (for example, block corruption or audio/video sync problems) and trigger a process to fix them.</p><p>Our Video Quality Analysis (VQA) team at Prime Video already owned a tool for audio/video quality inspection, but we never intended nor designed it to run at high scale (our target was to monitor thousands of concurrent streams and grow that number over time). While onboarding more streams to the service, we noticed that running the infrastructure at a high scale was very expensive. We also noticed scaling bottlenecks that prevented us from monitoring thousands of streams. So, we took a step back and revisited the architecture of the existing service, focusing on the cost and scaling bottlenecks.</p><p>The initial version of our service consisted of distributed components that were orchestrated by <span><a href="https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html" target="_blank" rel="noopener" data-cms-ai="0">AWS Step Functions</a></span>. The two most expensive operations in terms of cost were the orchestration workflow and when data passed between distributed components. To address this, we moved all components into a single process to keep the data transfer within the process memory, which also simplified the orchestration logic. Because we compiled all the operations into a single process, we could rely on scalable <span><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html" target="_blank" rel="noopener" data-cms-ai="0">Amazon Elastic Compute Cloud (Amazon EC2)</a></span> and <span><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html" target="_blank" rel="noopener" data-cms-ai="0">Amazon Elastic Container Service (Amazon ECS)</a></span> instances for the deployment.</p><h3><b>Distributed systems overhead</b></h3><p>Our service consists of three major components. The media converter converts input audio/video streams to frames or decrypted audio buffers that are sent to detectors. Defect detectors execute algorithms that analyze frames and audio buffers in real-time looking for defects (such as video freeze, block corruption, or audio/video synchronization problems) and send real-time notifications whenever a defect is found. For more information about this topic, see our <span><a href="https://www.primevideotech.com/computer-vision/how-prime-video-uses-machine-learning-to-ensure-video-quality" target="_blank" rel="noopener" data-cms-ai="0">How Prime Video uses machine learning to ensure video quality</a></span> article. The third component provides orchestration that controls the flow in the service.</p><p>We designed our initial solution as a distributed system using serverless components (for example, AWS Step Functions or <span><a href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" target="_blank" rel="noopener" data-cms-ai="0">AWS Lambda</a></span>), which was a good choice for building the service quickly. In theory, this would allow us to scale each service component independently. However, the way we used some components caused us to hit a hard scaling limit at around 5% of the expected load. Also, the overall cost of all the building blocks was too high to accept the solution at a large scale.</p><p>The following diagram shows the serverless architecture of our service.</p><div data-align-uncropped="">
        <div>
            
            
                
                    
                        
                            
                                
                                    
                                        <figure>
    
    <a id="image-c20000" name="image-c20000" data-cms-ai="0"></a>


    
        <picture>
    
    
        
            

        
    

    
    
        
    
            <source type="image/webp" width="1011" height="803" srcset="https://cdn.primevideotech.com/dims4/default/88e9f17/2147483647/strip/true/crop/1011x803+0+0/resize/1011x803!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png 1x,https://cdn.primevideotech.com/dims4/default/fbfcd55/2147483647/strip/true/crop/1011x803+0+0/resize/2022x1606!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png 2x"/>

    

    
        <source width="1011" height="803" srcset="https://cdn.primevideotech.com/dims4/default/bf61eca/2147483647/strip/true/crop/1011x803+0+0/resize/1011x803!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png"/>

    


    
    
    <img alt="The diagram shows a control plane and data plan in the initial architecture. The customer&#39;s request is handled by a lambda function that is then forwarded to relevant step functions that execute detectors. At the same time, Media Conversion service starts processing the input stream, providing artifacts to detectors through an S3 bucket. Once the analysis is completed, the aggregated result is being stored in an S3 bucket." srcset="https://cdn.primevideotech.com/dims4/default/bf61eca/2147483647/strip/true/crop/1011x803+0+0/resize/1011x803!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png 1x,https://cdn.primevideotech.com/dims4/default/2feace1/2147483647/strip/true/crop/1011x803+0+0/resize/2022x1606!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png 2x" width="1011" height="803" data-src="https://cdn.primevideotech.com/dims4/default/bf61eca/2147483647/strip/true/crop/1011x803+0+0/resize/1011x803!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png" src="https://cdn.primevideotech.com/dims4/default/bf61eca/2147483647/strip/true/crop/1011x803+0+0/resize/1011x803!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fb2%2Fd2%2Fdde535c6478d9c4b8c9891c4d93b%2F98191782.png" loading="lazy"/>


</picture>

    

    
        <div><figcaption><p><b>The initial architecture of our defect detection system.</b></p></figcaption></div>
    
</figure>

                                    
                                
                            
                        
                    
                
            
        </div>
    </div><p>The main scaling bottleneck in the architecture was the orchestration management that was implemented using AWS Step Functions. Our service performed multiple state transitions for every second of the stream, so we quickly reached account limits. Besides that, AWS Step Functions charges users per state transition.</p><p>The second cost problem we discovered was about the way we were passing video frames (images) around different components. To reduce computationally expensive video conversion jobs, we built a microservice that splits videos into frames and temporarily uploads images to an <span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" target="_blank" rel="noopener" data-cms-ai="0">Amazon Simple Storage Service (Amazon S3)</a></span> bucket. Defect detectors (where each of them also runs as a separate microservice) then download images and processed it concurrently using AWS Lambda. However, the high number of Tier-1 calls to the S3 bucket was expensive.</p><h3><b>From distributed microservices to a monolith application</b></h3><p>To address the bottlenecks, we initially considered fixing problems separately to reduce cost and increase scaling capabilities. We experimented and took a bold decision: we decided to rearchitect our infrastructure.</p><p>We realized that distributed approach wasnâ€™t bringing a lot of benefits in our specific use case, so we packed all of the components into a single process. This eliminated the need for the S3 bucket as the intermediate storage for video frames because our data transfer now happened in the memory. We also implemented orchestration that controls components within a single instance.</p><p>The following diagram shows the architecture of the system after migrating to the monolith.</p><div data-align-uncropped="">
        <div>
            
            
                
                    
                        
                            
                                
                                    
                                        <figure>
    
    <a id="image-b10000" name="image-b10000" data-cms-ai="0"></a>


    
        <picture>
    
    
        
            

        
    

    
    
        
    
            <source type="image/webp" width="1258" height="786" srcset="https://cdn.primevideotech.com/dims4/default/c32fa61/2147483647/strip/true/crop/1258x786+0+0/resize/1258x786!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png 1x,https://cdn.primevideotech.com/dims4/default/fc53e08/2147483647/strip/true/crop/1258x786+0+0/resize/2516x1572!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png 2x"/>

    

    
        <source width="1258" height="786" srcset="https://cdn.primevideotech.com/dims4/default/d0eeb09/2147483647/strip/true/crop/1258x786+0+0/resize/1258x786!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png"/>

    


    
    
    <img alt="The diagram represents a control and data plan for the updated architecture. All the components run within a single ECS task, therefore the control doesn&#39;t go through the network. Data sharing is done through instance memory and only the final results are uploaded to an S3 bucket." srcset="https://cdn.primevideotech.com/dims4/default/d0eeb09/2147483647/strip/true/crop/1258x786+0+0/resize/1258x786!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png 1x,https://cdn.primevideotech.com/dims4/default/20e9c08/2147483647/strip/true/crop/1258x786+0+0/resize/2516x1572!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png 2x" width="1258" height="786" data-src="https://cdn.primevideotech.com/dims4/default/d0eeb09/2147483647/strip/true/crop/1258x786+0+0/resize/1258x786!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png" src="https://cdn.primevideotech.com/dims4/default/d0eeb09/2147483647/strip/true/crop/1258x786+0+0/resize/1258x786!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F21%2Fd5%2Fa50088b2406686ad67a2d14a2aad%2F87955012.png" loading="lazy"/>


</picture>

    

    
        <div><figcaption><p><b>The updated architecture for monitoring a system with all components running inside a single Amazon ECS task.</b></p></figcaption></div>
    
</figure>

                                    
                                
                            
                        
                    
                
            
        </div>
    </div><p>Conceptually, the high-level architecture remained the same. We still have exactly the same components as we had in the initial design (media conversion, detectors, or orchestration). This allowed us to reuse a lot of code and quickly migrate to a new architecture.</p><p>In the initial design, we could scale several detectors horizontally, as each of them ran as a separate microservice (so adding a new detector required creating a new microservice and plug it in to the orchestration). However, in our new approach the number of detectors only scale vertically because they all run within the same instance. Our team regularly adds more detectors to the service and we already exceeded the capacity of a single instance. To overcome this problem, we cloned the service multiple times, parametrizing each copy with a different subset of detectors. We also implemented a lightweight orchestration layer to distribute customer requests.</p><p>The following diagram shows our solution for deploying detectors when the capacity of a single instance is exceeded.</p><div data-align-uncropped="">
        <div>
            
            
                
                    
                        
                            
                                
                                    
                                        <figure>
    
    <a id="image-1a0000" name="image-1a0000" data-cms-ai="0"></a>


    
        <picture>
    
    
        
            

        
    

    
    
        
    
            <source type="image/webp" width="725" height="805" srcset="https://cdn.primevideotech.com/dims4/default/4593aa1/2147483647/strip/true/crop/725x805+0+0/resize/725x805!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png 1x,https://cdn.primevideotech.com/dims4/default/02df04f/2147483647/strip/true/crop/725x805+0+0/resize/1450x1610!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png 2x"/>

    

    
        <source width="725" height="805" srcset="https://cdn.primevideotech.com/dims4/default/ea5aaa1/2147483647/strip/true/crop/725x805+0+0/resize/725x805!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png"/>

    


    
    
    <img alt="Customer&#39;s request is being forwarded by a lambda function to relevant ECS tasks. The result for each detector is stored in S3 bucket separately." srcset="https://cdn.primevideotech.com/dims4/default/ea5aaa1/2147483647/strip/true/crop/725x805+0+0/resize/725x805!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png 1x,https://cdn.primevideotech.com/dims4/default/8ba2f63/2147483647/strip/true/crop/725x805+0+0/resize/1450x1610!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png 2x" width="725" height="805" data-src="https://cdn.primevideotech.com/dims4/default/ea5aaa1/2147483647/strip/true/crop/725x805+0+0/resize/725x805!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png" src="https://cdn.primevideotech.com/dims4/default/ea5aaa1/2147483647/strip/true/crop/725x805+0+0/resize/725x805!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2Fc7%2F52%2F1c351ec34c42b31a3bf16addf4bd%2F7236309867.png" loading="lazy"/>


</picture>

    

    
        <div><figcaption><p><b>Our approach for deploying more detectors to the service. </b></p></figcaption></div>
    
</figure>

                                    
                                
                            
                        
                    
                
            
        </div>
    </div><h3><b>Results and takeaways</b></h3><p>Microservices and serverless components are tools that do work at high scale, but whether to use them over monolith has to be made on a case-by-case basis.</p><p>Moving our service to a monolith reduced our infrastructure cost by over 90%. It also increased our scaling capabilities. Today, weâ€™re able to handle thousands of streams and we still have capacity to scale the service even further. Moving the solution to Amazon EC2 and Amazon ECS also allowed us to use the <span><a href="https://aws.amazon.com/savingsplans/compute-pricing/" target="_blank" rel="noopener" data-cms-ai="0">Amazon EC2 compute saving plans</a></span> that will help drive costs down even further.</p><p>Some decisions weâ€™ve taken are not obvious but they resulted in significant improvements. For example, we replicated a computationally expensive media conversion process and placed it closer to the detectors. Whereas running media conversion once and caching its outcome might be considered to be a cheaper option, we found this not be a cost-effective approach.</p><p>The changes weâ€™ve made allow Prime Video to monitor all streams viewed by our customers and not just the ones with the highest number of viewers. This approach results in even higher quality and an even better customer experience.</p>
                            </div>
                        

                        
                </div><div>
    
        <div>
            <a href="https://www.primevideotech.com/marcin-kolny" data-cms-ai="0">
                
                    
                        <picture>
    
    
        
            

        
    

    
    
        
    
            <source type="image/webp" width="100" height="100" srcset="https://cdn.primevideotech.com/dims4/default/3983b67/2147483647/strip/true/crop/2067x2067+0+240/resize/100x100!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg 1x,https://cdn.primevideotech.com/dims4/default/2842e41/2147483647/strip/true/crop/2067x2067+0+240/resize/200x200!/format/webp/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg 2x"/>

    

    
        <source width="100" height="100" srcset="https://cdn.primevideotech.com/dims4/default/afd43c6/2147483647/strip/true/crop/2067x2067+0+240/resize/100x100!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg"/>

    


    
    
    <img alt="Marcin Kolny" srcset="https://cdn.primevideotech.com/dims4/default/afd43c6/2147483647/strip/true/crop/2067x2067+0+240/resize/100x100!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg 1x,https://cdn.primevideotech.com/dims4/default/497547e/2147483647/strip/true/crop/2067x2067+0+240/resize/200x200!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg 2x" width="100" height="100" data-src="https://cdn.primevideotech.com/dims4/default/afd43c6/2147483647/strip/true/crop/2067x2067+0+240/resize/100x100!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg" src="https://cdn.primevideotech.com/dims4/default/afd43c6/2147483647/strip/true/crop/2067x2067+0+240/resize/100x100!/quality/90/?url=https%3A%2F%2Famazon-k1-prod-entertainment.s3.amazonaws.com%2Fbrightspot%2F0e%2Fae%2F21d49cd242a485b751e0ec761ef7%2F927237646.jpeg" loading="lazy"/>


</picture>

                    
                
            </a>
        </div>

        <div>
            
                
            

            
                <p>
                    Senior SDE â€“ Prime Video
                </p>
            
        </div>
    
    </div></div>
  </body>
</html>
