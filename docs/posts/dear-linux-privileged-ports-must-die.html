<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://ar.al/2022/08/30/dear-linux-privileged-ports-must-die/">Original</a>
    <h1>Dear Linux, Privileged Ports Must Die</h1>
    
    <div id="readability-page-1" class="page"><div>
      
      <time datetime="2022-08-30T14:30:53+0100">30 Aug 2022</time>
      <figure>
    <img src="https://ar.al/2022/08/30/dear-linux-privileged-ports-must-die/toffs.jpg" alt="A photo of two actors playing Boris Johnson and some other toff popping champagne."/> <figcaption>
            <p>Privileged ports, toffs of the Linux world.</p>
        </figcaption>
</figure>

<p><a href="https://codeberg.org/kitten/app#kitten">Kitten</a> is a <a href="https://ar.al/2020/08/07/what-is-the-small-web/">small web</a> server that runs as a user-level service and would never need elevated privileges if it wasn’t for one archaic anti-security feature in Linux that dates back to the mainframe era: privileged ports.</p>
<h2 id="back-to-the-future">Back to the future</h2>
<p><a href="https://utcc.utoronto.ca/~cks/space/blog/unix/BSDRcmdsAndPrivPorts">As it was in Unix in the 1980s</a>, so it is now, that any process that wants to bind to a port less than 1024 must have elevated privileges. These ports are known as “privileged ports.” While this was a security feature in the days of dumb terminals, <strong>in the age of the World Wide Web, it is a security vulnerability.</strong></p>
<p>Privileged ports lead to dangerous security practices, like server processes forgetting to drop privileges and being run as root.</p>
<p>They’ve been <a href="https://www.linuxquestions.org/linux/articles/Technical/Why_can_only_root_listen_to_ports_below_1024">obsolete for quite a while</a>, <a href="https://news.ycombinator.com/item?id=18302380">macOS removed them as of Mojave</a><sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup>, and there’s no comparable concept on Windows either. Heck, <a href="http://adamierymenko.com/ports.html">they apparently even cause climate change</a>.</p>
<p>Not to mention, <a href="https://stackoverflow.com/questions/413807/is-there-a-way-for-non-root-processes-to-bind-to-privileged-ports-on-linux">they’re a world of unnecessary hurt to work around</a>.</p>
<p>In fact, even <a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=4.1cBSD/a/sys/netinet/in_pcb.c">their original implementation in BSD</a> was a hack:</p>
<div><pre><code data-lang="c"><span>if</span> (lport) {
  u_short aport <span>=</span> htons(lport);
  <span>int</span> wild <span>=</span> <span>0</span>;

  <span>/* GROSS */</span>
  <span>if</span> (aport <span>&lt;</span> IPPORT_RESERVED <span>&amp;&amp;</span> u.u_uid <span>!=</span> <span>0</span>)
    <span>return</span> (EACCES);
  <span>…</span>
</code></pre></div><blockquote>
<p>The BSD people knew this was a hack; they just did it anyway, probably because it was a very handy hack in their trusted local network environment. Unix has quietly inherited it ever since.</p>
<p>— <a href="https://utcc.utoronto.ca/~cks/space/blog/unix/BSDRcmdsAndPrivPorts">The BSD r* commands and the history of privileged TCP ports</a></p>
</blockquote>
<p>Listen to what some other folks have to say on the subject:</p>
<blockquote>
<p>“So we have web servers, and all other servers whose standard ports happen to fall below 1024, expecting to be started as root, bind(2) to their service address, and then “drop privileges”. <strong>At this point,  you must think I’m shitting you, but I’m not. This is for real.</strong>  Failure to drop privileges after binding to listen port is a whole  category of vulnerability. It’s like throwing egg on the stairs every morning, and several times later each day carefully classifying various accidents in the accident log as “slipped on eggy stairs”. Stop throwing egg on the stairs!”</p>
<p>— <a href="https://wibblement.blogspot.com/2021/11/the-persistent-idiocy-of-privileged.html"> The Persistent Idiocy of “Privileged Ports” on Unix</a></p>
</blockquote>
<blockquote>
<p>This port 1024 limit is a security measure. But it is based on an obsolete security model and today <strong>it only gives a false sense of security and contributes to security holes.</strong></p>
<p>— <a href="https://www.staldal.nu/tech/2007/10/31/why-can-only-root-listen-to-ports-below-1024/">Why can only root listen to ports below 1024?</a></p>
</blockquote>
<blockquote>
<p>These are the reasons why I suspect the 1024 limit was imposed:</p>
<ul>
<li>Don’t let users run system-level services on the mainframe.</li>
<li>Don’t let the users hog ports for important services on the mainframe.</li>
<li>Don’t let the users run a bogus service to steal logins on the mainframe.</li>
</ul>
<p>…and <strong>here’s why I think these aren’t relevant anymore:</strong></p>
<p><strong>- The mainframe is now the desktop.</strong></p>
<p>– <a href="https://icculus.org/finger/icculus?date=2006-08-30">…I really don’t get it</a></p>
</blockquote>
<h2 id="the-workaround">The workaround</h2>
<p>On modern Linux systems, you can configure privileged ports using <code>sysctl</code>:</p>
<div><pre><code data-lang="shell">sudo sysctl -w net.ipv4.ip_unprivileged_port_start<span>=</span><span>80</span>
</code></pre></div><p>However, that setting does not survive a reboot.</p>
<p>You can also configure the setting in a persistent way using a configuration file. e.g., by creating a file called <em>/etc/sysctl.d/99-reduce-unprivileged-port-start-to-80.conf</em> with the following content:</p>
<div><pre><code data-lang="toml">net.ipv4.ip_unprivileged_port_start=<span>80</span>
</code></pre></div><p>To remove all privileged ports, you can set that value to 0. For our needs, 80 will do as it means our web server can bind to ports 80 and 443 without requiring superuser privileges.</p>
<p>In fact, <a href="https://codeberg.org/kitten/app/src/branch/main/install#L153">the Kitten installer</a> does just this.</p>
<p>But even that has issues.</p>
<p>For one thing, it doesn’t work in rootless containers (e.g., if you’re running on an “immutable” Linux distribution like <a href="https://silverblue.fedoraproject.org/">Fedora Silverblue</a><sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>) because the configuration file gets added to the container, which doesn’t have <em>systemd</em> running <em>sysctl.d</em> so the configuration setting doesn’t get applied at boot.</p>
<p>So we’re back to having to gain temporary privileges and drop them just to alter this configuration setting every time the server is run.</p>
<p>What a pain in the ass.</p>
<h2 id="the-fix">The fix</h2>
<p><strong>The fix is easy: ship Linux distributions so that privileged ports start from 80 to begin with.</strong><sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup></p>
<div><pre><code data-lang="toml">net.ipv4.ip_unprivileged_port_start=<span>80</span>
</code></pre></div><p>Sure, this could also be set to zero but setting it to 80 would fix the number one use case today, which is to allow web servers to bind to ports 80 and 443 without requiring superuser privileges. So I’d be happy with either solution.</p>
<p>And for the three folks in Finland who administer multi-user Linux instances and rely on privileged ports for their mainframe-era security properties, they can always run <code>sysctl</code> and set their port limit to 1024 as it was before.</p>
<p>Yay, everyone’s happy!</p>
<p><strong>This is such an easy fix and one that would improve security across the board that I hope Linux distributions will start implementing it as soon as possible.</strong></p>
<p>All it takes is one major distribution to start the trend and the rest will follow. Please feel free to open issues in your distribution of choice and talk to folks you know to get them to do this.</p>
<p><em>#Linux #PrivilegedPortsMustDie</em> is what I’m saying.</p>
<p><strong>It’s time to move Linux out of the mainframe era… kicking and screaming, if need be.</strong></p>




      

    </div></div>
  </body>
</html>
