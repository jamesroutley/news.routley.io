<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://connortumbleson.com/2021/07/19/the-xbox-and-a20-line/">Original</a>
    <h1>Original Xbox Hacks: The A20 CPU Gate (2021)</h1>
    
    <div id="readability-page-1" class="page"><div>
			<p>In November of this year (2021) we will hit 20 years since the release of the original Xbox. This console was full of vulnerabilities (or misconfiguration) from the software to the hardware and with such a low price point two decades ago for a computer - it was highly popular. For this post we are going to go into a lot of details regarding one mistake Microsoft made which was the A20.</p><p><em>All the discoveries and research belongs to The Xbox Linux Project and Michael Steil. Research was obtained between personal memory of the era, a <a href="https://www.youtube.com/watch?v=9NqLljaHc80&amp;ref=connortumbleson.com">talk</a> and <a href="https://connortumbleson.com/uploads/2021/07/17mistakes-xbox.pdf">a paper</a> from Steil who was known in the scene as mist.</em></p><hr/><figure><img src="https://connortumbleson.com/content/images/2021/07/IntelD8088-2-1978.jpg" alt="" loading="lazy" width="435" height="151"/><figcaption>Intel 8088 (1978) - <a href="https://www.cpushack.com/chippics/Intel/808x/8088/IntelD8088-2-1978.html?ref=connortumbleson.com">Credit - CPUShack</a></figcaption></figure><p>So lets start with some history with some real old CPUs starting with the Intel 8088, which thanks to the <a href="https://www.cpushack.com/life-cycle-of-cpu.html?ref=connortumbleson.com">CPUShack</a> reminds us it started production in 1978 and lasted till 1998. This CPU had 20 physical address lines labeled A0 through A19 and each line represents a simple binary (0/1) so you can store 2<sup>20</sup> bytes or 1 MB of information. </p><figure><img src="https://connortumbleson.com/content/images/2021/07/cpu-intel8088.png" alt="" loading="lazy" width="944" height="707"/><figcaption>A rough drawing of address lines to RAM (A0-A19) on an Intel 8088</figcaption></figure><p>However, the 4 registers (code segment - CS, data segment - DS, stack segment - SS and extra segment - ES) only had 16 bits. So some form of translation needed to occur to map 16 bit registers to physical address space of 20 bits. This is where the small calculation came to be: <code>segment (shifted 4 bits) + offset = address</code>.</p><figure><img src="https://connortumbleson.com/content/images/2021/07/math-x86.png" alt="" loading="lazy" width="569" height="379"/><figcaption>Internal Address -&gt; Physical Address</figcaption></figure><p>So I wrote up a quick example to show how addresses translate into a physical address. Since we are shifting 4 bits, we can easily do 2<sup>4</sup> (2*2*2*2) and get 16 decimal or 0<sub>x</sub>10 hex to multiple the address by. </p><p>The thing about this notation is you can represent physical addresses with so many possible internal address + offset pairs. So knowing the early Intel 8088 only had 1MB what would happen if you asked for the memory at segment - <code>0<sub>x</sub>F800</code>, with offset <code>0<sub>x</sub>8000</code>. I&#39;ll save the long math and just say you&#39;ll get the physical address at <code>0<sub>x</sub>00100000</code> which is over the limit of a 20 bit address. The last real value would be at location <code>0<sub>x</sub>000FFFFF</code>, so the older generation CPUs just dropped any bit above the 20<sup>th</sup>.</p><p>So taking <code>0<sub>x</sub>00100000</code> would require a 21<sup>st</sup> bit, which doesn&#39;t exist on the Intel 8088 thus it gets dropped which ends up changing the location to <code>0<sub>x</sub>00000000</code>. This is known commonly as a &#34;wraparound&#34; because the location wraps back around to the beginning (or end) depending on how you are reading the memory.</p><figure><div><div><p><img src="https://connortumbleson.com/content/images/2021/07/IntelR80286-10.jpg" width="139" height="141" loading="lazy" alt=""/></p><p><img src="https://connortumbleson.com/content/images/2021/07/IntelCG80286-6C.jpg" width="180" height="180" loading="lazy" alt=""/></p><p><img src="https://connortumbleson.com/content/images/2021/07/IntelC80286-6.jpg" width="147" height="140" loading="lazy" alt=""/></p></div></div><figcaption><a href="https://www.cpushack.com/chippics/Intel/8028x/?ref=connortumbleson.com">Images from CPUShack - Intel 8028x</a></figcaption></figure><p>So the story gets interesting when you look at the history as a whole. For example, take the <a href="https://www.cpushack.com/chippics/Intel/8028x/IntelC80286-6.html?ref=connortumbleson.com">Intel 80286</a> which still rocked a 16 bit processor, but had 16 MB instead of 1 MB memory. This meant it had 24 address lines instead of 20, which wouldn&#39;t mean much except for when IBM started building the <a href="https://en.wikipedia.org/wiki/IBM_Personal_Computer/AT?ref=connortumbleson.com">PC/AT</a> (1984). The machine had additional memory, but broke compatibility with previous solutions that depended on the implicit &#34;wraparound&#34; that occurred when requesting memory outside the limitation of the address lines.</p><figure><img src="https://connortumbleson.com/content/images/2021/07/graphic-intel.png" alt="" loading="lazy" width="1660" height="412"/></figure><p>If you had trouble visualizing that, the image above should show the 20 address lines on the 8088, as well as laying the additional 4 address lines that the 80286 had above. So you can see it was not possible to represent a 21 digit binary number with only 20 lines.</p><p>So IBM probably panicked at this point - they can&#39;t swap microprocessors at this point, so they tweaked the motherboard by placing a gate on the A20 address line. So depending on signal given to the gate it could be thrown to 0, thus effectively mimicking the behavior of the older Intel 8088 if warranted. This could effectively swap the system between legacy behavior or the new. </p><p>I&#39;ve attempted to build an over simplified drawing to depict this, since the image above incorrectly assumes the gate exists at the CPU level, when in 1984 it did not.</p><figure><img src="https://connortumbleson.com/content/images/2021/07/ibm-pc-at.png" alt="" loading="lazy" width="840" height="741"/><figcaption>Another rough drawing of the IBM PC/AT</figcaption></figure><p>So I think you can see where this is going now. This feature which IBM started eventually moved into the CPU and started being included in a few of the later CPUs including the Pentium series.</p><p>The lucky original Xbox was packing a 32 bit 733 MHz Intel Pentium III processor, which indeed had this A20# Gate. So knowing the Xbox boots up (after some initialization) at <code>0<sub>x</sub>FFFFFFF0</code>, if we ground the A20 line - the Xbox will instead boot at <code>0<sub>x</sub>FFEFFFF0</code>. So once again another quick and dirty drawing to explain how this will affect the process.</p><figure><img src="https://connortumbleson.com/content/images/2021/07/memory-map.png" alt="" loading="lazy" width="950" height="239"/><figcaption>A partial memory map of the original Xbox</figcaption></figure><p>So you can see a normal Xbox boots into the secure state of the ROM. This is the portion that sets up enough critical information to verify and run the 2nd boot-loader (2BL) which then proceeds to also verify and prepare the kernel. However, grounding the A20 line proceeds to boot the Xbox directly into flash.</p><p>This is not good for Microsoft from a security perspective. The system can now boot from flash with whatever was cleverly placed there. An added bonus that booting with the A20 line grounded keeps the secret ROM still on. So a small application written and placed into flash can be used to simply dump the secret ROM.</p><p>Listening to the talk by <a href="https://www.youtube.com/watch?v=9NqLljaHc80&amp;ref=connortumbleson.com">Michael Steil</a>, he hinted that the Xbox Linux team kept this knowledge close to heart, but easily would have communicated it to the Xbox team had Microsoft wanted to communicate with the group.</p><p>With the 20 year anniversary nearing for the original Xbox - a few more deep dives into the past to come.</p>
		</div></div>
  </body>
</html>
