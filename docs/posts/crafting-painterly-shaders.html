<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.maximeheckel.com/posts/on-crafting-painterly-shaders/">Original</a>
    <h1>Crafting Painterly Shaders</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>Writing a shader that can reproduce the look and feel of aquarelle, watercolor, or gouache to obtain a more <em>painterly</em>
output for my WebGL scenes has always been a long-term goal of mine.
Inspired by the work of very talented 3D artists such
as <a href="https://twitter.com/simonxxoo">@simonxxoo</a> or <a href="https://twitter.com/arpeegee">@arpeegee</a>, the contrast between paintings and the added dimension allowed by 3D renderers
was always very appealing to me. On top of that, my recent work with <a href="https://ntietz.com/posts/moebius-style-post-processing/">stylized
shaders to mimic the hand-drawn Moebius art
style</a> emphasized not only that obtaining such stylized output was possible but also that post-processing
was more likely than not the key to emulating any artistic style.</p>
<p>After several months of on/off research that frankly was not leading to much, I stumbled upon a smoothing filter I never heard about before: the <strong>Kuwahara filter</strong>. Lucky for me, it turned out that many (very smart) people published papers about it and its ability to transform any image input into a painting-like work of art. By implementing it into a custom post-processing pass and going through many ups and downs in the process, I got very close to my original objective by building what is essentially <strong>a real-time 3D painting running in the browser</strong>:</p>
<figure></figure>
<p>This article is the culmination of months of work, trial and error, and research to <strong>craft the perfect painterly shader</strong> for your next WebGL project. In it, we will deep dive into <strong>the characteristics of the Kuwahara filter</strong> that make it so great at transforming our work into paintings, as well as look
into several techniques highlighted in the many papers I read to improve the original implementation and have it return <strong>a sharper, and more anisotropic output</strong>. Finally, we&#39;ll go through a bit of color correction and the use of textures to achieve a satisfying and accurate painting effect.</p>


<section id="painterly-post-processing-with-the-kuwahara-filter-section"><h2 id="painterly-post-processing-with-the-kuwahara-filter"><a href="#painterly-post-processing-with-the-kuwahara-filter" aria-hidden="true" tabindex="-1"><span></span></a>Painterly post-processing with the Kuwahara filter</h2><p>Up until then, my only attempts at painterly shader consisted of several implementations of custom materials focused on emulating specific aspects of paint that I instinctively listed as <em>essential</em> to get a convincing output:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The absence of texture/normal detail</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Preserved edges</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Quantized colors</p></li>
</ul><p>Below is an example of one of my &#34;best&#34; iterations from that exploratory work. It notably uses a Voronoi noise to <em>smudge normals</em> and a paintbrush texture for a more realistic look and feel.</p><p>However, despite my best efforts, this work was dead in the water as my implementation was severely flawed and only worked with a subset of meshes. From then on, I knew I had to go the post-processing route to solve most of those issues, but I didn&#39;t know how. Then, one day, I stumbled upon the beautiful work of <a href="https://twitter.com/arpeegee">@arpeegee</a>, who gave me the keywords I was missing all this time: <strong>Kuwahara filter</strong>.</p><div><div><div><p><a href="https://twitter.com/arpeegee" target="_blank" rel="noopener noreferrer"><span><span><img alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2746%27%20height=%2746%27/%3e"/></span><img alt="arpeegee" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic"/></span></a></p></div><a href="https://twitter.com/arpeegee/status/1825974541958422592" target="_blank" rel="noopener noreferrer" aria-label="@arpeegee&#39;s Twitter profile"><svg viewBox="328 355 335 276" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M 630, 425    A 195, 195 0 0 1 331, 600    A 142, 142 0 0 0 428, 570    A  70,  70 0 0 1 370, 523    A  70,  70 0 0 0 401, 521    A  70,  70 0 0 1 344, 455    A  70,  70 0 0 0 372, 460    A  70,  70 0 0 1 354, 370    A 195, 195 0 0 0 495, 442    A  67,  67 0 0 1 611, 380    A 117, 117 0 0 0 654, 363    A  65,  65 0 0 1 623, 401    A 117, 117 0 0 0 662, 390    A  65,  65 0 0 1 630, 425    Z" style="fill:#3BA9EE"></path></svg></a></div><p>I&#39;m done with this one! Learned a lot in the process 😌
Blender / Cycles https://t.co/VCkYOJeBNw</p></div><h3 id="characteristics-of-the-kuwahara-filter"><a href="#characteristics-of-the-kuwahara-filter" aria-hidden="true" tabindex="-1"><span></span></a>Characteristics of the Kuwahara filter</h3><p>Originally intended to remove noise through smoothing from medical images, the Kuwahara filter is most commonly used today to transform any input into stylistic paintings through post-processing.</p><p>Unlike other smoothing filters that reduce noise but also, on the way, blur our edges, the Kuwahara filter is capable of preserving edges and corners. That specificity is what makes it so good at achieving painting-like artistic effects by getting us two crucial visual properties of paintings:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The smoothing erases some of the texture details.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The filter preserves the edges and, in some cases, increases the sharpness compared to the original input.</p></li>
</ul><p>It achieves this by executing the following steps on each pixel of our input, which in our case would be our underlying 3D scene:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We center a box around a pixel.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We divide the box into 4 &#34;sub-boxes&#34; or <strong>Sectors</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><strong>We calculate the average color and variance for each Sector</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We set our pixel to the average color of the Sector with the <strong>lowest variance</strong>.</p></li>
</ol><p>I built the widget below to visually represent those sectors surrounding a given pixel at work:</p><p>You can see by selecting the edge examples that:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when a pixel sits just outside an edge, the Sector with the lowest variance will always be outside the edge</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when a pixel sits just inside an edge, the Sector with the lowest variance will be inside the edge</p></li>
</ul><p>highlighting the <em>edge-preserving</em> capabilities of this filter.</p><p>The widget below showcases how this process of picking the average color of the Sector with the lowest variance impacts an entire image:</p><p>Notice how, with a reasonable kernel size, we maintain the overall shapes featured in the underlying image but erase many details like, in this case, transparency. However, we can also observe that with a higher kernel size, the image filter, unfortunately, falls apart and denatures quite drastically our input, indicating that we will have to strike the right balance between kernel size and the strength of our painterly post-processing effect.</p><h3 id="our-first-implementation-of-the-kuwahara-filter-as-a-post-processing-effect"><a href="#our-first-implementation-of-the-kuwahara-filter-as-a-post-processing-effect" aria-hidden="true" tabindex="-1"><span></span></a>Our first implementation of the Kuwahara filter as a post-processing effect</h3><p>Now that we have a good understanding of the inner workings of the Kuwahara filter, let&#39;s implement it as a post-processing effect on top of a React Three Fiber scene. Much like the work done in <a href="https://ntietz.com/posts/moebius-style-post-processing/">Moebius-style post-processing and other stylized shaders</a>, we will define our custom post-processing pass using the <code>Pass</code> class from the <code>post-processing</code> package.</p><p>This post-processing pass will:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Take our underlying scene as an input.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Implement the Kuwahara filter in its fragment shader.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Output the resulting scene.</p></li>
</ul><p>The implementation of it in GLSL goes as follows:</p><div><div><p data-testid="codesnippet-title">Implementation of the Kuwahara filter in GLSL</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputBuffer</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> originalTexture</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line"> offset</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">int</span><span data-testid="content-line"> boxSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> squaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sampleCount </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> y </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> y </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> boxSize</span><span data-testid="content-line">;</span><span data-testid="content-line"> y</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> x </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> x </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> boxSize</span><span data-testid="content-line">;</span><span data-testid="content-line"> x</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> offset </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">x</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">y</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>19</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">            squaredColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> color</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">    avgColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>28</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> varianceRes </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">squaredColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">avgColor </span><span data-testid="content-line">*</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">    variance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">varianceRes</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>33</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>34</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>36</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>37</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>38</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>39</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">3</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">3</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>41</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> minVariance </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>42</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> finalColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>44</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SECTOR_COUNT</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>45</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">if</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> minVariance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>46</p><p><span><span data-testid="content-line">            minVariance </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>47</p><p><span><span data-testid="content-line">            finalColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>51</p><p><span><span data-testid="content-line">    gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">finalColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>In the code featured above, we can see that:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We&#39;re allocating an array of <code>vec3</code> and <code>float</code> to store the average color and variance for each of our Sectors, respectively.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We&#39;re computing those stats by sampling the color for every pixel in a given Sector along the x-axis and y-axis and calculating the average and variance using the formulas we saw in the previous part.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then set <code>minVariance</code> and <code>finalColor</code> as the variance and average color of the first Sector by default.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then loop through the other Sectors to find the Sector with the lowest variance and set its corresponding average color as the output of our fragment shader.</p></li>
</ol><p>Doing this will result in a version of our scene with fewer texture details while preserving the overall shape of our geometries and also introducing artifacts that <strong>look somewhat like brush strokes</strong>:</p></section>
<section id="the-papari-extension-section"><h2 id="the-papari-extension"><a href="#the-papari-extension" aria-hidden="true" tabindex="-1"><span></span></a>The Papari extension</h2><p>Through our initial implementation of the Kuwahara filter as a custom post-processing pass, we already achieved a somewhat convincing paint effect. However, it suffers from several drawbacks at high kernel sizes that may make our underlying scene not discernable by the viewer, and the appearance of our &#34;brush strokes&#34; could most likely be improved.</p><p>Ideally, we could fix both these issues in one go by allowing larger kernel sizes for a more intense stylized effect for our scene and also have more natural-looking artifacts with a slight tweak of our Kuwahara filter. That is what Giuseppe Papari proposes in his paper <strong>Artistic Edge and Corner Enhancing Smoothing</strong>. In it, he presents an <em>extension</em> to the Kuwahara filter that:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Removes the square-shaped kernel in favor of a circular one.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Improves the weight influence that each pixel has on the filter.</p></li>
</ol><p>In this part, we will implement some of those improvements with an additional section on potential performance improvements. It may sound absurd but; I like my paintings to run as close to 60fps as possible.</p><h3 id="circular-kernel"><a href="#circular-kernel" aria-hidden="true" tabindex="-1"><span></span></a>Circular kernel</h3><p>A circular-shaped kernel allows us to increase the number of Sectors when evaluating the color of a given pixel. Its box-shaped counterpart can only allow for up to four Sectors making more complex edge lines not well-preserved. Through his experiments, Papari found that <em>eight Sectors</em> were the ideal amount to balance output quality and good performance.</p><figure><p><img alt="Diagram showcasing both box-shaped and circular kernels and highlighting which parts of the image are being smoothed while maintaining the sharpness of the edges." loading="lazy" width="700" height="323" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison"/></p><figcaption>Diagram showcasing both box-shaped and circular kernels and highlighting which parts of the image are being smoothed while maintaining the sharpness of the edges.</figcaption></figure><p>The widget below showcases the impact that this subtle modification in the implementation of our filter has on a simple image:</p><p>Here, we can see that, compared to what we observed in the first part, this version of the Kuwahara filter yields a way better output even at a larger kernel size! The circular shape and the higher number of Sectors allow us to preserve edge lines for more complex angles and patterns.</p><p>We can tweak the fragment shader code to implement Papari&#39;s circular kernel into our post-processing pass by modifying the parts that compute variance and average color by Sector:</p><div><div><p data-testid="codesnippet-title">Switching to a circular kernel in our Kuwahara filter implementation</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> squaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sampleCount </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>8</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>9</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>10</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">            squaredColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> color</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">    avgColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> varianceRes </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">squaredColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">avgColor </span><span data-testid="content-line">*</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">    variance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">varianceRes</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>26</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>27</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SECTOR_COUNT</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>30</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> angle </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">i</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">6.28318</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>31</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">radius</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>In the end, the filter&#39;s principle is roughly the same. What changes here is which pixel is picked for a given sector and included in the average and variance.</p><figure><p><img alt="Diagram showcasing how the sampling of a slice of the circular kernel is split." loading="lazy" width="700" height="430" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details"/></p><figcaption>Diagram showcasing how the sampling of a slice of the circular kernel is split.</figcaption></figure><p>The demo below uses this extended version of the Kuwahara filter on top of our scene. It lets us use a larger kernel size, yielding a more stylized output while keeping our scene discernable:</p><h3 id="a-better-weighting-of-colors"><a href="#a-better-weighting-of-colors" aria-hidden="true" tabindex="-1"><span></span></a>A better weighting of colors</h3><p>The artifacts left by the filter are still quite visible at large kernel sizes. According to Papari&#39;s study, this effect is due to the <em>weighting</em> of the colors when calculating the average and the variance of a given Sector, as it does not discriminate any pixel. If a pixel is in a sector, it contributes the same amount to the calculations.</p><p>Using <strong>Gaussian weights</strong> fixes this issue:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>It provides a gradual fall-off from the center of the Sector to its edges.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>This results in more natural-looking transitions from one Sector to another, thus avoiding abrupt changes that would otherwise make those artifacts very visible.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>It <em>emphasizes</em> the central pixels more likely to represent the <strong>most accurate</strong> sector color, giving them more importance when calculating the average color.</p></li>
</ul><figure><p><img alt="Diagram comparing standard weighting vs Gaussian weighting. The darker the color of a pixel is, the &#39;heavier&#39; the weight for said pixel is." loading="lazy" width="700" height="398" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison"/></p><figcaption>Diagram comparing standard weighting vs Gaussian weighting. The darker the color of a pixel is, the &#39;heavier&#39; the weight for said pixel is.</figcaption></figure><p>To use Gaussian weighting in our filter, we only need to change a few lines from the previous implementation:</p><div><div><p data-testid="codesnippet-title">Using Gaussian weighting in our Kuwahara filter implementation</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">gaussianWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> distance</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> sigma</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">exp</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">(</span><span data-testid="content-line">distance </span><span data-testid="content-line">*</span><span data-testid="content-line"> distance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">2.0</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> sigma </span><span data-testid="content-line">*</span><span data-testid="content-line"> sigma</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedSquaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalWeight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sigma </span><span data-testid="content-line">=</span><span data-testid="content-line"> radius </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">3.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">float</span><span data-testid="content-line"> weight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">gaussianWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">length</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> sigma</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>20</p><p><span><span data-testid="content-line">            weightedColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> weight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">            weightedSquaredColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> weight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>22</p><p><span><span data-testid="content-line">            totalWeight </span><span data-testid="content-line">+=</span><span data-testid="content-line"> weight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>27</p><p><span><span data-testid="content-line">    avgColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> weightedColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> totalWeight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>28</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> varianceRes </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">weightedSquaredColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> totalWeight</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">avgColor </span><span data-testid="content-line">*</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">    variance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">varianceRes</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div></pre></div><p>As we can see in the code snippet above:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We compute the weight using the Gaussian formula.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then take the resulting weight into account when calculating our <strong>weighted color sum</strong> and <strong>weighted squared color sum</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Those weights are then reflected in the final result of the variance and average color for each Sector.</p></li>
</ol><p>Now, you may wonder whether adding all those nitty-gritty improvements to a filter that already performed quite well is worth it. You can see the result for yourself in the comparison below between a frame of our first scene using the original implementation of the Kuwahara filter and one using the Papari extension:</p><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our extended Kuwahara filter without and with Gaussian weighting." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="376" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-before-gaussian_cfx1fy 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-before-gaussian_cfx1fy 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-before-gaussian_cfx1fy"/></p><p><img alt="After" loading="eager" width="700" height="376" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-after-gaussian_zphvl2 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-after-gaussian_zphvl2 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-after-gaussian_zphvl2"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our extended Kuwahara filter without and with Gaussian weighting.</figcaption></figure><p>The result looks already better than previously, even at a low kernel size! Let&#39;s observe now the difference between both implementations for a higher value:</p><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our extended Kuwahara filter without and with Gaussian weighting at a high kernel size." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="529" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-before-gaussian_oqjiwu 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-before-gaussian_oqjiwu 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-before-gaussian_oqjiwu"/></p><p><img alt="After" loading="eager" width="700" height="529" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-after-gaussian_nsscnb 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-after-gaussian_nsscnb 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-after-gaussian_nsscnb"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our extended Kuwahara filter without and with Gaussian weighting at a high kernel size.</figcaption></figure><h3 id="fixing-a-performance-pitfall"><a href="#fixing-a-performance-pitfall" aria-hidden="true" tabindex="-1"><span></span></a>Fixing a performance pitfall</h3><p>The Gaussian function used to calculate the weights of our pixel is, unfortunately, quite expensive to run, even more so in all those nested loops necessary to sample each pixel of a given Sector. This improvement is costing us a lot of frames, and it would be very tempting to disregard it and revert to the original weighting method.</p><p>However, a team of <em>smart individuals</em> found a way to squeeze more performance out of the filter while maintaining the advantages given by the Gaussian. In <a href="https://www.umsl.edu/~kangh/Papers/kang-tpcg2010.pdf">Anisotropic Kuwahara Filtering with PolynomialWeighting Functions</a>, they propose to replace the Gaussian with a polynomial that roughly approximates it.</p><p><code>[(x + ζ) − ηy^2]^2</code></p><div><div><p data-testid="codesnippet-title">Using Polynomial weighting in our Kuwahara filter implementation</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">polynomialWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> x</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> y</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> eta</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> polyValue </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">+</span><span data-testid="content-line"> eta</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> lambda </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">y </span><span data-testid="content-line">*</span><span data-testid="content-line"> y</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> polyValue </span><span data-testid="content-line">*</span><span data-testid="content-line"> polyValue</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> squaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> weightSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">float</span><span data-testid="content-line"> weight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">polynomialWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> sampleOffset</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> eta</span><span data-testid="content-line">,</span><span data-testid="content-line"> lambda</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>When trying out this formula, I noticed the performance improvements highlighted in the paper but also that I could get a satisfying output at a smaller kernel size compared to what we&#39;ve implemented so far. I&#39;m still not exactly sure why 🤷‍♂️, but I&#39;ll take it.</p></section>
<section id="from-structure-tensor-to-anisotropic-kuwahara-filter-section"><h2 id="from-structure-tensor-to-anisotropic-kuwahara-filter"><a href="#from-structure-tensor-to-anisotropic-kuwahara-filter" aria-hidden="true" tabindex="-1"><span></span></a>From Structure Tensor to Anisotropic Kuwahara filter</h2><p>Papari&#39;s extension of the Kuwahara filter is already a step towards a lovely painterly shader, however, (I must sound like a broken record at this point) we still can perceive some artifacts left by the filter on the resulting scene. Indeed, the painting effect is applied indiscriminately to the input without any consideration for the overall structure of the current frame. In the case of a true painting, the artist would adapt the <em>flow of the brush</em> based on the direction of the edge. We&#39;re not getting this here.</p><p>Luckily, <a href="https://www.umsl.edu/~kangh/Papers/kang-tpcg2010.pdf">Anisotropic Kuwahara Filtering with PolynomialWeighting Functions</a> answers this problem by building upon the concepts of the extended Kuwahara filter we just saw.</p><p>In this paper, the authors suggest that we could adapt our circular kernel to the local features of the input during sampling by <strong>squeezing</strong> and <strong>rotating</strong> it, thus letting us sample our Sectors more accurately. As a result, our kernel would look more like an ellipsis rather than a circle.</p><figure><p><img alt="Diagram comparing isotropic kernels vs anisotropic kernels." loading="lazy" width="700" height="382" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel"/></p><figcaption>Diagram comparing isotropic kernels vs anisotropic kernels.</figcaption></figure><p>Implementing this improvement will require us to follow several steps and make our post-processing effect <strong>multi-pass</strong>:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The first pass will take the underlying scene as input and return the <strong>structure of the scene</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Then based on this structure as input we&#39;ll apply our Kuwahara filter to the underlying scene.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Finally, we&#39;ll add one extra pass to apply some tone mapping and other details that will make our painterly shader shine.</p></li>
</ol><div data-fullbleed="true"><div><figure><p><img alt="Diagram showcasing the multi-pass post-processing pipeline details in this section." loading="lazy" width="700" height="203" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline"/></p><figcaption>Diagram showcasing the multi-pass post-processing pipeline details in this section.</figcaption></figure></div></div><h3 id="sobel-operator-and-partial-derivatives"><a href="#sobel-operator-and-partial-derivatives" aria-hidden="true" tabindex="-1"><span></span></a>Sobel operator and partial derivatives</h3><p>To obtain the structure of our scene, we can leverage a <strong>Sobel operator</strong> which I introduced in <a href="https://ntietz.com/posts/moebius-style-post-processing/">Moebius-style post-processing and other stylized shaders</a> earlier this year.</p><p><code>Sx = [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]]</code></p><p><code>Sy = [[-1, -2, -1], [0, 0, 0], [1, 2, 1]]</code></p><p>However, this time we won&#39;t use it for edge detection like we did back then. We will apply our Sobel Matrix for every pixel but instead of a rapid change in intensity, which is characteristic of edges, we want to extract the partial derivatives along the x/y axis representing the <em>rate of change</em>.</p><div><div><p data-testid="codesnippet-title">Applying our Sobel Matrices when sampling</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputBuffer</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gx </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">computeStructureTensor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> uv</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>With those partial derivatives, we can obtain a <strong>structure tensor</strong></p><p>In the following fragment shader code, we apply both Sobel matrices at a given pixel, compute the structure tensor, and return it as an output.</p><div><div><p data-testid="codesnippet-title">Using Sobel Matrices to obtain the structure tensor</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputBuffer</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gx </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">computeStructureTensor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> uv</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> Sx </span><span data-testid="content-line">=</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>22</p><p><span><span data-testid="content-line">              Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>23</p><p><span><span data-testid="content-line">              Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y2</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>25</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> Sy </span><span data-testid="content-line">=</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>26</p><p><span><span data-testid="content-line">              Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">              Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y2</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">Sx</span><span data-testid="content-line">,</span><span data-testid="content-line"> Sx</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">Sy</span><span data-testid="content-line">,</span><span data-testid="content-line"> Sy</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">Sx</span><span data-testid="content-line">,</span><span data-testid="content-line"> Sy</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>33</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> tensor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">computeStructureTensor</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>35</p><p><span><span data-testid="content-line">    gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> tensor</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>If we were to visualize our scene with this tensor pass applied on top, this is what we&#39;d obtain:</p><h3 id="from-structure-tensor-to-flow"><a href="#from-structure-tensor-to-flow" aria-hidden="true" tabindex="-1"><span></span></a>From Structure Tensor to flow</h3><p>Thanks to the Structure Tensor we just obtained, we can derive the information we need to adapt our filter to the local features of our scene. This process is rather tedious and involves some notions of linear algebra that can seem daunting at first. Thus, we&#39;ll proceed step-by-step and avoid taking unnecessary shortcuts.</p><p>We want to know in which <em>direction</em> a given pixel points towards, i.e. the <strong>dominant direction and orientation of the tensor at a given position</strong>. Luckily, there is a mathematical concept that represents just that: <strong>eigenvalues</strong> and <strong>eigenvectors</strong>.</p><p>Through our structure tensor, we&#39;d like to obtain <code>λ1</code> and derive its corresponding eigenvector, giving us the <em>dominant</em> direction of the <em>local structure</em>, to adapt our filter.
We can do so by starting from the definition of an eigenvector <code>A * v = λ * v</code>. Given a Matrix <code>[[a, b], [b,c]]</code>, we have:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A * v = λ * v</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A * v - λ * v = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A * v - λ * I * v</code> where <code>I</code> is the identity matrix</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>(A - λ * I) * v = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Since we established that <code>v</code> is non-null, the only way for a product of a matrix transformation and non-zero vector to be null is if the transformation completely squishes space. This can be represented by a zero determinant for that matrix transformation, hence <code>det(A - λ * I) = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>det([[a - λ, b], [b, d - λ]]) = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>By applying the formula of the determinant we highlighted above we get: <code>(a - λ) * (d - λ) - b^2 = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Finally, if we simplify this equation, we get the following quadratic equation to solve for lambda: <code>λ^2 - (a + d)λ + (ad - b^2) = 0</code></p></li>
</ul><p>The solution of this quadratic equation gives us two possible values for lambda as we expected:</p><p><code>λ = [(a + d) ± √((a + d)^2 - 4*(ad - b^2))] / 2</code></p><p>Doing all these steps in our fragment shader code would be relatively intensive. If you look a bit closer at the formula above, you will notice that we can replace some bits with the ones of <strong>the determinant and the trace of the transformation matrix</strong>:</p><p><code>λ = [trace ± √(trace² - 4*determinant)] / 2</code></p><p>thus making us not have to perform all the steps we just went through in our shader code: we can directly use this formula to compute both eigenvalues.</p><div><div><p data-testid="codesnippet-title">Computing the eigenvalues of our structuretensor</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">r</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">g</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">b</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> trace </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">+</span><span data-testid="content-line"> Jyy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> determinant </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">-</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jxy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span></span></p></div></pre></div><p>Now that we have our eigenvalues, we can pick the largest one to derive our <strong>eigenvector</strong> following this definition:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>(A - λ * I) * v = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>[Jxx - λ, Jxy] [vx] = [0]</code> and <code>[Jxy, Jyy - λ]* [vy] [0]</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>(Jxx - λ) * vx + Jxy * vy = 0</code> and <code>Jxy * vx + (Jyy - λ) * vy = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>vx = -Jxy * vy / (Jxx - λ)</code>, and by setting <code>vy</code> to <code>1</code> for simplicity we get: <code>vx = -Jxy / (Jxx - λ)</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>we can then multiply both components by <code>Jxx - λ</code> and obtain the final value for our eigenvector: <code>v = (-Jxy, Jxx - λ)</code></p></li>
</ul><p>We can use it as is in our code, however, through many rounds of trial and error, I had to resort to using this eigenvector only if Jxy relative to the other components of the tensor matrix was above zero.</p><div><div><p data-testid="codesnippet-title">Computing the eigenvector of our structure tensor</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">getDominantOrientation</span><span data-testid="content-line">(</span><span data-testid="content-line">vec4</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">r</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">g</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">b</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> trace </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">+</span><span data-testid="content-line"> Jyy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> determinant </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">-</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jxy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> jxyStrength </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jxy</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jxx</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jyy</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jxy</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1e-7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">if</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">jxyStrength </span><span data-testid="content-line">&gt;</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>17</p><p><span><span data-testid="content-line">        v </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">Jxy</span><span data-testid="content-line">,</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">-</span><span data-testid="content-line"> lambda1</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>22</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">v</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> lambda1</span><span data-testid="content-line">,</span><span data-testid="content-line"> lambda2</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><h3 id="deriving-and-applying-anisotropy-to-our-filter"><a href="#deriving-and-applying-anisotropy-to-our-filter" aria-hidden="true" tabindex="-1"><span></span></a>Deriving and applying anisotropy to our filter</h3><p>From the Structure Tensor of our underlying scene, we derived both its eigenvalues and eigenvector. We could have also merely headed over to <a href="https://docs.opencv.org/4.x/d4/d70/tutorial_anisotropic_image_segmentation_by_a_gst.html">Anisotropic image segmentation by a gradient structure tensor</a> to find those formulas, however, we&#39;re grown-ups and it&#39;s nice to step out of our comfort zone to learn how to derive/define the tools and formulas we use in our shaders from time to time 🙂.</p><p>In <a href="https://www.umsl.edu/~kangh/Papers/kang-tpcg2010.pdf">Anisotropic Kuwahara Filtering with PolynomialWeighting Functions</a>, the authors define the anisotropy <code>A</code> using those eigenvalues as follows:</p><p><code>A = (λ1 - λ2) / (λ1 + λ2 + 1e-7)</code></p><p>With this formula, we can derive that:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A</code> ranges from <code>0</code> to <code>1</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when <code>λ1 = λ2</code>, the anisotropy is <code>0</code>, representing a <strong>isotropic</strong> region.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when <code>λ1 &gt; λ2</code>, the anisotropy tends towards <code>1</code>, representing an <strong>anisotropic</strong> region.</p></li>
</ul><p>With the anisotropy now defined, we can use it to shape the circular kernel from the Kuwahara filter along the x-axis and y-axis with</p><div><div><p data-testid="codesnippet-title">Excentricity of the circular kernel</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> structureTensor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> orientationAndAnisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">getDominantOrientation</span><span data-testid="content-line">(</span><span data-testid="content-line">structureTensor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> orientation </span><span data-testid="content-line">=</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> anisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">-</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">+</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1e-7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleX </span><span data-testid="content-line">=</span><span data-testid="content-line"> alpha </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleY </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>Notice how:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>As the anisotropy approaches <code>1</code>, the ellipsis becomes more elongated along the x-axis, stretching our circular kernel.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>When we have a relatively isotropic region, the scale factors are <code>1</code> resulting in our kernel remaining circular.</p></li>
</ul><p>We now know how to stretch and scale our kernel based on the anisotropy, the remaining task we need to achieve is to <em>orient</em> it accordingly using the eigenvector we computed previously and defining a <strong>rotation matrix</strong> from it.</p><div><div><p data-testid="codesnippet-title">Adapt our kernel using anisotropy and the eigenvector from our structure tensor</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">mat2</span><span data-testid="content-line"> anisotropyMat</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedSquaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalWeight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>14</p><p><span><span data-testid="content-line">            sampleOffset </span><span data-testid="content-line">*=</span><span data-testid="content-line"> anisotropyMat</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>24</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> structureTensor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>26</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>27</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> orientationAndAnisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">getDominantOrientation</span><span data-testid="content-line">(</span><span data-testid="content-line">structureTensor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>30</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> orientation </span><span data-testid="content-line">=</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>32</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> anisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">-</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">+</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1e-7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>35</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleX </span><span data-testid="content-line">=</span><span data-testid="content-line"> alpha </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>36</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleY </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>38</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">mat2</span><span data-testid="content-line"> anisotropyMat </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat2</span><span data-testid="content-line">(</span><span data-testid="content-line">orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">mat2</span><span data-testid="content-line">(</span><span data-testid="content-line">scaleX</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> scaleY</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>40</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SECTOR_COUNT</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>41</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> angle </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">i</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">6.28318</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>42</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropyMat</span><span data-testid="content-line">,</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">radius</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>As you can see above, the last step simply consists of applying this matrix to our <code>sampleOffset</code>. Voilà! We adapted our Kuwahara filter to be anisotropic!</p><p>I acknowledge that this process is rather tedious, however, the techniques described in the paper about the anisotropic Kuwahara filter that we reimplemented here are interesting and demonstrate the power that a few matrix transformations can have on an image and all the information we can derive from these.</p><p>The result in itself is subtle, and you&#39;ll mostly notice the advantages when:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>analyzing some specific and complex details of your scene from up close once the filter is applied</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>having a very high kernel size</p></li>
</ul><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our isotropic and anisotropic Kuwahara filter." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="460" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-before_fzlops 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-before_fzlops 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-before_fzlops"/></p><p><img alt="After" loading="eager" width="700" height="460" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-after_peebcb 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-after_peebcb 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-after_peebcb"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our isotropic and anisotropic Kuwahara filter.</figcaption></figure><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our isotropic and anisotropic Kuwahara filter." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="661" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-before_qx9lza 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-before_qx9lza 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-before_qx9lza"/></p><p><img alt="After" loading="eager" width="700" height="661" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-after_hank5e 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-after_hank5e 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-after_hank5e"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our isotropic and anisotropic Kuwahara filter.</figcaption></figure><p>Below is the full implementation of our multi-pass anisotropic Kuwahara filter:</p></section>
<section id="final-touches-and-conclusion-section"><h2 id="final-touches-and-conclusion"><a href="#final-touches-and-conclusion" aria-hidden="true" tabindex="-1"><span></span></a>Final touches and conclusion</h2><p>To bring out the best of our painterly shader, we can add a final post-processing pass to our scene to perform a few tweaks such as:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>quantization</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>color interpolation</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>saturation</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>tone mapping</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>adding some texture to the output</p></li>
</ul><p>Quantization will help reduce the number of colors our output will feature. I covered this method in length in <a href="https://ntietz.com/posts/the-art-of-dithering-and-retro-shading-web/">The Art of Dithering and Retro Shading for the Web</a>. As a reminder, the formula behind quantization is:</p><p><code>floor(color * (n - 1) + 0.5)/n - 1</code> where n is the total number of colors.</p><p>In our fragment shader for our final pass, we can add quantization by:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Calculating the grayscale value of the current pixel.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Setting the number of colors <code>n</code>. In my examples, I picked <code>16</code>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Using the formula established above.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Clamp the range to avoid extreme values which wouldn&#39;t yield a realistic painting effect.</p></li>
</ol><div><div><p data-testid="codesnippet-title">Applying quantization in our final post-processing pass</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> grayscale </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> qn </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">floor</span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">n </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">n </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    qn </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">qn</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div></pre></div><p>On top of that, to obtain a more painterly color output, we can use a <strong>Two Point Interpolation</strong> to blend our colors with our grayscale quantized image:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>For a darker quantized pixel, we&#39;d opt to interpolate from black (or close to black) to the image color based on that quantization value.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>For a lighter quantized pixel, we&#39;d interpolate from the image to white.</p></li>
</ul><div><div><p data-testid="codesnippet-title">Adding two point color interpolation</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.1</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> color</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> qn </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">qn </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>This method emphasizes the contrast between light (represented by white space) and dark areas (more painted, darker colors).</p><p>To make our output <em>pop</em> more, I also chose to increase the saturation of our colors:</p><div><div><p data-testid="codesnippet-title">Saturating our color output</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec3</span><span data-testid="content-line"> </span><span data-testid="content-line">sat</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> adjustment</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> W </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.2125</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.7154</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0721</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> intensity </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> W</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">intensity</span><span data-testid="content-line">,</span><span data-testid="content-line"> rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> adjustment</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sat</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>And, finally, I added some tone mapping for better color balance:</p><div><div><p data-testid="codesnippet-title">Applying tone mapping to our scene</p></div><pre><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">a </span><span data-testid="content-line">*</span><span data-testid="content-line"> x </span><span data-testid="content-line">+</span><span data-testid="content-line"> b</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">c </span><span data-testid="content-line">*</span><span data-testid="content-line"> x </span><span data-testid="content-line">+</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> e</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sat</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">ACESFilm</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> outputColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">    gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> outputColor</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>You can see that these little color improvements compound into significant changes highlighting the best features of our painterly shader:</p><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our post-processing pipeline without/with the final pass." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="465" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-without-final-pass_d2ag3x 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-without-final-pass_d2ag3x 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-without-final-pass_d2ag3x"/></p><p><img alt="After" loading="eager" width="700" height="465" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-with-final-padd_gwu0s8 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-with-final-padd_gwu0s8 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-with-final-padd_gwu0s8"/></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our post-processing pipeline without/with the final pass.</figcaption></figure><p>To wrap it all up, and give our output some <em>physicality</em> and <em>realism</em>, we can add a paper-like texture and blend it with the color output of our fragment shader, exactly as <a href="https://twitter.com/arpeegee">@arpeegee</a> did in the example that originally inspired this article.
This is a very easy trick that adds a <em>lot</em> of details to our scene and makes it look like a real painting.</p><p>The demo below bundles all those improvements together on top of the anisotropic Kuwahara filter making an otherwise standard scene look like a beautiful painting with many features reminiscent of watercolor which is the effect I was originally trying to achieve.</p><p>As we saw throughout this article, making a satisfying painterly shader seemed simple on the surface thanks to the standard implementation of the Kuwahara filter. However, it turned out to be much more intricate once we started to dig deeper, trying to fix the artifacts that each technique yielded. If you were to ask me my take on the topic, <strong>I&#39;d consider the Papari extension of the Kuwahara filter with polynomial weighting to be enough</strong> in most cases, while also being relatively performant compared to its anisotropic counterpart. At the end of the day, it&#39;s almost more a question of personal taste/creative choice as the different iterations of this image filter can produce drastically different results given an underlying scene/image.</p><p>Nonetheless, deep diving into how to obtain the structure tensor of an image and deriving anisotropy through many layers of linear algebra is far from useless as the technique can be ported to <em>many</em> other post-processing effects (one of which I&#39;m considering writing about here). Consider it as one additional tool in your ever-growing shader toolbelt.</p><p>To finish this article, which was quite the undertaking not going to lie, here are a couple more shots/paintings of some of the test scenes I used while building this custom post-processing shader:</p><figure><p><img alt="Orange Tree 1 - Anisotropic Kuwahara filter" loading="lazy" width="700" height="426" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz"/></p><figcaption>Orange Tree 1 - Anisotropic Kuwahara filter</figcaption></figure><figure><p><img alt="Raymarched Clouds - Extended Kuwahara filter" loading="lazy" width="700" height="388" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia"/></p><figcaption>Raymarched Clouds - Extended Kuwahara filter</figcaption></figure><figure><p><img alt="Orange Tree 2 - Anisotropic Kuwahara filter" loading="lazy" width="700" height="426" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l"/></p><figcaption>Orange Tree 2 - Anisotropic Kuwahara filter</figcaption></figure><figure><p><img alt="Spaceship formation - Extended Kuwahara filter" loading="lazy" width="700" height="410" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake"/></p><figcaption>Spaceship formation - Extended Kuwahara filter</figcaption></figure></section></div></div></div>
  </body>
</html>
