<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://forum.qubes-os.org/t/create-a-gaming-hvm/19000">Original</a>
    <h1>Create a QubesOS Gaming HVM with GPU PCI passthrough (2023)</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="text">
              
<p>To have an ‘HVM’ for gaming, you must have</p>
<ul>
<li>
<p>A dedicated GPU. By dedicated, it means: it is a secondary GPU, not the GPU used to display dom0. In 2023, ‘Nvidia’ and ‘Amd’ GPU work. Not tested with Intel GPUs. External GPU using thunderbolt work (<a href="https://forum.qubes-os.org/t/create-a-gaming-hvm/19000/8">Create a Gaming HVM - #8 by solene</a>)</p>
</li>
<li>
<p>A lot of patience. GPU passthrough is not trivial, and you will need to spend time debugging.</p>
</li>
<li>
<p>A screen available for the gaming ‘HVM’. (It can be a physical monitor or just to have multiple cables connected to the screen and switching between input source) <strong>[Optional]</strong></p>
</li>
<li>
<p>Dedicated gaming mouse and keyboard <strong>[Optional]</strong> .</p>
</li>
</ul>

<h2><a name="p-86347-goal-3" href="#p-86347-goal-3"></a>Goal</h2>
<h4><a name="p-86347-what-4" href="#p-86347-what-4"></a>What</h4>
<p>The goal of this step if to retrieve the default IOMMU Group (<a href="https://www.kernel.org/doc/html/latest/driver-api/vfio.html#groups-devices-and-iommus">VFIO - “Virtual Function I/O” — The Linux Kernel documentation</a>) of your hardware.</p>
<h4><a name="p-86347-why-5" href="#p-86347-why-5"></a>Why</h4>
<p>It can help understanding potential issue with your setup (what devices live in the same IOMMU group as your GPU) / finding potential  workaround.</p>
<h4><a name="p-86347-how-6" href="#p-86347-how-6"></a>How</h4>
<p>You can’t see your IOMMU Group when you are using Xen (the information is hidden from dom0).</p>
<ul>
<li>Boot a live linux distribution</li>
<li>In the grub, enable iommu: Add the parameters <code>iommu=1 iommu_amd=on</code> to the linux commandline</li>
<li>Once you logged in your live linux distribution, you need to retrieve the folder structure of <code>/sys/kernel/iommu_group</code>.</li>
</ul>
<pre data-code-wrap="bash"><code>#!/bin/bash
shopt -s nullglob
for g in /sys/kernel/iommu_groups/*; do
 echo &#34;IOMMU Group ${g##*/}:&#34;
 for d in $g/devices/*; do
  echo -e &#34;\t$(lspci -nns ${d##*/})&#34;
done
done
</code></pre>

<p>You must hide your secondary GPU from dom0. To do that, you have to modify the GRUB. In a dom0 Terminal, type:</p>
<pre data-code-wrap="bash"><code>qvm-pci
</code></pre>
<p>Then find the devices id for your secondary GPU. In my case, it is <code>dom0:0a_00.0</code>. Edit /etc/default/grub, and add the PCI hiding.</p>
<pre><code>GRUB_CMDLINE_LINUX=&#34;... rd.qubes.hide_pci=0a:00.0 &#34;
</code></pre>
<p>then regenerate the grub</p>
<pre data-code-wrap="bash"><code>grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<p>If you are using UEFI and Qubes OS 4.1 or earlier, the file to override with <code>grub2-mkconfig</code> is <code>/boot/efi/EFI/qubes/grub.cfg</code>.</p>
<p>Note: if after this step when you reboot the computer you get stuck in the QubesOS startup that means you are trying to use the GPU you just hid. Check your BIOS options. Also check the cables, BIOS have some GPU priority based on the type of cable. For example, DisplayPort can be favoured over HDMI.</p>
<p>Once you have rebooted, in dom0, type <code>sudo lspci -vvn</code>, you should see “Kernel driver in use: pciback” for the GPU you just hid.</p>

<p>Since the release of this qubes version of xen: <a href="https://github.com/QubesOS/qubes-vmm-xen/commit/b567bd91d0cda0b65c6dd7f28468f97cbb85f0c7">4.17.2-8</a> (R4.2, 2024-01-03), no additional configuration is required.</p>
<p>Remove any existing “max-ram-below-4g” workaround</p>
<details>
<summary>
If you are using an older version</summary>
<h2><a name="p-86347-why-do-we-need-to-do-that-9" href="#p-86347-why-do-we-need-to-do-that-9"></a>Why do we need to do that ?</h2>
<p><a href="https://github.com/QubesOS/qubes-issues/issues/4321#issuecomment-423011787">github.com/QubesOS/qubes-issues/issues/4321</a></p>
<p>Copy-paste of the comment:</p>
<p>This is caused by the default TOLUD (Top of Low Usable DRAM) of 3.75G provided by qemu not being large enough to accommodate the larger BARs that a graphics card typically has. The code to pass a custom max-ram-below-4g value to the qemu command line does exist in the libxl_dm.c file of xen, but there is no functionality in libvirt to add this parameter. It is possible to manually add this parameter to the qemu commandline by doing the following in a dom0 terminal.</p>
<hr/>
<p>( “max-ram-below-4g” is not related to the amount of ram you can pass to the VM. It is not related to VRAM either. It is related to WHAT is available in the memory space for 32 bits system and WHAT is stored in the memory space for 64 bits system (usable ram is only a part of what need to be mapped in the memory space) )</p>
<h2><a name="p-86347-finding-the-correct-value-for-this-parameter-10" href="#p-86347-finding-the-correct-value-for-this-parameter-10"></a>Finding the correct value for this parameter</h2>
<p>Below, we set the “max-ram-below-4g” parameter to “3.5G”.</p>
<p>For some GPU this value need to be “2G” (discovered here: <a href="https://forum.qubes-os.org/t/quick-howto-gpu-passthrough-with-lots-of-ram/21156">Quick howto: GPU passthrough with lots of RAM</a>). It is not currently well understood why the value need to be exactly “2G” or exactly “3.5G”, or maybe some other values for other GPU/configuration we never saw yet.  ( <a href="https://github.com/QubesOS/qubes-issues/issues/4321#issuecomment-1206000974">AppVM with GPU pass-through crashes when more than 3.5 GB (3584MB) of RAM is assigned to it · Issue #4321 · QubesOS/qubes-issues · GitHub</a> )</p>
<p>Current best guess is to run this command in dom0:</p>
<p><strong>Update</strong>: I think I discovered the reason (<a href="https://github.com/QubesOS/qubes-issues/issues/4321#issuecomment-1828226780">AppVM with GPU pass-through crashes when more than 3.5 GB (3584MB) of RAM is assigned to it · Issue #4321 · QubesOS/qubes-issues · GitHub</a> <a href="https://lists.xenproject.org/archives/html/xen-devel/2023-12/msg00133.html">Xen project Mailing List</a> ). If you want and have the skills required to compile the xen package, try to apply this patch <a href="https://github.com/QubesOS/qubes-vmm-xen/pull/172/files">Fix guest memory corruption caused by hvmloader by neowutran · Pull Request #172 · QubesOS/qubes-vmm-xen · GitHub</a> and confirm it if work as expected. With this patch, the part about “patching stubdom-linux-rootfs.gz” is not needed.</p>
<h2><a name="p-86347-patching-stubdom-linux-rootfsgz-11" href="#p-86347-patching-stubdom-linux-rootfsgz-11"></a>Patching stubdom-linux-rootfs.gz</h2>
<p>I modified the original code to:</p>
<ul>
<li>make it works with Qubes R4.1/R4.2</li>
<li>removed one of the original limitations by restricting the modification to VM with a name starting with “gpu_”</li>
<li>Added a way to modify per vm the value for “max-ram-below-4g”. Ex, if you want specifically to use 2G for “max-ram-below-4g”, name the vm “gpu_2G_YOURNAME”, if you want specifically to use 3.5G for “max-ram-below-4g”, name the vm “gpu_3n5G_YOURNAME”</li>
</ul>
<pre data-code-wrap="bash"><code>mkdir stubroot
cp /usr/libexec/xen/boot/qemu-stubdom-linux-rootfs stubroot/qemu-stubdom-linux-rootfs.gz
cd stubroot
gunzip qemu-stubdom-linux-rootfs.gz
cpio -i -d -H newc --no-absolute-filenames &lt; qemu-stubdom-linux-rootfs
rm qemu-stubdom-linux-rootfs
nano init
</code></pre>
<p>Before the line</p>
<pre><code># $dm_args and $kernel are separated with \n to allow for spaces in arguments
</code></pre>
<p>add:</p>
<pre data-code-wrap="bash"><code>vm_name=$(xenstore-read &#34;/local/domain/$domid/name&#34;)
if [ $(echo &#34;$vm_name&#34; | grep -iEc &#39;^gpu_&#39; ) -eq 1 ]; then
 max_ram_below_4g=$(echo &#34;$vm_name&#34; | grep -iEo &#34;_([0-9]*(n[0-9]*)?)._&#34; | cut -d &#39;_&#39; -f 2)
 if [[ -z &#34;$max_ram_below_4g&#34; ]];
 then
  max_ram_below_4g=&#34;3.5G&#34;
 fi
 max_ram_below_4g=$(echo &#34;$max_ram_below_4g&#34; | sed &#39;s/n/./g&#39;)
 dm_args=$(echo &#34;$dm_args&#34; | sed -n &#39;1h;2,$H;${g;s/\(-machine\nxenfv\)/\1,max-ram-below-4g=&#39;&#34;$max_ram_below_4g&#34;&#39;/g;p}&#39;)
fi
</code></pre>
<p>Then execute:</p>
<pre data-code-wrap="bash"><code>find . -print0 | cpio --null -ov \
--format=newc | gzip -9 &gt; ../qemu-stubdom-linux-rootfs
sudo mv ../qemu-stubdom-linux-rootfs /usr/libexec/xen/boot/
</code></pre>
<p>Note that this will apply the change to the HVM with a name starting with “gpu_”. So you need to name your gaming HVM “gpu_SOMETHING”.</p>
<p>Alternatively, the following dom0 script “patch_stubdom.sh” does all the previous steps:</p>
<pre><code>#!/bin/bash 

patch_rootfs(){

 filename=${1?Filename is required}

 cd ~/

 sudo rm -R &#34;patched_$filename&#34;
 mkdir &#34;patched_$filename&#34;

 cp /usr/libexec/xen/boot/$filename &#34;patched_$filename/$filename.gz&#34;
 cp /usr/libexec/xen/boot/$filename &#34;$filename.original&#34;

 cd patched_$filename
 gunzip $filename.gz
 cpio -i -d -H newc --no-absolute-filenames &lt; &#34;$filename&#34;
 sudo rm $filename

 grep -i &#34;max-ram-below-4g&#34; init &amp;&amp; echo &#34;!!ERROR!! The thing is already patched ! EXITING ! &#34; &gt;&amp;2 &amp;&amp; exit

patch_string=$(cat &lt;&lt;&#39;EOF&#39;


vm_name=$(xenstore-read &#34;/local/domain/$domid/name&#34;)
if [ $(echo &#34;$vm_name&#34; | grep -iEc &#39;^gpu_&#39; ) -eq 1 ]; then
 max_ram_below_4g=$(echo &#34;$vm_name&#34; | grep -iEo &#34;_([0-9]*(n[0-9]*)?)._&#34; | cut -d &#39;_&#39; -f 2)
 if [[ -z &#34;$max_ram_below_4g&#34; ]];
 then
  max_ram_below_4g=&#34;3.5G&#34;
 fi
 max_ram_below_4g=$(echo &#34;$max_ram_below_4g&#34; | sed &#39;s/n/./g&#39;)
 dm_args=$(echo &#34;$dm_args&#34; | sed -n &#39;1h;2,$H;${g;s/\\(-machine\\nxenfv\\)/\\1,max-ram-below-4g=&#39;&#34;$max_ram_below_4g&#34;&#39;/g;p}&#39;)
fi
\# $dm_args and $kernel

EOF
)

awk -v r=&#34;$patch_string&#34; &#39;{gsub(/^# \$dm_args and \$kernel/,r)}1&#39; init &gt; init2
cp init /tmp/init_$filename
mv init2 init
chmod +x init

 find . -print0 | cpio --null -ov \
--format=newc | gzip -9 &gt; ../$filename.patched
 sudo cp ../$filename.patched /usr/libexec/xen/boot/$filename

 cd ~/


}

grep -i &#34;max-ram-below-4g&#34; /usr/share/qubes/templates/libvirt/xen.xml &amp;&amp; &#34;!!ERROR!! xen.xml is patched ! EXITING ! &#34; &amp;&amp; exit
patch_rootfs &#34;qemu-stubdom-linux-rootfs&#34;
patch_rootfs &#34;qemu-stubdom-linux-full-rootfs&#34;

echo &#34;stubdom have been patched.&#34;

</code></pre>
<details>
<summary>
OUTDATED - DO NOT USE - Other method: Patching xen.xml instead of stubdom</summary>
<p>Instead of patching stubdom-linux-rootfs, you could inject the command directly inside the configuration template. It is the file &#34;core-admin/ “templates/libvirt/xen.xml” in the “qubes-core-admin” repository. In dom0 this file is in “/usr/share/qubes/templates/libvirt/xen.xml”</p>
<p>See below the part that have been modified to add the needed “max-ram-below-4g” option.</p>
<pre><code>&lt;!-- server_ip is the address of stubdomain. It hosts it&#39;s own DNS server. --&gt;
&lt;emulator
 {% if vm.features.check_with_template(&#39;linux-stubdom&#39;, True) %}
 type=&#34;stubdom-linux&#34;
 {% else %}
 type=&#34;stubdom&#34;
 {% endif %}
 {% if vm.netvm %}
 {% if vm.features.check_with_template(&#39;linux-stubdom&#39;, True) %}
 cmdline=&#34;-qubes-net:client_ip={{ vm.ip -}}
 ,dns_0={{ vm.dns[0] -}}
 ,dns_1={{ vm.dns[1] -}}
 ,gw={{ vm.netvm.gateway -}}
 ,netmask={{ vm.netmask }} -machine xenfv,max-ram-below-4g=3.5G&#34;
 {% else %}
 cmdline=&#34;-net lwip,client_ip={{ vm.ip -}}
 ,server_ip={{ vm.dns[1] -}}
 ,dns={{ vm.dns[0] -}}
 ,gw={{ vm.netvm.gateway -}}
 ,netmask={{ vm.netmask }} -machine xenfv,max-ram-below-4g=3.5G&#34;
 {% endif %}
 {% else %}
 cmdline=&#34;-machine xenfv,max-ram-below-4g=3.5G&#34;
 {% endif %}
</code></pre>
<p>A better patch for xen.xml is available here: <a href="https://github.com/QubesOS/qubes-issues/issues/4321#issuecomment-1551203532">AppVM with GPU pass-through crashes when more than 3.5 GB (3584MB) of RAM is assigned to it · Issue #4321 · QubesOS/qubes-issues · GitHub</a></p>
<p>I haven’t personnally tested this alternative but it should work and some users reported that it work. This method is less tested than patching stubdom-linux-rootfs, so I recommend patching stubdom-linux-rootfs.</p>
</details>
</details>

<p>As of 2023, I recommend using a Linux guest instead of a window guest.</p>
<h2><a name="p-86347-windows-13" href="#p-86347-windows-13"></a>Windows</h2>
<p>Install a window VM, you can use this <a href="https://github.com/elliotkillick/qvm-create-windows-qube">qvm-create-windows-qube</a></p>
<h2><a name="p-86347-linux-14" href="#p-86347-linux-14"></a>Linux</h2>
<p>Create a new standalone Qube based on the template of your choice.</p>
<p>You must run the kernel provided by the guest distribution, because we will use some non-default kernel module for the GPU driver. Just follow the doc: <a href="https://www.qubes-os.org/doc/managing-vm-kernel/#distribution-kernel">managing-vm-kernel</a>.</p>
<p>Install the GPU drivers you need.</p>
<p>And automated way to do that is proposed here: <a href="https://forum.qubes-os.org/t/create-a-gaming-hvm/19000#p-86347-automating-most-of-that-24">Create a Gaming HVM</a></p>

<p>In qubes settings for the HVM, go to the ‘devices’ tab, pass the ID corresponding to your GPU.</p>
<pre data-code-wrap="bash"><code>qvm-pci attach gpu_gaming_archlinux dom0:0a_00.0 --persistent
</code></pre>
<p>You may or may not need to add the option “permissive” or “no-strict-reset”.</p>
<p><a href="https://www.qubes-os.org/doc/device-handling-security/#pci-security">Some word about the security implication of thoses parameters.</a></p>
<pre data-code-wrap="bash"><code>qvm-pci attach gpu_gaming_archlinux dom0:0a_00.0 -o permissive=True -o no-strict-reset=True --persistent
</code></pre>

<p><strong>This is where you will have a lot of issues to debug. Prepare for intense suffering</strong></p>
<p>For Linux guests, run ‘sudo dmesg’ to have all the kernel log indicating you if there is a issue with your GPU driver. For some hardware, the MSI calls won’t work. You can work around that using for example <code>pci=nomsi</code> or <code>NVreg_EnableMSI=0</code> or something else. Check your drivers options. Check if alternative drivers exist (amdgpu, nvidia, nouveau, nvidia-open, using drivers from the official website, …). Check multiple kernel version.</p>
<p>For nvidia GPU, I recommand using “nvidia-open” drivers instead of “nvidia”</p>
<p>Some links that could help you to debug the issues you will have</p>
<ul>
<li>
<p><a href="https://forum.qubes-os.org/t/ryzen-7000-serie/">https://forum.qubes-os.org/t/ryzen-7000-serie/</a></p>
</li>
<li>
<p><a href="https://dri.freedesktop.org/docs/drm/gpu/amdgpu.html">https://dri.freedesktop.org/docs/drm/gpu/amdgpu.html</a></p>
</li>
</ul>
<p>For windows guests you will probably have the same issues but it will be harder to debug. I recommend using the drivers from Windows Update instead of the official drivers from the website of the constructor.</p>
<p>Some things that may be useful for debugging:</p>
<ul>
<li>
<p>Virsh (start, define, …)</p>
</li>
<li>
<p>/etc/libvirt/libxl/</p>
</li>
<li>
<p>xl</p>
</li>
<li>
<p>/etc/qubes/templates/libvirt/xen/by-name/</p>
</li>
<li>
<p>/usr/lib/xen/boot/</p>
</li>
<li>
<p>virsh -c xen:/// domxml-to-native xen-xm /etc/libvirt/libxl/…</p>
</li>
</ul>
<p>Issues with the drivers could be related to ‘qubes-vmm-xen-stubdom-linux’, ‘qubes-vmm-xen’, and the Linux kernel you will be using.</p>

<p>In some cases, it will just work out of the box (application will automatically detect the GPU and will be able to use it without modification.</p>
<p>In some cases, an additionnal layer is required: using VirtualGL, mentionned here: <a href="https://forum.qubes-os.org/t/seamless-gpu-passthrough-on-qubes-os-with-virtualgl/20265">Seamless GPU passthrough on Qubes OS with VirtualGL</a></p>
<p>You may have issue with how the mouse is handled by the game. AFAIK, no one tried to solve this issue.</p>

<h2><a name="p-86347-xorg-19" href="#p-86347-xorg-19"></a>Xorg</h2>
<p>Now Xorg. From XKCD:</p>
<p><a href="https://xkcd.com/963/"><img src="https://forum.qubes-os.org/uploads/db3820/original/2X/5/5918b857d4cb22183a9fff2cb70d6201b5041048.png" alt="image" title="X11 Satisfaction increases as time since dealing with X11 passes." data-base62-sha1="cIbsmjKaevmY02rfuIRAzaSBghO" width="319" height="261"/></a></p>
<p>Things you need to install:</p>
<ul>
<li>
<p>The Xorg input driver to support your mouse and keyboard</p>
</li>
<li>
<p>Your favorite Windows Manager</p>
</li>
</ul>
<p>In my case, it is:</p>
<p><strong>archlinux version:</strong></p>
<pre data-code-wrap="bash"><code>pacman -S xorg i3
</code></pre>
<p><strong>debian version:</strong></p>
<pre data-code-wrap="bash"><code>apt install xserver-xorg-input-kbd xserver-xorg-input-libinput xserver-xorg-input-mouse i3
</code></pre>
<p>Then create a XORG configuration file for your GPU and screen. My file named ‘xorg.conf’:</p>
<pre><code>Section &#34;ServerLayout&#34;
Identifier &#34;Passthrough Layout&#34;
Screen 0 &#34;Passthrough Screen&#34; Absolute 0 0
EndSection

Section &#34;Device&#34;
Identifier  &#34;Passthrough GPU&#34;
# name of the driver to use. Can be &#34;amdgpu&#34;, &#34;nvidia&#34;, or something else
Driver      &#34;driver&#34;
Option &#34;Coolbits&#34; &#34;4&#34;
# The BusID value will change after each qube reboot. 
BusID       &#34;PCI:0::0&#34;
EndSection

Section &#34;Monitor&#34;
Identifier &#34;Passthrough monitor&#34;
EndSection

Section &#34;Screen&#34;
Identifier &#34;Passthrough Screen&#34;
Device     &#34;Passthrough GPU&#34;
Monitor    &#34;Passthrough Monitor&#34;
EndSection
</code></pre>
<p>We can’t know what is the correct BusID before the qube is started. And it change after each reboot. So let’s write a script — named “xorgX1.sh” — that update this configuration file with the correct value, then start a binary on the Xorg X screen n°1.</p>
<pre data-code-wrap="bash"><code>#!/bin/bash
binary=${1:?binary required}

# Find the correct BusID of the AMD GPU, then set it in the Xorg configuration file
lspci | grep &#34;VGA&#34; | grep -E &#34;NVIDIA&#34; &amp;&amp; sed -i &#39;s/^Driver .*/Driver &#34;nvidia&#34;/g&#39; /opt/xorg.conf
lspci | grep &#34;VGA&#34; | grep -E &#34;AMD/ATI&#34; &amp;&amp; sed -i &#39;s/^Driver .*/Driver &#34;amdgpu&#34;/g&#39; /opt/xorg.conf
pci=$(lspci | grep &#34;VGA&#34; | grep -E &#34;NVIDIA|AMD/ATI&#34; | cut -d &#34; &#34; -f 1 | cut -d &#34;:&#34; -f 2 | cut -d &#34;.&#34; -f 1 | cut -d &#34;0&#34; -f 2)
sed -i &#39;s/&#34;PCI:[^&#34;]*&#34;/&#34;PCI:0:&#39;$pci&#39;:0&#34;/g&#39; /opt/xorg.conf

# Start the Xorg server for the X screen number 1.
# The X screen n__0 is already used for QubesOS integration
sudo startx &#34;$binary&#34; -- :1 -config /opt/xorg.conf
</code></pre>
<details>
<summary>
Deprecated: old way of doing it</summary>
<p>#!/bin/bash</p>
<p>binary=${1:?binary required}</p>

<p>pci=$(lspci | grep “VGA” | grep -E “NVIDIA|AMD/ATI” | cut -d &#34; &#34; -f 1 | cut -d “:” -f 2 | cut -d “.” -f 1 | cut -d “0” -f 2)</p>

<p>sudo killall pulseaudio</p>


<p>sudo startx “$binary” – :1 -config /home/user/AOC.conf</p>
</details>
<h2><a name="p-86347-audio-24" href="#p-86347-audio-24"></a>Audio</h2>
<ul>
<li>Create a script to launch your favorite Windows Manager and force it to use a specific pulse server.</li>
</ul>
<pre><code>#!/bin/bash
sleep 5 &amp;&amp; sudo setxkbmap -display :1 fr &amp; 
/bin/sudo -u user PULSE_SERVER=unix:/run/user/1000/pulse/native bash -c &#39;sudo xhost + local:;/usr/bin/i3&#39;
</code></pre>
<p>And launch it:</p>
<pre data-code-wrap="bash"><code>sudo ./xorgX1.sh ./i3.sh
</code></pre>
<details>
<summary>
Deprecated: old way of doing it</summary>
<ul>
<li>Delete any packages related to pulseaudio and install pipewire</li>
</ul>
<pre><code>sudo pacman -Rdd qubes-vm-pulseaudio pulseaudio
sudo pacman -S pipewire-{jack,alsa,pulse} pipewire-qubes
</code></pre>
<ul>
<li>Enable the “pipewire” service for this qube using Qubes Manager</li>
</ul>
<div><a href="https://forum.qubes-os.org/uploads/db3820/original/2X/c/c17c18f835b7359d4f17e3b13ec088c6d494bba3.png" data-download-href="https://forum.qubes-os.org/uploads/db3820/c17c18f835b7359d4f17e3b13ec088c6d494bba3" title="pipewire"><img src="https://forum.qubes-os.org/uploads/db3820/optimized/2X/c/c17c18f835b7359d4f17e3b13ec088c6d494bba3_2_690x168.png" alt="pipewire" data-base62-sha1="rBE1PzenJrSoiAB3hcvCgSapeCv" width="690" height="168" srcset="https://forum.qubes-os.org/uploads/db3820/optimized/2X/c/c17c18f835b7359d4f17e3b13ec088c6d494bba3_2_690x168.png, https://forum.qubes-os.org/uploads/db3820/original/2X/c/c17c18f835b7359d4f17e3b13ec088c6d494bba3.png 1.5x, https://forum.qubes-os.org/uploads/db3820/original/2X/c/c17c18f835b7359d4f17e3b13ec088c6d494bba3.png 2x" data-dominant-color="F2F3F3"/></a></div>
</details>
<details>
<summary>
Deprecated: old way of doing it2</summary>
<p>So you need to configure pulseaudio for Xorg multiseat. The archlinux documentation explain that very well: <a href="https://wiki.archlinux.org/index.php/Xorg_multiseat#Multiple_users_on_single_sound_card:_PulseAudio">Xorg multiseat</a> Use the option without system-mode deamon and adapt it to qube: Add the following line to /etc/pulse/qubes-default.pa</p>
<pre data-code-wrap="bash"><code>load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1
</code></pre>
<p>Then add this config for root:</p>
<pre data-code-wrap="bash"><code>mkdir /root/.pulse
echo &#34;default-server = 127.0.0.1&#34; &gt; /root/.pulse/client.conf
</code></pre>
<p>The sound was buggy/laggy on my computer. So tried to find a workaround by playing with pulseaudio settings. It was more or less random tries, so I can’t really explain it: In <code>/etc/pulse/daemon.conf</code> add the following lines:</p>
<pre data-code-wrap="bash"><code>default-fragments = 60
default-fragment-size-msec = 1
high-priority = no
realtime-scheduling = no
nice-level = 18
</code></pre>
<p>In <code>/etc/pulse/qubes-default.pa</code>{.text} change</p>
<pre data-code-wrap="bash"><code>load-module module-udev-detect
</code></pre>
<p>to</p>
<pre data-code-wrap="bash"><code>load-module module-udev-detect tsched=0
</code></pre>
<p>You can launch you favorite Windows Manager like that</p>
<pre data-code-wrap="bash"><code>sudo ./xorgX1.sh /usr/bin/i3
</code></pre>
</details>

<p>I trying to write a script to automate all the previous steps.</p>
<p>Please be carefull and read the code, not much tests have been done</p>
<h2><a name="p-86347-issues-and-fixes-26" href="#p-86347-issues-and-fixes-26"></a>Issues and fixes</h2>
<p>In one case in a setup with Intel IGPU + Nvidia DGPU, dom0 xorg crashed.</p>


<h2><a name="p-86347-references-27" href="#p-86347-references-27"></a>References</h2>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/index.php/PulseAudio">Archlinux: PulseAudio</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/index.php/PulseAudio/Troubleshooting">Archlinux: PulseAudio/Troubleshooting</a></p>
</li>
</ul>
<hr/>
<details>
<summary>
This document was migrated from the qubes-community project</summary>
<ul>
<li><a href="https://github.com/Qubes-Community/Contents/blob/master/docs/customization/gaming-hvm.md">Page archive</a></li>
<li>First commit: 18 Jan 2023. Last commit: 18 Jan 2023.</li>
<li>Applicable Qubes OS releases based on commit dates and <a href="https://www.qubes-os.org/doc/supported-releases/">supported releases</a>: 4.1</li>
<li>Original author(s) (GitHub usernames): neowutran</li>
<li>Original author(s) (forum usernames): <a href="https://forum.qubes-os.org/u/neowutran">@neowutran</a></li>
<li>Document license: <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></li>
</ul>
</details>
<details>
<summary>
Contributors</summary>
<ul>
<li><a href="https://forum.qubes-os.org/u/neowutran">@neowutran</a></li>
<li><a href="https://forum.qubes-os.org/u/deeplow">@deeplow</a></li>
<li><a href="https://forum.qubes-os.org/u/xvrhthxn">@xvrhthxn</a></li>
</ul>
</details>

            </div></div>
  </body>
</html>
