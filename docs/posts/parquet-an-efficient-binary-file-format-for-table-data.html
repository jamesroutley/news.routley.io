<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://csvbase.com/blog/3">Original</a>
    <h1>Parquet: An efficient, binary file format for table data</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <!-- Parquet: aka "Turbo CSV" -->
<p><a href="https://en.wikipedia.org/wiki/Apache_Parquet">Parquet</a> is an efficient, binary
file format for table data.  Compared to csv, it is:</p>
<ol>
<li>Quicker to read</li>
<li>Quicker to write</li>
<li>Smaller</li>
</ol>
<p>On a real world 10 million row financial data table I just tested with pandas I
found that Parquet is about <strong>7.5 times quicker to read</strong> than csv, <strong>~10 times
quicker to write</strong> and a about <strong>a fifth of the size</strong> on disk.  So way to
think of Parquet is as &#34;turbo csv&#34; - like csv, just faster (and smaller).</p>
<p>That&#39;s not all there is to Parquet though.  Although Parquet was originally
designed for Big Data, it also has benefits for <em>small</em> data.</p>
<h2>Scaling down</h2>
<p>One of the main advantages of Parquet is the format has an explicit schema that
is embedded <em>within</em> the file - and that schema includes type information.</p>
<p>So unlike with csv, readers don&#39;t need to infer the types of the columns by
scanning the data itself.  Inferring types via scanning is fragile and a common
source of data bugs.  It&#39;s not uncommon for the values for a column to begin
looking like ints only for later in the file to change into freeform text
strings.  When exchanging data, it&#39;s better to be explicit.</p>
<p>The representation of types is also standardised - there is only one way to
represent a boolean - unlike the <code>YES</code>, <code>y</code>, <code>TRUE</code>, <code>1</code>, <code>[x]</code> and so on of
csv files - which all need to be recognised and handled on a per feed basis.
Date/time string parsing is also eliminated: Parquet has both a date type and
the datetime type (both sensibly recorded as integers in UTC).</p>
<p>Parquet also does away with character encoding confusion - a huge practical
problem with textual file formats like csv.  Early on, <a href="https://en.wikipedia.org/wiki/Tower_of_Babel">God cursed
humanity</a> with multiple
languages. The early programmers cursed computers too: there are numerous ways
to represent characters as bytes.  Different tools use different
encodings - <a href="https://en.wikipedia.org/wiki/UTF-8">UTF-8</a>,
<a href="https://en.wikipedia.org/wiki/UTF-16">UTF-16</a>, UTF-16 with the bytes the wrong
way round, <a href="https://en.wikipedia.org/wiki/Windows-1252">Win-1252</a>,
<a href="https://en.wikipedia.org/wiki/ASCII">ASCII</a> (but something else on days when
the feed needs to include a non-ASCII character) - the list goes on.</p>
<p>More sophisticated programs <a href="https://github.com/chardet/chardet">apply statistics to the byte patterns in the early
parts of the file</a> to try to guess what the
character encoding might be - but again, it&#39;s fragile. And if you guess wrong -
the result is <a href="https://en.wikipedia.org/wiki/Mojibake">garbled nonsense</a>.</p>
<p>And finally, Parquet provides a single way to represent missing data - the
<code>null</code> type.  It&#39;s easy to tell &#34;null&#34; apart from <code>&#34;&#34;</code>, for
example.  And the fact that there is an official way to represent null (mostly)
eliminates the need to infer that certain special strings (eg <code>N/A</code>) actually
mean <code>null</code>.</p>
<h2>Column — and row — oriented</h2>
<p>How does Parquet work then?  Parquet is partly row oriented and partly column
oriented.  The data going into a Parquet file is broken up into &#34;row chunks&#34; -
largeish sets of rows.  Inside a row chunk each column is stored separately in
a &#34;column chunk&#34; - this best facilitates all the tricks to make the data
smaller.  Compression works better when similar data is adjacent.  Run-length
encoding is possible.  So is delta encoding.</p>
<p>Here&#39;s a diagram:</p>
<p><img src="https://csvbase.com/blog-static/parquet.svg" alt="diagram of a parquet file on disk"/></p>
<p>At the end of the file is the index, which contains references to all the other
row chunks, column chunks, etc.</p>
<p>That&#39;s actually one of the few downsides of Parquet - because the index is at
the end of the file you can&#39;t stream it.  A lot of programs that process csv
files stream through them to allow them to handle csv files that are larger
than memory.  Not possible with Parquet.</p>
<p>Instead, with Parquet, you tend to <em>split</em> your data across multiple files
(there is explicit support for this in the format) and then use the indexes to
skip around to find the data you want.  But again - that requires random
access - no streaming.</p>
<h2>Trying it out</h2>
<p>You can add <code>.parquet</code> to any csvbase table url to get a Parquet file, so
that&#39;s an easy way to try the format out:</p>
<div><pre><span></span><span>import</span> <span>pandas</span> <span>as</span> <span>pd</span>
<span>df</span> <span>=</span> <span>pd</span><span>.</span><span>read_parquet</span><span>(</span><span>&#34;https://csvbase.com/meripaterson/stock-exchanges.parquet&#34;</span><span>)</span>
</pre></div>
<p><img src="https://csvbase.com/blog-static/stock-exchanges-term.png" alt="screenshot of a csvbase table in pandas"/></p>
<p>If you want to see the gory details of the format, try the <code>parquet-tools</code>
package <a href="https://pypi.org/project/parquet-tools/">on PyPI</a> with a sample file:</p>
<div><pre><span></span>pip install -U parquet-tools
curl -O <span>&#34;https://csvbase.com/meripaterson/stock-exchanges.parquet&#34;</span>
parquet-tools inspect --detail stock-exchanges.parquet
</pre></div>
<p>That shows a lot of detail and in conjunction with <a href="https://parquet.apache.org/docs/">the
spec</a> can help you understand exactly
how the format is arranged.</p>
<p><img src="https://csvbase.com/blog-static/parquet-tools.png" alt="screenshot of parquet-tools output"/></p>
<h2>Keep in touch</h2>
<p>Please do <a href="mailto:cal@calpaterson.com">send me an email</a> about this article,
especially if you disagreed with it.</p>
<p>I am also on Mastodon:
<a href="https://fosstodon.org/@calpaterson">@calpaterson@fosstodon.org</a>.</p>
<p>If you liked this, you might like other things I&#39;ve written: on <a href="https://csvbase.com/blog">the csvbase
blog</a>, or on <a href="https://calpaterson.com/">my blog</a>.</p>
<p>Follow new posts <a href="https://csvbase.com/blog/posts.rss">via RSS</a>.</p>

      </div>
    </div></div>
  </body>
</html>
