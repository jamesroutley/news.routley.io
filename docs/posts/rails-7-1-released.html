<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/rails/rails/releases/tag/v7.1.0">Original</a>
    <h1>Rails 7.1 Released</h1>
    
    <div id="readability-page-1" class="page"><div>
<li>
<p>Fix <code>AS::MessagePack</code> with <code>ENV[&#34;RAILS_MAX_THREADS&#34;]</code>.</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Add a new public API for broadcasting logs</p>
<p>This feature existed for a while but was until now a private API.</p>
<p>Basic usage:</p>
<div data-snippet-clipboard-copy-content="stdout_logger = Logger.new(STDOUT)
file_logger = Logger.new(&#34;development.log&#34;)
broadcast = ActiveSupport::BroadcastLogger.new(stdout_logger, file_logger)

broadcast.info(&#34;Hello!&#34;) # The &#34;Hello!&#34; message is written on STDOUT and in the log file."><pre><span>stdout_logger</span> <span>=</span> <span>Logger</span><span>.</span><span>new</span><span>(</span><span>STDOUT</span><span>)</span>
<span>file_logger</span> <span>=</span> <span>Logger</span><span>.</span><span>new</span><span>(</span><span>&#34;development.log&#34;</span><span>)</span>
<span>broadcast</span> <span>=</span> <span>ActiveSupport</span>::<span>BroadcastLogger</span><span>.</span><span>new</span><span>(</span><span>stdout_logger</span><span>,</span> <span>file_logger</span><span>)</span>

<span>broadcast</span><span>.</span><span>info</span><span>(</span><span>&#34;Hello!&#34;</span><span>)</span> <span># The &#34;Hello!&#34; message is written on STDOUT and in the log file.</span></pre></div>
<p>Adding other sink(s) to the broadcast:</p>
<div data-snippet-clipboard-copy-content="broadcast = ActiveSupport::BroadcastLogger.new
broadcast.broadcast_to(Logger.new(STDERR))"><pre><span>broadcast</span> <span>=</span> <span>ActiveSupport</span>::<span>BroadcastLogger</span><span>.</span><span>new</span>
<span>broadcast</span><span>.</span><span>broadcast_to</span><span>(</span><span>Logger</span><span>.</span><span>new</span><span>(</span><span>STDERR</span><span>)</span><span>)</span></pre></div>
<p>Remove a sink from the broadcast:</p>
<div data-snippet-clipboard-copy-content="stdout_logger = Logger.new(STDOUT)
broadcast = ActiveSupport::BroadcastLogger.new(stdout_logger)

broadcast.stop_broadcasting_to(stdout_logger)"><pre><span>stdout_logger</span> <span>=</span> <span>Logger</span><span>.</span><span>new</span><span>(</span><span>STDOUT</span><span>)</span>
<span>broadcast</span> <span>=</span> <span>ActiveSupport</span>::<span>BroadcastLogger</span><span>.</span><span>new</span><span>(</span><span>stdout_logger</span><span>)</span>

<span>broadcast</span><span>.</span><span>stop_broadcasting_to</span><span>(</span><span>stdout_logger</span><span>)</span></pre></div>
<p><em>Edouard Chin</em></p>
</li>
<li>
<p>Fix Range#overlap? not taking empty ranges into account on Ruby &lt; 3.3</p>
<p><em>Nobuyoshi Nakada</em>, <em>Shouichi Kamiya</em>, <em>Hartley McGuire</em></p>
</li>
<li>
<p>Use Ruby 3.3 Range#overlap? if available</p>
<p><em>Yasuo Honda</em></p>
</li>
<li>
<p>Add <code>bigdecimal</code> as Active Support dependency that is a bundled gem candidate for Ruby 3.4.</p>
<p><code>bigdecimal</code> 3.1.4 or higher version will be installed.</p>
<p><em>Koichi ITO</em></p>
</li>
<li>
<p>Add <code>drb</code>, <code>mutex_m</code> and <code>base64</code> that are bundled gem candidates for Ruby 3.4</p>
<p><em>Yasuo Honda</em></p>
</li>
<li>
<p>When using cache format version &gt;= 7.1 or a custom serializer, expired and</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Make all cache stores return a boolean for <code>#delete</code></p>
<p>Previously the <code>RedisCacheStore#delete</code> would return <code>1</code> if the entry</p>
<p>The <code>FileStore</code> would return <code>nil</code> if the entry doesn&#39;t exists and returns</p>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p>Active Support cache stores now support replacing the default compressor via</p>
<div data-snippet-clipboard-copy-content="module MyCompressor
  def self.deflate(string)
    # compression logic...
  end

  def self.inflate(compressed)
    # decompression logic...
  end
end

config.cache_store = :redis_cache_store, { compressor: MyCompressor }"><pre><span>module</span> <span>MyCompressor</span>
  <span>def</span> <span>self</span><span>.</span><span>deflate</span><span>(</span><span>string</span><span>)</span>
    <span># compression logic...</span>
  <span>end</span>

  <span>def</span> <span>self</span><span>.</span><span>inflate</span><span>(</span><span>compressed</span><span>)</span>
    <span># decompression logic...</span>
  <span>end</span>
<span>end</span>

<span>config</span><span>.</span><span>cache_store</span> <span>=</span> <span>:redis_cache_store</span><span>,</span> <span>{</span> <span>compressor</span>: <span>MyCompressor</span> <span>}</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Active Support cache stores now support a <code>:serializer</code> option. Similar to</p>
<p>Specifying a serializer instead of a coder also enables performance</p>
<p>The <code>:serializer</code> and <code>:coder</code> options are mutually exclusive. Specifying</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Fix <code>ActiveSupport::Inflector.humanize(nil)</code> raising <code>NoMethodError: undefined method `end_with?&#39; for nil:NilClass</code>.</p>
<p><em>James Robinson</em></p>
</li>
<li>
<p>Don&#39;t show secrets for <code>ActiveSupport::KeyGenerator#inspect</code>.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="ActiveSupport::KeyGenerator.new(secret).inspect
&#34;#&lt;ActiveSupport::KeyGenerator:0x0000000104888038 ... @secret=\&#34;\\xAF\\bFh]LV}q\\nl\\xB2U\\xB3 ... &gt;&#34;"><pre><span>ActiveSupport</span>::<span>KeyGenerator</span><span>.</span><span>new</span><span>(</span><span>secret</span><span>)</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveSupport::KeyGenerator:0x0000000104888038 ... @secret=<span>\&#34;</span><span>\\</span>xAF<span>\\</span>bFh]LV}q<span>\\</span>nl<span>\\</span>xB2U<span>\\</span>xB3 ... &gt;&#34;</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="ActiveSupport::KeyGenerator::Aes256Gcm(secret).inspect
&#34;#&lt;ActiveSupport::KeyGenerator:0x0000000104888038&gt;&#34;"><pre><span>ActiveSupport</span>::<span>KeyGenerator</span>::<span>Aes256Gcm</span><span>(</span><span>secret</span><span>)</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveSupport::KeyGenerator:0x0000000104888038&gt;&#34;</span></pre></div>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p>Improve error message when EventedFileUpdateChecker is used without a</p>
<p><em>Hartley McGuire</em></p>
</li>
<li>
<p>Add <code>:report</code> behavior for Deprecation</p>
<p>Setting <code>config.active_support.deprecation = :report</code> uses the error</p>
<p>Deprecations are reported as handled errors, with a severity of <code>:warning</code>.</p>
<p>Useful to report deprecations happening in production to your bug tracker.</p>
<p><em>Étienne Barrié</em></p>
</li>
<li>
<p>Rename <code>Range#overlaps?</code> to <code>#overlap?</code> and add alias for backwards compatibility</p>
<p><em>Christian Schmidt</em></p>
</li>
<li>
<p>Fix <code>EncryptedConfiguration</code> returning incorrect values for some <code>Hash</code></p>
<p><em>Hartley McGuire</em></p>
</li>
<li>
<p>Don&#39;t show secrets for <code>MessageEncryptor#inspect</code>.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="ActiveSupport::MessageEncryptor.new(secret, cipher: &#34;aes-256-gcm&#34;).inspect
&#34;#&lt;ActiveSupport::MessageEncryptor:0x0000000104888038 ... @secret=\&#34;\\xAF\\bFh]LV}q\\nl\\xB2U\\xB3 ... &gt;&#34;"><pre><span>ActiveSupport</span>::<span>MessageEncryptor</span><span>.</span><span>new</span><span>(</span><span>secret</span><span>,</span> <span>cipher</span>: <span>&#34;aes-256-gcm&#34;</span><span>)</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveSupport::MessageEncryptor:0x0000000104888038 ... @secret=<span>\&#34;</span><span>\\</span>xAF<span>\\</span>bFh]LV}q<span>\\</span>nl<span>\\</span>xB2U<span>\\</span>xB3 ... &gt;&#34;</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="ActiveSupport::MessageEncryptor.new(secret, cipher: &#34;aes-256-gcm&#34;).inspect
&#34;#&lt;ActiveSupport::MessageEncryptor:0x0000000104888038&gt;&#34;"><pre><span>ActiveSupport</span>::<span>MessageEncryptor</span><span>.</span><span>new</span><span>(</span><span>secret</span><span>,</span> <span>cipher</span>: <span>&#34;aes-256-gcm&#34;</span><span>)</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveSupport::MessageEncryptor:0x0000000104888038&gt;&#34;</span></pre></div>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p>Don&#39;t show contents for <code>EncryptedConfiguration#inspect</code>.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="Rails.application.credentials.inspect
&#34;#&lt;ActiveSupport::EncryptedConfiguration:0x000000010d2b38e8 ... @config={:secret=&gt;\&#34;something secret\&#34;} ... @key_file_contents=\&#34;915e4ea054e011022398dc242\&#34; ...&gt;&#34;"><pre><span>Rails</span><span>.</span><span>application</span><span>.</span><span>credentials</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveSupport::EncryptedConfiguration:0x000000010d2b38e8 ... @config={:secret=&gt;<span>\&#34;</span>something secret<span>\&#34;</span>} ... @key_file_contents=<span>\&#34;</span>915e4ea054e011022398dc242<span>\&#34;</span> ...&gt;&#34;</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="Rails.application.credentials.inspect
&#34;#&lt;ActiveSupport::EncryptedConfiguration:0x000000010d2b38e8&gt;&#34;"><pre><span>Rails</span><span>.</span><span>application</span><span>.</span><span>credentials</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveSupport::EncryptedConfiguration:0x000000010d2b38e8&gt;&#34;</span></pre></div>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p><code>ERB::Util.html_escape_once</code> always returns an <code>html_safe</code> string.</p>
<p>This method previously maintained the <code>html_safe?</code> property of a string on the return</p>
<p>As an example, take this view snippet:</p>
<div data-snippet-clipboard-copy-content="&lt;p&gt;&lt;%= html_escape_once(&#34;this &amp; that &amp;amp; the other&#34;) %&gt;&lt;/p&gt;"><pre><span>&lt;</span><span>p</span><span>&gt;</span><span>&lt;</span>%= html_escape_once(&#34;this &amp; that &amp;amp; the other&#34;) %<span>&gt;</span><span>&lt;/</span><span>p</span><span>&gt;</span></pre></div>
<p>Before this change, that would be double-escaped and render as:</p>
<div data-snippet-clipboard-copy-content="&lt;p&gt;this &amp;amp;amp; that &amp;amp;amp; the other&lt;/p&gt;"><pre><span>&lt;</span><span>p</span><span>&gt;</span>this &amp;amp;amp; that &amp;amp;amp; the other<span>&lt;/</span><span>p</span><span>&gt;</span></pre></div>
<p>After this change, it renders correctly as:</p>
<div data-snippet-clipboard-copy-content="&lt;p&gt;this &amp;amp; that &amp;amp; the other&lt;/p&gt;"><pre><span>&lt;</span><span>p</span><span>&gt;</span>this &amp;amp; that &amp;amp; the other<span>&lt;/</span><span>p</span><span>&gt;</span></pre></div>
<p>Fixes <a data-error-text="Failed to load title" data-id="1717796292" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/48256" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/48256/hovercard" href="https://github.com/rails/rails/issues/48256">#48256</a></p>
<p><em>Mike Dalessio</em></p>
</li>
<li>
<p>Deprecate <code>SafeBuffer#clone_empty</code>.</p>
<p>This method has not been used internally since Rails 4.2.0.</p>
<p><em>Mike Dalessio</em></p>
</li>
<li>
<p><code>MessageEncryptor</code>, <code>MessageVerifier</code>, and <code>config.active_support.message_serializer</code></p>
<p>The Message Pack format can provide improved performance and smaller payload</p>
<div data-snippet-clipboard-copy-content="verifier = ActiveSupport::MessageVerifier.new(&#34;secret&#34;)
data = [{ a: 1 }, { b: 2 }.with_indifferent_access, 1.to_d, Time.at(0, 123)]
message = verifier.generate(data)

# BEFORE with config.active_support.message_serializer = :json
verifier.verified(message)
# =&gt; [{&#34;a&#34;=&gt;1}, {&#34;b&#34;=&gt;2}, &#34;1.0&#34;, &#34;1969-12-31T18:00:00.000-06:00&#34;]
verifier.verified(message).map(&amp;:class)
# =&gt; [Hash, Hash, String, String]

# AFTER with config.active_support.message_serializer = :message_pack
verifier.verified(message)
# =&gt; [{:a=&gt;1}, {&#34;b&#34;=&gt;2}, 0.1e1, 1969-12-31 18:00:00.000123 -0600]
verifier.verified(message).map(&amp;:class)
# =&gt; [Hash, ActiveSupport::HashWithIndifferentAccess, BigDecimal, Time]"><pre><span>verifier</span> <span>=</span> <span>ActiveSupport</span>::<span>MessageVerifier</span><span>.</span><span>new</span><span>(</span><span>&#34;secret&#34;</span><span>)</span>
<span>data</span> <span>=</span> <span>[</span><span>{</span> <span>a</span>: <span>1</span> <span>}</span><span>,</span> <span>{</span> <span>b</span>: <span>2</span> <span>}</span><span>.</span><span>with_indifferent_access</span><span>,</span> <span>1</span><span>.</span><span>to_d</span><span>,</span> <span>Time</span><span>.</span><span>at</span><span>(</span><span>0</span><span>,</span> <span>123</span><span>)</span><span>]</span>
<span>message</span> <span>=</span> <span>verifier</span><span>.</span><span>generate</span><span>(</span><span>data</span><span>)</span>

<span># BEFORE with config.active_support.message_serializer = :json</span>
<span>verifier</span><span>.</span><span>verified</span><span>(</span><span>message</span><span>)</span>
<span># =&gt; [{&#34;a&#34;=&gt;1}, {&#34;b&#34;=&gt;2}, &#34;1.0&#34;, &#34;1969-12-31T18:00:00.000-06:00&#34;]</span>
<span>verifier</span><span>.</span><span>verified</span><span>(</span><span>message</span><span>)</span><span>.</span><span>map</span><span>(</span>&amp;<span>:class</span><span>)</span>
<span># =&gt; [Hash, Hash, String, String]</span>

<span># AFTER with config.active_support.message_serializer = :message_pack</span>
<span>verifier</span><span>.</span><span>verified</span><span>(</span><span>message</span><span>)</span>
<span># =&gt; [{:a=&gt;1}, {&#34;b&#34;=&gt;2}, 0.1e1, 1969-12-31 18:00:00.000123 -0600]</span>
<span>verifier</span><span>.</span><span>verified</span><span>(</span><span>message</span><span>)</span><span>.</span><span>map</span><span>(</span>&amp;<span>:class</span><span>)</span>
<span># =&gt; [Hash, ActiveSupport::HashWithIndifferentAccess, BigDecimal, Time]</span></pre></div>
<p>The <code>:message_pack</code> serializer can fall back to deserializing with</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>A new <code>7.1</code> cache format is available which includes an optimization for</p>
<p>The <code>7.1</code> cache format is used by default for new apps, and existing apps</p>
<p>Cache entries written using the <code>6.1</code> or <code>7.0</code> cache formats can be read</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Active Support cache stores can now use a preconfigured serializer based on</p>
<div data-snippet-clipboard-copy-content="config.cache_store = :redis_cache_store, { serializer: :message_pack }"><pre><span>config</span><span>.</span><span>cache_store</span> <span>=</span> <span>:redis_cache_store</span><span>,</span> <span>{</span> <span>serializer</span>: <span>:message_pack</span> <span>}</span></pre></div>
<p>The <code>:message_pack</code> serializer can reduce cache entry sizes and improve</p>
<p>The <code>:message_pack</code> serializer can read cache entries written by the default</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p><code>Object#deep_dup</code> no longer duplicate named classes and modules.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="hash = { class: Object, module: Kernel }
hash.deep_dup # =&gt; {:class=&gt;#&lt;Class:0x00000001063ffc80&gt;, :module=&gt;#&lt;Module:0x00000001063ffa00&gt;}"><pre><span>hash</span> <span>=</span> <span>{</span> <span>class</span>: <span>Object</span><span>,</span> <span>module</span>: <span>Kernel</span> <span>}</span>
<span>hash</span><span>.</span><span>deep_dup</span> <span># =&gt; {:class=&gt;#&lt;Class:0x00000001063ffc80&gt;, :module=&gt;#&lt;Module:0x00000001063ffa00&gt;}</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="hash = { class: Object, module: Kernel }
hash.deep_dup # =&gt; {:class=&gt;Object, :module=&gt;Kernel}"><pre><span>hash</span> <span>=</span> <span>{</span> <span>class</span>: <span>Object</span><span>,</span> <span>module</span>: <span>Kernel</span> <span>}</span>
<span>hash</span><span>.</span><span>deep_dup</span> <span># =&gt; {:class=&gt;Object, :module=&gt;Kernel}</span></pre></div>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Consistently raise an <code>ArgumentError</code> if the <code>ActiveSupport::Cache</code> key is blank.</p>
<p><em>Joshua Young</em></p>
</li>
<li>
<p>Deprecate usage of the singleton <code>ActiveSupport::Deprecation</code>.</p>
<p>All usage of <code>ActiveSupport::Deprecation</code> as a singleton is deprecated, the most common one being</p>
<p>Calling any of the following without specifying a deprecator argument is also deprecated:</p>
<ul>
<li>Module.deprecate</li>
<li>deprecate_constant</li>
<li>DeprecatedObjectProxy</li>
<li>DeprecatedInstanceVariableProxy</li>
<li>DeprecatedConstantProxy</li>
<li>deprecation-related test assertions</li>
</ul>
<p>Use of <code>ActiveSupport::Deprecation.silence</code> and configuration methods like <code>behavior=</code>, <code>disallowed_behavior=</code>,</p>
<div data-snippet-clipboard-copy-content="Rails.application.deprecators.silence do
  # code that emits deprecation warnings
end"><pre><span>Rails</span><span>.</span><span>application</span><span>.</span><span>deprecators</span><span>.</span><span>silence</span> <span>do</span>
  <span># code that emits deprecation warnings</span>
<span>end</span></pre></div>
<p>If your gem has a Railtie or Engine, it&#39;s encouraged to add your deprecator to the application&#39;s deprecators, that</p>
<div data-snippet-clipboard-copy-content="initializer &#34;my_gem.deprecator&#34; do |app|
  app.deprecators[:my_gem] = MyGem.deprecator
end"><pre><span>initializer</span> <span>&#34;my_gem.deprecator&#34;</span> <span>do</span> |<span>app</span>|
  <span>app</span><span>.</span><span>deprecators</span><span>[</span><span>:my_gem</span><span>]</span> <span>=</span> <span>MyGem</span><span>.</span><span>deprecator</span>
<span>end</span></pre></div>
<p><em>Étienne Barrié</em></p>
</li>
<li>
<p>Add <code>Object#with</code> to set and restore public attributes around a block</p>
<div data-snippet-clipboard-copy-content="client.timeout # =&gt; 5
client.with(timeout: 1) do
  client.timeout # =&gt; 1
end
client.timeout # =&gt; 5"><pre><span>client</span><span>.</span><span>timeout</span> <span># =&gt; 5</span>
<span>client</span><span>.</span><span>with</span><span>(</span><span>timeout</span>: <span>1</span><span>)</span> <span>do</span>
  <span>client</span><span>.</span><span>timeout</span> <span># =&gt; 1</span>
<span>end</span>
<span>client</span><span>.</span><span>timeout</span> <span># =&gt; 5</span></pre></div>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Remove deprecated support to generate incorrect RFC 4122 UUIDs when providing a namespace ID that is not one of the</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Deprecate <code>config.active_support.use_rfc4122_namespaced_uuids</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove implicit conversion of objects into <code>String</code> by <code>ActiveSupport::SafeBuffer</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated <code>active_support/core_ext/range/include_time_with_zone</code> file.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Deprecate <code>config.active_support.remove_deprecated_time_with_zone_name</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated override of <code>ActiveSupport::TimeWithZone.name</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Deprecate <code>config.active_support.disable_to_s_conversion</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated option to passing a format to <code>#to_s</code> in <code>Array</code>, <code>Range</code>, <code>Date</code>, <code>DateTime</code>, <code>Time</code>,</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated <code>ActiveSupport::PerThreadRegistry</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated override of <code>Enumerable#sum</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Deprecated initializing a <code>ActiveSupport::Cache::MemCacheStore</code> with an instance of <code>Dalli::Client</code>.</p>
<p>Deprecate the undocumented option of providing an already-initialized instance of <code>Dalli::Client</code> to <code>ActiveSupport::Cache::MemCacheStore</code>. Such clients could be configured with unrecognized options, which could lead to unexpected behavior. Instead, provide addresses as documented.</p>
<p><em>aledustet</em></p>
</li>
<li>
<p>Stub <code>Time.new()</code> in <code>TimeHelpers#travel_to</code></p>
<div data-snippet-clipboard-copy-content="travel_to Time.new(2004, 11, 24) do
  # Inside the `travel_to` block `Time.new` is stubbed
  assert_equal 2004, Time.new.year
end"><pre><span>travel_to</span> <span>Time</span><span>.</span><span>new</span><span>(</span><span>2004</span><span>,</span> <span>11</span><span>,</span> <span>24</span><span>)</span> <span>do</span>
  <span># Inside the `travel_to` block `Time.new` is stubbed</span>
  <span>assert_equal</span> <span>2004</span><span>,</span> <span>Time</span><span>.</span><span>new</span><span>.</span><span>year</span>
<span>end</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Raise <code>ActiveSupport::MessageEncryptor::InvalidMessage</code> from</p>
<div data-snippet-clipboard-copy-content="encryptor = ActiveSupport::MessageEncryptor.new(&#34;x&#34; * 32, cipher: &#34;aes-256-gcm&#34;)
message = encryptor.encrypt_and_sign(&#34;message&#34;)
encryptor.decrypt_and_verify(message.next)
# =&gt; raises ActiveSupport::MessageEncryptor::InvalidMessage

encryptor = ActiveSupport::MessageEncryptor.new(&#34;x&#34; * 32, cipher: &#34;aes-256-cbc&#34;)
message = encryptor.encrypt_and_sign(&#34;message&#34;)
encryptor.decrypt_and_verify(message.next)
# BEFORE:
# =&gt; raises ActiveSupport::MessageVerifier::InvalidSignature
# AFTER:
# =&gt; raises ActiveSupport::MessageEncryptor::InvalidMessage"><pre><span>encryptor</span> <span>=</span> <span>ActiveSupport</span>::<span>MessageEncryptor</span><span>.</span><span>new</span><span>(</span><span>&#34;x&#34;</span> * <span>32</span><span>,</span> <span>cipher</span>: <span>&#34;aes-256-gcm&#34;</span><span>)</span>
<span>message</span> <span>=</span> <span>encryptor</span><span>.</span><span>encrypt_and_sign</span><span>(</span><span>&#34;message&#34;</span><span>)</span>
<span>encryptor</span><span>.</span><span>decrypt_and_verify</span><span>(</span><span>message</span><span>.</span><span>next</span><span>)</span>
<span># =&gt; raises ActiveSupport::MessageEncryptor::InvalidMessage</span>

<span>encryptor</span> <span>=</span> <span>ActiveSupport</span>::<span>MessageEncryptor</span><span>.</span><span>new</span><span>(</span><span>&#34;x&#34;</span> * <span>32</span><span>,</span> <span>cipher</span>: <span>&#34;aes-256-cbc&#34;</span><span>)</span>
<span>message</span> <span>=</span> <span>encryptor</span><span>.</span><span>encrypt_and_sign</span><span>(</span><span>&#34;message&#34;</span><span>)</span>
<span>encryptor</span><span>.</span><span>decrypt_and_verify</span><span>(</span><span>message</span><span>.</span><span>next</span><span>)</span>
<span># BEFORE:</span>
<span># =&gt; raises ActiveSupport::MessageVerifier::InvalidSignature</span>
<span># AFTER:</span>
<span># =&gt; raises ActiveSupport::MessageEncryptor::InvalidMessage</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Support <code>nil</code> original values when using <code>ActiveSupport::MessageVerifier#verify</code>.</p>
<div data-snippet-clipboard-copy-content="encryptor = ActiveSupport::MessageEncryptor.new(secret)
message = encryptor.encrypt_and_sign(nil)

encryptor.decrypt_and_verify(message)
# =&gt; nil

verifier = ActiveSupport::MessageVerifier.new(secret)
message = verifier.generate(nil)

verifier.verified(message)
# =&gt; nil

verifier.verify(message)
# BEFORE:
# =&gt; raises ActiveSupport::MessageVerifier::InvalidSignature
# AFTER:
# =&gt; nil"><pre><span>encryptor</span> <span>=</span> <span>ActiveSupport</span>::<span>MessageEncryptor</span><span>.</span><span>new</span><span>(</span><span>secret</span><span>)</span>
<span>message</span> <span>=</span> <span>encryptor</span><span>.</span><span>encrypt_and_sign</span><span>(</span><span>nil</span><span>)</span>

<span>encryptor</span><span>.</span><span>decrypt_and_verify</span><span>(</span><span>message</span><span>)</span>
<span># =&gt; nil</span>

<span>verifier</span> <span>=</span> <span>ActiveSupport</span>::<span>MessageVerifier</span><span>.</span><span>new</span><span>(</span><span>secret</span><span>)</span>
<span>message</span> <span>=</span> <span>verifier</span><span>.</span><span>generate</span><span>(</span><span>nil</span><span>)</span>

<span>verifier</span><span>.</span><span>verified</span><span>(</span><span>message</span><span>)</span>
<span># =&gt; nil</span>

<span>verifier</span><span>.</span><span>verify</span><span>(</span><span>message</span><span>)</span>
<span># BEFORE:</span>
<span># =&gt; raises ActiveSupport::MessageVerifier::InvalidSignature</span>
<span># AFTER:</span>
<span># =&gt; nil</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Maintain <code>html_safe?</code> on html_safe strings when sliced with <code>slice</code>, <code>slice!</code>, or <code>chr</code> method.</p>
<p>Previously, <code>html_safe?</code> was only maintained when the html_safe strings were sliced</p>
<div data-snippet-clipboard-copy-content="string = &#34;&lt;div&gt;test&lt;/div&gt;&#34;.html_safe
string.slice(0, 1).html_safe? # =&gt; true
string.slice!(0, 1).html_safe? # =&gt; true
# maintain html_safe? after the slice!
string.html_safe? # =&gt; true
string.chr.html_safe? # =&gt; true"><pre><span>string</span> <span>=</span> <span>&#34;&lt;div&gt;test&lt;/div&gt;&#34;</span><span>.</span><span>html_safe</span>
<span>string</span><span>.</span><span>slice</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>)</span><span>.</span><span>html_safe?</span> <span># =&gt; true</span>
<span>string</span><span>.</span><span>slice!</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>)</span><span>.</span><span>html_safe?</span> <span># =&gt; true</span>
<span># maintain html_safe? after the slice!</span>
<span>string</span><span>.</span><span>html_safe?</span> <span># =&gt; true</span>
<span>string</span><span>.</span><span>chr</span><span>.</span><span>html_safe?</span> <span># =&gt; true</span></pre></div>
<p><em>Michael Go</em></p>
</li>
<li>
<p>Add <code>Object#in?</code> support for open ranges.</p>
<div data-snippet-clipboard-copy-content="assert Date.today.in?(..Date.tomorrow)
assert_not Date.today.in?(Date.tomorrow..)"><pre><span>assert</span> <span>Date</span><span>.</span><span>today</span><span>.</span><span>in?</span><span>(</span>..<span>Date</span><span>.</span><span>tomorrow</span><span>)</span>
<span>assert_not</span> <span>Date</span><span>.</span><span>today</span><span>.</span><span>in?</span><span>(</span><span>Date</span><span>.</span><span>tomorrow</span>..<span>)</span></pre></div>
<p><em>Ignacio Galindo</em></p>
</li>
<li>
<p><code>config.i18n.raise_on_missing_translations = true</code> now raises on any missing translation.</p>
<p>Previously it would only raise when called in a view or controller. Now it will raise</p>
<p>If you do not want this behaviour, you can customise the i18n exception handler. See the</p>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p><code>ActiveSupport::CurrentAttributes</code> now raises if a restricted attribute name is used.</p>
<p>Attributes such as <code>set</code> and <code>reset</code> cannot be used as they clash with the</p>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p><code>HashWithIndifferentAccess#transform_keys</code> now takes a Hash argument, just</p>
<p><em>Akira Matsuda</em></p>
</li>
<li>
<p><code>delegate</code> now defines method with proper arity when delegating to a Class.</p>
<div data-snippet-clipboard-copy-content="# This defines 3.5 times faster method than before
class C
  def self.x() end
  delegate :x, to: :class
end

class C
  # This works but silently falls back to old behavior because
  # `delegate` cannot find the definition of `x`
  delegate :x, to: :class
  def self.x() end
end"><pre><span># This defines 3.5 times faster method than before</span>
<span>class</span> <span>C</span>
  <span>def</span> <span>self</span><span>.</span><span>x</span><span>(</span><span>)</span> <span>end</span>
  <span>delegate</span> <span>:x</span><span>,</span> <span>to</span>: <span>:class</span>
<span>end</span>

<span>class</span> <span>C</span>
  <span># This works but silently falls back to old behavior because</span>
  <span># `delegate` cannot find the definition of `x`</span>
  <span>delegate</span> <span>:x</span><span>,</span> <span>to</span>: <span>:class</span>
  <span>def</span> <span>self</span><span>.</span><span>x</span><span>(</span><span>)</span> <span>end</span>
<span>end</span></pre></div>
<p><em>Akira Matsuda</em></p>
</li>
<li>
<p><code>assert_difference</code> message now includes what changed.</p>
<p>This makes it easier to debug non-obvious failures.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="&#34;User.count&#34; didn&#39;t change by 32.
Expected: 1611
  Actual: 1579"><pre><code>&#34;User.count&#34; didn&#39;t change by 32.
Expected: 1611
  Actual: 1579
</code></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="&#34;User.count&#34; didn&#39;t change by 32, but by 0.
Expected: 1611
  Actual: 1579"><pre><code>&#34;User.count&#34; didn&#39;t change by 32, but by 0.
Expected: 1611
  Actual: 1579
</code></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Add ability to match exception messages to <code>assert_raises</code> assertion</p>
<p>Instead of this</p>
<div data-snippet-clipboard-copy-content="error = assert_raises(ArgumentError) do
  perform_service(param: &#39;exception&#39;)
end
assert_match(/incorrect param/i, error.message)"><pre><span>error</span> <span>=</span> <span>assert_raises</span><span>(</span><span>ArgumentError</span><span>)</span> <span>do</span>
  <span>perform_service</span><span>(</span><span>param</span>: <span>&#39;exception&#39;</span><span>)</span>
<span>end</span>
<span>assert_match</span><span>(</span><span>/incorrect param/i</span><span>,</span> <span>error</span><span>.</span><span>message</span><span>)</span></pre></div>
<p>you can now write this</p>
<div data-snippet-clipboard-copy-content="assert_raises(ArgumentError, match: /incorrect param/i) do
  perform_service(param: &#39;exception&#39;)
end"><pre><span>assert_raises</span><span>(</span><span>ArgumentError</span><span>,</span> <span>match</span>: <span>/incorrect param/i</span><span>)</span> <span>do</span>
  <span>perform_service</span><span>(</span><span>param</span>: <span>&#39;exception&#39;</span><span>)</span>
<span>end</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Add <code>Rails.env.local?</code> shorthand for <code>Rails.env.development? || Rails.env.test?</code>.</p>
<p><em>DHH</em></p>
</li>
<li>
<p><code>ActiveSupport::Testing::TimeHelpers</code> now accepts named <code>with_usec</code> argument</p>
<p><em>KevSlashNull</em>, and <em>serprex</em></p>
</li>
<li>
<p><code>ActiveSupport::CurrentAttributes.resets</code> now accepts a method name</p>
<p>The block API is still the recommended approach, but now both APIs are supported:</p>
<div data-snippet-clipboard-copy-content="class Current &lt; ActiveSupport::CurrentAttributes
  resets { Time.zone = nil }
  resets :clear_time_zone
end"><pre><span>class</span> <span>Current</span> &lt; <span>ActiveSupport</span>::<span>CurrentAttributes</span>
  <span>resets</span> <span>{</span> <span>Time</span><span>.</span><span>zone</span> <span>=</span> <span>nil</span> <span>}</span>
  <span>resets</span> <span>:clear_time_zone</span>
<span>end</span></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Ensure <code>ActiveSupport::Testing::Isolation::Forking</code> closes pipes</p>
<p>Previously, <code>Forking.run_in_isolation</code> opened two ends of a pipe. The fork</p>
<p>This resulted in an accumulation of open file descriptors, which could</p>
<p><em>Sam Bostock</em></p>
</li>
<li>
<p>Fix <code>Time#change</code> and <code>Time#advance</code> for times around the end of Daylight</p>
<p>Previously, when <code>Time#change</code> or <code>Time#advance</code> constructed a time inside</p>
<div data-snippet-clipboard-copy-content="# DST ended just before 2021-11-07 2:00:00 AM in US/Eastern.
ENV[&#34;TZ&#34;] = &#34;US/Eastern&#34;

time = Time.local(2021, 11, 07, 00, 59, 59) + 1
# =&gt; 2021-11-07 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0500

time = Time.local(2021, 11, 06, 01, 00, 00)
# =&gt; 2021-11-06 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(days: 1)
# =&gt; 2021-11-07 01:00:00 -0500"><pre><span># DST ended just before 2021-11-07 2:00:00 AM in US/Eastern.</span>
<span>ENV</span><span>[</span><span>&#34;TZ&#34;</span><span>]</span> <span>=</span> <span>&#34;US/Eastern&#34;</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>local</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>07</span><span>,</span> <span>00</span><span>,</span> <span>59</span><span>,</span> <span>59</span><span>)</span> + <span>1</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>seconds</span>: <span>0</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>local</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>06</span><span>,</span> <span>01</span><span>,</span> <span>00</span><span>,</span> <span>00</span><span>)</span>
<span># =&gt; 2021-11-06 01:00:00 -0400</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>days</span>: <span>1</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span></pre></div>
<p>And the DST offset would always be chosen for times with a <code>TimeZone</code></p>
<div data-snippet-clipboard-copy-content="Time.zone = &#34;US/Eastern&#34;

time = Time.new(2021, 11, 07, 02, 00, 00, Time.zone) - 3600
# =&gt; 2021-11-07 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0400

time = Time.new(2021, 11, 8, 01, 00, 00, Time.zone)
# =&gt; 2021-11-08 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(days: -1)
# =&gt; 2021-11-07 01:00:00 -0400"><pre><span>Time</span><span>.</span><span>zone</span> <span>=</span> <span>&#34;US/Eastern&#34;</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>new</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>07</span><span>,</span> <span>02</span><span>,</span> <span>00</span><span>,</span> <span>00</span><span>,</span> <span>Time</span><span>.</span><span>zone</span><span>)</span> - <span>3600</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>seconds</span>: <span>0</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>new</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>8</span><span>,</span> <span>01</span><span>,</span> <span>00</span><span>,</span> <span>00</span><span>,</span> <span>Time</span><span>.</span><span>zone</span><span>)</span>
<span># =&gt; 2021-11-08 01:00:00 -0500</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>days</span>: -<span>1</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span></pre></div>
<p>Now, <code>Time#change</code> and <code>Time#advance</code> will choose the offset that matches</p>
<div data-snippet-clipboard-copy-content="ENV[&#34;TZ&#34;] = &#34;US/Eastern&#34;

time = Time.local(2021, 11, 07, 00, 59, 59) + 1
# =&gt; 2021-11-07 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0400

time = Time.local(2021, 11, 06, 01, 00, 00)
# =&gt; 2021-11-06 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(days: 1)
# =&gt; 2021-11-07 01:00:00 -0400

Time.zone = &#34;US/Eastern&#34;

time = Time.new(2021, 11, 07, 02, 00, 00, Time.zone) - 3600
# =&gt; 2021-11-07 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0500

time = Time.new(2021, 11, 8, 01, 00, 00, Time.zone)
# =&gt; 2021-11-08 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(days: -1)
# =&gt; 2021-11-07 01:00:00 -0500"><pre><span>ENV</span><span>[</span><span>&#34;TZ&#34;</span><span>]</span> <span>=</span> <span>&#34;US/Eastern&#34;</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>local</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>07</span><span>,</span> <span>00</span><span>,</span> <span>59</span><span>,</span> <span>59</span><span>)</span> + <span>1</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>seconds</span>: <span>0</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>local</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>06</span><span>,</span> <span>01</span><span>,</span> <span>00</span><span>,</span> <span>00</span><span>)</span>
<span># =&gt; 2021-11-06 01:00:00 -0400</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>days</span>: <span>1</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0400</span>

<span>Time</span><span>.</span><span>zone</span> <span>=</span> <span>&#34;US/Eastern&#34;</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>new</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>07</span><span>,</span> <span>02</span><span>,</span> <span>00</span><span>,</span> <span>00</span><span>,</span> <span>Time</span><span>.</span><span>zone</span><span>)</span> - <span>3600</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>seconds</span>: <span>0</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>

<span>time</span> <span>=</span> <span>Time</span><span>.</span><span>new</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>8</span><span>,</span> <span>01</span><span>,</span> <span>00</span><span>,</span> <span>00</span><span>,</span> <span>Time</span><span>.</span><span>zone</span><span>)</span>
<span># =&gt; 2021-11-08 01:00:00 -0500</span>
<span>time</span><span>.</span><span>change</span><span>(</span><span>day</span>: <span>07</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span>
<span>time</span><span>.</span><span>advance</span><span>(</span><span>days</span>: -<span>1</span><span>)</span>
<span># =&gt; 2021-11-07 01:00:00 -0500</span></pre></div>
<p><em>Kevin Hall</em>, <em>Takayoshi Nishida</em>, and <em>Jonathan Hefner</em></p>
</li>
<li>
<p>Fix MemoryStore to preserve entries TTL when incrementing or decrementing</p>
<p>This is to be more consistent with how MemCachedStore and RedisCacheStore behaves.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p><code>Rails.error.handle</code> and <code>Rails.error.record</code> filter now by multiple error classes.</p>
<div data-snippet-clipboard-copy-content="Rails.error.handle(IOError, ArgumentError) do
  1 + &#39;1&#39; # raises TypeError
end
1 + 1 # TypeErrors are not IOErrors or ArgumentError, so this will *not* be handled"><pre><span>Rails</span><span>.</span><span>error</span><span>.</span><span>handle</span><span>(</span><span>IOError</span><span>,</span> <span>ArgumentError</span><span>)</span> <span>do</span>
  <span>1</span> + <span>&#39;1&#39;</span> <span># raises TypeError</span>
<span>end</span>
<span>1</span> + <span>1</span> <span># TypeErrors are not IOErrors or ArgumentError, so this will *not* be handled</span></pre></div>
<p><em>Martin Spickermann</em></p>
</li>
<li>
<p><code>Class#subclasses</code> and <code>Class#descendants</code> now automatically filter reloaded classes.</p>
<p>Previously they could return old implementations of reloadable classes that have been</p>
<p>They now automatically filter such classes like <code>DescendantTracker#subclasses</code> and</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p><code>Rails.error.report</code> now marks errors as reported to avoid reporting them twice.</p>
<p>In some cases, users might want to report errors explicitly with some extra context</p>
<p>This also allows to safely catch and report errors outside of the execution context.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Add <code>assert_error_reported</code> and <code>assert_no_error_reported</code></p>
<p>Allows to easily asserts an error happened but was handled</p>
<div data-snippet-clipboard-copy-content="report = assert_error_reported(IOError) do
  # ...
end
assert_equal &#34;Oops&#34;, report.error.message
assert_equal &#34;admin&#34;, report.context[:section]
assert_equal :warning, report.severity
assert_predicate report, :handled?"><pre><span>report</span> <span>=</span> <span>assert_error_reported</span><span>(</span><span>IOError</span><span>)</span> <span>do</span>
  <span># ...</span>
<span>end</span>
<span>assert_equal</span> <span>&#34;Oops&#34;</span><span>,</span> <span>report</span><span>.</span><span>error</span><span>.</span><span>message</span>
<span>assert_equal</span> <span>&#34;admin&#34;</span><span>,</span> <span>report</span><span>.</span><span>context</span><span>[</span><span>:section</span><span>]</span>
<span>assert_equal</span> <span>:warning</span><span>,</span> <span>report</span><span>.</span><span>severity</span>
<span>assert_predicate</span> <span>report</span><span>,</span> <span>:handled?</span></pre></div>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p><code>ActiveSupport::Deprecation</code> behavior callbacks can now receive the</p>
<p>3-arity and splat-args callbacks such as the following will now be passed</p>
<ul>
<li><code>-&gt;(message, callstack, deprecator) { ... }</code></li>
<li><code>-&gt;(*args) { ... }</code></li>
<li><code>-&gt;(message, *other_args) { ... }</code></li>
</ul>
<p>2-arity and 4-arity callbacks such as the following will continue to behave</p>
<ul>
<li><code>-&gt;(message, callstack) { ... }</code></li>
<li><code>-&gt;(message, callstack, deprecation_horizon, gem_name) { ... }</code></li>
<li><code>-&gt;(message, callstack, *deprecation_details) { ... }</code></li>
</ul>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p><code>ActiveSupport::Deprecation#disallowed_warnings</code> now affects the instance on</p>
<p>This means that individual <code>ActiveSupport::Deprecation</code> instances can be</p>
<p><strong>Before</strong></p>
<div data-snippet-clipboard-copy-content="ActiveSupport::Deprecation.disallowed_warnings = [&#34;foo&#34;]
deprecator = ActiveSupport::Deprecation.new(&#34;2.0&#34;, &#34;MyCoolGem&#34;)
deprecator.disallowed_warnings = [&#34;bar&#34;]

ActiveSupport::Deprecation.warn(&#34;foo&#34;) # =&gt; raise ActiveSupport::DeprecationException
ActiveSupport::Deprecation.warn(&#34;bar&#34;) # =&gt; print &#34;DEPRECATION WARNING: bar&#34;
deprecator.warn(&#34;foo&#34;)                 # =&gt; raise ActiveSupport::DeprecationException
deprecator.warn(&#34;bar&#34;)                 # =&gt; print &#34;DEPRECATION WARNING: bar&#34;"><pre><span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>disallowed_warnings</span> <span>=</span> <span>[</span><span>&#34;foo&#34;</span><span>]</span>
<span>deprecator</span> <span>=</span> <span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>new</span><span>(</span><span>&#34;2.0&#34;</span><span>,</span> <span>&#34;MyCoolGem&#34;</span><span>)</span>
<span>deprecator</span><span>.</span><span>disallowed_warnings</span> <span>=</span> <span>[</span><span>&#34;bar&#34;</span><span>]</span>

<span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>warn</span><span>(</span><span>&#34;foo&#34;</span><span>)</span> <span># =&gt; raise ActiveSupport::DeprecationException</span>
<span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>warn</span><span>(</span><span>&#34;bar&#34;</span><span>)</span> <span># =&gt; print &#34;DEPRECATION WARNING: bar&#34;</span>
<span>deprecator</span><span>.</span><span>warn</span><span>(</span><span>&#34;foo&#34;</span><span>)</span>                 <span># =&gt; raise ActiveSupport::DeprecationException</span>
<span>deprecator</span><span>.</span><span>warn</span><span>(</span><span>&#34;bar&#34;</span><span>)</span>                 <span># =&gt; print &#34;DEPRECATION WARNING: bar&#34;</span></pre></div>
<p><strong>After</strong></p>
<div data-snippet-clipboard-copy-content="ActiveSupport::Deprecation.disallowed_warnings = [&#34;foo&#34;]
deprecator = ActiveSupport::Deprecation.new(&#34;2.0&#34;, &#34;MyCoolGem&#34;)
deprecator.disallowed_warnings = [&#34;bar&#34;]

ActiveSupport::Deprecation.warn(&#34;foo&#34;) # =&gt; raise ActiveSupport::DeprecationException
ActiveSupport::Deprecation.warn(&#34;bar&#34;) # =&gt; print &#34;DEPRECATION WARNING: bar&#34;
deprecator.warn(&#34;foo&#34;)                 # =&gt; print &#34;DEPRECATION WARNING: foo&#34;
deprecator.warn(&#34;bar&#34;)                 # =&gt; raise ActiveSupport::DeprecationException"><pre><span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>disallowed_warnings</span> <span>=</span> <span>[</span><span>&#34;foo&#34;</span><span>]</span>
<span>deprecator</span> <span>=</span> <span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>new</span><span>(</span><span>&#34;2.0&#34;</span><span>,</span> <span>&#34;MyCoolGem&#34;</span><span>)</span>
<span>deprecator</span><span>.</span><span>disallowed_warnings</span> <span>=</span> <span>[</span><span>&#34;bar&#34;</span><span>]</span>

<span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>warn</span><span>(</span><span>&#34;foo&#34;</span><span>)</span> <span># =&gt; raise ActiveSupport::DeprecationException</span>
<span>ActiveSupport</span>::<span>Deprecation</span><span>.</span><span>warn</span><span>(</span><span>&#34;bar&#34;</span><span>)</span> <span># =&gt; print &#34;DEPRECATION WARNING: bar&#34;</span>
<span>deprecator</span><span>.</span><span>warn</span><span>(</span><span>&#34;foo&#34;</span><span>)</span>                 <span># =&gt; print &#34;DEPRECATION WARNING: foo&#34;</span>
<span>deprecator</span><span>.</span><span>warn</span><span>(</span><span>&#34;bar&#34;</span><span>)</span>                 <span># =&gt; raise ActiveSupport::DeprecationException</span></pre></div>
<p>Note that global <code>ActiveSupport::Deprecation</code> methods such as <code>ActiveSupport::Deprecation.warn</code></p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Add italic and underline support to <code>ActiveSupport::LogSubscriber#color</code></p>
<p>Previously, only bold text was supported via a positional argument.</p>
<div data-snippet-clipboard-copy-content="info color(&#34;Hello world!&#34;, :red, bold: true, underline: true)"><pre><span>info</span> <span>color</span><span>(</span><span>&#34;Hello world!&#34;</span><span>,</span> <span>:red</span><span>,</span> <span>bold</span>: <span>true</span><span>,</span> <span>underline</span>: <span>true</span><span>)</span></pre></div>
<p><em>Gannon McGibbon</em></p>
</li>
<li>
<p>Add <code>String#downcase_first</code> method.</p>
<p>This method is the corollary of <code>String#upcase_first</code>.</p>
<p><em>Mark Schneider</em></p>
</li>
<li>
<p><code>thread_mattr_accessor</code> will call <code>.dup.freeze</code> on non-frozen default values.</p>
<p>This provides a basic level of protection against different threads trying</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Add <code>raise_on_invalid_cache_expiration_time</code> config to <code>ActiveSupport::Cache::Store</code></p>
<p>Specifies if an <code>ArgumentError</code> should be raised if <code>Rails.cache</code> <code>fetch</code> or</p>
<p>Options are <code>true</code>, and <code>false</code>. If <code>false</code>, the exception will be reported</p>
<p><em>Trevor Turk</em></p>
</li>
<li>
<p><code>ActiveSupport::Cache:Store#fetch</code> now passes an options accessor to the block.</p>
<p>It makes possible to override cache options:</p>
<div data-snippet-clipboard-copy-content="Rails.cache.fetch(&#34;3rd-party-token&#34;) do |name, options|
  token = fetch_token_from_remote
  # set cache&#39;s TTL to match token&#39;s TTL
  options.expires_in = token.expires_in
  token
end"><pre><code>Rails.cache.fetch(&#34;3rd-party-token&#34;) do |name, options|
  token = fetch_token_from_remote
  # set cache&#39;s TTL to match token&#39;s TTL
  options.expires_in = token.expires_in
  token
end
</code></pre></div>
<p><em>Andrii Gladkyi</em>, <em>Jean Boussier</em></p>
</li>
<li>
<p><code>default</code> option of <code>thread_mattr_accessor</code> now applies through inheritance and</p>
<p>Previously, the <code>default</code> value provided was set only at the moment of defining</p>
<p>Fixes <a data-error-text="Failed to load title" data-id="1008053433" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/43312" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/43312/hovercard" href="https://github.com/rails/rails/issues/43312">#43312</a>.</p>
<p><em>Thierry Deo</em></p>
</li>
<li>
<p>Redis cache store is now compatible with redis-rb 5.0.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Add <code>skip_nil:</code> support to <code>ActiveSupport::Cache::Store#fetch_multi</code>.</p>
<p><em>Daniel Alfaro</em></p>
</li>
<li>
<p>Add <code>quarter</code> method to date/time</p>
<p><em>Matt Swanson</em></p>
</li>
<li>
<p>Fix <code>NoMethodError</code> on custom <code>ActiveSupport::Deprecation</code> behavior.</p>
<p><code>ActiveSupport::Deprecation.behavior=</code> was supposed to accept any object</p>
<p>This change removes this <code>arity</code> restriction of custom behaviors.</p>
<p><em>Ryo Nakamura</em></p>
</li>
<li>
<p>Support <code>:url_safe</code> option for <code>MessageEncryptor</code>.</p>
<p>The <code>MessageEncryptor</code> constructor now accepts a <code>:url_safe</code> option, similar</p>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Add <code>url_safe</code> option to <code>ActiveSupport::MessageVerifier</code> initializer</p>
<p><code>ActiveSupport::MessageVerifier.new</code> now takes optional <code>url_safe</code> argument.</p>
<div data-snippet-clipboard-copy-content="verifier = ActiveSupport::MessageVerifier.new(url_safe: true)
message = verifier.generate(data) # =&gt; URL-safe string"><pre><span>verifier</span> <span>=</span> <span>ActiveSupport</span>::<span>MessageVerifier</span><span>.</span><span>new</span><span>(</span><span>url_safe</span>: <span>true</span><span>)</span>
<span>message</span> <span>=</span> <span>verifier</span><span>.</span><span>generate</span><span>(</span><span>data</span><span>)</span> <span># =&gt; URL-safe string</span></pre></div>
<p>This option is <code>false</code> by default to be backwards compatible.</p>
<p><em>Shouichi Kamiya</em></p>
</li>
<li>
<p>Enable connection pooling by default for <code>MemCacheStore</code> and <code>RedisCacheStore</code>.</p>
<p>If you want to disable connection pooling, set <code>:pool</code> option to <code>false</code> when configuring the cache store:</p>
<div data-snippet-clipboard-copy-content="config.cache_store = :mem_cache_store, &#34;cache.example.com&#34;, pool: false"><pre><span>config</span><span>.</span><span>cache_store</span> <span>=</span> <span>:mem_cache_store</span><span>,</span> <span>&#34;cache.example.com&#34;</span><span>,</span> <span>pool</span>: <span>false</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Add <code>force:</code> support to <code>ActiveSupport::Cache::Store#fetch_multi</code>.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Deprecated <code>:pool_size</code> and <code>:pool_timeout</code> options for configuring connection pooling in cache stores.</p>
<p>Use <code>pool: true</code> to enable pooling with default settings:</p>
<div data-snippet-clipboard-copy-content="config.cache_store = :redis_cache_store, pool: true"><pre><span>config</span><span>.</span><span>cache_store</span> <span>=</span> <span>:redis_cache_store</span><span>,</span> <span>pool</span>: <span>true</span></pre></div>
<p>Or pass individual options via <code>:pool</code> option:</p>
<div data-snippet-clipboard-copy-content="config.cache_store = :redis_cache_store, pool: { size: 10, timeout: 2 }"><pre><span>config</span><span>.</span><span>cache_store</span> <span>=</span> <span>:redis_cache_store</span><span>,</span> <span>pool</span>: <span>{</span> <span>size</span>: <span>10</span><span>,</span> <span>timeout</span>: <span>2</span> <span>}</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Allow #increment and #decrement methods of <code>ActiveSupport::Cache::Store</code></p>
<p>Previously incrementing or decrementing an unset key would fail and return</p>
<p><em>Andrej Blagojević</em>, <em>Eugene Kenny</em></p>
</li>
<li>
<p>Add <code>skip_nil:</code> support to <code>RedisCacheStore</code></p>
<p><em>Joey Paris</em></p>
</li>
<li>
<p><code>ActiveSupport::Cache::MemoryStore#write(name, val, unless_exist:true)</code> now</p>
<p><em>Alan Savage</em></p>
</li>
<li>
<p><code>ActiveSupport::ErrorReporter</code> now accepts and forward a <code>source:</code> parameter.</p>
<p>This allow libraries to signal the origin of the errors, and reporters</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Fix and add protections for XSS in <code>ActionView::Helpers</code> and <code>ERB::Util</code>.</p>
<p>Add the method <code>ERB::Util.xml_name_escape</code> to escape dangerous characters</p>
<p><em>Álvaro Martín Fraguas</em></p>
</li>
<li>
<p>Respect <code>ActiveSupport::Logger.new</code>&#39;s <code>:formatter</code> keyword argument</p>
<p>The stdlib <code>Logger::new</code> allows passing a <code>:formatter</code> keyword argument to</p>
<p><em>Steven Harman</em></p>
</li>
<li>
<p>Deprecate preserving the pre-Ruby 2.4 behavior of <code>to_time</code></p>
<p>With Ruby 2.4+ the default for +to_time+ changed from converting to the</p>
<p>To minimize any noise generated the deprecation warning only appears when the</p>
<p><em>Andrew White</em></p>
</li>
<li>
<p><code>Pathname.blank?</code> only returns true for <code>Pathname.new(&#34;&#34;)</code></p>
<p>Previously it would end up calling <code>Pathname#empty?</code> which returned true</p>
<p>That behavior was unlikely to be expected.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Deprecate <code>Notification::Event</code>&#39;s <code>#children</code> and <code>#parent_of?</code></p>
<p><em>John Hawthorn</em></p>
</li>
<li>
<p>Change the default serializer of <code>ActiveSupport::MessageVerifier</code> from</p>
<p>Messages serialized with <code>Marshal</code> can still be read, but new messages will</p>
<p><em>Saba Kiaei</em>, <em>David Buckley</em>, and <em>Jonathan Hefner</em></p>
</li>
<li>
<p>Change the default serializer of <code>ActiveSupport::MessageEncryptor</code> from</p>
<p>Messages serialized with <code>Marshal</code> can still be read, but new messages will</p>
<p><em>Zack Deveau</em>, <em>Martin Gingras</em>, and <em>Jonathan Hefner</em></p>
</li>
<li>
<p>Add <code>ActiveSupport::TestCase#stub_const</code> to stub a constant for the duration of a yield.</p>
<p><em>DHH</em></p>
</li>
<li>
<p>Fix <code>ActiveSupport::EncryptedConfiguration</code> to be compatible with Psych 4</p>
<p><em>Stephen Sugden</em></p>
</li>
<li>
<p>Improve <code>File.atomic_write</code> error handling</p>
<p><em>Daniel Pepper</em></p>
</li>
<li>
<p>Fix <code>Class#descendants</code> and <code>DescendantsTracker#descendants</code> compatibility with Ruby 3.1.</p>
<p><a href="https://bugs.ruby-lang.org/issues/14394#note-33" rel="nofollow">The native <code>Class#descendants</code> was reverted prior to Ruby 3.1 release</a>,</p>
<p><em>Jean Boussier</em></p>
</li>
</div><div>
<li>
<p>Remove -shm and -wal SQLite files when <code>rails db:drop</code> is run.</p>
<p><em>Niklas Häusele</em></p>
</li>
<li>
<p>Revert the change to raise an <code>ArgumentError</code> when <code>#accepts_nested_attributes_for</code> is declared more than once for</p>
<p>The reverted behavior broke the case where the <code>#accepts_nested_attributes_for</code> was defined in a concern and</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Better naming for unique constraints support.</p>
<p>Naming unique keys leads to misunderstanding it&#39;s a short-hand of unique indexes.</p>
<p>In Rails 7.1.0.beta1 or before:</p>
<div data-snippet-clipboard-copy-content="add_unique_key :sections, [:position], deferrable: :deferred, name: &#34;unique_section_position&#34;
remove_unique_key :sections, name: &#34;unique_section_position&#34;"><pre><span>add_unique_key</span> <span>:sections</span><span>,</span> <span>[</span><span>:position</span><span>]</span><span>,</span> <span>deferrable</span>: <span>:deferred</span><span>,</span> <span>name</span>: <span>&#34;unique_section_position&#34;</span>
<span>remove_unique_key</span> <span>:sections</span><span>,</span> <span>name</span>: <span>&#34;unique_section_position&#34;</span></pre></div>
<p>Now:</p>
<div data-snippet-clipboard-copy-content="add_unique_constraint :sections, [:position], deferrable: :deferred, name: &#34;unique_section_position&#34;
remove_unique_constraint :sections, name: &#34;unique_section_position&#34;"><pre><span>add_unique_constraint</span> <span>:sections</span><span>,</span> <span>[</span><span>:position</span><span>]</span><span>,</span> <span>deferrable</span>: <span>:deferred</span><span>,</span> <span>name</span>: <span>&#34;unique_section_position&#34;</span>
<span>remove_unique_constraint</span> <span>:sections</span><span>,</span> <span>name</span>: <span>&#34;unique_section_position&#34;</span></pre></div>
<p><em>Ryuta Kamizono</em></p>
</li>
<li>
<p>Fix duplicate quoting for check constraint expressions in schema dump when using MySQL</p>
<p>A check constraint with an expression, that already contains quotes, lead to an invalid schema</p>
<p>Fixes <a data-error-text="Failed to load title" data-id="915248782" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/42424" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/42424/hovercard" href="https://github.com/rails/rails/issues/42424">#42424</a>.</p>
<p><em>Felix Tscheulin</em></p>
</li>
<li>
<p>Performance tune the SQLite3 adapter connection configuration</p>
<p>For Rails applications, the Write-Ahead-Log in normal syncing mode with a capped journal size, a healthy shared memory buffer and a shared cache will perform, on average, 2× better.</p>
<p><em>Stephen Margheim</em></p>
</li>
<li>
<p>Allow SQLite3 <code>busy_handler</code> to be configured with simple max number of <code>retries</code></p>
<p>Retrying busy connections without delay is a preferred practice for performance-sensitive applications. Add support for a <code>database.yml</code> <code>retries</code> integer, which is used in a simple <code>busy_handler</code> function to retry busy connections without exponential backoff up to the max number of <code>retries</code>.</p>
<p><em>Stephen Margheim</em></p>
</li>
<li>
<p>The SQLite3 adapter now supports <code>supports_insert_returning?</code></p>
<p>Implementing the full <code>supports_insert_returning?</code> contract means the SQLite3 adapter supports auto-populated columns (<a data-error-text="Failed to load title" data-id="1712735611" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/48241" data-hovercard-type="pull_request" data-hovercard-url="/rails/rails/pull/48241/hovercard" href="https://github.com/rails/rails/pull/48241">#48241</a>) as well as custom primary keys.</p>
<p><em>Stephen Margheim</em></p>
</li>
<li>
<p>Ensure the SQLite3 adapter handles default functions with the <code>||</code> concatenation operator</p>
<p>Previously, this default function would produce the static string <code>&#34;&#39;Ruby &#39; || &#39;on &#39; || &#39;Rails&#39;&#34;</code>.</p>
<div data-snippet-clipboard-copy-content="change_column_default &#34;test_models&#34;, &#34;ruby_on_rails&#34;, -&gt; { &#34;(&#39;Ruby &#39; || &#39;on &#39; || &#39;Rails&#39;)&#34; }"><pre><span>change_column_default</span> <span>&#34;test_models&#34;</span><span>,</span> <span>&#34;ruby_on_rails&#34;</span><span>,</span> <span>-&gt;</span> <span>{</span> <span>&#34;(&#39;Ruby &#39; || &#39;on &#39; || &#39;Rails&#39;)&#34;</span> <span>}</span></pre></div>
<p><em>Stephen Margheim</em></p>
</li>
<li>
<p>Dump PostgreSQL schemas as part of the schema dump.</p>
<p><em>Lachlan Sylvester</em></p>
</li>
<li>
<p>Encryption now supports <code>support_unencrypted_data</code> being set per-attribute.</p>
<p>You can now opt out of <code>support_unencrypted_data</code> on a specific encrypted attribute.</p>
<div data-snippet-clipboard-copy-content="class User &lt; ActiveRecord::Base
  encrypts :name, deterministic: true, support_unencrypted_data: false
  encrypts :email, deterministic: true
end"><pre><span>class</span> <span>User</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>encrypts</span> <span>:name</span><span>,</span> <span>deterministic</span>: <span>true</span><span>,</span> <span>support_unencrypted_data</span>: <span>false</span>
  <span>encrypts</span> <span>:email</span><span>,</span> <span>deterministic</span>: <span>true</span>
<span>end</span></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Add instrumentation for Active Record transactions</p>
<p>Allows subscribing to transaction events for tracking/instrumentation. The event payload contains the connection and the outcome (commit, rollback, restart, incomplete), as well as timing details.</p>
<div data-snippet-clipboard-copy-content="ActiveSupport::Notifications.subscribe(&#34;transaction.active_record&#34;) do |event|
  puts &#34;Transaction event occurred!&#34;
  connection = event.payload[:connection]
  puts &#34;Connection: #{connection.inspect}&#34;
end"><pre><span>ActiveSupport</span>::<span>Notifications</span><span>.</span><span>subscribe</span><span>(</span><span>&#34;transaction.active_record&#34;</span><span>)</span> <span>do</span> |<span>event</span>|
  <span>puts</span> <span>&#34;Transaction event occurred!&#34;</span>
  <span>connection</span> <span>=</span> <span>event</span><span>.</span><span>payload</span><span>[</span><span>:connection</span><span>]</span>
  <span>puts</span> <span>&#34;Connection: <span><span>#{</span><span>connection</span><span>.</span><span>inspect</span><span>}</span></span>&#34;</span>
<span>end</span></pre></div>
<p><em>Daniel Colson</em>, <em>Ian Candy</em></p>
</li>
<li>
<p>Support composite foreign keys via migration helpers.</p>
<div data-snippet-clipboard-copy-content="# Assuming &#34;carts&#34; table has &#34;(shop_id, user_id)&#34; as a primary key.

add_foreign_key(:orders, :carts, primary_key: [:shop_id, :user_id])

remove_foreign_key(:orders, :carts, primary_key: [:shop_id, :user_id])
foreign_key_exists?(:orders, :carts, primary_key: [:shop_id, :user_id])"><pre><span># Assuming &#34;carts&#34; table has &#34;(shop_id, user_id)&#34; as a primary key.</span>

<span>add_foreign_key</span><span>(</span><span>:orders</span><span>,</span> <span>:carts</span><span>,</span> <span>primary_key</span>: <span>[</span><span>:shop_id</span><span>,</span> <span>:user_id</span><span>]</span><span>)</span>

<span>remove_foreign_key</span><span>(</span><span>:orders</span><span>,</span> <span>:carts</span><span>,</span> <span>primary_key</span>: <span>[</span><span>:shop_id</span><span>,</span> <span>:user_id</span><span>]</span><span>)</span>
<span>foreign_key_exists?</span><span>(</span><span>:orders</span><span>,</span> <span>:carts</span><span>,</span> <span>primary_key</span>: <span>[</span><span>:shop_id</span><span>,</span> <span>:user_id</span><span>]</span><span>)</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Adds support for <code>if_not_exists</code> when adding a check constraint.</p>
<div data-snippet-clipboard-copy-content="add_check_constraint :posts, &#34;post_type IN (&#39;blog&#39;, &#39;comment&#39;, &#39;share&#39;)&#34;, if_not_exists: true"><pre><span>add_check_constraint</span> <span>:posts</span><span>,</span> <span>&#34;post_type IN (&#39;blog&#39;, &#39;comment&#39;, &#39;share&#39;)&#34;</span><span>,</span> <span>if_not_exists</span>: <span>true</span></pre></div>
<p><em>Cody Cutrer</em></p>
</li>
<li>
<p>Raise an <code>ArgumentError</code> when <code>#accepts_nested_attributes_for</code> is declared more than once for an association in</p>
<p><em>Joshua Young</em></p>
</li>
<li>
<p>Deprecate <code>rewhere</code> argument on <code>#merge</code>.</p>
<p>The <code>rewhere</code> argument on <code>#merge</code>is deprecated without replacement and</p>
<p><em>Adam Hess</em></p>
</li>
<li>
<p>Fix unscope is not working in specific case</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="Post.where(id: 1...3).unscope(where: :id).to_sql # &#34;SELECT `posts`.* FROM `posts` WHERE `posts`.`id` &gt;= 1 AND `posts`.`id` &lt; 3&#34;
"><pre><span>Post</span><span>.</span><span>where</span><span>(</span><span>id</span>: <span>1</span>...<span>3</span><span>)</span><span>.</span><span>unscope</span><span>(</span><span>where</span>: <span>:id</span><span>)</span><span>.</span><span>to_sql</span> <span># &#34;SELECT `posts`.* FROM `posts` WHERE `posts`.`id` &gt;= 1 AND `posts`.`id` &lt; 3&#34;</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="Post.where(id: 1...3).unscope(where: :id).to_sql # &#34;SELECT `posts`.* FROM `posts`&#34;"><pre><span>Post</span><span>.</span><span>where</span><span>(</span><span>id</span>: <span>1</span>...<span>3</span><span>)</span><span>.</span><span>unscope</span><span>(</span><span>where</span>: <span>:id</span><span>)</span><span>.</span><span>to_sql</span> <span># &#34;SELECT `posts`.* FROM `posts`&#34;</span></pre></div>
<p>Fixes <a data-error-text="Failed to load title" data-id="1689435061" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/48094" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/48094/hovercard" href="https://github.com/rails/rails/issues/48094">#48094</a>.</p>
<p><em>Kazuya Hatanaka</em></p>
</li>
<li>
<p>Change <code>has_secure_token</code> default to <code>on: :initialize</code></p>
<p>Change the new default value from <code>on: :create</code> to <code>on: :initialize</code></p>
<p>Can be controlled by the <code>config.active_record.generate_secure_token_on</code></p>
<div data-snippet-clipboard-copy-content="config.active_record.generate_secure_token_on = :create"><pre><span>config</span><span>.</span><span>active_record</span><span>.</span><span>generate_secure_token_on</span> <span>=</span> <span>:create</span></pre></div>
<p><em>Sean Doyle</em></p>
</li>
<li>
<p>Fix <code>change_column</code> not setting <code>precision: 6</code> on <code>datetime</code> columns when</p>
<p><em>Hartley McGuire</em></p>
</li>
<li>
<p>Support composite identifiers in <code>to_key</code></p>
<p><code>to_key</code> avoids wrapping <code>#id</code> value into an <code>Array</code> if <code>#id</code> already an array</p>
<p><em>Nikita Vasilevsky</em></p>
</li>
<li>
<p>Add validation option for <code>enum</code></p>
<div data-snippet-clipboard-copy-content="class Contract &lt; ApplicationRecord
  enum :status, %w[in_progress completed], validate: true
end
Contract.new(status: &#34;unknown&#34;).valid? # =&gt; false
Contract.new(status: nil).valid? # =&gt; false
Contract.new(status: &#34;completed&#34;).valid? # =&gt; true

class Contract &lt; ApplicationRecord
  enum :status, %w[in_progress completed], validate: { allow_nil: true }
end
Contract.new(status: &#34;unknown&#34;).valid? # =&gt; false
Contract.new(status: nil).valid? # =&gt; true
Contract.new(status: &#34;completed&#34;).valid? # =&gt; true"><pre><span>class</span> <span>Contract</span> &lt; <span>ApplicationRecord</span>
  <span>enum</span> <span>:status</span><span>,</span> <span>%w[</span><span>in_progress</span> <span>completed</span><span>]</span><span>,</span> <span>validate</span>: <span>true</span>
<span>end</span>
<span>Contract</span><span>.</span><span>new</span><span>(</span><span>status</span>: <span>&#34;unknown&#34;</span><span>)</span><span>.</span><span>valid?</span> <span># =&gt; false</span>
<span>Contract</span><span>.</span><span>new</span><span>(</span><span>status</span>: <span>nil</span><span>)</span><span>.</span><span>valid?</span> <span># =&gt; false</span>
<span>Contract</span><span>.</span><span>new</span><span>(</span><span>status</span>: <span>&#34;completed&#34;</span><span>)</span><span>.</span><span>valid?</span> <span># =&gt; true</span>

<span>class</span> <span>Contract</span> &lt; <span>ApplicationRecord</span>
  <span>enum</span> <span>:status</span><span>,</span> <span>%w[</span><span>in_progress</span> <span>completed</span><span>]</span><span>,</span> <span>validate</span>: <span>{</span> <span>allow_nil</span>: <span>true</span> <span>}</span>
<span>end</span>
<span>Contract</span><span>.</span><span>new</span><span>(</span><span>status</span>: <span>&#34;unknown&#34;</span><span>)</span><span>.</span><span>valid?</span> <span># =&gt; false</span>
<span>Contract</span><span>.</span><span>new</span><span>(</span><span>status</span>: <span>nil</span><span>)</span><span>.</span><span>valid?</span> <span># =&gt; true</span>
<span>Contract</span><span>.</span><span>new</span><span>(</span><span>status</span>: <span>&#34;completed&#34;</span><span>)</span><span>.</span><span>valid?</span> <span># =&gt; true</span></pre></div>
<p><em>Edem Topuzov</em>, <em>Ryuta Kamizono</em></p>
</li>
<li>
<p>Allow batching methods to use already loaded relation if available</p>
<p>Calling batch methods on already loaded relations will use the records previously loaded instead of retrieving</p>
<p><em>Adam Hess</em></p>
</li>
<li>
<p>Deprecate <code>read_attribute(:id)</code> returning the primary key if the primary key is not <code>:id</code>.</p>
<p>Starting in Rails 7.2, <code>read_attribute(:id)</code> will return the value of the id column, regardless of the model&#39;s</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Fix <code>change_table</code> setting datetime precision for 6.1 Migrations</p>
<p><em>Hartley McGuire</em></p>
</li>
<li>
<p>Fix change_column setting datetime precision for 6.1 Migrations</p>
<p><em>Hartley McGuire</em></p>
</li>
<li>
<p>Add <code>ActiveRecord::Base#id_value</code> alias to access the raw value of a record&#39;s id column.</p>
<p>This alias is only provided for models that declare an <code>:id</code> column.</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Fix previous change tracking for <code>ActiveRecord::Store</code> when using a column with JSON structured database type</p>
<p>Before, the methods to access the changes made during the last save <code>#saved_change_to_key?</code>, <code>#saved_change_to_key</code>, and <code>#key_before_last_save</code> did not work if the store was defined as a <code>store_accessor</code> on a column with a JSON structured database type</p>
<p><em>Robert DiMartino</em></p>
</li>
<li>
<p>Fully support <code>NULLS [NOT] DISTINCT</code> for PostgreSQL 15+ indexes.</p>
<p>Previous work was done to allow the index to be created in a migration, but it was not</p>
<p><em>Gregory Jones</em></p>
</li>
<li>
<p>Allow escaping of literal colon characters in <code>sanitize_sql_*</code> methods when named bind variables are used</p>
<p><em>Justin Bull</em></p>
</li>
<li>
<p>Fix <code>#previously_new_record?</code> to return true for destroyed records.</p>
<p>Before, if a record was created and then destroyed, <code>#previously_new_record?</code> would return true.</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Specify callback in <code>has_secure_token</code></p>
<div data-snippet-clipboard-copy-content="class User &lt; ApplicationRecord
  has_secure_token on: :initialize
end

User.new.token # =&gt; &#34;abc123....&#34;"><pre><span>class</span> <span>User</span> &lt; <span>ApplicationRecord</span>
  <span>has_secure_token</span> <span>on</span>: <span>:initialize</span>
<span>end</span>

<span>User</span><span>.</span><span>new</span><span>.</span><span>token</span> <span># =&gt; &#34;abc123....&#34;</span></pre></div>
<p><em>Sean Doyle</em></p>
</li>
<li>
<p>Fix incrementation of in memory counter caches when associations overlap</p>
<p>When two associations had a similarly named counter cache column, Active Record</p>
<p><em>Jacopo Beschi</em>, <em>Jean Boussier</em></p>
</li>
<li>
<p>Don&#39;t show secrets for Active Record&#39;s <code>Cipher::Aes256Gcm#inspect</code>.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::Encryption::Cipher::Aes256Gcm.new(secret).inspect
&#34;#&lt;ActiveRecord::Encryption::Cipher::Aes256Gcm:0x0000000104888038 ... @secret=\&#34;\\xAF\\bFh]LV}q\\nl\\xB2U\\xB3 ... &gt;&#34;"><pre><span>ActiveRecord</span>::<span>Encryption</span>::<span>Cipher</span>::<span>Aes256Gcm</span><span>.</span><span>new</span><span>(</span><span>secret</span><span>)</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveRecord::Encryption::Cipher::Aes256Gcm:0x0000000104888038 ... @secret=<span>\&#34;</span><span>\\</span>xAF<span>\\</span>bFh]LV}q<span>\\</span>nl<span>\\</span>xB2U<span>\\</span>xB3 ... &gt;&#34;</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::Encryption::Cipher::Aes256Gcm(secret).inspect
&#34;#&lt;ActiveRecord::Encryption::Cipher::Aes256Gcm:0x0000000104888038&gt;&#34;"><pre><span>ActiveRecord</span>::<span>Encryption</span>::<span>Cipher</span>::<span>Aes256Gcm</span><span>(</span><span>secret</span><span>)</span><span>.</span><span>inspect</span>
<span>&#34;#&lt;ActiveRecord::Encryption::Cipher::Aes256Gcm:0x0000000104888038&gt;&#34;</span></pre></div>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p>Bring back the historical behavior of committing transaction on non-local return.</p>
<div data-snippet-clipboard-copy-content="Model.transaction do
  model.save
  return
  other_model.save # not executed
end"><pre><span>Model</span><span>.</span><span>transaction</span> <span>do</span>
  <span>model</span><span>.</span><span>save</span>
  <span>return</span>
  <span>other_model</span><span>.</span><span>save</span> <span># not executed</span>
<span>end</span></pre></div>
<p>Historically only raised errors would trigger a rollback, but in Ruby <code>2.3</code>, the <code>timeout</code> library</p>
<p>To solve this, in Active Record 6.1 the behavior was changed to instead rollback the transaction as it was safer</p>
<p>Using <code>return</code>, <code>break</code> or <code>throw</code> inside a <code>transaction</code> block was essentially deprecated from Rails 6.1 onwards.</p>
<p>However with the release of <code>timeout 0.4.0</code>, <code>Timeout.timeout</code> now raises an error again, and Active Record is able</p>
<p>This historical behavior can now be opt-ed in via:</p>
<div data-snippet-clipboard-copy-content="Rails.application.config.active_record.commit_transaction_on_non_local_return = true"><pre><code>Rails.application.config.active_record.commit_transaction_on_non_local_return = true
</code></pre></div>
<p>And is the default for new applications created in Rails 7.1.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Deprecate <code>name</code> argument on <code>#remove_connection</code>.</p>
<p>The <code>name</code> argument is deprecated on <code>#remove_connection</code> without replacement. <code>#remove_connection</code> should be called directly on the class that established the connection.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Fix has_one through singular building with inverse.</p>
<p>Allows building of records from an association with a has_one through a</p>
<p><em>Gannon McGibbon</em></p>
</li>
<li>
<p>Disable database prepared statements when query logs are enabled</p>
<p>Prepared Statements and Query Logs are incompatible features due to query logs making every query unique.</p>
<p><em>zzak, Jean Boussier</em></p>
</li>
<li>
<p>Support decrypting data encrypted non-deterministically with a SHA1 hash digest.</p>
<p>This adds a new Active Record encryption option to support decrypting data encrypted</p>
<div data-snippet-clipboard-copy-content="Rails.application.config.active_record.encryption.support_sha1_for_non_deterministic_encryption = true"><pre><code>Rails.application.config.active_record.encryption.support_sha1_for_non_deterministic_encryption = true
</code></pre></div>
<p>The new option addresses a problem when upgrading from 7.0 to 7.1. Due to a bug in how Active Record</p>
<p><em>Cadu Ribeiro and Jorge Manrubia</em></p>
</li>
<li>
<p>Added PostgreSQL migration commands for enum rename, add value, and rename value.</p>
<p><code>rename_enum</code> and <code>rename_enum_value</code> are reversible. Due to Postgres</p>
<div data-snippet-clipboard-copy-content="rename_enum :article_status, to: :article_state"><pre><span>rename_enum</span> <span>:article_status</span><span>,</span> <span>to</span>: <span>:article_state</span></pre></div>
<div data-snippet-clipboard-copy-content="add_enum_value :article_state, &#34;archived&#34; # will be at the end of existing values
add_enum_value :article_state, &#34;in review&#34;, before: &#34;published&#34;
add_enum_value :article_state, &#34;approved&#34;, after: &#34;in review&#34;"><pre><span>add_enum_value</span> <span>:article_state</span><span>,</span> <span>&#34;archived&#34;</span> <span># will be at the end of existing values</span>
<span>add_enum_value</span> <span>:article_state</span><span>,</span> <span>&#34;in review&#34;</span><span>,</span> <span>before</span>: <span>&#34;published&#34;</span>
<span>add_enum_value</span> <span>:article_state</span><span>,</span> <span>&#34;approved&#34;</span><span>,</span> <span>after</span>: <span>&#34;in review&#34;</span></pre></div>
<div data-snippet-clipboard-copy-content="rename_enum_value :article_state, from: &#34;archived&#34;, to: &#34;deleted&#34;"><pre><span>rename_enum_value</span> <span>:article_state</span><span>,</span> <span>from</span>: <span>&#34;archived&#34;</span><span>,</span> <span>to</span>: <span>&#34;deleted&#34;</span></pre></div>
<p><em>Ray Faddis</em></p>
</li>
<li>
<p>Allow composite primary key to be derived from schema</p>
<p>Booting an application with a schema that contains composite primary keys</p>
<p>Given a <code>travel_routes</code> table definition and a <code>TravelRoute</code> model like:</p>
<div data-snippet-clipboard-copy-content="create_table :travel_routes, primary_key: [:origin, :destination], force: true do |t|
  t.string :origin
  t.string :destination
end

class TravelRoute &lt; ActiveRecord::Base; end"><pre><span>create_table</span> <span>:travel_routes</span><span>,</span> <span>primary_key</span>: <span>[</span><span>:origin</span><span>,</span> <span>:destination</span><span>]</span><span>,</span> <span>force</span>: <span>true</span> <span>do</span> |<span>t</span>|
  <span>t</span><span>.</span><span>string</span> <span>:origin</span>
  <span>t</span><span>.</span><span>string</span> <span>:destination</span>
<span>end</span>

<span>class</span> <span>TravelRoute</span> &lt; <span>ActiveRecord</span>::<span>Base</span><span>;</span> <span>end</span></pre></div>
<p>The <code>TravelRoute.primary_key</code> value will be automatically derived to <code>[&#34;origin&#34;, &#34;destination&#34;]</code></p>
<p><em>Nikita Vasilevsky</em></p>
</li>
<li>
<p>Include the <code>connection_pool</code> with exceptions raised from an adapter.</p>
<p>The <code>connection_pool</code> provides added context such as the connection used</p>
<p><em>Luan Vieira</em></p>
</li>
<li>
<p>Support multiple column ordering for <code>find_each</code>, <code>find_in_batches</code> and <code>in_batches</code>.</p>
<p>When find_each/find_in_batches/in_batches are performed on a table with composite primary keys, ascending or descending order can be selected for each key.</p>
<div data-snippet-clipboard-copy-content="Person.find_each(order: [:desc, :asc]) do |person|
  person.party_all_night!
end"><pre><span>Person</span><span>.</span><span>find_each</span><span>(</span><span>order</span>: <span>[</span><span>:desc</span><span>,</span> <span>:asc</span><span>]</span><span>)</span> <span>do</span> |<span>person</span>|
  <span>person</span><span>.</span><span>party_all_night!</span>
<span>end</span></pre></div>
<p><em>Takuya Kurimoto</em></p>
</li>
<li>
<p>Fix where on association with has_one/has_many polymorphic relations.</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="Treasure.where(price_estimates: PriceEstimate.all)
#=&gt; SELECT (...) WHERE &#34;treasures&#34;.&#34;id&#34; IN (SELECT &#34;price_estimates&#34;.&#34;estimate_of_id&#34; FROM &#34;price_estimates&#34;)"><pre><span>Treasure</span><span>.</span><span>where</span><span>(</span><span>price_estimates</span>: <span>PriceEstimate</span><span>.</span><span>all</span><span>)</span>
<span>#=&gt; SELECT (...) WHERE &#34;treasures&#34;.&#34;id&#34; IN (SELECT &#34;price_estimates&#34;.&#34;estimate_of_id&#34; FROM &#34;price_estimates&#34;)</span></pre></div>
<p>Later:</p>
<div data-snippet-clipboard-copy-content="Treasure.where(price_estimates: PriceEstimate.all)
#=&gt; SELECT (...) WHERE &#34;treasures&#34;.&#34;id&#34; IN (SELECT &#34;price_estimates&#34;.&#34;estimate_of_id&#34; FROM &#34;price_estimates&#34; WHERE &#34;price_estimates&#34;.&#34;estimate_of_type&#34; = &#39;Treasure&#39;)"><pre><span>Treasure</span><span>.</span><span>where</span><span>(</span><span>price_estimates</span>: <span>PriceEstimate</span><span>.</span><span>all</span><span>)</span>
<span>#=&gt; SELECT (...) WHERE &#34;treasures&#34;.&#34;id&#34; IN (SELECT &#34;price_estimates&#34;.&#34;estimate_of_id&#34; FROM &#34;price_estimates&#34; WHERE &#34;price_estimates&#34;.&#34;estimate_of_type&#34; = &#39;Treasure&#39;)</span></pre></div>
<p><em>Lázaro Nixon</em></p>
</li>
<li>
<p>Assign auto populated columns on Active Record record creation.</p>
<p>Changes record creation logic to allow for the <code>auto_increment</code> column to be assigned</p>
<p>The PostgreSQL adapter benefits the most from the change allowing for any number of auto-populated</p>
<p><em>Nikita Vasilevsky</em></p>
</li>
<li>
<p>Use the first key in the <code>shards</code> hash from <code>connected_to</code> for the <code>default_shard</code>.</p>
<p>Some applications may not want to use <code>:default</code> as a shard name in their connection model. Unfortunately Active Record expects there to be a <code>:default</code> shard because it must assume a shard to get the right connection from the pool manager. Rather than force applications to manually set this, <code>connects_to</code> can infer the default shard name from the hash of shards and will now assume that the first shard is your default.</p>
<p>For example if your model looked like this:</p>
<div data-snippet-clipboard-copy-content="class ShardRecord &lt; ApplicationRecord
  self.abstract_class = true

  connects_to shards: {
    shard_one: { writing: :shard_one },
    shard_two: { writing: :shard_two }
  }"><pre><span>class</span> <span>ShardRecord</span> &lt; <span>ApplicationRecord</span>
  <span>self</span><span>.</span><span>abstract_class</span> <span>=</span> <span>true</span>

  <span>connects_to</span> <span>shards</span>: <span>{</span>
    <span>shard_one</span>: <span>{</span> <span>writing</span>: <span>:shard_one</span> <span>}</span><span>,</span>
    <span>shard_two</span>: <span>{</span> <span>writing</span>: <span>:shard_two</span> <span>}</span>
  <span>}</span></pre></div>
<p>Then the <code>default_shard</code> for this class would be set to <code>shard_one</code>.</p>
<p>Fixes: <a data-error-text="Failed to load title" data-id="1275315412" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/45390" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/45390/hovercard" href="https://github.com/rails/rails/issues/45390">#45390</a></p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Fix mutation detection for serialized attributes backed by binary columns.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Add <code>ActiveRecord.disconnect_all!</code> method to immediately close all connections from all pools.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Discard connections which may have been left in a transaction.</p>
<p>There are cases where, due to an error, <code>within_new_transaction</code> may unexpectedly leave a connection in an open transaction. In these cases the connection may be reused, and the following may occur:</p>
<ul>
<li>Writes appear to fail when they actually succeed.</li>
<li>Writes appear to succeed when they actually fail.</li>
<li>Reads return stale or uncommitted data.</li>
</ul>
<p>Previously, the following case was detected:</p>
<ul>
<li>An error is encountered during the transaction, then another error is encountered while attempting to roll it back.</li>
</ul>
<p>Now, the following additional cases are detected:</p>
<ul>
<li>An error is encountered just after successfully beginning a transaction.</li>
<li>An error is encountered while committing a transaction, then another error is encountered while attempting to roll it back.</li>
<li>An error is encountered while rolling back a transaction.</li>
</ul>
<p><em>Nick Dower</em></p>
</li>
<li>
<p>Active Record query cache now evicts least recently used entries</p>
<p>By default it only keeps the <code>100</code> most recently used queries.</p>
<p>The cache size can be configured via <code>database.yml</code></p>
<div data-snippet-clipboard-copy-content="development:
  adapter: mysql2
  query_cache: 200"><pre><span>development</span>:
  <span>adapter</span>: <span>mysql2</span>
  <span>query_cache</span>: <span>200</span></pre></div>
<p>It can also be entirely disabled:</p>
<div data-snippet-clipboard-copy-content="development:
  adapter: mysql2
  query_cache: false"><pre><span>development</span>:
  <span>adapter</span>: <span>mysql2</span>
  <span>query_cache</span>: <span>false</span></pre></div>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Deprecate <code>check_pending!</code> in favor of <code>check_all_pending!</code>.</p>
<p><code>check_pending!</code> will only check for pending migrations on the current database connection or the one passed in. This has been deprecated in favor of <code>check_all_pending!</code> which will find all pending migrations for the database configurations in a given environment.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Make <code>increment_counter</code>/<code>decrement_counter</code> accept an amount argument</p>
<div data-snippet-clipboard-copy-content="Post.increment_counter(:comments_count, 5, by: 3)"><pre><span>Post</span><span>.</span><span>increment_counter</span><span>(</span><span>:comments_count</span><span>,</span> <span>5</span><span>,</span> <span>by</span>: <span>3</span><span>)</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Add support for <code>Array#intersect?</code> to <code>ActiveRecord::Relation</code>.</p>
<p><code>Array#intersect?</code> is only available on Ruby 3.1 or later.</p>
<p>This allows the Rubocop <code>Style/ArrayIntersect</code> cop to work with <code>ActiveRecord::Relation</code> objects.</p>
<p><em>John Harry Kelly</em></p>
</li>
<li>
<p>The deferrable foreign key can be passed to <code>t.references</code>.</p>
<p><em>Hiroyuki Ishii</em></p>
</li>
<li>
<p>Deprecate <code>deferrable: true</code> option of <code>add_foreign_key</code>.</p>
<p><code>deferrable: true</code> is deprecated in favor of <code>deferrable: :immediate</code>, and</p>
<p>Because <code>deferrable: true</code> and <code>deferrable: :deferred</code> are hard to understand.</p>
<p><em>Hiroyuki Ishii</em></p>
</li>
<li>
<p><code>AbstractAdapter#execute</code> and <code>#exec_query</code> now clear the query cache</p>
<p>If you need to perform a read only SQL query without clearing the query</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Make <code>.joins</code> / <code>.left_outer_joins</code> work with CTEs.</p>
<p>For example:</p>
<div data-snippet-clipboard-copy-content="Post
 .with(commented_posts: Comment.select(:post_id).distinct)
 .joins(:commented_posts)
#=&gt; WITH (...) SELECT ... INNER JOIN commented_posts on posts.id = commented_posts.post_id"><pre><span>Post</span>
 <span>.</span><span>with</span><span>(</span><span>commented_posts</span>: <span>Comment</span><span>.</span><span>select</span><span>(</span><span>:post_id</span><span>)</span><span>.</span><span>distinct</span><span>)</span>
 <span>.</span><span>joins</span><span>(</span><span>:commented_posts</span><span>)</span>
<span>#=&gt; WITH (...) SELECT ... INNER JOIN commented_posts on posts.id = commented_posts.post_id</span></pre></div>
<p><em>Vladimir Dementyev</em></p>
</li>
<li>
<p>Add a load hook for <code>ActiveRecord::ConnectionAdapters::Mysql2Adapter</code></p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Introduce adapter for Trilogy database client</p>
<p>Trilogy is a MySQL-compatible database client. Rails applications can use Trilogy</p>
<div data-snippet-clipboard-copy-content="development:
adapter: trilogy
database: blog_development
pool: 5"><pre><span>development</span>:
<span>adapter</span>: <span>trilogy</span>
<span>database</span>: <span>blog_development</span>
<span>pool</span>: <span>5</span></pre></div>
<p>Or by using the <code>DATABASE_URL</code> environment variable:</p>
<div data-snippet-clipboard-copy-content="ENV[&#39;DATABASE_URL&#39;] # =&gt; &#34;trilogy://localhost/blog_development?pool=5&#34;"><pre><span>ENV</span><span>[</span><span>&#39;DATABASE_URL&#39;</span><span>]</span> <span># =&gt; &#34;trilogy://localhost/blog_development?pool=5&#34;</span></pre></div>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p><code>after_commit</code> callbacks defined on models now execute in the correct order.</p>
<div data-snippet-clipboard-copy-content="class User &lt; ActiveRecord::Base
  after_commit { puts(&#34;this gets called first&#34;) }
  after_commit { puts(&#34;this gets called second&#34;) }
end"><pre><span>class</span> <span>User</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>after_commit</span> <span>{</span> <span>puts</span><span>(</span><span>&#34;this gets called first&#34;</span><span>)</span> <span>}</span>
  <span>after_commit</span> <span>{</span> <span>puts</span><span>(</span><span>&#34;this gets called second&#34;</span><span>)</span> <span>}</span>
<span>end</span></pre></div>
<p>Previously, the callbacks executed in the reverse order. To opt in to the new behaviour:</p>
<div data-snippet-clipboard-copy-content="config.active_record.run_after_transaction_callbacks_in_order_defined = true"><pre><span>config</span><span>.</span><span>active_record</span><span>.</span><span>run_after_transaction_callbacks_in_order_defined</span> <span>=</span> <span>true</span></pre></div>
<p>This is the default for new apps.</p>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Infer <code>foreign_key</code> when <code>inverse_of</code> is present on <code>has_one</code> and <code>has_many</code> associations.</p>
<div data-snippet-clipboard-copy-content="has_many :citations, foreign_key: &#34;book1_id&#34;, inverse_of: :book"><pre><span>has_many</span> <span>:citations</span><span>,</span> <span>foreign_key</span>: <span>&#34;book1_id&#34;</span><span>,</span> <span>inverse_of</span>: <span>:book</span></pre></div>
<p>can be simplified to</p>
<div data-snippet-clipboard-copy-content="has_many :citations, inverse_of: :book"><pre><span>has_many</span> <span>:citations</span><span>,</span> <span>inverse_of</span>: <span>:book</span></pre></div>
<p>and the foreign_key will be read from the corresponding <code>belongs_to</code> association.</p>
<p><em>Daniel Whitney</em></p>
</li>
<li>
<p>Limit max length of auto generated index names</p>
<p>Auto generated index names are now limited to 62 bytes, which fits within</p>
<p>Any index name over the limit will fallback to the new short format.</p>
<p>Before (too long):</p>
<div data-snippet-clipboard-copy-content="index_testings_on_foo_and_bar_and_first_name_and_last_name_and_administrator"><pre><code>index_testings_on_foo_and_bar_and_first_name_and_last_name_and_administrator
</code></pre></div>
<p>After (short format):</p>
<div data-snippet-clipboard-copy-content="idx_on_foo_bar_first_name_last_name_administrator_5939248142"><pre><code>idx_on_foo_bar_first_name_last_name_administrator_5939248142
</code></pre></div>
<p>The short format includes a hash to ensure the name is unique database-wide.</p>
<p><em>Mike Coutermarsh</em></p>
</li>
<li>
<p>Introduce a more stable and optimized Marshal serializer for Active Record models.</p>
<p>Can be enabled with <code>config.active_record.marshalling_format_version = 7.1</code>.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Allow specifying where clauses with column-tuple syntax.</p>
<p>Querying through <code>#where</code> now accepts a new tuple-syntax which accepts, as</p>
<p>For instance:</p>
<div data-snippet-clipboard-copy-content="# Cpk::Book =&gt; Cpk::Book(author_id: integer, number: integer, title: string, revision: integer)
# Cpk::Book.primary_key =&gt; [&#34;author_id&#34;, &#34;number&#34;]

book = Cpk::Book.create!(author_id: 1, number: 1)
Cpk::Book.where(Cpk::Book.primary_key =&gt; [[1, 2]]) # =&gt; [book]

# Topic =&gt; Topic(id: integer, title: string, author_name: string...)

Topic.where([:title, :author_name] =&gt; [[&#34;The Alchemist&#34;, &#34;Paulo Coelho&#34;], [&#34;Harry Potter&#34;, &#34;J.K Rowling&#34;]])"><pre><span># Cpk::Book =&gt; Cpk::Book(author_id: integer, number: integer, title: string, revision: integer)</span>
<span># Cpk::Book.primary_key =&gt; [&#34;author_id&#34;, &#34;number&#34;]</span>

<span>book</span> <span>=</span> <span>Cpk</span>::<span>Book</span><span>.</span><span>create!</span><span>(</span><span>author_id</span>: <span>1</span><span>,</span> <span>number</span>: <span>1</span><span>)</span>
<span>Cpk</span>::<span>Book</span><span>.</span><span>where</span><span>(</span><span>Cpk</span>::<span>Book</span><span>.</span><span>primary_key</span> <span>=&gt;</span> <span>[</span><span>[</span><span>1</span><span>,</span> <span>2</span><span>]</span><span>]</span><span>)</span> <span># =&gt; [book]</span>

<span># Topic =&gt; Topic(id: integer, title: string, author_name: string...)</span>

<span>Topic</span><span>.</span><span>where</span><span>(</span><span>[</span><span>:title</span><span>,</span> <span>:author_name</span><span>]</span> <span>=&gt;</span> <span>[</span><span>[</span><span>&#34;The Alchemist&#34;</span><span>,</span> <span>&#34;Paulo Coelho&#34;</span><span>]</span><span>,</span> <span>[</span><span>&#34;Harry Potter&#34;</span><span>,</span> <span>&#34;J.K Rowling&#34;</span><span>]</span><span>]</span><span>)</span></pre></div>
<p><em>Paarth Madan</em></p>
</li>
<li>
<p>Allow warning codes to be ignore when reporting SQL warnings.</p>
<p>Active Record config that can ignore warning codes</p>
<div data-snippet-clipboard-copy-content="# Configure allowlist of warnings that should always be ignored
config.active_record.db_warnings_ignore = [
  &#34;1062&#34;, # MySQL Error 1062: Duplicate entry
]"><pre><span># Configure allowlist of warnings that should always be ignored</span>
<span>config</span><span>.</span><span>active_record</span><span>.</span><span>db_warnings_ignore</span> <span>=</span> <span>[</span>
  <span>&#34;1062&#34;</span><span>,</span> <span># MySQL Error 1062: Duplicate entry</span>
<span>]</span></pre></div>
<p>This is supported for the MySQL and PostgreSQL adapters.</p>
<p><em>Nick Borromeo</em></p>
</li>
<li>
<p>Introduce <code>:active_record_fixtures</code> lazy load hook.</p>
<p>Hooks defined with this name will be run whenever <code>TestFixtures</code> is included</p>
<div data-snippet-clipboard-copy-content="ActiveSupport.on_load(:active_record_fixtures) do
  self.fixture_paths &lt;&lt; &#34;test/fixtures&#34;
end

klass = Class.new
klass.include(ActiveRecord::TestFixtures)

klass.fixture_paths # =&gt; [&#34;test/fixtures&#34;]"><pre><span>ActiveSupport</span><span>.</span><span>on_load</span><span>(</span><span>:active_record_fixtures</span><span>)</span> <span>do</span>
  <span>self</span><span>.</span><span>fixture_paths</span> &lt;&lt; <span>&#34;test/fixtures&#34;</span>
<span>end</span>

<span>klass</span> <span>=</span> <span>Class</span><span>.</span><span>new</span>
<span>klass</span><span>.</span><span>include</span><span>(</span><span>ActiveRecord</span>::<span>TestFixtures</span><span>)</span>

<span>klass</span><span>.</span><span>fixture_paths</span> <span># =&gt; [&#34;test/fixtures&#34;]</span></pre></div>
<p><em>Andrew Novoselac</em></p>
</li>
<li>
<p>Introduce <code>TestFixtures#fixture_paths</code>.</p>
<p>Multiple fixture paths can now be specified using the <code>#fixture_paths</code> accessor.</p>
<div data-snippet-clipboard-copy-content="ActiveSupport::TestCase.fixture_paths &lt;&lt; &#34;component1/test/fixtures&#34;
ActiveSupport::TestCase.fixture_paths &lt;&lt; &#34;component2/test/fixtures&#34;"><pre><span>ActiveSupport</span>::<span>TestCase</span><span>.</span><span>fixture_paths</span> &lt;&lt; <span>&#34;component1/test/fixtures&#34;</span>
<span>ActiveSupport</span>::<span>TestCase</span><span>.</span><span>fixture_paths</span> &lt;&lt; <span>&#34;component2/test/fixtures&#34;</span></pre></div>
<p><code>TestFixtures#fixture_path</code> is now deprecated.</p>
<p><em>Andrew Novoselac</em></p>
</li>
<li>
<p>Adds support for deferrable exclude constraints in PostgreSQL.</p>
<p>By default, exclude constraints in PostgreSQL are checked after each statement.</p>
<div data-snippet-clipboard-copy-content="exclusion_constraint :users, &#34;daterange(valid_from, valid_to) WITH &amp;&amp;&#34;, deferrable: :immediate"><pre><span>exclusion_constraint</span> <span>:users</span><span>,</span> <span>&#34;daterange(valid_from, valid_to) WITH &amp;&amp;&#34;</span><span>,</span> <span>deferrable</span>: <span>:immediate</span></pre></div>
<p>Passing <code>deferrable: :immediate</code> checks constraint after each statement,</p>
<p>It&#39;s also possible to change the default behavior from an immediate check</p>
<div data-snippet-clipboard-copy-content="exclusion_constraint :users, &#34;daterange(valid_from, valid_to) WITH &amp;&amp;&#34;, deferrable: :deferred"><pre><span>exclusion_constraint</span> <span>:users</span><span>,</span> <span>&#34;daterange(valid_from, valid_to) WITH &amp;&amp;&#34;</span><span>,</span> <span>deferrable</span>: <span>:deferred</span></pre></div>
<p><em>Hiroyuki Ishii</em></p>
</li>
<li>
<p>Respect <code>foreign_type</code> option to <code>delegated_type</code> for <code>{role}_class</code> method.</p>
<p>Usage of <code>delegated_type</code> with non-conventional <code>{role}_type</code> column names can now be specified with <code>foreign_type</code> option.</p>
<p><em>Jason Karns</em></p>
</li>
<li>
<p>Add support for unique constraints (PostgreSQL-only).</p>
<div data-snippet-clipboard-copy-content="add_unique_key :sections, [:position], deferrable: :deferred, name: &#34;unique_section_position&#34;
remove_unique_key :sections, name: &#34;unique_section_position&#34;"><pre><span>add_unique_key</span> <span>:sections</span><span>,</span> <span>[</span><span>:position</span><span>]</span><span>,</span> <span>deferrable</span>: <span>:deferred</span><span>,</span> <span>name</span>: <span>&#34;unique_section_position&#34;</span>
<span>remove_unique_key</span> <span>:sections</span><span>,</span> <span>name</span>: <span>&#34;unique_section_position&#34;</span></pre></div>
<p>See PostgreSQL&#39;s <a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS" rel="nofollow">Unique Constraints</a> documentation for more on unique constraints.</p>
<p>By default, unique constraints in PostgreSQL are checked after each statement.</p>
<p>An example of swapping unique columns between records.</p>
<div data-snippet-clipboard-copy-content="# position is unique column
old_item = Item.create!(position: 1)
new_item = Item.create!(position: 2)

Item.transaction do
  old_item.update!(position: 2)
  new_item.update!(position: 1)
end"><pre><span># position is unique column</span>
<span>old_item</span> <span>=</span> <span>Item</span><span>.</span><span>create!</span><span>(</span><span>position</span>: <span>1</span><span>)</span>
<span>new_item</span> <span>=</span> <span>Item</span><span>.</span><span>create!</span><span>(</span><span>position</span>: <span>2</span><span>)</span>

<span>Item</span><span>.</span><span>transaction</span> <span>do</span>
  <span>old_item</span><span>.</span><span>update!</span><span>(</span><span>position</span>: <span>2</span><span>)</span>
  <span>new_item</span><span>.</span><span>update!</span><span>(</span><span>position</span>: <span>1</span><span>)</span>
<span>end</span></pre></div>
<p>Using the default behavior, the transaction would fail when executing the</p>
<p>By passing the <code>:deferrable</code> option to the <code>add_unique_key</code> statement in</p>
<div data-snippet-clipboard-copy-content="add_unique_key :items, [:position], deferrable: :immediate"><pre><span>add_unique_key</span> <span>:items</span><span>,</span> <span>[</span><span>:position</span><span>]</span><span>,</span> <span>deferrable</span>: <span>:immediate</span></pre></div>
<p>Passing <code>deferrable: :immediate</code> does not change the behaviour of the previous example,</p>
<p>It&#39;s also possible to adjust the default behavior from an immediate</p>
<div data-snippet-clipboard-copy-content="add_unique_key :items, [:position], deferrable: :deferred"><pre><span>add_unique_key</span> <span>:items</span><span>,</span> <span>[</span><span>:position</span><span>]</span><span>,</span> <span>deferrable</span>: <span>:deferred</span></pre></div>
<p>If you want to change an existing unique index to deferrable, you can use :using_index</p>
<div data-snippet-clipboard-copy-content="add_unique_key :items, deferrable: :deferred, using_index: &#34;index_items_on_position&#34;"><pre><span>add_unique_key</span> <span>:items</span><span>,</span> <span>deferrable</span>: <span>:deferred</span><span>,</span> <span>using_index</span>: <span>&#34;index_items_on_position&#34;</span></pre></div>
<p><em>Hiroyuki Ishii</em></p>
</li>
<li>
<p>Remove deprecated <code>Tasks::DatabaseTasks.schema_file_type</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated <code>config.active_record.partial_writes</code>.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove deprecated <code>ActiveRecord::Base</code> config accessors.</p>
<p><em>Rafael Mendonça França</em></p>
</li>
<li>
<p>Remove the <code>:include_replicas</code> argument from <code>configs_for</code>. Use <code>:include_hidden</code> argument instead.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Allow applications to lookup a config via a custom hash key.</p>
<p>If you have registered a custom config or want to find configs where the hash matches a specific key, now you can pass <code>config_key</code> to <code>configs_for</code>. For example if you have a <code>db_config</code> with the key <code>vitess</code> you can look up a database configuration hash by  matching that key.</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::Base.configurations.configs_for(env_name: &#34;development&#34;, name: &#34;primary&#34;, config_key: :vitess)
ActiveRecord::Base.configurations.configs_for(env_name: &#34;development&#34;, config_key: :vitess)"><pre><span>ActiveRecord</span>::<span>Base</span><span>.</span><span>configurations</span><span>.</span><span>configs_for</span><span>(</span><span>env_name</span>: <span>&#34;development&#34;</span><span>,</span> <span>name</span>: <span>&#34;primary&#34;</span><span>,</span> <span>config_key</span>: <span>:vitess</span><span>)</span>
<span>ActiveRecord</span>::<span>Base</span><span>.</span><span>configurations</span><span>.</span><span>configs_for</span><span>(</span><span>env_name</span>: <span>&#34;development&#34;</span><span>,</span> <span>config_key</span>: <span>:vitess</span><span>)</span></pre></div>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Allow applications to register a custom database configuration handler.</p>
<p>Adds a mechanism for registering a custom handler for cases where you want database configurations to respond to custom methods. This is useful for non-Rails database adapters or tools like Vitess that you may want to configure differently from a standard <code>HashConfig</code> or <code>UrlConfig</code>.</p>
<p>Given the following database YAML we want the <code>animals</code> db to create a <code>CustomConfig</code> object instead while the <code>primary</code> database will be a <code>UrlConfig</code>:</p>
<div data-snippet-clipboard-copy-content="development:
  primary:
    url: postgres://localhost/primary
  animals:
    url: postgres://localhost/animals
    custom_config:
      sharded: 1"><pre><span>development</span>:
  <span>primary</span>:
    <span>url</span>: <span>postgres://localhost/primary</span>
  <span>animals</span>:
    <span>url</span>: <span>postgres://localhost/animals</span>
    <span>custom_config</span>:
      <span>sharded</span>: <span>1</span></pre></div>
<p>To register a custom handler first make a class that has your custom methods:</p>
<div data-snippet-clipboard-copy-content="class CustomConfig &lt; ActiveRecord::DatabaseConfigurations::UrlConfig
  def sharded?
    custom_config.fetch(&#34;sharded&#34;, false)
  end

  private
    def custom_config
      configuration_hash.fetch(:custom_config)
    end
end"><pre><span>class</span> <span>CustomConfig</span> &lt; <span>ActiveRecord</span>::<span>DatabaseConfigurations</span>::<span>UrlConfig</span>
  <span>def</span> <span>sharded?</span>
    <span>custom_config</span><span>.</span><span>fetch</span><span>(</span><span>&#34;sharded&#34;</span><span>,</span> <span>false</span><span>)</span>
  <span>end</span>

  <span>private</span>
    <span>def</span> <span>custom_config</span>
      <span>configuration_hash</span><span>.</span><span>fetch</span><span>(</span><span>:custom_config</span><span>)</span>
    <span>end</span>
<span>end</span></pre></div>
<p>Then register the config in an initializer:</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::DatabaseConfigurations.register_db_config_handler do |env_name, name, url, config|
  next unless config.key?(:custom_config)
  CustomConfig.new(env_name, name, url, config)
end"><pre><span>ActiveRecord</span>::<span>DatabaseConfigurations</span><span>.</span><span>register_db_config_handler</span> <span>do</span> |<span>env_name</span><span>,</span> <span>name</span><span>,</span> <span>url</span><span>,</span> <span>config</span>|
  <span>next</span> <span>unless</span> <span>config</span><span>.</span><span>key?</span><span>(</span><span>:custom_config</span><span>)</span>
  <span>CustomConfig</span><span>.</span><span>new</span><span>(</span><span>env_name</span><span>,</span> <span>name</span><span>,</span> <span>url</span><span>,</span> <span>config</span><span>)</span>
<span>end</span></pre></div>
<p>When the application is booted, configuration hashes with the <code>:custom_config</code> key will be <code>CustomConfig</code> objects and respond to <code>sharded?</code>. Applications must handle the condition in which Active Record should use their custom handler.</p>
<p><em>Eileen M. Uchitelle and John Crepezzi</em></p>
</li>
<li>
<p><code>ActiveRecord::Base.serialize</code> no longer uses YAML by default.</p>
<p>YAML isn&#39;t particularly performant and can lead to security issues</p>
<p>Unfortunately there isn&#39;t really any good serializers in Ruby&#39;s stdlib</p>
<p>The obvious choice would be JSON, which is a fine format for this use case,</p>
<p>Some third party JSON libraries like <code>Oj</code> have a suitable strict mode.</p>
<p>So it&#39;s preferable that users choose a serializer based on their own constraints.</p>
<p>The original default can be restored by setting <code>config.active_record.default_column_serializer = YAML</code>.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p><code>ActiveRecord::Base.serialize</code> signature changed.</p>
<p>Rather than a single positional argument that accepts two possible</p>
<p>Before:</p>
<div data-snippet-clipboard-copy-content="serialize :content, JSON
serialize :backtrace, Array"><pre><span>serialize</span> <span>:content</span><span>,</span> <span>JSON</span>
<span>serialize</span> <span>:backtrace</span><span>,</span> <span>Array</span></pre></div>
<p>After:</p>
<div data-snippet-clipboard-copy-content="serialize :content, coder: JSON
serialize :backtrace, type: Array"><pre><span>serialize</span> <span>:content</span><span>,</span> <span>coder</span>: <span>JSON</span>
<span>serialize</span> <span>:backtrace</span><span>,</span> <span>type</span>: <span>Array</span></pre></div>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>YAML columns use <code>YAML.safe_dump</code> if available.</p>
<p>As of <code>psych 5.1.0</code>, <code>YAML.safe_dump</code> can now apply the same permitted</p>
<p>It&#39;s preferable to ensure the payload only use allowed types when we first</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p><code>ActiveRecord::QueryLogs</code> better handle broken encoding.</p>
<p>It&#39;s not uncommon when building queries with BLOB fields to contain</p>
<p><code>ActiveRecord::QueryLogs</code> no longer depend on the query to be properly encoded.</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Fix a bug where <code>ActiveRecord::Generators::ModelGenerator</code> would not respect create_table_migration template overrides.</p>
<div data-snippet-clipboard-copy-content="rails g model create_books title:string content:text"><pre><code>rails g model create_books title:string content:text
</code></pre></div>
<p>will now read from the create_table_migration.rb.tt template in the following locations in order:</p>
<div data-snippet-clipboard-copy-content="lib/templates/active_record/model/create_table_migration.rb
lib/templates/active_record/migration/create_table_migration.rb"><pre><code>lib/templates/active_record/model/create_table_migration.rb
lib/templates/active_record/migration/create_table_migration.rb
</code></pre></div>
<p><em>Spencer Neste</em></p>
</li>
<li>
<p><code>ActiveRecord::Relation#explain</code> now accepts options.</p>
<p>For databases and adapters which support them (currently PostgreSQL</p>
<div data-snippet-clipboard-copy-content="Customer.where(id: 1).joins(:orders).explain(:analyze, :verbose)"><pre><span>Customer</span><span>.</span><span>where</span><span>(</span><span>id</span>: <span>1</span><span>)</span><span>.</span><span>joins</span><span>(</span><span>:orders</span><span>)</span><span>.</span><span>explain</span><span>(</span><span>:analyze</span><span>,</span> <span>:verbose</span><span>)</span></pre></div>
<p><em>Reid Lynch</em></p>
</li>
<li>
<p>Multiple <code>Arel::Nodes::SqlLiteral</code> nodes can now be added together to</p>
<p><em>Matthew Draper</em>, <em>Ole Friis</em></p>
</li>
<li>
<p><code>ActiveRecord::Base#signed_id</code> raises if called on a new record.</p>
<p>Previously it would return an ID that was not usable, since it was based on <code>id = nil</code>.</p>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Allow SQL warnings to be reported.</p>
<p>Active Record configs can be set to enable SQL warning reporting.</p>
<div data-snippet-clipboard-copy-content="# Configure action to take when SQL query produces warning
config.active_record.db_warnings_action = :raise

# Configure allowlist of warnings that should always be ignored
config.active_record.db_warnings_ignore = [
  /Invalid utf8mb4 character string/,
  &#34;An exact warning message&#34;,
]"><pre><span># Configure action to take when SQL query produces warning</span>
<span>config</span><span>.</span><span>active_record</span><span>.</span><span>db_warnings_action</span> <span>=</span> <span>:raise</span>

<span># Configure allowlist of warnings that should always be ignored</span>
<span>config</span><span>.</span><span>active_record</span><span>.</span><span>db_warnings_ignore</span> <span>=</span> <span>[</span>
  <span>/Invalid utf8mb4 character string/</span><span>,</span>
  <span>&#34;An exact warning message&#34;</span><span>,</span>
<span>]</span></pre></div>
<p>This is supported for the MySQL and PostgreSQL adapters.</p>
<p><em>Adrianna Chang</em>, <em>Paarth Madan</em></p>
</li>
<li>
<p>Add <code>#regroup</code> query method as a short-hand for <code>.unscope(:group).group(fields)</code></p>
<p>Example:</p>
<div data-snippet-clipboard-copy-content="Post.group(:title).regroup(:author)
# SELECT `posts`.`*` FROM `posts` GROUP BY `posts`.`author`"><pre><span>Post</span><span>.</span><span>group</span><span>(</span><span>:title</span><span>)</span><span>.</span><span>regroup</span><span>(</span><span>:author</span><span>)</span>
<span># SELECT `posts`.`*` FROM `posts` GROUP BY `posts`.`author`</span></pre></div>
<p><em>Danielius Visockas</em></p>
</li>
<li>
<p>PostgreSQL adapter method <code>enable_extension</code> now allows parameter to be <code>[schema_name.]&lt;extension_name&gt;</code></p>
<p>Example: <code>enable_extension(&#39;heroku_ext.hstore&#39;)</code></p>
<p><em>Leonardo Luarte</em></p>
</li>
<li>
<p>Add <code>:include</code> option to <code>add_index</code>.</p>
<p>Add support for including non-key columns in indexes for PostgreSQL</p>
<div data-snippet-clipboard-copy-content="add_index(:users, :email, include: [:id, :created_at])"><pre><span>add_index</span><span>(</span><span>:users</span><span>,</span> <span>:email</span><span>,</span> <span>include</span>: <span>[</span><span>:id</span><span>,</span> <span>:created_at</span><span>]</span><span>)</span></pre></div>
<p>will result in:</p>
<div data-snippet-clipboard-copy-content="CREATE INDEX index_users_on_email USING btree (email) INCLUDE (id, created_at)"><pre><span>CREATE</span> <span>INDEX</span> <span>index_users_on_email</span> USING btree (email) INCLUDE (id, created_at)</pre></div>
<p><em>Steve Abrams</em></p>
</li>
<li>
<p><code>ActiveRecord::Relation</code>’s <code>#any?</code>, <code>#none?</code>, and <code>#one?</code> methods take an optional pattern</p>
<p><em>George Claghorn</em></p>
</li>
<li>
<p>Add <code>ActiveRecord::Base.normalizes</code> for declaring attribute normalizations.</p>
<p>An attribute normalization is applied when the attribute is assigned or</p>
<p>For example:</p>
<div data-snippet-clipboard-copy-content="class User &lt; ActiveRecord::Base
  normalizes :email, with: -&gt; email { email.strip.downcase }
  normalizes :phone, with: -&gt; phone { phone.delete(&#34;^0-9&#34;).delete_prefix(&#34;1&#34;) }
end

user = User.create(email: &#34; CRUISE-CONTROL@EXAMPLE.COM\n&#34;)
user.email                  # =&gt; &#34;cruise-control@example.com&#34;

user = User.find_by(email: &#34;\tCRUISE-CONTROL@EXAMPLE.COM &#34;)
user.email                  # =&gt; &#34;cruise-control@example.com&#34;
user.email_before_type_cast # =&gt; &#34;cruise-control@example.com&#34;

User.where(email: &#34;\tCRUISE-CONTROL@EXAMPLE.COM &#34;).count         # =&gt; 1
User.where([&#34;email = ?&#34;, &#34;\tCRUISE-CONTROL@EXAMPLE.COM &#34;]).count # =&gt; 0

User.exists?(email: &#34;\tCRUISE-CONTROL@EXAMPLE.COM &#34;)         # =&gt; true
User.exists?([&#34;email = ?&#34;, &#34;\tCRUISE-CONTROL@EXAMPLE.COM &#34;]) # =&gt; false

User.normalize_value_for(:phone, &#34;+1 (555) 867-5309&#34;) # =&gt; &#34;5558675309&#34;"><pre><span>class</span> <span>User</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>normalizes</span> <span>:email</span><span>,</span> <span>with</span>: <span>-&gt;</span> <span>email</span> <span>{</span> <span>email</span><span>.</span><span>strip</span><span>.</span><span>downcase</span> <span>}</span>
  <span>normalizes</span> <span>:phone</span><span>,</span> <span>with</span>: <span>-&gt;</span> <span>phone</span> <span>{</span> <span>phone</span><span>.</span><span>delete</span><span>(</span><span>&#34;^0-9&#34;</span><span>)</span><span>.</span><span>delete_prefix</span><span>(</span><span>&#34;1&#34;</span><span>)</span> <span>}</span>
<span>end</span>

<span>user</span> <span>=</span> <span>User</span><span>.</span><span>create</span><span>(</span><span>email</span>: <span>&#34; CRUISE-CONTROL@EXAMPLE.COM<span>\n</span>&#34;</span><span>)</span>
<span>user</span><span>.</span><span>email</span>                  <span># =&gt; &#34;cruise-control@example.com&#34;</span>

<span>user</span> <span>=</span> <span>User</span><span>.</span><span>find_by</span><span>(</span><span>email</span>: <span>&#34;<span>\t</span>CRUISE-CONTROL@EXAMPLE.COM &#34;</span><span>)</span>
<span>user</span><span>.</span><span>email</span>                  <span># =&gt; &#34;cruise-control@example.com&#34;</span>
<span>user</span><span>.</span><span>email_before_type_cast</span> <span># =&gt; &#34;cruise-control@example.com&#34;</span>

<span>User</span><span>.</span><span>where</span><span>(</span><span>email</span>: <span>&#34;<span>\t</span>CRUISE-CONTROL@EXAMPLE.COM &#34;</span><span>)</span><span>.</span><span>count</span>         <span># =&gt; 1</span>
<span>User</span><span>.</span><span>where</span><span>(</span><span>[</span><span>&#34;email = ?&#34;</span><span>,</span> <span>&#34;<span>\t</span>CRUISE-CONTROL@EXAMPLE.COM &#34;</span><span>]</span><span>)</span><span>.</span><span>count</span> <span># =&gt; 0</span>

<span>User</span><span>.</span><span>exists?</span><span>(</span><span>email</span>: <span>&#34;<span>\t</span>CRUISE-CONTROL@EXAMPLE.COM &#34;</span><span>)</span>         <span># =&gt; true</span>
<span>User</span><span>.</span><span>exists?</span><span>(</span><span>[</span><span>&#34;email = ?&#34;</span><span>,</span> <span>&#34;<span>\t</span>CRUISE-CONTROL@EXAMPLE.COM &#34;</span><span>]</span><span>)</span> <span># =&gt; false</span>

<span>User</span><span>.</span><span>normalize_value_for</span><span>(</span><span>:phone</span><span>,</span> <span>&#34;+1 (555) 867-5309&#34;</span><span>)</span> <span># =&gt; &#34;5558675309&#34;</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Hide changes to before_committed! callback behaviour behind flag.</p>
<p>In <a data-error-text="Failed to load title" data-id="1456102052" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/46525" data-hovercard-type="pull_request" data-hovercard-url="/rails/rails/pull/46525/hovercard" href="https://github.com/rails/rails/pull/46525">#46525</a>, behavior around before_committed! callbacks was changed so that callbacks</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>The <code>namespaced_controller</code> Query Log tag now matches the <code>controller</code> format</p>
<p>For example, a request processed by <code>NameSpaced::UsersController</code> will now log as:</p>
<div data-snippet-clipboard-copy-content=":controller # &#34;users&#34;
:namespaced_controller # &#34;name_spaced/users&#34;"><pre><code>:controller # &#34;users&#34;
:namespaced_controller # &#34;name_spaced/users&#34;
</code></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Return only unique ids from ActiveRecord::Calculations#ids</p>
<p>Updated ActiveRecord::Calculations#ids to only return the unique ids of the base model</p>
<div data-snippet-clipboard-copy-content="Post.find_by(id: 1).comments.count
# =&gt; 5
Post.includes(:comments).where(id: 1).pluck(:id)
# =&gt; [1, 1, 1, 1, 1]
Post.includes(:comments).where(id: 1).ids
# =&gt; [1]"><pre><span>Post</span><span>.</span><span>find_by</span><span>(</span><span>id</span>: <span>1</span><span>)</span><span>.</span><span>comments</span><span>.</span><span>count</span>
<span># =&gt; 5</span>
<span>Post</span><span>.</span><span>includes</span><span>(</span><span>:comments</span><span>)</span><span>.</span><span>where</span><span>(</span><span>id</span>: <span>1</span><span>)</span><span>.</span><span>pluck</span><span>(</span><span>:id</span><span>)</span>
<span># =&gt; [1, 1, 1, 1, 1]</span>
<span>Post</span><span>.</span><span>includes</span><span>(</span><span>:comments</span><span>)</span><span>.</span><span>where</span><span>(</span><span>id</span>: <span>1</span><span>)</span><span>.</span><span>ids</span>
<span># =&gt; [1]</span></pre></div>
<p><em>Joshua Young</em></p>
</li>
<li>
<p>Stop using <code>LOWER()</code> for case-insensitive queries on <code>citext</code> columns</p>
<p>Previously, <code>LOWER()</code> was added for e.g. uniqueness validations with</p>
<p><em>Phil Pirozhkov</em></p>
</li>
<li>
<p>Extract <code>#sync_timezone_changes</code> method in AbstractMysqlAdapter to enable subclasses</p>
<p><em>Adrianna Chang</em>, <em>Paarth Madan</em></p>
</li>
<li>
<p>Do not write additional new lines when dumping sql migration versions</p>
<p>This change updates the <code>insert_versions_sql</code> function so that the database insert string containing the current database migration versions does not end with two additional new lines.</p>
<p><em>Misha Schwartz</em></p>
</li>
<li>
<p>Fix <code>composed_of</code> value freezing and duplication.</p>
<p>Previously composite values exhibited two confusing behaviors:</p>
<ul>
<li>When reading a compositve value it&#39;d <em>NOT</em> be frozen, allowing it to get out of sync with its underlying database</li>
<li>When writing a compositve value the argument would be frozen, potentially confusing the caller.</li>
</ul>
<p>Currently, composite values instantiated based on database columns are frozen (addressing the first issue) and</p>
<p><em>Greg Navis</em></p>
</li>
<li>
<p>Fix redundant updates to the column insensitivity cache</p>
<p>Fixed redundant queries checking column capability for insensitive</p>
<p><em>Phil Pirozhkov</em></p>
</li>
<li>
<p>Allow disabling methods generated by <code>ActiveRecord.enum</code>.</p>
<p><em>Alfred Dominic</em></p>
</li>
<li>
<p>Avoid validating <code>belongs_to</code> association if it has not changed.</p>
<p>Previously, when updating a record, Active Record will perform an extra query to check for the presence of</p>
<p>Currently, only <code>belongs_to</code>-related columns are checked for presence. It is possible to have orphaned records with</p>
<p>This behavior can be controlled by configuration:</p>
<div data-snippet-clipboard-copy-content="config.active_record.belongs_to_required_validates_foreign_key = false"><pre><span>config</span><span>.</span><span>active_record</span><span>.</span><span>belongs_to_required_validates_foreign_key</span> <span>=</span> <span>false</span></pre></div>
<p>and will be disabled by default with <code>config.load_defaults 7.1</code>.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p><code>has_one</code> and <code>belongs_to</code> associations now define a <code>reset_association</code> method</p>
<p><em>George Claghorn</em></p>
</li>
<li>
<p>Allow per attribute setting of YAML permitted classes (safe load) and unsafe load.</p>
<p><em>Carlos Palhares</em></p>
</li>
<li>
<p>Add a build persistence method</p>
<p>Provides a wrapper for <code>new</code>, to provide feature parity with <code>create</code>s</p>
<p><em>Sean Denny</em></p>
</li>
<li>
<p>Raise on assignment to readonly attributes</p>
<div data-snippet-clipboard-copy-content="class Post &lt; ActiveRecord::Base
  attr_readonly :content
end
Post.create!(content: &#34;cannot be updated&#34;)
post.content # &#34;cannot be updated&#34;
post.content = &#34;something else&#34; # =&gt; ActiveRecord::ReadonlyAttributeError"><pre><span>class</span> <span>Post</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>attr_readonly</span> <span>:content</span>
<span>end</span>
<span>Post</span><span>.</span><span>create!</span><span>(</span><span>content</span>: <span>&#34;cannot be updated&#34;</span><span>)</span>
<span>post</span><span>.</span><span>content</span> <span># &#34;cannot be updated&#34;</span>
<span>post</span><span>.</span><span>content</span> <span>=</span> <span>&#34;something else&#34;</span> <span># =&gt; ActiveRecord::ReadonlyAttributeError</span></pre></div>
<p>Previously, assignment would succeed but silently not write to the database.</p>
<p>This behavior can be controlled by configuration:</p>
<div data-snippet-clipboard-copy-content="config.active_record.raise_on_assign_to_attr_readonly = true"><pre><span>config</span><span>.</span><span>active_record</span><span>.</span><span>raise_on_assign_to_attr_readonly</span> <span>=</span> <span>true</span></pre></div>
<p>and will be enabled by default with <code>config.load_defaults 7.1</code>.</p>
<p><em>Alex Ghiculescu</em>, <em>Hartley McGuire</em></p>
</li>
<li>
<p>Allow unscoping of preload and eager_load associations</p>
<p>Added the ability to unscope preload and eager_load associations just like</p>
<div data-snippet-clipboard-copy-content="query.unscope(:eager_load, :preload).group(:id).select(:id)"><pre><span>query</span><span>.</span><span>unscope</span><span>(</span><span>:eager_load</span><span>,</span> <span>:preload</span><span>)</span><span>.</span><span>group</span><span>(</span><span>:id</span><span>)</span><span>.</span><span>select</span><span>(</span><span>:id</span><span>)</span></pre></div>
<p><em>David Morehouse</em></p>
</li>
<li>
<p>Add automatic filtering of encrypted attributes on inspect</p>
<p>This feature is enabled by default but can be disabled with</p>
<div data-snippet-clipboard-copy-content="config.active_record.encryption.add_to_filter_parameters = false"><pre><span>config</span><span>.</span><span>active_record</span><span>.</span><span>encryption</span><span>.</span><span>add_to_filter_parameters</span> <span>=</span> <span>false</span></pre></div>
<p><em>Hartley McGuire</em></p>
</li>
<li>
<p>Clear locking column on #dup</p>
<p>This change fixes not to duplicate locking_column like id and timestamps.</p>
<div data-snippet-clipboard-copy-content="car = Car.create!
car.touch
car.lock_version #=&gt; 1
car.dup.lock_version #=&gt; 0"><pre><code>car = Car.create!
car.touch
car.lock_version #=&gt; 1
car.dup.lock_version #=&gt; 0
</code></pre></div>
<p><em>Shouichi Kamiya</em>, <em>Seonggi Yang</em>, <em>Ryohei UEDA</em></p>
</li>
<li>
<p>Invalidate transaction as early as possible</p>
<p>After rescuing a <code>TransactionRollbackError</code> exception Rails invalidates transactions earlier in the flow</p>
<p><em>Nikita Vasilevsky</em></p>
</li>
<li>
<p>Allow configuring columns list to be used in SQL queries issued by an <code>ActiveRecord::Base</code> object</p>
<p>It is now possible to configure columns list that will be used to build an SQL query clauses when</p>
<div data-snippet-clipboard-copy-content="class Developer &lt; ActiveRecord::Base
  query_constraints :company_id, :id
end
developer = Developer.first.update(name: &#34;Bob&#34;)
# =&gt; UPDATE &#34;developers&#34; SET &#34;name&#34; = &#39;Bob&#39; WHERE &#34;developers&#34;.&#34;company_id&#34; = 1 AND &#34;developers&#34;.&#34;id&#34; = 1"><pre><span>class</span> <span>Developer</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>query_constraints</span> <span>:company_id</span><span>,</span> <span>:id</span>
<span>end</span>
<span>developer</span> <span>=</span> <span>Developer</span><span>.</span><span>first</span><span>.</span><span>update</span><span>(</span><span>name</span>: <span>&#34;Bob&#34;</span><span>)</span>
<span># =&gt; UPDATE &#34;developers&#34; SET &#34;name&#34; = &#39;Bob&#39; WHERE &#34;developers&#34;.&#34;company_id&#34; = 1 AND &#34;developers&#34;.&#34;id&#34; = 1</span></pre></div>
<p><em>Nikita Vasilevsky</em></p>
</li>
<li>
<p>Adds <code>validate</code> to foreign keys and check constraints in schema.rb</p>
<p>Previously, <code>schema.rb</code> would not record if <code>validate: false</code> had been used when adding a foreign key or check</p>
<p><em>Tommy Graves</em></p>
</li>
<li>
<p>Adapter <code>#execute</code> methods now accept an <code>allow_retry</code> option. When set to <code>true</code>, the SQL statement will be</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Only trigger <code>after_commit :destroy</code> callbacks when a database row is deleted.</p>
<p>This prevents <code>after_commit :destroy</code> callbacks from being triggered again</p>
<p><em>Ben Sheldon</em></p>
</li>
<li>
<p>Fix <code>ciphertext_for</code> for yet-to-be-encrypted values.</p>
<p>Previously, <code>ciphertext_for</code> returned the cleartext of values that had not</p>
<div data-snippet-clipboard-copy-content="Post.encrypts :body

post = Post.create!(body: &#34;Hello&#34;)
post.ciphertext_for(:body)
# =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;

post.body = &#34;World&#34;
post.ciphertext_for(:body)
# =&gt; &#34;World&#34;"><pre><span>Post</span><span>.</span><span>encrypts</span> <span>:body</span>

<span>post</span> <span>=</span> <span>Post</span><span>.</span><span>create!</span><span>(</span><span>body</span>: <span>&#34;Hello&#34;</span><span>)</span>
<span>post</span><span>.</span><span>ciphertext_for</span><span>(</span><span>:body</span><span>)</span>
<span># =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;</span>

<span>post</span><span>.</span><span>body</span> <span>=</span> <span>&#34;World&#34;</span>
<span>post</span><span>.</span><span>ciphertext_for</span><span>(</span><span>:body</span><span>)</span>
<span># =&gt; &#34;World&#34;</span></pre></div>
<p>Now, <code>ciphertext_for</code> will always return the ciphertext of encrypted</p>
<div data-snippet-clipboard-copy-content="Post.encrypts :body

post = Post.create!(body: &#34;Hello&#34;)
post.ciphertext_for(:body)
# =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;

post.body = &#34;World&#34;
post.ciphertext_for(:body)
# =&gt; &#34;{\&#34;p\&#34;:\&#34;xyz...&#34;"><pre><span>Post</span><span>.</span><span>encrypts</span> <span>:body</span>

<span>post</span> <span>=</span> <span>Post</span><span>.</span><span>create!</span><span>(</span><span>body</span>: <span>&#34;Hello&#34;</span><span>)</span>
<span>post</span><span>.</span><span>ciphertext_for</span><span>(</span><span>:body</span><span>)</span>
<span># =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;</span>

<span>post</span><span>.</span><span>body</span> <span>=</span> <span>&#34;World&#34;</span>
<span>post</span><span>.</span><span>ciphertext_for</span><span>(</span><span>:body</span><span>)</span>
<span># =&gt; &#34;{\&#34;p\&#34;:\&#34;xyz...&#34;</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Fix a bug where using groups and counts with long table names would return incorrect results.</p>
<p><em>Shota Toguchi</em>, <em>Yusaku Ono</em></p>
</li>
<li>
<p>Fix encryption of column default values.</p>
<p>Previously, encrypted attributes that used column default values appeared to</p>
<div data-snippet-clipboard-copy-content="Book.encrypts :name

book = Book.create!
book.name
# =&gt; &#34;&lt;untitled&gt;&#34;
book.name_before_type_cast
# =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;
book.reload.name_before_type_cast
# =&gt; &#34;&lt;untitled&gt;&#34;"><pre><span>Book</span><span>.</span><span>encrypts</span> <span>:name</span>

<span>book</span> <span>=</span> <span>Book</span><span>.</span><span>create!</span>
<span>book</span><span>.</span><span>name</span>
<span># =&gt; &#34;&lt;untitled&gt;&#34;</span>
<span>book</span><span>.</span><span>name_before_type_cast</span>
<span># =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;</span>
<span>book</span><span>.</span><span>reload</span><span>.</span><span>name_before_type_cast</span>
<span># =&gt; &#34;&lt;untitled&gt;&#34;</span></pre></div>
<p>Now, attributes with column default values are encrypted:</p>
<div data-snippet-clipboard-copy-content="Book.encrypts :name

book = Book.create!
book.name
# =&gt; &#34;&lt;untitled&gt;&#34;
book.name_before_type_cast
# =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;
book.reload.name_before_type_cast
# =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;"><pre><span>Book</span><span>.</span><span>encrypts</span> <span>:name</span>

<span>book</span> <span>=</span> <span>Book</span><span>.</span><span>create!</span>
<span>book</span><span>.</span><span>name</span>
<span># =&gt; &#34;&lt;untitled&gt;&#34;</span>
<span>book</span><span>.</span><span>name_before_type_cast</span>
<span># =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;</span>
<span>book</span><span>.</span><span>reload</span><span>.</span><span>name_before_type_cast</span>
<span># =&gt; &#34;{\&#34;p\&#34;:\&#34;abc...&#34;</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Deprecate delegation from <code>Base</code> to <code>connection_handler</code>.</p>
<p>Calling <code>Base.clear_all_connections!</code>, <code>Base.clear_active_connections!</code>, <code>Base.clear_reloadable_connections!</code> and <code>Base.flush_idle_connections!</code> is deprecated. Please call these methods on the connection handler directly. In future Rails versions, the delegation from <code>Base</code> to the <code>connection_handler</code> will be removed.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Allow ActiveRecord::QueryMethods#reselect to receive hash values, similar to ActiveRecord::QueryMethods#select</p>
<p><em>Sampat Badhe</em></p>
</li>
<li>
<p>Validate options when managing columns and tables in migrations.</p>
<p>If an invalid option is passed to a migration method like <code>create_table</code> and <code>add_column</code>, an error will be raised</p>
<p><em>Guo Xiang Tan</em>, <em>George Wambold</em></p>
</li>
<li>
<p>Update query log tags to use the <a href="https://open-telemetry.github.io/opentelemetry-sqlcommenter/" rel="nofollow">SQLCommenter</a> format by default. See <a href="https://github.com/rails/rails/issues/46179" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/46179/hovercard">#46179</a></p>
<p>To opt out of SQLCommenter-formatted query log tags, set <code>config.active_record.query_log_tags_format = :legacy</code>. By default, this is set to <code>:sqlcommenter</code>.</p>
<p><em>Modulitos</em> and <em>Iheanyi</em></p>
</li>
<li>
<p>Allow any ERB in the database.yml when creating rake tasks.</p>
<p>Any ERB can be used in <code>database.yml</code> even if it accesses environment</p>
<p>Deprecates <code>config.active_record.suppress_multiple_database_warning</code>.</p>
<p><em>Eike Send</em></p>
</li>
<li>
<p>Add table to error for duplicate column definitions.</p>
<p>If a migration defines duplicate columns for a table, the error message</p>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p>Fix erroneous nil default precision on virtual datetime columns.</p>
<p>Prior to this change, virtual datetime columns did not have the same</p>
<div data-snippet-clipboard-copy-content="t.virtual :name, type: datetime,                 as: &#34;expression&#34;
t.virtual :name, type: datetime, precision: nil, as: &#34;expression&#34;"><pre><code>t.virtual :name, type: datetime,                 as: &#34;expression&#34;
t.virtual :name, type: datetime, precision: nil, as: &#34;expression&#34;
</code></pre></div>
<p>This change fixes the default precision lookup, so virtual and regular</p>
<p><em>Sam Bostock</em></p>
</li>
<li>
<p>Use connection from <code>#with_raw_connection</code> in <code>#quote_string</code>.</p>
<p>This ensures that the string quoting is wrapped in the reconnect and retry logic</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Add <code>expires_at</code> option to <code>signed_id</code>.</p>
<p><em>Shouichi Kamiya</em></p>
</li>
<li>
<p>Allow applications to set retry deadline for query retries.</p>
<p>Building on the work done in <a data-error-text="Failed to load title" data-id="1154273875" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/44576" data-hovercard-type="pull_request" data-hovercard-url="/rails/rails/pull/44576/hovercard" href="https://github.com/rails/rails/pull/44576">#44576</a> and <a data-error-text="Failed to load title" data-id="1155775285" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/44591" data-hovercard-type="pull_request" data-hovercard-url="/rails/rails/pull/44591/hovercard" href="https://github.com/rails/rails/pull/44591">#44591</a>, we extend the logic that automatically</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Fix a case where the query cache can return wrong values. See <a data-error-text="Failed to load title" data-id="1374793684" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/46044" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/46044/hovercard" href="https://github.com/rails/rails/issues/46044">#46044</a></p>
<p><em>Aaron Patterson</em></p>
</li>
<li>
<p>Support MySQL&#39;s ssl-mode option for MySQLDatabaseTasks.</p>
<p>Verifying the identity of the database server requires setting the ssl-mode</p>
<p><em>Petrik de Heus</em></p>
</li>
<li>
<p>Move <code>ActiveRecord::InternalMetadata</code> to an independent object.</p>
<p><code>ActiveRecord::InternalMetadata</code> no longer inherits from <code>ActiveRecord::Base</code> and is now an independent object that should be instantiated with a <code>connection</code>. This class is private and should not be used by applications directly. If you want to interact with the schema migrations table, please access it on the connection directly, for example: <code>ActiveRecord::Base.connection.schema_migration</code>.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Deprecate quoting <code>ActiveSupport::Duration</code> as an integer</p>
<p>Using ActiveSupport::Duration as an interpolated bind parameter in a SQL</p>
<div data-snippet-clipboard-copy-content="Record.where(&#34;duration = ?&#34;, 1.hour.to_i)"><pre><code>Record.where(&#34;duration = ?&#34;, 1.hour.to_i)
</code></pre></div>
<p>If you want to use a duration as an ISO 8601 string:</p>
<div data-snippet-clipboard-copy-content="Record.where(&#34;duration = ?&#34;, 1.hour.iso8601)"><pre><code>Record.where(&#34;duration = ?&#34;, 1.hour.iso8601)
</code></pre></div>
<p><em>Aram Greenman</em></p>
</li>
<li>
<p>Allow <code>QueryMethods#in_order_of</code> to order by a string column name.</p>
<div data-snippet-clipboard-copy-content="Post.in_order_of(&#34;id&#34;, [4,2,3,1]).to_a
Post.joins(:author).in_order_of(&#34;authors.name&#34;, [&#34;Bob&#34;, &#34;Anna&#34;, &#34;John&#34;]).to_a"><pre><span>Post</span><span>.</span><span>in_order_of</span><span>(</span><span>&#34;id&#34;</span><span>,</span> <span>[</span><span>4</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>1</span><span>]</span><span>)</span><span>.</span><span>to_a</span>
<span>Post</span><span>.</span><span>joins</span><span>(</span><span>:author</span><span>)</span><span>.</span><span>in_order_of</span><span>(</span><span>&#34;authors.name&#34;</span><span>,</span> <span>[</span><span>&#34;Bob&#34;</span><span>,</span> <span>&#34;Anna&#34;</span><span>,</span> <span>&#34;John&#34;</span><span>]</span><span>)</span><span>.</span><span>to_a</span></pre></div>
<p><em>Igor Kasyanchuk</em></p>
</li>
<li>
<p>Move <code>ActiveRecord::SchemaMigration</code> to an independent object.</p>
<p><code>ActiveRecord::SchemaMigration</code> no longer inherits from <code>ActiveRecord::Base</code> and is now an independent object that should be instantiated with a <code>connection</code>. This class is private and should not be used by applications directly. If you want to interact with the schema migrations table, please access it on the connection directly, for example: <code>ActiveRecord::Base.connection.schema_migration</code>.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Deprecate <code>all_connection_pools</code> and make <code>connection_pool_list</code> more explicit.</p>
<p>Following on <a data-error-text="Failed to load title" data-id="1359250964" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/45924" data-hovercard-type="pull_request" data-hovercard-url="/rails/rails/pull/45924/hovercard" href="https://github.com/rails/rails/pull/45924">#45924</a> <code>all_connection_pools</code> is now deprecated. <code>connection_pool_list</code> will either take an explicit role or applications can opt into the new behavior by passing <code>:all</code>.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Fix connection handler methods to operate on all pools.</p>
<p><code>active_connections?</code>, <code>clear_active_connections!</code>, <code>clear_reloadable_connections!</code>, <code>clear_all_connections!</code>, and <code>flush_idle_connections!</code> now operate on all pools by default. Previously they would default to using the <code>current_role</code> or <code>:writing</code> role unless specified.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Allow ActiveRecord::QueryMethods#select to receive hash values.</p>
<p>Currently, <code>select</code> might receive only raw sql and symbols to define columns and aliases to select.</p>
<p>With this change we can provide <code>hash</code> as argument, for example:</p>
<div data-snippet-clipboard-copy-content="Post.joins(:comments).select(posts: [:id, :title, :created_at], comments: [:id, :body, :author_id])
#=&gt; &#34;SELECT \&#34;posts\&#34;.\&#34;id\&#34;, \&#34;posts\&#34;.\&#34;title\&#34;, \&#34;posts\&#34;.\&#34;created_at\&#34;, \&#34;comments\&#34;.\&#34;id\&#34;, \&#34;comments\&#34;.\&#34;body\&#34;, \&#34;comments\&#34;.\&#34;author_id\&#34;
#   FROM \&#34;posts\&#34; INNER JOIN \&#34;comments\&#34; ON \&#34;comments\&#34;.\&#34;post_id\&#34; = \&#34;posts\&#34;.\&#34;id\&#34;&#34;

Post.joins(:comments).select(posts: { id: :post_id, title: :post_title }, comments: { id: :comment_id, body: :comment_body })
#=&gt; &#34;SELECT posts.id as post_id, posts.title as post_title, comments.id as comment_id, comments.body as comment_body
#    FROM \&#34;posts\&#34; INNER JOIN \&#34;comments\&#34; ON \&#34;comments\&#34;.\&#34;post_id\&#34; = \&#34;posts\&#34;.\&#34;id\&#34;&#34;"><pre><span>Post</span><span>.</span><span>joins</span><span>(</span><span>:comments</span><span>)</span><span>.</span><span>select</span><span>(</span><span>posts</span>: <span>[</span><span>:id</span><span>,</span> <span>:title</span><span>,</span> <span>:created_at</span><span>]</span><span>,</span> <span>comments</span>: <span>[</span><span>:id</span><span>,</span> <span>:body</span><span>,</span> <span>:author_id</span><span>]</span><span>)</span>
<span>#=&gt; &#34;SELECT \&#34;posts\&#34;.\&#34;id\&#34;, \&#34;posts\&#34;.\&#34;title\&#34;, \&#34;posts\&#34;.\&#34;created_at\&#34;, \&#34;comments\&#34;.\&#34;id\&#34;, \&#34;comments\&#34;.\&#34;body\&#34;, \&#34;comments\&#34;.\&#34;author_id\&#34;</span>
<span>#   FROM \&#34;posts\&#34; INNER JOIN \&#34;comments\&#34; ON \&#34;comments\&#34;.\&#34;post_id\&#34; = \&#34;posts\&#34;.\&#34;id\&#34;&#34;</span>

<span>Post</span><span>.</span><span>joins</span><span>(</span><span>:comments</span><span>)</span><span>.</span><span>select</span><span>(</span><span>posts</span>: <span>{</span> <span>id</span>: <span>:post_id</span><span>,</span> <span>title</span>: <span>:post_title</span> <span>}</span><span>,</span> <span>comments</span>: <span>{</span> <span>id</span>: <span>:comment_id</span><span>,</span> <span>body</span>: <span>:comment_body</span> <span>}</span><span>)</span>
<span>#=&gt; &#34;SELECT posts.id as post_id, posts.title as post_title, comments.id as comment_id, comments.body as comment_body</span>
<span>#    FROM \&#34;posts\&#34; INNER JOIN \&#34;comments\&#34; ON \&#34;comments\&#34;.\&#34;post_id\&#34; = \&#34;posts\&#34;.\&#34;id\&#34;&#34;</span></pre></div>
<p><em>Oleksandr Holubenko</em>, <em>Josef Šimánek</em>, <em>Jean Boussier</em></p>
</li>
<li>
<p>Adapts virtual attributes on <code>ActiveRecord::Persistence#becomes</code>.</p>
<p>When source and target classes have a different set of attributes adapts</p>
<div data-snippet-clipboard-copy-content="class Person &lt; ApplicationRecord
end

class WebUser &lt; Person
  attribute :is_admin, :boolean
  after_initialize :set_admin

  def set_admin
    write_attribute(:is_admin, email =~ /@ourcompany\.com$/)
  end
end

person = Person.find_by(email: &#34;email@ourcompany.com&#34;)
person.respond_to? :is_admin
# =&gt; false
person.becomes(WebUser).is_admin?
# =&gt; true"><pre><span>class</span> <span>Person</span> &lt; <span>ApplicationRecord</span>
<span>end</span>

<span>class</span> <span>WebUser</span> &lt; <span>Person</span>
  <span>attribute</span> <span>:is_admin</span><span>,</span> <span>:boolean</span>
  <span>after_initialize</span> <span>:set_admin</span>

  <span>def</span> <span>set_admin</span>
    <span>write_attribute</span><span>(</span><span>:is_admin</span><span>,</span> <span>email</span> =~ <span>/@ourcompany<span>\.</span>com$/</span><span>)</span>
  <span>end</span>
<span>end</span>

<span>person</span> <span>=</span> <span>Person</span><span>.</span><span>find_by</span><span>(</span><span>email</span>: <span>&#34;email@ourcompany.com&#34;</span><span>)</span>
<span>person</span><span>.</span><span>respond_to?</span> <span>:is_admin</span>
<span># =&gt; false</span>
<span>person</span><span>.</span><span>becomes</span><span>(</span><span>WebUser</span><span>)</span><span>.</span><span>is_admin?</span>
<span># =&gt; true</span></pre></div>
<p><em>Jacopo Beschi</em>, <em>Sampson Crowley</em></p>
</li>
<li>
<p>Fix <code>ActiveRecord::QueryMethods#in_order_of</code> to include <code>nil</code>s, to match the</p>
<p>For example, <code>Post.in_order_of(:title, [nil, &#34;foo&#34;])</code> will now include posts</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Optimize <code>add_timestamps</code> to use a single SQL statement.</p>

<p>Now results in the following SQL:</p>
<div data-snippet-clipboard-copy-content="ALTER TABLE &#34;my_table&#34; ADD COLUMN &#34;created_at&#34; datetime(6) NOT NULL, ADD COLUMN &#34;updated_at&#34; datetime(6) NOT NULL"><pre><span>ALTER</span> <span>TABLE</span> <span><span>&#34;</span>my_table<span>&#34;</span></span> ADD COLUMN <span><span>&#34;</span>created_at<span>&#34;</span></span> datetime(<span>6</span>) <span>NOT NULL</span>, ADD COLUMN <span><span>&#34;</span>updated_at<span>&#34;</span></span> datetime(<span>6</span>) <span>NOT NULL</span></pre></div>
<p><em>Iliana Hadzhiatanasova</em></p>
</li>
<li>
<p>Add <code>drop_enum</code> migration command for PostgreSQL</p>
<p>This does the inverse of <code>create_enum</code>. Before dropping an enum, ensure you have</p>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Adds support for <code>if_exists</code> option when removing a check constraint.</p>
<p>The <code>remove_check_constraint</code> method now accepts an <code>if_exists</code> option. If set</p>
<p><em>Margaret Parsa</em> and <em>Aditya Bhutani</em></p>
</li>
<li>
<p><code>find_or_create_by</code> now try to find a second time if it hits a unicity constraint.</p>
<p><code>find_or_create_by</code> always has been inherently racy, either creating multiple</p>
<p><code>create_or_find_by</code> was introduced for this use case, however it&#39;s quite wasteful</p>
<p>So for case where most of the time the record is expected to exist, <code>find_or_create_by</code></p>
<p><em>Jean Boussier</em>, <em>Alex Kitchens</em></p>
</li>
<li>
<p>Introduce a simpler constructor API for ActiveRecord database adapters.</p>
<p>Previously the adapter had to know how to build a new raw connection to</p>
<p>When manually creating an adapter instance, it will now accept a single</p>
<p><em>Matthew Draper</em></p>
</li>
<li>
<p>Avoid redundant <code>SELECT 1</code> connection-validation query during DB pool</p>
<p>If the first query run during a request is known to be idempotent, it can be</p>
<p><em>Matthew Draper</em></p>
</li>
<li>
<p>Automatically reconnect broken database connections when safe, even</p>
<p>When an error occurs while attempting to run a known-idempotent query, and</p>
<p>This new default should always be safe -- to support that, it&#39;s consciously</p>
<p><em>Matthew Draper</em></p>
</li>
<li>
<p>Avoid removing a PostgreSQL extension when there are dependent objects.</p>
<p>Previously, removing an extension also implicitly removed dependent objects. Now, this will raise an error.</p>
<p>You can force removing the extension:</p>
<div data-snippet-clipboard-copy-content="disable_extension :citext, force: :cascade"><pre><span>disable_extension</span> <span>:citext</span><span>,</span> <span>force</span>: <span>:cascade</span></pre></div>
<p>Fixes <a data-error-text="Failed to load title" data-id="228722817" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/29091" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/29091/hovercard" href="https://github.com/rails/rails/issues/29091">#29091</a>.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Allow nested functions as safe SQL string</p>
<p><em>Michael Siegfried</em></p>
</li>
<li>
<p>Allow <code>destroy_association_async_job=</code> to be configured with a class string instead of a constant.</p>
<p>Defers an autoloading dependency between <code>ActiveRecord::Base</code> and <code>ActiveJob::Base</code></p>
<p>Deprecates <code>ActiveRecord::ActiveJobRequiredError</code> and now raises a <code>NameError</code></p>
<p><em>Ben Sheldon</em></p>
</li>
<li>
<p>Fix <code>ActiveRecord::Store</code> to serialize as a regular Hash</p>
<p>Previously it would serialize as an <code>ActiveSupport::HashWithIndifferentAccess</code></p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Add <code>timestamptz</code> as a time zone aware type for PostgreSQL</p>
<p>This is required for correctly parsing <code>timestamp with time zone</code> values in your database.</p>
<p>If you don&#39;t want this, you can opt out by adding this initializer:</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::Base.time_zone_aware_types -= [:timestamptz]"><pre><span>ActiveRecord</span>::<span>Base</span><span>.</span><span>time_zone_aware_types</span> -= <span>[</span><span>:timestamptz</span><span>]</span></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Add new <code>ActiveRecord::Base.generates_token_for</code> API.</p>
<p>Currently, <code>signed_id</code> fulfills the role of generating tokens for e.g.</p>
<p>With <code>generates_token_for</code>, a token can embed data from a record.  When</p>
<div data-snippet-clipboard-copy-content="class User &lt; ActiveRecord::Base
  has_secure_password

  generates_token_for :password_reset, expires_in: 15.minutes do
    # A password&#39;s BCrypt salt changes when the password is updated.
    # By embedding (part of) the salt in a token, the token will
    # expire when the password is updated.
    BCrypt::Password.new(password_digest).salt[-10..]
  end
end

user = User.first
token = user.generate_token_for(:password_reset)

User.find_by_token_for(:password_reset, token) # =&gt; user

user.update!(password: &#34;new password&#34;)
User.find_by_token_for(:password_reset, token) # =&gt; nil"><pre><span>class</span> <span>User</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>has_secure_password</span>

  <span>generates_token_for</span> <span>:password_reset</span><span>,</span> <span>expires_in</span>: <span>15</span><span>.</span><span>minutes</span> <span>do</span>
    <span># A password&#39;s BCrypt salt changes when the password is updated.</span>
    <span># By embedding (part of) the salt in a token, the token will</span>
    <span># expire when the password is updated.</span>
    <span>BCrypt</span>::<span>Password</span><span>.</span><span>new</span><span>(</span><span>password_digest</span><span>)</span><span>.</span><span>salt</span><span>[</span>-<span>10</span>..<span>]</span>
  <span>end</span>
<span>end</span>

<span>user</span> <span>=</span> <span>User</span><span>.</span><span>first</span>
<span>token</span> <span>=</span> <span>user</span><span>.</span><span>generate_token_for</span><span>(</span><span>:password_reset</span><span>)</span>

<span>User</span><span>.</span><span>find_by_token_for</span><span>(</span><span>:password_reset</span><span>,</span> <span>token</span><span>)</span> <span># =&gt; user</span>

<span>user</span><span>.</span><span>update!</span><span>(</span><span>password</span>: <span>&#34;new password&#34;</span><span>)</span>
<span>User</span><span>.</span><span>find_by_token_for</span><span>(</span><span>:password_reset</span><span>,</span> <span>token</span><span>)</span> <span># =&gt; nil</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
<li>
<p>Optimize Active Record batching for whole table iterations.</p>
<p>Previously, <code>in_batches</code> got all the ids and constructed an <code>IN</code>-based query for each batch.</p>
<p>Now, whole table iterations use range iteration (<code>id &gt;= x AND id &lt;= y</code>) by default which can make iteration</p>
<p>Only whole table iterations use this style of iteration by default. You can disable this behavior by passing <code>use_ranges: false</code>.</p>
<div data-snippet-clipboard-copy-content="Project.where(archived_at: nil).in_batches(use_ranges: true) do |relation|
  # do something
end"><pre><span>Project</span><span>.</span><span>where</span><span>(</span><span>archived_at</span>: <span>nil</span><span>)</span><span>.</span><span>in_batches</span><span>(</span><span>use_ranges</span>: <span>true</span><span>)</span> <span>do</span> |<span>relation</span>|
  <span># do something</span>
<span>end</span></pre></div>
<p>See <a data-error-text="Failed to load title" data-id="1277547479" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/45414" data-hovercard-type="pull_request" data-hovercard-url="/rails/rails/pull/45414/hovercard" href="https://github.com/rails/rails/pull/45414">#45414</a> for more details.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p><code>.with</code> query method added. Construct common table expressions with ease and get <code>ActiveRecord::Relation</code> back.</p>
<div data-snippet-clipboard-copy-content="Post.with(posts_with_comments: Post.where(&#34;comments_count &gt; ?&#34;, 0))
# =&gt; ActiveRecord::Relation
# WITH posts_with_comments AS (SELECT * FROM posts WHERE (comments_count &gt; 0)) SELECT * FROM posts"><pre><span>Post</span><span>.</span><span>with</span><span>(</span><span>posts_with_comments</span>: <span>Post</span><span>.</span><span>where</span><span>(</span><span>&#34;comments_count &gt; ?&#34;</span><span>,</span> <span>0</span><span>)</span><span>)</span>
<span># =&gt; ActiveRecord::Relation</span>
<span># WITH posts_with_comments AS (SELECT * FROM posts WHERE (comments_count &gt; 0)) SELECT * FROM posts</span></pre></div>
<p><em>Vlado Cingel</em></p>
</li>
<li>
<p>Don&#39;t establish a new connection if an identical pool exists already.</p>
<p>Previously, if <code>establish_connection</code> was called on a class that already had an established connection, the existing connection would be removed regardless of whether it was the same config. Now if a pool is found with the same values as the new connection, the existing connection will be returned instead of creating a new one.</p>
<p>This has a slight change in behavior if application code is depending on a new connection being established regardless of whether it&#39;s identical to an existing connection. If the old behavior is desirable, applications should call <code>ActiveRecord::Base#remove_connection</code> before establishing a new one. Calling <code>establish_connection</code> with a different config works the same way as it did previously.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p>Update <code>db:prepare</code> task to load schema when an uninitialized database exists, and dump schema after migrations.</p>
<p><em>Ben Sheldon</em></p>
</li>
<li>
<p>Fix supporting timezone awareness for <code>tsrange</code> and <code>tstzrange</code> array columns.</p>
<div data-snippet-clipboard-copy-content="# In database migrations
add_column :shops, :open_hours, :tsrange, array: true
# In app config
ActiveRecord::Base.time_zone_aware_types += [:tsrange]
# In the code times are properly converted to app time zone
Shop.create!(open_hours: [Time.current..8.hour.from_now])"><pre><span># In database migrations</span>
<span>add_column</span> <span>:shops</span><span>,</span> <span>:open_hours</span><span>,</span> <span>:tsrange</span><span>,</span> <span>array</span>: <span>true</span>
<span># In app config</span>
<span>ActiveRecord</span>::<span>Base</span><span>.</span><span>time_zone_aware_types</span> += <span>[</span><span>:tsrange</span><span>]</span>
<span># In the code times are properly converted to app time zone</span>
<span>Shop</span><span>.</span><span>create!</span><span>(</span><span>open_hours</span>: <span>[</span><span>Time</span><span>.</span><span>current</span>..<span>8</span><span>.</span><span>hour</span><span>.</span><span>from_now</span><span>]</span><span>)</span></pre></div>
<p><em>Wojciech Wnętrzak</em></p>
</li>
<li>
<p>Introduce strategy pattern for executing migrations.</p>
<p>By default, migrations will use a strategy object that delegates the method</p>
<p><em>Adrianna Chang</em></p>
</li>
<li>
<p>Add adapter option disallowing foreign keys</p>
<p>This adds a new option to be added to <code>database.yml</code> which enables skipping</p>
<p>Usage:</p>
<div data-snippet-clipboard-copy-content="development:
    &lt;&lt;: *default
    database: storage/development.sqlite3
    foreign_keys: false"><pre><span>development</span>:
    <span>&lt;&lt;</span>: <span>*default</span>
    <span>database</span>: <span>storage/development.sqlite3</span>
    <span>foreign_keys</span>: <span>false</span></pre></div>
<p><em>Paulo Barros</em></p>
</li>
<li>
<p>Add configurable deprecation warning for singular associations</p>
<p>This adds a deprecation warning when using the plural name of a singular associations in <code>where</code>.</p>
<p><em>Adam Hess</em></p>
</li>
<li>
<p>Run transactional callbacks on the freshest instance to save a given</p>
<p>When multiple Active Record instances change the same record within a</p>
<p>When <code>config.active_record.run_commit_callbacks_on_first_saved_instances_in_transaction</code></p>
<p>When it is <code>false</code>, which is the new framework default starting with version</p>
<ul>
<li>In general, run transactional callbacks on the last instance to save a</li>
<li>There are two exceptions:
<ul>
<li>If the record is created within the transaction, then updated by</li>
<li>If the record is destroyed within the transaction, then</li>
</ul>
</li>
</ul>
<p><em>Cameron Bothner and Mitch Vollebregt</em></p>
</li>
<li>
<p>Enable strict strings mode for <code>SQLite3Adapter</code>.</p>
<p>Configures SQLite with a strict strings mode, which disables double-quoted string literals.</p>
<p>SQLite has some quirks around double-quoted string literals.</p>
<p>If you don&#39;t want this behavior, you can disable it via:</p>
<div data-snippet-clipboard-copy-content="# config/application.rb
config.active_record.sqlite3_adapter_strict_strings_by_default = false"><pre><span># config/application.rb</span>
<span>config</span><span>.</span><span>active_record</span><span>.</span><span>sqlite3_adapter_strict_strings_by_default</span> <span>=</span> <span>false</span></pre></div>
<p>Fixes <a data-error-text="Failed to load title" data-id="202667093" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/27782" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/27782/hovercard" href="https://github.com/rails/rails/issues/27782">#27782</a>.</p>
<p><em>fatkodima</em>, <em>Jean Boussier</em></p>
</li>
<li>
<p>Resolve issue where a relation cache_version could be left stale.</p>
<p>Previously, when <code>reset</code> was called on a relation object it did not reset the cache_versions</p>
<p>Usage:</p>
<div data-snippet-clipboard-copy-content="developers = Developer.all
developers.cache_version

Developer.update_all(updated_at: Time.now.utc + 1.second)

developers.cache_version # Stale cache_version
developers.reset
developers.cache_version # Returns the current correct cache_version"><pre><span>developers</span> <span>=</span> <span>Developer</span><span>.</span><span>all</span>
<span>developers</span><span>.</span><span>cache_version</span>

<span>Developer</span><span>.</span><span>update_all</span><span>(</span><span>updated_at</span>: <span>Time</span><span>.</span><span>now</span><span>.</span><span>utc</span> + <span>1</span><span>.</span><span>second</span><span>)</span>

<span>developers</span><span>.</span><span>cache_version</span> <span># Stale cache_version</span>
<span>developers</span><span>.</span><span>reset</span>
<span>developers</span><span>.</span><span>cache_version</span> <span># Returns the current correct cache_version</span></pre></div>
<p>Fixes <a data-error-text="Failed to load title" data-id="1269654145" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/45341" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/45341/hovercard" href="https://github.com/rails/rails/issues/45341">#45341</a>.</p>
<p><em>Austen Madden</em></p>
</li>
<li>
<p>Add support for exclusion constraints (PostgreSQL-only).</p>
<div data-snippet-clipboard-copy-content="add_exclusion_constraint :invoices, &#34;daterange(start_date, end_date) WITH &amp;&amp;&#34;, using: :gist, name: &#34;invoices_date_overlap&#34;
remove_exclusion_constraint :invoices, name: &#34;invoices_date_overlap&#34;"><pre><span>add_exclusion_constraint</span> <span>:invoices</span><span>,</span> <span>&#34;daterange(start_date, end_date) WITH &amp;&amp;&#34;</span><span>,</span> <span>using</span>: <span>:gist</span><span>,</span> <span>name</span>: <span>&#34;invoices_date_overlap&#34;</span>
<span>remove_exclusion_constraint</span> <span>:invoices</span><span>,</span> <span>name</span>: <span>&#34;invoices_date_overlap&#34;</span></pre></div>
<p>See PostgreSQL&#39;s <a href="https://www.postgresql.org/docs/12/sql-createtable.html#SQL-CREATETABLE-EXCLUDE" rel="nofollow"><code>CREATE TABLE ... EXCLUDE ...</code></a> documentation for more on exclusion constraints.</p>
<p><em>Alex Robbin</em></p>
</li>
<li>
<p><code>change_column_null</code> raises if a non-boolean argument is provided</p>
<p>Previously if you provided a non-boolean argument, <code>change_column_null</code> would</p>
<div data-snippet-clipboard-copy-content="change_column_null :table, :column, true # good
change_column_null :table, :column, false # good
change_column_null :table, :column, from: true, to: false # raises (previously this made the column nullable)"><pre><span>change_column_null</span> <span>:table</span><span>,</span> <span>:column</span><span>,</span> <span>true</span> <span># good</span>
<span>change_column_null</span> <span>:table</span><span>,</span> <span>:column</span><span>,</span> <span>false</span> <span># good</span>
<span>change_column_null</span> <span>:table</span><span>,</span> <span>:column</span><span>,</span> <span>from</span>: <span>true</span><span>,</span> <span>to</span>: <span>false</span> <span># raises (previously this made the column nullable)</span></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Enforce limit on table names length.</p>
<p>Fixes <a data-error-text="Failed to load title" data-id="1241820374" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/45130" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/45130/hovercard" href="https://github.com/rails/rails/issues/45130">#45130</a>.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Adjust the minimum MariaDB version for check constraints support.</p>
<p><em>Eddie Lebow</em></p>
</li>
<li>
<p>Fix Hstore deserialize regression.</p>
<p><em>edsharp</em></p>
</li>
<li>
<p>Add validity for PostgreSQL indexes.</p>
<div data-snippet-clipboard-copy-content="connection.index_exists?(:users, :email, valid: true)
connection.indexes(:users).select(&amp;:valid?)"><pre><span>connection</span><span>.</span><span>index_exists?</span><span>(</span><span>:users</span><span>,</span> <span>:email</span><span>,</span> <span>valid</span>: <span>true</span><span>)</span>
<span>connection</span><span>.</span><span>indexes</span><span>(</span><span>:users</span><span>)</span><span>.</span><span>select</span><span>(</span>&amp;<span>:valid?</span><span>)</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Fix eager loading for models without primary keys.</p>
<p><em>Anmol Chopra</em>, <em>Matt Lawrence</em>, and <em>Jonathan Hefner</em></p>
</li>
<li>
<p>Avoid validating a unique field if it has not changed and is backed by a unique index.</p>
<p>Previously, when saving a record, Active Record will perform an extra query to check for the</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Stop setting <code>sql_auto_is_null</code></p>
<p>Since version 5.5 the default has been off, we no longer have to manually turn it off.</p>
<p><em>Adam Hess</em></p>
</li>
<li>
<p>Fix <code>touch</code> to raise an error for readonly columns.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Add ability to ignore tables by regexp for SQL schema dumps.</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::SchemaDumper.ignore_tables = [/^_/]"><pre><span>ActiveRecord</span>::<span>SchemaDumper</span><span>.</span><span>ignore_tables</span> <span>=</span> <span>[</span><span>/^_/</span><span>]</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Avoid queries when performing calculations on contradictory relations.</p>
<p>Previously calculations would make a query even when passed a</p>
<p>This applies to the following calculations: <code>count</code>, <code>sum</code>, <code>average</code>,</p>
<p><em>Luan Vieira, John Hawthorn and Daniel Colson</em></p>
</li>
<li>
<p>Allow using aliased attributes with <code>insert_all</code>/<code>upsert_all</code>.</p>
<div data-snippet-clipboard-copy-content="class Book &lt; ApplicationRecord
  alias_attribute :title, :name
end

Book.insert_all [{ title: &#34;Remote&#34;, author_id: 1 }], returning: :title"><pre><span>class</span> <span>Book</span> &lt; <span>ApplicationRecord</span>
  <span>alias_attribute</span> <span>:title</span><span>,</span> <span>:name</span>
<span>end</span>

<span>Book</span><span>.</span><span>insert_all</span> <span>[</span><span>{</span> <span>title</span>: <span>&#34;Remote&#34;</span><span>,</span> <span>author_id</span>: <span>1</span> <span>}</span><span>]</span><span>,</span> <span>returning</span>: <span>:title</span></pre></div>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Support encrypted attributes on columns with default db values.</p>
<p>This adds support for encrypted attributes defined on columns with default values.</p>
<p><em>Jorge Manrubia</em> and <em>Dima Fatko</em></p>
</li>
<li>
<p>Allow overriding <code>reading_request?</code> in <code>DatabaseSelector::Resolver</code></p>
<p>The default implementation checks if a request is a <code>get?</code> or <code>head?</code>,</p>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Remove <code>ActiveRecord.legacy_connection_handling</code>.</p>
<p><em>Eileen M. Uchitelle</em></p>
</li>
<li>
<p><code>rails db:schema:{dump,load}</code> now checks <code>ENV[&#34;SCHEMA_FORMAT&#34;]</code> before config</p>
<p>Since <code>rails db:structure:{dump,load}</code> was deprecated there wasn&#39;t a simple</p>
<div data-snippet-clipboard-copy-content="SCHEMA_FORMAT=sql rake db:schema:dump"><pre><code>SCHEMA_FORMAT=sql rake db:schema:dump
</code></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Fixed MariaDB default function support.</p>
<p>Defaults would be written wrong in &#34;db/schema.rb&#34; and not work correctly</p>
<p><em>kaspernj</em></p>
</li>
<li>
<p>Add <code>active_record.destroy_association_async_batch_size</code> configuration</p>
<p>This allows applications to specify the maximum number of records that will</p>
<p><em>Nick Holden</em></p>
</li>
<li>
<p>Fix <code>remove_foreign_key</code> with <code>:if_exists</code> option when foreign key actually exists.</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Remove <code>--no-comments</code> flag in structure dumps for PostgreSQL</p>
<p>This broke some apps that used custom schema comments. If you don&#39;t want</p>
<div data-snippet-clipboard-copy-content="ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = [&#39;--no-comments&#39;]"><pre><span>ActiveRecord</span>::<span>Tasks</span>::<span>DatabaseTasks</span><span>.</span><span>structure_dump_flags</span> <span>=</span> <span>[</span><span>&#39;--no-comments&#39;</span><span>]</span></pre></div>
<p><em>Alex Ghiculescu</em></p>
</li>
<li>
<p>Reduce the memory footprint of fixtures accessors.</p>
<p>Until now fixtures accessors were eagerly defined using <code>define_method</code>.</p>
<p>Instead fixtures accessors are now implemented with <code>method_missing</code>,</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Fix <code>config.active_record.destroy_association_async_job</code> configuration</p>
<p><code>config.active_record.destroy_association_async_job</code> should allow</p>
<p><em>Nick Holden</em></p>
</li>
<li>
<p>Fix <code>change_column_comment</code> to preserve column&#39;s AUTO_INCREMENT in the MySQL adapter</p>
<p><em>fatkodima</em></p>
</li>
<li>
<p>Fix quoting of <code>ActiveSupport::Duration</code> and <code>Rational</code> numbers in the MySQL adapter.</p>
<p><em>Kevin McPhillips</em></p>
</li>
<li>
<p>Allow column name with COLLATE (e.g., title COLLATE &#34;C&#34;) as safe SQL string</p>
<p><em>Shugo Maeda</em></p>
</li>
<li>
<p>Permit underscores in the VERSION argument to database rake tasks.</p>
<p><em>Eddie Lebow</em></p>
</li>
<li>
<p>Reversed the order of <code>INSERT</code> statements in <code>structure.sql</code> dumps</p>
<p>This should decrease the likelihood of merge conflicts. New migrations</p>
<p>For existing apps, there will be a large diff the next time <code>structure.sql</code></p>
<p><em>Alex Ghiculescu</em>, <em>Matt Larraz</em></p>
</li>
<li>
<p>Fix PG.connect keyword arguments deprecation warning on ruby 2.7</p>
<p>Fixes <a data-error-text="Failed to load title" data-id="1121266570" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/44307" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/44307/hovercard" href="https://github.com/rails/rails/issues/44307">#44307</a>.</p>
<p><em>Nikita Vasilevsky</em></p>
</li>
<li>
<p>Fix dropping DB connections after serialization failures and deadlocks.</p>
<p>Prior to 6.1.4, serialization failures and deadlocks caused rollbacks to be</p>
<p>6.1.4 removed these rollbacks, for both transactions and savepoints, causing</p>
<p>These rollbacks are now restored, except for savepoints on MySQL.</p>
<p><em>Thomas Morgan</em></p>
</li>
<li>
<p>Make <code>ActiveRecord::ConnectionPool</code> Fiber-safe</p>
<p>When <code>ActiveSupport::IsolatedExecutionState.isolation_level</code> is set to <code>:fiber</code>,</p>
<p><em>Alex Matchneer</em></p>
</li>
<li>
<p>Add <code>update_attribute!</code> to <code>ActiveRecord::Persistence</code></p>
<p>Similar to <code>update_attribute</code>, but raises <code>ActiveRecord::RecordNotSaved</code> when a <code>before_*</code> callback throws <code>:abort</code>.</p>
<div data-snippet-clipboard-copy-content="class Topic &lt; ActiveRecord::Base
  before_save :check_title

  def check_title
    throw(:abort) if title == &#34;abort&#34;
  end
end

topic = Topic.create(title: &#34;Test Title&#34;)
# #=&gt; #&lt;Topic title: &#34;Test Title&#34;&gt;
topic.update_attribute!(:title, &#34;Another Title&#34;)
# #=&gt; #&lt;Topic title: &#34;Another Title&#34;&gt;
topic.update_attribute!(:title, &#34;abort&#34;)
# raises ActiveRecord::RecordNotSaved"><pre><span>class</span> <span>Topic</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>before_save</span> <span>:check_title</span>

  <span>def</span> <span>check_title</span>
    <span>throw</span><span>(</span><span>:abort</span><span>)</span> <span>if</span> <span>title</span> == <span>&#34;abort&#34;</span>
  <span>end</span>
<span>end</span>

<span>topic</span> <span>=</span> <span>Topic</span><span>.</span><span>create</span><span>(</span><span>title</span>: <span>&#34;Test Title&#34;</span><span>)</span>
<span># #=&gt; #&lt;Topic title: &#34;Test Title&#34;&gt;</span>
<span>topic</span><span>.</span><span>update_attribute!</span><span>(</span><span>:title</span><span>,</span> <span>&#34;Another Title&#34;</span><span>)</span>
<span># #=&gt; #&lt;Topic title: &#34;Another Title&#34;&gt;</span>
<span>topic</span><span>.</span><span>update_attribute!</span><span>(</span><span>:title</span><span>,</span> <span>&#34;abort&#34;</span><span>)</span>
<span># raises ActiveRecord::RecordNotSaved</span></pre></div>
<p><em>Drew Tempelmeyer</em></p>
</li>
<li>
<p>Avoid loading every record in <code>ActiveRecord::Relation#pretty_print</code></p>
<div data-snippet-clipboard-copy-content="# Before
pp Foo.all # Loads the whole table.

# After
pp Foo.all # Shows 10 items and an ellipsis."><pre><span># Before</span>
<span>pp</span> <span>Foo</span><span>.</span><span>all</span> <span># Loads the whole table.</span>

<span># After</span>
<span>pp</span> <span>Foo</span><span>.</span><span>all</span> <span># Shows 10 items and an ellipsis.</span></pre></div>
<p><em>Ulysse Buonomo</em></p>
</li>
<li>
<p>Change <code>QueryMethods#in_order_of</code> to drop records not listed in values.</p>
<p><code>in_order_of</code> now filters down to the values provided, to match the behavior of the <code>Enumerable</code> version.</p>
<p><em>Kevin Newton</em></p>
</li>
<li>
<p>Allow named expression indexes to be revertible.</p>
<p>Previously, the following code would raise an error in a reversible migration executed while rolling back, due to the index name not being used in the index removal.</p>
<div data-snippet-clipboard-copy-content="add_index(:settings, &#34;(data-&gt;&#39;property&#39;)&#34;, using: :gin, name: :index_settings_data_property)"><pre><span>add_index</span><span>(</span><span>:settings</span><span>,</span> <span>&#34;(data-&gt;&#39;property&#39;)&#34;</span><span>,</span> <span>using</span>: <span>:gin</span><span>,</span> <span>name</span>: <span>:index_settings_data_property</span><span>)</span></pre></div>
<p>Fixes <a data-error-text="Failed to load title" data-id="1010891915" data-permission-text="Title is private" data-url="https://github.com/rails/rails/issues/43331" data-hovercard-type="issue" data-hovercard-url="/rails/rails/issues/43331/hovercard" href="https://github.com/rails/rails/issues/43331">#43331</a>.</p>
<p><em>Oliver Günther</em></p>
</li>
<li>
<p>Fix incorrect argument in PostgreSQL structure dump tasks.</p>
<p>Updating the <code>--no-comment</code> argument added in Rails 7 to the correct <code>--no-comments</code> argument.</p>
<p><em>Alex Dent</em></p>
</li>
<li>
<p>Fix migration compatibility to create SQLite references/belongs_to column as integer when migration version is 6.0.</p>
<p>Reference/belongs_to in migrations with version 6.0 were creating columns as</p>
<p><em>Marcelo Lauxen</em></p>
</li>
<li>
<p>Fix <code>QueryMethods#in_order_of</code> to handle empty order list.</p>
<div data-snippet-clipboard-copy-content="Post.in_order_of(:id, []).to_a"><pre><span>Post</span><span>.</span><span>in_order_of</span><span>(</span><span>:id</span><span>,</span> <span>[</span><span>]</span><span>)</span><span>.</span><span>to_a</span></pre></div>
<p>Also more explicitly set the column as secondary order, so that any other</p>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Fix quoting of column aliases generated by calculation methods.</p>
<p>Since the alias is derived from the table name, we can&#39;t assume the result</p>
<div data-snippet-clipboard-copy-content="class Test &lt; ActiveRecord::Base
  self.table_name = &#39;1abc&#39;
end
Test.group(:id).count
# syntax error at or near &#34;1&#34; (ActiveRecord::StatementInvalid)
# LINE 1: SELECT COUNT(*) AS count_all, &#34;1abc&#34;.&#34;id&#34; AS 1abc_id FROM &#34;1..."><pre><span>class</span> <span>Test</span> &lt; <span>ActiveRecord</span>::<span>Base</span>
  <span>self</span><span>.</span><span>table_name</span> <span>=</span> <span>&#39;1abc&#39;</span>
<span>end</span>
<span>Test</span><span>.</span><span>group</span><span>(</span><span>:id</span><span>)</span><span>.</span><span>count</span>
<span># syntax error at or near &#34;1&#34; (ActiveRecord::StatementInvalid)</span>
<span># LINE 1: SELECT COUNT(*) AS count_all, &#34;1abc&#34;.&#34;id&#34; AS 1abc_id FROM &#34;1...</span></pre></div>
<p><em>Jean Boussier</em></p>
</li>
<li>
<p>Add <code>authenticate_by</code> when using <code>has_secure_password</code>.</p>
<p><code>authenticate_by</code> is intended to replace code like the following, which</p>
<div data-snippet-clipboard-copy-content="User.find_by(email: &#34;...&#34;)&amp;.authenticate(&#34;...&#34;)"><pre><span>User</span><span>.</span><span>find_by</span><span>(</span><span>email</span>: <span>&#34;...&#34;</span><span>)</span>&amp;.<span>authenticate</span><span>(</span><span>&#34;...&#34;</span><span>)</span></pre></div>
<p>Such code is vulnerable to timing-based enumeration attacks, wherein an</p>
<p><code>authenticate_by</code> addresses the vulnerability by taking the same amount of</p>
<div data-snippet-clipboard-copy-content="User.authenticate_by(email: &#34;...&#34;, password: &#34;...&#34;)"><pre><span>User</span><span>.</span><span>authenticate_by</span><span>(</span><span>email</span>: <span>&#34;...&#34;</span><span>,</span> <span>password</span>: <span>&#34;...&#34;</span><span>)</span></pre></div>
<p><em>Jonathan Hefner</em></p>
</li>
</div></div>
  </body>
</html>
