<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/keisku/gmon">Original</a>
    <h1>Show HN: Goroutine Monitor Powered by eBPF</h1>
    
    <div id="readability-page-1" class="page"><p dir="auto"><code>gmon</code> is a tool designed to monitor the creation and destruction of goroutines in a Go program, drawing inspiration from the presentation <a href="https://www.usenix.org/conference/srecon23apac/presentation/liang" rel="nofollow">Real World Debugging with eBPF</a>.</p><div data-snippet-clipboard-copy-content="Usage of gmon:
  -level string
    	log level could be one of [&#34;DEBUG&#34; &#34;INFO&#34; &#34;WARN&#34; &#34;ERROR&#34;] (default &#34;INFO&#34;)
  -metrics int
    	Port to be used for metrics server, /metrics endpoint (default 5500)
  -path string
    	Path to executable file to be monitored (required)
  -pid int
    	Useful when tracing programs that have many running instances
  -pprof int
    	Port to be used for pprof server. If 0, pprof server is not started
  -trace string
    	Path to Go runtime/trace output"><pre><code>Usage of gmon:
  -level string
    	log level could be one of [&#34;DEBUG&#34; &#34;INFO&#34; &#34;WARN&#34; &#34;ERROR&#34;] (default &#34;INFO&#34;)
  -metrics int
    	Port to be used for metrics server, /metrics endpoint (default 5500)
  -path string
    	Path to executable file to be monitored (required)
  -pid int
    	Useful when tracing programs that have many running instances
  -pprof int
    	Port to be used for pprof server. If 0, pprof server is not started
  -trace string
    	Path to Go runtime/trace output
</code></pre></div><p dir="auto"><code>gmon</code> logs the creation of goroutines to stdout with stack traces.</p><div dir="auto" data-snippet-clipboard-copy-content="sudo gmon -path /path/to/executable
time=2024-03-20T05:10:57.752Z level=INFO msg=&#34;goroutine is created&#34; goroutine_id=22 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(*connReader).startBackgroundRead stack.4=net/http.(*conn).serve stack.5=net/http.(*Server).Serve.gowrap3 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=&#34;goroutine is created&#34; goroutine_id=21 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(*Server).Serve stack.4=net/http.(*Server).ListenAndServe stack.5=main.main.gowrap1 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=&#34;goroutine is created&#34; goroutine_id=23 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(*Server).Serve stack.4=net/http.(*Server).ListenAndServe stack.5=main.main.gowrap1 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=&#34;goroutine is created&#34; goroutine_id=34 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(*Server).Serve stack.4=net/http.(*Server).ListenAndServe stack.5=main.main.gowrap1 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=&#34;goroutine is created&#34; goroutine_id=24 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(*connReader).startBackgroundRead stack.4=net/http.(*conn).serve stack.5=net/http.(*Server).Serve.gowrap3 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=&#34;goroutine is created&#34; goroutine_id=35 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(*connReader).startBackgroundRead stack.4=net/http.(*conn).serve stack.5=net/http.(*Server).Serve.gowrap3 stack.6=runtime.goexit"><pre>sudo gmon -path /path/to/executable
time=2024-03-20T05:10:57.752Z level=INFO msg=<span><span>&#34;</span>goroutine is created<span>&#34;</span></span> goroutine_id=22 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(<span>*</span>connReader).startBackgroundRead stack.4=net/http.(<span>*</span>conn).serve stack.5=net/http.(<span>*</span>Server).Serve.gowrap3 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=<span><span>&#34;</span>goroutine is created<span>&#34;</span></span> goroutine_id=21 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(<span>*</span>Server).Serve stack.4=net/http.(<span>*</span>Server).ListenAndServe stack.5=main.main.gowrap1 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=<span><span>&#34;</span>goroutine is created<span>&#34;</span></span> goroutine_id=23 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(<span>*</span>Server).Serve stack.4=net/http.(<span>*</span>Server).ListenAndServe stack.5=main.main.gowrap1 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=<span><span>&#34;</span>goroutine is created<span>&#34;</span></span> goroutine_id=34 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(<span>*</span>Server).Serve stack.4=net/http.(<span>*</span>Server).ListenAndServe stack.5=main.main.gowrap1 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=<span><span>&#34;</span>goroutine is created<span>&#34;</span></span> goroutine_id=24 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(<span>*</span>connReader).startBackgroundRead stack.4=net/http.(<span>*</span>conn).serve stack.5=net/http.(<span>*</span>Server).Serve.gowrap3 stack.6=runtime.goexit
time=2024-03-20T05:10:57.752Z level=INFO msg=<span><span>&#34;</span>goroutine is created<span>&#34;</span></span> goroutine_id=35 stack.0=runtime.newproc stack.1=runtime.systemstack stack.2=runtime.newproc stack.3=net/http.(<span>*</span>connReader).startBackgroundRead stack.4=net/http.(<span>*</span>conn).serve stack.5=net/http.(<span>*</span>Server).Serve.gowrap3 stack.6=runtime.goexit</pre></div><p dir="auto"><code>gmon</code> exposes the following metrics in the <a href="https://www.cncf.io/projects/openmetrics/" rel="nofollow">OpenMetrics</a> format on the <code>GET /metrics</code>.</p><div dir="auto" data-snippet-clipboard-copy-content="curl -s http://localhost:5500/metrics

# HELP gmon_goroutine_creation The number of goroutines that have been creaated
# TYPE gmon_goroutine_creation counter
gmon_goroutine_creation{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;} 1
gmon_goroutine_creation{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;net/http.(*Server).Serve.gowrap3&#34;,stack_2=&#34;net/http.(*conn).serve&#34;,stack_3=&#34;net/http.(*connReader).startBackgroundRead&#34;,stack_4=&#34;runtime.newproc&#34;} 3
# HELP gmon_goroutine_exit The number of goroutines that have been exited
# TYPE gmon_goroutine_exit counter
gmon_goroutine_exit{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;net/http.(*Server).Serve.gowrap3&#34;,stack_2=&#34;net/http.(*conn).serve&#34;,stack_3=&#34;net/http.(*connReader).startBackgroundRead&#34;,stack_4=&#34;runtime.newproc&#34;} 3
# HELP gmon_goroutine_uptime Uptime of goroutines in seconds
# TYPE gmon_goroutine_uptime histogram
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;1&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;3&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;5&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;10&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;30&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;60&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;120&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;180&#34;} 2
gmon_goroutine_uptime_bucket{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;,le=&#34;+Inf&#34;} 2
gmon_goroutine_uptime_sum{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;} 0.9001332019999999
gmon_goroutine_uptime_count{stack_0=&#34;runtime.goexit&#34;,stack_1=&#34;main.main.gowrap1&#34;,stack_2=&#34;net/http.(*Server).ListenAndServe&#34;,stack_3=&#34;net/http.(*Server).Serve&#34;,stack_4=&#34;runtime.newproc&#34;} 2
...skip..."><pre>curl -s http://localhost:5500/metrics

<span><span>#</span> HELP gmon_goroutine_creation The number of goroutines that have been creaated</span>
<span><span>#</span> TYPE gmon_goroutine_creation counter</span>
gmon_goroutine_creation{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>} 1
gmon_goroutine_creation{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>net/http.(*Server).Serve.gowrap3<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*conn).serve<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*connReader).startBackgroundRead<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>} 3
<span><span>#</span> HELP gmon_goroutine_exit The number of goroutines that have been exited</span>
<span><span>#</span> TYPE gmon_goroutine_exit counter</span>
gmon_goroutine_exit{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>net/http.(*Server).Serve.gowrap3<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*conn).serve<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*connReader).startBackgroundRead<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>} 3
<span><span>#</span> HELP gmon_goroutine_uptime Uptime of goroutines in seconds</span>
<span><span>#</span> TYPE gmon_goroutine_uptime histogram</span>
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>1<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>3<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>5<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>10<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>30<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>60<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>120<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>180<span>&#34;</span></span>} 2
gmon_goroutine_uptime_bucket{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>,le=<span><span>&#34;</span>+Inf<span>&#34;</span></span>} 2
gmon_goroutine_uptime_sum{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>} 0.9001332019999999
gmon_goroutine_uptime_count{stack_0=<span><span>&#34;</span>runtime.goexit<span>&#34;</span></span>,stack_1=<span><span>&#34;</span>main.main.gowrap1<span>&#34;</span></span>,stack_2=<span><span>&#34;</span>net/http.(*Server).ListenAndServe<span>&#34;</span></span>,stack_3=<span><span>&#34;</span>net/http.(*Server).Serve<span>&#34;</span></span>,stack_4=<span><span>&#34;</span>runtime.newproc<span>&#34;</span></span>} 2
...skip...</pre></div><div dir="auto" data-snippet-clipboard-copy-content="# Build and output the binary to ./bin
./gmon.sh build
# Build and install the binary to /usr/bin
./gmon.sh install
# Run tests
./gmon.sh test"><pre><span><span>#</span> Build and output the binary to ./bin</span>
./gmon.sh build
<span><span>#</span> Build and install the binary to /usr/bin</span>
./gmon.sh install
<span><span>#</span> Run tests</span>
./gmon.sh <span>test</span></pre></div></div>
  </body>
</html>
