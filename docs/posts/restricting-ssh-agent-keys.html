<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/880458/5c4147ec8a7ca8df/">Original</a>
    <h1>Restricting SSH Agent Keys</h1>
    
    <div id="readability-page-1" class="page"><p>

<h2>[LWN subscriber-only content]</h2>
</p><div>
<!-- $Id: slink-none,v 1.2 2005-11-04 22:11:18 corbet Exp $ -->
<blockquote>
<div>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider <a href="https://lwn.net/subscribe/">subscribing to LWN</a>.  Thank you
for visiting LWN.net!
</p></div>
</blockquote>

<p>
The <a href="http://www.openssh.com/">OpenSSH</a> suite of tools for
secure remote logins is used widely within our communities; it also
underlies things like remote Git repository access.
A recent experimental feature for the upcoming OpenSSH 8.9 release
will help close a security hole 
that can be exploited by attacker-controlled SSH servers (e.g. <a href="https://man.openbsd.org/sshd.8"><tt>sshd</tt></a>) when the user is forwarding
authentication to a local <a href="https://man.openbsd.org/ssh-agent.1"><tt>ssh-agent</tt></a>.  Instead
of allowing the keys held in the agent to be used for authenticating to any
host where they might work, <a href="https://www.openssh.com/agent-restrict.html">SSH agent 
restriction</a> will allow users to specify where and how those keys can be
used.
</p>

<p>
The <tt>ssh-agent</tt> is used to 
to simplify making repeated connections to the same host; it stores and
manages SSH keys so that the passphrases protecting them do not need to be
entered each time a connection is made.  Normally, the passphrase is used
once to unlock a key, which then gets stored by the agent when <a href="https://man.openbsd.org/ssh-add.1"><tt>ssh-add</tt></a> is used;
alternatively, the <a href="https://man.openbsd.org/ssh_config.5"><tt>ssh_config</tt></a> option
<a href="https://man.openbsd.org/ssh_config.5#AddKeysToAgent"><tt>AddKeysToAgent</tt></a>
can be used for the same purpose.  <tt>ssh-agent</tt> is a
&#34;<span>deliberately simple program</span>&#34; since it holds private keys.
Damien Miller&#39;s description of the new feature (linked above) described it
this way:
</p><blockquote>
It speaks a simple, client-initiated <a href="https://datatracker.ietf.org/doc/html/draft-miller-ssh-agent">protocol</a>
with a small number of 
operations including adding or deleting keys, retrieving a list of public
halves for loaded keys and, critically, making a signature using a private
key. Most interactions with the agent are through the <tt>ssh-add</tt> tool for
adding, deleting and listing keys and <tt>ssh</tt>, which can use keys held in an
agent for user authentication, but other tools can also be used if they
speak the protocol.  
</blockquote>


<p>
Since the agent contains high-value keys, it is &#34;<span>a desirable and
frequently-exploited target for attackers</span>&#34;.  The agent is only
accessible from the local system, which greatly limits the attack surface,
unless access to the agent has been forwarded to a remote system.  Using
the <tt>-A</tt> option to <a href="https://man.openbsd.org/ssh.1"><tt>ssh</tt></a> (or the <a href="https://man.openbsd.org/ssh_config.5#ForwardAgent"><tt>ForwardAgent</tt></a>
configuration directive) will arrange for the remote host to be able to
communicate with the local agent.  That remote host can then perform all of the agent
operations in the same way that local programs can.
</p>

<p>
This kind of agent forwarding is generally used so that multi-hop SSH
connections can be made without needing to re-enter the passphrase to
unlock the key on the remote host—possibly many times.  It also means that
the private keys do not need to stored on the remote hosts.  A user who remotely
connects to HostA, and from there to one or more other hosts using the same
SSH key, will likely find it convenient to make the initial SSH connection
to HostA with agent-forwarding enabled; SSH connections from HostA may extend
the agent-forwarding path, as well.
</p>

<p>
The problem occurs when agent access is forwarded to an attacker-controlled
system that then can use the keys stored in the agent to authenticate to
any other host the user&#39;s keys give them access to.  So the user may be
using forwarding for HostA, HostB, and HostC, but their key will grant them
access to HostV or HostZ that an attacker wants to target for some reason.
Currently, SSH has no way to restrict how the keys held by the agent can be
used; that is the problem that the new feature is meant to address.
</p>

<p>
Part of the solution is separating local access from remote access to the
agent, so that some keys can only be used from the local system even if
agent access is forwarded.  Arguably, conflating those two types of agent access was a
mistake made long ago, so being able to add keys with restrictions on how
they can be used will help to rectify that.  A new <tt>-h</tt> option has been
created for <tt>ssh-add</tt> to describe the legal uses of a key, as an
example from the feature description shows:
</p><blockquote>
 These extensions allow the user to add <i>destination constraints</i> to keys
 they add to a <tt>ssh-agent</tt> and have <tt>ssh</tt> enforce them. For example, this
 command: 
<pre>    $ ssh-add -h &#34;perseus@cetus.example.org&#34; \
              -h &#34;scylla.example.org&#34; \
    	      -h &#34;scylla.example.org&gt;medea@charybdis.example.org&#34; \
              ~/.ssh/id_ed25519
</pre>
Adds a key that can only be used for authentication in the following circumstances:
<ol>
    <li>From the origin host to <tt>scylla.example.org</tt> as any user.
    </li><li>From the origin host to <tt>cetus.example.org</tt> as user <tt>perseus</tt>.
    </li><li>Through <tt>scylla.example.org</tt> to host <tt>charybdis.example.org</tt> as user <tt>medea</tt>.
</li></ol>
Attempts to use this key to authenticate to other hosts will be refused by
the agent because they weren&#39;t explicitly listed, as would an attempt to
authenticate through <tt>scylla.example.org</tt> to <tt>cetus.example.org</tt> because the
path was not permitted. Likewise, trying to authenticate as any other user
then <tt>perseus</tt> to <tt>cetus.example.org</tt> or <tt>medea</tt> to
<tt>charybdis.example.org</tt> would 
fail because the destination users are not permitted.  
</blockquote>


<p>
More complicated paths can be specified, but each hop needs to be listed in
its own <tt>-h</tt> option.  So a multi-hop path might look something like:
</p><pre>    $ ssh-add -h &#34;HostA&#34; \
              -h &#34;HostA&gt;HostB&#34; \
    	      -h &#34;HostB&gt;HostC&#34; \
              key-file
</pre><p>
It should be noted that an agent configuration like the above would not allow the
agent&#39;s key to be used to go directly from the local system to HostB or
HostC, they could only be reached via the appropriate hops.  The user may
still be able to bypass the agent and fall back to typing in the passphrase
 for the key when prompted by </p><tt>ssh</tt><p> in order to go
directly to HostB or HostC, however.
</p>

<p>
The new feature requires updates to the client-side tools, but also
needs updated SSH servers on the remote systems.  The agent protocol
needed to change to <a href="https://www.openssh.com/agent-restrict.html#authverify">incorporate
the server host key</a> in the authentication requests, so older SSH
servers will not be able to participate in the new scheme.  The feature
will &#34;fail safe&#34; if <tt>ssh-add</tt> or the SSH server do not support the
agent restrictions; <tt>ssh-add</tt> will fail if it does not understand
the destination constraints and the agent will decline authentication
requests that are not sent with the host key.
</p>

<p>
There are some caveats.  The biggest is that attackers can still hijack the
agent connection so they can request authentication to hosts (and
users) that have been authorized, but from different hosts than expected:
</p><blockquote>
Less obviously, they will also be able to forward use of the agent to other
hosts, e.g. by using an SSH implementation that doesn’t cooperate with
<tt>ssh-agent</tt>, or another tool entirely, such as socat. Note that the attacker
isn’t gaining any new access to keys here, they are still forced to act via
the compromised host and their access is still restricted to the keys that
were permitted for use though the intended host only.
<p>
[...] Because of these subtleties, it’s better to think of key constraints
as permitting use of a key through a given host rather than as from a
particular host, and, more generally, that any forwarding path is only as
strong as its weakest link. Another helpful way to think about key
constraints is that each one represents a delegation of a key to a host,
that is only slightly more trustworthy than the delegate is.  
</p></blockquote>


<p>
Overall, this seems like a welcome addition to the SSH toolbox; the
restrictions provided will be useful.  It is nice to know that agent
forwarding will no longer provide carte blanche access to any host where
the key will work.  The document describing the feature is admirably
detailed, with a look at the implementation details, plans for the future,
and more.  Interested readers are encouraged to take a look. 
</p></div></div>
  </body>
</html>
