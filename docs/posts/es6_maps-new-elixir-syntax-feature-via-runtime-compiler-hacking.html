<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/kzemek/es6_maps">Original</a>
    <h1>Show HN: es6_maps, new Elixir syntax feature via runtime compiler hacking</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><a href="https://github.com/kzemek/es6_maps/actions/workflows/elixir.yml"><img src="https://github.com/kzemek/es6_maps/actions/workflows/elixir.yml/badge.svg" alt="CI"/></a>
<a href="https://hex.pm/packages/es6_maps" rel="nofollow"><img src="https://camo.githubusercontent.com/a898866a3f1b8ec536f0a212e34bd2b4d835bc6d5ef4de6031a126065e52fb03/68747470733a2f2f696d672e736869656c64732e696f2f686578706d2f762f6573365f6d6170732e737667" alt="Module Version" data-canonical-src="https://img.shields.io/hexpm/v/es6_maps.svg"/></a>
<a href="https://hexdocs.pm/es6_maps/" rel="nofollow"><img src="https://camo.githubusercontent.com/93963020de3ea359d43b5c2fbbb77b70bd1cfe4efdb2ec8855b3284c06cfef96/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6865782d646f63732d6c69676874677265656e2e737667" alt="Hex Docs" data-canonical-src="https://img.shields.io/badge/hex-docs-lightgreen.svg"/></a>
<a href="https://github.com/kzemek/es6_maps/blob/master/LICENSE"><img src="https://camo.githubusercontent.com/478d680b58c42cd2b62906b54e1e8098d0e9bfef2702f5f34f841f77246b75ba/68747470733a2f2f696d672e736869656c64732e696f2f686578706d2f6c2f6573365f6d6170732e737667" alt="License" data-canonical-src="https://img.shields.io/hexpm/l/es6_maps.svg"/></a></p>
<p dir="auto">Enables ES6-like shorthand usage of Elixir maps.</p>

<p dir="auto">When writing code that heavily utilizes structures and passes complex objects through multiple layers, it&#39;s common to frequently use map literals.
This often results in repetitive code patterns such as <code>ctx = %{variable: variable, user: user, ...}</code> or <code>%{variable: variable, user: user, ...} = ctx</code>.</p>
<p dir="auto">I believe that introducing a shorthand form of object creation to Elixir enhances the language&#39;s ergonomics and is a natural extension of its existing map literals syntax.
This feature will be immediately familiar to JavaScript and Rust developers, and similar shorthands are present in other languages such as Go.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Is there any runtime overhead?</h3><a id="user-content-is-there-any-runtime-overhead" aria-label="Permalink: Is there any runtime overhead?" href="#is-there-any-runtime-overhead"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">No; the shorthand map keys compile down to exactly the same bytecode as the &#34;vanilla-style&#34; maps.</p>

<p dir="auto">The package can be installed by adding <code>es6_maps</code> to your list of dependencies and compilers in <code>mix.exs</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# mix.exs

def project do
  [
    compilers: [:es6_maps | Mix.compilers()],
    deps: deps()
  ]
end

def deps do
  [
    {:es6_maps, &#34;~&gt; 0.2.2&#34;, runtime: false}
  ]
end"><pre><span># mix.exs</span>

<span>def</span> <span>project</span> <span>do</span>
  <span>[</span>
    <span>compilers: </span><span>[</span><span>:es6_maps</span> <span>|</span> <span>Mix</span><span>.</span><span>compilers</span><span>(</span><span>)</span><span>]</span><span>,</span>
    <span>deps: </span><span>deps</span><span>(</span><span>)</span>
  <span>]</span>
<span>end</span>

<span>def</span> <span>deps</span> <span>do</span>
  <span>[</span>
    <span>{</span><span>:es6_maps</span><span>,</span> <span>&#34;~&gt; 0.2.2&#34;</span><span>,</span> <span>runtime: </span><span>false</span><span>}</span>
  <span>]</span>
<span>end</span></pre></div>


<div dir="auto" data-snippet-clipboard-copy-content="iex&gt; {hello, foo, bar} = {&#34;world&#34;, 1, 2}
iex&gt; %{hello, foo, bar: bar}
%{hello: &#34;world&#34;, foo: 1, bar: 2}"><pre><span>iex</span><span>&gt;</span> <span>{</span><span>hello</span><span>,</span> <span>foo</span><span>,</span> <span>bar</span><span>}</span> <span>=</span> <span>{</span><span>&#34;world&#34;</span><span>,</span> <span>1</span><span>,</span> <span>2</span><span>}</span>
<span>iex</span><span>&gt;</span> <span>%</span><span>{</span><span>hello</span><span>,</span> <span>foo</span><span>,</span> <span>bar: </span><span>bar</span><span>}</span>
<span>%</span><span>{</span><span>hello: </span><span>&#34;world&#34;</span><span>,</span> <span>foo: </span><span>1</span><span>,</span> <span>bar: </span><span>2</span><span>}</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="iex&gt; %{hello, foo} = %{hello: &#34;world&#34;, foo: 1, bar: 2}
iex&gt; hello
&#34;world&#34;
iex&gt; foo
1"><pre><span>iex</span><span>&gt;</span> <span>%</span><span>{</span><span>hello</span><span>,</span> <span>foo</span><span>}</span> <span>=</span> <span>%</span><span>{</span><span>hello: </span><span>&#34;world&#34;</span><span>,</span> <span>foo: </span><span>1</span><span>,</span> <span>bar: </span><span>2</span><span>}</span>
<span>iex</span><span>&gt;</span> <span>hello</span>
<span>&#34;world&#34;</span>
<span>iex</span><span>&gt;</span> <span>foo</span>
<span>1</span></pre></div>

<div dir="auto" data-snippet-clipboard-copy-content="iex&gt; map = %{hello: &#34;world&#34;, foo: 1, bar: 2}
iex&gt; foo = :baz
iex&gt; %{map | foo, bar: :bong}
%{hello: &#34;world&#34;, foo: :baz, bar: :bong}"><pre><span>iex</span><span>&gt;</span> <span>map</span> <span>=</span> <span>%</span><span>{</span><span>hello: </span><span>&#34;world&#34;</span><span>,</span> <span>foo: </span><span>1</span><span>,</span> <span>bar: </span><span>2</span><span>}</span>
<span>iex</span><span>&gt;</span> <span>foo</span> <span>=</span> <span>:baz</span>
<span>iex</span><span>&gt;</span> <span>%</span><span>{</span><span>map</span> <span>|</span> <span>foo</span><span>,</span> <span>bar: </span><span>:bong</span><span>}</span>
<span>%</span><span>{</span><span>hello: </span><span>&#34;world&#34;</span><span>,</span> <span>foo: </span><span>:baz</span><span>,</span> <span>bar: </span><span>:bong</span><span>}</span></pre></div>

<p dir="auto">All of the above work for structs as well:</p>
<div dir="auto" data-snippet-clipboard-copy-content="defmodule MyStruct do
  defstruct [:hello, :foo, :bar]
end

iex&gt; {foo, bar} = {1, 2}
iex&gt; %MyStruct{foo, bar, hello: &#34;world&#34;}
%MyStruct{foo: 1, bar: 2, hello: &#34;world&#34;}

iex&gt; struct = %MyStruct{foo: 1, bar: 2}
iex&gt; hello = &#34;world&#34;
iex&gt; %MyStruct{struct | hello}
%MyStruct{foo: 1, bar: 2, hello: &#34;world&#34;}

iex&gt; %MyStruct{hello} = %MyStruct{hello: &#34;world&#34;, foo: 1}
iex&gt; hello
&#34;world&#34;"><pre><span>defmodule</span> <span>MyStruct</span> <span>do</span>
  <span>defstruct</span> <span>[</span><span>:hello</span><span>,</span> <span>:foo</span><span>,</span> <span>:bar</span><span>]</span>
<span>end</span>

<span>iex</span><span>&gt;</span> <span>{</span><span>foo</span><span>,</span> <span>bar</span><span>}</span> <span>=</span> <span>{</span><span>1</span><span>,</span> <span>2</span><span>}</span>
<span>iex</span><span>&gt;</span> <span>%</span><span>MyStruct</span><span>{</span><span>foo</span><span>,</span> <span>bar</span><span>,</span> <span>hello: </span><span>&#34;world&#34;</span><span>}</span>
<span>%</span><span>MyStruct</span><span>{</span><span>foo: </span><span>1</span><span>,</span> <span>bar: </span><span>2</span><span>,</span> <span>hello: </span><span>&#34;world&#34;</span><span>}</span>

<span>iex</span><span>&gt;</span> <span>struct</span> <span>=</span> <span>%</span><span>MyStruct</span><span>{</span><span>foo: </span><span>1</span><span>,</span> <span>bar: </span><span>2</span><span>}</span>
<span>iex</span><span>&gt;</span> <span>hello</span> <span>=</span> <span>&#34;world&#34;</span>
<span>iex</span><span>&gt;</span> <span>%</span><span>MyStruct</span><span>{</span><span>struct</span> <span>|</span> <span>hello</span><span>}</span>
<span>%</span><span>MyStruct</span><span>{</span><span>foo: </span><span>1</span><span>,</span> <span>bar: </span><span>2</span><span>,</span> <span>hello: </span><span>&#34;world&#34;</span><span>}</span>

<span>iex</span><span>&gt;</span> <span>%</span><span>MyStruct</span><span>{</span><span>hello</span><span>}</span> <span>=</span> <span>%</span><span>MyStruct</span><span>{</span><span>hello: </span><span>&#34;world&#34;</span><span>,</span> <span>foo: </span><span>1</span><span>}</span>
<span>iex</span><span>&gt;</span> <span>hello</span>
<span>&#34;world&#34;</span></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Converting existing code to use ES6-style maps</h2><a id="user-content-converting-existing-code-to-use-es6-style-maps" aria-label="Permalink: Converting existing code to use ES6-style maps" href="#converting-existing-code-to-use-es6-style-maps"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto"><code>es6_maps</code> includes a formatting plugin that will convert your existing map and struct literals into the shorthand style.
Add the plugin to <code>.formatter.exs</code>, then call <code>mix format</code> to reformat your code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# .formatter.exs
[
  plugins: [Es6Maps.Formatter],
  inputs: [&#34;{mix,.formatter}.exs&#34;, &#34;{config,lib,test}/**/*.{ex,exs}&#34;]
]"><pre><span># .formatter.exs</span>
<span>[</span>
  <span>plugins: </span><span>[</span><span>Es6Maps.Formatter</span><span>]</span><span>,</span>
  <span>inputs: </span><span>[</span><span>&#34;{mix,.formatter}.exs&#34;</span><span>,</span> <span>&#34;{config,lib,test}/**/*.{ex,exs}&#34;</span><span>]</span>
<span>]</span></pre></div>
<p dir="auto">The plugin manipulates the AST, not raw strings, so it&#39;s precise and will only change your code by:</p>
<ol dir="auto">
<li>changing map keys into the shorthand form;</li>
<li>reordering map keys so the shorthand form comes first;</li>
<li>formatting the results like <code>mix format</code> would.</li>
</ol>
<div dir="auto"><h3 tabindex="-1" dir="auto">Reverting to the vanilla-style maps</h3><a id="user-content-reverting-to-the-vanilla-style-maps" aria-label="Permalink: Reverting to the vanilla-style maps" href="#reverting-to-the-vanilla-style-maps"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The formatting plugin can also be used to revert all of the ES6-style map shorthand uses back to the &#34;vanilla&#34; style.
Set the <code>es6_maps: [map_style: :vanilla]</code> option in <code>.formatter.exs</code>, then call <code>mix format</code> to reformat your code:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# .formatter.exs
[
  plugins: [Es6Maps.Formatter],
  inputs: [&#34;{mix,.formatter}.exs&#34;, &#34;{config,lib,test}/**/*.{ex,exs}&#34;],
  es6_maps: [map_style: :vanilla]
]"><pre><span># .formatter.exs</span>
<span>[</span>
  <span>plugins: </span><span>[</span><span>Es6Maps.Formatter</span><span>]</span><span>,</span>
  <span>inputs: </span><span>[</span><span>&#34;{mix,.formatter}.exs&#34;</span><span>,</span> <span>&#34;{config,lib,test}/**/*.{ex,exs}&#34;</span><span>]</span><span>,</span>
  <span>es6_maps: </span><span>[</span><span>map_style: </span><span>:vanilla</span><span>]</span>
<span>]</span></pre></div>

<p dir="auto">The plugin supports pragmas in the comments to control the formatting.
The pragma must be in the form <code># es6_maps: [map_style: :es6]</code> and can be placed anywhere in the file.
The <code>map_style</code> option can be set to <code>:es6</code> to convert to shorthand form or <code>:vanilla</code> to revert to the vanilla-style maps.
The pragma takes effect only on the line following the comment.</p>
<p dir="auto">For example in the code below, the first map will be formatted to the shorthand form, while the second map will be left as is:</p>
<div dir="auto" data-snippet-clipboard-copy-content="  %{foo, bar: 1} = var
  # es6_maps: [map_style: :vanilla]
  %{hello: hello, foo: foo, bar: 1} = var"><pre>  <span>%</span><span>{</span><span>foo</span><span>,</span> <span>bar: </span><span>1</span><span>}</span> <span>=</span> <span>var</span>
  <span># es6_maps: [map_style: :vanilla]</span>
  <span>%</span><span>{</span><span>hello: </span><span>hello</span><span>,</span> <span>foo: </span><span>foo</span><span>,</span> <span>bar: </span><span>1</span><span>}</span> <span>=</span> <span>var</span></pre></div>
<p dir="auto"><code>es6_maps: [map_style: :vanilla]</code> option in <code>.formatter.exs</code> can be combined with <code># es6_maps: [map_style: :es6]</code> comment pragmas.</p>

<p dir="auto"><code>es6_maps</code> replaces in runtime the Elixir compiler&#39;s <code>elixir_map</code> module.
The module&#39;s <code>expand_map/4</code> function is wrapped with a function that replaces map keys <code>%{k}</code> as if they were <code>%{k: k}</code>.
After <code>es6_maps</code> runs as one of the Mix compilers, the Elixir compiler will use the replaced functions to compile the rest of the code.</p>
<div dir="auto"><p dir="auto"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p><p dir="auto">By the nature of this solution it&#39;s tightly coupled to the internal Elixir implementation.
The current version of <code>es6_maps</code> should work for Elixir 1.15, 1.16 and the upcoming 1.17 version, but may break in the future.</p>
</div>
</article></div></div>
  </body>
</html>
