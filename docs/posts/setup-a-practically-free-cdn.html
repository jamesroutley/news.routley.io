<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/charlesroper/f2da6152d6789fa6f25e9d194a42b889">Original</a>
    <h1>Setup a Practically Free CDN</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-gistfile1-md">
      
      <div id="file-gistfile1-md-readme">
    <article itemprop="text">
<p dir="auto">I&#39;ve been using <a href="https://www.backblaze.com/" rel="nofollow">Backblaze</a> for a while now as my online backup service. I have used a few others in the past. None were particularly satisfactory until Backblaze came along.</p>
<p dir="auto">It was - still is - keenly priced at a flat $5 (Â£4) per month for unlimited backup (I&#39;ve currently got just under half a terabyte backed-up). It has a fast, reliable client. The company itself is <a href="https://www.backblaze.com/hard-drive.html" rel="nofollow">transparent about their operations</a> and <a href="https://www.backblaze.com/blog/" rel="nofollow">generous with their knowledge sharing</a>. To me, this says they understand their customers well. I&#39;ve never had reliability problems and everything about the outfit exudes a sense of simple, quick, solid quality. The service has even saved the day on a couple of occasions where I&#39;ve lost files.</p>
<p dir="auto">Safe to say, I&#39;m a happy customer. If you&#39;re not already using Backblaze, <a href="https://secure.backblaze.com/r/009oqf" rel="nofollow">I highly recommend you do</a>.</p>
<h2 dir="auto"><a id="user-content-taking-on-the-big-boys-with-b2" aria-hidden="true" href="#taking-on-the-big-boys-with-b2"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Taking on the big boys with B2</h2>
<p dir="auto">So when Backblaze <a href="https://www.backblaze.com/blog/b2-cloud-storage-provider/" rel="nofollow">announced</a> they were getting into the cloud storage business, taking on the likes of Amazon S3, Microsoft Azure, and Google Cloud, I paid attention. Even if the cost were the same, or a little bit more, I&#39;d be interested because I like the company. I like their product, and I like their style.</p>
<p dir="auto">What I wasn&#39;t expecting was for them to be cheaper. <em>Much</em> cheaper. How about 440% cheaper than S3 per GB? Don&#39;t believe me? <a href="https://www.backblaze.com/b2/cloud-storage-providers.html" rel="nofollow">Take a look</a>. Remarkable.</p>
<p dir="auto">What&#39;s more, they offer a <a href="https://www.backblaze.com/b2/cloud-storage-pricing.html" rel="nofollow">generous free tier</a> of 10 GB free storage and 1 GB free download per day.</p>
<p dir="auto">If it were any other company, I might think they&#39;re a bunch of clowns trying it on. But I know from my own experience and following their journey, <a href="https://www.backblaze.com/b2/storage-pod.html" rel="nofollow">they&#39;re genuine innovators</a> and good people.</p>
<h2 dir="auto"><a id="user-content-using-b2" aria-hidden="true" href="#using-b2"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Using B2</h2>
<p dir="auto">B2 is pretty simple. You can use their web UI, which is decent. Or you can use Cyberduck, which is what I use, is free, and of high quality. There is also a <a href="https://www.backblaze.com/b2/docs/quick_command_line.html" rel="nofollow">command-line tool</a> and <a href="https://www.backblaze.com/b2/docs/integrations.html" rel="nofollow">a number of other integrated tools</a>. There is also a <a href="https://www.backblaze.com/b2/docs/calling.html" rel="nofollow">web API</a>, of course.</p>
<h2 dir="auto"><a id="user-content-setting-up-a-vanity-url" aria-hidden="true" href="#setting-up-a-vanity-url"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Setting up a vanity URL</h2>
<p dir="auto">You can set up a &#34;vanity&#34; URL for your public B2 files. Do it for free using CloudFlare. There&#39;s a <a href="https://f001.backblaze.com/file/Backblaze_B2_Beta/Configuring+Cloudflare+and+B2.pdf" rel="nofollow">PDF [1.3 MB] documenting how</a>.</p>
<h2 dir="auto"><a id="user-content-using-cloudflare-cdn-to-cache-b2-hosted-files" aria-hidden="true" href="#using-cloudflare-cdn-to-cache-b2-hosted-files"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Using CloudFlare CDN to cache B2 hosted files</h2>
<p dir="auto">You can also configure CloudFlare to aggressively cache assets served by your B2 service. It is not immediately obvious how to do this, and took a bit of poking around to set up correctly.</p>
<p dir="auto">By default, B2 serves with cache-invalidating headers: <code>cache-control:max-age=0, no-cache, no-store</code>, which causes CloudFlare to skip caching of assets. You can see this happening by looking for the <code>cf-cache-status:MISS</code> header.</p>
<p dir="auto">To work around this problem, you can use CloudFlare&#39;s PageRules specifying an &#34;Edge cache expire TTL&#34;. I won&#39;t explain what that means here as it is <a href="https://blog.cloudflare.com/edge-cache-expire-ttl-easiest-way-to-override/" rel="nofollow">covered in-depth on the CloudFlare blog</a>.</p>
<p dir="auto">So, to cache your B2 assets, you need to create a PageRule that includes all files on your B2 domain. For example:</p>
<pre><code>files.silversuit.net/*
</code></pre>
<p dir="auto">You then need to add your cache settings. I have <strong>Cache Level</strong> set to <strong>Cache Everything</strong>; <strong>Browser Cache TTL</strong> set to <strong>a year</strong>; <strong>Edge Cache TTL</strong> set to <strong>7 days</strong>. I&#39;m caching aggressively here, but you can tweak these settings to suit. Here&#39;s a screenshot:</p>

    <p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/7285c61d54f0eeb17d1a42a5109ef475a16a4c22576ee92c266a60f0dcd433b6/68747470733a2f2f663030302e6261636b626c617a6562322e636f6d2f66696c652f73696c766572737569742f323031362d30342d32312d686f772d746f2d73657475702d612d70726163746963616c6c792d667265652d63646e2f5061676552756c65735f5f73637265656e73686f745f5f323031362d30342d32312d3132343634302e706e67"><img src="https://camo.githubusercontent.com/7285c61d54f0eeb17d1a42a5109ef475a16a4c22576ee92c266a60f0dcd433b6/68747470733a2f2f663030302e6261636b626c617a6562322e636f6d2f66696c652f73696c766572737569742f323031362d30342d32312d686f772d746f2d73657475702d612d70726163746963616c6c792d667265652d63646e2f5061676552756c65735f5f73637265656e73686f745f5f323031362d30342d32312d3132343634302e706e67" data-canonical-src="https://f000.backblazeb2.com/file/silversuit/2016-04-21-how-to-setup-a-practically-free-cdn/PageRules__screenshot__2016-04-21-124640.png"/></a></p>
    Screenshot showing PageRules settings

<p dir="auto">To check that it&#39;s working correctly, use DevTools to look for the <code>cf-cache-status:HIT</code> header:</p>

    <p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ccd32ace12364bedf1080faea669709c6e760d4b31e06c305b24f1cba9eb80e9/68747470733a2f2f663030302e6261636b626c617a6562322e636f6d2f66696c652f73696c766572737569742f323031362d30342d32312d686f772d746f2d73657475702d612d70726163746963616c6c792d667265652d63646e2f43616368654869745f5f73637265656e73686f745f5f323031362d30342d32312d3132343730372e706e67"><img src="https://camo.githubusercontent.com/ccd32ace12364bedf1080faea669709c6e760d4b31e06c305b24f1cba9eb80e9/68747470733a2f2f663030302e6261636b626c617a6562322e636f6d2f66696c652f73696c766572737569742f323031362d30342d32312d686f772d746f2d73657475702d612d70726163746963616c6c792d667265652d63646e2f43616368654869745f5f73637265656e73686f745f5f323031362d30342d32312d3132343730372e706e67" data-canonical-src="https://f000.backblazeb2.com/file/silversuit/2016-04-21-how-to-setup-a-practically-free-cdn/CacheHit__screenshot__2016-04-21-124707.png"/></a></p>
    Screenshot showing a CloudFlare cache hit

<h2 dir="auto"><a id="user-content-wrapping-up" aria-hidden="true" href="#wrapping-up"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Wrapping up</h2>
<p dir="auto">So, with that, you&#39;re making use of already very inexpensive B2 storage coupled with CloudFlare&#39;s free CDN to serve your assets almost entirely for free. And it&#39;s not like these are rinky-dink services that are going to fall over regularly; these are both high-quality, reputable companies.</p>
<p dir="auto">What a time to be alive, eh?</p>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
