<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/amlalabs/amla-sandbox">Original</a>
    <h1>Show HN: Amla Sandbox – WASM bash shell sandbox for AI agents</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Every popular agent framework runs LLM-generated code via <code>subprocess</code> or <code>exec()</code>. That&#39;s arbitrary code execution on your host. One prompt injection and you&#39;re done.</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>Framework</th>
<th>Execution Method</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>LangChain</td>
<td><code>exec(command, globals, locals)</code></td>
<td><a href="https://github.com/advisories/GHSA-c67j-w6g6-q2cm">CVE-2025-68664</a>, <a href="https://github.com/langchain-ai/langchain/issues/5294" data-hovercard-type="issue" data-hovercard-url="/langchain-ai/langchain/issues/5294/hovercard">GitHub #5294</a></td>
</tr>
<tr>
<td>AutoGen</td>
<td><code>subprocess.run()</code></td>
<td><a href="https://microsoft.github.io/autogen/0.2/docs/tutorial/code-executors/" rel="nofollow">Code Executors docs</a></td>
</tr>
<tr>
<td>SWE-Agent</td>
<td><code>subprocess.run([&#34;bash&#34;, ...])</code></td>
<td><a href="https://github.com/SWE-agent/SWE-ReX">SWE-ReX</a></td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">Some frameworks offer Docker isolation (OpenHands, AutoGen), but that requires running a Docker daemon and managing container infrastructure.</p>
<p dir="auto"><strong>amla-sandbox</strong> is a WASM sandbox with capability enforcement. Agents can only call tools you explicitly provide, with constraints you define. Sandboxed virtual filesystem. No network. No shell escape.</p>
<div dir="auto" data-snippet-clipboard-copy-content="uv pip install &#34;git+https://github.com/amlalabs/amla-sandbox&#34;"><pre>uv pip install <span><span>&#34;</span>git+https://github.com/amlalabs/amla-sandbox<span>&#34;</span></span></pre></div>
<p dir="auto">No Docker. No VM. One binary, works everywhere.</p>
<div dir="auto" data-snippet-clipboard-copy-content="from amla_sandbox import create_sandbox_tool

sandbox = create_sandbox_tool(tools=[stripe_api, database])

# Agent writes one script instead of 10 tool calls (JavaScript)
result = sandbox.run(&#39;&#39;&#39;
    const txns = await stripe.listTransactions({customer: &#34;cus_123&#34;});
    const disputed = txns.filter(t =&gt; t.disputed);
    console.log(disputed[0]);
&#39;&#39;&#39;, language=&#34;javascript&#34;)

# Or with shell pipelines
result = sandbox.run(&#39;&#39;&#39;
    tool stripe.listTransactions --customer cus_123 | jq &#39;[.[] | select(.disputed)] | .[0]&#39;
&#39;&#39;&#39;, language=&#34;shell&#34;)"><pre><span>from</span> <span>amla_sandbox</span> <span>import</span> <span>create_sandbox_tool</span>

<span>sandbox</span> <span>=</span> <span>create_sandbox_tool</span>(<span>tools</span><span>=</span>[<span>stripe_api</span>, <span>database</span>])

<span># Agent writes one script instead of 10 tool calls (JavaScript)</span>
<span>result</span> <span>=</span> <span>sandbox</span>.<span>run</span>(<span>&#39;&#39;&#39;</span>
<span>    const txns = await stripe.listTransactions({customer: &#34;cus_123&#34;});</span>
<span>    const disputed = txns.filter(t =&gt; t.disputed);</span>
<span>    console.log(disputed[0]);</span>
<span>&#39;&#39;&#39;</span>, <span>language</span><span>=</span><span>&#34;javascript&#34;</span>)

<span># Or with shell pipelines</span>
<span>result</span> <span>=</span> <span>sandbox</span>.<span>run</span>(<span>&#39;&#39;&#39;</span>
<span>    tool stripe.listTransactions --customer cus_123 | jq &#39;[.[] | select(.disputed)] | .[0]&#39;</span>
<span>&#39;&#39;&#39;</span>, <span>language</span><span>=</span><span>&#34;shell&#34;</span>)</pre></div>

<p dir="auto">Tool-calling is expensive. Every MCP call is a round trip through the model:</p>
<div data-snippet-clipboard-copy-content="LLM → tool → LLM → tool → LLM → tool → ..."><pre><code>LLM → tool → LLM → tool → LLM → tool → ...
</code></pre></div>
<p dir="auto">Ten tool calls = ten LLM invocations. Code mode collapses this:</p>
<div data-snippet-clipboard-copy-content="LLM → script that does all 10 things → result"><pre><code>LLM → script that does all 10 things → result
</code></pre></div>
<p dir="auto">But you can&#39;t just eval whatever the model spits out. So people either pay the token tax or run unsafe code. This gives you both: code-mode efficiency with actual isolation.</p>

<p dir="auto">The sandbox runs inside <a href="https://webassembly.org/docs/security/" rel="nofollow">WebAssembly</a> with <a href="https://wasi.dev/" rel="nofollow">WASI</a> for a minimal syscall interface. WASM provides memory isolation by design—linear memory is bounds-checked, and there&#39;s no way to escape to the host address space. The <a href="https://docs.wasmtime.dev/security.html" rel="nofollow">wasmtime runtime</a> we use is built with defense-in-depth and has been <a href="https://www.usenix.org/conference/usenixsecurity22/presentation/bosamiya" rel="nofollow">formally verified</a> for memory safety.</p>
<p dir="auto">On top of WASM isolation, every tool call goes through capability validation:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from amla_sandbox import Sandbox, MethodCapability, ConstraintSet, Param

sandbox = Sandbox(
    capabilities=[
        MethodCapability(
            method_pattern=&#34;stripe/charges/*&#34;,
            constraints=ConstraintSet([
                Param(&#34;amount&#34;) &lt;= 10000,
                Param(&#34;currency&#34;).is_in([&#34;USD&#34;, &#34;EUR&#34;]),
            ]),
            max_calls=100,
        ),
    ],
    tool_handler=my_handler,
)

# This works
sandbox.execute(&#39;await stripe.charges.create({amount: 500, currency: &#34;USD&#34;})&#39;)

# This fails - amount exceeds capability
sandbox.execute(&#39;await stripe.charges.create({amount: 50000, currency: &#34;USD&#34;})&#39;)"><pre><span>from</span> <span>amla_sandbox</span> <span>import</span> <span>Sandbox</span>, <span>MethodCapability</span>, <span>ConstraintSet</span>, <span>Param</span>

<span>sandbox</span> <span>=</span> <span>Sandbox</span>(
    <span>capabilities</span><span>=</span>[
        <span>MethodCapability</span>(
            <span>method_pattern</span><span>=</span><span>&#34;stripe/charges/*&#34;</span>,
            <span>constraints</span><span>=</span><span>ConstraintSet</span>([
                <span>Param</span>(<span>&#34;amount&#34;</span>) <span>&lt;=</span> <span>10000</span>,
                <span>Param</span>(<span>&#34;currency&#34;</span>).<span>is_in</span>([<span>&#34;USD&#34;</span>, <span>&#34;EUR&#34;</span>]),
            ]),
            <span>max_calls</span><span>=</span><span>100</span>,
        ),
    ],
    <span>tool_handler</span><span>=</span><span>my_handler</span>,
)

<span># This works</span>
<span>sandbox</span>.<span>execute</span>(<span>&#39;await stripe.charges.create({amount: 500, currency: &#34;USD&#34;})&#39;</span>)

<span># This fails - amount exceeds capability</span>
<span>sandbox</span>.<span>execute</span>(<span>&#39;await stripe.charges.create({amount: 50000, currency: &#34;USD&#34;})&#39;</span>)</pre></div>
<p dir="auto">The design draws from <a href="https://en.wikipedia.org/wiki/Capability-based_security" rel="nofollow">capability-based security</a> as implemented in systems like <a href="https://sel4.systems/" rel="nofollow">seL4</a>—access is explicitly granted, not implicitly available. Agents don&#39;t get ambient authority just because they&#39;re running in your process. This matters because prompt injection is a <a href="https://simonwillison.net/2025/Apr/11/prompt-injection-mitigation/" rel="nofollow">fundamental unsolved problem</a>; defense in depth through capability restriction limits the blast radius.</p>

<div dir="auto" data-snippet-clipboard-copy-content="from amla_sandbox import create_sandbox_tool

sandbox = create_sandbox_tool()

# JavaScript
sandbox.run(&#34;console.log(&#39;hello&#39;.toUpperCase())&#34;, language=&#34;javascript&#34;)  # -&gt; &#34;HELLO&#34;

# Shell
sandbox.run(&#34;echo &#39;hello&#39; | tr &#39;a-z&#39; &#39;A-Z&#39;&#34;, language=&#34;shell&#34;)  # -&gt; &#34;HELLO&#34;

# With tools
def get_weather(city: str) -&gt; dict:
    return {&#34;city&#34;: city, &#34;temp&#34;: 72}

sandbox = create_sandbox_tool(tools=[get_weather])
sandbox.run(&#34;const w = await get_weather({city: &#39;SF&#39;}); console.log(w);&#34;, language=&#34;javascript&#34;)"><pre><span>from</span> <span>amla_sandbox</span> <span>import</span> <span>create_sandbox_tool</span>

<span>sandbox</span> <span>=</span> <span>create_sandbox_tool</span>()

<span># JavaScript</span>
<span>sandbox</span>.<span>run</span>(<span>&#34;console.log(&#39;hello&#39;.toUpperCase())&#34;</span>, <span>language</span><span>=</span><span>&#34;javascript&#34;</span>)  <span># -&gt; &#34;HELLO&#34;</span>

<span># Shell</span>
<span>sandbox</span>.<span>run</span>(<span>&#34;echo &#39;hello&#39; | tr &#39;a-z&#39; &#39;A-Z&#39;&#34;</span>, <span>language</span><span>=</span><span>&#34;shell&#34;</span>)  <span># -&gt; &#34;HELLO&#34;</span>

<span># With tools</span>
<span>def</span> <span>get_weather</span>(<span>city</span>: <span>str</span>) <span>-&gt;</span> <span>dict</span>:
    <span>return</span> {<span>&#34;city&#34;</span>: <span>city</span>, <span>&#34;temp&#34;</span>: <span>72</span>}

<span>sandbox</span> <span>=</span> <span>create_sandbox_tool</span>(<span>tools</span><span>=</span>[<span>get_weather</span>])
<span>sandbox</span>.<span>run</span>(<span>&#34;const w = await get_weather({city: &#39;SF&#39;}); console.log(w);&#34;</span>, <span>language</span><span>=</span><span>&#34;javascript&#34;</span>)</pre></div>
<p dir="auto">With constraints:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sandbox = create_sandbox_tool(
    tools=[transfer_money],
    constraints={
        &#34;transfer_money&#34;: {
            &#34;amount&#34;: &#34;&lt;=1000&#34;,
            &#34;currency&#34;: [&#34;USD&#34;, &#34;EUR&#34;],
        },
    },
    max_calls={&#34;transfer_money&#34;: 10},
)"><pre><span>sandbox</span> <span>=</span> <span>create_sandbox_tool</span>(
    <span>tools</span><span>=</span>[<span>transfer_money</span>],
    <span>constraints</span><span>=</span>{
        <span>&#34;transfer_money&#34;</span>: {
            <span>&#34;amount&#34;</span>: <span>&#34;&lt;=1000&#34;</span>,
            <span>&#34;currency&#34;</span>: [<span>&#34;USD&#34;</span>, <span>&#34;EUR&#34;</span>],
        },
    },
    <span>max_calls</span><span>=</span>{<span>&#34;transfer_money&#34;</span>: <span>10</span>},
)</pre></div>

<p dir="auto"><strong>Tools require object syntax:</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="// WORKS - tools always take an object argument
await get_weather({city: &#34;SF&#34;});
await transfer({to: &#34;alice&#34;, amount: 500});

// FAILS - positional arguments don&#39;t work
await get_weather(&#34;SF&#34;);  // Error: argument after ** must be a mapping"><pre><span>// WORKS - tools always take an object argument</span>
<span>await</span> <span>get_weather</span><span>(</span><span>{</span><span>city</span>: <span>&#34;SF&#34;</span><span>}</span><span>)</span><span>;</span>
<span>await</span> <span>transfer</span><span>(</span><span>{</span><span>to</span>: <span>&#34;alice&#34;</span><span>,</span> <span>amount</span>: <span>500</span><span>}</span><span>)</span><span>;</span>

<span>// FAILS - positional arguments don&#39;t work</span>
<span>await</span> <span>get_weather</span><span>(</span><span>&#34;SF&#34;</span><span>)</span><span>;</span>  <span>// Error: argument after ** must be a mapping</span></pre></div>
<p dir="auto"><strong>Use <code>return</code> or <code>console.log()</code> for output:</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="// Return value is captured and output
return await get_weather({city: &#34;SF&#34;});  // -&gt; {&#34;city&#34;:&#34;SF&#34;,&#34;temp&#34;:72}
return {a: 1, b: 2};  // -&gt; {&#34;a&#34;:1,&#34;b&#34;:2}
return &#34;hello&#34;;  // -&gt; hello (strings not double-quoted)

// console.log also works
console.log(JSON.stringify({a: 1}));  // -&gt; {&#34;a&#34;:1}

// No return = no output
const x = 42;  // -&gt; (no output)"><pre><span>// Return value is captured and output</span>
<span>return</span> <span>await</span> <span>get_weather</span><span>(</span><span>{</span><span>city</span>: <span>&#34;SF&#34;</span><span>}</span><span>)</span><span>;</span>  <span>// -&gt; {&#34;city&#34;:&#34;SF&#34;,&#34;temp&#34;:72}</span>
<span>return</span> <span>{</span><span>a</span>: <span>1</span><span>,</span> <span>b</span>: <span>2</span><span>}</span><span>;</span>  <span>// -&gt; {&#34;a&#34;:1,&#34;b&#34;:2}</span>
<span>return</span> <span>&#34;hello&#34;</span><span>;</span>  <span>// -&gt; hello (strings not double-quoted)</span>

<span>// console.log also works</span>
<span>console</span><span>.</span><span>log</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>{</span><span>a</span>: <span>1</span><span>}</span><span>)</span><span>)</span><span>;</span>  <span>// -&gt; {&#34;a&#34;:1}</span>

<span>// No return = no output</span>
<span>const</span> <span>x</span> <span>=</span> <span>42</span><span>;</span>  <span>// -&gt; (no output)</span></pre></div>
<p dir="auto"><strong>VFS is writable only under /workspace and /tmp:</strong></p>
<div dir="auto" data-snippet-clipboard-copy-content="// WORKS - /workspace and /tmp are ReadWrite
await fs.writeFile(&#39;/workspace/data.json&#39;, &#39;{}&#39;);
await fs.mkdir(&#39;/tmp/cache&#39;);

// FAILS - root is read-only
await fs.mkdir(&#39;/mydir&#39;);  // EACCES: Permission denied"><pre><span>// WORKS - /workspace and /tmp are ReadWrite</span>
<span>await</span> <span>fs</span><span>.</span><span>writeFile</span><span>(</span><span>&#39;/workspace/data.json&#39;</span><span>,</span> <span>&#39;{}&#39;</span><span>)</span><span>;</span>
<span>await</span> <span>fs</span><span>.</span><span>mkdir</span><span>(</span><span>&#39;/tmp/cache&#39;</span><span>)</span><span>;</span>

<span>// FAILS - root is read-only</span>
<span>await</span> <span>fs</span><span>.</span><span>mkdir</span><span>(</span><span>&#39;/mydir&#39;</span><span>)</span><span>;</span>  <span>// EACCES: Permission denied</span></pre></div>

<p dir="auto">For LangGraph integration:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from langgraph.prebuilt import create_react_agent
from langchain_anthropic import ChatAnthropic
from amla_sandbox import create_sandbox_tool

sandbox = create_sandbox_tool(tools=[get_weather, search_db])
agent = create_react_agent(
    ChatAnthropic(model=&#34;claude-sonnet-4-20250514&#34;),
    [sandbox.as_langchain_tool()]  # LLM writes JS/shell that calls your tools
)"><pre><span>from</span> <span>langgraph</span>.<span>prebuilt</span> <span>import</span> <span>create_react_agent</span>
<span>from</span> <span>langchain_anthropic</span> <span>import</span> <span>ChatAnthropic</span>
<span>from</span> <span>amla_sandbox</span> <span>import</span> <span>create_sandbox_tool</span>

<span>sandbox</span> <span>=</span> <span>create_sandbox_tool</span>(<span>tools</span><span>=</span>[<span>get_weather</span>, <span>search_db</span>])
<span>agent</span> <span>=</span> <span>create_react_agent</span>(
    <span>ChatAnthropic</span>(<span>model</span><span>=</span><span>&#34;claude-sonnet-4-20250514&#34;</span>),
    [<span>sandbox</span>.<span>as_langchain_tool</span>()]  <span># LLM writes JS/shell that calls your tools</span>
)</pre></div>
<p dir="auto">For fine-grained capability control:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from amla_sandbox import SandboxTool, MethodCapability, ConstraintSet, Param

caps = [
    MethodCapability(
        method_pattern=&#34;mcp:search_db&#34;,
        constraints=ConstraintSet([Param(&#34;query&#34;).starts_with(&#34;SELECT&#34;)]),
        max_calls=5,
    )
]

sandbox_tool = SandboxTool.from_functions([search_db], capabilities=caps)
agent = create_react_agent(model, [sandbox_tool.as_langchain_tool()])"><pre><span>from</span> <span>amla_sandbox</span> <span>import</span> <span>SandboxTool</span>, <span>MethodCapability</span>, <span>ConstraintSet</span>, <span>Param</span>

<span>caps</span> <span>=</span> [
    <span>MethodCapability</span>(
        <span>method_pattern</span><span>=</span><span>&#34;mcp:search_db&#34;</span>,
        <span>constraints</span><span>=</span><span>ConstraintSet</span>([<span>Param</span>(<span>&#34;query&#34;</span>).<span>starts_with</span>(<span>&#34;SELECT&#34;</span>)]),
        <span>max_calls</span><span>=</span><span>5</span>,
    )
]

<span>sandbox_tool</span> <span>=</span> <span>SandboxTool</span>.<span>from_functions</span>([<span>search_db</span>], <span>capabilities</span><span>=</span><span>caps</span>)
<span>agent</span> <span>=</span> <span>create_react_agent</span>(<span>model</span>, [<span>sandbox_tool</span>.<span>as_langchain_tool</span>()])</pre></div>

<div data-snippet-clipboard-copy-content="┌────────────────────────────────────────────────┐
│              WASM Sandbox                      │
│  ┌──────────────────────────────────────────┐  │
│  │         Async Scheduler                  │  │
│  │   tasks waiting/running/ready            │  │
│  └──────────────────────────────────────────┘  │
│  ┌────────────┐ ┌──────────┐ ┌──────────────┐  │
│  │  VFS       │ │ Shell    │ │ Capabilities │  │
│  │ /workspace │ │ builtins │ │ validation   │  │
│  └────────────┘ └──────────┘ └──────────────┘  │
│                    ↓ yield                     │
└════════════════════════════════════════════════┘
                     │
                     ▼
┌─────────────────────────────────────────────┐
│              Python Host                    │
│                                             │
│   while sandbox.has_work():                 │
│       req = sandbox.step()  # tool call     │
│       sandbox.resume(execute(req))          │
│                                             │
└─────────────────────────────────────────────┘"><pre><code>┌────────────────────────────────────────────────┐
│              WASM Sandbox                      │
│  ┌──────────────────────────────────────────┐  │
│  │         Async Scheduler                  │  │
│  │   tasks waiting/running/ready            │  │
│  └──────────────────────────────────────────┘  │
│  ┌────────────┐ ┌──────────┐ ┌──────────────┐  │
│  │  VFS       │ │ Shell    │ │ Capabilities │  │
│  │ /workspace │ │ builtins │ │ validation   │  │
│  └────────────┘ └──────────┘ └──────────────┘  │
│                    ↓ yield                     │
└════════════════════════════════════════════════┘
                     │
                     ▼
┌─────────────────────────────────────────────┐
│              Python Host                    │
│                                             │
│   while sandbox.has_work():                 │
│       req = sandbox.step()  # tool call     │
│       sandbox.resume(execute(req))          │
│                                             │
└─────────────────────────────────────────────┘
</code></pre></div>
<p dir="auto">The sandbox yields on tool calls. Host executes them (after capability checks) and resumes. <a href="https://bellard.org/quickjs/" rel="nofollow">QuickJS</a> runs inside WASM for the JS runtime.</p>

<p dir="auto">First run compiles the WASM module (~300ms). Cache it:</p>

<p dir="auto">Subsequent loads: ~0.5ms.</p>

<div dir="auto" data-snippet-clipboard-copy-content="from amla_sandbox import Param, ConstraintSet

constraints = ConstraintSet([
    Param(&#34;amount&#34;) &gt;= 100,
    Param(&#34;amount&#34;) &lt;= 10000,
    Param(&#34;currency&#34;).is_in([&#34;USD&#34;, &#34;EUR&#34;]),
    Param(&#34;path&#34;).starts_with(&#34;/api/&#34;),
])"><pre><span>from</span> <span>amla_sandbox</span> <span>import</span> <span>Param</span>, <span>ConstraintSet</span>

<span>constraints</span> <span>=</span> <span>ConstraintSet</span>([
    <span>Param</span>(<span>&#34;amount&#34;</span>) <span>&gt;=</span> <span>100</span>,
    <span>Param</span>(<span>&#34;amount&#34;</span>) <span>&lt;=</span> <span>10000</span>,
    <span>Param</span>(<span>&#34;currency&#34;</span>).<span>is_in</span>([<span>&#34;USD&#34;</span>, <span>&#34;EUR&#34;</span>]),
    <span>Param</span>(<span>&#34;path&#34;</span>).<span>starts_with</span>(<span>&#34;/api/&#34;</span>),
])</pre></div>
<p dir="auto">Pattern matching for method names:</p>
<ul dir="auto">
<li><code>stripe/charges/create</code> — exact match</li>
<li><code>stripe/charges/*</code> — single path segment</li>
<li><code>stripe/**</code> — zero or more segments</li>
</ul>

<p dir="auto"><strong>What you get:</strong> Isolation without infrastructure. Capability enforcement. Token efficiency.</p>
<p dir="auto"><strong>What you don&#39;t get:</strong> Full Linux environment. Native module support. GPU access. Infinite loop protection (a <code>while(true){}</code> will hang - the step limit only counts WASM yields, not JS instructions).</p>
<p dir="auto">If you need a real VM with persistent state and arbitrary dependencies, use <a href="https://e2b.dev" rel="nofollow">e2b</a> or <a href="https://modal.com" rel="nofollow">Modal</a>. amla-sandbox is for the common case: agents running generated code with controlled tool access.</p>

<p dir="auto">Python code is MIT. The WASM binary is currently proprietary—you can use it freely with this package, but you can&#39;t extract or redistribute it separately. We&#39;re working on open sourcing the WASM runtime.</p>
<hr/>
<p dir="auto"><a href="https://amlalabs.com/sandbox" rel="nofollow">Website</a> · <a href="https://hamy.xyz/amlalabs/amla-sandbox/blob/main/examples">Examples</a> · <a href="https://hamy.xyz/amlalabs/amla-sandbox/blob/main/docs">Docs</a></p>
</article></div></div>
  </body>
</html>
