<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2023/05/25/new-playground--memory-spy/">Original</a>
    <h1>New playground: memory spy</h1>
    
    

<p>Hello! Today we&rsquo;re releasing a new playground called &ldquo;memory spy&rdquo;. It lets you run C programs
and see how their variables are represented in memory. It&rsquo;s designed to be
accessible to folks who don&rsquo;t know C &ndash; it comes with bunch of extremely simple
example C programs that you can poke at. Here&rsquo;s the link:</p>

<div style="margin: 1em 0" align="center">
&gt;&gt; <a href="https://memory-spy.wizardzines.com">Memory Spy</a> &lt;&lt;
</div>

<p>This is a companion to the &ldquo;how integers and floats work&rdquo; zine we&rsquo;ve been
working on, so the goal is mostly to look at how number types (integers and
floats) are represented.</p>

<h3 id="why-spy-on-memory">why spy on memory?</h3>

<p>How computers actually represent variables can seem kind of abstract, so  I
wanted to make it easy for folks to see how a real computer actually represents
variables in memory.</p>

<h3 id="why-is-it-useful-to-look-at-c">why is it useful to look at C?</h3>

<p>You might be wondering &ndash; I don&rsquo;t write C! Why should I care how C programs
represent variables in memory?</p>

<p>In this playground I&rsquo;m mostly interested in showing people how integers and
floats are represented. And low-level languages generally all represent
integers and floats in the same way &ndash; a 32-bit unsigned int is going to be the
same in C, C++, Rust, Go, Swift, etc. The exact name of the type is different,
but the representation is the same.</p>

<p>In higher-level languages like Python it&rsquo;s a little different, but under the
hood a <code>float</code> in Python contains a C <code>double</code>, so the C representation is
still pretty relevant.</p>

<h3 id="you-don-t-have-to-know-c">you don&rsquo;t have to know C</h3>

<p>It uses C because C is the language where it&rsquo;s the most straightforward to map
between &ldquo;the code in your program&rdquo; and &ldquo;what&rsquo;s in your computer&rsquo;s memory&rdquo;.</p>

<p>But if you&rsquo;re not comfortable with C, this playground is still for you! We put
together a bunch of example programs where you can run them and look at each
variable&rsquo;s value.</p>

<p>None of the example programs use any fancy features of C &ndash; a lot of the code
is extremely simple, like <code>char byte = 'a';</code>. So you should be mostly
able to understand what&rsquo;s going on even if you don&rsquo;t know C at all.</p>

<h3 id="how-does-it-work">how does it work?</h3>

<p>Behind the scenes, there&rsquo;s a server that:</p>

<ul>
<li>compiles the program with <code>clang</code></li>
<li>runs the program with the C debugger <code>lldb</code> (using a Python lldb script)</li>
<li>returns a JSON file with the values of the variable on every line, as an array of bytes</li>
</ul>

<p>Then the frontend formats the array of bytes so you can look at it.</p>

<h3 id="some-limitations">some limitations</h3>

<p>The two main limitations I can think of right now are:</p>

<ul>
<li>there&rsquo;s no support for loops (it&rsquo;ll run them, but it&rsquo;ll only tell you the value of the variable the first time through the loop)</li>
<li>it only supports defining one variable per line</li>
</ul>

<p>There are probably more, it&rsquo;s a very simple project.</p>

<h3 id="the-inspiration">the inspiration</h3>

<p><a href="https://pythontutor.com/">Python Tutor</a> by Philip Guo was a huge inspiration. It has a different focus &ndash; it also lets you step through programs in a
debugger, but it&rsquo;s more focused on helping the user build a mental model for
how variables and control flow work.</p>

<h3 id="what-about-security">what about security?</h3>

<p>In general my approach to running arbitrary untrusted code is 20% sandboxing
and 80% making sure that it&rsquo;s an extremely low value attack target so it&rsquo;s not
worth trying to break in.</p>

<p>Programs are terminated after 1 second of runtime, they run in a container with
no network access, and the machine they&rsquo;re running on has no sensitive data on
it and a very small CPU.</p>

<h3 id="some-notes-on-the-tech-stack">some notes on the tech stack</h3>

<p>The backend is in Go, plus a Python script to script the interactions with
lldb. (here&rsquo;s <a href="https://gist.github.com/jvns/7f1eff7cdda26412cc8df280a1641fd4">the source for the lldb script</a> and <a href="https://gist.github.com/jvns/14b8f65537004a56013260d9219ef36f">the source for the Go server right now</a>). I&rsquo;m
using <a href="https://jvns.ca/blog/2022/06/28/some-notes-on-bubblewrap/">bubblewrap</a>
to sandbox lldb.</p>

<p>As always the frontend is using Vue. You can see the frontend source with &ldquo;view
source&rdquo; if you want.</p>

<p>The main fancy thing that happens on the frontend is that I use <a href="https://tree-sitter.github.io/tree-sitter/">tree sitter</a> to figure out which lines
of the code have variables defined on them.</p>

<h3 id="some-design-notes">some design notes</h3>

<p>As usual these days, I built this project with <a href="https://marieflanagan.com/">Marie Claire LeBlanc Flanagan</a>. I think the
design decision I&rsquo;m the happiest with is how we handled navigating the program you&rsquo;re running.
Instead of using next/previous arrows to step through the code one line at a
time, you can just click on a line to view its variables.</p>

<p>This &ldquo;click on a line&rdquo; design wouldn&rsquo;t make sense in a normal debugger context
because usually you have loops and a line might be run more than once. But our
focus here isn&rsquo;t on control flow, and none of the example programs have loops.</p>

<p>The other thing I&rsquo;m happy with is the decision to use regular links like (<code>&lt;a href=&quot;#example=hexadecimal&quot;&gt;</code>) for all the navigation. There&rsquo;s an
<code>onhashchange</code> Javascript event that takes care of making sure we update the
page to match the new URL.</p>

<p>I think there were more design struggles but I forget what they were right now.</p>

<h3 id="that-s-all">that&rsquo;s all!</h3>

<p>Here&rsquo;s the link again:</p>

<div style="margin: 1em 0" align="center">
&gt;&gt; <a href="https://memory-spy.wizardzines.com">Memory Spy</a> &lt;&lt;
</div>

<p>Let me know on Twitter or Mastodon if you notice any problems.</p>

  </body>
</html>
