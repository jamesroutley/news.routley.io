<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://reinteractive.com/articles/running-open-source-AI-models-locally-with-ruby">Original</a>
    <h1>Running Open-Source AI Models Locally with Ruby</h1>
    
    <div id="readability-page-1" class="page"><section>
            <article>
              <!--  





 <header class="SC-PageHeader ">
    <h1 class="SC-PageHeader_heading">
      Running Open-Source AI Models Locally With Ruby
    </h1>
</header>
 -->
              <!-- **Hidden Subtile**-->
                <!-- **Hidden Featured Image**
              <img src="https://res.cloudinary.com/hynqxvid6/image/upload/c_fit,f_auto,h_1024,w_1024/v1/media/Running_Open-Source_Models_Locally_with_Ruby_2.png" class="sc-mb-base" loading="lazy">-->
              <!-- **Hidden Featured Date**
              <div class="sc-mb-base sc-shade-neutral">
                February 1, 2024
              </div>-->
                <p>G’day Rubyists. I’m currently working with a client on implementing a custom AI solution using an open source AI model. The reason for this is the client has very sensitive customer information and we don’t want to pass this across to OpenAI or other proprietary models, in order to maintain a very high level of security.</p>

<p>The solution has been to download and run an open source AI model in an AWS virtual machine, keeping the model completely under our control, with the Rails application making API calls to the AI in a safe environment.</p>

<p>I wanted to share with you how to download an open source AI model locally, get it running and run Ruby scripts against it.</p>

<h3 id="why-go-custom">Why Go Custom?</h3>
<p>The reason behind this project is straightforward: data security. When dealing with sensitive client information, the safest route is often to keep things in-house. This approach led us to explore custom AI models, which offer a higher degree of control and privacy.</p>

<h3 id="open-source-models">Open source models</h3>
<p>Over the last 6 months we have started to see a plethora of open source models hitting the market. While not as powerful as GPT-4, many of these models are showing performance that exceeds GPT-3.5 and they are only going to get better as time goes on.</p>

<p>There are a few other successful AI models such as Mistral, Mixtral and Lama. The right model to use depends on your processing power and what you are trying to achieve.</p>

<p>As we are going to be running this model locally, probably the best option is Mistral. It is about 4GB in size and outperforms GPT-3.5 on most metrics. For its size Mistral is the best model in my opinion.</p>

<p>Mixtral, out performs Mistral, but it is a huge model and requires at least 48GB of RAM to run.</p>

<h3 id="parameters">Parameters</h3>
<p>When talking about Large Language Models they are generally referred to by their parameter size, and a brief description of this is useful.</p>

<p>The Mistral model, which we will be running locally, is a 7 billion parameter model. Mixtral is a 70 billion parameter model.</p>

<p>It works this way, all of these LLMs are neural networks. A neural network is a collection of neurons, and each neuron connects to all of the other neurons in the proceeding layers.</p>

<p><img src="https://res.cloudinary.com/hynqxvid6/image/upload/q_auto,f_auto/v1706679063/media/Image_1.jpg" alt=" Running Open-Source AI Models"/>
</p>

<p>Each connection has a weight, which is usually a percentage. Each neuron also has a bias which modifies the data as it passes through that node.</p>

<p>The whole purpose of a neural network is to “learn” a very advanced algorithm which is effectively a pattern matching algorithm. In the case of LLMs, by being trained of huge amounts of text, it learns the ability to predict text patterns and so can generate meaningful responses to our prompts.</p>

<p>In simple terms the parameters are the number of weights and biases in the model. This tends to give us an idea of how many neurons are in the neural network. For a 7 billion parameter model there will be something on the order of 100 layers, with thousands of neurons per layer.</p>

<p>To put in context GPT-3.5 has about 175 billion parameters. It’s actually quite amazing that Mistral with 7 billion parameters can outperform GPT-3.5 in many metrics.</p>

<h3 id="software-to-run-models-locally">Software to run models locally</h3>
<p>In order to run our open source models locally it is necessary to download software to do this. While there are several options on the market, the simplest I found, and the one which will run on an Intel Mac, is <a href="https://ollama.ai/">Ollama</a>.</p>

<p>Right now Ollama runs on Mac and Linux, with Windows coming in the future. Though you can use WSL on Windows to run a Linux shell.</p>

<p>Ollama allows you to download and run these open source models. It also opens up the model on a local port giving you the ability to make API calls via your Ruby code. And this is where it gets fun as a Ruby developer. You can write Ruby apps that integrate with your own local models.</p>

<p>You can also watch this setup process on my YouTube video.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/0ZlkH4i_BnM?si=DU3-1K6oVFZoekME" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>

<h3 id="setting-up-ollama">Setting Up Ollama</h3>
<p>Installation of Ollama is straightforward on Mac and Linux systems. Just download the software and it will install the package. Ollama is primarily command-line based, making it easy to install and run models. Just follow the steps and you will be set up in about 5 minutes.</p>

<p><img src="https://res.cloudinary.com/hynqxvid6/image/upload/q_auto,f_auto/v1706680650/media/Image_2.jpg" alt="Running Open-Source AI Models"/>
</p>

<h3 id="installing-your-first-model">Installing your first model</h3>

<p>Once you have Ollama set up and running, you should see the Ollama icon in your taskbar. This means it’s running in the background and will run your models.</p>

<p><img src="https://res.cloudinary.com/hynqxvid6/image/upload/q_auto,f_auto/v1706681152/media/Image_3.jpg" alt="Running Open-Source AI Models"/>
</p>
<p>The next step is to download the model.</p>

<ul>
  <li>Open your terminal</li>
  <li>Run the following command:</li>
</ul>

<p><code>ollama run mistral</code></p>

<p>The first time this will download Mistral, which will take some time as it is about 4GB in size.</p>

<ul>
  <li>Once it has finished downloading it will open the Ollama prompt and you can start communicating with Mistral.</li>
</ul>

<p><img src="https://res.cloudinary.com/hynqxvid6/image/upload/q_auto,f_auto/v1706681411/media/Image_4.jpg" alt=" Running Open-Source AI Models"/>
</p>

<p>Next time you run <code>ollama run mistral</code> it will just run the model.</p>

<h3 id="customising-models">Customising Models</h3>
<p>With Ollama you can create customizations to the base model. This is a little like creating custom GPTs in OpenAI.</p>

<p>Full details are provided in the Ollama <a href="https://github.com/ollama/ollama">documentation</a>.</p>

<p>The steps to create a custom model are fairly simple:</p>

<ul>
  <li>Create a <code>Modelfile</code></li>
  <li>Add the following text to the Modelfile:</li>
</ul>

<pre><code>
FROM mistral

# Set the temperature set the randomness or creativity of the response
PARAMETER temperature 0.3

# Set the system message
SYSTEM ”””
	You are an excerpt Ruby developer. You will be asked questions about the Ruby 
	Programming language. You will provide an explanation along with code examples.
	”””
</code></pre>

<p>The system message is what primes the AI model to respond in a given way.</p>

<ul>
  <li>Create the new model. Run the following command in the terminal:</li>
</ul>

<p><code>ollama create &lt;model-name&gt; -f ‘./Modelfile’</code></p>

<p>In my case, I am calling the model Ruby.</p>

<p><code>ollama create ruby -f ‘./Modelfile’</code></p>

<p>This will create the new model.</p>

<ul>
  <li>List your models with the following command:</li>
</ul>

<p><code>ollama list</code></p>

<p><img src="https://res.cloudinary.com/hynqxvid6/image/upload/q_auto,f_auto/v1706681774/media/Image_5.jpg" alt=" Running Open-Source AI Models"/>
</p>

<ul>
  <li>Now you can run the custom model</li>
</ul>

<p><code>ollama run ruby</code></p>

<h3 id="integrating-with-ruby">Integrating with Ruby</h3>
<p>Although there’s no dedicated gem for Ollama yet, Ruby developers can interact with the model using basic HTTP request methods. Ollama runs in the background, and it opens up the model via port <code>11434</code>, so you can access it on `http://localhost:11434’.
The Ollama <a href="https://github.com/ollama/ollama/blob/main/docs/api.md">API documentation</a> provides the different endpoints for the basic commands such as chat and creating embeddings.</p>

<p>For us we want to work with the <code>/api/chat</code> endpoint to send a prompt to the AI model.</p>

<p>Here is some basic Ruby code for interacting with the model.</p>

<pre><code>
require &#39;net/http&#39;
require &#39;uri&#39;
require &#39;json&#39;


uri = URI(&#39;http://localhost:11434/api/chat&#39;)


request = Net::HTTP::Post.new(uri)
request.content_type = &#39;application/json&#39;
request.body = JSON.dump({
 model: &#39;ruby&#39;,
 messages: [
   {
     role: &#39;user&#39;,
     content: &#39;How can I covert a PDF into text?&#39;,
   }
 ],
 stream: false
})


response = Net::HTTP.start(uri.hostname, uri.port) do |http|
 http.read_timeout = 120
 http.request(request)
end


puts response.body
</code></pre>

<p>The Ruby code does the following:</p>

<ul>
  <li>
    <p>The code starts by requiring three libraries: ‘net/http’, ‘uri’, and ‘json’. These libraries are used for making HTTP requests, parsing URIs, and handling JSON data respectively.</p>
  </li>
  <li>
    <p>A URI object is created with the address of the API endpoint (‘http://localhost:11434/api/chat’).</p>
  </li>
  <li>
    <p>A new HTTP POST request is created using the Net::HTTP::Post.new method with the URI as the argument.</p>
  </li>
  <li>
    <p>The content type of the request is set to ‘application/json’.</p>
  </li>
  <li>
    <p>The body of the request is set to a JSON string that represents a hash. This hash contains three keys: ‘model’, ‘messages’, and ‘stream’. The ‘model’ key is set to ‘ruby’ which is our model, the ‘messages’ key is set to an array containing a single hash representing a user message, and the ‘stream’ key is set to false.</p>
  </li>
  <li>
    <p>The messages hash follows a model for intersecting with AI models. It takes a role and the content. The roles can be system, user and assistance. System is the priming message for how the model should respond. We already set that in the Modelfile. The user message is our standard prompt, and the model will respond with the assistant message.</p>
  </li>
  <li>
    <p>The HTTP request is sent using the Net::HTTP.start method. This method opens a network connection to the specified hostname and port, and then sends the request. The read timeout for the connection is set to 120 seconds given that I am running on a 2019 Intel Mac, the responds can be a little slow. This isn’t an issue running on the appropriate AWS servers.</p>
  </li>
  <li>
    <p>The response from the server is stored in the ‘response’ variable.</p>
  </li>
</ul>

<h3 id="practical-use-cases">Practical Use Cases</h3>
<p>The real value of running local AI models comes into play for companies dealing with sensitive data. These models are really good at processing unstructured data, like emails or documents, and extracting valuable, structured information.</p>

<p>For one use case I am training the model on all of the customer information in a CRM. This allows users to ask questions about the customer without needing to go through sometimes hundreds of notes.</p>

<h3 id="conclusion">Conclusion</h3>
<p>Where security is not an issue I am more likely to work directly with OpenAI. But for companies that need private models, then Open Source is definitely the way to go.</p>

<p>If I get around to it, one of these days I’ll write a Ruby wrapper around the Ollama APIs to make it a little easier to interact with. If you would like to work on that project, then definitely reach out.</p>

<p>Have fun working with open source models.</p>

            </article>
          </section><section>
            <div>
              <!-- CB 'Search-Bar' -->



                
              

<section>
        <div>
            <div>
                <p>Ready to start your next project?</p>
            </div>
            
        </div>
    </section>

            </div>
          </section></div>
  </body>
</html>
