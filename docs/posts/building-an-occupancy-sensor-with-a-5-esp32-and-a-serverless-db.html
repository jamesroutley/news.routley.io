<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://matthew.science/posts/occupancy/">Original</a>
    <h1>Building an occupancy sensor with a $5 ESP32 and a serverless DB</h1>
    
    <div id="readability-page-1" class="page"><div>
        <header>
    

    <nav>
        
            <a href="https://jvns.ca/">Home</a>
        
            <a href="https://jvns.ca/posts">All posts</a>
        
            <a href="https://jvns.ca/about">About</a>
        

        
            |

            
                <a href="https://jvns.ca/">en</a>
            
        

        
            | <a id="dark-mode-toggle" onclick="toggleTheme()" href=""></a>
            
        
    </nav>
</header>


        
    
<main>
    <article>
        

        

        <section>
            <p>Have you ever wanted to design a full end-to-end software solution to collect occupancy data across a college campus?</p>
<p>I didn&#39;t think I would either, but here we are.</p>
<h2 id="the-inspiration">The inspiration</h2>
<p>During my first year in college, we had Sodexo as our dining provider. They had a contract with <a href="https://www.bluefox.io/products/count">Bluefox</a>, who provides occupancy sensors to report the number of people within a dining hall. I&#39;d like to think they used this data to improve dining hall operations. I couldn&#39;t tell you what they <em>actually</em> used it for. I can say that after some FOIA requests a friend made that returned PDF&#39;s with awful kerning, these devices work by counting smartphone MAC addresses from Bluetooth advertising packets. This was a pretty cool way for me to avoid crowds in the dining hall - toss the API call into Grafana, and you have a live chart of how busy the dining halls are.</p>
<h2 id="the-downfall">The downfall</h2>
<p>Unfortunately, the university switched dining hall providers to Aramark. Aramark does not contract Bluefox to provide the same occupancy counts, which meant no more occupancy data, which meant no more skipping busy hours.</p>
<h2 id="the-climb-back">The climb back</h2>
<p>The idea of tracking occupancy metrics with a bluetooth beacon was stuck in my head. What design decisions and considerations would you need to make?</p>
<ul>
<li>How accurate is BLE beacon count, as a proxy for occupancy?
<ul>
<li>Some people carry around headphones, smartwatches, etc - but some don&#39;t carry any devices at all (or keep Bluetooth off on their phone).</li>
</ul>
</li>
<li>How accurate is BLE beacon availability time, as a proxy for dwell time?
<ul>
<li>Can we use unique MAC addresses&#39; churn to detect this?</li>
<li>Is the built-in MAC address randomization that is common across <a href="https://source.android.com/docs/core/connect/wifi-mac-randomization-behavior">many</a> different <a href="https://support.apple.com/guide/security/bluetooth-security-sec82597d97e/web#sec18ee64d9d">manufacturers</a> going to impact this? (Even though this privacy feature has <a href="https://ieeexplore.ieee.org/document/9369628">flaws</a>)</li>
</ul>
</li>
<li>How can we communicate the results back to a central server?
<ul>
<li>WiFi seems the obvious choice for me. Not every location will have easy-to-access WiFi, though.</li>
<li>LoRa could be an option, depending on the distribution of beacons. Here&#39;s some <a href="https://medium.com/home-wireless/what-is-the-range-of-a-lora-radio-411261e35f46">range testing numbers</a>, though this is affected by the antenna&#39;s gain and locations (here&#39;s <a href="https://yosensi.io/posts/what_is_the_real_range_of_lora/">another test</a> with a far higher range).</li>
</ul>
</li>
<li>How can we collect the data?
<ul>
<li>Should we use a time series database?</li>
</ul>
</li>
<li>How can we analyze the data?
<ul>
<li>Can we predict trends in the longer time spans, excluding special events like homecoming weekend, finals week, etc?</li>
</ul>
</li>
</ul>
<p>I found these questions tumbling around in my head, so I began with some preliminary testing - writing some simple code to count the number of devices detected on my laptop&#39;s Bluetooth adapter. Success - it was surprisingly easy to write code to scan for <code>x</code> seconds every <code>y</code> seconds and save it to a SQLite database at regular intervals. So, I carried my laptop to dining halls, Chick-Fil-A, Starbucks, etc and waited.
</p>
<p>In larger areas like dining halls, the counts seemed accurate by my guesstimate. There&#39;s no way for me to count everyone in a dining hall, with complicated layouts and different seating areas, especially when I&#39;m not certain of my bluetooth adapter&#39;s range (is it picking up people on the terrace through the walls? etc). But it most definitely matched the trends around class changes - when classes got out, people went to eat, which rapidly increased the number of people I saw, and the number of beacons my laptop detected.</p>
<h2 id="long-term-deployment">Long term deployment</h2>
<p>Okay, sounds great, it looks like we have some kind of method validation. But I don&#39;t plan on cloning myself in every dining hall and sitting 24/7, so what can we do to create a small device to collect the same data?</p>
<h2 id="raspberry-pi-maybe">Raspberry Pi - Maybe?</h2>
<p>My first thought was - Raspberry Pi Zero W. It&#39;s small and cheap, has Wi-Fi and Bluetooth, and definitely is in stock somewhere on Earth. </p>
<p>I rewrote my simple code (in Rust, no less!) to handle everything gracefully (reboots, no network, adapter loss, etc). Linux Bluetooth is incredibly painful to handle in a headless way. Binding to DBus requires cross-compiler magic and not even Cross was getting me out of it. After struggling enough through a million different compiler flags, a power outage that caused me to lose my progress on the Makefile (also, yes I use Make with Rust), and at last setting up a QEMU bridge, I was able to get my binary to run on my Pi. I even wrote all of the patching magic to make it connect to Wi-Fi (try doing THAT headlessly, when there&#39;s a portal you have to sign into!), install the necessary libraries on start-up, make a service to run my executable, and automagically update when I push a new update. Okay, that&#39;s a lot of moving parts. Let&#39;s boot it up and hope it works...</p>
</section>

        

    </article>
</main>



        





    </div></div>
  </body>
</html>
