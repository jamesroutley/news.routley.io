<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://floppy.cafe/">Original</a>
    <h1>Bit banging a 3.5&#34; floppy drive</h1>
    
    <div id="readability-page-1" class="page"><div>
      
      
      <p>
        Welcome to the <b>floppy cafe</b>! These pages are the lost and sacred
        texts you&#39;ve been looking for if you happen to be writing a driver for
        a 3.5&#34; floppy. To learn these mysteries, I bit-banged a floppy drive
        using a
        <a href="https://www.pjrc.com/store/teensy40.html" target="_blank" rel="noreferrer">teensy4.0</a>
        and managed to write a full driver for it. My project code is hosted
        <a href="https://github.com/SharpCoder/floppy-driver-rs" target="_blank" rel="noreferrer">here on github</a>
        in case you&#39;d like to learn more. Continue reading for an extremely
        detailed overview of the project and all my findings on this adventure.
        <b>Although the information is largely common for any floppy drive,
          floppy.cafe is dedicated specifically to 3.5&#34; media.
        </b>
      </p>
      <h2>Table of Contents</h2>
      
        
        
        
        
        
        
      
      <h2>
        <a id="how-do-floppy-disks-work" href="#how-do-floppy-disks-work"><img src="https://floppy.cafe/media/link.png"/></a>How do Floppy Disks
        Work?
      </h2>
      <p>
        This
        <a href="http://philipstorr.id.au/pcbook/book4/floppyd.htm" target="_blank">website</a>
        has a good overview and some nice pictures. Fundamentally, your floppy
        houses a magnetized disk that spins at about 300rpm. For 3.5&#34; media,
        that disk contains 80 tracks. Each track has 18 sectors. Each sector has
        512 bytes of user-space data (and some more bytes used for metadata).
        Most &#34;modern&#34; floppies are double-sided, so you can multiply all that by
        2 in order to find the total amount of usable space per disk.
        <code>1,474,560 bytes</code> in all.
      </p>
      <p>
        <b>Fun fact!</b> floppy disks actually contain a lot more surface area
        than 1.44mb. By my calculation, you&#39;ll get closer to 1.70mb but a lot of
        that extra space is earmarked for
        <a href="#synchronization-barriers">synchronization barriers</a> and
        sector / track metadata.
      </p>
      <h2>
        <a id="wiring-guide" href="#wiring-guide"><img src="https://floppy.cafe/media/link.png"/></a>
        Wiring Guide
      </h2>
      <p>
        Here&#39;s the cool thing about floppy drives: they have no communication
        protocol! It&#39;s just a bunch of gpio pins. For most of them, pulling the
        pin <code>HIGH</code> means it is in the &#34;disabled&#34; or &#34;off&#34; state.
        Pulling a pin <code>LOW</code> will activate it. You can read about the
        very detailed specifications for the
        <a href="https://floppy.cafe/resources/SAMSUNG-SFD321B-070103.pdf" target="_blank">SAMSUNG-SFD321B</a>
        floppy drive. The top row of pins are the functions, the bottom row of
        pins are all <b>LOGIC GROUND</b>. Logic. Did you get that? LOGIC! Not
        motor ground. I had them wired up wrong for weeks and wondered why
        nothing worked. And, yes, there&#39;s like a million ground pins but you
        only need 1 to get it working.
      </p>
      <p>
        <b>An important note!</b> the logic-level pins are rated for 5v,
        however, you can use 3v3 in a pinch! Why is that? All these data pins
        are <i>open drain</i> and should be hooked up to a
        <i>pull-up resistor</i>. That means the only way these floppy drives
        communciate back is by sinking the voltage. So 3v3, 5v, it doesn&#39;t
        matter. The floppy drive will happily pull it down.
      </p>
      <p>
        <b>Protip!</b> Some of the bottom row of pins are
        <b>not connected internally!</b> So if you are plugging in just 1 ground
        wire and it&#39;s not working, chances are the ground pin you selected is
        disconnected. Try another one.
      </p>
      <img alt="A page from a guide showing what each pin on the back of a floppy drive does." src="https://floppy.cafe/media/pins.png"/>
      <p>
        You&#39;ll notice the power section only needs two wires. 5v+ and another
        ground. For your sanity, I suggest using a separate power bus than
        whatever your microcontroller is on.
      </p>
      <p>
        Please do not connect the 5v+ to an arduino or a GPIO! It can draw
        upwards of 1A during really feisty operations and it will
        <b>fry your microcontroller!</b>
      </p>
      <h2>
        <a id="sending-commands" href="#sending-commands"><img src="https://floppy.cafe/media/link.png"/></a>Sending Commands
      </h2>
      <p>
        There are a number of commands and proceedures you will need to
        implement in order to assume control of the floppy drive. In general,
        commands are issued by pulling a given pin <code>LOW</code>.
      </p>

      <p>
        <b>A word of warning:</b> I&#39;ve read online the Arduino internal pull-ups
        aren&#39;t great. They&#39;ll work for most of these pins
        <i>except the data line</i>. You may want to add a 4.5k pull-up to the
        <code>DATA</code> line instead of relying on the built-in pull-ups.
      </p>
      <p>Alright! Let&#39;s explore each function you have access to.</p>

      <h3>Index</h3>
      <p>
        The floppy drive doesn&#39;t really know <i>where</i> you are at any given
        time. You can suss this out with various mechanisms, and one of those
        mechanisms is the <b>INDEX</b> pin. The index pin is the first usable
        pin on the top row (pin 8). When this pin is <code>LOW</code>, the disk
        has made one complete revolution and is currently at the start of the
        data stream.
      </p>
      <p>
        In my driver, I would often look for <code>HIGH</code> to
        <code>LOW</code> transitions and use this to increment an error counter.
        If I can&#39;t complete some task after 10 revolutions or so, I consider the
        drive in a bad state.
      </p>

      <h3>Drive Select</h3>
      <p>
        There are a few different drive select pins (often for drive 0, 1, and
        2) but the main one we&#39;re interested in is
        <code>PIN 12</code> also known as <code>DRIVE SELECT 1</code>. The other
        ones are reserved for controlling multiple floppy drives at once. This
        function is used to enable the floppy drive. Pulling it
        <code>LOW</code>
        will provide you access to all the other I/O functions except
        <code>MOTOR ON</code>. That one is agnostic of drive select.
      </p>
      <h3>Motor On</h3>
      <p>
        As the name suggests, this pin is dedicated to controlling the motor. To
        enable the motor, pull this pin
        <code>LOW</code> and then wait 500ms. It&#39;s good practice to monitor the
        <code>INDEX</code> line as well for a <code>HIGH</code> to
        <code>LOW</code> transition, indicating that the spindle has made a
        complete revolution.
      </p>
      <h3>Direction Select</h3>
      <p>
        This pin controls the direction that the track <b>stepper motor</b> pin
        will move in, when you pulse the <code>STEP</code> pin. Pulling this pin
        <code>LOW</code> will orient the track stepper motor to move towards the
        center of the magnetic disk (increasing the track number). Pulling this
        pin <code>HIGH</code> will orient the track stepper to move towards the
        outside of the magnetic disk (decreasing the track number).
      </p>
      <h3>Step</h3>
      <p>
        There are 80 tracks on your average 3.5&#34; floppy drive. You can select a
        given track by pulsing the <code>STEP</code> pin and combining it with
        the <b>direction select</b> pin.
      </p>
      <p>
        Pulsing this pin will charge and actuate a stepper motor. As such, there
        are some specific timing requirements. I like to pull it
        <code>LOW</code> for <code>3ms</code> and then pull it
        <code>HIGH</code> for an additional <code>3ms</code> and leave it in the
        high state until the next pulse. The documentation states it can be low
        for as short as <code>0.15us</code> but that didn&#39;t work for me
        consistently across other drives.
      </p>
      <h3>Write Data</h3>
      <p>
        If you want to know a lot more about this pin, head on over to the
        <a href="https://floppy.cafe/mfm.html">MFM ENCODING</a> page for a primer on how to use it.
        From a technical perspective, pulsing this pin will reverse the flux
        direction on the magnetized disk. In general, you will hold the pin
        <code>LOW</code> for about <code>0.15us to 1.1us</code> and then bring
        it back to a <code>HIGH</code> state. How long it remains in the high
        state determines the encoded value according to the MFM rules.
      </p>
      <h3>Write Gate</h3>
      <p>
        Pusling the write data pin will do nothing if the gate is closed. To
        begin writing data, you must pull this pin <code>LOW</code> and keep it
        low during your write operation.
      </p>
      <p>
        <b>You cannot read and write at the same time.</b>
      </p>
      <p>
        <b>Fun fact!</b> While I was developing my driver, I ruined many entire
        tracks by leaving this open for too long. If you aren&#39;t careful, it&#39;ll
        wreck the sector metadata and synchronization barriers and totally
        destroy your floppy disk. Reformatting the disk should restore balance
        to the force, so this won&#39;t be a total loss.
      </p>
      <h3>Track 00</h3>
      <p>
        The floppy drive controls this pin, and when it gets pulled
        <code>LOW</code> that means the read/write head is positioned on
         the first track  (<b>track 0</b>).
      </p>
      <h3>Write Protect</h3>
      <p>
        When a write-protected media is insertted, this pin will be pulled
        <code>LOW</code> by the floppy drive and the data on the disk is
        protected from mis-erasing. When the pin is <code>HIGH</code> the
        floppy drive can be written.
      </p>
      <p>
        This only seems to work if the <b>drive select</b> pin has been pulled
        low.
      </p>
      <h3>Read Data</h3>
      <p>
        A <code>HIGH</code> to <code>LOW</code> transition on this line
        indicates the flux direction has changed on the underlying magnetic
        disk. Once you encouter this transition, count all the clock cyles
        between the <i>leading edge</i> of the <code>LOW</code> signal to the
        <i>trailing edge</i> of the <code>HIGH</code> signal.
      </p>
      <h3>Side Select</h3>
      <p>
        These 3.5&#34; floppy disks have 2 sides. Pulling this pin
        <code>HIGH</code> selects the lower side (side 0). Pulling this pin
        <code>LOW</code> selects the upper side (side 1).
      </p>
      <h3>Ready/Disk Change</h3>
      <p>
        I never got this to work, but the spec says it will either tell you if
        the drive is in a ready state or not. When the floppy drive pulls this
        pin <code>LOW</code>, the drive is ready for operation. Otherwise, the
        pin will be left in a <code>HIGH</code> state.
      </p>
      <h2>
        <a id="synchronization-barriers" href="#synchronization-barriers"><img src="https://floppy.cafe/media/link.png"/></a>Synchronization
        Barriers
      </h2>
      <p>
        Between each track is a synchronization barrier. This barrier is
        surprisingly easy to find because it is just 12 <code>0x0</code> bytes
        followed by 3 <code>0xA1</code> bytes. In terms of pulses, it amounts to
        to 96 short pulses followed by the sequence of pulses <code>MLMLMSLMLMSLMLM</code>.
        You may have trouble reading all 96 pulses because of timing. A common
        practice is to seek for at least 80 pulses instead.
        This will give you a bit more resilience.
      </p>
      <h2>
        <a id="sector-metadata" href="#sector-metadata"><img src="https://floppy.cafe/media/link.png"/></a>Sector Metadata
      </h2>
      <p>
        Each sector is comprised of some metadata to describe it. The metadata
        is formatted like so:
        </p><ul>
          <li>12 bytes of <b>0x0</b></li>
          <li>3 bytes of <b>0xA1</b></li>
          <li>One byte of <b>0xFE</b></li>
          <li>One byte to indicate the track number</li>
          <li>One byte to indicate the side (or head)</li>
          <li>One byte to indicate thes sector number</li>
          <li>One byte to indicate the sector size</li>
          <li>2 bytes of CRC (cyclic redundancy code) computed from the sector
            metadata</li>
          <li>22 bytes of <b>0x4E</b></li>
          <li>12 bytes of <b>0x0</b></li>
          <li>3 bytes of <b>0xA1</b></li>
          <li>1 byte of either <b>0xFA</b> or <b>0xFB</b></li>
          <li>512 bytes of user data</li>
          <li>2 bytes of CRC computed from the user data</li>
          <li>Unspecified amount of <b>0x4E</b> bytes filling in the remaining
            space between sectors</li>
        </ul>
      
      <p>
        Upon careful inspection, we can see there are actually two
        synchronization barriers. One to find the sector metadata, and another
        to find the userspace data.
        The only difference is the byte that follows. For sectors, the immediate
        byte after the barrier is <b>0xFE</b>. For userspace data, it&#39;s either
        <b>0xFA</b> or <b>0xFB</b>.
        This is how we can determine which kind of barrier we&#39;ve run into.
      </p>
      <h2>
        <a id="track-metadata" href="#track-metadata"><img src="https://floppy.cafe/media/link.png"/></a>Track Metadata
      </h2>
      <p>
        Each track also has its own set of metadata which is formatted like so:
        </p><ul>
          <li>80 bytes of <b>0x4E</b></li>
          <li>12 bytes of <b>0x00</b></li>
          <li>3 bytes of <b>0xC3</b></li>
          <li>One byte of <b>0xFC</b></li>
          <li>50 bytes of <b>0x4E</b></li>
        </ul>
      
      <h2>
        <a id="further-reading" href="#further-reading"><img src="https://floppy.cafe/media/link.png"/></a>Further Reading
      </h2>
      <p>
        Here is a comprehensive list of additional resources:
        </p><ul>
          <li><a href="https://floppy.cafe/resources/SAMSUNG-SFD321B-070103.pdf" target="_blank" rel="noreferrer">SFD321B-070103.pdf</a></li>
          <li><a href="http://philipstorr.id.au/pcbook/book4/floppyd.htm" target="_blank" rel="noreferrer">Floppy Disk Formats</a></li>
          <li><a href="http://www.interfacebus.com/PC_Floppy_Drive_PinOut.html" target="_blank" rel="noreferrer">Floppy Drive PinOut</a></li>
          <li><a href="https://www.5volts.ch/posts/mfmreader/" target="_blank" rel="noreferrer">MFM Reader</a></li>
          <li><a href="https://github.com/SharpCoder/floppy-driver-rs" target="_blank" rel="noreferrer">(github) Floppy Driver RS</a></li>
          <li><a href="https://github.com/adafruit/Adafruit_Floppy/tree/main" target="_blank" rel="noreferrer">(github) Adafruit Floppy Reader</a></li>
          <li><a href="https://github.com/dhansel/ArduinoFDC" target="_blank" rel="noreferrer">(github) Arduino FDC</a></li>
        </ul>
      
      <p>
        Next, let&#39;s check out <a href="https://floppy.cafe/mfm.html">MFM ENCODING</a> to learn more
        about how data is stored.
      </p>
    </div></div>
  </body>
</html>
