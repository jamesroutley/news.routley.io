<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.n16f.net/blog/making-ielm-more-comfortable/">Original</a>
    <h1>Making IELM (Emacs Lisp REPL) More Comfortable</h1>
    
    <div id="readability-page-1" class="page"><div>
    <section>
      <p>IELM is the Emacs Lisp REPL. It lets you evaluate any Elisp expression, prints
the output and keeps track of previous commands. While it is a serious step-up
from the humble <code>eval-expression</code>, it can be uncomfortable on several aspects.
Let us improve it.</p>
<h2 id="adding-eldoc-hints">Adding Eldoc hints</h2>
<p>Eldoc is a generic module used to display realtime documentation hints while
you type. For Emacs Lisp, it means displaying docstrings when your
cursor is over a symbol or when you start writing a function call.</p>
<p>When calling a function, you often need a quick remainder about the arguments.
Having Eldoc means you do not have to call <code>C-h f</code> and deal with the
documentation buffer, and can just glance at the echo area.</p>
<p>To enable Eldoc in IELM, let us add it to the initialization hook:</p>
<pre><code>(add-hook &#39;ielm-mode-hook &#39;eldoc-mode)
</code></pre>
<h2 id="using-paredit">Using Paredit</h2>
<p><a href="https://paredit.org/">Paredit</a> is an essential minor mode that lets you
manipulate Lisp code as expressions and not as simple text. If you are not
using it and think that editing all these parentheses is annoying, you are
missing out. Give it a try, you will not be disappointed.</p>
<p>To use Paredit in IELM, we add it to the initialization hook:</p>
<pre><code>(add-hook &#39;ielm-mode-hook &#39;paredit-mode)
</code></pre>
<p>Infortunately there is a key conflict between Paredit and IELM. Paredit
overrides <code>return</code> to execute <code>paredit-RET</code>, meaning that the original
<code>ielm-return</code> is not called.</p>
<p>The simplest way to fix it is to alter the Paredit keymap:</p>
<pre><code>(define-key paredit-mode-map (kbd &#34;RET&#34;) nil)
(define-key paredit-mode-map (kbd &#34;C-j&#34;) &#39;paredit-newline)
</code></pre>
<p>We remove the entry associated with <code>return</code> and use <code>C-j</code> to insert a newline
character, useful to write a multiline expression.</p>
<h2 id="making-the-command-history-persistent">Making the command history persistent</h2>
<p>The most annoying part of IELM is that it does not have persistent history. I
expect any interactive command system to store past entries since they can
always be useful again. ZSH has persistence, so does the
<a href="https://slime.common-lisp.dev/">SLIME</a> Common Lisp REPL. IELM does not, even
though Comint (the mode IELM derives from) can handle it.</p>
<p>Let us add it. First we will write a function to configure Comint and load any
entry stored in the history file if it exists:</p>
<pre><code>(defun g-ielm-init-history ()
  (let ((path (expand-file-name &#34;ielm/history&#34; user-emacs-directory)))
    (make-directory (file-name-directory path) t)
    (setq-local comint-input-ring-file-name path))
  (setq-local comint-input-ring-size 10000)
  (setq-local comint-input-ignoredups t)
  (comint-read-input-ring))
</code></pre>
<p>We store the history in the <code>ielm/history</code> file in the user Emacs directory,
mimicking the <code>eshell/history</code> file used by Eshell.</p>
<p>Nothing complicated: we increase the number of entries stored in the history
file, and tell Comint to drop duplicate entries. We also are careful and use
<code>setq-local</code> to make sure Comint settings are only modified for the current
buffer and not globally, since other buffers using different Comint-based
modes could have different requirements.</p>
<p>We want to call this function when IELM start:</p>
<pre><code>(add-hook &#39;ielm-mode-hook &#39;g-ielm-init-history)
</code></pre>
<p>Reading the history is one thing. We need a way to add all expressions we
evaluate to it. It would have been nice to have a hook called everytime an
expression is entered, but we have to do without it. We are going to use Elisp
<a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Advising-Functions.html">advices</a>
to evaluate code each time a specific function is called. We want to write
the history file when <code>ielm-send-input</code> returns:</p>
<pre><code>(defun g-ielm-write-history (&amp;rest _args)
  (with-file-modes #o600
    (comint-write-input-ring)))
  
(advice-add &#39;ielm-send-input :after &#39;g-ielm-write-history)
</code></pre>
<p>Advising functions are called with the same arguments as the advised function.
We do not care about them, so we use the <code>&amp;rest</code> keyword to match all
arguments passed to <code>g-ielm-write-history</code>.</p>
<p>We are careful to use <code>with-file-modes</code> to make sure the file is always
created as only readable by the user, since it may contain private
information.</p>
<p>This was not easy, but persistent history is worth it!</p>
<h2 id="useful-key-bindings">Useful key bindings</h2>
<p>Finally we will bind two key combinations.</p>
<p>First the very common <code>C-l</code> to clear the buffer. All modes deriving from
Comint have <code>C-c M-o</code>, but it is awkward to type and <code>C-l</code> is very common in
various applications.</p>
<pre><code>(define-key inferior-emacs-lisp-mode-map (kbd &#34;C-l&#34;)
            &#39;comint-clear-buffer)
</code></pre>
<p>Then we want a way to search through old expressions. Comint has
<code>comint-history-isearch-backward-regexp</code> which is incredibly primitive. We can
get a far better experience with <a href="https://github.com/emacs-helm/helm">Helm</a>.
The <code>helm-comint-input-ring</code> function lets us browse among old expressions and
select one through incremental search. We bind it to <code>C-r</code>:</p>
<pre><code>(define-key inferior-emacs-lisp-mode-map (kbd &#34;C-r&#34;)
            &#39;helm-comint-input-ring)
</code></pre>
<p>IELM is so much more comfortable to use now!</p>

    </section>
  </div></div>
  </body>
</html>
