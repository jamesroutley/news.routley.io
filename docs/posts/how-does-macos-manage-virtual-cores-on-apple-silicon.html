<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://eclecticlight.co/2023/10/23/how-does-macos-manage-virtual-cores-on-apple-silicon/">Original</a>
    <h1>How does macOS manage virtual cores on Apple Silicon?</h1>
    
    <div id="readability-page-1" class="page"><div data-first_letter="O">
		<p>One of the most distinctive features of Apple silicon chips is that they have two types of CPU core, E (Efficiency) cores that are energy efficient but slower than the P (Performance) cores, which normally run much of the code in the apps we use. Apps don’t decide directly which cores they will be run on, that’s a privilege of macOS, but they register their interest by setting a Quality of Service, or QoS, which is then taken into account when they’re scheduled to run. With the introduction of <a href="https://eclecticlight.co/2023/10/18/how-game-mode-manages-cpu-and-gpu/">Game Mode</a> in Sonoma, CPU scheduling can now work differently, with E cores being reserved for the use of games. This article looks at another atypical situation, when running a macOS virtual machine (VM) assigned a set number of virtual cores. How does macOS Sonoma handle that?</p>
<h4>CPU cores</h4>
<p>M-series chips contain different types and numbers of CPU cores, depending on the model:</p>
<ul>
<li>Base models contain 4 E and 4 P cores; for the M1, those are Icestorm and Firestorm respectively, while the M2 has Blizzard and Avalanche. These are configured in two clusters, one containing the E cores, the other the P cores. Within each cluster, all cores are run at the same frequency, and they share L2 cache.</li>
<li>Pro and Max models contain 2-4 E and 6-8 P cores, in one E cluster and two P clusters, again running at a common frequency within the cluster, and sharing L2 cache.</li>
<li>Ultra models contain 4 (M1) or 8 (M2) E and 16 P cores, their clusters having common frequencies and L2 caches.</li>
</ul>
<p>In broad terms, allocation of executable threads to different cores depends on:</p>
<ul>
<li>The <strong>QoS</strong> assigned to each thread. Those given low values for background and maintenance tasks, including Time Machine backups and Spotlight indexing, are run on E cores, and have no external control to allow their rescheduling to P cores. Those with higher QoS can be run on either P or E cores, and external controls can restrict them to E cores alone, although they’ll normally be run on P cores when they’re available.</li>
<li><strong>Clustering</strong>. Because all cores in a cluster run at the same frequency, it’s more efficient to recruit additional cores in the same cluster, as they’ll already be running at a higher frequency, rather than a core in a different cluster, whose frequency may then need to be increased. Clusters are normally recruited in sequence too: in Macs with two P clusters, threads are normally run on the first of those (P0), and only when additional cores are required is the second (P1) recruited. Running with a light load, P0 is therefore likely to be more active than other P clusters, which may spend long periods idling.</li>
<li><strong>Order</strong> within a cluster. Although applied more loosely than other principles, there is an observed tendency to recruit cores in order within a cluster. Where the P0 cluster contains cores P2, P3, P4 and P5, threads tend to be loaded onto P2 first, and P5 last. However, running threads are often relocated within a cluster, following which P2 may be left idle, while P5 bears the brunt.</li>
</ul>
<p>Thread scheduling and dispatch contains many more subtleties, but those influences normally dominate what you see in practice.</p>
<h4>Virtual CPU cores</h4>
<p>Under macOS lightweight virtualisation, virtual machines (VMs) are allocated a number of virtual CPU cores, all of which are the same type, equivalent to a P core. There is thus no option to allocate threads running in the VM to E cores on the host. This is illustrated in the following examples shown in Activity Monitor’s CPU History window.</p>
<p><span><img data-attachment-id="75509" data-permalink="https://eclecticlight.co/vm2shothostlohi/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg" data-orig-size="1062,1114" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="vm2shotHostloHi" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=286" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=940" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=940" alt="vm2shotHostloHi" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg 1062w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=143&amp;h=150 143w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=286&amp;h=300 286w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=768&amp;h=806 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shothostlohi.jpg?w=976&amp;h=1024 976w" sizes="(max-width: 1062px) 100vw, 1062px"/></span></p>
<p>Two different loads were applied to the M1 Max shown here: the two long peaks seen on the E cores were floating-point threads at a QoS of 9 for a background task, while the shorter peaks on four P cores were the same threads at a QoS of 33 for priority user tasks.</p>
<p><span><img data-attachment-id="75511" data-permalink="https://eclecticlight.co/vm2shotvmvmlowhigh/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png" data-orig-size="908,474" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="vm2shotVMVMlowhigh" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png?w=908" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png?w=940" alt="vm2shotVMVMlowhigh" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png 908w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png?w=150&amp;h=78 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png?w=300&amp;h=157 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmvmlowhigh.png?w=768&amp;h=401 768w" sizes="(max-width: 908px) 100vw, 908px"/></span></p>
<p>When the same sequence was run on a VM with 4 virtual CPU cores, the QoS made no difference to the performance or core allocation seen in the VM.</p>
<p><span><img data-attachment-id="75510" data-permalink="https://eclecticlight.co/vm2shotvmhostlowhigh/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg" data-orig-size="1062,1114" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="vm2shotVMhostlowhigh" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=286" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=940" alt="vm2shotVMhostlowhigh" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg 1062w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=143&amp;h=150 143w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=286&amp;h=300 286w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=768&amp;h=806 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm2shotvmhostlowhigh.jpg?w=976&amp;h=1024 976w" sizes="(max-width: 1062px) 100vw, 1062px"/></span></p>
<p>On the host, both thread loads were run similarly on the first cluster of P cores. This might suggest that the host simply hands over the cluster of P cores to be scheduled and dispatched by the VM. If you rely on what you’re shown in Activity Monitor, you could be tempted to reach that conclusion.</p>
<h4>Methods</h4>
<p>To assess core allocation for VMs, I used a Mac Studio M1 Max running Sonoma 14.0. A Sonoma 14.0 VM was built using Viable, and run during tests using that virtualisation app. Test loads were applied from the VM using my app AsmAttic, each thread running 5 x 10^8 tight loops of purposeless assembly code performing floating point arithmetic using registers alone. I detailed <a href="https://eclecticlight.co/2021/11/26/how-can-you-compare-the-performance-of-m1-chips-2-core-allocation/">this here</a>. Each thread typically takes about 3.2 seconds to complete, and serves here as an in-core load, not a benchmark. During each of those runs, <code>powermetrics</code> was run on the host to log <code>cpu_power</code> measurements over 0.1 second sampling periods. Frequency and active residency for all the cores was then extracted and analysed using DataGraph. Test runs included the same VM configured with 3 and 4 virtual cores, and with 1-6 threads, all at a QoS of 33.</p>
<h4>Single threads</h4>
<p><span><img data-attachment-id="75514" data-permalink="https://eclecticlight.co/vm3core1thrfrequency/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png" data-orig-size="1050,850" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="vm3core1thrFrequency" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=940" alt="vm3core1thrFrequency" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png 1050w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=150&amp;h=121 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=300&amp;h=243 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=768&amp;h=622 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thrfrequency.png?w=1024&amp;h=829 1024w" sizes="(max-width: 1050px) 100vw, 1050px"/></span></p>
<p>Running a single thread on three or four virtual cores resulted in the expected rapid change in P0 cluster frequency (above), and in active residency (percentage of available processor cycles that aren’t idle), shown below. As this gives total active residency for the whole cluster of four cores, its maximum is 400%. Although there are small peaks above the expected 100% for a single thread, those were probably threads from other processes.</p>
<p><span><img data-attachment-id="75513" data-permalink="https://eclecticlight.co/vm3core1thractresidency/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png" data-orig-size="1050,850" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="vm3core1thrActResidency" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=940" alt="vm3core1thrActResidency" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png 1050w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=150&amp;h=121 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=300&amp;h=243 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=768&amp;h=622 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresidency.png?w=1024&amp;h=829 1024w" sizes="(max-width: 1050px) 100vw, 1050px"/></span></p>
<h4>Multiple threads</h4>
<p>As the number of threads run on the VM increases, so the number of cores running them rises to the limit imposed by the number of virtual cores. Looking first at the effect on host clusters, these might imply that VM threads are confined to the single P cluster, P0.</p>
<p><span><img data-attachment-id="75516" data-permalink="https://eclecticlight.co/vm4core4threadfreq/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png" data-orig-size="1107,892" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="VM4core4threadFreq" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=940" alt="VM4core4threadFreq" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png 1107w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=150&amp;h=121 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=300&amp;h=242 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=768&amp;h=619 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadfreq.png?w=1024&amp;h=825 1024w" sizes="(max-width: 1107px) 100vw, 1107px"/></span></p>
<p>This chart shows cluster frequencies for the three clusters in the M1 Max. The test load was applied just after 1 second, and was completed at about 4 seconds, matching the reported elapsed time of about 3.2 seconds. P0 frequency (solid line) rose rapidly to just over 3,000 MHz, and was sustained at that until completion. The other P cluster (P1) was run much of that time at its idle of 600 MHz, with short peaks up to 2,500 MHz. The E cluster was run throughout at about 1,000 MHz, with fewer and smaller peaks.</p>
<p><span><img data-attachment-id="75515" data-permalink="https://eclecticlight.co/vm4core4threadactres/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png" data-orig-size="1107,892" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="VM4core4threadActRes" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=940" alt="VM4core4threadActRes" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png 1107w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=150&amp;h=121 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=300&amp;h=242 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=768&amp;h=619 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadactres.png?w=1024&amp;h=825 1024w" sizes="(max-width: 1107px) 100vw, 1107px"/></span></p>
<p>Here, to enable easier comparison, cluster active residency is shown with a scale maximum of 100% for each of the three clusters. The effect of the load on P0 active residency (solid line) dominates much as it did for frequency, but there are also many smaller and briefer peaks. To unravel what those represent, you need to analyse individual core responses.</p>
<h4>Individual P cores</h4>
<p>A simple starting point is analysing the active residency in P0 by individual core, for a single thread test.</p>
<p><span><img data-attachment-id="75512" data-permalink="https://eclecticlight.co/vm3core1thractresbycore/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png" data-orig-size="1050,850" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="vm3core1thrActResByCore" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=940" alt="vm3core1thrActResByCore" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png 1050w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=150&amp;h=121 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=300&amp;h=243 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=768&amp;h=622 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm3core1thractresbycore.png?w=1024&amp;h=829 1024w" sizes="(max-width: 1050px) 100vw, 1050px"/></span></p>
<p>This bar chart shows just the test period, here as sample number rather than time (each sample representing approximately 0.1 second). Active residency for the first core, P2, is shown in red, P3 in orange, P4 in blue, and P5 in purple. The bulk of the test thread was run on P2 to begin with, swapped over to P4, then brought back to P2 to complete. There are, though, significant contributions made by P3 as well.</p>
<p>Extending this analysis to other thread numbers, and 4 virtual cores, demonstrated that all cores in the P0 were used to run the test threads, which were moved around not infrequently during each test run.</p>
<p><span><img data-attachment-id="75517" data-permalink="https://eclecticlight.co/vm4core4threadpcoresares/" data-orig-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png" data-orig-size="1108,871" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="VM4core4threadPcoresARes" data-image-description="" data-image-caption="" data-medium-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=300" data-large-file="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=940" loading="lazy" src="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=940" alt="VM4core4threadPcoresARes" srcset="https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png 1108w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=150&amp;h=118 150w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=300&amp;h=236 300w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=768&amp;h=604 768w, https://eclecticlightdotcom.files.wordpress.com/2023/10/vm4core4threadpcoresares.png?w=1024&amp;h=805 1024w" sizes="(max-width: 1108px) 100vw, 1108px"/></span></p>
<p>It’s only when you look at active residency across all P cores that the picture becomes clear: when the second P cluster is active, it appears to be handling some of the test load. This shows active residency for all eight P cores, when running 4 threads on 4 virtual cores. To maintain the 400% required to complete the threads on time, there are several sample periods in which P6 and P7 take significant load, for example in samples 12 and 27, about 1 and 2.5 seconds into the test.</p>
<p>Core allocation of threads being run on virtual cores thus appears to follow the same general rules as host threads running at high QoS, and shows no particular affinity for clusters or cores. Thus virtualisation isn’t a different mode, as far as core allocation is concerned.</p>
<h4>Conclusions</h4>
<ul>
<li>Threads from VM virtual cores are invariably run at high QoS, and are scheduled and dispatched by the host macOS in accordance with its normal rules. Virtualisation doesn’t bring any special core allocation or CPU performance mode.</li>
<li>Those threads are mobile across cores as with any other thread.</li>
<li>There’s no evidence that macOS makes any attempt to allocate virtual cores to physical cores.</li>
<li>Software in a VM has no means of designating that any of its threads should be run at lower QoS, or on host E cores. VMs thus lack energy efficiency and background performance advantages of macOS running on an Apple silicon host.</li>
</ul>
	</div></div>
  </body>
</html>
