<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.infoq.com/news/2023/07/yelp-corrupted-cassandra-rebuild/">Original</a>
    <h1>Yelp Rebuilds Corrupted Cassandra Cluster Using Its Data Streaming Architecture</h1>
    
    <div id="readability-page-1" class="page"><div>
								<p>Yelp <a href="https://engineeringblog.yelp.com/2023/01/rebuilding-a-cassandra-cluster-using-yelps-data-pipeline.html">created a solution to sanitize data from the corrupted Apache Cassandra cluster</a> utilizing its data streaming architecture. The team explored many potential options to address the data corruption issue, however ultimately had to move the data into a new cluster to remove corrupted records in the process.</p>

<p>Yelp uses <a href="https://cassandra.apache.org/_/index.html">Apache Cassandra</a> as the data store for many parts of its platform. The company tends to run many smaller Cassandra clusters for specific use cases based on data, traffic, and business requirements. Initially, Cassandra clusters were hosted directly on EC2, but more recently, they transitioned most of them to <a href="https://kubernetes.io/">Kubernetes</a> using <a href="https://engineeringblog.yelp.com/2020/11/orchestrating-cassandra-on-kubernetes-with-operators.html">a dedicated operator</a>.</p>

<p>The team has discovered that one of the Cassandra clusters running on EC2 was affected by data corruption that regular data maintenance tools could not address. Over time the situation was getting worse, impacting cluster health even further.</p>

<p><a href="https://www.linkedin.com/in/muhammad-junaid-muzammil/">Muhammad Junaid Muzammil</a>, a software engineer at Yelp, explains the reasons for opting to rebuild the corrupted Cassandra cluster:</p>

<blockquote>
<p>Since the corruption was widespread, removing SSTables and running repairs wasn’t an option, as it would have led to data loss. Also, based on corruption size estimates and recent data value, we opted not to restore the cluster to the last corruption free backed up state.</p>
</blockquote>

<p>The team opted to use a design inspired by sortation systems used in the manufacturing industry to remove defective products from reaching the end of the production line. They created a data pipeline using <a href="https://engineeringblog.yelp.com/2016/08/paastorm-a-streaming-processor.html">their PaaStorm streaming processor</a> and the Cassandra Source connector that relies on <a href="https://cassandra.apache.org/doc/latest/cassandra/operating/cdc.html">Change Data Capture (CDC)</a> feature, available in Cassandra from version 3.8.</p>

<p><img alt="" data-src="news/2023/07/yelp-corrupted-cassandra-rebuild/en/resources/1mitigation-strategy-1689337695832.jpeg" src="https://imgopt.infoq.com/fit-in/1200x2400/filters:quality(80)/filters:no_upscale()/news/2023/07/yelp-corrupted-cassandra-rebuild/en/resources/1mitigation-strategy-1689337695832.jpeg" rel="share"/></p>

<p><em>High-Level View of Data Corruption Mitigation Pipeline (Source: <a href="https://engineeringblog.yelp.com/2023/01/rebuilding-a-cassandra-cluster-using-yelps-data-pipeline.html">Rebuilding a Cassandra cluster using Yelp’s Data Pipeline</a>)</em></p>

<p>The Data Infrastructure team created a new Cassandra cluster on Kubernetes, benefiting from many hardware and software upgrades. The data pipeline used a Stream SQL processor to define data sanitation criteria, splitting the data between valid and malformed streams. Using the Cassandra Sink Connector, the pipeline fed the sanitized data stream into the new Cassandra cluster. The malformed data stream was used to analyze the data corruption&#39;s severity further.</p>

<p>The team used a statistical sampling technique to validate the overall data migration process, inspecting a small subset of the data by comparing the data imported into the new cluster against the old one.</p>

<p>Before switching the traffic to the new cluster, the team created a setup where read requests were sent to both clusters, and the returned data was compared. They analyzed the logged results and estimated that 0.009% of the data were corrupted in the old cluster. Finally, the traffic was seamlessly switched to the new cluster, and the corrupted one was torn down.</p>

<p><img alt="" data-src="news/2023/07/yelp-corrupted-cassandra-rebuild/en/resources/1validation-comparison-tee-1689337695832.jpeg" src="https://imgopt.infoq.com/fit-in/1200x2400/filters:quality(80)/filters:no_upscale()/news/2023/07/yelp-corrupted-cassandra-rebuild/en/resources/1validation-comparison-tee-1689337695832.jpeg" rel="share"/></p>

<p><em>Data Validation Approach For Read Requests (Source: <a href="https://engineeringblog.yelp.com/2023/01/rebuilding-a-cassandra-cluster-using-yelps-data-pipeline.html">Rebuilding a Cassandra cluster using Yelp’s Data Pipeline</a>)</em></p>

								









  
    

							</div></div>
  </body>
</html>
