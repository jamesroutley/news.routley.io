<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jvns.ca/blog/2021/12/06/dns-doesn-t-propagate/">Original</a>
    <h1>DNS &#34;propagation&#34; is actually caches expiring</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>Hello! Yesterday I <a href="https://twitter.com/b0rk/status/1467585993138229248">tweeted this</a>:</p>
<blockquote><p lang="en" dir="ltr">I feel like the term &#34;DNS propagation&#34; is misleading, like you&#39;re not actually waiting for DNS records to &#34;propagate&#34;, you&#39;re waiting for cached records to expire</p>‚Äî üîéJulia Evansüîç (@b0rk) <a href="https://twitter.com/b0rk/status/1467585993138229248?ref_src=twsrc%5Etfw">December 5, 2021</a></blockquote> 
<p>and I want to talk about it a little more. This came up because I was showing a
friend a demo of how DNS caching works last week, and he realized that what was
happening in the demo didn‚Äôt line up with his mental model of how DNS worked.
He immediately brought this up and adjusted his mental model (‚Äúoh, DNS records are
<strong>pulled</strong>, not <strong>pushed</strong>!‚Äú). But this it got me thinking ‚Äì why did my very
smart and experienced friend have an inaccurate mental model for how DNS works
in the first place?</p>
<p>First ‚Äì I‚Äôm very tired of posts that complain about how people are ‚Äúwrong‚Äù about how a
given piece of technology works without explaining why it‚Äôs helpful to be
‚Äúright‚Äù. So here‚Äôs why I like knowing how DNS works.</p>
<h3 id="having-a-correct-mental-model-for-dns-helps-me-make-updates-faster">having a correct mental model for DNS helps me make updates faster</h3>
<p>A common piece of advice I see for handling DNS updates is ‚Äúwait 24-48 hours‚Äù.
But I am very impatient, and I do NOT want to wait 48 hours! But if I want to
confidently ignore this advice (and I really do!!!), then I have to actually
understand how DNS works.</p>
<p>And it is possible to ignore this ‚Äú24-48 hours‚Äù advice sometimes! It even turns
out that in some cases (like when creating a record for a new name that didn‚Äôt
have any records before), you don‚Äôt need to wait for DNS updates at all! It‚Äôs the best.</p>
<p>And of course, knowing how DNS works makes me much more confident debugging
DNS problems when things go wrong, which always feels good.</p>
<p>Now that I‚Äôve hopefully made a case for why this is interesting to understand, let‚Äôs talk about how DNS updates work!</p>
<h3 id="dns-is-pull-not-push">DNS is pull, not push</h3>
<p>When you make a DNS request (for example when you type <code>google.com</code> in your
browser), you make a request to a <strong>DNS resolver</strong>, like <code>8.8.8.8</code>.</p>
<p>When you create a DNS record for a domain, you set the DNS record on an <strong>authoritative nameserver</strong>.</p>
<p>There are 2 ways you could imagine this working:</p>
<ol>
<li>When an authoritative nameserver gets an update for a DNS record, it immediately starts pushing updates to every resolver it knows about <strong>(false)</strong></li>
<li>The authoritative nameserver never pushes updates, it just replies with the current record when it receives a query <strong>(true)</strong></li>
</ol>
<p>In fact, if you create a DNS record, it‚Äôs possible that no DNS resolver will
ever know about it! For example, I just created a record for a subdomain of
jvns.ca that I will not tell you. Nobody will ever make a DNS query for that
subdomain (I‚Äôm not going to make one, and you can‚Äôt because I didn‚Äôt tell you
what it is!), so no resolver knows about it.</p>
<h3 id="new-dns-records-are-actually-available-instantly">new DNS records are actually available instantly</h3>
<p>I just created a TXT record at <code>newrecord.jvns.ca</code> with the content ‚Äúi‚Äôm a new
record‚Äù. Then a few seconds later, I went to
<a href="https://www.whatsmydns.net/#TXT/newrecord.jvns.ca">https://www.whatsmydns.net/#TXT/newrecord.jvns.ca</a>
to see where that DNS record was available. And it was immediately available
everywhere in the world, even though only 10 seconds had passed. No wait!</p>
<p>This is how CDNs work too ‚Äì if you request a new resource that hasn‚Äôt be
requested before, you‚Äôll get it right away.</p>
<h3 id="why-dns-updates-take-time-caching">why DNS updates take time: caching</h3>
<p>But when you update a DNS record, it <em>is</em> slow! So why is that, if records
don‚Äôt need time to get pushed out? Well, DNS resolvers like <code>8.8.8.8</code> cache DNS
records.</p>
<p>And if those cached records are still valid, they‚Äôll never request a new
record! So a DNS update doesn‚Äôt fully take effect until <strong>all cached versions
of that record have expired</strong>. When people say ‚Äúwe‚Äôre waiting for DNS to propagate‚Äù, what they
actually mean is ‚Äúwe‚Äôre waiting for cached records to expire‚Äù.</p>
<p>You might think that if you have a record where the TTL is 60, resolvers will
cache it for 60 seconds, so you just need to wait 60 seconds for the change to
be applied. But that would be too easy! So let‚Äôs talk about a few reasons that
caches could take a longer time to expire (like an hour or a day).</p>
<p><strong>slow update reason 1: some resolvers ignore TTLs</strong></p>
<p>We said before that for a DNS update to fully take effect, all cached versions
of that record need to expire. In theory, the TTL (‚Äútime to live‚Äù) on the
record determines how long resolvers cache your record before. But that would
be too easy :(</p>
<p>Instead, very rudely, some resolvers will ignore your TTL and just cache your
record for as long as you feel like! Like 24 hours!</p>
<p>So your DNS records updates might take more time to take effect than you‚Äôd
expect from the TTL.</p>
<p><strong>slow update reason 2: negative DNS caching</strong></p>
<p>If you query for a DNS record that <strong>doesn‚Äôt exist</strong>, your resolver might cache the <strong>absence</strong> of that record.
This has happened to me a lot of times and it‚Äôs always super frustrating ‚Äì here‚Äôs how it goes:</p>
<ol>
<li>I visit <code>something.mydomain.com</code> before creating the DNS record</li>
<li>I create the record</li>
<li>Then I visit it again. But it doesn‚Äôt work for a long time!!! Except after some mysterious amount of time it suddenly starts working?? Why???</li>
</ol>
<p>One day recently I decided to actually find out why this was happening, found a
Stack Overflow answer talking about it, and of course the answer is in a DNS
RFC! The <a href="https://www.rfc-editor.org/rfc/rfc2308">RFC for negative caching</a>
says that the TTL for negative caching is ‚Äúthe minimum of the MINIMUM field of
the SOA record and the TTL of the SOA itself‚Äù.</p>
<p>Let‚Äôs see what that is for subdomains of <code>jvns.ca</code>:</p>
<pre><code>$ dig soa jvns.ca 
jvns.ca.		3600	IN	SOA	art.ns.cloudflare.com. dns.cloudflare.com. 2264245811 10000 2400 604800 3600
</code></pre>
<p>It‚Äôs the minimum of the SOA TTL (3600) and the
last number in the SOA record‚Äôs value (3600). So negative caching will happen
for an hour. And sure enough, the last time I caused this problem for myself, I
waited an hour and everything worked! Hooray!</p>
<p>While testing this, I noticed that Cloudflare‚Äôs resolver (1.1.1.1) doesn‚Äôt seem
to do negative DNS caching, but my ISP‚Äôs resolver does. Weird!</p>
<p><strong>slow update reason 3: browser and OS caching</strong></p>
<p>DNS resolvers aren‚Äôt the only place DNS records are cached ‚Äì your browser and
OS might also be caching DNS records!</p>
<p>For example, in Firefox I sometimes need to press Ctrl+Shift+R to force reload
a page after a DNS change, even if the TTL has expired and there‚Äôs a new record
available. So Firefox seems to cache a little more aggressively than my DNS
resolver does.</p>
<p><strong>slow update reason 4: nameserver records are cached for a long time</strong></p>
<p>Just making changes to DNS records is normally relatively fast, as long as you
have a short TTL. But changing your domain‚Äôs nameservers can take more time. This is because to change your nameservers, 2 things have to happen:</p>
<ol>
<li>Your registrar has to tell your TLD‚Äôs nameservers about the new nameservers for your domain (I don‚Äôt know exactly how long this takes or why it takes time, but it‚Äôs not instant!)</li>
<li>Resolvers have cached records for your nameserver, and those records need to expire. The TTL on those records is usually something like 1 day, so this can easily take a day.</li>
</ol>
<p>For example, I just changed the nameservers for a domain I don‚Äôt use 5 minutes
ago, and step 1 isn‚Äôt even done yet!</p>
<h3 id="dns-resolvers-are-a-bit-like-cdns">DNS resolvers are a bit like CDNs</h3>
<p>If you already know how content delivery networks work, here‚Äôs an analogy! The
way DNS resolver caching works is similar to how CDN caching work in a couple of ways:</p>
<ol>
<li>they both have an origin server (for DNS, the authoritative name server, for CDNs, the HTTP origin)</li>
<li>they both expire their caches at some point (for DNS, when the TTL expires or maybe later if that‚Äôs the resolver‚Äôs policy, and for CDNs based on the HTTP <code>Cache-Control</code> header, or whatever the CDN‚Äôs policy is)</li>
</ol>
<p>There are differences too ‚Äì for example, CDNs usually have a way to purge
records (which is VERY useful), and DNS often don‚Äôt. Though
8.8.8.8 seems to have a <a href="https://developers.google.com/speed/public-dns/cache">‚Äúflush cache‚Äù feature</a>. And CDNs are
much more centralized. DNS resolvers are much more difficult to work with
because there are thousands of different DNS resolvers run by different
organizations and running different software and there‚Äôs no way to control what
they do directly.</p>
<h3 id="the-term-dns-propagation-feels-misleading-to-me">the term ‚ÄúDNS propagation‚Äù feels misleading to me</h3>
<p>I feel like the widespread use of the term ‚ÄúDNS propagation‚Äù is a little‚Ä¶
misleading? I‚Äôm not going to pretend to have a better term, but the reason that
so many people have an incorrect mental model of how DNS works isn‚Äôt because
they‚Äôre dumb ‚Äì the ‚Äúpropagation‚Äù terminology we use to talk about why DNS
updates are slow implies an incorrect mental model! No wonder people are
confused!</p>
<p>For most programmers, ‚Äúthere are a bunch of cached records you have
no control over and you need to wait for them to expire‚Äù is a pretty normal and
approachable concept! We deal with caching all the time, and we all
know why it‚Äôs frustrating to deal with. So it seems to me like if we used a
term that‚Äôs more accurate, people would default to a more correct model of how
DNS works.</p>
<p>Of course, I‚Äôm not sure that the term ‚ÄúDNS propagation‚Äù is <em>why</em> people like my
friend end up with an incorrect mental model for how DNS works. That‚Äôs a strong
statement and I don‚Äôt have a lot of evidence for it! But I did get quite a few
of responses to my original tweet saying that just that 1 sentence (‚Äúyou‚Äôre not
actually waiting for DNS records to ‚Äúpropagate‚Äù, you‚Äôre waiting for cached
records to expire‚Äù) cleared up some confusion for them.</p>
<p>And I‚Äôm definitely not the first person to think that the term ‚Äúpropagation‚Äù is
misleading. A couple of examples:</p>
<ul>
<li><a href="https://www.nslookup.io/blog/dns-propagation-does-not-exist/">DNS propagation does not exist</a></li>
<li>this <a href="https://www.whatsmydns.net/#">DNS propagation checker</a> says on its
homepage ‚ÄúWhile technically DNS <strong>does not propagate</strong>, this is the term that
people have become familiar with‚Ä¶‚Äù</li>
</ul>
<h3 id="okay-dns-records-actually-do-propagate">okay, DNS records actually do ‚Äúpropagate‚Äù.</h3>
<p>Okay, so if DNS record don‚Äôt ‚Äúpropagate‚Äù, why do we use the term ‚ÄúDNS
propagation?‚Äú. There must be a reason, right? Well, I <a href="https://twitter.com/b0rk/status/1467585993138229248">posted on twitter about
this actually</a>, and a few
people mentioned that DNS records actually <em>do</em> get ‚Äúpushed out‚Äù. But pushing
out these changes is pretty fast and it‚Äôs not why DNS updates are slow.</p>
<p>My understanding of this is that:</p>
<ol>
<li>If you run a big authoritative DNS server, you want to run it globally so
that people can get DNS responses quickly no matter where they are in the
world</li>
<li>When there‚Äôs an update, it needs to get synced to all the other
authoritative servers globally, and that syncing takes time</li>
</ol>
<p>But this delay isn‚Äôt what people are referring to when they talk about ‚ÄúDNS
propagation‚Äù. My guess is that in the vast majority of cases, this propagation
delay is at most a couple of minutes. I‚Äôve never actually seen this delay
happening in practice when I‚Äôve set a DNS record.</p>
<p>And when people talk about ‚ÄúDNS propagation‚Äù, they‚Äôre basically always talking
about waiting for cached records to expire, which can easily take hours or
days.</p>
<h3 id="maybe-we-use-the-term-propagation-for-historical-reasons">maybe we use the term ‚Äúpropagation‚Äù for historical reasons?</h3>
<p>In the 90s, maybe DNS records really did take multiple hours to get
‚Äúpropagated‚Äù and pushed out, and so it was more accurate to use the term
‚Äúpropagation‚Äù to describe why you needed to wait? And maybe that‚Äôs why we still
use the term ‚Äúpropagation‚Äù to talk about the reason for DNS delays? I have no
idea how DNS worked in the 90s though.</p>
<h3 id="this-terminology-is-probably-here-to-stay">this terminology is probably here to stay</h3>
<p>I‚Äôm not trying to say here that people should stop using the term ‚ÄúDNS
propagation‚Äù to talk about waiting for cached records to expire. I‚Äôm probably
going to keep using it sometimes ‚Äì it‚Äôs a very widely used term that a lot of
people recognize! And if everyone in the conversation already has an accurate
understanding of how DNS works, using the term ‚ÄúDNS propagation‚Äù of course
isn‚Äôt going to suddenly make people forget how DNS actually works :)</p>
<p>But I do think it‚Äôs important to recognize when terms we use are potentially
misleading. I think I‚Äôm going to be more careful about using it in the
future, especially when explaining DNS to people who don‚Äôt have a good
understanding of it yet.</p>
<h3 id="that-s-all">that‚Äôs all!</h3>
<p>I hope that this helps make DNS less mysterious to some of you!</p>
<p><small> Thanks to Aditya, Taylor, and Hazem for their comments on a draft of this post </small></p>
</div></div>
  </body>
</html>
