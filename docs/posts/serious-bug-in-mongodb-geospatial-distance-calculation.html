<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.icod.de/2022/05/19/serious-bug-in-mongodb-geospatial-distance-calculation/">Original</a>
    <h1>Serious Bug in MongoDB Geospatial distance calculation</h1>
    
    <div id="readability-page-1" class="page"><div>
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p></div>
				</td>
						<td><div><p><span>package</span><span> </span><span>main</span></p><p><span>import</span><span> </span><span>(</span></p><p><span>	</span><span>&#34;context&#34;</span></p><p><span>	</span><span>&#34;fmt&#34;</span></p><p><span>	</span><span>&#34;log&#34;</span></p><p><span>	</span><span>&#34;time&#34;</span></p><p><span>	</span><span>&#34;github.com/golang/geo/s2&#34;</span></p><p><span>	</span><span>geo</span><span> </span><span>&#34;github.com/kellydunn/golang-geo&#34;</span></p><p><span>	</span><span>&#34;go.mongodb.org/mongo-driver/bson&#34;</span></p><p><span>	</span><span>&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span></p><p><span>	</span><span>&#34;go.mongodb.org/mongo-driver/mongo&#34;</span></p><p><span>	</span><span>mopts</span><span> </span><span>&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span></p><p><span>	</span><span>&#34;go.mongodb.org/mongo-driver/mongo/readpref&#34;</span></p><p><span>	</span><span>&#34;go.mongodb.org/mongo-driver/x/bsonx&#34;</span></p><p><span>)</span></p><p><span>const</span><span> </span><span>earthRadiusKm</span><span> </span>=<span> </span><span>6371.01</span><span> </span><span>// See https://github.com/golang/geo/blob/master/s2/s2_test.go#L46-L51</span></p><p><span>var</span><span> </span><span>(</span></p><p><span>	</span><span>Database</span><span>          </span>=<span> </span><span>&#34;testgeo&#34;</span></p><p><span>	</span><span>DefaultTimeout</span><span>    </span>=<span> </span><span>time</span><span>.</span><span>Second *</span><span> </span><span>10</span></p><p><span>	</span><span>ProfileCollection</span><span> </span>=<span> </span><span>&#34;profile&#34;</span></p><p><span>)</span></p><p><span>type</span><span> </span><span>(</span></p><p><span>	</span><span>Profile</span><span> </span><span>struct</span><span> </span><span>{</span></p><p><span>		</span><span>ID       </span><span>primitive</span><span>.</span><span>ObjectID</span><span> </span><span>`</span><span>bson</span><span>:</span><span>&#34;_id,omitempty&#34;</span><span> </span><span>json</span><span>:</span><span>&#34;id&#34;</span><span>`</span></p><p><span>		</span><span>Location </span><span>Location</span><span>           </span><span>`</span><span>bson</span><span>:</span><span>&#34;location&#34;</span><span> </span><span>json</span><span>:</span><span>&#34;location&#34;</span><span>`</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>ProfileResult</span><span> </span><span>struct</span><span> </span><span>{</span></p><p><span>		</span><span>ID       </span><span>primitive</span><span>.</span><span>ObjectID</span><span> </span><span>`</span><span>bson</span><span>:</span><span>&#34;_id,omitempty&#34;</span><span> </span><span>json</span><span>:</span><span>&#34;id&#34;</span><span>`</span></p><p><span>		</span><span>Location </span><span>Location</span><span>           </span><span>`</span><span>bson</span><span>:</span><span>&#34;location&#34;</span><span> </span><span>json</span><span>:</span><span>&#34;location&#34;</span><span>`</span></p><p><span>		</span><span>Distance </span><span>float64</span><span>            </span><span>`</span><span>bson</span><span>:</span><span>&#34;distance&#34;</span><span> </span><span>json</span><span>:</span><span>&#34;distance&#34;</span><span>`</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>Location</span><span> </span><span>struct</span><span> </span><span>{</span></p><p><span>		</span><span>Type        </span><span>string</span><span>    </span><span>`</span><span>json</span><span>:</span><span>&#34;type&#34;</span><span> </span><span>bson</span><span>:</span><span>&#34;type&#34;</span><span>`</span></p><p><span>		</span><span>Coordinates</span><span> </span><span>[</span><span>]</span><span>float64</span><span> </span><span>`</span><span>json</span><span>:</span><span>&#34;coordinates&#34;</span><span> </span><span>bson</span><span>:</span><span>&#34;coordinates&#34;</span><span>`</span></p><p><span>	</span><span>}</span></p><p><span>)</span></p><p><span>func </span><span>main</span><span>(</span><span>)</span><span> </span><span>{</span></p><p><span>	</span><span>lat1</span><span> </span><span>:</span>=<span> </span><span>9.1829321</span></p><p><span>	</span><span>lng1</span><span> </span><span>:</span>=<span> </span><span>48.7758459</span></p><p><span>	</span><span>lat2</span><span> </span><span>:</span>=<span> </span><span>45.749428</span></p><p><span>	</span><span>lng2</span><span> </span><span>:</span>=<span> </span><span>15.39967</span></p><p><span>	</span><span>// lat1 := 9.653194</span></p><p><span>	</span><span>// lng1 := 48.709797</span></p><p><span>	</span><span>// lat2 := 9.182313</span></p><p><span>	</span><span>// lng2 := 48.783187</span></p><p><span>	</span><span>p1</span><span> </span><span>:</span>=<span> </span><span>geo</span><span>.</span><span>NewPoint</span><span>(</span><span>lat1</span><span>,</span><span> </span><span>lng1</span><span>)</span></p><p><span>	</span><span>// p1 := geo2.NewPoint(lng1, lat1)</span></p><p><span>	</span><span>p2</span><span> </span><span>:</span>=<span> </span><span>geo</span><span>.</span><span>NewPoint</span><span>(</span><span>lat2</span><span>,</span><span> </span><span>lng2</span><span>)</span></p><p><span>	</span><span>// p2 := geo2.NewPoint(lng2, lat2)</span></p><p><span>	</span><span>dist</span><span> </span><span>:</span>=<span> </span><span>p1</span><span>.</span><span>GreatCircleDistance</span><span>(</span><span>p2</span><span>)</span></p><p><span>	</span><span>fmt</span><span>.</span><span>Printf</span><span>(</span><span>&#34;great circle distance: %f\n&#34;</span><span>,</span><span> </span><span>dist</span><span>)</span></p><p><span>	</span><span>pg1</span><span> </span><span>:</span>=<span> </span><span>s2</span><span>.</span><span>PointFromLatLng</span><span>(</span><span>s2</span><span>.</span><span>LatLngFromDegrees</span><span>(</span><span>lat1</span><span>,</span><span> </span><span>lng1</span><span>)</span><span>)</span></p><p><span>	</span><span>// pg1 := s2.PointFromLatLng(s2.LatLngFromDegrees(lng1, lat1))</span></p><p><span>	</span><span>pg2</span><span> </span><span>:</span>=<span> </span><span>s2</span><span>.</span><span>PointFromLatLng</span><span>(</span><span>s2</span><span>.</span><span>LatLngFromDegrees</span><span>(</span><span>lat2</span><span>,</span><span> </span><span>lng2</span><span>)</span><span>)</span></p><p><span>	</span><span>// pg2 := s2.PointFromLatLng(s2.LatLngFromDegrees(lng2, lat2))</span></p><p><span>	</span><span>sdist</span><span> </span><span>:</span>=<span> </span><span>pg1</span><span>.</span><span>Distance</span><span>(</span><span>pg2</span><span>)</span><span> </span>*<span> </span><span>earthRadiusKm</span></p><p><span>	</span><span>// odist := pg2.Distance(pg1) * earthRadiusKm</span></p><p><span>	</span><span>fmt</span><span>.</span><span>Printf</span><span>(</span><span>&#34;s2 distance: %f\n&#34;</span><span>,</span><span> </span><span>sdist</span><span>)</span></p><p><span>	</span><span>// fmt.Printf(&#34;s2 r-distance: %f\n&#34;, odist)</span></p><p><span>	</span><span>// fmt.Printf(&#34;mongo result: %f\n&#34;, 5165738.082454552)</span></p><p><span>	</span><span>mp1</span><span> </span><span>:</span>=<span> </span><span>new</span><span>(</span><span>Profile</span><span>)</span></p><p><span>	</span><span>mp1</span><span>.</span><span>Location</span><span> </span>=<span> </span><span>NewPoint</span><span>(</span><span>lng1</span><span>,</span><span> </span><span>lat1</span><span>)</span></p><p><span>	</span><span>mp2</span><span> </span><span>:</span>=<span> </span><span>new</span><span>(</span><span>Profile</span><span>)</span></p><p><span>	</span><span>mp2</span><span>.</span><span>Location</span><span> </span>=<span> </span><span>NewPoint</span><span>(</span><span>lng2</span><span>,</span><span> </span><span>lat2</span><span>)</span></p><p><span>	</span><span>client</span><span>,</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>mongoInit</span><span>(</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>log</span><span>.</span><span>Fatal</span><span>(</span><span>e</span><span>.</span><span>Error</span><span>(</span><span>)</span><span>)</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>defer </span><span>func</span><span>(</span><span>)</span><span> </span><span>{</span></p><p><span>		</span><span>if</span><span> </span><span>e</span><span> </span>=<span> </span><span>client</span><span>.</span><span>Disconnect</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>)</span><span>;</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>			</span><span>panic</span><span>(</span><span>e</span><span>)</span></p><p><span>		</span><span>}</span></p><p><span>	</span><span>}</span><span>(</span><span>)</span></p><p><span>	</span><span>res1</span><span>,</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>CreateProfile</span><span>(</span><span>client</span><span>,</span><span> </span><span>mp1</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>log</span><span>.</span><span>Fatal</span><span>(</span><span>e</span><span>.</span><span>Error</span><span>(</span><span>)</span><span>)</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>res2</span><span>,</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>CreateProfile</span><span>(</span><span>client</span><span>,</span><span> </span><span>mp2</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>log</span><span>.</span><span>Fatal</span><span>(</span><span>e</span><span>.</span><span>Error</span><span>(</span><span>)</span><span>)</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>mp1</span><span>.</span><span>ID</span><span> </span>=<span> </span><span>res1</span><span>.</span><span>InsertedID</span><span>.</span><span>(</span><span>primitive</span><span>.</span><span>ObjectID</span><span>)</span></p><p><span>	</span><span>mp2</span><span>.</span><span>ID</span><span> </span>=<span> </span><span>res2</span><span>.</span><span>InsertedID</span><span>.</span><span>(</span><span>primitive</span><span>.</span><span>ObjectID</span><span>)</span></p><p><span>	</span><span>var</span><span> </span><span>radius </span><span>int32</span></p><p><span>	</span><span>radius</span><span> </span>=<span> </span><span>int32</span><span>(</span><span>6371</span><span>)</span><span> </span>*<span> </span><span>1000</span></p><p><span>	</span><span>geoStage</span><span> </span><span>:</span>=<span> </span><span>bson</span><span>.</span><span>D</span><span>{</span><span>{</span></p><p><span>		</span><span>&#34;$geoNear&#34;</span><span>,</span><span> </span><span>bson</span><span>.</span><span>D</span><span>{</span></p><p><span>			</span><span>{</span><span>&#34;near&#34;</span><span>,</span><span> </span><span>mp1</span><span>.</span><span>Location</span><span>}</span><span>,</span></p><p><span>			</span><span>{</span><span>&#34;distanceField&#34;</span><span>,</span><span> </span><span>&#34;distance&#34;</span><span>}</span><span>,</span></p><p><span>			</span><span>{</span><span>&#34;minDistance&#34;</span><span>,</span><span> </span><span>1</span><span>}</span><span>,</span></p><p><span>			</span><span>{</span><span>&#34;maxDistance&#34;</span><span>,</span><span> </span><span>radius</span><span>}</span><span>,</span></p><p><span>			</span><span>{</span><span>&#34;spherical&#34;</span><span>,</span><span> </span><span>true</span><span>}</span><span>,</span></p><p><span>		</span><span>}</span><span>,</span></p><p><span>	</span><span>}</span><span>,</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>result</span><span>,</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>AggregateProfile</span><span>(</span><span>client</span><span>,</span><span> </span><span>mongo</span><span>.</span><span>Pipeline</span><span>{</span><span>geoStage</span><span>}</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>return</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>fmt</span><span>.</span><span>Printf</span><span>(</span><span>&#34;mongodb distance: %f\n&#34;</span><span>,</span><span> </span><span>result</span><span>[</span><span>0</span><span>]</span><span>.</span><span>Distance</span><span>)</span></p><p><span>}</span></p><p><span>func </span><span>mongoInit</span><span>(</span><span>)</span><span> </span><span>(</span>*<span>mongo</span><span>.</span><span>Client</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span></p><p><span>	</span><span>ctx</span><span>,</span><span> </span><span>cancel</span><span> </span><span>:</span>=<span> </span><span>context</span><span>.</span><span>WithTimeout</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>,</span><span> </span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>defer </span><span>cancel</span><span>(</span><span>)</span></p><p><span>	</span><span>client</span><span>,</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>mongo</span><span>.</span><span>Connect</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>mopts</span><span>.</span><span>Client</span><span>(</span><span>)</span><span>.</span><span>ApplyURI</span><span>(</span><span>&#34;mongodb://localhost:27017&#34;</span><span>)</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>e</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>ctx</span><span>,</span><span> </span><span>cancel</span><span> </span>=<span> </span><span>context</span><span>.</span><span>WithTimeout</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>,</span><span> </span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>defer </span><span>cancel</span><span>(</span><span>)</span></p><p><span>	</span><span>e</span><span> </span>=<span> </span><span>client</span><span>.</span><span>Ping</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>readpref</span><span>.</span><span>Primary</span><span>(</span><span>)</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>e</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>// drop database</span></p><p><span>	</span><span>_</span><span> </span>=<span> </span><span>client</span><span>.</span><span>Database</span><span>(</span><span>Database</span><span>)</span><span>.</span><span>Drop</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>)</span></p><p><span>	</span><span>// create geoJSON 2dsphere index</span></p><p><span>	</span><span>ctx</span><span>,</span><span> </span><span>cancel</span><span> </span>=<span> </span><span>context</span><span>.</span><span>WithTimeout</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>,</span><span> </span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>defer </span><span>cancel</span><span>(</span><span>)</span></p><p><span>	</span><span>db</span><span> </span><span>:</span>=<span> </span><span>client</span><span>.</span><span>Database</span><span>(</span><span>Database</span><span>)</span></p><p><span>	</span><span>indexOpts</span><span> </span><span>:</span>=<span> </span><span>mopts</span><span>.</span><span>CreateIndexes</span><span>(</span><span>)</span><span>.</span><span>SetMaxTime</span><span>(</span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>// Index to location 2dsphere type.</span></p><p><span>	</span><span>pointIndexModel</span><span> </span><span>:</span>=<span> </span><span>mongo</span><span>.</span><span>IndexModel</span><span>{</span></p><p><span>		</span><span>Options</span><span>:</span><span> </span><span>mopts</span><span>.</span><span>Index</span><span>(</span><span>)</span><span>,</span></p><p><span>		</span><span>Keys</span><span>:</span><span> </span><span>bsonx</span><span>.</span><span>MDoc</span><span>{</span></p><p><span>			</span><span>&#34;location&#34;</span><span>:</span><span> </span><span>bsonx</span><span>.</span><span>String</span><span>(</span><span>&#34;2dsphere&#34;</span><span>)</span><span>,</span></p><p><span>		</span><span>}</span><span>,</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>profileIndexes</span><span> </span><span>:</span>=<span> </span><span>db</span><span>.</span><span>Collection</span><span>(</span><span>&#34;profile&#34;</span><span>)</span><span>.</span><span>Indexes</span><span>(</span><span>)</span></p><p><span>	</span><span>// _, e = profileIndexes.CreateOne(ctx, pointIndexModel, indexOpts)</span></p><p><span>	</span><span>_</span><span>,</span><span> </span><span>e</span><span> </span>=<span> </span><span>profileIndexes</span><span>.</span><span>CreateOne</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>pointIndexModel</span><span>,</span><span> </span><span>indexOpts</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>e</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>return</span><span> </span><span>client</span><span>,</span><span> </span><span>nil</span></p><p><span>}</span></p><p><span>// NewPoint returns a GeoJSON Point with longitude and latitude.</span></p><p><span>func </span><span>NewPoint</span><span>(</span><span>long</span><span>,</span><span> </span><span>lat </span><span>float64</span><span>)</span><span> </span><span>Location</span><span> </span><span>{</span></p><p><span>	</span><span>return</span><span> </span><span>Location</span><span>{</span></p><p><span>		</span><span>&#34;Point&#34;</span><span>,</span></p><p><span>		</span><span>[</span><span>]</span><span>float64</span><span>{</span><span>long</span><span>,</span><span> </span><span>lat</span><span>}</span><span>,</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p><p><span>func </span><span>CreateProfile</span><span>(</span><span>client *</span><span>mongo</span><span>.</span><span>Client</span><span>,</span><span> </span><span>m *</span><span>Profile</span><span>)</span><span> </span><span>(</span>*<span>mongo</span><span>.</span><span>InsertOneResult</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span></p><p><span>	</span><span>ctx</span><span>,</span><span> </span><span>cancel</span><span> </span><span>:</span>=<span> </span><span>context</span><span>.</span><span>WithTimeout</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>,</span><span> </span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>defer </span><span>cancel</span><span>(</span><span>)</span></p><p><span>	</span><span>c</span><span> </span><span>:</span>=<span> </span><span>client</span><span>.</span><span>Database</span><span>(</span><span>Database</span><span>)</span><span>.</span><span>Collection</span><span>(</span><span>ProfileCollection</span><span>)</span></p><p><span>	</span><span>return</span><span> </span><span>c</span><span>.</span><span>InsertOne</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>m</span><span>)</span></p><p><span>}</span></p><p><span>func </span><span>AggregateProfile</span><span>(</span><span>client *</span><span>mongo</span><span>.</span><span>Client</span><span>,</span><span> </span><span>pipeline</span><span> </span><span>interface</span><span>{</span><span>}</span><span>)</span><span> </span><span>(</span><span>[</span><span>]</span>*<span>ProfileResult</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span></p><p><span>	</span><span>ctx</span><span>,</span><span> </span><span>cancel</span><span> </span><span>:</span>=<span> </span><span>context</span><span>.</span><span>WithTimeout</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>,</span><span> </span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>defer </span><span>cancel</span><span>(</span><span>)</span></p><p><span>	</span><span>c</span><span> </span><span>:</span>=<span> </span><span>client</span><span>.</span><span>Database</span><span>(</span><span>Database</span><span>)</span><span>.</span><span>Collection</span><span>(</span><span>ProfileCollection</span><span>)</span></p><p><span>	</span><span>cursor</span><span>,</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>c</span><span>.</span><span>Aggregate</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>pipeline</span><span>)</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>e</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>ctx</span><span>,</span><span> </span><span>cancel</span><span> </span>=<span> </span><span>context</span><span>.</span><span>WithTimeout</span><span>(</span><span>context</span><span>.</span><span>Background</span><span>(</span><span>)</span><span>,</span><span> </span><span>DefaultTimeout</span><span>)</span></p><p><span>	</span><span>defer </span><span>cancel</span><span>(</span><span>)</span></p><p><span>	</span><span>var</span><span> </span><span>m</span><span> </span><span>[</span><span>]</span>*<span>ProfileResult</span></p><p><span>	</span><span>if</span><span> </span><span>e</span><span> </span><span>:</span>=<span> </span><span>cursor</span><span>.</span><span>All</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>&amp;m);</span><span> </span><span>e</span><span> </span><span>!</span>=<span> </span><span>nil</span><span> </span><span>{</span></p><p><span>		</span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>e</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>return</span><span> </span><span>m</span><span>,</span><span> </span><span>nil</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div></div>
  </body>
</html>
