<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.paradedb.com/pages/introducing_lakehouse">Original</a>
    <h1>Pg_lakehouse: A DuckDB Alternative in Postgres</h1>
    
    <div id="readability-page-1" class="page"><p>Our newest extension, <a href="https://github.com/paradedb/paradedb/tree/dev/pg_lakehouse" target="_blank" rel="noreferrer"><code>pg_lakehouse</code></a>, transforms Postgres into a DuckDB alternative. Like DuckDB, <code>pg_lakehouse</code> allows Postgres to directly
query external object stores like S3, table formats like Delta Lake, and file formats like Parquet.</p><p>Under the hood, <code>pg_lakehouse</code> uses the foreign data wrapper API to connect to external data sources. While there are other foreign data wrappers in the Postgres ecosystem, <code>pg_lakehouse</code> differentiates in two ways:</p><p><code>pg_lakehouse</code> uses two Postgres APIs: the executor hook and foreign data wrapper. In Postgres, the executor hook is a function — run immediately after a query plan is generated — that
executes the query plan. Extensions can override this function with custom logic. <code>pg_lakehouse</code>’s executor hook reroutes foreign table queries to DataFusion, which executes
the query instead of the Postgres query engine.</p><p>If the query fails for any reason inside DataFusion, it gracefully falls back to Postgres. This is where the foreign data wrapper comes in. One responsibility of the foreign
data wrapper is to scan the foreign table and send rows to the Postgres query engine.</p><p>Typically, a query will fall back to Postgres if it contains a clause that cannot (yet) be pushed down to DataFusion. Users can determine which query engine was used by running
<code>EXPLAIN</code>.</p><p>We’ve provided an example Parquet file of 3 million NYC taxi trips hosted in a public S3 bucket for testing. After the extension
is <a href="https://github.com/paradedb/paradedb/tree/dev/pg_search#installation" target="_blank" rel="noreferrer">installed</a>, you can run the following code to query this dataset:</p><div><div><pre><code><span>CREATE</span> EXTENSION pg_lakehouse<span>;</span>

<span>CREATE</span> <span>FOREIGN</span> <span>DATA</span> WRAPPER s3_wrapper
<span>HANDLER</span> s3_fdw_handler
VALIDATOR s3_fdw_validator<span>;</span>


<span>CREATE</span> SERVER s3_server <span>FOREIGN</span> <span>DATA</span> WRAPPER s3_wrapper
OPTIONS <span>(</span>
    region <span>&#39;us-east-1&#39;</span><span>,</span>
    allow_anonymous <span>&#39;true&#39;</span>
<span>)</span><span>;</span>


<span>CREATE</span> <span>FOREIGN</span> <span>TABLE</span> trips <span>(</span>
    <span>&#34;VendorID&#34;</span>              <span>INT</span><span>,</span>
    <span>&#34;tpep_pickup_datetime&#34;</span>  <span>TIMESTAMP</span><span>,</span>
    <span>&#34;tpep_dropoff_datetime&#34;</span> <span>TIMESTAMP</span><span>,</span>
    <span>&#34;passenger_count&#34;</span>       <span>BIGINT</span><span>,</span>
    <span>&#34;trip_distance&#34;</span>         <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;RatecodeID&#34;</span>            <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;store_and_fwd_flag&#34;</span>    <span>TEXT</span><span>,</span>
    <span>&#34;PULocationID&#34;</span>          <span>REAL</span><span>,</span>
    <span>&#34;DOLocationID&#34;</span>          <span>REAL</span><span>,</span>
    <span>&#34;payment_type&#34;</span>          <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;fare_amount&#34;</span>           <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;extra&#34;</span>                 <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;mta_tax&#34;</span>               <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;tip_amount&#34;</span>            <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;tolls_amount&#34;</span>          <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;improvement_surcharge&#34;</span> <span>DOUBLE</span> <span>PRECISION</span><span>,</span>
    <span>&#34;total_amount&#34;</span>          <span>DOUBLE</span> <span>PRECISION</span>
<span>)</span>
SERVER s3_server
OPTIONS <span>(</span>
    path <span>&#39;s3://paradedb-benchmarks/yellow_tripdata_2024-01.parquet&#39;</span><span>,</span>
    extension <span>&#39;parquet&#39;</span>
<span>)</span><span>;</span>


<span>SELECT</span> <span>COUNT</span><span>(</span><span>*</span><span>)</span> <span>FROM</span> trips<span>;</span>
  count

 <span>2964624</span>
<span>(</span><span>1</span> <span>row</span><span>)</span>
</code></pre></div></div><p><code>pg_lakehouse</code> is open-source and licensed under AGPL. If you’d like to contribute, the best place to start is our
<a href="https://join.slack.com/t/paradedbcommunity/shared_invite/zt-217mordsh-ielS6BiZf7VW3rqKBFgAlQ" target="_blank" rel="noreferrer">Slack community</a>. And please don’t hesitate to show your support by
<a href="https://github.com/paradedb/paradedb" target="_blank" rel="noreferrer">giving us a star</a>!</p></div>
  </body>
</html>
