<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.flipperzero.one/1-month-battery-life-with-firmware-update/">Original</a>
    <h1>FlipperZero: 1 Month Battery Life with Firmware Update</h1>
    
    <div id="readability-page-1" class="page"><div id="site-main">
<article>
<header>
<section>
<a href="https://blog.flipperzero.one/tag/zero/">Flipper Zero</a>
</section>


<figure>
<img srcset="/content/images/size/w300/2023/04/flipper_zero_1month_batter_life_firmware_update.jpg 300w,
                            /content/images/size/w600/2023/04/flipper_zero_1month_batter_life_firmware_update.jpg 600w,
                            /content/images/size/w1000/2023/04/flipper_zero_1month_batter_life_firmware_update.jpg 1000w,
                            /content/images/size/w2000/2023/04/flipper_zero_1month_batter_life_firmware_update.jpg 2000w" sizes="(min-width: 1400px) 1400px, 92vw" src="https://blog.flipperzero.one/content/images/size/w2000/2023/04/flipper_zero_1month_batter_life_firmware_update.jpg" alt="1 Month Battery Life with Firmware Update"/>
</figure>
</header>
<section>
<p>We are proud to announce that starting the firmware version <strong>0.82</strong>, your Flipper Zero&#39;s battery life will last up to 1 month! It took us 2 years to resolve all firmware issues that prevented Flipper Zero from switching to power-saving mode, resulting in the same power consumption baseline in both idle and active states. As a result, Flipper Zero&#39;s battery life was approximately 1 week instead of the intended 1 month.</p><p>In this post, we will tell you about the new power saving mode and the challenges with the STM32 microcontroller we had to overcome to make the new mode a reality. We will also share updates about worldwide sales.</p><p>The firmware version <strong>0.82</strong> is available — <a href="https://update.flipperzero.one/" rel="noopener noreferrer">Update now</a>! This version brings a new deep sleep feature that extends your device&#39;s battery life up to 1 month by dramatically decreasing power consumption when there are no running applications or connections on your Flipper Zero.</p><p>When Flipper Zero is not running any user applications, the device enters an idle state (sleep mode). Once an application starts, the device switches to an active state: the backlight activates, data exchange with the microSD card begins, and so on. In the active state, power consumption can reach up to 30 mA with a backlight, up to 400 mA with an active transceiver, and even up to 2 A with an active transceiver and connected external module.</p><p>The microcontroller used in Flipper Zero supports different sleep modes that have different levels of energy efficiency:</p><ul><li><strong>Before</strong>, we used a mode that wasn&#39;t a true sleep mode. This mode was easier to implement but less energy efficient. In this Legacy sleep mode, <strong>Flipper Zero consumed 9 mA of power in the idle state</strong>.</li><li><strong>After</strong> resolving firmware issues, we enabled a new energy-efficient sleep mode, in which various microcontroller blocks are turned off, and the core clock is switched to a more energy-efficient clock generator. In this deep sleep mode, <strong>the power consumption baseline in the idle state is only 1.5 mA!</strong></li></ul><figure><img src="https://blog.flipperzero.one/content/images/2023/04/flipper_zero_new_saving_mode_power_consumption--1--1.png" alt="" loading="lazy" width="2000" height="1037" srcset="https://blog.flipperzero.one/content/images/size/w600/2023/04/flipper_zero_new_saving_mode_power_consumption--1--1.png 600w, https://blog.flipperzero.one/content/images/size/w1000/2023/04/flipper_zero_new_saving_mode_power_consumption--1--1.png 1000w, https://blog.flipperzero.one/content/images/size/w1600/2023/04/flipper_zero_new_saving_mode_power_consumption--1--1.png 1600w, https://blog.flipperzero.one/content/images/size/w2400/2023/04/flipper_zero_new_saving_mode_power_consumption--1--1.png 2400w" sizes="(min-width: 720px) 720px"/><figcaption>The new firmware results in power consumption of approximately 1.5 mA in the new deep sleep mode, compared to about 9 mA in the old sleep mode</figcaption></figure><h3 id="how-to-check-new-deep-sleep-mode">How to check new deep sleep mode</h3><p>The implementation of the deep sleep feature was complex. There are several scenarios where this mode may not be activated, such as when a background application is running, second processing core tasks are active, or a Remote Procedure Call (RPC) session is ongoing over Bluetooth LE.</p><p>To verify if your Flipper Zero is properly entering deep sleep mode, go to <code>Settings →<strong>  </strong>Power<strong> </strong>→ Battery Info</code> and wait for the LCD backlight to turn off. A <code>Napping...</code> message should appear in the battery status.</p><figure><img src="https://blog.flipperzero.one/content/images/2023/04/flipper_zero_batter_status_napping-1.png" alt="" loading="lazy" width="1600" height="563" srcset="https://blog.flipperzero.one/content/images/size/w600/2023/04/flipper_zero_batter_status_napping-1.png 600w, https://blog.flipperzero.one/content/images/size/w1000/2023/04/flipper_zero_batter_status_napping-1.png 1000w, https://blog.flipperzero.one/content/images/2023/04/flipper_zero_batter_status_napping-1.png 1600w" sizes="(min-width: 720px) 720px"/><figcaption>Battery info widget shows if deep sleep mode is on</figcaption></figure><h3 id="how-to-turn-off-deep-sleep-mode">How to turn off deep sleep mode</h3><p>This deep sleep mode is enabled by default. You don&#39;t need to disable it unless you have problems with your Flipper Zero. Mind that this deep sleep mode is still in its experimental phase. It may lead to unpredictable bugs and side effects. Our testing team has discovered and resolved most of the bugs, but there may still be some that we still need to identify. If you think the mode causes the bug, you can disable the mode for testing purposes and share the issue <a href="https://forum.flipperzero.one/t/flipper-zero-low-power-mode/15494">on the forum</a>.</p><p>To disable the deep sleep mode on your device, go to <code>Settings → System</code> and set <code>Sleep Method</code> to <code>Legacy</code>.</p><figure><img src="https://blog.flipperzero.one/content/images/2023/04/Monosnap-Miro-2023-04-27-13-28-57.png" alt="" loading="lazy" width="2000" height="661" srcset="https://blog.flipperzero.one/content/images/size/w600/2023/04/Monosnap-Miro-2023-04-27-13-28-57.png 600w, https://blog.flipperzero.one/content/images/size/w1000/2023/04/Monosnap-Miro-2023-04-27-13-28-57.png 1000w, https://blog.flipperzero.one/content/images/size/w1600/2023/04/Monosnap-Miro-2023-04-27-13-28-57.png 1600w, https://blog.flipperzero.one/content/images/size/w2400/2023/04/Monosnap-Miro-2023-04-27-13-28-57.png 2400w" sizes="(min-width: 720px) 720px"/><figcaption>Disable the new deep sleep mode in Settings</figcaption></figure>
<p>We tried to implement deep sleep mode for a long time, but we could not understand why the system crashed after exiting deep sleep mode.</p><p>Flipper Zero is based on an <a href="https://www.st.com/en/microcontrollers-microprocessors/stm32wb-series.html">STM32WB</a> series microcontroller. Firmware development with this microcontroller is highly challenging due to its dual-core architecture, shared peripherals, and closed-source firmware for the Core 2<strong> </strong>without the ability to debug it🤯</p><figure><img src="https://blog.flipperzero.one/content/images/2023/04/image-3.png" alt="" loading="lazy" width="2000" height="1567" srcset="https://blog.flipperzero.one/content/images/size/w600/2023/04/image-3.png 600w, https://blog.flipperzero.one/content/images/size/w1000/2023/04/image-3.png 1000w, https://blog.flipperzero.one/content/images/size/w1600/2023/04/image-3.png 1600w, https://blog.flipperzero.one/content/images/2023/04/image-3.png 2259w" sizes="(min-width: 720px) 720px"/><figcaption>The second core runs proprietary binary blob firmware with no way to debug it</figcaption></figure><p>Another problem was poor documentation and incomplete Real-Time Operating System (RTOS) support in the Software Development Kit (SDK). We had to add support for deep sleep inside the operating system ourselves. The <a href="https://github.com/flipperdevices/flipperzero-firmware/blob/0.82.3/firmware/targets/f7/furi_hal/furi_hal_os.c#L132">furi_hal_os_sleep()</a> function performs tick suppression inside the OS domain.</p><p>Although the ARM architecture was initially designed for mobile usage and low power consumption in mind, the implementation of power-saving functions is actually carried out by chip vendors. Vendors use various approaches to implement power-saving functions and provide examples and SDKs to simplify developers&#39; lives. But that doesn’t guarantee success, especially on multicore, shared periphery chips.</p><h3 id="challenges-with-core-2">Challenges with Core 2</h3><p>A set of hardware semaphores and Inter-processor communication controller are used to control subsystem ownership and signaling between Core 1 and Core 2. Core 1 firmware must explicitly take some of them to control the clock, flash, and other critical stages. Combining work with a flash controller and active BLE connection is an exceptionally complex task: using a flash controller stalls instruction/data fetch from memory, which causes Core 2 to miss transmission deadlines. The whole system is quite sophisticated and we&#39;ll cover it in a separate post.</p>
<p>Almost every electronic device has oscillators inside. Flipper Zero MCU has 7 oscillators. An oscillator is a circuit consisting of a small crystal of quartz and an amplifier that generates even pulses, which provide precise timing for the MCU core and subsystems! These pulses are crucial for the microcontroller&#39;s internal operations.</p><figure><img src="https://blog.flipperzero.one/content/images/2023/04/02_02.png" alt="" loading="lazy" width="2000" height="1037" srcset="https://blog.flipperzero.one/content/images/size/w600/2023/04/02_02.png 600w, https://blog.flipperzero.one/content/images/size/w1000/2023/04/02_02.png 1000w, https://blog.flipperzero.one/content/images/size/w1600/2023/04/02_02.png 1600w, https://blog.flipperzero.one/content/images/size/w2400/2023/04/02_02.png 2400w" sizes="(min-width: 720px) 720px"/><figcaption>Oscillators play a crucial role in the functionality of Flipper Zero firmware</figcaption></figure><p>Three of these oscillators are especially important:</p><ul><li><strong>High-Speed External (HSE)</strong> and <strong>Low-Speed External (LSE)</strong> oscillators provide reference clocks, which are precise, but not energy efficient.</li><li><strong>High-Speed Internal (HSI)</strong> oscillator provides an internal clock, which is energy efficient, but not precise.</li></ul><p>The LSE oscillator is continuously active, the HSE oscillator is activated when an application is running, and the HSI oscillator is activated when the device enters deep sleep mode. However, using the HSE oscillator during deep sleep is impossible, requiring all clock domains to be switched to HSI before entering deep sleep mode. Overcoming this challenge, we have developed the <a href="https://github.com/flipperdevices/flipperzero-firmware/blob/0.82.3/firmware/targets/f7/furi_hal/furi_hal_clock.c#L205">furi_hal_clock_switch_to_hsi()</a> function that facilitates a smooth and efficient transition to the energy-efficient HSI oscillator, enabling deep sleep functionality.</p><p>Since going into sleep mode physically turns off peripheral subsystems, they must be in a disabled state. That brings API design to a new level of complexity, especially in multitask OS. It took us some time to design APIs to be compatible with deep sleep mode. The <a href="https://github.com/flipperdevices/flipperzero-firmware/blob/0.82.3/firmware/targets/f7/furi_hal/furi_hal_power.c#L175">furi_hal_power_deep_sleep()</a> function is responsible for the transition into deep sleep mode at the power domain level.</p>
<p>Another problem is debugging Core 1 firmware when in deep sleep mode: MCU Debug subsystem must be specially configured to wake the system up from sleep. Debugging is also impossible if the system is misconfigured, exiting, or entering deep sleep mode and something goes wrong. Also, halting MCU while in sleep will wake it up on the HSI clock, which is much slower than HSE and requires a special debug adapter configuration.</p><p>As you can see, developing and debugging with the STM32WB series microcontroller is a challenging task. That is why it took us so long to identify and resolve all the issues related to our firmware. But thanks to our team of developers, the battery life of your Flipper Zero will last up to 1 month, starting the firmware version 0.82.</p>
<p>Sales of Flipper Zero are gaining momentum around the world. More than 200 thousand devices have already reached their owners! At the same time, worldwide delivery is a big challenge for us. We engage reseller partners to sell Flipper Zero worldwide.</p><p>For your convenience, we have created a <a href="https://flipperzero.one/how-to-buy">How<strong> </strong>To Buy</a> page where you can select your country and view live information about all official partners. The page is currently in beta mode but will soon update data about partners in real time.</p><figure><img src="https://blog.flipperzero.one/content/images/2023/04/Screenshot-2023-04-27-at-20.46.42.png" alt="" loading="lazy" width="924" height="1196" srcset="https://blog.flipperzero.one/content/images/size/w600/2023/04/Screenshot-2023-04-27-at-20.46.42.png 600w, https://blog.flipperzero.one/content/images/2023/04/Screenshot-2023-04-27-at-20.46.42.png 924w" sizes="(min-width: 720px) 720px"/></figure><p>Due to the incredible popularity of Flipper Zero, many fraudulent accounts have appeared on the Internet. Only the websites listed here are trusted. We do not sell our products on social networks like Instagram, Telegram, or TikTok.</p><p>⚠️ If you are offered to buy Flipper Zero anywhere else, it is most likely a fraudulent seller. Don&#39;t send them money, you will most probably be scammed. Please report all scammers to us via the <a href="https://flipperzero.one/abuse-report">Abuse Report Form</a>.</p>
</section>
<section id="comments">

</section>
</article>
</div></div>
  </body>
</html>
