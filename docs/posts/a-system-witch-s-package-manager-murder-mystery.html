<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://artemis.sh/2022/04/11/package-manager-murder-mystery.html">Original</a>
    <h1>A System-Witch’s Package Manager Murder Mystery</h1>
    
    <div id="readability-page-1" class="page"><article>
            <header>
                
                <time datetime="2022-04-11 00:00:00 +0000">2022-04-11</time>
            </header>
            <p>It was a calm day on the puppy-linux thinkpad. The CPU was cool, the RAM was operating at double data rate, and a gentle breeze flowed through the chassis as the fan whirred away. A girl wanted to log onto Discord to chat with her friends, but much to her dismay, Discord needed a package update! No matter, such things happen from time to time, but she’d need to uninstall the old version first. She threw on her systems-witch hat and set to work.</p>

<p>The girl walked over to <code>urxvt</code> and activated her package manager. “Hello package manager, could you <code>pkg u discord</code>”? The package manager began to reply, “<code>Uninstall the package discord:</code>”.</p>

<p>There was a pause. Package managers need to think things over sometimes. Suddenly, she heard a shriek over her terminal:</p>

<div><div><pre><code>/usr/sbin/pkg: line 5912: grep: Argument list too long
/usr/sbin/pkg: line 5912: uniq: Argument list too long
/usr/sbin/pkg: line 5913: mv: Argument list too long
ESC[32mUninstalled:ESC[0m discord
/usr/sbin/pkg: line 268: grep: Argument list too long
/usr/sbin/pkg: line 5933: which: Argument list too long
/usr/sbin/pkg: line 1: wc: Argument list too long
ash: -le: argument expected
/usr/sbin/pkg: line 1: wc: Argument list too long
ash: -le: argument expected
/usr/sbin/pkg: line 1: wc: Argument list too long
ash: -le: argument expected
/usr/sbin/pkg: line 1: wc: Argument list too long
ash: -le: argument expected
</code></pre></div></div>

<p>The last two lines repeated over and over as the script clawed desperately at the air, its mind spinning in circles. The blood drained from our little witch’s face. She hung up the terminal and the package manager slumped down. Her thoughts were swirling, but one question stood out among all the others: Why?</p>

<p>With not a moment to waste, she hurried to the scene of the crime.</p>

<div><div><pre><code>$ sed -n &#39;5910,5914 p&#39; &lt; /usr/sbin/pkg

  # clean up user-installed-packages (remove duplicates and empty lines)
  grep -v &#34;^\$&#34; ${REPO_DIR}/user-installed-packages | uniq &gt; ${REPO_DIR}/user-installed-packages_clean
  mv ${REPO_DIR}/user-installed-packages_clean ${REPO_DIR}/user-installed-packages

</code></pre></div></div>

<p>Odd. Just a typical grep and and uniq command. The uniq doesn’t even have any arguments! How can the argument list be too long when there’s no arguments? Surely, there <em>must</em> be an explanation. Someone or something had killed her package manager, and she was going to figure out what.</p>

<p>The girl retreated into her mental archives. Was this a shell problem? A Linux problem? Argument list too long, argument list too long… Linux certainly has a maximum argument length for programs. Was the something setting the limit to zero somehow? She paged through her memories searching for something, <em>anything</em>, that mentioned argument lists. Finally she found something. A memory, not about arguments, but environment variables.</p>

<p>You see, when the Kernel executes a program, it provides the current set of environment variables directly adjacent to the command line arguments in memory. Could it be that the argument length limit applied to the environment variables too? A query online said yes, but the stack exchange is wily and not to be trusted without verification. Our protagonist dived into the linux source code.</p>

<p>In <code>fs/exec.c</code> she found a function named <code>bprm_stack_limits</code>, which had this to say on the matter:</p>

<div><div><pre><code>  limit = max_t(unsigned long, limit, ARG_MAX);
  /*
   * We must account for the size of all the argv and envp pointers to
   * the argv and envp strings, since they will also take up space in
   * the stack. They aren&#39;t stored until much later when we can&#39;t
   * signal to the parent that the child has run out of stack space.
   * Instead, calculate it here so it&#39;s possible to fail gracefully.
   *
   * In the case of argc = 0, make sure there is space for adding a
   * empty string (which will bump argc to 1), to ensure confused
   * userspace programs don&#39;t start processing from argv[1], thinking
   * argc can never be 0, to keep them from walking envp by accident.
   * See do_execveat_common().
   */
  ptr_size = (max(bprm-&gt;argc, 1) + bprm-&gt;envc) * sizeof(void *);
  if (limit &lt;= ptr_size)
    return -E2BIG;
</code></pre></div></div>

<p>She chuckled, That second half of the block comment was an echo of <a href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt">a recent attack on <code>polkit</code></a>. But there at the bottom was the answer to the question at hand: <code>max(bprm-&gt;argc, 1) + bprm-&gt;envc</code>. The kernel source agreed, environment variables take space away from the argument list. If an environment variable was too big, it could stop the shell from running programs at all! But what environment variable could have gotten that large?</p>

<p>The intrepid system administrator returned to the package manager’s corpse, this time peering above the injury.</p>

<div><div><pre><code>$ sed -n &#39;5906,5910 p&#39; &lt; /usr/sbin/pkg

  # remove $PKGNAME from user-installed-packages
  NEWUSERPKGS=&#34;$(grep -v &#34;^${PKGNAME}&#34; ${REPO_DIR}/user-installed-packages)&#34;
  [ &#34;$NEWUSERPKGS&#34; != &#34;&#34; ] &amp;&amp; echo &#34;$NEWUSERPKGS&#34; &gt; ${REPO_DIR}/user-installed-packages

</code></pre></div></div>

<p>Hmm… so the entirety of <code>user-installed-packages</code> was loaded into <code>NEWUSERPKGS</code>. How big was that file?</p>

<div><div><pre><code>$ wc -c /var/packages/user-installed-packages
172474 /var/packages/user-installed-packages
</code></pre></div></div>

<p>Well, that certainly seemed large enough to overflow a reasonable argument list length limit. It seemed to our witch that she finally had a suspect. But, how could she be sure? There weren’t any commands exporting that variable, and it’s unbecoming to levy such an accusation against a line of code without reasonable proof. Perhaps if there were some way to print the exported environment? She tried adding an <code>env</code> to the script, but it was no use.</p>

<div><div><pre><code>/usr/sbin/pkg: line 5910: env: Argument list too long
</code></pre></div></div>

<p>Of course, <code>env</code> was a separate program, and the shell couldn’t launch those. But maybe it could run a builtin command. If exports were the problem, maybe they could be the solution too!</p>

<div><div><pre><code>$ export --help
export: export [-fn] [name[=value] ...] or export -p
    Options:
      -f	refer to shell functions
      -n	remove the export property from each NAME
      -p	display a list of all exported variables and functions
</code></pre></div></div>

<p>There, <code>-p</code>! That’s what she needed. She sprinkled an <code>export -p</code> into the code.</p>

<div><div><pre><code>export EDITOR=&#39;vim&#39;
export HOSTNAME=&#39;puppypc1400&#39;
export KICAD_PATH=&#39;/usr/share/kicad&#39;
export LS_COLORS=&#39;bd=33:cd=33&#39;
export NEWUSERPKGS=&#39;tmux_3.0a-2|tmux|3.0a-2||Utility;shell|750K|pool/main/t/tmux|tmux_3.0a-2_amd64.deb|+libc6&amp;ge2.27,+libevent-2.1-7&amp;ge2.1.8-stable,+libtinfo6&amp;ge6,+libutempter0&amp;ge1.1.5|terminal multiplexer|ubuntu|focal|
vim-common_8.1.2269|vim-common|8.1.2269|1ubuntu5|Filesystem;filemanager|375K|pool/main/v/vim|vim-common_8.1.2269-1ubuntu5_all.deb|+xxd|Vi IMproved - Common files|ubuntu|focal|
vim-runtime_8.1.2269|vim-runtime|8.1.2269|1ubuntu5|Filesystem;filemanager|30765K|pool/main/v/vim|vim-runtime_8.1.2269-1ubuntu5_all.deb||Vi IMproved - Runtime files|ubuntu|focal|
[... snip ...]
</code></pre></div></div>

<p>The witch grinned. There it was, <code>NEWUSERPKGS</code> printing out as far as the eye could see. With a culrpit identified, she had what she needed to resurrect her package manager from its untimely death. She added an <code>export -n NEWUSERPKGS</code> above the wound, re-aligned her runes, and sent a jolt of energy into the package manager. Its eyes lit up.</p>

<div><div><pre><code>$ pkg u discord
Uninstall the package discord:  
Uninstalled: discord
$ 
</code></pre></div></div>

<p>She’d done it! Her package manager was back once again, alive and well.</p>

<p>But there was a loose thread dangling. There were no <code>export</code> commands around <code>NEWUSERPKGS</code>, so why was it exported to the child processes? Could a shell be instructed to export all of its variables automatically? She consulted the stack exchange once more.</p>

<p>“What do you mean export all at once? you can use semi colons to define in one line” said a voice in the stack exchange. “Your question is unclear” chimed another. But finally, a moment of clarity: “<code>set -a</code>: When this option is on, the export attribute shall be set for each variable to which an assignment is performed”. She took once more to the package manager, sifting gently through its code with her regular expressions:</p>

<div><div><pre><code>$ grep -C2 &#39;set -a&#39; /usr/sbin/pkg
#====================  main functions  ======================#

set -a

# utility funcs
</code></pre></div></div>

<p>There it was. The trouble maker that had set this all in motion. A bit of a silly choice for a shell script, but so things were. She offered to remove it from the package manager, but it expressed misgivings that it might start malfunctioning. She nodded. The package manager was back on its feet, so better to let it be, for now.</p>

<p>With her Discord client updated, the UNIX witch gave her package manager a gentle pat, and she bid it back to its slumbers. She’d wake it again, when the time arose. For now, it deserved some rest, and so did she.</p>

        </article></div>
  </body>
</html>
