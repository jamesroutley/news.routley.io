<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jcs.org/2024/05/29/x1usb">Original</a>
    <h1>Adding a USB port to the ThinkPad X1 Nano (the hard way)</h1>
    
    <div id="readability-page-1" class="page"><article>
					<header>
						
						<div><p>
							posted on wednesday, may 29th, 2024
							</p></div>
					</header>
					<p>I wanted to add an internal USB port to my
						<a href="https://jcs.org/2021/01/27/x1nano">ThinkPad X1 Nano</a>
						which should have been a fairly easy thing to do, but it wasn&#39;t.</p>
					<p>Of course, if I were still using my
						<a href="https://jcs.org/2021/08/06/framework">Framework Laptop</a>
						it would be as easy as plugging in a
						<a href="https://community.frame.work/t/dongle-hider/3573">custom module</a>
						but I&#39;ve been using my X1 Nano as my primary laptop for quite some time now.</p>
					
					<h2 id="logitech-mouse">Logitech Mouse</h2>
					<p>As convenient as the TrackPoint is on my ThinkPad, having a mouse with a scroll
						wheel and 4 buttons is very handy.
						I
						<a href="https://jcs.org/uses">use</a>
						a Logitech mouse which can connect wirelessly to a
						<a href="https://amzn.to/3SmdyFQ">USB dongle</a>
						over RF, providing lower latency and better battery life than Bluetooth.
						The mouse does also support Bluetooth but OpenBSD doesn&#39;t, so USB dongle it is.
						This might seem annoying on a laptop with only 2 USB ports, but it&#39;s usually
						plugged into a USB-C dock under my desk which also routes power to the laptop so
						everything rides over a single USB-C cable and I don&#39;t even notice the dongle.</p>
					<p>However, whenever I unplug my laptop, this supposedly wireless mouse loses its
						connection and I need to remember to bring the dongle along with a
						USB-A-to-USB-C adapter.
						Yuck.</p>
					<p>I also have the same problem when using my AirPods with the laptop.
						Since OpenBSD can&#39;t connect to them natively over Bluetooth, I use a
						<a href="https://jcs.org/2020/11/18/openbsd_btaudio">Creative BT-W3</a>
						to handle Bluetooth which then presents a USB audio interface to OpenBSD.
						(Unfortunately I can&#39;t leave that connected all the time because as soon as I
						switch the AirPods to connect to my phone, the BT-W3 will take over the
						connection within about 10 seconds if I&#39;m within range of my laptop.)</p>
					<p>Clearly my life would be easier if OpenBSD had a Bluetooth stack again, but it&#39;s
						a lot of work and I don&#39;t want to write it.
						Perhaps it&#39;s easier to hide a USB port inside of the laptop where at least the
						mouse dongle can hide out.</p>
					<h2 id="m2">M.2</h2>
					<p>The X1 Nano has an available M.2 (B-Key) slot for adding an optional WWAN card.
						On many other laptops, it would be straightforward to buy an
						<a href="https://www.ebay.com/itm/335298311317">M.2 USB card</a>,
						install it in this slot, and instantly gain an internal USB port
						(or
						<a href="https://www.ebay.com/itm/266607702919">two</a>).</p>
					<p>Fun fact: in addition to providing a PCIe interface, M.2 slots also have pins
						for providing a USB connection.
						Many Wi-Fi cards that have integrated Bluetooth use both of these sets of pins
						to present the Wi-Fi interface over PCI and Bluetooth over USB.
						There are a set of
						<a href="https://jcs.org/images/2024-05-29-config_pins-950x958.png">4 configuration pins</a>
						that the card uses to tell the host what type of interfaces are being used.
						M.2 USB cards don&#39;t even have to provide their own USB controller, they just
						need to connect the M.2 USB pins to a USB port, shift 3.3V to 5V needed for USB,
						and ground certain configuration pins.
						The
						<a href="https://jcs.org/images/2024-05-29-schematic-2512x1753.png">schematic</a>
						for such a card shows how only the USB <code>SSIC</code>, <code>CONFIG</code>, <code>VBAT</code>, and <code>GND</code> pins
						are wired up.</p>
					<p>Unfortunately, Lenovo continues to implement a stupid
						<a href="https://www.thinkwiki.org/wiki/Problem_with_unauthorized_MiniPCI_network_card">network card
							whitelist</a>
						that IBM started over
						<a href="http://mjg59.user.srcf.net/thinkpad/wireless.html">20 years ago</a>
						on its ThinkPad models.
						If the card in the M.2 slot is not advertising a known PCI vendor and product ID
						in the whitelist contained in the BIOS (now UEFI firmware), the ThinkPad will
						refuse to boot:</p>
					<figure><a href="https://jcs.org/images/2024-05-29-m2_usb-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-m2_usb-335x251.jpg" srcset="/images/2024-05-29-m2_usb-335x251.jpg 1x, /images/2024-05-29-m2_usb-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>M.2 USB card (with port removed) plugged in...</figcaption>
					</figure>
					<figure><a href="https://jcs.org/images/2024-05-29-unauthorized-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-unauthorized-335x251.jpg" srcset="/images/2024-05-29-unauthorized-335x251.jpg 1x, /images/2024-05-29-unauthorized-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>...which causes an error</figcaption>
					</figure>
					<p>I briefly considering making a custom M.2 PCI card that forwarded the USB pins
						but also added some kind of microcontroller that pretended to be a known good
						WWAN card, at least as far as its vendor and product ID.
						I also thought about a card that used some kind of timer chip to keep the
						configuration pins disconnected long enough to let the machine boot while
						thinking nothing is in the slot, and then connect them to the USB port.
						These both seemed difficult to implement, so I started down a different route.</p>
					<h2 id="firmware-hacking">Firmware Hacking?</h2>
					<p>To investigate the whitelist, I first needed a valid WWAN card to know what
						vendor and product ID to look for.
						This took a bit of trial and error but I eventually found the
						<a href="https://www.ebay.com/itm/185716453055">Qualcomm X55</a>
						card to work, which has a vendor of <code>105b</code> (Foxconn) and a product of <code>e0ab</code>.</p>
					<p>Next, I needed to look at the actual firmware code to see how its whitelist
						worked.
						After poking around the motherboard, I located the firmware flash chip right
						next to the M.2 slot under a plastic sheet, and it&#39;s a
						<a href="https://www.winbond.com/hq/product/code-storage-flash-memory/serial-nor-flash/?__locale=en&amp;partNo=W25R256JV">Winbond W25R256JV 32 Megabyte</a>
						8mm x 6mm chip.</p>
					<figure><a href="https://jcs.org/images/2024-05-29-winbond_area-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-winbond_area-335x251.jpg" srcset="/images/2024-05-29-winbond_area-335x251.jpg 1x, /images/2024-05-29-winbond_area-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>Firmware flash chip</figcaption>
					</figure>
					<figure><a href="https://jcs.org/images/2024-05-29-winbond-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-winbond-335x251.jpg" srcset="/images/2024-05-29-winbond-335x251.jpg 1x, /images/2024-05-29-winbond-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>Winbond W25R256JV</figcaption>
					</figure>
					<p>Since this flash chip has such a low profile, my usual SOIC chip clips couldn&#39;t
						grab onto it.
						I didn&#39;t want to desolder it and risk damaging it, so I purchased a
						<a href="https://www.ebay.com/itm/395097837233">pogopin probe</a>
						that worked well, though it&#39;s a bit tiresome to use because it requires a steady
						hand applying downward pressure for about eight minutes for a full read and
						write.</p>
					<p>Using the probe with my
						<a href="https://amzn.to/3U1B9gg">CH341A reader</a>
						and
						<a href="https://github.com/nofeletru/UsbAsp-flash">AsProgrammer</a>
						on a Windows laptop (ironically, my Framework laptop), I was able to read the
						firmware image and look for <code>5B 10 AB E0</code> (the vendor and product in
						little-endian format).</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-asprogrammer-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-asprogrammer-505x378.jpg" srcset="/images/2024-05-29-asprogrammer-505x378.jpg 1x, /images/2024-05-29-asprogrammer-1010x756@2x.jpg 2x" width="505" height="378"/></a>
							<figcaption>Firmware contents in AsProgrammer</figcaption>
						</figure>
					</center>
					<p>I changed <code>E0</code> to <code>E1</code> in both instances, hoping it would then boot with an
						unauthorized card error, indicating I had found the proper whitelist.
						Unfortunately this caused the machine to boot with this error:</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-selfheal-1500x558.jpg"><img src="https://jcs.org/images/2024-05-29-selfheal-505x187.jpg" srcset="/images/2024-05-29-selfheal-505x187.jpg 1x, /images/2024-05-29-selfheal-1010x374@2x.jpg 2x" width="505" height="187"/></a>
							<figcaption>BIOS self-healing</figcaption>
						</figure>
					</center>
					<p>Apparently Lenovo uses a thing called Secure Flash Authentication which
						calculates a checksum of the firmware image and validates it against a signed
						value and if it fails, the firmware is overwritten with a known good version.
						I&#39;m not entirely sure how this works, though.
						Where is the known good copy stored?
						Another 32MB flash chip?
						What is doing the flash verification?
						It can&#39;t be the firmware on the flash chip itself because that could be toast
						and it will still self-heal.
						Is the verification code running from the known good flash?
						Does it do this verification on every boot, reading the entire 32MB before
						POSTing?</p>
					<p>After wasting a week or two on this and playing around with some very sketchy
						Windows software for modifying UEFI payloads, I gave up going this route.</p>
					<h2 id="fingerprint-reader">Fingerprint Reader</h2>
					<p>While staring at the motherboard with the battery removed, I remembered that the
						fingerprint reader that sits next to the touchpad connects over USB, though I
						usually have it disabled in the firmware.
						I wondered if it would be possible to use whatever connection that board uses to
						connect an arbitrary USB device.</p>
					<figure><a href="https://jcs.org/images/2024-05-29-fingerprint-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-fingerprint-335x251.jpg" srcset="/images/2024-05-29-fingerprint-335x251.jpg 1x, /images/2024-05-29-fingerprint-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>Fingerprint reader board (under metal cage)</figcaption>
					</figure>
					<figure><a href="https://jcs.org/images/2024-05-29-fingerprint_pins-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-fingerprint_pins-335x251.jpg" srcset="/images/2024-05-29-fingerprint_pins-335x251.jpg 1x, /images/2024-05-29-fingerprint_pins-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>Fingerprint reader pins</figcaption>
					</figure>
					<p>The fingerprint reader board used an
						<abbr title="Flat Flexible Cable">FFC</abbr>
						8-pin connector but only 4 of its pins were connected which is also the amount
						needed for a basic USB 2.0 connection.
						I bought an
						<a href="https://amzn.to/4cZx0lM">FFC 8-pin 0.5mm breakout board</a>
						and determined pin 1 to be USB <code>VCC</code>, pin 2 <code>DATA-</code>, pin 3 <code>DATA+</code>, and pin 4
						<code>GND</code>.</p>
					<figure><a href="https://jcs.org/images/2024-05-29-fingerprint_boards-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-fingerprint_boards-335x251.jpg" srcset="/images/2024-05-29-fingerprint_boards-335x251.jpg 1x, /images/2024-05-29-fingerprint_boards-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>Breakout board next to fingerprint reader</figcaption>
					</figure>
					<figure><a href="https://jcs.org/images/2024-05-29-fingerprint_port-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-fingerprint_port-335x251.jpg" srcset="/images/2024-05-29-fingerprint_port-335x251.jpg 1x, /images/2024-05-29-fingerprint_port-670x502@2x.jpg 2x" width="335" height="251"/></a>
						<figcaption>USB port wired up</figcaption>
					</figure>
					<p>Conveniently, there are two rubber/foam blocks adhered to the case on
						<a href="https://jcs.org/images/2024-05-29-m2_usb-3872x2904.jpg">both sides of the display connector</a>.
						By removing one of them, there is just enough space to house a USB connector in
						a permanent location:</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-usb_port_location-1500x694.jpg"><img src="https://jcs.org/images/2024-05-29-usb_port_location-505x233.jpg" srcset="/images/2024-05-29-usb_port_location-505x233.jpg 1x, /images/2024-05-29-usb_port_location-1010x466@2x.jpg 2x" width="505" height="233"/></a>
							<figcaption>USB port location</figcaption>
						</figure>
					</center>
					<p>So my (eventual) idea was to create a new
						<a href="https://jlcpcb.com/capabilities/flex-pcb-capabilities">flex PCB</a>
						that goes in place of the fingerprint reader and has an FFC 8-pin connector for
						the motherboard cable, then routes the four USB pins down to a USB port next to
						the display connector.
						While normally a USB port wouldn&#39;t hold up well on a flexible PCB, this one is
						going to house a USB device that is semi-permanently installed, so it won&#39;t
						undergo the stress of constant removal and insertion.</p>
					<p>With the temporary USB port soldered up, I crossed my fingers and powered on the
						machine, and nothing started on fire.
						Once OpenBSD booted, I plugged in some USB 2.0 devices and most of them
						attachedâ€¦ except the one device I actually needed: the Logitech Bolt receiver.
						There were no port errors, it was just never detected as if it weren&#39;t powered
						up.</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-usb_attachments-1500x615.jpg"><img src="https://jcs.org/images/2024-05-29-usb_attachments-505x207.jpg" srcset="/images/2024-05-29-usb_attachments-505x207.jpg 1x, /images/2024-05-29-usb_attachments-1010x414@2x.jpg 2x" width="505" height="207"/></a>
							<figcaption>OpenBSD showing USB connections</figcaption>
						</figure>
					</center>
					<h2 id="usb-power">USB Power</h2>
					<p>After checking again with a multimeter, I realized that the FFC cable going to
						the fingerprint reader is only carrying 3.3V instead of the usual 5V for USB.
						Apparently the fingerprint reader is designed to only need 3.3V for its USB
						connection (possibly taking power from nearby i<sup>2</sup>c components which
						use 3.3V), and most of the USB devices that I tried worked with only 3.3V as
						well.
						Since the Logitech Bolt required more than 3.3V, I needed to boost the voltage
						to 5V.</p>
					<p>While doing some
						<a href="https://dzrmo.wordpress.com/2017/01/26/a-tiny-but-good-boost-converter/">research</a>,
						I came across
						<a href="https://amzn.to/3V4S7e6">these boost boards</a>
						which use an
						<a href="https://www.lcsc.com/product-detail/DC-DC-Converters_MICRONE-Nanjing-Micro-One-Elec-ME2108A50PG_C236798.html">ME2108</a>
						to boost &lt;5V to 5V.
						I bought some and wired one up inline with the external USB port and it did
						provide the necessary 5V to make the Logitech Bolt adapter work, so I just
						needed to incorporate that circuit into my flex PCB.</p>
					<h2 id="designing-a-pcb">Designing a PCB</h2>
					<p>After
						<a href="https://jcs.org/notes/2024/04/02/112204962722683053">whining</a>
						about having to do PCB design and dreading using EAGLE again, I found
						<a href="https://easyeda.com/">EasyEDA</a>
						which offers a free in-browser PCB design platform
						(which worked in Firefox on OpenBSD)
						that ties in with
						<a href="https://jlcpcb.com/">JLCPCB</a>
						for PCB printing and assembly.</p>
					<p>I got out my calipers and took a bunch of measurements of the fingerprint reader
						board including its various oval-shaped holes, then designed a similar board in
						EasyEDA.
						I desoldered the components on one of the boost boards and figured out how they
						each connected, and incorporated those onto my PCB.</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-3d_pcb-978x694.png"><img src="https://jcs.org/images/2024-05-29-3d_pcb-505x358.png" srcset="/images/2024-05-29-3d_pcb-505x358.png 1x, /images/2024-05-29-3d_pcb-1010x716@2x.png 2x" width="505" height="358"/></a>
							<figcaption>EasyEDA&#39;s 3D view</figcaption>
						</figure>
					</center>
					<p>I also opted for JLCPCB&#39;s PCB assembly service so they would deliver completed
						boards with the FFC connector and USB port components included and soldered on.
						This would save me from having to source them separately and deal with SMD
						soldering.</p>
					<p>A few weeks later, I had my printed flex boards all assembled and just needed to
						punch them out of their perforated sheets and trim the legs on the USB port.
						The black coating over the flex board is for EMI shielding.</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-printed_pcbs-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-printed_pcbs-335x251.jpg" srcset="/images/2024-05-29-printed_pcbs-335x251.jpg 1x, /images/2024-05-29-printed_pcbs-670x502@2x.jpg 2x" width="335" height="251"/></a>
							<figcaption>Flex PCBs</figcaption>
						</figure>
						<figure><a href="https://jcs.org/images/2024-05-29-printed_pcb_closeup-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-printed_pcb_closeup-335x251.jpg" srcset="/images/2024-05-29-printed_pcb_closeup-335x251.jpg 1x, /images/2024-05-29-printed_pcb_closeup-670x502@2x.jpg 2x" width="335" height="251"/></a>
							<figcaption>SMD components</figcaption>
						</figure>
					</center>
					<p>The top part of the PCB replaces the fingerprint module underneath its metal
						cage:</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-flex_installed-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-flex_installed-335x251.jpg" srcset="/images/2024-05-29-flex_installed-335x251.jpg 1x, /images/2024-05-29-flex_installed-670x502@2x.jpg 2x" width="335" height="251"/></a></figure>
						<figure><a href="https://jcs.org/images/2024-05-29-flex_installed_under_cage-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-flex_installed_under_cage-335x251.jpg" srcset="/images/2024-05-29-flex_installed_under_cage-335x251.jpg 1x, /images/2024-05-29-flex_installed_under_cage-670x502@2x.jpg 2x" width="335" height="251"/></a></figure>
					</center>
					<p>It then snakes under some other cables, the battery, the heatpipe, and under the
						display cable to finally put a USB port where I need it, and a
						<a href="https://amzn.to/4ebIfIu">USB multimeter</a> confirms that the power is correctly
						boosted to a solid 5V:</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-final_location-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-final_location-335x251.jpg" srcset="/images/2024-05-29-final_location-335x251.jpg 1x, /images/2024-05-29-final_location-670x502@2x.jpg 2x" width="335" height="251"/></a></figure>
						<figure><a href="https://jcs.org/images/2024-05-29-5v-1500x1125.jpg"><img src="https://jcs.org/images/2024-05-29-5v-335x251.jpg" srcset="/images/2024-05-29-5v-335x251.jpg 1x, /images/2024-05-29-5v-670x502@2x.jpg 2x" width="335" height="251"/></a></figure>
					</center>
					<p>That screw hole standoff on the bottom cover shown there near the USB port did
						need to be sanded off to clear the height of the USB device.
						This standoff normally has a plastic clip screwed into it that clips under the
						case and isn&#39;t one of the load-bearing screws that goes all the way through the
						bottom cover.</p>
					<p>And now with nothing external plugged in, my Logitech Bolt adapter is attached
						to the root USB hub and my wireless mouse is again wireless:</p>
					<pre><code>nano:~$ usbdevs -v
Controller /dev/usb0:
addr 01: 8086:0000 Intel, xHCI root hub
	 super speed, self powered, config 1, rev 1.00
	 driver: uhub0
Controller /dev/usb1:
addr 01: 8086:0000 Intel, xHCI root hub
	 super speed, self powered, config 1, rev 1.00
	 driver: uhub1
addr 02: 046d:c548 Logitech, USB Receiver
	 full speed, power 98 mA, config 1, rev 5.00
	 driver: uhidev0
	 driver: uhidev1
	 driver: uhidev2
addr 03: 13d3:5411 Azurewave, Integrated Camera
	 high speed, power 500 mA, config 1, rev 61.01, iSerial 0000
	 driver: uvideo0
	 driver: uvideo1
	 driver: ugen0
addr 04: 8087:0026 Intel, Bluetooth
	 full speed, self powered, config 1, rev 0.02
	 driver: ugen1
</code></pre>
					<h2 id="3d-printed-shim">3D-Printed Shim</h2>
					<p>Since the original fingerprint reader had a raised pad and the flex PCB is just
						flat, there&#39;s a slight depression in the keyboard deck where the fingerprint
						reader used to be.
						I designed a 3d model to sandwich between the PCB and the keyboard deck that
						will make it more flush, but I still haven&#39;t perfected it.
						This may just require some matte filament and acetone smoothing to eliminate the
						3d printing lines.</p>
					<center>
						<figure><a href="https://jcs.org/images/2024-05-29-hole-1500x754.jpg"><img src="https://jcs.org/images/2024-05-29-hole-505x254.jpg" srcset="/images/2024-05-29-hole-505x254.jpg 1x, /images/2024-05-29-hole-1010x508@2x.jpg 2x" width="505" height="254"/></a></figure>
					</center>
					<p>On a side note, I thought it would be neat to house a Yubikey in this hole
						instead or maybe a super tiny LCD.</p>
				</article></div>
  </body>
</html>
