<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/basecamp/kamal-proxy">Original</a>
    <h1>Kamal Proxy â€“ A minimal HTTP proxy for zero-downtime deployments</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><div dir="auto"><a id="user-content-kamal-proxy---a-minimal-http-proxy-for-zero-downtime-deployments" aria-label="Permalink: Kamal Proxy - A minimal HTTP proxy for zero-downtime deployments" href="#kamal-proxy---a-minimal-http-proxy-for-zero-downtime-deployments"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">What it does</h2><a id="user-content-what-it-does" aria-label="Permalink: What it does" href="#what-it-does"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Kamal Proxy is a tiny HTTP proxy, designed to make it easy to coordinate
zero-downtime deployments. By running your web applications behind Kamal Proxy,
you can deploy changes to them without interruping any of the traffic that&#39;s in
progress. No particular cooperation from an application is required for this to
work.</p>
<p dir="auto">Kamal Proxy is designed to work as part of <a href="https://kamal-deploy.org/" rel="nofollow">Kamal</a>,
which provides a complete deployment experience including container packaging
and provisioning. However, Kamal Proxy could also be used standalone or as part
of other deployment tooling.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">A quick overview</h2><a id="user-content-a-quick-overview" aria-label="Permalink: A quick overview" href="#a-quick-overview"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To run an instance of the proxy, use the <code>kamal-proxy run</code> command. There&#39;s no
configuration file, but there are some options you can specify if the defaults
aren&#39;t right for your application.</p>
<p dir="auto">For example, to run the proxy on a port other than 80 (the default) you could:</p>
<div data-snippet-clipboard-copy-content="kamal-proxy run --http-port 8080"><pre><code>kamal-proxy run --http-port 8080
</code></pre></div>
<p dir="auto">Run <code>kamal-proxy help run</code> to see the full list of options.</p>
<p dir="auto">To route traffic through the proxy to a web application, you <code>deploy</code> instances
of the application to the proxy. Deploying an instance makes it available to the
proxy, and replaces the instance it was using before (if any).</p>
<p dir="auto">Use the format <code>hostname:port</code> when specifying the instance to deploy.</p>
<p dir="auto">For example:</p>
<div data-snippet-clipboard-copy-content="kamal-proxy deploy service1 --target web-1:3000"><pre><code>kamal-proxy deploy service1 --target web-1:3000
</code></pre></div>
<p dir="auto">This will instruct the proxy to register <code>web-1:3000</code> to receive traffic under
the service name <code>service1</code>. It will immediately begin running HTTP health
checks to ensure it&#39;s reachable and working and, as soon as those health checks
succeed, will start routing traffic to it.</p>
<p dir="auto">If the instance fails to become healthy within a reasonable time, the <code>deploy</code>
command will stop the deployment and return a non-zero exit code, allowing
deployment scripts to handle the failure appropriately.</p>
<p dir="auto">Each deployment takes over all the traffic from the previously deployed
instance. As soon as Kamal Proxy determines that the new instance is healthy,
it will route all new traffic to that instance.</p>
<p dir="auto">The <code>deploy</code> command also waits for traffic to drain from the old instance before
returning. This means it&#39;s safe to remove the old instance as soon as <code>deploy</code>
returns successfully, without interrupting any in-flight requests.</p>
<p dir="auto">Because traffic is only routed to a new instance once it&#39;s healthy, and traffic
is drained completely from old instances before they are removed, deployments
take place with zero downtime.</p>
<div dir="auto"><h3 tabindex="-1" dir="auto">Host-based routing</h3><a id="user-content-host-based-routing" aria-label="Permalink: Host-based routing" href="#host-based-routing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Host-based routing allows you to run multiple applications on the same server,
using a single instance of Kamal Proxy to route traffic to all of them.</p>
<p dir="auto">When deploying an instance, you can specify a host that it should serve traffic
for:</p>
<div data-snippet-clipboard-copy-content="kamal-proxy deploy service1 --target web-1:3000 --host app1.example.com"><pre><code>kamal-proxy deploy service1 --target web-1:3000 --host app1.example.com
</code></pre></div>
<p dir="auto">When deployed in this way, the instance will only receive traffic for the
specified host. By deploying multiple instances, each with their own host, you
can run multiple applications on the same server without port conflicts.</p>
<p dir="auto">Only one service at a time can route a specific host:</p>
<div data-snippet-clipboard-copy-content="kamal-proxy deploy service1 --target web-1:3000 --host app1.example.com
kamal-proxy deploy service2 --target web-2:3000 --host app1.example.com # returns &#34;Error: host is used by another service&#34;
kamal-proxy remove service1
kamal-proxy deploy service2 --target web-2:3000 --host app1.example.com # suceeds"><pre><code>kamal-proxy deploy service1 --target web-1:3000 --host app1.example.com
kamal-proxy deploy service2 --target web-2:3000 --host app1.example.com # returns &#34;Error: host is used by another service&#34;
kamal-proxy remove service1
kamal-proxy deploy service2 --target web-2:3000 --host app1.example.com # suceeds
</code></pre></div>
<div dir="auto"><h3 tabindex="-1" dir="auto">Automatic TLS</h3><a id="user-content-automatic-tls" aria-label="Permalink: Automatic TLS" href="#automatic-tls"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Kamal Proxy can automatically obtain and renew TLS certificates for your
applications. To enable this, add the <code>--tls</code> flag when deploying an instance:</p>
<div data-snippet-clipboard-copy-content="kamal-proxy deploy service1 --target web-1:3000 --host app1.example.com --tls"><pre><code>kamal-proxy deploy service1 --target web-1:3000 --host app1.example.com --tls
</code></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Specifying <code>run</code> options with environment variables</h2><a id="user-content-specifying-run-options-with-environment-variables" aria-label="Permalink: Specifying run options with environment variables" href="#specifying-run-options-with-environment-variables"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">In some environments, like when running a Docker container, it can be convenient
to specify <code>run</code> options using environment variables. This avoids having to
update the <code>CMD</code> in the Dockerfile to change the options. To support this,
<code>kamal-proxy run</code> will read each of its options from environment variables if they
are set. For example, setting the HTTP port can be done with either:</p>
<div data-snippet-clipboard-copy-content="kamal-proxy run --http-port 8080"><pre><code>kamal-proxy run --http-port 8080
</code></pre></div>
<p dir="auto">or:</p>
<div data-snippet-clipboard-copy-content="HTTP_PORT=8080 kamal-proxy run"><pre><code>HTTP_PORT=8080 kamal-proxy run
</code></pre></div>
<p dir="auto">If any of the environment variables conflict with something else in your
environment, you can prefix them with <code>KAMAL_PROXY_</code> to disambiguate them. For
example:</p>
<div data-snippet-clipboard-copy-content="KAMAL_PROXY_HTTP_PORT=8080 kamal-proxy run"><pre><code>KAMAL_PROXY_HTTP_PORT=8080 kamal-proxy run
</code></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Building</h2><a id="user-content-building" aria-label="Permalink: Building" href="#building"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">To build Kamal Proxy locally, if you have a working Go environment you can:</p>
<div data-snippet-clipboard-copy-content="make"><pre><code>make
</code></pre></div>
<p dir="auto">Alternatively, build as a Docker container:</p>
<div data-snippet-clipboard-copy-content="make docker"><pre><code>make docker
</code></pre></div>
<div dir="auto"><h2 tabindex="-1" dir="auto">Trying it out</h2><a id="user-content-trying-it-out" aria-label="Permalink: Trying it out" href="#trying-it-out"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">See the <a href="https://hannahilea.com/basecamp/kamal-proxy/blob/main/example">example</a> folder for a Docker Compose setup that you can use
to try out the proxy commands.</p>
</article></div></div>
  </body>
</html>
