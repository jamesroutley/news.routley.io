<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://taras.glek.net/post/curious-case-of-maintaining-sufficient-free-space-with-zfs/">Original</a>
    <h1>Maintaining sufficient free space with ZFS</h1>
    
    <div id="readability-page-1" class="page"><div role="main">
  <div>
    <div>
      <article role="main">
        <p>TLDR: ZFS free-space reporting is a lagging indicator.</p>
<p><img src="https://taras.glek.net/images/hard-disk-in-space.png" alt="hard drive in space"/></p>
<h3 id="background">Background</h3>
<p>I use <a href="https://www.proxmox.com/en/">Proxmox</a> VM server backed by a <a href="https://en.wikipedia.org/wiki/ZFS">ZFS</a> array of hard drives for various personal infrastructure. I also have security cameras that upload motion-triggered videos to my server (via FTP!).</p>
<h3 id="problem-description">Problem Description</h3>
<p>I would like to use 90% of my available space for most-recent security videos.</p>
<p>Recipe:</p>
<ol>
<li>Create a dedicated ZFS volume</li>
<li>Setup <a href="https://linuxhint.com/setup-zfs-quotas-reservations/">ZFS quota</a></li>
<li>Run a cronjob to free space faster than it gets consumed by video uploads.</li>
</ol>
<p>I set out to find a decent disk-freeing solution. I eventually settled on a python <a href="https://github.com/fphammerle/free-disk">free-disk</a>. (Most of these utils were written in bash, didn’t want to disk having to grasp &amp; modify write-only code).</p>
<p>I modified <code>free-disk</code> to support deleting files with a particular extension (e.g. <code>.mp4</code>) and deployed it. My changes to free-disk are <a href="https://github.com/tarasglek/free-disk/tree/taras/precision">here</a>. Author took part of them in, hoping for rest to get upstreamed too.</p>
<p>I was surprised to see that the script freed up roughly 10x more than I expected. So I added some debug logging and after a few days of experiments ended up with following:</p>
<pre><code>15:17:02-0700:DEBUG:Required free: 9.31GiB. 3.4GiB to free. --track-
bytes-deleted=True
Jul 09 15:17:37 quad free-disk[70706]: 2022-07-09T15:17:37-0700:INFO:Removed 40 file(s) with modification date &lt;= 2022
-06-18T18:32:18.734254Z. Deleted 3.46GiB. Filesystem freed 2.22GiB.
Jul 09 15:17:37 quad free-disk[74496]: Filesystem         1M-blocks     Used Available Use% Mounted on
Jul 09 15:17:37 quad free-disk[74496]: rpool/data/tinycam  1572864M 1564537M     8328M 100% /export/tinycam
Jul 09 15:17:39 quad free-disk[74499]: Filesystem         1M-blocks     Used Available Use% Mounted on
Jul 09 15:17:39 quad free-disk[74499]: rpool/data/tinycam  1572864M 1564537M     8328M 100% /export/tinycam
Jul 09 15:17:41 quad free-disk[74502]: Filesystem         1M-blocks     Used Available Use% Mounted on
Jul 09 15:17:41 quad free-disk[74502]: rpool/data/tinycam  1572864M 1564537M     8328M 100% /export/tinycam
Jul 09 15:17:43 quad free-disk[74616]: Filesystem         1M-blocks     Used Available Use% Mounted on
Jul 09 15:17:43 quad free-disk[74616]: rpool/data/tinycam  1572864M 1563300M     9565M 100% /export/tinycam
</code></pre><p>To get this data I added alernate logic to free-disk to free based on bytes-deleted instead of filesystem free-space (eg number reported by <code>df</code>). I also added a few <code>sleep 2;df -h /export/tinycam</code> commands to track progress.</p>
<p>It seems that after I delete files, it takes roughly 5-10seconds for disk-free information to settle. Problem-settled: “obviously one should only free space by tracking bytes-deleted” or “add sleep 10 before checking free-space”. Not so fast :)</p>
<h3 id="complexity-of-modern-free-space-tracking">Complexity of Modern Free-Space tracking</h3>
<p>ZFS is a filesystem that supports deduplication &amp; compression. It also supports snapshots. This means that the file being deleted could:</p>
<ol>
<li>Be a uncompressed and have no other duplicates.</li>
<li>Be compressed and space freed would be less than the size shown by <code>stat</code></li>
<li>Be referenced by a snapshot, so no space is actually freed when the file is deleted.</li>
<li>Be dedupped to another file</li>
<li>Some combo of all of the above</li>
</ol>
<p>So in order for ZFS to know how much space has been reclaimed by file deletion it needs to check all these conditions and it should do this async of file-deletion to now slow down FS-operations.</p>
<p>Luckily ZFS documents this:</p>
<blockquote>
<p>ZFS is a transactional file system. Most file system modifications are bundled into transaction groups and committed to disk asynchronously. Until these modifications are committed to disk, they are termed pending changes. The amount of space used, available, and referenced by a file or file system does not consider pending changes. Pending changes are generally accounted for within a few seconds. Even committing a change to disk by using fsync(3C) or O_SYNC does not necessarily guarantee that the space usage information is updated immediately.</p>
</blockquote>
<p>Conclusion: There is no universal way to ensure space is freed on ZFS. One needs to carefully consider how ZFS is being used in order to understand how to automatically maintain free disk space.</p>
<p>I get burned by (3) about once or twice a year, eventually I remember that I have a snapshot that diverged too much. This lagging-indication of free-space was new and fun, figured it was worth a blog post.</p>
<p>Comment on <a href="https://twitter.com/tarasglek/status/1546091314915278853">Twitter</a></p>


        
          
        

        

        
      </article>

      
        
      


      

    </div>
  </div>
</div></div>
  </body>
</html>
