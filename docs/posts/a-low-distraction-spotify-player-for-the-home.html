<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://capnfabs.net/posts/stereo-remote/">Original</a>
    <h1>A low-distraction Spotify player for the home</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody" id="content"><p>I bought a stereo system back in 2023. Like an ‚Äòold school‚Äô one, in the sense that it consists of a couple of bookshelf speakers and an amp. I don‚Äôt own any physical music media anymore ‚Äì I left all my CDs behind when I moved to Germany in 2016, and just use Spotify now. So I needed a way to get Spotify on the stereo.</p><figure><img srcset="/posts/stereo-remote/hta100_hu12959079299878538531.jpg,
/posts/stereo-remote/hta100_hu16309209606491630775.jpg 2x" src="https://www.noemamag.com/posts/stereo-remote/hta100_hu12959079299878538531.jpg" alt="I am a big sucker for the brushed metal and the slightly overdone retro aesthetic"/><figcaption><p>I am a big sucker for the brushed metal and the slightly overdone retro aesthetic</p></figcaption></figure><p>Now ‚Äì <em>normal</em> people would do something like buy an amplifier that supports <a href="https://support.spotify.com/de-en/article/spotify-connect/">Spotify Connect</a> directly or use Bluetooth Audio or buy a <a href="https://www.hifiklubben.de/argon-audio-solo-musikstreamer/argsolobk/">streaming device</a> and be done with it. But I‚Äôve been sorta trying to rethink my relationship with my phone and get some of my attention span back ‚Äì and you still have to unlock and use a phone to start the music with these Spotify Connect systems. I don‚Äôt want to have to look at my notifications or do Face ID or potentially get sucked into an email / social media hole just to put music on.</p><p>So I decided to build something. After a couple weeks, I‚Äôd gotten a piece of open-source software called <a href="https://github.com/librespot-org/librespot">librespot</a> to <a href="https://capnfabs.net/posts/udev-systemd-spotify-usb-audio/">stream over the stereo‚Äôs USB-audio connection from a Raspberry Pi</a>. This works great<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> ‚Äì but I still needed an <em>interface</em>.</p><p>I wanted:</p><ul><li>to be able to play music without having to look at my phone (this was the whole goal of the project)</li><li>to be able to change the volume from my sofa. And pause the current song, and skip tracks‚Ä¶</li></ul><p>What I wanted was a üí° <em>remote control</em>. Something that doesn‚Äôt require line-of-sight because I‚Äôve got that Raspberry Pi in a cupboard somewhere. But the Raspberry Pi is just a Linux computer‚Ä¶ so maybe I can just use a bluetooth keyboard? Like a <a href="https://www.makeuseof.com/what-is-a-macro-pad/">Macropad</a>?</p><h2 id="spoilers-here-is-the-remote-control">Spoilers, here is the remote control</h2><figure><img srcset="/posts/stereo-remote/remote-control_hu13834799048467908794.jpg,
/posts/stereo-remote/remote-control_hu10756146782145689326.jpg 2x" src="https://www.noemamag.com/posts/stereo-remote/remote-control_hu13834799048467908794.jpg" alt="Probably the coolest remote control ever"/><figcaption><p>Probably the coolest remote control ever</p></figcaption></figure><p>This is an <em>Owlab Voice Mini</em> and a bit of custom software running on the computer.</p><p>Here‚Äôs how it works:</p><ul><li>the top row of buttons are <kbd>‚èÆÔ∏è Prev</kbd> | <kbd>‚èØÔ∏è Play/Pause</kbd> | <kbd>‚è≠Ô∏è Next</kbd>.</li><li>The big ISO Enter button is <em>also</em> Play/Pause. It makes a big satisfying ‚Äúclick‚Äù sound when you slap it.</li><li>That little brown knob on the top right (behind the enter key) changes the volume.</li></ul><p>But! It also supports <em>playing albums</em>. The awkward list icon button (middle-bottom, I can‚Äôt draw good) in combination with any of the other keys randomly picks an album matched to an ‚ú® <em>energy</em> ‚ú®:</p><ul><li><strong>Chill</strong>: think: easy listening. Sigur Ros. The Staves. Mogwai. The National.</li><li><strong>Fun</strong>. think: Frances Quinlan, Vampire Weekend, Ezra Collective, Royal Canoe<sup id="fnref:2"><a href="#fn:2" role="doc-noteref">2</a></sup>.</li><li><strong>RUDE</strong>: Queen, Tune-Yards, Fall of Troy, Battles, and (since last week after watching that <a href="https://youtu.be/-91vymvIH0c?si=2YFhow5K-csYeIij&amp;t=275">Tiny Desk concert that‚Äôs doing the rounds</a>) Doechii.</li></ul><p>I <em>love</em> this playlist feature. I can get home, turn on the stereo (it‚Äôs got a super satisfying big button which makes a <em>kchunk</em> sound and everything lights up) and then slap a really satisfying ultra clicky mechanical keyboard switch and have the music start.</p><p>The system isn‚Äôt perfect ‚Äì</p><ul><li>there‚Äôs no screen, and therefore no immediate feedback for your actions. I sometimes have to wait for the song to really start before I can figure out if it‚Äôs something I want to listen to.</li><li>The bluetooth keyboard won‚Äôt wake up from twiddling the volume knob, so you‚Äôve gotta tap the <kbd>fn</kbd> key to get it to wake up first.</li><li>It‚Äôs also probably the remote control with the worst battery life imaginable ‚Äì about three days ‚Äì and the on/off switch is literally <em>underneath</em> the keys.</li></ul><figure><img srcset="/posts/stereo-remote/on-off-switch_hu5647442217040697064.jpg,
/posts/stereo-remote/on-off-switch_hu7532112025809873413.jpg 2x" src="https://www.noemamag.com/posts/stereo-remote/on-off-switch_hu5647442217040697064.jpg" alt="WHYYYYYYYYYYYY"/><figcaption><p>WHYYYYYYYYYYYY</p></figcaption></figure><p>But I love it. I can leave my phone on charge and muted and kinda just <a href="https://open.spotify.com/track/2VNSUMHI1R3B6wVV8P7ZlG">roll the dice</a> through some of my favourite albums until I get to something I wanna listen to.</p><h2 id="heres-how-it-works">Here‚Äôs how it works</h2><p>Oh goodness I think this is the first time i‚Äôve put a block diagram into a blog post:</p><figure><img src="https://www.noemamag.com/posts/stereo-remote/block-diagram.png" alt="ok it‚Äôs not actually that complex"/><figcaption><p>ok it‚Äôs not actually that complex</p></figcaption></figure><p>We‚Äôll talk about all these pieces one-by-one.</p><h3 id="building-the-macropad">Building the macropad</h3><p>Like I said before, the macropad is an <a href="https://www.qwertykeys.com">Owlab</a> <a href="https://candykeys.com/product/owlabs-voice-mini-7-key-macropad/latte">Voice Mini (in Latte)</a>. You still need to BYO switches + keycaps.</p><figure><img src="https://www.noemamag.com/posts/stereo-remote/owlab-case.jpg" alt="I think this is a render?"/><figcaption><p>I think this is a render?
<a href="https://candykeys.com/product/owlabs-voice-mini-7-key-macropad">img via Candykeys</a></p></figcaption></figure><p>I added some clicky clicky <a href="https://www.cherry.de/de-de/produkt/mx-green">Cherry MX Green</a> switches and some ‚Äúrelegendable keycaps‚Äù that I had lying around (these are super cool, you can draw on a piece of paper and then just slip it into the keycap).<sup id="fnref:3"><a href="#fn:3" role="doc-noteref">3</a></sup></p><figure><img srcset="/posts/stereo-remote/partially-assembled_hu7649751436203933297.jpg,
/posts/stereo-remote/partially-assembled_hu2371100149835121066.jpg 2x" src="https://www.noemamag.com/posts/stereo-remote/partially-assembled_hu7649751436203933297.jpg" alt="WIP; ISO Enter keys are weirdly difficult to source"/><figcaption><p>WIP; ISO Enter keys are weirdly difficult to source</p></figcaption></figure><p>After building - we‚Äôve gotta figure out what all the keys are mapped to, and (maybe) reprogram it. Here‚Äôs what I‚Äôve got it set up for:</p><div><figure><img src="https://www.noemamag.com/posts/stereo-remote/keymap-layer1.png" alt="Layer 1 (normal)"/><figcaption><p>Layer 1 (normal)</p></figcaption></figure><figure><img src="https://www.noemamag.com/posts/stereo-remote/keymap-layer2.png" alt="Layer 2 (playlists)"/><figcaption><p>Layer 2 (playlists)</p></figcaption></figure></div><p>That is: pressing the top row of keys sends 1, 2, and 3 to the computer. Holding the ‚Äúplaylists / layer 2‚Äù key and pressing the top row of keys sends Q, W, and E to the computer.</p><p>We‚Äôll now teach the computer how to interpret these keystrokes.</p><h3 id="changes-to-librespot">Changes to librespot</h3><p>I added some custom code to librespot which listens on TCP port 2777 and processes text instructions. The protocol is super simple ‚Äì it supports the following commands:</p><div><pre tabindex="0"><code data-lang="py"><span><span><span>&#34;PlayPause&#34;</span><span>,</span> <span>&#34;Next&#34;</span><span>,</span> <span>&#34;Prev&#34;</span><span>,</span> <span>&#34;VolUp&#34;</span><span>,</span> <span>&#34;VolDown&#34;</span>
</span></span></code></pre></div><p>plus a ‚Äúload-and-play‚Äù command, which is <code>Load/</code> followed by a spotify URL (e.g. <code>spotify:track:4PTG3Z6ehGkBFwjybzWkR8</code>, you can retrieve Spotify URLs using <a href="https://community.spotify.com/t5/FAQs/Basics-of-a-Spotify-URL/ta-p/919201">these instructions</a>).</p><p>Each of these commands are just <em>strings</em>, so when I was testing it was perfectly sufficient (and <em>extremely</em> satisfying) to SSH into the Raspberry Pi and write:</p><div><pre tabindex="0"><code data-lang="sh"><span><span>$ telnet localhost <span>2227</span>
</span></span><span><span>PlayPause
</span></span><span><span>Next
</span></span><span><span>Next
</span></span><span><span>Prev
</span></span><span><span>VolUp
</span></span><span><span>VolUp
</span></span><span><span>VolUp
</span></span><span><span>VolUp
</span></span></code></pre></div><p>Every time I pressed <kbd>Enter</kbd>, I could hear the music respond to the command. Feels good! ‚ú®</p><h3 id="input-events">input-events</h3><p>I built a tiny program called <code>input-events</code>, which:</p><ul><li><p>Reads directly from the keyboard device (<code>/dev/voice-mini</code>) using the <a href="https://www.kernel.org/doc/html/v4.17/input/input_uapi.html">Linux input subsystem</a><sup id="fnref:4"><a href="#fn:4" role="doc-noteref">4</a></sup>,</p></li><li><p>Translates those keyboard events to one of the above protocol commands using a config file, and</p></li><li><p>Writes that command to <code>localhost:2777</code> (the ‚Äòremote control‚Äô port that I built into my librespot fork).</p></li></ul><p>The config file looks something like this (here‚Äôs the <a href="https://gist.github.com/capnfabs/4147ab6e30ca0602b0401cffbbedd060">full config</a>):</p><div><pre tabindex="0"><code data-lang="json"><span><span><span>{</span>
</span></span><span><span>  <span>&#34;Num1&#34;</span><span>:</span> <span>&#34;Prev&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;Num2&#34;</span><span>:</span> <span>&#34;PlayPause&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;Num3&#34;</span><span>:</span> <span>&#34;Next&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;Enter&#34;</span><span>:</span> <span>&#34;PlayPause&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;VolumeUp&#34;</span><span>:</span> <span>&#34;VolUp&#34;</span><span>,</span>
</span></span><span><span>  <span>&#34;VolumeDown&#34;</span><span>:</span> <span>&#34;VolDown&#34;</span><span>,</span>
</span></span><span><span>  <span>// CHILL
</span></span></span><span><span><span></span>  <span>&#34;Q&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>    <span>&#34;choose_one&#34;</span><span>:</span> <span>[</span>
</span></span><span><span>      <span>// The National: First two pages of Frankenstein
</span></span></span><span><span><span></span>      <span>&#34;Load/spotify:album:5Mc6uebYtKnRc5I7bjlNB6&#34;</span><span>,</span>
</span></span><span><span>      <span>// The Staves: Good Woman
</span></span></span><span><span><span></span>      <span>&#34;Load/spotify:album:66A7X1EqFQEEvuE5Nezqrl&#34;</span><span>,</span>
</span></span><span><span>      <span>// The Staves: If I was
</span></span></span><span><span><span></span>      <span>&#34;Load/spotify:album:2VxNr0ZeGhWJ8rQNe4d8vS&#34;</span><span>,</span>
</span></span><span><span>      <span>//...
</span></span></span><span><span><span></span>    <span>],</span>
</span></span><span><span>     <span>// FUN
</span></span></span><span><span><span></span>  <span>&#34;W&#34;</span><span>:</span> <span>{</span>
</span></span><span><span>    <span>&#34;choose_one&#34;</span><span>:</span> <span>[</span>
</span></span><span><span>      <span>// fun.
</span></span></span><span><span><span></span>      <span>&#34;Load/spotify:album:7m7F7SQ3BXvIpvOgjW51Gp&#34;</span><span>,</span>
</span></span><span><span>      <span>// ...
</span></span></span><span><span><span></span>    <span>],</span>
</span></span><span><span>    <span>// ...
</span></span></span><span><span><span></span>  <span>}</span>
</span></span></code></pre></div><p>And so (for example): pressing <kbd>1</kbd> will always run ‚ÄúPrev‚Äù, but pressing <kbd>Q</kbd> will choose and run one of the commands in that block randomly (and therefore, play one randomly selected ‚Äòchill album‚Äô).</p><p><code>input-events</code> is a separate program because when I built it, my <a href="https://capnfabs.net/posts/cross-compiling-rust-apps-raspberry-pi/">iteration time for changes to <code>librespot</code> was huge</a>. Decoupling made it much easier to iterate on the keyboard interaction, and that was the bit that I thought I‚Äôd have to prototype the most to get something which ‚Äòfeels right‚Äô.</p><p>This turned out to be a good idea ‚Äì I haven‚Äôt touched the <code>input-events</code> program since I wrote it two years ago, even as I‚Äôve had to recompile librespot to keep it up to date with whatever changes Spotify are making on their backend.</p><figure><video muted="" autoplay="" loop="" playsinline="" src="./input-events-early-testing.mp4" alt="Video showing command line responses to keyboard input" width="580"></video><figcaption><p>Testing an early version of the input-events program</p></figcaption></figure><h3 id="more-udev-rules-and-another-systemd-service">more udev rules and another systemd service</h3><p>I‚Äôve written about <a href="https://capnfabs.net/posts/udev-systemd-spotify-usb-audio/">udev before</a>, but it was much easier the second time around. The rules this time:</p><ul><li>Ensure that the Voice Mini bluetooth keyboard always shows up at the same spot (<code>/dev/voice-mini</code>)</li><li>Boot the <code>input-events</code> service when the device connects and shut it down again when the device disconnects.</li></ul><p>Here are the rules:</p><pre tabindex="0"><code>ACTION==&#34;add&#34;, KERNEL==&#34;event[0-9]*&#34;, SUBSYSTEM==&#34;input&#34;, ATTRS{name}==&#34;Voice Mini&#34;, SYMLINK+=&#34;voice-mini&#34;, RUN+=&#34;/usr/bin/su flopbox -c &#39;systemctl --user start input-events.service&#39;&#34;
ACTION==&#34;remove&#34;, ENV{DEVLINKS}==&#34;/dev/voice-mini&#34;, RUN+=&#34;/usr/bin/su flopbox -c &#39;systemctl --user stop input-events.service&#39;&#34;
</code></pre><p>The first rule basically says: when an input device named ‚ÄúVoice Mini‚Äù connects, make a symlink for it at <code>/dev/voice-mini</code> and boot the <code>input-events</code> service. The second rule says: when the device mapped to <code>/dev/voice-mini</code> is removed from the system, stop the <code>input-events</code> service.</p><h2 id="thats-it">That‚Äôs it!</h2><p>That‚Äôs it! I‚Äôm still <em>very pumped</em> about this contraption; I use it daily, and though it was a lot of work I‚Äôm glad I put the time in. My takeaways here are:</p><ul><li>Decoupling the pieces of this system was a <em>great</em> idea.</li><li>Low-level Linux input APIs were nowhere near as bad as I thought they‚Äôd be.</li><li>It‚Äôs pretty rewarding to build bespoke things for your own use like this ‚ú®.</li></ul></div></div>
  </body>
</html>
