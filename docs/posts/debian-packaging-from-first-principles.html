<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mikecoats.com/debian-packaging-first-principles-part-1-simple/">Original</a>
    <h1>Debian Packaging from First Principles</h1>
    
    <div id="readability-page-1" class="page"><div>
<p>I’ve used Debian as my distro of choice for well over a decade and whilst I’ve become familiar with “using” Debian I’ve never really understood how it worked under the hood. I understand that behind the scenes of <code>apt install</code> there’s a repository out on the internet somewhere, some packages are downloaded, and then their contents are installed, but how that happens is a bit of a black-box mystery to me.</p>



<figure><img fetchpriority="high" decoding="async" width="1024" height="767" src="https://mikecoats.com/wp-content/uploads/2024/07/IMG_0418-1024x767.jpeg" alt="A screenshot of a Makefile to build a simple deb package." srcset="https://mikecoats.com/wp-content/uploads/2024/07/IMG_0418-1024x767.jpeg 1024w, https://mikecoats.com/wp-content/uploads/2024/07/IMG_0418-300x225.jpeg 300w, https://mikecoats.com/wp-content/uploads/2024/07/IMG_0418-768x576.jpeg 768w, https://mikecoats.com/wp-content/uploads/2024/07/IMG_0418-1536x1151.jpeg 1536w, https://mikecoats.com/wp-content/uploads/2024/07/IMG_0418.jpeg 1584w" sizes="(max-width: 1024px) 100vw, 1024px"/></figure>



<p>In this first post in the series I aim to uncover what exactly is a <code>deb</code> file, what it contains and how one works. In subsequent posts I hope to better understand package-to-package dependencies, and eventually <code>apt</code> repositories. If you want to follow along with my code from this post and across all of the posts in this series, the files can be found in <a href="https://codeberg.org/MikeCoats/debian-packaging-first-principles/src/branch/main/simple" data-type="link" data-id="https://codeberg.org/MikeCoats/debian-packaging-first-principles/src/branch/main/simple">this directory</a> from within <a href="https://codeberg.org/MikeCoats/debian-packaging-first-principles" data-type="link" data-id="https://codeberg.org/MikeCoats/debian-packaging-first-principles">this git repository</a>.</p>



<h2>deb Format</h2>



<p>To begin with, I first consulted the <code>deb</code> format’s <code>man</code> page.</p>


<pre aria-describedby="shcb-language-2" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> man 5 deb</span>
<span>#</span><span> [...]</span>
The file is an ar archive with a magic value of !&lt;arch&gt;.
<span>#</span><span> [...]</span>
The first member is named debian-binary and contains a
series of lines, separated by newlines. Currently only
one line is present, the format version number, 2.0 at
the time this manual page was written.
<span>#</span><span> [...]</span>
The second required member is named control.tar.  It is
a tar archive containing the package control information
as a series of plain files, of which the file control is
mandatory
<span>#</span><span> [...]</span>
The third, last required member is named data.tar.  It
contains the filesystem as a tar archive
<span>#</span><span> [...]</span>
These members must occur in this exact order.
<span>#</span><span> [...]</span></code></span><small id="shcb-language-2"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<h2 id="ar-archive"><code>ar</code> Archive</h2>



<p>The first requirement from that man page is that a <code>deb</code> file is “an <code>ar</code> archive with a magic value of !&lt;arch&gt;.” I’m not familiar with the <code>ar</code> tool, so I’ve no idea if it’s special or difficult to set “!&lt;arch&gt;” as a magic value. To test <code>ar</code>‘s default behaviour, we can create an empty file, add it to a new <code>ar</code> archive, then inspect the archive’s content with a hex viewer such as <code>xxd</code>.</p>


<pre aria-describedby="shcb-language-3" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> touch empty</span>
<span>
$</span><span> ar r empty.ar empty</span>
ar: creating empty.ar
<span>
$</span><span> xxd -c 8 -g 1 empty.ar</span>
00000000: 21 3c 61 72 63 68 3e 0a  !&lt;arch&gt;.
00000008: 65 6d 70 74 79 2f 20 20  empty/
00000010: 20 20 20 20 20 20 20 20
00000018: 30 20 20 20 20 20 20 20  0
00000020: 20 20 20 20 30 20 20 20      0
00000028: 20 20 30 20 20 20 20 20    0
00000030: 36 34 34 20 20 20 20 20  644
00000038: 30 20 20 20 20 20 20 20  0
00000040: 20 20 60 0a</code></span><small id="shcb-language-3"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>From this output we can see that <code>ar</code> is using “!&lt;arch&gt;” by default, so we don’t need to take any special action here.</p>



<h2 id="debian-binary"><code>debian-binary</code></h2>



<p>Creating the first member of the archive, <code>debian-binary</code>, is as straightfoward as creating a plain text file with a single line containing “2.0”.</p>


<pre aria-describedby="shcb-language-4" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> vim debian-binary</span>
2.0</code></span><small id="shcb-language-4"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<h2 id="control-tar"><code>control.tar</code></h2>



<p>The archive’s second member, <code>control.tar</code>, needs to contain a <code>control</code> file as a bare minimum. Consulting the <code>deb-control</code> format’s <code>man</code> page reveals the format and contents of that file, including which fields are required.</p>


<pre aria-describedby="shcb-language-5" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> man 5 deb-control</span>
<span>#</span><span> [...]</span>
This file contains a number of fields.  Each field begins
with a tag, such as Package or Version (case insensitive),
followed by a colon, and the body of the field
<span>#</span><span> [...]</span>
FIELDS
<span>#</span><span> [...]</span>
       Package: package-name (required)
<span>#</span><span> [...]</span>
       Version: version-string (required)
<span>#</span><span> [...]</span>
       Architecture: arch|all (required)
<span>#</span><span> [...]</span></code></span><small id="shcb-language-5"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>It looks like we only need to provide three fields to get <code>dpkg</code> to accept our <code>deb</code> file, a name, the package’s version and the target architecture. Architecture’s the easiest here, we can just use “all” since we’re not actually bundling any platform-specific binaries. Version is straightforward too, we can just use a sensible “first” version such as 0.0.1 and accompany it with a “first” package number to build “0.0.1-1”. The name is to our own whims and since it’s the Simple example from my Debian Packaging from First Principles series, “dpfp-simple” is good enough.</p>


<pre aria-describedby="shcb-language-6" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> mkdir control</span>
<span>
$</span><span> vim control/control</span>
Package: dpfp-simple
Version: 0.0.1-1
Architecture: all</code></span><small id="shcb-language-6"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>With our <code>control</code> file in place, we can now bundle it in to the <code>control.tar</code> file which will be later added to the <code>deb</code>. You can probably get away without setting the user and group to root, but you might end up leaking your own username and group in the <code>tar</code> file without it.</p>


<pre aria-describedby="shcb-language-7" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> tar \</span>
    --create \
    --file control.tar \
    --owner=root \
    --group=root \
    --directory=control \
    control
<span>
$</span><span> tar \</span>
    --list \
    --verbose \
    --file control.tar
-rw-r--r-- root/root        54 2024-07-10 12:44 control</code></span><small id="shcb-language-7"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>We can see the <code>control.tar</code> file contains a single control file, matching the <code>man</code> pages’s specifications.</p>



<h2 id="data-tar"><code>data.tar</code></h2>



<p>The <code>data.tar</code> file needs to hold the package’s contents as they appear on the filesystem, so we should create a deep hierarchy of directories and place a simple text file within it.</p>


<pre aria-describedby="shcb-language-8" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> mkdir \</span>
    --parents \
    data/opt/debian-packaging-first-principles/simple
<span>
$</span><span> vim data/opt/debian-packaging-first-principles/simple/dpfp-simple-success.txt</span>
Debian Packaging from First Principles
    Simple
        Success!</code></span><small id="shcb-language-8"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>With our package’s filesystem laid out, we can bundle the success file and it’s directory hierarchy in to the <code>data.tar</code> we need to add to the deb. We follow the same process as we did for the <code>control.tar</code> earlier.</p>


<pre aria-describedby="shcb-language-9" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> tar \</span>
    --create \
    --file data.tar \
    --owner=root \
    --group=root \
    --directory=data \
    opt/
<span>
$</span><span> tar \</span>
    --list \
    --verbose \
    --file data.tar
drwxr-xr-x root/root         0 2024-07-10 14:45 opt/
drwxr-xr-x root/root         0 2024-07-10 14:45 opt/debian-packaging-first-principles/
drwxr-xr-x root/root         0 2024-07-10 14:48 opt/debian-packaging-first-principles/simple/
-rw-r--r-- root/root        67 2024-07-10 14:47 opt/debian-packaging-first-principles/simple/dpfp-simple-success.txt</code></span><small id="shcb-language-9"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>This time, we can see <code>tar</code>‘s created entries for the whole directory structure as well as the text file which will be installed by <code>dpkg</code>.</p>



<h2 id="our-package-deb"><code>our-package.deb</code></h2>



<p>Now we’ve created the three member files described by the first <code>man</code> page, we can use the <code>ar</code> command to bundle them together to build our final <code>deb</code> package.</p>


<pre aria-describedby="shcb-language-10" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> ar \</span>
    r dpfp-simple_0.0.1-1_all.deb \
    debian-binary \
    control.tar \
    data.tar
ar: creating dpfp-simple_0.0.1-1_all.deb
<span>
$</span><span> ar tv dpfp-simple_0.0.1-1_all.deb</span>
rw-r--r-- 0/0      4 Jan  1 01:00 1970 debian-binary
rw-r--r-- 0/0  10240 Jan  1 01:00 1970 control.tar
rw-r--r-- 0/0  10240 Jan  1 01:00 1970 data.tar</code></span><small id="shcb-language-10"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>Here the <code>ar</code> command has added the three member files to our <code>deb</code> file and they appear to be in the correct order, such that Debian should accept them for installation.</p>



<h2 id="installing-and-removing">Installing and Removing</h2>



<p>You can use either <code>apt</code> or <code>dpkg</code> to install a local <code>deb</code> file, but for simplicity’s sake, I’ll stick with <code>dpkg</code> for just now. Once the package has been installed, we should be able to find the included text file in the correct location within the filesystem.</p>


<pre aria-describedby="shcb-language-11" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> sudo dpkg --install dpfp-simple_0.0.1-1_all.deb</span>
dpkg: warning: parsing file &#39;/var/lib/dpkg/tmp.ci/control&#39;
near line 4 package &#39;dpfp-simple&#39;:
 missing &#39;Description&#39; field
dpkg: warning: parsing file &#39;/var/lib/dpkg/tmp.ci/control&#39;
near line 4 package &#39;dpfp-simple&#39;:
 missing &#39;Maintainer&#39; field
Selecting previously unselected package dpfp-simple.
(Reading database ... 136384 files and directories
currently installed.)
Preparing to unpack dpfp-simple_0.0.1-1_all.deb ...
Unpacking dpfp-simple (0.0.1-1) ...
Setting up dpfp-simple (0.0.1-1) ...
<span>
$</span><span> less /opt/debian-packaging-first-principles/simple/dpfp-simple-success.txt</span>
Debian Packaging from First Principles
    Simple
        Success!</code></span><small id="shcb-language-11"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>Interesting. It appears that whilst the <code>deb</code> man page only describes three fields as required, it will be quite loud about two other fields missing from the <code>control</code> file. Despite these warnings, the files are extracted correctly and can be viewed as we’d hoped. To remove our package again, we need to specify its name instead of the <code>deb</code> file.</p>


<pre aria-describedby="shcb-language-12" data-shcb-language-name="Shell Session" data-shcb-language-slug="shell"><span><code><span>$</span><span> sudo dpkg --remove dpfp-simple</span>
dpkg: warning: parsing file &#39;/var/lib/dpkg/status&#39; near
line 1939 package &#39;dpfp-simple&#39;:
 missing &#39;Description&#39; field
dpkg: warning: parsing file &#39;/var/lib/dpkg/status&#39; near
line 1939 package &#39;dpfp-simple&#39;:
 missing &#39;Maintainer&#39; field
(Reading database ... 136387 files and directories
currently installed.)
Removing dpfp-simple (0.0.1-1) ...
<span>
$</span><span> ls -al /opt</span>
total 12
drwxr-xr-x 1 root root 4096 Jul 10 16:09 .
drwxr-xr-x 1 root root 4096 Jan  1  2021 ..</code></span><small id="shcb-language-12"><span>Code language:</span> <span>Shell Session</span> <span>(</span><span>shell</span><span>)</span></small></pre>


<p>It appears that as part of whatever Debian does to store information about its installed packages, it copies the <code>control</code> file in to some central list and still complains about missing fields even as it’s removing the defective package.</p>



<h2 id="bug-fixing">Bug Fixing</h2>



<p>In order that we’re being well behaved citizens of the <code>deb</code> ecosystem, we should fix those warnings. We need to add the two missing fields to our <code>control</code> file, update our version number to indicate we’re on our second package version, and rebuild the <code>deb</code> following the earlier steps.</p>


<pre aria-describedby="shcb-language-13" data-shcb-language-name="Diff" data-shcb-language-slug="diff"><span><code>Package: dpfp-simple
<span>- Version: 0.0.1-1</span>
<span>+ Version: 0.0.1-2</span>
Architecture: all
<span>+ Description: A bare-minimum deb file, manually assembled to understand Debian packaging.</span>
<span>+ Maintainer: Mike Coats &lt;i.am@mikecoats.com&gt;</span></code></span><small id="shcb-language-13"><span>Code language:</span> <span>Diff</span> <span>(</span><span>diff</span><span>)</span></small></pre>


<p>With the changes from that <code>diff</code> in place, and a new <code>deb</code> file built, we can try installing and removing the package again to see if the warnings have been resolved.</p>


<pre><span><code>$ sudo dpkg --install ./dpfp-simple_0.0.1-2_all.deb
Selecting previously unselected package dpfp-simple.
(Reading database ... 137130 files and directories currently installed.)
Preparing to unpack ./dpfp-simple_0.0.1-2_all.deb ...
Unpacking dpfp-simple (0.0.1-2) ...
Setting up dpfp-simple (0.0.1-2) ...

$ sudo dpkg --remove dpfp-simple
(Reading database ... 137133 files and directories currently installed.)
Removing dpfp-simple (0.0.1-2) ...</code></span></pre>


<p>Bingo! No more warnings!</p>



<p>To simplify the repeated building of the deb and its member files, I wrapped up the process in <a href="https://codeberg.org/MikeCoats/debian-packaging-first-principles/src/branch/main/simple/Makefile" data-type="link" data-id="https://codeberg.org/MikeCoats/debian-packaging-first-principles/src/branch/main/simple/Makefile">a small, hand-rolled, Makefile</a>. My plan for the next few blog posts is to iterate on this project to understand more about <code>deb</code> files and <code>apt</code> tooling, first getting to grips with dependencies.</p>
</div></div>
  </body>
</html>
