<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/agsb/milliForth-6502">Original</a>
    <h1>MilliForth-6502: The smallest Forth real programming language for 6502</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><em>&#34;A Forth in 328 bytes â€” the smallest real programming
language ever, as of yet.&#34;</em></p>
<p dir="auto">The milliForth<sup><a href="#user-content-fn-1-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-1-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup> is a review of sectorForth<sup><a href="#user-content-fn-2-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-2-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup>,
and smaller than sector Lisp<sup><a href="#user-content-fn-3-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-3-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></p>
<p dir="auto">The miniForth<sup><a href="#user-content-fn-4-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-4-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup> is another Forth to use in a boot sector
of less than 512 bytes.</p>

<p dir="auto">Yes, bytes. But those are for a x86 16-bit CPU.
How minimal could be it for a classic 6502 8-bit CPU ?</p>
<p dir="auto">Two essentially different CPUs, a 16-bit x86 based on complex
registers and opcodes, and a 8-bit 6502 using page zero
as common registers and page one as hardware stack.</p>

<p dir="auto">The FIG-Forth (1980) for 6502 uses Indirect Thread Code (ITC)
as inner interpreter.</p>
<p dir="auto">The miniForth, sectorforth and milliForth use Direct Thread Code (DTC)</p>
<p dir="auto">This Forth for 6502, <del>will be</del> was done using two models:</p>
<div data-snippet-clipboard-copy-content="with classic Direct Thread Code (DTC) 
and
with Minimal Thread Code (MTC)"><pre><code>with classic Direct Thread Code (DTC) 
and
with Minimal Thread Code (MTC)
</code></pre></div>
<p dir="auto">(later we will compare both, <del>but DTC will win for less size</del>)</p>
<p dir="auto">This project is also used to verify standart Direct Thread Code against
variations of Minimum Thread Code.</p>
<p dir="auto"><a href="https://github.com/agsb/milliForth-6502/blob/main/The_words_in_MTC_Forth.en.pdf">Minimal Thread Code</a>
is an alternative model for inner interpreter, where
the dictionary is organized with the primitives words grouped together
before the compound words, defining a &#34;tipping point&#34;, from where could
decide if the reference of a word will be to executed or be pushed into
return stack. PS. MTC is a reduced form of <a href="https://sourceforge.net/projects/tachyon-forth/" rel="nofollow">TachyonForth</a> inner interpreter.</p>

<p dir="auto">Focus in size not performance.</p>
<p dir="auto">The compilation wqas done with <a href="https://github.com/cc65/cc65">ca65</a> V2.19 - Git 7979f8a41.</p>
<p dir="auto">The emulation of 6502 CPU was done with <a href="https://github.com/ShonFrazier/lib6502">run6502</a></p>
<p dir="auto">The way at 6502 is use a page zero and lots of lda/sta bytes.</p>
<p dir="auto">Both DTC and MTC runs with my_hello_world.FORTH, with these numbers.</p>
<div data-snippet-clipboard-copy-content="MTC, Instructions: 35796948, Cycles: 148802145, SIZE: 582

DTC, Instructions: 35211469, Cycles: 148450585, SIZE: 596

compiling my_hello_world.FORTH, overhead MTC / DTC

Instructions:    1.66% 

Cycles:          0.24%"><pre><code>MTC, Instructions: 35796948, Cycles: 148802145, SIZE: 582

DTC, Instructions: 35211469, Cycles: 148450585, SIZE: 596

compiling my_hello_world.FORTH, overhead MTC / DTC

Instructions:    1.66% 

Cycles:          0.24%
</code></pre></div>
<p dir="auto">(*) Thanks to wise changes from <a href="https://github.com/peterferrie">peterferrie</a> !</p>

<ul dir="auto">
<li>
<p dir="auto">as Forth-1994<sup><a href="#user-content-fn-5-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-5-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup>: FALSE is $0000 and TRUE is $FFFF ;</p>
</li>
<li>
<p dir="auto">all tib (80 bytes), pic (16 cells), data (36 cells) and
return (36 cells) stacks are in page $200 ;</p>
</li>
<li>
<p dir="auto">tib and pic grows forward, stacks grows backwards ;</p>
</li>
<li>
<p dir="auto">only immediate flag used as $80, no more flags ;</p>
</li>
<li>
<p dir="auto">no line editor, no backspace, no cancel line, no low ASCII verify ;</p>
</li>
<li>
<p dir="auto">no stacks overflow or underflow checks ;</p>
</li>
</ul>

<ul dir="auto">
<li>6502 is a byte processor, no need &#39;pad&#39; at end of even names ;</li>
<li>hardware stack (page $100) not used as forth stack, free for use ;</li>
<li>uses 32 bytes of <em>page zero</em> ;</li>
<li>no multiuser, no multitask, no faster ;</li>
<li>only update <em>latest</em> at end of word definition ;</li>
<li>redefine a word does not change previous uses ;</li>
<li>stacks moves like the hardware stack ;</li>
<li>words must be between spaces, before and after ever ;</li>
<li>better use 7-bit ASCII characters ;</li>
<li>approuch as ANSI X3.215-1994<sup><a href="#user-content-fn-5-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-5-2-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup></li>
</ul>

<p dir="auto">Look up at Notes<sup><a href="#user-content-fn-6-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-6-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">6</a></sup> for more.</p>
<p dir="auto">24/08/2024
merge of dtc and mtc code into a flagged sector-6502.s file</p>
<p dir="auto">16/08/2024:
both models DTC and MTC, works with my_hello_world.FORTH;</p>
<p dir="auto">11/08/2024:
return to direct thread code;</p>
<p dir="auto">11/06/2024:
adapt for minimal thread indirect code;</p>
<p dir="auto">24/01/2024:
write using standart direct thread code;</p>
<p dir="auto">14/11/2023
code for 6502 sized to 624 bytes,
no ascii-7, no key, no emit, no 2/, many errors</p>

<p dir="auto">This version includes:</p>
<div data-snippet-clipboard-copy-content="primitives:
    s@    return the address of user structure
    +     adds two values at top of data stack
    nand  logic not and the two values at top of data stack
    @     fetch a value of cell wich address at top of data stack
    !     store a value into a cell wich address at top of data stack
    0#    test if top of data stack is not zero

    :     starts compilng a new word
    ;     stops compiling a new word
    exit  ends a word

    key   get a char from default terminal (system dependent)
    emit  put a char into default terminal (system dependent)
        
internals: 
    spush, spull, rpull, rpush, (stack code)
    copyfrom, copyinto, (heap code)
    incr, decr, add, etc (register mimics)
    cold, warm, quit, token, skip, scan, getline, (boot and terminal)
    parse, find, compile, execute, (outer interpreter)

    unnest, next, nest, (dtc inner) 
    unnest, next, nest, pick, jump, (mtc inner)

    ps. next is not the FOR NEXT loop    

externals:
    getch, putch, byes (depends on system, used minimal for emulator )

extensions: (selectable)
    2/      shift right one bit
    exec    jump to address at top of spt
    :$      jump to (ipt)   
    ;$      jump to next 

extras:    (selectable)
    bye     ends the Forth, return to system
    abort   restart the Forth
    .S      list cells in data stack
    .R      list cells in return stack
    .       show cell at top of data stack
    words   extended list the words in dictionary
    dump    list contents of dictionary in binary

A my_hello_world.FORTH alternate version with dictionary for use;

The sp@ and rp@ are now derived from s@ in the my_hello_world.FORTH
"><pre><code>primitives:
    s@    return the address of user structure
    +     adds two values at top of data stack
    nand  logic not and the two values at top of data stack
    @     fetch a value of cell wich address at top of data stack
    !     store a value into a cell wich address at top of data stack
    0#    test if top of data stack is not zero

    :     starts compilng a new word
    ;     stops compiling a new word
    exit  ends a word

    key   get a char from default terminal (system dependent)
    emit  put a char into default terminal (system dependent)
        
internals: 
    spush, spull, rpull, rpush, (stack code)
    copyfrom, copyinto, (heap code)
    incr, decr, add, etc (register mimics)
    cold, warm, quit, token, skip, scan, getline, (boot and terminal)
    parse, find, compile, execute, (outer interpreter)

    unnest, next, nest, (dtc inner) 
    unnest, next, nest, pick, jump, (mtc inner)

    ps. next is not the FOR NEXT loop    

externals:
    getch, putch, byes (depends on system, used minimal for emulator )

extensions: (selectable)
    2/      shift right one bit
    exec    jump to address at top of spt
    :$      jump to (ipt)   
    ;$      jump to next 

extras:    (selectable)
    bye     ends the Forth, return to system
    abort   restart the Forth
    .S      list cells in data stack
    .R      list cells in return stack
    .       show cell at top of data stack
    words   extended list the words in dictionary
    dump    list contents of dictionary in binary

A my_hello_world.FORTH alternate version with dictionary for use;

The sp@ and rp@ are now derived from s@ in the my_hello_world.FORTH

</code></pre></div>

<div data-snippet-clipboard-copy-content="    $000    page zero       ; cpu reserved
    $100    hardware stack  ; cpu reserved
    $200    TIB             ; terminal input buffer, 80 bytes
    $298*   data stack      ; data stack, 36 cells, backwards
    $2E0*   return stack    ; return stack, 36 cells, backwards
    $2E0    PIC             ; reserved for scratch, 16 cells
    $300    _main_          ; start of Forth
    $???    _ends_          ; end of code and primitives of Forth
    $???    _init_          ; start of compound dictionary

    _init_ is the page (MSB) of _ends_ + 1
"><pre><code>    $000    page zero       ; cpu reserved
    $100    hardware stack  ; cpu reserved
    $200    TIB             ; terminal input buffer, 80 bytes
    $298*   data stack      ; data stack, 36 cells, backwards
    $2E0*   return stack    ; return stack, 36 cells, backwards
    $2E0    PIC             ; reserved for scratch, 16 cells
    $300    _main_          ; start of Forth
    $???    _ends_          ; end of code and primitives of Forth
    $???    _init_          ; start of compound dictionary

    _init_ is the page (MSB) of _ends_ + 1

</code></pre></div>

<p dir="auto">&#34; When heap moves forward, move the stack backward &#34;</p>
<p dir="auto">Push is &#39;store and decrease&#39;. Pull is &#39;increas and fetch&#39;.</p>
<p dir="auto">A common memory model organization of Forth:</p>
<div data-snippet-clipboard-copy-content="   tib-&gt;...&lt;-spt, user forth dictionary, here-&gt;pad...&lt;-rpt,"><pre><code>   tib-&gt;...&lt;-spt, user forth dictionary, here-&gt;pad...&lt;-rpt,
</code></pre></div>
<p dir="auto">then backward stacks allow to use the slack space ...</p>
<p dir="auto">This 6502 Forth memory model is blocked in pages of 256 bytes:</p>
<div data-snippet-clipboard-copy-content="   page0, page1, page2, core ... forth dictionary ...here..."><pre><code>   page0, page1, page2, core ... forth dictionary ...here...
</code></pre></div>
<p dir="auto">at page2, without &#39;rush over&#39;</p>
<div data-snippet-clipboard-copy-content="   |tib 40 cells&gt; &lt;spt 36 cells| &lt;rpt 36 cells|pic 16 cells&gt; | ."><pre><code>   |tib 40 cells&gt; &lt;spt 36 cells| &lt;rpt 36 cells|pic 16 cells&gt; | .
</code></pre></div>

<p dir="auto"><em>&#34;SectorFORTH was an extensive guide throughout the process of
implementing milliFORTH, and milliFORTH&#39;s design actually converged
on sectorFORTH unintentionally in a few areas. That said, the language
implemented is intentionally very similar, being the &#39;minimal FORTH&#39;.&#34;</em></p>
<p dir="auto">For Forth language primer see
<a href="https://www.forth.com/starting-forth/" rel="nofollow">Starting Forth</a></p>
<p dir="auto">For Forth from inside howto see
<a href="http://git.annexia.org/?p=jonesforth.git;a=blob_plain;f=jonesforth.S;hb=refs/heads/master" rel="nofollow">JonasForth</a></p>

<p dir="auto"><em>** 16/08/2024 DTC and MTC models operational, using lib6502 for emulation and tests **</em></p>
<p dir="auto">A crude small script for compile with ca65 is included.</p>
<div data-snippet-clipboard-copy-content="; for make it
sh mk a sector-6502

; for clear it
sh mk x sector-6502"><pre><code>; for make it
sh mk a sector-6502

; for clear it
sh mk x sector-6502
</code></pre></div>
<p dir="auto">the size is take from main: to ends: using the sector-6502.lbl file</p>

<p dir="auto">the originals files are edited for lines with less than 80 bytes</p>
<p dir="auto">the bf.FORTH and hello_world.FORTH are from original milliForth<sup><a href="#user-content-fn-1-f9cda6eb73d2d5f446eb8830ca59bcac" id="user-content-fnref-1-2-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></p>
<p dir="auto">the my_hello_world.FORTH is adapted for miiliforth-6502</p>

<section data-footnotes="">
<ol dir="auto">
<li id="user-content-fn-1-f9cda6eb73d2d5f446eb8830ca59bcac">
<p dir="auto">The original milliForth: <a href="https://github.com/fuzzballcat/milliForth">https://github.com/fuzzballcat/milliForth</a> <a href="#user-content-fnref-1-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 1">â†©</a> <a href="#user-content-fnref-1-2-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 1-2">â†©<sup>2</sup></a></p>
</li>
<li id="user-content-fn-2-f9cda6eb73d2d5f446eb8830ca59bcac">
<p dir="auto">The inspirational sectorForth: <a href="https://github.com/cesarblum/sectorforth/">https://github.com/cesarblum/sectorforth/</a> <a href="#user-content-fnref-2-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 2">â†©</a></p>
</li>
<li id="user-content-fn-3-f9cda6eb73d2d5f446eb8830ca59bcac">
<p dir="auto">Mind-blowing sectorLISP: <a href="https://justine.lol/sectorlisp2/">https://justine.lol/sectorlisp2/</a>, <a href="https://github.com/jart/sectorlisp">https://github.com/jart/sectorlisp</a> <a href="#user-content-fnref-3-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 3">â†©</a></p>
</li>
<li id="user-content-fn-4-f9cda6eb73d2d5f446eb8830ca59bcac">
<p dir="auto">The miniforth: <a href="https://github.com/meithecatte/miniforth">https://github.com/meithecatte/miniforth</a> <a href="#user-content-fnref-4-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 4">â†©</a></p>
</li>
<li id="user-content-fn-5-f9cda6eb73d2d5f446eb8830ca59bcac">
<p dir="auto">Forth standart ANSI X3.215-1994: <a href="http://www.forth.org/svfig/Win32Forth/DPANS94.txt">http://www.forth.org/svfig/Win32Forth/DPANS94.txt</a> <a href="#user-content-fnref-5-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 5">â†©</a> <a href="#user-content-fnref-5-2-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 5-2">â†©<sup>2</sup></a></p>
</li>
<li id="user-content-fn-6-f9cda6eb73d2d5f446eb8830ca59bcac">
<p dir="auto">Notes and Times: <a href="https://github.com/agsb/milliForth-6502/blob/main/Notes.md">https://github.com/agsb/milliForth-6502/blob/main/Notes.md</a> <a href="#user-content-fnref-6-f9cda6eb73d2d5f446eb8830ca59bcac" data-footnote-backref="" aria-label="Back to reference 6">â†©</a></p>
</li>
</ol>
</section>
</article></div></div>
  </body>
</html>
