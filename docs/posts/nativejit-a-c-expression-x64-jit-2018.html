<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/BitFunnel/NativeJIT">Original</a>
    <h1>NativeJIT: A C&#43;&#43; expression â€“&gt; x64 JIT (2018)</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><a href="https://ci.appveyor.com/project/MichaelHopcroft/nativejit" rel="nofollow"><img src="https://camo.githubusercontent.com/557b8cb55763b7b68fd5d408625815454e11fb4404e11f2318d49c9bdc7fbf61/68747470733a2f2f63692e6170707665796f722e636f6d2f6170692f70726f6a656374732f7374617475732f6f39353762343472686d3876743234672f6272616e63682f6d61737465723f7376673d74727565" alt="Build status" data-canonical-src="https://ci.appveyor.com/api/projects/status/o957b44rhm8vt24g/branch/master?svg=true"/></a>
<a href="https://doozer.io/user/mikehopcroft/NativeJIT/builds" rel="nofollow"><img src="https://camo.githubusercontent.com/9bc1e898ece6a162fa20600c1f13e4065884177e8be1a6a7cc726bde61748258/68747470733a2f2f646f6f7a65722e696f2f62616467652f6d696b65686f7063726f66742f4e61746976654a49542f6275696c647374617475732f6d6173746572" alt="Build status" data-canonical-src="https://doozer.io/badge/mikehopcroft/NativeJIT/buildstatus/master"/></a></p>

<p dir="auto">NativeJIT is an open-source cross-platform library for high-performance
just-in-time compilation of expressions involving C data structures.
The compiler is light weight and fast
and it takes no dependencies beyond the standard C++ runtime.
It runs on Linux, OSX, and Windows.
The generated code is optimized with particular attention paid
to register allocation.</p>
<p dir="auto">The compiler was developed by the <a href="http://www.bing.com/" rel="nofollow">Bing</a> team for use in the Bing search engine.
One important use is scoring documents containing keywords that match a user&#39;s query.
The scoring process attempts to gauge how well each document matches the user&#39;s intent,
and as such, depends on the specifics of how each query was phrased.
Bing formulates a custom expression for each query
and then uses NativeJIT to compile the expression into x64 code that will
be run on a large set of candidate documents spread across a cluster of
machines.</p>
<p dir="auto">We knew from the get go that throughput and latency
would be essential when processing queries at scale,
so we put a lot of effort in to making NativeJIT run fast.</p>
<p dir="auto">Our design point was scenarios where</p>
<ul dir="auto">
<li>The expression isn&#39;t known until runtime.</li>
<li>The expression will be evaluated enough times to amortize the cost of compilation.</li>
<li>Latency and throughput demands require low cost for compilation.</li>
</ul>
<p dir="auto">Here&#39;s trivial &#34;Hello, world&#34; level example that computes the area of a circle:</p>
<div dir="auto" data-snippet-clipboard-copy-content="#include &#34;NativeJIT/CodeGen/ExecutionBuffer.h&#34;
#include &#34;NativeJIT/CodeGen/FunctionBuffer.h&#34;
#include &#34;NativeJIT/Function.h&#34;
#include &#34;Temporary/Allocator.h&#34;

#include &lt;iostream&gt;

using NativeJIT::Allocator;
using NativeJIT::ExecutionBuffer;
using NativeJIT::Function;
using NativeJIT::FunctionBuffer;

int main()
{
    // Create allocator and buffers for pre-compiled and post-compiled code.
    ExecutionBuffer codeAllocator(8192);
    Allocator allocator(8192);
    FunctionBuffer code(codeAllocator, 8192);

    // Create the factory for expression nodes.
    // Our area expression will take a single float parameter and return a float.
    Function&lt;float, float&gt; expression(allocator, code);

    // Multiply input parameter by itself to get radius squared.
    auto &amp; rsquared = expression.Mul(expression.GetP1(), expression.GetP1());

    // Multiply by PI.
    const float  PI = 3.14159265358979f;
    auto &amp; area = expression.Mul(rsquared, expression.Immediate(PI));

    // Compile expression into a function.
    auto function = expression.Compile(area);

    // Now run our expression!
    float radius = 2.0;
    std::cout &lt;&lt; &#34;The area of a circle with radius &#34; &lt;&lt; radius
              &lt;&lt; &#34; is &#34; &lt;&lt; function(radius);

    return 0;
}"><pre>#<span>include</span> <span><span>&#34;</span>NativeJIT/CodeGen/ExecutionBuffer.h<span>&#34;</span></span>
#<span>include</span> <span><span>&#34;</span>NativeJIT/CodeGen/FunctionBuffer.h<span>&#34;</span></span>
#<span>include</span> <span><span>&#34;</span>NativeJIT/Function.h<span>&#34;</span></span>
#<span>include</span> <span><span>&#34;</span>Temporary/Allocator.h<span>&#34;</span></span>

#<span>include</span> <span><span>&lt;</span>iostream<span>&gt;</span></span>

<span>using</span> NativeJIT::Allocator;
<span>using</span> NativeJIT::ExecutionBuffer;
<span>using</span> NativeJIT::Function;
<span>using</span> NativeJIT::FunctionBuffer;

<span>int</span> <span>main</span>()
{
    <span><span>//</span> Create allocator and buffers for pre-compiled and post-compiled code.</span>
    ExecutionBuffer <span>codeAllocator</span>(<span>8192</span>);
    Allocator <span>allocator</span>(<span>8192</span>);
    FunctionBuffer <span>code</span>(codeAllocator, <span>8192</span>);

    <span><span>//</span> Create the factory for expression nodes.</span>
    <span><span>//</span> Our area expression will take a single float parameter and return a float.</span>
    Function&lt;<span>float</span>, <span>float</span>&gt; <span>expression</span>(allocator, code);

    <span><span>//</span> Multiply input parameter by itself to get radius squared.</span>
    <span>auto</span> &amp; rsquared = expression.<span>Mul</span>(expression.<span>GetP1</span>(), expression.<span>GetP1</span>());

    <span><span>//</span> Multiply by PI.</span>
    <span>const</span> <span>float</span>  PI = <span>3</span>.<span>14159265358979f</span>;
    <span>auto</span> &amp; area = expression.<span>Mul</span>(rsquared, expression.<span>Immediate</span>(PI));

    <span><span>//</span> Compile expression into a function.</span>
    <span>auto</span> function = expression.<span>Compile</span>(area);

    <span><span>//</span> Now run our expression!</span>
    <span>float</span> radius = <span>2.0</span>;
    std::cout &lt;&lt; <span><span>&#34;</span>The area of a circle with radius <span>&#34;</span></span> &lt;&lt; radius
              &lt;&lt; <span><span>&#34;</span> is <span>&#34;</span></span> &lt;&lt; <span>function</span>(radius);

    <span>return</span> <span>0</span>;
}</pre></div>
<p dir="auto">Here is the generated assembly code on Windows:</p>
<div dir="auto" data-snippet-clipboard-copy-content="PI_CONSTANT:
   db 0f 49 40                              ; PI constant is stored in memory.
ENTRY_POINT:
  sub         rsp,8                         ; Standard function prologue.
  mov         qword ptr [rsp],rbp           ; Standard function prologue.
  lea         rbp,[rsp+8]                   ; Standard function prologue.
  mulss       xmm0,xmm0                     ; Multiply by radius parameter by itself.
  mulss       xmm0,dword ptr [29E2A580000h] ; Multiply by PI.
  mov         rbp,qword ptr [rsp]           ; Standard function epilogue.
  add         rsp,8                         ; Standard function epilogue."><pre><span>PI_CONSTANT:</span>
<span>   </span><span>db</span><span> 0f </span><span>49</span><span> </span><span>40</span><span>                              ; PI constant is stored in memory.</span>
<span>ENTRY_POINT:</span>
<span>  </span><span>sub</span><span>         </span><span>rsp</span><span>,</span><span>8</span><span>                         ; Standard function prologue.</span>
<span>  </span><span>mov</span><span>         qword ptr </span><span>[</span><span>rsp</span><span>],</span><span>rbp</span><span>           ; Standard function prologue.</span>
<span>  </span><span>lea</span><span>         </span><span>rbp</span><span>,[</span><span>rsp</span><span>+</span><span>8</span><span>]</span><span>                   ; Standard function prologue.</span>
<span>  </span><span>mulss</span><span>       </span><span>xmm0</span><span>,</span><span>xmm0</span><span>                     ; Multiply by radius parameter by itself.</span>
<span>  </span><span>mulss</span><span>       </span><span>xmm0</span><span>,</span><span>dword ptr </span><span>[</span><span>29E2A580000h</span><span>]</span><span> ; Multiply by PI.</span>
<span>  </span><span>mov</span><span>         </span><span>rbp</span><span>,</span><span>qword ptr </span><span>[</span><span>rsp</span><span>]</span><span>           ; Standard function epilogue.</span>
<span>  </span><span>add</span><span>         </span><span>rsp</span><span>,</span><span>8</span><span>                         ; Standard function epilogue.</span></pre></div>
<p dir="auto">This example shows an expression that multiplies a number by itself.
We also support a wide variety of arithmetic and logical operations, pointer and array operations, conditionals, accessing structure fields, and calling out to C functions.
<a href="http://bitfunnel.org/getting-started-with-nativejit/" rel="nofollow">See our preliminary API docs for more information</a> and the <code>Examples/</code> directory for more examples.</p>

<p dir="auto">In order to build NativeJIT you will need CMake (2.8.11+), and a modern C++
compiler (gcc 5+, clang 3.4+, or VC 2015+). You can run CMake directly to generate the appropriate build setup for your platform. Alternately, we have some scripts that have the defaults that we use available.</p>

<p dir="auto">For *nix platforms (including OS X),</p>
<div dir="auto" data-snippet-clipboard-copy-content="./Configure_Make.sh
cd build-make
make
make test"><pre>./Configure_Make.sh
<span>cd</span> build-make
make
make <span>test</span></pre></div>

<p dir="auto">If you&#39;re on Ubuntu 15+, you can install dependencies with:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt-get install clang cmake"><pre>sudo apt-get install clang cmake</pre></div>
<p dir="auto">On Ubuntu 14 and below, you&#39;ll need to install a newer version of CMake. To
install a new-enough CMake, see <a href="http://askubuntu.com/questions/610291/how-to-install-cmake-3-2-on-ubuntu-14-04" rel="nofollow">this link</a>.
If you&#39;re using gcc, you&#39;ll also need to make sure you have gcc-5 (<code>sudo apt-get install g++-5</code>).</p>
<p dir="auto">To override the default compiler, set the <code>CXX</code> and <code>CC</code> environment variables.
For example, if you have clang-3.8 installed as <code>clang-3.8</code> and are using bash:</p>
<div dir="auto" data-snippet-clipboard-copy-content="export CXX=&#34;clang++-3.8&#34;
export CC=&#34;clang-3.8&#34;"><pre><span>export</span> CXX=<span><span>&#34;</span>clang++-3.8<span>&#34;</span></span>
<span>export</span> CC=<span><span>&#34;</span>clang-3.8<span>&#34;</span></span></pre></div>

<p dir="auto">Install XCode and then run the following command to install required packages
using Homebrew (<a href="http://brew.sh/" rel="nofollow">http://brew.sh/</a>):</p>

<p dir="auto">NativeJIT can be built on OS X using either standard *nix makefiles or XCode.
In order to generate and build makefiles, in the root <code>NativeJIT</code> directory run:</p>
<p dir="auto">If you want to create an Xcode project instead of using Makefiles, run:</p>


<p dir="auto">Install the following tools:</p>
<ul dir="auto">
<li>Visual Studio 2015 with C++ compiler</li>
<li>CMake (<a href="http://www.cmake.org/download/" rel="nofollow">http://www.cmake.org/download/</a>)</li>
</ul>
<p dir="auto">You can get <a href="https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx" rel="nofollow">the free version of Visual Studio here</a>.
Note that if you&#39;re installing Visual Studio for the first time and select the
default install options, you won&#39;t get a C++ compiler. To force the install of
the C++ compiler, you need to either create a new C++ project or open an
existing C++ project.</p>
<p dir="auto">In order to configure solution for Visual Studio 2015 run the following
commands from the root <code>NativeJIT</code> directory:</p>

<p dir="auto">From now on you can use the generated solution <code>build-msvc\NativeJIT.sln</code> from Visual Studio
or build from command line using <code>cmake</code>.</p>
</article></div></div>
  </body>
</html>
