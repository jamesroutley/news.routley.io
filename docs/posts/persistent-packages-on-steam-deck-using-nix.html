<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://chrastecky.dev/gaming/persistent-packages-on-steam-deck-using-nix">Original</a>
    <h1>Persistent packages on Steam Deck using Nix</h1>
    
    <div id="readability-page-1" class="page"><p _ngcontent-ng-c3018183921="">The Steam Deck (and SteamOS) delivers a fantastic console-like experience on a Linux system. However, its immutable filesystem means that installing packages that persist across system upgrades isn’t straightforward. Fortunately, with a little Nix magic, you can work around that limitation.</p><div _ngcontent-ng-c3018183921=""><p>Immutable systems offer many benefits—until you need to customize your filesystem by installing packages. While installing software isn’t difficult per se, SteamOS’s design means that most customizations are wiped during system upgrades. About a year ago, Valve added <code>/nix</code> to the list of directories that remain intact during updates, and that’s where Nix stores all of its packages.</p>

<blockquote>
<p>If you’re not familiar with Nix: it’s a package manager that uses declarative definitions for your software instead of commands like <code>apt install</code> or <code>dnf install</code>. You simply list all your desired packages in a configuration file, and Nix takes care of installing them. Additionally, the handy <code>nix-shell</code> utility lets you spawn temporary shells with the packages you specify.</p>
</blockquote>

<p>There are two primary ways to work with Nix comfortably: you can either run <a href="https://nixos.org/" rel="noopener noreferrer" target="_blank">NixOS</a> (which isn’t ideal on a Steam Deck) or use <a href="https://nix-community.github.io/home-manager/" rel="noopener noreferrer" target="_blank">Home Manager</a>.</p>

<h2>Installing Nix</h2>

<p>Switch to Desktop Mode and open Konsole for the following steps. First, install Nix itself using this command (see the <a href="https://nixos.org/download/" rel="noopener noreferrer" target="_blank">official installation instructions</a>):</p>

<p><code>sh &lt;(curl -L https://nixos.org/nix/install) --no-daemon</code></p>

<p>This command installs Nix in single-user mode (<code>--no-daemon</code>), which is a good fit for SteamOS since it may not require <code>sudo</code> for most operations. (If it does ask for sudo, you’ll need to <a href="https://www.gamingonlinux.com/guides/view/how-to-set-change-and-reset-your-steamos-steam-deck-desktop-sudo-password/" rel="noopener noreferrer" target="_blank">set up sudo on your Steam Deck</a>.)</p>

<p>Next, load Nix into your current terminal session:</p>

<p><code>source .bash_profile</code></p>

<p>By default, Nix uses the unstable branch of packages. To switch to the stable channel, run:</p>

<p><code>nix-channel --add https://nixos.org/channels/nixos-24.11 nixpkgs</code></p>

<p>This command sets your <code>nixpkgs</code> channel to the latest stable version (in this example, 24.11). In the future, check the current stable version on the <a href="https://nixos.org/" rel="noopener noreferrer" target="_blank">NixOS homepage</a>.</p>

<p>Nix is now installed—but without Home Manager, it isn’t very user-friendly.</p>

<h2>Installing Home Manager</h2>

<p>First, add the Home Manager channel to your Nix configuration:</p>

<p><code>nix-channel --add https://github.com/nix-community/home-manager/archive/release-24.11.tar.gz home-manager</code></p>

<p><strong>Note:</strong> Ensure that the version for both Nix and Home Manager match. In this example, both are 24.11.</p>

<blockquote>
<p>If you prefer the unstable branch, you can instead run: <code>nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager</code></p>
</blockquote>

<p>Update your channels to include these changes:</p>

<p><code>nix-channel --update</code></p>

<p>Before proceeding, back up your Bash configuration files:</p>

<ul>
	<li><code>mv .bash_profile .bash_profile.bckp</code></li>
	<li><code>mv .bashrc .bashrc.bckp</code></li>
</ul>

<blockquote>
<p>If you choose not to back them up, you’ll need to remove them because Home Manager creates these files during installation and will fail if they already exist.</p>
</blockquote>

<p>Now, run the Home Manager installation:</p>

<p><code>nix-shell &#39;&lt;home-manager&gt;&#39; -A install</code></p>

<p>Once the installation completes, create your Home Manager configuration file using a text editor:</p>

<p><code>kate ~/.config/home-manager/home.nix</code></p>

<p>Paste in the following configuration:</p>

<pre><code>{ config, pkgs, ... }:
{
  home.username = &#34;deck&#34;;
  home.homeDirectory = &#34;/home/deck&#34;;

  programs.bash = {
    enable = true;
    initExtra = &#39;&#39;
      if [ -e $HOME/.nix-profile/etc/profile.d/nix.sh ]; then . $HOME/.nix-profile/etc/profile.d/nix.sh; fi

      export NIX_SHELL_PRESERVE_PROMPT=1
      if [[ -n &#34;$IN_NIX_SHELL&#34; ]]; then
        export PS1=&#34;$PS1(nix-shell) &#34;
      fi
    &#39;&#39;;
  };

  home.stateVersion = &#34;24.11&#34;; # don&#39;t change this even if you upgrade your channel in the future, this should stay the same as the version you first installed nix on

  home.packages = with pkgs; [
    
  ];

  programs.home-manager.enable = true;
}</code></pre>

<p>This configuration does the following:</p>

<ul>
	<li>Sets your username to <strong>deck</strong> (the default on Steam Deck).</li>
	<li>Specifies the correct path to your home directory.</li>
	<li>Enables Home Manager to manage your Bash shell and ensures the Nix environment is loaded automatically—so you won’t have to source it manually each time.</li>
	<li>Adds a <code>(nix-shell)</code> suffix to your terminal prompt when you’re in a Nix shell, which is a subtle but useful improvement over the default behavior.</li>
	<li>Defines the <code>home.stateVersion</code>, which should remain the same as when you first installed Nix (even if you later change your channels). <strong>You should never change it after the initial Nix installation</strong></li>
	<li>Enables Home Manager itself.</li>
	<li>Provides an empty list (<code>home.packages</code>) where you can later add your desired packages.</li>
</ul>

<p>Apply your new configuration by running:</p>

<p><code>home-manager switch</code></p>

<p>This is the basic workflow for managing your environment with Nix: update your configuration file and then run <code>home-manager switch</code> to apply the changes.</p>

<p>After closing and reopening your terminal, test the setup by running <code>nix-shell</code>. If you see an error indicating that <code>default.nix</code> is missing, everything is working as expected. (If the command isn’t found at all, something went wrong.)</p>

<h2>Installing packages</h2>

<p>To install packages, simply add them to the <code>home.packages</code> list in your configuration file. For example, to install <code>nmap</code> (for network scanning) and <code>cowsay</code> (because a cow makes everything better), update your configuration as follows:</p>

<pre><code>  home.packages = with pkgs; [
      nmap
      cowsay
  ];</code></pre>

<p>Keep the rest of the file unchanged, then apply the new configuration with <code>home-manager switch</code>. You can test the setup by running:</p>

<p><code>echo &#34;Hello from my Steam Deck!&#34; | cowsay</code></p>

<p>You should see this beauty in your terminal:</p>

<pre><code> ___________________________ 
&lt; Hello from my Steam Deck! &gt;
 --------------------------- 
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre>

<p>Running <code>nmap</code> should display its usage instructions. If you decide to remove <code>nmap</code> (you&#39;re keeping <code>cowsay</code>, right?), just delete it from the configuration file and run <code>home-manager switch</code> again.</p>

<h2>Tips</h2>

<ul>
	<li>Create a desktop shortcut to your configuration file:
	<ul>
		<li><code>ln -s ~/.config/home-manager/home.nix ~/Desktop/Nix_Config</code></li>
	</ul>
	</li>
	<li>Run <code>nix-collect-garbage</code> periodically to remove unused packages and free up space.</li>
	<li>Install the <code>comma</code> package. This nifty tool lets you run any package on the fly by simply prefixing the command with a comma.
	<ul>
		<li>For example, instead of adding <code>nmap</code> to your configuration, you could run <code>, nmap</code> to temporarily use it. (notice the comma in front of nmap)</li>
	</ul>
	</li>
	<li>Nix can do much more than just manage packages—for instance, you can use it to create environment variables, shell aliases, systemd services, files, and more.</li>
</ul>

<p><small>Cover image sources: <a href="https://commons.wikimedia.org/wiki/File:Steam_Deck_(front).png" rel="noopener noreferer" target="_blank">Wikimedia Commons</a>, <a href="https://github.com/NixOS/nixos-artwork/blob/master/wallpapers/nix-wallpaper-nineish-catppuccin-frappe-alt.png" rel="noopener noreferer" target="_blank">NixOS</a> </small></p></div></div>
  </body>
</html>
