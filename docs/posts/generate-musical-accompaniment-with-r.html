<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://flujoo.github.io/en/generate-accompaniment-progression/">Original</a>
    <h1>Generate Musical Accompaniment with R</h1>
    
    <div id="readability-page-1" class="page"><div><p>Given a harmonic progression and the first accompaniment motif, how to automatically generate an entire accompaniment progression?</p>
<p>In this blog, I will tackle this problem with R language and <a href="https://github.com/flujoo/gm">R package “gm”</a>. Please note that, for illustrative purposes, the solution presented here is only a simplified version. I will talk more about this in the last section.</p>
<p>Let’s first clarify the problem, before diving into it.</p>
<h2 id="clarify-the-problem">Clarify the Problem</h2>
<p>Take the beginning of Chopin’s nocturne Op.9 No.1 as an example:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/nocturne.png" alt=""/></p>
<audio controls="">
  <source src="audio/nocturne.mp3" type="audio/mpeg"/>
</audio>
<p>By <strong>accompaniment motifs</strong>, I mean the structures in the red frames in the following score:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/motifs.png" alt=""/></p>
<audio controls="">
  <source src="audio/accompaniment.mp3" type="audio/mpeg"/>
</audio>
<p>By <strong>harmonic progression</strong>, I mean the sequence of the background harmonies behind these accompaniment motifs, which is B♭m, F7, B♭m and B♭m.</p>
<p>Thus the problem here is that, given only a starting accompaniment motif such as</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/motif.png" alt=""/></p>
<p>and a harmonic progression such as B♭m, F7, B♭m and B♭m or other ones, how to generate an entire accompaniment progression such as</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/accompaniment.png" alt=""/></p>
<h2 id="main-idea">Main Idea</h2>
<p>Let’s have a look of the first two accompaniment motifs to gain some insights:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/two.png" alt=""/></p>
<audio controls="">
  <source src="audio/two.mp3" type="audio/mpeg"/>
</audio>
<p>They have almost the same morphology. Their only differences are caused by the background harmonies. When the first accompaniment motif moves into or repeats in a new “harmonic environment”, it has to change some pitches to adapt to the new environment.</p>
<p>However, the differences caused by adaptation are kept as minimum as possible. For example, the pitch of the second note of the first motif is F3, and that of the second motif is also F3. Since the harmony behind the second motif is F dominant 7th whose pitch classes include F, there is no need for F3 to change.</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/f3.png" alt=""/></p>
<p>Also, the pitch of the third note of the first motif is D♭4, but there is no D♭ in the pitch classes of F dominant 7th, so it moves to a nearest pitch E♭4.</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/d_flat_4.png" alt=""/></p>
<p>This “move as minimum as possible” principle is no accident. Some theorist calls it <strong>common tone rule</strong> and <strong>nearest chordal tone rule</strong>.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup> These rules are like “industrial standards”, which are taught in textbooks and usually followed by composers. They are also the core of the solution to our problem, which can be stated as follows:</p>
<p>Suppose we have a starting accompaniment motif and a harmonic progression. We first make this motif adapt to the first harmony from the harmonic progression, to generate the second accompaniment motif. In the process, “move as minimum as possible” principle is obeyed. We then make the second motif adapt to the second harmony to generate the third motif. Repeat this process, until an entire accompaniment progression is generated.</p>
<p>Now let’s implement this in R.</p>
<h2 id="represent-motifs-and-harmonies">Represent Motifs and Harmonies</h2>
<p>From data structure perspective, a motif is just a list of notes or chords, and each note has two components, which are pitch and duration. However, to simplify the problem, chords and durations are ignored here. Therefore, a motif is a list of pitches.</p>
<p>To represent pitches, <a href="https://en.wikipedia.org/wiki/Scientific_pitch_notation#Table_of_note_frequencies">MIDI note numbers</a> rather than scientific pitch notations such as E4 are used, for ease of operation. Therefore, a motif can be represented as a vector of integers in R. For example, the first accompaniment motif of Chopin’s nocturne can be represented as</p>
<div><pre tabindex="0"><code data-lang="r"><span>c</span><span>(</span><span>46</span><span>,</span> <span>53</span><span>,</span> <span>61</span><span>,</span> <span>58</span><span>,</span> <span>65</span><span>,</span> <span>53</span><span>)</span>
</code></pre></div><p>It is equivalent to</p>
<div><pre tabindex="0"><code data-lang="r"><span>c</span><span>(</span><span>&#34;B-2&#34;</span><span>,</span> <span>&#34;F3&#34;</span><span>,</span> <span>&#34;D-4&#34;</span><span>,</span> <span>&#34;B-3&#34;</span><span>,</span> <span>&#34;F4&#34;</span><span>,</span> <span>&#34;F3&#34;</span><span>)</span>
</code></pre></div><p>A harmony is a list of <a href="https://en.wikipedia.org/wiki/Pitch_class#Other_ways_to_label_pitch_classes">pitch classes</a>. It can be represented as a vector of integers. For example, C major can be represented as</p>
<p>It is equivalent to</p>
<h2 id="show-motifs">Show Motifs</h2>
<p>We can use <a href="https://github.com/flujoo/gm">R package “gm”</a> to show the first motif:</p>
<div><pre tabindex="0"><code data-lang="r"><span>library</span><span>(</span><span>gm</span><span>)</span>

<span># pitches</span>
<span>ps</span> <span>&lt;-</span> <span>as.list</span><span>(</span><span>c</span><span>(</span><span>46</span><span>,</span> <span>53</span><span>,</span> <span>61</span><span>,</span> <span>58</span><span>,</span> <span>65</span><span>,</span> <span>53</span><span>))</span>

<span># durations</span>
<span>ds</span> <span>&lt;-</span> <span>rep</span><span>(</span><span>list</span><span>(</span><span>0.5</span><span>),</span> <span>6</span><span>)</span>

<span>m</span> <span>&lt;-</span>
    <span>Music</span><span>()</span> <span>+</span>
    <span>Tempo</span><span>(</span><span>110</span><span>)</span> <span>+</span>
    <span>Meter</span><span>(</span><span>6</span><span>,</span> <span>4</span><span>)</span> <span>+</span>
    <span>Key</span><span>(</span><span>-5</span><span>)</span> <span>+</span>
    <span>Line</span><span>(</span><span>ps</span><span>,</span> <span>ds</span><span>)</span> <span>+</span> 
    <span>Clef</span><span>(</span><span>&#34;F&#34;</span><span>,</span> <span>to</span> <span>=</span> <span>1</span><span>)</span>

<span>show</span><span>(</span><span>m</span><span>,</span> <span>to</span> <span>=</span> <span>c</span><span>(</span><span>&#34;score&#34;</span><span>,</span> <span>&#34;audio&#34;</span><span>))</span>
</code></pre></div><p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/gm.png" alt=""/></p>
<audio controls="">
  <source src="audio/gm.mp3" type="audio/mpeg"/>
</audio>
<p>The code is straightforward. See <a href="https://flujoo.github.io/gm/articles/gm.html">the documentation of “gm”</a> for more details.</p>
<p>Let’s wrap the code into a function for further use:</p>
<div><pre tabindex="0"><code data-lang="r"><span>show_motif</span> <span>&lt;-</span> <span>function</span><span>(</span><span>motif</span><span>)</span> <span>{</span>
    <span>ps</span> <span>&lt;-</span> <span>as.list</span><span>(</span><span>motif</span><span>)</span>
    <span>ds</span> <span>&lt;-</span> <span>rep</span><span>(</span><span>list</span><span>(</span><span>0.5</span><span>),</span> <span>length</span><span>(</span><span>motif</span><span>))</span>

    <span>m</span> <span>&lt;-</span>
        <span>Music</span><span>()</span> <span>+</span>
        <span>Tempo</span><span>(</span><span>110</span><span>)</span> <span>+</span>
        <span>Meter</span><span>(</span><span>6</span><span>,</span> <span>4</span><span>)</span> <span>+</span>
        <span>Key</span><span>(</span><span>-5</span><span>)</span> <span>+</span>
        <span>Line</span><span>(</span><span>ps</span><span>,</span> <span>ds</span><span>)</span> <span>+</span> 
        <span>Clef</span><span>(</span><span>&#34;F&#34;</span><span>,</span> <span>to</span> <span>=</span> <span>1</span><span>)</span>

    <span>show</span><span>(</span><span>m</span><span>,</span> <span>to</span> <span>=</span> <span>c</span><span>(</span><span>&#34;score&#34;</span><span>,</span> <span>&#34;audio&#34;</span><span>))</span>
<span>}</span>
</code></pre></div><h2 id="get-neighbor-pitches">Get Neighbor Pitches</h2>
<p>As mentioned above, if a pitch in a motif does not match the new harmony, it has to move to a nearest pitch. So we need a function that gets a pitch’s neighbor pitches:</p>
<div><pre tabindex="0"><code data-lang="r"><span>get_pitches</span> <span>&lt;-</span> <span>function</span><span>(</span><span>pitch</span><span>,</span> <span>harmony</span><span>)</span> <span>{</span>
    <span>ps</span> <span>&lt;-</span> <span>pitch</span> <span>+</span> <span>-2</span><span>:</span><span>2</span>
    <span>ps</span><span>[</span><span>(</span><span>ps</span> <span>%%</span> <span>12</span><span>)</span> <span>%in%</span> <span>harmony]</span>
<span>}</span>
</code></pre></div><p>Let’s have a test. Suppose we have a pitch D♭4 whose MIDI note number is 61, and a harmony F dominant 7th whose pitch classes are F, A, C and E♭, or 5, 9, 0 and 3. The neighbor pitches of D♭4 should be C4 and E♭4, or 60 and 63.</p>
<div><pre tabindex="0"><code data-lang="r"><span>get_pitches</span><span>(</span><span>61</span><span>,</span> <span>c</span><span>(</span><span>5</span><span>,</span> <span>9</span><span>,</span> <span>0</span><span>,</span> <span>3</span><span>))</span>

<span>#&gt; [1] 60 63</span>
</code></pre></div><p>The result is correct.</p>
<h2 id="generate-candidate-motifs">Generate Candidate Motifs</h2>
<p>As you have seen in the above example, a pitch can have more than one neighbor pitch in a new harmony, which means that a motif can generate more than one motif in a new harmony.</p>
<p>Now we have two strategic options. First, we write a function which takes a motif as input and returns exactly one motif. Second, we write two functions, the first of which generates some candidate motifs, and the second of which selects the best one from those candidates.</p>
<p>The first strategy is straightforward, but in my experience, the second strategy, which we will take, is far easier to implement.</p>
<p>Let’s first create a function to generate candidates, which takes a motif and returns a list of motifs:</p>
<div><pre tabindex="0"><code data-lang="r"><span># use pipe operator `%&gt;%`</span>
<span>library</span><span>(</span><span>magrittr</span><span>)</span>

<span>generate_motifs</span> <span>&lt;-</span> <span>function</span><span>(</span><span>motif</span><span>,</span> <span>harmony</span><span>)</span> <span>{</span>
    <span>ps</span> <span>&lt;-</span> <span>mapply</span><span>(</span>
        <span>get_pitches</span><span>,</span>
        <span>as.list</span><span>(</span><span>motif</span><span>),</span>
        <span>MoreArgs</span> <span>=</span> <span>list</span><span>(</span><span>harmony</span> <span>=</span> <span>harmony</span><span>),</span>
        <span>SIMPLIFY</span> <span>=</span> <span>FALSE</span>
    <span>)</span>

    <span>motifs</span> <span>&lt;-</span> 
        <span>ps</span> <span>%&gt;%</span>
        <span>expand.grid</span><span>()</span> <span>%&gt;%</span>
        <span>t</span><span>()</span> <span>%&gt;%</span>
        <span>as.data.frame</span><span>()</span> <span>%&gt;%</span>
        <span>as.list</span><span>()</span>

    <span>names</span><span>(</span><span>motifs</span><span>)</span> <span>&lt;-</span> <span>NULL</span>
    <span>motifs</span>
<span>}</span>
</code></pre></div><p>Let’s try this function on the first motif of Chopin’s nocturne:</p>
<div><pre tabindex="0"><code data-lang="r"><span>motifs</span> <span>&lt;-</span> <span>generate_motifs</span><span>(</span>
    <span>c</span><span>(</span><span>46</span><span>,</span> <span>53</span><span>,</span> <span>61</span><span>,</span> <span>58</span><span>,</span> <span>65</span><span>,</span> <span>53</span><span>),</span>
    <span>c</span><span>(</span><span>5</span><span>,</span> <span>9</span><span>,</span> <span>0</span><span>,</span> <span>3</span><span>)</span>
<span>)</span>

<span>length</span><span>(</span><span>motifs</span><span>)</span>

<span>#&gt; [1] 64</span>
</code></pre></div><p>There are total 64 candidates! This is overwhelming. Let’s create a function to select only the best one.</p>
<h2 id="select-from-candidates">Select from Candidates</h2>
<p>These candidates are not all equally good. Some do not fully reify the background harmony, such as the 52rd motif:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/52.png" alt=""/></p>
<p>This motif does not have pitch class E♭.</p>
<p>And some candidates have ugly contours so that they do not sound very good, such as the ninth motif:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/9.png" alt=""/></p>
<p>The third and fourth pitch of this motif are the same.</p>
<p>Let’s create some functions to screen out ill-formed motifs.</p>
<div><pre tabindex="0"><code data-lang="r"><span># check if a motif fully reify the given harmony</span>
<span>is_complete</span> <span>&lt;-</span> <span>function</span><span>(</span><span>motif</span><span>,</span> <span>harmony</span><span>)</span> <span>{</span>
    <span>all</span><span>(</span><span>harmony</span> <span>%in%</span> <span>(</span><span>motif</span> <span>%%</span> <span>12</span><span>))</span>
<span>}</span>

<span># check if a motif has the same contour as the original one</span>
<span>has_same_contour</span> <span>&lt;-</span> <span>function</span><span>(</span><span>motif</span><span>,</span> <span>motif_0</span><span>)</span> <span>{</span>
    <span>all</span><span>(</span><span>order</span><span>(</span><span>motif</span><span>)</span> <span>==</span> <span>order</span><span>(</span><span>motif_0</span><span>))</span>
<span>}</span>

<span># wrap the above two functions</span>
<span>is_good</span> <span>&lt;-</span> <span>function</span><span>(</span><span>motif</span><span>,</span> <span>harmony</span><span>,</span> <span>motif_0</span><span>)</span> <span>{</span>
    <span>is_complete</span><span>(</span><span>motif</span><span>,</span> <span>harmony</span><span>)</span> <span>&amp;&amp;</span>
        <span>has_same_contour</span><span>(</span><span>motif</span><span>,</span> <span>motif_0</span><span>)</span>
<span>}</span>
</code></pre></div><p>Let’s try this function on those 64 candidates:</p>
<div><pre tabindex="0"><code data-lang="r"><span>motifs</span> <span>&lt;-</span> <span>Filter</span><span>(</span>
    <span>function</span><span>(</span><span>motif</span><span>)</span> <span>is_good</span><span>(</span>
        <span>motif</span><span>,</span>
        <span>c</span><span>(</span><span>5</span><span>,</span> <span>9</span><span>,</span> <span>0</span><span>,</span> <span>3</span><span>),</span>
        <span>c</span><span>(</span><span>46</span><span>,</span> <span>53</span><span>,</span> <span>61</span><span>,</span> <span>58</span><span>,</span> <span>65</span><span>,</span> <span>53</span><span>)</span>
    <span>),</span>

    <span>motifs</span>
<span>)</span>

<span>length</span><span>(</span><span>motifs</span><span>)</span>

<span>#&gt; [1] 18</span>
</code></pre></div><p>We still have 18 candidates. We can write more screening functions to reduce the number. For example, for a dominant 7th harmony, the third should not be doubled. However, to simplify the problem, we will stop here, and just take the first candidate.</p>
<h2 id="generate-progression">Generate Progression</h2>
<p>Now let’s put all these together. We will create a single function that takes a motif and a harmony progression as input, generates an entire accompaniment progression, and shows it:</p>
<div><pre tabindex="0"><code data-lang="r"><span>generate_progression</span> <span>&lt;-</span> <span>function</span><span>(</span><span>motif</span><span>,</span> <span>harmonies</span><span>)</span> <span>{</span>
    <span>prog</span> <span>&lt;-</span> <span>list</span><span>(</span><span>motif</span><span>)</span>
    <span>m0</span> <span>&lt;-</span> <span>motif</span>

    <span>for </span><span>(</span><span>h</span> <span>in</span> <span>harmonies</span><span>)</span> <span>{</span>
        <span>ms</span> <span>&lt;-</span> <span>generate_motifs</span><span>(</span><span>m0</span><span>,</span> <span>h</span><span>)</span>
        <span>m</span> <span>&lt;-</span> <span>Filter</span><span>(</span><span>function</span><span>(</span><span>m</span><span>)</span> <span>is_good</span><span>(</span><span>m</span><span>,</span> <span>h</span><span>,</span> <span>m0</span><span>),</span> <span>ms</span><span>)</span><span>[[1]]</span>
        <span>m0</span> <span>&lt;-</span> <span>m</span>
        <span>prog</span> <span>&lt;-</span> <span>c</span><span>(</span><span>prog</span><span>,</span> <span>m</span><span>)</span>
    <span>}</span>

    <span>show_motif</span><span>(</span><span>unlist</span><span>(</span><span>prog</span><span>))</span>
<span>}</span>
</code></pre></div><p>Let’s try it on some harmony progression:</p>
<div><pre tabindex="0"><code data-lang="r"><span>motif</span> <span>&lt;-</span> <span>c</span><span>(</span><span>46</span><span>,</span> <span>53</span><span>,</span> <span>61</span><span>,</span> <span>58</span><span>,</span> <span>65</span><span>,</span> <span>53</span><span>)</span>

<span>harmonies</span> <span>&lt;-</span> <span>list</span><span>(</span>
    <span>c</span><span>(</span><span>3</span><span>,</span> <span>6</span><span>,</span> <span>10</span><span>),</span>
    <span>c</span><span>(</span><span>5</span><span>,</span> <span>9</span><span>,</span> <span>0</span><span>,</span> <span>3</span><span>),</span>
    <span>c</span><span>(</span><span>10</span><span>,</span> <span>1</span><span>,</span> <span>5</span><span>)</span>
<span>)</span>

<span>generate_progression</span><span>(</span><span>motif</span><span>,</span> <span>harmonies</span><span>)</span>
</code></pre></div><p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/prog.png" alt=""/></p>
<audio controls="">
  <source src="audio/prog.mp3" type="audio/mpeg"/>
</audio>
<p>Not too bad!</p>
<h2 id="discussion">Discussion</h2>
<p>As mentioned earlier, this solution has some limitations, mainly because accompaniment motifs can have far more complex structures. For example, they can contain pedal notes as in Chopin’s nocturne Op.9 No.1:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/pedal.png" alt=""/></p>
<p>chords as in Chopin’s nocturne Op.9 No.2:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/chord.png" alt=""/></p>
<p>non-harmonic notes as in Chopin’s nocturne Op.72 No.1:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/non.png" alt=""/></p>
<p>more than one voice as in Chopin’s nocturne Op.15 No.1:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/voice.png" alt=""/></p>
<p>However, with this being said, the idea behind this solution applies not only to accompaniment motifs, but also to melodic motifs and even bigger structures, as in Beethoven’s first piano sonata:</p>
<p><img src="https://flujoo.github.io/en/generate-accompaniment-progression/pics/beethoven.png" alt=""/></p>
<p>See my other blog <a href="https://flujoo.github.io/en/three-types-of-music-analysis">Three Types of Music Analysis</a> for some discussion.</p>

</div></div>
  </body>
</html>
