<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://orca.security/resources/blog/aws-cloudformation-vulnerability/">Original</a>
    <h1>BreakingFormation: AWS CloudFormation Vulnerability</h1>
    
    <div id="readability-page-1" class="page"><div>
                            <p><span>Orca Security’s vulnerability researcher, Tzah Pahima, discovered a vulnerability in AWS allowing file and credential disclosure of an AWS internal service. This zero-day, which AWS completely mitigated within 6 days of our submission, was an XXE (XML External Entity) vulnerability found in the CloudFormation service. This could have been used to leak sensitive files found on the vulnerable service machine and make server-side requests (SSRF) susceptible to the unauthorized disclosure of credentials of internal AWS infrastructure services.</span></p>
<p><span>At Orca Security, our customers are our priority in everything we do, including vulnerability research. Our primary goal is always to protect you and your cloud estate. Prior to this post, and before announcing the CloudFormation vulnerability publicly, our researchers worked with AWS to ensure that the issue was fixed to avoid putting our customers — and AWS’ customers — at risk.</span></p>
<h2><b>What was the Zero-Day AWS BreakingFormation Vulnerability?</b></h2>
<p><span>If you use AWS, then you might be familiar with CloudFormation, the service that enables you to easily provision AWS resources (such as EC2 instances and S3 buckets) using templates. CloudFormation also allows you to use API calls to dynamically create and configure resources. The <a href="https://orca.security/about/orca-research-pod/">Orca Security Research Team</a> discovered a zero-day vulnerability that allowed us to compromise a server within CloudFormation, which in turn, led to us running as an AWS infrastructure service.</span></p>
<p><span>Leveraging an anomaly in the way that CloudFormation renders templates allowed us to trigger an XXE vulnerability, which we used to read files and perform HTTP requests on behalf of the server. The server contained multiple service binaries containing AWS server-side logic, as well as configuration files for connecting to internal AWS endpoints and services.</span></p>
<p><span>Our research team believes, given the data found on the host (including credentials and data involving internal endpoints), that an attacker could abuse this vulnerability to bypass tenant boundaries, giving them privileged access to any resource in AWS.</span></p>
<p><span>This is what a file disclosure looks like (AWS employees’ information on the right side of the screen was redacted):</span></p>


<p><span>We didn’t want to interfere with the service’s operation. To ensure to whom these credentials belonged, but in a non-invasive way, we used the leaked credentials to presign an S3 URL and then used the SSRF to try and access our own S3 bucket to see which identity was involved. The resulting logs tell us who these credentials belong to. The result was an Access Denied CloudTrail log entry, with the identity shown below:</span></p>
<p><a href="https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion.png"><img src="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%201024%20582&#39;%3E%3C/svg%3E" alt="" width="1024" height="582" data-lazy-srcset="https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion-1024x582.png 1024w, https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion-300x171.png 300w, https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion-768x437.png 768w, https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion-1536x874.png 1536w, https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion.png 1600w" data-lazy-sizes="(max-width: 1024px) 100vw, 1024px" data-lazy-src="https://i0.wp.com/orca.security/wp-content/uploads/2022/01/blog_AWS_BreakingFormation_eventversion-1024x582.png"/></a></p>
<p><span><strong>Note:</strong> The</span><b> “userIdentity”</b><span> field shows that an </span><b>AWS service</b><span>, not CloudFormation’s public principal but rather an internal service used by AWS, tried to access our storage bucket.</span></p>
<h2><b>Reforming the Ranks</b></h2>
<p><span>We immediately reported the issue to AWS, who acted quickly to fix it. The AWS security team coded a fix in </span><b>less than 25 hours</b><span>, and it reached all AWS regions within 6 days.</span></p>
<p><span></span><span>Orca Security researchers helped test the fix to ensure that this vulnerability was correctly resolved, and we were able to verify that it could no longer be exploited.</span></p>
<div>
<h4><strong>Timeline:</strong></h4>
<ul>
<li aria-level="1"><b>09/09/2021 – </b><span>Vulnerability reported to the AWS security team.</span></li>
<li aria-level="1"><b>09/10/2021 – </b><span>AWS sent us a message, saying they had made a code change and had started deploying it.</span></li>
<li aria-level="1"><b>09/15/2021 – </b><span>The code change reached every AWS region.</span></li>
</ul>
</div>
<p><span>The <a href="https://orca.security/about/orca-research-pod/">Orca Security Research Team</a> is dedicated to ethically advancing cloud security in close partnership with the cloud service platforms that we help protect. </span></p>
<p><span>If you’d like to learn more about Orca Security</span><span> I invite you to experience our tech and talent first-hand with a no-obligation, <a href="https://orca.security/lp/cloud-security-risk-assessment/?utm_content=breakingformation-blog">free cloud risk assessment</a>. You’ll get complete visibility into your public cloud, a detailed risk report with an executive summary, and time with our cloud security experts.</span></p>
<ul>
<li><img src="data:image/svg+xml,%3Csvg%20xmlns=&#39;http://www.w3.org/2000/svg&#39;%20viewBox=&#39;0%200%200%200&#39;%3E%3C/svg%3E" data-lazy-src="https://orca.security/wp-content/uploads/2021/12/icon_vulnerability.svg"/>
<p>Discover Your Cloud Vulnerabilities In Minutes</p>
<p>Scan your entire AWS, Azure, and Google Cloud environments for vulnerabilities with <a href="https://orca.security/lp/cloud-security-risk-assessment/?utm_content=breakingformation-blog">Orca Security’s free, no obligation risk assessment</a>.</p>
</li>
</ul>



<p><strong><em>Tzah Pahima is a Cloud Security Researcher at Orca Security. Follow him on Twitter <a href="https://twitter.com/tzahpahima">@tzahpahima</a></em></strong></p>
                        </div></div>
  </body>
</html>
