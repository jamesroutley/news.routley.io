<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://mattrighetti.com/2022/04/05/i-need-to-find-an-appartment.html">Original</a>
    <h1>I Need to Find an Apartment</h1>
    
    <div id="readability-page-1" class="page"><div>
<article>

<p>Apr 5, 2022</p>
<p>Long story short: I’ve taken a new position in Luxembourg and I have to
find an apartment, in a different country, in a reasonably short time.</p>
<div>
<div>
<p><strong>TL;DR:</strong> I hate apartment hunting, I’ve tried to make it as interesting
as possible by creating a pipeline with different tools and languages
to <em>scrape</em> data from a website with the use of Puppeteer, load data into
a SQLite database using Go and visualizing all the data with Python and Folium.</p>
</div>
</div>
<p>If you want to look at the final code or follow along with me
you can checkout the project repo on
<a href="https://github.com/mattrighetti/athome-scraper">GitHub</a>.</p>
<p>I initially sketched what I was looking for by priority</p>

<p>After that it was time for the boring stuff: looking for an apartment
that best fits my requirements.</p>
<p>I have a couple of friends in Lux and they all told me to look on the infamous
website <a href="https://athome.lu">AtHome.lu</a> to get an idea on the available
apartments that there are in Lux, so I did.</p>
<p>I don’t like doing this, so I try to make things easier by just
looking at the pictures and if the price looks ok I’ll just bookmark
the thing so that I can look at it later for comparisons.</p>
<p>This quickly becomes hard to do. Some agencies will publish part of the
monthly price, some of them will post the actual monthly price. Each
agency fee is different and it’s not immediately visible. The map
on the website is just awful and it won’t let me compare positions with other
apartments. Needless to say that it is pretty much impossible to choose
the right one with this messy data.</p>
<p>What I’d like to have is a big map with all the apartments that I like on
it and maybe a database to query apartments to show by different parameters.</p>
<p>Let’s see if we can scrape some data off of athome.lu!</p>
<p>After giving a quick look at the website I’ve found out that by selecting
the renting apartments in the Luxembourg area, links start with this URL path
<code>www.athome.lu/en/rent/apartment/luxembourg</code>, each apartment
has a unique id and the complete address for an apartment looks like this
<code>www.athome.lu/en/rent/apartment/luxembourg/id-642398588.html</code>.</p>
<p>This is a good start, it means that I can pretty much navigate to a specific apartment
page just by knowing its id.</p>
<p>If I inspect the html source of a single page, I immediately notice that there
is a <strong>HUGE</strong> json object with a lot of data in it at the bottom of the page,</p>
<div>
<p><img src="https://mattrighetti.com/assets/images/initstate.png" alt="initstate"/>
</p>
</div>
<p>Let’s see if we can find something interesting in it.</p>
<div>
<p><img src="https://mattrighetti.com/assets/images/initstate_console.png" alt="initstate console"/>
</p>
</div>
<p>Cool, it seems like a big object to set up the entire page. If we look at
each sub-object of <code><em>INITIAL_STATE</em></code> we find <code>detail</code> which
seems to be our lucky card.</p>
<div>
<p><img src="https://mattrighetti.com/assets/images/detail_console.png" alt="detail console"/>
</p>
</div>
<p>Great! We don’t even have to scrape data from html, we have all the data of the
apartment in this <code><em>INITIAL_STATE</em>.detail</code> object!</p>
<p>How can I access that variable through code though? I don’t have a great experience with it
and I don’t write a lot of JS, but I heard that <a href="https://developers.google.com/web/tools/puppeteer/">Puppeteer</a>
is the right tool for the job. Let me try something out</p>
<div>
<div>
<pre><code data-lang="javascript"><span>const</span> <span>puppeteer</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>puppeteer</span><span>&#39;</span><span>);</span>
<span>const</span> <span>fs</span> <span>=</span> <span>require</span><span>(</span><span>&#39;</span><span>fs</span><span>&#39;</span><span>).</span><span>promises</span><span>;</span>

<span>async</span> <span>function</span> <span>scrape_json_data</span><span>(</span><span>browser</span><span>,</span> <span>link</span><span>)</span> <span>{</span>
    <span>const</span> <span>page</span> <span>=</span> <span>await</span> <span>browser</span><span>.</span><span>newPage</span><span>();</span>
    <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>link</span><span>);</span>
    <span>const</span> <span>obj</span> <span>=</span> <span>await</span> <span>page</span><span>.</span><span>evaluate</span><span>(()</span> <span>=&gt;</span> <span>{</span>
        <span>var</span> <span>{</span> <span>detail</span> <span>}</span> <span>=</span> <span>__INITIAL_STATE__</span><span>;</span>
        <span>return</span> <span>detail</span><span>;</span>
    <span>});</span>
    <span>return</span> <span>obj</span><span>;</span>
<span>}</span>

<span>(</span><span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>browser</span> <span>=</span> <span>await</span> <span>puppeteer</span><span>.</span><span>launch</span><span>({</span> <span>headless</span><span>:</span> <span>true</span> <span>});</span>
    <span>// File where I&#39;ll save all my preferred apartments&#39; links</span>
    <span>const</span> <span>data</span> <span>=</span> <span>await</span> <span>fs</span><span>.</span><span>readFile</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>LINKS_PATH</span><span>,</span> <span>&#34;</span><span>utf-8</span><span>&#34;</span><span>);</span>
    <span>// Read line by line</span>
    <span>const</span> <span>links</span> <span>=</span> <span>data</span><span>.</span><span>split</span><span>(</span><span>/</span><span>\r?\n</span><span>/</span><span>);</span>

    <span>var</span> <span>objs</span> <span>=</span> <span>[];</span>
    <span>for</span> <span>(</span><span>var</span> <span>i</span> <span>in</span> <span>links</span><span>)</span> <span>{</span>
        <span>let</span> <span>id_pattern</span> <span>=</span> <span>/id-</span><span>(\d</span><span>+</span><span>)</span><span>/</span><span>;</span>
        <span>// Take id from final part of each link</span>
        <span>let</span> <span>id</span> <span>=</span> <span>links</span><span>[</span><span>i</span><span>].</span><span>match</span><span>(</span><span>id_pattern</span><span>)[</span><span>1</span><span>];</span>

        <span>console</span><span>.</span><span>log</span><span>(</span><span>&#34;</span><span>scraping: </span><span>&#34;</span> <span>+</span> <span>id</span><span>);</span>
        <span>var</span> <span>obj</span> <span>=</span> <span>await</span> <span>scrape_json_data</span><span>(</span><span>browser</span><span>,</span> <span>links</span><span>[</span><span>i</span><span>]);</span>

        <span>if</span> <span>(</span><span>obj</span><span>.</span><span>found</span><span>)</span> <span>{</span>
            <span>// Remove all the superfluous data from detail obj</span>
            <span>obj</span> <span>=</span> <span>clean_obj</span><span>(</span><span>obj</span><span>);</span>
            <span>// Add link to the obj, somehow it&#39;s not included in detail obj :/</span>
            <span>obj</span><span>.</span><span>link</span> <span>=</span> <span>links</span><span>[</span><span>i</span><span>];</span>
            <span>objs</span><span>.</span><span>push</span><span>(</span><span>obj</span><span>);</span>
        <span>}</span> <span>else</span> <span>{</span>
            <span>objs</span><span>.</span><span>push</span><span>({</span> <span>found</span><span>:</span> <span>false</span><span>,</span> <span>listingId</span><span>:</span> <span>parseInt</span><span>(</span><span>id</span><span>)</span> <span>});</span>
        <span>}</span>
    <span>}</span>

    <span>// Save obj data to json file</span>
    <span>fs</span><span>.</span><span>writeFile</span><span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>JSON_OUT</span><span>,</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>objs</span><span>));</span>
    <span>await</span> <span>browser</span><span>.</span><span>close</span><span>()</span>
<span>})();</span></code></pre>
</div>
</div>
<p>The code above will open a headless instance of chrome, go to each
apartment link that is saved in the file at <code>LINKS_PATH</code> and
spit an array of all the apartment data in a file at <code>JSON_OUT</code>.</p>
<p>We were lucky this time, we didn’t have to go through scraping html,
and this would have probably been the most boring part of the entire process.
The next steps will be about storing data in a database and visualizing it,
but first let’s write a <a href="https://github.com/casey/just">justfile</a>
(alternative to a Makefile) that will make our life easier when we
need to execute commands.</p>
<div>
<div>
<pre><code data-lang="justfile">base     := justfile_directory()
json_out := &#34;/tmp/res.json&#34;
links    := base + &#34;/homes.txt&#34;

scrape:
    LINKS_PATH={{links}} \
    JSON_OUT={{json_out}} \
    node scraper/main.js</code></pre>
</div>
</div>
<p>I can now scrape data by just typing</p>

<p>I want to save all the data to a sqlite database
so that I can conveniently check, query and get
apartments info whenever I want and however I want.</p>
<p>Let’s move away from js and switch to a compiled language,
Go will fit perfectly for this, it’s fast and easy to use.</p>
<p>The binary will parse the entire json file that the scraper created
and load each apartment to the <code>apartment</code> table in sqlite.</p>
<p>I didn’t show it before, but this is my final, cleaned-from-useless-stuff
<code>Apartment</code> struct with some tag annotations to read from json and load into
sqlite by using <a href="https://github.com/jmoiron/sqlx">sqlx</a>.</p>
<div>
<div>
<pre><code data-lang="go"><span>type</span> <span>Apartment</span> <span>struct</span> <span>{</span>
	<span>Found</span>                  <span>bool</span>      <span>`json:&#34;found,omitempty&#34; db:&#34;found,omitempty&#34;`</span>
	<span>ListingId</span>              <span>uint32</span>    <span>`json:&#34;listingId,omitempty&#34; db:&#34;listingId,omitempty&#34;`</span>
	<span>ListingAgencyReference</span> <span>string</span>    <span>`json:&#34;listingAgencyReference,omitempty&#34; db:&#34;listingAgencyReference,omitempty&#34;`</span>
	<span>IsSoldProperty</span>         <span>bool</span>      <span>`json:&#34;isSoldProperty,omitempty&#34; db:&#34;isSoldProperty,omitempty&#34;`</span>
	<span>Region</span>                 <span>string</span>    <span>`json:&#34;region,omitempty&#34; db:&#34;region,omitempty&#34;`</span>
	<span>CityName</span>               <span>string</span>    <span>`json:&#34;cityName,omitempty&#34; db:&#34;cityName,omitempty&#34;`</span>
	<span>Lon</span>                    <span>float64</span>   <span>`json:&#34;lon,omitempty&#34; db:&#34;lon,omitempty&#34;`</span>
	<span>Lat</span>                    <span>float64</span>   <span>`json:&#34;lat,omitempty&#34; db:&#34;lat,omitempty&#34;`</span>
	<span>Price</span>                  <span>int</span>       <span>`json:&#34;price,omitempty&#34; db:&#34;price,omitempty&#34;`</span>
	<span>ChargesPrice</span>           <span>int</span>       <span>`json:&#34;chargesPrice,omitempty&#34; db:&#34;chargesPrice,omitempty&#34;`</span>
	<span>Caution</span>                <span>float32</span>   <span>`json:&#34;caution,omitempty&#34; db:&#34;caution,omitempty&#34;`</span>
	<span>AgencyFee</span>              <span>string</span>    <span>`json:&#34;agency_fee,omitempty&#34; db:&#34;agency_fee,omitempty&#34;`</span>
	<span>PropertySubType</span>        <span>string</span>    <span>`json:&#34;propertySubType,omitempty&#34; db:&#34;propertySubType,omitempty&#34;`</span>
	<span>PublisherId</span>            <span>int</span>       <span>`json:&#34;publisher_id,omitempty&#34; db:&#34;publisher_id,omitempty&#34;`</span>
	<span>PublisherRemoteVisit</span>   <span>bool</span>      <span>`json:&#34;publisher_remote_visit,omitempty&#34; db:&#34;publisher_remote_visit,omitempty&#34;`</span>
	<span>PublisherPhone</span>         <span>string</span>    <span>`json:&#34;publisher_phone,omitempty&#34; db:&#34;publisher_phone,omitempty&#34;`</span>
	<span>PublisherName</span>          <span>string</span>    <span>`json:&#34;publisher_name,omitempty&#34; db:&#34;publisher_name,omitempty&#34;`</span>
	<span>PublisherAthomeId</span>      <span>string</span>    <span>`json:&#34;publisher_athome_id,omitempty&#34; db:&#34;publisher_athome_id,omitempty&#34;`</span>
	<span>PropertySurface</span>        <span>float64</span>   <span>`json:&#34;propertySurface,omitempty&#34; db:&#34;propertySurface,omitempty&#34;`</span>
	<span>BuildingYear</span>           <span>string</span>    <span>`json:&#34;buildingYear,omitempty&#34; db:&#34;buildingYear,omitempty&#34;`</span>
	<span>FloorNumber</span>            <span>string</span>    <span>`json:&#34;floorNumber,omitempty&#34; db:&#34;floorNumber,omitempty&#34;`</span>
	<span>BathroomsCount</span>         <span>int</span>       <span>`json:&#34;bathroomsCount,omitempty&#34; db:&#34;bathroomsCount,omitempty&#34;`</span>
	<span>BedroomsCount</span>          <span>int</span>       <span>`json:&#34;bedroomsCount,omitempty&#34; db:&#34;bedroomsCount,omitempty&#34;`</span>
	<span>BalconiesCount</span>         <span>int</span>       <span>`json:&#34;balconiesCount,omitempty&#34; db:&#34;balconiesCount,omitempty&#34;`</span>
	<span>CarparkCount</span>           <span>int</span>       <span>`json:&#34;carparkCount,omitempty&#34; db:&#34;carparkCount,omitempty&#34;`</span>
	<span>GaragesCount</span>           <span>int</span>       <span>`json:&#34;garagesCount,omitempty&#34; db:&#34;garagesCount,omitempty&#34;`</span>
	<span>HasLivingRoom</span>          <span>bool</span>      <span>`json:&#34;hasLivingRoom,omitempty&#34; db:&#34;hasLivingRoom,omitempty&#34;`</span>
	<span>HasKitchen</span>             <span>bool</span>      <span>`json:&#34;hasKitchen,omitempty&#34; db:&#34;hasKitchen,omitempty&#34;`</span>
	<span>Availability</span>           <span>string</span>    <span>`json:&#34;availability,omitempty&#34; db:&#34;availability,omitempty&#34;`</span>
	<span>Media</span>                  <span>*</span><span>[]</span><span>string</span> <span>`json:&#34;media,omitempty&#34; db:&#34;media,omitempty&#34;`</span>
	<span>Description</span>            <span>string</span>    <span>`json:&#34;description,omitempty&#34; db:&#34;description,omitempty&#34;`</span>
	<span>Link</span>                   <span>string</span>    <span>`json:&#34;link,omitempty&#34; db:&#34;link,omitempty&#34;`</span>
	<span>CreatedAt</span>              <span>string</span>    <span>`json:&#34;createdAt,omitempty&#34; db:&#34;createdAt,omitempty&#34;`</span>
	<span>UpdatedAt</span>              <span>string</span>    <span>`json:&#34;updatedAt,omitempty&#34; db:&#34;updatedAt,omitempty&#34;`</span>
<span>}</span></code></pre>
</div>
</div>
<p>I might change my mind later down the road on the data that I want to keep
in each <code>Apartment</code> struct, so I might want to make changes to the database structure,
and therefore the queries to insert and update the database too. To make this a bit more
flexible I will use a yaml file to save any database migration and insert/update
queries to the database.</p>
<div>
<div>
<pre><code data-lang="yaml"><span>migrations</span><span>:</span> <span>|</span>
  <span>CREATE TABLE IF NOT EXISTS apartment(</span>
      <span>found BOOL,</span>
      <span>listingId INTEGER PRIMARY KEY,</span>
      <span>...</span>
      <span>description TEXT,</span>
      <span>link TEXT,</span>
      <span>createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
      <span>updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
  <span>);</span>


<span>insertQuery</span><span>:</span> <span>|</span>
    <span>INSERT INTO apartment(found,listingId,listingAgencyReference,isSoldProperty,region,cityName,</span>
                          <span>lon,lat,price,chargesPrice,caution,agency_fee,propertySubType,publisher_id,</span>
                          <span>publisher_remote_visit,publisher_phone,publisher_name,publisher_athome_id,</span>
                          <span>propertySurface,buildingYear,floorNumber,bathroomsCount,bedroomsCount,balconiesCount,</span>
                          <span>garagesCount,carparkCount,hasLivingRoom,hasKitchen,availability,media,description,link)</span>
    <span>VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)</span>


<span>updateQuery</span><span>:</span> <span>|</span>
    <span>UPDATE apartment</span>
    <span>SET found = ?, listingId = ?, listingAgencyReference = ?, isSoldProperty = ?, region = ?, cityName = ?, lon = ?, lat = ?, price = ?,</span>
        <span>chargesPrice = ?, caution = ?, agency_fee = ?, propertySubType = ?, publisher_id = ?, publisher_remote_visit = ?, publisher_phone = ?,</span>
        <span>publisher_name = ?, publisher_athome_id = ?, propertySurface = ?, buildingYear = ?, floorNumber = ?, bathroomsCount = ?,</span>
        <span>bedroomsCount = ?, balconiesCount = ?, garagesCount = ?, carparkCount = ?, hasLivingRoom = ?, hasKitchen = ?,</span>
        <span>availability = ?, media = ?, description = ?, link = ?, updatedAt = CURRENT_TIMESTAMP</span>
    <span>WHERE listingId = ?</span></code></pre>
</div>
</div>
<p>After setting up these basic features and with a little more code
I can compile the program and run it so that it will load the previous
json file into my sqlite <code>apartment</code> table.</p>
<p>Let’s add some more commands to the justfile that we’ve
created previously.</p>
<div>
<div>
<pre><code data-lang="justfile">db_path  := base + &#34;/db.sqlite&#34;

gobuild:
    cd {{base}}/loader; go build cmd/main.go

load: gobuild
    CONFIG_PATH={{base}}/loader/config.yaml \
    JSON_OUT={{json_out}} \
    DB_PATH={{db_path}} \
    {{base}}/loader/main

fetch: scrape load</code></pre>
</div>
</div>
<p>Let’s load the data into database</p>
<div>
<div>
<pre><code data-lang="Shell session">$ just load
&gt; OR
$ just fetch
&gt; which will first scrape data and then load it in the database
&gt; justfiles are cool!</code></pre>
</div>
</div>
<p>Just to get some specs, this runs fast. Take a look</p>
<div>
<div>
<pre><code data-lang="Shell session">$ cat home.txt | wc
  65      66    4469
$ time just load
just load  0.38s user 0.52s system 220% cpu 0.408 total</code></pre>
</div>
</div>
<p>I now have all the data that I scraped in my nice and super fast
database, ready to be queried with the craziest query that comes
to my mind, I can think of some.</p>
<p>We’re at a going point at the moment, I have a lot of parameters
with which I can query apartments that I like. I can select them by
non-decreasing price, by area and if I add some more complex Haversine
formulae I could also sort them by distance from the city centre or any
other map coordinates.</p>
<p>I won’t stop here though. I have some interesting little vars in
each apartment data: <code>lat</code>, <code>lon</code>. I don’t want to waste geo data!
It’s nice and fun to just look at tabular data, but I think I could
get an easier idea of the location just by plotting stuff on a map.</p>
<p>I want to code something quick with the smallest amount of code, so I’ll
go with Python and Jupyter notebook in conjunction with
<a href="https://python-visualization.github.io/folium/">Folium</a> which is
a library that generates <a href="https://leafletjs.com/">Leaflet</a> maps.</p>
<p>Let’s setup the map with my point of interest</p>
<div>
<div>
<pre><code data-lang="python"><span>import</span> <span>folium</span>

<span>lux_coords</span> <span>=</span> <span>[</span><span>49.611622</span><span>,</span> <span>6.131935</span><span>]</span>
<span>map_</span> <span>=</span> <span>folium</span><span>.</span><span>Map</span><span>(</span><span>location</span> <span>=</span> <span>lux_coords</span><span>,</span> <span>zoom_start</span> <span>=</span> <span>10</span><span>)</span>

<span>interesting_coords</span> <span>=</span> <span>[</span><span>49.630033</span><span>,</span> <span>6.168936</span><span>]</span>
<span>folium</span><span>.</span><span>Marker</span><span>(</span><span>location</span><span>=</span><span>interesting_coords</span><span>,</span> <span>popup</span><span>=</span><span>&#34;Point of interest&#34;</span><span>,</span> <span>icon</span><span>=</span><span>folium</span><span>.</span><span>Icon</span><span>(</span><span>color</span><span>=</span><span>&#39;red&#39;</span><span>)).</span><span>add_to</span><span>(</span><span>map_</span><span>)</span>

<span>folium</span><span>.</span><span>Circle</span><span>(</span><span>location</span><span>=</span><span>interesting_coords</span><span>,</span> <span>radius</span><span>=</span><span>5000</span><span>,</span> <span>color</span><span>=</span><span>&#39;green&#39;</span><span>,</span> <span>opacity</span><span>=</span><span>0.5</span><span>,</span> <span>weight</span><span>=</span><span>2</span><span>).</span><span>add_to</span><span>(</span><span>map_</span><span>)</span>
<span>folium</span><span>.</span><span>Circle</span><span>(</span><span>location</span><span>=</span><span>interesting_coords</span><span>,</span> <span>radius</span><span>=</span><span>10000</span><span>,</span> <span>color</span><span>=</span><span>&#39;yellow&#39;</span><span>,</span> <span>opacity</span><span>=</span><span>0.5</span><span>,</span> <span>weight</span><span>=</span><span>2</span><span>).</span><span>add_to</span><span>(</span><span>map_</span><span>)</span>
<span>folium</span><span>.</span><span>Circle</span><span>(</span><span>location</span><span>=</span><span>interesting_coords</span><span>,</span> <span>radius</span><span>=</span><span>15000</span><span>,</span> <span>color</span><span>=</span><span>&#39;orange&#39;</span><span>,</span> <span>opacity</span><span>=</span><span>0.5</span><span>,</span> <span>weight</span><span>=</span><span>2</span><span>).</span><span>add_to</span><span>(</span><span>map_</span><span>)</span>
<span>folium</span><span>.</span><span>Circle</span><span>(</span><span>location</span><span>=</span><span>interesting_coords</span><span>,</span> <span>radius</span><span>=</span><span>20000</span><span>,</span> <span>color</span><span>=</span><span>&#39;red&#39;</span><span>,</span> <span>opacity</span><span>=</span><span>0.5</span><span>,</span> <span>weight</span><span>=</span><span>2</span><span>).</span><span>add_to</span><span>(</span><span>map_</span><span>)</span></code></pre>
</div>
</div>
<p>This will show a map centered on Lux, with a cool red pin on my point of interest
and to get a better idea of the distance, I also added some circles with a radius of
5km, 10km, 15km and 20km. This is extremely useful because I can discard immediately
by looking at the map of apartments that are too far from my point of interest.</p>
<div>
<p><img src="https://mattrighetti.com/assets/images/poi.png" alt="poi"/>
</p>
</div>
<p>Before going crazy with SQL I need to add my scraped apartments
to the map and for the sake of simplicity I will query them all here</p>
<div>
<div>
<pre><code data-lang="python"><span>import</span> <span>os</span>
<span>import</span> <span>sqlite3</span>


<span>def</span> <span>getApartments</span><span>(</span><span>db</span><span>):</span>
    <span>cur</span> <span>=</span> <span>db</span><span>.</span><span>cursor</span><span>()</span>
    <span>cur</span><span>.</span><span>execute</span><span>(</span>
        <span>&#34;&#34;&#34;
        SELECT *
        FROM apartment
        WHERE
            found = TRUE
        &#34;&#34;&#34;</span>
    <span>)</span>

    <span>return</span> <span>[</span><span>Apartment</span><span>(</span><span>row</span><span>)</span> <span>for</span> <span>row</span> <span>in</span> <span>cur</span><span>.</span><span>fetchall</span><span>()]</span>


<span>def</span> <span>addApartment</span><span>(</span><span>map_</span><span>,</span> <span>a</span><span>):</span>
    <span>popup</span> <span>=</span> <span>folium</span><span>.</span><span>Popup</span><span>(</span><span>a</span><span>.</span><span>_popup_</span><span>(),</span> <span>max_width</span><span>=</span><span>450</span><span>)</span>
    <span>folium</span><span>.</span><span>Marker</span><span>(</span>
        <span>location</span><span>=</span><span>[</span><span>a</span><span>.</span><span>lat</span><span>,</span> <span>a</span><span>.</span><span>lon</span><span>],</span>
        <span>popup</span><span>=</span><span>popup</span><span>,</span>
        <span># I can use fontawesome to change the pin icon
</span>        <span>icon</span><span>=</span><span>folium</span><span>.</span><span>Icon</span><span>(</span><span>color</span><span>=</span><span>a</span><span>.</span><span>_get_color</span><span>(),</span> <span>icon</span><span>=</span><span>a</span><span>.</span><span>_get_icon</span><span>(),</span> <span>prefix</span><span>=</span><span>&#34;fa&#34;</span><span>)</span>
    <span>).</span><span>add_to</span><span>(</span><span>map_</span><span>)</span>


<span>db</span> <span>=</span> <span>sqlite3</span><span>.</span><span>connect</span><span>(</span><span>os</span><span>.</span><span>environ</span><span>[</span><span>&#34;DB_PATH&#34;</span><span>])</span>
<span>apartments</span> <span>=</span> <span>getApartments</span><span>(</span><span>db</span><span>)</span>
<span>for</span> <span>a</span> <span>in</span> <span>apartments</span><span>:</span>
    <span>addApartment</span><span>(</span><span>map_</span><span>,</span> <span>a</span><span>)</span>
<span>map_</span></code></pre>
</div>
</div>
<div>
<p><img src="https://mattrighetti.com/assets/images/poi_apartments.png" alt="poi apartments"/>
</p>
</div>
<p>And here we have it! Definitely a much better experience
than going back and forth on the website and drawing on a map
all the apartments one by one, right?</p>
<p>In the code above you can see that I’ve used a custom popup for each
apartment. With Folium we can use HTML to customize the pin’s popup
with the most important information I want to see (i.e. monthly total price, initial fee,
caution etc.)</p>
<div>
<div>
<pre><code data-lang="python"><span>def</span> <span>_popup_</span><span>(</span><span>self</span><span>):</span>
    <span>return</span> <span>f</span><span>&#34;&#34;&#34;
    &lt;h4&gt;Info&lt;/h4&gt;
    &lt;b&gt;ID: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>listingId</span><span>}</span><span>&lt;br&gt;
    &lt;b&gt;Monthly Price: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>price</span><span>}</span><span>&lt;br&gt;
    &lt;b&gt;Monthly Charge: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>chargesPrice</span><span>}</span><span>&lt;br&gt;
    &lt;b&gt;Caution: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>caution</span><span>}</span><span>&lt;br&gt;
    &lt;b&gt;Agency Fee: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>agencyFee</span><span>}</span><span>
    &lt;br&gt;
    &lt;h4&gt;Total&lt;/h4&gt;
    &lt;b&gt;Monthly: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>price</span> <span>+</span> <span>self</span><span>.</span><span>chargesPrice</span><span>}</span><span>&lt;br&gt;
    &lt;b&gt;Initial: &lt;/b&gt;</span><span>{</span><span>self</span><span>.</span><span>caution</span> <span>+</span> <span>self</span><span>.</span><span>agencyFee</span><span>}</span><span>&lt;br&gt;&lt;br&gt;
    &lt;a href=&#34;</span><span>{</span><span>self</span><span>.</span><span>link</span><span>}</span><span>&#34; target=&#34;_blank&#34;&gt;Page&lt;/a&gt;&lt;br&gt;
    &lt;a href=&#34;</span><span>{</span><span>self</span><span>.</span><span>galleryLink</span><span>}</span><span>&#34; target=&#34;_blank&#34;&gt;Gallery&lt;/a&gt;&lt;br&gt;
    &#34;&#34;&#34;</span></code></pre>
</div>
</div>
<div>
<p><img src="https://mattrighetti.com/assets/images/popup.png" alt="popup"/>
</p>
</div>
<p>That’s just what I wanted, I can now see on the map which are the best
located apartments in Lux and immediately get to see the info that I’m
interested in the most!</p>
<p>Why would I save the data on a database if I don’t use SQL at all?
Let’s say that I have a base budget of 1000€ and I want to show only
the apartments on which I would have to spend an incremental amount of 200€,
I could simply change the SQL query to</p>
<div>
<div>
<pre><code data-lang="sql"><span>SELECT</span> <span>*</span>
<span>FROM</span> <span>apartment</span>
<span>WHERE</span>
    <span>found</span> <span>=</span> <span>TRUE</span> <span>AND</span>
    <span>listingId</span> <span>IN</span> <span>(</span>
        <span>SELECT</span> <span>listingId</span>
        <span>FROM</span> <span>apartment</span>
        <span>WHERE</span>
            <span>found</span> <span>=</span> <span>TRUE</span> <span>AND</span>
            <span>price</span> <span>+</span> <span>chargesPrice</span> <span>&lt;</span> <span>1000</span> <span>+</span> <span>200</span>
    <span>)</span></code></pre>
</div>
</div>
<p>Phewww, if you’re still here reading all this you deserve a bonus point.</p>
<p>Imagine I saw a very cool apartment that looks like a very good deal but
it’s a bit out of the city, what’s the best way to know how much it is going
to take me to get from that apartment to my point of interest with public transportation?</p>
<p>If you paid close attention to the image above you might already know the answer,
Google Maps of course! Google Maps is very cool, you can get directions from
position x to position y by visiting <code>www.google.com/maps/dir/x.lat,x.lon/y.lat,y.lon</code>.</p>
<p>All I need to do is add <code>&lt;a href=&#34;{self.mapsDir}&#34; target=&#34;_blank&#34;&gt;Maps Directions&lt;/a&gt;</code>
to the popup dialog I pasted above and I will have a very handy link that
will open Google Maps on a new tab with the time travel from position x to y.</p>
<p>This will save me so much time, you have no idea!</p>
<p>Why don’t we finish this by completing our justfile? In the end I
want to type a single command and be shown the map with all the apartments
that I saved on my file.</p>
<div>
<div>
<pre><code data-lang="justfile">open:
    DB_PATH={{db_path}} \
    jupyter notebook \
    {{base}}/analyzer/apartments.ipynb

show: fetch open</code></pre>
</div>
</div>
<p>That is so convenient, I can finally only look at pictures of cool
apartments, save the link on my file and at the end of the day type</p>

<p>Life is good now, at least I made the process funnier and more efficient
than before!</p>
<p>The only thing that is <em>very slow</em> at the moment is the first js snippet,
it takes ~1s to get a single apartment, multiply
that for 100 apartments and you will have to wait for a couple of minutes before
seeing all the pins on the map. The immediate solution would be to make multiple
page requests at a time but I’m not much of an expert with `Promise`s so I think
I’ll stick with this solution until I’m not bored again to wait
for the tool to scrape each link.</p>
<p>I now need to get back to hunting that apartment, wish me luck!</p>
</article>

</div></div>
  </body>
</html>
