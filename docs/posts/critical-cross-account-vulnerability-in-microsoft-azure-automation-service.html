<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://orca.security/resources/blog/autowarp-microsoft-azure-automation-service-vulnerability/">Original</a>
    <h1>Critical cross-account vulnerability in Microsoft Azure automation service</h1>
    
    <div id="readability-page-1" class="page"><div>
                            <p><span>AutoWarp is a <strong>critical vulnerability</strong> in the Azure Automation service that allowed <strong>unauthorized access</strong> to other Azure customer accounts using the service. This attack could mean full control over resources and data belonging to the targeted account, depending on the permissions assigned by the customer.</span></p>
<p><span>Our research showed that multiple large companies were using the service and could have been accessed, putting billions of dollars at risk. We reported this issue directly to Microsoft, it is now fixed, and all impacted customers have been notified.</span></p>
<h4><b>Were You Vulnerable to AutoWarp?</b></h4>
<p><span>You have been vulnerable to AutoWarp before the vulnerability was fixed if:</span></p>
<ol>
<li><span>You have been using the Azure Automation service</span></li>
<li>The Managed Identity feature in your automation account is enabled (which is enabled by <b>default</b><span>)</span></li>
</ol>
<h4><a href="https://orca.security/wp-content/uploads/2022/03/Azure_AutoWarp_v1-1.gif"><img src="https://orca.security/wp-content/uploads/2022/03/Azure_AutoWarp_v1-1.gif" alt="" width="962" height="658"/></a></h4>
<div>
<h4><b>AutoWarp Discovery Timeline</b></h4>
<ul>
<li><span>December 6, 2021: We’ve begun our research, discovered the vulnerability, and reported it to Microsoft.</span></li>
<li><span>December 7, 2021: We discovered large companies at risk (including a global telecommunications company, two car manufacturers, a banking conglomerate, big four accounting firms, and more). </span></li>
<li><span>December 10, 2021: Microsoft fixed the issue and started looking for additional variants of this attack.</span></li>
<li><span>March 7, 2022: Public disclosure following Microsoft’s investigation conclusion.</span></li>
</ul>
</div>
<h4><strong>Microsoft’s Statement</strong></h4>
<blockquote><p><span>“We want to thank Yanir Tsarimi from Orca Security who reported this vulnerability and worked with the Microsoft Security Response Center (MSRC) under </span><a href="https://www.microsoft.com/en-us/msrc/cvd"><span>Coordinated Vulnerability Disclosure (CVD)</span></a><span> to help keep Microsoft customers safe.”</span></p>

<p><span>-Microsoft Security Response Center (MSRC)</span></p></blockquote>

<p><span>Microsoft responded to this incident in the blog <a href="https://msrc-blog.microsoft.com/2022/03/07/13943/">here</a>.</span></p>
<p><span>Microsoft also recommends its Automation customers to follow Security best practices outlined </span><a target="_blank" data-stringify-link="https://docs.microsoft.com/en-us/azure/automation/automation-security-guidelines" delay="150" data-sk="tooltip_parent" href="https://docs.microsoft.com/en-us/azure/automation/automation-security-guidelines" rel="noopener noreferrer" data-remove-tab-index="true" tabindex="-1">here</a><span>.</span></p>
<h4><b>What Is the Microsoft Azure Automation Service?</b><span> </span></h4>
<p><span>Microsoft Azure Automation allows customers to execute automation code in a managed fashion. You can schedule jobs, provide input and output, and more. Each customer’s automation code runs inside a sandbox, isolated from other customers’ code executing on the same virtual machine.  </span><span> </span></p>
<h4><b>AutoWarp: </b><b>The Azure Automation Security Flaw</b><span> </span></h4>
<p><span>We found a serious flaw that allowed us to interact with an internal server that manages the sandboxes of other customers. We managed to obtain authentication tokens for other customer accounts through that server. Someone with malicious intentions could’ve continuously grabbed tokens, and with each token, widen the attack to more Azure customers.</span></p>

<h4><strong>Full Technical Details – Researcher Point of View</strong></h4>
<p><span>I was scrolling through the Azure services list, looking for my next service to research. Seeing “Automation Accounts” under the “Management &amp; Governance” category caught me off guard. I thought it was some kind of service allowing me to control Azure accounts with automation.</span></p>
<p><span>After creating my first automation account, I realized that Azure Automation is a pretty standard service for (unsurprisingly) automation scripts. You can upload your Python or PowerShell script to execute on Azure. </span></p>
<p><span>What I love most about research is exploring the unknown, so the first thing I did was explore the file system to see what juicy stuff I might find. I started a reverse shell from my automation script, making the work against the server much smoother.</span></p>
<p><span>Setting a reverse shell with Python was no problem. However, when I executed some of the common commands like <em>tasklist</em>, I got an error saying they were not found. Apparently, the <em>PathExt</em> environment variable, which is responsible for defining which file extensions the OS should try to execute, is set to a strange value. Usually, it contains the <em>.exe</em> file extension, but not in our case. Only <em>.CPL</em> was there, which is the file extension for Windows Control Panel items. Even when I tried to use <em>tasklist.exe</em> to list the running processes, it gave me a message I’ve never seen before. It looked like something might be up…</span></p>
<p><a href="https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog.png"><img src="https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog.png" alt="" width="600" height="317" srcset="https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog.png 1600w, https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog-300x159.png 300w, https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog-1024x541.png 1024w, https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog-768x406.png 768w, https://orca.security/wp-content/uploads/2022/03/embedded-image_ubuntu_Autowarp_blog-1536x812.png 1536w" sizes="(max-width: 600px) 100vw, 600px"/></a></p>
<p><span>The first two things that caught my attention when I looked at the C:\ drive , were the “Orchestrator” and “temp” directories. The orchestrator directory contained a lot of DLLs and EXEs. I saw filenames with “sandbox” and intuitively I understood that this directory contained the sandbox we were running in. The temp directory contained another directory named “diags” and there was a “trace.log” file.</span></p>
<p><a href="https://orca.security/wp-content/uploads/2022/03/embedded-image_temp_Autowarp_blog.png"><img src="https://orca.security/wp-content/uploads/2022/03/embedded-image_temp_Autowarp_blog.png" alt="" width="600" height="317" srcset="https://orca.security/wp-content/uploads/2022/03/embedded-image_temp_Autowarp_blog.png 1386w, https://orca.security/wp-content/uploads/2022/03/embedded-image_temp_Autowarp_blog-300x158.png 300w, https://orca.security/wp-content/uploads/2022/03/embedded-image_temp_Autowarp_blog-1024x541.png 1024w, https://orca.security/wp-content/uploads/2022/03/embedded-image_temp_Autowarp_blog-768x406.png 768w" sizes="(max-width: 600px) 100vw, 600px"/></a></p>
<p><span>Log files are great for research. In many cases, logs provide very concise and important information. You essentially have a chance to peek inside a diary describing what the developers deemed important. Luckily for me, this was a very good log file. This popped up very early in line 7:</span></p>
<pre>Orchestrator.Sandbox.Diagnostics Critical: 
0 : [2021-12-06T12:08:04.5527647Z]  
Creating asset retrieval web service. 
[assetRetrievalEndpoint=
http://127.0.0.1:40008]
</pre>
<hr/>
<blockquote><p><span>“There’s nothing more exciting than finding out your target exposes a web service. Especially when it’s local AND on a high, seemingly random port.”</span></p>

<p><span>Yanir Tsarimi</span></p>
<p><span>Cloud Security Researcher, </span><span>Orca Security</span></p></blockquote>
<hr/>
<p><span>This just screamed red flags to me. This is what I usually call a “cover” </span><span>–</span><span> A software decision made to cover up for some technical limitation. Why would you choose such a high random port? Because other ports are taken.</span></p>
<p><span>I made an HTTP request to the URL with cURL. It worked but didn’t provide much information on what was going on. I also tried to access the next ports (40009, 40010, and so on). Some of them responded to me, which immediately confirmed my suspicions. The logs made it obvious that the web service was managed by the orchestrator I saw earlier, so I had to understand what was going on. What is this web service?</span></p>
<h4><b>Peeking Inside the Azure Automation Code</b></h4>
<p><span>After downloading the orchestrator’s files, I started ILSpy (.NET decompiler) and started looking for the code for this “asset retrieval web service” as they call it. I looked at the method setting up the HTTP routes and what really popped out was that “/oauth2/token” and “/metadata/identity/oauth2/token” were mapped to a controller called “MSIController”. What I didn’t know at the time is that MSI is an acronym for “Managed Service Identity”. Pretty interesting, right?</span></p>
<p><a href="https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog.png"><img src="https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog-1024x209.png" alt="" width="1024" height="209" srcset="https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog-1024x209.png 1024w, https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog-300x61.png 300w, https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog-768x157.png 768w, https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog-1536x314.png 1536w, https://orca.security/wp-content/uploads/2022/03/embedded-image_MSI_Autowarp_blog.png 1600w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></p>
<p><span>I hadn’t really done much .NET web development or research before, so I inferred from the code that these routes were mapped to the “MSIController” class, which is pretty straightforward if you are familiar with the concept of MVC (Model-View-Controller). It is also interesting to note that some experience in software development helps significantly when reviewing source code – it helps to “read between the lines” in even more complicated cases.</span></p>
<p><a href="https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog.png"><img src="https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog-1024x473.png" alt="" width="1024" height="473" srcset="https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog-1024x473.png 1024w, https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog-300x139.png 300w, https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog-768x355.png 768w, https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog-1536x709.png 1536w, https://orca.security/wp-content/uploads/2022/03/embedded-image_GET_Autowarp_blog.png 1600w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></p>
<p><span>I started making HTTP requests to /oauth2/token, and I adjusted my request to look like a metadata request (add “Metadata: True” HTTP header) and add the resource parameter. I wanted the token to be usable by Azure management APIs, so I used “resource=</span><a href="https://managment.azure.com/"><span>https://managment.azure.com/</span></a><span>”. The request simply returned a JWT (JSON Web Token). Uh-oh.</span></p>
<p><span>Now, who was the identity behind this token? I decoded the token and saw my subscription ID, tenant ID, and my automation account resource ID. I looked up “Azure Automation Identity” online and found that each automation account has a “system-assigned managed identity”, which basically means you can assign roles to your automation scripts and the identity is managed by the service. Cool.</span></p>
<p><span>So I wanted to test to see if my token was the real deal. I used the Azure CLI to make a simple request to get all my VMs (“az vm list”) and intercepted the request, and swapped the token. I got an error that I didn’t have enough permissions. Duh, I didn’t assign any role to my managed identity. After assigning a compatible role, the token worked. The token was actually linked to my managed identity!</span></p>
<h4><b>Where Things Got Bad</b></h4>
<p><span>So a token that’s linked to a managed identity is not an issue in itself. You are supposed to be able to get a token for your own managed identity. But if you’ve been following, there were additional ports accessible locally. Each time I ran an automation job, I saw the port changing, but it remained around the same range. </span></p>
<p><span>I wrote up a quick Python script to make HTTP requests to 20 ports starting from 40,000. It was simple to do:</span></p>
<pre>import requests

PORT_RANGE_START = 40000
PORTS_TO_SCAN = 1000

print(&#34;Making requests to ports 40000 and up...&#34;)
for port in range(PORT_RANGE_START, PORT_RANGE_START + PORTS_TO_SCAN):
    try:
        resp = requests.post(f&#34;http://127.0.0.1:{port}/oauth2/token&#34;, 
timeout=0.5, headers={&#39;Metadata&#39;: &#39;True&#39;}, data={&#39;resource&#39;: 
&#39;https://management.azure.com/&#39;})
        print(f&#34;Port {port}: {resp.json()}&#34;)
    except Exception as e:
        continue</pre>
<p><span>Random ports gave me JWT tokens. I executed the script a few more times and different ports gave me different tokens! It was obvious to me that I was actually accessing other people’s identity endpoints. I already proved that these tokens could be used to manage the Azure account, if given enough permissions, so accessing data of other tenants was not necessary.</span></p>
<p><a href="https://orca.security/wp-content/uploads/2022/03/embedded-image_token_Autowarp_blog.png"><img src="https://orca.security/wp-content/uploads/2022/03/embedded-image_token_Autowarp_blog.png" alt="" width="800" height="93" srcset="https://orca.security/wp-content/uploads/2022/03/embedded-image_token_Autowarp_blog.png 1070w, https://orca.security/wp-content/uploads/2022/03/embedded-image_token_Autowarp_blog-300x35.png 300w, https://orca.security/wp-content/uploads/2022/03/embedded-image_token_Autowarp_blog-1024x119.png 1024w, https://orca.security/wp-content/uploads/2022/03/embedded-image_token_Autowarp_blog-768x89.png 768w" sizes="(max-width: 800px) 100vw, 800px"/></a></p>
<p><span>We wanted to understand how far this simple flaw could go. We used the schedules feature of Azure Automation to try grabbing tokens from a few hundred ports and seeing which tenants came up. We did not store the token and only extracted the metadata about the tenant (tenant ID and automation account resource ID). </span></p>
<p><span>In this short period of time, before the issue was patched, we saw many unique tenants, including several very well-known companies! And this was just from a scheduled run every hour. If we ran continuously, it’s likely we would have captured much more (It’s expected the identity endpoint goes down as soon as the automation job finishes, so you’d have to grab it really fast in some cases).</span></p>
<p><span>This was a fairly simple flaw that manifested into a very interesting and fun vulnerability. It’s unclear what was missing here, the identity endpoint could have required some form of authentication (other endpoints on this server certainly did). Or maybe someone overlooked the fact that the internal network inside the machine is not actually sandboxed as you might expect.</span></p>
<h4><b>The Aftermath of the AutoWarp Microsoft Azure Automation Vulnerability</b></h4>
<p><span>I reported the flaw to Microsoft the same day. I would like to thank them for being so responsive and cooperative in the responsible disclosure process. Microsoft decided to patch this issue by requiring the “X-IDENTITY-HEADER” HTTP header when requesting identities. You must set the value to the secret value set in your environment variables. They also mentioned they are performing an overall review of their architecture to make sure things like this don’t happen again!</span></p>
<p><a href="https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog.png"><img src="https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog.png" alt="" width="800" height="125" srcset="https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog.png 1600w, https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog-300x47.png 300w, https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog-1024x160.png 1024w, https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog-768x120.png 768w, https://orca.security/wp-content/uploads/2022/03/embedded-image_automationacc_Autowarp_blog-1536x240.png 1536w" sizes="(max-width: 800px) 100vw, 800px"/></a></p>
<p><span>We are happy that we found this issue before it landed in the wrong hands. We would like to thank Microsoft for working with us and fixing this issue swiftly and professionally. Our focused research towards cloud providers will continue and you can expect to hear more from us soon.</span></p>
<p><span>AutoWarp, and previous critical cloud vulnerabilities such as </span><a href="https://orca.security/resources/blog/aws-glue-vulnerability/"><span>AWS Superglue</span></a><span> and </span><a href="https://orca.security/resources/blog/aws-cloudformation-vulnerability/"><span>BreakingFormation</span></a><span> show that nothing is bulletproof and there are numerous ways attackers can reach your cloud environment. That’s why it’s important to have complete visibility into your cloud estate including the most critical attack paths. To help, </span><span>I invite you to experience our tech and talent first-hand with a no-obligation, </span><a href="https://orca.security/lp/cloud-security-risk-assessment/?utm_source=blog&amp;utm_medium=blog&amp;utm_campaign=22-azure-vulnerabilities&amp;utm_content=autowarp"><span>free cloud risk assessment</span></a><span>. You’ll get complete visibility into your public cloud, a detailed risk report with an executive summary, and time with our cloud security experts.</span></p>
<ul>
<li><img src="https://orca.security/wp-content/uploads/2021/12/icon_vulnerability.svg"/>
<p>Discover Your Cloud Vulnerabilities In Minutes</p>
<p>Scan your entire AWS, Azure, and Google Cloud environments for vulnerabilities with <a href="https://orca.security/lp/cloud-security-risk-assessment/?utm_source=blog&amp;utm_medium=blog&amp;utm_campaign=22-azure-vulnerabilities&amp;utm_content=autowarp">Orca Security’s free, no obligation risk assessment</a>.</p>
</li>
</ul>

</div></div>
  </body>
</html>
