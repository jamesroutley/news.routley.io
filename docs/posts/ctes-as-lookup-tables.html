<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://misfra.me/2023/ctes-as-lookup-tables/">Original</a>
    <h1>CTEs as lookup tables</h1>
    
    <div id="readability-page-1" class="page"><section>
<p>In the past I’ve had to write queries to convert data in a table into user-friendly display text.
One way to do this is with CASE expressions. For example, let’s say you have a table with a column being a country code,
and you want to add the country name in the final result.</p>

<pre><code>sqlite&gt; SELECT code FROM data;
+------+
| code |
+------+
| us   |
| fr   |
| in   |
+------+
</code></pre>

<p>One approach is to use a CASE expression in your query like this:</p>

<pre><code>sqlite&gt; SELECT code,
   ...&gt; CASE code 
   ...&gt;   WHEN &#39;us&#39; THEN &#39;United States&#39;
   ...&gt;   WHEN &#39;fr&#39; THEN &#39;France&#39;
   ...&gt;   WHEN &#39;in&#39; THEN &#39;India&#39;
   ...&gt;  END AS country
   ...&gt; FROM data;
+------+---------------+
| code |    country    |
+------+---------------+
| us   | United States |
| fr   | France        |
| in   | India         |
+------+---------------+
</code></pre>

<p>The downside is that it’s harder to read, and if you need to do something similar elsewhere in the query, you’ll
have to repeat the expression.</p>

<p>An alternative is to use a CTE like this:</p>

<pre><code>sqlite&gt; WITH countries (code, name) AS (
   ...&gt;   SELECT * FROM (VALUES
   ...&gt;     (&#39;us&#39;, &#39;United States&#39;), (&#39;fr&#39;, &#39;France&#39;), (&#39;in&#39;, &#39;India&#39;)
   ...&gt;   ) AS codes
   ...&gt; )
   ...&gt; SELECT data.code, name FROM data LEFT JOIN countries ON countries.code = data.code;
+------+---------------+
| code |     name      |
+------+---------------+
| us   | United States |
| fr   | France        |
| in   | India         |
+------+---------------+
</code></pre>

<p>Now the <code>countries</code> CTE becomes a lookup table that you can reference several times in your queries.</p>

<p>This approach works with SQLite and PostgreSQL.</p>

</section></div>
  </body>
</html>
