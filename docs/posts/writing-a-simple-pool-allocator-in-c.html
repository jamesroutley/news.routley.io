<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://8dcc.github.io/programming/pool-allocator.html">Original</a>
    <h1>Writing a simple pool allocator in C</h1>
    
    <div id="readability-page-1" class="page"><div id="text-the-chunk-type">
<p>
In our simple implementation, we will declare a <code>Chunk</code> type with a fixed size. In
a more general implementation, we would use a chunk size specified by the
programmer at runtime, but that method adds a lot of casts, and I think it would
make this article more confusing.
</p>

<p>
First, let’s have a look at the definition of <code>Chunk</code>.
</p>

<div>
<pre><span>#define</span> <span>CHUNK_SZ</span> <span>64</span>

<span>typedef</span> <span>union</span> <span>Chunk</span> <span>Chunk</span>;
<span>union</span> <span>Chunk</span> {
    <span>Chunk</span>* <span>next</span>;
    <span>char</span> <span>arr</span>[CHUNK_SZ];
};
</pre>
</div>

<p>
Notice how we are <code>typedef</code>’ing a <code>union</code>, not a <code>struct</code>.
</p>

<p>
If you are not familiar with C <code>union</code>’s, they are syntactically similar to
<code>struct</code>’s, but they can be used to define variables that may hold (at different
times) objects of different types and sizes; as opposed to structures, which let
the programmer <i>group</i> different data types as a single record. Unions essentially
let the programmer access the data in a <i>single area of storage</i> as if it were
storing one of many <i>data types</i> at a given time. When you access a <i>member</i> of a
union variable (e.g. <code>my_chunk.next</code> or <code>my_chunk.arr</code>), the compiler is responsible
for accessing the <code>union</code> variable as if it were the specified member type (in
that example, either a pointer or an array of <code>CHUNK_SZ</code> characters, never both).
</p>

<p>
In this case, using a <code>union</code> is convenient because it lets us “interpret” the
<code>Chunk</code> as a pointer to another <code>Chunk</code> depending on the context, while also
specifying the real size of the <code>Chunk</code> (i.e. <code>CHUNK_SZ</code>). Also note that the size
of a union is the size of the <i>biggest possible member</i> (in a 64-bit computer,
<code>sizeof(Chunk*)</code> is 8 bytes, and since the <code>arr</code> member is 64 bytes, that will be
the size of the <code>Chunk</code> union).
</p>

<p>
However, it’s still not clear why we would need to interpret the <code>Chunk</code> as a
pointer depending on the context. First, we need to understand that there will
be two (implicit) types of chunks:
</p>

<ol>
<li><b>Free chunks</b>: They are not in use by the program. They will use the <code>next</code>
pointer.</li>
<li><b>Non-free chunks</b>: They have been allocated, so we assume they contain
arbitrary user data. Specifically, in this implementation, each chunk can
contain (at most) <code>CHUNK_SZ</code> bytes of data.</li>
</ol>

<p>
As mentioned, these types are “implicit”. This means that there isn’t any <code>flags</code>
variable that lets us know whether a specified chunk is free; instead, we know
that a chunk is free because it will be inside a <i>linked list</i> of free
chunks. When we initialize the pool, since all chunks are free, we will use the
<code>Chunk.next</code> pointer to link each chunk to its adjacent one, like this:
</p>


<div id="fig1">
<p><img src="https://8dcc.github.io/img/pool-allocator1.svg" alt="pool-allocator1.svg"/>
</p>
<p><span>Figure 1: </span>Four free chunks right after initializing the pool.</p>
</div>

<p>
The gray area represents the rest of the union that is not used when accessing
<code>Chunk.next</code>, and the incomplete red arrow represents a <code>NULL</code> pointer. The creation
of this linked list, along with its advantages, will be explained when <a href="#creating-the-pool">creating
the pool</a> below.
</p>
</div></div>
  </body>
</html>
