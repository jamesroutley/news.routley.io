<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://zmatt.net/unlocking-my-lenovo-laptop-part-1/">Original</a>
    <h1>Unlocking my Lenovo laptop, part 1 (2016)</h1>
    
    <div id="readability-page-1" class="page"><div>
						<h3>Introduction</h3>
<p>Two months ago, I bought a new battery for my Lenovo laptop (a ThinkPad X230T).  I was about to go away on holidays and wanted a battery that could last me through a plane flight; the original battery was by then barely lasting ten minutes.  Little did I know that I was about to be in for an adventure.<span id="more-214"></span></p>
<p>I installed the new battery, and everything went fine for a few hours… that is, until I had to plug the laptop in to charge.  The battery was not charging.  Odd.  I rebooted, only to find this message displayed on the screen by the BIOS:</p>
<blockquote><p><strong>The system does not support batteries that are not genuine Lenovo-made or authorized. The system will continue to boot, but may not charge unauthorized batteries.</strong></p><strong>
<p>ATTENTION: Lenovo has no responsibility for the performance or safety of unauthorized batteries, and provides no warranties for failures or damage arising out of their use.</p>
</strong><p><strong>Press the ESC key to continue.<br/>
</strong></p></blockquote>
<p>“May not charge”?  That was quite a non-definite message, but this battery was definitely not charging, even with the laptop off.  Oh dear.</p>
<p>Now certainly at this point it was possible that the battery was faulty in addition to being non-genuine, but I did not like this idea of Lenovo locking me down to using only ‘genuine’ batteries.  Firstly, I had a battery in my hands that might have been working perfectly fine otherwise.  Secondly, it meant that Lenovo could charge artificially high prices for their ‘genuine’ batteries.  Thirdly, should Lenovo discontinue replacement batteries for my laptop, I would indeed be left with a useless laptop.</p>
<h3>First steps: investigating the battery</h3>
<p>My first avenue of investigation would be to ‘sniff’ the communication between the laptop and the two batteries, to compare the replacement battery to the original battery.  I easily found the pin-out for Lenovo batteries on the Internet, which for easy reference is:</p>
<table>
<tbody><tr>
<th>Pin</th>
<th>Name</th>
<th>Description</th>
</tr>
<tr>
<td>1,2</td>
<td>VBATT (+)</td>
<td>Battery voltage (or charging voltage)</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>SCL</td>
<td>SMBus clock</td>
</tr>
<tr>
<td>4</td>
<td>SDA</td>
<td>SMBus data</td>
</tr>
<tr>
<td>5</td>
<td>T</td>
<td>Thermistor</td>
</tr>
<tr>
<td>6,7</td>
<td>GND (-)</td>
<td>Ground</td>
</tr>
</tbody></table>
<p>In this case I was interested in the communication that happens via the <a href="https://en.wikipedia.org/wiki/System_Management_Bus">SMBus</a> pins, SCL and SDA.  To sniff this communication, I used a basic logic analyser that I had at hand (a <a href="http://www.usbee.com/sx.html">USBee SX</a>).  Conveniently, there is enough spare length in the battery contacts that it is possible to tap out signals while the battery is connected to the system as you can see in this photo:</p>
<p><img src="https://blog.bridge.watch/wp-content/uploads/2016/01/usbee1.jpg" alt="Connecting to battery SMBus pins" width="600" height="450" srcset="https://zmatt.net/wp-content/uploads/2016/01/usbee1.jpg 600w, https://zmatt.net/wp-content/uploads/2016/01/usbee1-300x225.jpg 300w" sizes="(max-width: 600px) 100vw, 600px"/></p>
<p>(Trick 1: I soldered two 2-pin headers end-to-end (<img src="https://blog.bridge.watch/wp-content/uploads/2016/01/headers.png" alt="headers" width="25" height="9"/>) such that the end pins could be wedged around the SDA/SCL contacts, the middle could pass through the narrow gap to the outside of the laptop, and the logic analyser could be connected to the end header.)</p>
<p>(Trick 2: Ground can be attached to the VGA connector, this is a generally useful trick when probing laptops.)</p>
<p><a href="https://blog.bridge.watch/wp-content/uploads/2016/01/usbee2.jpg"><img src="https://blog.bridge.watch/wp-content/uploads/2016/01/usbee2.jpg" alt="USBee SX software" width="600" height="450" srcset="https://zmatt.net/wp-content/uploads/2016/01/usbee2.jpg 600w, https://zmatt.net/wp-content/uploads/2016/01/usbee2-300x225.jpg 300w" sizes="(max-width: 600px) 100vw, 600px"/></a></p>
<p>The USBee SX software has the advantage of having built-in I2C/SMBus decoding at a single click.  I don’t find the output particularly readable though, so I put it through a quick one-liner to clean it up a bit (perl -pe ‘s/\n/ /gs’ |sed ‘s/[[:space:]]\+/ /g;s/START/\nSTART/g;s/ACK \([0-9A-F]\) /ACK 0\1 /g;s/ ACK / /g’).  I’ve uploaded the SMBus captures from the original and replacement batteries <a href="https://blog.bridge.watch/wp-content/uploads/2016/02/original1.txt">here</a> and <a href="https://blog.bridge.watch/wp-content/uploads/2016/02/replacement1.txt">here</a> for those interested.</p>
<p>Now, for those not in the know, most modern smart batteries implement a standard called <a href="http://sbs-forum.org/specs/sbdat110.pdf">Smart Battery Specification (SBS)</a>.  The communication that we’ve just captured is, indeed, based around the Smart Battery Specification, albeit using a few vendor-specific commands.</p>
<p>I’ve decoded the communication according to the SBS protocol below.  I’ve interleaved the two batteries, with <span>green</span> being the original battery and <span>black</span> being the replacement battery.  I’ve called out interesting lines with <span><strong>bold red</strong></span> annotation that I’ll refer to below.</p>
<hr/>
<p><span>Read SpecificationInfo -&gt; 0x0031 (SBS 1.1 with PEC support)</span></p>
<p><span><strong>(authentication sequence 1)</strong></span></p>
<p><span>Read unknown 0x35 -&gt; 0x00c0</span></p>
<p><span><strong>(authentication sequence 2)</strong></span></p>
<hr/>
<p>First, some minor differences:</p>
<ul>
<li>The replacement battery has a bug / feature where it generates the wrong packet checksum (PEC) on the first access <span><strong>(1)</strong></span>.  However, the laptop is happy enough trying again.</li>
<li>The replacement battery reports that it has an integrated charge controller whereas the original battery doesn’t <span><strong>(2)</strong></span>.</li>
<li>The replacement battery reports a manufacturer of SANYO whereas the original battery reports a manufacturer of LGC <span><strong>(3)</strong></span>.  In fact, Lenovo batteries are made by both Sanyo and LG Chem; I suspect that whoever made my replacement battery just happened to be cloning a Sanyo-made battery.</li>
<li>The original battery responds to the manufacturer-specific function OptionalMfgFunction5 with something that looks like a serial number <span><strong>(4)</strong></span>.</li>
</ul>
<p>It turns out that all of these minor differences can be ignored.  The interesting parts are the authentication sequences:</p>
<ul>
<li><span><strong>Authentication sequence 1</strong></span>: The laptop writes 4 bytes using the manufacturer-specific command OptionalMfgFunction4 (0x3c) and then reads 12+4 bytes using the same command.  In this case, the outgoing message sends a four byte challenge and the response is the string “Lenovo Japan” followed by a four byte response that depends on the challenge (this is a form of <a href="https://en.wikipedia.org/wiki/Challenge%E2%80%93response_authentication">challenge-response authentication</a>).</li>
<li><span><strong>Authentication sequence 2</strong></span>: The laptop writes 17 bytes with command 0x27 and reads 8+17 bytes with command 0x28. These commands are not defined in the Smart Battery Specification. Again, it will turn out that this is a sort of challenge-response authentication.</li>
</ul>
<p>It is not clear why there are two different authentication steps, but perhaps the first one has previously been broken: this is, after all, a cat-and-mouse game between Lenovo and those who have an interest in circumventing their scheme.  Neither authentication scheme is implemented in my replacement battery.</p>
<p>(The line marked <span><strong>(5)</strong></span> is just to draw attention to the embarrassing situation where my 62Wh original battery, after two years, now has a full capacity of just under 2Wh.)</p>
<h3>Attacking the problem</h3>
<p>Now that we understand approximately how the battery is authenticated, the next question is how we might circumvent this authentication.  There are a number of possible options.</p>
<p><em>Option 1: Replace just the used Li-Ion cells in the original battery, preserving the original controller</em></p>
<p>This is a common approach to battery reconditioning.  However, there are a number of pitfalls.  Getting the Lenovo batteries apart necessarily involves damaging the plastic to some extent, as the seams have both latches and glue.  Also, replacing cells needs to be done carefully as some controllers can brick themselves if the battery voltage is disconnected (I do not know whether this is the case for the Lenovo batteries).  The problematic corollary is that the controller will remember data about the old cells, and I’m not sure what effect this might have.</p>
<p>I decided not to go down this path except as a last resort.  I did – after getting my replacement battery working – pull apart the original battery for my own edification, and I might comment more on this in a later post.</p>
<p><em>Option 2: Modify the firmware on the non-genuine battery to emulate the genuine battery</em></p>
<p>“Modify the firmware on a battery?”, you say incredulously.  Yes, in fact smart batteries run firmware, and usually this firmware is updateable.  For example, the TI BQ20Z80 battery fuel gauge chip is known to have an embedded ARC microprocessor and flash memory, and has been reverse engineered sufficiently that it is in fact practical to download/upload/modify the firmware (see Charlie Millers’s Blackhat talk on <a href="https://media.blackhat.com/bh-us-11/Miller/BH_US_11_Miller_Battery_Firmware_Public_WP.pdf">Battery Firmware Hacking</a>).</p>
<p>There are two angles to this.  Firstly, if we could download the firmware from the genuine battery, we would perhaps be able to work out the authentication algorithm.  Secondly, if we could upload new firmware to a non-genuine battery, we could implement the authentication algorithm on the new battery.</p>
<p>At this point I hooked up the SMBus lines of both batteries to a microcontroller so I could send commands to them independent of the laptop.  I used an Arduino just because it’s what I had readily at hand, although any microcontroller (preferably 3.3V) would work fine.</p>
<p>Unfortunately, I got nowhere with this: while all the standard SBS commands worked, neither battery responded to any TI vendor-specific commands that I tried.  This makes me think that neither uses a TI chip or they are well locked down.  The non-genuine battery responded to ManufacturerAccess command 0x0001 with 0x2168 (some sort of device ID perhaps?), while the genuine battery did not appear to respond to ManufacturerAccess in any useful way.</p>
<p>Given that I had no idea what chip was inside either battery – and even if I knew that, I might not have been able to get enough information to hack the firmware – I decided to shelve this option temporarily.</p>
<p><em>Option 3: Interpose between the laptop and the battery</em></p>
<p>Another option would be to add a small embedded microcontroller in between the laptop and battery which would answer the authentication commands if the battery cannot.  (In fact it may not be necessary to interpose in the strict sense, it is probably sufficient just to sit on that bus.)</p>
<p>There is some spare space in the Thinkpad’s mini-PCIe slot so it would be possible to run wires from the SMBus lines down to that bay.  However, adding extra electronics to the laptop is non-ideal, and at this point we still don’t know how to actually calculate the responses to the authentication challenges.</p>
<p><em>Option 4: Modify the ThinkPad embedded controller firmware</em></p>
<p>Clearly if we could modify the laptop to skip the battery authentication, that would solve all of our problems.  Since the battery authentication happens even when the laptop is switched off, it cannot be BIOS that is doing the authentication (BIOS runs on the main system processors, and does not run when the system is switched off).  Therefore the authentication must be being performed by another part of the system: the embedded controller.</p>
<p>We turn to the embedded controller in <a href="https://blog.bridge.watch/unlocking-my-lenovo-laptop-part-2/">part 2</a> of this series…</p>
											</div></div>
  </body>
</html>
