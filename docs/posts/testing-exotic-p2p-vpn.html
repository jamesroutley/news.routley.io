<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.nommy.moe/blog/exotic-mesh-vpn/">Original</a>
    <h1>Testing “Exotic” P2P VPN</h1>
    
    <div id="readability-page-1" class="page"><div><p>My standard &#34;everyday&#34; solution when it comes to connecting computers into a single network is Wireguard. </p><p>The downsides come from having part of my home infrastructure located in territory controlled by a country that has blocked Wireguard by signatures. </p><p>So it&#39;s time for penetration.</p><p>Actually, there are several projects that allow obfuscating Wireguard traffic and punching through firewalls. </p><p>But the main problem with obfuscation is the reduction of effective packet MTU. Because we wrap one packet in another packet, and this overhead takes up space. </p><ul><li><p><strong>p2p mesh network</strong> </p></li><li><p><strong>Open source and selfhosted</strong></p></li><li><p><strong>Ideologically correct VPN</strong> </p></li><li><p><strong>Not Wireguard</strong> </p></li><li><p><strong>Packaged in nixpkgs</strong></p></li></ul><h2 id="easytier">EasyTier</h2><p><a href="https://github.com/EasyTier/EasyTier">GitHub</a>, <a href="https://easytier.cn/en/">Official site</a></p><p>This is probably the simplest way to create a p2p network. So simple that there isn&#39;t even a module in nixpkgs to run it.</p><p>For security, there&#39;s only a password in <code>--network-secret</code>, which is used for traffic encryption.</p><p>To work, it immediately opens TCP, UDP, WG, WS, WSS and whatever Lucifer&#39;s IT department cooked up. If one gets blocked, it&#39;ll break through via another.</p><p>Essentially all nodes in the network are identical and you can specify multiple peers for initial connection establishment. </p><p>By the way, it has clients for Android, Windows and Mac OS, so it&#39;s a good time to dig out those old games you didn&#39;t finish in childhood and organize LAN party with friends who aren&#39;t very tech-savvy.</p><p>The main disadvantage is that you can&#39;t bind IP addresses to specific machines.</p><p>And yes, this is a project from China, which might not appeal to some for ideological reasons, but personally I hope it was created by enthusiasts specifically for breaking through the Great Firewall of China.</p><details><summary>Configuration example</summary> <pre data-lang="nix"><code data-lang="nix"><span>{
</span><span>  </span><span>networking</span><span>.</span><span>firewall </span><span>= {
</span><span>    </span><span>allowedTCPPorts </span><span>= [ </span><span>11010 11011 11012 </span><span>];
</span><span>    </span><span>allowedUDPPorts </span><span>= [ </span><span>11010 11011 11012 </span><span>];
</span><span>  };
</span><span>
</span><span>  </span><span>environment</span><span>.</span><span>systemPackages </span><span>= [ </span><span>pkgs</span><span>.</span><span>easytier </span><span>];
</span><span>  </span><span>systemd</span><span>.</span><span>services</span><span>.&#34;</span><span>easytier</span><span>&#34; = {
</span><span>    </span><span>enable </span><span>= </span><span>true</span><span>;
</span><span>    </span><span>script </span><span>= &#34;</span><span>easytier-core -d --network-name sumeragi --network-secret changeme -p tcp://public.easytier.cn:11010 --dev-name et0 --multi-thread</span><span>&#34;;
</span><span>    </span><span>serviceConfig </span><span>= {
</span><span>      </span><span>Restart </span><span>= &#34;</span><span>always</span><span>&#34;;
</span><span>      </span><span>RestartMaxDelaySec </span><span>= &#34;</span><span>1m</span><span>&#34;;
</span><span>      </span><span>RestartSec </span><span>= &#34;</span><span>100ms</span><span>&#34;;
</span><span>      </span><span>RestartSteps </span><span>= </span><span>9</span><span>;
</span><span>      </span><span>User </span><span>= &#34;</span><span>root</span><span>&#34;;
</span><span>    };
</span><span>    </span><span>wantedBy </span><span>= [ &#34;</span><span>multi-user.target</span><span>&#34; ];
</span><span>    </span><span>after </span><span>= [ &#34;</span><span>network.target</span><span>&#34; ];
</span><span>    </span><span>path </span><span>= </span><span>with </span><span>pkgs</span><span>; [
</span><span>      </span><span>easytier
</span><span>      </span><span>iproute2
</span><span>      </span><span>bash
</span><span>    ];
</span><span>  };
</span><span>}
</span></code></pre></details><h2 id="nebula">Nebula</h2><p><a href="https://github.com/slackhq/nebula">GitHub</a>, <a href="https://nebula.defined.net/docs/">Official site</a></p><p>This is a more pompous commercial solution from the creators of Slack.</p><p>It has elliptic curve encryption, suggests using its own PKI and looks generally reliable. </p><p>For its operation it requires &#34;lighthouses&#34; that will connect all other nodes. </p><p>Among the nice features there&#39;s a firewall and zoning, to build slightly more complex networks than &#34;everyone with everyone.&#34;</p><p>And also Nebula&#39;s interface is absolutely shit. </p><details><summary>ConfigurationExample</summary> <pre data-lang="nix"><code data-lang="nix"><span>let
</span><span>  </span><span>isLighthouse </span><span>= </span><span>if </span><span>(</span><span>config</span><span>.</span><span>networking</span><span>.</span><span>hostName </span><span>== &#34;</span><span>lighthouse</span><span>&#34;) </span><span>then </span><span>true </span><span>else </span><span>false</span><span>;
</span><span>in
</span><span>{
</span><span>  </span><span>services</span><span>.</span><span>nebula</span><span>.</span><span>networks</span><span>.</span><span>sumeragi </span><span>= {
</span><span>    </span><span>enable </span><span>= </span><span>true</span><span>;
</span><span>    </span><span>ca </span><span>= &#34;</span><span>/etc/nebula/ca.crt</span><span>&#34;;
</span><span>    </span><span>cert </span><span>= &#34;</span><span>/etc/nebula/node.crt</span><span>&#34;;
</span><span>    </span><span>key </span><span>= &#34;</span><span>/etc/nebula/node.key</span><span>&#34;;
</span><span>
</span><span>    </span><span>isLighthouse </span><span>= </span><span>isLighthouse</span><span>;
</span><span>    </span><span>lighthouses </span><span>= </span><span>if </span><span>(</span><span>isLighthouse</span><span>) </span><span>then </span><span>[] </span><span>else </span><span>[ &#34;</span><span>10.1.0.1</span><span>&#34; ];
</span><span>
</span><span>    </span><span>listen </span><span>= {
</span><span>      </span><span>host </span><span>= &#34;</span><span>0.0.0.0</span><span>&#34;;
</span><span>      </span><span>port </span><span>= </span><span>4242</span><span>;
</span><span>    };
</span><span>
</span><span>    </span><span>staticHostMap </span><span>= {
</span><span>      &#34;</span><span>10.1.0.1</span><span>&#34; = [ &#34;</span><span>266.266.266.266:4242</span><span>&#34; ];
</span><span>    };
</span><span>
</span><span>    </span><span>settings </span><span>= </span><span>if </span><span>(</span><span>isLighthouse</span><span>) </span><span>then </span><span>{
</span><span>      </span><span>sshd </span><span>= {
</span><span>        </span><span>enabled </span><span>= </span><span>true</span><span>;
</span><span>        </span><span>listen </span><span>= &#34;</span><span>127.0.0.1:2222</span><span>&#34;;
</span><span>        </span><span>host_key </span><span>= &#34;</span><span>/etc/nebula/id_ed25519</span><span>&#34;;
</span><span>        </span><span>authorized_users </span><span>= [
</span><span>          {
</span><span>            </span><span>user </span><span>= &#34;</span><span>nommy</span><span>&#34;;
</span><span>            </span><span>keys </span><span>= [
</span><span>              &#34;</span><span>ssh-ed25519 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span>&#34;
</span><span>            ];
</span><span>          }
</span><span>        ];
</span><span>      };
</span><span>    } </span><span>else </span><span>{
</span><span>    };
</span><span>
</span><span>    </span><span>firewall </span><span>= {
</span><span>      </span><span>outbound </span><span>= [
</span><span>        { </span><span>port </span><span>= &#34;</span><span>any</span><span>&#34;; </span><span>proto </span><span>= &#34;</span><span>any</span><span>&#34;; </span><span>host </span><span>= &#34;</span><span>any</span><span>&#34;; }
</span><span>      ];
</span><span>      </span><span>inbound </span><span>= [
</span><span>        { </span><span>port </span><span>= &#34;</span><span>any</span><span>&#34;; </span><span>proto </span><span>= &#34;</span><span>any</span><span>&#34;; </span><span>host </span><span>= &#34;</span><span>any</span><span>&#34;; }
</span><span>      ];
</span><span>    };
</span><span>  };
</span><span>
</span><span>  </span><span>networking</span><span>.</span><span>firewall</span><span>.</span><span>allowedUDPPorts </span><span>= [ </span><span>4242 </span><span>];
</span><span>}
</span><span>
</span></code></pre></details><h2 id="tinc">Tinc</h2><p><a href="https://github.com/gsliepen/tinc">GitHub</a>, <a href="https://tinc-vpn.org/">Official site</a></p><p>When I found this, my first thought was &#34;The fuck is this?&#34; </p><p>But actually, Tinc can surprise you quite a bit.</p><p>Under the hood it uses its own protocol over UDP, elliptic curves and a ton of black magic (which, by the way, is properly documented) that makes it all work.</p><p>Of course, it still needs a node for initial connection bootstrapping, but there&#39;s no special setup required — any node can do it, and afterwards it&#39;s all direct node-to-node communication.</p><p>It has a relatively normal CLI, can show a graph of the entire network, has other tasty features, but really lacks some kind of TUI, or at least ASCII art for rendering that graph.</p><details><summary>Example of not very good configuration</summary> <p>For obvious reasons, the configuration was assembled in a dendrofecal manner, I strongly advise not copying it as-is, but rewriting it yourself.</p> <p>Yes, interface and route configuration is done through <code>tinc-up</code> and <code>tinc-down</code>. </p> <pre data-lang="nix"><code data-lang="nix"><span>let
</span><span>  </span><span>hostName </span><span>= </span><span>config</span><span>.</span><span>networking</span><span>.</span><span>hostName</span><span>;
</span><span>in
</span><span>{
</span><span>  </span><span>networking</span><span>.</span><span>firewall</span><span>.</span><span>allowedTCPPorts </span><span>= [ </span><span>655 </span><span>];
</span><span>  </span><span>networking</span><span>.</span><span>firewall</span><span>.</span><span>allowedUDPPorts </span><span>= [ </span><span>655 </span><span>];
</span><span>
</span><span>  </span><span>services</span><span>.</span><span>tinc </span><span>= {
</span><span>    </span><span>networks </span><span>= {
</span><span>      </span><span>sumeragi </span><span>= {
</span><span>        </span><span>name </span><span>= </span><span>hostName</span><span>;
</span><span>        </span><span>ed25519PrivateKeyFile </span><span>= &#34;</span><span>/etc/tinc/sumeragi/ed25519_key.priv</span><span>&#34;;
</span><span>        </span><span>interfaceType </span><span>= &#34;</span><span>tun</span><span>&#34;;
</span><span>        </span><span>debugLevel </span><span>= </span><span>3</span><span>;
</span><span>
</span><span>        </span><span>hostSettings </span><span>= {
</span><span>          </span><span>lighthouse </span><span>= {
</span><span>            </span><span>settings</span><span>.</span><span>Ed25519PublicKey </span><span>= &#34;</span><span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span>&#34;;
</span><span>            </span><span>subnets </span><span>= [
</span><span>              { </span><span>address </span><span>= &#34;</span><span>10.2.0.1/32</span><span>&#34;; }
</span><span>            ];
</span><span>            </span><span>addresses </span><span>= [
</span><span>              { </span><span>address </span><span>= &#34;</span><span>266.266.266.266</span><span>&#34;; </span><span>port </span><span>= </span><span>655</span><span>; }
</span><span>            ];
</span><span>          };
</span><span>          </span><span>laptop </span><span>= {
</span><span>            </span><span>settings</span><span>.</span><span>Ed25519PublicKey </span><span>= &#34;</span><span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span>&#34;;
</span><span>            </span><span>subnets </span><span>= [
</span><span>              { </span><span>address </span><span>= &#34;</span><span>10.2.0.2/32</span><span>&#34;; }
</span><span>            ];
</span><span>          };
</span><span>          </span><span>rpi </span><span>= {
</span><span>            </span><span>settings</span><span>.</span><span>Ed25519PublicKey </span><span>= &#34;</span><span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span>&#34;;
</span><span>            </span><span>subnets </span><span>= [
</span><span>              { </span><span>address </span><span>= &#34;</span><span>10.2.0.3/32</span><span>&#34;; }
</span><span>            ];
</span><span>          };
</span><span>        };
</span><span>      };
</span><span>    };
</span><span>  };
</span><span>
</span><span>  </span><span>environment</span><span>.</span><span>etc </span><span>= {
</span><span>    &#34;</span><span>tinc/sumeragi/tinc-up</span><span>&#34;.</span><span>source </span><span>= </span><span>pkgs</span><span>.</span><span>writeScript </span><span>&#34;</span><span>tinc-up-sumeragi</span><span>&#34; &#39;&#39;
</span><span>        #!</span><span>${</span><span>pkgs</span><span>.</span><span>stdenv</span><span>.</span><span>shell</span><span>}
</span><span>        </span><span>${</span><span>pkgs</span><span>.</span><span>nettools</span><span>}</span><span>/bin/ifconfig $INTERFACE </span><span>${</span><span>(</span><span>builtins</span><span>.</span><span>elemAt config</span><span>.</span><span>services</span><span>.</span><span>tinc</span><span>.</span><span>networks</span><span>.</span><span>sumeragi</span><span>.</span><span>hostSettings</span><span>.&#34;</span><span>${</span><span>hostName</span><span>}</span><span>&#34;.</span><span>subnets </span><span>0</span><span>)</span><span>.</span><span>address</span><span>}</span><span> netmask 255.255.255.0
</span><span>        /run/current-system/sw/bin/ip r add 10.2.0.0/24 dev tinc.sumeragi
</span><span>    </span><span>&#39;&#39;;
</span><span>    &#34;</span><span>tinc/sumeragi/tinc-down</span><span>&#34;.</span><span>source </span><span>= </span><span>pkgs</span><span>.</span><span>writeScript </span><span>&#34;</span><span>tinc-down-sumeragi</span><span>&#34; &#39;&#39;
</span><span>        #!</span><span>${</span><span>pkgs</span><span>.</span><span>stdenv</span><span>.</span><span>shell</span><span>}
</span><span>        </span><span>${</span><span>pkgs</span><span>.</span><span>nettools</span><span>}</span><span>/bin/ifconfig $INTERFACE down
</span><span>        /run/current-system/sw/bin/ip r del 10.2.0.0/24 dev tinc.sumeragi
</span><span>    </span><span>&#39;&#39;;
</span><span>  };
</span><span>}
</span></code></pre></details><p>This is actually a huge topic and you could write a whole book about it, but the most important thing is — IPerf lies. </p><p>So along with two versions of IPerf, it&#39;s worth adding some real-world network usage cases.</p><p>Internet speeds in both directions are roughly the same for all nodes, so I&#39;ll take numbers from the first direction that comes up, since the difference will be within the margin of error.</p><h2 id="infrastructure">Infrastructure</h2><p>For realistic measurements I&#39;ll use three machines:</p><ul><li>Home laptop (<strong>Laptop</strong>) in Spain</li><li>Intermediate server with public IP (<strong>Lighthouse</strong>) in Finland</li><li>Raspberry Pi (<strong>RPi</strong>) behind the Russian firewall</li></ul><p>The mesh network coordinators are hosted on Lighthouse, while speed is measured between Laptop and RPi.</p><h2 id="ping">Ping</h2><p><code>ping -c 300 10.1.0.3</code></p><p>We send ICMP packets, wait for the response to arrive, measure the time it took to get the response. </p><p>Latency is the average ping response time. </p><p>For more or less stable results, 300 packets should be enough.</p><h2 id="dev-zero-through-ssh">/dev/zero through SSH</h2><p><code>ssh 10.1.0.3 &#39;dd if=/dev/zero bs=128M count=3 2&gt;/dev/null&#39; | dd of=/dev/null status=progress</code></p><p>We read three times 128 MB of zeros through SSH, then look at the reading speed. </p><p>The main reason for using this test is that through some solutions SSH works so hellishly slow that more than a second can pass between pressing a key and the character appearing on screen, which is completely unacceptable. </p><h2 id="wget">Wget</h2><p><code>wget 10.1.0.3:5201/testfile</code></p><p>As a test file — the same 384 MB of zeros from /dev/null.</p><p>As a server I use <a href="https://github.com/TheWaWaR/simple-http-server">simple-http-server</a>, setting the number of threads equal to the number of CPU cores (8). </p><p>Yes, they show orange prices in Africa. Hell knows how to tune this. </p><h2 id="reference-values">Reference values</h2><p>Measuring exact values for speed, ping and all this stuff that we could use as a baseline is somewhat impossible, since both machines are behind NAT. </p><table><thead><tr><th></th><th>ICMP packet loss</th><th>ICMP Latency</th><th>ICMP Jittering</th><th>/dev/zero through SSH</th><th>Wget</th><th>iperf2</th><th>iperf3</th></tr></thead><tbody><tr><td>Laptop -&gt; Lighthouse</td><td>0%</td><td>71.879 ms</td><td>1.422 ms</td><td>25.5 MB/s</td><td>23.3 MB/s</td><td>18 MB/s</td><td>24.375 MB/s</td></tr><tr><td>RPi -&gt; Lighthouse</td><td>0%</td><td>51.872 ms</td><td>1.011 ms</td><td>9.0 MB/s</td><td>Timeout</td><td>9.963 MB/s</td><td>11.112 MB/s</td></tr></tbody></table><p>Now we can start fantasizing.</p><p>Speed between nodes is limited by the slowest link, so we use the minimum values as our reference.</p><p>And it&#39;s time for the final results.</p><p>All speeds are normalized in bytes. To convert to bits, multiply by 8.</p><table><thead><tr><th></th><th>ICMP packet loss</th><th>ICMP Latency</th><th>ICMP Jittering</th><th>/dev/zero through SSH</th><th>Wget</th><th>iperf2</th><th>iperf3</th></tr></thead><tbody><tr><td>Reference</td><td>0%</td><td>123.751 ms</td><td>1.422 ms</td><td>9.0 MB/s</td><td>Timeout</td><td>9.963 MB/s</td><td>11.112 MB/s</td></tr><tr><td>Wireguard + udp2raw</td><td>49.6%</td><td>108.806 ms</td><td>3.724 ms</td><td>Timeout</td><td>Timeout</td><td>3.175 KB/s</td><td>0.00 B/s</td></tr><tr><td>EasyTier</td><td>0%</td><td>153.163 ms</td><td>36.290 ms</td><td>2.7 MB/s</td><td>8.09 MB/s</td><td>6.15 KB/s</td><td>0.00 B/s</td></tr><tr><td>Nebula</td><td>0%</td><td>122.173 ms</td><td>15.054 ms</td><td>2.7 MB/s</td><td>3.40 MB/s</td><td>5.975 KB/s</td><td>0.00 B/s</td></tr><tr><td>Tinc</td><td>2.3%</td><td>115.065 ms</td><td>3.393 ms</td><td>14.7 MB/s</td><td>5.16 MB/s</td><td>6.488 MB/s</td><td>4.175 MB/s</td></tr></tbody></table><p>Egyptian power of those iperfs...</p><p>Tinc, as I already said, is very capable of surprising.</p><p>EasyTier can be forgiven for such overheads, it&#39;s ad-hoc after all and generally &#34;be thankful there&#39;s any connection at all.&#34;</p><p>But Nebula frankly disappointed me. Here I really want to crack a joke about the Slack client on Electron, but... I expected better, seriously.</p><p>So if you want to get something like this — Tinc is the best choice performance-wise. </p><p>That&#39;s all, folks.</p></div></div>
  </body>
</html>
