<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/OpenSSHConfigOrderMatters">Original</a>
    <h1>The order of files in /etc/ssh/sshd_config.d/ matters</h1>
    
    <div id="readability-page-1" class="page"><div><h2>The order of files in /etc/ssh/sshd_config.d/ matters (and may surprise you)</h2>

	<p><small>April  2, 2025</small></p>
</div><div><p>Suppose, not entirely hypothetically, that you have an Ubuntu 24.04
server system where you want to disable SSH passwords for the
Internet but allow them for your local LAN. This looks straightforward
based on <a href="https://man.openbsd.org/sshd_config">sshd_config</a>,
given the <a href="https://man.openbsd.org/sshd_config#PasswordAuthentication"><code>PasswordAuthentication</code></a> and
<a href="https://man.openbsd.org/sshd_config#Match"><code>Match</code></a> directives:</p>

<blockquote><pre>PasswordAuthentication no
Match Address 127.0.0.0/8,192.168.0.0/16
  PasswordAuthentication yes
</pre>
</blockquote>

<p>Since I&#39;m an innocent person, I put this in a file in
/etc/ssh/sshd_config.d/ with a nice high ordering number, say
&#39;60-no-passwords.conf&#39;. Then I restarted the SSH daemon and
was rather confused when it didn&#39;t work (and I wound up resorting
to manipulating <a href="https://man.openbsd.org/sshd_config#AuthenticationMethods"><code>AuthenticationMethods</code></a>, which
also works).</p>

<p>The culprit is two things combined together. The first is this
sentence at the start of <a href="https://man.openbsd.org/sshd_config">sshd_config</a>:</p>

<blockquote><p>[...] <strong>Unless noted otherwise, for each keyword, the first obtained
value will be used</strong>. [...]</p>
</blockquote>

<p>Some configuration systems are &#39;first mention wins&#39;, but I think
it&#39;s more common to be either &#39;last mention wins&#39; or &#39;if it&#39;s
mentioned more than once, it&#39;s an error&#39;. Certainly I was vaguely
expecting sshd_config and the files in sshd_config.d to be
&#39;last mention wins&#39;, because that would be the obvious way to let
you easily override things specified in sshd_config itself. But
OpenSSH doesn&#39;t work this way.</p>

<p>(You can still override things in sshd_config, because the
global  sshd_config includes all of sshd_config.d/* at the
start, before it sets anything, rather than at the end, how you
often see this.)</p>

<p>The second culprit is that at least in our environment, Ubuntu
24.04 writes out a &#39;50-cloud-init.conf&#39; file that contains one
deadly (for this) line:</p>

<blockquote><pre>PasswordAuthentication yes
</pre>
</blockquote>

<p>Since &#39;50-cloud-init.conf&#39; was read by sshd before my
&#39;60-no-passwords.conf&#39;, it forced password authentication to be on.
My new configuration file was more or less silently ignored.</p>

<p>Renaming my configuration file to be &#39;10-no-passwords.conf&#39; fixed
my problem and made things work like I expected.</p>
</div></div>
  </body>
</html>
