<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://calebhearth.com/sign-git-with-ssh">Original</a>
    <h1>Signing Git commits with your SSH key (2021)</h1>
    
    <div id="readability-page-1" class="page"><article>

<p>You may already be signing your Git commits with a <a href="https://calebhearth.com/pgp-and-you#signing-git-commits-and-tags">GPG</a> key, but as of today you can instead choose to sign with your SSH key! Signing in SSH is a relatively new feature that lets you use your private SSH key to sign arbitrary text and others to verify that signature with your public key.</p>
<p>This is great, because pretty much everyone has an SSH key (and pretty much no one has a GPG key). As developers, we’ve probably all uploaded one or more SSH keys to GitHub because that’s necessary to use <code>git(1)</code> to push to GitHub.</p>
<p>This all makes it pretty easy to sign and verify Git commits with keys we already have. There are a few settings you’ll need to configure to start signing.</p>
<h2 id="signing">Signing</h2>
<p>First, we’ll want to configure Git to use SSH as the format for signing:</p>
<div><div><pre><code><span>$ </span>git config <span>--global</span> commit.gpgsign <span>true</span>
<span>$ </span>git config <span>--global</span> gpg.format ssh
</code></pre></div></div>
<p>Next, tell Git what key to use for signing. You can find your SSH keys in <code>~/.ssh/</code> or list them with</p>

<p>On the off chance that you don’t already have an SSH key, <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">GitHub have instructions you can follow</a>.</p>
<p>To set the signing key:</p>
<div><div><pre><code><span>$ </span>git config <span>--global</span> user.signingkey <span>&#34;ssh-ed25519 &lt;your key id&gt;&#34;</span>
</code></pre></div></div>
<p>I ran this, which won’t be useful to you:</p>
<div><div><pre><code><span>$ </span>git config <span>--global</span> user.signingkey <span>\</span>
  <span>&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM9V5SC0UdggJItk8StyYrJTj4eSArjuz4kgqXRy8hnf&#34;</span>
</code></pre></div></div>
<p>To confirm that you’ve configured signing correctly, run:</p>
<div><div><pre><code><span>$ </span>git commit <span>--allow-empty</span> <span>--message</span><span>=</span><span>&#34;Testing SSH signing&#34;</span>
</code></pre></div></div>
<p>You should see something like <code>[main 02f6137] Testing SSH signing</code> if you’ve configured signing correctly.</p>
<h2 id="verifying">Verifying</h2>
<p>Git also lets you verify signatures, but there are more steps involved in this. First, some background. GPG/PGP provides a trust framework that allows you to specify specific keys to trust as well as to let you say “I trust this person(‘s key) to verify others’ keys” so that if you trust Caleb and Caleb vouches for Derek, <code>gpg(1)</code> will agree that Derek’s valid signatures can be trusted.</p>
<p>SSH doesn’t have this “web of trust”. Instead, it uses files like “~/.ssh/authorized_keys” and “~/.ssh/known_hosts” to configure what keys and hosts it should trust, respectively. For verification, we’ll need to create a file to configure allowed signers (see <code>ssh-keygen(1) ALLOWED SIGNERS</code>). While there’s no formal place to store this file yet, it makes sense to store a global “database” of allowed signers in “~/.ssh/allowed_signers” and a project-specific file might be stored in “<project root="">/.git/allowed_signers&#34; if you&#39;d like to maintain your own list or &#34;<project root="">/.allowed_signers&#34; if you want to commit the file and share it.</project></project></p>
<h3 id="viewing-signatures">Viewing Signatures</h3>
<p>So given all of that, let’s see what our signature looks like on that commit we just made:</p>
<div><div><pre><code><span>$ </span>git show <span>--show-signature</span>
error: gpg.ssh.allowedSignersFile needs to be configured and exist <span>for </span>ssh signature verification
commit 52b2c062225a77eea1e142c4073b7b0907eeef5c
No signature
Author: Caleb Hearth &lt;<a href="https://calebhearth.com/cdn-cgi/l/email-protection" data-cfemail="2546444940476546444940474d404457514d0b464a48">[email protected]</a>&gt;
Date:   Mon Nov 15 16:28:46 2021 <span>-0600</span>

    Testing SSH signing
</code></pre></div></div>
<p>The first thing you’ll note is that Git claims there is “No signature” even if we made one. Don’t Panic. We also see on the first line an error from Git noting that we need to configure an allowed signers file. We can set that up globally with:</p>
<div><div><pre><code><span>$ </span>git config <span>--global</span> gpg.ssh.allowedSignersFile ~/.ssh/allowed_signers
<span>$ </span><span>touch</span> ~/.ssh/allowed_signers
<span>$ </span>git show <span>--show-signature</span>
commit 52b2c062225a77eea1e142c4073b7b0907eeef5c
Good <span>&#34;git&#34;</span> signature with ED25519 key SHA256:l1J5VwpF7tSJ0SE9/iawdFhwR7BdzPPxdV3jIURg/yo
sig_find_principals: sshsig_get_principal: key not found^M
No principal matched.
Author: Caleb Hearth &lt;<a href="https://calebhearth.com/cdn-cgi/l/email-protection" data-cfemail="0261636e67604261636e67606a676370766a2c616d6f">[email protected]</a>&gt;
Date:   Mon Nov 15 16:28:46 2021 <span>-0600</span>

    Testing SSH signing
</code></pre></div></div>
<h3 id="allowed-signers">Allowed Signers</h3>
<p>We’re making progress here, and we see that there is a good signature, but that the key is not found. That’s because the allowed_signers file is empty. We can populate it with our own key like this:</p>
<div><div><pre><code><span>echo</span> <span>&#34;<a href="https://calebhearth.com/cdn-cgi/l/email-protection" data-cfemail="2546444940476546444940474d404457514d0b464a48">[email protected]</a> ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM9V5SC0UdggJItk8StyYrJTj4eSArjuz4kgqXRy8hnf&#34;</span> <span>\</span>
  <span>&gt;</span> ~/.ssh/authorized_signatures
</code></pre></div></div>
<p>The format for the allowed signers file is documented in <code>ssh-keygen(1) ALLOWED SIGNERS</code> and effectively boils down to:</p>
<pre><code>&lt;email&gt;[,&lt;email&gt;...] &lt;key type&gt; &lt;public key&gt;
</code></pre>
<p>What is not made explicit in that documentation is that wildcards can be used in place of the email portion. While this may make reduce security in principle by allowing anyone with access to the key to sign, in practice Git allows both committer and author emails to be specified so there is no real security impact here and it makes things somewhat easier.</p>
<pre><code>* ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM9V5SC0UdggJItk8StyYrJTj4eSArjuz4kgqXRy8hnf
</code></pre>
<p>When we try showing the signature again, we’ll see a successful verification:</p>
<pre><code>commit 52b2c062225a77eea1e142c4073b7b0907eeef5c
Good &#34;git&#34; signature for <a href="https://calebhearth.com/cdn-cgi/l/email-protection" data-cfemail="3251535e57507251535e57505a575340465a1c515d5f">[email protected]</a> with ED25519 key SHA256:l1J5VwpF7tSJ0SE9/iawdFhwR7BdzPPxdV3jIURg/yo
Author: Caleb Hearth &lt;<a href="https://calebhearth.com/cdn-cgi/l/email-protection" data-cfemail="d9bab8b5bcbb99bab8b5bcbbb1bcb8abadb1f7bab6b4">[email protected]</a>&gt;
Date:   Mon Nov 15 16:28:46 2021 -0600

    Testing SSH signing
</code></pre>
<h3 id="user-ssh-keys-from-github">User SSH Keys from GitHub</h3>
<p>GitHub provide public SSH keys for all users at URLs like <a href="https://github.com/calebhearth.keys">https://github.com/calebhearth.keys</a>, so you can use that along with the Git author email address to add new allowed signers to that file. That’s manual and a bit of a pain, so I wrote up this very quick-and-dirty <a href="https://calebhearth.com/get_authorized_signers.rb">script</a> that will pull all keys for all signed commits since 14 November 2021 (the day before Git SSH signing was released) and print them out in authorized_signers format. You can run it on any repo and append the output to your authorized_signers, after which you may want to de-duplicate entries.</p>
<h3 id="gitconfig">.gitconfig</h3>
<p>After all of this, here are the changes to my <code>~/.gitconfig</code> that I’ve made to sign with SSH:</p>
<pre><code>[gpg]
  format = ssh
[gpg &#34;ssh&#34;]
  allowedSignersFile = ~/.ssh/allowed_signers
[user]
  signingkey = ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM9V5SC0UdggJItk8StyYrJTj4eSArjuz4kgqXRy8hnf
</code></pre>
<h3 id="github">GitHub</h3>
<div>
<p><img alt="Screenshot of a commit showing a &#39;Verified&#39; badge. Below, a hovercard shows a checkmark next to text indicating that the commit was signed with a verified signature, my profile username and real name, and an SSH key fingerprint for my SSH key." title="Screenshot of a commit showing a &#39;Verified&#39; badge. Below, a hovercard shows a checkmark next to text indicating that the commit was signed with a verified signature, my profile username and real name, and an SSH key fingerprint for my SSH key." src="https://calebhearth.com/assets/verified-commit-05ff7e0e70d161b02fd0a584c64f02071444d7ed38ed8b6b0a9ec2365e6abc5a.png"/></p><p>You’ll need to <a href="https://github.com/settings/ssh/new">upload your key</a> to GitHub as a signing key, even if it has already been uploaded as an authentication key (this is a new dichotomy introduced to support this feature). Once that’s been done, you’ll see that commits signed with your SSH key are correctly shown as verified on GitHub:</p>
</div>
<h3 id="conclusion">Conclusion</h3>
<p>Using SSH to sign and verify Git commits, after a bit of setup, should be really easy and a great alternative to GPG signing and verification.</p>
<p>I do have an early wishlist for improvements:</p>
<ul>
<li>GitHub support for displaying SSH signatures (Fixed! See the <a href="#github">GitHub</a> section above)</li>
<li>a default global allowed_keys file both for Git and SSH</li>
<li>bugfixes such as to remove those <code>^M</code> Windows linefeed characters from the error output (Fixed!)</li>
<li>hopefully we’ll see companies setting up cert-authority for their domains to make setting this up even easier</li>
</ul>
</article></div>
  </body>
</html>
