<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/978010/">Original</a>
    <h1>Memory sealing for the GNU C Library</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>

<div>
<center>
           <div><b>LWN.net needs you!</b><p>Without subscribers, LWN would simply not exist.  Please consider
       <a href="https://lwn.net/subscribe/">signing up for a subscription</a> and helping
       to keep LWN publishing</p></div>
           </center>
           <p>
The </p><a href="https://lwn.net/Articles/958438/"><tt>mseal()</tt> system call</a><p> allows a
process to prevent any future changes to portions of its address space
(thus &#34;sealing&#34; them); it was patterned after the </p><a href="https://lwn.net/Articles/915640/"><tt>mimmutable()</tt> system call</a><p> in OpenBSD.
</p><tt>mseal()</tt><p> generated a lot of discussion, but it was finally merged
for the upcoming 6.10 kernel release.  While </p><tt>mseal()</tt><p> was initially
aimed at securing the Chrome browser, the hope was that it would be useful
elsewhere; as a step toward realizing that hope, Adhemerval Zanella has
posted <a href="https://lwn.net/ml/all/20240611153220.165430-1-adhemerval.zanella@linaro.org">a
patch series</a> adding support for — and use of — </p><tt>mseal()</tt><p> to the
GNU C library (glibc).
</p><p>
This new system call is intended to increase security by making it harder
for an attacker who has gained some control to make changes to a process&#39;s
address space.  If a region of memory has been sealed, it cannot be
unmapped, remapped, or have its protections changed; some <a href="https://man7.org/linux/man-pages/man2/madvise.2.html"><tt>madvise()</tt></a>
operations are also forbidden.  Sealing is a one-way operation; once memory
is sealed, it cannot be unsealed for the life of the process.
</p><p>
The first step in the series is to make <tt>mseal()</tt> available to
glibc users.  The interface is almost exactly what the kernel provides:
</p><pre>    int mseal(void *address, size_t length, unsigned long flags);
</pre>
<p>
The <tt>address</tt> and <tt>length</tt> parameters describe the memory
range to be sealed; the <tt>flags</tt> value is currently unused and must
be zero.
<!-- middle-ad -->
</p><p>
Zanella did not stop with adding the system-call wrapper, though.  The C
library, which includes the dynamic loader, does much of the work of
putting a process&#39;s address space together in the first place; it is well
positioned to know which parts of that address space should not change and,
thus, can be sealed.  Zanella&#39;s patch set takes advantage of that
information to optionally seal various parts of the address space,
including:
</p><ul>
<li> The binary code that the process is running, once it has been set up. 
     This sealing works for both static and dynamic binaries.  All shared
     libraries loaded as dependencies will also be sealed, read-only
     segments included.  (For the curious, this sealing happens after the
     <a href="https://www.redhat.com/en/blog/hardening-elf-binaries-using-relocation-read-only-relro">RELRO</a>
     setup is done, so it would not have been enough to block the <a href="https://lwn.net/Articles/967866/">XZ backdoor</a>).
</li><li> Any preloaded libraries.
</li><li> The kernel&#39;s <a href="https://lwn.net/Articles/615809/">vDSO area</a>.
</li><li> Any dynamic library loaded with <a href="https://www.man7.org/linux/man-pages/man3/dlopen.3.html"><tt>dlopen()</tt></a>
     using the <tt>RTLD_NODELETE</tt> flag (which prevents the library from
     being unloaded on a <tt>dlclose()</tt> call).
</li><li> Any <a href="https://man7.org/linux/man-pages/man7/rtld-audit.7.html">audit
     modules</a> and their dependencies.
</li></ul>
<p>
While most programs should run just fine (and more securely) with this
sealing in place, there will surely be exceptions that are playing
complicated tricks with their address space.  So, naturally, there is an
addition to <a href="https://www.gnu.org/software/libc/manual/html_node/Tunables.html">the
list of glibc tunables</a>, called <tt>gtld.rtld.seal</tt>, controlling the
sealing behavior.  Setting this knob to zero will disable any sealing
performed automatically by the library (though <tt>mseal()</tt> will
continue to work, of course).  The default value (one) causes the sealing
to happen, but any failure to seal a portion of the address space will be
ignored.  For more security-critical programs, setting this knob to two
will cause the process to be killed if any of the sealing attempts fails.
</p><p>
This is early work; <tt>mseal()</tt> is not yet in a released kernel, and
this is the first version of Zanella&#39;s patch set.  Even in the absence of
other concerns, it would be unlikely to be applied to the glibc repository
before 6.10 is released; in the meantime, it may well go through some
changes.  But its essential form seems unlikely to change significantly, so
chances are good that systems using glibc will eventually have better
address-space protection by default.  The expected 6.10 release date
(mid-July) means that the timing for inclusion in the planned <a href="https://sourceware.org/glibc/wiki/Release/2.40">glibc 2.40</a>
release (the beginning of August) is tight, so <tt>mseal()</tt> may be more
likely to appear in 2.41.<br clear="all"/></p><hr/><p>
           (<a href="https://lwn.net/Login/?target=/Articles/978010/">Log in</a> to post comments)
           </p></div> <!-- ArticleText -->

</div> <!-- middlecolumn -->

</div></div>
  </body>
</html>
