<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/openai/codex/discussions/1174">Original</a>
    <h1>Codex CLI is going native</h1>
    
    <div id="readability-page-1" class="page"><div role="presentation" data-paste-markdown-skip="">
    <tbody data-target-translation-id="13337851" data-target-translation-type="comment">
        <tr>
    <td>
        <p dir="auto"><a data-hovercard-type="user" data-hovercard-url="/users/bpostlethwaite/hovercard" data-octo-click="hovercard-link-click" data-octo-dimensions="link_type:self" href="https://github.com/bpostlethwaite">@bpostlethwaite</a> we should write things up in more detail (and refactor some of the code so it&#39;s easier to follow), but the high level is that we have a set of sandbox permissions:</p>
<div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L250" data-line-number="250"></td>
          <td id="LC250"> <span>/// Permissions that should be granted to the sandbox in which the agent</span> </td>
        </tr>

        <tr>
          <td id="L251" data-line-number="251"></td>
          <td id="LC251"> <span></span><span>/// operates.</span> </td>
        </tr>

        <tr>
          <td id="L252" data-line-number="252"></td>
          <td id="LC252"> <span></span><span>#<span>[</span>derive<span>(</span><span>Debug</span><span>,</span> <span>Clone</span><span>,</span> <span>PartialEq</span><span>,</span> <span>Eq</span><span>,</span> <span>Hash</span><span>,</span> <span>Serialize</span><span>,</span> <span>Deserialize</span><span>)</span><span>]</span></span> </td>
        </tr>

        <tr>
          <td id="L253" data-line-number="253"></td>
          <td id="LC253"> <span>#<span>[</span>serde<span>(</span>rename_all = <span>&#34;kebab-case&#34;</span><span>)</span><span>]</span></span> </td>
        </tr>

        <tr>
          <td id="L254" data-line-number="254"></td>
          <td id="LC254"> <span>pub</span> <span>enum</span> <span>SandboxPermission</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L255" data-line-number="255"></td>
          <td id="LC255">     <span>/// Is allowed to read all files on disk.</span> </td>
        </tr>

        <tr>
          <td id="L256" data-line-number="256"></td>
          <td id="LC256"> <span></span>    <span>DiskFullReadAccess</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L257" data-line-number="257"></td>
          <td id="LC257">  </td>
        </tr>

        <tr>
          <td id="L258" data-line-number="258"></td>
          <td id="LC258">     <span>/// Is allowed to write to the operating system&#39;s temp dir that</span> </td>
        </tr>

        <tr>
          <td id="L259" data-line-number="259"></td>
          <td id="LC259"> <span></span>    <span>/// is restricted to the user the agent is running as. For</span> </td>
        </tr>

        <tr>
          <td id="L260" data-line-number="260"></td>
          <td id="LC260"> <span></span>    <span>/// example, on macOS, this is generally something under</span> </td>
        </tr>

        <tr>
          <td id="L261" data-line-number="261"></td>
          <td id="LC261"> <span></span>    <span>/// `/var/folders` as opposed to `/tmp`.</span> </td>
        </tr>

        <tr>
          <td id="L262" data-line-number="262"></td>
          <td id="LC262"> <span></span>    <span>DiskWritePlatformUserTempFolder</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L263" data-line-number="263"></td>
          <td id="LC263">  </td>
        </tr>

        <tr>
          <td id="L264" data-line-number="264"></td>
          <td id="LC264">     <span>/// Is allowed to write to the operating system&#39;s shared temp</span> </td>
        </tr>

        <tr>
          <td id="L265" data-line-number="265"></td>
          <td id="LC265"> <span></span>    <span>/// dir. On UNIX, this is generally `/tmp`.</span> </td>
        </tr>

        <tr>
          <td id="L266" data-line-number="266"></td>
          <td id="LC266"> <span></span>    <span>DiskWritePlatformGlobalTempFolder</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L267" data-line-number="267"></td>
          <td id="LC267">  </td>
        </tr>

        <tr>
          <td id="L268" data-line-number="268"></td>
          <td id="LC268">     <span>/// Is allowed to write to the current working directory (in practice, this</span> </td>
        </tr>

        <tr>
          <td id="L269" data-line-number="269"></td>
          <td id="LC269"> <span></span>    <span>/// is the `cwd` where `codex` was spawned).</span> </td>
        </tr>

        <tr>
          <td id="L270" data-line-number="270"></td>
          <td id="LC270"> <span></span>    <span>DiskWriteCwd</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L271" data-line-number="271"></td>
          <td id="LC271">  </td>
        </tr>

        <tr>
          <td id="L272" data-line-number="272"></td>
          <td id="LC272">     <span>/// Is allowed to the specified folder. `PathBuf` must be an</span> </td>
        </tr>

        <tr>
          <td id="L273" data-line-number="273"></td>
          <td id="LC273"> <span></span>    <span>/// absolute path, though it is up to the caller to canonicalize</span> </td>
        </tr>

        <tr>
          <td id="L274" data-line-number="274"></td>
          <td id="LC274"> <span></span>    <span>/// it if the path contains symlinks.</span> </td>
        </tr>

        <tr>
          <td id="L275" data-line-number="275"></td>
          <td id="LC275"> <span></span>    <span>DiskWriteFolder</span> <span>{</span> <span>folder</span><span>:</span> <span>PathBuf</span> <span>}</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L276" data-line-number="276"></td>
          <td id="LC276">  </td>
        </tr>

        <tr>
          <td id="L277" data-line-number="277"></td>
          <td id="LC277">     <span>/// Is allowed to write to any file on disk.</span> </td>
        </tr>

        <tr>
          <td id="L278" data-line-number="278"></td>
          <td id="LC278"> <span></span>    <span>DiskFullWriteAccess</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L279" data-line-number="279"></td>
          <td id="LC279">  </td>
        </tr>

        <tr>
          <td id="L280" data-line-number="280"></td>
          <td id="LC280">     <span>/// Can make arbitrary network requests.</span> </td>
        </tr>

        <tr>
          <td id="L281" data-line-number="281"></td>
          <td id="LC281"> <span></span>    <span>NetworkFullAccess</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L282" data-line-number="282"></td>
          <td id="LC282"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>

<p dir="auto">that can be aggregated to define a <code>SandboxPolicy</code>. We map the <code>SandboxPolicy</code> to an appropriate set of CLI args to a helper binary that spawns a subprocess in the sandbox:</p>
<ul dir="auto">
<li>On macOS, we use <code>/usr/bin/sandbox-exec</code>: <div>
  
  <div itemprop="text">
    <table data-tab-size="8" data-paste-markdown-skip="">

        <tbody><tr>
          <td id="L270" data-line-number="270"></td>
          <td id="LC270"> <span>fn</span> <span>create_seatbelt_command_args</span><span>(</span> </td>
        </tr>

        <tr>
          <td id="L271" data-line-number="271"></td>
          <td id="LC271">     <span>command</span><span>:</span> <span>Vec</span><span>&lt;</span><span>String</span><span>&gt;</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L272" data-line-number="272"></td>
          <td id="LC272">     <span>sandbox_policy</span><span>:</span> <span>&amp;</span><span>SandboxPolicy</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L273" data-line-number="273"></td>
          <td id="LC273">     <span>cwd</span><span>:</span> <span>&amp;</span><span>Path</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L274" data-line-number="274"></td>
          <td id="LC274"> <span>)</span> -&gt; <span>Vec</span><span>&lt;</span><span>String</span><span>&gt;</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L275" data-line-number="275"></td>
          <td id="LC275">     <span>let</span> <span>(</span>file_write_policy<span>,</span> extra_cli_args<span>)</span> = <span>{</span> </td>
        </tr>

        <tr>
          <td id="L276" data-line-number="276"></td>
          <td id="LC276">         <span>if</span> sandbox_policy<span>.</span><span>has_full_disk_write_access</span><span>(</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L277" data-line-number="277"></td>
          <td id="LC277">             <span>// Allegedly, this is more permissive than `(allow file-write*)`.</span> </td>
        </tr>

        <tr>
          <td id="L278" data-line-number="278"></td>
          <td id="LC278">             <span>(</span> </td>
        </tr>

        <tr>
          <td id="L279" data-line-number="279"></td>
          <td id="LC279">                 <span>r#&#34;(allow file-write* (regex #&#34;^/&#34;))&#34;#</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L280" data-line-number="280"></td>
          <td id="LC280">                 <span>Vec</span><span>::</span><span>&lt;</span><span>String</span><span>&gt;</span><span>::</span><span>new</span><span>(</span><span>)</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L281" data-line-number="281"></td>
          <td id="LC281">             <span>)</span> </td>
        </tr>

        <tr>
          <td id="L282" data-line-number="282"></td>
          <td id="LC282">         <span>}</span> <span>else</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L283" data-line-number="283"></td>
          <td id="LC283">             <span>let</span> writable_roots = sandbox_policy<span>.</span><span>get_writable_roots_with_cwd</span><span>(</span>cwd<span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L284" data-line-number="284"></td>
          <td id="LC284">             <span>let</span> <span>(</span>writable_folder_policies<span>,</span> cli_args<span>)</span><span>:</span> <span>(</span><span>Vec</span><span>&lt;</span><span>String</span><span>&gt;</span><span>,</span> <span>Vec</span><span>&lt;</span><span>String</span><span>&gt;</span><span>)</span> = writable_roots </td>
        </tr>

        <tr>
          <td id="L285" data-line-number="285"></td>
          <td id="LC285">                 <span>.</span><span>iter</span><span>(</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L286" data-line-number="286"></td>
          <td id="LC286">                 <span>.</span><span>enumerate</span><span>(</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L287" data-line-number="287"></td>
          <td id="LC287">                 <span>.</span><span>map</span><span>(</span>|<span>(</span>index<span>,</span> root<span>)</span>| <span>{</span> </td>
        </tr>

        <tr>
          <td id="L288" data-line-number="288"></td>
          <td id="LC288">                     <span>let</span> param_name = <span>format</span><span>!</span><span>(</span><span>&#34;WRITABLE_ROOT_{index}&#34;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L289" data-line-number="289"></td>
          <td id="LC289">                     <span>let</span> policy<span>:</span> <span>String</span> = <span>format</span><span>!</span><span>(</span><span>&#34;(subpath (param <span>\&#34;</span>{param_name}<span>\&#34;</span>))&#34;</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L290" data-line-number="290"></td>
          <td id="LC290">                     <span>let</span> cli_arg = <span>format</span><span>!</span><span>(</span><span>&#34;-D{param_name}={}&#34;</span><span>,</span> root<span>.</span>to_string_lossy<span>(</span><span>)</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L291" data-line-number="291"></td>
          <td id="LC291">                     <span>(</span>policy<span>,</span> cli_arg<span>)</span> </td>
        </tr>

        <tr>
          <td id="L292" data-line-number="292"></td>
          <td id="LC292">                 <span>}</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L293" data-line-number="293"></td>
          <td id="LC293">                 <span>.</span><span>unzip</span><span>(</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L294" data-line-number="294"></td>
          <td id="LC294">             <span>if</span> writable_folder_policies<span>.</span><span>is_empty</span><span>(</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L295" data-line-number="295"></td>
          <td id="LC295">                 <span>(</span><span>&#34;&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>,</span> <span>Vec</span><span>::</span><span>&lt;</span><span>String</span><span>&gt;</span><span>::</span><span>new</span><span>(</span><span>)</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L296" data-line-number="296"></td>
          <td id="LC296">             <span>}</span> <span>else</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L297" data-line-number="297"></td>
          <td id="LC297">                 <span>let</span> file_write_policy = <span>format</span><span>!</span><span>(</span> </td>
        </tr>

        <tr>
          <td id="L298" data-line-number="298"></td>
          <td id="LC298">                     <span>&#34;(allow file-write*<span>\n</span>{}<span>\n</span>)&#34;</span><span>,</span> </td>
        </tr>

        <tr>
          <td id="L299" data-line-number="299"></td>
          <td id="LC299">                     writable_folder_policies<span>.</span>join<span>(</span><span>&#34; &#34;</span><span>)</span> </td>
        </tr>

        <tr>
          <td id="L300" data-line-number="300"></td>
          <td id="LC300">                 <span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L301" data-line-number="301"></td>
          <td id="LC301">                 <span>(</span>file_write_policy<span>,</span> cli_args<span>)</span> </td>
        </tr>

        <tr>
          <td id="L302" data-line-number="302"></td>
          <td id="LC302">             <span>}</span> </td>
        </tr>

        <tr>
          <td id="L303" data-line-number="303"></td>
          <td id="LC303">         <span>}</span> </td>
        </tr>

        <tr>
          <td id="L304" data-line-number="304"></td>
          <td id="LC304">     <span>}</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L305" data-line-number="305"></td>
          <td id="LC305">  </td>
        </tr>

        <tr>
          <td id="L306" data-line-number="306"></td>
          <td id="LC306">     <span>let</span> file_read_policy = <span>if</span> sandbox_policy<span>.</span><span>has_full_disk_read_access</span><span>(</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L307" data-line-number="307"></td>
          <td id="LC307">         <span>&#34;; allow read-only file operations<span>\n</span>(allow file-read*)&#34;</span> </td>
        </tr>

        <tr>
          <td id="L308" data-line-number="308"></td>
          <td id="LC308">     <span>}</span> <span>else</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L309" data-line-number="309"></td>
          <td id="LC309">         <span>&#34;&#34;</span> </td>
        </tr>

        <tr>
          <td id="L310" data-line-number="310"></td>
          <td id="LC310">     <span>}</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L311" data-line-number="311"></td>
          <td id="LC311">  </td>
        </tr>

        <tr>
          <td id="L312" data-line-number="312"></td>
          <td id="LC312">     <span>// TODO(mbolin): apply_patch calls must also honor the SandboxPolicy.</span> </td>
        </tr>

        <tr>
          <td id="L313" data-line-number="313"></td>
          <td id="LC313">     <span>let</span> network_policy = <span>if</span> sandbox_policy<span>.</span><span>has_full_network_access</span><span>(</span><span>)</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L314" data-line-number="314"></td>
          <td id="LC314">         <span>&#34;(allow network-outbound)<span>\n</span>(allow network-inbound)<span>\n</span>(allow system-socket)&#34;</span> </td>
        </tr>

        <tr>
          <td id="L315" data-line-number="315"></td>
          <td id="LC315">     <span>}</span> <span>else</span> <span>{</span> </td>
        </tr>

        <tr>
          <td id="L316" data-line-number="316"></td>
          <td id="LC316">         <span>&#34;&#34;</span> </td>
        </tr>

        <tr>
          <td id="L317" data-line-number="317"></td>
          <td id="LC317">     <span>}</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L318" data-line-number="318"></td>
          <td id="LC318">  </td>
        </tr>

        <tr>
          <td id="L319" data-line-number="319"></td>
          <td id="LC319">     <span>let</span> full_policy = <span>format</span><span>!</span><span>(</span> </td>
        </tr>

        <tr>
          <td id="L320" data-line-number="320"></td>
          <td id="LC320">         <span>&#34;{MACOS_SEATBELT_BASE_POLICY}<span>\n</span>{file_read_policy}<span>\n</span>{file_write_policy}<span>\n</span>{network_policy}&#34;</span> </td>
        </tr>

        <tr>
          <td id="L321" data-line-number="321"></td>
          <td id="LC321">     <span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L322" data-line-number="322"></td>
          <td id="LC322">     <span>let</span> <span>mut</span> seatbelt_args<span>:</span> <span>Vec</span><span>&lt;</span><span>String</span><span>&gt;</span> = <span>vec</span><span>!</span><span>[</span><span>&#34;-p&#34;</span><span>.</span>to_string<span>(</span><span>)</span><span>,</span> full_policy<span>]</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L323" data-line-number="323"></td>
          <td id="LC323">     seatbelt_args<span>.</span><span>extend</span><span>(</span>extra_cli_args<span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L324" data-line-number="324"></td>
          <td id="LC324">     seatbelt_args<span>.</span><span>push</span><span>(</span><span>&#34;--&#34;</span><span>.</span><span>to_string</span><span>(</span><span>)</span><span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L325" data-line-number="325"></td>
          <td id="LC325">     seatbelt_args<span>.</span><span>extend</span><span>(</span>command<span>)</span><span>;</span> </td>
        </tr>

        <tr>
          <td id="L326" data-line-number="326"></td>
          <td id="LC326">     seatbelt_args </td>
        </tr>

        <tr>
          <td id="L327" data-line-number="327"></td>
          <td id="LC327"> <span>}</span> </td>
        </tr>
    </tbody></table>
  </div>
</div>
</li>
<li>On Linux, we build our own CLI that uses Landlock/seccomp: <a href="https://github.com/openai/codex/blob/main/codex-rs/linux-sandbox/README.md">https://github.com/openai/codex/blob/main/codex-rs/linux-sandbox/README.md</a></li>
</ul>
<p dir="auto">In both cases, the policy is applied to the process spawned (and to any processes it spawns), so it applies to an entire process tree.</p>
    </td>
  </tr>

    </tbody>
  </div></div>
  </body>
</html>
