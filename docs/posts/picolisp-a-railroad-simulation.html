<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://picolisp-explored.com/a-railroad-simulation-with-des">Original</a>
    <h1>Picolisp a Railroad Simulation</h1>
    
    <div id="readability-page-1" class="page"><div id="post-content-parent"><div id="post-content-wrapper"><p>In our <a target="_blank" href="https://picolisp-explored.com/picolisp-explored-discrete-event-simulation">previous post</a>, we introduced how to utilize Discrete Event Simulation (DES) in PicoLisp. Now, let&#39;s explore another application: a railroad model simulation that includes tracks and trains. The visualization is ASCII-based, so feel free to unleash your imagination to transform it into a comprehensive mini railway experience! ðŸ˜Š</p>
<p>You can create a sort of &#34;model of a model railroad&#34; with the program, and it serves no other purpose than having fun.</p>
<hr/>
<p>The sources can be found on <a target="_blank" href="https://gitlab.com/picolisp-blog/single-plage-scripts/-/tree/main/railroad">GitLab</a> or downloaded from <a target="_blank" href="https://software-lab.de/bahn.tgz">https://software-lab.de/bahn.tgz</a> (source code within the &#34;misc/&#34;-folder). PicoLisp version &gt;= 23.12 is required.</p>
<hr/>
<h2 id="heading-concept">Concept</h2>
<p>The base of the simulation is a railroad network drawn in ASCII, with each line representing a track. The cyan lines represent switches that enable the trains to change tracks.</p>
<p>The trains are the simulated objects (&#34;bots&#34;). They are depicted as <code>@000</code> , where the <code>@</code> mark represents the locomotive and each <code>0</code> represents a wagon.</p>
<p>At any point in time, a train is either</p>
<ul>
<li><p>waiting, e.g. at a station,</p>
</li>
<li><p>moving from one position to another,</p>
</li>
<li><p>or shunting (rearranging locomotive and wagons).</p>
</li>
</ul>
<hr/>
<p>Let&#39;s see it in action in the example below. There are 5 trains in operation - some with multiple wagons, some with a locomotive at each end, and one solitary locomotive without any wagons.</p>
<p>For each train an individual schedule has been defined based on a specified order of positions. However, the precise movements of the trains are determined dynamically using Discrete Event Simulation.</p>
<p>The GIF below is showing the first 30 seconds of the simulation running at 8x speed.</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1715542067487/5b63063b-0cf4-470f-8822-2af30bdac866.gif?auto=format,compress&amp;gif-q=60&amp;format=webm" alt=""/></p>
<h3 id="heading-running-the-simulation">Running the simulation</h3>
<p>The source code is split into two files:</p>
<ul>
<li><p><code>bahn.l</code>, containing the fundamental logic for the train and network simulation.</p>
</li>
<li><p><code>plan.l</code>, containing the railway network layout and driving parameters, such as the number and specifications of trains, schedule, speed, etc.</p>
</li>
</ul>
<p><em>Note: if you are confused about the wording - &#34;bahn&#34; is the German word for train :)</em></p>
<p>To start the simulation, use the following command:</p>
<pre><code>$ pil bahn.l -bahn~main plan.l -go +
</code></pre>
<p>Typing &#34;s&#34; starts and stops the simulation, while the simulation speed doubles and halves with &#34;+&#34; and &#34;-&#34; respectively. <code>ESC</code> will drop you into the REPL, and calling <code>(go)</code> from the REPL will continue with the simulation. To exit the simulation, press <code>ESC</code> and then <code>Ctrl-D</code> or <code>(bye)</code>.</p>
<hr/>
<h3 id="heading-train-simulation-in-detail">Train Simulation in Detail</h3>
<p>A train can be in three states: Waiting, moving and shunting.</p>
<p><em>Waiting</em> is realized using the <code>pause</code> function of the DES library.</p>
<p>More interesting is <em>moving</em>, which consists of several steps:</p>
<ol>
<li><p>Acceleration until reaching travel speed.</p>
</li>
<li><p>Continuous travel at the designated speed.</p>
</li>
<li><p>Deceleration upon reaching the destination.</p>
</li>
</ol>
<p>Discrete Event Simulation offers several advantages over continuous simulation, particularly when dealing with numerous bots with varying timings. For instance, <strong>continuous simulation</strong> will use a fixed time slice <code>dt</code> and the bot&#39;s current speed <code>v</code> to calculate their change in position, using the following differential equation:</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1715539172395/6967ce47-4862-4081-ad9a-2a4d01579d9a.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p>This calculation is performed for all bots, regardless of their individual speeds.</p>
<p>In contrast, <strong>discrete event simulation</strong> utilizes a spatial resolution <code>ds</code> (which may vary for each bot and scenario) and computes the time required to &#34;pause&#34; in the simulation until the bot has covered the distance:</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1715539275981/c4af2f7c-841e-49bc-a499-e10c56a77466.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p>Now, all moving bots remain inactive for their scheduled amounts of time - longer if they move at slower speeds and/or coarser resolutions. This approach can significantly reduce processing time.</p>
<hr/>
<p>Note that the equations above are valid only for moving at constant speed. For accelerated movement, a continuous simulation would calculate:</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1715539742398/ebc24ee2-1b27-461a-8601-4aee3537dc8d.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p>For discrete event simulation, we can use:</p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1715539875068/7383e268-69a7-44d6-ab80-f9860056f279.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p><img loading="lazy" src="https://cdn.hashnode.com/res/hashnode/image/upload/v1715539947168/4c74a0d0-b0b7-4c09-9efc-5bfb1b4abd13.png?auto=compress,format&amp;format=webp" alt=""/></p>
<p>This behavior is implemented in the <code>drive</code> function in the file <code>bahn.l</code>. The function takes the following parameters: acceleration (in m/sÂ², also utilized for deceleration during braking), travel speed (in m/s), and X and Y coordinates for the destination. Optionally, additional X and Y destination pairs can be provided to enforce intermediate stops.</p>
<p>For each destination, the function searches for a viable path through the track network and attempts to lock the path. If the path is unavailable, it enters a pause state until receiving a signal that another bot has released the locks. It also toggles all necessary switches as required for its route.</p>
<hr/>
<p>Now the last train state, <em>shunting</em>, which is implemented in the <code>shunt</code> function in <code>bahn.l</code>. This function disconnects the locomotive from the first wagon, calls <code>drive</code> and <code>turn</code> repeatedly to navigate to the other end of the train, and connects to the previously last wagon.</p>
<hr/>
<p>As an example, this is how the first locomotive is defined in <code>bahn.l</code>.</p>
<pre><code>(<span><span>new</span></span> &#39;(<span>+Locomotive</span>) (<span>pd</span> <span>1</span> <span>10</span> &#39;a) <span>5</span>
   (<span>pause</span>)
   (<span><span>loop</span></span>
      (<span>drive</span> <span>0.2</span> <span>40.0</span>  <span>31</span> <span>14</span>)
      (<span>pause</span> <span>12.0</span>)
      (<span>drive</span> <span>0.2</span> <span>40.0</span>  <span>45</span> <span>34</span>)
      (<span>shunt</span>
         (<span>drive</span> <span>0.1</span> <span>10.0</span>  <span>45</span> <span>38</span>)
         (<span>turn</span>)
         (<span>drive</span> <span>0.1</span> <span>10.0</span>  <span>48</span> <span>32</span>  <span>45</span> <span>23</span>)
         (<span>turn</span>)
         (<span>drive</span> <span>0.1</span> <span>10.0</span>  <span>45</span> <span>28</span>) )
      (<span>drive</span> <span>0.2</span> <span>40.0</span>  <span>31</span> <span>19</span>)
      ...  ) ) )
</code></pre>
<p>The <code>pd</code> method of the locomotive object defines that the locomotive starts at position <code>(x, y) = (1, 10)</code> and faces in direction of <code>a</code>, e. g. downwards. The last parameter of the first line, <code>5</code>, indicates the number of wagons.</p>
<p>As mentioned above, the <code>drive</code> method takes four parameters: acceleration, speed, and a target x-y-position. <code>drive</code> is also used within the <code>shunt</code> method to define the movement of the locomotive while the wagons stay at their current position.</p>
<hr/>
<p>With this, we have covered all possible states of the train. Next we will see how the track network is implemented.</p>
<hr/>
<h3 id="heading-track-simulation-in-detail">Track Simulation in Detail</h3>
<p>For the railway tracks to run the trains on, we use the track network library available in the PicoLisp distribution. The library has a <code>tracks</code> function in <code>@lib/simul.l</code>, which processes the ASCII representation of a railway layout from the current input stream and generates an appropriate data structure.</p>
<p>The idea is to have interconnected track elements where the bots can be positioned, along with a <code>cdr</code>-like operation to move a bot from one element to the next. Iterating this operation results in a continuous movement into one direction.</p>
<p>However, for a comprehensive track network, a simple linked list of track elements is insufficient. It must be possible to traverse it in both directions and accommodate switches (turnouts) and loops. Loops present a particular challenge. Consider this layout where a bot starts in the top-right position and moves leftwards:</p>
<pre><code>             &lt;--               &lt;--
       ---------------------------------
      /                 /      --&gt;
     /                 /
    /                 /
   |                 |
   |                 |
   |                 |
    \               /
     \             /
      \           /
       -----------
           --&gt;
</code></pre>
<p>After traversing the loop, it ends up in the top-right position again, but now moving in the opposite direction! The <code>cdr</code> operation would throw it back into the loop instead of continuing in the intended direction.</p>
<p>To address this, the <code>tracks</code> function generates what we call a &#34;Networked Linked Lists&#34; data structure. This structure is a form of indirect doubly linked list that accommodates branches, allowing for traversal in both directions and supporting complex track layouts such as loops.</p>
<p>The structure can be visualized with the built-in ASCII diagramming capabilities of the PicoLisp Vip editor. In the PicoLisp REPL (in debug mode!) enter</p>
<pre><code>: (<span>vi</span> <span>&#34;@doc/Tracks&#34;</span>)
</code></pre>
<p>and type &#34;v&#34; to view it in a new buffer. It will show:</p>
<pre><code>Connectors:

---------+                 +-------------&gt;   +-----------------------------&gt;
         |                 |                 |
         v                 |                 |
      +-----+-----+     +--+--+-----+     +--+--+-----+
  +--&gt;|  |  |  ---+----&gt;|  |  |  ---+----&gt;|  |  |  |  |
  |   +--+--+-----+     +-----+-----+     +-----+--+--+
  |      | ^                                       |
  |      | |                                       |
  |      | +---------------------------------------|-----------------+
  |      |                                         |                 |
  |      |                                         |                 |
  |      |      +----------+ +---------------------+                 |
  |      |      |          | |                                       |
  |      v      v          | v                                       |
  |   +------------+    +--+--+-----+     +-----+-----+     +-----+--+--+
  +---+- a      b -+---&gt;|  |  |  ---+----&gt;|  |  |  ---+----&gt;|  |  |  |  |
      |            |    +-----+-----+     +--+--+-----+     +--+--+-----+
      |   Track    |       ^                 |                 |
      |            |       |                 |                 |
      | x        y |       +-----------------|-----------------|------------
      +------------+                         |                 |
                                             |                 |
&lt;--------------------------------------------+   &lt;-------------+
</code></pre>
<p>As you can see, it is a rather complicated structure. The <code>Track</code> box is a symbol holding the actual track element. It stores information like the <code>x</code> and <code>y</code> coordinates and connectors to the neighboring track elements in <code>a</code> and <code>b</code>. Each connector consists of three cells for forward- and backward-links and optional switches in both directions.</p>
<hr/>
<h3 id="heading-user-interface">User Interface</h3>
<p>Showing the animated ASCII drawing and handling user keyboard input is all done by a single function called <code>display</code>. It is called by <code>go</code> in a loop until <code>ESC</code> is typed, and allows to move around in the layout or along a rail track, and to toggle switches manually. Additionally, the following commands can be used in order to interact with the simulation:</p>
<ul>
<li><p><code>s</code> stops or continues the simulation.</p>
</li>
<li><p><code>+</code> and <code>-</code> double and halve the simulation speed respectively. Initially, the speed factor is 2. It is displayed at the bottom left.</p>
</li>
<li><p>A red `#` cursor (initially hidden on the left outside the layout) can be moved around on the screen with the following keystrokes:</p>
<ul>
<li><p><code>j</code> or <code>DOWN</code>, <code>k</code> or <code>UP</code>, <code>l</code> and <code>h</code> move by a single position</p>
</li>
<li><p><code>z</code> and <code>Z</code> move by eight positions right and left</p>
</li>
<li><p><code>w</code> and <code>b</code> move by a &#34;word&#34; (e.g. rail element) to the right and left</p>
</li>
<li><p><code>0</code> and <code>$</code> to go to left and right end of the layout</p>
</li>
<li><p><code>g</code> and <code>G</code> go to top and bottom of the layout</p>
</li>
<li><p><code>TAB</code> and <code>BACK</code> to jump to the next and previous switch</p>
</li>
<li><p><code>ENTER</code> to toggle a switch</p>
</li>
<li><p><code>SPACE</code> to move along the track</p>
</li>
<li><p><code>r</code> to toggle the move direction for the <code>SPACE</code> command.</p>
</li>
</ul>
</li>
</ul>
<hr/>
<p>Now, with this information you should have a good understanding of how to create a railway model using discrete event simulation in PicoLisp. By referring to the examples on <a target="_blank" href="https://gitlab.com/picolisp-blog/single-plage-scripts/-/tree/main/railroad">GitLab</a>, tweaking it into your own railway model shouldn&#39;t be too challenging.</p>
<p>With some (considerable) effort, you could even replace the ASCII representation by something more visually appealing ðŸ˜Š</p>
<p><img loading="lazy" src="https://cdn.pixabay.com/photo/2016/01/18/16/21/model-train-1146828_640.jpg" alt="Modelleisenbahn, Modell, Eisenbahn, Zug"/></p>
<hr/>
<h3 id="heading-sources">Sources</h3>
<ul>
<li><p><a target="_blank" href="https://www.irasutoya.com/2013/05/blog-post_9988.html">https://www.irasutoya.com/2013/05/blog-post_9988.html</a></p>
</li>
<li><p><a target="_blank" href="https://software-lab.de/doc/des.html">https://software-lab.de/doc/des.html</a></p>
</li>
<li><p><a target="_blank" href="https://pixabay.com/de/photos/modelleisenbahn-modell-eisenbahn-1146828/">https://pixabay.com/de/photos/modelleisenbahn-modell-eisenbahn-1146828/</a></p>
</li>
</ul>
</div></div></div>
  </body>
</html>
