<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://vadosware.io/post/how-i-built-lwhn/">Original</a>
    <h1>How I Built LoginWithHN</h1>
    
    <div id="readability-page-1" class="page"><div>
        <div>

          <div>
            
            
            

            
              
              
            


            
            
            
            

            
              
<p><strong>tl;dr - This post explains how I built <a href="https://loginwithhn.com">LoginWithHN.com (LWHN)</a>, an unofficial OAuth2+OpenID connect provider for <a href="https://news.ycombinator.com">HackerNews</a>. LWHN is for builders who want to share things with the HN audience, and cuts down friction like any other OAuth2+OpenID connect provider. LWHN is now open to the public for new client app registration, so check it out if you‚Äôre interested.</strong></p>
<p><em>DISCLAIMER: I wrote this article with the knowledge that <a href="https://www.ory.sh/">Ory</a> would share it later on their blog/marketing channels. Ory‚Äôs product <a href="https://www.ory.sh/hydra/">Hydra</a> powers LWHN‚Äôs OAuth2+OpenID Connect integration and I whole heartedly endorse it.</em></p>

<p>Login is often one of the last things I think about while building a new project. I‚Äôve built the email + password flow so many times now that I can do it in my sleep:</p>
<ul>
<li>Salted <a href="https://en.wikipedia.org/wiki/Bcrypt"><code>bcrypt</code></a>/<a href="https://en.wikipedia.org/wiki/Scrypt"><code>scrypt</code></a>/etc password hashes with high work (round) count</li>
<li>Email reset</li>
<li><code>HTTPOnly</code> + <code>Secure</code> cookies with expiry</li>
<li>reasonable expiry length</li>
</ul>
<p>Most people would use a framework like Rails or Django here to save themselves the time but that‚Äôs not my style (see rest of this blog).</p>
<p>Anyway, instead of doing too much, one thing I don‚Äôt do <em>enough</em> of is thinking about login from a <strong>user-centric point of view</strong>. Case in point ‚Äì <strong>no one cares how secure your login is, they care that it‚Äôs convenient</strong>.</p>
<p>It‚Äôs a fine line ‚Äì don‚Äôt build insecure software (users don‚Äôt like apps that leak all their data), but also don‚Äôt bombard users with friction.</p>
<p>So rephrased, the question isn‚Äôt how to build a secure, correct login implementation, or even if you should have someone else build it (great options like <a href="https://clerk.dev">Clerk.dev</a>, <a href="https://ory.sh/cloud">Ory Cloud</a> and <a href="https://supertokens.com">supertokens</a> are out there).</p>
<p><strong>The right question is what kind of login flow will <del>spark joy</del> be least annoying for your users</strong>.</p>

<p>I build a lot of projects/products with people who surf <a href="https://news.ycombinator.com">HackerNews</a> in mind ‚Äì it‚Äôs one of the best moderated high traffic tech communities out there, full of people who are willing to be early adopters of projects and ideas.</p>
<p>The secret is probably some combination of HN‚Äôs stellar moderation team and maybe the focus/industry and the people it attracts. I‚Äôm not smart enough to understand completely <em>why</em> HN is so good, but one thing I know is that I rate the random seasoned HN user‚Äôs opinion over a lot of the rest of the internet, even when <a href="https://news.ycombinator.com/item?id=8863">most commenters on a topic are completely, hilariously wrong</a>, and routinely condescending/nitpicky.</p>
<p>The mix of early adopters, people with fresh ideas (and many dragging around many stale-but-good ideas like <a href="https://sqlite.org">SQLite</a> and <a href="https://www.postgresql.org">Postgres</a>), is often the right people to pan rough drafts of ideas and apps.</p>

<p>Anyway, getting back to the task at hand ‚Äì these days login has been federated/distributed for most social/non-social apps, thanks to a few different frameworks:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">Security Assertion Markup Language (SAML)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Central_Authentication_Service">Central Authentication Service (CAS)</a>
<ul>
<li>A bit different as authentication is centralized (it‚Äôs in the name!), but there are some federation features built in to later versions of the protocol</li>
<li>CAS is my personal favorite; v1 is simplest delegated Authentication (‚ÄúAuthN‚Äù) you‚Äôll find, so simple that I actually did write a <a href="https://github.com/t3hmrman/casgo">small CAS v1 implementation</a>) a while ago</li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/OAuth#OAuth_2.0">OAuth2</a> + <a href="https://en.wikipedia.org/wiki/OpenID#OpenID_Connect_(OIDC)">OpenID Connect</a>
<ul>
<li>OAuth2 actually is an Authorization (‚ÄúAuthZ‚Äù) protocol; you only know what someone can do as a given user, not that they <em>are</em> a given user.</li>
<li>OpenID Connect builds on OAuth2 to make it an AuthN protocol, by adding and endpoint that answers the ‚Äúwho are you‚Äù question (<code>/openid</code>)</li>
</ul>
</li>
</ul>
<p><strong>People are getting <em>very simple</em> login flows by just dropping ‚ÄúLogin with Google‚Äù or ‚ÄúLogin with Twitter‚Äù buttons on their pages!</strong> That‚Äôs something I‚Äôd love when building products for HackerNews.</p>
<p>Well, this is a short writeup on how I built <a href="https://loginwithhn.com">LoginWithHN</a> (Spoiler alert: it‚Äôs possible, and actually kind of an easy hack).</p>

<p>As usual, it‚Äôs good to <a href="https://en.wikipedia.org/wiki/RTFM">Read The Fucking Manual (RTFM)</a> ‚Äì first I needed to make sure that it <em>makes sense</em> to attempt to do what I‚Äôm trying to do. Simple questions:</p>
<ul>
<li>Does the login method <em>have</em> to be a password?</li>
<li>What are timelines like on token exchange?</li>
<li>How hard would this be to implement?</li>
<li>What technologies is most used for cross-site auth?</li>
</ul>
<p>If you‚Äôre not an OAuth expert, try to read at least some of the guides on delegated AuthN/AuthZ below. I recommend starting with CAS, as it‚Äôs the simplest and they all work very similarly.</p>
<ul>
<li><a href="https://developers.yale.edu/cas-central-authentication-service">CAS Protocol v1 (Yale docs)</a></li>
<li><a href="https://apereo.github.io/cas/6.2.x/protocol/CAS-Protocol-Specification.html">CAS Protocol v1/2/3</a>
<ul>
<li>I personally didn‚Äôt need a lot of the things in v2 &amp; v3 but maybe someone did.</li>
</ul>
</li>
<li><a href="https://oauth.net/getting-started/">OAuth 2.0 simplified by OAuth.net</a></li>
<li><a href="https://www.ory.sh/hydra/docs/concepts/oauth2/">OAuth2 Concept guide by Ory</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">An introduction to OAuth 2 by Digital Ocean</a></li>
<li><a href="https://developer.okta.com/blog/2019/10/21/illustrated-guide-to-oauth-and-oidc">An illustrated Guide to OAuth and OpenID Connect</a></li>
<li><a href="https://openid.net/connect/">OpenID Connect documentation</a></li>
<li><a href="https://support.okta.com/help/s/article/Beginner-s-Guide-to-SAML?language=en_US">Beginner‚Äôs Guide to SAML by Okta</a></li>
<li><a href="https://duo.com/blog/the-beer-drinkers-guide-to-saml">The Beer Drinker‚Äôs Guide to SAML by Duo Security</a></li>
</ul>
<p>After reading links above (or not) hopefully you come to the same conclusions I did:</p>
<p>OAuth2 + OpenIDConnect is the obvious answer here ‚Äì there‚Äôs no requirement for the login credentials to be a username/password (that‚Äôd be silly),  a username and password for (OAuth2 at least)</p>

<h2 id="the-ground-floor-setup">The ground-floor setup</h2>
<p>At this point I have a pretty set stack for the projects I want to build fast, and it looks like this:</p>
<ul>
<li><a href="https://nodejs.org/api/fs.html">NodeJS</a></li>
<li><a href="https://www.typescriptlang.org/docs">Typescript</a></li>
<li><a href="https://docs.nestjs.com">NestJS</a>
<ul>
<li>This might look like a head scratcher, but I find that <code>express</code> is actually <em>too</em> loose, most of the time ‚Äì I always end up writing in some sort of component system which manages lifecycle. NestJS is the best mix of pragmatism and ‚Äúenterprise‚Äù application creature comforts that I‚Äôve seen so far.</li>
</ul>
</li>
</ul>
<p>Obviously, the real question here is what should I use to provide the dynamic OIDC part of my flow? At first I chose <a href="https://github.com/panva/node-oidc-provider"><code>panva/node-oidc-provider</code></a>. The documentation is thorough but unfortunately the onboarding just <em>wasn‚Äôt easy enough</em> for me.</p>
<h2 id="first-try-nestjs-w-panvanode-oidc-provider">First try: NestJS w/ <code>panva/node-oidc-provider</code></h2>
<p>Unfortunately <code>node-oidc-provider</code> had no ready-to-use Postgres DB adapter ‚Äì there‚Äôs a <a href="https://github.com/panva/node-oidc-provider/blob/7d6b195424c539a8341e665aeabcaf50e7b5ab9a/example/adapters/contributed/sequelize.js">rough edge example</a>, but the more I read the documentation, and the more I implemented the surface of the API you needed to slot in the more I was convinced that it was just‚Ä¶ too hard.</p>
<p>A couple things went distinctively wrong:</p>
<ul>
<li>Integrating <code>node-oidc-provider</code> with NestJS was more difficult than I expected (everything‚Äôs just a <code>(req, res) =&gt; void</code> right? in the end it better to use a <code>Controller</code> rather than a NestJS <code>Middleware</code>)</li>
<li>Replicating the schema (so I could enshrine it in the database) of <code>node-oidc-provider</code> revealed a semi-<a href="https://en.wikipedia.org/wiki/Attribute-value_system">attribute-value style</a> layout</li>
</ul>
<p><strong>This project actually sat on the shelf for <em>6 months</em> during this time</strong>, as I had more important fish to fry ‚Äì thinking about it was a constant source of discontent. Funnily enough, I gave up just when I had figured everything out ‚Äì and I had just written a glorious DB adapter that actually worked like I wanted it to:</p>
<details>
<summary>üìúÔ∏è node-oidc-provider DB Adapter (click to expand)</summary>
  
  
  
  

  
    <div><pre tabindex="0"><code data-lang="typescript"><span>import</span> <span>{</span> <span>Logger</span> <span>}</span> <span>from</span> <span>&#34;@nestjs/common&#34;</span><span>;</span>
<span>import</span> <span>{</span> <span>DBService</span> <span>}</span> <span>from</span> <span>&#34;./services/db&#34;</span><span>;</span>
<span>import</span> <span>{</span>
  <span>getTypeForOIDCProviderModelName</span><span>,</span>
  <span>getTypeValidatorForOIDCProviderModelName</span><span>,</span>
  <span>OIDCProviderModel</span><span>,</span>
  <span>OIDCProviderModelID</span><span>,</span>
  <span>OIDCGrantID</span><span>,</span>
  <span>getOIDCModelPrefix</span><span>,</span>
  <span>isExpirableEntity</span><span>,</span>
  <span>isConsumableEntity</span><span>,</span>
  <span>isConsumableOIDCProviderModel</span><span>,</span>
<span>}</span> <span>from</span> <span>&#34;./types&#34;</span><span>;</span>

<span>import</span> <span>{</span>
  <span>OIDCGrant</span><span>,</span>
<span>}</span> <span>from</span> <span>&#34;./models&#34;</span><span>;</span>

<span>/**
</span><span> * Arguments required to build an oidc-provider adapter that uses a DBService
</span><span> * @see buildOIDCAdapter
</span><span> */</span>
<span>interface</span> <span>BuildDBOIDCAdapterArgs</span> <span>{</span>
  <span>db</span>: <span>DBService</span><span>;</span>
  <span>logger?</span>: <span>Logger</span><span>;</span>
<span>}</span>

<span>export</span> <span>type</span> <span>OIDCAdapterClassFunction</span> <span>=</span>  <span>(</span><span>name</span>: <span>string</span><span>)</span> <span>=&gt;</span> <span>void</span><span>;</span>

<span>/**
</span><span> * Builder for OIDC Adapter that uses a DBService
</span><span> *
</span><span> * @see https://github.com/panva/node-oidc-provider/blob/main/example/my_adapter.js
</span><span> * @param {BuildDBOIDCAdapterArgs} args
</span><span> * @returns {Promise&lt;Function&gt;} A constructor function that builds oidc-provider compliant functions
</span><span> */</span>
<span>export</span> <span>async</span> <span>function</span> <span>buildOIDCAdapter</span><span>(</span><span>args</span>: <span>BuildDBOIDCAdapterArgs</span><span>)</span><span>:</span> <span>Promise</span><span>&lt;</span><span>OIDCAdapterClassFunction</span><span>&gt;</span> <span>{</span>
  <span>const</span> <span>{</span> <span>db</span><span>,</span> <span>logger</span> <span>}</span> <span>=</span> <span>args</span><span>;</span>

  <span>// Create anonymous class that performans as an Adapter usable by oidc-provider
</span><span></span>  <span>return</span> <span>function</span> <span>DBOIDCAdapter</span><span>(</span><span>name</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>name</span> <span>=</span> <span>name</span><span>;</span>
    <span>this</span><span>.</span><span>db</span> <span>=</span> <span>db</span><span>;</span>

    <span>this</span><span>.</span><span>upsert</span> <span>=</span> <span>async</span> <span>(</span>
      <span>partialID</span>: <span>OIDCProviderModelID</span><span>,</span>
      <span>payload</span>: <span>OIDCProviderModel</span><span>,</span>
      <span>expiresInSeconds?</span>: <span>number</span><span>,</span>
    <span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>fullID</span> <span>=</span> <span>this</span><span>.</span><span>key</span><span>(</span><span>partialID</span><span>);</span>
      <span>const</span> <span>expiresAt</span> <span>=</span> <span>expiresInSeconds</span> <span>?</span> <span>new</span> <span>Date</span><span>(</span><span>new</span> <span>Date</span><span>().</span><span>getTime</span><span>()</span> <span>+</span> <span>(</span><span>expiresInSeconds</span> <span>*</span> <span>1000</span><span>))</span> <span>:</span> <span>null</span><span>;</span>

      <span>const</span> <span>modelClass</span> <span>=</span> <span>getTypeForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>);</span>
      <span>const</span> <span>validator</span> <span>=</span> <span>getTypeValidatorForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>);</span>

      <span>// Ensure the payload matches what we expect the model class to look like?
</span><span></span>      <span>if</span> <span>(</span><span>!</span><span>validator</span><span>(</span><span>payload</span><span>))</span> <span>{</span>
        <span>logger</span><span>?</span><span>.</span><span>error</span><span>(</span><span>`Invalid payload for OIDC model class [</span><span>${</span><span>modelClass</span><span>.</span><span>name</span><span>}</span><span>]: </span><span>${</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>payload</span><span>,</span> <span>null</span><span>,</span> <span>&#39;  &#39;</span><span>)</span><span>}</span><span>`</span><span>);</span>
        <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>`Invalid payload for OIDC model class [</span><span>${</span><span>modelClass</span><span>.</span><span>name</span><span>}</span><span>]`</span><span>);</span>
      <span>}</span>

      <span>// Grantable classes must have grant
</span><span></span>      <span>await</span> <span>db</span><span>.</span><span>upsertEntityByID</span><span>(</span><span>modelClass</span><span>,</span> <span>fullID</span><span>,</span> <span>{...</span><span>payload</span><span>,</span> <span>expiresAt</span> <span>});</span>
    <span>};</span>

    <span>this</span><span>.</span><span>find</span> <span>=</span> <span>async</span> <span>(</span><span>partialID</span>: <span>OIDCProviderModelID</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>cls</span> <span>=</span> <span>getTypeForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>);</span>
      <span>const</span> <span>fullID</span> <span>=</span> <span>this</span><span>.</span><span>key</span><span>(</span><span>partialID</span><span>);</span>
      <span>const</span> <span>entity</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>findEntity</span><span>(</span><span>cls</span><span>,</span> <span>{</span> <span>id</span>: <span>fullID</span> <span>});</span>
      <span>if</span> <span>(</span><span>!</span><span>entity</span><span>)</span> <span>{</span> <span>return</span> <span>undefined</span><span>;</span> <span>}</span>

      <span>if</span> <span>(</span><span>isExpirableEntity</span><span>(</span><span>entity</span><span>))</span> <span>{</span>
        <span>if</span> <span>(</span><span>new</span> <span>Date</span><span>()</span> <span>&lt;=</span> <span>entity</span><span>.</span><span>expiresAt</span><span>)</span> <span>{</span> <span>return</span> <span>undefined</span><span>;</span> <span>}</span>
      <span>}</span>

      <span>if</span> <span>(</span><span>isConsumableEntity</span><span>(</span><span>entity</span><span>))</span> <span>{</span>
        <span>if</span> <span>(</span><span>new</span> <span>Date</span><span>()</span> <span>&lt;</span> <span>entity</span><span>.</span><span>consumedAt</span><span>)</span> <span>{</span> <span>return</span> <span>undefined</span><span>;</span> <span>}</span>
      <span>}</span>

      <span>return</span> <span>entity</span><span>;</span>
    <span>};</span>

    <span>this</span><span>.</span><span>findByUserCode</span> <span>=</span> <span>async</span> <span>(</span><span>userCode</span>: <span>string</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>cls</span> <span>=</span> <span>getTypeForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>);</span>
      <span>const</span> <span>entity</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>findEntity</span><span>(</span><span>cls</span><span>,</span> <span>{</span> <span>userCode</span> <span>});</span>
      <span>if</span> <span>(</span><span>!</span><span>entity</span><span>)</span> <span>{</span> <span>return</span> <span>undefined</span><span>;</span> <span>}</span>
      <span>return</span> <span>entity</span><span>;</span>
    <span>};</span>

    <span>this</span><span>.</span><span>findByUid</span> <span>=</span> <span>async</span> <span>(</span><span>uid</span>: <span>string</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>cls</span> <span>=</span> <span>getTypeForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>);</span>
      <span>const</span> <span>entity</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>findEntity</span><span>(</span><span>cls</span><span>,</span> <span>{</span> <span>uid</span> <span>});</span>
      <span>if</span> <span>(</span><span>!</span><span>entity</span><span>)</span> <span>{</span> <span>return</span> <span>undefined</span><span>;</span> <span>}</span>
      <span>return</span> <span>entity</span><span>;</span>
    <span>};</span>

    <span>this</span><span>.</span><span>consume</span> <span>=</span> <span>async</span> <span>(</span><span>partialID</span>: <span>OIDCProviderModelID</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>fullID</span> <span>=</span> <span>this</span><span>.</span><span>key</span><span>(</span><span>partialID</span><span>);</span>
      <span>const</span> <span>cls</span> <span>=</span> <span>getTypeForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>);</span>

      <span>if</span> <span>(</span><span>!</span><span>isConsumableOIDCProviderModel</span><span>(</span><span>cls</span><span>))</span> <span>{</span>
        <span>throw</span> <span>new</span> <span>TypeError</span><span>(</span><span>`class [</span><span>${</span><span>cls</span><span>.</span><span>name</span><span>}</span><span>] is not consumable`</span><span>);</span>
      <span>}</span>

      <span>await</span> <span>db</span><span>.</span><span>consumeEntity</span><span>(</span><span>cls</span><span>,</span> <span>fullID</span><span>);</span>
    <span>};</span>

    <span>this</span><span>.</span><span>destroy</span> <span>=</span> <span>async</span> <span>(</span><span>partialID</span>: <span>OIDCProviderModelID</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>fullID</span> <span>=</span> <span>this</span><span>.</span><span>key</span><span>(</span><span>partialID</span><span>);</span>
      <span>await</span> <span>db</span><span>.</span><span>deleteEntity</span><span>(</span><span>getTypeForOIDCProviderModelName</span><span>(</span><span>this</span><span>.</span><span>name</span><span>),</span> <span>{</span> <span>id</span>: <span>fullID</span> <span>});</span>
    <span>};</span>

    <span>this</span><span>.</span><span>revokeByGrantId</span> <span>=</span> <span>async</span> <span>(</span><span>partialGrantID</span>: <span>OIDCGrantID</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>id</span> <span>=</span> <span>`grant_</span><span>${</span><span>partialGrantID</span><span>}</span><span>`</span><span>;</span>
      <span>const</span> <span>grant</span> <span>=</span> <span>await</span> <span>db</span><span>.</span><span>findEntity</span><span>&lt;</span><span>OIDCGrant</span><span>&gt;(</span><span>OIDCGrant</span><span>,</span> <span>{</span><span>id</span><span>});</span>
      <span>if</span> <span>(</span><span>!</span><span>grant</span><span>)</span> <span>{</span> <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>`No such OIDCGrant with ID [</span><span>${</span><span>id</span><span>}</span><span>]`</span><span>);</span> <span>}</span>

      <span>// Delete the grant and all related tokens
</span><span></span>      <span>await</span> <span>db</span><span>.</span><span>deleteGrantAndRelatedEntities</span><span>(</span><span>id</span><span>);</span>
    <span>};</span>

    <span>this</span><span>.</span><span>key</span> <span>=</span> <span>(</span><span>id</span>: <span>string</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>return</span> <span>`</span><span>${</span><span>getOIDCModelPrefix</span><span>(</span><span>this</span><span>.</span><span>name</span><span>)</span><span>}</span><span>_</span><span>${</span><span>id</span><span>}</span><span>`</span><span>;</span>
    <span>};</span>
  <span>};</span>
<span>}</span></code></pre></div>
  
</details>




<p>The pain of having to figure out every single one of those enums &amp; classes (<code>OIDCGrant</code>, <code>OIDCProviderModelID</code>), write the appropriate DB entities, and do the checks in a way that made sense to me, made me think: <strong>‚Äúwhy am I even using this library if I have to get this much into the weeds?&#34;</strong></p>
<p>I‚Äôm just too lazy to do this much work (to be fair I already did it but we‚Äôll ignore that).</p>
<p>Luckily for me I‚Äôd seen Ory and their extensive toolset before, and was able to recall one of their solutions that would help ‚Äì <a href="https://www.ory.sh/hydra/">Ory Hydra</a>.</p>
<h2 id="second-times-the-charm-nestjs--ory-hydra">Second time‚Äôs the charm: NestJS + Ory Hydra</h2>
<p>Ory‚Äôs got a lot of tools with interesting names, and it‚Äôs often hard to remember what they do, but <a href="https://www.ory.sh/hydra/">Hydra</a> is the one in the toolbelt that makes OAuth2+OpenID Connect flows a breeze (and I can confirm they do!). They‚Äôve got an excellent <a href="https://www.ory.sh/hydra/docs">documentation site</a>, the codebase is written in Golang (quite possibly the easiest to understand compiled language out there), and more importantly, <strong>they promise to take the complexity <em>out</em> of managing the OAuth2 flow</strong>.</p>
<p>I don‚Äôt manage any fo the grants revocation, etc, Hydra does the work for me.</p>
<h3 id="installing--running-ory-hydra">Installing &amp; running Ory Hydra</h3>
<p>Since Ory knows just how to appeal to developers, Hydra is a cinch to run locally with the <a href="https://hub.docker.com/r/oryd/hydra"><code>oryd/hydra</code> Docker container</a>:</p>
<div><pre tabindex="0"><code data-lang="makefile"><span>hydra-local</span><span>:</span>
    @echo -e <span>&#34;Running local hydra...\n\n&#34;</span>
    <span>$(</span>DOCKER<span>)</span> run --rm <span>\
</span><span></span>        -it <span>\
</span><span></span>        --network host <span>\
</span><span></span>        -p 0.0.0.0:<span>${</span><span>HYDRA_PUBLIC_PORT</span><span>}</span>:<span>${</span><span>HYDRA_PUBLIC_PORT</span><span>}</span> <span>\
</span><span></span>        -p 0.0.0.0:<span>${</span><span>HYDRA_ADMIN_PORT</span><span>}</span>:<span>${</span><span>HYDRA_ADMIN_PORT</span><span>}</span> <span>\
</span><span></span>        --name <span>${</span><span>HYDRA_CONTAINER_NAME</span><span>}</span> <span>\
</span><span></span>        -e <span>DSN</span><span>=</span><span>&#34;</span><span>${</span><span>HYDRA_DSN</span><span>}</span><span>&#34;</span> <span>\
</span><span></span>        -e <span>WEBFINGER_OIDC_DISCOVERY_SUPPORTED_CLAIMS</span><span>=</span><span>${</span><span>HYDRA_WEBFINGER_OIDC_DISCOVERY_SUPPORTED_CLAIMS</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_LOGIN</span><span>=</span><span>${</span><span>HYDRA_URLS_LOGIN</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_CONSENT</span><span>=</span><span>${</span><span>HYDRA_URLS_CONSENT</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_LOGOUT</span><span>=</span><span>${</span><span>HYDRA_URLS_LOGOUT</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_ERROR</span><span>=</span><span>${</span><span>HYDRA_URLS_ERROR</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_POST_LOGOUT_REDIRECT</span><span>=</span><span>${</span><span>HYDRA_URLS_POST_LOGOUT_REDIRECT</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_SELF_PUBLIC</span><span>=</span><span>${</span><span>HYDRA_URLS_SELF_PUBLIC</span><span>}</span> <span>\
</span><span></span>        -e <span>URLS_SELF_ISSUER</span><span>=</span><span>${</span><span>HYDRA_URLS_SELF_ISSUER</span><span>}</span> <span>\
</span><span></span>        -e <span>OAUTH2_ALLOWED_TOP_LEVEL_CLAIMS</span><span>=</span><span>${</span><span>HYDRA_OAUTH2_ALLOWED_TOP_LEVEL_CLAIMS</span><span>}</span> <span>\
</span><span></span>        -e <span>OAUTH2_HASHERS_BCRYPT_COST</span><span>=</span><span>${</span><span>HYDRA_OAUTH2_HASHERS_BCRYPT_COST</span><span>}</span> <span>\
</span><span></span>        -e <span>SECRETS_SYSTEM</span><span>=</span><span>${</span><span>HYDRA_SECRETS_SYSTEM</span><span>}</span> <span>\
</span><span></span>        -e <span>TTL_ACCESS_TOKEN</span><span>=</span><span>${</span><span>HYDRA_TTL_ACCESS_TOKEN</span><span>}</span> <span>\
</span><span></span>        -e <span>TTL_REFRESH_TOKEN</span><span>=</span><span>${</span><span>HYDRA_TTL_REFRESH_TOKEN</span><span>}</span> <span>\
</span><span></span>        -e <span>TTL_ID_TOKEN</span><span>=</span><span>${</span><span>HYDRA_TTL_ID_TOKEN</span><span>}</span> <span>\
</span><span></span>        --entrypoint /bin/ash <span>\
</span><span></span>        <span>${</span><span>HYDRA_IMAGE</span><span>}</span>:<span>${</span><span>HYDRA_IMAGE_TAG</span><span>}</span> <span>\
</span><span></span>        -c <span>&#34;\
</span><span>            /usr/bin/hydra migrate sql --yes &#39;</span><span>${</span><span>HYDRA_DSN</span><span>}</span><span>&#39;;\
</span><span>            /usr/bin/hydra serve all \
</span><span>            --dangerous-force-http \
</span><span>            --dangerous-allow-insecure-redirect-urls &#39;https://localhost&#39;\
</span><span>        &#34;</span>
</code></pre></div><p>OK so there‚Äôs a LOT of environment variables there, but just ignore em for now (if you ever do this you can actually <a href="https://www.ory.sh/hydra/docs/reference/configuration">look up what they do</a>).</p>
<p>I‚Äôve modified the <code>entrypoint</code> of the image because I want to do a few different things before I run <code>hydra</code>:</p>
<ul>
<li>Run the SQL migrations
<ul>
<li>As you might expect from any reasonably written DB-adjacent program, migrations are idempotent</li>
</ul>
</li>
<li>Serve <em>both</em> the public and admin API (<code>serve all</code>)</li>
<li>Allow <code>hydra</code> to operate over unsecured HTTP on localhost</li>
<li>Allow <code>hydra</code> to use insecure redirect URLs like HTTPS localhost (I actually don‚Äôt need this but it‚Äôs in the <code>Makefile</code> so I‚Äôll repeat it here)</li>
</ul>
<p>BTW: Just to ruffle some feathers out there ‚Äì if you think containerization isn‚Äôt a massively useful tool in 2022, you‚Äôre wrong.</p>
<p>If you‚Äôre with me at this point, you now have a working OAuth2+OpenID connect compliant server ‚Äì Done.</p>
<h3 id="create-yourself-an-oauth2openid-connect-client-app">Create yourself an OAuth2+OpenID Connect client app</h3>
<p>At this point we may have an OIDC compliant server, but we also need at least <em>one</em> client to make authentication requests to it!</p>
<p>You can do this quite easily by <code>docker exec</code>-ing into that container we started earlier:</p>
<div><pre tabindex="0"><code data-lang="makefile"><span>hydra-local-create-client</span><span>:</span>
    <span>$(</span>DOCKER<span>)</span> <span>exec</span> -it <span>\
</span><span></span>        <span>$(</span>HYDRA_CONTAINER_NAME<span>)</span> <span>\
</span><span></span>        hydra clients create lwhn <span>\
</span><span></span>            --endpoint<span>=</span><span>&#34;</span><span>$(</span>HYDRA_ADMIN_ENDPOINT_URL<span>)</span><span>&#34;</span> <span>\
</span><span></span>            --callbacks<span>=</span><span>&#34;</span><span>$(</span>LWHN_HYDRA_CLIENT_REDIRECT_URI<span>)</span><span>&#34;</span> <span>\
</span><span></span>            --id<span>=</span><span>$(</span>LWHN_HYDRA_CLIENT_ID<span>)</span> <span>\
</span><span></span>            --secret<span>=</span><span>$(</span>LWHN_HYDRA_CLIENT_SECRET<span>)</span> <span>\
</span><span></span>            --audience<span>=</span><span>&#34;</span><span>$(</span>LWHN_HYDRA_CLIENT_AUDIENCES<span>)</span><span>&#34;</span> <span>\
</span><span></span>            --post-logout-callbacks<span>=</span><span>&#34;</span><span>$(</span>LWHN_HYDRA_CLIENT_POST_LOGOUT_REDIRECT_URI<span>)</span><span>&#34;</span> <span>\
</span><span></span>            --grant-types<span>=</span>authorization_code <span>\
</span><span></span>            --response-types<span>=</span>code <span>\
</span><span></span>            --scope<span>=</span><span>$(</span>LWHN_HYDRA_CLIENT_SCOPES<span>)</span>
</code></pre></div><p>Hydra‚Äôs got excellent <a href="https://www.ory.sh/hydra/docs/cli/hydra-clients-create">documentation on the <code>hydra clients create</code> CLI</a>.</p>
<h3 id="integrating-hydra-into-our-app-and-later-other-apps">Integrating Hydra into our app (and later other apps)</h3>
<p>So we‚Äôve got an OAuth2 provider running, with a single OAuth client‚Ä¶ but we haven‚Äôt actually <em>written</em> the app that we‚Äôre going to use to manage or do anything!</p>
<p>What were we trying to do again? It‚Äôs a bit meta but try to stick with me ‚Äì <strong>LoginWithHN (LWHN) has three similar but slightly different integration points with Hydra:</strong></p>
<ul>
<li>Login implementation that Hydra depends on (‚Äúhydra calls this thing to actually do it‚Äôs job‚Äù)</li>
<li>Demo app uses Hydra as a customer (‚ÄúLWHN calls Hydra to actually do logins‚Äù)</li>
<li>Registration for <em>other client applications</em> (‚Äúother peoples&#39; apps use LoginWithHN to perform OAuth2 login‚Äù)</li>
</ul>
<p>Let‚Äôs shelf this for now though, because we‚Äôve hit on something we need to zoom out and solve ‚Äì <strong>how do we actually authenticate people from HN?</strong></p>

<p>Let‚Äôs zoom back out and build the actual login mechanism ‚Äì that shouldn‚Äôt be too hard to hack right?</p>
<p>Since HN has public profile pages that users can modify at any time, we can easily verify any user can access any account:</p>
<ol>
<li>Get the user‚Äôs username</li>
<li>Provide a unique code or phrase to put in their HN profile</li>
<li>Confirm the profile contains the expected text</li>
<li>Mark them as logged in</li>
</ol>
<p>As many on HN helpfully noted, I‚Äôm <a href="https://news.ycombinator.com/item?id=29929060">not</a> <a href="https://indieauth.com/">the</a> <a href="http://zacstewart.com/2012/12/24/verifying-minecraft-user-accounts.html">first</a> to use this sort of method, it‚Äôs been used to great effect in the past. The method really boils down to one important <code>setInterval</code>:</p>
<details>
<summary>üìúÔ∏è Important setInterval #1, checking the HN Profile  (click to expand)</summary>
  
  
  
  

  
    <div><pre tabindex="0"><code data-lang="typescript">    <span>// Start watching for account
</span><span></span>    <span>let</span> <span>times</span> <span>=</span> <span>0</span><span>;</span>
    <span>const</span> <span>intervalID</span> <span>=</span> <span>setInterval</span><span>(</span>
      <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>try</span> <span>{</span>
          <span>// If we&#39;ve exceeded max checks, then stop polling
</span><span></span>          <span>if</span> <span>(</span><span>times</span> <span>&gt;=</span> <span>maxChecks</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>ongoingPolls</span><span>.</span><span>delete</span><span>(</span><span>hnUsername</span><span>);</span>
            <span>clearInterval</span><span>(</span><span>intervalID</span><span>);</span>
            <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>`Exceeded max checks [</span><span>${</span><span>maxChecks</span><span>}</span><span>] (delayMs: </span><span>${</span><span>delayMs</span><span>}</span><span>)`</span><span>);</span>
          <span>}</span>
          <span>times</span><span>++</span><span>;</span>

          <span>// Check user&#39;s YC profile
</span><span></span>          <span>this</span><span>.</span><span>logger</span><span>.</span><span>debug</span><span>(</span><span>`looking for [</span><span>${</span><span>displayToken</span><span>}</span><span>] on HN profile [</span><span>${</span><span>hnUsername</span><span>}</span><span>]`</span><span>);</span>

          <span>// PREVIOUSLY:
</span><span></span>          <span>//
</span><span></span>          <span>// // FUTURE: if fallbacks get implemented, require that delay from ENV is no less than 30 seconds like before!
</span><span></span>          <span>// const resp = await axios.get(
</span><span></span>          <span>//   `https://news.ycombinator.com/user?id=${hnUsername}`,
</span><span></span>          <span>//   {responseType: &#39;text&#39;},
</span><span></span>          <span>// );
</span><span></span>          <span>//
</span><span></span>          <span>// const profileDataContainsCode = resp.data.includes(buildLoginTokenPhrase(displayToken));
</span><span></span>
          <span>// Get user data using Firebase HN API
</span><span></span>          <span>const</span> <span>resp</span> <span>=</span> <span>await</span> <span>axios</span><span>.</span><span>get</span><span>(</span><span>`https://hacker-news.firebaseio.com/v0/user/</span><span>${</span><span>hnUsername</span><span>}</span><span>.json`</span><span>);</span>

          <span>const</span> <span>about</span> <span>=</span> <span>resp</span><span>?</span><span>.</span><span>data</span><span>?</span><span>.</span><span>about</span><span>;</span>
          <span>if</span> <span>(</span><span>!</span><span>about</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>logger</span><span>.</span><span>error</span><span>(</span><span>&#34;About unexpectedly missing on response from Firebase API&#34;</span><span>);</span>
            <span>return</span><span>;</span>
          <span>}</span>

          <span>// If the profile data contained the right info, then clear the interval and mark the account logged in
</span><span></span>          <span>if</span> <span>(</span><span>!</span><span>about</span><span>.</span><span>includes</span><span>(</span><span>buildLoginTokenPhrase</span><span>(</span><span>displayToken</span><span>)))</span> <span>{</span> <span>return</span><span>;</span> <span>}</span>

          <span>// At this point we have found the display token, the user has confirmed usage of the account
</span><span></span>          <span>this</span><span>.</span><span>logger</span><span>.</span><span>debug</span><span>(</span><span>`found display token [</span><span>${</span><span>displayToken</span><span>}</span><span>] on HN profile [</span><span>${</span><span>hnUsername</span><span>}</span><span>]`</span><span>);</span>

          <span>// Confirm login success
</span><span></span>          <span>await</span> <span>this</span><span>.</span><span>dbSvc</span><span>.</span><span>confirmLoginSuccessByHNUsername</span><span>({</span>
            <span>hnUsername</span><span>,</span>
            <span>hnMetadata</span><span>:</span> <span>{</span>
              <span>karma</span>: <span>resp?.data?.karma</span><span>,</span>
              <span>// created is expected to be unix epoch
</span><span></span>              <span>createdAtISOString</span>: <span>new</span> <span>Date</span><span>(</span><span>resp</span><span>?</span><span>.</span><span>data</span><span>?</span><span>.</span><span>created</span> <span>*</span> <span>1000</span><span>).</span><span>toISOString</span><span>(),</span>
            <span>},</span>
          <span>});</span>

          <span>// Stop checking since it&#39;s been found
</span><span></span>          <span>this</span><span>.</span><span>ongoingPolls</span><span>.</span><span>delete</span><span>(</span><span>hnUsername</span><span>);</span>
          <span>clearInterval</span><span>(</span><span>intervalID</span><span>);</span>
        <span>}</span> <span>catch</span> <span>(</span><span>err</span><span>)</span> <span>{</span>
          <span>this</span><span>.</span><span>logger</span><span>.</span><span>error</span><span>(</span><span>`Error occurred while checking for HN profile page update: </span><span>${</span><span>err</span><span>.</span><span>toString</span><span>()</span><span>}</span><span>`</span><span>);</span>
        <span>}</span>
      <span>},</span>
      <span>delayMs</span><span>,</span>
    <span>);</span>
    <span>this</span><span>.</span><span>ongoingPolls</span><span>.</span><span>set</span><span>(</span><span>hnUsername</span><span>,</span> <span>displayToken</span><span>);</span></code></pre></div>
  
</details>




<p>And that‚Äôs basically it! you can imagine what <code>this.dbSvc</code> (in fact the abstraction is a bit off there, that should be something like <code>loginSvc</code> (which also exists!) but I digress.</p>
<h2 id="hooking-up-to-hydra-core-functionality">Hooking up to Hydra: Core functionality</h2>
<p>OK, now we‚Äôve got the basic functionality (well a sketch of it!) ‚Äì let‚Äôs hook it up to Hydra. Let‚Äôs start by RTFMing:</p>
<ul>
<li><a href="https://www.ory.sh/hydra/docs/concepts/login">Hydra docs on login flow</a></li>
<li><a href="https://www.ory.sh/hydra/docs/concepts/consent">Hydra docs on consent flow</a></li>
<li><a href="https://github.com/ory/hydra-login-consent-node/blob/master/src/routes/logout.ts">Hydra example login &amp; consent app in NodeJS</a></li>
</ul>
<p>Hydra‚Äôs gone above and beyond in providing this documentation and example app, so it‚Äôs smart to use/study them.</p>
<p><strong>We need to create the source of truth for the Hydra OAuth2/OpenID Connect facade</strong>.</p>
<p>Out of this came a few NestJS controllers and endpoints that mediate the flow, here‚Äôs one example:</p>
<details>
<summary>üìúÔ∏è Login controller (click to expand)</summary>
  
  
  
  

  
    <div><pre tabindex="0"><code data-lang="typescript">  <span>/**
</span><span>   * POST /api/v1/login/start
</span><span>   * Start the login process for a given user
</span><span>   *
</span><span>   * @param {LoginStartRequest} body
</span><span>   * @returns {Promise&lt;ResponseEnvelope&lt;void&gt;&gt;} A promise that resolves when the process has started
</span><span>   */</span>
  <span>@Post</span><span>(</span><span>&#39;/start&#39;</span><span>)</span>
  <span>async</span> <span>startLogin</span><span>(</span>
    <span>@Body</span><span>(</span><span>new</span> <span>ValidationPipe</span><span>())</span> <span>body</span>: <span>LoginStartRequest</span><span>,</span>
    <span>@Res</span><span>()</span> <span>res</span>: <span>Response</span><span>,</span>
  <span>)</span><span>:</span> <span>Promise</span><span>&lt;</span><span>void</span><span>&gt;</span> <span>{</span>
    <span>const</span> <span>{</span> <span>hnUsername</span><span>,</span> <span>loginChallenge</span> <span>}</span> <span>=</span> <span>body</span><span>;</span>
    <span>this</span><span>.</span><span>logger</span><span>?</span><span>.</span><span>debug</span><span>(</span><span>`received start login request [</span><span>${</span><span>hnUsername</span><span>}</span><span>]`</span><span>);</span>

    <span>// Ory login challenge stuff
</span><span></span>    <span>if</span> <span>(</span><span>!</span><span>loginChallenge</span><span>)</span> <span>{</span>
      <span>res</span><span>.</span><span>status</span><span>(</span><span>HttpStatus</span><span>.</span><span>BAD_REQUEST</span><span>).</span><span>send</span><span>(</span><span>&#34;Missing login challenge&#34;</span><span>);</span>
      <span>throw</span> <span>new</span> <span>BadRequestException</span><span>(</span><span>&#34;Missing login challenge&#34;</span><span>);</span>
      <span>return</span><span>;</span>
    <span>}</span>

    <span>// Get login request from Ory Hydra
</span><span></span>    <span>try</span> <span>{</span>
      <span>const</span> <span>hydraAdmin</span> <span>=</span> <span>await</span> <span>this</span><span>.</span><span>hydraSvc</span><span>.</span><span>getAdminAPI</span><span>();</span>

      <span>// Retrieve login request from Hydra
</span><span></span>      <span>const</span> <span>{</span> <span>data</span>: <span>loginRequest</span> <span>}</span> <span>=</span> <span>await</span> <span>hydraAdmin</span><span>.</span><span>getLoginRequest</span><span>(</span><span>loginChallenge</span><span>);</span>

      <span>// If skip is specified, we can automatically pass the user
</span><span></span>      <span>if</span> <span>(</span><span>loginRequest</span><span>.</span><span>skip</span><span>)</span> <span>{</span>
        <span>// Accept login request
</span><span></span>        <span>const</span> <span>{</span> <span>data</span>: <span>acceptLoginResp</span> <span>}</span> <span>=</span> <span>await</span> <span>hydraAdmin</span><span>.</span><span>acceptLoginRequest</span><span>(</span>
          <span>loginChallenge</span><span>,</span>
          <span>{</span> <span>subject</span>: <span>String</span><span>(</span><span>loginRequest</span><span>.</span><span>subject</span><span>)</span> <span>},</span>
        <span>);</span>

        <span>// Redirect to where Hydra says to
</span><span></span>        <span>res</span><span>.</span><span>redirect</span><span>(</span><span>acceptLoginResp</span><span>.</span><span>redirect_to</span><span>);</span>
        <span>return</span><span>;</span>
      <span>}</span>

      <span>// Save challenge ID for the account
</span><span></span>      <span>await</span> <span>this</span><span>.</span><span>dbSvc</span><span>.</span><span>updateEntityByQuery</span><span>(</span><span>Account</span><span>,</span> <span>{</span> <span>hnUsername</span> <span>},</span> <span>{</span> <span>hydraCurrentSessionID</span>: <span>loginRequest.session_id</span> <span>});</span>

      <span>this</span><span>.</span><span>logger</span><span>.</span><span>debug</span><span>(</span><span>`saved login request challenge with ID [</span><span>${</span><span>loginRequest</span><span>.</span><span>challenge</span><span>}</span><span>]`</span><span>);</span>

    <span>}</span> <span>catch</span> <span>(</span><span>err</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>logger</span><span>.</span><span>error</span><span>(</span><span>`Failed to login start w/ hydra: </span><span>${</span><span>err</span><span>.</span><span>toString</span><span>()</span><span>}</span><span>`</span><span>);</span>

      <span>// throw new InternalServerErrorException(&#34;Failed to process login challenge&#34;);
</span><span></span>      <span>res</span><span>.</span><span>redirect</span><span>(</span><span>&#34;/error&#34;</span><span>);</span>
      <span>return</span><span>;</span>
    <span>}</span>

    <span>// ****** HERE is where we start checking for the user! ******
</span><span></span>
    <span>// Start login for user, returning a map of mechanisms that the user can use
</span><span></span>    <span>const</span> <span>loginMechanism</span> <span>=</span> <span>await</span> <span>this</span><span>.</span><span>loginSvc</span><span>.</span><span>startLoginForAccountByHNUsername</span><span>({</span> <span>hnUsername</span><span>,</span> <span>loginChallenge</span> <span>});</span>

    <span>const</span> <span>response</span> <span>=</span> <span>{</span>
      <span>status</span>: <span>ResponseStatus.Success</span><span>,</span>
      <span>data</span><span>:</span> <span>{</span>
        <span>hnUsername</span><span>,</span>
        <span>loginMechanism</span><span>,</span>
      <span>}</span>
    <span>};</span>

    <span>// Send response back
</span><span></span>    <span>res</span><span>.</span><span>json</span><span>(</span><span>response</span><span>);</span>
  <span>}</span></code></pre></div>
  
</details>




<p>That‚Äôs what it looks like to <em>start</em> the login flow. What I haven‚Äôt included here is the bit where I generate a <code>login_challenge</code> from Hydra but it‚Äôs not hard to do (you‚Äôll get one by just setting up Hydra correctly).</p>
<p>It‚Äôs not quite clear from just that code but the <code>loginMechanism</code> that comes back is an object like this:</p>
<div><pre tabindex="0"><code data-lang="typescript"><span>export</span> <span>enum</span> <span>LoginMechanismName</span> <span>{</span>
  <span>PollHN</span> <span>=</span> <span>&#34;poll-hn&#34;</span><span>,</span>
  <span>TOTP</span> <span>=</span> <span>&#34;totp&#34;</span><span>,</span>
  <span>Email</span> <span>=</span> <span>&#34;email&#34;</span><span>,</span>
<span>}</span>

<span>export</span> <span>type</span> <span>HNUsername</span> <span>=</span> <span>string</span><span>;</span>
<span>export</span> <span>type</span> <span>PollHNLoginMechanism</span> <span>=</span> <span>{</span>
  <span>kind</span>: <span>LoginMechanismName.PollHN</span><span>;</span>
  <span>hnUsername</span>: <span>HNUsername</span><span>;</span>
  <span>displayToken</span>: <span>string</span><span>;</span>
<span>}</span>

<span>export</span> <span>type</span> <span>TOTPCode</span> <span>=</span> <span>number</span><span>;</span>
<span>export</span> <span>type</span> <span>TOTPLoginMechanism</span> <span>=</span> <span>{</span>
  <span>kind</span>: <span>LoginMechanismName.TOTP</span><span>;</span>
  <span>hnUsername</span>: <span>HNUsername</span><span>;</span>
<span>}</span>

<span>export</span> <span>type</span> <span>EmailAddress</span> <span>=</span> <span>string</span><span>;</span>
<span>export</span> <span>type</span> <span>EmailLoginMechanism</span> <span>=</span> <span>{</span>
  <span>kind</span>: <span>LoginMechanismName.Email</span><span>,</span>
  <span>hnUsername</span>: <span>HNUsername</span><span>;</span>
<span>}</span>

<span>export</span> <span>type</span> <span>LoginMechanism</span> <span>=</span> <span>PollHNLoginMechanism</span> <span>|</span> <span>TOTPLoginMechanism</span> <span>|</span> <span>EmailLoginMechanism</span><span>;</span>
</code></pre></div><p>Implementing the Hydra login and consent flows was easy, I‚Äôll avoid duplicating their documentation with this post. Similarly, including HN-specific data like karma count as OIDC claims was very easy during the Hydra integration.</p>
<p>LoginWithHN is obviously geared towards HN, but there are lots of other places people might want to login using a similar flow. Who knows when I‚Äôll get to it, but expansion is an interesting prospect.</p>

<p>So now we‚Äôve got the source of truth for Hydra in place, and we‚Äôve got a theoretically functional flow, let‚Äôs build the app that exposes that flow for a demo to anyone who visits! It‚Äôs not hard to build, but paradoxically the more interesting part is that there‚Äôs another important <code>setInterval</code> ‚Äì instead of just <code>POST</code>ing username/password details to our app and being whisked away to the OAuth2 server, we need to actually <em>wait</em> for a message to come back. I‚Äôve kept it simple with some polling:</p>
<details>
<summary>üìúÔ∏è The second important setInterval (click to expand)</summary>
  
  
  
  

  
    <div><pre tabindex="0"><code data-lang="javascript">  <span>// Start polling to check for resolution of login
</span><span></span>  <span>let</span> <span>intervalID</span> <span>=</span> <span>setInterval</span><span>(</span>
    <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>// Check whether the account has been confirmed using the display token
</span><span></span>      <span>fetch</span><span>(</span>
        <span>&#34;/api/v1/hn/poll/status&#34;</span><span>,</span>
        <span>{</span>
          <span>method</span><span>:</span> <span>&#34;POST&#34;</span><span>,</span>
          <span>headers</span><span>:</span> <span>{</span>
            <span>&#34;Content-Type&#34;</span><span>:</span> <span>&#34;application/json&#34;</span><span>,</span>
          <span>},</span>
          <span>credentials</span><span>:</span> <span>&#34;same-origin&#34;</span><span>,</span>
          <span>body</span><span>:</span> <span>JSON</span><span>.</span><span>stringify</span><span>({</span> <span>displayToken</span> <span>}),</span>
        <span>},</span>
      <span>)</span>
        <span>.</span><span>then</span><span>(</span><span>loginStartResp</span> <span>=&gt;</span> <span>processFetchJSONResponse</span><span>({</span> <span>response</span><span>:</span> <span>loginStartResp</span> <span>}))</span>
        <span>.</span><span>then</span><span>(</span><span>envelope</span> <span>=&gt;</span> <span>processLoginResultData</span><span>(</span><span>envelope</span><span>))</span>
        <span>.</span><span>then</span><span>(</span><span>loggedIn</span> <span>=&gt;</span> <span>{</span>
          <span>if</span> <span>(</span><span>!</span><span>loggedIn</span><span>)</span> <span>{</span> <span>return</span><span>;</span> <span>}</span>
          <span>// If login succeeded, then we can stop polling
</span><span></span>          <span>// Next steps should have been triggered in processLoginResultData() and will be triggering soon
</span><span></span>          <span>if</span> <span>(</span><span>indicatorElem</span><span>)</span> <span>{</span> <span>indicatorElem</span><span>.</span><span>classList</span><span>.</span><span>add</span><span>(</span><span>&#34;hidden&#34;</span><span>);</span> <span>}</span>

          <span>clearInterval</span><span>(</span><span>intervalID</span><span>);</span>
        <span>})</span>
        <span>.</span><span>catch</span><span>(</span><span>err</span> <span>=&gt;</span> <span>{</span>
          <span>showPageFlash</span><span>({</span>
            <span>variant</span><span>:</span> <span>&#34;error&#34;</span><span>,</span>
            <span>title</span><span>:</span> <span>&#34;Error while checking login&#34;</span><span>,</span>
            <span>description</span><span>:</span> <span>`An error occurred while checking your profile... Please try &lt;a href=&#34;/&#34;&gt;logging in again&lt;/a&gt;.`</span><span>,</span>
          <span>});</span>

          <span>if</span> <span>(</span><span>indicatorElem</span><span>)</span> <span>{</span> <span>indicatorElem</span><span>.</span><span>classList</span><span>.</span><span>remove</span><span>(</span><span>&#34;hidden&#34;</span><span>);</span> <span>}</span>

          <span>clearInterval</span><span>(</span><span>intervalID</span><span>);</span>
        <span>});</span>
    <span>},</span>
    <span>CHECK_HN_POLL_RESULT_INTERVAL_MS</span><span>,</span>
  <span>);</span>

<span>// You&#39;ll need this as well for context!
</span><span></span>
<span>/**
</span><span> * Process the data fterp a login result, as
</span><span> * all login methods produce the same LoginResultData object
</span><span> *
</span><span> * @returns {boolean} whether the login completed or not
</span><span> */</span>
<span>function</span> <span>processLoginResultData</span><span>(</span><span>envelope</span><span>)</span> <span>{</span>
  <span>// Ensure data is present
</span><span></span>  <span>if</span> <span>(</span><span>!</span><span>envelope</span><span>.</span><span>data</span><span>)</span> <span>{</span>
    <span>const</span> <span>err</span> <span>=</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;Data missing from envelope&#34;</span><span>);</span>
    <span>err</span><span>.</span><span>responseData</span> <span>=</span> <span>envelope</span><span>;</span>
    <span>throw</span> <span>err</span><span>;</span>
  <span>}</span>

  <span>// Ensure request succeeded
</span><span></span>  <span>if</span> <span>(</span><span>envelope</span><span>.</span><span>status</span> <span>!==</span> <span>&#34;success&#34;</span><span>)</span> <span>{</span>
    <span>genericErrorFlash</span><span>();</span>
    <span>console</span><span>.</span><span>error</span><span>(</span><span>err</span><span>);</span>
    <span>const</span> <span>err</span> <span>=</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;Login failed&#34;</span><span>);</span>
    <span>err</span><span>.</span><span>responseData</span> <span>=</span> <span>envelope</span><span>;</span>
    <span>throw</span> <span>err</span><span>;</span>
  <span>}</span>

  <span>// Get the redirect URL
</span><span></span>  <span>const</span> <span>{</span> <span>confirmed</span><span>,</span> <span>redirectURL</span> <span>}</span> <span>=</span> <span>envelope</span><span>.</span><span>data</span><span>;</span>

  <span>// Return immediately if the user is still not confirmed
</span><span></span>  <span>if</span> <span>(</span><span>!</span><span>confirmed</span><span>)</span> <span>{</span> <span>return</span> <span>false</span><span>;</span> <span>}</span>

  <span>if</span> <span>(</span><span>!</span><span>redirectURL</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>error</span><span>(</span><span>err</span><span>);</span>
    <span>const</span> <span>err</span> <span>=</span> <span>new</span> <span>Error</span><span>(</span><span>&#34;redirectURL unexpectedly missing from response&#34;</span><span>);</span>
    <span>err</span><span>.</span><span>responseData</span> <span>=</span> <span>envelope</span><span>;</span>
    <span>throw</span> <span>err</span><span>;</span>
  <span>}</span>

  <span>// Show flash signalling successful login
</span><span></span>  <span>showPageFlash</span><span>({</span>
      <span>variant</span><span>:</span> <span>&#34;success&#34;</span><span>,</span>
      <span>title</span><span>:</span> <span>&#34;Login successful&#34;</span><span>,</span>
      <span>description</span><span>:</span> <span>&#34;You&#39;ve been logged in! Redirecting...&#34;</span><span>,</span>
    <span>flashDurationMs</span><span>:</span> <span>DEFAULT_FLASH_DURATION_MS</span><span>,</span>
  <span>});</span>

  <span>// If the response succeeded, then the login cookie has been set,
</span><span></span>  <span>// we can go to the page to finish out the login
</span><span></span>  <span>setTimeout</span><span>(()</span> <span>=&gt;</span> <span>window</span><span>.</span><span>location</span> <span>=</span> <span>redirectURL</span><span>,</span> <span>LOGIN_SUCCESS_REDIRECT_WAIT_MS</span><span>);</span>

  <span>return</span> <span>true</span><span>;</span>
<span>}</span></code></pre></div>
  
</details>




<p>This time I‚Äôm checking in with the core functionality API to check whether the <code>setInterval</code> from earlier has resolved itself.</p>
<p>If the user <em>has</em> logged in properly we show a little message and use <code>window.location</code> redirect to the URL that you‚Äôd be redirectedto normally by <code>POST</code>ing your username/password.</p>
<p>And that‚Äôs all it really takes! Of course I‚Äôm missing <a href="https://knowyourmeme.com/memes/how-to-draw-an-owl">the rest of the owl</a>, but just believe me here ‚Äì it‚Äôs not that hard (you could do it yourself, probably in a day).</p>
<h2 id="hooking-up-to-hydra-setting-up-lwhn-to-onboard-other-client-apps">Hooking up to Hydra: Setting up LWHN to onboard other client apps</h2>
<p>To make this tool actually useful to <em>anyone else</em>, we‚Äôre going to have to enable other client apps to do login with HN <em>as well</em>. This is basically as simple as interacting with the <a href="https://www.ory.sh/hydra/docs/reference/api/#tag/admin">private Hydra administrative API</a> and creating clients when people sign up. Rather than dropping more code, I‚Äôll show the app I built to make it happen which was quite fun to build:</p>
<p><img src="https://notebook.wesleyac.com/images/lwhn-top-picture.png" alt="top of the LWHN app"/></p>
<p>And below there, an example integration and some instructions for various ways to integrate</p>
<p><img src="https://notebook.wesleyac.com/images/lwhn-integration-picture.png" alt="integration instructions below the fold of the LWHN app"/></p>

<p>One repeatedly requested feature was the ability to limit users based on HN karma.</p>
<p>Since it‚Äôs pretty fraught for <em>me</em> to determine where the limit should be, I just expose it.</p>
<p>It was quite easy to do, since <a href="https://github.com/HackerNews/API">the official HN API</a> produces user <code>karma</code> information:</p>
<div><pre tabindex="0"><code data-lang="typescript">          <span>// Confirm login success
</span><span></span>          <span>await</span> <span>this</span><span>.</span><span>dbSvc</span><span>.</span><span>confirmLoginSuccessByHNUsername</span><span>({</span>
            <span>hnUsername</span><span>,</span>
            <span>hnMetadata</span><span>:</span> <span>{</span>
              <span>karma</span>: <span>resp?.data?.karma</span><span>,</span>
              <span>// created is expected to be unix epoch
</span><span></span>              <span>createdAtISOString</span>: <span>new</span> <span>Date</span><span>(</span><span>resp</span><span>?</span><span>.</span><span>data</span><span>?</span><span>.</span><span>created</span> <span>*</span> <span>1000</span><span>).</span><span>toISOString</span><span>(),</span>
            <span>},</span>
          <span>});</span>
</code></pre></div><p>You‚Äôve seen this code before (it‚Äôs in the larger code listing above) but worth noting ‚Äì I just save it in the DB next to everything else when I confirm a successful login.</p>

<p>Though they‚Äôre related, <a href="https://news.ycombinator.com">HackerNews</a> is not <a href="https://ycombinator.com">Y Combinator</a>. Not every HN user is a YC founder, and one thing people have asked for a lot is <strong>being able to prove whether an HN user is indeed a YC founder</strong>. YC founders want to make things for YC founders (who they can get lightning-fast feedback from, etc), and maybe even some people who aren‚Äôt YC founders want to make things for YC founders.</p>
<p>Thanks to the help of <a href="https://badge.orangedao.xyz/">OrangeDAO</a> (which was recently <a href="https://techcrunch.com/2022/01/24/hundreds-of-y-combinator-alumni-join-crypto-collective-to-back-web3-startups/">covered by TechCrunch</a>), it‚Äôs actually quite easy to build in the functionality.</p>
<p>Stay tuned for when that drops (or don‚Äôt ‚Äì just go register now for an application and I‚Äôll email you!).</p>

<p>There‚Äôs more to do, but that‚Äôs it for today! For those following along at home, if you were writing code you‚Äôd have already succesfully built the functionality that makes LoginWithHN tick.</p>
<p>Thanks for coming along on this ride ‚Äì This project took a lot longer than it had to, but I‚Äôm glad to finally have it out there, and look forward to using it in my own projects. Building things for the HN community is always a joy, an hopefully now other people will have an option for getting auth hooked up that is extremely quick and easy to use.</p>

            
          </div>

        </div>
      </div></div>
  </body>
</html>
