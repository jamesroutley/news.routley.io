<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.ralfj.de/blog/2024/04/14/bubblebox.html">Original</a>
    <h1>Sandboxing all the things with Flatpak and BubbleBox</h1>
    
    <div id="readability-page-1" class="page"><article id="-content">
      <header>
    
    
</header>

<p>A few years ago, I have <a href="https://www.ralfj.de/blog/2019/03/09/firejail.html">blogged</a> about my approach to sandboxing less-trusted applications that I have to or want to run on my main machine.
The approach has changed since then, so it is time for an update.</p>

<!-- MORE -->

<p>Over time I grew increasingly frustrated with Firejail: configurations would frequently break on updates,
and debugging Firejail profiles is extremely hard. When considering all the included files, we are talking
about many hundred lines of configuration with a subtle interplay of allowlists and blocklists.
Even when I knew which folder I wanted to give access to, it was often non-trivial to ensure that
this access would actually be possible.</p>

<p>Now I am instead using a combination of two different approaches: Flatpak and BubbleBox.</p>

<h2 id="flatpak">Flatpak</h2>

<p>The easiest sandbox to maintain is the sandbox maintained by someone else.
So when a Flatpak exists for software I want to or have to use, such as Signal or Zoom, that is generally my preferred approach.</p>

<p>Unfortunately, Flatpaks can come with extremely liberal default profiles that make the sandbox mostly pointless.
The following global overrides help ensure that this does not happen:</p>
<div><div><pre><code>[Context]
sockets=!gpg-agent;!pcsc;!ssh-auth;!system-bus;!session-bus
filesystems=~/.XCompose:ro;xdg-config/fontconfig:ro;!~/.gnupg;!~/.ssh;!xdg-documents;!home;!host

[Session Bus Policy]
org.freedesktop.Flatpak=none
org.freedesktop.secrets=none
</code></pre></div></div>

<h2 id="bubblebox">BubbleBox</h2>

<p>However, not all software exists as Flatpak.
Also, sometimes I want software to run basically on my host system (i.e., to use the regular <code>/usr</code>), just without access to literally <em>everything</em> in my home directory.
Examples of this are Factorio and VSCodium.
The latter doesn’t work in Flatpak as I want to use it with LaTeX, and realistically this means it needs to run the LaTeX installed via <code>apt</code>.
The official recommendation is to effectively disable the Flatpak sandbox, but that entirely defeats the point, so I went looking for alternatives.</p>

<p><a href="https://github.com/containers/bubblewrap">bubblewrap</a> provides a very convenient solution: it can start an application in its own private filesystem namespace with full control over which part of the host file system is accessible from inside the sandbox.
I wrote a small wrapper around bubblewrap to make this configuration a bit more convenient to write and manage;
this project is called <a href="https://www.ralfj.de/projects/bubblebox">BubbleBox</a>.
This week-end I finally got around to adding support for <a href="https://github.com/flatpak/xdg-dbus-proxy">xdg-dbus-proxy</a> so that sandboxed applications can now access particular D-Bus functions without having access to the entire bus (which is in general not safe to expose to a sandboxed application).
That means it’s finally time to blog about this project, so here we go – if you are interested, check out <a href="https://www.ralfj.de/projects/bubblebox">BubbleBox</a>;
the project page explains how you can use it to set up your own sandboxing.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>I should also note that this is not the only bubblewrap-based sandboxing solution.
<a href="https://github.com/igo95862/bubblejail">bubblejail</a> is fairly similar but provides a configuration GUI and a good set of default provides;
it was a very useful resource when figuring out the right bubblewrap flags to make complex GUI applications work properly.
(Incidentally, “bubblejail” is also how I called my own script originally, but then I realized that the name is already taken.)
Joachim Breitner also recently <a href="https://www.joachim-breitner.de/blog/812-Convenient_sandboxed_development_environment">blogged</a> about his own bubblewrap-based sandboxing script.
There are many ways to do this, and it was fun to figure out my own solution.</p>

<p>Using bubblewrap and xdg-dbus-proxy for this was an absolute joy.
Both of these components came out of the Flatpak project, but the authors realized that they could be independently useful,
so in best Unix tradition they turned them into tools that provide all the required mechanism without hard-coding any sort of policy.
Despite doing highly non-trivial tasks, they are both pretty easy to use and compose and very well-documented.
Thanks a lot to everyone involved!</p>






    </article></div>
  </body>
</html>
