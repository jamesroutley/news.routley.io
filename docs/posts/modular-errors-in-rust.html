<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://sabrinajewson.org/blog/errors">Original</a>
    <h1>Modular Errors in Rust</h1>
    
    <div id="readability-page-1" class="page"><div><p id="published"><time datetime="2023-04-08">2023-04-08</time></p><nav><ul><li><a href="#blocks-txt">Case Study: A Blocks.txt Parser</a><ul><li><a href="#problem-1-backtraces">Problem 1: Backtraces</a></li><li><a href="#problem-2-inextensibility">Problem 2: Inextensibility</a></li><li><a href="#problem-3-error-matching">Problem 3: Error Matching</a></li><li><a href="#problem-4-privacy-and-stability">Problem 4: Privacy and Stability</a></li><li><a href="#problem-5-non-modularity">Problem 5: Non-Modularity</a></li></ul></li><li><a href="#guidelines-for-good-errors">Guidelines for Good Errors</a><ul><li><a href="#leveraging-source">Leveraging the <code>.source()</code> method</a></li><li><a href="#constructing-the-error-types">Constructing the error types</a></li><li><a href="#on-from">On <code>From</code></a></li><li><a href="#on-nearness">On “nearness”</a></li><li><a href="#verbosity">Verbosity</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li></ul></nav><p>It is thankfully common wisdom nowadays that documentation must be placed as near as possible to the code it documents, and should be fine-grained to a minimal unit of describability (the thing being documented). The practice provides numerous benefits to the codebase and project as a whole:</p><ol><li>When editing the source code, contributors are less likely to forget to update the documentation as well, ensuring it is kept up-to-date and accurate.</li><li>When reading the source code, reviewers can easily jump back and forth between the docs and the code it documents, helping them understand it and allowing them to contrast the expected with actual behaviour.</li><li>The codebase becomes more modular. Individual parts can be extracted into different crates or projects if necessary, and strong abstraction boundaries make the code easier to understand in small pieces.</li></ol><p>But you probably already knew this; after all, Rust made the excellent design choice of making it the by far easiest method of writing documentation at all. And you probably also know that these same principles apply to tests: when unit tests are kept next to their minimum unit of checkability, you get the same benefits of convenient updating, assisted understanding and modularity. And most Rust projects do use unit tests in this way (when they can, for often there are limitations that prevent it from working), which again we can thank the tooling for.</p><p>But that’s all old news. What I’m here to convince you of today is that this principle applies additionally to <em>error types</em>: that is, error types should be located near to their unit of fallibility. To illustrate this point, I will follow the initial development and later API improvement of a hypothetical Rust library.</p><h2 id="blocks-txt"><a href="#blocks-txt"></a>Case Study: A Blocks.txt Parser</h2><p>Suppose you’re a library author, and you’re working on a crate to implement the parsing of <a href="https://www.unicode.org/Public/UCD/latest/ucd/Blocks.txt">Blocks.txt</a> in the <a href="https://unicode.org/ucd/">Unicode Character Database</a>. If you’re not familiar with this file, it defines the list of so-called <a href="https://en.wikipedia.org/wiki/Unicode_block">Unicode blocks</a>, which are non-overlapping contiguous categories that Unicode characters can be sorted into. It looks a bit like this:</p><pre><code>0000..007F; Basic Latin
0080..00FF; Latin-1 Supplement
0100..017F; Latin Extended-A
0180..024F; Latin Extended-B
0250..02AF; IPA Extensions
</code></pre><p>This file tells you that, for example, the character “½”, <code>U+00BD</code>, is in the block “Latin-1 Supplement” because <code>0x0800 ≤ 0x00BD ≤ 0x00FF</code>. Every character has an associated block; characters which have not yet been assigned a block in the file above are considered to be in the special pseudo-block <code>No_Block</code>.</p><p>So let’s get started on a Rust parser. The specification for the format is given by <a href="https://www.unicode.org/reports/tr44/#Format_Conventions">section 4.2 of Unicode Annex #44</a>, but the format is so trivial you could almost guess it. Upon seeing this task, a typical Rustacean may write code like this:</p><pre><code><span>
<span><span>pub</span> <span>struct</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span>ranges</span><span>:</span> <span>Vec<span>&lt;</span><span>(</span><span>RangeInclusive<span>&lt;</span><span>u32</span><span>&gt;</span></span>, String<span>)</span><span>&gt;</span></span>,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span><span><span>pub</span> <span>fn</span> </span><span>from_file</span></span><span><span>&lt;</span>P<span>:</span> <span>AsRef<span>&lt;</span>Path<span>&gt;</span></span><span>&gt;</span></span><span><span><span>(</span><span>path</span><span>:</span> P</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, Error<span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>Self</span><span><span>::</span></span>from_str<span><span>(</span><span>&amp;</span><span>fs<span>::</span></span>read_to_string<span><span>(</span>path</span><span><span>)</span></span><span>?</span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>

	<span><span><span>pub</span> <span>fn</span> </span><span>download</span></span><span><span><span>(</span><span>agent</span><span>:</span> <span>&amp;</span><span>ureq<span>::</span></span>Agent</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, Error<span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>let</span> response <span>=</span> agent.<span>get</span><span><span>(</span><span>LATEST_URL</span></span><span><span>)</span></span>.<span>call</span><span><span>(</span></span><span><span>)</span></span><span>?</span><span>;</span>
		<span>Self</span><span><span>::</span></span>from_str<span><span>(</span><span>&amp;</span>response.<span>into_string</span><span><span>(</span></span><span><span>)</span></span><span>?</span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>FromStr <span>for</span></span><span> <span>Blocks</span> </span><span><span><span>{</span>
	<span>type</span> <span>Err</span> <span>=</span> Error<span>;</span>
	<span><span><span>fn</span> </span><span>from_str</span></span><span><span><span>(</span><span>s</span><span>:</span> <span>&amp;</span><span>str</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, <span><span><span>Self</span><span>::</span></span></span>Err<span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>let</span> ranges <span>=</span> s
			.<span>lines</span><span><span>(</span></span><span><span>)</span></span>
			.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>line</span><span>|</span></span> </span><span>line.<span>split_once</span><span><span>(</span><span><span>&#39;</span>#<span>&#39;</span></span></span><span><span>)</span></span>.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span><span>(</span></span><span><span>l</span><span>,</span> _</span><span><span>)</span></span><span>|</span></span> </span><span>l</span></span><span><span>)</span></span>.<span>unwrap_or</span><span><span>(</span>line</span><span><span>)</span></span></span></span><span><span>)</span></span>
			.<span>filter</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>line</span><span>|</span></span> </span><span><span>!</span>line.<span>is_empty</span><span><span>(</span></span><span><span>)</span></span></span></span><span><span>)</span></span>
			.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>line</span><span>|</span></span> </span><span><span><span>{</span>
				<span>let</span> <span><span>(</span>range<span>,</span> name</span><span><span>)</span></span> <span>=</span> line.<span>split_once</span><span><span>(</span><span><span>&#39;</span>;<span>&#39;</span></span></span><span><span>)</span></span>.<span>ok_or</span><span><span>(</span><span>Error<span>::</span></span>NoSemicolon</span><span><span>)</span></span><span>?</span><span>;</span>
				<span>let</span> <span><span>(</span>range<span>,</span> name</span><span><span>)</span></span> <span>=</span> <span><span>(</span>range.<span>trim</span><span><span>(</span></span><span><span>)</span></span><span>,</span> name.<span>trim</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
				<span>let</span> <span><span>(</span>start<span>,</span> end</span><span><span>)</span></span> <span>=</span> range.<span>split_once</span><span><span>(</span><span><span>&#34;</span>..<span>&#34;</span></span></span><span><span>)</span></span>.<span>ok_or</span><span><span>(</span><span>Error<span>::</span></span>NoDotDot</span><span><span>)</span></span><span>?</span><span>;</span>
				<span>let</span> start <span>=</span> <span>u32</span><span><span>::</span></span>from_str_radix<span><span>(</span>start<span>,</span> <span>16</span></span><span><span>)</span></span><span>?</span><span>;</span>
				<span>let</span> end <span>=</span> <span>u32</span><span><span>::</span></span>from_str_radix<span><span>(</span>end<span>,</span> <span>16</span></span><span><span>)</span></span><span>?</span><span>;</span>
				<span>Ok</span><span><span>(</span><span><span>(</span>start<span>..</span><span>=</span>end<span>,</span> name.<span>to_owned</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span></span><span><span>)</span></span>
			</span><span><span>}</span></span></span></span><span><span>)</span></span>
			.<span>collect<span>::</span></span><span><span>&lt;</span><span>Result<span>&lt;</span><span>Vec<span>&lt;</span><span>_</span><span>&gt;</span></span>, Error<span>&gt;</span></span><span>&gt;</span></span><span><span>(</span></span><span><span>)</span></span><span>?</span><span>;</span>
		<span>Ok</span><span><span>(</span><span>Self</span> <span><span>{</span> ranges </span><span><span>}</span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
</span></code></pre><p>Now we need to define an error type, so let’s just follow the “big <code><span><span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span> <span>enum</span></span></code>” convention and bash out some boilerplate that gets the job done:</p><pre><code><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>Error</span> <span><span>{</span>
	NoSemicolon<span>,</span>
	NoDotDot<span>,</span>
	ParseInt<span><span>(</span>ParseIntError</span><span><span>)</span></span><span>,</span>
	Io<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Ureq<span><span>(</span><span>Box<span>&lt;</span><span>ureq<span>::</span></span>Error<span>&gt;</span></span></span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>From<span>&lt;</span>ParseIntError<span>&gt;</span></span> <span>for</span></span><span> <span>Error</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>from</span></span><span><span><span>(</span><span>error</span><span>:</span> ParseIntError</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Self</span></span> </span><span><span><span>{</span>
		<span>Self</span><span><span>::</span></span>ParseInt<span><span>(</span>error</span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>From<span>&lt;</span><span>io<span>::</span></span>Error<span>&gt;</span></span> <span>for</span></span><span> <span>Error</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>from</span></span><span><span><span>(</span><span>error</span><span>:</span> <span>io<span>::</span></span>Error</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Self</span></span> </span><span><span><span>{</span>
		<span>Self</span><span><span>::</span></span>Io<span><span>(</span>error</span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>From<span>&lt;</span><span>ureq<span>::</span></span>Error<span>&gt;</span></span> <span>for</span></span><span> <span>Error</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>from</span></span><span><span><span>(</span><span>error</span><span>:</span> <span>ureq<span>::</span></span>Error</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Self</span></span> </span><span><span><span>{</span>
		<span>Self</span><span><span>::</span></span>Ureq<span><span>(</span><span>Box</span><span><span>::</span></span>new<span><span>(</span>error</span><span><span>)</span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>Error</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>match</span> <span>self</span> <span><span>{</span>
			<span>Self</span><span><span>::</span></span>NoSemicolon <span>=&gt;</span> f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>no semicolon<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>NoDotDot <span>=&gt;</span> f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>no `..` in character range<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>ParseInt<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Display<span>::</span></span>fmt<span><span>(</span>e<span>,</span> f</span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>Io<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Display<span>::</span></span>fmt<span><span>(</span>e<span>,</span> f</span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>Ureq<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Display<span>::</span></span>fmt<span><span>(</span>e<span>,</span> f</span><span><span>)</span></span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>std<span>::</span></span><span>error<span>::</span></span>Error <span>for</span></span><span> <span>Error</span> </span><span><span><span>{</span></span><span><span>}</span></span></span>
</span></code></pre><p>Lastly, a couple other bits and imports go at the end:</p><pre><code><span><span>pub</span> <span>const</span> <span>LATEST_URL</span><span>:</span> <span>&amp;</span><span>str</span> <span>=</span> <span><span>&#34;</span>https://www.unicode.org/Public/UCD/latest/ucd/Blocks.txt<span>&#34;</span></span><span>;</span>

<span>use</span> <span>std<span>::</span></span>cmp<span>;</span>
<span>use</span> <span>std<span>::</span></span>fmt<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>fmt<span>::</span></span>Display<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>fmt<span>::</span></span>Formatter<span>;</span>
<span>use</span> <span>std<span>::</span></span>fs<span>;</span>
<span>use</span> <span>std<span>::</span></span>io<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>num<span>::</span></span>ParseIntError<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>ops<span>::</span></span>RangeInclusive<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>path<span>::</span></span>Path<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>str<span>::</span></span>FromStr<span>;</span>
</span></code></pre><p>And we’re done.</p><p>There are a few small things to note with this code just before we move on:</p><ol><li>I omitted documentation, since it’s not relevant to the real example; in actual code, all the public items would be documented. Similarly, unit tests are omitted.</li><li>In a real library, one would not hard-depend on <a href="https://docs.rs/ureq">ureq</a> and <code>std</code> and would use feature-flags instead, but again I omitted that for this example.</li><li>You might have noticed I put my imports on separate lines each at bottom — I do have my reasons for this, but that’s best saved for another day ;)</li><li><code>Blocks</code> implements <a href="https://doc.rust-lang.org/stable/std/str/trait.FromStr.html"><code>FromStr</code></a>, but not <a href="https://doc.rust-lang.org/stable/std/convert/trait.TryFrom.html"><code><span><span>TryFrom<span>&lt;</span><span>&amp;</span><span>str</span><span>&gt;</span></span></span></code></a>. This is actually intentional, because despite being nearly identical traits signature-wise they mean two very different things: <code>FromStr</code> implies <em>parsing</em> from a string whereas <code><span><span>TryFrom<span>&lt;</span><span>&amp;</span><span>str</span><span>&gt;</span></span></span></code> is for when your data type <em>is</em> a subset of all strings. In our case, <code>FromStr</code> is the correct one to use.</li><li>The <code>Display</code> implementation of <code>Error</code> formats error messages like <code>no semicolon</code> in lowercase and without a full stop at the end — this is in accordance with <a href="https://doc.rust-lang.org/stable/std/error/trait.Error.html">conventions established by the Standard Library</a> (“Error messages are typically concise lowercase sentences without trailing punctuation”). A common pitfall of both new and experienced Rustaceans is using incorrect casing for error messages.</li><li>Another common pitfall is naming things like what we’ve named <code>Error::Io</code> as <code>Error::IoError</code> instead. Simply: you don’t need the <code>Error</code> suffix, it says it in the name already!</li><li>One could use the <a href="https://docs.rs/thiserror/latest/thiserror/">thiserror</a> crate to shorten the code by using a <code><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Error</span></span><span><span><span>)</span></span></span><span>]</span></span></span></code>. Personally, I would never use this for a library crate since it’s really not that many lines of code saved for a whole extra dependency, but you might want to know about it.</li><li>The <code>Ureq</code> variant of the <code>Error</code> enum is boxed because <code>ureq::Error</code> is actually very large and Clippy complains about it.</li></ol><p>So there we have it: our perfect little library, let’s go off and publish it to crates.io.</p><p>What we’ve written so far, with regard to error handling, is what I’d say most libraries on crates.io do. It’s by far the most <em>common</em> way of handling errors: just stick everything in a big <code><span><span>enum</span></span></code> of “different ways things can go wrong in the library” and don’t think about it after that. But unfortunately, while it is <em>common</em> it is not exactly <em>good</em>, for a few reasons the rest of this post will be covering.</p><h3 id="problem-1-backtraces"><a href="#problem-1-backtraces"></a>Problem 1: Backtraces</h3><p>Suppose you then decide to use your library in a CLI application; and as per usual advice and your own experience, you decide to use <a href="https://docs.rs/anyhow">anyhow</a> to handle the errors in it. So you write out all your code and it looks a little like this:</p><pre><code><span><span><span><span>fn</span> </span><span>main</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>anyhow<span>::</span></span><span>Result<span>&lt;</span><span>(</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
	<span>init_something</span><span><span>(</span></span><span><span>)</span></span><span>?</span><span>;</span>
	<span>let</span> blocks <span>=</span> <span>Blocks<span>::</span></span>from_file<span><span>(</span><span><span>&#34;</span>Blocks.txt<span>&#34;</span></span></span><span><span>)</span></span><span>?</span><span>;</span>
	<span>init_something_else</span><span><span>(</span></span><span><span>)</span></span><span>?</span><span>;</span>
		<span>Ok</span><span><span>(</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span>
</span><span><span>}</span></span></span>

<span>use</span> <span>unicode_blocks<span>::</span></span>Blocks<span>;</span>
</span></code></pre><p>Looks good, so you go ahead and run it — only, you’re rather abruptly met with:</p><pre><code>Error: invalid digit found in string
</code></pre><p>Um, okay. That doesn’t help us very much at all. What went wrong here?</p><p>Well, much pain and many <code>dbg!</code> statements later, you discover that the culprit is that somehow, on line 223 of <code>Blocks.txt</code> you replaced a <code>0</code> with an <code>O</code>. Oops!</p><pre><code><span><span><span>@@</span> <span>-222,3 +222,3</span> <span>@@</span>
</span> 10800..1083F; Cypriot Syllabary
<span><span>-</span>10840..1O85F; Imperial Aramaic
</span><span><span>+</span>10840..1085F; Imperial Aramaic
</span> 10860..1087F; Palmyrene
</span></code></pre><p>And then you run it again and it works fine.</p><p>But it didn’t have to be this hard. The error message <em>could</em> have displayed something more useful, and maybe this is just a pipe dream, but I’ve seen <code>anyhow</code> emit this sort of thing before:</p><pre><code>Error: error reading `Blocks.txt`

Caused by:
	0: invalid Blocks.txt data on line 223
	1: one end of range is not a valid hexidecimal integer
	2: invalid digit found in string
</code></pre><p>That’s so much more helpful — you wouldn’t ever have had to suspect <code>init_something</code> and <code>init_something_else</code> as potential causes of the error, or even search <code>Blocks.txt</code> for mistakes, it completely guides you to exactly where it went wrong!</p><p>Oh well, you say to yourself, at least this time it was decently obvious where the source of the error came from; at least I wasn’t getting a <a href="https://github.com/tokio-rs/mio/issues/1444">file not found error from <code>TcpListener::bind</code></a> (the natural conclusion to this kind of “flat”-style error handling). But wouldn’t it be nice if all errors came with backtrace and context tracking built-in?</p><h3 id="problem-2-inextensibility"><a href="#problem-2-inextensibility"></a>Problem 2: Inextensibility</h3><p>At least one of the things in the above image looks feasible to fix though: adding line numbers as context to the error messages. All we have to do is return to our <code>Error</code> enum and add more fields to the <code>NoSemicolon</code>, and <code>NoDotDot</code>, and <code>ParseInt</code>, variants:</p><pre><code><span><span><span>pub</span> <span>enum</span> <span>Error</span> <span><span>{</span>
	NoSemicolon <span><span>{</span> line<span>:</span> <span>usize</span> </span><span><span>}</span></span><span>,</span>
	NoDotDot <span><span>{</span> line<span>:</span> <span>usize</span> </span><span><span>}</span></span><span>,</span>
	ParseInt <span><span>{</span> line<span>:</span> <span>usize</span><span>,</span> source<span>:</span> ParseIntError </span><span><span>}</span></span><span>,</span>
	Io<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Ureq<span><span>(</span><span>Box<span>&lt;</span><span>ureq<span>::</span></span>Error<span>&gt;</span></span></span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>
</span></code></pre><p>Except… we can’t do that without breaking backward compatibility, because while the enum itself is <code><span><span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span></span></code> the individual variants aren’t, meaning you’ve fixed them to forever have the fields they do currently (without breaking changes).</p><h3 id="problem-3-error-matching"><a href="#problem-3-error-matching"></a>Problem 3: Error Matching</h3><p>Okay, so back to the application. You’ve now realized that you still want to call <code><span><span>Blocks<span>::</span></span>from_file<span><span>(</span><span><span>&#34;</span>Blocks.txt<span>&#34;</span></span></span><span><span>)</span></span></span></code>, but if it fails with a “file not found” error you actually want to download the file automatically instead of exiting the program entirely. We have to match on the <code><span><span>Result</span></span></code> for that:</p><pre><code><span><span>let</span> blocks <span>=</span> <span>match</span> <span>Blocks<span>::</span></span>from_file<span><span>(</span><span><span>&#34;</span>Blocks.txt<span>&#34;</span></span></span><span><span>)</span></span> <span><span>{</span>
	<span>Ok</span><span><span>(</span>blocks</span><span><span>)</span></span> <span>=&gt;</span> blocks<span>,</span>
	<span>Err</span><span><span>(</span><span>unicode_blocks<span>::</span></span><span>Error<span>::</span></span>Io<span><span>(</span>e</span><span><span>)</span></span></span><span><span>)</span></span> <span>if</span> e.<span>kind</span><span><span>(</span></span><span><span>)</span></span> <span>=</span><span>=</span> <span>io<span>::</span></span><span>ErrorKind<span>::</span></span>NotFound <span>=&gt;</span> <span><span>{</span>
			</span><span><span>}</span></span>
</span><span><span>}</span></span><span>;</span>
</span></code></pre><p>Great! But the compiler is yelling that the <code><span><span>match</span></span></code> arms aren’t exhaustive. Not too hard to fix, let’s look at the cases we need to deal with:</p><ul><li><code>NoSemicolon</code>, <code>NoDotDot</code>, <code>ParseInt</code>: Those are pretty obvious, they look like parsing errors, so we can just propagate them.</li><li><code>Io</code>: Other I/O errors than “file not found” can also safely be propagated.</li><li><code>Ureq</code>: Ummm…? Wait, is this function doing HTTP requests? Let me check the source code again… [please stand by…] oh okay, so it’s not. Then I could add an <code><span><span>unreachable!</span><span><span>(</span></span><span><span>)</span></span></span></code> here which would be correct and indicates semantics nicely; on the other hand, nowhere is it written in the documentation of the API that it <em>won’t</em> ever return this, so maybe I should just propagate it anyway?</li><li>Oh, and I forgot, we added <code>#[non_exhaustive]</code> to <code><span><span><span>enum</span> <span>Error</span></span></span></code> so there’s always the possibility of it returning a variant that doesn’t exist yet. Well, I guess we can just propagate it anyway.</li></ul><p>So, this situation isn’t ideal. The library doesn’t document anywhere what errors a given function <em>can</em> return, so users are often left shooting in the dark. From personal experience, there have been many times I have seen an error variant which was appropriate for me to catch, then I had to spend ages digging around in the source code to find out whether it was <em>actually</em> generated or not — and even an answer to that doesn’t constitute an API guarantee that it will or won’t be in future.</p><p>Another issue with the code that we’ve written is that it’s entirely non-obvious that our <code><span><span>match</span></span></code> arm refers specifically to the <code>Blocks.txt</code> file not being found. The arm itself just says “check if an I/O not found error occurred”, but in theory, and especially for more complex functions, an I/O not found error could mean one of several different things that the user can no longer differentiate between because they were all put together in a single <code>Io</code> variant.</p><h3 id="problem-4-privacy-and-stability"><a href="#problem-4-privacy-and-stability"></a>Problem 4: Privacy and Stability</h3><p>One very common mistake libraries make with this style of big-<code><span><span>enum</span></span></code> error is accidentally exposing dependencies intended to be private in their public API through error types. In our example code, suppose <code>std::fs</code> and <code>io::Error</code> weren’t part of the standard library but were rather types from an external library that was on version <code>0.4</code>. Now, when they bump their version to <code>0.5</code> I <em>also</em> have to make a breaking change to update it to the newer version, because I exposed the <code>io::Error</code> type in my public API through the <code>Error</code> enum, even though I never expose my usage of the library anywhere else (it’s covered up by the opaque interface of <code>from_file</code>). The same issue occurs if I tried to switch out my usage of that library for a different one; it also forbids me from ever releasing 1.0 until the dependency library also reaches 1.0 as per the <a href="https://rust-lang.github.io/api-guidelines/necessities.html#public-dependencies-of-a-stable-crate-are-stable-c-stable">C-STABLE</a> API requirement.</p><p>This is hard to fix with this approach to errors, because <code><span><span>enum</span></span></code> data is hardcoded to always use inherited visibility, meaning if the outer <code><span><span>enum</span></span></code> fields are public <em>all</em> inner fields are too. Private fields are also useful in errors in general, for reasons other than stability: private fields are just generally a nice feature to have on types.</p><h3 id="problem-5-non-modularity"><a href="#problem-5-non-modularity"></a>Problem 5: Non-Modularity</h3><p>And lastly, touching back on what I mentioned at the beginning of this article: this approach to error handling is <em>non-modular</em>. I couldn’t easily take a component alone, like the parser, and extract it to a different crate, because I’d have to change many APIs or otherwise hack around it. Every API is interconnected with each other through the underlying error type, tying the crate together in a big knot that makes it difficult to untangle and remove stuff.</p><p>This kind of non-modularity also makes the codebase more difficult to understand: one is forced, to a greater degree, to learn the entire codebase at once to work on it, rather than learn it piece by piece, a far preferable way of learning.</p><h2 id="guidelines-for-good-errors"><a href="#guidelines-for-good-errors"></a>Guidelines for Good Errors</h2><p>So the current error type we have has problems. But how do we fix them? And this is where we bring in that principle from the start:</p><blockquote><p>Error types should be located near to their unit of fallibility.</p></blockquote><p>The key phrase here is “unit of fallibility”. What are the units of fallibility in our library? Well, it’s certainly not <em>the library itself</em> — the library is just a way of interacting with Unicode blocks, and it’s not like that can particularly fail. The only libraries that <em>would</em> have the entire library as a unit of fallibility are those whose only purpose is to perform a single operation (they typically have an API surface of no more than two functions, maybe a <code>Params</code> builder type, and nothing more).</p><p>This tells us that the <code>unicode_blocks::Error</code> type is inherently misguided. Rather, the units of fallibility in our case are the <em>operations we do</em>, like downloading, reading a file, and parsing.</p><p>Now, things get a little subjective at this point on deciding what counts as two separate units or the same unit. In general, you should ask yourself the following two questions:</p><ol><li>Do they have different ways in which they can fail?</li><li>Should they show different error messages should they fail?</li></ol><p>If the answer to either of those questions is “yes”, then they should normally be separate error types.</p><p>For us, this means we actually want <em>three</em> separate error types:</p><ol><li><code>FromFileError</code>, for errors in <code>Blocks::from_file</code>;</li><li><code>DownloadError</code>, for errors in <code>Blocks::download</code>;</li><li><code>ParseError</code>, for errors in <code>from_str</code>.</li></ol><h3 id="leveraging-source"><a href="#leveraging-source"></a>Leveraging the <code>.source()</code> method</h3><p>Earlier, we said we wanted our error messages (printed with <code>anyhow</code>) to look good, like this:</p><pre><code>Error: error reading `Blocks.txt`

Caused by:
	0: invalid Blocks.txt data on line 223
	1: one end of range is not a valid hexidecimal integer
	2: invalid digit found in string
</code></pre><p>So how do we get <code>anyhow</code> to print this? It turns out what the library calls internally is the <a href="https://doc.rust-lang.org/stable/std/error/trait.Error.html#method.source"><code>Error::source()</code></a> method, a default-implemented method of the <code>Error</code> trait that tells you the cause of an error. What we see in the above graphic depicts:</p><ol><li>an error type (we know to be <code>FromFileError</code>) whose <code>Display</code> implementation prints “error reading <code>Blocks.txt</code>”, and whose <code>source</code> is…</li><li>…another error type, whose <code>Display</code> implementation prints “invalid Blocks.txt data on line 223”, and whose <code>source</code> is…</li><li>…another error type, whose <code>Display</code> implementation prints “one end of range is not a valid hexidecimal integer”, and whose <code>source</code> is…</li><li>…another error type (we know to be <code>ParseIntError</code>) whose <code>Display</code> implementation prints “invalid digit found in string” and whose <code>source</code> is <code>None</code>.</li></ol><p>That might seem like a lot of layers, but they all map very nicely to our code: layer 1 is a <code>FromFileError</code>, layer 2 has to be our <code>ParseError</code>, layer 3 has to be something contained within the <code>ParseError</code>, and layer 4 is <code>ParseIntError</code>.</p><p>This leads us to a much nicer structure for the error types in the <code>from_file</code> API.</p><pre><code><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>FromFileError</span> </span><span><span><span>{</span>
	<span>pub</span> <span>path</span><span>:</span> <span>Box<span>&lt;</span>Path<span>&gt;</span></span>,
	<span>pub</span> <span>kind</span><span>:</span> FromFileErrorKind,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>FromFileError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>error reading `<span>{}</span>`<span>&#34;</span></span></span><span><span>,</span> <span>self</span>.path.<span>display</span><span><span>(</span></span><span><span>)</span></span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>FromFileError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>match</span> <span>&amp;</span><span>self</span>.kind <span><span>{</span>
			<span>FromFileErrorKind<span>::</span></span>ReadFile<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
			<span>FromFileErrorKind<span>::</span></span>Parse<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>FromFileErrorKind</span> <span><span>{</span>
	ReadFile<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Parse<span><span>(</span>ParseError</span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>
</span></code></pre><p>This error:</p><ul><li>has very good backtraces, as it implements <code>Display</code> and <code>source()</code> well;</li><li>is extensible, as the <code><span><span>struct</span></span></code> is attributed with <code><span><span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span></span></code>;</li><li>supports precise error matching, as we’ve now <em>automatically</em> given the public API guarantee that we won’t produce HTTP errors from our function, so our users needn’t worry about dealing with that case;</li><li>makes it clear where the <code>io::Error</code>s can come from, because the variant is named <code>ReadFile</code> instead of simply <code>Io</code>;</li><li>would easily be able to adjust to support hiding <code>io::Error</code> from the public API surface simply by making <code>kind</code> and <code>FromFileErrorKind</code> private;</li><li>is entirely modular, being conceptually contained within the <code>from_file</code> logic portion of the code, so it can be extracted, learnt independently, et cetera.</li></ul><p><code>ParseError</code> can be defined in a somewhat similar fashion, also with the above benefits.</p><pre><code><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>ParseError</span> </span><span><span><span>{</span>
	<span>pub</span> <span>line</span><span>:</span> <span>usize</span>,
	<span>pub</span> <span>kind</span><span>:</span> ParseErrorKind,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>ParseError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>invalid Blocks.txt data on line <span>{}</span><span>&#34;</span></span></span><span><span>,</span> <span>self</span>.line <span>+</span> <span>1</span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>ParseError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>Some</span><span><span>(</span><span>&amp;</span><span>self</span>.kind</span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>ParseErrorKind</span> <span><span>{</span>
	<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
	NoSemicolon<span>,</span>
	<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
	NoDotDot<span>,</span>
	<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
	ParseInt <span><span>{</span> source<span>:</span> ParseIntError </span><span><span>}</span></span><span>,</span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>ParseErrorKind</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>match</span> <span>*</span><span>self</span> <span><span>{</span>
			<span>Self</span><span><span>::</span></span>NoSemicolon <span>=&gt;</span> f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>no semicolon<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>NoDotDot <span>=&gt;</span> f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>no `..` in range<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>ParseInt <span><span>{</span> <span>..</span> </span><span><span>}</span></span> <span>=&gt;</span> <span><span>{</span>
				f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>one end of range is not a valid hexadecimal integer<span>&#34;</span></span></span><span><span>)</span></span>
			</span><span><span>}</span></span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>ParseErrorKind</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>match</span> <span>self</span> <span><span>{</span>
			<span>Self</span><span><span>::</span></span>ParseInt <span><span>{</span> source </span><span><span>}</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>source</span><span><span>)</span></span><span>,</span>
			<span>_</span> <span>=&gt;</span> <span>None</span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
</span></code></pre><p>Note that the <code><span><span>enum</span></span></code> variants themselves are <code><span><span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span></span></code>, so that they can be extended in future with more information.</p><p>There is a slight deviation from <code>FromFileError</code>’s design here, that its corresponding <code>*Kind</code> type actually implements <code>Display</code> and <code>Error</code> in and of itself instead of simply existing as a data holder for other error types. The logic is that while we could separate make unit structs for <code>NoSemicolon</code>, <code>NoDotDot</code> and <code>ParseInt</code>, it just isn’t very necessary here (where on the other hand <code>io::Error</code> is an external type and <code>ParseError</code> is required to be a distinct type because of <code>FromStr</code>). However, sometimes it is still better to make unit structs: it depends on the use case.</p><p>Finally, <code>DownloadError</code> showcases a similar pattern (although it’s not that interesting at this point):</p><pre><code><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>DownloadError</span> </span><span><span><span>{</span>
	<span>pub</span> <span>kind</span><span>:</span> DownloadErrorKind,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>DownloadError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>failed to download Blocks.txt from the Unicode website<span>&#34;</span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>DownloadError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>match</span> <span>&amp;</span><span>self</span>.kind <span><span>{</span>
			<span>DownloadErrorKind<span>::</span></span>Request<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
			<span>DownloadErrorKind<span>::</span></span>ReadBody<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
			<span>DownloadErrorKind<span>::</span></span>Parse<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>DownloadErrorKind</span> <span><span>{</span>
	Request<span><span>(</span><span>Box<span>&lt;</span><span>ureq<span>::</span></span>Error<span>&gt;</span></span></span><span><span>)</span></span><span>,</span>
	ReadBody<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Parse<span><span>(</span>ParseError</span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>
</span></code></pre><p>Note that we could have merged <code>DownloadErrorKind</code> and <code>DownloadError</code> into a single type; I chose not to here in favour of extensibility, because it seems quite possible that one would want to add more fields to <code>DownloadError</code> in future. But for some cases it definitely makes sense.</p><h3 id="constructing-the-error-types"><a href="#constructing-the-error-types"></a>Constructing the error types</h3><p>If you try to implement the functions that return these error types, you’ll quickly run into something rather annoying: they require quite a bit of boilerplate to use. For example, the body of <code>from_file</code> now looks like this:</p><pre><code><span><span><span><span>pub</span> <span>fn</span> </span><span>from_file</span></span><span><span>&lt;</span>P<span>:</span> <span>AsRef<span>&lt;</span>Path<span>&gt;</span></span><span>&gt;</span></span><span><span><span>(</span><span>path</span><span>:</span> P</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, FromFileError<span>&gt;</span></span></span> </span><span><span><span>{</span>
	<span>let</span> path <span>=</span> path.<span>as_ref</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
	<span><span>(</span><span><span><span>|</span></span></span><span><span><span>|</span></span> </span><span><span><span>{</span>
		<span>let</span> s <span>=</span> <span>fs<span>::</span></span>read_to_string<span><span>(</span>path</span><span><span>)</span></span>.<span>map_err</span><span><span>(</span><span>FromFileErrorKind<span>::</span></span>ReadFile</span><span><span>)</span></span><span>?</span><span>;</span>
		<span>Self</span><span><span>::</span></span>from_str<span><span>(</span><span>&amp;</span>s</span><span><span>)</span></span>.<span>map_err</span><span><span>(</span><span>FromFileErrorKind<span>::</span></span>Parse</span><span><span>)</span></span>
	</span><span><span>}</span></span></span></span><span><span>)</span></span><span><span>(</span></span><span><span>)</span></span>
	.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>kind</span><span>|</span></span> </span><span>FromFileError <span><span>{</span>
		path<span>:</span> path.<span>into</span><span><span>(</span></span><span><span>)</span></span><span>,</span>
		kind<span>,</span>
	</span><span><span>}</span></span></span></span><span><span>)</span></span>
</span><span><span>}</span></span></span>
</span></code></pre><p>Yeah, not the prettiest. Unfortunately, I don’t think there’s much we can actually do here; once we get <code>try</code> blocks it’ll definitely be nicer, but it seems to be an unavoidable cost of many good error-handling schemes.</p><h3 id="on-from"><a href="#on-from"></a>On <code>From</code></h3><p>One thing notably omitted from the definitions of the new error types was implementations of <code>From</code> for inner types. There is no problem with them really, one just has to be careful that it (a) works with extensibility and (b) actually makes <em>sense</em>. For example, taking <code>FromFileErrorKind</code>:</p><pre><code><span><span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>FromFileErrorKind</span> <span><span>{</span>
	ReadFile<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Parse<span><span>(</span>ParseError</span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>
</span></code></pre><p>While it does make sense to implement <code>From&lt;ParseError&gt;</code>, because <code>Parse</code> is literally the name of one of the variants of <code>FromFileErrorKind</code>, it does not make sense to implement <code>From&lt;io::Error&gt;</code> because such an implementation would implicitly add meaning that one failed during the process of reading the file from disk (as the variant is named <code>ReadFile</code> instead of <code>Io</code>). Constraining the meaning of “any I/O error” to “an error reading the file from the disk” is helpful but should not be done implicitly, thus rendering <code>From</code> inappropriate.</p><h3 id="on-nearness"><a href="#on-nearness"></a>On “nearness”</h3><p>One part of my principle of errors I haven’t yet touched on is the aspect of “nearness”; that errors should, as well as having an appropriate associated unit of fallibility, be sufficiently <em>near</em> to it. The fact is, with Rust’s current design you can’t put them as close as I’d like without sacrificing documentation quality. That is, while you’d ideally write something like:</p><pre><code><span><span><span>impl</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span><span><span>pub</span> <span>fn</span> </span><span>from_file</span></span><span><span>&lt;</span>P<span>:</span> <span>AsRef<span>&lt;</span>Path<span>&gt;</span></span><span>&gt;</span></span><span><span><span>(</span><span>path</span><span>:</span> P</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, FromFileError<span>&gt;</span></span></span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>pub</span> <span>struct</span> </span><span><span>FromFileError</span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span><span><span>pub</span> <span>fn</span> </span><span>download</span></span><span><span><span>(</span><span>agent</span><span>:</span> <span>&amp;</span><span>ureq<span>::</span></span>Agent</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, DownloadError<span>&gt;</span></span></span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>pub</span> <span>struct</span> </span><span><span>DownloadError</span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
</span></code></pre><p>This just makes your rustdoc look bad, since the <code><span><span><span>impl</span></span></span></code> blocks are needlessly separated. So usually I end up writing something more like:</p><pre><code><span><span><span>impl</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span><span><span>pub</span> <span>fn</span> </span><span>from_file</span></span><span><span>&lt;</span>P<span>:</span> <span>AsRef<span>&lt;</span>Path<span>&gt;</span></span><span>&gt;</span></span><span><span><span>(</span><span>path</span><span>:</span> P</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, FromFileError<span>&gt;</span></span></span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
	<span><span><span>pub</span> <span>fn</span> </span><span>download</span></span><span><span><span>(</span><span>agent</span><span>:</span> <span>&amp;</span><span>ureq<span>::</span></span>Agent</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, DownloadError<span>&gt;</span></span></span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>FromFileError</span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>DownloadError</span> </span><span><span><span>{</span>  </span><span><span>}</span></span></span>
</span></code></pre><p>It’s unfortunate, but I don’t think it’s terrible — you still get most the benefits of nearness.</p><p>The only thing to make sure of is that they stay in the same module; this same concept of “nearness” is a similar reason why one should be extremely wary of any module named “errors”, which is of equal organizational value to having a drawer labelled “medium-sized and flat”.</p><h3 id="verbosity"><a href="#verbosity"></a>Verbosity</h3><p>Possibly the biggest objection to this style of error is the sheer number of lines of code required to implement it; error types aren’t a trivial number of lines, and making a new error type for every function can easily hugely increase the number of lines a library needs. This is definitely a valid criticism, I also find it tiresome to write the same things over and over again, but let me also offer an alternate perspective: rather than seeing it as simply a more verbose way to do the same thing, see it as due treatment for an oft ignored area.</p><p>Traditionally, errors as something to be pushed to the side as soon as possible to get on with “real” logic. But the art of resilient, reliable and user-friendly systems considers <em>all</em> outcomes, not just the successful one. As a success story, look no further than the Rust compiler itself; I don’t think it would be an exaggeration to say that Rust enjoys the current popularity it does <em>because of</em> how good its error messages are, and how much effort was put into it.</p><h2 id="conclusion"><a href="#conclusion"></a>Conclusion</h2><p>This post is not here to give you a structure that you should follow for your errors. The structure I used as an example in this post had one specific use case, and filled it appropriately. If you find you can apply the same structure to your own code and it works well, then great! But really, what post is for is to get people to <em>start caring</em> about errors, putting actual thought into their designs, and learning how to elegantly pull off	ever-present balancing act between the five goals of good backtraces, extensibility, inspectability (matching), stability and modularity.</p><p>If there’s one thing I wish for you to take away, it’s that error handling is <em>hard</em>, but it’s <em>worth it</em> to learn. Because I’m tired of having to deal with lazy kitchen-sink-type errors.</p><details><summary>The final code</summary><pre><code><span>
<span><span>pub</span> <span>struct</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span>ranges</span><span>:</span> <span>Vec<span>&lt;</span><span>(</span><span>RangeInclusive<span>&lt;</span><span>u32</span><span>&gt;</span></span>, String<span>)</span><span>&gt;</span></span>,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span><span>Blocks</span> </span><span><span><span>{</span>
	<span><span><span>pub</span> <span>fn</span> </span><span>block_of</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>c</span><span>:</span> <span>char</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>&amp;</span><span>str</span></span> </span><span><span><span>{</span>
		<span>self</span>.ranges
			.<span>binary_search_by</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span><span>(</span></span><span><span>range</span><span>,</span> _</span><span><span>)</span></span><span>|</span></span> </span><span><span><span>{</span>
				<span>if</span> <span>*</span>range.<span>end</span><span><span>(</span></span><span><span>)</span></span> <span>&lt;</span> <span>u32</span><span><span>::</span></span>from<span><span>(</span>c</span><span><span>)</span></span> <span><span>{</span>
					<span>cmp<span>::</span></span><span>Ordering<span>::</span></span>Less
				</span><span><span>}</span></span> <span>else</span> <span>if</span> <span>u32</span><span><span>::</span></span>from<span><span>(</span>c</span><span><span>)</span></span> <span>&lt;</span> <span>*</span>range.<span>start</span><span><span>(</span></span><span><span>)</span></span> <span><span>{</span>
					<span>cmp<span>::</span></span><span>Ordering<span>::</span></span>Greater
				</span><span><span>}</span></span> <span>else</span> <span><span>{</span>
					<span>cmp<span>::</span></span><span>Ordering<span>::</span></span>Equal
				</span><span><span>}</span></span>
			</span><span><span>}</span></span></span></span><span><span>)</span></span>
			.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>i</span><span>|</span></span> </span><span><span>&amp;</span><span>*</span><span>self</span>.ranges<span><span>[</span>i<span>]</span></span>.<span>1</span></span></span><span><span>)</span></span>
			.<span>unwrap_or</span><span><span>(</span><span><span>&#34;</span>No_Block<span>&#34;</span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
	<span><span><span>pub</span> <span>fn</span> </span><span>from_file</span></span><span><span>&lt;</span>P<span>:</span> <span>AsRef<span>&lt;</span>Path<span>&gt;</span></span><span>&gt;</span></span><span><span><span>(</span><span>path</span><span>:</span> P</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, FromFileError<span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>let</span> path <span>=</span> path.<span>as_ref</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
		<span><span>(</span><span><span><span>|</span></span></span><span><span><span>|</span></span> </span><span><span><span>{</span>
			<span>Self</span><span><span>::</span></span>from_str<span><span>(</span><span>&amp;</span><span>fs<span>::</span></span>read_to_string<span><span>(</span>path</span><span><span>)</span></span>.<span>map_err</span><span><span>(</span><span>FromFileErrorKind<span>::</span></span>ReadFile</span><span><span>)</span></span><span>?</span></span><span><span>)</span></span>
				.<span>map_err</span><span><span>(</span><span>FromFileErrorKind<span>::</span></span>Parse</span><span><span>)</span></span>
		</span><span><span>}</span></span></span></span><span><span>)</span></span><span><span>(</span></span><span><span>)</span></span>
		.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>kind</span><span>|</span></span> </span><span>FromFileError <span><span>{</span>
			path<span>:</span> path.<span>into</span><span><span>(</span></span><span><span>)</span></span><span>,</span>
			kind<span>,</span>
		</span><span><span>}</span></span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
	<span><span><span>pub</span> <span>fn</span> </span><span>download</span></span><span><span><span>(</span><span>agent</span><span>:</span> <span>&amp;</span><span>ureq<span>::</span></span>Agent</span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, DownloadError<span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span><span>(</span><span><span><span>|</span></span></span><span><span><span>|</span></span> </span><span><span><span>{</span>
			<span>let</span> response <span>=</span> agent
				.<span>get</span><span><span>(</span><span>LATEST_URL</span></span><span><span>)</span></span>
				.<span>call</span><span><span>(</span></span><span><span>)</span></span>
				.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>e</span><span>|</span></span> </span><span><span>DownloadErrorKind<span>::</span></span>Request<span><span>(</span><span>Box</span><span><span>::</span></span>new<span><span>(</span>e</span><span><span>)</span></span></span><span><span>)</span></span></span></span><span><span>)</span></span><span>?</span><span>;</span>
			<span>Self</span><span><span>::</span></span>from_str<span><span>(</span>
				<span>&amp;</span>response
					.<span>into_string</span><span><span>(</span></span><span><span>)</span></span>
					.<span>map_err</span><span><span>(</span><span>DownloadErrorKind<span>::</span></span>ReadBody</span><span><span>)</span></span><span>?</span><span>,</span>
			</span><span><span>)</span></span>
			.<span>map_err</span><span><span>(</span><span>DownloadErrorKind<span>::</span></span>Parse</span><span><span>)</span></span>
		</span><span><span>}</span></span></span></span><span><span>)</span></span><span><span>(</span></span><span><span>)</span></span>
		.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>kind</span><span>|</span></span> </span><span>DownloadError <span><span>{</span> kind </span><span><span>}</span></span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>FromStr <span>for</span></span><span> <span>Blocks</span> </span><span><span><span>{</span>
	<span>type</span> <span>Err</span> <span>=</span> ParseError<span>;</span>
	<span><span><span>fn</span> </span><span>from_str</span></span><span><span><span>(</span><span>s</span><span>:</span> <span>&amp;</span><span>str</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Result<span>&lt;</span><span>Self</span>, <span><span><span>Self</span><span>::</span></span></span>Err<span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>let</span> ranges <span>=</span> s
			.<span>lines</span><span><span>(</span></span><span><span>)</span></span>
			.<span>enumerate</span><span><span>(</span></span><span><span>)</span></span>
			.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span><span>(</span></span><span><span>i</span><span>,</span> <span>line</span></span><span><span>)</span></span><span>|</span></span> </span><span><span><span>{</span>
				<span><span>(</span>
					i<span>,</span>
					line.<span>split_once</span><span><span>(</span><span><span>&#39;</span>#<span>&#39;</span></span></span><span><span>)</span></span>.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span><span>(</span></span><span><span>line</span><span>,</span> _</span><span><span>)</span></span><span>|</span></span> </span><span>line</span></span><span><span>)</span></span>.<span>unwrap_or</span><span><span>(</span>line</span><span><span>)</span></span><span>,</span>
				</span><span><span>)</span></span>
			</span><span><span>}</span></span></span></span><span><span>)</span></span>
			.<span>filter</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span><span>(</span></span><span>_<span>,</span> <span>line</span></span><span><span>)</span></span><span>|</span></span> </span><span><span>!</span>line.<span>is_empty</span><span><span>(</span></span><span><span>)</span></span></span></span><span><span>)</span></span>
			.<span>map</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span><span>(</span></span><span><span>i</span><span>,</span> <span>line</span></span><span><span>)</span></span><span>|</span></span> </span><span><span><span>{</span>
				<span><span>(</span><span><span><span>|</span></span></span><span><span><span>|</span></span> </span><span><span><span>{</span>
					<span>let</span> <span><span>(</span>range<span>,</span> name</span><span><span>)</span></span> <span>=</span> line.<span>split_once</span><span><span>(</span><span><span>&#39;</span>;<span>&#39;</span></span></span><span><span>)</span></span>.<span>ok_or</span><span><span>(</span><span>ParseErrorKind<span>::</span></span>NoSemicolon</span><span><span>)</span></span><span>?</span><span>;</span>
					<span>let</span> <span><span>(</span>range<span>,</span> name</span><span><span>)</span></span> <span>=</span> <span><span>(</span>range.<span>trim</span><span><span>(</span></span><span><span>)</span></span><span>,</span> name.<span>trim</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span><span>;</span>
					<span>let</span> <span><span>(</span>start<span>,</span> end</span><span><span>)</span></span> <span>=</span> range.<span>split_once</span><span><span>(</span><span><span>&#34;</span>..<span>&#34;</span></span></span><span><span>)</span></span>.<span>ok_or</span><span><span>(</span><span>ParseErrorKind<span>::</span></span>NoDotDot</span><span><span>)</span></span><span>?</span><span>;</span>
					<span>let</span> start <span>=</span> <span>u32</span><span><span>::</span></span>from_str_radix<span><span>(</span>start<span>,</span> <span>16</span></span><span><span>)</span></span>
						.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>source</span><span>|</span></span> </span><span><span>ParseErrorKind<span>::</span></span>ParseInt <span><span>{</span> source </span><span><span>}</span></span></span></span><span><span>)</span></span><span>?</span><span>;</span>
					<span>let</span> end <span>=</span> <span>u32</span><span><span>::</span></span>from_str_radix<span><span>(</span>end<span>,</span> <span>16</span></span><span><span>)</span></span>
						.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>source</span><span>|</span></span> </span><span><span>ParseErrorKind<span>::</span></span>ParseInt <span><span>{</span> source </span><span><span>}</span></span></span></span><span><span>)</span></span><span>?</span><span>;</span>
					<span>Ok</span><span><span>(</span><span><span>(</span>start<span>..</span><span>=</span>end<span>,</span> name.<span>to_owned</span><span><span>(</span></span><span><span>)</span></span></span><span><span>)</span></span></span><span><span>)</span></span>
				</span><span><span>}</span></span></span></span><span><span>)</span></span><span><span>(</span></span><span><span>)</span></span>
				.<span>map_err</span><span><span>(</span><span><span><span>|</span></span></span><span><span><span>kind</span><span>|</span></span> </span><span>ParseError <span><span>{</span> line<span>:</span> i<span>,</span> kind </span><span><span>}</span></span></span></span><span><span>)</span></span>
			</span><span><span>}</span></span></span></span><span><span>)</span></span>
			.<span>collect<span>::</span></span><span><span>&lt;</span><span>Result<span>&lt;</span><span>Vec<span>&lt;</span><span>_</span><span>&gt;</span></span>, ParseError<span>&gt;</span></span><span>&gt;</span></span><span><span>(</span></span><span><span>)</span></span><span>?</span><span>;</span>
		<span>Ok</span><span><span>(</span><span>Self</span> <span><span>{</span> ranges </span><span><span>}</span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>DownloadError</span> </span><span><span><span>{</span>
	<span>pub</span> <span>kind</span><span>:</span> DownloadErrorKind,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>DownloadError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>failed to download Blocks.txt from the Unicode website<span>&#34;</span></span></span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>DownloadError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>match</span> <span>&amp;</span><span>self</span>.kind <span><span>{</span>
			<span>DownloadErrorKind<span>::</span></span>Request<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
			<span>DownloadErrorKind<span>::</span></span>ReadBody<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
			<span>DownloadErrorKind<span>::</span></span>Parse<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>DownloadErrorKind</span> <span><span>{</span>
	Request<span><span>(</span><span>Box<span>&lt;</span><span>ureq<span>::</span></span>Error<span>&gt;</span></span></span><span><span>)</span></span><span>,</span>
	ReadBody<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Parse<span><span>(</span>ParseError</span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>FromFileError</span> </span><span><span><span>{</span>
	<span>pub</span> <span>path</span><span>:</span> <span>Box<span>&lt;</span>Path<span>&gt;</span></span>,
	<span>pub</span> <span>kind</span><span>:</span> FromFileErrorKind,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>FromFileError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>error reading `<span>{}</span>`<span>&#34;</span></span></span><span><span>,</span> <span>self</span>.path.<span>display</span><span><span>(</span></span><span><span>)</span></span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>FromFileError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>match</span> <span>&amp;</span><span>self</span>.kind <span><span>{</span>
			<span>FromFileErrorKind<span>::</span></span>ReadFile<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
			<span>FromFileErrorKind<span>::</span></span>Parse<span><span>(</span>e</span><span><span>)</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>e</span><span><span>)</span></span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>FromFileErrorKind</span> <span><span>{</span>
	ReadFile<span><span>(</span><span>io<span>::</span></span>Error</span><span><span>)</span></span><span>,</span>
	Parse<span><span>(</span>ParseError</span><span><span>)</span></span><span>,</span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
<span><span>pub</span> <span>struct</span> </span><span><span>ParseError</span> </span><span><span><span>{</span>
	<span>pub</span> <span>line</span><span>:</span> <span>usize</span>,
	<span>pub</span> <span>kind</span><span>:</span> ParseErrorKind,
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>ParseError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>invalid Blocks.txt data on line <span>{}</span><span>&#34;</span></span></span><span><span>,</span> <span>self</span>.line <span>+</span> <span>1</span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>ParseError</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>Some</span><span><span>(</span><span>&amp;</span><span>self</span>.kind</span><span><span>)</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>derive</span><span><span><span>(</span></span></span><span><span>Debug</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>pub</span> <span>enum</span> <span>ParseErrorKind</span> <span><span>{</span>
	<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
	NoSemicolon<span>,</span>
	<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
	NoDotDot<span>,</span>
	<span><span>#</span><span>[</span><span>non_exhaustive</span><span>]</span></span>
	ParseInt <span><span>{</span> source<span>:</span> ParseIntError </span><span><span>}</span></span><span>,</span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Display <span>for</span></span><span> <span>ParseErrorKind</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>fmt</span></span><span><span><span>(</span><span>&amp;</span><span>self</span>, <span>f</span><span>:</span> <span>&amp;</span><span>mut</span> <span>Formatter<span>&lt;</span>&#39;<span>_</span><span>&gt;</span></span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>fmt<span>::</span></span>Result</span> </span><span><span><span>{</span>
		<span>match</span> <span>*</span><span>self</span> <span><span>{</span>
			<span>Self</span><span><span>::</span></span>NoSemicolon <span>=&gt;</span> f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>no semicolon<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>NoDotDot <span>=&gt;</span> f.<span>write_str</span><span><span>(</span><span><span>&#34;</span>no `..` in range<span>&#34;</span></span></span><span><span>)</span></span><span>,</span>
			<span>Self</span><span><span>::</span></span>ParseInt <span><span>{</span> <span>..</span> </span><span><span>}</span></span> <span>=&gt;</span> <span><span>{</span>
				<span>write!</span><span><span>(</span></span><span>f,</span><span> <span><span>&#34;</span>one end of range is not a valid hexadecimal integer<span>&#34;</span></span></span><span><span>)</span></span>
			</span><span><span>}</span></span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>impl</span> </span><span>Error <span>for</span></span><span> <span>ParseErrorKind</span> </span><span><span><span>{</span>
	<span><span><span>fn</span> </span><span>source</span></span><span><span><span>(</span><span>&amp;</span><span>self</span></span><span><span><span>)</span></span></span></span><span> <span><span>-&gt;</span> <span>Option<span>&lt;</span><span>&amp;</span><span>(</span>dyn Error + <span>&#39;static</span><span>)</span><span>&gt;</span></span></span> </span><span><span><span>{</span>
		<span>match</span> <span>self</span> <span><span>{</span>
			<span>Self</span><span><span>::</span></span>ParseInt <span><span>{</span> source </span><span><span>}</span></span> <span>=&gt;</span> <span>Some</span><span><span>(</span>source</span><span><span>)</span></span><span>,</span>
			<span>_</span> <span>=&gt;</span> <span>None</span><span>,</span>
		</span><span><span>}</span></span>
	</span><span><span>}</span></span></span>
</span><span><span>}</span></span></span>

<span><span>#</span><span>[</span><span>cfg</span><span><span><span>(</span></span></span><span><span>test</span></span><span><span><span>)</span></span></span><span>]</span></span>
<span><span>mod</span> <span>tests</span> <span><span>{</span>
	<span><span>#</span><span>[</span><span>test</span><span>]</span></span>
	<span><span><span>fn</span> </span><span>real_unicode</span></span><span><span><span>(</span></span><span><span><span>)</span></span></span></span><span> </span><span><span><span>{</span>
		<span>let</span> data <span>=</span> <span>include_str!</span><span><span>(</span><span><span>&#34;</span>../Blocks.txt<span>&#34;</span></span></span><span><span>)</span></span>.<span>parse<span>::</span></span><span><span>&lt;</span>Blocks<span>&gt;</span></span><span><span>(</span></span><span><span>)</span></span>.<span>unwrap</span><span><span>(</span></span><span><span>)</span></span><span>;</span>
		<span>assert_eq!</span><span><span>(</span>data.<span>block_of</span><span><span>(</span><span><span>&#39;</span><span>\u{0080}</span><span>&#39;</span></span></span><span><span>)</span></span><span>,</span> <span><span>&#34;</span>Latin-1 Supplement<span>&#34;</span></span></span><span><span>)</span></span><span>;</span>
		<span>assert_eq!</span><span><span>(</span>data.<span>block_of</span><span><span>(</span><span><span>&#39;</span>½<span>&#39;</span></span></span><span><span>)</span></span><span>,</span> <span><span>&#34;</span>Latin-1 Supplement<span>&#34;</span></span></span><span><span>)</span></span><span>;</span>
		<span>assert_eq!</span><span><span>(</span>data.<span>block_of</span><span><span>(</span><span><span>&#39;</span><span>\u{00FF}</span><span>&#39;</span></span></span><span><span>)</span></span><span>,</span> <span><span>&#34;</span>Latin-1 Supplement<span>&#34;</span></span></span><span><span>)</span></span><span>;</span>
		<span>assert_eq!</span><span><span>(</span>data.<span>block_of</span><span><span>(</span><span><span>&#39;</span><span>\u{EFFFF}</span><span>&#39;</span></span></span><span><span>)</span></span><span>,</span> <span><span>&#34;</span>No_Block<span>&#34;</span></span></span><span><span>)</span></span><span>;</span>
	</span><span><span>}</span></span></span>

	<span>use</span> <span>crate</span><span><span>::</span></span>Blocks<span>;</span>
</span><span><span>}</span></span></span>

<span>pub</span> <span>const</span> <span>LATEST_URL</span><span>:</span> <span>&amp;</span><span>str</span> <span>=</span> <span><span>&#34;</span>https://www.unicode.org/Public/UCD/latest/ucd/Blocks.txt<span>&#34;</span></span><span>;</span>

<span>use</span> <span>std<span>::</span></span>cmp<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>error<span>::</span></span>Error<span>;</span>
<span>use</span> <span>std<span>::</span></span>fmt<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>fmt<span>::</span></span>Display<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>fmt<span>::</span></span>Formatter<span>;</span>
<span>use</span> <span>std<span>::</span></span>fs<span>;</span>
<span>use</span> <span>std<span>::</span></span>io<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>num<span>::</span></span>ParseIntError<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>ops<span>::</span></span>RangeInclusive<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>path<span>::</span></span>Path<span>;</span>
<span>use</span> <span>std<span>::</span></span><span>str<span>::</span></span>FromStr<span>;</span>
</span></code></pre></details><p><a href="#">⮬ Back to top</a></p></div></div>
  </body>
</html>
