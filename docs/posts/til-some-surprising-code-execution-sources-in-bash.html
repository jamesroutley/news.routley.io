<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://yossarian.net/til/post/some-surprising-code-execution-sources-in-bash">Original</a>
    <h1>TIL: Some surprising code execution sources in bash</h1>
    
    <div id="readability-page-1" class="page"><div>
            <p>I ran across two surprising sources of code execution in <code>bash</code> (and probably
other shells) recently.</p>
<p>In a historic context these probably weren&#39;t <em>too</em>
serious of a problem, but in the context of CI systems where everything is
a rats&#39; nest of shell and YAML they could be useful execution primitives.</p>
<h2>Source 1: arithmetic expressions (a.k.a. &#34;white-collar eval&#34;)</h2>
<p>Leading question aside, do you think this snippet of <code>bash</code> can run
arbitrary code?</p>
<pre><code><span><span><span>function</span> <span>guess</span><span>(</span><span>)</span> <span>{</span>
  <span>num</span><span>=</span><span><span><span>&#34;</span><span><span>$</span><span>{</span></span><span><span>1</span></span><span><span>}</span></span><span>&#34;</span></span></span>
  <span>if</span> <span><span>[[</span> <span><span>&#34;</span><span><span>$</span><span>{</span></span><span><span>num</span></span><span><span>}</span></span><span>&#34;</span></span> <span><span>-</span>eq</span> 42 <span>]]</span></span>
  <span>then</span>
    <span><span>echo</span></span><span> <span><span>&#34;</span>Correct<span>&#34;</span></span></span>
  <span>else</span>
    <span><span>echo</span></span><span> <span><span>&#34;</span>Wrong<span>&#34;</span></span></span>
  <span>fi</span>
<span>}</span></span>
</span></code></pre>
<p>Most people (including experienced shell programmers) say &#34;no&#34;: they
recognize that there <em>could</em> have been a splatting bug if it was <code>$num</code> instead
of <code>&#34;${num}&#34;</code>, but the double quoting should firmly prevent any evaluation
of the <code>num</code> variable itself.</p>
<p>But nope: because of <code>-eq</code>, <code>num</code> is treated with <code>bash</code>&#39;s arithmetic evaluation
rules, meaning that this works:</p>
<pre><code><span><span><span>$</span></span><span> guess <span><span>&#39;</span>a[$(cat /etc/passwd &gt; /tmp/pwned)] + 42<span>&#39;</span></span></span>
<span><span>Correct</span></span>
<span><span>$</span></span><span> cat /tmp/pwned</span>
</span></code></pre>
<p>Note the single quotes: <code>$(cat /etc/passwd &gt; ~/pwned)</code> is <strong>not</strong> executed
eagerly as a parameter to <code>guess</code>, but as part of the evaluation of <code>-eq</code>
within <code>[[</code>.</p>
<p>Unlike the case below, this doesn&#39;t appear to work with <code>[</code> or <code>test</code>.</p>
<h2>Source 2: <code>test -v</code></h2>
<p>The same surprising code execution source exists with <code>test -v var</code>, under
the same conditions as arithmetic expressions (needs to use the builtin,
not the standard binary):</p>
<pre><code><span><span><span>$</span></span><span> <span>[</span><span>[</span> <span>-</span>v <span><span>&#39;</span>x[$(cat /etc/passwd &gt; /tmp/pwned)]<span>&#39;</span></span> <span>]</span><span>]</span></span>
<span><span>$</span></span><span> cat /tmp/pwned</span>
</span></code></pre>
<p>This <em>also</em> works with <code>[</code> and <code>test</code>, so long as their builtin variants
are used instead of their external binary variants. <code>/usr/bin/[</code> and
<code>/usr/bin/test</code> will of course not work, since they have no access to the
context of the shell that spawned them.</p>
<p>I&#39;m not 100% sure <em>why</em> this is the case, since <code>-v var</code> is documented as
testing whether <code>var</code> is set and it shouldn&#39;t be necessary to evaluate
a subscript to determine that.</p>


        </div></div>
  </body>
</html>
