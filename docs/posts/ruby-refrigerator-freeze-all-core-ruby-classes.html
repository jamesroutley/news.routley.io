<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/jeremyevans/ruby-refrigerator">Original</a>
    <h1>Ruby-refrigerator: Freeze all core Ruby classes</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">


<p dir="auto">Refrigerator offers an easy way to freeze all ruby core classes and modules. It’s designed to be used in production and when testing to make sure that no code is making unexpected changes to core classes or modules at runtime.</p>



<pre><span>gem</span> <span>install</span> <span>refrigerator</span>
</pre>



<p dir="auto">Source code is available on GitHub at <a href="https://github.com/jeremyevans/ruby-refrigerator">github.com/jeremyevans/ruby-refrigerator</a></p>





<p dir="auto">After loading all of the code for your application, you can call the <code>freeze_core</code> method to freeze all core classes:</p>

<pre><span>require</span> <span>&#39;refrigerator&#39;</span>
<span>Refrigerator</span>.<span>freeze_core</span>
</pre>

<p dir="auto">This will freeze all core classes, so that modifications to them at runtime will raise exceptions.</p>

<p dir="auto">In a rack-based application, a good place to call ‘freeze_core` is at the end of the `config.ru` file.</p>

<p dir="auto">You can also pass an :except option to <code>freeze_core</code> with an array of class names not to freeze:</p>

<pre><span>Refrigerator</span>.<span>freeze_core</span>(<span>:except</span><span>=&gt;</span>[<span>&#39;BasicObject&#39;</span>])
</pre>

<p dir="auto">One reason to exclude certain classes is because you know they will be modified at runtime.</p>



<p dir="auto">Refrigerator also offers a <code>check_require</code> method for checking libraries for modifications to the core classes.  It allows you to easily see what fails when when you try to require the library with a frozen core, and offers some options that you can use to try to get the require to not raise an exception.  This allows you to see what changes the library makes to the core classes.  Here’s an example of basic use:</p>

<pre><span>Refrigerator</span>.<span>check_require</span>(<span>&#39;open3&#39;</span>, <span>:modules</span><span>=&gt;</span>[<span>:Open3</span>])
</pre>

<p dir="auto">The <code>check_require</code> method takes the following options:</p>
<dl><dt>:modules 
</dt><dd>
<p dir="auto">Define the given module names before freezing the core (array of symbols)</p>
</dd><dt>:classes 
</dt><dd>
<p dir="auto">Define the given class names before freezing the core (array of symbols or two element arrays with class name symbol and superclass name symbol)</p>
</dd><dt>:exclude 
</dt><dd>
<p dir="auto">Exclude the given class/module names from freezing (array of strings)</p>
</dd><dt>:depends 
</dt><dd>
<p dir="auto">Any dependencies to require before freezing the core (array of strings)</p>
</dd></dl>

<p dir="auto">Without any options, <code>check_require</code> will likely raise an exception, as it freezes the core before requiring, and if the required files tries to add a class or module to the global namespace, that will fail.  The :modules and :classes options exist so that you can predefine the class so that the required file will reopen the existing class instead of defining a new class.</p>

<p dir="auto">The :depends option can be easily used to load all dependencies of the required file before freezing the core.  This is also necessary in most cases, especially when using the stdlib, since many stdlib files modify the core classes in ways beyond adding modules or classes. The :exclude option is basically a last resort, where you can disable the freezing of certain core classes, if you know the required library modifies them.</p>

<p dir="auto">Here’s an example using Sequel, a ruby database toolkit:</p>

<pre><span>Refrigerator</span>.<span>check_require</span> <span>&#39;sequel&#39;</span>,
  <span>:depends</span><span>=&gt;</span><span>%w&#39;bigdecimal date thread time uri&#39;</span>,
  <span>:modules</span><span>=&gt;</span>[<span>:Sequel</span>]
</pre>

<p dir="auto">And an example using Roda, a ruby web toolkit:</p>

<pre><span>Refrigerator</span>.<span>check_require</span> <span>&#39;roda&#39;</span>,
  <span>:depends</span><span>=&gt;</span><span>%w&#39;rack uri fileutils set tmpdir tempfile thread date time&#39;</span>,
  <span>:classes</span><span>=&gt;</span>[<span>:Roda</span>]
</pre>

<p dir="auto">Note that many stdlib libraries will fail <code>check_require</code> unless you use the :exclude option, for example, <code>date</code>:</p>

<pre><span>Refrigerator</span>.<span>check_require</span> <span>&#39;date&#39;</span>,
  <span>:classes</span><span>=&gt;</span>[<span>:Date</span>, [<span>:DateTime</span>, <span>:Date</span>]]
<span># Fails due to Time#to_date addition</span>

<span>Refrigerator</span>.<span>check_require</span> <span>&#39;date&#39;</span>,
  <span>:classes</span><span>=&gt;</span>[<span>:Date</span>, [<span>:DateTime</span>, <span>:Date</span>]],
  <span>:exclude</span><span>=&gt;</span>[<span>&#39;Time&#39;</span>]
<span># =&gt; true</span>
</pre>



<p dir="auto">refrigerator ships with a <code>check_require</code> binary that offers access to <code>Refrigerator.check_require</code> from the command line.  Here’s the usage:</p>

<pre>$ bin/check_require
Usage: check_require [options] path

Options:
  -m, --modules [Module1,Module2]  define given modules under Object before freezing core classes
  -c [Class1,Class2/SuperclassOfClass2],
      --classes                    define given classes under Object before freezing core classes
  -r, --require [foo,bar/baz]      require given libraries before freezing core classes
  -e, --exclude [Object,Array]     exclude given core classes from freezing
  -h, -?, --help                   Show this message</pre>

<p dir="auto">You can use this to easily check ruby libraries for issues when requiring.  For example, let’s try with <code>open3</code>:</p>

<pre>$ bin/check_require open3
Traceback (most recent call last):
        4: from bin/check_require:42:in `&lt;main&gt;&#39;
        3: from /home/billg/ruby-refrigerator/lib/refrigerator.rb:35:in `check_require&#39;
        2: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
        1: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
/usr/local/lib/ruby/2.5/open3.rb:32:in `&lt;top (required)&gt;&#39;: can&#39;t modify frozen #&lt;Class:Object&gt; (FrozenError)
$ bin/check_require -m Open3 open3</pre>

<p dir="auto">As displayed above, open3 does not modify any core classes, beyond defining the <code>Open3</code> module.</p>

<p dir="auto">Let’s try with <code>date</code>:</p>

<pre>$ bin/check_require date
Traceback (most recent call last):
        6: from bin/check_require:42:in `&lt;main&gt;&#39;
        5: from /home/billg/ruby-refrigerator/lib/refrigerator.rb:35:in `check_require&#39;
        4: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
        3: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
        2: from /usr/local/lib/ruby/2.5/date.rb:4:in `&lt;top (required)&gt;&#39;
        1: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
/usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;: can&#39;t modify frozen #&lt;Class:Object&gt; (FrozenError)
$ bin/check_require -c Date,DateTime/Date date
Traceback (most recent call last):
        6: from bin/check_require:42:in `&lt;main&gt;&#39;
        5: from /home/billg/ruby-refrigerator/lib/refrigerator.rb:35:in `check_require&#39;
        4: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
        3: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
        2: from /usr/local/lib/ruby/2.5/date.rb:4:in `&lt;top (required)&gt;&#39;
        1: from /usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;
/usr/local/lib/ruby/2.5/rubygems/core_ext/kernel_require.rb:59:in `require&#39;: can&#39;t modify frozen class (FrozenError)
$ bin/check_require -c Date,DateTime/Date -e Time date</pre>

<p dir="auto">The first failure is because <code>date</code> defines the <code>Date</code> and <code>DateTime</code> classes, so you must define those classes first, using a slash to separate DateTime from the superclass Date. Note that it still fails in that case, but it doesn’t even tell you why.  It turns out the reason is that <code>date</code> also adds <code>to_date</code> and other methods to <code>Time</code>, so you need to exclude the freezing of <code>Time</code> as well.</p>

<p dir="auto">Here are a couple more examples, using Sequel and Roda:</p>

<pre>bin/check_require -m Sequel -r bigdecimal,date,thread,time,uri sequel
bin/check_require -c Roda -r rack,uri,fileutils,set,tmpdir,tempfile,thread,date,time roda</pre>

<div dir="auto"><h2 id="user-content-label-supporting+new+ruby+minor+versions" tabindex="-1" dir="auto">Supporting new ruby minor versions<span><a href="#label-Supporting+new+ruby+minor+versions">¶</a> <a href="#top">↑</a></span></h2><a id="user-content-supporting-new-ruby-minor-versions-" aria-label="Permalink: Supporting new ruby minor versions¶↑" href="#supporting-new-ruby-minor-versions-"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<p dir="auto">The list of constants that <code>freeze_core</code> will freeze are stored in the module_names/*.txt files in the repository, with separate files per ruby minor version.  When new ruby minor versions are released, the <code>module_names</code> rake task can be run with the new ruby minor version, and it will generate the appropriate file.</p>

<div dir="auto"><h2 id="user-content-label-skipped+classes+and+modules" tabindex="-1" dir="auto">Skipped Classes and Modules<span><a href="#label-Skipped+Classes+and+Modules">¶</a> <a href="#top">↑</a></span></h2><a id="user-content-skipped-classes-and-modules-" aria-label="Permalink: Skipped Classes and Modules¶↑" href="#skipped-classes-and-modules-"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>

<p dir="auto">Internal, deprecated, and private classes and modules are not frozen by refrigerator.</p>



<p dir="auto">MIT</p>



<p dir="auto">Jeremy Evans &lt;code@jeremyevans.net&gt;</p>
</article></div></div>
  </body>
</html>
