<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://danthesalmon.com/windows-smb-tailscale/#">Original</a>
    <h1>Windows Kills SMB Speeds When Using Tailscale</h1>
    
    <div id="readability-page-1" class="page"><div id="content"><div><heading></heading><section><section><div><div><p><h3>Dan Salmon</h3></p><p><em>November 11 2024</em></p></div></div></section></section><content><h3 id="the-issue">The Issue</h3><p>Yesterday when trying to transfer an ISO file from a TrueNAS SMB share, I was getting horrible transfer speeds.</p><figure><img src="https://danthesalmon.com/windows-smb-tailscale/slow1.png" alt="Copy progress dialog window showing a speed of 355KB/s"/></figure><p>The NAS can definitely saturate a gigabit link which is what my desktop connects to the switch over. I had seen this behavior before and had a feeling it was related to having Tailscale running - the last time it happened I quit Tailscale and my fast transfers returned.</p><p>Why would this matter?</p><p>Well, in my home network I have a Proxmox VM that, among other things, runs Tailscale as a <a href="https://tailscale.com/kb/1019/subnets" target="_blank">subnet router</a>. I set it up this way so that my homelab services (especially Pi-hole) are available to my laptop and phone from outside my house.</p><p>Consequently, my desktop now has 2 interfaces that can both reach my trusted <code>10.10.1.1/24</code> network - the gigabit NIC connected to the switch and the Tailscale virtual adapter.</p><p>A quick online search led me to a thread <a href="https://forum.tailscale.com/t/windows-routes-all-smb-traffic-through-tailscale-even-when-lan-ip-is-specified-is-much-slower/1995" target="_blank">on the Tailscale forums</a> describing the exact behavior I was seeing.</p><p>I learned that Windows has a system for determining which interface will handle a request when multiple interfaces could be used. Just like dynamic routing protocols calculate the “cost” of each route to a remote network, Windows has a system to calculate which interface to use. Windows refers to this cost as the “Interface Metric” which is calculated based on the physical interface medium and its link speed (as documented <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/automatic-metric-for-ipv4-routes" target="_blank">here</a> in the last table).</p><p>Since the Tailscale interface advertises a link speed of 100Gbps, Windows assigns it a much lower interface metric than the integrated gigabit NIC on my motherboard. Lower metric = lower “cost” associated.</p><div><pre tabindex="0"><code data-lang="powershell"><span><span>PS C:\&gt; Get-NetAdapter | Where-Object {$_.Name <span>-EQ</span> <span>&#34;Tailscale&#34;</span> <span>-or</span> $_.Name <span>-EQ</span> <span>&#34;Ethernet&#34;</span>}
</span></span><span><span>
</span></span><span><span>Name        InterfaceDescription     ifIndex Status   LinkSpeed
</span></span><span><span>----        --------------------     ------- ------   ---------
</span></span><span><span>Ethernet    Intel(R) I211 Gigabit...      10 Up          1 Gbps
</span></span><span><span>Tailscale   Tailscale Tunnel               9 Up        100 Gbps
</span></span><span><span>
</span></span><span><span>PS C:\&gt; Get-NetIPInterface | Where-Object { ($_.InterfaceAlias <span>-EQ</span> <span>&#34;Tailscale&#34;</span> <span>-or</span> $_.InterfaceAlias <span>-EQ</span> <span>&#34;Ethernet&#34;</span>) <span>-and</span> $_.AddressFamily <span>-eq</span> <span>&#34;IPv4&#34;</span>}
</span></span><span><span>
</span></span><span><span>ifIndex InterfaceAlias  AddressFamily NlMtu(Bytes) InterfaceMetric Dhcp     ConnectionState PolicyStore
</span></span><span><span>------- --------------  ------------- ------------ --------------- ----     --------------- -----------
</span></span><span><span>10      Ethernet        IPv4                  1500              25 Enabled  Connected       ActiveStore
</span></span><span><span>11      Tailscale       IPv4                  1280               5 Disabled Connected       ActiveStore
</span></span></code></pre></div><p>I only want traffic destined for my <a href="https://tailscale.com/kb/1136/tailnet/" target="_blank">Tailnet</a> to use the Tailscale interface. To ensure Windows chooses the Ethernet interface in all other cases, we just need to increase the Interface Metric on the Tailscale interface to be higher than 25.</p><h3 id="the-fix">The Fix</h3><p>The usual way to change this is in the Control Panel, but if you try to set the Interface Metric manually, Windows won’t let you because the Tailscale interface somehow has an “empty” static IP address set.</p><figure><img src="https://danthesalmon.com/windows-smb-tailscale/manual-metric.png" alt="Windows error message window showing text &#39;The adapter requires at least one IP address. Please enter one.&#39;"/></figure><p>Powershell to the rescue:</p><div><pre tabindex="0"><code data-lang="powershell"><span><span>PS C:\Windows\system32&gt; Get-NetAdapter | Where-Object -FilterScript {$_.InterfaceAlias <span>-Eq</span> <span>&#34;Tailscale&#34;</span>} | Set-NetIPInterface -InterfaceMetric 500
</span></span><span><span>PS C:\Windows\system32&gt; Get-NetIPInterface |Where-Object { ($_.InterfaceAlias <span>-EQ</span> <span>&#34;Tailscale&#34;</span> <span>-or</span> $_.InterfaceAlias <span>-EQ</span> <span>&#34;Ethernet&#34;</span>) <span>-and</span> $_.AddressFamily <span>-eq</span> <span>&#34;IPv4&#34;</span>}
</span></span><span><span>
</span></span><span><span>ifIndex InterfaceAlias AddressFamily NlMtu(Bytes) InterfaceMetric Dhcp     ConnectionState PolicyStore
</span></span><span><span>------- -------------- ------------- ------------ --------------- ----     --------------- -----------
</span></span><span><span>10      Ethernet       IPv4                  1500              25 Enabled  Connected       ActiveStore
</span></span><span><span>9       Tailscale      IPv4                  1280             500 Disabled Connected       ActiveStore
</span></span></code></pre></div><p>After I changed this, I was back to getting near-gigabit speeds over the Ethernet interface.</p><figure><img src="https://danthesalmon.com/windows-smb-tailscale/fast.png" alt="Copy progress dialog window showing a speed of 113MB/s"/></figure><h3 id="future-steps">Future Steps</h3><p>Switch this machine to a Linux distro and upgrade the NIC to 10G!</p></content></div></div></div>
  </body>
</html>
