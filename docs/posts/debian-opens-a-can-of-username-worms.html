<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/SubscriberLink/1000485/670ef0045e5e8a3e/">Original</a>
    <h1>Debian opens a can of username worms</h1>
    
    <div id="readability-page-1" class="page"><div>
<center>
<table>
<tbody><tr><td>
<h3>Welcome to LWN.net</h3>
<p>
The following subscription-only content has been made available to you 
by an LWN subscriber.  Thousands of subscribers depend on LWN for the 
best news from the Linux and free software communities.  If you enjoy this 
article, please consider accepting the trial offer on the right.  Thank you
for visiting LWN.net!
</p></td><td>
<div>
<h3>Free trial subscription</h3>
           <p>
           Try LWN for free for 1 month: no payment
           or credit card required.  <a href="https://lwn.net/Promo/slink-trial2-3/claim">Activate
           your trial subscription now</a> and see why thousands of
           readers subscribe to LWN.net.
           
</p></div>
</td>
</tr>

</tbody></table>
</center>

<p>It has long been said that <a href="https://martinfowler.com/bliki/TwoHardThings.html">naming things
is one of the hard things to do in computer science</a>. That may be
so, but it pales in comparison to the challenge of handling
usernames properly in applications. This is especially true when multiple
applications are involved, and they are all supposed to agree on what
characters are, and are not, allowed. The Debian project is facing
that problem right now, as two user-creation utilities disagreed about
which names are allowable. A plan is in place to sort this out
before the release of Debian 13 (&#34;trixie&#34;) sometime next year.</p>

<p>The <tt>useradd</tt> utility is part of the <a href="https://github.com/shadow-maint/shadow">shadow-utils</a>
project, which includes programs for managing user and group
accounts. The <tt>shadow-utils</tt> suite is included in Debian&#39;s
<tt><a href="https://packages.debian.org/search?keywords=passwd">passwd</a></tt>
package. For historical reasons, and to avoid confusion with the
upstream project, Debian&#39;s <a href="https://salsa.debian.org/debian/shadow">version of the
shadow-utils sources</a> are often referred to as &#34;<tt>src:shadow</tt>&#34;.</p>

<!-- middle-ad -->

<p>Most Debian users don&#39;t work with <tt>useradd</tt>, or
<tt>groupadd</tt>, directly. Instead, Debian has long supplied its own
<tt><a href="https://manpages.debian.org/bookworm/adduser/adduser.8.en.html">adduser</a></tt>
(and <tt>addgroup</tt>)
utilities, originally written by founder Ian Murdock. These act as
simpler front ends to <tt>useradd</tt> and use Debian-supplied system
defaults for creating users&#39; home directories and configurations. It
should be noted that <tt>useradd</tt>, et al., have become much more
full-featured since Debian&#39;s utilities were introduced, but the
project continues to maintain them nonetheless.</p>

<h4>Little Bobby Tables</h4>

<p>In June, Debian developer and <tt>src:shadow</tt> maintainer Chris
Hofstaedtler <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1074306">filed
a bug</a> against the <tt>adduser</tt> package. The
<tt>src:shadow</tt> package had dropped a <a href="https://sources.debian.org/patches/shadow/1:4.16.0-5/debian/Relax-usernames-groupnames-checking.patch/">Debian-specific
patch</a>, originally introduced in 2003 by Karl Ramm, to allow
characters far beyond what were allowed by the upstream
<tt>shadow-utils</tt> project. In the patch, Ramm wrote:</p>

<blockquote>
I can&#39;t come up with a good justification as to why characters other
than &#39;:&#39;s and &#39;\0&#39;s should be disallowed in group and usernames (other
than &#39;-&#39; as the leading character).  Thus, the maintenance tools don&#39;t
anymore.
</blockquote>

<p>Hofstaedtler said that he had puzzled out some of the patch&#39;s
purpose from old bug reports that had been &#34;fixed&#34; by the patch, and
those asked for two things not allowed by the upstream
<tt>shadow-utils</tt>: usernames with upper-case characters or that
are purely numeric. Hofstaedtler said that upper-case names had been
allowed in the upstream <tt>shadow-utils</tt> project &#34;<q>a long time
ago</q>&#34;, but it seemed like a bad idea to allow purely numeric
usernames.</p>

<p>The patch enabled much more than upper-case and purely numeric names,
though. With the patch dropped in version <a href="https://tracker.debian.org/news/1539923/accepted-shadow-14152-2-source-into-unstable/">1:4.15.2-2</a> of the
<tt>shadow</tt> source package, one of <tt>adduser</tt>&#39;s
<nobr>tests—which</nobr> explicitly allowed a username reminiscent of a <a href="https://xkcd.com/327/">famous xkcd comic</a>
<nobr>(&#34;<q>bob;&gt;/hacked</q>&#34;)—had failed</nobr>:</p>

<blockquote>
<p>For src:shadow, I would really like to not have a divergence from
upstream in this regard. I think if we have clear requirements then we
(I) can submit them upstream and I would expect upstream to accept
patches.</p>

<p>I do feel that making the case for &#34;bob;&gt;/hacked&#34; would be very
hard.</p>
</blockquote>

<p>Hofstaedtler said that the patch had been reapplied for the time
being, it was included again in version <a href="https://tracker.debian.org/news/1540076/accepted-shadow-14152-3-source-into-unstable/">1:4.15.2-3</a>, but he asked if
username requirements could be sorted out in time for the Debian
&#34;trixie&#34; release. If the patch were dropped entirely, then
<tt>useradd</tt> would restrict usernames to the POSIX standard, with
the exception of allowing a &#34;$&#34; character at the end of a username </p>

<p>Debian developer and <tt>adduser</tt> maintainer Marc Haber <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1074306#21">replied</a>
in late October that other tests were failing as well, and thought
that &#34;<q>useradd upstream is being too picky here</q>&#34;. Since
<tt>adduser</tt> depends on <tt>useradd</tt> it could not create users
that <tt>useradd</tt> would reject, he said he would like to
synchronize on what would be allowed or not.</p>

<p>As part of the research into what should be allowed in usernames,
Haber took over Debian&#39;s <a href="https://wiki.debian.org/UserAccounts">UserAccounts</a> wiki
page, which outlines Debian&#39;s username tools and policies, and started
looking into whether the project should relax its requirements around
usernames.</p>

<h4>Limits on usernames</h4>

<p>One of the questions that bubbles up when looking at usernames is
not just allowable characters, but the allowable length of the
username. The documentation for <tt>shadow-utils</tt> does not specify a
length for usernames or what encoding is being used. 

</p><p>However, the POSIX standard says that usernames should not include
non-ASCII characters to be portable between systems. The standard <a href="https://pubs.opengroup.org/onlinepubs/9799919799/basedefs/V1_chap03.html#tag_03_409">says</a>
that usernames should be &#34;<q>composed of characters from the portable
filename character set</q>&#34;. That set is comprised of numbers 0
through 9, upper-case and lower-case &#34;a&#34; through &#34;z&#34;, the period (.),
underscore (_), and hyphen (-). It also specifies that usernames
should not begin with a hyphen.</p>

<p>It is, however, possible to assign characters outside that set with
the tools at hand. But Linux distributions usually put up some
guardrails in the <tt>adduser</tt> and <tt>useradd</tt> configurations
to prevent administrators from creating usernames with non-ASCII
characters unintentionally. These configurations can be overridden with 
<tt>adduser</tt>&#39;s <tt>--allow-bad-names</tt> option or <tt>useradd</tt>&#39;s
<tt>--badname</tt> option.</p>  

<p>In November, Haber <a href="https://lwn.net/ml/all/Zz9xogrnHDSFjZUn@torres.zugschlus.de/">posted</a>
a message on debian-devel that he had &#34;<q>opened an especially nasty
can of worms</q>&#34; and was finding that things were more complicated
than he had understood. He sought input and opinions on a number of
questions about whether Debian should allow non-ASCII characters for usernames, how
to do that if so, and if it was more appropriate to document username
guidance in Debian&#39;s <a href="https://www.debian.org/doc/debian-policy/">Policy Manual</a>
rather than its wiki. His suggestion was to allow UTF-8 for regular
user accounts, but to restrict to ASCII for system accounts created by
Debian packages.</p>

<p>Richard Lewis <a href="https://lwn.net/ml/all/86a5dss0n6.fsf@simplex.rtf.org.uk/">asked</a>
if enabling UTF-8 would open the door to &#34;<q>some of the abuse
described</q>&#34; in a 2021 LWN article about <a href="https://lwn.net/Articles/874951/">flaws in Unicode handling</a>
that led to security exploits. He said that it seemed to be a bad
idea to make the change, even if it would be nicer for users to have
the option.</p>

<p>Haber <a href="https://lwn.net/ml/all/Z0BQgtaAgb1LYmCt@torres.zugschlus.de/">said</a>
that he was not sure if it would be dangerous to allow UTF-8 usernames,
&#34;<q>since we can expect other commands to gracefully handle a byte
stream, can&#39;t we?</q>&#34; Additionally, local administrators already
can loosen restrictions to allow UTF-8 usernames, but Debian does
not test for such use cases. Debian would become &#34;<q>more robust</q>&#34;
if it assumed UTF-8 characters would be used in usernames.
&#34;<q>Vulnerabilities that could be exploited by having non-ascii
user names are already here and present today, just not uncovered yet.</q>&#34;</p>

<p>It would be reasonable, Timo Röhling <a href="https://lwn.net/ml/all/d4qdqpeuqkgebg5hundayqafzurk72ledcv7udwdm3nwaifnpu@3hkwinihtwp2/">said</a>,
to mitigate possible <a href="https://en.wikipedia.org/wiki/IDN_homograph_attack">homograph attacks</a> by disallowing mixed alphabets
&#34;<q>such as cyrillic and latin letters in the same name</q>&#34;. Haber <a href="https://lwn.net/ml/all/Z0CzbtHUtX_8YeSq@torres.zugschlus.de/">said</a>
that was not going to help if a user could directly write to
<tt>/etc/passwd</tt>, and he was unwilling to implement that himself
in <tt>adduser</tt>. He would accept code and test cases written by
others, though.</p>

<h4>Keyboards</h4>

<p>Security concerns aside, there are other practical problems with
supporting non-ASCII usernames. Étienne Mollier <a href="https://lwn.net/ml/all/Z0DekqnxO9PARyrH@emlwks999.eu/">noted</a> that he had &#34;<q>one weird
enough</q>&#34; character in his first name that posed a problem if he had
to log in using a keyboard layout that lacked the capability to
transcribe the lower-case or upper-case &#39;e&#39; acute characters (&#34;é&#34; or
&#34;É&#34;). For that reason, he said, he felt better about keeping a full
ASCII username and &#34;<q>wouldn&#39;t feel strongly if unicode support for
login never happens</q>&#34;. But it would be good if the <a href="https://en.wikipedia.org/wiki/Gecos_field">gecos field</a> of
the <tt>passwd</tt> file had proper Unicode support to properly
display users&#39; real names.</p>

<p>Not only was it difficult to type &#34;é&#34; on some keyboards, it could
also be encoded in multiple ways. Gioele Barabucci <a href="https://lwn.net/ml/all/15f881af-2f62-494e-b6ea-a13f16eec959@svario.it/">pointed
out</a> that it could be &#34;<q>e
with acute</q>&#34; which is encoded in UTF as <tt>U+00E9</tt>, or it
could be &#34;<q>e, combined with an [acute] accent</q>&#34; which would be
<tt>U+0065</tt> plus <tt>U+0301</tt>:</p>

<blockquote>
If a keyboard input system provides the 
former sequence of bytes, but the username is stored in the login 
infrastructure using the latter sequence of [bytes], then a naive 
comparison will not find the user &#34;émollier&#34; in the system. Unicode 
defines in Annex 15 a few normalization forms as a way to work around 
this problem. But a correct use of these normalization forms still 
requires coordination and standardization among all programs accessing 
the data.
</blockquote>

<p>He asked if POSIX or other standards provided a normalization form
for UTF-8 encoded usernames. Peter Pentchev <a href="https://lwn.net/ml/all/Z0EVkB84K5nI5vnw@straylight.m.ringlet.net/">responded</a>
that POSIX said to stick to the portable filename character set to
ensure portability. Haber <a href="https://lwn.net/ml/all/Z0dLt65uVbZLxK_e@torres.zugschlus.de/">argued</a>
that it should be up to local admins to decide whether they wanted
their local user database to be portable. &#34;<q>I don&#39;t think that we should restrict
local admins who don&#39;t need that kind of portability.</q>&#34;</p>

<p>Simon McVittie <a href="https://lwn.net/ml/all/Z0M2B4CqjmJbJ5iS@remnant.pseudorandom.co.uk/">recommended</a>
that Debian consider adopting systemd&#39;s <a href="https://systemd.io/USER_NAMES/">user name syntax</a> and
concepts of &#34;strict mode&#34; and &#34;relaxed mode&#34;. The systemd tooling
adheres to a strict naming convention when creating usernames, but
it has a relaxed convention for accepting usernames created by other
tools. McVittie said that seemed like a good principle for Debian to
follow, even if its specific rules might differ from systemd&#39;s.</p>

<p>Haber seemed to agree in part, but said systemd&#39;s strict mode was
&#34;<q>even stricter than what we currently allow for system
accounts</q>&#34;, and he did not like that systemd&#39;s policies (especially with
<tt>systemd-homed</tt>, which LWN <a href="https://lwn.net/Articles/995915/">covered recently</a>) were not configurable.</p>

<h4>This time it&#39;s personal</h4>

<p>The discussion, perhaps not surprisingly, brought out some strong
feelings about how names and usernames were represented. Especially
when, as Hofstaedtler <a href="https://lwn.net/ml/all/n2uzj625zhxsg7ju6ox5vtx5cmbafzbecxb4lvv72sqruykk5s@qwlfypn2eo4e/">noted</a>,
usernames can be important to some users:</p>

<blockquote>
<p>I see and type my username hundreds times a day, people use it
to address me in written and spoken conversations with it, etc.</p>

<p>If it were my uid, which I see maybe once a week and don&#39;t have to
remember, I wouldn&#39;t care.</p>
</blockquote>

<p>Indeed, it&#39;s not uncommon in open-source communities or within
organizations to use a person&#39;s username rather than their given
name—so it is unsurprising that some people feel strongly that
usernames should be composed of a wider range of characters than POSIX
recommends. Others <a href="https://lwn.net/ml/all/D5UKN8ASXWNV.31KHR2M4P1Q4Z@philkern.de/">dislike
the practice</a> of conflating usernames with real-world names, and
see little reason to go to any trouble to go beyond ASCII.</p>

<p>Johannes Schauer Marin Rodrigues <a href="https://lwn.net/ml/all/173235075276.3934267.16369985803329427907@localhost/">supported</a>
allowing more than ASCII in usernames. He said it would be good for
Debian to put pressure on other projects to provide Unicode
support. &#34;<q>We cannot find these kind of bugs if we accept
translating everybody&#39;s given name to the American alphabet.</q>&#34;
Bálint Réczey, though, <a href="https://lwn.net/ml/all/CAK0Odpz6tXkceqimZ+Nd=GSN7bMQZOy3s25nEq6U=d40Y+M-ug@mail.gmail.com/">asked</a>
that Debian avoid opening that can of worms and imposing needless work
on upstreams. &#34;<q>Keep what works reasonably well for decades.</q>&#34;</p>

<h4>A plan</h4>

<p>Haber initially <a href="https://lwn.net/ml/all/Z0BSfVx_GjzBOGgV@torres.zugschlus.de/">seemed
bullish</a> on allowing UTF-8 usernames in Debian &#34;<q>as a courtesy to those people who need non-ascii user names to
write their name</q>&#34; and as an opportunity to find &#34;<q>bugs that are
already here</q>&#34; in Debian&#39;s software. He acknowledged that it is late
in the development cycle for trixie. But, since it was currently
possible to create usernames with UTF-8 characters, he did not want
to tighten restrictions in trixie versus Debian 12, only to
revisit those restrictions for Debian 14. In a reply to Mollier
he <a href="https://lwn.net/ml/all/Z0dJo6l-CXZQFHU3@torres.zugschlus.de/">wondered</a>
about what advice to give in Debian&#39;s documentation &#34;<q>once we have
decided to officially allow UTF-8 login names</q>&#34;.</p>

<p>On December 3, however, Haber <a href="https://lwn.net/ml/all/Z08v5ReoUOOaBi8H@torres.zugschlus.de/">said</a>
that he &#34;<q>finally understood</q>&#34; that UTF-8 support would require
more than the ability to create an UTF-8 encoded username and write 
it to <tt>/etc/passwd</tt>. Homograph characters, such as U+00E9 (é)
and U+0065 plus U+0301 (é), could be used with <tt>adduser</tt> to
create two separate users with lookalike usernames:</p>

<blockquote>
At the least, adduser should reject creating étienne if étienne
already exists - those are different user names but look the same, and
if you don&#39;t cut-and-paste user names instead of typing them you&#39;re
bound to hit the wrong user depending on HOW you type and what input
medium you use. Not good.
</blockquote>

<p>Haber said that he was the only active developer working on
<tt>adduser</tt> and did not have time to implement a check against
lookalike usernames in time for the trixie release. Worse, he said,
the Perl module that he would use (<a href="https://metacpan.org/pod/Unicode::Precis">Unicode::Precis</a>)
was not packaged for Debian and had not had a release in more than
five years.</p>

<p>The next version of <tt>adduser</tt>, Haber said, would reject
UTF-8 usernames by default. They would still be allowed when using the
<tt>--allow-bad-names</tt> option, but he said he wanted to deprecate
that option name in favor of something that doesn&#39;t use the word
&#34;bad&#34;. The <tt>--allow-all-names</tt> option will continue to pass
everything verbatim to <tt>useradd</tt>.</p>

<p>Mollier <a href="https://lwn.net/ml/all/Z09e0lyrPtwulBbv@emlwks999.eu/">thanked</a>
Haber for his work on the problem, and suggested some
alternatives to the bad names option. Barabucci also <a href="https://lwn.net/ml/all/3e2679c3-bc1a-49ab-8fe1-2fa6b8b132b8@svario.it/">thanked</a>
Haber for taking the time to research the issue, to which Haber
<a href="https://lwn.net/ml/all/Z09yAiCCsZ5Xu8bM@torres.zugschlus.de/">replied
dryly</a>, &#34;<q>I have learned many things.</q>&#34;</p>

<p>Haber&#39;s current course of action for <tt>adduser</tt> seems the
most prudent. There may be a day when it is more practical to expand
the allowed characters for usernames, but the work required to do so
right now is far greater than the benefits that users would gain in
the process.</p>

</div></div>
  </body>
</html>
