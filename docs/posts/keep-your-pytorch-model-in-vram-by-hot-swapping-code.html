<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/valine/training-hot-swap/">Original</a>
    <h1>Show HN: Keep your PyTorch model in VRAM by hot swapping code</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">This is an example of how to hotswap PyTorch training code without unloading your model weights from VRAM.</p>
<p dir="auto">For large LLMs it can take upwards of 30 seconds to load a model from disk to VRAM. Waiting 30 seconds every time you want to rerun your script slows down development. This is a barebones implementation of a method to keep large models in VRAM even after your training script exits. If a model reload is necessary, it happens in the background after exit ensuring the model will be ready immediately the next time your script is run.</p>
<p dir="auto">This works by spawning a second process that stays active after your target script exits. The script you change is not run directly. Instead, this background process runs the code on your behalf using Python&#39;s eval().</p>
<p dir="auto">This can also be used over a VPN for remote code execution. IntelliJ&#39;s remote SSH interpreter is quite buggy and not ideal for seamless remote development. Configure model_server.py to run on a remote machine, and run client.py on your development machine. Debugging with the IntelliJ debugger is supported in this configuration as well, enabling an almost seamless development experience with scripts that run instantly and are easily debuggable.</p>
<hr/>

<p dir="auto">Some work has also been done to ensure compatibility with the DearImgui Python bindings. UI code can be submitted to the server along with your training script. I personally like to build out UI for my training scripts to monitor progress, loss over time, and enable easy evaluation. Submitting your UI code along with your training code ensures that your app will launch instantly.</p>
<p dir="auto">Here&#39;s a GUI from an app that displays intermediate output of Mistral 7B. It takes about 0.32 seconds on my machine from when I run the code to when I can interact with the model, and that&#39;s including initializtion time for the GUI.
<a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/14074844/435508123-fe38bcb0-0a37-4731-a565-9a785f0885b0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NDUyMzQzOTQsIm5iZiI6MTc0NTIzNDA5NCwicGF0aCI6Ii8xNDA3NDg0NC80MzU1MDgxMjMtZmUzOGJjYjAtMGEzNy00NzMxLWE1NjUtOWE3ODVmMDg4NWIwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTA0MjElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwNDIxVDExMTQ1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWFmNzFkODQ4NWEzOTE5NzlmNzE1NDcxZDEwMWUzZGI4M2JjYTIxZGNkYzFlMDQ5NzkwYWFjOTI5YTlkNTdiNmQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.ixUpBstNUxox-iafqmf7iKUgfTyDswsZK-ovbKi2kpI"><img src="https://private-user-images.githubusercontent.com/14074844/435508123-fe38bcb0-0a37-4731-a565-9a785f0885b0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NDUyMzQzOTQsIm5iZiI6MTc0NTIzNDA5NCwicGF0aCI6Ii8xNDA3NDg0NC80MzU1MDgxMjMtZmUzOGJjYjAtMGEzNy00NzMxLWE1NjUtOWE3ODVmMDg4NWIwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTA0MjElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwNDIxVDExMTQ1NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWFmNzFkODQ4NWEzOTE5NzlmNzE1NDcxZDEwMWUzZGI4M2JjYTIxZGNkYzFlMDQ5NzkwYWFjOTI5YTlkNTdiNmQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.ixUpBstNUxox-iafqmf7iKUgfTyDswsZK-ovbKi2kpI" alt="Screenshot from 2024-12-06 01-35-09"/></a>
As an aside, you can find more transformer visualizations of mine here: <a href="https://x.com/lukasvaline" rel="nofollow">https://x.com/lukasvaline</a></p>
<hr/>

<p dir="auto">Set your model download location in model_server.py.</p>
<p dir="auto">Compatible with IntelliJ debug server. Set your debug server port to 5678.</p>
<p dir="auto">To begin using this in your development simply swap your .from_pretrained call and reference the global variable &#39;model&#39;</p>
<p dir="auto">This code goes away:</p>
<div dir="auto" data-snippet-clipboard-copy-content="model = MistralForCausalLM.from_pretrained(
    self.model_path,
    torch_dtype=torch.float16,
    device_map=device,
    use_flash_attention_2=False,
    config=self.config,
)"><pre><span>model</span> <span>=</span> <span>MistralForCausalLM</span>.<span>from_pretrained</span>(
    <span>self</span>.<span>model_path</span>,
    <span>torch_dtype</span><span>=</span><span>torch</span>.<span>float16</span>,
    <span>device_map</span><span>=</span><span>device</span>,
    <span>use_flash_attention_2</span><span>=</span><span>False</span>,
    <span>config</span><span>=</span><span>self</span>.<span>config</span>,
)</pre></div>
<p dir="auto">And is replaced with:</p>
<div dir="auto" data-snippet-clipboard-copy-content="def get_model(self):
    &#34;&#34;&#34;Get model either from global context&#34;&#34;&#34;
    global model  # Reference the global model variable

    try:
        # Check if model exists in global scope
        model
    except NameError:
        return None

    return model

model = get_model()"><pre><span>def</span> <span>get_model</span>(<span>self</span>):
    <span>&#34;&#34;&#34;Get model either from global context&#34;&#34;&#34;</span>
    <span>global</span> <span>model</span>  <span># Reference the global model variable</span>

    <span>try</span>:
        <span># Check if model exists in global scope</span>
        <span>model</span>
    <span>except</span> <span>NameError</span>:
        <span>return</span> <span>None</span>

    <span>return</span> <span>model</span>

<span>model</span> <span>=</span> <span>get_model</span>()</pre></div>
<p dir="auto">How to run:
Launch the server and keep it running</p>
<div dir="auto" data-snippet-clipboard-copy-content="training-hot-swap$ python model_server.py "><pre>training-hot-swap$ python model_server.py </pre></div>
<p dir="auto">Submit the training code to the server</p>
<div dir="auto" data-snippet-clipboard-copy-content="training-hot-swap$ python client.py ./src ./src/sample_train.py"><pre>training-hot-swap$ python client.py ./src ./src/sample_train.py</pre></div>
<hr/>

<p dir="auto">This script is a major potential security vulnerability. This is a server which by design executes arbitrary code. Don&#39;t expose this server to the internet directly.</p>
</article></div></div>
  </body>
</html>
