<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.g1a55er.net/Android-14-Still-Allows-Modification-of-System-Certificates">Original</a>
    <h1>Yes, Android 14 still allows modification of system certificates</h1>
    
    <div id="readability-page-1" class="page"><div>
      <section id="main_content">
        <article>
  
  <time datetime="2023-09-15T00:00:00+00:00">15 Sep 2023</time>
  <p>Tim Perry recently claimed in an article that <a href="https://httptoolkit.com/blog/android-14-breaks-system-certificate-installation/">“Android 14 blocks all modification of system certificates, even as root”</a>. This sparked <a href="https://news.ycombinator.com/item?id=37391521">significant discussion on Hacker News</a>. Thankfully my tests show that it is still possible to adjust the system certificate store in Android 14.</p>

<p><strong>Update Sept. 15 2023, 6:21 AM PT:</strong> After I’d already written this post but before I posted it, it looks like Perry already discovered that he can <a href="https://github.com/httptoolkit/httptoolkit-server/commit/965fd8d9b287af0e4b305d828d5e8e1aa52dce36">solve this problem</a> for his purposes by bind mounting the <code>/apex/</code> mount back to the <code>/system/</code> partition in the namespace of <code>zygote</code> and the children of <code>zygote</code>. The core of the idea came from <a href="https://mastodon.social/@tbodt/111029869755316309">a Mastodon thread with @tbodt and @tmw</a>. This post still provides a slightly alternative method, so it is still relevant, as well as still being relevant to the broader discussion.</p>

<h3 id="users-can-still-revoke-system-certificate-trust-through-the-settings-app">Users Can Still Revoke System Certificate Trust Through the Settings App</h3>

<p><img src="https://www.g1a55er.net/images/android-14-system-ca/trust-anchor-toggles.png" alt="" width="250"/></p>

<p>The headline of Perry’s article asserts that even root users cannot “modify” the system certificates at all. In fact, even in Android 14, all users can still remove certificate authorities (CAs) from the list of trusted CAs in the Settings app, just like they could in previous versions of Android.</p>

<p>To confirm that the Settings app still works, I used an Android 14 emulator to revoke trust from all the Amazon and Starfield Technologies CAs. I then accessed <a href="https://www.amazontrust.com/repository/">Amazon Trust Services Repository’s</a> test pages using Chrome. They failed to load due to an untrusted CA. I also confirmed the revocation of trust persists across reboots.</p>

<p>Based on this, I think the headline of Perry’s article is overly strong. Most of the more impassioned comments on Hacker News took the headline’s strong claim at face value. It is important to be clear: users still retain ultimate control over the trust anchors in Android 14.</p>

<h3 id="developers-can-still-add-trusted-system-certificates-via-adb">Developers Can Still Add Trusted System Certificates via ADB</h3>

<p>When I revisited the article after reading Perry’s comments on HN and Mastodon, it became clear that his primary concern was the inability to easily add temporary system CAs via ADB. This feature is critical for his product, <a href="https://httptoolkit.com">HTTP Toolkit</a>. It is also critical for many other security researchers and app developers, myself included.</p>

<p>While Perry correctly notes that the traditional method no longer functions with Android 14, the feature hasn’t been discarded.</p>

<p>I <a href="https://news.ycombinator.com/item?id=37392354">initially anticipated</a> a deep dive into APEX and its signing intricacies. Thankfully, a simpler, albeit somewhat crude, workaround exists for this as a proof-of-concept. <strong>This is not suitable for production use. For a production environment, it’s crucial to carefully limit SELinux and tmpfs security options to grant only the minimal privileges. Alternatively, one can construct a properly signed repacked APEX.</strong></p>

<div><div><pre><code><span># These commands assume a root shell. </span>
<span>#</span>
<span># Deal with the fact that there will be executables on the /apex tmpfs</span>
<span># !! Not suitable for production usage !! </span>
setenforce 0
mount <span>-o</span> remount,exec /apex
<span># Make a copy of the current conscrypt APEX contents</span>
<span>cp</span> <span>-r</span> <span>-p</span> /apex/com.android.conscrypt /apex/com.android.conscrypt-bak
<span># Lazily unmount because conscrypt might be in active use</span>
umount <span>-l</span> /apex/com.android.conscrypt
<span>rm</span> <span>-rf</span> /apex/com.android.conscrypt
<span># Put contents of conscrypt APEX on /apex tmpfs mount</span>
<span>mv</span> /apex/com.android.conscrypt-bak /apex/com.android.conscrypt
<span># Soft userspace reboot to get everything back into a consistent state </span>
killall system_server
<span># Clear system trust anchors, if desired</span>
<span>mv</span> /apex/com.android.conscrypt/cacerts /apex/com.android.conscrypt/cacerts-bak
</code></pre></div></div>

<p><img src="https://www.g1a55er.net/images/android-14-system-ca/meme.jpg" alt="" width="400"/></p>

<p>Executing these steps clears the system CA list in the “Trusted credentials” section of the Settings app - the result desired in the original post.</p>

<p><img src="https://www.g1a55er.net/images/android-14-system-ca/empty-system-ca-list.png" alt="" width="300"/></p>

<p>After this setup, adding trusted certificates is almost identical to prior versions. The only change is using /apex/com.android.conscrypt/cacerts as the destination path. I confirmed this by adding my personal CA as a system trust anchor.</p>

<p><img src="https://www.g1a55er.net/images/android-14-system-ca/personal-ca-system-ca-list.png" alt="" width="300"/></p>

<p>This process only necessitates root access and doesn’t require altering /system. If you need persistence beyond a single boot, you’ll need to modify the /system partition, just as in older Android versions. Be prepared for the slight complexity of either deleting or repacking the com.android.conscrypt APEX. I leave that as an exercise to the reader.</p>

<h3 id="verdict-all-is-well-that-ends-well">Verdict: All Is Well That Ends Well</h3>

<p>Yes, Android 14 has altered the behavior of its system certificate store. But users’ freedoms remain intact. The modifications just add a layer of indirection facilitating over-the-air updates to the certificate store. Given Android’s update delays have <a href="https://letsencrypt.org/2020/12/21/extending-android-compatibility.html">previously hurt CAs like LetsEncrypt</a>, this is a positive move. I can see how the new layer may seems complicated at first, but it does have to meet some pretty tough constraints<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>.</p>

<p>Kudos to Perry for highlighting this change. Various tools will need to be updated to work with Android 14. Once that is done, I am optimistic that security researchers, developers, and reverse engineers will retain their previous capabilities to tinker and make.</p>

<h3 id="disclosures">Disclosures</h3>

<p>I am friends with Googlers and former Googlers, but I have never worked for Google. I have previously worked as a security-focused developer for a small Android OEM, which is why this caught my attention. I do not currently work for anyone, so these opinions can only be my own.</p>



</article>
      </section>
    </div></div>
  </body>
</html>
