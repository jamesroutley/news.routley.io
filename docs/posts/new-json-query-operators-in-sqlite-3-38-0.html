<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tirkarthi.github.io/programming/2022/02/26/sqlite-json-improvements.html">Original</a>
    <h1>New JSON query operators in SQLite 3.38.0</h1>
    
    <div id="readability-page-1" class="page"><div>
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>SQLite <a href="https://www.sqlite.org/releaselog/3_38_0.html">3.38.0</a> introduced improvements to JSON query syntax using <code>-&gt;</code> and <code>-&gt;&gt;</code> operators that are similar to <a href="https://www.postgresql.org/docs/9.5/functions-json.html">PostgreSQL JSON functions</a>. In this post we will look into how this simplifies the query syntax.</p>

<h3 id="installation">Installation</h3>

<blockquote>
  <p>The JSON functions are now built-ins. It is no longer necessary to use the -DSQLITE_ENABLE_JSON1 compile-time option to enable JSON support. JSON is on by default. Disable the JSON interface using the new -DSQLITE_OMIT_JSON compile-time option.</p>
</blockquote>

<p>With the release of 3.38.0 JSON support is on by default. SQLite also provides pre-built binaries for Linux, Windows and Mac. For Linux you can get started with below. For other platforms please visit <a href="https://www.sqlite.org/download.html">downloads</a> page.</p>

<div><div><pre><code>wget https://www.sqlite.org/2022/sqlite-tools-linux-x86-3380000.zip
unzip sqlite-tools-linux-x86-3380000.zip
<span>cd </span>sqlite-tools-linux-x86-3380000
rlwrap ./sqlite3
</code></pre></div></div>

<p>I found that support for readline is missing in the prebuilt binaries. If readline and other build utilities are installed in your machine you can download and compile SQLite binary.</p>

<div><div><pre><code>wget https://www.sqlite.org/2022/sqlite-autoconf-3380000.tar.gz
<span>tar</span> <span>-xvf</span> sqlite-autoconf-3380000.tar.gz
<span>cd </span>sqlite-autoconf-3380000
./configure
make
./sqlite3
</code></pre></div></div>

<p><a href="https://sqlite.org/forum/forumpost/152354d5c474067e">JSON enhancements proposal thread</a> in SQLite forum</p>

<h3 id="sample-data">Sample data</h3>

<p>In this post we will be using a sample data that stores the interests of a user as a JSON and see how the new operators provide support in querying. The table has an auto incrementing id as primary key with name as text and a JSON storing interests of the user. Let’s also assume the array of likes are stored in the order of preferences such that for John he likes skating the most and swimming as the last.</p>

<div><div><pre><code><span>.</span><span>/</span><span>sqlite3</span>
<span>SQLite</span> <span>version</span> <span>3</span><span>.</span><span>38</span><span>.</span><span>0</span> <span>2022</span><span>-</span><span>02</span><span>-</span><span>22</span> <span>18</span><span>:</span><span>58</span><span>:</span><span>40</span>
<span>Enter</span> <span>&#34;.help&#34;</span> <span>for</span> <span>usage</span> <span>hints</span><span>.</span>
<span>Connected</span> <span>to</span> <span>a</span> <span>transient</span> <span>in</span><span>-</span><span>memory</span> <span>database</span><span>.</span>
<span>Use</span> <span>&#34;.open FILENAME&#34;</span> <span>to</span> <span>reopen</span> <span>on</span> <span>a</span> <span>persistent</span> <span>database</span><span>.</span>
<span>sqlite</span><span>&gt;</span> <span>create</span> <span>table</span> <span>user</span><span>(</span><span>id</span> <span>integer</span> <span>primary</span> <span>key</span><span>,</span> <span>name</span> <span>text</span><span>,</span> <span>interests</span> <span>json</span><span>);</span>
<span>sqlite</span><span>&gt;</span> <span>insert</span> <span>into</span> <span>user</span> <span>values</span><span>(</span><span>null</span><span>,</span> <span>&#34;John&#34;</span><span>,</span> <span>&#39;{&#34;likes&#34;: [&#34;skating&#34;, &#34;reading&#34;, &#34;swimming&#34;], &#34;dislikes&#34;: [&#34;cooking&#34;]}&#39;</span><span>);</span>
<span>sqlite</span><span>&gt;</span> <span>insert</span> <span>into</span> <span>user</span> <span>values</span><span>(</span><span>null</span><span>,</span> <span>&#34;Kate&#34;</span><span>,</span> <span>&#39;{&#34;likes&#34;: [&#34;reading&#34;, &#34;swimming&#34;], &#34;dislikes&#34;: [&#34;skating&#34;]}&#39;</span><span>);</span>
<span>sqlite</span><span>&gt;</span> <span>insert</span> <span>into</span> <span>user</span> <span>values</span><span>(</span><span>null</span><span>,</span> <span>&#34;Jim&#34;</span><span>,</span> <span>&#39;{&#34;likes&#34;: [&#34;reading&#34;, &#34;swimming&#34;], &#34;dislikes&#34;: [&#34;cooking&#34;]}&#39;</span><span>);</span>
<span>sqlite</span><span>&gt;</span> <span>.</span><span>mode</span> <span>column</span>
<span>sqlite</span><span>&gt;</span> <span>select</span> <span>*</span> <span>from</span> <span>user</span><span>;</span>
<span>id</span>  <span>name</span>  <span>interests</span>                                                   
<span>--  ----  ------------------------------------------------------------</span>
<span>1</span>   <span>John</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>,</span> <span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>                                               
<span>2</span>   <span>Kate</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>]</span><span>}</span>
<span>3</span>   <span>Jim</span>   <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>
</code></pre></div></div>

<h3 id="operator-semantics">Operator semantics</h3>

<p><a href="https://www.sqlite.org/json1.html#jptr">SQLite docs</a></p>

<p>With the above schema in place we can now use the JSON operators to query. With <code>-&gt;</code> we can have the left part as a JSON component and the right part as a path expression. <code>-&gt;</code> also provides a JSON representation in return so it can be chained in nested lookups. In the below example we look for users who have reading as their first preference. Since the interests column is of JSON type we can use <code>-&gt;</code> operator along with <code>$.likes</code> which is a path expression to get the likes attribute. Then we can pass it to <code>-&gt;&gt;</code> which also takes a path expression to its right but returns value as SQLite datatype like text, integer etc. instead of JSON. Here <code>$[0]</code> is used to access the first element of the array. As per docs path also supports negative indexing where <code>$[#-1]</code> can be used to access last element of the array.</p>

<div><div><pre><code><span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;$.likes&#39;</span><span>-&gt;&gt;</span><span>&#39;$[0]&#39;</span> <span>=</span> <span>&#39;reading&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>interests</span>                                                  
<span>--  ----  -----------------------------------------------------------</span>
<span>2</span>   <span>Kate</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>
<span>3</span>   <span>Jim</span>   <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;$.likes&#39;</span><span>-&gt;&gt;</span><span>&#39;$[0]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>interests</span>                                                   
<span>--  ----  ------------------------------------------------------------</span>
<span>1</span>   <span>John</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>,</span> <span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>
</code></pre></div></div>

<p>The above query can be further simplified removing <code>$</code> and for integers even removing quotes.</p>

<div><div><pre><code>
<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>interests</span>
<span>--  ----  ------------------------------------------------------------</span>
<span>1</span>   <span>John</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>,</span> <span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>

<span>-- As per reddit comment in r/sql for integers even [] is optional</span>
<span>-- Rules https://github.com/sqlite/sqlite/blob/a0318fd7b4fbedbce74f133fb0f84ff4a19ea075/src/json.c#L1554</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span>
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>0</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>
<span>id</span>  <span>name</span>  <span>interests</span>
<span>--  ----  ------------------------------------------------------------</span>
<span>1</span>   <span>John</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>,</span> <span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>
</code></pre></div></div>

<p>The catch with <code>-&gt;</code> and <code>-&gt;&gt;</code> is that <code>-&gt;</code> returns a JSON representation and it also expects the right side to be a JSON. This might lead to some confusion like below example where using <code>-&gt;[0]</code> doesn’t return any value since we are comparing JSON representation with text value of “skating”</p>

<div><div><pre><code><span>-- Returns no value</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>

<span>-- Returns value</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>&#39;&#34;skating&#34;&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>interests</span>                                                   
<span>--  ----  ------------------------------------------------------------</span>
<span>1</span>   <span>John</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>,</span> <span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span> 

<span>-- Returns value too with the string represented as JSON</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>json_quote</span><span>(</span><span>&#39;skating&#39;</span><span>);</span>

<span>id</span>  <span>name</span>  <span>interests</span>                                                   
<span>--  ----  ------------------------------------------------------------</span>
<span>1</span>   <span>John</span>  <span>{</span><span>&#34;likes&#34;</span><span>:</span> <span>[</span><span>&#34;skating&#34;</span><span>,</span> <span>&#34;reading&#34;</span><span>,</span> <span>&#34;swimming&#34;</span><span>],</span> <span>&#34;dislikes&#34;</span><span>:</span> <span>[</span><span>&#34;cooking&#34;</span><span>]</span><span>}</span>
</code></pre></div></div>

<p>We can also the operators to get specific fields like queries.</p>

<div><div><pre><code><span>-- List of first and last preference of users with skating as their first preference</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> 
       <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>as</span> <span>first_preference</span><span>,</span> 
       <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;$[#-1]&#39;</span> <span>as</span> <span>last_preference</span> 
       <span>from</span> <span>user</span> <span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>first_preference</span>  <span>last_preference</span>
<span>--  ----  ----------------  ---------------</span>
<span>1</span>   <span>John</span>  <span>skating</span>           <span>swimming</span>
</code></pre></div></div>

<p>We can also use the operators in sorting and grouping</p>

<div><div><pre><code><span>-- List of users sorted by their first preference</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> 
       <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>as</span> <span>first_preference</span>
       <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;$[#-1]&#39;</span> <span>as</span> <span>last_preference</span> 
       <span>from</span> <span>user</span> <span>order</span> <span>by</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>first_preference</span>  <span>last_preference</span>
<span>--  ----  ----------------  ---------------</span>
<span>2</span>   <span>Kate</span>  <span>reading</span>           <span>swimming</span>     
<span>3</span>   <span>Jim</span>   <span>reading</span>           <span>swimming</span>     
<span>1</span>   <span>John</span>  <span>skating</span>           <span>swimming</span>

<span>--  List of users grouped by their first preference</span>

<span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> 
       <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>as</span> <span>first_preference</span><span>,</span> 
       <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;$[#-1]&#39;</span> <span>as</span> <span>last_preference</span> 
       <span>from</span> <span>user</span> <span>group</span> <span>by</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span><span>;</span>

<span>id</span>  <span>name</span>  <span>first_preference</span>  <span>last_preference</span>
<span>--  ----  ----------------  ---------------</span>
<span>2</span>   <span>Kate</span>  <span>reading</span>           <span>swimming</span>     
<span>1</span>   <span>John</span>  <span>skating</span>           <span>swimming</span>
</code></pre></div></div>

<h3 id="indexing">Indexing</h3>

<p>Index can also be created for a given expression thus making the query efficient. Once we create an index for querying by first preference the index is used for</p>

<div><div><pre><code><span>-- Query plan without index</span>

<span>explain</span> <span>query</span> <span>plan</span> <span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>
<span>QUERY</span> <span>PLAN</span>
<span>--SCAN user</span>


<span>-- Create index on first preference of a user</span>

<span>create</span> <span>index</span> <span>idx_first_preference</span> <span>on</span> <span>user</span><span>(</span><span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span><span>);</span>

<span>explain</span> <span>query</span> <span>plan</span> <span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[0]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>
<span>QUERY</span> <span>PLAN</span>
<span>--SEARCH user USING INDEX idx_first_preference (&lt;expr&gt;=?)</span>

<span>explain</span> <span>query</span> <span>plan</span> <span>select</span> <span>id</span><span>,</span> <span>name</span><span>,</span> <span>interests</span> <span>from</span> <span>user</span> 
<span>where</span> <span>interests</span><span>-&gt;</span><span>&#39;likes&#39;</span><span>-&gt;&gt;</span><span>&#39;[1]&#39;</span> <span>=</span> <span>&#39;skating&#39;</span><span>;</span>
<span>QUERY</span> <span>PLAN</span>
<span>--SCAN user</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p>Enabling JSON by default and the new operators in 3.38.0 improve adoption and ergonomics of using JSON in SQLite. PostgreSQL has more rich query support which will be hopefully added in future releases.</p>

  </div>

</article>




      </div>
    </div></div>
  </body>
</html>
