<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jon.hk/elixir/ash/a-gentle-primer-to-ash/">Original</a>
    <h1>Ash: A Gentle Primer</h1>
    
    <div id="readability-page-1" class="page"><div>
<div>




<div>
<div>
<h2 id="learn-by-trying">Learn by Trying</h2>



<p><a href="https://livebook.dev/">LiveBook</a> is the interactive notebook for Elixir (like Jupyter/Quarto).  It is quick and foolproof to setup, and let you tinker with code along with explanations on the side.</p>



<figure><img data-attachment-id="778" data-permalink="https://jon.hk/elixir/ash/a-gentle-primer-to-ash/attachment/image-1-2/" data-orig-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?fit=930%2C378&amp;ssl=1" data-orig-size="930,378" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="image-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?fit=300%2C122&amp;ssl=1" data-large-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?fit=930%2C378&amp;ssl=1" decoding="async" loading="lazy" width="930" height="378" src="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?resize=930%2C378&amp;ssl=1" alt="" srcset="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?w=930&amp;ssl=1 930w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?resize=300%2C122&amp;ssl=1 300w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?resize=768%2C312&amp;ssl=1 768w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/image-1.png?resize=600%2C244&amp;ssl=1 600w" sizes="(max-width: 930px) 100vw, 930px" data-recalc-dims="1"/></figure>



<p>For this tutorial, I have prepared a set of LiveBooks (each corresponding to a section) as well as the CSV needed.  Instead of just reading, you can run the code and see it in action.  I encourage you to experiment and see what happens.</p>




</div>
</div>
</div>



<p>Ash Framework (<a href="https://ash-hq.org/">üîó website</a>) is a set of tools for Elixir, built by Zach Daniels (<a href="https://twitter.com/ZachSDaniel1">@ZachSDaniel1</a>) with sponsorship of <a href="https://alembic.com.au/">Alembic</a>.  It is incredibly thoughtful and thorough.  The exhaustiveness makes it hard to know what Ash does; the documentation is excellent but is perhaps appeals most to those who have written things the wrong way (perhaps many times) before; dwells in the abstract, and the usage of changeset / Ecto (Elixir‚Äôs database ‚ÄúORM‚Äù) might put off some beginners.  And I think Ash has <em>a lot</em> to offer for beginners, a tool to grow with and grow into.</p>



<p>This tutorial is a gentle primer, and aims to be approachable in two ways.  We will lean on analogies and pictures, and we will use a minimal setup ‚Äî only LiveBooks and two plain-text CSV files.  No formal database, no need to setup a development environment.  CSV is a relatable use-case ‚Äî ‚Äúthe standard way‚Äù probably shows code you wrote before.  It being a bunch of flat files also make it easy to see what Ash have done for us.  If you are like me, there will be a few moments that make you go, ‚ÄúWait.  Did <em>that</em> just happen?  <strong>How</strong>?‚Äù  It justifies using Ash.</p>



<p>This is going to be a single looong tutorial that is written in public, and will eventually come with some videos, the accompanying LiveBooks / CSVs, and perhaps some notes.  I assume basic familiarity with Elixir syntax but no </p>



<p>Before we introduce what we are trying to work with (and hand-roll a solution), let‚Äôs try to Explain Ash Like I am Five.</p>



<h2 id="ash-framework-eli5">Ash Framework: ELI5</h2>



<p>We want a banana cake. We are willing to gather the ingredients, and then think (!) and write (!!) to bring that banana cake about.</p>



<div>
<div>
<div>
<p>We could choose to write a <strong>recipe</strong>: an ordered list of specific actions.  Recipes are <em>procedural</em>:</p>



<ol>
<li>measure out 100 g of butter, 250 g flour, 100 g sugar, 250 cm<sup>3</sup> water, 20 g baking soda, 10 g baking powder</li>



<li>take out 3 ripe bananas and 2 large eggs</li>



<li>using a whisk, beat the eggs</li>



<li>mash the bananas with a fork</li>



<li>melt the butter using a steamer over low fire</li>



<li>add first the wet ingredients, then the dry ingredients, to the Panasonic PM106 bread-maker</li>



<li>use the ‚Äú#19 quick bread‚Äù feature</li>
</ol>



<p>We call this ‚Äúdo this, do that‚Äù the <em>imperative</em> style.</p>
</div>
</div>



<div>
<div>
<p>We could, instead, write a <strong>work order</strong> / <strong>wish-list</strong> / <strong>specification</strong>.  This (mostly unordered) list is <em>aspirational</em>:</p>



<p>Banana Bread:</p>



<ul>
<li>sweetness: not-too-sweet</li>



<li>gluten-free: true</li>



<li>vegan: false</li>



<li>nuts: [lightly toasted walnut]</li>



<li>extras: <em>dulce de leche</em><sup data-fn="a7ab2a24-ec1e-4819-ade0-c6a0df2dddff"><a href="#a7ab2a24-ec1e-4819-ade0-c6a0df2dddff" id="a7ab2a24-ec1e-4819-ade0-c6a0df2dddff-link">1</a></sup></li>
</ul>



<p>We call this the <em>declarative</em> style.</p>
</div>
</div>
</div>



<p>With Ash Framework, you write work orders and, <em>magically</em> üí´ üîÆ, the work gets done.</p>



<p>If you are actually 5 years old, magic sounds <em>great</em>.  I am guessing you just pretend to be five: the word <em>Magic</em> and those üí´ üîÆ emojis brings you bitter memories, of being disillusioned, or of javascript frameworks.  Let‚Äôs go a little deeper.</p>



<p>Under the <mark>imperative recipe paradigm</mark>, instructions are precise.  Under the control hides brittleness.  If the kitchen doesn‚Äôt have a bread-maker, or don‚Äôt have the right model of the bread-maker, all bets are off.  If we want gluten-free banana bread, we will add a nice foot-note ‚ÄúUse Bob Red Mill‚Äôs 1-for-1 Gluten Free flour, or a 4:5:1 mix of [‚Ä¶]‚Äù.  Over time, the 7 steps recipe becomes an entangled mess of foot-notes, <em>many conflicting with one another</em>.  Dad and mom argue if they should refactor the recipe.</p>



<p>With the <mark>declarative work order paradigm</mark>, nothing was ever precise.  The outcome depends on:</p>



<ol>
<li>the craftsmanship of the baker taking the work order, </li>



<li>your understanding of what the baker‚Äôs limits are, and </li>



<li>whether the baker is too proud to let you into the kitchen.</li>
</ol>



<p>Coming back to code-land, Ash-the-Baker has some hard-won skills and despite that, stays pretty humble.  </p>



<ul>
<li>Don‚Äôt have a database?  Just substitute <code>Ash.DataLayer.ETS</code>.  Or <code>AshCsv</code> like in the upcoming tutorial.  Ash is aware of whether you have a database, and thus when to construct SQL queries and when to do the queries in Elixir.  (Why use a steamer when you have a microwave?)</li>



<li>Gluten-free? Vegan? Ash accommodates most standard requests out of the box.</li>



<li>Want your finished banana bread in GraphQL or JSON shapes?  No problem.</li>



<li>You want to add some some Chili Pepper Infused Garlic Jam‚Ñ¢ per your family tradition?  Ash lets you in the kitchen to do that part.  (Plenty of escape hatches.)</li>
</ul>



<p>Keep this analogy of <strong>recipe</strong> vs. <strong>work order</strong> in mind as we work through Professeur Bunsen‚Äôs request.</p>



<h2 id="the-scenario">The Scenario</h2>



<p>Prof Bunsen teaches a Potions class.  He has already gave tests and a potion-brewing lab, and collected the data into a spreadsheet:</p>







<p>He gave this to you as a CSV file <code>potions_grade.csv</code>, and asks:</p>



<ol>
<li>calculate the term grade for each student, which is a weighed average of 60% Tests and 40% lab</li>



<li>Adam was left out in the spreadsheet.  Could you please add him back in?  Oh yea, and I‚Äôd like the CSV updated too.</li>



<li>Mozart is German!  Please change his name back to <em>Gottlieb</em> in your system.  Oh yea, and I‚Äôd like the CSV updated too.</li>



<li>can you give me a list, highest score first, of those who passed?</li>
</ol>



<p>The Potions class made us Elixir devs, and we are glad to help.  </p>



<div>
<div>
<div>
<p>We will first do this the standard way, which included:</p>



<ul>
<li>[1-1] extracting data from the CSV, </li>



<li>[1-2] transforming the data into something useful, and </li>



<li>[1-3] loading the data out to file/screen that fulfil Professor‚Äôs requests.</li>
</ul>



<p>The numbering in Chapter 1 reflects the sequence of steps we take to solve the task.  We will refer to this common pattern of Extract <code>-&gt;</code> Transform <code>-&gt;</code> Load by its acronym ETL.</p>
</div>
</div>



<div>
<div>
<p>We will then do this the Ash way, which become a taster for the following features one at a time:</p>



<ul>
<li>[2-1] resources and API</li>



<li>[2-2] constraints</li>



<li>[2-3] calculations &amp; queries</li>



<li>[2-4] (bonus) relating the wizard_houses.CSV to scores</li>
</ul>



<p>The numbering in Chapter 2 reflects our learning progression. We flesh out details of the work order in place.</p>
</div>
</div>
</div>



<p>The following zip file contains LiveBooks corresponding to the chapters.</p>



<h2 id="1-the-standard-way">1. The Standard Way</h2>



<p>We make a folder that contains the <code>potions_grade.csv</code>, and create a new LiveBook in there.  Our LiveBook is running in standalone mode, and we use the setup dropdown to select the <code>CSV</code> hex package.  This is a convenience feature that adds selected packages as a <code>Mix.install</code>.</p>



<p>(The code here breaks each conceptual step into its own procedure, sacrifice terseness and efficiency.  If you are not new to Elixir, and just want to see Ash, skip to Chapter 2.)</p>



<figure><p>
<iframe loading="lazy" src="https://player.vimeo.com/video/870727439?dnt=1&amp;app_id=122963" width="500" height="281" frameborder="0" allow="autoplay; fullscreen; picture-in-picture"></iframe>
</p><figcaption><strong>Video walkthrough of Section 1.</strong>  The content is parallel with the article and the LiveBooks, and split up into one per section.</figcaption></figure>







<p>We can refer to the directory that the LiveBook is in (and where <code>potions_grade.csv</code> is located) using <code>__DIR__</code>.</p>



<pre><code>csv_path = __DIR__ &lt;&gt; &#34;/potions_grade.csv&#34;

class_data =
  csv_path
  |&gt; File.stream!([:trim_bom])
  |&gt; CSV.decode!(headers: true)
  |&gt; Enum.take(12)</code></pre>



<p>This gives us a list of maps that is stored in the <code>class_data</code> variable:</p>



<pre><code>[
  %{
    &#34;first_name&#34; =&gt; &#34;Rachel&#34;,
    &#34;house&#34; =&gt; &#34;lion&#34;,
    &#34;last_name&#34; =&gt; &#34;Rodr√≠guez&#34;,
    &#34;practical_score&#34; =&gt; &#34;14&#34;,
    &#34;student_id&#34; =&gt; &#34;101&#34;,
    &#34;test_1_score&#34; =&gt; &#34;57&#34;,
    &#34;test_2_score&#34; =&gt; &#34;35&#34;
  },
...
]</code></pre>



<p>Notice that all the map keys are strings, and so are all the values.  We need to do some transformation of the map before we can answer Prof Black‚Äôs queries.</p>



<h3 id="1-2-transforming-the-data">1-2. Transforming the data</h3>



<p>Let‚Äôs start by making the map keys into atoms.  The outer <code>for</code> comprehension iterates over each student map, whereas the nested <code>for</code> comprehension loops over each pair of key-value within the map, returning the atomized key.</p>



<pre><code>class_data =
  for student &lt;- class_data do
    for {k, v} &lt;- student, into: %{} do
      {String.to_atom(k), v}
    end
  end</code></pre>



<p>Using <code>into: %{}</code> collects each processed student map back as a map, which would otherwise default to collecting in a list.</p>



<p>But all the values are still strings, and we can‚Äôt do calculations on strings.  Let‚Äôs fix that by converting what we know ought to be integers into integers (normally, of course, you‚Äôd atomize the keys and convert to integers in one step):</p>



<pre><code>class_data =
  for student &lt;- class_data do
    for {k, v} &lt;- student, into: %{} do
      case k do
        keys when keys in [:student_id, :test_1_score, :test_2_score, :practical_score] -&gt; {k, String.to_integer(v)}
        _ -&gt; {k, v}
      end
    end
  end</code></pre>



<p>We now have our <code>class_data</code> in a format we‚Äôd like to work with:</p>



<pre><code>[
  %{
    first_name: &#34;Rachel&#34;,
    house: &#34;lion&#34;,
    last_name: &#34;Rodr√≠guez&#34;,
    practical_score: 14,
    student_id: 101,
    test_1_score: 57,
    test_2_score: 35
  },
...
]</code></pre>



<p>This makes it straight-forward to transform, for example, adding Adam (alas, we didn‚Äôt think to check that the test_score should be between 0-100):</p>



<pre><code>class_data =
  class_data ++
    [
      %{
        student_id: 201,
        first_name: &#34;Adam&#34;,
        last_name: &#34;Added&#34;,
        test_score: 321,
        lab_score: 23
      }
    ]</code></pre>



<p>Or changing Mozart‚Äôs name back to Gottlieb (alas, having kept the students‚Äô names as a list, we will have to traverse the list <em>again</em>):</p>



<pre><code>class_data =
  for %{first_name: first_name, last_name: last_name} = student &lt;- class_data do
    case first_name == &#34;Mozart&#34; and last_name == &#34;Amadeus&#34; do
      true  -&gt; %{student | last_name: &#34;Gottlieb&#34;}
      false -&gt; student
    end
  end</code></pre>



<p>It is also easy to calculate the weighted grade:</p>



<pre><code>class_data =
  for student &lt;- class_data do
    weighed_average = 
      (0.6*student[:test_score]) + (0.4*student[:lab_score])
    Map.put_new(student, :weighed_average, weighed_average)
  end</code></pre>



<pre><code>[
  %{
    first_name: &#34;Rachel&#34;,
    house: &#34;lion&#34;,
    last_name: &#34;Rodr√≠guez&#34;,
    practical_score: 14,
    student_id: 101,
    test_1_score: 57,
    test_2_score: 35,
    weighed_average: 28.9
  },
...
]</code></pre>



<p>It all seem good to us, but alas, Professor just realized that Polly got married, and her <code>last_name</code> is now Anna.  He edited the shared CSV, but that of course has no effect on what we have loaded into memory.</p>



<h3 id="1-3-loading-back-into-csv">1-3. Loading back into CSV</h3>



<p>Let‚Äôs write the new map, with the calculated averages, back into a CSV for on-disk storage:</p>



<pre><code>output_path = &#34;#{__DIR__}/potions_grade_new.csv&#34;
new_csv =
  class_data
  |&gt; CSV.encode(headers: true)
  |&gt; Enum.to_list()

File.write!(output_path, new_csv)</code></pre>



<p>So far so good.  When Prof Black gives you another CSV file, you might extract some of the common parts into a module, but chances are there‚Äôs going to be some unnecessarily bespoke code that is left over.  And as the project grows, the logic starts to dribble in various code fragments.</p>



<h2 id="2-the-ash-way">2. The Ash Way</h2>



<h3 id="2-1-resources-api">2-1. Resources &amp; API</h3>



<p>The gradebook we had is what we would call a <em>Resource</em> in Ash.  You can think of Resources as some class of nouns which have their own internal structure and logic.  Our gradebook, for example,<sup data-fn="2076d0ea-dbd7-4739-aefa-19c8a56fb2c1"><a href="#2076d0ea-dbd7-4739-aefa-19c8a56fb2c1" id="2076d0ea-dbd7-4739-aefa-19c8a56fb2c1-link">2</a></sup></p>



<ul>
<li>came from a CSV file and should be stored back into it</li>



<li>has one entry per student;</li>



<li>each student (each entry) is uniquely identified by a student number (no student can share the same number);</li>



<li>students have a first name and a last name (but not gender or age etc);</li>



<li>there are only two scores (test and lab) and they should be numbers between 0 and 100.</li>



<li>some values, like the weighed average, <em>depends</em> on other values and should be calculated when we need them, lest we end up with <code>test_score</code> 100, <code>lab_score</code> 100, <code>weighed_average</code> 50 where we cannot know where the discrepancy arises</li>
</ul>



<p>We can write these ‚Äúinternal structure and logic‚Äù concisely and unambiguously for Ash, using its <em>domain specific language</em> (DSL).</p>



<figure><p>
<iframe loading="lazy" title="ash_primer 2-1" src="https://player.vimeo.com/video/870942709?dnt=1&amp;app_id=122963" width="500" height="281" frameborder="0" allow="autoplay; fullscreen; picture-in-picture"></iframe>
</p><figcaption>Another low production video ü•≤, this time for [2-1].</figcaption></figure>



<h4 id="elixir-equivalent-syntax">Elixir equivalent syntax</h4>



<p>Before we get into the Ash DSL, a reminder that Elixir gives us certain syntax simplification.  The following code are identical:</p>



<pre><code>#1
eat(monkey, :banana, [:speed =&gt; quickly, :quantity =&gt; 3])


#2a
monkey
|&gt; eat(:banana, [speed: quickly, quantity: 3])

#2b
monkey
|&gt; eat(:banana, speed: quickly, quantity: 3)

#3
eat monkey, :banana, [speed: quickly, quantity: 3]

#4
eat monkey, :banana, speed: quickly, quantity: 3</code></pre>



<p>#1 is a standard function.  The first argument can be pushed into the function using the pipe <code>|&gt;</code> operator and that gives us #2a.  The last argument is a keyword list, and when a keyword list is the last argument the <code>[ ]</code> can be omitted (giving us #2b).  Atom assignments can be expressed as ‚Äúinverting <code>:</code> placement‚Äù, so <code>:quantity =&gt; 3</code> and <code>quantity: 3</code> are equivalent.</p>



<p>A functions‚Äô parentheses <code>( )</code> can be omitted when that does not introduce ambiguity (#1 <code>-&gt;</code> #3b).  And if we take out the keyword list square brackets, we get the very terse #4.</p>



<p>Ash code is conventionally written with #3 style.  The following are some typical examples and what they really are:</p>



<pre><code>allow_nil? true

# this is just a function call to allow_nil?/1
allow_nil?(true)</code></pre>



<pre><code>attribute :test_score, :integer do
  constraints [
      max: 100,
      min: 0
      ]
end

# again this is a function call, this time to constraints/1, which assigns :max and :min
constraints([:max =&gt; 100, :min =&gt; 0])</code></pre>



<p>It becomes quite natural.  You will, however, need to do some work with the formatter.exs settings to make sure the Ash DSL doesn‚Äôt get eaten by your editor.</p>



<h4 id="writing-our-minimal-resource">Writing our minimal Resource</h4>



<p>Ash Resources are just a module, so we can start with </p>



<pre><code>defmodule Grade do

end</code></pre>



<p>To make Elixir recognize that <code>Grade</code> should behave like an Ash resource, we tell it with a <code>use</code> expression:</p>



<pre><code>defmodule Grade do
  use Ash.Resource
end</code></pre>



<p>Our gradebook retains its internal logical and structure, regardless of whether it is stored in (backed by) a database, in-memory, a CSV file, or not at all persisted.  To tell Ash that we are choosing (today) to use CSV as source/storage, we specify the <code>data_layer</code> option.</p>



<pre><code>defmodule Grade do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer
end</code></pre>



<p>Now we need to state some facts about the CSV file, like where it is to be found, does it have a header, and what are the columns:</p>



<pre><code>defmodule Grade do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer

  csv do
    file &#34;#{__DIR__}/potions_grade_ash.csv&#34;
    header? true

    columns [
      :id,
      :first_name,
      :last_name,
      :test_score,
      :lab_score
    ]
  end
end</code></pre>



<p>Our ‚Äúinternal structure and logic‚Äù states that, for each entry, we should keep some information, in a specific type.  In Ash, each piece of information is called an <em>Attribute</em>, and they are declared inside an <code>attributes do ... end</code> block.</p>



<pre><code>defmodule Grade do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer

  csv do
    file &#34;#{__DIR__}/potions_grade_ash.csv&#34;
    header? true

    columns [
      :id,
      :first_name,
      :last_name,
      :test_score,
      :lab_score
    ]
  end

  attributes do
    attribute :id,         :integer do
      primary_key? true
      allow_nil?   false
    end

    attribute :first_name, :string
    attribute :last_name,  :string
    attribute :test_score, :integer
    attribute :lab_score,  :integer
  end
end</code></pre>



<p>Notice that each attribute could have just a type and no other clues, in which case we omit the <code>do...end</code> block.  What I tend to do is to start with a minimum specification, and come back to flesh it out.  This is easy: the specifications are all in one place, and you will not need to dig through files and lines to find where the logic was implemented.</p>



<p>We have so far specified the <em>structure</em>.  What about the <em>logic</em>?  What verbs should our gradebook accept?  The verbs it accepts is stated inside an <code>actions do ... end</code> block, and we can for now tell Ash we haven‚Äôt thought very far, so let‚Äôs just do the defaults:</p>



<pre><code>defmodule Grade do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer

  csv do
    file &#34;#{__DIR__}/potions_grade_ash.csv&#34;
    header? true

    columns [
      :id,
      :first_name,
      :last_name,
      :test_score,
      :lab_score
    ]
  end

  attributes do
    attribute :id,         :integer do
      primary_key? true
      allow_nil?   false
    end

    attribute :first_name, :string
    attribute :last_name,  :string
    attribute :test_score, :integer
    attribute :lab_score,  :integer
  end

  actions do
    defaults [:create, :read, :update, :destroy]
  end
end</code></pre>



<p>Our baby gradebook specification is now complete, but even (especially?) in this state, we should not be letting everyone tamper with it.  People who want to get access should go through a manager.</p>



<h4 id="api">API</h4>



<p>The manager, unsurprisingly, is also just an Elixir module, with behaviours specified by Ash.  The manager is the <em>Interface</em> to all of our resources, and thus the behaviour is <code>Ash.Api</code> (application programmatic interface).  Let‚Äôs call this <code>PotionsClass</code>; maybe we will use it to help manage the potions that the students brew too.</p>



<pre><code>defmodule PotionsClass do
  use Ash.Api

  resources do
    resource Grade
  end
end</code></pre>



<p>Right now the manager is pretty permissive (anyone can come) and create/read/update/destroy using our default actions.  The manager can be taught to be suspicious (needing special credentials for different operations), and package our gradebook into different formats (e.g., JSON, graphQL).  But that is for another day.</p>



<p>When I write Ash, I tend to start with this API block, listing out the Resources.  Then I go into writing minimum specifications for each resource, their relationships, and then come back to flesh out the attributes/actions, and finally back to the API laying out how these should be accessible.</p>



<h3 id="2-2-constraints">2-2. Constraints</h3>



<h4 id="adding-details-to-our-attributes">Adding details to our attributes</h4>



<p>By stating <code>attribute :test_score, :integer</code>, we ask Ash to cast the CSV string into an integer.  We can <code>do ... end</code> better.</p>



<p>There are two categories here.  The first category of options, such as <code>allow_nil?/1</code>, can be applied to any attribute.  The second category of options is properly termed constraints.  What constraints you can apply on an attribute depends on the type.  <code>:integer</code>s, for example, are simple and accepts only <code>:max</code> and <code>:min</code>; <code>:string</code> can be tested against a regex pattern; atoms can be checked such that only <code>:open</code> and <code>:closed</code> can be valid.  And so on.  There are currently 25 built-in types, and you can find üîó <a href="https://hexdocs.pm/ash/Ash.Type.html">documentation here</a>.  (Keeping with Ash providing escape hatch (‚Äúletting you in the kitchen‚Äù), you can define your own types too.)</p>



<p>In our gradebook, we assume that every field must be filled in (that is, all students should have all of <code>first_name</code>, <code>last_name</code>, <code>test_score</code>, and <code>lab_score</code>), so we can expand all attributes into a <code>do ... end</code> block, and setting <code>allow_nil?</code> to be false. We can additionally add a type-specific constraint to our scores, so that mistakes like setting a score to 321 cannot be written into the CSV.  Our completed attribute section would look like this:</p>



<pre><code>  attributes do
    attribute :id, :integer do
      primary_key? true
      allow_nil? false
    end

    attribute :first_name, :string do
      allow_nil? fals
    end

    attribute :last_name, :string do
      allow_nil? false
    end

    attribute :test_score, :integer do
      allow_nil? false
      constraints [
        max: 100,
        min: 0
      ]
    end

    attribute :lab_score, :integer do
      allow_nil? false
      constraints [
        max: 100,
        min: 0
      ]
    end
  end</code></pre>



<p>Later on you will see Ash applying the constraints when we try to bring Adam in while providing 321 as his <code>test_score</code>.  Ash will reject our changeset (proposal for changes), and explain clearly why it rejected the proposal.  But first, an interlude about what we have written so far.</p>



<h4 id="interlude-our-situation">Interlude: Our situation</h4>



<p>By now we have the following structure, a <code>Grade</code> resource that is backed by the <code>potions CSV</code> datalayer, and accessed through the <code>PotionsClass</code> API:</p>



<figure><img data-attachment-id="677" data-permalink="https://jon.hk/elixir/ash/a-gentle-primer-to-ash/attachment/ash_csv_tutorial-03/" data-orig-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?fit=825%2C1084&amp;ssl=1" data-orig-size="825,1084" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="ash_csv_tutorial-03" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?fit=228%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?fit=779%2C1024&amp;ssl=1" decoding="async" loading="lazy" width="228" height="300" src="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?resize=228%2C300&amp;ssl=1" alt="" srcset="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?resize=228%2C300&amp;ssl=1 228w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?resize=779%2C1024&amp;ssl=1 779w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?resize=768%2C1009&amp;ssl=1 768w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?resize=600%2C788&amp;ssl=1 600w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-03.png?w=825&amp;ssl=1 825w" sizes="(max-width: 228px) 100vw, 228px" data-recalc-dims="1"/></figure>



<p>A larger project may have multiple resource inside an API, each connected to their own datalayer and can be accessed in other shapes, but it share similar structure.<sup data-fn="469cbcb6-9ff0-44ba-a91b-9deed8ffc884"><a href="#469cbcb6-9ff0-44ba-a91b-9deed8ffc884" id="469cbcb6-9ff0-44ba-a91b-9deed8ffc884-link">3</a></sup></p>



<figure><img data-attachment-id="680" data-permalink="https://jon.hk/elixir/ash/a-gentle-primer-to-ash/attachment/ash_csv_tutorial-01/" data-orig-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?fit=2680%2C1040&amp;ssl=1" data-orig-size="2680,1040" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="ash_csv_tutorial-01" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?fit=300%2C116&amp;ssl=1" data-large-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?fit=1024%2C397&amp;ssl=1" decoding="async" loading="lazy" width="1024" height="397" src="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=1024%2C397&amp;ssl=1" alt="" srcset="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=1024%2C397&amp;ssl=1 1024w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=300%2C116&amp;ssl=1 300w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=768%2C298&amp;ssl=1 768w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=1536%2C596&amp;ssl=1 1536w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=2048%2C795&amp;ssl=1 2048w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=1200%2C466&amp;ssl=1 1200w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=1320%2C512&amp;ssl=1 1320w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_csv_tutorial-01.png?resize=600%2C233&amp;ssl=1 600w" sizes="(max-width: 1000px) 100vw, 1000px" data-recalc-dims="1"/></figure>



<p>As your project grows, there may be multiple APIs, and resources relating within an API and outside the API:</p>



<figure><img data-attachment-id="682" data-permalink="https://jon.hk/elixir/ash/a-gentle-primer-to-ash/attachment/ash_larger_architecture/" data-orig-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?fit=3284%2C1111&amp;ssl=1" data-orig-size="3284,1111" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="ash_larger_architecture" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?fit=300%2C101&amp;ssl=1" data-large-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?fit=1024%2C346&amp;ssl=1" decoding="async" loading="lazy" width="1024" height="346" src="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=1024%2C346&amp;ssl=1" alt="" srcset="https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=1024%2C346&amp;ssl=1 1024w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=300%2C101&amp;ssl=1 300w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=768%2C260&amp;ssl=1 768w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=1536%2C520&amp;ssl=1 1536w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=2048%2C693&amp;ssl=1 2048w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=1200%2C406&amp;ssl=1 1200w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=1320%2C447&amp;ssl=1 1320w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?resize=600%2C203&amp;ssl=1 600w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/09/ash_larger_architecture.png?w=3000&amp;ssl=1 3000w" sizes="(max-width: 1000px) 100vw, 1000px" data-recalc-dims="1"/></figure>



<p>Over time, your specification becomes more intricate, as you bring in calculated fields, policies for who can access the resources, keeping a paper trail for changes, double-entry book keeping etc.  But for the most part there is a standard organization.</p>



<p>For those of you thinking ahead, you may be asking how these must be organized in files and folders.  Ash is agnostic to <em>where</em> you place your files / folders, so in short there is no ‚Äúmust‚Äù.  There is üîó <a href="https://hexdocs.pm/ash/structure-your-project.html">suggestion for good practice</a>, however, and it differs slightly from standard Elixir / Phoenix Context practices, so you may want to consult the suggestion and decide how you want to organize your projects.</p>



<h4 id="seeing-our-new-rules-in-action">Seeing our new rules in action</h4>



<p>We have our work order drafted; let‚Äôs pass it to Ash and see it in action.</p>



<p>To <strong>read</strong>, we go through our API module <code>PotionsClass</code>:</p>



<pre><code>PotionsClass.read!(Grade)

# which is equivalent to
Grade
|&gt; PotionsClass.read!</code></pre>



<p>This gives us a list of <code>Grade</code> structs:</p>



<pre><code>[
  %Grade{
    __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
    id: 101,
    first_name: &#34;Rachel&#34;,
    last_name: &#34;Rodr√≠guez&#34;,
    test_score: 57,
    lab_score: 14,
    aggregates: %{},
    calculations: %{},
    __metadata__: %{selected: [:id, :first_name, :last_name, :test_score, :lab_score]},
    __order__: nil,
    __lateral_join_source__: nil
  }, ...
]</code></pre>



<p>You can see that Ash Resources use Ecto (Elixir‚Äôs ‚ÄúORM‚Äù) under the hood, but they are otherwise ‚Äújust a struct‚Äù and we can handle them just like any other maps:</p>



<pre><code>Grade
|&gt; PotionsClass.read!()
|&gt; Enum.map(&amp;(&amp;1.first_name))
|&gt; Enum.sort()</code></pre>



<pre><code>[&#34;Ala&#34;, &#34;Go&#34;, &#34;Jeong-Hui&#34;, &#34;Jikky&#34;, &#34;Mark&#34;, &#34;Mozart&#34;, &#34;Polly&#34;, &#34;Rachel&#34;, &#34;Severus&#34;, &#34;Sue&#34;,
 &#34;Zach&#34;, &#34;Ëä±ÈÅì&#34;]
</code></pre>



<p>To <strong>create/update</strong> resources, we first make a <em>changeset</em>, a proposal of changes.  Ash-the-Baker will check the proposal, and let you know if what you propose is valid.  Let‚Äôs try to create Adam:</p>



<pre><code>change_proposal =
  Ash.Changeset.for_create(
    Grade,
    :create,
    %{
      id: &#34;new student&#34;,
      first_name: &#34;Adam&#34;,
      last_name: &#34;Added&#34;,
      test_score: 321, # &lt;- yikes typo
      lab_score: 23
    }
  )</code></pre>



<pre><code>#Ash.Changeset&lt;
  action_type: :create,
  action: :create,
  attributes: %{first_name: &#34;Adam&#34;, last_name: &#34;Added&#34;, lab_score: 23},
  errors: [
    %Ash.Error.Changes.InvalidAttribute{
      field: :test_score,
      message: &#34;must be less than or equal to %{max}&#34;,
      value: 321,
      ...
    },
    %Ash.Error.Changes.InvalidAttribute{
      field: :id,
      message: &#34;is invalid&#34;,
      value: &#34;new student&#34;,
      ...
    }
  ],
  data: ...,
  valid?: false
&gt;</code></pre>



<p>Ash examines the proposal declares it invalid.  Notice that the errors are listed for you, and informative.  If you submit the proposal and ask for the change in one step you will get the errors in your terminal.  Let‚Äôs fix the errors.</p>



<pre><code>change_proposal =
  Ash.Changeset.for_create(
    Grade, # we want the for_create function to act on a Grade resource,
    :create, # using the :create action (that was default)
    %{ # with this map as the data source
      id: 150,
      first_name: &#34;Adam&#34;,
      last_name: &#34;Added&#34;,
      test_score: 32,
      lab_score: 23
    }
  )

change_proposal
|&gt; PotionsClass.create!()</code></pre>



<p>This passes, and perhaps surprisingly, the changes are automatically reflected in your CSV file.  Ash managed that for you.</p>



<p>Note that the idiomatic way of writing the above is using a pipeline.  This is what you will see in the official documentation:</p>



<pre><code>Grade
|&gt; Ash.Changeset.for_create(
    :create,
    %{
      id: 150,
      first_name: &#34;Adam&#34;,
      last_name: &#34;Added&#34;,
      test_score: 32,
      lab_score: 23
    }
  )
|&gt; PotionsClass.create!()</code></pre>



<h3 id="2-3-calculations-queries">2-3. Calculations &amp; Queries</h3>



<p>For <code>weighed_average</code> and <code>full_name</code>, they should be derived from the scores and names, but not as separate fields (columns).  Imagine when we see ‚ÄúPolly‚Äù, ‚ÄúPolley‚Äù, ‚ÄúPolly Anna‚Äù; it is not clear whether Polly has married and changed her full name (but a mistake means we forgot about the last name), or the mistake is made in the full name.</p>



<p>For these derived fields, we use <em>calculations</em>.  As you may expect by now, Ash provides within Resources the <code>calculations</code> block:</p>



<pre><code>defmodule Grade do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer

  csv do
    [...]
  end

  attributes do
    [...]
  end

  calculations do
    # our calculate do-end blocks go here
  end

  actions do
    [...]
  end
end</code></pre>



<p>Each <code>calculate</code> block takes the name of the field, its type, and an Ash expression.  Ash expressions, wrapped inside an <code>expr()</code>, let you reference field names as variables.  <code>Calculate</code>s are not confined to numerical calculations, but could be a wide variety of Elixir code.  We will show some integer, string, and conditional here:</p>



<pre><code>  calculations do
    calculate :weighed_average, :float, expr(0.6 * test_score + 0.4 * lab_score)
    calculate :full_name, :string, expr(first_name &lt;&gt; &#34; &#34; &lt;&gt; last_name)
    calculate
      :pass,
      :boolean,
      expr(
        if weighed_average &gt;= 60 do
          true
        else
          false
        end
      )
  end</code></pre>



<p>If you now try to <code>PotionsClass.read!(Grade)</code>, you will see response with <code>weighed_average: #Ash.NotLoaded&lt;:calculation&gt;</code>.  Calculations can be heavy, and in other ORMs the implicit loading can cause performance problems that are gnarly to track down.  Ecto/Ash requires them to be explicitly loaded, and the <code>load/1</code> function is located inside <code>Ash.Query</code>.</p>



<pre><code>require Ash.Query

Grade
|&gt; Ash.Query.load([:weighed_average, :full_name, :pass])
|&gt; PotionsClass.read!()</code></pre>



<pre><code>[
  #Grade&lt;
    full_name: &#34;Rachel Rodr√≠guez&#34;,
    pass: false,
    weighed_average: 39.8,
    __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
    id: 101,
    first_name: &#34;Rachel&#34;,
    last_name: &#34;Rodr√≠guez&#34;,
    test_score: 57,
    lab_score: 14,
    aggregates: %{},
    calculations: %{},
    ...
  &gt;,
   ...
]
</code></pre>



<p>After we <code>load</code> a calculated value, it is part of the map and can be used in filter and sort as normal:</p>



<pre><code>passing_students =
  Grade
  |&gt; Ash.Query.load([:pass, :full_name])
  |&gt; Ash.Query.filter(pass == true)
  |&gt; Ash.Query.sort(:first_name)
  |&gt; PotionsClass.read!()
  |&gt; Enum.map(&amp; &amp;1.full_name)
  |&gt; dbg</code></pre>



<pre><code>[&#34;Go Ku&#34;, &#34;Jikky Mouse&#34;, &#34;Mozart Gottlieb&#34;, &#34;Polly Polley&#34;, &#34;Severus Snape&#34;, &#34;Zach Daniels&#34;]</code></pre>



<p>Fun thing to try here.  Open the CSV file in an editor, and manually change Polly‚Äôs last name to Anna.  Re-run the above cell  ü§Ø  I mean, <em>how</em>?</p>



<p><code>Ash.Query</code> now lets us pick out a single entry for update, so let‚Äôs change Mozart‚Äôs last_name:</p>



<pre><code>[mozart] =
  Grade
  |&gt; Ash.Query.filter(first_name == &#34;Mozart&#34;)
  |&gt; PotionsClass.read!() # this returns a list containing one %Grade{}

mozart
|&gt; Ash.Changeset.for_update(:update, %{last_name: &#34;Gottlieb&#34;})
|&gt; PotionsClass.update!()</code></pre>



<p>The change is propagated to our datalayer (csv).  In the future, there will be a <code>Ash.DataLayer.Multi</code> option where the changes can go into your sqlite file at the same time.</p>



<p>Let‚Äôs recap: we have declared a Resource that is backed by a CSV DataLayer, with some on-the-fly fields. We are able to read, create, and update entries.  You may feel that that it is all too clumsy, and wish for some cleaner interface where you can just go <code>Grade.read()</code>.  That is accomplished in Ash using <em>Code Interface</em> and is the subject of our next section.</p>



<h3 id="2-4-code-interface">2-4. Code Interface</h3>



<p><code>Ash.Query</code> and <code>Ash.Changeset</code> represent low-level approaches, and are useful to know about.  There are, however, two issues:</p>



<ol>
<li><strong>long and verbose</strong>.  We really shouldn‚Äôt need <em>four</em> lines of code just to read a <code>Grade</code> with the <code>weighed_average</code> loaded</li>



<li><strong>not managed by Ash</strong>.  When we imperatively tell <code>Ash.Query</code> / <code>Ash.Changeset</code> to ‚Äúdo this do that‚Äù, our requests are no longer managed by the <code>Grade</code> Resource.  This means these operations do not benefit from all the other magic that Ash can provide.  For example, we need to write our own access rules for who (what actors) are authorized to read / write; we need to wire up how to monitor / trace for debugging.</li>
</ol>



<p><em>Code Interfaces</em> let us bring these actions into the Resource, and they are simple as adding a <code>code_interface do ... end block</code> to the resource.</p>



<figure><p>
<iframe loading="lazy" title="ash-primer 2-4 code interface" src="https://player.vimeo.com/video/870947153?dnt=1&amp;app_id=122963" width="500" height="281" frameborder="0" allow="autoplay; fullscreen; picture-in-picture"></iframe>
</p></figure>



<pre><code>code_interface do
  define_for PotionsClass # we are still interfacing through the API

  define :create # define a set of Grade.create() functions for the :create action
  define :read
  define :update
  define :destroy

  define :passing_students # code interfaces work also for non-default actions
end

actions do
  defaults([:create, :read, :update, :destroy])

  # here&#39;s an extra action for later
  read :passing_students do # we define a new action called :passing_students, that is a kind of read
    prepare build(load: [:pass]) # build up the Resource, loading the :pass calculation
    filter expr(pass == true)
  end
end</code></pre>



<p>This creates a ‚ÄúAsh-managed shortcut‚Äù for all of our actions.  Instead of manually preparing the query / proposal (changeset) and submitting to  <code>PotionsClass</code> (API), we can now just do <code>Grade.read()</code> and get back an <code>{:ok, result}</code> tuple:</p>



<pre><code>{:ok,
 [
   #Grade&lt;
     full_name: #Ash.NotLoaded&lt;:calculation&gt;,
     pass: #Ash.NotLoaded&lt;:calculation&gt;,
     weighed_average: #Ash.NotLoaded&lt;:calculation&gt;,
     __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
     id: 101,
     first_name: &#34;Rachel&#34;,
     last_name: &#34;Rodr√≠guez&#34;,
     ...
   &gt;, ...
  ],
  ...
}</code></pre>



<p>Conveniently, by declaring the <code>:read</code> as a code interface, Ash also gives you the <code>!</code> version of the function, conveniently plugged into a pipeline: </p>



<div>
<div>
<pre><code>Grade.read!()
|&gt; Enum.max_by(&amp;(&amp;1.test_score))</code></pre>
</div>



<div>
<pre><code>#Grade&lt;
  full_name: #Ash.NotLoaded&lt;:calculation&gt;,
  pass: #Ash.NotLoaded&lt;:calculation&gt;,
  weighed_average: #Ash.NotLoaded&lt;:calculation&gt;,
  __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
  id: 112,
  first_name: &#34;Zach&#34;,
  last_name: &#34;Daniels&#34;,
  test_score: 100,
  lab_score: 100,
  aggregates: %{},
  calculations: %{},
  ...
&gt;
</code></pre>
</div>
</div>



<p>Code interface functions also accepts options.  In the case of <code>:read</code>, you can <code>load</code> calculations (and relationships):</p>



<div>
<div>
<pre><code>Grade.read!(load: [:weighed_average, :full_name])
|&gt; Enum.max_by(&amp;(&amp;1.weighed_average))</code></pre>
</div>



<div>
<pre><code>#Grade&lt;
  full_name: &#34;Zach Daniels&#34;,
  pass: #Ash.NotLoaded&lt;:calculation&gt;,
  weighed_average: 100.0,
  __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
  id: 112,
  first_name: &#34;Zach&#34;,
  last_name: &#34;Daniels&#34;,
  test_score: 100,
  lab_score: 100,
  aggregates: %{},
  calculations: %{},
  ...
&gt;
</code></pre>
</div>
</div>



<p>The idiomatic Ash way for manipulating Resources is to (1) define meaningful actions, and (2) wrap them into a code interface.  As an example, by defining the <code>:passing_student</code> read-type action, our code is not only more terse, but simply more clear as to its intent, and benefits from integration to other parts of Ash.</p>



<div>
<div>
<pre><code>Grade.passing_students!(load: :full_name)
|&gt; Enum.map(&amp;(&amp;1.full_name))

# [&#34;Polly Polley&#34;, &#34;Mozart Amadeus&#34;, &#34;Go Ku&#34;, &#34;Severus Snape&#34;, &#34;Zach Daniels&#34;, &#34;Jikky Mouse&#34;]</code></pre>
</div>



<div>
<pre><code>require Ash.Query

passing_students =
  Grade
  |&gt; Ash.Query.filter(pass == true)
  |&gt; Ash.Query.sort(:first_name)
  |&gt; Ash.Query.load([:full_name])
  |&gt; PotionsClass.read!()</code></pre>
</div>
</div>



<p>Try having a go with the <code>:update</code>, <code>:create</code>, and <code>:destroy</code> actions.  Examples are presented for you in the accompanying LiveBook.</p>



<h3 id="2-5-relationships">2-5. Relationships</h3>



<p>In this last section we look at how we associate one Resource with another.  </p>



<p>This section/LiveBook is thematically connected, but otherwise standalone: you are not expected to have gone through every previous section to be able to follow. I think this benefits readers who are happy with resources but find relationships complicated.</p>



<figure><p>
<iframe loading="lazy" title="ash-primer 2-5 relationships" src="https://player.vimeo.com/video/870949965?dnt=1&amp;app_id=122963" width="500" height="281" frameborder="0" allow="autoplay; fullscreen; picture-in-picture"></iframe>
</p></figure>



<p>We thus start with two <em>new</em> CSV files and two <em>new</em> <code>Resources</code>: <code>Student</code> and <code>House</code>. The following diagram shows their relationship:</p>



<figure><img data-attachment-id="759" data-permalink="https://jon.hk/elixir/ash/a-gentle-primer-to-ash/attachment/ash_csv_relationship-2/" data-orig-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?fit=1331%2C1108&amp;ssl=1" data-orig-size="1331,1108" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="ash_csv_relationship" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?fit=300%2C250&amp;ssl=1" data-large-file="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?fit=1024%2C852&amp;ssl=1" decoding="async" loading="lazy" width="1024" height="852" src="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=1024%2C852&amp;ssl=1" alt="" srcset="https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=1024%2C852&amp;ssl=1 1024w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=300%2C250&amp;ssl=1 300w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=768%2C639&amp;ssl=1 768w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=1200%2C999&amp;ssl=1 1200w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=1320%2C1099&amp;ssl=1 1320w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?resize=600%2C499&amp;ssl=1 600w, https://i0.wp.com/jon.hk/wp-content/uploads/2023/10/ash_csv_relationship.png?w=1331&amp;ssl=1 1331w" sizes="(max-width: 1000px) 100vw, 1000px" data-recalc-dims="1"/></figure>



<p>As usual, we will start from outside in, first defining the API:</p>



<pre><code>defmodule Potions do
  use Ash.Api

  resources do
    resource Potions.Student
    resource Potions.House
  end
end</code></pre>



<p>But before we go further, a brief note about naming.  Neither Elixir nor Ash require files to be placed in specific locations, nor do they require modules to be named in a specific way.  It is conventional, however, to ‚Äúnamespace‚Äù the Resource modules within the API module as if they are related.  We would thus use the names to visually group <code>Student</code> and <code>House</code> as <code>Potions.Student</code> and <code>Potions.House</code> respectively.</p>



<p>The Resources are defined as follows: pay attention to how the relationships do‚Ä¶end blocks are constructed.  If you are reading this on a desktop, you should see the definition for <code>Potions.Student</code> on the left, <code>Potions.House</code> on the right, offering a parallel with the diagram above.  For <code>Students</code> we are bringing in everything we have learnt thus far.</p>



<div>
<div>
<pre><code>defmodule Potions.Student do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer

  csv do
    file &#34;#{__DIR__}/data/2-5_student_ash.csv&#34;
    header? true

    columns [
      :id,
      :first_name,
      :last_name,
      :date_of_birth,
      :familiar,
      :house_id
    ]
  end

  attributes do
    attribute :id, :integer do
      primary_key? true
      allow_nil? false
    end

    attribute :first_name, :string do
      allow_nil? false
    end

    attribute :last_name, :string do
      allow_nil? false
    end

    attribute :date_of_birth, :date
    attribute :familiar, :string
    attribute :house_id, :integer
  end

  calculations do
    calculate(:full_name, :string, expr(first_name &lt;&gt; &#34; &#34; &lt;&gt; last_name))
  end

  # &lt;-- This is new
  relationships do
    belongs_to :house, Potions.House do
      # source_attribute :house_id
      attribute_type :integer
    end
  end
  # --&gt;

  code_interface do
    define_for Potions

    define :create
    define :read
    define :update
    define :destroy

    define :assign_house
  end

  actions do
    defaults [:create, :read, :update, :destroy]

    # &lt;-- we also add an action to show working with relationships
    update :assign_house do
      accept []  # No attributes should be accepted
      argument :house_id, :integer, allow_nil?: false # We accept a house&#39;s id as input here

      change manage_relationship(:house_id, :house, type: :append_and_remove)
    end
    # --&gt;
  end
end</code></pre>
</div>



<div>
<pre><code>defmodule Potions.House do
  use Ash.Resource,
    data_layer: AshCsv.DataLayer

  csv do
    file &#34;#{__DIR__}/data/2-5_house_ash.csv&#34;
    header? true
    columns [:id, :name, :features]
  end

  attributes do
    attribute :id, :integer do
      primary_key? true
      allow_nil? false
    end

    attribute :name, :string do
      allow_nil? false
    end

    attribute :features, :string
  end

  # &lt;-- the reciprocal
  relationships do
    has_many :student, Potions.Student
  end
  # --&gt;

  code_interface do
    define_for Potions

    define :create
    define :read
    define :update
    define :destroy
  end

  actions do
    defaults [:create, :read, :update, :destroy]
  end
end</code></pre>
</div>
</div>



<p>A brief aside on the primary key, which each record needs to uniquely identify itself.  For simplicity, I have chosen to put IDs in the CSV as integers.  Using integers for keys is generally bad practice, and Ash defaults to using UUID.  We thus need to tell Ash that this is an exception using <code>attribute_type :integer</code>.  If we follow the golden path of Ash, and auto-generate UUIDs, our <code>belongs_to</code> statement does not even need the <code>do...end</code> block.</p>



<p>Ash further assumes that you are naming the primary keys to be <code>:id</code> in both Resources.  If you name the primary keys something else, then you will need to explicitly state what are the primary key fields using <code>source_attribute</code> / <code>destination_attribute</code>s.</p>



<p>With code interfaces defined for our Resources, we can query relationships using <code>load</code> option built into the <code>read!()</code>.  Here we are loading both the relationship (<code>:student</code>) and a calculation in that related resource (the students‚Äô <code>:full_name</code>).</p>



<pre><code>Potions.House.read!(load: [
  :student, 
  student: [:full_name]
])</code></pre>



<pre><code>[
  #Potions.House&lt;
    student: [
      #Potions.Student&lt;
        full_name: &#34;Rachel Rodr√≠guez&#34;,
        house: #Ash.NotLoaded&lt;:relationship&gt;,
        __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
        id: 101,
        first_name: &#34;Rachel&#34;,
        last_name: &#34;Rodr√≠guez&#34;,
        date_of_birth: ~D[2000-01-01],
        familiar: &#34;cat&#34;,
        house_id: 1,
        aggregates: %{},
        calculations: %{},
        ...
      &gt;,
      ...
    ],
    __meta__: #Ecto.Schema.Metadata&lt;:built, &#34;&#34;&gt;,
    id: 1,
    name: &#34;lion&#34;,
    features: &#34;loyal and fierce&#34;,
    aggregates: %{},
    calculations: %{},
    ...
  &gt;,
  ...
]
</code></pre>



<div>
<h4 id="cautionary-note">‚ö†Ô∏è Cautionary note</h4>



<p>What you can specify in actions <em>does</em> depend on what is available from the Data Layer.  <code>AshCsv</code> in particular is rather new, and does not (yet) support <code>sort</code> and <code>filter</code> in actions, nor most <code>aggregates</code>.  These will come along using an emulation at the application (Elixir) level, similar to the treatment given for the ETS DataLayer.  Until then, you will need to (unidiomatically) filter with <code>Enum</code>.</p>



<pre><code>[ lions ] =
  Potions.House.read!(load: [:student, student: [:full_name]])
  |&gt; Enum.filter(&amp;(&amp;1.name == &#34;lion&#34;))

for student &lt;- lions.student do
  student.familiar
end

# [&#34;cat&#34;, &#34;leopard&#34;, &#34;panther&#34;, &#34;jaguar&#34;]</code></pre>
</div>



<p>When we declare our <code>Potions.Student</code> Resource, we defined a <code>:assign_house</code> action (and wrapped into a code interface) for changing a student‚Äôs <code>:house</code>.</p>



<pre><code># Potions.Student

    # &lt;-- we also add an action to show working with relationships
    update :assign_house do
      accept []  # No attributes should be accepted
      argument :house_id, :integer, allow_nil?: false # We accept a house&#39;s id as input here

      change manage_relationship(:house_id, :house, type: :append_and_remove)
    end
    # --&gt;</code></pre>



<p>We can select Rachel, and use our code interface to re-assign her:</p>



<pre><code>[rachel] =
  Potions.Student.read!(load: [:house])
  |&gt; Enum.filter(&amp;(&amp;1.first_name == &#34;Rachel&#34;))

Potions.Student.assign_house!(rachel, %{house_id: 3})</code></pre>



<p>Managing relationships is a big topic on its own, and best left for another occasion.</p>



<h2 id="outro">Outro</h2>



<p>In this tutorial, we looked why one might want to use Ash, and then progressively looked at how to construct Resources that reads and writes to a CSV (that you can look at transparently), and has attributes, calculations, relationships, actions, and code interfaces.  </p>



<p>While this may convince you to not hand-roll some CSV opening / parsing code again, this is a shallow scratch to what Ash accomplishes.  The value magnifies as Resources are wired with authorizations / policies, usage in Phoenix / LiveView forms &amp; PubSub, and observability / tracing.  Perhaps we will do a follow-up one day.</p>



<p>I hope you both learnt something new, and enjoyed the learning.</p>









<h2 id="changelog">Changelog</h2>



<ul>
<li><strong>v0.10 (2022-09-28)</strong>.  Completed LiveBooks.  Article: outlines, ELI5 &amp; standard sections.</li>



<li><strong>v0.40(2022-09-30)</strong>.  Prose for all but 2-4 relationship.</li>



<li><strong>v0.80 (2022-10-01)</strong>.  Completed LiveBook package.</li>



<li><strong>v0.90 (2022-10-03)</strong>. Added 2-4 Code Interface section + LiveBook, completed all prose.</li>
</ul>
</div></div>
  </body>
</html>
