<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://kevincox.ca/2022/05/13/wrong-by-default/">Original</a>
    <h1>Wrong by Default</h1>
    
    <div id="readability-page-1" class="page"><div><p>Posted <time datetime="2022-05-13T11:20:00-04:00">on 2022-05-13</time></p><p>A few programming languages use a “defer” pattern for resource cleanup. This is a construct such as a <code>defer</code> keyword which schedules cleanup code to run at the end of the enclosing block (or function). This is available in Zig, Go and even in GCC C.</p>

<div><pre><code><span>fn</span> <span>printFile</span><span>(</span><span>path</span><span>:</span> <span>str</span><span>)</span> <span>!</span><span>void</span> <span>{</span>
	<span>var</span> <span>f</span> <span>=</span> <span>try</span> <span>open</span><span>(</span><span>path</span><span>)</span>
	<span>defer</span> <span>f</span><span>.</span><span>close</span><span>()</span>
	<span>for</span> <span>line</span> <span>in</span> <span>f</span> <span>{</span>
		<span>print</span><span>(</span><span>try</span> <span>line</span><span>)</span>
	<span>}</span>
	<span>// File is closed here.</span>
<span>}</span>
</code></pre></div>
<p>This provides a few key benefits.</p>

<ol>
  <li>The cleanup is right next to the allocation. It is easy to spot and keep in sync.</li>
  <li>The cleanup automatically occurs even for early returns and error cases.</li>
  <li>The cleanup automatically occurs in the right order (reverse order of the keywords).</li>
</ol>

<p>This is a huge improvement to manually writing and running cleanup code. Each point above is a common source of bugs that are now easy to avoid.</p>

<p>However, <code>defer</code> has one huge downside. You need to remember it.</p>

<p>Compare to something like C++ or Rust:</p>

<div><pre><code><span>fn</span> <span>printFile</span><span>(</span><span>path</span><span>:</span> <span>&amp;</span><span>str</span><span>)</span> <span>-&gt;</span> <span>std</span><span>::</span><span>io</span><span>::</span><span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span> <span>{</span>
	<span>let</span> <span>f</span> <span>=</span> <span>std</span><span>::</span><span>fs</span><span>::</span><span>File</span><span>::</span><span>open</span><span>(</span><span>path</span><span>)</span><span>?</span><span>;</span>
	<span>for</span> <span>line</span> <span>in</span> <span>std</span><span>::</span><span>io</span><span>::</span><span>BufReader</span><span>::</span><span>new</span><span>(</span><span>f</span><span>)</span><span>.lines</span><span>()</span> <span>{</span>
		<span>println!</span><span>(</span><span>&#34;{}&#34;</span><span>,</span> <span>line</span><span>?</span><span>);</span>
	<span>}</span>
	<span>Ok</span><span>(())</span>
	<span>// File is closed here.</span>
<span>}</span>
</code></pre></div>
<p>Sure, adding one line of code isn’t hard. But you can forget. How do you even know what types need to be <code>close</code>d, <code>unlock</code>ed or otherwise disposed of? Automatic disposal (known as <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII</a>) takes this off the programmers mind and avoids bugs. Everything that needs to be cleaned up is cleaned up when it is no longer used.</p>

<p>Java has the same problem. Many programmers love garbage collectors because they clean up after you. But the problem with most garbage collectors is that they only clean up memory! There are many other types of resources such as locks, files, threads and sockets that you need to handle yourself. Some of these can be handled by finalizers but due to the possibly long length of time before they run they are not suitable for some resources such as locks.</p>

<p>A good resource management solution such as RAII can handle all resources that your program uses. For the longest time the best solution for java was <code>finally</code> blocks.</p>

<div><pre><code><span>FileInputStream</span> <span>inputStream</span> <span>=</span> <span>new</span> <span>FileInputStream</span><span>(</span><span>&#34;story.txt&#34;</span><span>);</span>
<span>try</span> <span>{</span>
	<span>// Read file here...</span>
<span>}</span> <span>finally</span> <span>{</span>
	<span>inputStream</span><span>.</span><span>close</span><span>();</span>
<span>}</span>
</code></pre></div>
<p>While this is clearly a lot more boilerplate than defer and results in an unpleasant rightward shift, it is effectively the same. And most importantly you still need to remember which types need to be closed.</p>

<p>This has gotten slightly better in Java 7 with <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/language/try-with-resources.html">the try-with-resources statement</a>.</p>

<div><pre><code><span>try</span> <span>(</span><span>FileInputStream</span> <span>inputStream</span> <span>=</span> <span>new</span> <span>FileInputStream</span><span>(</span><span>&#34;foo.txt&#34;</span><span>))</span> <span>{</span>
	<span>// Read file here...</span>
<span>}</span>
</code></pre></div>
<p>But even still, manual action is required for correctness. However, the best part of this feature may be the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/AutoCloseable.html"><code>java.lang.AutoCloseable</code> interface</a>. Finally there is a way to know which types need to be cleaned up. This machine-visible information may allow effective lints to be built. If you ever get an <code>AutoClosable</code> type you better use it in a try-with-resources statement or quickly pass it to someone else (and shift the burden to them). But complex cases would be difficult to reliably detect. For example if you store the type in a data structure and clean it up after it is removed. Even simply passing references to multiple places creates ambiguity on who is responsible for cleaning it up.</p>

<p>The moral of the story is that the best way to avoid bugs is to make them difficult to write. Ideally make bugs harder to write than correct code. <code>defer</code> and try-with-resources are “wrong by default” and require explicit work on behalf of the programmer to become correct. RAII is correct without the programmer doing anything extra.</p>

<p>This post was inspired by the <code>defer</code> keyword, but it’s a much more general problem than that. I remember a document in Google about the <code>--dont-be-stupid</code> flag. These commonly get added when a bug is found, but the fix contains an behavioural change that some client depends on, or the change needs to be carefully rolled out. After a few years most services will have dozens of these flags, all hardcoded on in the service configuration. Of course every once in a while a new instance of the service will be set up and this bug will reappear. Backwards compatibility and gradual rollouts are good, but at some point you need to update the code to be right by default.</p>
<hr/><p><a href="https://kevincox.ca/feed.atom">Feed</a> - <a href="https://feedmail.org/subscriptions/new?url=https://kevincox.ca">Newsletter</a> - <a href="mailto:blog@kevincox.ca?subject=Wrong%20by%20Default">Private Feedback</a></p></div></div>
  </body>
</html>
