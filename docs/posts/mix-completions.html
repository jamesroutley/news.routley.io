<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://erikarow.land/articles/mix-completions">Original</a>
    <h1>Mix Completions</h1>
    
    <div id="readability-page-1" class="page"><section id="Mix-Completions">

<p>I’ve released <a href="https://hex.pm/packages/mix_completions"><code>mix_completions</code></a>, a mix task that allows you to add shell completions for <code>mix</code>. <code>mix_completions</code> supports completions for <code>bash</code> and <code>zsh</code>.<label for="fn1"></label>

<span><span><code>fish</code> already had community contributions adding completions for <code>mix</code>: <a href="https://github.com/fish-shell/fish-shell/blob/master/share/completions/mix.fish">fish completions</a></span>
</span>
</p>
<section id="How-it-works">
<h2>How it works</h2>
<p><code>mix_completions</code> adds three tasks to work with shell completions:</p>
<section id="mix-complete">
<h3><code>mix complete</code></h3>
<p><code>mix complete</code> caches the available completions from <code>mix help</code>. If <code>mix complete</code> detects a <code>mix.exs</code> file, it will cache these completions in the project in <code>.mix_complete.cache</code>. Otherwise it will store the cache in <code>$XDG_CACHE_HOME/.mix_complete.cache</code>.</p>
<p>This means that you can have a separate set of completions for a project with custom tasks than what is generally available to mix globally.</p>
</section>
<section id="mix-complete-bash">
<h3><code>mix complete.bash</code></h3>
<p><code>mix complete.bash</code> will refresh the cache a la <code>mix complete</code>, and outputs bash that when sourced enables shell completions for <code>mix</code>.</p>
</section>
<section id="mix-complete-zsh">
<h3><code>mix complete.zsh</code></h3>
<p><code>mix complete.zsh</code>, like its <code>bash</code> counterpart, refreshes the cache and generates output that can be loaded by <code>zsh</code>. Instructions on where to put this output can be found in the <a href="https://github.com/erikareads/mix_completions#zsh-completions">README</a>.</p>
</section>
</section>
<section id="Why-Cache-Completions">
<h2>Why Cache Completions</h2>
<p>With shell completions there seem to be two ways of sourcing the completions:</p>
<ol>
<li>
<p>Ask the program for the completions available. This is the approach that <a href="https://cobra.dev/">cobra</a> and <a href="https://click.palletsprojects.com/en/8.1.x/">click</a> take. The shell completions they output are simply a parser for completions output by the program itself.</p>
</li>
<li>
<p>Caching completions outside of the program. This is the approach that tools like <a href="https://github.com/DannyBen/completely">completely</a> take. Saving the completions in plain text or directly in the shell output.</p>
</li>
</ol>
<p>I chose to use option 2, because Elixir has a non-trivial startup time. Recently work has reduced the startup time of the BEAM for Elixir, but <code>mix</code> still takes a few seconds to run on my machine. Instead of waiting multiple seconds for completions to come back, I chose to cache the completions in a TSV that can parsed and handled by the shell completions directly.</p>
</section>
<section id="Where-to-store-the-cache">
<h2>Where to store the cache?</h2>
<p>This project led me to learn about the <a href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html">XDG Base Directory Specification</a>. I’ve known about these environment variables for a while, but I didn’t know how to use them as a software author.</p>
<p>The XDG specification gives guidance on where to put configuration or cache files on unix systems. The recommendations were simple to use: <code>XDG_CACHE_HOME</code> is configurable by a user, and defaults to <code>$HOME/.local/cache</code> if unset.</p>
<p>I can either put my cache as a file in that directory or create a subdirectory if I have multiple cached things to store. <code>mix_completions</code> only stores one TSV for its cache, so it’s stored directly in the <code>XDG_CACHE_HOME</code> directory.</p>
</section>
<section id="Finding-all-the-tasks">
<h2>Finding all the tasks</h2>
<p>Initially, when I wanted to find all of the available mix tasks,
I used <code>System.shell</code> to call <code>mix help</code> and then processed the output with <code>awk</code>.
This got the job done, but felt fragile.</p>
<p>While explaining this to a friend, they pointed out that <code>mix help --names</code> does this work for me.<label for="fn2"></label>

<span><span>Thanks Jeff!</span>
</span>
 Though I did have to filter <code>iex</code> from the list, and I was still invoking <code>System.shell</code>.</p>
<p>Then I realized that if <code>mix</code> had an option for this, it must know how to find (and print) all of the available tasks. Now, <code>mix_completions</code> uses vendored versions of the same functions that <code>mix help</code> uses. This proved to be useful when I switched from a simple list of tasks to a tab-separated values file of both tasks and their shortsdocs, since <code>Mix.Task</code> provides helpers to fetch things like a task’s shortdoc.</p>
</section>
<section id="Limitations">
<h2>Limitations</h2>
<p>Since I chose to work in a project agnostic way, I have no way of knowing what arguments and flag are available for subcommands. Thus I chose to only provide completions for available tasks, since I can ask <code>mix</code> for these directly. The <a href="https://github.com/fish-shell/fish-shell/blob/master/share/completions/mix.fish"><code>fish</code> community completions</a> provide more granularity, at the cost of pre-assuming which tasks you have available.</p>
<p>I chose to use caching over hard-coding so that you can detect new tasks and add completions for them, if only at the surface level.</p>
</section>
<section id="Try-It-Now">
<h2>Try It Now</h2>
<p>If you would like to try <code>mix_completions</code> run:</p>
<pre><code>mix archive.install hex mix_completions
</code></pre>
<p>Instructions on how to source the completions for your chosen shell are in the <a href="https://github.com/erikareads/mix_completions">README</a>.</p>
<p>Please report any issues you find. :)</p>
<p><img alt="mix completions example gif" src="https://erikarow.land/mix_completions_example.gif"/></p>
</section>
</section></div>
  </body>
</html>
