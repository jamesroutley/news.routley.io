<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/dbohdan/recur">Original</a>
    <h1>Show HN: Retry a command with exponential backoff and jitter (&#43; Starlark exprs)</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto"><strong>recur</strong> is a command-line tool that runs a single command repeatedly until it succeeds or no more attempts are left.
It implements optional <a href="https://en.wikipedia.org/wiki/Exponential_backoff" rel="nofollow">exponential backoff</a> with configurable <a href="https://en.wikipedia.org/wiki/Thundering_herd_problem#Mitigation" rel="nofollow">jitter</a>.
It lets you write the success condition in Starlark.</p>

<ul dir="auto">
<li>Go 1.19</li>
<li>POSIX Make for testing</li>
</ul>


<p dir="auto">Prebuilt binaries for
FreeBSD (amd64),
Linux (aarch64, riscv64, x86_64),
macOS (arm64, x86_64),
NetBSD (amd64),
OpenBSD (amd64),
and Windows (amd64, x86)
are attached to <a href="https://github.com/dbohdan/recur/releases">releases</a>.</p>

<p dir="auto">Install Go, then run the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go install github.com/dbohdan/recur@latest"><pre>go install github.com/dbohdan/recur@latest</pre></div>

<div data-snippet-clipboard-copy-content="Usage: recur [-a &lt;attempts&gt;] [-b &lt;backoff&gt;] [-c &lt;condition&gt;] [-d &lt;delay&gt;] [-f]
[-j &lt;jitter&gt;] [-m &lt;max-delay&gt;] [-t &lt;timeout&gt;] [-v] &lt;command&gt; [&lt;arg&gt; ...]

Retry a command with exponential backoff and jitter.

Arguments:
  &lt;command&gt;
          Command to run.

  [&lt;arg&gt; ...]
          Arguments to the command.

Flags:
  -h, --help
          Print this help message and exit.

  -V, --version
          Print version number and exit.

  -a, --attempts 10
          Maximum number of attempts (negative for infinite).

  -b, --backoff 0
          Base for exponential backoff (duration).

  -c, --condition &#39;code == 0&#39;
          Success condition (Starlark expression).

  -d, --delay 0
          Constant delay (duration).

  -f, --forever
          Infinite attempts.

  -j, --jitter &#39;0,0&#39;
          Additional random delay (maximum duration or &#39;min,max&#39; duration).

  -m, --max-delay 1h
          Maximum allowed sum of constant delay and exponential backoff
(duration).

  -t, --timeout -1s
          Timeout for each attempt (duration; negative for no timeout).

  -v, --verbose
          Increase verbosity (up to 3 times)."><pre lang="none"><code>Usage: recur [-a &lt;attempts&gt;] [-b &lt;backoff&gt;] [-c &lt;condition&gt;] [-d &lt;delay&gt;] [-f]
[-j &lt;jitter&gt;] [-m &lt;max-delay&gt;] [-t &lt;timeout&gt;] [-v] &lt;command&gt; [&lt;arg&gt; ...]

Retry a command with exponential backoff and jitter.

Arguments:
  &lt;command&gt;
          Command to run.

  [&lt;arg&gt; ...]
          Arguments to the command.

Flags:
  -h, --help
          Print this help message and exit.

  -V, --version
          Print version number and exit.

  -a, --attempts 10
          Maximum number of attempts (negative for infinite).

  -b, --backoff 0
          Base for exponential backoff (duration).

  -c, --condition &#39;code == 0&#39;
          Success condition (Starlark expression).

  -d, --delay 0
          Constant delay (duration).

  -f, --forever
          Infinite attempts.

  -j, --jitter &#39;0,0&#39;
          Additional random delay (maximum duration or &#39;min,max&#39; duration).

  -m, --max-delay 1h
          Maximum allowed sum of constant delay and exponential backoff
(duration).

  -t, --timeout -1s
          Timeout for each attempt (duration; negative for no timeout).

  -v, --verbose
          Increase verbosity (up to 3 times).
</code></pre></div>
<p dir="auto">The &#34;duration&#34; arguments take <a href="https://pkg.go.dev/time#ParseDuration" rel="nofollow">Go duration strings</a>;
for example, <code>0</code>, <code>100ms</code>, <code>2.5s</code>, <code>0.5m</code>, or <code>1h</code>.
The value of <code>-j</code>/<code>--jitter</code> must be either one duration string or two joined with a comma, like <code>1s,2s</code>.</p>
<p dir="auto">Setting the delay (<code>-d</code>/<code>--delay</code>) increases the maximum delay (<code>-m</code>/<code>--max-delay</code>) to that value when the maximum delay is shorter.
Use <code>-m</code>/<code>--max-delay</code> after <code>-d</code>/<code>--delay</code> if you want a shorter maximum delay.</p>
<p dir="auto">recur exits with the last command&#39;s exit code unless the user overrides this in the condition.
When the command is not found during the last attempt,
recur exits with the code 255.</p>

<p dir="auto">recur supports a limited form of scripting.
You can define the success condition using an expression in <a href="https://laurent.le-brun.eu/blog/an-overview-of-starlark" rel="nofollow">Starlark</a>, a small scripting language derived from Python.
The default condition is <code>code == 0</code>.
It means recur will stop retrying when the exit code of the command is zero.</p>
<p dir="auto">If you know Python, you can quickly start writing recur conditions in Starlark.
The most significant differences between Starlark and Python for this purpose are:</p>
<ul dir="auto">
<li>Starlark has no <code>is</code>.
You must write <code>code == None</code>, not <code>code is None</code>.</li>
<li>Starlark has no sets.
Write <code>code in (1, 2, 3)</code> or <code>code in [1, 2, 3]</code> rather than <code>code in {1, 2, 3}</code>.</li>
</ul>
<p dir="auto">You can use the following variables in the condition expression:</p>
<ul dir="auto">
<li><code>attempt</code>: <code>int</code> — the number of the current attempt, starting at one.
Combine with <code>--forever</code> to use the condition instead of the built-in attempt counter.</li>
<li><code>code</code>: <code>int | None</code> — the exit code of the last command.
<code>code</code> is <code>None</code> when the command was not found.</li>
<li><code>command_found</code>: <code>bool</code> — whether the last command was found.</li>
<li><code>max_attempts</code>: <code>int</code> — the value of the option <code>--attempts</code>.
<code>--forever</code> sets it to -1.</li>
<li><code>time</code>: <code>float</code> — the time the most recent attempt took, in seconds.</li>
<li><code>total_time</code>: <code>float</code> — the time between the start of the first attempt and the end of the most recent, again in seconds.</li>
</ul>
<p dir="auto">recur defines one custom function:</p>
<ul dir="auto">
<li><code>exit(code: int | None) -&gt; None</code> — exit with the exit code.
If <code>code</code> is <code>None</code>, exit with the exit code for a missing command (255).</li>
</ul>
<p dir="auto">This function allows you to override the default behavior of returning the last command&#39;s exit code.
For example, you can make recur exit with success when the command fails.</p>
<div dir="auto" data-snippet-clipboard-copy-content="recur --condition &#39;code != 0 and exit(0)&#39; sh -c &#39;exit 1&#39;
# or
recur --condition &#39;False if code == 0 else exit(0)&#39; sh -c &#39;exit 1&#39;"><pre>recur --condition <span><span>&#39;</span>code != 0 and exit(0)<span>&#39;</span></span> sh -c <span><span>&#39;</span>exit 1<span>&#39;</span></span>
<span><span>#</span> or</span>
recur --condition <span><span>&#39;</span>False if code == 0 else exit(0)<span>&#39;</span></span> sh -c <span><span>&#39;</span>exit 1<span>&#39;</span></span></pre></div>
<p dir="auto">In the following example we stop early and do not retry when the command&#39;s exit code indicates incorrect usage or a problem with the installation.</p>
<div dir="auto" data-snippet-clipboard-copy-content="recur --condition &#39;code == 0 or (code in (1, 2, 3, 4) and exit(code))&#39; curl &#34;$url&#34;"><pre>recur --condition <span><span>&#39;</span>code == 0 or (code in (1, 2, 3, 4) and exit(code))<span>&#39;</span></span> curl <span><span>&#34;</span><span>$url</span><span>&#34;</span></span></pre></div>

<p dir="auto">MIT.</p>

<p dir="auto">recur was inspired by <a href="https://github.com/tirsen/retry-cli">retry-cli</a>.
I wanted something like retry-cli but without the Node.js dependency.</p>
<p dir="auto">There are other similar tools:</p>
<ul dir="auto">
<li><a href="https://github.com/rye/eb">eb</a>.
Written in Rust.
<code>cargo install eb</code>.</li>
<li><a href="https://github.com/joshdk/retry">retry (joshdk)</a>.
Written in Go.
<code>go install github.com/joshdk/retry@master</code>.</li>
<li><a href="https://github.com/kadwanev/retry">retry (kadwanev)</a>.
Written in Bash.</li>
<li><a href="https://github.com/minfrin/retry">retry (minfrin)</a>.
Written in C.
Packaged for Debian and Ubuntu.
<code>sudo apt install retry</code>.</li>
<li><a href="https://github.com/timofurrer/retry-cmd">retry (timofurrer)</a>.
Written in Rust.
<code>cargo install retry-cmd</code>.</li>
<li><a href="https://github.com/tirsen/retry-cli">retry-cli</a>.
Written in JavaScript for Node.js.
<code>npx retry-cli</code>.</li>
<li><a href="https://github.com/skx/sysbox">SysBox</a> includes the command <code>splay</code>.
Written in Go.
<code>go install github.com/skx/sysbox@latest</code>.</li>
</ul>
</article></div></div>
  </body>
</html>
