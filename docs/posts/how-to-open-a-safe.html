<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/H4ckd4ddy/bypass-sentry-safe">Original</a>
    <h1>How to open a safe</h1>
    
    <div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text">
<h3 dir="auto"><a id="user-content-tldr" aria-hidden="true" href="#tldr"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>TL;DR</h3>
<p dir="auto">A vulnerability allows opening electronic safes from the Sentry Safe and Master Lock company without any pin code.</p>
<p dir="auto">The company was notified but never responded.</p>
<p dir="auto">I created an alternative PCB and firmware to patch this issue, <a href="https://github.com/H4ckd4ddy/fix-sentry-safe">available here</a></p>
<h3 dir="auto"><a id="user-content-story" aria-hidden="true" href="#story"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Story</h3>
<p dir="auto">I just bought a logic analyser, what can I do with it?</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/analyser.jpg"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/analyser.jpg" alt="Logic Analyser"/></a></p>
<p dir="auto">Look around... TV... printer...</p>
<p dir="auto">... electronic safe!</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/safe.jpg"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/safe.jpg" alt="Safe"/></a></p>
<h3 dir="auto"><a id="user-content-disassembly" aria-hidden="true" href="#disassembly"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Disassembly</h3>
<p dir="auto">Let&#39;s try to understand how it works.</p>
<p dir="auto">Start by disassembling the door to take a look inside.</p>
<p dir="auto">There are only two circuit boards:</p>
<ul dir="auto">
<li>1x outside with batteries, keypad, leds &amp; buzzer</li>
<li>1x inside with memory &amp; solenoid (who mechanically unlock the bolts)</li>
</ul>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/boards_front.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/boards_front.png" alt="Front of boards"/></a>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/boards_back.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/boards_back.png" alt="Back of boards"/></a></p>
<h3 dir="auto"><a id="user-content-capture" aria-hidden="true" href="#capture"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Capture</h3>
<p dir="auto">Between these two boards, there are 4 wires (black, yellow, green &amp; red). As the color of wires are not always respected, let&#39;s assume that we don&#39;t trust them. We can inspect circuit tracks to find the wire mapping, but as my new logic analyser can cature 8 channels, let&#39;s just plug each wire in.</p>
<p dir="auto">This kind of electronic safe needs a 5 digits code, so for the first cature I will just press the &#34;1&#34; key 5 times.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/11111.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/11111.png" alt="11111 capture"/></a></p>
<p dir="auto">Result : only green wire has changing signal. Black is always low, yellow &amp; red are always high (so colors are respected).</p>
<p dir="auto">We can see on the captured signal 5 repetitions of the same shape in a row, so we can assume that matches our &#34;1&#34; key pressed 5 times.
To decode the full signal, we have to find the protocol used.</p>
<p dir="auto">This safe is not open hardware or software, so we don&#39;t know how it works.</p>
<p dir="auto">So let&#39;s take a look at the chips on boards.</p>
<p dir="auto">Only one microcontroller on each of them.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/chip.jpg"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/chip.jpg" alt="Chip"/></a></p>
<p dir="auto">According to the datasheet, main communication protocols used with this microcontroller are SPI and IÂ²C.
But not this time, cause both of them need a clock signal, and there is no movement on any of the other wires.</p>
<p dir="auto">So I guess it can be the most used asynchronous bus protocol: UART</p>
<p dir="auto">Good news, the open source pulseview software contains a lot of decoders including UART.</p>
<p dir="auto">But which frequency is being used?</p>
<p dir="auto">To find out the frequency, I start by measuring time between each shape that we suppose to be a pressed key.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/time.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/time.png" alt="Time"/></a></p>
<p dir="auto">The whole key took 2.1 ms to be transmitted, and the shortest peak took approximatly 0.2 ms.
UART uses basically 1 start bit, 8 data bits &amp; 1 stop bit = 10 bits</p>
<p dir="auto">2.1 ms / 10 = 0.21 ms</p>
<p dir="auto">This matches with our shortest peak.</p>
<p dir="auto">10 bits in 2.1 ms
so
(1000 ms / 2.1 ms) * 10 = number of bits that can be transmitted in a second ~= 4762</p>
<p dir="auto">UART frequency must match 9600 subdivision, 4762 is very close to 4800 wich match 9600/2, a common speed for UART.</p>
<p dir="auto">So we try to set this frequency in our decoder.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/decode.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/decode.png" alt="Decode UART"/></a></p>
<p dir="auto">It works! We can read our 5x &#34;1&#34; keys.</p>
<p dir="auto">After some tries with different codes, here is some observations about different signal parts:</p>
<ul dir="auto">
<li>signal always begins by a wake up shape with 2.7 ms low state, then 0.25ms high (not part of UART protocol)</li>
<li>after wake up, signal always sends 0x0 byte</li>
<li>after that, fixed value 0x71 is sent, it seems to be a command byte (0x71 = try an unlock)</li>
<li>then 5 digits of the pressed code are sent</li>
<li>finaly, the last byte changes depending on the code, it seems to be a custom checksum</li>
</ul>
<p dir="auto">Here is data :t</p>
<table>
<thead>
<tr>
<th>Command byte</th>
<th>Tried Code</th>
<th>Checksum byte</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x71</td>
<td>11111</td>
<td>0x76</td>
</tr>
<tr>
<td>0x71</td>
<td>22222</td>
<td>0x7B</td>
</tr>
<tr>
<td>0x71</td>
<td>12345</td>
<td>0x80</td>
</tr>
</tbody>
</table>
<p dir="auto">We can see that checksum corresponds to command byte added to each code byte.</p>
<p dir="auto">Now we have all the information needed to automate this process with a short Arduino function.</p>
<div data-snippet-clipboard-copy-content="void send_command(int command, int a, int b, int c, int d, int e) {
  int checksum = (command + a + b + c + d + e);
  
  // Wake-up signal shape
  pinMode(pin, OUTPUT);
  digitalWrite(pin, LOW);
  delayMicroseconds(2750);
  digitalWrite(pin, HIGH);
  delayMicroseconds(200);

  // Data
  Serial.begin(4800);
  Serial.write(0x0);
  Serial.write(command);
  Serial.write(a);
  Serial.write(b);
  Serial.write(c);
  Serial.write(d);
  Serial.write(e);
  Serial.write(checksum);
  Serial.end();

  pinMode(pin, OUTPUT);
  digitalWrite(pin, HIGH);
}"><pre><span>void</span> <span>send_command</span>(<span>int</span> command, <span>int</span> a, <span>int</span> b, <span>int</span> c, <span>int</span> d, <span>int</span> e) {
  <span>int</span> checksum = (command + a + b + c + d + e);
  
  <span><span>//</span> Wake-up signal shape</span>
  <span>pinMode</span>(pin, OUTPUT);
  <span>digitalWrite</span>(pin, LOW);
  <span>delayMicroseconds</span>(<span>2750</span>);
  <span>digitalWrite</span>(pin, HIGH);
  <span>delayMicroseconds</span>(<span>200</span>);

  <span><span>//</span> Data</span>
  Serial.<span>begin</span>(<span>4800</span>);
  Serial.<span>write</span>(<span>0x0</span>);
  Serial.<span>write</span>(command);
  Serial.<span>write</span>(a);
  Serial.<span>write</span>(b);
  Serial.<span>write</span>(c);
  Serial.<span>write</span>(d);
  Serial.<span>write</span>(e);
  Serial.<span>write</span>(checksum);
  Serial.<span>end</span>();

  <span>pinMode</span>(pin, OUTPUT);
  <span>digitalWrite</span>(pin, HIGH);
}</pre></div>
<p dir="auto">But even if each code can be tried very fast, the safe contains bruteforce protection.</p>
<p dir="auto">So I try to capture the signal during code change to see what append.</p>
<p dir="auto">To change the code :</p>
<ul dir="auto">
<li>Press the &#34;P&#34; button</li>
<li>Enter the factory code</li>
<li>Enter your new code</li>
</ul>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/change.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/change.png" alt="Change code signal"/></a></p>
<p dir="auto">When we look at the signal :</p>
<ul dir="auto">
<li>Some strange custom shapes are sent during &#34;P&#34; press</li>
<li>Keypad board sends factory code with a 0x74 command byte</li>
<li>The chip inside responds if factory code is valid or not (factory code is printed on manual, random and cannot be changed)</li>
<li>Keypad send new code with 0x75 command byte</li>
</ul>
<p dir="auto">I also capture the signal exchange at boot time, so we can now map some functions :</p>
<table>
<thead>
<tr>
<th>Command byte</th>
<th>Function</th>
<th>Code provided</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x71</td>
<td>Try to unlock</td>
<td>Code to try</td>
</tr>
<tr>
<td>0x74</td>
<td>Try to init code change</td>
<td>Factory code</td>
</tr>
<tr>
<td>0x75</td>
<td>End code change process</td>
<td>New code</td>
</tr>
<tr>
<td>0x78</td>
<td>Boot</td>
<td>00000 (null)</td>
</tr>
</tbody>
</table>
<p dir="auto">But what happends if you directly send a new code signal, skiping factory code step...</p>
<p dir="auto">... the code is overwritten !!! So we can reset code without knowing it.</p>
<p dir="auto">We can now open every Sentry Safe &amp; Master lock electronic safe in a second.</p>
<h3 dir="auto"><a id="user-content-poc" aria-hidden="true" href="#poc"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Poc</h3>
<p dir="auto">As a Proof of Conncept, I will build a pocket tool.</p>
<p dir="auto">I took an Atmega328, 8bits AVR microcontroller at 8 MHz (without crystal). After flashing the program to its flash, I solder on two CR2032 batteries, a button and two pins.</p>
<p dir="auto">The program will just send a reset signal to set a dummy code, then send an unlock signal to open safe.</p>
<p dir="auto">And I put all of this in a pen... to have a real pen-test tool.</p>
<p dir="auto"><g-emoji alias="tada" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png">ðŸŽ‰</g-emoji></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/hardware.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/hardware.png" alt="Hardware"/></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/pen.png"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/pen.png" alt="Pen-test tool"/></a></p>
<p dir="auto">How to use it :</p>
<ul dir="auto">
<li>Remove tiny screw in front of safe</li>
<li>Touch black and green wires with two pins of our pen</li>
<li>Press button</li>
<li>Safe is open !</li>
</ul>
<h3 dir="auto"><a id="user-content-demo" aria-hidden="true" href="#demo"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Demo</h3>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/H4ckd4ddy/bypass-sentry-safe/blob/master/images/demo.gif"><img src="https://github.com/H4ckd4ddy/bypass-sentry-safe/raw/master/images/demo.gif" alt="Demo" data-animated-image=""/></a></p>
<h3 dir="auto"><a id="user-content-fix" aria-hidden="true" href="#fix"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Fix</h3>
<p dir="auto">To fix this vulnerability, <a href="https://github.com/H4ckd4ddy/fix-sentry-safe">check my other repository</a></p>
</article>
          </div></div>
  </body>
</html>
