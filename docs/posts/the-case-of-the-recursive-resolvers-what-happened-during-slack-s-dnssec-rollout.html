<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://slack.engineering/what-happened-during-slacks-dnssec-rollout/">Original</a>
    <h1>The case of the recursive resolvers: What happened during Slack’s DNSSEC rollout</h1>
    
    <div id="readability-page-1" class="page"><div id="content-area">
	<div>
		<main id="primary">
			<article id="post-14285">
				<!-- .entry__header -->

									<div>
						<p>On September 30th 2021, Slack had an <a href="https://status.slack.com/2021-09-30">outage</a> that impacted less than 1% of our online user base, and lasted for 24 hours. This outage was the result of our attempt to enable DNSSEC — an extension intended to secure the DNS protocol, required for <a href="https://csrc.nist.gov/projects/risk-management/sp800-53-controls/release-search#!/control">FedRAMP Moderate</a> — but which ultimately led to a series of unfortunate events.</p>
<p>The internet relies very heavily on the Domain Name System (<a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS</a>) protocol. DNS is like a phone book for the entire internet. Web sites are accessed through <a href="https://en.wikipedia.org/wiki/Domain_name">domain names</a>, but web browsers interact using <a href="https://en.wikipedia.org/wiki/IP_address">IP addresses</a>. DNS translates domain names to IP addresses, so that browsers can load the sites you need. Refer to <a href="https://www.cloudflare.com/en-us/learning/dns/what-is-dns/">‘What is DNS?’ by Cloudflare</a> to read more about how DNS works and all the necessary steps to do a domain name lookup.</p>
<p><img loading="lazy" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?w=640" alt="" width="667" height="134" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png 3263w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?resize=640,129 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?resize=768,154 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?resize=1280,257 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?resize=1536,309 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?resize=2048,412 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-dns-path-example.png?resize=1920,386 1920w" sizes="(max-width: 479px) 90vw, (max-width: 599px) 432px, 536px"/></p>
<p>DNS as a protocol is insecure by default, and anyone in transit between the client and the <a href="https://en.wikipedia.org/wiki/Name_server#Authoritative_name_server">authoritative DNS name server</a> for a given domain name can tamper with the response, directing the client elsewhere. DNS has a security extension commonly referred to as <a href="https://en.wikipedia.org/wiki/Domain_Name_System_Security_Extensions">DNSSEC</a>, which prevents tampering with responses between the authoritative DNS server of the domain name (i.e. slack.com.) and the client’s DNS recursive resolver of choice. DNSSEC will not protect the last mile of DNS — which is the communication between the client and their DNS recursor — from a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">MiTM attack</a>. While we are aware of the <a href="https://sockpuppet.org/blog/2015/01/15/against-dnssec/">debate around the utility of DNSSEC</a> among the DNS community, we are still committed to securing Slack for our customers.</p>
<p><img loading="lazy" width="2698" height="1794" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?w=640" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png 2698w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?resize=640,426 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?resize=768,511 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?resize=1280,851 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?resize=1536,1021 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?resize=2048,1362 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-DNSSEC-secure-path.png?resize=1920,1277 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/></p>
<p>At Slack, we use <a href="https://aws.amazon.com/route53/">Amazon Route 53</a> as our authoritative DNS server for all our public domains, delegating some subzones to <a href="https://ns1.com/">NS1</a>. We do this to make use of NS1’s advanced traffic management features. All these zones are operated by the Traffic Engineering team at Slack.</p>
<p>For the last four months, the team has been working on enabling DNSSEC signing on all <a href="https://en.wikipedia.org/wiki/Domain_name">domains</a> used by Slack. At the time of the incident, all critical Slack domains, other than slack.com, already had DNSSEC enabled for at least one month.</p>
<p>By design, DNSSEC can only be enabled on a per-domain basis, making it impossible to enable DNSSEC per subdomain (i.e. example.slack.com) or subzone (i.e. wss-backup.slack.com, which is delegated from the slack.com Route53 zone to NS1). This design choice significantly increases the risk of DNSSEC rollouts.</p>
<p>Accordingly, we were careful about testing that our domains were still resolving correctly. For each domain that we enabled DNSSEC on we did the following validation:</p>
<ul>
<li>We created external monitoring and alerting for DNS and DNSSEC resolution from multiple locations around the globe using many resolvers (including Cloudflare, Comodo, Google, OpenDNS, Quad9, and Verisign).</li>
<li>We created multiple <a href="https://dnsviz.net">dnsviz.net</a> and <a href="https://dnssec-debugger.verisignlabs.com/">Verisign DNSSEC Debugger</a> tests to make sure that our zones were set up correctly, and that the chain of trust between authoritative and delegated zones was successful.</li>
<li>We created multiple <a href="https://dnschecker.org">dnschecker.org</a> tests to ensure resolution against slack.com and it’s sub-delegated records resolved as expected after applying the zone changes.</li>
<li>We created several hand-crafted <a href="https://en.wikipedia.org/wiki/Dig_(command)">dig</a> tests using multiple resolvers.</li>
</ul>
<p>Prior to enabling DNSSEC for slack.com, we rolled out DNSSEC to all other Slack public domains successfully, with no internal or customer impact. The incident on September 30th 2021 was the third unsuccessful attempt to enable DNSSEC on slack.com.</p>
<p><img loading="lazy" width="2968" height="2588" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png 2968w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?resize=640,558 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?resize=768,670 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?resize=1280,1116 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?resize=1536,1339 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?resize=2048,1786 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-Copy-of-dnssec-rollout-timeline-1.png?resize=1920,1674 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/></p>
<h2>Unsuccessful attempt one 😟</h2>
<p>On September 7th, 2021, we enabled DNSSEC signing on slack.com. However, prior to publishing the DS record at our <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">DNS registrar</a>, a large <a href="https://en.wikipedia.org/wiki/Internet_service_provider">ISP</a> in the US had an outage and many of our customers reported being unable to access Slack as a result. Early in that incident — before we were aware of the ISP issue — the <a href="https://slack.com">slack.com</a> zone changes were rolled back as a precaution.</p>
<h2>Unsuccessful attempt two 😢</h2>
<p>On September 8th, 2021, we enabled DNSSEC signing on slack.com following the same procedure as on our previous attempt. Prior to publishing the DS record at the DNS registrar, our Customer Experience team noticed a small number of users reporting DNS resolution problems. Most of the affected users were accessing Slack through a VPN provider.</p>
<p>It turned out that some resolvers become more strict when DNSSEC signing is enabled at the authoritative name servers, <i>even while signing was not enabled at the root name servers (i.e. before DS records were published to COM nameservers).</i> This strict DNS spec enforcement will reject a <a href="https://en.wikipedia.org/wiki/CNAME_record">CNAME record</a> at the apex of a zone (as per <a href="https://www.rfc-editor.org/rfc/rfc1912#section-2.4">RFC-2181</a>), including the APEX of a sub-delegated subdomain. This was the reason that customers using VPN providers were disproportionately affected — many VPN providers use resolvers with this behavior.</p>
<p>We stopped signing the slack.com zone in Route53 and NS1. Shortly afterwards, this fixed the DNS resolution issues for users that had reported problems. After this attempt, our sub-delegated zones were updated to <a href="https://help.ns1.com/hc/en-us/articles/360017511293-What-is-the-difference-between-CNAME-and-ALIAS-records-">ALIAS records</a>.</p>
<h2>Unsuccessful attempt three 😭</h2>
<p>On September 30th 2021 and after careful planning, the Traffic Engineering team made their third attempt to enable DNSSEC signing on slack.com. We started by enabling DNSSEC signing on all NS1 <a href="https://slack.com">slack.com</a> sub-delegated zones and the Route53 authoritative zone for <a href="https://slack.com">slack.com</a>, which also provisioned the necessary DS records from the delegated zones to maintain chain of trust between Authoritative and delegated zones.</p>
<p>Immediately after, we followed all the validation steps listed above to ensure that slack.com was still resolving correctly.</p>
<p><img loading="lazy" width="3075" height="2436" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png 3075w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?resize=640,507 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?resize=768,608 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?resize=1280,1014 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?resize=1536,1217 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?resize=2048,1622 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-1.png?resize=1920,1521 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>State of slack.com DNS when DNSSEC signing was enabled at slack.com zone, but not yet published DS record at .com zone.</i></p>
<p>After a three hour ‘soak time’ and successful validations, we were confident to publish the slack.com <a href="https://www.cloudflare.com/en-gb/learning/dns/dns-records/dnskey-ds-records/">DS record</a> at the DNS registrar, which instructed DNSSEC validating resolvers to start validating DNS requests for slack.com (unless the <a href="https://datatracker.ietf.org/doc/html/rfc4035#section-3.2.2">cd flag</a> is specified).</p>
<p>After publishing the DS record at the DNS registrar, we ran the same validation steps again and confirmed everything was working as intended. Our DNS resolution monitoring that enforced DNSSEC checking corroborated a successful rollout.</p>
<p><img loading="lazy" width="3638" height="2481" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png 3638w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?resize=640,436 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?resize=768,524 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?resize=1280,873 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?resize=1536,1048 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?resize=2048,1397 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-2.png?resize=1920,1309 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>State of slack.com DNS chain after DNSSEC was fully enabled.</i></p>
<p>Our DNSSEC probes went green after publishing the DS record at the DNS registrar as well. Success!<img loading="lazy" width="1118" height="1042" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.32.10.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.32.10.png 1118w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.32.10.png?resize=640,596 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.32.10.png?resize=768,716 768w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/></p>
<p>Soon afterwards, Customer Experience started getting reports from users seeing “ERR_NAME_NOT_RESOLVED” errors in Slack clients. Slack applications are based on Chromium and integrate a way to export a <a href="https://www.chromium.org/developers/design-documents/network-stack/netlog">NetLog</a> capture, which is incredibly helpful when debugging network problems and analyzing performance. NetLogs are extensively used by Customer Experience and Engineering at Slack.</p>
<p>‘ERR_NAME_NOT_RESOLVED’ type errors can have multiple causes. In this specific case, it was caused by <a href="https://datatracker.ietf.org/doc/html/rfc2308#section-2.2">NODATA</a> DNS responses from some DNS recursive resolvers. Our engineering teams started to investigate.</p>
<p>During our initial investigation we saw most reports were from a private (corporate) DNS recursive resolver and Google’s Public Resolver (8.8.8.8). This was surprising, as impact to Google DNS <i>should</i> mean a much larger impact than our monitoring and customer reports indicated.</p>
<p>At this point we decided to pull the DS record from the DNS registrar, effectively removing the slack.com DS record at the ‘.com.’ zone to ‘stop the bleeding’, and later focus on the ‘NODATA’ DNS responses reported by customers.<img loading="lazy" width="3068" height="2436" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png 3068w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?resize=640,508 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?resize=768,610 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?resize=1280,1016 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?resize=1536,1220 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?resize=2048,1626 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4.png?resize=1920,1524 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>State of Slack.com DNS after removing the slack.com DS record from the .com zone</i></p>
<p>After nearly an hour, there were no signs of improvement and error rates remained stable, trending neither upwards nor downwards.</p>
<p>Our Traffic team was confident that reverting the DS record published in MarkMonitor was sufficient to eventually resolve DNS resolution problems. As things were not getting any better, and given the severity of the incident, we decided to rollback DNSSEC signing in our slack.com authoritative and delegated zones, wanting to recover our DNS configuration to the last previous healthy state, allowing us to completely rule out DNSSEC as a problem.</p>
<p><img loading="lazy" width="3068" height="2436" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png 3068w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?resize=640,508 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?resize=768,610 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?resize=1280,1016 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?resize=1536,1220 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?resize=2048,1626 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-5.png?resize=1920,1524 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>State of slack.com DNS after un-signing DNSSEC at slack.com zone</i></p>
<p>As soon as the rollback was pushed out things got much worse; our Traffic team was paged due to DNS resolution issues for slack.com from multiple resolvers across the world.</p>
<p><img loading="lazy" width="2028" height="1628" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png 2028w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png?resize=640,514 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png?resize=768,617 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png?resize=1280,1028 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png?resize=1536,1233 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.45.22.png?resize=1920,1541 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>Example DNS resolution alert for 9.9.9.9 DNS resolver received by our Traffic team after the rollback.</i></p>
<p>Based on expert advice, our understanding at the time was that DS records at the .com zone were never cached, so pulling it from the registrar would cause resolvers to immediately stop performing DNSSEC validation. This assumption turned out to be untrue. The ‘.com.’ zone will ask resolvers to cache the slack.com DS record for 24h by default (non modifiable by zone owners). Luckily, some resolvers cap that TTL with a lower value (i.e. Google’s 8.8.8.8 has a 6h TTL on DS records).</p>
<p><img loading="lazy" width="2888" height="2325" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png 2888w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?resize=640,515 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?resize=768,618 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?resize=1280,1030 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?resize=1536,1237 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?resize=2048,1649 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS-expectation.png?resize=1920,1546 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>How we thought recursive resolvers would behave after disabling DNSSEC signing in slack.com zone</i></p>
<p>The team knew removing the DNSKEY from the authoritative zone is a high-risk operation unless the DS record is not published anymore. However, the assumption of no cached DS records at the ‘.com.’ zone made us believe we were in the same state as in the previous two rollbacks, and that the result would be the same. However, unlike with our previous attempt, this time resolvers had cached DS records with up to 24 TTL remaining.</p>
<p><img loading="lazy" width="2888" height="2325" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png 2888w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?resize=640,515 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?resize=768,618 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?resize=1280,1030 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?resize=1536,1237 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?resize=2048,1649 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-slackcom-dnssec-step-4TTLS.png?resize=1920,1546 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>How recursive resolvers actually behaved: they had cached the slack.com DS record for 24h. DNSSEC validations started to fail after disabling signing on slack.com zone.</i></p>
<p>All our DNS configuration is managed in <a href="https://www.terraform.io/">Terraform</a>. Terraform is great for managing infrastructure as code, but in this case it made us miss a <b>critical</b> warning when trying to disable DNSSEC signing in Route53:</p>
<p><img loading="lazy" width="1682" height="1484" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.54.01.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.54.01.png 1682w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.54.01.png?resize=640,565 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.54.01.png?resize=768,678 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.54.01.png?resize=1280,1129 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.54.01.png?resize=1536,1355 1536w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>Disable DNSSEC warning window in Route53 Console.</i></p>
<p>Once the rollback was complete, all DNSSEC validating resolvers that had recently cached the DS record for slack.com started returning a <a href="https://bluecatnetworks.com/blog/the-top-four-dns-response-codes-and-what-they-mean/">SERVFAIL</a> on all slack.com lookups. We were immediately alerted by our external monitoring on DNS/DNSSEC resolution probes.</p>
<p>Our team quickly started contacting major ISPs and operators that run public DNS resolvers, with the request to flush all cached records for slack.com. Additionally, we flushed caches for resolvers that offer a public site (i.e. <a href="https://developers.google.com/speed/public-dns/cache">Google’s 8.8.8.8</a> and <a href="https://1.1.1.1/purge-cache/">Cloudflare’s 1.1.1.1</a>).</p>
<p>As resolvers flushed their caches, we slowly saw signs of improvement on our internal monitoring. Slack clients send telemetry to slackb.com and thanks to this isolation, we were still able to receive client metrics that helped us quantify the impact of this outage. Ironically, slackb.com had DNSSEC enabled successfully prior to this incident.</p>
<p>Throughout the incident, we considered re-signing DNSSEC on the slack.com zone (without publishing the DS at the DNS registrar). Restoring the DNSKEY would slightly improve the situation for some users, but it would not have solved the issue with all users that were initially getting ‘NODATA’ on their responses after DNSSEC signing was enabled. With hindsight this might have been better, but at this point we still did not understand the root cause of the original ‘NODATA’ responses.</p>
<p>For us to restore signing, we would have had to recover some keys which had been deleted when we rolled back the changes to the slack.com zone. In Route53 the <a href="https://www.cloudflare.com/en-gb/dns/dnssec/how-dnssec-works/">DNSSEC KSK (Key Signing Key)</a> is managed via an <a href="https://aws.amazon.com/kms/">AWS KMS key</a>. The KMS key was recoverable as per our configuration and the KSK was going to be the same, but we were uncertain if the ZSK (Zone Signing Key) would have been the same or different, as the ZSK is fully managed by AWS and we have no visibility into it. After the incident, Amazon’s Route53 team confirmed that the ZSK would have been different. When re-enabling signing on a zone, the ZSK will be generated with a new key pair. The Route53 team intends to design a mechanism for customers to quickly recover from this situation in the future.</p>
<p>At this point, some hours into the incident, we were in a situation where Slack was resolving correctly for the vast majority of customers, but a long tail of users of smaller DNS resolvers — which had not flushed the slack.com records — were still impacted.</p>
<p>We decided not to restore signing due to a lack of confidence. At the time, our understanding was that the DS record TTL might have been set by the slack.com zone in Route53, so a failed attempt to re-enable signing on the zone would ‘reset the clock’ on the DS record TTL, so we would have to request flushing of the slack.com DNS records for a second time and prolong the impact of the incident.</p>
<p>We know now signing a zone has no impact on the DS record TTL as it comes from the .com zone directly. Re-enabling signing would have had no impact as the ZSK would be different, so all DNSSEC validating resolvers would have continued failing to validate. So this action would have neither made things better nor made them worse.</p>
<p>As public resolver caches were flushed and as the 24h TTL on the DS record at the ‘.com’ zone expired, the error rates went back to normal.</p>
<h2>Solving the mystery 🕵️</h2>
<p>Once impact to Slack customers was mitigated, we aimed to determine the root cause of this outage. Prior to attempting DNSSEC on slack.com, our team had successfully enabled DNSSEC on all other Slack public domains. So how was slack.com different? Why had we not seen issues with any of the previous domains? Why did it only impact <i>some </i>corporate internal DNS resolvers and <i>some </i>of Google’s Public DNS lookups, but not all?</p>
<p>To understand what had happened, we replicated the rollout steps using a test zone setup identical to slack.com and used a resolver that we knew had problems during the rollout. Surprisingly, all our attempts to reproduce the behavior were unsuccessful.</p>
<p>At this point we went back to the NetLogs that we had received from customers during the outage.</p>
<p>Side Note: How do we get access to NetLogs from our customers? These were voluntarily provided by some customers after they opened support cases during this incident, so a <b>huge thank you</b> to those of you that did that! It really helps us out when debugging incidents like this one.</p>
<p>This is where we found an extremely interesting clue: clients were able to resolve slack.com successfully but failed to resolve app.slack.com. Why?</p>
<p>The following screenshot shows an attempt to resolve the slack.com domain successfully at “At 12:32:59.120”: <img loading="lazy" width="1252" height="606" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.55.34.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.55.34.png 1252w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.55.34.png?resize=640,310 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.55.34.png?resize=768,372 768w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/></p>
<p>One microsecond later, app.slack.com fails to resolve with a ‘ERR_NAME_NOT_RESOLVED’ error:<img loading="lazy" width="1258" height="590" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.56.07.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.56.07.png 1258w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.56.07.png?resize=640,300 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/Screenshot-2021-11-05-at-11.56.07.png?resize=768,360 768w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/></p>
<p>This indicated there was likely a problem with the ‘*.slack.com’ wildcard record since we didn’t have a wildcard record in any of the other domains where we had rolled out DNSSEC on. Yes, it was an oversight that we did not test a domain with a wildcard record before attempting slack.com — learn from our mistakes!</p>
<p>We collected evidence and reached out to the Amazon Route 53 team, who jumped on a call with us to figure it out. After walking them through the evidence we had, they quickly correlated this behavior to an issue with <a href="https://en.wikipedia.org/wiki/Domain_Name_System_Security_Extensions#Authenticating_NXDOMAIN_responses_and_NSEC">NSEC responses</a> that Route 53 generated on wildcard records. Aha! 💡</p>
<p>When a request is made to a DNSSEC-enabled domain for a wildcard record which type does not exist, the answer is a signed NSEC record confirming that while the domain name exists, the requested type does not. This signed NSEC response can include some additional information (<a href="https://datatracker.ietf.org/doc/html/rfc7129#section-5.3">specifically designed to keep wildcard records from breaking, among other things</a>), but Route53 was not returning this additional information.</p>
<p>What this means is that a request for a record at the same level, say an <a href="https://en.wikipedia.org/wiki/List_of_DNS_record_types">AAAA lookup</a> for <a href="http://app.slack.com/">app.slack.com</a> would correctly return a signed NSEC saying “there is no record for that”. This is correct since we don’t publish any AAAA records. The expected client behaviour is to fall back to requesting an A record. BUT — since Route53 isn’t returning that extra information — some public resolvers (including Google Public DNS, 8.8.8.8) take that response to mean that <b>nothing</b> exists at that level so there’s no need to query for an A record.</p>
<p>This NSEC response is cached. This effectively meant that impacted DNS resolvers were unintentionally being “cache poisoned” (by clients innocently checking for the existence of AAAA records) when DNSSEC was enabled in a Route53 zone with a wildcard record. Luckily, this cache poisoning would only affect the regional cache. This meant that one regional cache backing a larger impacted resolver could be temporarily poisoned, and anyone else hitting that same cache would see the failure, but those hitting other regional caches on the same resolver would not.</p>
<p><img loading="lazy" width="3441" height="2554" src="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?w=688" alt="" srcset="https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png 3441w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?resize=640,475 640w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?resize=768,570 768w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?resize=1280,950 1280w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?resize=1536,1140 1536w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?resize=2048,1520 2048w, https://slack.engineering/wp-content/uploads/sites/7/2021/11/DNSSEC-blog-post-diagrams-cache-poisoning-example.png?resize=1920,1425 1920w" sizes="(max-width: 959px) 688px, (max-width: 1023px) 768px, 1172px"/><i>Recursive resolvers caches are poisoned by incorrect NSEC response from Route53.</i></p>
<p>Interestingly, at this point we were able to reproduce this issue with our DNSSEC-enabled test zone against Google Public DNS (8.8.8.8) but <b>not</b> against Cloudflare Public DNS (1.1.1.1). A second mystery was whether or not one of these major public resolvers was out of spec. We investigated this and decided it is protocol compliant to reuse a cached NSEC record to decide a subsequent response. In fact, that’s what Aggressive NSEC (<a href="https://research.google/pubs/pub46737/">RFC 8198</a>) does, an optional spec, which Google implements. Some implementations only infer non-existence of “names” within the NSEC span. Some also do RR “type” inference from the NSEC-type bitmap. It seems that Google does both and perhaps Cloudflare does neither (or only the first). In the end we concluded that both options were “acceptable” and the only real way to avoid being in this ambiguous situation is for your Authoritative Nameserver to correctly return existing record types in the NSEC type bitmap (which was exactly what the AWS Route53 team was fixing).</p>
<p><i>Lookup of existing A wildcard record ‘*.slackexperts.com‘:</i></p>
<pre data-stringify-type="pre">dig A qqq.slackexperts.com @8.8.8.8 +dnssec

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; A qqq.slackexperts.com @8.8.8.8 +dnssec
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 48704
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 512
;; QUESTION SECTION:
;qqq.slackexperts.com.          IN      A

;; ANSWER SECTION:
qqq.slackexperts.com.   300     IN      A       54.211.89.16
qqq.slackexperts.com.   300     IN      RRSIG   A 13 3 300 20211105130720 20211105110220 28453 slackexperts.com. zksghNF9JTx4mRXjkoEGP6C5zCPb5JjX2MzeihENzx3JIjnZLZyokvdd /dnxcA5Qjl3sc3eC0bkryoGATb4ghw==

;; Query time: 66 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Wed Oct 13 15:40:32 EDT 2021
;; MSG SIZE  rcvd: 177</pre>
<p><i>Lookup of non existent AAAA wildcard record ‘*.slackexperts.com’ – no A specified in NSEC response:</i></p>
<pre data-stringify-type="pre">dig AAAA qqq.slackexperts.com @8.8.8.8 +dnssec

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; AAAA qqq.slackexperts.com @8.8.8.8 +dnssec
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 63101
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 4, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 512
;; QUESTION SECTION:
;qqq.slackexperts.com.          IN      AAAA

;; AUTHORITY SECTION:
slackexperts.com.       2370    IN      SOA     ns-869.awsdns-44.net. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86400
slackexperts.com.       2370    IN      RRSIG   SOA 13 2 900 20211013205618 20211013184118 30624 slackexperts.com. iBn8JmsuVq+F5zD+cm6C1Ypr25TtpKAIduCUZ80+sbuCbMQh0beC7RFc 2MctSnC9tf1RuCQHUxa/sEVVyHw6xQ==
qqq.slackexperts.com.   2370    IN      NSEC    \000.qqq.slackexperts.com. RRSIG NSEC
qqq.slackexperts.com.   2370    IN      RRSIG   NSEC 13 3 86400 20211014204118 20211013184118 30624 slackexperts.com. yB7d/Fl15M0z6zEHuE4XDvdxBT91DPiV38vhvI/42piqA1YI9ibb178E X0L82AaIaxcvSXKsdrWD8bAxJGVVyw==

;; Query time: 40 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Wed Oct 13 15:41:47 EDT 2021
;; MSG SIZE  rcvd: 398</pre>
<p><i>Lookup of existing A wildcard record after cache is poisoned (no ANSWER SECTION – It’s empty!):</i></p>
<pre data-stringify-type="pre">dig A qqq.slackexperts.com @8.8.8.8 +dnssec

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; A qqq.slackexperts.com @8.8.8.8 +dnssec
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 17738
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 4, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 512
;; QUESTION SECTION:
;qqq.slackexperts.com.          IN      A

;; AUTHORITY SECTION:
slackexperts.com.       2382    IN      SOA     ns-869.awsdns-44.net. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86400
slackexperts.com.       2382    IN      RRSIG   SOA 13 2 900 20211013205618 20211013184118 30624 slackexperts.com. iBn8JmsuVq+F5zD+cm6C1Ypr25TtpKAIduCUZ80+sbuCbMQh0beC7RFc 2MctSnC9tf1RuCQHUxa/sEVVyHw6xQ==
qqq.slackexperts.com.   2382    IN      NSEC    \000.qqq.slackexperts.com. RRSIG NSEC
qqq.slackexperts.com.   2382    IN      RRSIG   NSEC 13 3 86400 20211014204118 20211013184118 30624 slackexperts.com. yB7d/Fl15M0z6zEHuE4XDvdxBT91DPiV38vhvI/42piqA1YI9ibb178E X0L82AaIaxcvSXKsdrWD8bAxJGVVyw==

;; Query time: 10 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Wed Oct 13 15:42:12 EDT 2021
;; MSG SIZE  rcvd: 398</pre>
<p>Ta-da! 🎉</p>
<p>Our mystery was definitively solved. At the time of the writing of this blog post, the Route53 team has rolled out a fix to the NSEC-type bug described above.</p>
<p>We are very sorry for the impact this outage had on everyone who uses Slack and hope that this write-up will shed some light on some of the corner cases with DNSSEC (circa 2021). Maybe, just maybe, this will prevent someone else from having a similar issue.</p>
<h2>Acknowledgements 🙏</h2>
<p>We’d like to thank the Amazon Route 53 team for confirming the issue and for their rapid fix, Salesforce DNS team for their kindness, support, and DNSSEC expertise, and all of the DNS community for their invaluable help in rapidly flushing caches to bring Slack back to everyone affected by this problem. Last but not least, a huge thank you to our Customer Experience team, who are the ones on the front lines every day, connecting the dots between our customers and our engineering teams — we could not have done it without you! 🌟</p>
<p>1 <a href="https://csrc.nist.gov/projects/risk-management/sp800-53-controls/release-search#!/control">FedRAMP Moderate NIST 800-53 controls</a> (<a href="https://csrc.nist.gov/projects/risk-management/sp800-53-controls/release-search#!/control?version=5.1&amp;number=SC-20">SC-20</a>, <a href="https://csrc.nist.gov/projects/risk-management/sp800-53-controls/release-search#!/control?version=5.1&amp;number=SC-21">SC-21</a>)</p>
					</div><!-- .entry__content -->
				<!-- .entry__footer -->
			</article><!-- #post-14285 -->

		
		</main><!-- #primary -->

		
<!-- #secondary -->
	</div><!-- .container -->
</div></div>
  </body>
</html>
