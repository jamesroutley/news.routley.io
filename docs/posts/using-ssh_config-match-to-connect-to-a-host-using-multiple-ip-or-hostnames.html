<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://fmartingr.com/blog/2022/08/12/using-ssh-config-match-to-connect-to-a-host-using-multiple-ip-or-hostnames/">Original</a>
    <h1>Using SSH_config Match to connect to a host using multiple IP or Hostnames</h1>
    
    <div id="readability-page-1" class="page"><div>
      <header>
        <p><img src="https://fmartingr.com/static/images/avatar.jpg?h=f834fb12"/>
        </p>
        
        <nav>
          <a href="https://fmartingr.com/">/home</a>
          
            <a href="https://fmartingr.com/blog/">/blog</a>
          
            <a href="https://fmartingr.com/about/">/about</a>
          
        </nav>
      </header>
      <hr/>
      <section>
        
  
  
  <article>
    
    <p>
      Published on August 12, 2022
    </p>
    
      <div>
        
          <p>My main computer is a MacBook Pro from 2017, but I have some servers laying around and one other laptop connected at home
with ArchLinux installed that I use mainly for development. I connect to it remotely either directly using a
SSH/Mosh + Tmux + Emacs/Vim combination, or using the pretty convenient VSCode Remote Extensions when I&#39;m not feeling
much of a <em>hacker</em>.</p>
<p>Thing is, I may access this computer either from my home network directly if I&#39;m at home or via a SDN if I am not (at the office,
coffeeshop, visiting family, etc).</p>
<p>My approach was to setup the hosts directly on my <code>~/.ssh/ssh_config</code> as you would with different machines:</p>
<div><pre><span></span><span># .ssh/config</span>
Host laptop.lan
    HostName <span>192</span>.168.1.2 <span># Internal network IP</span>

Host laptop.sdn
    Hostname <span>10</span>.0.0.2 <span># SDN IP</span>
</pre></div>
<p>That way, I would connect to each one of them depending on the situation. Using tmux and ssh is not that much of a problem
since I could just detach from home, go away, then connect via SDN an everything would be there (though I had to remember
which alias to use instead of just <code>ssh laptop</code>). For VSCode is not that convenient since I would need to close the connection,
made a new one to the new host and so on. Surely we could made this simpler, right?</p>
<p>In my home network, my main router is also my DNS server (with Ad Blocking, rules and all kind of fancy things), and that
server resolves my local domain (<code>*.lan</code>) to LAN IP Addresses, so I can start with a simple config as I had previously:</p>
<div><pre><span></span><span># .ssh/config</span>
Host laptop
    HostName laptop.lan
</pre></div>
<p>Now, what happens if I&#39;m not at home? I could solve this in several ways:</p>
<ul>
<li>I could <code>ping</code> my router, but that could collide with other networks out there.</li>
<li>I could check if my Wifi BSSID is one of the APs at home, but I could also connect via Ethernet.</li>
<li>I could check if I can resolve the <code>laptop.lan</code> address, though this requires network access, but in the end is the one I ended
up using.</li>
</ul>
<div><pre><span></span>$ dig +short laptop.lan
<span>192</span>.168.1.2 <span># At home</span>

$ dig +short laptop.lan
<span># Empty result when away from home</span>
</pre></div>
<p>Now, here comes the <a href="https://man7.org/linux/man-pages/man5/ssh_config.5.html"><code>Match</code></a> magic:</p>
<div><pre><span></span><span># .ssh/config</span>
Host laptop
    HostName laptop.lan

Match originalhost laptop <span>exec</span> <span>&#34;[[ </span><span>$(</span>/usr/bin/dig +short laptop.lan<span>)</span><span> == &#39;&#39; ]]&#34;</span>
    HostName laptop.sdn
</pre></div>
<p>Using <code>Match</code> we can replace properties for a defined host using matches. In this ad-hoc example what I did is:</p>
<ul>
<li><code>Match originalhost laptop</code>: The connection host need to match <code>laptop</code></li>
<li><code>exec &#34;[[ $(/usr/bin/dig +short laptop.lan) == &#39;&#39; ]]&#34;</code>: Execute <code>dig</code> and try to resolve my LAN&#39;s laptop domain name.
This needs to be a successful command for it to match, in this case we compare <code>dig</code>s output to an empty string to evaluate
if we can resolve the <code>laptop.lan</code> domain name (check the <code>[[ ]]</code>).</li>
<li><code>HostName laptop.sdn</code> If both rules match, replace the <code>HostName</code> property with the laptop&#39;s SDN domain name.</li>
</ul>
<p>This is a pretty easy way to just <code>ssh laptop</code> wherever I am. I didn&#39;t knew about this particular
keyword until today, and it&#39;s pretty powerful!</p>
<p>Documentation: <a href="https://man7.org/linux/man-pages/man5/ssh_config.5.html">ssh_config(5) manpage</a></p>

        
      </div>
      
    
    <hr/>
  </article>

  <p>
    If you want to approach me directly about this post use the most appropriate channel 
    from <a href="https://fmartingr.com/about/">the about page</a>.
  </p>

      </section>
      <hr/>
      
    
  

  

</div></div>
  </body>
</html>
