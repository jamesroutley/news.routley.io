<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://h0x0er.github.io/blog/2025/06/29/ebpf-connecting-with-container-runtimes/">Original</a>
    <h1>eBPF: Connecting with Container Runtimes</h1>
    
    <div id="readability-page-1" class="page"><div data-md-component="main">
        <div>
          
            
              
                
              
              
            
            
              
                
              
              
            
          
          
  <div data-md-component="content">
    
    <article>
      
        
  





<h2 id="objective">Objective</h2>
<ul>
<li>to understand how connection with <code>Container Runtime (CR)</code> is being made using <code>Container Runtime Interface (CRI)</code> in different open-source eBPF-based projects.<ul>
<li>to query <code>pod or container info</code> for context enrichment.</li>
</ul>
</li>
</ul>
<!-- more -->

<hr/>
<h2 id="reasoning">Reasoning</h2>
<details>
<summary>Note</summary>
<p>Code snippets are take from open-source <a href="https://github.com/cilium/tetragon">tetragon</a>, <a href="https://github.com/aquasecurity/tracee">tracee</a> and <a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md">crictl</a> projects.</p>
</details>
<p>Connection with CR is important for making the tool/product kubernetes-aware. As it provides rich information that could be of interest for different use-cases.</p>
<p>Connection with CR involves following steps</p>
<ul>
<li>locate <code>unix-socket</code> file</li>
<li>make a grpc connection using <a href="https://github.com/kubernetes/cri-api/blob/v0.33.1/pkg/apis/runtime/v1/api.proto">CRI API</a></li>
<li>query the info</li>
</ul>
<h3 id="locate-unix-socket-file">Locate <code>unix-socket</code> file</h3>
<details>
<summary>Tip</summary>
<p>Make sure to mount host <code>/var</code> or <code>/run</code> in container.</p>
</details>
<p>Most of the times these are in a well-known location such as <code>/var/run</code> or <code>/run</code>. Checkout CR documentation for exact location.</p>
<p>In projects that I explored, well-known paths are hardcoded for flexibility. </p>
<p>During runtime, code iterate over these paths, tries to make a connection and returns the corresponding service, if it was success.</p>
<h4 id="tetragon">Tetragon</h4>
<p>Tetragon contains some hardcoded default sock-paths. <strong><a href="https://github.com/cilium/tetragon/blob/50a1d08e471d2fdbabff0416ba0c314769bb4c13/pkg/cri/cri.go#L22">[Source]</a></strong>
</p><div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span>    </span><span>defaultEndpoints</span><span> </span><span>=</span><span> </span><span>[]</span><span>string</span><span>{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span>        </span><span>&#34;unix:///run/containerd/containerd.sock&#34;</span><span>,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span>        </span><span>&#34;unix:///run/crio/crio.sock&#34;</span><span>,</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span>        </span><span>&#34;unix:///var/run/cri-dockerd.sock&#34;</span><span>,</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span>    </span><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="crictl">Crictl</h4>
<p><strong><a href="https://github.com/kubernetes-sigs/cri-tools/blob/0cf370b13928d79146916fd9accbbc69f64a92b5/cmd/crictl/main_unix.go#L31">Browse full source-code</a></strong></p>
<div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span>var</span><span> </span><span>defaultRuntimeEndpoints</span><span> </span><span>=</span><span> </span><span>[]</span><span>string</span><span>{</span><span>&#34;unix:///run/containerd/containerd.sock&#34;</span><span>,</span><span> </span><span>&#34;unix:///run/crio/crio.sock&#34;</span><span>,</span><span> </span><span>&#34;unix:///var/run/cri-dockerd.sock&#34;</span><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="tracee">Tracee</h4>
<p><strong><a href="https://github.com/aquasecurity/tracee/blob/a675202eeef1bcf2ce269cb7493f35d769dbe367/pkg/containers/runtime/sockets.go#L42C1-L63C2">Browse full source-code</a></strong></p>
<div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span>func</span><span> </span><span>Autodiscover</span><span>(</span><span>onRegisterFail</span><span> </span><span>func</span><span>(</span><span>err</span><span> </span><span>error</span><span>,</span><span> </span><span>runtime</span><span> </span><span>RuntimeId</span><span>,</span><span> </span><span>socket</span><span> </span><span>string</span><span>))</span><span> </span><span>Sockets</span><span> </span><span>{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span>    </span><span>register</span><span> </span><span>:=</span><span> </span><span>func</span><span>(</span><span>sockets</span><span> </span><span>*</span><span>Sockets</span><span>,</span><span> </span><span>runtime</span><span> </span><span>RuntimeId</span><span>,</span><span> </span><span>socket</span><span> </span><span>string</span><span>)</span><span> </span><span>{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span>        </span><span>err</span><span> </span><span>:=</span><span> </span><span>sockets</span><span>.</span><span>Register</span><span>(</span><span>runtime</span><span>,</span><span> </span><span>socket</span><span>)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span>        </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span>            </span><span>onRegisterFail</span><span>(</span><span>err</span><span>,</span><span> </span><span>runtime</span><span>,</span><span> </span><span>socket</span><span>)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span>        </span><span>}</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span>    </span><span>}</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span>    </span><span>sockets</span><span> </span><span>:=</span><span> </span><span>Sockets</span><span>{}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span>    </span><span>const</span><span> </span><span>(</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span>        </span><span>defaultContainerd</span><span> </span><span>=</span><span> </span><span>&#34;/var/run/containerd/containerd.sock&#34;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span>        </span><span>defaultDocker</span><span>     </span><span>=</span><span> </span><span>&#34;/var/run/docker.sock&#34;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span>        </span><span>defaultCrio</span><span>       </span><span>=</span><span> </span><span>&#34;/var/run/crio/crio.sock&#34;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span>        </span><span>defaultPodman</span><span>     </span><span>=</span><span> </span><span>&#34;/var/run/podman/podman.sock&#34;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span>    </span><span>)</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span>    </span><span>register</span><span>(</span><span>&amp;</span><span>sockets</span><span>,</span><span> </span><span>Containerd</span><span>,</span><span> </span><span>defaultContainerd</span><span>)</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span>    </span><span>register</span><span>(</span><span>&amp;</span><span>sockets</span><span>,</span><span> </span><span>Docker</span><span>,</span><span> </span><span>defaultDocker</span><span>)</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span>    </span><span>register</span><span>(</span><span>&amp;</span><span>sockets</span><span>,</span><span> </span><span>Crio</span><span>,</span><span> </span><span>defaultCrio</span><span>)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span>    </span><span>register</span><span>(</span><span>&amp;</span><span>sockets</span><span>,</span><span> </span><span>Podman</span><span>,</span><span> </span><span>defaultPodman</span><span>)</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span>    </span><span>return</span><span> </span><span>sockets</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="making-connection">Making connection</h3>
<h4 id="tetragon_1">Tetragon</h4>
<p><strong><a href="https://github.com/cilium/tetragon/blob/50a1d08e471d2fdbabff0416ba0c314769bb4c13/pkg/cri/cri.go#L1-L89">Browse full source-code</a></strong>
</p><div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span>// required modules</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span>import</span><span> </span><span>(</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span>    </span><span>&#34;google.golang.org/grpc&#34;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span>    </span><span>&#34;google.golang.org/grpc/credentials/insecure&#34;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span>     </span><span>criapi</span><span> </span><span>&#34;k8s.io/cri-api/pkg/apis/runtime/v1&#34;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span>)</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span>func</span><span> </span><span>newClientTry</span><span>(</span><span>ctx</span><span> </span><span>context</span><span>.</span><span>Context</span><span>,</span><span> </span><span>endpoint</span><span> </span><span>string</span><span>)</span><span> </span><span>(</span><span>criapi</span><span>.</span><span>RuntimeServiceClient</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span>    </span><span>u</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>url</span><span>.</span><span>Parse</span><span>(</span><span>endpoint</span><span>)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span>        </span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>err</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span>    </span><span>}</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span>    </span><span>if</span><span> </span><span>u</span><span>.</span><span>Scheme</span><span> </span><span>!=</span><span> </span><span>&#34;unix&#34;</span><span> </span><span>{</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span>        </span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>errNotUnix</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span>    </span><span>}</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span>    </span><span>conn</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>grpc</span><span>.</span><span>NewClient</span><span>(</span><span>endpoint</span><span>,</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span>        </span><span>grpc</span><span>.</span><span>WithTransportCredentials</span><span>(</span><span>insecure</span><span>.</span><span>NewCredentials</span><span>()),</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span>    </span><span>)</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span>        </span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>err</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span>    </span><span>}</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span>    </span><span>rtcli</span><span> </span><span>:=</span><span> </span><span>criapi</span><span>.</span><span>NewRuntimeServiceClient</span><span>(</span><span>conn</span><span>)</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span>    </span><span>if</span><span> </span><span>_</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>rtcli</span><span>.</span><span>Version</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>&amp;</span><span>criapi</span><span>.</span><span>VersionRequest</span><span>{});</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span>        </span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>fmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;validate CRI v1 runtime API for endpoint %q: %w&#34;</span><span>,</span><span> </span><span>endpoint</span><span>,</span><span> </span><span>err</span><span>)</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a><span>    </span><span>}</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span>    </span><span>return</span><span> </span><span>rtcli</span><span>,</span><span> </span><span>nil</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="crictl_1">Crictl</h4>
<p><strong><a href="https://github.com/kubernetes-sigs/cri-tools/blob/0cf370b13928d79146916fd9accbbc69f64a92b5/cmd/crictl/main.go#L73">Browse full source-code</a></strong></p>
<div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span>// required modules</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span>import</span><span>(</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span>  </span><span>...</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span>  </span><span>internalapi</span><span> </span><span>&#34;k8s.io/cri-api/pkg/apis&#34;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span>  </span><span>remote</span><span> </span><span>&#34;k8s.io/cri-client/pkg&#34;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span>  </span><span>...</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span>)</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span>...</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span>for</span><span> </span><span>_</span><span>,</span><span> </span><span>endPoint</span><span> </span><span>:=</span><span> </span><span>range</span><span> </span><span>defaultRuntimeEndpoints</span><span> </span><span>{</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span>    </span><span>logrus</span><span>.</span><span>Debugf</span><span>(</span><span>&#34;Connect using endpoint %q with %q timeout&#34;</span><span>,</span><span> </span><span>endPoint</span><span>,</span><span> </span><span>t</span><span>)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span>    </span><span>res</span><span>,</span><span> </span><span>err</span><span> </span><span>=</span><span> </span><span>remote</span><span>.</span><span>NewRemoteRuntimeService</span><span>(</span><span>endPoint</span><span>,</span><span> </span><span>t</span><span>,</span><span> </span><span>tp</span><span>,</span><span> </span><span>&amp;</span><span>logger</span><span>)</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span>        </span><span>logrus</span><span>.</span><span>Error</span><span>(</span><span>err</span><span>)</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span>        </span><span>continue</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span>    </span><span>}</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span>    </span><span>logrus</span><span>.</span><span>Debugf</span><span>(</span><span>&#34;Connected successfully using endpoint: %s&#34;</span><span>,</span><span> </span><span>endPoint</span><span>)</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span>    </span><span>break</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span>}</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span>...</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="tracee_1">Tracee</h4>
<p><strong><a href="https://github.com/aquasecurity/tracee/blob/a675202eeef1bcf2ce269cb7493f35d769dbe367/pkg/containers/runtime/containerd.go#L26C1-L51C2">Browse full source-code</a></strong></p>
<div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span>func</span><span> </span><span>ContainerdEnricher</span><span>(</span><span>socket</span><span> </span><span>string</span><span>)</span><span> </span><span>(</span><span>ContainerEnricher</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span>    </span><span>enricher</span><span> </span><span>:=</span><span> </span><span>containerdEnricher</span><span>{}</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span>    </span><span>// avoid duplicate unix:// prefix</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span>    </span><span>unixSocket</span><span> </span><span>:=</span><span> </span><span>&#34;unix://&#34;</span><span> </span><span>+</span><span> </span><span>strings</span><span>.</span><span>TrimPrefix</span><span>(</span><span>socket</span><span>,</span><span> </span><span>&#34;unix://&#34;</span><span>)</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span>    </span><span>client</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>containerd</span><span>.</span><span>New</span><span>(</span><span>socket</span><span>)</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span>        </span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>errfmt</span><span>.</span><span>WrapError</span><span>(</span><span>err</span><span>)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span>    </span><span>}</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span>    </span><span>conn</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>grpc</span><span>.</span><span>NewClient</span><span>(</span><span>unixSocket</span><span>,</span><span> </span><span>grpc</span><span>.</span><span>WithTransportCredentials</span><span>(</span><span>insecure</span><span>.</span><span>NewCredentials</span><span>()))</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span>        </span><span>if</span><span> </span><span>errC</span><span> </span><span>:=</span><span> </span><span>client</span><span>.</span><span>Close</span><span>();</span><span> </span><span>errC</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span>            </span><span>logger</span><span>.</span><span>Errorw</span><span>(</span><span>&#34;Closing containerd connection&#34;</span><span>,</span><span> </span><span>&#34;error&#34;</span><span>,</span><span> </span><span>errC</span><span>)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span>        </span><span>}</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span>        </span><span>return</span><span> </span><span>nil</span><span>,</span><span> </span><span>errfmt</span><span>.</span><span>WrapError</span><span>(</span><span>err</span><span>)</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span>    </span><span>}</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span>    </span><span>enricher</span><span>.</span><span>images_cri</span><span> </span><span>=</span><span> </span><span>cri</span><span>.</span><span>NewImageServiceClient</span><span>(</span><span>conn</span><span>)</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span>    </span><span>enricher</span><span>.</span><span>containers</span><span> </span><span>=</span><span> </span><span>client</span><span>.</span><span>ContainerService</span><span>()</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span>    </span><span>enricher</span><span>.</span><span>namespaces</span><span> </span><span>=</span><span> </span><span>client</span><span>.</span><span>NamespaceService</span><span>()</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span>    </span><span>enricher</span><span>.</span><span>images</span><span> </span><span>=</span><span> </span><span>client</span><span>.</span><span>ImageService</span><span>()</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span>    </span><span>return</span><span> </span><span>&amp;</span><span>enricher</span><span>,</span><span> </span><span>nil</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="query-the-info">Query the info</h3>
<h4 id="tetragon_2">Tetragon</h4>
<p>Querying cgroup-path of a container. <strong><a href="https://github.com/cilium/tetragon/blob/50a1d08e471d2fdbabff0416ba0c314769bb4c13/pkg/cri/container.go#L85-L114">[Source]</a></strong></p>
<div><table><tbody><tr><td></td><td><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span>func</span><span> </span><span>CgroupPath</span><span>(</span><span>ctx</span><span> </span><span>context</span><span>.</span><span>Context</span><span>,</span><span> </span><span>cli</span><span> </span><span>criapi</span><span>.</span><span>RuntimeServiceClient</span><span>,</span><span> </span><span>containerID</span><span> </span><span>string</span><span>)</span><span> </span><span>(</span><span>string</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span>  </span><span>// creating a request </span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span>    </span><span>req</span><span> </span><span>:=</span><span> </span><span>criapi</span><span>.</span><span>ContainerStatusRequest</span><span>{</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span>        </span><span>ContainerId</span><span>:</span><span> </span><span>containerID</span><span>,</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span>        </span><span>Verbose</span><span>:</span><span>     </span><span>true</span><span>,</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span>    </span><span>}</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span>  </span><span>// making grpc call</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span>    </span><span>res</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>cli</span><span>.</span><span>ContainerStatus</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>&amp;</span><span>req</span><span>)</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span>        </span><span>return</span><span> </span><span>&#34;&#34;</span><span>,</span><span> </span><span>err</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span>    </span><span>}</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span>  </span><span>// taking the info</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span>    </span><span>info</span><span> </span><span>:=</span><span> </span><span>res</span><span>.</span><span>GetInfo</span><span>()</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span>    </span><span>if</span><span> </span><span>info</span><span> </span><span>==</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span>        </span><span>return</span><span> </span><span>&#34;&#34;</span><span>,</span><span> </span><span>errors</span><span>.</span><span>New</span><span>(</span><span>&#34;no container info&#34;</span><span>)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span>    </span><span>}</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span>  </span><span>// extracting the relevant info</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span>    </span><span>var</span><span> </span><span>path</span><span>,</span><span> </span><span>json</span><span> </span><span>string</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span>    </span><span>if</span><span> </span><span>infoJson</span><span>,</span><span> </span><span>ok</span><span> </span><span>:=</span><span> </span><span>info</span><span>[</span><span>&#34;info&#34;</span><span>];</span><span> </span><span>ok</span><span> </span><span>{</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span>        </span><span>json</span><span> </span><span>=</span><span> </span><span>infoJson</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span>        </span><span>path</span><span> </span><span>=</span><span> </span><span>&#34;runtimeSpec.linux.cgroupsPath&#34;</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span>    </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span>        </span><span>return</span><span> </span><span>&#34;&#34;</span><span>,</span><span> </span><span>errors</span><span>.</span><span>New</span><span>(</span><span>&#34;could not find info&#34;</span><span>)</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span>    </span><span>}</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span>    </span><span>ret</span><span> </span><span>:=</span><span> </span><span>gjson</span><span>.</span><span>Get</span><span>(</span><span>json</span><span>,</span><span> </span><span>path</span><span>).</span><span>String</span><span>()</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span>    </span><span>if</span><span> </span><span>ret</span><span> </span><span>==</span><span> </span><span>&#34;&#34;</span><span> </span><span>{</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span>        </span><span>return</span><span> </span><span>&#34;&#34;</span><span>,</span><span> </span><span>errors</span><span>.</span><span>New</span><span>(</span><span>&#34;failed to find cgroupsPath in json&#34;</span><span>)</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span>    </span><span>}</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span>    </span><span>return</span><span> </span><span>ParseCgroupsPath</span><span>(</span><span>ret</span><span>)</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<hr/>
<h4 id="tracee_2">Tracee</h4>
<p><strong><a href="https://github.com/aquasecurity/tracee/blob/a675202eeef1bcf2ce269cb7493f35d769dbe367/pkg/containers/runtime/containerd.go#L53-L107">Browse full source-code</a></strong></p>
<div><table><tbody><tr><th colspan="2"><span>tracee-snippet.go</span></th></tr><tr><td><div><pre><span></span><span><a href="#__codelineno-7-1"> 1</a></span>
<span><a href="#__codelineno-7-2"> 2</a></span>
<span><a href="#__codelineno-7-3"> 3</a></span>
<span><a href="#__codelineno-7-4"> 4</a></span>
<span><a href="#__codelineno-7-5"> 5</a></span>
<span><a href="#__codelineno-7-6"> 6</a></span>
<span><a href="#__codelineno-7-7"> 7</a></span>
<span><a href="#__codelineno-7-8"> 8</a></span>
<span><a href="#__codelineno-7-9"> 9</a></span>
<span><a href="#__codelineno-7-10">10</a></span>
<span><a href="#__codelineno-7-11">11</a></span>
<span><a href="#__codelineno-7-12">12</a></span>
<span><a href="#__codelineno-7-13">13</a></span>
<span><a href="#__codelineno-7-14">14</a></span>
<span><a href="#__codelineno-7-15">15</a></span>
<span><a href="#__codelineno-7-16">16</a></span>
<span><a href="#__codelineno-7-17">17</a></span>
<span><a href="#__codelineno-7-18">18</a></span>
<span><a href="#__codelineno-7-19">19</a></span>
<span><a href="#__codelineno-7-20">20</a></span>
<span><a href="#__codelineno-7-21">21</a></span>
<span><a href="#__codelineno-7-22">22</a></span>
<span><a href="#__codelineno-7-23">23</a></span>
<span><a href="#__codelineno-7-24">24</a></span>
<span><a href="#__codelineno-7-25">25</a></span>
<span><a href="#__codelineno-7-26">26</a></span>
<span><a href="#__codelineno-7-27">27</a></span>
<span><a href="#__codelineno-7-28">28</a></span>
<span><a href="#__codelineno-7-29">29</a></span>
<span><a href="#__codelineno-7-30">30</a></span>
<span><a href="#__codelineno-7-31">31</a></span>
<span><a href="#__codelineno-7-32">32</a></span>
<span><a href="#__codelineno-7-33">33</a></span>
<span><a href="#__codelineno-7-34">34</a></span>
<span><a href="#__codelineno-7-35">35</a></span>
<span><a href="#__codelineno-7-36">36</a></span>
<span><a href="#__codelineno-7-37">37</a></span></pre></div></td><td><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span>func</span><span> </span><span>(</span><span>e</span><span> </span><span>*</span><span>containerdEnricher</span><span>)</span><span> </span><span>Get</span><span>(</span><span>ctx</span><span> </span><span>context</span><span>.</span><span>Context</span><span>,</span><span> </span><span>containerId</span><span> </span><span>string</span><span>)</span><span> </span><span>(</span><span>EnrichResult</span><span>,</span><span> </span><span>error</span><span>)</span><span> </span><span>{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span>    </span><span>res</span><span> </span><span>:=</span><span> </span><span>EnrichResult</span><span>{}</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span>    </span><span>nsList</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>e</span><span>.</span><span>namespaces</span><span>.</span><span>List</span><span>(</span><span>ctx</span><span>)</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span>    </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span>        </span><span>return</span><span> </span><span>res</span><span>,</span><span> </span><span>errfmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;failed to fetch namespaces %s&#34;</span><span>,</span><span> </span><span>err</span><span>.</span><span>Error</span><span>())</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span>    </span><span>}</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span>    </span><span>for</span><span> </span><span>_</span><span>,</span><span> </span><span>namespace</span><span> </span><span>:=</span><span> </span><span>range</span><span> </span><span>nsList</span><span> </span><span>{</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span>        </span><span>// always query with namespace applied</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span>        </span><span>nsCtx</span><span> </span><span>:=</span><span> </span><span>namespaces</span><span>.</span><span>WithNamespace</span><span>(</span><span>ctx</span><span>,</span><span> </span><span>namespace</span><span>)</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span>        </span><span>// if containers is not in current namespace, search the next one</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span>        </span><span>container</span><span>,</span><span> </span><span>err</span><span> </span><span>:=</span><span> </span><span>e</span><span>.</span><span>containers</span><span>.</span><span>Get</span><span>(</span><span>nsCtx</span><span>,</span><span> </span><span>containerId</span><span>)</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span>        </span><span>if</span><span> </span><span>err</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span>            </span><span>continue</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span>        </span><span>}</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span>    </span><span>...</span><span>.</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span>        </span><span>// if in k8s we can extract pod info from labels</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span>        </span><span>if</span><span> </span><span>container</span><span>.</span><span>Labels</span><span> </span><span>!=</span><span> </span><span>nil</span><span> </span><span>{</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span>            </span><span>labels</span><span> </span><span>:=</span><span> </span><span>container</span><span>.</span><span>Labels</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span>            </span><span>res</span><span>.</span><span>PodName</span><span> </span><span>=</span><span> </span><span>labels</span><span>[</span><span>PodNameLabel</span><span>]</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span>            </span><span>res</span><span>.</span><span>Namespace</span><span> </span><span>=</span><span> </span><span>labels</span><span>[</span><span>PodNamespaceLabel</span><span>]</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span>            </span><span>res</span><span>.</span><span>UID</span><span> </span><span>=</span><span> </span><span>labels</span><span>[</span><span>PodUIDLabel</span><span>]</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span>            </span><span>res</span><span>.</span><span>Sandbox</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>isSandbox</span><span>(</span><span>labels</span><span>)</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span>            </span><span>// containerd containers normally have no names unless set from k8s</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span>            </span><span>res</span><span>.</span><span>ContName</span><span> </span><span>=</span><span> </span><span>labels</span><span>[</span><span>ContainerNameLabel</span><span>]</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a><span>        </span><span>}</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a><span>        </span><span>res</span><span>.</span><span>Image</span><span> </span><span>=</span><span> </span><span>imageName</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a><span>        </span><span>res</span><span>.</span><span>ImageDigest</span><span> </span><span>=</span><span> </span><span>imageDigest</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span>        </span><span>return</span><span> </span><span>res</span><span>,</span><span> </span><span>nil</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a><span>    </span><span>}</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a><span>    </span><span>return</span><span> </span><span>res</span><span>,</span><span> </span><span>errfmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;failed to find container %s in any namespace&#34;</span><span>,</span><span> </span><span>containerId</span><span>)</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a><span>}</span>
</span></code></pre></div></td></tr></tbody></table></div>
<hr/>
<h2 id="refer">Refer</h2>
<ul>
<li><a href="https://github.com/cilium/tetragon/blob/main/pkg/cri/cri.go">https://github.com/cilium/tetragon/blob/main/pkg/cri/cri.go</a></li>
<li><a href="https://github.com/cilium/tetragon/tree/main/pkg/cri">https://github.com/cilium/tetragon/tree/main/pkg/cri</a></li>
<li><a href="https://github.com/kubernetes-sigs/cri-tools/blob/0cf370b13928d79146916fd9accbbc69f64a92b5/cmd/crictl/main.go#L73">https://github.com/kubernetes-sigs/cri-tools/blob/0cf370b13928d79146916fd9accbbc69f64a92b5/cmd/crictl/main.go#L73</a></li>
<li><a href="https://github.com/aquasecurity/tracee/tree/main/pkg/containers/runtime">https://github.com/aquasecurity/tracee/tree/main/pkg/containers/runtime</a></li>
</ul>







  
  



  


  



      
    </article>
  </div>

          

        </div>
        
          
        
      </div></div>
  </body>
</html>
