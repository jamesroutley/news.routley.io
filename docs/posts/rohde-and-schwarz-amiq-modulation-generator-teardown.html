<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://tomverbeure.github.io/2025/04/26/RS-AMIQ-Teardown-Analog-Deep-Dive.html">Original</a>
    <h1>Rohde and Schwarz AMIQ Modulation Generator Teardown</h1>
    
    <div id="readability-page-1" class="page"><div aria-label="Content">
      <div>
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#the-rohde--schwarz-amiq-modulation-generator" id="markdown-toc-the-rohde--schwarz-amiq-modulation-generator">The Rohde &amp; Schwarz AMIQ Modulation Generator</a></li>
  <li><a href="#winiqsim-software" id="markdown-toc-winiqsim-software">WinIQSim Software</a></li>
  <li><a href="#inside-the-amiq" id="markdown-toc-inside-the-amiq">Inside the AMIQ</a></li>
  <li><a href="#the-signal-generation-pcb" id="markdown-toc-the-signal-generation-pcb">The Signal Generation PCB</a></li>
  <li><a href="#analog-signal-generation-architecture-fixed-vs-variable-dac-clock" id="markdown-toc-analog-signal-generation-architecture-fixed-vs-variable-dac-clock">Analog Signal Generation Architecture: Fixed vs Variable DAC Clock</a></li>
  <li><a href="#internal-reference-clock-generation" id="markdown-toc-internal-reference-clock-generation">Internal Reference Clock Generation</a></li>
  <li><a href="#dac-clock-synthesizer" id="markdown-toc-dac-clock-synthesizer">DAC Clock Synthesizer</a></li>
  <li><a href="#iq-output-skew-tuning" id="markdown-toc-iq-output-skew-tuning">I/Q Output Skew Tuning</a></li>
  <li><a href="#variable-gain-amplifier" id="markdown-toc-variable-gain-amplifier">Variable Gain Amplifier</a></li>
  <li><a href="#internal-diagnostics" id="markdown-toc-internal-diagnostics">Internal Diagnostics</a></li>
  <li><a href="#efficient-distribution-of-configuration-signals" id="markdown-toc-efficient-distribution-of-configuration-signals">Efficient Distribution of Configuration Signals</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
  <li><a href="#references" id="markdown-toc-references">References</a></li>
</ul>



<p>Every few months, a local company auctions off all kinds of lab, production and test equipment. 
I shouldn’t be subscribed to their email list but I am, and that’s one way I end up with more
stuff that I don’t really need.</p>

<p>During a recent auction, I got my hands on a Rohde &amp; Schwarz AMIQ, an I/Q modulation
generator, for a grand total of $45. Add to that another 30% for the auction fee and taxes and
you’re still paying much less than what others would pay for a round of golf? But instead of 
one morning of fun, this thing has the potential to keep me busy for many weekends, so what a deal!</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/amiq_frontside.jpg"><img src="https://tomverbeure.github.io/assets/amiq/amiq_frontside.jpg" alt="AMIQ frontside view"/></a>
<em>(Click to enlarge)</em></p>

<p>A few days after “winning” the auction, I drove to a dark dungeon of a warehouse in San Jose
to pick up the loot.</p>

<p>The AMIQ has a power on/off button and 3 LEDs and that’s in terms of user interface.
There are no dials, there’s no display. So without any other options, I simply powered it up
and I was immediately greeted by the ominous clicking of a hard drive. I was right: 
this thing would keep me entertained for at least a little bit!</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/amiq_backside.jpg"><img src="https://tomverbeure.github.io/assets/amiq/amiq_backside.jpg" alt="AMIQ backside view"/></a>
<em>(Click to enlarge)</em></p>

<p>It took a significant amount of effort to restore the machine back to its working state. I’ll
write about that in future blog posts, but let’s start with an overview of the functionality
and a teardown of the R&amp;S AMIQ and then deep dive into some of its analog circuits.</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/amiq_const_diagram.jpg" alt="Oscilloscope showing a constellation diagram generated by an AMIQ"/></p>

<p><em>AMIQ prices on eBay vary wildly, from $129 to $2600 at the time of writing this. Even if you
get one of the higher priced ones, you should expect to get a unit that’s close to failing due to
leaking capacitors and a flaky harddrive!</em></p>



<p>Reduced to an elevator sales pitch, the AMIQ is <em>a 2-channel arbitrary waveform generator (AWG) 
with a deep sample buffer</em>. That’s it!</p>

<p>It has a streaming buffer that feeds samples to 2 14-bit DACs at a sample rate of up to 105MHz. 
Two output channels I and Q will typically contain quadrature modulation signals that are sent 
to an RF vector signal generator such as a Rohde &amp; Schwarz SMIQ for the actual high-frequency 
modulation. In a typical setup, the AMIQ is used to generate the baseband modulated signal and 
the SMIQ shifts the baseband signal to an RF frequency.</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/amiq_smiq_setup.png" alt="WinIQSIM - AMIQ - SMIQ setup"/></p>

<p>Since the AMIQ has no user interface, the waveform data must provided by an external
device. This could be a PC that runs R&amp;S WinIQSim software or even the SMIQ itself because it has 
the ability to control an AMIQ. You can also create your own waveforms and upload them via floppy disk, 
GPIB or an RS-232 interface using 
<a href="https://tomverbeure.github.io/2020/06/07/Making-Sense-of-Test-and-Measurement-Protocols.html#scpi---the-universal-command-language">SCPI control commands</a>.</p>

<p>Figure 4-1 of the <a href="https://tomverbeure.github.io/assets/amiq/docs/AMIQ_OperatingManual_en_08.pdf">AMIQ Operating Manual</a> has a
simplified block diagram. It is pretty straightforward and somewhat similar to the one of my
<a href="https://tomverbeure.github.io/2023/01/02/HP33120A-Repair-Shutting-Down-the-Eye-of-Sauron.html#a-walk-through-the-block-diagram">HP 33120A function generator</a>:</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/amiq_block_diagram.png"><img src="https://tomverbeure.github.io/assets/amiq/amiq_block_diagram.png" alt="AMIQ block diagram"/></a>
<em>(Click to enlarge)</em></p>

<p>On the left are 2 blocks that are shared:</p>

<ul>
  <li>a clock synthesizer</li>
  <li>waveform memory</li>
</ul>

<p>And then for each channel:</p>

<ul>
  <li>14-bit D/A converter</li>
  <li>analog filters</li>
  <li>output section with amplifier/attenuator</li>
  <li>differential analog output driver (AMIQ-B2 option)</li>
</ul>

<p>The major blocks are surrounded by a large amount of DACs that are used to control everything from
the tuning input of local 10MHz clock oscillator, gain and offset of output signals, clock skew 
between I and Q signal and much more.</p>

<p>You could do some of this with a modern SDR setup, but the specifications of the AMIQ units
are dialed up a notch. Both channels are completely symmetrical to avoid modulation errors at the
source. If there’s a need to compensate for small delay differences in, for example, the external 
cables, you can compensate for that by changing the skew between clocks of the output DACs with a 
precision of 10ps. Similarly, the DAC sample frequency can be programmed with 32-bit precision.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/backside_connectors.jpg"><img src="https://tomverbeure.github.io/assets/amiq/backside_connectors.jpg" alt="Backside speciality connectors"/></a>
<em>(Click to enlarge)</em></p>

<p>In addition to the main I/Q outputs at the front, there are a bunch of secondary input and output signals:</p>

<ul>
  <li>10MHz reference input and output</li>
  <li>sample clock</li>
  <li>trigger input</li>
  <li>marker output</li>
  <li>external filter loopback output and input</li>
  <li>bit error rate measurement (BER) connector (AMIQ-B1 option)</li>
  <li>parallel interface with the digital value of the samples that are sent to the DAC (front panel, AMIQ-B3 option)</li>
</ul>

<p><a href="https://tomverbeure.github.io/assets/amiq/backside_pc_connectors.jpg"><img src="https://tomverbeure.github.io/assets/amiq/backside_pc_connectors.jpg" alt="Backside PC connectors"/></a>
<em>(Click to enlarge)</em></p>

<p>Above those speciality inputs and outputs are the obligatory GPIB interface and a bunch of generic connectors 
that look suspiciously like the ones you’d find on an early century PC:</p>

<ul>
  <li>PS/2 keyboard and mouse</li>
  <li>Parallel port</li>
  <li>RS232</li>
  <li>USB</li>
</ul>

<p>There are 3 different AMIQ versions:</p>

<ul>
  <li>1110.2003.02: 4M samples</li>
  <li>1110.2003.03: 4M samples</li>
  <li>1110.2003.04: 16M samples</li>
</ul>

<p>Mine is an AMIQ-04.</p>



<p>While it is possible to control the AMIQ over RS-232 or GPIB with your own software, you’d have
a hard time matching the features of WinIQSim, a R&amp;S Windows application that supports the AMIQ.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/AMIQ_Main_Multi_Carrier_window.png"><img src="https://tomverbeure.github.io/assets/amiq/AMIQ_Main_Multi_Carrier_window.png" alt="WinIQSim Main Multi-Carrier window"/></a>
<em>(Click to enlarge)</em></p>

<p>With WinIQSim, you can select one of the popular communication protocols from the late nineties and
early 2000s, fill in digital framing data, apply all kinds of distortions and interferences, 
compute the I and Q waveforms and send it to the AMIQ.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/AMIQ_Graphics_window.png"><img src="https://tomverbeure.github.io/assets/amiq/AMIQ_Graphics_window.png" alt="WinIQSim FFT Magnitude plot window"/></a></p>

<p>Some of the supported formats include CDMA2000, 802.11a WLAN, TD-SCDMA and more. But you don’t have 
to use these official protocols, WinIQSim supports any kind of FSK, QPSK, QAM or other common modulation 
method.</p>

<p>You need a license for some of the communication protocols. The license is linked to the AMIQ device,
not the PC, but the license check is pretty naive, and while I haven’t tried it… yet, the EEVblog forum 
has discussions about how to enable features yourself. My device only came with a license for IS-95 CDMA.</p>



<p>It’s trivial to open up an AMIQ: after removing the 4 feet in the back with a regular
Philips screwdriver, you can simply slide off the outer case.</p>

<p>It has 2 major subsystems:</p>

<ul>
  <li>
    <p>the top contains all the components of a standard PC</p>

    <p><a href="https://tomverbeure.github.io/assets/amiq/amiq_pc_motherboard_side.jpg"><img src="https://tomverbeure.github.io/assets/amiq/amiq_pc_motherboard_side.jpg" alt="AMIQ top inside view - PC motherboard"/></a>
<em>(Click to enlarge)</em></p>
  </li>
  <li>
    <p>the bottom has a signal generation PCB</p>

    <p><a href="https://tomverbeure.github.io/assets/amiq/amiq_siggen_side.jpg"><img src="https://tomverbeure.github.io/assets/amiq/amiq_siggen_side.jpg" alt="AMIQ signal generation side"/></a>
<em>(Click to enlarge)</em></p>

    <p>The PCB looks incredibly clean and well laid out and I love how they printed the names of different
sections on the metal gray shielding plates.</p>
  </li>
</ul>

<p>We’ll leave the PC system for a future blog post, and focus on the signal generation PCB.</p>



<p>Let’s remove the shielding plates to see what’s underneath. I had to drill out one of the screws that attach
the plates because the head was stripped. (Did somebody before me already try to repair it?)</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/amiq_siggen_uncovered.jpg"><img src="https://tomverbeure.github.io/assets/amiq/amiq_siggen_uncovered.jpg" alt="AMIQ signal generation board"/></a>
<em>(Click to enlarge)</em></p>

<p>The bottom half left and right sections are perfectly symmetrical, as one would expect for a device that has the
ability to tune skew mismatches with a 10 ps precision.</p>

<p>Annotated, it looks like this:</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/amiq_siggen_annotated.jpg"><img src="https://tomverbeure.github.io/assets/amiq/amiq_siggen_annotated.jpg" alt="AMIQ signal generation annotated"/></a>
<em>(Click to enlarge)</em></p>

<p>Rohde &amp; Schwarz recently made the terrible decision to lock all their software and manuals behind an approval-only 
corporate log-in wall, but luckily some of the most important AMIQ assets can be found online elsewhere, including 
the operating manual and a service manual contains the full schematics!</p>

<p>Let’s dig a bit deeper into the various aspects of the design.</p>

<p><em>In what follows I’ll be focusing primarily on analog aspects of the design. This is a very personal
choice: not that the digital sections aren’t important, it’s just that, as digital design engineer,
they’re not particular interesting to me. By studying the analog sections, I hope to stumble into
circuits that I didn’t really know a lot about before.</em></p>

<p><strong>Fantastic Schematics</strong></p>

<p>Before digging in for real, a word about the schematics: they are fantastic.</p>

<p>Each sub-system has a block diagram that is already pretty detailed, with signal names
that match the schematics and test points, often with annotations to indicate the voltage or
frequency range. Here’s the block diagram of the reference and DAC clock generation section, for
example.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/block_diagram.png"><img src="https://tomverbeure.github.io/assets/amiq/block_diagram.png" alt="Block diagram example"/></a></p>
<center>Schematic page 5 <i>(Click to enlarge)</i></center>


<p>Signals that come from or go to other pages are fully referenced. Look at the <code>SYN_OUT_CLK</code> signal below:</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/schematic_signal_references.png"><img src="https://tomverbeure.github.io/assets/amiq/schematic_signal_references.png" alt="Schematic signal references"/></a></p>
<center>Schematic page 10 <i>(Click to enlarge)</i></center>


<p>The signal is also used on page 6, coordinate 1D and 7B and page 22, coordinate 8A. How cool is that?</p>

<p><strong>Signal path test points</strong></p>

<p>One of the awesome features of the PCB is the generous amount of test points. We’re not
just talking PCB test point against which you can hold your oscilloscope probe or even header
pins, though there are plenty of those too, but full on SMB connectors.</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/amiq_test_connectors.jpg" alt="AMIQ test connectors"/></p>

<p>In addition to these SMD connectors, there are also plenty of jumpers that can be used to interrupt
the default signal flow and insert your own test signal instead.</p>



<p>In the HP 33120A the DAC has a fixed 40 MHz clock. There’s a 16 kB waveform RAM that contains, say, one quarter
period of a 100 Hz sine. If you want to send out a sine wave of 200 Hz, instead of sequentially stepping through
all the addresses of the waveform RAM, you just skip every other address. One of the benefits of this kind
of generation scheme is that you can make do with a fixed frequency analog anti-aliasing filter: the Nyquist frequency
is always the same after all.</p>

<p>A major disadvantage, however, is that even if the output signal has a bandwidth of only 1MHz, you still need to 
feed the DAC at the fixed clock rate. You could insert a digital upsampling filter between the waveform memory and 
the DAC, but that requires significant mathematical DSP fire power, or you’d have to increase the depth of the
waveform memory.</p>

<p>For an arbitrary waveform generator, it makes more sense to run the DAC at whichever clock speed is
sufficient to meet the Nyquist requirement of the desired signal and provide a number of different filtering options. 
The AMIQ has 4 such options: no filter, a 25 MHz, a 2.5 MHz or a loopback through an external filter.</p>

<p>The DAC sample clock range is huge, from 10 Hz all the way to 105 MHz, though specifications are only guaranteed up 
to 100 MHz. According to the data sheet, the clock frequency can be set with a precision of 10^-7.</p>



<p>Like all professional test and measurement equipment, the AMIQ uses a 10MHz reference clock that
can come from outside or that can be generated locally with a 10MHz crystal. It’s common for high-end equipment
to have an oven controlled crystal oscillator (OCXO), but AMIQ has a lower spec’ed temperature controlled one (TCXO), 
a <a href="https://tomverbeure.github.io/assets/amiq/milliren_txco_400_series.jpg">Milliren Technologies 453-0210</a>.</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/ref_clock_generation_pcb.jpg" alt="Reference clock generation PCB"/></p>

<p>If we look at the larger reference clock generation block diagram, we can see something slightly unusual: instead
of selecting between the internal TCXO output or the external reference clock input, the internal reference
clock always comes from the TCXO (green).</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/reference_clock_diagram.png"><img src="https://tomverbeure.github.io/assets/amiq/reference_clock_diagram.png" alt="Reference clock block diagram"/></a></p>
<center>Schematic page 5 <i>(Click to enlarge)</i></center>


<p>When the internal clock is selected, the TCXO output frequency can be tuned with an analog signal that comes from
the <code>VTXCO TUNE</code> DAC (blue), but when the external reference input is active, the TCXO is phase locked to the
external clock. You can see the phase comparator and low pass filter in red.</p>

<p>The reason for using a PLL with the internal TCXO as the voltage controlled oscillator is probably to ensure
that the generated reference clock has the phase noise of the TCXO while tracking the frequency of the
external reference clock: a PLL acts as a low-pass filter to the reference clock and as a high-pass filter
to the VCO. If the TCXO has a better high frequency phase noise than the external reference clock, that makes 
sense. 
<em>This is really out of my wheelhouse, so take all of this with a grain of salt…</em></p>

<p><code>SYN_REF</code> is the output of the internal reference clock generation unit.</p>



<p>The clock synthesizer creates a highly programmable DAC clock from the internal reference clock <code>SYN_REF</code> from
previous section. It should come as no surprise that this clock is generated by a PLL as well.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/clock_synthesizer.png"><img src="https://tomverbeure.github.io/assets/amiq/clock_synthesizer.png" alt="Clock synthesizer block diagram"/></a></p>
<center>Schematic page 5 <i>(Click to enlarge)</i></center>


<p>There are two speciality components in the clock generation path:</p>

<ul>
  <li>a <a href="https://tomverbeure.github.io/assets/amiq/docs/JTOS-200.pdf">Mini-Circuits JTOS-200 VCO</a></li>
  <li>an Analog Devices <a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ad9850.pdf">AD9850 DDS Synthesizer</a></li>
</ul>

<p><a href="https://tomverbeure.github.io/assets/amiq/clock_synthesizer_pcb.jpg"><img src="https://tomverbeure.github.io/assets/amiq/clock_synthesizer_pcb.jpg" alt="Clock synthesizer PCB"/></a>
<em>(Click to enlarge)</em></p>

<p>The VCO has an operating frequency between 100 and 200 MHz. I don’t know enough about VCOs to give meaningful
commentary about the specifications, but based on comparisons with similar components on Digikey, such
as this <a href="https://www.digikey.com/en/products/detail/fairview-microwave/FMVC11009/22222673">FMVC11009</a>, 
it’s safe to assume that it’s an expensive and high quality component.</p>

<p>The AD9850 is located in the feedback path of the PLL where it acts as a feedback divider with a 
precision of 32 bits.</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/ad9850_block_diagram.png" alt="AD9850 block diagram"/></p>

<p>The signal flow inside the AD9850 is interesting:</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/ad9850_signal_flow.png" alt="AD9850 signal flow"/></p>

<p>It works as follows:</p>

<ul>
  <li>each clock cycle, the phase of a <a href="https://en.wikipedia.org/wiki/Numerically_controlled_oscillator">numerical controlled oscillator (NCO)</a>
accumulates with the programmable 32-bit increment.</li>
  <li>the upper bits of the phase accumulator serve as the address of a sine waveform table.</li>
  <li>a 10-bit DAC converts the digital sine wave to analog.</li>
  <li>the analog signal is sent through an external low-pass filter.</li>
  <li>the output of the low-pass filter goes back into the AD9850 and through a comparator to generate a digital output clock.</li>
</ul>

<p>This thing has its own programmable signal generator! But why the roundtrip from
digital to analog back to digital? In theory, the MSB of the NCO could be used as output clock
of the clock generator.</p>

<p>The problem is that in such a configuration, the length of each clock period toggles between
N and N+1 clock cycles, with a ratio so that the average clock period ends up with the desired value.
But this creates major spurs in the frequency spectrum of the generated clock.</p>

<p>When fed into the phase comparator of a PLL, these frequency spurs can show up as jitter at the 
output of the PLL and thus into the spectrum of the generated I and Q signals.</p>

<p>By converting the signal to analog and using a low pass filter, the spurs can be filtered
away. The combination of a low pass filter and a comparator acts as an interpolator: the edges of
the generated clock fall somewhere in between N and N+1.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/dds_oscillator.png"><img src="https://tomverbeure.github.io/assets/amiq/dds_oscillator.png" alt="DDS oscillator schematic"/></a></p>
<center>Schematic page 21 <i>(Click to enlarge)</i></center>


<p>The steepness of the low pass filter depends on the ratio between the input and the output clock: 
the lower the ratio, the steeper the filter. There are a bunch of binary clock dividers that make it 
hard to know the exact ratio, but if the output of the VCO is 100 MHz and the input 10 MHz or less, 
there is a 10:1 ratio. The AMIQ has a 7th order elliptical low pass filter.</p>

<p>I ran a quick simulation in LTspice to check the behavior. 
(<a href="https://tomverbeure.github.io/assets/amiq/ltspice/dds_filter.asc"><code>dds_filter.asc</code></a> source file.)</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/filter_spice_schematic.png" alt="Filter schematic in LTspice"/></p>

<p>The filter has a cut-off frequency of around 13 MHz:</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/filter_spice_frequency_plot.png"><img src="https://tomverbeure.github.io/assets/amiq/filter_spice_frequency_plot.png" alt="Filter frequency plot in LTspice"/></a></p>

<p>In modern fractional PLLs, instead of using a regular DAC, one could use a high-order sigma-delta 
unit to create a pulse density modulated output with the noise pushed to higher frequencies and
a low pass filter that can be less aggressive.</p>

<p>There’s a plenty of literature online about DDS clock generators, some of which I’ve listed in 
the references at the bottom, but the 
<a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ad9850.pdf">datasheet of the AD9850</a>
itself is a good start.</p>



<p>Earlier I mentioned the ability to tune the skew between the I and the Q output to
compensate for a difference in cable length when connecting the AMIQ to an RF signal
generator.</p>

<p>While the digital waveform fetching circuit works on one clock, the two clocks that
go to the DAC are the ones that can be changed:</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/clock_skew_tuning-amiq_system_diagram.svg" alt="DAC system diagram"/></p>

<p>Here’s what the skewing circuit looks like:</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/skew_adj_schematic.png"><img src="https://tomverbeure.github.io/assets/amiq/skew_adj_schematic.png" alt="Skew adjust schematic"/></a></p>
<center>Schematic page 10 <i>(Click to enlarge)</i></center>


<p>Starting with input signal <code>DAC_CLK</code>, the goal is to create <code>I_DAC_CLK</code> and <code>Q_DAC_CLK</code> that 
can be moved up to 1ns ahead or behind the other. Signals can be delayed by sending them through 
an R/C combo. Since we need a variable delay, we need a way to change the value of either the R 
or the C.  A varactor or varicap diode is exactly that kind of device: its capacitance changes 
depending on the reverse bias voltage across the diode.</p>

<p>Static input signal <code>SKEW_TUNE</code> comes from a DAC. It goes to the cathode of one varicap and the
anode of the other. When its voltage increase, the capacitance of those 2 diodes moves in opposite
ways, and so does the R/C delay along the I and Q clock path.
A <a href="https://www.rf-microwave.com/en/philips/bb147/varicap-diode-30v-20ma-2-4-112pf-sod-323/bb147/">BB147 varicap</a>
has a capacitance that varies between 2pF and 112pF depending on the bias voltage.</p>

<p>Capacitances C168 and C619 prevent the relatively high bias voltages from reaching the digital
signal path.</p>

<p>Does the circuit work? Absolutely!</p>

<p>The scope photos below show the impact of the skewing circuit when dialed to the maximum in both
directions:</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/skew_purple_vs_yellow.jpg" alt="Oscilloscope pictures of skewed purple and yellow signals"/></p>

<p>With a 2ns/div horizontal scale, you can see a skew of ~1ns either way.</p>



<p>The analog signal path starts at the DAC and then goes through the anti-aliasing filters, 
an output section that does amplification and attenuation, and finally the output connector
board.</p>

<p>It is common for signal generators to have a fixed gain amplification section and then some selectable
fixed attenuation stages: amplifiers with a variable gain and low distortion are hard to design. 
If you need a signal amplitude that can’t be achieved with one of the fixed attenuation
settings, one solution is to multiply the signal before it enters the DAC to reduce the output amplitude,
though that’s at the expense of losing some of the dynamic range of the DAC.</p>

<p>This is not the case for the AMIQ: while it can use a signal path that only uses fixed amplification and attenuation
stages, it also offers the intriguing option to send the analog signal through an analog multiplier stage:</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/variable_gain_unit.png" alt="Variable gain amplifier"/></p>

<p>If we zoom down from the system diagram to the block diagram, we can see how the multiplier/variable
attenuator sits between the filter and the output amplifier, with 2 control input signals: 
<code>AMPL_CNTRL</code> and <code>OFFSET</code>. This circuit exists twice, of course, for the I and the Q channel.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/output_path_block_diagram.png"><img src="https://tomverbeure.github.io/assets/amiq/output_path_block_diagram.png" alt="Output path block diagram"/></a></p>
<center>Schematic page 3 <i>(Click to enlarge)</i></center>


<p>Let’s check out the details!</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/ad835_pcb.jpg" alt="ADC835 PCB"/></p>

<p>The heavy lifting of the variable gain amplifier is performed by an Analog Devices
<a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ad835.pdf">AD835 <em>250 MHz, Voltage Output, 4-Quadrant Multiplier</em></a>,
a part from their <a href="https://www.analog.com/en/product-category/analog-multipliers-dividers.html"><em>Analog Multipliers &amp; Dividers</em> catalog</a>.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/variable_gain_amplifier.png"><img src="https://tomverbeure.github.io/assets/amiq/variable_gain_amplifier.png" alt="Variable gain amplifier"/></a></p>
<center>Schematic page 14 <i>(Click to enlarge)</i></center>


<p>It’s a tiny 8-pin device that calculates <code>W = (X1-X2) * (Y1-Y2) + Z</code>. In low volume, it will set you back $32 on Digikey.
In addition to the multiplication, you can set a fixed output gain by feeding back output W through a resistive
divider back into Z. For inputs less than 10 MHz, it has a typical harmonic distortion of -70dB.</p>

<p><img src="https://tomverbeure.github.io/assets/amiq/ad835_block_diagram.png" alt="AD835 functional block diagram"/></p>

<p>Analog Devices datasheets usually have a <em>Theory of Operation</em> section that explain, well, the
underlying theory of operation. The AD835 has such a section as well, but it doesn’t go any further
than stating that</p>

<blockquote>
  <p>the multiplier is based on a classic form, having a translinear core, supported by 
three (X, Y, and Z) linearized voltage-to-current converters, and the load driving 
output amplifier.</p>
</blockquote>

<p>I have no clue how the thing works!</p>

<p>In the case of the AMIQ, X2 and Y2 are strapped to ground, and there’s no feedback from
W back into Z either which reduces the functionality to: <code>W = FILTER_OUT * AMPL_VAR + OFFSET</code>.
<code>AMPL_VAR</code> and <code>OFFSET</code> are static analog values that are each created by a 12-bit DAC8143,
just like many other analog configuration signals.</p>

<p>It’s almost shame that this powerful little device is asked to perform such a basic operation.</p>

<p>While researching the AD835, somebody pointed out the 
<a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ad8310.pdf">AD8310</a>, 
another interesting speciality chip from Analog Devices. It’s a <em>DC to 440 MHz, 95dB logarithmic
amplifier</em>, a converter from linear to logarithmic scale basically.</p>

<p>Discovering little gems like this is why I love studying schematics of complex devices.</p>



<p>The AMIQ has a set of 15 internal analog signal to monitor the health of the device. Various
meaningful signals are gathered all around the signal generation board and measured at power 
up to give you that dreaded <em>Diagnostic Check Fail</em> message.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/diagnostics_adc.jpg"><img src="https://tomverbeure.github.io/assets/amiq/diagnostics_adc.jpg" alt="Diagnostic circuit schematic"/></a></p>
<center>Schematic page 27 <i>(Click to enlarge)</i></center>


<p>The circuit itself is straightforward: 2 8-to-1 analog multiplexers feed into a
<a href="https://mm.digikey.com/Volume0/opasdata/d220001/medias/docus/1/CS5505-8.pdf">CS5507AS 16-bit AD converter</a>.
It can only do 100 samples per second, but that’s sufficient to measure a bunch of mostly
static signals.</p>

<p>Like many other devices, the measured value is sent serially to one of the FPGAs.</p>

<p>The ADC needs a 2.5V reference voltage. It’s funny that this reference voltage also goes 
to the analog multiplexers as one one of the diagnostic signals. One wonders what the ADC returns
as a result when it tries to convert the output of a broken reference voltage generator.</p>

<p>There are a bunch of circuits in the AMIQ whose only purpose is generating diagnostic
signals. Here’s a good example of that:</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/diagnostics_peak_recorder.png"><img src="https://tomverbeure.github.io/assets/amiq/diagnostics_peak_recorder.png" alt="Diagnostics peak and phase detection circuits"/></a></p>
<center>Schematic page 14 <i>(Click to enlarge)</i></center>


<p><code>I_OUT_DIAG</code> and <code>Q_OUT_DIAG</code> are the outputs after the attenuator that will eventually end
up at the connectors. The circuit in the top red square is a signal peak detector, similar
to what you’d find in the rectifier of a power supply. It allows the AMIQ to track the output
level of signals with a frequency that is way higher than the sample rate of the ADC.</p>

<p>The circuit in the red rectangle below performs a digital XOR on the analog I and the Q
signals and then sends it through a simple R/C low pass filter. I think that it allows the
AMIQ to check that the phase difference between the I and Q channel is sensible when applying
a test signal during power-on self-test.</p>



<p>The AMIQ signal board has hundreds of configuration bits: there are the obvious enable/disable or selection bits,
such as those to select between different output filters, but the lion’s share are used to set the output value
of many 12-bit DACs.</p>

<p>Instead of using parallel busses that fan out from an FPGA, the AMIQ has a serial configuration scan chain.
Discrete 8-bit <a href="https://assets.nexperia.com/documents/data-sheet/74HC_HCT4094.pdf">74HCT4094 shift-and-store registers</a> 
are located all over the design for the digital configuration bits. 
The <a href="https://www.analog.com/media/en/technical-documentation/data-sheets/DAC8143.pdf">DAC8134 devices</a> 
have their own built-in shift register and are part of the same scan chain.</p>

<p><a href="https://tomverbeure.github.io/assets/amiq/config_scan_chain.png"><img src="https://tomverbeure.github.io/assets/amiq/config_scan_chain.png" alt="Configuration scan chain"/></a></p>
<center>Schematic page 19 <i>(Click to enlarge)</i></center>


<p>The schematic above is an example of that. The red scan chain data input goes through the <code>VTCXO_TUNE</code> DAC, then 
the 74HCT4094 after which it exist to some other page of the schematics.</p>



<p>Around the late nineties, test equipment companies started to stop adding schematics to their service manuals,
but the R&amp;S AMIQ is a nice exception to that. And while the device already has a bunch of FPGAs, most of the components
are off-the-shelf single-function components. Thanks to that, the AMIQ is an excellent candidate for a deep
dive: all the information is there, you need to just spend a bit of effort to go through things. I had a 
ton of fun figuring out how things worked.</p>



<p><strong>Rohde &amp; Schwarz documents</strong></p>

<ul>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/AMIQ_overview.PDF">R&amp;S - IQ Modulation Generator AMIQ</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/Rohde-Schwarz-AMIQ04-Datasheet.pdf">R&amp;S - AMIQ Datasheet</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/AMIQ_OperatingManual_en_08.pdf">R&amp;S - AMIQ Operating Manual</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/Rohde_Schwarz_AMIQ_Service_Manual_with_schematics.pdf">R&amp;S - AMIQ Service Manual with schematic</a></li>
</ul>

<p><strong>Various application notes</strong></p>

<ul>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/amiq_floppy_disc_control.pdf">R&amp;S - Floppy Disk Control of the I/Q Modulation Generator AMIQ</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/Software%20Manual%20WinIQSIM%20-%20ES%20Documentation.pdf">R&amp;S - Software WinIQSIM for Calculating I/Q Signals for Modulation Generator R&amp;S AMIQ</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/R&amp;S%20-%20Creating%20Test%20Signals%20for%20Bluetooth%20with%20AMIQ.pdf">R&amp;S - Creating Test Signals for Bluetooth with AMIQ / WinIQSIM and SMIQ</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/R&amp;S%20-%20WCDMA%20Signal%20Generator%20Solutions.pdf">R&amp;S - WCDMA Signal Generator Solutions</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/R&amp;S%20Golden%20devices%20-%20ideal%20path%20or%20detour.pdf">R&amp;S - Golden devices: ideal path or detour?</a></li>
  <li><a href="https://tomverbeure.github.io/assets/amiq/docs/R&amp;S%20-%20Demonstration%20of%20BER%20Test%20with%20AMIQ%20controlled%20by%20WinIQSIM.pdf">R&amp;S - Demonstration of BER Test with AMIQ controlled by WinIQSIM</a></li>
</ul>

<p><strong>Other AMIQ content on the web</strong></p>

<ul>
  <li><a href="https://zw-ix.nl/blog/2021/02/09/getting-an-rohde-schwarz-amiq-up-and-running/">zw-ix has a blog - Getting an Rohde Schwarz AMIQ up and running</a></li>
  <li><a href="https://zw-ix.nl/blog/2021/02/09/494/">zw-ix has a blog - Connecting a Rohde Schwarz AMIQ to a SMIQ04</a></li>
  <li><a href="https://x.com/BoscoMac/status/1860000781128380629">Bosco tweets</a></li>
</ul>

<p><strong>DDS Clock Synthesis</strong></p>

<ul>
  <li><a href="https://www.analog.com/media/en/training-seminars/tutorials/MT-085.pdf">MT-085 Tutorial: Fundamentals of Direct Digital Synthesis (DDS)</a></li>
  <li><a href="https://www.analog.com/media/en/technical-documentation/app-notes/an-1396.pdf">How to Predict the Frequency and Magnitude of the Primary Phase Truncation Spur in the Output Spectrum of a Direct Digital Synthesizer (DDS)</a></li>
</ul>

<p><strong>Related content</strong></p>

<ul>
  <li><a href="https://www.youtube.com/watch?v=6aRZGOcdGUE">The Signal Path - Teardown, Repair &amp; Analysis of a Rohde &amp; Schwarz AFQ100A I/Q (ARB) Modulation Generator</a></li>
</ul>


  </div>
</article>

      </div>
    </div></div>
  </body>
</html>
