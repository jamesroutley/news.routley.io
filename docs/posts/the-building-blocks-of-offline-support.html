<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://pketh.org/building-offline.html">Original</a>
    <h1>The building blocks of offline support</h1>
    
    <div id="readability-page-1" class="page"><div>
    <p>The latest release of Kinopio lets you work offline while in a subway, plane, or uncharted rainforest. When you come back online, your changes will be synced back up. And because the app no longer needs to wait for a network before loading, it starts up a lot faster too.</p>


<figure>
  <figcaption>
    üõ´ Editing the Kinopio roadmap in airplane mode
  </figcaption>
</figure>

<p>Full offline support was the byproduct of building for speed and immediacy. From a multi-storage loading process, to a queue system to save grouped changes, and a UI status system to inform and reassure users ‚Äì many separate systems come together to enable an experience that responds fast and works everywhere.</p>

<blockquote>
  <p>
    <img src="http://pketh.org/images/2020/porco-rosso-engine.jpg"/>
    If you&#39;re curious, the overall architecture of Kinopio is described in
    <a href="http://pketh.org/how-kinopio-is-made.html">How Kinopio is Made</a>
  </p>
</blockquote>



<p>While running Kinopio, if you peek inside the <code>Storage</code> tab in your web inspector, you‚Äôll see that each of your spaces is locally cached under a <code>space-ID</code> key with a stringified JSON value containing cards and other attributes that gets updated as you work.</p>

<p>This local-first approach is what enables new users to immediately start using the app without an account ‚Äì because the best way to learn how to use Kinopio is by using Kinopio.</p>

<p>The <code>kinopio-server</code> enables editing your spaces on other devices, sharing public spaces, and real-time collaboration. In scenarios like these, the remote data on the server acts as the source of truth. But reading/writing remote data from servers is much slower than cached local data.</p>

<p>When loading a space, we can use both local and remote data together to get the best of both worlds, local speed and remote truth. The process goes something like this:</p>



<p>A helpful side-effect of this loading system is that when you‚Äôre offline, you‚Äôll still be able to open your cached local spaces.</p>



<p>In most apps there‚Äôs a 1:1 relationship between user actions and server routes. In a social media app when I write something and hit the <code>Post</code> button, my post is then saved to a server so that others can read it.</p>

<p>But in the case of Kinopio, items like cards and boxes which need to show updates in real-time as you interact with them, this means a new update on each keystroke when you type in them, and on each rendering frame while being dragged. But of course you can also paint-select multiple cards and move them around together, so potentially that‚Äôs &gt;100s of updates a second.</p>


<figure>
  <figcaption>
    The x, y, width, height of the selection box is being broadcasted to collaborators in real-time
  </figcaption>
</figure>

<p>If I was sending server requests for each update, even regular use would bang against the rate limit that exists to prevent the server from crashing.</p>

<p>Instead, all updates flow through centralized update methods which update: the local cache, app state, real-time broadcast stream, undo/redo history, and adds the update to the API operations queue so that multiple updates can be grouped together and sent to the server in a single request.</p>



<p>Especially worth noting is that operations currently in the queue are saved in localStorage, so if they fail the queue can be resumed later when connectivity improves.</p>



<p>Once you have systems that are local-first and resilient to connectivity issues, the actual loading the app offline part almost writes itself.</p>

<p>For offline loading, the <a href="https://vite-pwa-org.netlify.app">vita-PWA</a> build plugin generates a PWA manifest and service worker that instructs the browser to cache the app and its asset files locally. And when new releases are shipped, the browser updates its cache to the new version.</p>

<p>The last thing needed is to do is inform the user that Kinopio works offline and reassure them that their changes will be sync-ed up once they‚Äôre back online.</p>

<p><img src="https://pketh.org/images/2024/offline/ss1.png"/></p>
<figure>
  <figcaption>
    Offline status button and dialog
  </figcaption>
</figure>

<p>While offline, it might surprise users to learn that certain features aren‚Äôt available offline because they depend on the server, like global search. Those features display a little clickable <code>offline</code> info badge. Other features are more obviously not usable offline, like social or discovery feeds, which can just be hidden.</p>

<p><img src="https://pketh.org/images/2024/offline/ss2.png"/></p>
<figure>
  <figcaption>
    Clicking the badge opens the Offline dialog
  </figcaption>
</figure>

<p>Essentially, I went through every dialog and button and decided whether I could either make it work offline, show an <code>offline</code> badge, or whether to hide it entirely.</p>



<p>While using Kinopio offline to test features and write this post, I realized that working this way is a really nice way to concentrate even on my desktop computer.</p>

<p>I‚Äôve never heard a productivity influencer say ‚Äúhey just go offline sometimes‚Äù, but the offline web is here, it‚Äôs speedy, it‚Äôs the original focus mode.</p>

<p><img src="https://pketh.org/images/2024/offline/frog.webp"/></p>
<figure>
  <figcaption>
    <a href="https://www.are.na/block/10001580">(source)</a>
  </figcaption>
</figure>

  </div><div>
  <hr/>
  <p>
    Subscribe to the <a href="https://pketh.org/feed.xml">RSS feed</a>,
    </p>

  <p>
      If you liked this, you might also enjoy
      
        
      
        
      
        
      
  </p>
</div></div>
  </body>
</html>
