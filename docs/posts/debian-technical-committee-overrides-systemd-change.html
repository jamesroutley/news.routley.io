<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://lwn.net/Articles/1041316/">Original</a>
    <h1>Debian Technical Committee overrides systemd change</h1>
    
    <div id="readability-page-1" class="page"><div>

<p>Debian packagers have a great deal of latitude when it comes to the
configuration of the software they package; they may opt, for example,
to <a href="https://lwn.net/Articles/973782/">disable default
features</a> in software that they feel are a security
hazard. However, packagers are expected to ensure that their packages
comply with <a href="https://www.debian.org/doc/debian-policy/">Debian Policy</a>,
regardless of the upstream&#39;s preferences. If a packager fails to
comply with the policy, the <a href="https://www.debian.org/devel/tech-ctte">Debian Technical
Committee</a> (TC) can step in to override them, which it has
done in the case of a recent systemd change that broke several
programs that depend on a world-writable <tt>/run/lock</tt>
directory.</p>

<p>The Filesystem Hierarchy Standard (FHS) <a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs/ch05s09.html">specifies</a>
that the <tt>/var/lock</tt> directory should be used to store lock
files for devices and other resources shared by multiple
applications. On Debian, <tt>/var/lock</tt> is a symbolic link to
<tt>/run/lock</tt>. The <tt>/run</tt> directory is created as a tmpfs
filesystem specifically for run-time files by <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd-tmpfiles-setup.service.html"><tt>systemd-tmpfiles</tt></a>
during system startup.</p>

<!-- middle-ad -->

<p>Debian Policy still cites the FHS, even though the FHS
has gone unmaintained for more than a decade. The specification was
not so much finished as <a href="https://www.mail-archive.com/lsb-discuss@lists.linux-foundation.org/msg00201.html">abandoned</a>
after FHS 3.0 was released—though there is a slow-moving
effort to revive and revise the standard as FHS 4.0, it has not
yet produced any results. Meanwhile, in the absence of a current
standard, systemd has spun off its <a href="https://www.freedesktop.org/software/systemd/man/latest/file-hierarchy.html"><tt>file-hierarchy</tt></a>
documentation to the <a href="https://uapi-group.org/">Linux Userspace
API (UAPI) Group</a> as a <a href="https://uapi-group.org/specifications/specs/linux_file_system_hierarchy/">specification</a>. LWN
<a href="https://lwn.net/Articles/1032947/">covered</a> that
development in August, related to Fedora&#39;s search for an FHS
successor.</p>

<h4>Locking up <tt>/run/lock</tt></h4>

<p>The <tt>/run/lock</tt> directory was deprecated in <a href="https://github.com/systemd/systemd/releases/tag/v258">Systemd v258</a>;
rather than dropping the directory entirely, though, the project has
changed the default to making <tt>/run/lock</tt> writable only by root, which is stricter than the permissions Debian had shipped with previously
<strike>rather than making it world-writable as in the past</strike>. The plan is to
get rid of <tt>/run/lock</tt> entirely in the v259 release, though
users (or distributions) can still retain the legacy behavior by
adding a configuration file in <tt>/etc/tmpfiles.d</tt> to override
systemd&#39;s defaults and create the directory with the desired
permissions.</p>

<p>The Debian project just released a new stable version, <a href="https://lwn.net/Articles/1033474/">Debian 13</a>
(&#34;trixie&#34;), in August, and work has begun on Debian 14
(&#34;forky&#34;). The current stable version of Debian shipped with systemd
v257, so users on stable will not be affected by these changes. But
v258 has entered Debian unstable where the change to
<tt>/run/lock</tt> broke other software, such as the <a href="https://en.wikipedia.org/wiki/UUCP">Unix-to-Unix Copy</a>
program (UUCP) and the <a href="https://en.wikipedia.org/wiki/Cu_%28Unix_utility%29"><tt>cu</tt></a>
utility. Use of the directory is not limited to vintage utilities;
Zbigniew Jędrzejewski-Szmek <a href="https://github.com/systemd/systemd/pull/38644#issuecomment-3302769755">objected</a>
to removing <tt>/var/lock</tt> in v259 as it would break <a href="https://github.com/alsa-project/alsa-utils?tab=readme-ov-file#alsa-utils"><tt>alsa-utils</tt></a>
and create additional work for distributions:</p>

<blockquote>
Doing this would this way just creat a foottrap for distributions: if
they notice the change, they&#39;ll just create a local override, so we
get a more complicated system in total with zero benefit to anyone. If
they miss it, things will be broken for a while until users report
it. And then they&#39;ll add the override.
</blockquote>

<p>On August 13, Marco d&#39;Itri—who is listed as a maintainer
of the systemd package—filed a <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1110981">bug</a>
against the <tt>uucp</tt> package reporting that systemd v258-rc1-1
had broken <a href="https://linux.die.net/man/8/uucico"><tt>uucico</tt></a>, along
with filing a 
<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1110980">bug</a>
against the systemd package, which cited the FHS entry for
<tt>/var/lock</tt>. He said that a compromise might be to make the
directory writable by the <a href="https://wiki.debian.org/SystemGroups#Other_System_Groups:~:text=dialout%3A%20Full%20and%20direct%20access%20to%20serial%20ports">dialout</a>
group rather than world-writable. He also <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1110980#10">mentioned</a>
that there was a <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=734086">previous
effort</a> in 2014 to modernize software that uses UUCP-style locks to
use <a href="https://man7.org/linux/man-pages/man2/flock.2.html"><tt>flock()</tt></a>
instead, but it stalled out.</p>

<h4>&#34;Dead and severely outdated&#34;</h4>

<p>Rather than temporarily reverting the behavior, systemd maintainer Luca
Boccassi <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1110980#27">argued</a>
that a world-writable directory in <tt>/run</tt> is a security risk.
Any process could write as much as it wanted to <tt>/run</tt>, which
could effectively DoS the system by exhausting space or inodes;
filling up <tt>/run</tt> would then cause critical services, such as
<a href="https://en.wikipedia.org/wiki/Udev">udev</a>, to stop
working. The FHS, he said, is &#34;<q>dead and severely outdated</q>&#34;.</p>

<p>The issue had already been <a href="https://github.com/systemd/systemd/issues/38563">discussed</a>
by the systemd project; Lennart Poettering had <a href="https://github.com/systemd/systemd/issues/38563#issuecomment-3242736658">responded</a>
that he did not see the point of <tt>/var/lock</tt> &#34;<q>in the modern
world</q>&#34;, but distributions were free to do as they see fit:</p>

<blockquote>
<p>Consider this more a passing of the baton from upstream systemd to
downstreams: if your distro wants this kind of legacy interface, then
just add this via a distro-specific tmpfiles drop-in. But there&#39;s no
point really in forcing anyone who has a more forward-looking view of
the world to still carry that dir.</p>
</blockquote>

<p>Poettering argued that distributions could make their own choices,
though it made him shudder to think of allowing unprivileged programs
to fill up a directory. Boccassi <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1110980#27:~:text=I%20certainly%20won%27t%20try%20to%20stop%20anyone%20wishing%20to%20do%20it">echoed</a> that sentiment in his response
to the Debian systemd bug. Any package could ship a configuration for
<tt>tmpfiles.d</tt> to create the directory and assume responsibility
for it as well:</p>

<blockquote>
<p>I certainly won&#39;t try to stop anyone wishing to do it, but also I
do not wish for these old workarounds to ship in this package
either.</p>

<p>There&#39;s ~2 years time until Forky ships, and that should be plenty of time
to either add this workaround elsewhere, or fix remaining programs to
use BSD locks, or both, so I&#39;m not going to hold back the new version
from testing for this niche case, sorry.</p>
</blockquote>

<p>Boccassi closed the bug with the &#34;WONTFIX&#34; tag.</p>

<h4>Debian Policy</h4>

<p>On September 1, d&#39;Itri <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1110980#38">responded</a>
that upstream systemd&#39;s opinion was not relevant in this case. Debian
policy requires the directory for lock files of serial devices, though
he had also opened a <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1111839">bug</a>
to revisit that, since the practice of using <tt>/var/lock</tt> for
serial-device locks dates back to the 1980s. However,
<tt>/var/lock</tt> is provided by systemd, so he reasoned that it is a
systemd bug unless another package was identified to take ownership of
creating the directory. &#34;<q>But you cannot just decide that the policy
violation does not exist.</q>&#34;</p>

<p>Thorsten Alteholz opened a <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1115317">bug</a>
with Debian&#39;s Technical Committee on September 15. He asked for
advice on how to proceed since the systemd bug had been marked
WONTFIX.</p>

<blockquote>
So what do you recommend how to go on from here? Change Debian policy
(as asked in #1111839), revert the change in systemd, find a Debian
wide solution or let every package maintainer implement their own
solution?
</blockquote>

<p>Bdale Garbee <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1115317#10">weighed
in</a> on the bug as well. He said that he uses <tt>cu</tt> &#34;<q>almost
constantly for interacting with embedded serial consoles on devices a
USB connection away from my laptop</q>&#34;. He was frustrated with the
change imposed by systemd &#34;<q>with no warning</q>&#34;, and looked forward
to the TC&#39;s response.</p>

<p>On September 24, Matthew Vernon <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1115317#20">responded</a>
to the bug, with a CC to the systemd maintainer alias. He said that it
seemed that Debian Policy required FHS compliance, &#34;<q>at least until
we come up with a transition plan</q>&#34;, and asked if systemd would
please revert the change. There was no response from any of the
systemd maintainers.</p>

<h4>Override</h4>

<p>Vernon <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1115317#30">updated</a>
the bug on September 29, and said that the TC had discussed the
situation at its last meeting. The conclusion was that systemd should
comply with policy, and thus FHS. He included a draft ballot text that
the TC would vote on, which noted that the committee was
&#34;<q>sympathetic</q>&#34; to the argument that <tt>flock()</tt> would be a
better solution, but that &#34;<q>an important part of the role of a 
Debian Developer is ensuring that software in Debian complies with 
Debian Policy</q>&#34;. A final <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1115317#40">ballot</a>
for the committee to consider was posted on October 2.</p>

<p>The ballot contained three options; all three required that the
systemd package provide <tt>/var/lock</tt> &#34;<q>with
relaxed enough permissions that existing Debian software that uses
/var/lock for system-wide locks of serial devices (and similar
purposes) works again</q>&#34;. The committee would exercise its power
under the Debian Constitution to override the systemd maintainers.
The options were:</p>

<blockquote>
<p>1) This change to systemd must persist until a satisfactory migration
of impacted software has occurred and Policy updated accordingly.</p>

<p>2) This change to systemd must persist until Policy has been updated
to allow otherwise.</p>

<p>3) This change to systemd must persist until the TC allows otherwise,
which the TC expects to do once a suitable transition plan has been
agreed.</p>
</blockquote>

<p>Vernon <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1115317#75">replied</a>
on October 6 to say that a decision had been reached and that
option one had won.</p>

<h4>Unlocking</h4>

<p>Debian&#39;s continued use of UUCP-style locking does seem to be more
than a little bit dated. The FHS 3.0 is clearly reaching the end
of its useful life, if not actually expired.</p>

<p>As a comparison, Fedora&#39;s <a href="https://packages.fedoraproject.org/pkgs/uucp/uucp/"><tt>uucp</tt></a>
package has a <a href="https://src.fedoraproject.org/rpms/uucp/blob/rawhide/f/uucp-1.07-lockdev.patch">patch</a>
to use <a href="https://linux.die.net/man/3/lockdev"><tt>lockdev</tt></a>
instead. The upcoming Fedora 43 release includes systemd v258,
and <tt>/run/lock</tt> is not world-writable. It seems like 
Debian could borrow Fedora&#39;s approach
for the <tt>uucp</tt> package, though that would not solve the problem
for any other Debian packages affected by the <tt>/run/lock</tt>
change. There is also third-party software to consider, of course.</p>

<p>To date, Boccassi has not responded to the conversation; I emailed
d&#39;Itri to ask why he did not make the change himself, since he was
aware of the bug. He replied on October 13 and said that 
&#34;<q>a maintainer cannot force a decision on another maintainer</q>.&#34;
Since he and Boccassi disagreed about the change it was left to the TC
to decide. He said that he planned to prepare a merge request to
implement the TC&#39;s decision, &#34;<q>as I have already agreed with
Luca</q>&#34;, within the week.</p>

</div></div>
  </body>
</html>
