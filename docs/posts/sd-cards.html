<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://schollz.com/tinker/sdcard/?utm_source=atom_feed">Original</a>
    <h1>sd cards</h1>
    
    <div id="readability-page-1" class="page"><div id="maincontent">
            
<p><img src="https://deepflow.io/img/sdcard.png"/>
</p>
<div>
    
    
    
    
    <p>
            <postamble datetime="2024-01-03" 2018-09-04=""><time datetime="2024-01-03 08:00:46">January 3rd, 2024</time></postamble>
         / <a href="https://deepflow.io/tags/software">#software</a> 
    </p>
    <p>Not all sd cards are the same.</p>
</div>
<p>I am working on an embedded device which I call “<a href="https://github.com/schollz/_core" target="_blank">_core</a>”. One of the main features of this device is the ability to jump around in an audio sample. Jumping around in audio normally requires a computer to load in the entire audio data into RAM. However, 16-bit audio at 44.1 khz quickly becomes megabytes of data and I’m using the rp2040 which only has 264 kilobytes of internal RAM! So instead of using RAM, I’m attempting to use an SD Card to quickly and randomly access memory.</p>
<h2 id="sd-card-in-the-audio-block">SD card in the audio block</h2>
<p>In many applications (mine included), audio is transfered in “blocks”, i.e. the audio dac asks for a batch of samples all at once instead of one sample at a time. For real-time audio this is a good strategy to buffer playback so that a sample isn’t lost in case another sample takes too long to compute. In my audio application the audio block consists of 441 samples. This means, at a sampling rate of 44,100 samples/second (44.1 khz), there is only 10 milliseconds to generate the next piece of audio.</p>
<p>If the audio data is in RAM, there is almost no latency to access the data. However, when the audio is coming from the SD card, then there is some latency involved in sending messages to the SD card. To prevent dropouts (bad audio “pops”), the SD card must succesfully retrieve data in less than 10 milliseconds.</p>
<p>So my most basic question is “what is the best SD card to use” which revolves around two questions:</p>
<ol>
<li>How fast can a SD card retrieve audio data in my application?</li>
<li>How often does the SD card require more than 10 milliseconds to retrieve data?</li>
</ol>
<h2 id="experiment">Experiment</h2>
<p>I bought 14 different SD cards and tested them using the same firmware, same hardware, and same samples. My firmware uses the SDIO protocol, for this test it is accessing 819 bytes after seeking to a position. I use the rp2040 <code>time_us_64()</code> to get the timing before and after the operations, and add up the entire time to get the latency.</p>
<p><a href="https://deepflow.io/img/sdcard_timings.png" target="_blank">
<img src="https://deepflow.io/img/sdcard_timings.png"/>
</a></p><p>(click the image to enlarge). The box-plots show the median read duration (latency) in my application and the dots show the outliers. The red area at the top shows where latency exceeds the audio block time, causing dropouts. (<a href="https://github.com/schollz/_core/blob/main/dev/analyze_sdcards.py" target="_blank">code for making plot</a>)</p>
<h2 id="conclusion">Conclusion</h2>
<p>I found that most SD cards are pretty fast. There are some that are much slower (an old Sandisk 16GB). Surprisingly, the fastest SD card (Lexar A1 32 GB) is not usable because it has periodic spikes of high latency which causes audio dropouts. The “best” SD card in my situation seems to be the “Kootion 32GB” cards which have the lowest median latency and also very few high outliers.</p>
<p><em>not all SD cards are the same!</em></p>



            </div></div>
  </body>
</html>
