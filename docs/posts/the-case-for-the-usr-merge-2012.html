<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.freedesktop.org/wiki/Software/systemd/TheCaseForTheUsrMerge/">Original</a>
    <h1>The Case for the /usr Merge (2012)</h1>
    
    <div id="readability-page-1" class="page"><div class="page">




<div id="pagebody">

<div id="content">
<p><a href="http://www.freedesktop.org/wiki/Software/systemd/">Back to systemd</a></p>



<p><strong>Why the /usr Merge Makes Sense for Compatibility Reasons</strong></p>

<p><em>This is based on the <a href="https://fedoraproject.org/wiki/Features/UsrMove">Fedora feature</a> for the same topic, put together by Harald Hoyer and Kay Sievers. This feature has been implemented successfully in Fedora 17.</em></p>

<p>Note that this page discusses a topic that is actually independent of systemd. systemd supports both systems with split and with merged /usr, and the /usr merge also makes sense for systemd-less systems. That said we want to encourage distributions adopting systemd to also adopt the /usr merge.</p>

<h3 id="whatsbeingdiscussedhere">What&#39;s Being Discussed Here?</h3>

<p>Fedora (and other distributions) have finished work on getting rid of the separation of /bin and /usr/bin, as well as /sbin and /usr/sbin, /lib and /usr/lib, and /lib64 and /usr/lib64. All files from the directories in / will be merged into their respective counterparts in /usr, and symlinks for the old directories will be created instead:</p>

<pre><code>/bin → /usr/bin
/sbin → /usr/sbin
/lib → /usr/lib
/lib64 → /usr/lib64
</code></pre>

<p>You are wondering why merging /bin, /sbin, /lib, /lib64 into their respective counterparts in /usr makes sense, and why distributions are pushing for it? You are wondering whether your own distribution should adopt the same change? Here are a few answers to these questions, with an emphasis on a compatibility point of view:</p>

<h3 id="compatibility:thegistofit">Compatibility: The Gist of It</h3>

<ul>
<li>Improved compatibility with other Unixes/Linuxes in <em>behavior</em>: After the /usr merge all binaries become available in both /bin and /usr/bin, resp. both /sbin and /usr/sbin (simply because /bin becomes a symlink to /usr/bin, resp. /sbin to /usr/sbin). That means scripts/programs written for other Unixes or other Linuxes and ported to your distribution will no longer need fixing for the file system paths of the binaries called, which is otherwise a major source of frustration. /usr/bin and /bin (resp. /usr/sbin and /sbin) become entirely equivalent.</li>
<li>Improved compatibility with other Unixes (in particular Solaris) in <em>appearance</em>: The primary commercial Unix implementation is nowadays Oracle Solaris. Solaris has already completed the same /usr merge in Solaris 11. By making the same change in Linux we minimize the difference towards the primary Unix implementation, thus easing portability from Solaris.</li>
<li>Improved compatibility with GNU build systems: The biggest part of Linux software is built with GNU autoconf/automake (i.e. GNU autotools), which are unaware of the Linux-specific /usr split. Maintaining the /usr split requires non-trivial project-specific handling in the upstream build system, and in your distribution&#39;s packages. With the /usr merge, this work becomes unnecessary and porting packages to Linux becomes simpler.</li>
<li>Improved compatibility with current upstream development: In order to minimize the delta from your Linux distribution to upstream development the /usr merge is key.</li>
</ul>

<h3 id="compatibility:thelongerversion">Compatibility: The Longer Version</h3>

<p>A unified filesystem layout (as it results from the /usr merge) is more compatible with UNIX than Linux’ traditional split of /bin vs. /usr/bin. Unixes differ in where individual tools are installed, their locations in many cases are not defined at all and differ in the various Linux distributions. The /usr merge removes this difference in its entirety, and provides full compatibility with the locations of tools of any Unix via the symlink from /bin to /usr/bin.</p>

<h4 id="example">Example</h4>

<ul>
<li>/usr/bin/foo may be called by other tools either via /usr/bin/foo or /bin/foo, both paths become fully equivalent through the /usr merge. The operating system ends up executing exactly the same file, simply because the symlink /bin just redirects the invocation to /usr/bin.</li>
</ul>

<p>The historical justification for a /bin, /sbin and /lib separate from /usr no longer applies today. (<a href="http://lists.busybox.net/pipermail/busybox/2010-December/074114.html">More on the historical justification for the split</a>, by Rob Landley) They were split off to have selected tools on a faster hard disk (which was small, because it was more expensive) and to contain all the tools necessary to mount the slower /usr partition. Today, a separate /usr partition already must be mounted by the initramfs during early boot, thus making the justification for a split-off moot. In addition a lot of tools in /bin and /sbin in the status quo already lost the ability to run without a pre-mounted /usr. There is no valid reason anymore to have the operating system spread over multiple hierarchies, it lost its purpose.</p>

<p>Solaris implemented the core part of the /usr merge 15 years ago already, and completed it with the introduction of Solaris 11. Solaris has /bin and /sbin only as symlinks in the root file system, the same way as you will have after the /usr merge: <a href="http://docs.oracle.com/cd/E23824_01/html/E24456/userenv-1.html">Transitioning From Oracle Solaris 10 to Oracle Solaris 11 - User Environment Feature Changes</a>.</p>

<p>Not implementing the /usr merge in your distribution will isolate it from upstream development. It will make porting of packages needlessly difficult, because packagers need to split up installed files into multiple directories and hard code different locations for tools; both will cause unnecessary incompatibilities. Several Linux distributions are agreeing with the benefits of the /usr merge and are already in the process to implement the /usr merge. This means that upstream projects will adapt quickly to the change, those making portability to your distribution harder.</p>

<h3 id="beyondcompatibility">Beyond Compatibility</h3>

<p>One major benefit of the /usr merge is the reduction of complexity of our system: the new file system hierarchy becomes much simpler, and the separation between (read-only, potentially even immutable) vendor-supplied OS resources and users resources becomes much cleaner. As a result of the reduced complexity of the hierarchy, packaging becomes much simpler too, since the problems of handling the split in the .spec files go away.</p>

<p>The merged directory /usr, containing almost the entire vendor-supplied operating system resources, offers us a number of new features regarding OS snapshotting and options for enterprise environments for network sharing or running multiple guests on one host. Static vendor-supplied OS resources are monopolized at a single location, that can be made read-only easily, either for the whole system or individually for each service. Most of this is much harder to accomplish, or even impossible, with the current arbitrary split of tools across multiple directories.</p>

<p><em>With all vendor-supplied OS resources in a single directory /usr they may be shared atomically, snapshots of them become atomic, and the file system may be made read-only as a single unit.</em></p>



<ul>
<li>With the merged /usr directory we can offer a read-only export of the vendor supplied OS to the network, which will contain almost the entire operating system resources. The client hosts will then only need a minimal host-specific root filesystem with symlinks pointing into the shared /usr filesystem. From a maintenance perspective this is the first time where sharing the operating system over the network starts to make sense. Without the merged /usr directory (like in traditional Linux) we can only share parts of the OS at a time, but not the core components of it that are located in the root file system. The host-specific root filesystem hence traditionally needs to be much larger, cannot be shared among client hosts and needs to be updated individually and often. Vendor-supplied OS resources traditionally ended up &#34;leaking&#34; into the host-specific root file system.</li>
</ul>

<h4 id="example:multipleguestoperatingsystemsonthesamehost">Example: Multiple Guest Operating Systems on the Same Host</h4>

<ul>
<li>With the merged /usr directory, we can offer to share /usr read-only with multiple guest operating systems, which will shrink down the guest file system to a couple of MB. The ratio of the per-guest host-only part vs. the shared operating system becomes nearly optimal.
In the long run the maintenance burden resulting of the split-up tools in your distribution, and hard-coded deviating installation locations to distribute binaries and other packaged files into multiple hierarchies will very likely cause more trouble than the /usr merge itself will cause.</li>
</ul>

<h2 id="mythsandfacts">Myths and Facts</h2>

<p><strong>Myth #1</strong>: Fedora is the first OS to implement the /usr merge</p>

<p><strong>Fact</strong>: Oracle Solaris has implemented the /usr merge in parts 15 years ago, and completed it in Solaris 11. Fedora is following suit here, it is not the pioneer.</p>

<p><strong>Myth #2</strong>: Fedora is the only Linux distribution to implement the /usr merge</p>

<p><strong>Fact</strong>: Multiple other Linux distributions have been working in a similar direction.</p>

<p><strong>Myth #3</strong>: The /usr merge decreases compatibility with other Unixes/Linuxes</p>

<p><strong>Fact</strong>: By providing all binary tools in /usr/bin as well as in /bin (resp. /usr/sbin + /sbin) compatibility with hard coded binary paths in scripts is increased. When a distro A installs a tool “foo” in /usr/bin, and distro B installs it in /bin, then we’ll provide it in both, thus creating compatibility with both A and B.</p>

<p><strong>Myth #4</strong>: The /usr merge’s only purpose is to look pretty, and has no other benefits</p>

<p><strong>Fact</strong>: The /usr merge makes sharing the vendor-supplied OS resources between a host and networked clients as well as a host and local light-weight containers easier and atomic. Snapshotting the OS becomes a viable option. The /usr merge also allows making the entire vendor-supplied OS resources read-only for increased security and robustness.</p>

<p><strong>Myth #5</strong>: Adopting the /usr merge in your distribution means additional work for your distribution&#39;s package maintainers</p>

<p><strong>Fact</strong>: When the merge is implemented in other distributions and upstream, not adopting the /usr merge in your distribution means more work, adopting it is cheap.</p>

<p><strong>Myth #6</strong>: A split /usr is Unix “standard”, and a merged /usr would be Linux-specific</p>

<p><strong>Fact</strong>: On SysV Unix /bin traditionally has been a symlink to /usr/bin. A non-symlinked version of that directory is specific to non-SysV Unix and Linux.</p>

<p><strong>Myth #7</strong>: After the /usr merge one can no longer mount /usr read-only, as it is common usage in many areas.</p>

<p><strong>Fact</strong>: Au contraire! One of the reasons we are actually doing this is to make a read-only /usr more thorough: the entire vendor-supplied OS resources can be made read-only, i.e. all of what traditionally was stored in /bin, /sbin, /lib on top of what is already in /usr.</p>

<p><strong>Myth #8</strong>: The /usr merge will break my old installation which has /usr on a separate partition.</p>

<p><strong>Fact</strong>: This is perfectly well supported, and one of the reasons we are actually doing this is to make placing /usr of a separate partition more thorough. What changes is simply that you need to boot with an initrd that mounts /usr before jumping into the root file system. Most distributions rely on initrds anyway, so effectively little changes.</p>

<p><strong>Myth #9</strong>: The /usr split is useful to have a minimal rescue system on the root file system, and the rest of the OS on /usr.</p>

<p><strong>Fact</strong>: On Fedora the root directory contains ~450MB already. This hasn&#39;t been minimal since a long time, and due to today&#39;s complex storage and networking technologies it&#39;s unrealistic to ever reduce this again. In fact, since the introduction of initrds to Linux the initrd took over the role as minimal rescue system that requires only a working boot loader to be started, but not a full file system.</p>

<p><strong>Myth #10</strong>: The status quo of a split /usr with mounting it without initrd is perfectly well supported right now and works.</p>

<p><strong>Fact</strong>: A split /usr without involvement of an initrd mounting it before jumping into the root file system <a href="http://freedesktop.org/wiki/Software/systemd/separate-usr-is-broken">hasn&#39;t worked correctly since a long time</a>.</p>

<p><strong>Myth #11</strong>: Instead of merging / into /usr it would make a lot more sense to merge /usr into /.</p>

<p><strong>Fact</strong>: This would make the separation between vendor-supplied OS resources and machine-specific even worse, thus making OS snapshots and network/container sharing of it much harder and non-atomic, and clutter the root file system with a multitude of new directories.</p>

<hr/>

<p>If this page didn&#39;t answer your questions you may continue reading <a href="https://fedoraproject.org/wiki/Features/UsrMove">on the Fedora feature page</a> and this <a href="http://thread.gmane.org/gmane.linux.redhat.fedora.devel/155511/focus=155792">mail from Lennart</a>.</p>

</div>





</div>



</div></div>
  </body>
</html>
