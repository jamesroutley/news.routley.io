<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blog.wesleyac.com/posts/e2e-testing-email">Original</a>
    <h1>End-to-end testing emails</h1>
    
    <div id="readability-page-1" class="page"><div>
        <p>I came up with a really slick trick to write E2E tests that deal with sending/receiving emails recently. This is the sort of thing that seems like it&#39;s probably usually sort of a nightmare — I wanted to write a test for registering a account on a website, where part of the flow was clicking on a validation link in a email.</p>

<p>The slick trick is a test SMTP server which is also a HTTP server. It&#39;s 39 lines of Javascript and extraordinarily simple:</p>
<div><pre><code data-lang="javascript"><span>const</span> <span>SMTPServer</span> <span>=</span> <span>require</span><span>(</span><span>&#34;</span><span>smtp-server</span><span>&#34;</span><span>).</span><span>SMTPServer</span><span>;</span>
<span>const</span> <span>http</span> <span>=</span> <span>require</span><span>(</span><span>&#34;</span><span>http</span><span>&#34;</span><span>);</span>

<span>let</span> <span>emails</span> <span>=</span> <span>{};</span>

<span>new</span> <span>SMTPServer</span><span>({</span>
  <span>authOptional</span><span>:</span> <span>true</span><span>,</span>
  <span>onData</span><span>:</span> <span>(</span><span>stream</span><span>,</span> <span>session</span><span>,</span> <span>callback</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>chunks</span> <span>=</span> <span>[];</span>
    <span>stream</span><span>.</span><span>on</span><span>(</span><span>&#39;</span><span>data</span><span>&#39;</span><span>,</span> <span>(</span><span>chunk</span><span>)</span> <span>=&gt;</span> <span>chunks</span><span>.</span><span>push</span><span>(</span><span>Buffer</span><span>.</span><span>from</span><span>(</span><span>chunk</span><span>)));</span>
    <span>stream</span><span>.</span><span>on</span><span>(</span><span>&#39;</span><span>end</span><span>&#39;</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>data</span> <span>=</span> <span>Buffer</span><span>.</span><span>concat</span><span>(</span><span>chunks</span><span>).</span><span>toString</span><span>(</span><span>&#39;</span><span>utf8</span><span>&#39;</span><span>);</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>data</span><span>);</span>
      <span>const</span> <span>email</span> <span>=</span> <span>session</span><span>.</span><span>envelope</span><span>.</span><span>rcptTo</span><span>[</span><span>0</span><span>].</span><span>address</span><span>;</span>
      <span>if</span> <span>(</span><span>email</span> <span>in</span> <span>emails</span><span>)</span> <span>{</span>
        <span>emails</span><span>[</span><span>email</span><span>].</span><span>push</span><span>(</span><span>data</span><span>);</span>
      <span>}</span> <span>else</span> <span>{</span>
        <span>emails</span><span>[</span><span>email</span><span>]</span> <span>=</span> <span>[</span><span>data</span><span>];</span>
      <span>}</span>
      <span>callback</span><span>();</span>
    <span>});</span>
  <span>}</span>
<span>}).</span><span>listen</span><span>(</span><span>2525</span><span>);</span>

<span>http</span><span>.</span><span>createServer</span><span>(</span><span>async</span> <span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>const</span> <span>email</span> <span>=</span> <span>req</span><span>.</span><span>url</span><span>.</span><span>slice</span><span>(</span><span>1</span><span>);</span>
  <span>if</span> <span>(</span><span>!</span><span>(</span><span>email</span> <span>in</span> <span>emails</span><span>))</span> <span>{</span>
    <span>emails</span><span>[</span><span>email</span><span>]</span> <span>=</span> <span>[];</span>
  <span>}</span>

  <span>res</span><span>.</span><span>writeHead</span><span>(</span><span>200</span><span>,</span> <span>{</span><span>&#34;</span><span>Content-Type</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>text/plain</span><span>&#34;</span><span>});</span>

  <span>const</span> <span>initial_num_emails</span> <span>=</span> <span>emails</span><span>[</span><span>email</span><span>].</span><span>length</span><span>;</span>
  <span>while</span> <span>(</span><span>emails</span><span>[</span><span>email</span><span>].</span><span>length</span> <span>==</span> <span>initial_num_emails</span><span>)</span> <span>{</span>
    <span>await</span> <span>new</span> <span>Promise</span><span>(</span><span>resolve</span> <span>=&gt;</span> <span>setTimeout</span><span>(</span><span>resolve</span><span>,</span> <span>10</span><span>));</span>
  <span>}</span>

  <span>res</span><span>.</span><span>end</span><span>(</span><span>emails</span><span>[</span><span>email</span><span>][</span><span>initial_num_emails</span><span>]);</span>
<span>}).</span><span>listen</span><span>(</span><span>2424</span><span>);</span>
</code></pre></div>
<p>This allows you to make a request to <code>http://localhost:2424/test@example.com</code>, which will block until the SMTP server on port 2525 receives a email to <code>test@example.com</code>, at which point it&#39;ll return the full text of the email.</p>

<p>This allows for writing a super simple E2E tests — here&#39;s my helper function to register a new user:</p>
<div><pre><code data-lang="javascript"><span>async</span> <span>function</span> <span>registerAndLogin</span><span>(</span><span>page</span><span>)</span> <span>{</span>
  <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>&#39;</span><span>/register</span><span>&#39;</span><span>);</span>
  <span>const</span> <span>email</span> <span>=</span> <span>`</span><span>${</span><span>randomUUID</span><span>()}</span><span>@example.com`</span><span>;</span>
  <span>const</span> <span>password</span> <span>=</span> <span>randomUUID</span><span>();</span>
  <span>await</span> <span>page</span><span>.</span><span>getByPlaceholder</span><span>(</span><span>&#39;</span><span>Email</span><span>&#39;</span><span>).</span><span>fill</span><span>(</span><span>email</span><span>);</span>
  <span>await</span> <span>page</span><span>.</span><span>getByPlaceholder</span><span>(</span><span>&#39;</span><span>Password</span><span>&#39;</span><span>).</span><span>fill</span><span>(</span><span>password</span><span>);</span>
  <span>const</span> <span>verification_email</span> <span>=</span> <span>fetch</span><span>(</span><span>`http://localhost:2424/</span><span>${</span><span>email</span><span>}</span><span>`</span><span>);</span>
  <span>await</span> <span>page</span><span>.</span><span>getByRole</span><span>(</span><span>&#39;</span><span>button</span><span>&#39;</span><span>,</span> <span>{</span> <span>name</span><span>:</span> <span>&#39;</span><span>Sign Up</span><span>&#39;</span> <span>}).</span><span>press</span><span>(</span><span>&#39;</span><span>Enter</span><span>&#39;</span><span>);</span>
  <span>const</span> <span>verification_email_response</span> <span>=</span> <span>await</span> <span>verification_email</span><span>;</span>
  <span>const</span> <span>verification_email_text</span> <span>=</span> <span>await</span> <span>verification_email_response</span><span>.</span><span>text</span><span>();</span>
  <span>const</span> <span>verification_link</span> <span>=</span> <span>/</span><span>(</span><span>https</span><span>?</span><span>:</span><span>\/\/[^\s]</span><span>+</span><span>)</span><span>/gm</span><span>.</span><span>exec</span><span>(</span><span>verification_email_text</span><span>)[</span><span>1</span><span>];</span>
  <span>await</span> <span>page</span><span>.</span><span>goto</span><span>(</span><span>verification_link</span><span>);</span>
  <span>return</span> <span>{</span>
    <span>email</span><span>:</span> <span>email</span><span>,</span>
    <span>password</span><span>:</span> <span>password</span>
  <span>};</span>
<span>}</span>
</code></pre></div>
<p>Note the nice use of async/await to make the fetch request before pressing the &#34;Sign Up&#34; button.</p>

<p>As soon as I came up with this I immediately started showing it to everyone — my friend said &#34;I feel like I just learned a new skateboard trick&#34; — excellent praise, in my book.</p>

<p>As a sidenote, if you haven&#39;t used <a href="https://playwright.dev">Playwright</a> for E2E tests, you&#39;re missing out. It&#39;s my opinion that the existence of Playwright moves E2E testing of webapps from being something that&#39;s usually tedious and flaky but sometimes worth the costs to something that&#39;s viable as a primary testing strategy.</p>

<p>Unit tests are best when code is decoupled and complex, but web code tends to be simple but tightly connected. This makes E2E testing a extremely useful strategy, and Playwright makes it simple to write non-flaky E2E tests with a small amount of effort — check out the <a href="https://playwright.dev/docs/codegen">codegen tool</a> and the <a href="https://playwright.dev/docs/trace-viewer">trace viewer</a> if you haven&#39;t.</p>

<p>If you want E2E tests to be your main tests, it does require some somewhat careful planning — since I <a href="https://blog.wesleyac.com/posts/consider-sqlite">use SQLite</a> and don&#39;t rely on any cloud tools, I can have tests that run extremely quickly (and even in parallel), without relying on any external resources, which is key for this kind of strategy. If you can swing it, though, it&#39;s pretty nice.</p>

      </div></div>
  </body>
</html>
