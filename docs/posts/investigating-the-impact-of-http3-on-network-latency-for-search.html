<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dropbox.tech/frontend/investigating-the-impact-of-http3-on-network-latency-for-search">Original</a>
    <h1>Investigating the impact of HTTP3 on network latency for search</h1>
    
    <div id="readability-page-1" class="page"><div>
            


<div>
    
    <div>
<p>Dropbox is well known for storing users’ files—but it’s equally important we can retrieve content quickly when our users need it most. For the Retrieval Experiences team, that means building a search experience that is as fast, simple, and powerful as possible. But when we conducted a research study in July 2022, one of the most common complaints was that search was still too slow.<b> </b>If search was faster, these users said, they would be more likely to use Dropbox on a regular basis.</p>
<p>At that time, we found it took ~400-450ms (p75) for the search webpage to submit a query and receive a response from the server—far too slow for our users who expected quicker results. It sent us looking for ways that search latency could be improved.</p>
<p>In our early analysis, we learned that of the time it took to fetch search query results, roughly half of that time was spent in transit to and from Dropbox servers (a.k.a. network latency) while the other half was spent on determining which search results to return (a.k.a. server latency). We decided to tackle both sides of the equation simultaneously. While some of our colleagues explored ways to reduce server latency, we investigated network latency.</p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="Three graphs showing changes in p75 network, server, and combined latency (in miliseconds) respectively over the course of a week. When viewed sperately, it's clear that network latency is significantly more variable than server latency."
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png"
             aria-hidden=""
             alt="Three graphs showing changes in p75 network, server, and combined latency (in miliseconds) respectively over the course of a week. When viewed sperately, it's clear that network latency is significantly more variable than server latency."
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="1113"
             data-aem-asset-id="71cc6715-8ea3-4750-bc0d-0452edd664ab:http3searchlatency-diagram1-@2x.png"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="1113"
             data-aem-asset-id="71cc6715-8ea3-4750-bc0d-0452edd664ab:http3searchlatency-diagram1-@2x.png"
             data-trackable="true" /> -->

        
         <img src="https://dropbox.tech/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png/_jcr_content/renditions/http3searchlatency-diagram1-@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram1-@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="Three graphs showing changes in p75 network, server, and combined latency (in miliseconds) respectively over the course of a week. When viewed sperately, it&#39;s clear that network latency is significantly more variable than server latency." data-aem-asset-id="71cc6715-8ea3-4750-bc0d-0452edd664ab:http3searchlatency-diagram1-@2x.png" data-trackable="true" height="1113" width="720"/>
        
    

            <figcaption><p>Search’s total latency is comprised of server time and network time</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<p>Network latency is significantly more variable than server latency. It depends on local network conditions, the user’s distance from a Dropbox datacenter, and even the time of day. During business hours, many users work at offices with strong internet connections, but at night, they are at homes with weaker internet connections. Compared to North America—where the majority of Dropbox data centers are located—latencies can be up to twice as high in Europe and three times as high in Asia. Considering 25% of search requests originate from Europe and 15% originate from Asia, a significant portion of Dropbox users would benefit from lower network latencies.</p>
<p>At this point, we realized that we couldn’t tackle our network latency issues alone. In collaboration with the Traffic team, we considered our options and decided to test a possible solution: HTTP3.</p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="A graph showing p75 result suggestion network latency (in milliseconds) by region. Latency is highest in Asia, followed by Europe, while North and Central America are lowest."
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png"
             aria-hidden=""
             alt="A graph showing p75 result suggestion network latency (in milliseconds) by region. Latency is highest in Asia, followed by Europe, while North and Central America are lowest."
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="723"
             data-aem-asset-id="fc6de258-c706-45c5-b1c5-e773892c1909:http3searchlatency-diagram2-@2x.png"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="723"
             data-aem-asset-id="fc6de258-c706-45c5-b1c5-e773892c1909:http3searchlatency-diagram2-@2x.png"
             data-trackable="true" /> -->

        
         <img src="https://dropbox.tech/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png/_jcr_content/renditions/http3searchlatency-diagram2-@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram2-@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="A graph showing p75 result suggestion network latency (in milliseconds) by region. Latency is highest in Asia, followed by Europe, while North and Central America are lowest." data-aem-asset-id="fc6de258-c706-45c5-b1c5-e773892c1909:http3searchlatency-diagram2-@2x.png" data-trackable="true" height="723" width="720"/>
        
    

            <figcaption><p>Regional differences in network latency</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<p id="-a-hypothetical-speed-boost">
    <h2> A hypothetical speed boost</h2>
</p>
</div>
<div>
<p>Dropbox.com currently uses HTTP2, a protocol based on <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank">TCP</a>. The latest version, HTTP3, uses <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank">UDP</a>. This speeds up the time to establish connections and serve parallel requests by:</p>
<ul>
<li><b>Introducing Zero Round Trip Time (0RTT) at the beginning of connections. </b>Compared to HTTP2, HTTP3 makes one fewer round trip because it avoids the three-way handshake mandatory for TCP-based protocols. Furthermore, with 0RTT, subsequent HTTP3 connections establish a secure connection and make the actual request in the same packet, whereas in HTTP2, these pieces of data must be sent separately.</li>
<li><b>Eliminating head-of-line blocking. </b>TCP is stream-oriented and thus requires packets to be processed in a strict order. If a packet in one stream is lost, packets in subsequent streams could be delayed in the client’s TCP stack, even if the streams are unrelated to each other. But with UDP, if one stream is blocked, other streams can still deliver data to the application.</li>
</ul>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="Head-of-line blocking: In HTTP2, a blocked stream also delays subsequent streams, whereas in HTTP3, a blocked stream only affects that stream"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png"
             aria-hidden=""
             alt="Head-of-line blocking: In HTTP2, a blocked stream also delays subsequent streams, whereas in HTTP3, a blocked stream only affects that stream"
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="356"
             data-aem-asset-id="00eb6127-a301-40fa-ab1f-12db0a123a8c:http3searchlatency-diagram3-@2x.png"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="356"
             data-aem-asset-id="00eb6127-a301-40fa-ab1f-12db0a123a8c:http3searchlatency-diagram3-@2x.png"
             data-trackable="true" /> -->

        
         <img src="https://dropbox.tech/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png/_jcr_content/renditions/http3searchlatency-diagram3-@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2023/05/http3/http3searchlatency-diagram3-@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="Head-of-line blocking: In HTTP2, a blocked stream also delays subsequent streams, whereas in HTTP3, a blocked stream only affects that stream" data-aem-asset-id="00eb6127-a301-40fa-ab1f-12db0a123a8c:http3searchlatency-diagram3-@2x.png" data-trackable="true" height="356" width="720"/>
        
    

            <figcaption><p>Head-of-line blocking: In HTTP2, a blocked stream also delays subsequent streams, whereas in HTTP3, a blocked stream only affects that stream</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<p>HTTP3 sounded promising. In theory, it could not only speed up search requests but also operations across all of Dropbox—from file uploads to content suggestions. However, it was unclear what the real world impact would be. It was entirely possible—albeit unlikely—for HTTP3 to be <i>slower</i> than HTTP2.  </p>
<p>We needed to be sure that Dropbox would benefit from a migration to HTTP3. Rather than take an unknown leap, we decided to test HTTP3 on a portion of Dropbox traffic first.</p>

</div>
<div>
<p id="-setting-up-the-experiment">
    <h2> Setting up the experiment</h2>
</p>
</div>
<div>
<p>To evaluate the performance of HTTP3 on Dropbox servers, the Traffic team created a test subdomain that served our main website with HTTP3. The test site was specifically designed so that we could safely make specific API requests over HTTP3 without negatively impacting users of the main website.</p>
<p>As part of this test site, we built a no-op API endpoint that could successfully leverage HTTP3. Because the server doesn’t perform any operations, server latency would be near zero—meaning any remaining latency would be network latency. With this endpoint in place, we then devised our HTTP3 test involving a series of actions meant to simulate typical request traffic on our website—including when a user performs a search. The simulation had three phases:</p>
<ol>
<li><b>Setup. </b>First, we pre-warmed the cache by firing off two sequential HTTP3 requests, ignoring any timing data. This was done purely to warm up any networking caches related to the HTTP2 and HTTP3 servers equally, ensuring that subsequent HTTP2 vs. HTTP3 testing was a fair comparison. This is specifically necessary for our test because the first connection is always HTTP2; that’s when the client receives information required to support HTTP3. All subsequent connections would then try to use HTTP3.</li>
<li><b>Running the HTTP2 control.</b> We then ran five parallel HTTP2 requests to the no-op API endpoint and logged the network time for each request. This simulated how users currently get data from our servers, and thus was our control.</li>
<li><b>Running the HTTP3 experiment.</b> Finally, we ran another five parallel requests to the no-op API endpoint, but this time via HTTP3. We logged the elapsed network time for each request to compare against HTTP2.</li>
</ol>
<p>The most important aspect of this test was that the requests were made in parallel. This would simulate real-world scenarios at Dropbox, where many parallel requests are fired with each interaction with Dropbox web. But more importantly, it would help us determine whether eliminating head-of-line blocking would actually speed up parallel requests; if these requests were not faster, it was unlikely HTTP3 would help us in practice.</p>
<p>To prevent any impact to user-facing performance, we only allowed our HTTP3 tests to be conducted once per page load, and only after the user completed a search. We ran the experiment for roughly two weeks between December 2022 and January 2023. Traffic regularly exceeded 1,500 queries per second (QPS) at peak times, and we successfully collected data from a wide sample of users around the world.</p>

</div>

<div>
<p>Over the course of our two-week experiment, 300,000 HTTP3 requests were fired per day.</p>
<p>For the majority of our global users, HTTP3 reduced network latencies by <b>5-15ms</b> (or 5%). While this is an improvement, these wins would appear negligible to the average user. At p90, however, HTTP3 demonstrated massive improvements, with a latency reduction of <b>48ms </b>(or 13%)—and at p95, a reduction of <b>146ms</b> (21%). This could be explained by the fact that HTTP3 is better at handling packet drops in parallel connections by eliminating head-of-line blocking; because packet drops are more likely to occur in networks with suboptimal connection quality, the benefits of HTTP3 are more visible at the higher percentiles.</p>

</div>
<div>



<table id="customers">
  <tbody><tr>
    <th>HTTP3 vs. HTTP2</th>
    <th></th>
  </tr>
  <tr>
    <td>p25</td>
    <td>-4.23ms / -4.73%</td>
  </tr>
  <tr>
    <td>p50</td>
    <td>-5.55ms / -4.15%</td>
  </tr>
  <tr>
    <td>p75</td>
    <td>-13.1ms / -5.78%</td>
  </tr>
  <tr>
    <td>p90</td>
    <td>-47.6ms / -12.5%</td>
  </tr>
  <tr>
    <td>p95</td>
    <td>-146ms / -20.9%</td>
  </tr>
</tbody></table>
</div>
<p>The results are even more prominent when split by region at the higher percentiles. HTTP3 significantly reduced network latencies for Asia by around <b>77ms </b>at p90 and by <b>200ms</b> at p95. Other high-traffic regions like Europe and North and Central America experienced smaller absolute improvements, though the relative improvements are similar across the board (<b>22%</b> at p95).</p>
<div>



<table id="customers">
  <tbody><tr>
    <th>HTTP3 vs. HTTP2</th>
    <th>North and Central America</th>
    <th>Europe</th>
    <th>Asia</th>
  </tr>
  <tr>
    <td>p25</td>
    <td>-3.20ms / -6%</td>
    <td>-2.34ms / -2%</td>
    <td>-3.73ms / -2%</td>
  </tr>
  <tr>
    <td>p50</td>
    <td>-4.21ms / -5%</td>
    <td>-3.84ms / -3%</td>
    <td>-5.12ms / -2%</td>
  </tr>
  <tr>
    <td>p75</td>
    <td>-9.03ms / -8%</td>
    <td>-11.1ms / -6%</td>
    <td>-15.0ms / -4%</td>
  </tr>
  <tr>
    <td>p90</td>
    <td>-44.9ms / -17%</td>
    <td>-47.3ms / -13%</td>
    <td>-77.3ms / -14%</td>
  </tr>
  <tr>
    <td>p95</td>
    <td>-118ms / -22%</td>
    <td>-141ms / -21%</td>
    <td>-200ms / -22%</td>
  </tr>
</tbody></table>
</div>

<div>
<p>Our experiment successfully demonstrated that HTTP3 significantly improved latency at the 90th percentile and above. Even though HTTP3 noticeably reduces latencies for only 10% of our users, these will be the users who suffer from high latencies and will appreciate improvement the most. The biggest beneficiaries of HTTP3 would be our international users, since the highest latencies are disproportionally found outside of North America.</p>
<p>We gained two major insights from our large-scale experiment:</p>
<ul>
<li>The benefits of 0RTT are less important because nearly all connections to dropbox.com are long-lived.</li>
<li>The way HTTP3 handles head-of-line blocking significantly reduced latencies, especially in networks where packets drops are more likely to occur.</li>
</ul>
<p>At the beginning of our investigation into network latency, we only knew the hypothetical benefits of HTTP3. Now we have a better understanding of the actual impact that HTTP3 can bring—not only to Search, but all of Dropbox, including file operations and content suggestions with machine learning. Given the sizable performance benefit for users in our p90+, Traffic is now planning a production-ready buildout of HTTP3.</p>
<p><i>This high-impact project is the result of Dropboxers working together across several teams (specifically, Retrieval Experiences and Traffic). We’d like to give special thanks to Roland Hui, Sarah Andrabi, Khugan Shanmugeswaran, the NetEng team, and the Security team for helping us turn this theoretical investigation into a reality.</i></p>
<p>~ ~ ~</p>
<p><i>If building innovative products, experiences, and infrastructure excites you, come build the future with us! Visit </i><a href="https://dropbox.com/jobs" target="_blank"><i><u>dropbox.com/jobs</u></i></a><i> to see our open roles, and follow @LifeInsideDropbox on </i><a href="https://www.instagram.com/lifeinsidedropbox/?hl=en" target="_blank"><i><u>Instagram</u></i></a><i> and </i><a href="https://www.facebook.com/lifeinsidedropbox/" target="_blank"><i><u>Facebook</u></i></a><i> to see what it&#39;s like to create a more enlightened way of working. </i></p>

</div>

    
</div>

        </div></div>
  </body>
</html>
