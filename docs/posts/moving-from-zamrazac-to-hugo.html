<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://minor.gripe/posts/2025-03-23-moving_from_zamrazac_to_hugo/">Original</a>
    <h1>Moving From Zamrazac to Hugo</h1>
    
    <div id="readability-page-1" class="page"><div>
                <div>
  <div>
  

  <div>
    <p><time datetime=" 2025-03-23T23:22:28-0500">
        March 23, 2025
      </time>
      
      <span> - </span>
      <span>
        
          
        

        <span>9 mins read</span>
      </span>
    </p>

    
    
    
  </div>

  
  

  
</div>

  <h2 id="moving-over">Moving over</h2>
<p>One of my goals for my sabbatical since last November has been upgrading my blogging infra.
This is now done.</p>
<p>I went from an old (read: Ubuntu 19 or so?) VPS running Nginx hosting static files generated by my <a href="https://github.com/crertel/zamrazac" target="_blank">Zamrazac</a> static site generator to a <a href="https://nixos.org/" target="_blank">NixOS 24.11</a> VPS running Nginx hosting static files generated by <a href="https://gohugo.io/" target="_blank">Hugo</a> with a slightly-modified <a href="https://poison.lukeorth.com/" target="_blank">Poison</a> theme (as well as self-hosted analytics via <a href="https://plausible.io/" target="_blank">Plausible</a>).</p>
<h2 id="why-move">Why move?</h2>
<p>My original goal with Zamrazac was “archival quality” blog posts in a language I enjoy. This turned the design space into:</p>
<ul>
<li>Must be implemented in Elixir</li>
<li>Must create minimal HTML files (e.g., no network traffic required to render)</li>
<li>Must embed images</li>
<li>Must keep reasonable size</li>
</ul>
<p>I managed to accomplish all of those things during my first week or two at Recurse many years ago.
I’m particularly proud of the image processing–dithering, compressing, inlining via data URLs, and finally rendering a nice sepia tone using only CSS filters.</p>
<p>Unfortunately, years later, one particular issue kept coming back. I really, really wanted better code rendering.</p>
<p>My old solution used <code>&lt;pre&gt;</code> blocks and was basically servicable, but it unfortunately lacked syntax highlighting and line numbers.</p>
<h3 id="a-brief-rant-about-syntax-highlighting">A brief rant about syntax highlighting</h3>
<p>Based on what I learned reading up on it, the basic issue with syntax highlighting is that there are several ways to do it and all of them I dislike.</p>
<p>Starting from the display and working backwards, you have a bunch of inline block elements/spans that need to be colored. You start with something simple like this…</p>
<p>…and you expect it to eventually turn into a DOM tree like…</p>
<div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>pre</span>&gt;
</span></span><span><span>    &lt;<span>span</span> <span>class</span><span>=</span><span>&#34;keyword-decl-var&#34;</span>&gt;var&lt;/<span>span</span>&gt; &lt;<span>span</span> <span>class</span><span>=</span><span>&#34;identifier-variable&#34;</span>&gt;myVar&lt;/<span>span</span>&gt;&lt;<span>span</span> <span>class</span><span>=</span><span>&#34;keyword-end-of-statement&#34;</span>&gt;;&lt;/<span>span</span>&gt;
</span></span><span><span>&lt;/<span>pre</span>&gt;
</span></span></code></pre></div><p>…or like…</p>
<div><pre tabindex="0"><code data-lang="html"><span><span>&lt;<span>pre</span>&gt;
</span></span><span><span>    &lt;<span>span</span> <span>style</span><span>=</span><span>&#34;color: #400;&#34;</span>&gt;var&lt;/<span>span</span>&gt; &lt;<span>span</span> <span>style</span><span>=</span><span>&#34;color: #bbb;&#34;</span>&gt;myVar&lt;/<span>span</span>&gt;&lt;<span>span</span> <span>style</span><span>=</span><span>&#34;#fff&#34;</span>&gt;;&lt;/<span>span</span>&gt;
</span></span><span><span>&lt;/<span>pre</span>&gt;
</span></span></code></pre></div><p>…or similar. Most any library–<a href="https://highlightjs.org/" target="_blank">highlight.js</a>, <a href="https://prismjs.com/" target="_blank">prism</a>, or even CLI tools like <a href="http://andre-simon.de/doku/highlight/en/highlight.php" target="_blank">highlight</a>–will end up doing this basic transformation, and the wiggle room is whether it’s done in the client browser, server dynamically during a request, or a preprocessing step.</p>
<p>I didn’t want to have external dependencies or large files embedding libs, I didn’t want to be re-rendering this every time (Zamrazac being a static site generator and all), and so I figured it’d be a preprocessing step.</p>
<p>So, in Elixir, the standard ansewr for this is <a href="https://www.hex.pm/packages/makeup" target="_blank">makeup</a>. This is perfectly cromulent, excepting that at the time it only really supported Elixir/Erlang/C/HTML/Diff/JSON and that cluster (since then, via <a href="https://github.com/elixir-makeup/makeup_syntect" target="_blank">makeup-syntect</a> it’s gotten better) so it wasn’t what I needed.</p>
<p>My next port of call was some kind of tool I could shell out to, highlight a blob, and patch back in its results: this is what introduced me to <code>highlight</code> above. Unforuntately, once that got figured out, I had a bear-and-a-half of a time trying to get the generated HTML spliced back in, because of the way I was trying to use Floki and Earmark. I think it <em>may</em> have gotten better, but at the time there wasn’t really any good way I could find to say “okay, remove everything below this child node, replace it with this other content, and wrap the whole thing in this other thing”.</p>
<p>So, I flipped the table and decided I’d just give up on it for a while, and sulk. Life provided many other areas of excitement, and time passed quickly.</p>
<h3 id="what-changed">What changed?</h3>
<p>I’ve been doing some fun projects like vibe-coding, Nix-adjacent stuff, learning about ML, and so forth and wanted to share that progress–unfortunately, this means that I’d need to share code.</p>
<p>Making things even more annoying, I haven’t been able to do even basic blogging because my tape-and-bailing-wire setup on my old <a href="https://www.linuxmint.com/" target="_blank">Linux Mint</a> installation fell apart once I’d migrated to NixOS. The old situation was some shell scripts calling into an Elixir project using a system-wide Elixir/Erlang install, and in the new world that’s just not how I have anything set up.</p>
<p>Between these things, wanting to write and Nix breakage and Zamrazac’s age, I figured it was time to bite the bullet and see what was out there.</p>
<h2 id="the-move">The move</h2>
<p>Hugo does a large superset of what Zamrazac did, by and large, and is written in Go and reasonably fast. Perhaps most importantly, it’s already packaged in Nixpkgs and so I don’t have to do anything particularly clever to use it. This will be easy!</p>
<h3 id="the-only-difference-between-theory-and-practice">The only difference between theory and practice…</h3>
<p>The move plan was straightforward enough:</p>
<ol>
<li>Install Hugo</li>
<li>Grab a template</li>
<li>Copy over all the blog posts and change their front matter (the metadata at the head of all their markdown files) to match what Hugo expects</li>
<li>Update my local blogging scripts</li>
<li>Copy the output of running Hugo to the VPS</li>
</ol>
<h3 id="is-that-only-in-theory-is-there-no-difference">…is that only in theory is there no difference.</h3>
<p>The plan started out well.</p>
<blockquote>
<p>Install Hugo</p></blockquote>
<p>Laughably easy, testing via <code>nix-shell -p hugo</code> and later by just adding <code>hugo</code> to my <code>configuration.nix</code>. <em>Sweet</em>.</p>
<blockquote>
<p>Grab a template</p></blockquote>
<p>Poison seemed neat, and just needed to be downloaded to my new blog root and configured with their default suggested config modulo some tweaking around paths and whatnot. <em>Awesome</em>.</p>
<blockquote>
<p>Copy over all the blog posts and change their front matter</p></blockquote>
<p>Tedious, since I was too chicken to write a script to do it for me (and Claude was proving a bit unreliable). So, okay, copy the files and build the folder structure and do it manually. Not <em>delightful</em>, but a good chance to throw <em>Do the Right Thing</em> on the second monitor while I worked.</p>
<blockquote>
<p>Update my local blogging scripts</p></blockquote>
<p>Easy enough, mostly just removing a bunch of old assumptions and then slapfighting over directory name generation. <em>Acceptable</em>.</p>
<blockquote>
<p>Copy the output of running Hugo to the VPS</p></blockquote>
<p>And <em>here</em>, dear reader, is where <a href="https://www.youtube.com/watch?v=3m5qxZm_JqM" target="_blank">the front fell off</a>.</p>
<h3 id="the-front-falls-off">The front falls off</h3>
<p>A bit of background: my VPS had been provisioned back in 2018, so it is a bit long in the tooth.
I don’t have the <code>uptime</code> for it prior to this adventure, but I’m pretty sure it was months or possibly a year or two; once upon a time, this sort of thing was considered a badge of a job well done.</p>
<p>The box itself was running Ubuntu 19 with the usual hardening steps applied and nothing interesting running but SSH and Nginx, serving files out of a static directory and occasionally phoning home to handle SSL stuff via Let’s Encrypt. It did its job, humble as that was, and that was it.</p>
<p>Fast-forward to this week, and I decide that maaaaybe I should at least update the system. I run the usual incantation of <code>sudo apt-get update</code> and wouldn’t you know but all the sources have EOL’ed on me. There will be no updating this box.</p>
<p>I have nothing but free time on my hands, and so I decide to myself “Why not <del>zoidberg</del>NixOS?” I’ve moved nearly all my other boxen over a while ago, and this is one of the holdouts.</p>
<p>I first tried <a href="https://nixos.org/manual/nixos/stable/index.html#sec-installing-from-other-distro" target="_blank">lustrating</a>, and was unable to get that to work after a couple of hours. So, I instead decided to do a fresh install.</p>
<p>My hosting provider <a href="https://tornadovps.com/" target="_blank">TornadoVPS</a> is a bit spartan in amenities, but does provide a netboot installer so the sufficiently masochistic can do this. Because Reasons, the access provided to your box is a management console via SSH that internally hooks to the serial port (I believe) of the VPS VM. To do what I needed to do, I’d need to:</p>
<ol>
<li>Open up the management console</li>
<li>Load the latest-provided NixOS image (24.05, not great not terrible)</li>
<li>Restart the VM and attach</li>
<li>Install NixOS after zorching the disk</li>
<li>Setup Nginx</li>
</ol>
<p>All of that was pretty straightforward, except that I couldn’t get the damned installer to actually…install. I attempted to follow the <a href="https://nixos.org/manual/nixos/stable/#sec-installation" target="_blank">instructions</a> but I ended up repeatedly screwing up the bootloader and possibly partitioning–note that the GUI installer is fine, but I had to do this via the terminal because of the aforementioned serial port access.</p>
<p>Anyways, at this point I’d kvetched sufficiently that one of my friends reminded me we not only already had a documented process for this but also that same runbook contained some handy default settings and configurations. I cracked that open and after a little bit of time had a functioning NixOS VM! Huzzah!</p>
<p>Except…well, I couldn’t log in. I’d dutifully copied over and kept my password during installation, but alas it wouldn’t work. The standard Linux terminal login screen kept failing after I put in my username and then password.</p>
<p>I assumed I’d made a mistake and redid the entire process–thrice!–and eventually got fed-up enough to try pasting in the password to the liveboot environment. Aha, the answer was obvious: the password contained a bunch of additiaonl garbage. There was something wrong in the character bucket brigade between my scratchpad, my clipboard, my temrinal, SSH, their serial console, and the VM.</p>
<p>Manually keying the password in and lo and behold everything was fine.</p>
<h3 id="wrapping-up-the-move">Wrapping up the move</h3>
<p>The files got copied over, I fought with permissions a bit to make sure Nginx could get at the files and <em>I</em> could upload and update them easily, and I bodged together a decent deploy script with <code>rsync</code> instead of my old, derpy <code>scp</code>. Great success.</p>
<p>I discovered that it all worked, and then set about configuring and setting up Plausible, which was again very easy <a href="https://nixos.org/manual/nixos/stable/#module-services-plausible" target="_blank">on NixOS</a>.</p>
<p>I also discovered that my images were all broken (surprise) and so with a bit of Claude learned to make a <a href="https://gohugo.io/content-management/shortcodes/#highlight" target="_blank">Hugo shortcode</a> that would reproduce most of the old Zamrazac functionality:</p>
<pre tabindex="0"><code>{{/* layouts/shortcodes/smart-image.html */}}
{{ $src := .Get &#34;src&#34; }}
{{ $alt := .Get &#34;alt&#34; | default &#34;&#34; }}
{{ $width := .Get &#34;width&#34; | default &#34;800&#34; }}
{{ $quality := .Get &#34;quality&#34; | default &#34;80&#34; }}
{{ $class := .Get &#34;class&#34; | default &#34;&#34; }}

{{ $isRemote := or (hasPrefix $src &#34;http://&#34;) (hasPrefix $src &#34;https://&#34;) }}
{{ $image := &#34;&#34; }}

{{ if $isRemote }}
    {{ $image = resources.GetRemote $src }}
{{ else }}
    {{ $image = $.Page.Resources.Get $src }}
{{ end }}

{{ if $image }}
    {{ $opts := dict &#34;method&#34; &#34;Atkinson&#34; &#34;colors&#34; (slice &#34;#F5E8C8&#34; &#34;#D0B27A&#34; &#34;#A67F46&#34; &#34;#664A2B&#34;) }}
    {{ $processed := $image.Resize (printf &#34;%sx q%s&#34; $width $quality) | images.Filter (images.Grayscale) | images.Filter
    (images.Dither $opts)
    }}

    &lt;figure class=&#34;{{ $class }}&#34;&gt;
        {{ if $isRemote }}
        &lt;a target=&#34;_blank&#34; href=&#34;{{$src}}&#34;&gt;
            {{else}}
            &lt;a target=&#34;_blank&#34; href=&#34;{{$image.RelPermalink}}&#34;&gt;
                {{ end }}
                &lt;img src=&#34;{{ $processed.RelPermalink }}&#34; width=&#34;{{ $width }}&#34; alt=&#34;{{ $alt }}&#34; loading=&#34;lazy&#34;&gt;
                {{ with .Get &#34;caption&#34; }}&lt;figcaption&gt;{{ . }}&lt;/figcaption&gt;{{ end }}
            &lt;/a&gt;
    &lt;/figure&gt;
{{ else }}
    {{ if $isRemote }}
        &lt;!-- Fallback for remote images that can&#39;t be processed --&gt;
        &lt;figure class=&#34;{{ $class }}&#34;&gt;
            &lt;img src=&#34;{{ $src }}&#34; width=&#34;{{ $width }}&#34; alt=&#34;{{ $alt }}&#34; loading=&#34;lazy&#34;&gt;
            {{ with .Get &#34;caption&#34; }}&lt;figcaption&gt;{{ . }}&lt;/figcaption&gt;{{ end }}
        &lt;/figure&gt;
    {{ else }}
        &lt;div class=&#34;error&#34;&gt;Image not found: {{ $src }}&lt;/div&gt;
    {{ end }}
{{ end }}
</code></pre><p>It’s not perfect, but it works!</p>
<h2 id="on-to-blogging">On to blogging!</h2>
<p><a href="https://www.youtube.com/watch?v=ixnv986R9Qk" target="_blank">At last, my arm is complete again</a>.</p>
<p>My next steps will be tidying up and copying over my ML notes to date, and probably dusting off the old cobwebs by writing about the things I learned as engineering management and leadership over the last four years. I think I’ll also be playing around with the shortcodes more to make little callout boxes and personas like I’ve seen in other blogs that I liked–good artists copy, great artists steal, etc.</p>
<p>So long for now!</p>

  
  <hr/>


  
</div>
            </div></div>
  </body>
</html>
