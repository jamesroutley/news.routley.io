<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mayer.cool/writings/pavlovs-half-marathon/index.html">Original</a>
    <h1>Training myself to run farther with Strava&#39;s API and an IoT dog feeder of M&amp;Ms</h1>
    
    <div id="readability-page-1" class="page">


<h2>TLDR</h2>
<p>I bought an IOT dog food dispenser, filled it with M&amp;Ms, and made a script checks the Strava API to see if I ran a sufficient distance. If I did, I got a reward like the good boy I was.</p>
<p>This ended up being far and away the most effective running program I have ever implemented for myself. I now run long distances regularly, recently completed a half marathon (13.1 miles), and don&#39;t even use the M&amp;M dispenser anymore. Kind of like how your dog still sits even though you don&#39;t give him a treat for doing so anymore!</p>
<video width="100%" controls="">
  <source src="./explainer.mp4#t=0.001" type="video/mp4"/>
  Your browser does not support the video tag.
</video>
<h2>Why</h2>
<p>Recently, I have accepted that I have become an adult. My adulthood litmus test has always been the following:</p>
<blockquote>
<p><em>If you know what date it is every day, you are an adult.</em></p>
</blockquote>
<p>Well, turns out this is wrong. I now know that what being an adult <em>really</em> means is that most of your time is taken up by an ever-growing list of compulsory maintenance tasks that constitute the meager amount of contol you exert over your own life. And I <em>still</em> don&#39;t even know what the date is! Turns out that was merely my justification for being a terrible planner and meeting attender - *child at heart*!</p>
<p>Part of understanding that I am now an adult meant readjusting what it means to exercise. I love going to the gym and spending a long time there, but I found myself doing it less and less, mostly because big blocks of time stopped presenting themselves to me. Running is like a goldfish, though. It will grow to the size of its bowl, plus it was always right outside my doorstep. So it was time to become a runner.</p>
<p>The problem is that I have a love-hate relationship with running. I used to be a fat kid, and I changed that the summer before going to college by running along the streetcar track every day in New Orleans&#39;s balmy 100-degree, 100% humidity days at noon. It was the most successful weight loss regimine I ever had, and I&#39;m happy to say I&#39;ve never needed another one like it. That said, it did not instill a fondness for running in me. I still can&#39;t listen to my 2014 running playlist without feeling mildly heat struck.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IGgBWghFgZQ" title="YouTube video player" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="origin-when-cross-origin" allowfullscreen=""></iframe>
<p>This is the sound of me never wearing cargo shorts again.</p>
<p>I knew I had to do something different this time. Running was no longer a means to and end, I needed it to be a sustainable part of my life. Thankfully, I knew just the solution for how to acclimate myself.</p>
<p>I used to work as a Zoo. Zoo keepers and vets have to get animals of varying intelligence (Giraffes are like a house for sale - the lights are on but nobody&#39;s home) to move certain places and do certain things, like stay on a scale to get weighed. They did this by target training the animals.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ylYwif3it1Y" title="YouTube video player" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="origin-when-cross-origin" allowfullscreen=""></iframe>
<p>You can get animals to do basic things like touch their nose to a target if they know they will get food after doing it. This is due to the proven principles of classical conditioning, whereby you can get an animal to associate neutral stimuli (the wand) with a desired response (touch nose to wand) by rewarding them with positive reinforcement (food) every time they do the desired response.</p>
<p>Before long, as soon as you show them the stick, they will touch their nose to it due to the positive association. Well, what am I but another food-motivated, dumb animal? It was time to associate running long distances with treats and get myself conditioned!</p>
<h2>How</h2>
<h3>The feeder</h3>
<p>I knew I had to get a food dispenser that I could control with Python, so I sought out to find the shittiest, most cheaply made looking IOT dog food dispenser on Amazon. My rationale was that it would have the worst security around whatever protocol it used to trigger the feeding, so I could easily capture and replay the feed command. I landed on <a href="https://www.amazon.com/dp/B0CQL2KH7R?ref=ppx_yo2ov_dt_b_fed_asin_title&amp;th=1">this one</a> because I could see the app in the photo and boy did it look like the right vibe:</p>
<p><img src="https://www.mayer.cool/writings/pavlovs-half-marathon/app.png" alt="app"/></p>
<p>Turns out, I didn&#39;t have to do any reverse engineering or MitM traffic at all! This dog feeder happened to be part of the &#34;Smart Life&#34; ecosystem. Smart Life is an offshoot of <a href="https://www.tuya.com/">Tuya</a>, a smart home product company with a fair amount of developer support! Setting up programmatic access with it was super easy, mostly thanks to the hard work of the maintainers of <a href="https://github.com/jasonacox/tinytuya">tinytuya</a>.</p>
<h3>tinytuya</h3>
<p><a href="https://github.com/jasonacox/tinytuya">tinytuya</a> is a Python module designed to allow programtic control of Tuya devices via Python. The UX of this Python module is incredible. There is a mildly convoluted setup process you need to go through to get you device&#39;s &#34;secret key&#34; to allow for the use of tinytuya, but the documentation is verbose and easy to follow, and the module even comes with a <a href="https://github.com/jasonacox/tinytuya?tab=readme-ov-file#setup-wizard---getting-local-keys">setup wizard</a> that will scan your local net to find any Tuya devices. Once everything was set up, I could dispense food at will using the following script:</p>
<pre><code>import tinytuya

# Connect to Tuya Cloud
c = tinytuya.Cloud(
        apiRegion=&#34;us&#34;, 
        apiKey=&#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;, 
        apiSecret=&#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;, 
        apiDeviceID=&#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;)

# Display list of devices
devices = c.getdevices()
print(&#34;Device List: %r&#34; % devices)

# Select a Device ID to Test
id = &#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;

# Display Properties of Device
result = c.getproperties(id)
print(&#34;Properties of device:\n&#34;, result)

# Display Status of Device
result = c.getstatus(id)
print(&#34;Status of device:\n&#34;, result)

# Send Command - Dog Food!
commands = {
    &#34;commands&#34;: [
        {&#34;code&#34;: &#34;manual_feed&#34;, &#34;value&#34;: 1},
    ]
}
print(&#34;Sending command...&#34;)
result = c.sendcommand(id,commands)
print(&#34;Results\n:&#34;, result)
</code></pre>
<p>Note that this goes through their cloud service, which means you have to have this device connected to the internet which I know skeeves some folks out. If you wanted to have this thing completely isolated though, you could have a no-outbound-internet subnet with this device on it so long as the device you are going to run the script on has line-of-sight.</p>
<p>You can do this because Tuya devices have a local-only protocol that tinytuya supports, so you can send commands just within your LAN. This is what I ended up using for my final application (see next section), but I also didn&#39;t take any precaution with walling off the dog feeder. If it port scanned my house at some point and shipped the data somewhere, so be it.</p>
<h3>Strava</h3>
<p>The Strava API is also quite friendly - I used <a href="https://github.com/stravalib/stravalib">stravalib</a> to interface with it. One hangup with Strava is that it only allows for authentication via oauth, with tokens that only last 6 hours once minted. This means that instead of having a little script that held an API token to hit the Strava API, I had to make a minimal webserver to both redirect to the oauth page and catch the auth code after successful authentication. This ended up being pretty nice though because it meant that I could run the program from my phone!</p>
<p>There was also a bit of legwork <a href="https://medium.com/analytics-vidhya/accessing-user-data-via-the-strava-api-using-stravalib-d5bee7fdde17">setting up an &#34;application&#34; with Strava</a> to be able to hit the API.</p>
<p>In the end, the Python code relevant to Strava looked like this. The domain you see referenced, <code>food.mayer.cool</code> just points to a local IP I assigned to my flask server. I believe this can just be a local IP or localhost, I made an A record in namecheap so I could remember it and type it into my phone easily.</p>
<pre><code>import flask
from stravalib import unithelper
from stravalib.client import Client

client = Client()  
app = flask.Flask(__name__)

# Start the oauth flow
@app.route(&#34;/start&#34;)
def start():
    authorize_url = client.authorization_url(
        client_id=XXXXXX, redirect_uri=&#34;http://food.mayer.cool:8282/authorized&#34;
    )
    return flask.redirect(authorize_url)

# Catch the oauth flow and print data about the most recent run
@app.route(&#34;/authorized&#34;)
def authorized():
    # Have the user click the authorization URL, a &#39;code&#39; param will be added to the redirect_uri
    # .....
    code = flask.request.args.get(&#34;code&#34;)
    
    token_response = client.exchange_code_for_token(
        client_id=XXXXXX, client_secret=&#34;XXXXXXXXXXXXXXXXXXXXX&#34;, code=code
    )
    # Pull out auth material
    access_token = token_response[&#34;access_token&#34;]
    refresh_token = token_response[&#34;refresh_token&#34;]
    expires_at = token_response[&#34;expires_at&#34;]

    # Set auth material in the client
    client.access_token = access_token
    client.refresh_token = refresh_token
    client.token_expires_at = expires_at

    # Get my data
    athlete = client.get_athlete()
    most_recent = next(client.get_activities(limit=1))

    # use unithelper to convert distance to miles
    print(f&#34;Miles ran: {unithelper.miles(most_recent.distance)}&#34;)
</code></pre>
<h3>Final script</h3>
<p>Gluing the two pieces together, I could set how long I needed to run (I hardcoded it and changed it as I progressed), check Strava, and dispense a treat for myself. I used pickled data to keep track of when I last ran to ensure that I only got one set of M&amp;Ms per run.</p>
<p>My complete script ended up looking like this:</p>
<pre><code>import datetime
import flask
import json
import pickle
import requests
import tinytuya
from stravalib import unithelper
from stravalib.client import Client

client = Client()  
app = flask.Flask(__name__)

@app.route(&#34;/authorized&#34;)
def authorized():
    # Have the user click the authorization URL, a &#39;code&#39; param will be added to the redirect_uri
    # .....
    code = flask.request.args.get(&#34;code&#34;)

    token_response = client.exchange_code_for_token(
        client_id=XXXXX, client_secret=&#34;XXXXXXXXXXXXXXXXXX&#34;, code=code
    )
    # Pull out auth material
    access_token = token_response[&#34;access_token&#34;]
    refresh_token = token_response[&#34;refresh_token&#34;]
    expires_at = token_response[&#34;expires_at&#34;]

    # Set auth material in the client
    client.access_token = access_token
    client.refresh_token = refresh_token
    client.token_expires_at = expires_at

    # Get my data
    athlete = client.get_athlete()
    most_recent = next(client.get_activities(limit=1))

    # Check distance
    distance = 4
    if unithelper.miles(most_recent.distance).magnitude &lt; distance:
        return f&#34;You need to run at least {distance} miles to deserve a treat!&#34;

    # Check pickle file to see if we&#39;ve already fed for this run
    try:
        with open(&#39;last_run_time.pkl&#39;, &#39;rb&#39;) as f:
            last_run_time = pickle.load(f)
    except FileNotFoundError:
        last_run_time = datetime.datetime(1900, 7, 28, 19, 7, 56, tzinfo=datetime.timezone.utc)

    if most_recent.start_date &lt;= last_run_time:
        return &#34;You&#39;ve already been fed for this run!&#34;

    # connect to the device locally
    d = tinytuya.Device(&#39;XXXXXXXXXXX&#39;, &#39;192.168.1.XXX&#39;, &#39;XXXXXXXXXXXX&#39;, version=3.4)
    data = d.status()  

    # Show status and state of first controlled switch on device
    print(&#39;Dictionary %r&#39; % data)

    # Locally we can just set the oid 3 to a value of 1, which will dispence one round of M&amp;Ms
    d.set_value(3,1)

    # Save current time as pickle file
    with open(&#39;last_run_time.pkl&#39;, &#39;wb&#39;) as f:
        pickle.dump(most_recent.start_date, f)


    return &#34;Authorization successful&#34;

@app.route(&#34;/start&#34;)
def start():
    authorize_url = client.authorization_url(
        client_id=119442, redirect_uri=&#34;http://food.mayer.cool:8282/authorized&#34;
    )
    return flask.redirect(authorize_url)


if __name__ == &#34;__main__&#34;:
    print(&#34;Starting server...&#34;)
    print(&#34;Go to http://food.mayer.cool:8282/start to begin the authorization process&#34;)
    app.run(host=&#34;0.0.0.0&#34;, port=8282)

</code></pre>
<p>And there you have it! Your very own treat dispenser. This same flow could be used to track and reward progress on all sorts of stuff, not just run distance. Budgeting, git commits, you name it. Anything with a digital form of tracking and can give immediate feedback for can be &#34;trained&#34; in the same way!</p>
<h2>Efficacy</h2>
<p>Ok, I know what you are thinking: &#34;This is so stupid, why didn&#39;t Dan just open up the top of the feeder, or go buy M&amp;Ms when he wanted them? Isn&#39;t human free will more powerful than being trained like a dog?&#34;</p>
<p>And I think that obviously this will depend on the person, but for me personally, the answer is no. Bare with me as I get a little bit philosphical. Here are my thoughts on this after living with it for a few months:</p>
<h3>We are creatures of habit</h3>
<p>This one is pretty basic and I can only speak for myself, but I mostly do the same stuff every day. &#34;Free will&#34; doesn&#39;t factor into quotidian life much, the &#34;decisions&#34; you make are much more subtle and implicit - you don&#39;t think about opening up your phone when you are bored, you just do. That was my goal with running - I wanted it to become something I just do.</p>
<p>I don&#39;t usually keep M&amp;Ms in the house and am not in the habit of eating them, so I didn&#39;t feel a deep urge to &#34;cheat&#34;. I instead was building a completely new habit where I ate M&amp;Ms after achieving a goal. The wires never got crossed in my brain where the M&amp;Ms became the goal, they became a small positive association, but that was it. Having a small positive association was all the difference though. See point 2:</p>
<h3>My brain&#39;s cost-benefit analysis is fried</h3>
<p>The world is designed to lure us into forming bad habits. Food companies, entertainment companies, brokerages, and just about everything else at this point has been hyper-optimized to form positive associations in our animal brain with consumption. This is a tough system to live in, because our aspirations are usually more nebulous than &#34;feel good&#34;, which is what the products promise us.</p>
<p>Our aspirations do not easily produce positive associations that immediately form. In the case of running, when I tell myself I want to run, it is because I want to stay healthy, minimize my chances of chronic pain, and have a more sustainable, balanced life. None of those things give me immediate gratification the same way I would have if I sat down and played a very stimulating video game instead of running.</p>
<p>Does that mean that I actually want to play an hour of Magic: The Gathering Arena instead of running? No. It just means that the designers of free-to-play games now have 30+ years of research backing up how to make their game feel as good as possible to play, and how to deliver immediate positive feedback when I play it to keep me coming back.</p>
<p>Running is a much simpler activity, and no one is engineering it to make me feel like I am having a good time when I engage with it - in fact I usually actively feel neutral to bad. So when my brain is making one of those subtle, implicit decisions it doesn&#39;t see a lot of benefit from going running. Running is going to be hard, and it is unclear what I will really get out of it. Arena is easy to access, and I will get a bunch of dopamine hits while playing! Multiply this dilemma by every decision we make day-to-day, and you see why so many folks have developed bad habits. It is an unfair fight. Our aspirations hardly stand a chance.</p>
<p>Attaching a small, mostly symbolic reward to achieving my goals helped me level the playing field. After setting up the dispenser, when my brain weighed those options, running still looked hard, but there was also a small concrete dopamine hit associated with it. Achieving my goals <em>is what I wanted deep down</em>, and it was now easier to convince my animal brain that it was in its best interest too.</p>
<p>The best part is, after you have trained your dog to sit, he will still sit long after your stop feeding him treats. It appears I am no different. I have stopped using the M&amp;M dispenser, but I am still running regularly.</p>
<h3>Results</h3>
<p>Here are the runs I tracked with Strava over the course of this experiment:</p>

  
<p>I don&#39;t think that I ever set the M&amp;M payout distance to be more that 4 miles, which definitely shows in the data. There were plenty of days that I didn&#39;t feel great, and pushed to get to the distance limit and stopped - some may see this is bad but for me it was exactly what I needed! And as I did that more, It became apparent that once you reach a certain level of physical conditioning, running longer distances is more gated by joints, feet, and time than endurance.</p>
<p>More than anything else, I was gated by time on my long runs, which if you recall, is why I started this whole thing in the first place. It is difficult to find a free 3 hours to warm up, run, and then cool down, stretch, and so on. So you can see I mostly ran at the 3-4 mile range with a few longer runs, and then on the weekends started ramping up distance. My half marathon run did really tear up my feet though, and I have been taking it relatively easy since then, back down in the 3-4 range.</p>
<h2>What&#39;s next</h2>
<p>Since this whole quest is more to keep me healthy and in the habit than reaching any particular goal, I don&#39;t foresee myself doing super long runs in the future, instead keeping in the 6-8 range for long runs and trying to work on speed. I average around a 9 minute mile right now and would like to get that lower. I also now feel pretty habituated, which means it is time to classically condition myself to do something else. I am thinking that working on side projects more frequently, or keeping with learning a new skill will be great applications.</p>
<p>I hope this makes you think more about how you could incentivize yourself to achieve your goals, and combat all the forces at work trying to steal away your time and attention.</p>
<p>Speaking of which, I have no advertising or analytics on my website (besides whatever the embeds bring in for themselves), so it would mean a lot if you <a href="https://users3.smartgb.com/g/g.php?a=s&amp;i=g36-36443-57">signed my guestbook</a> if you enjoyed the reading! Thanks for stopping by.</p>


<div id="webrings">
    <div>
        
        <p><a href="https://webring.recurse.com"><img src="https://www.mayer.cool/recurse.png" width="30" alt="Recurse Center Webring"/></a>
            <a href="https://webring.xxiivv.com/#mayer" target="_blank" rel="noopener">
                <img src="https://webring.xxiivv.com/icon.black.svg" width="30" alt="XXIIVV webring"/>
              </a>
        </p>
    </div>
</div>
</div>
  </body>
</html>
