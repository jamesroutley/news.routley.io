<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://unifiedpush.org/news/20250131_push_for_decentralized/">Original</a>
    <h1>Push Notifications for Decentralized Services</h1>
    
    <div id="readability-page-1" class="page"><div>
          
  


  










  <article>
    
    <p><em>How mobile push notifications currently bring centralization to decentralized services, and how we can avoid it, even for mainstream configurations.</em></p>
<blockquote>
<p>Published the 31/01/2025</p>
<p>This post will focus on Android.</p>
</blockquote>
<p>We all know <em>decentralized</em> applications: emails, Mastodon (and the Fediverse), Nextcloud and other clouds, Git servers, Messaging services like XMPP or Matrix, Feed reader (RSS), some calendars, etc.</p>
<p>They are <em>decentralized</em> because they don’t rely on a single server, own by a single entity. They can be installed by different persons or organizations, on different servers. Mobile applications for these services usually ask the users what server they want to use, before interacting with the service.</p>
<p><em>Push notifications</em> refer to a mechanism used by servers to inform (mobile) clients of real-time updates. Without push notifications, clients must either periodically request updates from the server, or maintain a connection with their server, which can lead to increased data usage and battery drain.</p>
<div>
    <h2 id="how-it-usually-work-how-it-is-recommended-by-google">
        How it usually work, how it is recommended by Google
    </h2>
    <a data-clipboard-text="https://unifiedpush.org/news/20250131_push_for_decentralized/#how-it-usually-work-how-it-is-recommended-by-google" title="Anchor to: How it usually work, how it is recommended by Google" aria-label="Anchor to: How it usually work, how it is recommended by Google" href="#how-it-usually-work-how-it-is-recommended-by-google">
        <svg><use xlink:href="#gdoc_link"></use></svg>
    </a>
</div>
<p>When Android application developers want to add support for push notifications, they usually go for <em>Firebase Cloud Messaging</em> (FCM), the solution provided by Google.</p>
<p>The <a href="https://firebase.google.com/docs/cloud-messaging/android/client">guide provided by firebase</a> explain the different steps for you to support their solution:</p>
<ul>
<li>You first need to go on the Firebase Console, create a new project and add your application to this project.</li>
</ul>
<details><summary><small>You are also <i>strongly</i> recommended to enable analytics for your project.</small></summary>
<p><img src="https://pjg1.site/blog/20250131_push_for_decentralized/enable_analytics.png" alt="&amp;ldquo;Note from the website: For an optimal experience with FCM, we strongly recommend enabling Google Analytics in your project. Google Analytics is a requirement for FCM&amp;rsquo;s message delivery reporting.&amp;rdquo;"/></p>
<p><em>Google strongly recommend enabling their Analytics</em></p>
</details>
<ul>
<li>Then you will need to download a file (json) containing your firebase project information and add it to your application sources.</li>
<li>Add <em>firebase-messaging</em> to your application, the library that will register to the Google Services on the device (if present).</li>
<li>Then find out where you can create a new service account for FCM and generate its keys. Most of the time, <strong>these keys are considered sensitive, you must ensure to keep them secret. So you must not share them.</strong>*</li>
</ul>
<p><em>* There might be solutions to generate keys that can be public but it seems easy to mess with this configuration.</em></p>
<p>When your application server is centralized, you implement the FCM API, and save these keys with your configuration. When you want to inform users about an update, your server will request Google servers with these credentials.</p>
<p>This solution works only for users with Google Services. This is the case for most users but the ones without these services (because Google, or Internet isn’t accessible or because users choose to not install them), you may need another solution, a fallback.</p>
<div>
    <h2 id="what-it-means-for-mobile-applications-for-decentralized-and-self-hostable-services">
        What it means for mobile applications for decentralized and self-hostable services
    </h2>
    <a data-clipboard-text="https://unifiedpush.org/news/20250131_push_for_decentralized/#what-it-means-for-mobile-applications-for-decentralized-and-self-hostable-services" title="Anchor to: What it means for mobile applications for decentralized and self-hostable services" aria-label="Anchor to: What it means for mobile applications for decentralized and self-hostable services" href="#what-it-means-for-mobile-applications-for-decentralized-and-self-hostable-services">
        <svg><use xlink:href="#gdoc_link"></use></svg>
    </a>
</div>
<p>Developers of decentralized services have responded to this expectation of a centralized architecture with <em>gateways</em>:</p>
<ul>
<li>The project hosts on a centralized server a service that will “translate” requests from the different servers to Google servers.</li>
<li>The application server implement their own protocol or follows the standard webpush specifications (RFC8030 + RFC8291 + RFC8292).</li>
<li>When the server wants to inform the users, it pushes a message with this protocol to the gateway. The gateway knows the Google keys for the application and uses that secret to push to Google servers.</li>
</ul>
<p>For example:</p>
<ul>
<li>Element uses a <a href="https://github.com/matrix-org/sygnal">sygnal</a> server hosted at <a href="https://matrix.org/">https://matrix.org/</a>.</li>
<li>Mastodon uses a <a href="https://github.com/mastodon/webpush-fcm-relay">webpush-fcm-relay</a> server hosted at <a href="https://app.joinmastodon.org/">https://app.joinmastodon.org/</a>.</li>
<li>Nextcloud applications use a push proxy (<a href="https://github.com/nextcloud/notifications/blob/master/docs/push-v2.md">documented here</a>) server hosted at <a href="https://push-notifications.nextcloud.com">https://push-notifications.nextcloud.com</a>.</li>
</ul>
<img alt="A screenshot of the matrix push gateway specifications: the Matrix homeserver sends a message to the Push Gateway that forward to the Push Provider" src="https://pjg1.site/blog/20250131_push_for_decentralized/matrix_push_gateway_specification.png"/>
<p><em>The Push gateway is under the (mobile) app developer responsibility</em></p>
<p><strong>In other words, the applications of decentralized services often respond to this problem by reintroducing a certain centralization.</strong> And this still doesn’t solve problems when Google or the Internet is not accessible, or when the user hasn’t installed Google services.</p>
<p>Another often adopted solution is to periodically fetch new events with the server, or to maintain a constant connection to the server. The first solution is good for an application that does not need “real-time” events. And the second can be adapted for the applications that we use intensively, if the use of data and energy for this connection is negligible compared to the basic use of the application. Maintaining a connection can also be very expensive for applications which have not been developed with this use in account. What often happens when the project implements them as a <em>best effort</em> for a small user base.</p>
<p>There is of course the solution of UnifiedPush, that uses webpush specifications, which is decentralized by default and can do authorization controls using the standard VAPID, based an asymmetric encryption.</p>
<p>But as the majority of users rely on Google services, this is understandable that projects target these users first. Some mobile app project have chosen to rely uniquely on UnifiedPush, to simplify things and because users with Google services can install <a href="https://pjg1.site/users/distributors/fcm/">gCompat-UP</a> to bring UnifiedPush support to these services.</p>
<p>Obviously, we know that everybody won’t migrate from a day to the next to UnifiedPush, and we don’t want to force everybody to migrate. But users should be free to use the services of their choice.</p>
<div>
    <h2 id="webpush-to-google-services">
        Webpush to google services
    </h2>
    <a data-clipboard-text="https://unifiedpush.org/news/20250131_push_for_decentralized/#webpush-to-google-services" title="Anchor to: Webpush to google services" aria-label="Anchor to: Webpush to google services" href="#webpush-to-google-services">
        <svg><use xlink:href="#gdoc_link"></use></svg>
    </a>
</div>
<p>What is less known, and not (well?) documented by Google, is that <strong>you can directly send webpush requests to FCM servers</strong>.</p>
<p>If your application server support Webpush* with VAPID, you can get rid of push gateways. And this can be done by supporting UnifiedPush in the same way:</p>
<p><a href="https://pjg1.site/kdoc/embedded_fcm_distributor/">embedded-fcm-distributor</a> is a library that will register to Google services for webpush registrations, authenticated with VAPID key. It gives support for UnifiedPush to users with Google Services.</p>
<p>To use it, you follow the UnifiedPush main setup. A quick summarize:</p>
<p>You first implement the push service:</p>
<div><pre tabindex="0"><code data-lang="kotlin"><span><span><span>class</span> <span>PushServiceImpl</span> <span>:</span> <span>PushService</span><span>()</span> <span>{</span>
</span></span><span><span>  <span>override</span> <span>fun</span> <span>onMessage</span><span>(</span><span>message</span><span>:</span> <span>PushMessage</span><span>,</span> <span>instance</span><span>:</span> <span>String</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>processMessage</span><span>(</span><span>PushMessage</span><span>.</span><span>content</span><span>)</span>
</span></span><span><span>  <span>}</span>
</span></span><span><span>
</span></span><span><span>  <span>override</span> <span>fun</span> <span>onNewEndpoint</span><span>(</span><span>endpoint</span><span>:</span> <span>PushEndpoint</span><span>,</span> <span>instance</span><span>:</span> <span>String</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>sendEndpointToServer</span><span>(</span><span>endpoint</span><span>)</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>  <span>override</span> <span>fun</span> <span>onUnregistered</span><span>(</span><span>instance</span><span>:</span> <span>String</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>sendEndpointToServer</span><span>(</span><span>null</span><span>)</span>
</span></span><span><span>  <span>}</span>
</span></span><span><span>
</span></span><span><span>  <span>override</span> <span>fun</span> <span>onRegistrationFailed</span><span>(</span><span>reason</span><span>:</span> <span>FailedReason</span><span>,</span> <span>instance</span><span>:</span> <span>String</span><span>)</span> <span>{</span>
</span></span><span><span>    <span>processFail</span><span>(</span><span>reason</span><span>)</span>
</span></span><span><span>  <span>}</span>
</span></span></code></pre></div><p>And subscribe with the server VAPID public key:</p>
<div><pre tabindex="0"><code data-lang="kotlin"><span><span>  <span>UnifiedPush</span><span>.</span><span>tryUseCurrentOrDefaultDistributor</span><span>(</span><span>context</span><span>)</span> <span>{</span> <span>success</span> <span>-&gt;</span>
</span></span><span><span>    <span>if</span> <span>(</span><span>success</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>UnifiedPush</span><span>.</span><span>register</span><span>(</span><span>context</span><span>,</span> <span>messageForDistributor</span><span>,</span> <span>vapid</span><span>)</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>  <span>}</span>
</span></span></code></pre></div><p>It will call the service <code>onNewEndpoint</code>. Details for the main setup are provided in the <a href="https://pjg1.site/kdoc/connector">library documentation</a>.</p>
<p>Note that it is also possible to upload your VAPID keys on the Firebase Console, if you use a centralized application and want to pushes with Webpush. But <strong>being able to register a VAPID pubkey retrieved during execution is not possible with the <em>firebase-messaging</em> library.</strong></p>
<p>* The published version of the standard. There are some applications that rely on a draft of the specifications.</p>
<div>
    <h2 id="-webpush-everywhere-">
        🌈 Webpush everywhere 🌈
    </h2>
    <a data-clipboard-text="https://unifiedpush.org/news/20250131_push_for_decentralized/#-webpush-everywhere-" title="Anchor to: 🌈 Webpush everywhere 🌈" aria-label="Anchor to: 🌈 Webpush everywhere 🌈" href="#-webpush-everywhere-">
        <svg><use xlink:href="#gdoc_link"></use></svg>
    </a>
</div>
<p>This gives another reason to embrace the standards and implement webpush (and UnifiedPush) !</p>
<p>Mastodon 4.4 will <a href="https://github.com/mastodon/mastodon/pull/33528#issuecomment-2589468275">follow the standard webpush specifications</a>. JMAP is an email standard that support webpush, we can have <a href="https://datatracker.ietf.org/doc/draft-gougeon-imap-webpush/">an RFC to add webpush support to IMAP</a>. A proposal to <a href="https://github.com/matrix-org/matrix-spec-proposals/pull/4174">add webpush to Matrix specifications</a> is opened.</p>
<p>We are looking for other decentralized, and centralized, services to support it too. Maybe we’ll lose these gateways one day.</p>
<p>Regarding iOS, they have made some progress in adopting webpush, but it does not seem possible to push for mobile applications with it yet.</p>

  </article>



          
          
          
          
        </div></div>
  </body>
</html>
