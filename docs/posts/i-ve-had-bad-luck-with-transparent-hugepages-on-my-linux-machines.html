<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/TransparentHugepagesBadLuck">Original</a>
    <h1>I&#39;ve had bad luck with transparent hugepages on my Linux machines</h1>
    
    <div id="readability-page-1" class="page"><div><h2>I&#39;ve had bad luck with transparent hugepages on my Linux machines</h2>

	<p><small>January 31, 2023</small></p>
</div><div><p>Normally, pages of virtual memory are a relatively small size, such
as 4 Kbytes. <a href="https://wiki.debian.org/Hugepages">Hugepages</a> (<a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt">also</a>) are
a CPU and Linux kernel feature which allows programs to selectively
have much larger pages, which generally improves their performance.
<a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/transhuge.html">Transparent hugepage support</a> is
an additional Linux kernel feature where programs can be more or
less transparently set up with hugepages if it looks like this will
be useful for them. This sounds good but <a href="https://mastodon.social/@cks/109752064557651589">generally I haven&#39;t had
the best of luck with them</a>:</p>

<blockquote><p>It appears to have been &#39;0&#39; days since Linux kernel (transparent)
hugepages have dragged one of my systems into the mud for mysterious
reasons. Is my memory too fragmented? Who knows, all I can really do
is turn hugepages off.</p>

<p>(Yes they have some performance benefit when they work, but they&#39;re
having a major performance issue now.)</p>
</blockquote>

<p>This time around, the symptom was that Go&#39;s self-tests were timing
out while I was trying to build it (or in some runs, the build
itself would stall). While this was going on, top said that the
&#39;<code>khugepaged</code>&#39; kernel daemon process was constantly running (on
a single CPU).</p>

<p>(I&#39;m fairly sure I&#39;ve seen this sort of &#39;khugepaged at 100%
and things stalling&#39; behavior before, partly because when I
saw top I immediately assumed THP were the problem, but I can&#39;t
remember details.)</p>

<p>One of the issues that can cause problems with hugepages is that
to have huge pages, you need huge areas of contiguous RAM. These
aren&#39;t always available, and not having them is <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/DecodingPageAllocFailures">one of the reasons
for kernel page allocation failures</a>.
To get these areas of contiguous RAM, the modern Linux kernel uses
(potentially) <a href="https://lwn.net/Articles/817905/">proactive compaction</a>,
which is normally visible as the &#39;kcompactd0&#39; kernel daemon. Once
you have aligned contiguous RAM that&#39;s suitable for use as huge
pages, the kernel needs to turn runs of ordinary sized pages into
hugepages. This is the job of khugepaged; <a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/transhuge.html">to quote</a>:</p>

<blockquote><p>Unless THP is completely disabled, there is [a] khugepaged daemon that
scans memory and collapses sequences of basic pages into huge pages.</p>
</blockquote>

<p>In the normal default kernel settings, this only happens for processes
that use the <a href="https://man7.org/linux/man-pages/man2/madvise.2.html"><code>madvise(2)</code></a> system call
to tell the kernel that a mmap()&#39;d area of theirs is suitable for
this. Go can do this under some circumstances, although I&#39;m not
sure what they are exactly (the direct code that does it is deep
inside the Go runtime).</p>

<p>If you look over the Internet, there are plenty of reports of
khugepaged using all of a CPU, often with responsiveness problems
to go along with it. Sometimes this stops if people quit and restart
some application; at other times, people resort to disabling
transparent hugepages or rebooting their systems. No one seems to
have identified a cause, or figured out what&#39;s going on to cause
the khugepaged CPU usage or system slowness (presumably the two
are related, perhaps through lock contention or memory thrashing).</p>

<p>Disabling THP is done through sysfs:</p>

<blockquote><pre>echo never &gt;/sys/kernel/mm/transparent_hugepage/enabled
</pre>
</blockquote>

<p>The next time around I may try to limit THP&#39;s &#39;defragmentation&#39;
efforts:</p>

<blockquote><pre>echo never &gt;/sys/kernel/mm/transparent_hugepage/defrag
</pre>
</blockquote>

<p>(The normal settings for both of these these days are &#39;madvise&#39;.)</p>

<p>If I&#39;m understanding <a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/transhuge.html">the documentation</a>
correctly, this will only use a hugepage if one is available
at the time that the program calls madvise(); it won&#39;t try to get one
later and swap it in.</p>

<p>(Looking at the documentation makes me wonder if Go and khugepaged
were both fighting back and forth trying to obtain hugepages when
Go made a madvise() call to enable hugepages for some regions.)</p>

<p>I believe I&#39;ve only really noticed this behavior on my desktops,
which are unusual in that I use ZFS on Linux on them. ZFS has its
own memory handling (the &#39;ARC&#39;), and historically has had some odd
and uncomfortable interaction with the normal Linux kernel memory
system. Still, it doesn&#39;t seem to be just me who has khugepaged
problems.</p>

<p>(I don&#39;t think we&#39;ve seen these issues on <a href="https://utcc.utoronto.ca/~cks/space/blog/linux/ZFSFileserverSetupIII">our ZFS fileservers</a>, but then we don&#39;t run anything else on the
fileservers. They sit there handling NFS in the kernel and that&#39;s
about it. Well, <a href="https://utcc.utoronto.ca/~cks/space/blog/sysadmin/LocalVarMailImprovement">there is one exception these days in our IMAP
server</a>, but I&#39;m not sure it
runs anything that uses madvise() to try to use hugepages.)</p>
</div></div>
  </body>
</html>
