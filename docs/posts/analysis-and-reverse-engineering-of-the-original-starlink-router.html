<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/">Original</a>
    <h1>Analysis and reverse-engineering of the original Starlink router</h1>
    
    <div id="readability-page-1" class="page"><article id="post-2215">

	<div>
		<!-- .entry-header -->

		
		<div>
			<p><img data-attachment-id="2216" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_thumb/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_thumb.jpg?fit=150%2C149&amp;ssl=1" data-orig-size="150,149" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_thumb" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_thumb.jpg?fit=150%2C149&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_thumb.jpg?fit=150%2C149&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_thumb.jpg?resize=150%2C149&amp;ssl=1" alt="" width="150" height="149" data-recalc-dims="1"/></p>

<div><p>While waiting for my Dishy, I decided to find and buy the Starlink router separately.</p></div>


<p>Honestly, I love the design of this thing. It reminds me of something from the good old sci-fi.</p>

<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?ssl=1"><img data-attachment-id="2220" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_header_pict/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?fit=800%2C606&amp;ssl=1" data-orig-size="800,606" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2.2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;iPhone SE (1st generation)&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1638305966&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;4.15&#34;,&#34;iso&#34;:&#34;100&#34;,&#34;shutter_speed&#34;:&#34;0.03030303030303&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="starlink_router_header_pict" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?fit=396%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?fit=800%2C606&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?resize=800%2C606&amp;ssl=1" alt="" width="800" height="606" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?w=800&amp;ssl=1 800w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?resize=396%2C300&amp;ssl=1 396w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_header_pict.jpg?resize=768%2C582&amp;ssl=1 768w" sizes="(max-width: 800px) 100vw, 800px" data-recalc-dims="1"/></a></p>

<p>The whole device looks rock solid and right-balanced. It’s a shame that this enclosure is not designed to be easily opened. There is no glue, but there are no screws also.</p>
<p>Six hooks hold metal and plastic parts of the router together, three on each side. To open this thing, you need to push the hooks somehow. This damages plastic and even aluminum. But it’s better than nothing, I guess.</p>

<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?ssl=1"><img data-attachment-id="2228" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_hooks/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?fit=750%2C404&amp;ssl=1" data-orig-size="750,404" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2.2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;iPhone SE (1st generation)&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1639791821&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;4.15&#34;,&#34;iso&#34;:&#34;32&#34;,&#34;shutter_speed&#34;:&#34;0.02&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_hooks" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?fit=400%2C215&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?fit=750%2C404&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?resize=750%2C404&amp;ssl=1" alt="" width="750" height="404" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?w=750&amp;ssl=1 750w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_hooks.jpg?resize=400%2C215&amp;ssl=1 400w" sizes="(max-width: 750px) 100vw, 750px" data-recalc-dims="1"/></a></p>
<h3>Router internals</h3>
<p>The whole metal part of the housing works as a heat sink:</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?ssl=1"><img data-attachment-id="2235" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_first_open1/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?fit=900%2C675&amp;ssl=1" data-orig-size="900,675" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2.2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;iPhone SE (1st generation)&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1638313695&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;4.15&#34;,&#34;iso&#34;:&#34;25&#34;,&#34;shutter_speed&#34;:&#34;0.02&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_first_open1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?fit=400%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?fit=850%2C638&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?resize=808%2C606&amp;ssl=1" alt="" width="808" height="606" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?w=900&amp;ssl=1 900w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?resize=400%2C300&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open1.jpg?resize=768%2C576&amp;ssl=1 768w" sizes="(max-width: 808px) 100vw, 808px" data-recalc-dims="1"/></a></p>
<p>A relatively simple single board.</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?ssl=1"><img data-attachment-id="2236" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_first_open2/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?fit=900%2C675&amp;ssl=1" data-orig-size="900,675" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2.2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;iPhone SE (1st generation)&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1638313983&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;4.15&#34;,&#34;iso&#34;:&#34;25&#34;,&#34;shutter_speed&#34;:&#34;0.03030303030303&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_first_open2" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?fit=400%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?fit=850%2C638&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?resize=808%2C606&amp;ssl=1" alt="" width="808" height="606" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?w=900&amp;ssl=1 900w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?resize=400%2C300&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_open2.jpg?resize=768%2C576&amp;ssl=1 768w" sizes="(max-width: 808px) 100vw, 808px" data-recalc-dims="1"/></a></p>
<h3>PCB</h3>
<p>The heart of the router is a popular Qualcomm <a href="https://www.qualcomm.com/products/ipq4018">IPQ4018</a> SoC: quad-core ARM Cortex A-7, 802.11ac WiFi 5GHz, and 2.4 GHz support, two channels both. Additionally, this SoC integrates a crypto engine and switch engine with hardware NAT and traffic steering.</p>
<p>Here are all components of the board with a brief description:</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?ssl=1"><img data-attachment-id="2249" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_pcb_top/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?fit=1024%2C571&amp;ssl=1" data-orig-size="1024,571" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_pcb_top" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?fit=400%2C223&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?fit=850%2C474&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?resize=850%2C475&amp;ssl=1" alt="" width="850" height="475" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?w=1024&amp;ssl=1 1024w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?resize=400%2C223&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_top.jpg?resize=768%2C428&amp;ssl=1 768w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a></p>
<p><a href="https://www.ti.com/lit/ds/symlink/tps2378.pdf">TPS2378</a> implements IEEE802.3at PoE standard and could handle up to 100V input.</p>
<p><a href="https://www.winbond.com/hq/product/code-storage-flash-memory/qspinand-flash/?__locale=en&amp;partNo=W25N01GV">W25N01GV</a> it’s a serial NAND Flash IC. The router operating system is stored on this chip.</p>
<p>Honestly, I’m not impressed by these dual-band antennas. Sure, they can cover a small apartment or a few rooms, but nothing more.</p>
<p>Here is what under the RF cans covers:</p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?ssl=1"><img data-attachment-id="2254" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_rf_can/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?fit=1184%2C545&amp;ssl=1" data-orig-size="1184,545" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_rf_can" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?fit=400%2C184&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?fit=850%2C391&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?resize=765%2C352&amp;ssl=1" alt="" width="765" height="352" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?resize=1024%2C471&amp;ssl=1 1024w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?resize=400%2C184&amp;ssl=1 400w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?resize=768%2C354&amp;ssl=1 768w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_rf_can.jpg?w=1184&amp;ssl=1 1184w" sizes="(max-width: 765px) 100vw, 765px" data-recalc-dims="1"/></a></p>
<p><a href="https://www.skyworksinc.com/en/Products/Front-end-Modules/SKY85333-11">SKY8533-11</a> and <a href="https://www.skyworksinc.com/en/Products/Front-end-Modules/SKY85743-21">SKY85743-21</a> are WiFi RF frontends, implementing LNA, PA, and switches.</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?ssl=1"><img data-attachment-id="2259" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_pcb_bottom/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?fit=1122%2C562&amp;ssl=1" data-orig-size="1122,562" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_pcb_bottom" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?fit=400%2C200&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?fit=850%2C426&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?resize=812%2C407&amp;ssl=1" alt="" width="812" height="407" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?resize=1024%2C513&amp;ssl=1 1024w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?resize=400%2C200&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?resize=768%2C385&amp;ssl=1 768w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_pcb_bottom.jpg?w=1122&amp;ssl=1 1122w" sizes="(max-width: 812px) 100vw, 812px" data-recalc-dims="1"/></a></p>
<p>The main voltage converter is <a href="https://www.ti.com/lit/ds/symlink/lm5116.pdf">LM5116</a>. Starlink PoE is 56 volts, but the router could run fine at 24 volts from a network switch.</p>
<p>The Ethernet switch is <a href="https://content.codico.com/fileadmin/media/download/datasheets/qualcomm/qualcomm_qca8072.pdf">QCA8072</a> – dual-port, 10/100/1000 Mbps tri-speed Ethernet PHY. IPQ807x it’s a typical solution for the IPQ40xx platform.</p>
<p><a href="https://datasheetspdf.com/pdf/796156/GigaDevice/GD25Q128B/1">GD25Q128B</a> it’s an SPI NOR flash with Qualcomm bootloader, u-boot, and some additional data.</p>
<p>The most interesting part is the <a href="https://www.st.com/content/st_com/en/products/embedded-software/secure-mcu-software/stsw-stsa110-ssl.html">STSAFE-A</a> chip. This special MCU provides secure storage, authentication, and some cryptographic functions, fully supported by the OpenSSL. The MCU is used to store board configuration and certificates. I’ll cover this below.</p>
<p>Recreated router block diagram:</p>
<p><a href="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?ssl=1"><img data-attachment-id="2286" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_block_diagram3/" data-orig-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?fit=1123%2C794&amp;ssl=1" data-orig-size="1123,794" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_block_diagram3" data-image-description="" data-image-caption="" data-medium-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?fit=400%2C283&amp;ssl=1" data-large-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?fit=850%2C601&amp;ssl=1" loading="lazy" src="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?resize=798%2C564&amp;ssl=1" alt="" width="798" height="564" srcset="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?resize=1024%2C724&amp;ssl=1 1024w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?resize=400%2C283&amp;ssl=1 400w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?resize=768%2C543&amp;ssl=1 768w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_block_diagram3.png?w=1123&amp;ssl=1 1123w" sizes="(max-width: 798px) 100vw, 798px" data-recalc-dims="1"/></a></p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?ssl=1"><img data-attachment-id="2279" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_uart_pins/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?fit=500%2C329&amp;ssl=1" data-orig-size="500,329" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2.2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;iPhone SE (1st generation)&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1639916317&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;4.15&#34;,&#34;iso&#34;:&#34;25&#34;,&#34;shutter_speed&#34;:&#34;0.0046511627906977&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;1&#34;}" data-image-title="starlink_router_uart_pins" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?fit=400%2C263&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?fit=500%2C329&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?resize=264%2C173&amp;ssl=1" alt="" width="264" height="173" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?w=500&amp;ssl=1 500w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?resize=400%2C263&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uart_pins.jpg?resize=345%2C225&amp;ssl=1 345w" sizes="(max-width: 264px) 100vw, 264px" data-recalc-dims="1"/></a>Unfortunately, I couldn’t trace the UART interface. I know where is the corresponding CPU pins, but it looks like those pins are not used for the serial console. Plus TX pin is almost buried under the CPU, and it’s tough to get to it.</p>
<p>There are a few test points on the board. Some of them related to the NAND and NOR. Some are voltages control and so on.</p>
<h3>Firmware</h3>
<p>Both NOR and NAND were removed from the board and dumped. All the data below were found with <a href="https://github.com/ReFirmLabs/binwalk">binwalk</a> and hex editor.</p>
<p>Analyzing the dumps, I found that SpaceX is followed a typical QCA pattern, with a few minor differences.</p>
<p>Here is a simplified layout of the Starlink NOR:</p>

<table id="tablepress-13">
<thead>
<tr>
	<th>Partition</th><th>Offset, bytes</th><th>Description</th>
</tr>
</thead>
<tbody>
<tr>
	<td>SBL</td><td>0</td><td>QCA Secondary bootloader</td>
</tr>
<tr>
	<td>MIBIB</td><td>0x40000</td><td>Partition table</td>
</tr>
<tr>
	<td>TZ</td><td>0x60000</td><td>Trust Zone firmware</td>
</tr>
<tr>
	<td>CDT</td><td>0x140000</td><td>Platform memory configuration</td>
</tr>
<tr>
	<td>UENV_0</td><td>0x180000</td><td>u-boot environment variables 0</td>
</tr>
<tr>
	<td>UBOOT_0</td><td>0x190000</td><td>u-boot ELF binary 0</td>
</tr>
<tr>
	<td>UENV_1</td><td>0x290000</td><td>u-boot environment variables 1</td>
</tr>
<tr>
	<td>UBOOT_1</td><td>0x2D0000</td><td>u-boot ELF binary 1</td>
</tr>
</tbody>
</table>
<!-- #tablepress-13 from cache -->
<p>Trust Zone firmware protects the boot process. This means that only a “valid” signed bootloader and Linux kernel are allowed. Each bootloader contains a security certificate. Those certificates could be extracted with a simple <code>dd</code> command. The u-boot certificate, for example:</p>
<pre>dd if=GD25Q128B@WSON8.BIN of=cert0.der bs=1 skip=4002248 count=1165</pre>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?ssl=1"><img data-attachment-id="2304" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/u-boot-cert/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?fit=734%2C608&amp;ssl=1" data-orig-size="734,608" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="u-boot cert" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?fit=362%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?fit=734%2C608&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?resize=538%2C446&amp;ssl=1" alt="" width="538" height="446" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?w=734&amp;ssl=1 734w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/u-boot-cert.jpg?resize=362%2C300&amp;ssl=1 362w" sizes="(max-width: 538px) 100vw, 538px" data-recalc-dims="1"/></a></p>
<p>Also, there are multiple u-boot binaries with separate environments. It could be done for redundancy or different modes. I’m not sure.</p>
<p>It seems that the first u-boot uses some default environment. Env variables at offset <strong>0x180000</strong>:</p>
<pre>baudrate=115200
bootcmd=bootipq
bootdelay=2
ipaddr=192.168.1.11
burn-fail=0
burn-in=0
count=0
</pre>
<p>Also, this bootloader loads the default environment as defined <a href="https://github.com/SpaceExplorationTechnologies/starlink-wifi/blob/master/qca/src/uboot-1.0/common/sysinfo_common.c#L58">there</a>.</p>
<pre>bootcmd=bootipq
bootdelay=2
baudrate=115200
ipaddr=192.168.1.11
serial_number=WISNEW-200600011
default_password=Starlink-pass-111
default_ssid=Starlink_00000000
eth_mac_addr=94:10:3E:E9:7F:D5
wps_device_pin=28680758</pre>
<p>In contrast, the secondary u-boot contains a Factory configuration at offset <strong>0x290000</strong>.</p>
<p><a href="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?ssl=1"><img data-attachment-id="2298" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_network_id_sysconf/" data-orig-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?fit=906%2C422&amp;ssl=1" data-orig-size="906,422" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_network_id_sysconf" data-image-description="" data-image-caption="" data-medium-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?fit=400%2C186&amp;ssl=1" data-large-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?fit=850%2C396&amp;ssl=1" loading="lazy" src="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?resize=850%2C396&amp;ssl=1" alt="" width="850" height="396" srcset="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?w=906&amp;ssl=1 906w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?resize=400%2C186&amp;ssl=1 400w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_network_id_sysconf.jpg?resize=768%2C358&amp;ssl=1 768w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a></p>
<p>Additionally, the NOR flash contains WiFi calibration data, a.k.a. “ART” partition. The QCA WiFi driver uses this data; I’m not covering this in the current article.</p>
<h3>NAND image</h3>
<p>The NAND flash contains the Linux kernel image and rootfs. But it’s somewhat tricky to get a usable image of the NAND.</p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?ssl=1"><img data-attachment-id="2319" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_nand_page/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?fit=923%2C935&amp;ssl=1" data-orig-size="923,935" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_nand_page" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?fit=296%2C300&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?fit=850%2C861&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?resize=595%2C602&amp;ssl=1" alt="" width="595" height="602" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?w=923&amp;ssl=1 923w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?resize=296%2C300&amp;ssl=1 296w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_page.jpg?resize=768%2C778&amp;ssl=1 768w" sizes="(max-width: 595px) 100vw, 595px" data-recalc-dims="1"/></a></p>
<p>This means that each 2048 data page contains an additional tail of 64 bytes. Those OOB chunks should be separated from actual data and processed correctly.</p>
<pre>import sys

NAND_PAGE_SIZE = 0x800 # 2048 bytes
NAND_PAGE_BLK = 64 # 64 pages per block
NAND_SECTOR_PER_PAGE = 4 # 4 sectors in page
NAND_SECTOR_SIZE = NAND_PAGE_SIZE/NAND_SECTOR_PER_PAGE
OOBLEN = 64

inf = open(sys.argv[1] , &#34;rb&#34;)
of = open(sys.argv[2], &#34;wb&#34;)

def page2off(pgno):
    return pgno * 0x840 # (NAND_PAGE_SIZE + NAND_SECTOR_PER_PAGE*OOBLEN)

def read_page(inf, blkno, pgno):
    blklen = page2off(NAND_PAGE_BLK)
    fileoff = blklen * blkno + page2off(pgno)

    print &#34;reading block %d page %d: offset %08X&#34; % (blkno, pgno, fileoff)

    inf.seek(fileoff, 0)
    block = inf.read(blklen)
    buf = &#34;&#34;

    for i in range(NAND_PAGE_SIZE):
        buf += block[i]

   return s

for blkn in range(1024):
    for pagen in range(64):
        res = read_page(inf, blkn, pagen)
        of.write(res)</pre>
<p>Page size, sectors count, and block count were taken from the datasheet.</p>
<p>Run and test result:</p>
<pre>$ python oob_strip.py W25N01GV@WSON8.BIN test_nand_out.bin

$ file test_out.bin 
test_out.bin: UBI image, version 1</pre>
<p>Alright, we have a <a href="http://www.linux-mtd.infradead.org/doc/ubi.html">UBI</a>. Quite a reasonable solution for the NAND.</p>
<pre>$ ubireader_display_info test_out.bin 
UBI File
---------------------
    Min I/O: 2048
    LEB Size: 126976
    PEB Size: 131072
    Total Block Count: 1024
    Data Block Count: 407
    Layout Block Count: 4
    Internal Volume Block Count: 0
    Unknown Block Count: 613
    First UBI PEB Number: 0

    Image: 1911121817
    ---------------------
        Image Sequence Num: 1911121817
        Volume Name:kernel
        Volume Name:ubi_rootfs
        Volume Name:rootfs_data
        PEB Range: 512 - 1023

        Volume: kernel
        ---------------------
        Volume: ubi_rootfs
        ---------------------
        Volume: rootfs_data
        ---------------------
******
    Image: 1899964099
    ---------------------
        Image Sequence Num: 1899964099
        Volume Name:kernel
        Volume Name:ubi_rootfs
        Volume Name:rootfs_data
        PEB Range: 0 - 511

        Volume: kernel
        ---------------------
        Volume: ubi_rootfs
        ---------------------
        Volume: rootfs_data
        ---------------------</pre>
<p>Great result. Here we have two images with three volumes in each image.</p>
<p>Unfortunately, it’s impossible to extract undamaged volume in this way. Typical NAND could always contain some amount of bad sectors or flipped bits. Those errors could be corrected with the OOB, and typically it’s done by the NAND controller.</p>
<p>The proper solution is to use some real hardware NAND controller or <a href="http://manpages.ubuntu.com/manpages/bionic/man4/nandsim.4freebsd.html">nandsim</a> (NAND Flash simulator driver).</p>
<pre>sudo modprobe nandsim id_bytes=0x98,0xd1,0x90,0x15,0x76,0x14,0x01,0x00 parts=512,512
sudo nandwrite -k -a -o --input-skip=69206016 /dev/mtd1 &#39;W25N01GV@WSON8.BIN&#39;
sudo modprobe ubi mtd=/dev/mtd1,2048,0,2
sudo mount -t ubifs /dev/ubi2_2 /mnt/ubi2_2</pre>
<p>Now it’s possible to read the data. Thus the simplified NAND layout is:</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?ssl=1"><img data-attachment-id="2327" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_nand_layout1/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?fit=891%2C363&amp;ssl=1" data-orig-size="891,363" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_nand_layout1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?fit=400%2C163&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?fit=850%2C346&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?resize=850%2C346&amp;ssl=1" alt="" width="850" height="346" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?w=891&amp;ssl=1 891w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?resize=400%2C163&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_nand_layout1.png?resize=768%2C313&amp;ssl=1 768w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a></p>
<p><strong>Volume 0</strong> contains the Linux kernel <a href="https://www.thegoodpenguin.co.uk/blog/u-boot-fit-image-overview/">FIT image</a> with signature.</p>
<pre>nand_extract/ubi2_2
├── etc
│   └── config
│   └── WifiConfig
├── upper
│   └── etc
│   ├── config
│   │   ├── dhcp
│   │   ├── dropbear
│   │   ├── ecm
│   │   ├── macsec
│   │   ├── network
│   │   ├── nss
│   │   ├── ripd
│   │   ├── skb_recycler
│   │   ├── ssid-steering
│   │   ├── system
│   │   ├── thermal
│   │   ├── ubootenv
│   │   ├── upnpd
│   │   ├── WifiConfig
│   │   └── wireless
│   ├── conntrackd
│   │   └── conntrackd.conf
│   ├── crontabs
│   │   └── root
│   ├── dnsmasq.conf
│   ├── dropbear
│   │   ├── authorized_keys
│   │   └── dropbear_rsa_host_key

***</pre>
<p>This volume is part of the OpenWrt <a href="https://openwrt.org/docs/guide-user/additional-software/extroot_configuration">Extroot</a> and mounted as <a href="https://en.wikipedia.org/wiki/OverlayFS">/overlay</a></p>
<p><strong>/etc/config/WifiConfig</strong> it’s a binary file used by the SpaceX proprietary software.</p>
<p>Sure, the file format is unknown, but it looks quite straightforward.</p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?ssl=1"><img data-attachment-id="2387" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_wifi_config_binary_format_fix/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?fit=900%2C646&amp;ssl=1" data-orig-size="900,646" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_wifi_config_binary_format_fix" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?fit=400%2C287&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?fit=850%2C610&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?resize=850%2C610&amp;ssl=1" alt="" width="850" height="610" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?w=900&amp;ssl=1 900w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?resize=400%2C287&amp;ssl=1 400w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_config_binary_format_fix.jpg?resize=768%2C551&amp;ssl=1 768w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a></p>
<h3>Kernel</h3>
<p>The <strong>FIT image</strong> contains multiple device tree blobs, Linux kernel, and Starlink Router Attest Certs.</p>
<pre>$ binwalk kernel-starlink

DECIMAL HEXADECIMAL DESCRIPTION
--------------------------------------------------------------------------------
40 0x28 device tree image (dtb)
268 0x10C gzip compressed data, maximum compression, has original file name: &#34;Image&#34;, from Unix, last modified: 2021-06-11 21:41:35
3754412 0x3949AC device tree image (dtb)
3779480 0x39AB98 device tree image (dtb)
3798724 0x39F6C4 device tree image (dtb)
3818016 0x3A4220 device tree image (dtb)
3839952 0x3A97D0 device tree image (dtb)
3865044 0x3AF9D4 device tree image (dtb)
3889968 0x3B5B30 device tree image (dtb)
3917528 0x3BC6D8 device tree image (dtb)
3936928 0x3C12A0 device tree image (dtb)
3961960 0x3C7468 device tree image (dtb)
3983688 0x3CC948 device tree image (dtb)
4003052 0x3D14EC device tree image (dtb)
4033728 0x3D8CC0 device tree image (dtb)
4058660 0x3DEE24 device tree image (dtb)
4083428 0x3E4EE4 Certificate in DER format (x509 v3), header length: 4, sequence length: 1161
4084593 0x3E5371 Certificate in DER format (x509 v3), header length: 4, sequence length: 947
4085544 0x3E5728 Certificate in DER format (x509 v3), header length: 4, sequence length: 945
4089868 0x3E680C Certificate in DER format (x509 v3), header length: 4, sequence length: 1161
4091033 0x3E6C99 Certificate in DER format (x509 v3), header length: 4, sequence length: 947
4091984 0x3E7050 Certificate in DER format (x509 v3), header length: 4, sequence length: 945</pre>
<p>The secure boot chain uses those certs to verify the validity of the kernel.</p>
<p>Why are there so many dtb sections? The single platform requires a single dtb. Those dtb’s are support for different QCA reference platforms.</p>
<p>The Linux kernel image is gzip-compressed, and it’s elementary to extract build configuration:</p>
<pre>$ binwalk kernel-starlink | grep Image -A1
<strong>268</strong> 0x10C gzip compressed data, maximum compression, has original file name: &#34;Image&#34;, from Unix, last modified: 2021-06-11 21:41:35
<strong>3754412</strong> 0x3949AC device tree image (dtb)</pre>
<p>Image size: <strong>3754412 – 268</strong> = <strong>3754144</strong></p>
<p>Image extraction:</p>
<pre>dd if=kernel-starlink of=linux_image.gz bs=1 skip=268 count=3754144

gzip -d linux_image.gz</pre>
<p>The config is also gzip-compressed. Let’s find it.</p>
<pre>$ binwalk linux_image | grep gzip -A1 -B1
5236966 0x4FE8E6 MPEG transport stream data
<strong>5949576 0x5AC888 gzip</strong> compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)
6174471 0x5E3707 xz compressed data
--
7370351 0x70766F LZMA compressed data, properties: 0xC0, dictionary size: 0 bytes, uncompressed size: 64 bytes
<strong>7392936 0x70CEA8 gzip</strong> compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)
7761920 0x767000 ELF, 32-bit LSB shared object, ARM, version 1 (SYSV)

</pre>
<p>The first one at <strong>0x5AC888</strong>:</p>
<pre>dd if=linux_image of=kernel_config.gz bs=1 skip=5949576 count=224895

gzip -d kernel_config.gz

$ head -n10 kernel_config 
#
# Automatically generated file; DO NOT EDIT.
# Linux/arm 4.4.60 Kernel Configuration
#
CONFIG_ARM=y
CONFIG_ARM_HAS_SG_CHAIN=y
CONFIG_MIGHT_HAVE_PCI=y
CONFIG_SYS_SUPPORTS_APM_EMULATION=y
CONFIG_HAVE_PROC_CPU=y
CONFIG_STACKTRACE_SUPPORT=y</pre>
<p>Linux kernel 4.4.60!</p>
<h3>Rootfs</h3>
<p>The basic system is not so different from “vanilla” OpenWrt. Except for one big thing.</p>
<pre># SpaceX: As a failsafe, we limit the uptime of our devices to 20 days. After 20 days
# this script will stop petting the watchdog, which will lead to it rebooting after
# about 2 minutes. To do this, we first take manual control of the watchdog from
# procd, using the ubus commands.
<strong>pet_watchdog</strong>() {
    # Wait one minute to let ubus system fully boot
    sleep 60

    echo &#34;Start Petting Watchdog&#34;
    ubus call system watchdog &#39;{&#34;magicclose&#34;: true}&#39;
    ubus call system watchdog &#39;{&#34;stop&#34;: true}&#39;

    # Pet every 10 seconds for 20 days (1,728,000 seconds)
    for var in `seq 1 172800`; do echo 1 ; sleep 10; done &gt; /dev/watchdog
}</pre>
<p>So, Starlink internet is down for ~1 minute every 20 days? 🙂</p>
<p>But the most interesting binary is <code>/usr/sbin/wifi_control</code></p>
<p>It’s a giant application that controls everything, the whole router operation. This app is written in <a href="https://go.dev/">Go</a>, and it’s really hard to disassemble.</p>
<ol>
<li>LAN configuration</li>
<li>iptables firewall configuration</li>
<li>WiFi configuration</li>
<li>Thermal management</li>
<li>Stats and Telemetry management</li>
<li>Captive portal</li>
<li>Interaction with mobile application</li>
</ol>
<p>It seems that many params like IP addresses and URLs are just hardcoded in the application.</p>
<p>This wifi_control initially starts from <code>/etc/init.d/boot</code> script:</p>
<pre>wifi_control --board=$(cat /etc/board) --early_init</pre>
<p>This creates initial configuration in /etc/config and wifi_control exits.</p>
<p>Also, I could find a lot of interesting strings:</p>
<pre>rx_beam_state
tx_beam_state
modulation
snow_active_override
auto_power_snow_melt_enabled
signal_strength
signal_level_dbm</pre>
<p>It looks like it’s possible to get a lot of cool statistics from the Dishy.</p>
<p>Now it’s time to run some software.</p>
<h3>Booting up</h3>
<p>Lack of the UART makes no fun. I decided to use 3rd-party hardware and run the Starlink router software.</p>
<p>There are two significant differences:</p>
<p>But it’s not an issue.</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?ssl=1"><img data-attachment-id="2315" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_dk04/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?fit=900%2C633&amp;ssl=1" data-orig-size="900,633" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_dk04" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?fit=400%2C281&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?fit=850%2C598&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?resize=618%2C434&amp;ssl=1" alt="" width="618" height="434" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?w=900&amp;ssl=1 900w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?resize=400%2C281&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dk04.jpg?resize=768%2C540&amp;ssl=1 768w" sizes="(max-width: 618px) 100vw, 618px" data-recalc-dims="1"/></a></p>
<p>Is it possible to run Starlink’s u-boot on a different board? Yes, it’s possible.</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?ssl=1"><img data-attachment-id="2334" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_uboot-_run/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?fit=801%2C765&amp;ssl=1" data-orig-size="801,765" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_uboot-_run" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?fit=314%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?fit=801%2C765&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?resize=801%2C765&amp;ssl=1" alt="" width="801" height="765" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?w=801&amp;ssl=1 801w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?resize=314%2C300&amp;ssl=1 314w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_uboot-_run.jpeg?resize=768%2C733&amp;ssl=1 768w" sizes="(max-width: 801px) 100vw, 801px" data-recalc-dims="1"/></a></p>
<p>I decided to build the u-boot and Linux kernel from the SpaceX GitHub repository and boot with Starlink rootfs</p>
<h3>Building the Starlink OpenWrt</h3>
<p>The <a href="https://github.com/SpaceExplorationTechnologies/starlink-wifi">SpaceX repository</a> is based on quite ancient <a href="https://openwrt.org/releases/15.05/start">OpenWrt 15.05.1</a> “Chaos Calmer” release.</p>
<p>I couldn’t compile the repo on my Linux Mint 20.2, so I decided to use <a href="https://www.docker.com/">Docker</a> with Ubuntu 16.04 (LTS) environment. I will not cover the installation and initial configuration of the Docker.</p>
<p>This is my <code>Dockerfile</code>:</p>
<pre>FROM ubuntu:16.04

ARG UID=1000
ARG GID=1000

# OpenWRT&#39;s dl directory.
ENV DLDIR /opt/dl

RUN apt-get update &amp;&amp; apt-get install -y \
        apt-utils \
        build-essential \
        curl \
        ocaml \
        device-tree-compiler \
        iputils-ping \
        file \
        gawk \
        git \
        less \
        libjansson-dev \
        libncurses5-dev \
        libssl-dev \
        nodejs \
        python-m2crypto \
        python-minimal \
        sharutils \
        subversion \
        unzip \
        vim \
        squashfs-tools \
        wget

RUN groupadd -g $GID user &amp;&amp; \
useradd --create-home --gid $GID --uid $UID user

WORKDIR /var/build/starlink-wifi</pre>
<p>Put the Dockerfile to the Starlink repository top dir and run:</p>
<pre>docker build . -t starlink-wifi-build -f Dockerfile</pre>
<p>Run the Docker:</p>
<pre>src_root=$(realpath &#34;$(dirname $0)&#34;)

docker run -i $(tty -s &amp;&amp; echo -t) \
    -v ${src_root}:/var/build/starlink-wifi \
    -v /opt/dl \
    -v ~/.gitconfig:/etc/gitconfig \
    -u $(id -u):$(id -g) \
    starlink-wifi-build &#34;$@&#34;</pre>
<p>Now it’s time to build the firmware:</p>
<pre>./scripts/feeds update -a
./scripts/feeds install -a
cp spacex_openwrt.config .config
make oldconfig</pre>
<p>Run<code>make menuconfig</code> and go to <code>Boot Loaders ---&amp;gt;</code></p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?ssl=1"><img data-attachment-id="2355" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_repo_uboot_select/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?fit=642%2C249&amp;ssl=1" data-orig-size="642,249" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_repo_uboot_select" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?fit=400%2C155&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?fit=642%2C249&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?resize=642%2C249&amp;ssl=1" alt="" width="642" height="249" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?w=642&amp;ssl=1 642w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_repo_uboot_select.png?resize=400%2C155&amp;ssl=1 400w" sizes="(max-width: 642px) 100vw, 642px" data-recalc-dims="1"/></a></p>
<pre>cp nand_extracted_kernel_config target/linux/ipq806x/config-4.4
make V=s -jN</pre>
<p>Where <code>N</code> is required, threads count. Typically, this value equals the number of the CPU cores.</p>
<p>In my case, the correct Linux kernel is bin/ipq806x/openwrt-ipq806x-qcom-ipq4019-ap.dk04.1-c1-fit-uImage.itb since I’m running on AP.DK04</p>
<h3>Running the firmware</h3>
<p>I decided to use a single NOR flash and made up with the following layout: <code>896k(SBL),64k(u-boot-env),600k(u-boot),20m(rootfs)</code></p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?ssl=1"><img data-attachment-id="2359" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_madeup_nor/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?fit=707%2C409&amp;ssl=1" data-orig-size="707,409" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_madeup_nor" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?fit=400%2C231&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?fit=707%2C409&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?resize=631%2C365&amp;ssl=1" alt="" width="631" height="365" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?w=707&amp;ssl=1 707w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_madeup_nor.jpg?resize=400%2C231&amp;ssl=1 400w" sizes="(max-width: 631px) 100vw, 631px" data-recalc-dims="1"/></a></p>
<p>SBL and u-boot env were borrowed from the original DK04 QSDK firmware.</p>
<pre>dd if=/dev/zero of=111496_zero.bin bs=1 count=111496
cat qca_bootloader_only.bin u-boot.bin 111496_zero.bin nand_extract/squashfs-starlink &gt; starlink_nor.bin</pre>
<p>There is no kernel. I decided to boot it up over the network. Why not?</p>
<p>Resulting starlink_nor.bin was burned to a spare NOR flash.</p>
<p>After the board start, some configuration is required in the u-boot console:</p>
<pre>setenv serverip 192.168.1.150
set mtdparts &#34;mtdparts=78b5000.spi:896k(QCA-bootloader),64k(u-boot-env),600k(u-boot),20m(rootfs)&#34;
setenv bootargs &#34;rootfstype=squashfs root=/dev/mtdblock3 ro noinitrd init=/init console=ttyMSM0,115200 mtdparts=spi0.0:896k(QCA-bootloader),64k(u-boot-env),600k(u-boot),20m(rootfs)&#34;
saveenv</pre>
<p>192.168.1.150 it’s the address of my TFTP server.</p>
<p>Now it’s time to boot the operating system:</p>
<pre>tftpboot 84000000 openwrt-ipq806x-qcom-ipq4019-ap.dk04.1-c1-fit-uImage.itb
bootm</pre>
<p>The kernel is booting and should mount&amp;run Starlink’s rootfs.</p>
<p><a href="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?ssl=1"><img data-attachment-id="2360" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_console_motd/" data-orig-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?fit=768%2C438&amp;ssl=1" data-orig-size="768,438" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_console_motd" data-image-description="" data-image-caption="" data-medium-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?fit=400%2C228&amp;ssl=1" data-large-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?fit=768%2C438&amp;ssl=1" loading="lazy" src="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?resize=768%2C438&amp;ssl=1" alt="" width="768" height="438" srcset="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?w=768&amp;ssl=1 768w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_console_motd.png?resize=400%2C228&amp;ssl=1 400w" sizes="(max-width: 768px) 100vw, 768px" data-recalc-dims="1"/></a>Yay!</p>
<p>It’s possible to configure the network and internet access:</p>
<pre>brctl addbr br-lan
brctl addif br-lan eth0
ip addr add 192.168.1.21/24 broadcast 192.168.1.255 dev eth0
ip link set dev eth0 up
ip route add default via 192.168.1.1</pre>
<p>Half of these commands should have been executed automatically, but something went wrong.</p>
<p>Ok, now the internet is working, but what about the wifi_control?</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?ssl=1"><img data-attachment-id="2361" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_first_run_ping/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?fit=1352%2C327&amp;ssl=1" data-orig-size="1352,327" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_first_run_ping" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?fit=400%2C97&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?fit=850%2C206&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?resize=850%2C206&amp;ssl=1" alt="" width="850" height="206" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?resize=1024%2C248&amp;ssl=1 1024w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?resize=400%2C97&amp;ssl=1 400w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?resize=768%2C186&amp;ssl=1 768w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_first_run_ping.jpeg?w=1352&amp;ssl=1 1352w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a></p>
<p>Sure! It tries to access the security chip and fails because there is no such chip on my board 🙂</p>
<p>I think it’s time to check out that security chip.</p>
<h3 data-page-title-en="STSAFE-A110">STSAFE-A110 auth chip</h3>
<p>The STSAFE-A110 is in UFDFPN8 2×3 mm package. I decided to build an adapter for easy connection.</p>


<p>Also, there is a minimum required set of components: bypass capacitor and Reset circuit.</p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?ssl=1"><img data-attachment-id="2365" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/stsafe_adapter_schematic/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?fit=950%2C402&amp;ssl=1" data-orig-size="950,402" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="stsafe_adapter_schematic" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?fit=400%2C169&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?fit=850%2C360&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?resize=850%2C360&amp;ssl=1" alt="" width="850" height="360" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?w=950&amp;ssl=1 950w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?resize=400%2C169&amp;ssl=1 400w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_adapter_schematic.png?resize=768%2C325&amp;ssl=1 768w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a>C2 and R3 generate a Reset signal of the required length. Check out the <a href="file:///home/oleg/Documents/Datasheets/stm32/stsafe-a110.pdf">datasheet</a> on page 26.</p>
<p>The device connected to the Raspberry Pi I2C bus:</p>
<p><a href="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?ssl=1"><img data-attachment-id="2368" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/stsafe_connected_to_raspberry/" data-orig-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?fit=800%2C667&amp;ssl=1" data-orig-size="800,667" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;2.2&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;iPhone SE (1st generation)&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;1639616041&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;4.15&#34;,&#34;iso&#34;:&#34;25&#34;,&#34;shutter_speed&#34;:&#34;0.02&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="stsafe_connected_to_raspberry" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?fit=360%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?fit=800%2C667&amp;ssl=1" loading="lazy" src="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?resize=563%2C469&amp;ssl=1" alt="" width="563" height="469" srcset="https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?w=800&amp;ssl=1 800w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?resize=360%2C300&amp;ssl=1 360w, https://i0.wp.com/olegkutkov.me/wp-content/uploads/2021/12/stsafe_connected_to_raspberry.jpg?resize=768%2C640&amp;ssl=1 768w" sizes="(max-width: 563px) 100vw, 563px" data-recalc-dims="1"/></a></p>
<p>Quick test:</p>
<pre>$ i2cdetect -y 1
0 1 2 3 4 5 6 7 8 9 a b c d e f
00: -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: 20 -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</pre>
<p>It’s alive! 0x20 it’s the correct address for STSAFE</p>
<p>There is an official ST library and toolset for the STSAFE-A110: <a href="https://www.st.com/en/embedded-software/stsw-stsa110-ssl.html">https://www.st.com/en/embedded-software/stsw-stsa110-ssl.html</a></p>
<p>This library could be compiled on the Raspberry Pi. Just OpenSSL headers are required.</p>
<p>Open make.in and edit OpenSSL paths. In the case of a standard SSL installation, this should look like this:</p>
<pre>OPENSSL_INC = /usr/include/openssl
OPENSSL_LIB = /usr/lib
OPENSSL_BIN = /usr/bin</pre>
<p>Then run:</p>
<pre>make
sudo make install
sudo ldconfig</pre>
<p>Next create file <code>openssl.conf.stsafe</code> with the following content:</p>
<pre>openssl_conf = openssl_def

[openssl_def]
engines = engine_section

[engine_section]
Stsafe = Stsafe_section

[Stsafe_section]
dynamic_path = /usr/lib/engines-1.1/Stsafe.so
engine_id = Stsafe
default_algorithms = ALL
init = 1</pre>
<p>Now we ready for test:</p>
<p><code>OPENSSL_CONF=./openssl.conf.stsafe openssl engine Stsafe</code></p>
<p>There should be a successful pairing at the command output:</p>
<pre>Main : Now let&#39;s pair ... 
About to call StSafeA_LocalEnvelopeKeySlotQuery: 0x2907d0, 0x2907e0, 0x2907f0 
StSafeA_LocalEnvelopeKeySlotQuery: StatusCode=0 slot 0: presence flag =1 
StSafeA_LocalEnvelopeKeySlotQuery: StatusCode=0 slot 1: presence flag =1 
StatusCode=0 ---HostKeySlot = 0xbef11ccc, pStSafeA-&gt;InOutBuffer.LV.Data = 0xb6ab2430
HostKeySlot-&gt;HostKeyPresenceFlag: 1 
Main : stsafe_pairing success</pre>
<p>The next step is to run the <code>test suit</code> to get some useful output.</p>
<pre>cd Examples/stsafe_engine_test_suite/</pre>
<p>Please note that some tests might fail. I commented those failed tests in <code>test_stsafe_engine.c</code></p>
<p>Build and run the tool:</p>
<pre>make
./test_stsafe_engine</pre>
<p>This is what I got:</p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?ssl=1"><img data-attachment-id="2374" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_stsafe_test_suit-2/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?fit=730%2C843&amp;ssl=1" data-orig-size="730,843" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_stsafe_test_suit" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?fit=260%2C300&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?fit=730%2C843&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?resize=730%2C843&amp;ssl=1" alt="" width="730" height="843" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?w=730&amp;ssl=1 730w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_stsafe_test_suit.jpg?resize=260%2C300&amp;ssl=1 260w" sizes="(max-width: 730px) 100vw, 730px" data-recalc-dims="1"/></a></p>
<p>Sorry for the blurred parts 🙂</p>
<p>Those hex data could be copied to a text file and then converted to a valid <code>pem</code> file:</p>
<pre>cat device_cert.txt | xxd -r -p | openssl x509 -inform DER -out device_cert.pem -outform PEM</pre>
<p>Result:</p>
<p><a href="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?ssl=1"><img data-attachment-id="2372" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_dev_pem/" data-orig-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?fit=556%2C457&amp;ssl=1" data-orig-size="556,457" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_dev_pem" data-image-description="" data-image-caption="" data-medium-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?fit=365%2C300&amp;ssl=1" data-large-file="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?fit=556%2C457&amp;ssl=1" loading="lazy" src="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?resize=556%2C457&amp;ssl=1" alt="" width="556" height="457" srcset="https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?w=556&amp;ssl=1 556w, https://i1.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_dev_pem.png?resize=365%2C300&amp;ssl=1 365w" sizes="(max-width: 556px) 100vw, 556px" data-recalc-dims="1"/></a></p>
<p>What’s about <code>wifi_control</code>? Let’s run it on Raspberry!</p>
<p>Make some preparations first.</p>
<pre># echo &#34;v1 &gt; /etc/board
# echo &#34;2021.19.0.mr2666-prod&#34; &gt; /etc/version    # or version of your firmware
# ln -s /bin/true /usr/local/bin/devinfo_access</pre>
<p>Copy <code>WifiConfig</code> from the real system to your Raspberry <code>/etc/</code></p>
<p>Raspberry Pi uses the second I2C bus /dev/i2c-1</p>
<p>Then run <code>sudo udevadm control --reload-rules; sudo udevadm trigger</code>.</p>
<p><a href="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?ssl=1"><img data-attachment-id="2377" data-permalink="https://olegkutkov.me/2021/12/25/analysis-and-reverse-engineering-of-the-original-starlink-router/starlink_router_wifi_control_on_rpi/" data-orig-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?fit=1007%2C396&amp;ssl=1" data-orig-size="1007,396" data-comments-opened="1" data-image-meta="{&#34;aperture&#34;:&#34;0&#34;,&#34;credit&#34;:&#34;&#34;,&#34;camera&#34;:&#34;&#34;,&#34;caption&#34;:&#34;&#34;,&#34;created_timestamp&#34;:&#34;0&#34;,&#34;copyright&#34;:&#34;&#34;,&#34;focal_length&#34;:&#34;0&#34;,&#34;iso&#34;:&#34;0&#34;,&#34;shutter_speed&#34;:&#34;0&#34;,&#34;title&#34;:&#34;&#34;,&#34;orientation&#34;:&#34;0&#34;}" data-image-title="starlink_router_wifi_control_on_rpi" data-image-description="" data-image-caption="" data-medium-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?fit=400%2C157&amp;ssl=1" data-large-file="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?fit=850%2C334&amp;ssl=1" loading="lazy" src="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?resize=850%2C334&amp;ssl=1" alt="" width="850" height="334" srcset="https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?w=1007&amp;ssl=1 1007w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?resize=400%2C157&amp;ssl=1 400w, https://i2.wp.com/olegkutkov.me/wp-content/uploads/2021/12/starlink_router_wifi_control_on_rpi.jpeg?resize=768%2C302&amp;ssl=1 768w" sizes="(max-width: 850px) 100vw, 850px" data-recalc-dims="1"/></a></p>
<p>A lot of interesting things are going on here!</p>
<p>Now I’m trying to reverse the I2C communication protocol to understand how wifi_control interacts with STSAFE. There is a lot of data traffic on this bus.</p>
<p>Stay tuned!</p>




































































































		</div><!-- .entry-content -->
	</div>

</article></div>
  </body>
</html>
