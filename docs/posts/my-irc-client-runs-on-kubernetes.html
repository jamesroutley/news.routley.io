<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://xeiaso.net/blog/2024/k8s-irc-client/">Original</a>
    <h1>My IRC client runs on Kubernetes</h1>
    
    <div id="readability-page-1" class="page"><div>
            <article>
    
    <p>
        Published on <time datetime="2024-08-23">08/23/2024</time>, 1098 words, 4 minutes to read
    </p>

    
        <p>Trust me, there&#39;s a reason for this</p>
    

    
        
            
    

    

        
    

    
        <figure><picture><source type="image/avif" srcset="https://cdn.xeiaso.net/file/christine-static/hero/arona-seattle.avif"/><source type="image/webp" srcset="https://cdn.xeiaso.net/file/christine-static/hero/arona-seattle.webp"/><img alt="An image of A light-blue haired anime woman with a pixie cut in a white hoodie and short skirt drinking coffee in Seattle, space needle, smartphone, chat bubbles, blue halo" loading="lazy" src="https://cdn.xeiaso.net/file/christine-static/hero/arona-seattle.jpg"/></picture></figure>
        <small>A light-blue haired anime woman with a pixie cut in a white hoodie and short skirt drinking coffee in Seattle, space needle, smartphone, chat bubbles, blue halo - Black Forest Flux.1 [dev]</small>
    

    <p>IRC has historically been one of the most important chat programs in my life. It&#39;s how I met my husband, how I found jobs in the early stages of my career, how I get help with weird Linux arcana that nobody else can really fix, and it&#39;s where I socialize with the Internet Illuminati. I use it every day and main reason I use tmux is to attach to that one session with my IRC client in it.</p>
<p>However, there&#39;s a problem with this setup: it&#39;s tied to one physical computer. If that physical computer dies, I lose easy access to all my IRC logs. My IRC logs folder is ridiculously large:</p>
<pre><code><span>$ du -hs .weechat/logs
</span><span>5.0G	.weechat/logs
</span></code></pre>
<p>This is five gigabytes of <em>text</em>. This represents a huge fraction of my digital life and is some of the most important data to me. Not to mention my 188 kilobytes of configuration that I&#39;ve built up over the years.</p>
<p>Point is, there&#39;s a lot of data here and I want to make sure that it&#39;s easy to access via a shell like I&#39;m used to. I also want it to be a bit more redundant so that if one physical computer dies then it&#39;ll just be rescheduled to another machine and I&#39;ll be back up and chatting within minutes <em>without human intervention</em>.</p>
<p>Seeing as there&#39;s realistically not many other options for this (and I already have a Kubernetes cluster), I decided to move my IRC client into a VM on top of Kubernetes.</p>
<h2>What? Why?</h2>
<p>After reading that last bit, I&#39;m sure that some of you have questions like this:</p>
<div><p><img alt="Aoi is wut" loading="lazy" src="https://cdn.xeiaso.net/sticker/aoi/wut/128"/></p><div><p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; </p><p>You&#39;re using a container orchestrator for virtual machines? That seems a
bit...unorthodox. Why not just put it into a container? What&#39;s wrong with
that?</p></div></div>
<p>There&#39;s a couple properties of Kubernetes that I&#39;m going to be taking advantage of here:</p>
<ol>
<li>Kubernetes detects node failure and reschedules jobs to other machines as it happens.</li>
<li>I already have Kubernetes set up (the best orchestrator is the one you already have).</li>
<li>If I&#39;m going to have a SSH daemon and tmux running in a container, I might as well just run a whole normal Linux distro so that I can use systemd for this instead of having to reinvent my own service management layer.</li>
</ol>
<p>The big thing that makes all this work is my combination of <a href="https://kubevirt.io">Kubevirt</a> and <a href="https://longhorn.io">Longhorn</a>. Kubevirt lets you schedule virtual machines onto Kubernetes and import cloud-friendly images into your cluster. Longhorn is what I use for replicated block/file storage in my Kubernetes cluster, which makes everything have at least three copies in my homelab. This combination allows me to have a virtual machine that automagically gets run <em>somewhere</em> in the homelab. I don&#39;t have to think about it. I don&#39;t have to care. It just works. It also backs up all of the data to <a href="https://tigrisdata.com">Tigris</a>, which makes me feel better about the data being intact if my house were to catch on fire.</p>
<div><p><img alt="Cadey is coffee" loading="lazy" src="https://cdn.xeiaso.net/sticker/cadey/coffee/128"/></p><div><p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; </p><p>This is what I wanted to implement with <a href="https://xeiaso.net/blog/series/waifud">waifud</a>, but now
I don&#39;t need to use that project at all. It even imports cloud-config metadata
for me! It&#39;s glorious.</p></div></div>
<h2>The big move</h2>
<div><p><img alt="Mara is hacker" loading="lazy" src="https://cdn.xeiaso.net/sticker/mara/hacker/128"/></p><div><p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; </p><p>For your convenience when reading, Kubernetes and Kubevirt terms are written
in JavaClassNameCase. To be extra unambiguous the first time a term is used,
the &#34;owner&#34; of the term will be written next to it, such as a &#34;Kubevirt
VirtualMachine&#34; or a &#34;Kubernetes Service&#34;.</p></div></div>
<p>To move my IRC client over to Kubernetes, I needed three objects:</p>
<ol>
<li>A <a href="https://github.com/kubevirt/containerized-data-importer/blob/main/doc/datavolumes.md">Kubevirt DataVolume</a>, which is a Kubernetes PersistentVolumeClaim that gets pre-seeded with the contents of a Linux distribution.</li>
<li>A <a href="https://kubevirt.io/user-guide/user_workloads/creating_vms/">Kubevirt VirtualMachine</a>, which is like a Kubernetes Deployment, but it uses a template that has a virtual machine hypervisor enabled.</li>
<li>A Kubernetes Service to expose ports on that VirtualMachine with a stable IP address and DNS name so that I can SSH into it and another one of my bots can use my IRC client as a bouncer.</li>
</ol>
<p>Each of those objects are defined in <a href="https://github.com/Xe/x/blob/master/kube/alrest/vms/arona/arona.yaml">Xe/x/kube/alrest/vms/arona/arona.yaml</a>. The most exciting one I want to highlight here is the Kubevirt DataVolume:</p>
<pre><code><span><span>apiVersion</span><span>:</span> cdi.kubevirt.io/v1beta1
</span><span><span>kind</span><span>:</span> DataVolume
</span><span><span>metadata</span><span>:</span>
</span><span>  <span>name</span><span>:</span> <span>&#34;arona&#34;</span>
</span><span>  <span>namespace</span><span>:</span> waifud
</span><span><span>spec</span><span>:</span>
</span><span>  <span>storage</span><span>:</span>
</span><span>    <span>storageClassName</span><span>:</span> longhorn
</span><span>    <span>volumeMode</span><span>:</span> Block 
</span><span>    <span>accessModes</span><span>:</span>
</span><span>      <span>-</span> ReadWriteOnce 
</span><span>    <span>resources</span><span>:</span>
</span><span>      <span>requests</span><span>:</span>
</span><span>        <span>storage</span><span>:</span> 64Gi
</span><span>  <span>source</span><span>:</span>
</span><span>    <span>http</span><span>:</span>
</span><span>      <span>url</span><span>:</span> <span>&#34;https://cloud-images.ubuntu.com/daily/server/noble/current/noble-server-cloudimg-amd64.img&#34;</span>
</span></code></pre>
<p>This is kinda exciting to me because I <a href="https://github.com/Xe/waifud/blob/a0c21bcfe5855e5effbfd52ecec7206b6be568aa/src/api/instances.rs#L458-L506">implemented this in waifud</a> with the most fucked Rust code ever. My implementation also assumed that the contents of cloud image URLs didn&#39;t change (spoiler alert: they do, all the time), and overall I wasn&#39;t really happy with how it worked in practice. Kubevirt DataVolumes make this irrelevant and I am so happy that I can grab something off the shelf for this. It&#39;s worth having to use Kubernetes for this.</p>
<p>From there all I needed was a hostname for the machine, to write some stuff <a href="https://github.com/Xe/x/blob/master/kube/alrest/vms/arona/setup.sh">in a shell script</a>, copy <a href="https://wiki.archlinux.org/title/WeeChat#tmux_method">a systemd unit out of the Arch wiki</a>, and then to copy over my giant <code>.weechat</code> folder.</p>
<div><p><img alt="Cadey is enby" loading="lazy" src="https://cdn.xeiaso.net/sticker/cadey/enby/128"/></p><div><p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; </p><p>I chose the hostname <code>arona</code> by opening a four-split of gacha game fandom
wikis and clicking the &#34;random page&#34; button on each of them, then picked the
one that sounded nicest. The other options were <code>yanfei</code>, <code>hanabi</code>, and
<code>changli</code>, but <code>arona</code> just sounded better.</p></div></div>
<h2>The results</h2>
<figure><a href="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/arona-uwufetch.jpg"><picture><source type="image/avif" srcset="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/arona-uwufetch.avif"/><source type="image/webp" srcset="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/arona-uwufetch.webp"/><img alt="A screenshot of my VM arona running neowofetch, showing off the fact that it has 4 hours of uptime, is using about a gigabyte of ram, and is running Ubuntu 24.04." loading="lazy" src="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/arona-uwufetch.jpg"/></picture></a><figcaption>A screenshot of my VM arona running neowofetch, showing off the fact that it has 4 hours of uptime, is using about a gigabyte of ram, and is running Ubuntu 24.04.</figcaption></figure>
<p>I&#39;m pretty happy with this so far! The VM automatically gets backed up every night, it&#39;s replicated between my machines, and to get into it, I just run <code>ssh xe@arona.waifud.svc.alrest.xeserv.us</code> and then get into weechat with the command <code>chats</code>.</p>
<figure><a href="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/irc-client.jpg"><picture><source type="image/avif" srcset="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/irc-client.avif"/><source type="image/webp" srcset="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/irc-client.webp"/><img alt="A screenshot of my IRC client in the Gentoo offtopic IRC channel on Libera.chat" loading="lazy" src="https://cdn.xeiaso.net/file/christine-static/blog/2024/arona-irc/irc-client.jpg"/></picture></a><figcaption>A screenshot of my IRC client in the Gentoo offtopic IRC channel on Libera.chat</figcaption></figure>

    <hr/>

    

    

    <p>Facts and circumstances may have changed since publication. Please contact me before jumping to conclusions if something seems wrong or unclear.</p>

    <p>Tags: </p>
</article>
        </div><div>
            <p>Copyright 2012-2024 Xe Iaso (Christine Dodrill). Any and all opinions listed here are my own and
                not representative of any of my employers, past, future, and/or present.</p>
            
            <p>Served by xesite v4 (/app/xesite) with site version 
                        <a href="https://github.com/Xe/site/commit/f16f97473a092d915d81997ac92d13fc648e3237">f16f9747</a>
                    , source code available <a href="https://github.com/Xe/site">here</a>.</p>
        </div></div>
  </body>
</html>
