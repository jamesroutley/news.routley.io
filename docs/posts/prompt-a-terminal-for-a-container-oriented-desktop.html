<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://blogs.gnome.org/chergert/2023/12/14/prompt/">Original</a>
    <h1>Prompt – A terminal for a container-oriented desktop</h1>
    
    <div id="readability-page-1" class="page"><article id="post-10831">
	
	<!-- .entry-header -->

	<div>
		<p><a href="https://gitlab.gnome.org/chergert/prompt">Prompt</a> is a terminal that marries the best of <a href="https://flathub.org/apps/org.gnome.Builder">GNOME Builder</a>’s seamless container support, the beauty of <a href="https://flathub.org/apps/org.gnome.TextEditor">GNOME Text Editor</a>, and the robustness of VTE. I like to think of it as a <b>companion terminal to Builder</b>.</p>
<p>Though it’s also useful for immutable/container-oriented desktops like <a href="https://fedoraproject.org/silverblue/">Fedora Silverblue</a> or <a href="https://projectbluefin.io/">Project Bluefin</a> where containers are front-and-center.</p>
<p><a href="http://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-27-04.png"><img decoding="async" src="http://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-27-04-1024x831.png" alt="A screenshot of Prompt with a menu open showing a list of available containers to spawn a new terminal shell within." width="600" srcset="https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-27-04-1024x831.png 1024w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-27-04-300x243.png 300w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-27-04-768x623.png 768w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-27-04.png 1327w" sizes="(max-width: 1024px) 100vw, 1024px"/></a></p>
<p>This came out of a prototype I made for the GNOME Builder IDE nearly a decade ago. We already had all the container abstractions so why not expose them as a Terminal Workspace?</p>
<p>Prompt extracts the container portion of the code-foundry into a standalone program.</p>
<p>My prototype didn’t go anywhere in recent years because I was conflicted. I have a high performance bar for software I ship and VTE wasn’t there yet on Wayland-based compositors which I use. But if you frequent this blog you already know that I reached out to the meticulous VTE maintainers and helped them pick the right battles to nearly double performance this GNOME cycle. I also ported <code>gnome-terminal</code> to GTK 4 which provided me ample opportunity to see where and how containers would integrate from an application perspective.</p>
<p>I designed Prompt to be Flatpak-first. That has design implications if you want a robust feature-set. Typically an application is restricted to the PID and PTY namespace within the Flatpak sandbox even if you’re capable of executing processes on the host. That means using TTY API like <code>tcgetpgrp()</code> becomes utterly useless when the kernel <code>ioctl()</code> returns you a PID of 0 (as it’s in a different namespace). Notably, 0 is the one value <code>tcgetpgrp()</code> is not documented to return. How fun!</p>
<p>To give Prompt the best chance at tracking containers and foreground processes a <code>prompt-agent</code> runs from the host system. It is restricted to very old versions of GLib/GObject/GIO and JSON-GLib because we know that <code>/usr/bin/flatpak</code> will already require them. Using those libraries instead of certain GLibc API helps us in situations where GLibc is only forward-compatible and not backwards-compatible. Combined with point-to-point D-Bus serialization on top of a <code>socketpair()</code> we have a robust way to pass file-descriptors between the agent and the UI process and we’ll use that a bunch.</p>
<p>There are a lot of little tricks in here to keep things fast and avoid energy-drain. For example, process tracking is done with a combination of exponential-backoff and re-triggering based on either new content arriving or certain key-presses. It gives a very low-latency feeling to the <code>sudo</code>/<code>ssh</code> feature I love from Console, albeit with less overhead.</p>
<p>One thing I find helpful with Builder is that when I come back to it my project session is right there. So this has session support too. It will restore your tabs/containers how they were before. So if you have a similar workflow you might find that useful. If not? Just turn it off in Preferences.</p>
<p>I want to have a bit of fun because right now I’m stuck indoors caring for my young, paraplegic dog. So it’s packed full of palettes you can play with. Who doesn’t like a little color!</p>
<p><a href="http://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55.png"><img fetchpriority="high" decoding="async" src="http://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55-1024x520.png" alt="A screenshot of Prompt with the preferences window open allowing the selection of numerous palettes with diverse color sets. The terminal window is recolored using colors from the palette." width="660" height="335" srcset="https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55-1024x520.png 1024w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55-300x152.png 300w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55-768x390.png 768w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55-1536x780.png 1536w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-12-28-55-2048x1040.png 2048w" sizes="(max-width: 660px) 100vw, 660px"/></a></p>
<p>There are some subtle performance choices that make for a better experience in Prompt. For example, I do like having a small amount of padding around the terminal so that rounded corners look nice and also avoids an extra framebuffer when rendering on the GPU. However, that looks odd with scrollback. So Prompt rewrites the snapshot from VTE to remove the background and extraneous clipping. We already have a background from window recoloring anyway. It’s a small detail that just feels good when using it.</p>
<p>Another subtle improvement is detecting when we are entering the tab overview. Currently, libadwaita uses a <code>GtkWidgetPaintable</code> to represent the tab contents. This works great for the likes of Epiphany where the contents are backed by GL textures. But for a terminal application we have a lot of text and we don’t want to redraw it scaled as would happen in this case. That puts a lot of pressure on the glyph cache. So instead, we create a single texture upfront and scale that texture. Much smoother.</p>
<p>For people writing terminal applications there is a little inspector you can popup to help you out. It can be difficult to know if you’re doing the right thing or getting the right behavior so this might be something we can extend going forward to make that easier for you. GTK’s inspector already does so much so this is just an extension of what you could do there.</p>
<p><a href="http://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16.png"><img decoding="async" src="http://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16-1024x520.png" alt="A terminal window open with a secondary &#34;inspector&#34; window open. The inspector shows what column and row the mouse is positioned as well as the cursor and what non-visible OSC hyperlink is under the pointer." width="660" height="335" srcset="https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16-1024x520.png 1024w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16-300x152.png 300w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16-768x390.png 768w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16-1536x780.png 1536w, https://blogs.gnome.org/chergert/files/2023/12/Screenshot-from-2023-12-14-14-46-16-2048x1040.png 2048w" sizes="(max-width: 660px) 100vw, 660px"/></a></p>
<p>Creating Prompt has elevated problems we should fix.</p>
<ul>
<li>Podman creates an additional PTY which sort of breaks the whole notion of foreground processes. <a href="https://github.com/containers/podman/issues/20767">Filed an issue upstream</a> and it seems likely we can get that addressed for personal containers. That will improve what happens when you close your terminal tab with something running or if you SSH’d into another host from the container.</li>
<li>Container tracking is currently limited to Fedora hosts because <code>toolbox</code> only emits the container-tracking escape sequences when the host is Fedora. The current goal I’ve discussed with VTE maintainers is that we’ll use a new “termprop” feature in VTE that will be silently dropped on terminal applications not interested in it. That way <code>toolbox</code> and the likes can safely emit the escape sequence.</li>
<li>Currently podman will exit if you pass a <code>--user</code> or <code>--workdir</code> that does not exist in the container. That isn’t a problem with <code>toolbox</code> as it is always your user and fails gracefully for directories. So we need a good strategy to see if both of those are available to inherit when creating new tabs.</li>
<li>This does have transparency support, but it’s hidden in a GSetting for now. Once we have libadwaita with CSS variable support we can probably make this look better during transitions which is where it falls down now. We also need some work on how <code>AdwTabOverview</code> does snapshots of tabs and inserts a background.</li>
<li>I have a <a href="https://gitlab.gnome.org/chergert/prompt/-/blob/main/README.md?ref_type=heads#jhbuild"><code>.bashrc</code> snippet</a> to treat <code>jhbuild</code> as a container which is helpful for those of us GNOME developers still using it.</li>
<li>Accessibility is an extremely important piece of our infrastructure in GNOME. So part of this work will inevitably tie into making sure the a11y portion of VTE works with the soon-to-land a11y improvements in GTK. That has always been missing on GTK 4-based VTE and therefore every terminal based upon it.</li>
</ul>
<pre>$ flatpak install --user --from <a href="https://nightly.gnome.org/repo/appstream/org.gnome.Prompt.Devel.flatpakref">https://nightly.gnome.org/repo/appstream/org.gnome.Prompt.Devel.flatpakref</a>
</pre>
<p>If you like software that I write, consider donating to a pet shelter near you this holiday season. We’re so lucky to have great pet care in Oregon but not everywhere is so lucky.</p>
<p>Happy Holiday Hacking!</p>
	</div><!-- .entry-content -->

	
	<!-- .entry-footer -->

</article></div>
  </body>
</html>
