<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.bbc.com/future/article/20231025-the-surprisingly-subtle-ways-microsoft-word-has-changed-the-way-we-use-language">Original</a>
    <h1>Subtle ways Microsoft Word has changed how we use language</h1>
    
    <div id="readability-page-1" class="page"><article>
      <section>
        
        
        01 Nov, 2023
      </section>

      
      <h2>Exploring Postgres internals by adding a new data type.</h2>
      <p><b>Disclaimer</b>: This is my second post on my experiment with Postgres internals. I&#39;m still pretty new to this, and I have only explored a few things in the source code, so please let me know if I did things incorrectly.
</p>

<p><em>Edit</em>: I’ve pushed my changes <a href="https://github.com/burntcarrot/postgres/tree/color-type" rel="nofollow">here</a>, feel free to check it out!</p>

<h2>Introduction</h2>

<p>Two days in, I’ve made some tiny baby steps in understanding how this thing works. In my <a href="https://www.aadhav.me/posts/pg-experiments-part-1" rel="nofollow">previous experiment</a>, I was tinkering with <code>+</code> operator logic, so I decided it would be a nice time to explore what it takes to write my own data type.</p>

<p>After doing some research on this, I found out that the easiest way to do it was to develop an extension which would have the logic for the data type. You plug it in into Postgres, and it works as intended. But I wanted to explore further; building an extension didn’t feel like a challenge.</p>

<p>I wanted to add a new “in-built” data type by trying to tweak with Postgres’ backend. <em>Why?</em> Because it’s fun to break things and fix it. I took up the challenge and started finding things out….</p>

<h2>Initial exploration</h2>

<p>As we saw in the <a href="https://www.aadhav.me/posts/pg-experiments-part-1" rel="nofollow">previous experiment</a>, logic for ADTs (abstract data types) is present in <a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=tree;f=src/backend/utils/adt;hb=HEAD" rel="nofollow"><code>src/backend/utils/adt</code></a>, so it made sense to explore this area once again. In order to not get intimidated by complex logic, I tried to search for an ADT which was easy to follow and had minimal logic.</p>

<p>I found <a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/bool.c;h=16ae96a8ff4e86488811f1df32a46e914d9c1ffe;hb=HEAD" rel="nofollow"><code>bool.c</code></a> to be a nice candidate for exploration; it was pretty easy to follow, and gave me an idea about how ADTs are structured. One pattern I found out was that all ADTs seem to implement an interface; most of them had function names with common suffixes like <code>in</code>, <code>out</code>, <code>send</code>, <code>recv</code>. On exploring further, it made sense:</p>

<ul>
<li><code>in</code> is meant for converting an external representation to your ADT’s internal representation</li>
<li><code>out</code> is meant for converting your ADT’s internal representation to an external representation</li>
<li><code>send</code> is meant for converting your ADT’s internal representation to a binary representation</li>
<li><code>recv</code> is meant for converting an external binary representation to your ADT’s internal representation</li>
</ul>

<p>ADTs must always have input and output functions. <code>send</code> and <code>recv</code> are optional and are used for providing binary input and output routines.</p>

<p>For this experiment, I wanted to build a custom <code>color</code> type which would store hex values and if possible, it should support operations on top of it. And since I haven’t looked into the internals of how colors are represented, this was the perfect opportunity.</p>

<h2>Implementing the color type</h2>

<p>After multiple failed attempts and rewrites, I was finally happy with the internal representation for <code>color</code> - an <code>uint32</code> integer:</p>
<pre tabindex="0"><code><span><span><span>/*-------------------------------------------------------------------------
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * color.c
</span></span></span><span><span><span> *	  PostgreSQL type definition for a custom &#39;color&#39; data type.
</span></span></span><span><span><span> *
</span></span></span><span><span><span> *-------------------------------------------------------------------------
</span></span></span><span><span><span> */</span>
</span></span><span><span>
</span></span><span><span><span>#</span><span>include</span> <span>&#34;postgres.h&#34;</span><span>
</span></span></span><span><span><span></span><span>#</span><span>include</span> <span>&#34;fmgr.h&#34;</span><span>
</span></span></span><span><span><span></span><span>#</span><span>include</span> <span>&#34;utils/builtins.h&#34;</span><span>
</span></span></span><span><span><span></span><span>#</span><span>include</span> <span>&#34;libpq/pqformat.h&#34;</span><span>
</span></span></span><span><span><span></span>
</span></span><span><span><span>typedef</span> <span>uint32</span> <span>color</span><span>;</span>
</span></span><span><span>
</span></span><span><span><span>#</span><span>define COLOR_RED_SHIFT 16</span><span>
</span></span></span><span><span><span></span><span>#</span><span>define COLOR_GREEN_SHIFT 8</span><span>
</span></span></span><span><span><span></span><span>#</span><span>define COLOR_BLUE_SHIFT 0</span><span>
</span></span></span><span><span><span></span><span>#</span><span>define COLOR_CHANNEL_MASK 0xFF</span><span>
</span></span></span></code></pre>
<p>Next thing to do was to implement the input function. To implement it, I took a <code>cstring</code> as input and converted it to an <code>uint32</code> by using <code>scanf</code>:</p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * color_in - Color reader. Accepts a hexadecimal string as the input, and converts it to a color value.
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_in</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_in</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>char</span> <span>*</span><span>str</span> <span>=</span> <span>PG_GETARG_CSTRING</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>uint32</span> <span>c</span> <span>=</span> <span>0</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>if</span> <span>(</span><span>sscanf</span><span>(</span><span>str</span><span>,</span> <span></span><span>&#34;</span><span>%06X</span><span>&#34;</span><span>,</span> <span>&amp;</span><span>c</span><span>)</span> <span>!</span><span>=</span> <span>1</span><span>)</span> <span>{</span>
</span></span><span><span>        <span>ereport</span><span>(</span><span>ERROR</span><span>,</span> <span>(</span><span>errcode</span><span>(</span><span>ERRCODE_INVALID_TEXT_REPRESENTATION</span><span>)</span><span>,</span>
</span></span><span><span>                        <span>errmsg</span><span>(</span><span></span><span>&#34;</span><span>invalid input syntax for type color: </span><span>\&#34;</span><span>%s</span><span>\&#34;</span><span>&#34;</span><span>,</span> <span>str</span><span>)</span><span>)</span><span>)</span><span>;</span>
</span></span><span><span>    <span>}</span>
</span></span><span><span>
</span></span><span><span>    <span>PG_RETURN_UINT32</span><span>(</span><span>c</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<p>The output function takes an <code>uint32</code> as an argument, and converts it to a hexadecimal string using <code>snprintf</code>:</p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * color_out - Color output function. Converts the internal color value to a hexadecimal string representation.
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_out</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_out</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>uint32</span> <span>c</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>char</span> <span>str</span><span>[</span><span>7</span><span>]</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Format color as a 6-character hexadecimal string
</span></span></span><span><span><span></span>    <span>snprintf</span><span>(</span><span>str</span><span>,</span> <span>sizeof</span><span>(</span><span>str</span><span>)</span><span>,</span> <span></span><span>&#34;</span><span>%06X</span><span>&#34;</span><span>,</span> <span>c</span><span>)</span><span>;</span>
</span></span><span><span>    <span>PG_RETURN_CSTRING</span><span>(</span><span>pstrdup</span><span>(</span><span>str</span><span>)</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<h2>Send and receive routines</h2>

<p>Implementing <code>send</code> and <code>recv</code> was tricky. I checked <a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/bool.c;h=16ae96a8ff4e86488811f1df32a46e914d9c1ffe;hb=HEAD#l183" rel="nofollow"><code>bool</code>’s implementation</a> and it seemed to use a few things from <code>pg_format.c</code>, which had an interesting comment:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/libpq/pqformat.c;h=d712c80b5e76b7b488211291bbb63c51203c7cad;hb=HEAD#l2" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/libpq/pqformat.c;h=d712c80b5e76b7b488211291bbb63c51203c7cad;hb=HEAD#l2</a>)</p>
<pre tabindex="0"><code><span><span><span>/*-------------------------------------------------------------------------
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * pqformat.c
</span></span></span><span><span><span> *		Routines for formatting and parsing frontend/backend messages
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * Outgoing messages are built up in a StringInfo buffer (which is expansible)
</span></span></span><span><span><span> * and then sent in a single call to pq_putmessage.  This module provides data
</span></span></span><span><span><span> * formatting/conversion routines that are needed to produce valid messages.
</span></span></span><span><span><span> * Note in particular the distinction between &#34;raw data&#34; and &#34;text&#34;; raw data
</span></span></span><span><span><span> * is message protocol characters and binary values that are not subject to
</span></span></span><span><span><span> * character set conversion, while text is converted by character encoding
</span></span></span><span><span><span> * rules.
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * Incoming messages are similarly read into a StringInfo buffer, via
</span></span></span><span><span><span> * pq_getmessage, and then parsed and converted from that using the routines
</span></span></span><span><span><span> * in this module.
</span></span></span></code></pre>
<p>This is exactly what I needed to understand. So, I needed to store my message in a buffer of type <code>StringInfo</code>. <em>But wait</em>. Wasn’t the buffer of type <code>StringInfoData</code> in <code>bool.c</code>?</p>

<p><em>Let me check. Oh, okay.</em></p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/lib/stringinfo.h;h=598ed093dc8757fd08f089b0a1c3cb15ec0c37d0;hb=HEAD#l22" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/lib/stringinfo.h;h=598ed093dc8757fd08f089b0a1c3cb15ec0c37d0;hb=HEAD#l22</a>)</p>
<pre tabindex="0"><code><span><span><span>typedef</span> <span>struct</span> <span>StringInfoData</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>char</span>	   <span>*</span><span>data</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>len</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>maxlen</span><span>;</span>
</span></span><span><span>	<span>int</span>			<span>cursor</span><span>;</span>
</span></span><span><span><span>}</span> <span>StringInfoData</span><span>;</span>
</span></span><span><span>
</span></span><span><span><span>typedef</span> <span>StringInfoData</span> <span>*</span><span>StringInfo</span><span>;</span>
</span></span></code></pre>
<p>The interface routines are also neatly specified in the code:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/libpq/pqformat.c;h=d712c80b5e76b7b488211291bbb63c51203c7cad;hb=HEAD#l32" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/libpq/pqformat.c;h=d712c80b5e76b7b488211291bbb63c51203c7cad;hb=HEAD#l32</a>)</p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * INTERFACE ROUTINES
</span></span></span><span><span><span> * Message assembly and output:
</span></span></span><span><span><span> *		pq_beginmessage - initialize StringInfo buffer
</span></span></span><span><span><span> *		pq_sendbyte		- append a raw byte to a StringInfo buffer
</span></span></span><span><span><span> *		pq_sendint		- append a binary integer to a StringInfo buffer
</span></span></span><span><span><span> *		pq_sendint64	- append a binary 8-byte int to a StringInfo buffer
</span></span></span><span><span><span> *		pq_sendfloat4	- append a float4 to a StringInfo buffer
</span></span></span><span><span><span> *		pq_sendfloat8	- append a float8 to a StringInfo buffer
</span></span></span><span><span><span> *		pq_sendbytes	- append raw data to a StringInfo buffer
</span></span></span><span><span><span> *		pq_sendcountedtext - append a counted text string (with character set conversion)
</span></span></span><span><span><span> *		pq_sendtext		- append a text string (with conversion)
</span></span></span><span><span><span> *		pq_sendstring	- append a null-terminated text string (with conversion)
</span></span></span><span><span><span> *		pq_send_ascii_string - append a null-terminated text string (without conversion)
</span></span></span><span><span><span> *		pq_endmessage	- send the completed message to the frontend
</span></span></span><span><span><span> * Note: it is also possible to append data to the StringInfo buffer using
</span></span></span><span><span><span> * the regular StringInfo routines, but this is discouraged since required
</span></span></span><span><span><span> * character set conversion may not occur.
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * typsend support (construct a bytea value containing external binary data):
</span></span></span><span><span><span> *		pq_begintypsend - initialize StringInfo buffer
</span></span></span><span><span><span> *		pq_endtypsend	- return the completed string as a &#34;bytea*&#34;
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * Special-case message output:
</span></span></span><span><span><span> *		pq_puttextmessage - generate a character set-converted message in one step
</span></span></span><span><span><span> *		pq_putemptymessage - convenience routine for message with empty body
</span></span></span><span><span><span> *
</span></span></span><span><span><span> * Message parsing after input:
</span></span></span><span><span><span> *		pq_getmsgbyte	- get a raw byte from a message buffer
</span></span></span><span><span><span> *		pq_getmsgint	- get a binary integer from a message buffer
</span></span></span><span><span><span> *		pq_getmsgint64	- get a binary 8-byte int from a message buffer
</span></span></span><span><span><span> *		pq_getmsgfloat4 - get a float4 from a message buffer
</span></span></span><span><span><span> *		pq_getmsgfloat8 - get a float8 from a message buffer
</span></span></span><span><span><span> *		pq_getmsgbytes	- get raw data from a message buffer
</span></span></span><span><span><span> *		pq_copymsgbytes - copy raw data from a message buffer
</span></span></span><span><span><span> *		pq_getmsgtext	- get a counted text string (with conversion)
</span></span></span><span><span><span> *		pq_getmsgstring - get a null-terminated text string (with conversion)
</span></span></span><span><span><span> *		pq_getmsgrawstring - get a null-terminated text string - NO conversion
</span></span></span><span><span><span> *		pq_getmsgend	- verify message fully consumed
</span></span></span><span><span><span> */</span>
</span></span></code></pre>
<p>For my <code>color</code> type, I needed the following:</p>

<ul>
<li><code>pq_begintypsend</code>: for initializing the buffer</li>
<li><code>pq_endtypsend</code>: for “finalizing” the buffer and converting the buffer contents to <code>bytea</code></li>
<li><code>pq_sendint</code>: for appending an integer to the buffer</li>
<li><code>pq_getmsgint</code>: for getting a binary integer from the buffer</li>
</ul>

<p>Cool. Let’s use these routines for building our send and receive functionality:</p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * color_send - converts color to binary format
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_send</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_send</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>uint32</span> <span>c</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>StringInfoData</span> <span>buf</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>pq_begintypsend</span><span>(</span><span>&amp;</span><span>buf</span><span>)</span><span>;</span>
</span></span><span><span>    <span>pq_sendint</span><span>(</span><span>&amp;</span><span>buf</span><span>,</span> <span>c</span><span>,</span> <span>4</span><span>)</span><span>;</span>
</span></span><span><span>    <span>PG_RETURN_BYTEA_P</span><span>(</span><span>pq_endtypsend</span><span>(</span><span>&amp;</span><span>buf</span><span>)</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>/*
</span></span></span><span><span><span> * color_recv - converts external binary format back to the internal color type
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_recv</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_recv</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>StringInfo</span> <span>buf</span> <span>=</span> <span>(</span><span>StringInfo</span><span>)</span> <span>PG_GETARG_POINTER</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>uint32</span> <span>c</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>c</span> <span>=</span> <span>pq_getmsgint</span><span>(</span><span>buf</span><span>,</span> <span>4</span><span>)</span><span>;</span>
</span></span><span><span>    <span>PG_RETURN_UINT32</span><span>(</span><span>c</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<h2>Figuring out the system catalog</h2>

<p>Before testing it out, these functions should be registered in the <code>pg_proc</code> catalog (<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/catalog/pg_proc.dat;h=091f7e343c3da673036ea7fbd57304e1dadbfe39;hb=HEAD" rel="nofollow"><code>pg_proc.dat</code></a>). Entries in <code>pg_proc.dat</code> define the functions associated with your custom data type, specify their return types, and declare the argument types they accept. Here’s what I added to <code>pg_proc.dat</code> for my <code>color</code> type:</p>
<pre tabindex="0"><code><span><span>{ oid =&gt; &#39;7901&#39;, proname =&gt; &#39;color_in&#39;, prorettype =&gt; &#39;color&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;cstring&#39;, prosrc =&gt; &#39;color_in&#39; },
</span></span><span><span>{ oid =&gt; &#39;7902&#39;, proname =&gt; &#39;color_out&#39;, prorettype =&gt; &#39;cstring&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;color&#39;, prosrc =&gt; &#39;color_out&#39; },
</span></span><span><span>{ oid =&gt; &#39;7903&#39;, proname =&gt; &#39;color_send&#39;, prorettype =&gt; &#39;bytea&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;color&#39;, prosrc =&gt; &#39;color_send&#39; },
</span></span><span><span>{ oid =&gt; &#39;7904&#39;, proname =&gt; &#39;color_recv&#39;, prorettype =&gt; &#39;color&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;internal&#39;, prosrc =&gt; &#39;color_recv&#39; },
</span></span></code></pre>
<p>I’ll try to explain what these keys are (as per my understanding):</p>

<ul>
<li><code>oid</code>: This field specifies the OID (Object Identifier) of the function. OIDs are unique identifiers for objects in the PostgreSQL system catalog. (I had to find OIDs which aren’t referenced anywhere.) (There is a <a href="https://wiki.postgresql.org/wiki/Developer_FAQ#What_tools_are_available_for_developers.3F" rel="nofollow">tool (unused_oids)</a> to help simplify this process!)</li>
<li><code>proname</code>: The name of the function.</li>
<li><code>prorettype</code>: It specifies the return data type of the function. In this case, the function <code>color_in</code> returns the <code>color</code> data type.</li>
<li><code>proargtypes</code>: Defines the argument types of the function. <code>&#39;cstring&#39;</code> indicates that the input function <code>color_in</code> accepts a single argument of type <code>cstring</code>.</li>
<li><code>prosrc</code>: The function’s C-language name (link symbol).</li>
</ul>

<p>And now to register the <code>color</code> type, I added this to the type system catalog (<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/catalog/pg_type.h;h=508ba7b0f71c6a82694e3d4c1242a346b560421b;hb=HEAD" rel="nofollow"><code>pg_type.dat</code></a>):</p>
<pre tabindex="0"><code><span><span># custom type (color)
</span></span><span><span>{ oid =&gt; &#39;7012&#39;, array_type_oid =&gt; &#39;7201&#39;,
</span></span><span><span>  descr =&gt; &#39;color data type&#39;,
</span></span><span><span>  typname =&gt; &#39;color&#39;, typlen =&gt; &#39;4&#39;, typbyval =&gt; &#39;t&#39;, typcategory =&gt; &#39;N&#39;,
</span></span><span><span>  typinput =&gt; &#39;color_in&#39;, typoutput =&gt; &#39;color_out&#39;, typreceive =&gt; &#39;color_recv&#39;,
</span></span><span><span>  typsend =&gt; &#39;color_send&#39;, typalign =&gt; &#39;i&#39;, typstorage =&gt; &#39;x&#39; },
</span></span></code></pre>
<p>Each of these fields is explained nicely in the <a href="https://www.postgresql.org/docs/current/catalog-pg-type.html" rel="nofollow">documentation</a>. I’ve used <code>typstorage</code> as <code>x</code> because I didn’t know a suitable storage strategy, <em>maybe <code>p</code> is the correct way to do it?</em></p>

<blockquote>
<p><em>Edit</em>: Thanks to <a href="https://github.com/pjungwir" rel="nofollow">Paul Jungwirth</a> for letting me know that <code>p</code> (plain storage) should be the best choice for <code>typstorage</code>, as the <code>color</code> type is essentially a <code>uint32</code> and is fixed-width in nature.</p>
</blockquote>

<h2>Solving compilation errors</h2>

<p>I was excited to test it out, so I set up everything:</p>
<pre tabindex="0"><code><span><span>$ ./configure --prefix<span>=</span><span>$(</span><span>pwd</span><span>)</span>/test-install
</span></span><span><span>$ make -j8 <span>&amp;&amp;</span> make install
</span></span><span><span>$ ./test-install/bin/initdb <span>$(</span><span>pwd</span><span>)</span>/test-data <span># Create a database</span>
</span></span><span><span>$ <span>echo</span> <span>&#34;port=8080&#34;</span> &gt; <span>$(</span><span>pwd</span><span>)</span>/postgres.conf <span># This is the minimal postgres run config</span>
</span></span><span><span>$ mkdir test-run <span># Place for postgres to put lock files</span>
</span></span><span><span>$ ./test-install/bin/postgres --config-file<span>=</span><span>$(</span><span>pwd</span><span>)</span>/postgres.conf -D <span>$(</span><span>pwd</span><span>)</span>/test-data -k <span>$(</span><span>pwd</span><span>)</span>/test-run
</span></span></code></pre>
<p>But on compiling, I encountered this error:</p>
<pre tabindex="0"><code><span><span>Use of uninitialized value in sprintf at genbki.pl line 1027.
</span></span><span><span>unresolved OID reference &#34;color_in&#34; in pg_type.dat field typinput line
</span></span><span><span>Use of uninitialized value in sprintf at genbki.pl line 1027.
</span></span><span><span>unresolved OID reference &#34;color_out&#34; in pg_type.dat field typoutput line
</span></span><span><span>Use of uninitialized value in sprintf at genbki.pl line 1027.
</span></span><span><span>unresolved OID reference &#34;color_recv&#34; in pg_type.dat field typreceive line
</span></span><span><span>Use of uninitialized value in sprintf at genbki.pl line 1027.
</span></span><span><span>unresolved OID reference &#34;color_send&#34; in pg_type.dat field typsend line
</span></span><span><span>make[2]: *** [Makefile:172: bki-stamp] Error 1
</span></span><span><span>make[2]: Leaving directory &#39;/home/burntcarrot/postgresql/src/backend/catalog&#39;
</span></span><span><span>make[1]: *** [Makefile:141: submake-catalog-headers] Error 2
</span></span><span><span>make[1]: Leaving directory &#39;/home/burntcarrot/postgresql/src/backend&#39;
</span></span><span><span>make: *** [src/Makefile.global:385: submake-generated-headers] Error 2
</span></span></code></pre>
<p>The error is originating from <code>genbki.pl</code>, which is a Perl script which generates <code>postgres.bki</code>:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/catalog/genbki.pl;h=380bc23c82e76ec175efd39100f9f76403c2250d;hb=HEAD#l4" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/catalog/genbki.pl;h=380bc23c82e76ec175efd39100f9f76403c2250d;hb=HEAD#l4</a>)</p>
<pre tabindex="0"><code><span><span><span>#!/usr/bin/perl</span>
</span></span><span><span><span>#----------------------------------------------------------------------</span>
</span></span><span><span><span>#</span>
</span></span><span><span><span># genbki.pl</span>
</span></span><span><span><span>#    Perl script that generates postgres.bki and symbol definition</span>
</span></span><span><span><span>#    headers from specially formatted header files and data files.</span>
</span></span><span><span><span>#    postgres.bki is used to initialize the postgres template database.</span>
</span></span><span><span><span>#</span>
</span></span><span><span><span># Portions Copyright (c) 1996-2023, PostgreSQL Global Development Group</span>
</span></span><span><span><span># Portions Copyright (c) 1994, Regents of the University of California</span>
</span></span><span><span><span>#</span>
</span></span><span><span><span># src/backend/catalog/genbki.pl</span>
</span></span><span><span><span>#</span>
</span></span><span><span><span>#----------------------------------------------------------------------</span>
</span></span></code></pre>
<p>And what is <code>postgres.bki</code>? On searching through the docs, I found this (<a href="https://www.postgresql.org/docs/current/bki.html" rel="nofollow">link</a>):</p>

<blockquote>
<p>To create the catalog files and load this initial data into them, a backend running in bootstrap mode reads a BKI (Backend Interface) file containing commands and initial data. The <code>postgres.bki</code> file used in this mode is prepared from the aforementioned header and data files, while building a PostgreSQL distribution, by a Perl script named <code>genbki.pl</code>.</p>
</blockquote>

<p>Wow. A <a href="https://dictionary.cambridge.org/dictionary/english/til" rel="nofollow">TIL</a> moment. But the problem wasn’t solved yet.</p>

<p>The origin of the error was on line <code>1027</code>, which seemed to have logic for performing OID lookups:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/catalog/genbki.pl;h=380bc23c82e76ec175efd39100f9f76403c2250d;hb=HEAD#l1025" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/catalog/genbki.pl;h=380bc23c82e76ec175efd39100f9f76403c2250d;hb=HEAD#l1025</a>)</p>
<pre tabindex="0"><code><span><span><span># ....</span>
</span></span><span><span>
</span></span><span><span><span># Perform OID lookups on an array of OID names.</span>
</span></span><span><span><span># If we don&#39;t have a unique value to substitute, warn and</span>
</span></span><span><span><span># leave the entry unchanged.</span>
</span></span><span><span><span># (We don&#39;t exit right away so that we can detect multiple problems</span>
</span></span><span><span><span># within this genbki.pl run.)</span>
</span></span><span><span><span>sub</span> <span>lookup_oids</span>
</span></span><span><span><span>{</span>
</span></span><span><span>	<span>my</span> <span>(</span><span>$</span><span>lookup</span><span>,</span> <span>$</span><span>catname</span><span>,</span> <span>$</span><span>attname</span><span>,</span> <span>$</span><span>lookup_opt</span><span>,</span> <span>$</span><span>bki_values</span><span>,</span> <span>@</span><span>lookupnames</span><span>)</span>
</span></span><span><span>	  <span>=</span> <span>@</span><span>_</span><span>;</span>
</span></span><span><span>
</span></span><span><span>	<span>my</span> <span>@</span><span>lookupoids</span><span>;</span>
</span></span><span><span>	<span>foreach</span> <span>my</span> <span>$</span><span>lookupname</span> <span>(</span><span>@</span><span>lookupnames</span><span>)</span>
</span></span><span><span>	<span>{</span>
</span></span><span><span>		<span>my</span> <span>$</span><span>lookupoid</span> <span>=</span> <span>$</span><span>lookup</span><span>-</span><span>&gt;</span><span>{</span><span>$</span><span>lookupname</span><span>}</span><span>;</span>
</span></span><span><span>		<span>if</span> <span>(</span><span>defined</span><span>(</span><span>$</span><span>lookupoid</span><span>)</span> <span>and</span> <span>$</span><span>lookupoid</span> <span>ne</span> <span>&#39;MULTIPLE&#39;</span><span>)</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>push</span> <span>@</span><span>lookupoids</span><span>,</span> <span>$</span><span>lookupoid</span><span>;</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>else</span>
</span></span><span><span>		<span>{</span>
</span></span><span><span>			<span>push</span> <span>@</span><span>lookupoids</span><span>,</span> <span>$</span><span>lookupname</span><span>;</span>
</span></span><span><span>			<span>if</span> <span>(</span><span>$</span><span>lookupname</span> <span>eq</span> <span>&#39;-&#39;</span> <span>or</span> <span>$</span><span>lookupname</span> <span>eq</span> <span>&#39;0&#39;</span><span>)</span>
</span></span><span><span>			<span>{</span>
</span></span><span><span>				<span>if</span> <span>(</span><span>!</span><span>$</span><span>lookup_opt</span><span>)</span>
</span></span><span><span>				<span>{</span>
</span></span><span><span>					<span>warn</span> <span>sprintf</span>
</span></span><span><span>					  <span>&#34;invalid zero OID reference in %s.dat field %s line %s\n&#34;</span><span>,</span>
</span></span><span><span>					  <span>$</span><span>catname</span><span>,</span> <span>$</span><span>attname</span><span>,</span> <span>$</span><span>bki_values</span><span>-</span><span>&gt;</span><span>{</span><span></span><span>line_number</span><span>}</span><span>;</span>
</span></span><span><span>					<span>$</span><span>num_errors</span><span>+</span><span>+</span><span>;</span>
</span></span><span><span>				<span>}</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>			<span>else</span>
</span></span><span><span>			<span>{</span>
</span></span><span><span>				<span>warn</span> <span>sprintf</span>
</span></span><span><span>				  <span>&#34;unresolved OID reference \&#34;%s\&#34; in %s.dat field %s line %s\n&#34;</span><span>,</span>
</span></span><span><span>				  <span>$</span><span>lookupname</span><span>,</span> <span>$</span><span>catname</span><span>,</span> <span>$</span><span>attname</span><span>,</span> <span>$</span><span>bki_values</span><span>-</span><span>&gt;</span><span>{</span><span></span><span>line_number</span><span>}</span><span>;</span>
</span></span><span><span>				<span>$</span><span>num_errors</span><span>+</span><span>+</span><span>;</span>
</span></span><span><span>			<span>}</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>return</span> <span>@</span><span>lookupoids</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span># ....</span>
</span></span></code></pre>
<p>And the error message reflects that too:</p>
<pre tabindex="0"><code><span><span>unresolved OID reference &#34;color_out&#34; in pg_type.dat field typoutput line
</span></span></code></pre>
<p><em>“Wait. How is my function not accessible to the Perl script?”</em></p>

<p>After some debugging, I found out that there was a <a href="https://mesonbuild.com/" rel="nofollow">Meson</a> config in the ADT directory, and it was missing my ADT’s source file, so I added it:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/meson.build;h=8515cd93650492cb79c74f58a5123a4ca59d9e31;hb=HEAD" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/meson.build;h=8515cd93650492cb79c74f58a5123a4ca59d9e31;hb=HEAD</a>)</p>
<pre tabindex="0"><code><span><span># Copyright (c) 2022-2023, PostgreSQL Global Development Group
</span></span><span><span>
</span></span><span><span>backend_sources += files(
</span></span><span><span>  &#39;acl.c&#39;,
</span></span><span><span>  &#39;amutils.c&#39;,
</span></span><span><span>  &#39;array_expanded.c&#39;,
</span></span><span><span>  &#39;array_selfuncs.c&#39;,
</span></span><span><span>  &#39;array_typanalyze.c&#39;,
</span></span><span><span>  &#39;array_userfuncs.c&#39;,
</span></span><span><span>  &#39;arrayfuncs.c&#39;,
</span></span><span><span>  &#39;arraysubs.c&#39;,
</span></span><span><span>  &#39;arrayutils.c&#39;,
</span></span><span><span>  &#39;ascii.c&#39;,
</span></span><span><span>  &#39;bool.c&#39;,
</span></span><span><span>  &#39;cash.c&#39;,
</span></span><span><span>  &#39;char.c&#39;,
</span></span><span><span>  &#39;color.c&#39;, &lt;-- added my ADT
</span></span><span><span>  &#39;cryptohashfuncs.c&#39;,
</span></span><span><span>  &#39;date.c&#39;,
</span></span><span><span>  &#39;datetime.c&#39;,
</span></span><span><span>  ....
</span></span></code></pre>
<p>I also needed to modify the <code>Makefile</code> inside <code>src/backend/utils/adt</code> to include the object file for my ADT:</p>

<p>(<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/Makefile;h=0de0bbb1b8ac7ccb60ea1ab39dbadf7004ea7586;hb=HEAD" rel="nofollow">https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/utils/adt/Makefile;h=0de0bbb1b8ac7ccb60ea1ab39dbadf7004ea7586;hb=HEAD</a>)</p>
<pre tabindex="0"><code><span><span><span>#
</span></span></span><span><span><span></span><span># Makefile for utils/adt
</span></span></span><span><span><span></span><span>#
</span></span></span><span><span><span></span><span># src/backend/utils/adt/Makefile
</span></span></span><span><span><span></span><span>#
</span></span></span><span><span><span></span>
</span></span><span><span><span>subdir</span> <span>=</span> src/backend/utils/adt
</span></span><span><span><span>top_builddir</span> <span>=</span> ../../../..
</span></span><span><span><span>i</span><span>n</span><span>c</span><span>l</span><span>u</span><span>d</span><span>e</span> <span>$(</span><span>top_builddir</span><span>)</span><span>/</span><span>s</span><span>r</span><span>c</span><span>/</span><span>M</span><span>a</span><span>k</span><span>e</span><span>f</span><span>i</span><span>l</span><span>e</span><span>.</span><span>g</span><span>l</span><span>o</span><span>b</span><span>a</span><span>l</span>
</span></span><span><span>
</span></span><span><span><span>override CPPFLAGS </span><span>:</span>= -<span>I</span>. -<span>I</span><span>$(</span><span>srcdir</span><span>)</span> <span>$(</span><span>CPPFLAGS</span><span>)</span>
</span></span><span><span>
</span></span><span><span><span># keep this list arranged alphabetically or it gets to be a mess
</span></span></span><span><span><span></span><span>OBJS</span> <span>=</span> <span>\
</span></span></span><span><span><span></span>	acl.o <span>\
</span></span></span><span><span><span></span>	amutils.o <span>\
</span></span></span><span><span><span></span>	array_expanded.o <span>\
</span></span></span><span><span><span></span>	array_selfuncs.o <span>\
</span></span></span><span><span><span></span>	array_typanalyze.o <span>\
</span></span></span><span><span><span></span>	array_userfuncs.o <span>\
</span></span></span><span><span><span></span>	arrayfuncs.o <span>\
</span></span></span><span><span><span></span>	arraysubs.o <span>\
</span></span></span><span><span><span></span>	arrayutils.o <span>\
</span></span></span><span><span><span></span>	ascii.o <span>\
</span></span></span><span><span><span></span>	bool.o <span>\
</span></span></span><span><span><span></span>	cash.o <span>\
</span></span></span><span><span><span></span>	char.o <span>\
</span></span></span><span><span><span></span>	color.o <span>\ </span> &lt;-- added my ADT
</span></span><span><span>	cryptohashfuncs.o <span>\
</span></span></span><span><span><span></span>	....
</span></span></code></pre>
<p>Now, on trying again, the compilation process worked perfectly. Time to test it out!</p>

<p><em>Edit</em>: If you change the system catalog (<code>.dat</code> files), you would need to re-initalize the DB:</p>
<pre tabindex="0"><code><span><span>$ rm -rf test-data
</span></span><span><span>$ ./test-install/bin/initdb <span>$(</span><span>pwd</span><span>)</span>/test-data <span># Re-create the database</span>
</span></span></code></pre>
<h2>Initial test with the color type</h2>

<p>I created a table with my <code>color</code> type:</p>
<pre tabindex="0"><code><span><span><span>postgres</span><span>=</span><span>#</span><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>color</span><span> </span><span>(</span><span>val</span><span> </span><span>color</span><span>)</span><span>;</span><span>
</span></span></span><span><span><span></span><span>CREATE</span><span> </span><span>TABLE</span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>INSERT</span><span> </span><span>INTO</span><span> </span><span>color</span><span> </span><span>VALUES</span><span> </span><span>(</span><span>&#39;</span><span>FF0000</span><span>&#39;</span><span>)</span><span>;</span><span>
</span></span></span><span><span><span></span><span>INSERT</span><span> </span><span>0</span><span> </span><span>1</span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>*</span><span> </span><span>FROM</span><span> </span><span>color</span><span>;</span><span>
</span></span></span><span><span><span>  </span><span>val</span><span>
</span></span></span><span><span><span></span><span>--------
</span></span></span><span><span><span></span><span> </span><span>FF0000</span><span>
</span></span></span><span><span><span></span><span>(</span><span>1</span><span> </span><span>row</span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>\</span><span>d</span><span> </span><span>color</span><span>
</span></span></span><span><span><span>              </span><span>Table</span><span> </span><span>&#34;</span><span>public.color</span><span>&#34;</span><span>
</span></span></span><span><span><span> </span><span>Column</span><span> </span><span>|</span><span> </span><span>Type</span><span>  </span><span>|</span><span> </span><span>Collation</span><span> </span><span>|</span><span> </span><span>Nullable</span><span> </span><span>|</span><span> </span><span>Default</span><span>
</span></span></span><span><span><span></span><span>--------+-------+-----------+----------+---------
</span></span></span><span><span><span></span><span> </span><span>val</span><span>    </span><span>|</span><span> </span><span>color</span><span> </span><span>|</span><span>           </span><span>|</span><span>          </span><span>|</span><span>
</span></span></span></code></pre>
<p>A sigh of relief. It worked!</p>

<p>This was a good start, but the type is of no use if we can’t perform operations on top of it. For getting started, I wanted to go ahead with an operator that “mixes” two colors and returns the result of type <code>color</code>.</p>

<h2>Implementing operators for the color type</h2>

<p>Color addition is tricky, there are different techniques to perform it; but to keep things simple, I chose <em>additive mixing</em> as the algorithm for color addition. I was able to implement this by taking help from some articles I found online:</p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * color_add - adds two values of type color and returns the result
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_add</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_add</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>color</span> <span>arg1</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>color</span> <span>arg2</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>1</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Extract the Red (R) channel component of arg1 and arg2 by shifting the bits
</span></span></span><span><span><span></span>    <span>// to the right and applying a bit mask to isolate the 8 bits representing the Red channel.
</span></span></span><span><span><span></span>    <span>uint32</span> <span>r1</span> <span>=</span> <span>(</span><span>arg1</span> <span>&gt;</span><span>&gt;</span> <span>COLOR_RED_SHIFT</span><span>)</span> <span>&amp;</span> <span>COLOR_CHANNEL_MASK</span><span>;</span>
</span></span><span><span>    <span>uint32</span> <span>r2</span> <span>=</span> <span>(</span><span>arg2</span> <span>&gt;</span><span>&gt;</span> <span>COLOR_RED_SHIFT</span><span>)</span> <span>&amp;</span> <span>COLOR_CHANNEL_MASK</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Extract the Green (G) channel component.
</span></span></span><span><span><span></span>    <span>uint32</span> <span>g1</span> <span>=</span> <span>(</span><span>arg1</span> <span>&gt;</span><span>&gt;</span> <span>COLOR_GREEN_SHIFT</span><span>)</span> <span>&amp;</span> <span>COLOR_CHANNEL_MASK</span><span>;</span>
</span></span><span><span>    <span>uint32</span> <span>g2</span> <span>=</span> <span>(</span><span>arg2</span> <span>&gt;</span><span>&gt;</span> <span>COLOR_GREEN_SHIFT</span><span>)</span> <span>&amp;</span> <span>COLOR_CHANNEL_MASK</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Extract the Blue (B) channel component.
</span></span></span><span><span><span></span>    <span>uint32</span> <span>b1</span> <span>=</span> <span>(</span><span>arg1</span> <span>&gt;</span><span>&gt;</span> <span>COLOR_BLUE_SHIFT</span><span>)</span> <span>&amp;</span> <span>COLOR_CHANNEL_MASK</span><span>;</span>
</span></span><span><span>    <span>uint32</span> <span>b2</span> <span>=</span> <span>(</span><span>arg2</span> <span>&gt;</span><span>&gt;</span> <span>COLOR_BLUE_SHIFT</span><span>)</span> <span>&amp;</span> <span>COLOR_CHANNEL_MASK</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Add the Red (R) channel components, ensuring that the result does not exceed
</span></span></span><span><span><span></span>    <span>// the maximum value represented by COLOR_CHANNEL_MASK (0xFF), which corresponds
</span></span></span><span><span><span></span>    <span>// to the upper limit of the Red channel. This prevents overflow.
</span></span></span><span><span><span></span>    <span>uint32</span> <span>r</span> <span>=</span> <span>Min</span><span>(</span><span>r1</span> <span>+</span> <span>r2</span><span>,</span> <span>COLOR_CHANNEL_MASK</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Add the Green (G) channel components.
</span></span></span><span><span><span></span>    <span>uint32</span> <span>g</span> <span>=</span> <span>Min</span><span>(</span><span>g1</span> <span>+</span> <span>g2</span><span>,</span> <span>COLOR_CHANNEL_MASK</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Add the Blue (B) channel components.
</span></span></span><span><span><span></span>    <span>uint32</span> <span>b</span> <span>=</span> <span>Min</span><span>(</span><span>b1</span> <span>+</span> <span>b2</span><span>,</span> <span>COLOR_CHANNEL_MASK</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Reconstruct the color by left-shifting the Red (R), Green (G), and Blue (B)
</span></span></span><span><span><span></span>    <span>// components back to their original bit positions and combining them with the OR (|) operation.
</span></span></span><span><span><span></span>    <span>color</span> <span>result_color</span> <span>=</span> <span>(</span><span>r</span> <span>&lt;</span><span>&lt;</span> <span>COLOR_RED_SHIFT</span><span>)</span> <span>|</span> <span>(</span><span>g</span> <span>&lt;</span><span>&lt;</span> <span>COLOR_GREEN_SHIFT</span><span>)</span> <span>|</span> <span>(</span><span>b</span> <span>&lt;</span><span>&lt;</span> <span>COLOR_BLUE_SHIFT</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// Return the final color as a uint32 value.
</span></span></span><span><span><span></span>    <span>PG_RETURN_UINT32</span><span>(</span><span>result_color</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<p>In addition to this, I thought it would be a good idea to add support for equality and inequality operators as the implementation would be fairly easy, due to the internal representation of color being a <code>uint32</code>:</p>
<pre tabindex="0"><code><span><span><span>/*
</span></span></span><span><span><span> * color_eq - checks for equality between two values of type color
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_eq</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_eq</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>color</span> <span>arg1</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>color</span> <span>arg2</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>1</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>PG_RETURN_BOOL</span><span>(</span><span>arg1</span> <span>=</span><span>=</span> <span>arg2</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>/*
</span></span></span><span><span><span> * color_ne - checks for inequality between two values of type color
</span></span></span><span><span><span> */</span>
</span></span><span><span><span>PG_FUNCTION_INFO_V1</span><span>(</span><span>color_ne</span><span>)</span><span>;</span>
</span></span><span><span><span>Datum</span> <span>color_ne</span><span>(</span><span>PG_FUNCTION_ARGS</span><span>)</span>
</span></span><span><span><span>{</span>
</span></span><span><span>    <span>color</span> <span>arg1</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>0</span><span>)</span><span>;</span>
</span></span><span><span>    <span>color</span> <span>arg2</span> <span>=</span> <span>PG_GETARG_UINT32</span><span>(</span><span>1</span><span>)</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>PG_RETURN_BOOL</span><span>(</span><span>arg1</span> <span>!</span><span>=</span> <span>arg2</span><span>)</span><span>;</span>
</span></span><span><span><span>}</span>
</span></span></code></pre>
<p>Nice! Now, I had support for these operators: <code>=</code>, <code>&lt;&gt;</code> and <code>+</code>.</p>

<p>To register these functions in the catalog (<code>pg_proc.dat</code>), I followed the same process:</p>
<pre tabindex="0"><code><span><span>{ oid =&gt; &#39;7905&#39;, proname =&gt; &#39;color_eq&#39;, prorettype =&gt; &#39;bool&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;color color&#39;, prosrc =&gt; &#39;color_eq&#39; },
</span></span><span><span>{ oid =&gt; &#39;7906&#39;, proname =&gt; &#39;color_ne&#39;, prorettype =&gt; &#39;bool&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;color color&#39;, prosrc =&gt; &#39;color_ne&#39; },
</span></span><span><span>{ oid =&gt; &#39;7907&#39;, proname =&gt; &#39;color_add&#39;, prorettype =&gt; &#39;color&#39;,
</span></span><span><span>  proargtypes =&gt; &#39;color color&#39;, prosrc =&gt; &#39;color_add&#39; },
</span></span></code></pre>
<p>In order to register operators for the <code>color</code> type, I added the following to the <code>pg_operator</code> system catalog (<a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/catalog/pg_operator.dat;h=b2cdea66c4bf8ea542795fe09e03485316f11540;hb=HEAD" rel="nofollow"><code>pg_operator.dat</code></a>):</p>
<pre tabindex="0"><code><span><span># custom color type
</span></span><span><span>
</span></span><span><span>{ oid =&gt; &#39;7915&#39;, descr =&gt; &#39;equal&#39;,
</span></span><span><span>  oprname =&gt; &#39;=&#39;, oprcanmerge =&gt; &#39;t&#39;, oprcanhash =&gt; &#39;t&#39;, oprleft =&gt; &#39;color&#39;,
</span></span><span><span>  oprright =&gt; &#39;color&#39;, oprresult =&gt; &#39;bool&#39;, oprcom =&gt; &#39;=(color,color)&#39;,
</span></span><span><span>  oprnegate =&gt; &#39;&lt;&gt;(color,color)&#39;, oprcode =&gt; &#39;color_eq&#39; },
</span></span><span><span>{ oid =&gt; &#39;7916&#39;, descr =&gt; &#39;not equal&#39;,
</span></span><span><span>  oprname =&gt; &#39;&lt;&gt;&#39;, oprcanmerge =&gt; &#39;t&#39;, oprcanhash =&gt; &#39;t&#39;, oprleft =&gt; &#39;color&#39;,
</span></span><span><span>  oprright =&gt; &#39;color&#39;, oprresult =&gt; &#39;bool&#39;, oprcom =&gt; &#39;&lt;&gt;(color,color)&#39;,
</span></span><span><span>  oprnegate =&gt; &#39;=(color,color)&#39;, oprcode =&gt; &#39;color_ne&#39; },
</span></span><span><span>{ oid =&gt; &#39;7917&#39;, descr =&gt; &#39;add&#39;,
</span></span><span><span>  oprname =&gt; &#39;+&#39;, oprleft =&gt; &#39;color&#39;, oprright =&gt; &#39;color&#39;, oprresult =&gt; &#39;color&#39;,
</span></span><span><span>  oprcom =&gt; &#39;+(color,color)&#39;, oprcode =&gt; &#39;color_add&#39; },
</span></span></code></pre>
<p>Here’s what these fields mean:</p>

<ul>
<li><code>oid</code>: OID (Object Identifier)</li>
<li><code>descr</code>: A short description of the operator.</li>
<li><code>oprname</code>: The name of the operator. It is the symbol or name used to invoke the operator, for example: <code>=</code>, <code>&lt;&gt;</code>, or <code>+</code>.</li>
<li><code>oprcanmerge</code>: This is a boolean flag (<code>t</code>/<code>f</code>) indicating whether the operator supports merge joins. (I’ve kept it as <code>t</code> for now, but I’d be glad to know the suitable value for this.)</li>
<li><code>oprcanhash</code>: This is a boolean flag (<code>t</code>/<code>f</code>) indicating whether the operator supports hash joins. (I’ve kept it as <code>t</code> for now.)</li>
<li><code>oprleft</code>: The left operand data type of the operator.</li>
<li><code>oprright</code>: The right operand data type of the operator.</li>
<li><code>oprresult</code>: The data type of the result produced by the operator.</li>
<li><code>oprcom</code>: This specifies the commutator operator. The commutator is another operator that has the same functionality but with the operand order reversed. For example, <code>=</code> and <code>=</code> are commutator operators of each other.</li>
<li><code>oprnegate</code>: The negate operator for a comparison operator. It represents the opposite of the operator. For <code>=</code>, its negate is <code>&lt;&gt;</code>.</li>
<li><code>oprcode</code>: This refers to the function implementing the operator.</li>
</ul>

<h2>The final test</h2>

<p>To test it out, I recompiled and was excited to see if the operators worked perfectly:</p>
<pre tabindex="0"><code><span><span><span>postgres</span><span>=</span><span>#</span><span> </span><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>color</span><span> </span><span>(</span><span>val</span><span> </span><span>color</span><span>)</span><span>;</span><span>
</span></span></span><span><span><span></span><span>CREATE</span><span> </span><span>TABLE</span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>INSERT</span><span> </span><span>INTO</span><span> </span><span>color</span><span> </span><span>VALUES</span><span> </span><span>(</span><span>&#39;</span><span>FF0000</span><span>&#39;</span><span>)</span><span>;</span><span>
</span></span></span><span><span><span></span><span>INSERT</span><span> </span><span>0</span><span> </span><span>1</span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>*</span><span> </span><span>FROM</span><span> </span><span>color</span><span>;</span><span>
</span></span></span><span><span><span>  </span><span>val</span><span>
</span></span></span><span><span><span></span><span>--------
</span></span></span><span><span><span></span><span> </span><span>FF0000</span><span>
</span></span></span><span><span><span></span><span>(</span><span>1</span><span> </span><span>row</span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>val</span><span>+</span><span>&#39;</span><span>00FF00</span><span>&#39;</span><span> </span><span>FROM</span><span> </span><span>color</span><span>;</span><span>
</span></span></span><span><span><span> </span><span>?</span><span>column</span><span>?</span><span>
</span></span></span><span><span><span></span><span>----------
</span></span></span><span><span><span></span><span> </span><span>FFFF00</span><span>
</span></span></span><span><span><span></span><span>(</span><span>1</span><span> </span><span>row</span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>&#39;</span><span>FF0000</span><span>&#39;</span><span>:</span><span>:</span><span>color</span><span> </span><span>+</span><span> </span><span>&#39;</span><span>00FF00</span><span>&#39;</span><span>:</span><span>:</span><span>color</span><span>;</span><span>
</span></span></span><span><span><span> </span><span>?</span><span>column</span><span>?</span><span>
</span></span></span><span><span><span></span><span>----------
</span></span></span><span><span><span></span><span> </span><span>FFFF00</span><span>
</span></span></span><span><span><span></span><span>(</span><span>1</span><span> </span><span>row</span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>*</span><span> </span><span>FROM</span><span> </span><span>color</span><span> </span><span>WHERE</span><span> </span><span>val</span><span>=</span><span>&#39;</span><span>FF0000</span><span>&#39;</span><span>;</span><span>
</span></span></span><span><span><span>  </span><span>val</span><span>
</span></span></span><span><span><span></span><span>--------
</span></span></span><span><span><span></span><span> </span><span>FF0000</span><span>
</span></span></span><span><span><span></span><span>(</span><span>1</span><span> </span><span>row</span><span>)</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>postgres</span><span>=</span><span>#</span><span> </span><span>SELECT</span><span> </span><span>*</span><span> </span><span>FROM</span><span> </span><span>color</span><span> </span><span>WHERE</span><span> </span><span>val</span><span>&lt;</span><span>&gt;</span><span>&#39;</span><span>FF0000</span><span>&#39;</span><span>;</span><span>
</span></span></span><span><span><span> </span><span>val</span><span>
</span></span></span><span><span><span></span><span>-----
</span></span></span><span><span><span></span><span>(</span><span>0</span><span> </span><span>rows</span><span>)</span><span>
</span></span></span></code></pre>
<p>Yay! The operators work as intended, and I was finally relieved to see how it turned out. It may not be perfect, but it was exciting to work on!</p>

<p>I’ve pushed these changes <a href="https://github.com/burntcarrot/postgres/tree/color-type" rel="nofollow">here</a>, please feel free to check it out!</p>

<h2>Conclusion</h2>

<p>Yes, I should have <a href="https://en.wikipedia.org/wiki/RTFM" rel="nofollow">RTFM</a>’d it. But honestly, this was more fun. If I had already knew about which routines to use, how to structure things, it wouldn’t have been interesting.</p>

<p>I spent 2 days on this, and I’d like to say: it was worth it. I’ll take a break, enjoy a few games and come back to hacking Postgres once again (yes, I have something planned).</p>

<p>Please email (<code>contact &lt;at&gt; aadhav.me</code>) or DM on <a href="https://twitter.com/carrotburnt" rel="nofollow">Twitter</a> if you have any questions, corrections, or if you are hiring.</p>

    </article></div>
  </body>
</html>
