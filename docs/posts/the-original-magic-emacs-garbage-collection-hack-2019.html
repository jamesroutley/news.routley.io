<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://akrl.sdf.org/#orgc15a10d">Original</a>
    <h1>The original magic Emacs garbage collection hack (2019)</h1>
    
    <div id="readability-page-1" class="page"><div id="text-4">
<p>
<span><span>&lt;2019-03-11 Mon&gt;</span></span>
</p>

<p>
Living into the GNU Emacs Lisp Machine is as attractive as convenient.
</p>

<p>
One of the many advantages is being able to forget about the barbarian
practice of the manual memory management.
</p>

<p>
Unfortunately everything comes with a price and Emacs as to recollect
all unused memory from time to time, here we come to (in)famous
garbage collector.
</p>

<p>
This post is not about the details of the Emacs GC but rather on how
to tweak it to suit our needs.
</p>

<p>
If you have an Emacs running since a while just check the <code>gc-elapsed</code>
variable. This is the time spent in GC for the current session in
second. You&#39;ll get an idea of how much is unacceptable this
problem…
</p>

<p>
We&#39;ll certainly have to be sneaky to fix it.
</p>

<p>
The first thing you want to do is probably to see when GC is
running.
</p>

<div>
<pre>(setq garbage-collection-messages t)
</pre>
</div>

<p>
Using Emacs for a while with this setup you&#39;ll notice that when
Elisp is running and consing GC is coming into play really often.
</p>

<p>
This is infact the reason why we do not notice it, it&#39;s just running
all the time…
</p>

<p>
In the moment that garbage collection becomes visible to you the
next immediate and obvious consequence step is that you are
starving to optimize it.
</p>

<p>
The first information you&#39;ll find about how to trim the Emacs GC is
the <code>gc-cons-threshold</code> variable. This represents (as the manual
says) the <code>&#34;Number of bytes of consing between garbage collections.&#34;</code>
</p>

<p>
The default value (800KB) is quite small but this should not come as a
surprise seen the fact that Emacs was made to run on really
constrained hardware systems.
</p>

<p>
The first optimization attempt would be to increase this
threshold. This is done by many (say mosts) but unfortunately does
not solve the problem but just make it worst.
</p>

<p>
An higher threshold certainly reduce the number of GC runs but these
are just longer translating in more annoying hangs of the whole
universe.
</p>

<p>
Infact what you want to do is to have the GC happening when you are
not using Emacs actively; Say when you are thinking while reading,
annoying a colleague or having a coffee.
</p>

<p>
The GC is not smart enough to understand when you are going to use
the keyboard to input a command in the nearhood future, nobody can
predict the future infact (not even Emacs) but here the interval
distribution comes into play to help us. The long story short is
that is possible to extrapolate from interval distribution that if
something did not happened for a while is unlikely to happen
soon. Surprise!!
</p>

<p>
With this truth revealed this is the trick I propose:
</p>

<div>
<pre>(<span>defmacro</span> <span>k-time</span> (<span>&amp;rest</span> body)
  <span>&#34;Measure and return the time it takes evaluating BODY.&#34;</span>
  `(<span>let</span> ((time (current-time)))
     ,@body
     (float-time (time-since time))))

<span>;; </span><span>Set garbage collection threshold to 1GB.</span>
(setq gc-cons-threshold #x40000000)

<span>;; </span><span>When idle for 15sec run the GC no matter what.</span>
(<span>defvar</span> <span>k-gc-timer</span>
  (run-with-idle-timer 15 t
                       (<span>lambda</span> ()
                         (message <span>&#34;Garbage Collector has run for %.06fsec&#34;</span>
                                  (k-time (garbage-collect))))))
</pre>
</div>

<p>
As first I&#39;m consciously setting the GC threshold to 1GB. Probably
many will be surprised but this is just a polite way to say: &#34;NEVER
garbage collect unless we are potentially causing the OS to swap
pages.&#34;
</p>

<p>
The second action I&#39;m taking is to set a timer using
<code>run-with-idle-timer</code>. That means that every time Emacs will be idle
for 15 secs we&#39;ll garbage collect once. The assumption is that the
probability that we are going to input a command exactly after 15
secs is rather low.
</p>

<p>
I believe this unconventional garbage collection strategy should be
completely clear to the reader now.
</p>

<p>
You can tweak the two parameters as you prefer and experiment a bit
with maybe less extreme values. If <code>gc-cons-threshold</code> is enough
high to avoid GC during start-up also this will benefit from this
setup. This exact value really depends on your Emacs
configuration. In general Emacs will feel more responsive.
</p>

<p>
To conclude I believe the biggest advantage is probably that coming
back from the coffee or just from time to time you&#39;ll see into the
mini-buffer how much time you have saved. This will certainly boost
your productivity and enthusiasm. In case this happens you&#39;ll
forever be grateful to me.
</p>
</div></div>
  </body>
</html>
