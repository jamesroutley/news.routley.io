<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://jay.gooby.org/2022/05/06/use-a-basic-gmail-account-to-send-mail-as-with-a-domain-that-uses-cloudflare-email-routing">Original</a>
    <h1>Use a custom domain to send emails with Gmail using Cloudflare email routing</h1>
    
    <div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>If you’ve got a basic Gmail account like <code>your.name@gmail.com</code> (ie not a full
<a href="https://workspace.google.com">Google Workspace</a> account) and a custom domain
that you want to send email from, using Gmail’s “Send mail as” functionality,
and you want to use this domain with <a href="https://developers.cloudflare.com/email-routing/">Cloudflare’s email routing</a> then this guide is for you…</p>

<h2 id="ytho">ytho?</h2>
<p>First some background. Why would you want to do this? Typically, if you have a
custom domain that you want to use for email, then you’d have to administer
or have access to an email server for it. This email server will need to have DNS <code>MX</code> records set
up for it, and will also need a good <a href="https://en.wikipedia.org/wiki/Cold_email#Bad_email_address_reputation">sender reputation</a> if your emails aren’t
going to end up in spam.</p>

<p>Normally, to “Send mail as” in Gmail, you’d enter the custom domain’s email server SMTP details,
and your email username and password. Then when you send emails from Gmail, Google contacts
that mail server, and the emails go out from it, rather than from Gmail.</p>

<p>The advantage of this is that you can let the domain’s email server sign the emails with a DKIM signature, as well as having whatever email addresses you want on that custom domain. The downside, is that you need an email server,
and inboxes for those custom addresses.</p>

<p>However, now that Cloudflare have made email routing available for domains where they are the authoritative nameserver (host your domain’s DNS records), you can use Gmail to send emails using your custom domain, and Cloudflare to route them, doing away with the need for a custom mailserver entirely.</p>

<h2 id="how-to-use-gmails-send-mail-as-with-a-custom-domain-and-cloudflare-email-routing">How to use Gmail’s “Send mail as” with a custom domain and Cloudflare email routing</h2>

<h3 id="1-configure-cloudflare">1. Configure Cloudflare</h3>
<p>First you’ll need a domain configured to use Cloudflare, if not you’ll need to <a href="https://developers.cloudflare.com/dns/zone-setups/full-setup/setup/">change the domain’s authoritative nameservers</a> first. Then you can <a href="https://developers.cloudflare.com/email-routing/get-started/enable-email-routing/">setup  Cloudflare email routing</a>.</p>

<p>You’ll be given some DNS records to set up by default, but you’ll want to alter these slightly.</p>

<h4 id="11-edit-your-spf-record">1.1 Edit your SPF record</h4>
<p>Your <code>spf TXT</code> record will need to look like this:</p>

<div><div><pre><code id="code-1">v=spf1 a mx include:_spf.google.com include:_spf.mx.cloudflare.net  ~all
</code></pre></div></div>

<p>– we’ve added <code>a mx include:_spf.google.com</code> to indicate that google can send on our behalf, along with Cloudflare.</p>

<h4 id="12-edit-your-dmarc-record">1.2 Edit your DMARC record</h4>
<p>Change it so it looks like this:</p>

<div><div><pre><code id="code-2">v=DMARC1; p=none; rua=mailto:you@example.com; aspf=r;
</code></pre></div></div>

<p>– where <code>example.com</code> is your custom domain. The email address in the <code>rua</code> field can be anything at your custom domain; it’s where email providers will periodically send you aggregated reports about your domain’s email.</p>

<p>We’ve set the domain policy <code>p</code> to <code>none</code> (other options are <code>quarantine</code> and <code>reject</code> if sending mail fails to pass DMARC checks). The SPF alignment policy <code>aspf</code> is set to relaxed <code>r</code>.</p>

<p>Setting the above is critical to not getting your custom domain’s email bounced or rejected, especially as it won’t be DKIM signed by Gmail.</p>

<h4 id="13-create-an-email-route">1.3 Create an Email Route</h4>

<p>In your Cloudflare dashboard, click the <strong>Email</strong> option, then add a destination address - use your regular gmail address <code>your.name@gmail.com</code> etc. You’ll need to click the email that’s sent to you to confirm this.</p>

<p>Once you’ve done that, you can add a custom email address e.g. <code>special@example.com</code> and route it the gmail address you just confirmed.</p>

<h3 id="2-configure-gmail">2. Configure Gmail</h3>
<p>Next we’ll do the Gmail configuration.</p>

<h4 id="21-create-an-app-password">2.1 Create an app password</h4>
<p>First you’ll need to create an email app password in your Google account. Go to <a href="https://myaccount.google.com/apppasswords">https://myaccount.google.com/apppasswords</a> and choose <code>Email</code> from the “Select app” dropdown and <code>Other</code> for the device.</p>

<p>Copy the password that’s generated for you.</p>

<h4 id="22-add-the-email-address-to-gmails-send-mail-as-section">2.2 Add the email address to Gmail’s “Send mail as” section</h4>
<p>There are <a href="https://support.google.com/mail/answer/22370">detailed instructions on adding a new email address</a>, but it’s relatively easy. Go to your <a href="https://mail.google.com/mail/#settings/accounts">Gmail account settings</a> and in the <strong>Send mail as:</strong> section, click the <strong>Add another email address option</strong>.</p>

<p>In the pop-up, enter your custom domain’s email address, untick the <strong>Treat as an alias</strong> option, click the <strong>Specify a different “reply-to” address</strong> link and add the same custom email address in there. Then click <strong>Next Step</strong>.</p>

<p><img src="https://jay.gooby.org/images/use-a-basic-gmail-account-to-send-mail-as-with-a-domain-that-uses-cloudflare-email-routing/Screenshot%202022-05-06%20at%2017.50.18.png#small" alt="Gmail form to add a custom sending email address" loading="lazy"/></p>

<p>Overwrite the value for <strong>SMTP Server</strong>. Use <code>smtp.gmail.com</code>, leave the Port option as is.</p>

<p><strong>Username</strong> should be the name part of your regular gmail address, so if you’re <code>your.name@gmail.com</code> then you’d enter <code>your.name</code>. The <strong>Password</strong> is the <a href="#21-create-an-app-password">email app password that you generated</a> above. Click the <strong>Add Account</strong> button. You’ll be sent an email to the custom email address you entered. Click the link in this, and you’re good to go.</p>

<p><img src="https://jay.gooby.org/images/use-a-basic-gmail-account-to-send-mail-as-with-a-domain-that-uses-cloudflare-email-routing/Screenshot%202022-05-06%20at%2017.52.44.png#small" alt="Gmail form for smtp server details" loading="lazy"/></p>

<h3 id="all-done">All done</h3>
<p>You’ll be able to compose emails in Gmail and set the sender to your custom domain email address, and when people reply, Cloudflare will route these back to your regular gmail account, all without you needing a separate custom mail server.</p>

  </div>

</article></div>
  </body>
</html>
