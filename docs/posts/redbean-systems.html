<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://redbean.systems/">Original</a>
    <h1>Redbean Systems</h1>
    
    <div id="readability-page-1" class="page">

<p>
Hack the planet! Send feedback to jtunney@gmail.com

</p><form action="/python" method="post" target="output">
</form>





<h2>command line api</h2>

<p>Latency should be 30 milliseconds, plus network overhead.

</p><pre>curl --tcp-fastopen -H &#39;Content-Type: text/plain&#39; -d &#39;
import time
time.sleep(1)
print(&#34;hello&#34;)
time.sleep(1)
print(&#34;hello&#34;)
&#39; http://redbean.systems/python
</pre>

<h2>source code</h2>

<ul>
<li><a href="https://github.com/jart/cosmopolitan/blob/master/libc/calls/unveil.c">cosmopolitan/libc/calls/unveil.c</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/libc/calls/pledge-linux.c">cosmopolitan/libc/calls/pledge-linux.c</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/net/http/tokenbucket.c">cosmopolitan/net/http/tokenbucket.c</a>
</li><li><a href="https://github.com/jart/cosmopolitan/blob/master/net/turfwar/blackholed.c">cosmopolitan/net/turfwar/blackholed.c</a>
</li></ul>

<pre># Copyright 2023 Justine Alexandra Roberts Tunney
#
# Permission to use, copy, modify, and/or distribute this software for
# any purpose with or without fee is hereby granted, provided that the
# above copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED &#34;AS IS&#34; AND THE AUTHOR DISCLAIMS ALL
# WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
# AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
# DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
# PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
# TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
# PERFORMANCE OF THIS SOFTWARE.

import cosmo
import errno
import http.server
import math
import os
import resource
import signal
import socketserver
import sys
import time
import tokenbucket
import traceback
import urllib.parse

# public python sandbox
# secured by pledge() and unveil()
#
# git clone https://github.com/jart/cosmopolitan
# cd cosmopolitan
# make -j8 o//third_party/python/python.com
# o//third_party/python/python.com pledgethon.py 8080
# google-chrome http://127.0.0.1:8080

REPLENISH = 30.                                            # seconds to grant a token
BUCKETBIT = 24                                             # netmask bits for each bucket
BURSTNESS = 5                                              # number of fast executions allowed
TIM_LIMIT = 3.                                             # max seconds of wall time for client
THR_LIMIT = (0, 0)                                         # max numbers of threads on whole system
CPU_LIMIT = (1, 2)                                         # max seconds of cpu time for each client
FDS_LIMIT = (128, 128)                                     # highest numbered file descriptor allowed
FSZ_LIMIT = (500*1000, 512*1000)                           # maximum number of bytes allowed in file
RAM_LIMIT = (64*1024*1024, 65*1024*1024)                   # bytes of ram client is allowed to have
SERVER_PLEDGE = &#39;stdio rpath wpath cpath anet proc unveil&#39; # system calls allowed for whole server
CLIENT_PLEDGE = &#39;stdio rpath wpath cpath&#39;                  # subset of above syscalls for clients

std_print = print  # make print() non-buffered to stdout
print = lambda *args, **kwargs: std_print(*args, **kwargs, flush=True)


def run(cmd):
  print(cmd)
  os.system(cmd)


def on_sigalrm(signum, frame):
  os.write(2, b&#39;*** RAN OUT OF WALL TIME ***\n&#39;)
  os.kill(pid, signal.SIGKILL)


def on_sigxcpu(signum, frame):
  os.write(2, b&#39;*** RAN OUT OF CPU QUOTA ***\n&#39;)
  os._exit(128 + signal.SIGXCPU)


def on_sigxfsz(signum, frame):
  os.write(2, b&#39;*** RAN OUT OF FILE QUOTA ***\n&#39;)
  os._exit(128 + signal.SIGXFSZ)


class Server(socketserver.ForkingMixIn, http.server.HTTPServer):
  max_children = 256
  protocol_version = &#39;HTTP/1.0&#39;

  def forked_request(self, request, client_address):
    resource.setrlimit(resource.RLIMIT_AS, RAM_LIMIT)
    resource.setrlimit(resource.RLIMIT_CPU, CPU_LIMIT)
    resource.setrlimit(resource.RLIMIT_FSIZE, FSZ_LIMIT)
    os.close(0)                        # close standard input
    os.close(3)                        # close server socket
    cosmo.verynice()                   # low client priority
    cosmo.unveil(&#39;/public&#39;, &#39;rwc&#39;)     # unveil the fun folder
    cosmo.unveil(&#39;/proc/cpuinfo&#39;, &#39;r&#39;) # unveil this file to our visitors
    cosmo.unveil(None, None)           # commit filesystem policy
    os.chdir(&#39;/public&#39;)                # go to fun folder


class Handler(http.server.SimpleHTTPRequestHandler):
  protocol_version = &#39;HTTP/1.0&#39;
  server_version = &#39;pledgethon/1.o&#39;

  def do_GET(self):
    self.close_connection = True
    self.send_response(200)
    content = b&#39;&#39;&#39;\
&lt;!doctype html&gt;
&lt;html lang=&#34;en&#34;&gt;
&lt;meta charset=&#34;utf-8&#34;&gt;
&lt;title&gt;Redbean Systems&lt;/title&gt;
&lt;style&gt;
body {
  max-width: 960px;
  min-width: 960px;
  margin: 0 auto 0 auto;
  margin-top: 2em;
  background: white;
}
input,
textarea {
  margin-top: .5em;
  margin-bottom: .5em;
  padding: .5em;
}
&lt;/style&gt;
&lt;h1&gt;Redbean Systems&lt;/h1&gt;
&lt;form action=&#34;.&#34; method=&#34;post&#34; target=&#34;output&#34;&gt;
&lt;textarea id=&#34;code&#34; name=&#34;code&#34; cols=&#34;80&#34; rows=&#34;20&#34; autofocus&gt;
import os
print(os.environ[&#39;USER&#39;])
print(os.getcwd())
with open(&#39;/proc/cpuinfo&#39;) as f:
  print(f.read())
&lt;/textarea&gt;&lt;br&gt;
&lt;input type=&#34;submit&#34; value=&#34;run my code&#34;&gt;
&lt;/form&gt;
&lt;iframe name=&#34;output&#34; width=&#34;960&#34; height=&#34;400&#34; frameBorder=&#34;0&#34;&gt;&lt;/iframe&gt;
&lt;h2&gt;source code&lt;/h2&gt;
&lt;pre&gt;
%s
&lt;/pre&gt;
&#39;&#39;&#39; % (SAUCE)
    self.send_header(&#39;Content-Type&#39;, &#39;text/html; charset=utf-8&#39;)
    self.send_header(&#39;Cache-Control&#39;, &#39;max-age=0, no-store&#39;);
    self.send_header(&#39;Content-Length&#39;, str(len(content)))
    self.send_header(&#39;Connection&#39;, &#39;close&#39;)
    self.end_headers()
    self.wfile.write(content)
    self.wfile.flush()

  def do_POST(self):
    self.close_connection = True
    ip = self.client_address[0]
    if ip == &#39;127.0.0.1&#39; and &#39;X-Forwarded-For&#39; in self.headers:
      ip = self.headers[&#39;X-Forwarded-For&#39;]
    tokens = tokenbucket.acquire(ip)
    debt = 128 - BURSTNESS - tokens
    if debt &gt; 0:
      if tokens &lt; 60:
        tokenbucket.blackhole(ip)
      self.bounce(debt)
      return
    content_length = int(self.headers[&#39;Content-Length&#39;])
    post_data = self.rfile.read(content_length)
    post_data = post_data.decode(&#39;utf-8&#39;)
    parameters = urllib.parse.parse_qs(post_data)
    code = parameters[&#39;code&#39;][0] if &#39;code&#39; in parameters else &#39;&#39;
    self.send_response(200)
    self.send_header(&#39;Content-Type&#39;, &#39;text/plain; charset=utf-8&#39;)
    self.send_header(&#39;Cache-Control&#39;, &#39;max-age=0, no-store&#39;);
    self.send_header(&#39;Connection&#39;, &#39;close&#39;)
    self.end_headers()
    self.wfile.flush()
    os.dup2(4, 1)  # map client socket to stdout
    os.dup2(4, 2)  # map client socket to stderr
    supervise()
    resource.setrlimit(resource.RLIMIT_NPROC, THR_LIMIT)
    cosmo.pledge(CLIENT_PLEDGE, None)  # restrict permissible system calls
    exec(code)

  def bounce(self, debt):
    self.send_response(429)
    self.send_header(&#39;Content-Type&#39;, &#39;text/plain; charset=utf-8&#39;)
    self.send_header(&#39;Cache-Control&#39;, &#39;max-age=0, no-store&#39;);
    self.send_header(&#39;Connection&#39;, &#39;close&#39;)
    self.end_headers()
    self.wfile.write(b&#39;*** TOO MANY REQUESTS ***\n&#39;)
    self.wfile.write(b&#39;*** WAIT %d SECONDS ***\n&#39; % (int(math.ceil(debt * REPLENISH))))
    self.wfile.flush()


def supervise():
  global pid
  signal.setitimer(signal.ITIMER_REAL, TIM_LIMIT)
  started = time.time()
  pid = os.fork()
  if not pid:
    return
  pid, ws, ru = os.wait4(pid, 0)
  if os.WIFEXITED(ws):
    print(&#39;*** EXITED WITH STATUS %d ***&#39; % (os.WEXITSTATUS(ws)))
  else:
    print(&#39;*** TERMINATED BY %s ***&#39; % (signal.Signals(os.WTERMSIG(ws)).name))
  cputime = ru.ru_utime + ru.ru_stime
  print(&#39;*** USED %.6f SECONDS OF WALL TIME ***&#39; % (time.time() - started))
  print(&#39;*** USED %.6f SECONDS OF CPU TIME (%.3f%% SYSTEM) ***&#39; %
        (cputime, ru.ru_stime / cputime * 100))
  print(&#39;*** BALLOONED TO %d KB OF RESIDENT MEMORY ***&#39; % (ru.ru_maxrss))
  if ru.ru_msgrcv or ru.ru_msgsnd:
    print(&#39;*** RECEIVED %d MESSAGES AND SENT %d ***&#39; %
          (ru.ru_msgrcv, ru.ru_msgsnd))
  if ru.ru_nvcsw or ru.ru_nivcsw:
    print(&#39;*** TRIGGERED %d CONTEXT SWITCHES ***&#39; %
          (ru.ru_nvcsw + ru.ru_nivcsw))
  print(&#39;*** TRIGGERED %d PAGE FAULTS ***&#39; %
        (ru.ru_minflt + ru.ru_majflt))
  if ru.ru_nsignals:
    print(&#39;*** RECEIVED %d SIGNALS ***&#39; % (ru.ru_nsignals))
  os._exit(0)


if __name__ == &#39;__main__&#39;:
  with open(sys.argv[0], &#39;rb&#39;) as fin:
    SAUCE = fin.read().replace(b&#39;&amp;&#39;, b&#39;&amp;amp;&#39;).replace(b&#39;&lt;&#39;, b&#39;&amp;lt;&#39;).replace(b&#39;&gt;&#39;, b&#39;&amp;gt;&#39;)
  if not os.path.isdir(&#39;/public&#39;):
    run(&#39;sudo mkdir /public&#39;)
    run(&#39;sudo chmod 1777 /public&#39;)
  if tokenbucket.blackhole(&#39;0.0.0.0&#39;) != 0:
    sys.stderr.write(&#34;warning: blackholed.com isn&#39;t running\n&#34;)
  tokenbucket.config(REPLENISH, BUCKETBIT)
  resource.setrlimit(resource.RLIMIT_NOFILE, FDS_LIMIT)
  signal.signal(signal.SIGALRM, on_sigalrm)
  signal.signal(signal.SIGXCPU, on_sigxcpu)
  signal.signal(signal.SIGXFSZ, on_sigxfsz)
  cosmo.pledge(None, None)          # throws exception if seccomp isn&#39;t available
  cosmo.unveil(&#39;&#39;, None)            # throws exception if landlock isn&#39;t available
  cosmo.pledge(SERVER_PLEDGE, None) # server system call restrictions
  port = int(sys.argv[1]) if len(sys.argv) &gt; 1 else 8080
  addr = (&#39;0.0.0.0&#39;, port)
  print(&#39;pledgethon http://%s:%d&#39; % (addr[0], addr[1]))
  httpd = Server(addr, Handler)
  httpd.serve_forever()

</pre>
</div>
  </body>
</html>
