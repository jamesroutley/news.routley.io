<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://randomascii.wordpress.com/2022/09/29/why-modern-software-is-slow-windows-voice-recorder/">Original</a>
    <h1>Why modern software is slow</h1>
    
    <div id="readability-page-1" class="page"><div id="post-3893">
											<h2><a href="https://randomascii.wordpress.com/2022/09/29/why-modern-software-is-slow-windows-voice-recorder/" rel="bookmark">Why Modern Software is Slow–Windows Voice Recorder</a></h2>					
					<!-- .entry-meta -->

					<div>
						<p>I apologize for this title because there are many things that can make modern software slow. Blindly applying one explanation without a bit of investigation is the software equivalent of a <a href="https://en.wikipedia.org/wiki/Cargo_cult">cargo cult</a>. That said, this post describes <em>one</em> example of why modern software can be painfully slow.</p>
<p><a href="https://randomascii.files.wordpress.com/2022/09/image.png"><img width="212" height="293" title="Voice Recorder&#39;s beautiful UI" alt="Voice Recorder&#39;s beautiful UI" src="https://randomascii.files.wordpress.com/2022/09/image_thumb.png?w=212&amp;h=293"/></a>All I wanted was to record a forty-second voiceover for a <a href="https://youtu.be/Sh08No3VuWk">throw-away video</a>, so I fired up the <em>Windows Voice Recorder</em> app and hit the record button. Nothing seemed to happen.</p>

<p>And then, when I checked later it was recording. I experimented a bit and found that the first time that I started a recording after launching <em>Voice Recorder</em> there was often a long delay before it would respond. A twenty-second delay for recording a forty-second clip is a pretty bad efficiency ratio. This bothered me enough that I wanted some understanding of “why” so <a href="https://tinyurl.com/etwcentral">I grabbed an ETW trace</a>.</p>
<p>Modern software loves to use additional processes so I wasn’t surprised when the busiest process wasn’t <em>SoundRec.exe</em>, but the verbosely named “RuntimeBroker.exe &lt;Microsoft.WindowsSoundRecorder&gt;”. Looking at its CPU usage I noticed that it got busy as soon as I launched <em>Voice Recorder</em> – before I even clicked the record button.</p>
<p><em>RuntimeBroker</em> was CPU bound and was spending most of its time in a single thread that was busy performing queries on the results of a crawl over some directory:</p>
<p><a href="https://randomascii.files.wordpress.com/2022/09/image-1.png"><img width="643" height="310" title="CPU Usage (sampled) data of DataBroker.exe, 1 kHz sampling rate" alt="CPU Usage (sampled) data of DataBroker.exe, 1 kHz sampling rate" src="https://randomascii.files.wordpress.com/2022/09/image_thumb-1.png?w=643&amp;h=310"/></a></p>
<p>The next step was to look at the File I/O graph to see what directory was being scanned. The results were a bit inconsistent (sometimes the scan seemed to stop early?) but it appears that <em>RuntimeBroker</em> was – on the same thread – scanning part or all of my documents directory.</p>
<p><a href="https://randomascii.files.wordpress.com/2022/09/image-2.png"><img width="617" height="148" title="File I/O data in Windows Performance Analyzer - scanning My Documents" alt="File I/O data in Windows Performance Analyzer - scanning My Documents" src="https://randomascii.files.wordpress.com/2022/09/image_thumb-2.png?w=617&amp;h=148"/></a></p>
<p>Meanwhile another <em>RuntimeBroker</em> thread was spending a bit of time in <em>propsys.dll!TryGetFileTypeAssocFromStateRepository</em>.</p>
<p>So, I’m guessing that the whole purpose of this was to find all audio files in my documents directory in order to populate the list of previous recordings. And, once I started watching for that I found that when I launched <em>Voice Recorder</em> it would – after a significant delay – fill in a list of recordings. If I clicked the record button <em>after</em> the list was populated then recording would start instantly.</p>
<p>&lt;sarcasm&gt;Clearly this was a case of user error. If I had waited patiently for my slow computer to be ready then it would have been fast and responsive when I wanted to start recording.&lt;/sarcasm&gt;</p>
<p>The crazy thing about this delay from scanning my documents directory is that <em>Voice Recorder</em> seems to ignore any audio files that aren’t in the <em>Sound Recordings</em> directory. All that scanning, for nothing?</p>
<h2>Complaints and concerns</h2>
<p>I have some thoughts about this whole thing…</p>
<ol>
<li>The “dir /s” command can scan my documents directory in less than two seconds. Why does <em>RuntimeBroker</em> take 5-10 times as long to do its scan? I only have ~44,000 files in the directory so what filtering could it be doing that adds an extra half-million clock cycles per file?</li>
<li>Why does <em>RuntimeBroker</em> scan my entire documents directory when <em>Voice Recorder</em> ignores audio files that aren’t in the “Sound recordings” subfolder? Is that a <em>WinRT</em> flaw, or a <em>Voice Recorder</em> flaw?</li>
<li>What happens with users who don’t have an SSD and 32 GB of RAM? In my case the directory structure of my documents directory was entirely cached in memory so there was zero disk activity required to do the scan, but some users are not so lucky. If those users have more files and a spinning disk then god have mercy on their souls.</li>
<li>When doing an operation that blocks the user from using the application then a progress meter or busy cursor would be more honest. The <em>Voice Recorder</em> UI was always responsive, but that was a lie – the record button should have been disabled until it was ready.</li>
<li>Why does the scan of the documents directory sometimes not traverse the entire directory? Is there some RuntimeBroker caching?</li>
</ol>
<p>I don’t know enough about <a href="https://www.infoq.com/news/2011/09/Design-Details-Windows-Runtime/">WinRT and RuntimeBroker</a> to comment intelligently about where the design flaws lie, but I’m confident in saying that a voice recorder app that can’t instantly record voice, on modern hardware, means that there are design flaws.</p>
<p>All of this testing was done on Windows 10, 21H2. Somebody on twitter said that they saw no delay on Windows 11 but it’s not clear if the issues were fixed, or if that user didn’t have enough documents to make the delay clearly obvious.</p>
<p>Hacker news discussion <a href="https://news.ycombinator.com/item?id=33028300">is here</a></p>
<p>Twitter discussion is <a href="https://twitter.com/BruceDawson0xB/status/1575588951456616448">here</a> and <a href="https://twitter.com/antumbral/status/1575746890595184640">here</a></p>
											</div><!-- .entry-content -->

							<div id="entry-author-info">
						<p><img alt="" src="https://1.gravatar.com/avatar/d69d2780728dfc033fcc8123f31ef8fa?s=60&amp;d=identicon&amp;r=G" height="60" width="60"/>						</p><!-- #author-avatar -->
						<div id="author-description">
							<h2>
							About brucedawson							</h2><p>
							I&#39;m a programmer, working for Google, focusing on optimization and reliability. Nothing&#39;s more fun than making code run 10x as fast. Unless it&#39;s eliminating large numbers of bugs.

I also unicycle. And play (ice) hockey. And sled hockey. And juggle. And worry about whether this blog should have been called randomutf-8.

2010s in review tells more: https://twitter.com/BruceDawson0xB/status/1212101533015298048							</p><!-- #author-link	-->
						</div><!-- #author-description -->
					</div><!-- #entry-author-info -->

						<!-- .entry-utility -->
					</div></div>
  </body>
</html>
