<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.naveen.ing/cli-for-smartplugs/">Original</a>
    <h1>Show HN: Terminal dashboard that throttles my PC during peak electricity rates</h1>
    
    <div id="readability-page-1" class="page"><div> <p><img src="https://www.naveen.ing/images/projects/post-3-wattwise-screen.png" alt="WattWise CLI Energy Monitor" width="800"/>
  <em>CLI dashboard showing real-time and historical power draw readings from a Kasa smart plug</em>
</p>
<p><span>The Challenge: Performance vs. Power Costs</span></p>
<p>High-performance computing often means high electricity bills, especially in regions with time-of-use pricing. Finding the balance between computational power and energy efficiency becomes critical when running resource-intensive workloads.</p>
<p><span>Current Workstation Specs</span></p>
<ul>
<li><strong>CPUs: Dual EPYC 7C13 (base 2GHz, boost 3.7GHz) - 128 cores total (256 threads)</strong></li>
<li><strong>Motherboard: Gigabyte MZ72-HB2</strong></li>
<li><strong>RAM: 512GB DDR4</strong></li>
<li><strong>GPUs: 2x A4000 16GB</strong></li>
<li><strong>GPUs: 2x 4090 48GB (Upcoming)</strong></li>
<li><strong>Storage: 10TB NVMe</strong></li>
<li><strong>PSU: Coolmaster 1600W Platinum</strong></li>
</ul>
<p><span>Understanding Power Usage</span></p>
<p>I have been setting up a workstation for off-loading compute-intensive LLM workflows from my desktop. The build includes dual Epyc CPUs with plans to add 4 GPUs for up to 128GB VRAM to run multiple agents in parallel. A key constraint was ensuring the system could run comfortably on a standard household 120V outlet.</p>
<p>Since I already use smart plugs throughout my home, I added one to monitor the workstation’s power consumption. However, checking power statistics using the kasa phone app or Home Assistant dashboard proved cumbersome, especially when I already maintain a terminal window with monitoring tools like htop, nvtop, and nload in a 2×2 grid on my secondary display.</p>
<p><img src="https://www.naveen.ing/images/projects/post-3-kasa-plug.png" alt="TP-link Kasa EP25 Smart Plug" width="400"/>
  <em>TP-link Kasa EP25 Smart Plug</em>
</p>
<p><span>Building a Terminal-Based Solution</span></p>
<p>After sketching a simple wireframe for what I wanted: a clean, terminal-based UI that would display power consumption data already being collected by my Home Assistant instance through the TP-Link integration. After getting the data access sorted, I spent some time with ‘Claude 3.7 Sonnet Thinking’ iterating on the CLI structure and features.</p>
<p>The result: WattWise, a lightweight CLI tool that pulls power usage data from smart plugs (either directly or through Home Assistant) and presents it in a clean, information-dense dashboard right in the terminal.</p>
<p><img src="https://www.naveen.ing/images/projects/post3-wattWise-demo.gif" alt="WattWise CLI Monitor" width="800"/>
  <em>WattWise Demo</em>
</p>
<p><span>Key Features</span></p>
<p><span>Monitoring Features</span></p>
<ul>
<li>Real-time power monitoring with wattage and current display</li>
<li>Color-coded power values (green for low usage, yellow for medium, red for high)</li>
<li>Historical consumption charts directly in the terminal</li>
<li>While smart plug measurements aren’t lab-grade (typically ±1-3% accuracy), they’re more than sufficient for practical usage monitoring</li>
</ul>
<p><span>Power Management Features</span></p>
<ul>
<li>Automatic CPU/GPU throttling based on time-of-use electricity pricing</li>
<li>Configurable power thresholds and performance profiles</li>
<li>Simple configuration through an interactive setup process</li>
</ul>
<p><span>Deployment Options</span></p>
<ul>
<li>Direct installation from source code</li>
<li>Docker support for containerized deployment</li>
<li>Connection options for both direct Kasa smart plug access and Home Assistant integration</li>
</ul>
<p><span>Dynamic Power Management</span></p>
<p>Since my utility provider uses Time of Use (ToU) pricing. Over the years, I’ve built various home automations to minimize electricity usage during peak hours. With my workstation potentially drawing up to 1400W at full load, it made sense to add automatic CPU and GPU throttling during expensive rate periods.</p>
<p><img src="https://www.naveen.ing/images/projects/post3-diagram-2.png" alt="WattWise System Architecture" width="800"/>
  <em>Power Optimizer: System architecture</em>
</p>
<p>My testing showed that reducing CPU frequency from 3700MHz to 1500MHz saved approximately 225W under load on my specific setup, though results will vary by hardware. The power optimizer service dynamically adjusts clock speeds based on:</p>
<ol>
<li>System load (from os.getloadavg())</li>
<li>Current power consumption (from the smart plug)</li>
<li>Time of day (to account for ToU periods)</li>
</ol>
<p><img src="https://www.naveen.ing/images/projects/post3-diagram-3.png" alt="Time of Use Adaptation Chart" width="800"/>
  <em>Power Optimizer: ToU adaption chart</em>
</p>
<p><span>Adaptive Performance Control</span></p>
<p>Initially, I explored a full PID (Proportional-Integral-Derivative) controller, but a simpler PI (Proportional-Integral) approach proved more suitable for power management.</p>
<p>The PI controller focuses on two key aspects:</p>
<ul>
<li>Proportional (P) term: Provides immediate, proportional response to current errors</li>
<li>Integral (I) term: Accumulates past errors to eliminate long-term steady-state deviations</li>
</ul>
<p>By removing the Derivative term, we:</p>
<ul>
<li>Simplify the control logic</li>
<li>Reduce computational overhead</li>
<li>Maintain smooth performance transitions</li>
<li>Avoid potential over-optimization from the derivative calculation</li>
</ul>
<p>For systems with gradual state changes like power management, the derivative term often introduces unnecessary complexity without meaningful benefits.</p>
<p>The controller dynamically adapts system parameters by considering:</p>
<ul>
<li>Current system utilization (CPU/GPU load)</li>
<li>Instantaneous power consumption</li>
<li>Time-of-use electricity rate periods</li>
</ul>
<p>This approach ensures energy-efficient transitions without the complexity of a full PID implementation.</p>
<p><img src="https://www.naveen.ing/images/projects/post3-diagram-1.png" alt="Power Optimizer Control Flow" width="800"/>
  <em>Power Optimizer: Control flow (with PID)</em>
</p>
<p><span>Implementation and Limitations</span></p>
<p><span>Terminal Interface</span></p>
<p>The dashboard design is simple with:</p>
<ul>
<li>A large, easy-to-read current wattage display</li>
<li>Color-coded elements based on consumption thresholds</li>
<li>Real-time updates with configurable refresh intervals</li>
<li>Historical graph using Unicode block characters for compatibility across terminals</li>
</ul>
<p><span>Data Sources</span></p>
<p>The tool supports two main data sources:</p>
<ol>
<li><strong>Direct Kasa Connection</strong>: Communicates directly with TP-Link Kasa smart plugs</li>
<li><strong>Home Assistant Integration</strong>: Uses the existing HA setup with authentication tokens</li>
</ol>
<p>The code is modular enough that adding support for other smart plug systems shouldn’t be too difficult.</p>
<p><span>Current Limitations</span></p>
<p>This is very much a personal project with some constraints:</p>
<ul>
<li>Currently supports only one smart plug at a time</li>
<li>Works only with Kasa smart plugs that have energy monitoring capabilities (Ex: EP25)</li>
<li>Requires either direct network access to the plug or Home Assistant integration</li>
<li>Power management features require Linux systems with appropriate CPU/GPU frequency control capabilities</li>
</ul>
<p><span>How TO Use</span></p>
<p>Basic setup:</p>
<pre tabindex="0" data-language="bash"><code><span><span>git</span><span> clone</span><span> https://github.com/naveenkul/WattWise.git</span></span>
<span><span>cd</span><span> WattWise</span></span>
<span><span>pip</span><span> install</span><span> -r</span><span> requirements.txt</span></span>
<span><span>pip</span><span> install</span><span> .</span></span>
<span></span></code></pre>
<p>Basic usage:</p>
<pre tabindex="0" data-language="bash"><code><span><span># Quick power view (single reading)</span></span>
<span><span>wattwise</span></span>
<span></span>
<span><span># Continuous monitoring with charts</span></span>
<span><span>wattwise</span><span> --watch</span></span>
<span></span></code></pre>
<p><span>Future Improvements</span></p>
<ul>
<li>Support for multiple plugs with aggregated power statistics</li>
<li>Additional smart plug brands/models compatibility</li>
<li>Enhanced visualization options and exports</li>
<li>Integration with other power management tools</li>
<li>Better predictive algorithms for consumption forecasting</li>
</ul>
<p><span>Final Thoughts</span></p>
<p>WattWise started as a simple utility to solve my specific need: monitoring a power-hungry workstation from the terminal I already have open. The addition of automatic power management during peak ToU hours has already saved me from manually adjusting system performance throughout the day.</p>
<p><strong>The dashboard part of the project is open-sourced under the MIT license</strong>. Documentation and installation instructions are available in the repository. Contributions and feedback are welcome!</p>

<p>Feel free to fork it and adapt it to your specific needs – I’d be curious to see what others build with it.</p>
<hr/>
<p><strong>Update (04/01/25)</strong>: Added Workstation specs</p> </div></div>
  </body>
</html>
