<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://edera.dev/stories/tarmageddon">Original</a>
    <h1>Tarmageddon: RCE vulnerability highlights challenges of open source abandonware</h1>
    
    <div id="readability-page-1" class="page"><div><div><p>This vulnerability impacts major, widely-used projects, including uv (Astral&#39;s lightning-fast Python package manager), <code>testcontainers</code>, and <code>wasmCloud</code>. Due to the widespread nature of <code>tokio-tar</code> in various forms, it is not possible to truly quantify upfront the blast radius of this bug across the ecosystem.</p><p>While the active forks have been <a href="https://github.com/edera-dev/cve-tarmageddon/tree/main/patches">successfully patched</a> (see also <a href="https://github.com/astral-sh/tokio-tar/security/advisories/GHSA-j5gw-2vrg-8fgx">Astral Security Advisory</a>), this disclosure highlights a major systemic challenge: the highly downloaded <code>tokio-tar</code> remains unpatched.</p><p>Our suggested remediation is to immediately upgrade to one of the patched versions or remove this dependency. If you depend on <code>tokio-tar</code>, consider migrating to an actively maintained fork like <code>astral-tokio-tar</code>. In addition, the Edera fork <code>krata-tokio-tar</code> will be archived to coalesce all efforts with the astral fork and reduce the ecosystem confusion.</p><h2>The Challenge of Abandonware: A Decentralized Responsible Disclosure</h2><p>This vulnerability disclosure was uniquely challenging because the most popular fork (<code>tokio-tar</code>, with over 5 million downloads on crates.io) appears to be abandonware – no longer actively maintained.</p><p>In a standard disclosure, a single patch is applied to the main upstream repository, and all downstream users inherit the fix. Because we could not rely on the original project maintainers to apply the fix, we were forced to coordinate a decentralized disclosure across a deep and complex fork lineage:</p><p><code>async-tar</code> (Root) ➡️ <code>tokio-tar</code> (Most popular fork, abandoned) ➡️<code> krata-tokio-tar</code> (Originally maintained by Edera, now archived) ➡️ <code>astral-tokio-tar </code>(Actively maintained by Astral)</p><p>Instead of a single point of contact, we had to:</p><ol role="list"><li>Develop patches for the upstream versions.</li><li>Identify and reach out to the maintainers of the unmaintained upstream repositories (<code>tokio-tar</code> and <code>async-tar</code>). Neither project had a SECURITY.md or public contact method, so it required some social engineering and community sleuthing to locate the right maintainers. </li><li>Individually contact the maintainers of the two most active forks (<code>astral-tokio-tar</code> and <code>krata-tokio-tar</code>) and coordinate simultaneous patching under a strict 60-day embargo.</li><li>Proactively reach out to major downstream projects (including <code>testcontainers</code>, <code>binstalk-downloader</code>, <code>liboxen</code>, and <code>opa-wasm</code>) to ensure they were ready to upgrade immediately upon disclosure.</li></ol><p>This process required significantly more effort and time than a typical disclosure, underscoring the severe challenges and inefficiency of ensuring wide-scale patching when critical vulnerabilities are found in popular, yet abandoned, open-source dependencies.</p><h2>Downstream Project Coordination Results</h2><ul role="list"><li>Binstalk: Plan to eliminate dependency or switch to patched <code>astral-tokio-tar</code> due to small attack surface.</li><li>Opa-wasm: Not affected, as they do not use the vulnerable unpacking/extraction-to-path functionality.</li><li>Other projects were made aware of the upcoming patch and have not responded to our attempts at outreach. Furthermore, there are likely several downstream projects relying on impacted versions that we are not aware of. </li></ul><h2>Technical Overview &amp; Analysis </h2><p>This vulnerability is a desynchronization flaw that allows an attacker to &#34;smuggle&#34; additional archive entries into TAR extractions. It occurs when processing nested TAR files that exhibit a specific mismatch between their PAX extended headers and ustar headers.</p><p>The flaw stems from the parser&#39;s inconsistent logic when determining file data boundaries:</p><ol role="list"><li>A file entry has both PAX and ustar headers.</li><li>The PAX header correctly specifies the actual file size (<code>size=X</code>, e.g., 1MB).</li><li>The ustar header incorrectly specifies zero size (<code>size=0</code>).</li><li>The vulnerable <code>tokio-tar</code> parser incorrectly advances the stream position based on the ustar size (0 bytes) instead of the PAX size (X bytes).</li></ol><p>By advancing 0 bytes, the parser fails to skip over the actual file data (which is a nested TAR archive) and immediately encounters the next valid TAR header located at the start of the nested archive. It then incorrectly interprets the inner archive&#39;s headers as legitimate entries belonging to the outer archive.</p><p>This leads to:</p><ul role="list"><li>File overwriting attacks within extraction directories.</li><li>Supply chain attacks via build system and package manager exploitation.</li><li>Bill-of-materials (BOM) bypass for security scanning.</li></ul><h3><strong>The Parser Misalignment</strong></h3><p>Normal TAR processing:</p><figure><p><img src="https://cdn.prod.website-files.com/6650e7341072f6452c2cd520/68f6d539fd9f41f527de9c75_image2.png" loading="lazy" alt=""/></p></figure><p>Vulnerable Processing (PAX size=X, ustar size=0):</p><figure><p><img src="https://cdn.prod.website-files.com/6650e7341072f6452c2cd520/68f6d52daeded6282f1daa90_image1.png" loading="lazy" alt=""/></p></figure><p>The result seen by the parser: </p><pre contenteditable="false"><code><span>Expected by scanner/validator:
</span><span>Entry </span><span>1</span><span>: </span><span>&#34;outer-file.txt&#34;</span><span>
</span><span>Entry </span><span>2</span><span>: </span><span>&#34;inner-tar-file.tar&#34;</span><span> (</span><span>0</span><span> bytes per ustar, but N bytes </span><span>in</span><span> PAX)
</span><span>Entry </span><span>3</span><span>: </span><span>&#34;next-file.txt&#34;</span><span>
</span>
<!-- -->Actually extracted by tokio-tar:
<span>Entry </span><span>1</span><span>: </span><span>&#34;outer-file.txt&#34;</span><span>
</span><span>Entry </span><span>2</span><span>: </span><span>&#34;inner-tar-file.tar&#34;</span><span> (</span><span>0</span><span> bytes per ustar)
</span><span>Entry </span><span>3</span><span>: </span><span>&#34;inner-file1.txt&#34;</span><span> (</span><span>from</span><span> inner TAR)
</span><span>Entry </span><span>4</span><span>: </span><span>&#34;inner-file2.txt&#34;</span><span> (</span><span>from</span><span> inner TAR)
</span><span>Entry </span><span>5</span><span>: </span><span>&#34;next-file.txt&#34;</span><span> (continues normally)</span></code></pre><p>The key insight is that the parser&#39;s internal position in the stream becomes misaligned, causing it to treat headers and data from a hidden, nested archive as part of the primary archive&#39;s entry list.</p><h2>Attack Scenarios</h2><h3>1. Python Build Backend Hijacking</h3><p>Target: Python package managers using <code>tokio-tar</code> (e.g., <code>uv</code>). An attacker uploads a malicious package to PyPI. The package&#39;s outer TAR contains a legitimate <code>pyproject.toml</code>, but the hidden inner TAR contains a malicious one that hijacks the build backend. During package installation, the malicious config overwrites the legitimate one, leading to RCE on developer machines and CI systems.</p><h3>2. Container Image Poisoning</h3><p>Target: Container testing frameworks (e.g., <code>testcontainers</code>). Testing frameworks that extract image layers for analysis can be tricked into processing layers crafted with this nested TAR structure. The hidden inner TAR introduces unexpected or overwritten files, allowing for test environment compromise and supply chain pollution.</p><h3>3. BOM/Manifest Bypass</h3><p>Target: Any system with separate &#34;scan/approve&#34; vs &#34;extract/deploy&#34; phases. A security scanner analyzes the outer, clean TAR and approves its limited file set. However, the extraction process using the vulnerable library pulls in additional, unapproved, and unscanned files from the inner TAR, resulting in a security control bypass and policy violation.</p><h2>Remediation</h2><p>The Edera team provided patches for <code>astral-tokio-tar</code> (used by uv) and <code>krata-tokio-tar</code>. The vulnerability is tracked as <a href="https://www.cve.org/CVERecord?id=CVE-2025-62518">CVE-2025-62518</a>. <em>Huge thank you to the security team at Astral for diligently working with us to patch this vulnerability and responsibly disclose. </em></p><p>The patch requires modifying the TAR parser to:</p><ul role="list"><li>Prioritize PAX headers for size determination over ustar headers.</li><li>Validate header consistency between PAX and ustar records.</li><li>Implement strict boundary checking to prevent data/header confusion.</li></ul><p>Patches are available here: <a href="https://github.com/edera-dev/cve-tarmageddon/tree/main/patches">https://github.com/edera-dev/cve-tarmageddon/tree/main/patches</a> </p><p>Due to architectural differences, we did not provide a direct patch for <code>async-tar,</code> but a patch was written by the maintainer.</p><h2><strong>Alternatives</strong></h2><p>If immediate patching or switching to a maintained fork is not possible, consider these workarounds:</p><p><strong>Alternative Library</strong>: The standard tar crate (non-async) correctly handles this scenario and can serve as a temporary replacement:</p><ul role="list"><li><strong>Pros</strong>: Mature, well-tested, handles PAX headers correctly</li><li><strong>Cons</strong>: Synchronous API only, may require architectural changes for async codebases</li><li><strong>Migration</strong>: Consider wrapping tar operations in tokio::task::spawn_blocking() for async compatibility</li></ul><p><strong>Runtime Mitigations</strong>:</p><ul role="list"><li>Validate extracted file counts against expected manifests</li><li>Implement post-extraction directory scanning to detect unexpected files</li><li>Use separate extraction sandboxes with file count/size limits</li><li>Disable file overwriting during extraction where possible. </li></ul><h2>A Note on Rust, Security Boundaries, and the Path Forward</h2><p>The discovery of TARmageddon is an important reminder that Rust is not a silver bullet. While Rust&#39;s guarantees make it significantly harder to introduce memory safety bugs (like buffer overflows or use-after-free), it does not eliminate logic bugs—and this parsing inconsistency is fundamentally a logic flaw. Developers must remain vigilant against all classes of vulnerabilities, regardless of the language used.</p><p>This lineage of vulnerable libraries (<code>async-tar</code> ➡️ <code>tokio-tar</code> ➡️ forks) tells a common open-source story: popular code, even in modern secure languages, can become unmaintained and expose its millions of downstream users to risk.</p><p>This experience reinforces the importance of defense-in-depth. We are happy to report that due to proactive design in Edera, our own products were not vulnerable to this bug despite embedding the vulnerable <code>krata-tokio-tar</code>. By implementing strong security boundaries and ensuring that vulnerable operations were not used in critical pathways, Edera mitigated the issue before the patch was even released.</p><p>Lastly, we’d like to thank the researchers and maintainers across the ecosystem that worked with us to responsibly disclose and patch this vulnerability. </p><h2>Timeline – 60 Day Disclosure Embargo </h2><p>8/21: Bug discovered. </p><p>8/21: Initial investigation found the vulnerability in <code>krata-tokio-tar</code> and <code>astral-tokio-tar</code>, as well as the upstream <code>tokio-tar</code> and <code>async-tar</code></p><p>8/21: Minimal reproduction created</p><p>8/22: Created patches for all libraries</p><p>8/22: Disclosed bug to maintainers of all libraries, the rust foundation, and select downstream projects (selected by number of downloads). The embargo date was set to October 21.</p><p>8/22: Received response from <code>astral-tokio-tar</code> and <code>tokio-tar</code> and shared the patch</p><p>9/2: Received acknowledgment from <code>async-tar</code></p><p>10/21: Publish GHSA and patches for <code>astral-tokio-tar</code> and <code>krata-tokio-tar</code></p></div></div></div>
  </body>
</html>
