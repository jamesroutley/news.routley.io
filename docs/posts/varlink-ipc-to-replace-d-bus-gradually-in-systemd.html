<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://varlink.org/">Original</a>
    <h1>Varlink – IPC to replace D-Bus gradually in systemd</h1>
    
    <div id="readability-page-1" class="page"><div>
      
        <header>
          
          
        </header>
      

      <section itemprop="text">
        
          
        
        <p>Varlink is an interface description format and protocol that aims to make services accessible to both humans and machines in the simplest feasible way.</p>

<p>A varlink interface combines the classic UNIX <a href="https://en.wikipedia.org/wiki/Command-line_interface">command line options</a>, <a href="https://en.wikipedia.org/wiki/Standard_streams">STDIN/OUT/ERROR</a> text formats, <a href="https://en.wikipedia.org/wiki/Man_page">man pages</a>, service metadata and provides the equivalent over a single file descriptor, a.k.a. <a href="#activation">“FD3”</a>.</p>

<p>Varlink is plain-text, type-safe, discoverable, self-documenting, remotable, testable, easy to debug. Varlink is accessible from any programming environment. See the <a href="https://varlink.org/Ideals">Ideals</a> page for more. And everybody likes <a href="https://varlink.org/Screenshots">Screenshots</a>.</p>

<h2 id="interface">Interface</h2>
<p>A varlink interface has a reverse-domain name and specifies which methods the interface implements. Each method has named and typed input and output parameters. Complex types can be aliased with the <code>type</code> keyword to allow reusing them and to make method signatures easier to read. The interface also specifies the errors that may be returned from its method calls.</p>

<p>Everything can be documented by adding a comment immediately before it. The documentation is provided to clients as structured data on a well-known service interface.</p>

<p>See the <a href="https://varlink.org/Interface-Definition">Interface Definition</a> about the varlink syntax and how to parse an interface file.</p>

<div><div><pre><code><span># Interface to jump a spacecraft to another point in space.</span>
<span># The FTL Drive is the propulsion system to achieve</span>
<span># faster-than-light travel through space. A ship making a</span>
<span># properly calculated jump can arrive safely in planetary</span>
<span># orbit, or alongside other ships or spaceborne objects.</span>
<span>interface</span> <span>org</span><span>.</span><span>example</span><span>.</span><span>ftl</span>

<span># The current state of the FTL drive and the amount of</span>
<span># fuel available to jump.</span>
<span>type</span> <span>DriveCondition</span> <span>(</span>
  <span>state</span><span>:</span> <span>(</span><span>idle</span><span>,</span> <span>spooling</span><span>,</span> <span>busy</span><span>),</span>
  <span>tylium_level</span><span>:</span> <span>int</span>
<span>)</span>

<span># Speed, trajectory and jump duration is calculated prior</span>
<span># to activating the FTL drive.</span>
<span>type</span> <span>DriveConfiguration</span> <span>(</span>
  <span>speed</span><span>:</span> <span>int</span><span>,</span>
  <span>trajectory</span><span>:</span> <span>int</span><span>,</span>
  <span>duration</span><span>:</span> <span>int</span>
<span>)</span>

<span># The galactic coordinates use the Sun as the origin.</span>
<span># Galactic longitude is measured with primary direction</span>
<span># from the Sun to the center of the galaxy in the galactic</span>
<span># plane, while the galactic latitude measures the angle</span>
<span># of the object above the galactic plane.</span>
<span>type</span> <span>Coordinate</span> <span>(</span>
  <span>longitude</span><span>:</span> <span>float</span><span>,</span>
  <span>latitude</span><span>:</span> <span>float</span><span>,</span>
  <span>distance</span><span>:</span> <span>int</span>
<span>)</span>

<span># Monitor the drive. The method will reply with an update</span>
<span># whenever the drive&#39;s state changes</span>
<span>method</span> <span>Monitor</span><span>()</span> <span>-&gt;</span> <span>(</span><span>condition</span><span>:</span> <span>DriveCondition</span><span>)</span>

<span># Calculate the drive&#39;s jump parameters from the current</span>
<span># position to the target position in the galaxy</span>
<span>method</span> <span>CalculateConfiguration</span><span>(</span>
  <span>current</span><span>:</span> <span>Coordinate</span><span>,</span>
  <span>target</span><span>:</span> <span>Coordinate</span>
<span>)</span> <span>-&gt;</span> <span>(</span><span>configuration</span><span>:</span> <span>DriveConfiguration</span><span>)</span>

<span># Jump to the calculated point in space</span>
<span>method</span> <span>Jump</span><span>(</span><span>configuration</span><span>:</span> <span>DriveConfiguration</span><span>)</span> <span>-&gt;</span> <span>()</span>

<span># There is not enough tylium to jump with the given</span>
<span># parameters</span>
<span>error</span> <span>NotEnoughEnergy</span> <span>()</span>

<span># The supplied parameters are outside the supported range</span>
<span>error</span> <span>ParameterOutOfRange</span> <span>(</span><span>field</span><span>:</span> <span>string</span><span>)</span>
</code></pre></div></div>

<h2 id="protocol">Protocol</h2>
<p>All messages are encoded as JSON objects and terminated with a single <code>NUL</code> byte.</p>

<p>A service responds to requests in the same order that they are received—messages are never multiplexed. However, multiple requests can be queued on a connection to enable <a href="https://en.wikipedia.org/wiki/HTTP_pipelining">pipelining</a>. This simplifies and minimizes the amount of state clients need to track.</p>

<p>The common case is a simple method call with a single reply. To support <em>monitoring calls</em>, <em>subscriptions</em>, <em>chunked data</em>, <em>streaming</em>, calls may carry instructions for the server to not reply, or to reply multiple times to a single method call. See the <a href="https://varlink.org/Method-Call">Method Call</a> page for a detailed description.</p>

<p>In common programming languages, varlink clients do not require complex modules or libraries, already existing JSON and socket communication facilities are used to integrate natively into the programming language’s object model.</p>

<p>Requests specify the fully-qualified <code>method</code> that should be called, along with its input parameters:</p>
<div><div><pre><code><span>{</span>
  <span>&#34;</span><span>method</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>org.example.ftl.CalculateConfiguration</span><span>&#34;</span><span>,</span>
  <span>&#34;</span><span>parameters</span><span>&#34;</span><span>:</span> <span>{</span>
    <span>&#34;</span><span>current</span><span>&#34;</span><span>:</span> <span>{</span>
      <span>&#34;</span><span>longitude</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>27.13</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>latitude</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>-12.4</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>distance</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>48732498234</span><span>&#34;</span>
    <span>},</span>
    <span>&#34;</span><span>target</span><span>&#34;</span><span>:</span> <span>{</span>
      <span>&#34;</span><span>longitude</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>-48.7</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>latitude</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>12.9</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>distance</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>354667658787</span><span>&#34;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>A service replies with an object that contains the output <code>parameters</code>:</p>
<div><div><pre><code><span>{</span>
  <span>&#34;</span><span>parameters</span><span>&#34;</span><span>:</span> <span>{</span>
    <span>&#34;</span><span>configuration</span><span>&#34;</span><span>:</span> <span>{</span>
      <span>&#34;</span><span>speed</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>32434234</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>trajectory</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>686787</span><span>&#34;</span><span>,</span>
      <span>&#34;</span><span>duration</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>13256445</span><span>&#34;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Errors contain the fully-qualified error and optional <code>parameters</code> as specified and documented in the varlink interface file:</p>
<div><div><pre><code><span>{</span>
  <span>&#34;</span><span>error</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>org.example.ftl.ParameterOutOfRange</span><span>&#34;</span><span>,</span>
  <span>&#34;</span><span>parameters</span><span>&#34;</span><span>:</span> <span>{</span> 
    <span>&#34;</span><span>field</span><span>&#34;</span><span>:</span> <span>&#34;</span><span>current.distance</span><span>&#34;</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<h2 id="service">Service</h2>
<p>Every varlink service offers the <code>org.varlink.service</code> interface, which describes all interfaces the service provides and provides information about the service implementation itself. See the <a href="https://varlink.org/Service">Service</a> page for details.</p>

<h2 id="address">Address</h2>
<p>Varlink services are expressed in URI notation. All properties after a <code>;</code> character should be ignored to allow future extensions.</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Example</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TCP</td>
      <td><em>tcp:127.0.0.1:12345</em></td>
      <td>hostname/IP address and port</td>
    </tr>
    <tr>
      <td>UNIX socket</td>
      <td><em>unix:/run/org.example.ftl</em></td>
      <td> </td>
    </tr>
    <tr>
      <td>UNIX abstract namespace socket</td>
      <td><em>unix:@org.example.ftl</em></td>
      <td> </td>
    </tr>
    <tr>
      <td>device node</td>
      <td><em>device:/dev/org.kernel.example</em></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>See the <a href="https://varlink.org/Screenshots#transports">transport screenshot</a> for examples.</p>

<h2 id="activation">Activation</h2>
<p>A listen socket a.k.a “FD3” might be passed to a varlink service at startup.</p>

<table>
  <thead>
    <tr>
      <th>Environment</th>
      <th>Example</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>LISTEN_FDS</td>
      <td><em>LISTEN_FDS=2</em></td>
      <td>Number of file descriptors passed to the service. It always starts at 3. If more than one file descriptor is passed, <em>LISTEN_FDNAMES</em> identifies the <em>varlink</em> file descriptor.</td>
    </tr>
    <tr>
      <td>LISTEN_PID</td>
      <td><em>LISTEN_PID=4711</em></td>
      <td>The process id of the started service. This should match the PID of the started service, otherwise everything should be ignored.</td>
    </tr>
    <tr>
      <td>LISTEN_FDNAMES</td>
      <td><em>LISTEN_FDNAMES=other:varlink</em></td>
      <td>A colon separated list of names of the passed file descriptors.  The varlink file descriptor should be named <em>varlink</em>.</td>
    </tr>
  </tbody>
</table>

<p>The service activator should pass the command line option <em>–varlink=<a href="#address">ADDRESS</a></em> to the service, to make the listening address and possible parameters known to the service. It also shows the listening address in <em>ps</em>, which helps to debug a running service.</p>

<p>See an example implementation of a <a href="https://github.com/cherry-pick/com.redhat.resolver/blob/master/src/service.c#L112">service activator</a>.</p>

<h2 id="resolver">Resolver</h2>
<p>Public varlink interfaces are registered system-wide by their well-known address, by default <em>/run/org.varlink.resolver</em>. The resolver translates a given varlink interface to the service address which provides this interface.</p>

<p>Multiple services can implement and offer the same interface, but only one of the services is registered with the resolver. The set of registered interfaces becomes the globally visible system interface, its actual configuration is usually defined by the operating system and not managed by the services themselves.</p>

<p>See the <a href="https://github.com/cherry-pick/com.redhat.resolver/blob/master/src/org.varlink.resolver.varlink"><code>org.varlink.resolver</code></a> interface for details.</p>

<h2 id="bridge">Bridge</h2>
<p>The <a href="https://varlink.org/Screenshots#command-line">varlink</a> command line tool supports a <code>bridge</code> mode to bridge a single connection to the resolver and its registered services. It intercepts the calls to the <code>org.varlink.service</code> interface and replies with the information the resolver supplies.</p>

<p>If the bridge is used over SSH, all the interfaces of the locally running services appear to the remote ssh client as if they were implemented by the bridge.</p>

<p>See a <a href="https://varlink.org/Screenshots#remote-host">screenshot</a> as an example.</p>

        
      </section>

      

      

      
    </div></div>
  </body>
</html>
