<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://github.com/rscott2049/pico-rmii-ethernet_nce">Original</a>
    <h1>Raspberry Pi Pico does line rate 100M Ethernet</h1>
    
    <div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">

<p dir="auto">This is an update to the existing pico-rmii-ethernet library by Sandeep Mistry.
Please see README_orig.md for a description of that library. Note that the
RMII board modifications to use an external 50 MHz clock are still necessary.</p>
<div dir="auto"><h2 tabindex="-1" dir="auto">Improvements present in this library:</h2><a id="user-content-improvements-present-in-this-library" aria-label="Permalink: Improvements present in this library:" href="#improvements-present-in-this-library"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ol dir="auto">
<li>Achieves 94.9 Mbit/sec when Pico is overclocked to 300 MHz, as measured
by iperf.</li>
<li>Inter packet gaps correctly inserted into transmit stream.</li>
<li>Greater flexiblity in choosing system clocks: 100, 150, 200, 250, 300.
Higher system clock frequencies should work; untested.</li>
<li>iperf available in the examples directory</li>
</ol>

<p dir="auto">This library uses DMA driven ring buffers for both transmit and receive. The
transmit side is entirely DMA driven, while the receive side uses a per-packet
interrupt to finalize a received packet. Performance does vary with system
clock speed, and the memory region the executable is placed:</p>
<markdown-accessiblity-table><table>
<thead>
<tr>
<th>System Clock MHz</th>
<th>Iperf Mbit/sec (SRAM)</th>
<th>Iperf Mbit/sec (flash)</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>1.38</td>
<td>1.27</td>
</tr>
<tr>
<td>150</td>
<td>2.81</td>
<td>Link not established</td>
</tr>
<tr>
<td>200</td>
<td>65.4</td>
<td>31.4</td>
</tr>
<tr>
<td>250</td>
<td>83.4</td>
<td>69.3</td>
</tr>
<tr>
<td>300</td>
<td>94.9</td>
<td>85.9</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto">The MDIO interface was changed from polled to interrupt driven, thus freeing
up more processor time for packet processing.</p>

<p dir="auto">The library uses:</p>
<ol dir="auto">
<li>Five DMA channels: 2 receive, 3 transmit. Two channels are used per Tx/Rx for
ring buffer management, and the third Tx channel assists in generating the
Ethernet Inter Packet Gap.</li>
<li>Two interrupts: 1 shared for MDIO, and 1 exclusive for the end-of-packet
processing.</li>
<li>Two 4KB aligned memory regions for Tx/Rx data, 32/64 long word pointer
buffers, and a 256 long word CRC table.</li>
<li>One PWM timer used as MD clock</li>
<li>One DMA timer used to assist with IPG generation</li>
<li>12 PIO instructions for Tx, 6 for Rx, total 18</li>
</ol>
<p dir="auto">At 300 MHz, almost all of core 1 is used. It is possible to use about 6
usec per packet poll, verified by placing a sleep_us(6) call in
netif_rmii_ethernet_loop() and running iperf. Core 0, of course, remains
available for user applications.</p>

<p dir="auto">Edit main.c in examples/{http, lwiperf} to set the pins used for the RMII
interface, and set the target_clk variable to the desired system clock, one
of: 100/150/200/250/300 MHz.</p>

<p dir="auto">** For best performance, must be run directly from RP2040 SRAM **, using:</p>
<div data-snippet-clipboard-copy-content="        pico_set_binary_type(pico_rmii_ethernet_lwiperf no_flash)"><pre><code>        pico_set_binary_type(pico_rmii_ethernet_lwiperf no_flash)
</code></pre></div>
<p dir="auto">and loading via a debugger or</p>
<div data-snippet-clipboard-copy-content="        pico_set_binary_type(pico_rmii_ethernet_lwiperf copy_to_ram)"><pre><code>        pico_set_binary_type(pico_rmii_ethernet_lwiperf copy_to_ram)
</code></pre></div>
<p dir="auto">in the CMakeLists.</p>

<p dir="auto">Sandeep Mistry - who determined that using an external clock for the RMII
board would enable much better performance.</p>
</article></div></div>
  </body>
</html>
