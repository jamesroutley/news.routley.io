<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://dropbox.tech/infrastructure/disaster-readiness-test-failover-blackhole-sjc">Original</a>
    <h1>We unplugged a data center to test our disaster readiness</h1>
    
    <div id="readability-page-1" class="page"><div>
            


<div>
    
    <div>
<p>On Thursday, November 18, 2021, Dropbox did <i>not</i> go down. On a normal day this would be a non-event—a sign that everything was operating as usual. However, this day was anything but usual. At 5:00 pm PT, a group of Dropboxers were huddled on a Zoom call when the command was given to physically unplug our San Jose data center from the rest of the Dropbox network. </p>
<p>This was a big deal—the culmination of more than a year’s worth of work for the Disaster Readiness (DR) team, and more than six years of work across Dropbox as a whole. </p>
<p>In a world where natural disasters are more and more prevalent, it’s important that we consider the potential impact of such events on our data centers. A core Dropbox value is being worthy of our customer’s trust. From a disaster readiness perspective, this means ensuring we not only measure risks to our physical locations, but also implement strategies to mitigate such risks.</p>
<p>After we migrated <a href="https://dropbox.tech/infrastructure/magic-pocket-infrastructure" target="_blank">from AWS in 2015</a>, Dropbox was highly centralized in San Jose. While user metadata has been replicated across other regions for many years, the reality was that San Jose was where most of our services originated and matured. Given San Jose&#39;s proximity to the the San Andreas Fault, it was critical we ensured an earthquake wouldn&#39;t take Dropbox offline.</p>
<p>One way of communicating our preparedness to our customers is through a metric called Recovery Time Objective (RTO). RTO measures the amount of time we promise it will take to recover from a catastrophic event. Over the years, there have been several workstreams aimed at continually reducing our estimated RTO in preparation for all kinds of potential disasters—earthquakes included.</p>
<p>Due to a large cross-functional effort led by the DR team in 2020 and 2021—culminating in the literal unplugging of our San Jose data center—Dropbox was able to reduce its RTO by more than an order of magnitude. This is the story of how we did it.</p>

</div>
<div>
<p id="-in-the-beginning-there-was-magic-pocket">
    <h2> In the beginning there was Magic Pocket</h2>
</p>
</div>
<div>
<p>In order to better appreciate the challenges associated with achieving a significant reduction in our RTO, it’s important to understand how the architecture of Dropbox was designed.</p>
<p>Dropbox has two core serving stacks: one for block (file) data, and one for metadata. As many avid Dropbox tech blog readers may be aware, <a href="https://dropbox.tech/infrastructure/inside-the-magic-pocket" target="_blank">Magic Pocket is our solution for block storage</a>, and was designed with a multi-homed approach to reliability. When a service is multi-homed, it means that, by design, the service can be run from more than one data center.</p>
<p>Magic Pocket is also what we call an active-active system. This means, in addition to being multi-homed, it was designed to serve block data from multiple data centers independently at the same time. Its design includes built-in replication and redundancies to ensure a region failure is minimally disruptive to our business. This type of architecture is resilient in disaster scenarios because, from the user’s perspective, it is able to transparently withstand the loss of a data center. After Magic Pocket was implemented, Dropbox embarked on a three-phase plan to make the metadata stack more resilient, with a goal of eventually achieving an active-active architecture here, too. </p>
<p>The first phase of this project was to achieve an active-passive architecture. This meant making the necessary changes to enable us to move metadata from our current active metro—our San Jose data center (SJC)—to another passive metro. This process is called a failover. </p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram-1-collage.png 2x,  1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram-1-collage.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="2800"
             data-sly-attribute.height="2500"
             data-aem-asset-id="130ee037-43fe-47a9-946e-ca51f96a596d"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram-1-collage.png 2x,  1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram-1-collage.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="2800"
             data-sly-attribute.height="2500"
             data-aem-asset-id="130ee037-43fe-47a9-946e-ca51f96a596d"
             data-trackable="true" /> -->

        
        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram-1-collage.png/_jcr_content/renditions/Diagram-1-collage.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram-1-collage.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="" data-aem-asset-id="130ee037-43fe-47a9-946e-ca51f96a596d" data-trackable="true" height="2500" width="2800"/>
    

            
        
    </figure>
</div></div>
<p>Our first failover was successfully performed in 2015, and was intended as a one-off exercise on the way to our eventual goal. But as we began to work towards an active-active architecture for our metadata stack—enabling us to serve user metadata from multiple data centers independently—we started to realize how difficult achieving this goal would be.</p>
<div>
<p id="-metadata-complicates-things">
    <h2> Metadata complicates things</h2>
</p>
</div>
<p>The metadata stack is built on top of two large, sharded MySQL deployments. One is for general metadata using our in-house database <a href="https://dropbox.tech/infrastructure/reintroducing-edgestore">E</a><a href="https://dropbox.tech/infrastructure/reintroducing-edgestore" target="_blank">dgestore</a>, and the other for filesystem metadata. Each shard in a cluster is allocated to six physical machines: one primary and two replicas in each of our core regions.</p>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes=""
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="305"
             data-aem-asset-id="8c81e7f7-4599-4325-a8bc-ebb53b651a64"
             data-trackable="true" />
        <img data-sly-test.highRes="true"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="305"
             data-aem-asset-id="8c81e7f7-4599-4325-a8bc-ebb53b651a64"
             data-trackable="true" /> -->

        
        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png/_jcr_content/renditions/Diagram%202_@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%202_@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="" data-aem-asset-id="8c81e7f7-4599-4325-a8bc-ebb53b651a64" data-trackable="true" height="305" width="720"/>
    

            
        
    </figure>
</div></div>
<div>
<p>There are two core trade-offs at the MySQL layer—and complexities with how we model data in Edgestore—that forced a rethink of our disaster readiness plans.</p>
<p>The first MySQL trade-off is with how we handle replication. We use <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html">s</a><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html" target="_blank">emisynchronous replication</a> to balance data integrity and write latency. However, because of that choice, replication between regions is asynchronous—meaning the remote replicas are always some number of transactions behind the primary region. This replication lag makes it very hard to handle a sudden and complete failure of the primary region. Given this context, we structured our RTO—and more broadly, our disaster readiness plans—around imminent failures where our primary region is still up, but may not be for long. We felt comfortable with this trade-off because our data centers have many redundant power and networking systems that are frequently tested.</p>
<p>The second MySQL trade-off is at a consistency level. We run MySQL in <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_read-committed">r</a><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_read-committed" target="_blank">ead </a><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_read-committed">c</a><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html#isolevel_read-committed" target="_blank">ommitted</a> isolation mode. This strong consistency makes it easy for our developers to work with data, but it also limits the ways we can scale our databases. A common way to scale is to introduce caches that alter the overall consistency guarantees, but increase read throughput. In our case, while we’ve built out a cache layer, it was still designed to be strongly consistent with the database. This decision complicated the design, and put restrictions on how far away from the databases caches can be. </p>
<p>Finally, because Edgestore is a large multi-tenant graph database used for many different purposes, data ownership isn&#39;t always straightforward. This complex ownership model made it hard to move just a subset of user data to another region.</p>
<p>These trade-offs are critical to why we struggled to build an active-active system. Our developers have come to rely on the write performance enabled by our first MySQL trade-off, and the strong consistency of the second. Combined, these choices severely limited our architectural choices when designing an active-active system, and made the resulting system much more complex. By 2017, work towards this effort had stalled—but there was still pressure within the company to develop a more robust solution to potential datacenter failures. To ensure business continuity in the event of disaster, we switched gears and prioritized an active-passive failure model instead.</p>

</div>
<div>
<p id="-introducing-the-disaster-readiness-team">
    <h2> Introducing the Disaster Readiness team</h2>
</p>
</div>
<div>
<p>Once we made the decision to focus on active-passive, we began to build the tools needed to make failovers more frequent. In 2019 we ran our first formalized failover, and from that point on we ran failovers quarterly, further improving the process each time. 2020 marked a turning point—not only for the world, but for the state of disaster readiness at Dropbox. </p>
<p>In May 2020, a critical failure in our failover tooling caused a major outage, costing us 47 minutes of downtime. The script that drove the failover had errored out halfway through the process, leaving us stuck in a half-failed state. This failure highlighted several critical problems in our disaster readiness strategy:</p>
<ol>
<li>The system driving our failovers did not fail safely.</li>
<li>Individual service teams all owned their own failover process and tooling in isolation from each other.</li>
<li>We were not running failovers often enough, which gave us fewer opportunities to practice our approach.</li>
</ol>
<p>To tackle the first problem, we started an emergency audit of our existing failover tooling and processes. We made the necessary changes to ensure our tooling now failed safely, and built a new checklist to ensure appropriate rigor when running a failover exercise.</p>
<p>The second and third problems were addressed by creating a dedicated team for failover, the Disaster Readiness (DR) team. Having a dedicated team with no competing priorities meant we could run failovers monthly instead of quarterly. More failover experience would not only help build confidence in our approach, but empower us to respond to and recover from disasters far more quickly than before. </p>
<p>With a clear mandate and a team of seven, we set ourselves the ambitious goal of significantly reducing our RTO by the end of 2021.</p>

</div>
<div>
<p id="the-year-of-failover-improvements">
    <h2>The year of failover improvements</h2>
</p>
</div>
<div>
<p>A major concern highlighted by the May 2020 outage was that we relied on a single monolithic Go binary to handle the failover from one metro to another. This tool did the job for the first few failovers, but became harder to manage as our failover ambitions grew.</p>
<p>As a result, we decided to rewrite the tool from the ground up to be more modular and configurable. We took inspiration from <a href="https://www.usenix.org/conference/osdi18/presentation/veeraraghavan" target="_blank">Facebook’s Maelstrom paper</a>, which details a system for dealing with data center disaster scenarios by smartly draining traffic. However, we would need to adapt the fundamental idea to our own Dropbox systems, starting with an MVP.</p>
<p>We borrowed Maelstrom’s concept of a runbook, which contains one or more tasks, each of which carries out a particular operation. Together, the tasks form a directed acyclic graph, which enables us to describe not only the current steps needed to perform a failover exercise, but any generic disaster recovery test. We can then describe the runbook needed to perform a failover in a configuration language that is easy to parse and edit—making changes or updates to the failover process as simple as editing configuration files.</p>
<p>Not only is this a much more lightweight process than editing the Go binary directly, but it allows us to reuse tasks with other runbooks, making it easier to test a task one at a time on a more regular basis.</p>
<p>The diagrams below show the state machines for a runbook and a task within.</p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="Runbook state machine. A runbook consists of multiple Tasks."
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png"
             aria-hidden=""
             alt="Runbook state machine. A runbook consists of multiple Tasks."
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="493"
             data-aem-asset-id="494e7d11-9c08-4a7d-b35f-1446eac9b695"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="493"
             data-aem-asset-id="494e7d11-9c08-4a7d-b35f-1446eac9b695"
             data-trackable="true" /> -->

        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png/_jcr_content/renditions/Diagram%203_@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%203_@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="Runbook state machine. A runbook consists of multiple Tasks." data-aem-asset-id="494e7d11-9c08-4a7d-b35f-1446eac9b695" data-trackable="true" height="493" width="720"/>
        
    

            <figcaption><p>Runbook state machine. A runbook consists of multiple Tasks.</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="Task state machine. A task performs a specific operation, such as failing over a database cluster, changing traffic weights, or sending a Slack message."
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png"
             aria-hidden=""
             alt="Task state machine. A task performs a specific operation, such as failing over a database cluster, changing traffic weights, or sending a Slack message."
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="302"
             data-aem-asset-id="d319c413-4d09-4aac-8203-1343d0d3a6ee"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="302"
             data-aem-asset-id="d319c413-4d09-4aac-8203-1343d0d3a6ee"
             data-trackable="true" /> -->

        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png/_jcr_content/renditions/Diagram%204_@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%204_@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="Task state machine. A task performs a specific operation, such as failing over a database cluster, changing traffic weights, or sending a Slack message." data-aem-asset-id="d319c413-4d09-4aac-8203-1343d0d3a6ee" data-trackable="true" height="302" width="720"/>
        
    

            <figcaption><p>Task state machine. A task performs a specific operation, such as failing over a database cluster, changing traffic weights, or sending a Slack message.</p>
</figcaption>
        
    </figure>
</div></div>
<p>We also wrote an in-house scheduler implementation which can accept a runbook definition and send out tasks to be executed by a worker process. For the MVP, both scheduler and worker are co-located in the same process and communicate over Go channels, but the flexible architecture means we could turn them into separate services as usage increases in the future.</p>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="The updated failover tool, which consists of a scheduler goroutine and multiple worker goroutines, communicating via channels to assign and execute tasks belonging to a runbook in the correct order."
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png"
             aria-hidden=""
             alt="The updated failover tool, which consists of a scheduler goroutine and multiple worker goroutines, communicating via channels to assign and execute tasks belonging to a runbook in the correct order."
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="563"
             data-aem-asset-id="b9eba5fc-3fb3-4a34-9055-da3b28765980"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="563"
             data-aem-asset-id="b9eba5fc-3fb3-4a34-9055-da3b28765980"
             data-trackable="true" /> -->

        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png/_jcr_content/renditions/Diagram%205_@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%205_@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="The updated failover tool, which consists of a scheduler goroutine and multiple worker goroutines, communicating via channels to assign and execute tasks belonging to a runbook in the correct order." data-aem-asset-id="b9eba5fc-3fb3-4a34-9055-da3b28765980" data-trackable="true" height="563" width="720"/>
        
    

            <figcaption><p>The updated failover tool, which consists of a scheduler goroutine and multiple worker goroutines, communicating via channels to assign and execute tasks belonging to a runbook in the correct order.<br/>
</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<p>With this new architecture, it was easy to gain visibility into the execution status of our failover runbook. At a glance, we could now tell which tasks had failed or succeeded. The explicit graph structure also allows for greedy task execution in the face of failure, while guarding important actions from being executed should any of their predecessors fail. And the operator gains other operational flexibilities, such as the ability to easily rerun a runbook, skipping over completed tasks or tasks we do not want. As our runbooks grow in complexity, these reliability gains are essential for our procedure to remain manageable.</p>
<p>Fundamental improvements in our tooling aside, we also implemented other changes to help us reduce risk and place our customers first:</p>
<ul>
<li><b>Routine testing of key failover procedures. </b>With our refactored tooling, we could now run regular, automated tests of failover tasks on a much smaller scale. For example, we might only run a failover of a single database cluster, or only one percent of traffic to another metro and back. These small tests gave us the confidence to make changes without worrying we might miss any regressions—and helped ensure the same issues that plagued our unsuccessful failover would not reoccur.</li>
<li><b>Improved operational procedures. </b>The DR team was inspired by practices used in past NASA space launches. For example, we instituted a formalized go/no-go decision point, and various checks leading up to a countdown. We also introduced clearly defined roles—such as “button pusher” and “incident manager”—and automated as many steps as possible, allowing us to reduce the number of participants needed for each failover exercise from 30 to fewer than five. This reduction helped us balance the cost of running exercises more frequently.</li>
<li><b>Clearly defined abort criteria and procedures. </b>Part of the operational improvements included planning for a worst case scenario by defining clear abort criteria and procedures. Having these in place ensured we not only knew <i>when</i> to make a call to abort, but <i>how</i>—allowing us to recover as quickly as possible and minimize the impact on our users’ experience.</li>
<li><b>More frequent and longer failover exercises. </b>Armed with better tooling, procedures, and visibility into our failover exercises, we were able to increase the frequency of failovers from once a quarter to once a month—and increase the duration of each failover exercise over time. This enabled us to catch code deployments, configuration changes, or new services that would cause a problem during failover sooner, reducing the number of such issues we had to address at a time. After multiple successful one-hour failovers, we increased our stay in the passive metro to four hours, then 24 hours, and so on—until we were able to run from the passive metro for over one month at a time. We also challenged the team with an “unplanned” failover, where the date of the failover was a surprise to the team and the company, leaving everyone just an hour to prepare.</li>
</ul>
<p>Looking back at the improvements made since the May 2020, our successful streak of failovers demonstrated that we were on the right path towards our goal. Operationally, we demonstrated muscle memory for performing and consistently improving failovers. The failover service introduced a layer of automation that significantly reduce pre-failover steps for the DR team—drastically reducing the amount of manual prep work needed to perform failover as a result. These tooling improvements also reduced our monthly downtime from 8-9 minutes per failover at the beginning of 2021 to 4-5 minutes in the latter half of the year.<b> </b>The next frontier was getting to a place where we could prove we were no longer dependent on SJC.</p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="A history of our incremental progress on failover exercises with longer duration of stay."
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png"
             aria-hidden=""
             alt="A history of our incremental progress on failover exercises with longer duration of stay."
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="503"
             data-aem-asset-id="367cd067-1cac-4489-aa57-0165ec256216"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="503"
             data-aem-asset-id="367cd067-1cac-4489-aa57-0165ec256216"
             data-trackable="true" /> -->

        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png/_jcr_content/renditions/Diagram%206_@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%206_@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="A history of our incremental progress on failover exercises with longer duration of stay." data-aem-asset-id="367cd067-1cac-4489-aa57-0165ec256216" data-trackable="true" height="503" width="720"/>
        
    

            <figcaption><p>A history of our incremental progress on failover exercises with longer duration of stay.</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<p id="the-year-of-the-blackhole">
    <h2>The year of the blackhole</h2>
</p>
</div>
<div>
<p>As our failover efforts continued to improve from 2020 into 2021, a small group within the DR team began work on the second critical milestone: achieving true active-passive architecture.</p>
<p>While our ability to failover proved we could migrate the metadata serving stack to the passive metro, there were several other critical services still serving from the active metro—in this case, SJC. We realized the best way to ensure we did not have any dependency on the active metro was to perform a disaster recovery test where we physically unplugged SJC from the rest of the Dropbox network. If<b> </b>unplugging SJC proved to have minimal impact on our operations, this would prove that in the event of a disaster affecting SJC, Dropbox could be operating normally within a matter of hours.<b> </b>We called this project the SJC blackhole.</p>
<p><b>Multi-homing <br/>
 </b>Even though the metadata and block stacks that serve live user traffic would not be affected by the SJC blackhole, we knew we could still face major troubles if internal services were degraded or nonfunctional while Dropbox was being served out of another metro. That would prevent us from being able to correct production issues that might arise during the blackhole. As a result, we needed to ensure that all critical services still running in SJC were multi-homed—or, at the very least, could temporarily run single-homed from a metro other than SJC.</p>
<p>Several prior technological investments helped facilitate the multihoming process and made detection of single-homed services easier. We leveraged the Traffic team and our traffic load balancer <a href="https://dropbox.tech/infrastructure/how-we-migrated-dropbox-from-nginx-to-envoy" target="_blank">Envoy</a> to control traffic flowing from our POPs to our data centers for all critical web routes. The <a href="https://dropbox.tech/infrastructure/courier-dropbox-migration-to-grpc" target="_blank">Courier</a> migration allowed us to build common failover RPC clients, which could direct a service’s client requests to a deployment in another metro. Additionally, Courier standard telemetry provided inter-service traffic data, which helped us identify single-homed services. At the network layer, we leveraged <a href="https://www.kentik.com/" target="_blank">Kentik</a> netflow data with custom dimension tagging to validate the dependency findings from our Courier service and catch any lingering non-Courier traffic. Finally, almost all services are under <a href="https://dropbox.tech/infrastructure/continuous-integration-and-deployment-with-bazel" target="_blank">Bazel</a> configuration, which allowed us to build and promote multi-metro deployment practices and provided another data source to validate service-metro affinity. Once at-risk services were identified, the DR team provided advice and resources to empower service owners to make changes to their service architecture that would reduce dependency on SJC.</p>
<p>In some cases, we were able to work directly with teams to integrate their service into our monthly failover. By reducing the number of services which were single-homed in SJC and involving them in regular testing, we increased our confidence in those services being able to serve out of another metro. Some of the major services that were added to the failover roster were <a href="https://dropbox.tech/infrastructure/cape-technical-deep-dive" target="_blank">CAPE</a> and <a href="https://dropbox.tech/infrastructure/asynchronous-task-scheduling-at-dropbox" target="_blank">ATF</a>, two asynchronous task execution frameworks. For certain teams, we parachuted in to directly assist their multi-homing efforts for their SJC-only components. In the end, we were able to help multi-home all major services in SJC before our planned blackhole date, allowing us to minimize the potential impact of SJC going dark.<br/>
</p>

</div>
<div>
<p id="preparing-for-the-blackhole">
    <h2>Preparing for the blackhole</h2>
</p>
</div>
<div>
<p>Once we were confident that critical services were, at the very least, no longer single-homed in SJC, we prepared to unplug SJC for the first time.</p>
<p>About two months prior to the SJC blackhole, in collaboration with the networking engineering team, we decided to take an incremental approach to preparing for the big event. In our collaboration, there were three main goals:</p>
<ol>
<li>To decide on a procedure that would simulate a complete loss of SJC (and would be easily reversible).</li>
<li>Test this procedure in a lower risk, less impactful metro.</li>
<li>Based on the outcome of these tests, prepare the company for the SJC blackhole.</li>
</ol>
<p><b>The procedure<br/>
 </b>Initially, we planned to isolate SJC from the network by draining the metro’s network routers. While this would have gotten the job done, we ultimately landed on a physical approach that we felt better simulated a true disaster scenario: unplugging the network fiber! After deciding on this approach, we set out to outline a detailed Method of Procedure (MOP) that would dictate the sequence of actions to be performed on the big day. At a high level, this is what our MOP looked like: </p>
<ol>
<li>Install traffic drains to direct all lingering traffic to other metros.</li>
<li>Disable all alerting and auto-remediation.</li>
<li>Pull the plug!</li>
<li>Perform validations (pings to machines, monitor key metrics, etc.).</li>
<li>Start a 30 minute timer and wait.</li>
<li>Reconnect fiber.</li>
<li>Perform validations.</li>
<li>Re-enable alerting and auto-remediation.</li>
<li>Un-drain traffic.</li>
</ol>
<p>With the overall procedure decided, we set out to prepare for two test runs in our Dallas Forth Worth (DFW) metro. We chose this metro because it fit the requirement of being lower risk; it had few critical services, all of which were multi-homed by design, and was therefore very resilient. </p>
<p>The DFW metro consists of two data center facilities: DFW4 and DFW5. We decided to start with one data center for the first test, and test both facilities second.</p>
<p>To prepare, the networking and data center teams took photos documenting our optical gear wiring in its ideal state. They also ordered backup hardware to have on hand, just in case something broke. Meanwhile, the DR team defined our abort criteria, and coordinated with teams to either drain their service or disable alerting and/or auto-remediation. </p>
<p><b>DFW test no.1<br/>
 </b>The day finally came to conduct our first DFW test. More than 20 of us were gathered over Zoom, our MOP was on the screen, and everyone understood their role and was ready to go. We proceeded as planned through the MOP, and unplugged the fiber for DFW4.</p>
<p>As we began to do validations, we noticed very quickly that our external availability number was dropping—something we did not expect. After waiting about four minutes, we made the call to abort and began to reconnect the network fiber. We deemed the first test a failure as we did not reach 30 minutes of network isolation.</p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes=""
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="457"
             data-aem-asset-id="ae7a8646-e153-4dc2-bfc7-9ef29b0418a0"
             data-trackable="true" />
        <img data-sly-test.highRes="true"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png 2x, /cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png.transform/half-res/img.png 1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="720"
             data-sly-attribute.height="457"
             data-aem-asset-id="ae7a8646-e153-4dc2-bfc7-9ef29b0418a0"
             data-trackable="true" /> -->

        
        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png/_jcr_content/renditions/Diagram%207_@2x.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/Diagram%207_@2x.png" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="" data-aem-asset-id="ae7a8646-e153-4dc2-bfc7-9ef29b0418a0" data-trackable="true" height="457" width="720"/>
    

            
        
    </figure>
</div></div>
<div>
<p>The root cause was that the unplugged DFW data center, DFW4, was home to our S3 proxies. When the services still running in DFW5 tried—and failed—to talk to the local S3 proxies, those services suffered, ultimately impacting global availability. </p>
<p>Going into the test, we incorrectly assumed that the two DFW facilities were roughly equivalent—and thus, we could simply pull the plug on one without affecting the other. However what this test found was that, because we don’t yet treat facilities as independent points of failure—but plan to in the future—many cross-facility dependencies still exist. This leads to a greater impact when we take a single facility offline compared to taking the whole metro offline<sup><a href="#footnote-one">1</a></sup>.</p>
<p>It’s important to remember that the whole purpose of disaster recovery tests are the lessons we learn—and in this case, not only did the DR team learn a lot, but so did many others. Specifically:</p>
<ul>
<li>We needed to conduct blackhole tests on the entire metro, not individual data center facilities.</li>
<li>We needed a more robust abort criteria specific to these types of tests.</li>
<li>We needed to work with local service owners to drain their services.</li>
</ul>
<p>As a result, the MOP for the next tests introduced two new steps:</p>
<ol>
<li><b>Drain any local services (for example, S3 proxies).</b></li>
<li>Install traffic drains to direct all lingering traffic to other metros.</li>
<li>Disable all alerting and auto-remediation.</li>
<li>Pull the plug!</li>
<li>Perform validations (pings to machines, monitor key metrics, etc.).</li>
<li>Start a 30 minute timer and wait.</li>
<li>Reconnect fiber.</li>
<li>Perform validations.</li>
<li><b>Un-drain local services and validate their health.</b></li>
<li>Re-enable alerting and auto-remediation.</li>
<li>Un-drain traffic.</li>
</ol>
<p><b>DFW test no.2<br/>
 </b>Using what we learned, we tried again a few weeks later—this time, aiming to blackhole the entire DFW metro. Once again, photos were taken, we had backup hardware on hand, and we prepared for our first full metro blackhole. </p>
<p>We started by draining critical local services, and then proceeded with the remaining steps as usual. Two Dropboxers were positioned onsite in each facility and unplugged the fiber on command. Much to our relief, we saw no impact to availability and were able to maintain the blackhole for the full 30 minutes. This was a significant improvement which allowed us to deem the network procedure viable for SJC.</p>
<p>An important outcome of our DFW tests was that they forced owners of non-critical services—for example, deployment systems, commit systems, and internal security tooling—to think critically about how the SJC blackhole would impact them. An impact document was created to ensure we had a single source of truth to communicate which services would have a gap in service during the SJC blackhole. And we encouraged service owners to perform their own pre-blackhole tests to ensure their service’s readiness for the SJC blackhole procedure.</p>
<p>As we reflected on what went well and how we could improve, we realized another huge benefit: these tests had helped train the key teams and their on-calls on the procedure we would use for the SJC blackhole. The fact we could apply these same procedures to SJC gave us the operational confidence we would be successful there, too. </p>

</div>

<div>
<p>On Thursday, November 18, 2021, the time had finally come to unplug SJC. We had three Dropboxers ready onsite in each of SJC’s three data center facilities. Again, they took photos and had extra hardware ready in case any optical gear was damaged while un-plugging or re-plugging the delicate network fiber. About 30 people gathered in a Zoom call, and even more in a Slack channel, diligently progressing through a detailed procedure like a space launch mission control.</p>
<p>Finally, at 5:00 pm PT, the time came to pull the plug at each facility, one by one, until all three were offline. Much like our second DFW test, we saw no impact to global availability—and ultimately reached our goal of a 30 minute SJC blackhole! </p>
<p>Yeah, we know, this probably sounds a bit anti-climactic. But that’s exactly the point! Our detail-oriented approach to preparing for this event is why the big day went so smoothly.</p>
<p>While there were some unexpected impacts to internal services that we plan to follow up on, we deemed this test a huge success. In the unlikely event of a disaster, our revamped failover procedures showed that we now had the people and processes in place to offer a significantly reduced RTO—and that Dropbox could run indefinitely from another region without issue. And most importantly, our blackhole exercise proved that, without SJC, Dropbox could still survive. </p>

</div>
<div>
<div>
    <figure>
        
            
    

        

        
        
        

        
        
        

        <!--optimized image webp-->
        

        
        <!-- <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/fiber-collage-alt.jpg 2x,  1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/fiber-collage-alt.jpg"
             aria-hidden=""
             alt="From left to right, Eddie, Victor, and Jimmy prepare to physically unplug the network fiber at each of SJC’s three data center facilities. "
             class=""
             data-sly-attribute.width="3750"
             data-sly-attribute.height="3000"
             data-aem-asset-id="3a5228c6-49d9-45f8-9aa6-77e6c45dacb9"
             data-trackable="true" />
        <img data-sly-test.highRes="false"
             srcset="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/fiber-collage-alt.jpg 2x,  1x"
             src="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/fiber-collage-alt.jpg"
             aria-hidden=""
             alt=""
             class=""
             data-sly-attribute.width="3750"
             data-sly-attribute.height="3000"
             data-aem-asset-id="3a5228c6-49d9-45f8-9aa6-77e6c45dacb9"
             data-trackable="true" /> -->

        
        <img src="https://thewitchofendor.com/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/fiber-collage-alt.jpg/_jcr_content/renditions/fiber-collage-alt.webp" fallbackimage="/cms/content/dam/dropbox/tech-blog/en-us/2022/04/disaster-readiness/fiber-collage-alt.jpg" onerror="window.failedAttempts=0;this.setAttribute(&#39;src&#39;,this.getAttribute(&#39;fallbackimage&#39;));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="From left to right, Eddie, Victor, and Jimmy prepare to physically unplug the network fiber at each of SJC’s three data center facilities. " data-aem-asset-id="3a5228c6-49d9-45f8-9aa6-77e6c45dacb9" data-trackable="true" height="3000" width="3750"/>
        
    

            <figcaption><p>From left to right, Eddie, Victor, and Jimmy prepare to physically unplug the network fiber at each of SJC’s three data center facilities. <br/>
</p>
</figcaption>
        
    </figure>
</div></div>
<div>
<p id="a-more-resilient-reliable-dropbox">
    <h2>A more resilient, reliable Dropbox</h2>
</p>
</div>
<div>
<p>The ability to completely blackhole SJC traffic for 30 minutes was a big step forward for disaster readiness at Dropbox. We proved we now have the tooling, knowledge, and experience necessary to keep the business running in the wake of a disaster bad enough to shutdown an entire metro. These are also the kinds of improvements that enable us to be even more competitive with industry standards for service dependability and resiliency.</p>
<p>This was a multi-year effort involving careful planning and collaboration between multiple teams at Dropbox—and given the complexity of our services and their dependencies, these failovers were not without risk. But a mix of due diligence, frequent testing, and procedural improvements have helped us minimize those risks going forward.</p>
<p>Most importantly, our experience here reinforces a core tenet of disaster readiness: like a muscle, it takes training and practice to get stronger. As we conduct blackhole exercises more frequently—and refine the processes we use—our disaster readiness capabilities will only continue to improve. And if we do our jobs right, our users should never notice when something goes wrong. A resilient, reliable Dropbox is a Dropbox they can trust. </p>
<p>Finally, we’d like to acknowledge the many Dropboxers that made this possible, all of whom should be commended for helping us unlock this new milestone. Reliability at our scale requires everyone to take ownership. We couldn’t reach a milestone like this without hundreds of smaller wins from dozens of teams.</p>

</div>

<p>Do you want to build resilient systems at scale? Are you energized by the thought of averting disaster? If so, we’d love to have you at Dropbox! Visit out <a href="https://www.dropbox.com/jobs/all-jobs" target="_blank">our jobs page</a> to see current openings and apply today.</p>
<div>
<p>- - -</p>
<p><span><sup><a></a><a id="footnote-one"></a>1</sup><i>This isn&#39;t to say the failure of an individual data center facility would impact customers any more than the failure of an entire metro. In both cases we would maintain service by simply failing over to another metro. In the future we plan to further isolate our failure domains, at which point we&#39;ll update our disaster readiness strategy to test individual data center facilities, too.</i></span></p>

</div>

    
</div>

        </div></div>
  </body>
</html>
