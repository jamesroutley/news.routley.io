<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://hearsum.ca/posts/history-of-code-signing-at-mozilla/">Original</a>
    <h1>A brief history of code signing at Mozilla</h1>
    
    <div id="readability-page-1" class="page"><div itemprop="articleBody text">
    <p>Shipping large software to end-user devices is a complicated process. Shipping large software <em>securely</em> to end-user devices is even more complicated. Signing the things that ship to end-user devices is one of those complications, and it gets even more complicated when you sign thousands of artifacts per day.</p>

<p>Mozilla has been signing Firefox in some form beginning with Firefox 1.0. This began with detached GPG signatures for builds, and progressed to Authenticode signing for Windows installers in Firefox 1.0.1. Since then it has evolved over time to encompass other platforms, other types of files within our products, and other ways that we ship (such as our own update packages). This post will provide a overview of the what, when, why, and how of code signing at Mozilla over the past ~20 years.</p>



<h3>Early GPG &amp; Authenticode Signing</h3>

<p>When we first began signing, it happened on a Windows machine. Late in the release process, after Windows installers had been built, we would download all of the release artifacts to this machine, sign the Windows installers, and generate detached GPG signatures for those before pushing the artifacts elsewhere.</p>

<p>At this time, the private keys and certificates were held on a USB stick that was kept removed from the machine at-rest. A Release Engineer needed to be physically present in Mountain View to perform this step. Once inserted, signing could be done via Remote Desktop rather than at the physical machine (but don&#39;t forget to remove the USB stick afterwards!).</p>

<p>GPG signing was done with the standard GPG tools, running in cygwin. Authenticode signing was also done with the standard (at the time) Microsoft &#39;signcode.exe&#39; tool. An annoying fact about that tool, is that it only accepted the necessary passphrase from a GUI dialog. To work around this, we had an <a href="https://en.wikipedia.org/wiki/AutoIt">AutoIt</a> script running in the background that injected the passphrase into this dialog whenever it popped up. This interesting way of automating the process meant that mouse movements or keyboard interaction at the wrong time could interfere with the signing process.</p>

<p>This process was partly scripted, but there was still a series of ~15 commands someone had to run by hand (and not mess up) to get everything done. You can see these commands for yourself in our now-ancient <a href="https://wiki.mozilla.org/ReleaseEngineering/Unified_Release_Process#Sign_builds">Unified Release Process</a> documentation.</p>

<h3>Windows internal file signing</h3>

<p>Careful readers may have noted that early Authenticode signing only covered the Firefox installer itself, not the EXEs and DLLs inside of it. At some point (I haven&#39;t gone to the effort of tracking down exactly where...) we started signing these inner files as well. This process seems to have been <a href="https://wiki.mozilla.org/ReleaseEngineering/Unified_Release_Process#Signing_windows_files">lost to the sands of time</a>, but I seem to recall it worked very similarly to the installer signing process, but without the GPG parts.</p>

<h3>Improved signing on Windows</h3>

<p>The first notable improvement we had to this process was to automate most of the copy/pasting that was done from the wiki. This came in the form of <a href="https://github.com/mozilla/build-tools/blob/dba69406faad0c8e7a016150a3f5761ef83914d2/release/signing/Makefile">a Makefile that with a few mere inputs</a>, would download, sign, and re-upload the signed builds. The main benefit of this was reduced opportunity for human error.</p>

<p>Not long after that, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=470146">we had our first real game-changing improvements</a>. Chris AtLee <a href="https://atlee.ca/posts/blog20090804faster-signing/">wrote a nice post about it back in 2009</a>, and how his changes took signing time from 8 hours all the way down to sub-15 minutes. This was accomplished through a combination of faster hardware, parallelized signing, in-process compression &amp; decompression, and better caching. His changes also introduced <a href="https://github.com/mozilla/build-tools/blob/c2e8e6f048db8990d629f169072d2a06b42e4759/release/signing/sign-release.py">a hefty amount of python</a> into the signing process, which paved the way for the next big improvement...</p>

<h3>Automatic signing</h3>

<p>Despite the signing process now being very quick once it gets started, it could still sometimes take hours or longer to begin the process. Typically this would happen if our build and repack processes finished at a time when no Release Engineer was around to begin signing. This was solved with what we called &#34;autosign&#34;. Rather than require a Release Engineer to be around at the right moment, we adjusted our scripts to allow them to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=558464#c1">be started ahead of time</a>, and be smart enough to know when all of the files it needs to sign are ready. This work eliminated all wait time between builds being ready and signing running.</p>

<h3>Signing Windows builds...on Linux!</h3>

<p>In 2011, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=509158#c10">signing was rearchitected altogether</a>. In short, the idea was to move signing to a highly secured Linux server, and sign builds through an API as part of the build process. This allowed builds to be signed as they were produced, and reduced the number of times builds had to move from one server to another before they shipped.

An obvious question here is how we would manage to sign Windows binaries on Linux...as it turns out, the mono project had <a href="https://manpages.debian.org/testing/mono-devel/signcode.1.en.html">its own version of signcode that ran natively on Linux</a> that we were able to make use of.</p>

<h3>MAR Signing</h3>

<p>Shortly after (and perhaps even motivating - I&#39;m not sure at this point) the aforementioned signing server work, we <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=699700">began signing our MAR (Mozilla ARchive) packages</a> that update users from an older version of Firefox to a newer version. Thanks to the earlier work, it was fairly trivial to use the same architecture to sign these files.</p>

<h3>macOS .app signing</h3>

<p>The idea of signing .app bundles for macOS was filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=400296#c0">all the way back in 2007</a>. There was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=400296#c25">some initial work on this</a> in 2010, but we were unable to land it at that time. Around the same time that MAR signing was happening in 2012, we <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=400296#c68">picked up this work again</a> and managed to drive it home this time.</p>

<p>Unfortunately, there were no tools available at the time to sign macOS builds on anything except a fairly modern macOS machine. For this reason, we had to run additional copies of our signing server on macOS and sign those builds with them. (If you&#39;ve ever had to run macOS as a server you&#39;ll know just how unfortunate this was...)</p>

<h3>Taskcluster/signingscript/iscript</h3>

<p>In 2018, Mozilla migrated its CI and Release automation from our aging Buildbot systems to <a href="https://taskcluster.net/">Taskcluster</a>. As part of this, signing tasks moved to specialized Taskcluster workers known as &#34;signingscript&#34; and &#34;iscript&#34;, used for signing non-macOS and macOS builds respectively. These specialized workers continued to outsource the actual work of signing to the previously discussed signing servers.</p>

<p>An important part of this change is the introduction of <a href="https://scriptworker.readthedocs.io/en/latest/chain_of_trust.html">Chain of Trust</a>, a significant security enhancement that helps ensure that only authentic artifacts are signed to this day.</p>

<h3>Introducing...Autograph!</h3>

<p><a href="https://github.com/mozilla-services/autograph">Autograph</a> is Mozilla&#39;s modern code signing service. It was built specifically to provide a signing service that allowed us to keep private key material in Hardware Security Modules (HSMs). Migrating release signing to it was a huge improvement over the existing signing server where Release Engineers had direct access to such things. It was initially used for signing XPIs and APKs, but by the end of 2019 we had migrated all non-macOS signing to it and retired the old Linux signing servers.</p>

<p>In addition to the security enhancements it brought, we saw great performance wins with it as well, largely in thanks to it&#39;s support for <a href="https://github.com/mozilla-services/autograph/blob/main/docs/architecture.md#overview"> only requiring a hash of the bytes being signed to be sent over the wire</a>. (This requires that the client has some advanced knowledge of the file being signed, but it saves a <em>tremendous</em> amount of network traffic at our scale.)

</p>
<h3>Notarization with rcodesign</h3><p>

In 2023 we started making use of <a href="https://gregoryszorc.com/docs/apple-codesign/0.17.0/apple_codesign_rcodesign.html">rcodesign</a> to <a href="https://github.com/mozilla-releng/scriptworker-scripts/pull/714">notarize and staple our macOS builds</a>. While actual macOS code signing itself continues to happen on macOS machines, this allowed us to move at least some of our operations into the cloud and reduce our reliance on mac hardware.

</p>

<p>I&#39;ve mentioned a number of tools and technology that we use as part of signing, but I&#39;ve purposely glossed over some details in the interest of brevity. The following section is a glossary of sorts, and introduces some more under the hood tools that we use as part of signing. If you&#39;re interested in the gory details, the links below should be enough to find them for yourself! Or you can stop by <a href="https://chat.mozilla.org/#/room/#firefox-ci:mozilla.org">#firefox-ci on Matrix to ask questions!</a></p>

<h3>osslsigncode</h3>
<p>osslsigncode is a <a href="https://github.com/mtrojnar/osslsigncode">tool that implements parts of Microsoft&#39;s signtool.exe</a>. In the past, we used it to directly sign PE files. These days, we use it&#39;s support for attaching the signatures that Autograph makes to them.</p>

<h3>winsign</h3>
<p>Winsign is a <a href="https://github.com/mozilla-releng/winsign">python library for signing and manipulating Authenticode signatures</a>. It relies on osslsigncode for writing signatures, and supports signing directly with a private key, or outsourcing the signing process to a passed in function. The latter is what we use, and it&#39;s how we inject a call to Autograph into the signing process.</p>

<h3>msix-packaging</h3>
<p>In 2021 we began shipping Firefox as an MSIX package. As part of this we discovered that osslsigncode does not support signing MSIX packages. Luckily for us, Microsoft&#39;s MSIX packaging tools are open source and run on Linux, and we found a <a href="https://github.com/microsoft/msix-packaging/issues/340#issuecomment-620797067">fork that contained most of what was needed</a> to support signing. With a few additional modifications, we were able to support signing these packages in our existing systems.</p>

<h3>apple-codesign</h3>
<p><a href="https://gregoryszorc.com/docs/apple-codesign/0.17.0/index.html">apple-codesign</a> is a very exciting project from Gregory Szorc which provides 3rd party tools capable of signing, notarizing, and stapling .app bundles and other Apple formats such as .pkg and .dmg. These tools run on Linux, and as noted above, we&#39;re already making use of them to notarize and staple our .app bundles.

We&#39;re extremely excited about this project, and grateful to Gregory Szorc for all the effort he&#39;s bit into it. In the future we&#39;re looking forward to migrating our actual code signing to these tools which would (finally) allow us to retire our dedicated macOS signing machines.</p>

<h3>mardor</h3>
<p><a href="https://github.com/mozilla-releng/build-mar">mardor</a> is a python tool to manage, and most importantly, sign, MAR files. In the days before Autograph it was used to directly sign MAR files. These days we only use it to inject signatures made by Autograph into the files, similar to our usage of osslsigncode.</p>

<h3>signingscript</h3>
<p><a href="https://github.com/mozilla-releng/scriptworker-scripts/tree/master/signingscript">signingscript</a> is the glue between our CI system (Taskcluster) and Autograph. Through a combination of the tools listed above, custom code in signingscript itself, and communication with Autograph it produces signed builds. It is additionally responsible for notarizing and stapling our macOS builds.</p>

<h3>iscript</h3>
<p><a href="https://github.com/mozilla-releng/scriptworker-scripts/tree/master/iscript">iscript</a> is essentially a pared down version of signingscript (in fact their code is both derived from our early signing server code), and is responsible for signing our macOS builds. iscript runs on a small cluster of mac minis, which are a huge pain in the butt to manage.

</p>
<h3>autograph</h3><p>
As noted in an earlier section <a href="https://github.com/mozilla-services/autograph">Autograph</a> is our modern code signing service. It has a simple HTTP API that accepts signing requests and returns signed data or files. In addition to signing various artifacts that we ship it also makes <a href="https://github.com/mozilla-services/autograph/blob/main/signer/contentsignaturepki/README.md">Content Signatures</a> on behalf of addons.mozilla.org, aus5.mozilla.org/Balrog (our update server), and some other backend services that Firefox communicates with, helping to ensure the security and integrity of requests made between Firefox and Mozilla-run services.

</p>
<p>What a ride it&#39;s been over the last 20 years! We&#39;ve gone from signing nothing to signing nearly everything in some form. Signing started off as a very manual process, and now happens seamlessly thousands of times per day.</p>

<p>I don&#39;t think it would be possible to name everyone that contributed to this, but it took the ideas and efforts of tens, if not hundreds, of people to get to this point: release engineers, build system experts, security folks, and many others were all critical to getting us where we are today.</p>

<p>I&#39;ve got this post as brief as possible, but if you&#39;re interested in more details on any parts here feel free to reach out!</p>
    </div></div>
  </body>
</html>
