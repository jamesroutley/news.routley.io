<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.mgmarlow.com/words/2021-03-27-proper-tail-calls-js/">Original</a>
    <h1>What happened to proper tail calls in JavaScript? (2021)</h1>
    
    <div id="readability-page-1" class="page"><article>
    
<p>Proper tail calls (PTC) is a programming language feature that enables memory-efficient recursive algorithms. I&#39;m not going to belabor the details of proper tail calls or how it pertains to JavaScript, as <a href="https://2ality.com/2015/06/tail-call-optimization.html">Dr. Axel&#39;s article</a> already offers those explanations. Instead, I&#39;m going to discuss the evolution of the feature in JavaScript since its genesis in ECMAScript 2015.</p>
<p>Despite its inclusion in the <a href="https://262.ecma-international.org/6.0/#sec-tail-position-calls">2015 language specification</a>, PTC is currently only supported by Safari. It is astounding that six years after the formal submission of the standard, only one major browser offers any kind of support.</p>
<ul>
<li>JavaScriptCore (Safari) ✅ (<a href="https://webkit.org/blog/6240/ecmascript-6-proper-tail-calls-in-webkit/">read all about it</a>)</li>
<li>V8 (Chrome, Edge, Opera) ❌</li>
<li>SpiderMonkey (Firefox) ❌</li>
<li>Carakan (Opera) ❌</li>
</ul>
<p>Why are browser vendors ignoring PTC? V8 chalks it up to two main reasons:</p>
<blockquote>
<ol>
<li>
<p>It makes it more difficult to understand during debugging how execution arrived at a certain point since the stack contains discontinuities, and</p>
</li>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/Stack">error.stack</a> contains less information about execution flow which may break telemetry software that collects and analyzes client-side errors.</p>
</li>
</ol>
</blockquote>
<p>It&#39;s worth noting that V8 fully implemented proper tail calls but ultimately removed them, according to their <a href="https://v8.dev/blog/modern-javascript#proper-tail-calls">blog post</a> from 2016. To help outline a solution to the aforementioned problems, V8 created a proposal for an alternative approach called <a href="https://github.com/tc39/proposal-ptc-syntax">syntactic tail calls</a> (STC). As the name suggests, it proposes a syntax for opting in to PTC, rather than supporting implicit opt-in.</p>
<p>The STC proposal is <a href="https://github.com/tc39/proposal-ptc-syntax/issues/23">hotly</a> <a href="https://github.com/tc39/proposal-ptc-syntax/issues/22">debated</a>. The arguments tend to trend in one of two directions:</p>
<ol>
<li>
<p>STC is unnecessary and defeats the purpose of PTC. Safari has implemented PTC since 2016 without issue, so most fears of implicit behavior are unwarranted.</p>
</li>
<li>
<p>STC is important to guard against potential problems with implicit behavior. As V8 summarized, PTC introduces educational concerns across developers and debugging concerns across implementations.</p>
</li>
</ol>
<p>TC39 editors express a general hesitancy towards STC and a lack of faith for broader PTC adoption that is <a href="https://github.com/kangax/compat-table/issues/819#issuecomment-226620936">well-summarized</a> by contributor Jordan Harband. Since 2017, the proposal has been <a href="https://github.com/tc39/proposals/blob/master/inactive-proposals.md">marked inactive</a>. There is no indication that the proposal will be revived or that PTC adoption will move in a forward direction.</p>
<p>All that drama aside, browser implementations are only one part of the story. What about Babel?</p>
<p>Similar to V8, Babel implemented and subsequently reverted both <a href="https://github.com/babel/babel/pull/701">proper tail calls</a> and <a href="https://github.com/babel/babel/pull/714">tail call optimization</a>. The reference to PTC in the <a href="https://babeljs.io/docs/en/learn#tail-calls">ES2015 documentation</a> states,</p>
<blockquote>
<p>Temporarily Removed in Babel 6</p>
<p>Only explicit self referencing tail recursion was supported due to the complexity and performance impact of supporting tail calls globally. Removed due to other bugs and will be re-implemented.</p>
</blockquote>
<p>When will tail calls be re-implemented? Not in Babel 7, that&#39;s for sure. The uncertain fate of PTC requires JavaScript developers to reach for alternative approaches.</p>
<p>Kyle Simpson describes the use of a trampoline, a helper function that rewrites tail-recursive functions with while loops. His methodology is detailed in <a href="https://github.com/getify/Functional-Light-JS/blob/master/manuscript/ch8.md/#trampolines">Chapter 8 of Functional-Light JavaScript</a>.</p>
<p>Those looking for npm packages have a couple of options:</p>
<ul>
<li>
<p><a href="http://glat.info/fext/">fext</a>, a library that enables optimizations by wrapping functions with its API.</p>
</li>
<li>
<p><a href="https://github.com/krzkaczor/babel-plugin-tailcall-optimization">babel-plugin-tailcall-optimization</a>, a plugin that automatically rewrites tail-recursive functions with trampolines.</p>
</li>
</ul>
<p>PS, a final clarification for the pedantic:</p>
<p>The terminology of proper tail calls (PTC) and tail call optimization (TCO) is often conflated. Here&#39;s the difference between the two:</p>
<ul>
<li>
<p><strong>proper tail calls</strong>: functions called in the tail position reuse the current stack frame, preventing the creation of additional stack frames that cause space inefficiency.</p>
</li>
<li>
<p><strong>tail call optimization</strong>: rewrites a recursive function into an iterative one, usually by calling goto.</p>
</li>
</ul>
<p>The difference between the two is nuanced, though often mentioned in spicy Github threads. PTC only deals with stack manipulation, while TCO rewrites a recursive function as an iterative function. Find more details from Ward Cunningham&#39;s <a href="http://wiki.c2.com/?TailCallOptimization">tail call optimization</a> wiki.</p>

  </article></div>
  </body>
</html>
