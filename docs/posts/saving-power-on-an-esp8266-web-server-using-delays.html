<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>James Routley | Feed</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="../styles.css"
      media="screen"
    />
  </head>
  <body>
    <a href="/index.html">Back</a>
    <a href="https://www.tablix.org/~avian/blog/archives/2022/08/saving_power_on_an_esp8266_web_server_using_delays/">Original</a>
    <h1>Saving power on an ESP8266 web server using delays</h1>
    
    <div id="readability-page-1" class="page"><div>
<p><a href="https://github.com/esp8266/Arduino">ESP8266 core</a> support on Arduino comes with a library that allows you to quickly setup and run a web server from your device. Commonly the code using the ESP8266WebServer library looks something like the following:</p>

<pre>#include &lt;ESP8266WebServer.h&gt;

ESP8266WebServer server(80);

void setup(void)
{
	<i>... various wi-fi and request handler setup calls here ...</i>
}

void loop(void)
{
	server.handleClient();
}
</pre>

<p>For a more concrete example, take a look at the <a href="https://github.com/esp8266/Arduino/blob/313b3c07ecccbe6fee24aa9fa447c4aed16ca499/libraries/ESP8266WebServer/examples/HelloServer/HelloServer.ino">&#34;Hello World&#34; example</a> that is included with the library.</p>

<p>In the following we&#39;ll focus on the <code>loop()</code> and ignore the rest. As the name implies, the Arduino framework calls the <code>loop()</code> function in an infinite loop. The <code>handleClient()</code> method checks if any client has connected over the Wi-Fi network and issued an HTTP request. If so, it handles the request and sends a response back to the client. If not, it exits immediately, doing nothing.</p>

<p>In other words, <code>loop()</code> implements a busy-wait for HTTP requests. Even when there is nothing to do, the CPU still runs the busy loop roughly 100000 times per second. In the common case where a page is only requested from the server every once in a while, the system will spend almost all of its time in this state.</p>

<p>Busy loops are common on microcontrollers. On an ATmega microcontroller, another popular target for Arduino code, this is hardly a problem. Unless you&#39;re running your hardware off a battery and really counting every microwatt, a busy CPU uses negligible extra power over a CPU that&#39;s sleeping. The ESP8266 is a bit more powerful than an 8-bit microcontroller though and correspondingly has a higher power consumption when not sleeping. Hence it makes sense to be a bit more sensible about when the CPU is running or not.</p>

<p>The best solution would be to not have a busy loop at all. Ideally we could use the underlying RTOS to only schedule a <code>handleClient()</code> task in response to network events. The RTOS is smart enough to put the CPU to sleep when no task needs to run. Unfortunately, the simple Arduino environment does not want us to mess with the RTOS. The ESP8266WebServer library certainly isn&#39;t written with such use in mind. This approach would require a lot of refactoring of ESP8266WebServer and the code that uses it.</p>

<p>A simpler way is to slow the busy loop down. There is no need to check for client connections hundreds of thousand times per second. A more modest rate would be good enough and the CPU can sleep in between. This would decrease the power consumption at the cost of the response time for HTTP requests. Inserting the Arduino-provided <a href="https://github.com/esp8266/Arduino/blob/15e7d35d6e7c430915a5a86d854ae855d10a8da5/cores/esp8266/core_esp8266_main.cpp#L149"><code>delay()</code> function</a> into <code>loop()</code> does exactly what we want:</p>

<pre>void loop(void)
{
	server.handleClient();
	delay(...);
}
</pre>

<p>The question that remains is what is a good value to choose for delay in this case. What value gives the best trade off between decreased power consumption and increased response time?</p>

<p><a href="https://www.tablix.org/~avian/blog/images2/2022/08/my_setup_for_measuring_esp8266_power_consumption.jpg"><img alt="My setup for measuring ESP8266 power consumption." height="400" src="https://www.tablix.org/~avian/blog/images2/2022/08/my_setup_for_measuring_esp8266_power_consumption-t.jpg" width="400"/></a></p>

<p>To check I&#39;ve used this somewhat messy breadboard setup. I&#39;ve measured the power consumption and response times when running a simple web server Arduino sketch, similar to the &#34;Hello World&#34; included with the ESP8266WebServer library, but with various delays inserted into the loop.</p>

<p>A multimeter with an averaging function measured the current on the 3.3 V supply line of an <a href="https://www.esp8266.com/wiki/doku.php?id=esp8266-module-family">ESP-01 module</a>. Averaging time was 30 s. I&#39;ve measured the power consumption while the module was idle (not answering any HTTP requests)</p>

<p>The module was connected through an USB development board to a PC for easy programming from the Arduino IDE. I&#39;ve used Arduino 2.8.19 and the ESP8266 core 2.4.2.</p>

<p>I&#39;ve measured HTTP server response times over the Wi-Fi network using <a href="https://httpd.apache.org/docs/2.4/programs/ab.html">Apache Bench</a> (<code>ab -n10</code>). As the representative metric I&#39;ve chosen the median time from the <i>Waiting</i> row. This is the time it took ESP8266 to send the first byte of the response.</p>

<p><a href="https://www.tablix.org/~avian/blog/images2/2022/08/supply_current_versus_various_delays_in_loop.png"><img alt="Supply current versus various delays in loop()" height="225" src="https://www.tablix.org/~avian/blog/images2/2022/08/supply_current_versus_various_delays_in_loop-t.jpg" width="400"/></a></p>

<p><a href="https://www.tablix.org/~avian/blog/images2/2022/08/response_time_versus_various_delays_in_loop.png"><img alt="Response time versus various delays in loop()" height="225" src="https://www.tablix.org/~avian/blog/images2/2022/08/response_time_versus_various_delays_in_loop-t.jpg" width="400"/></a></p>

<p>Here are the results, comparing code with just a call to <code>handleClient()</code> to code that is also calling delay with various argument values. The argument to delay is wait time in milliseconds. I&#39;ve also did a measurement with <code>yield()</code> instead of <code>delay()</code>, something that I&#39;ve seen used in <a href="https://github.com/esp8266/Arduino/blob/313b3c07ecccbe6fee24aa9fa447c4aed16ca499/libraries/ESP8266WebServer/examples/ServerSentEvents/ServerSentEvents.ino#L206">some examples</a>.</p>

<p>Even a 1 millisecond delay, the minimum allowed by the function, decreases the idle power consumption by 60%. Not surprising if you consider that this small delay causes the CPU to be idle 99.999% of time. The added delay does also measurably increase the response time, as was expected, but the difference between 6 or 8 ms should be negligible for most practical use cases.</p>

<p>Further increasing the delay does not bring any benefits. It only increases the response time without measurably decreasing power consumption. I suspect the variations in measured current with higher delay values are likely due to uncontrolled traffic on the network waking up the ESP8266&#39;s radio more often in some test runs than in others.</p>

<p>Adding a <code>yield()</code> call to <code>loop()</code> does not show any benefits in this test. In fact, <code>handleClient()</code> itself <a href="https://github.com/esp8266/Arduino/blob/313b3c07ecccbe6fee24aa9fa447c4aed16ca499/libraries/ESP8266WebServer/src/ESP8266WebServer-impl.h#L382">calls <code>yield()</code></a> in some cases before returning. Similarly, <a href="https://arduino.stackexchange.com/questions/86542/what-does-a-delay0-actually-do">adding <code>delay(0)</code></a> has no measurable effect.</p>

<p>In conclusion, I recommend using a <code>loop()</code> with 1 ms delay:</p>

<pre>void loop(void)
{
	server.handleClient();
	delay(1);
}
</pre>

<p>The added delay decreases the idle power consumption at 3.3 V by about 60%, from around 230 mW to around 70 mW. This is significant enough that you can feel the board running cooler by touch. On a yearly basis it saves around 1.4 kWh per device that&#39;s powered on continuously.</p>

<p>For most simple Arduino sketches using ESP8266WebServer, like using the request handler to read a sensor or actuate a relay, this is just a simple one-line change, so I think the power saving is worth the effort. Of course, if you&#39;re doing something else in <code>loop()</code> in addition to just calling <code>handleClient()</code>, adding a delay might have other side effects. In such case the code running in <code>loop()</code> might need some adjusting to account for the delay.</p>

</div></div>
  </body>
</html>
